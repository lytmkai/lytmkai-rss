<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[【LangChain.js学习】调用大模型]]></title>    <link>https://juejin.cn/post/7605468286181310499</link>    <guid>https://juejin.cn/post/7605468286181310499</guid>    <pubDate>2026-02-12T07:12:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605468286181310499" data-draft-id="7605489943868882959" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【LangChain.js学习】调用大模型"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-12T07:12:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【LangChain.js学习】调用大模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T07:12:55.000Z" title="Thu Feb 12 2026 07:12:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">一、调用通义千问大模型</h2>
<h3 data-id="heading-1">方式1：使用 @langchain/community 专属适配器</h3>
<h4 data-id="heading-2">依赖安装</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm add @langchain/community
</code></pre>
<h4 data-id="heading-3">调用代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatAlibabaTongyi</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/community/chat_models/alibaba_tongyi"</span>;
​
<span class="hljs-comment">// 初始化通义千问专属模型实例</span>
<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatAlibabaTongyi</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-string">"qwen-plus"</span>,
    <span class="hljs-comment">// 替换为个人有效阿里百炼API Key</span>
    <span class="hljs-attr">alibabaApiKey</span>: <span class="hljs-string">"[你的阿里百炼API Key]"</span>,
});
​
<span class="hljs-comment">// 注意：需在async函数中执行await调用</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">callTongyiModel</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">"为什么鹦鹉会说话？"</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response.<span class="hljs-property">content</span>);
}
​
<span class="hljs-title function_">callTongyiModel</span>();
</code></pre>
<h3 data-id="heading-4">方式2：使用 @langchain/openai 兼容接口</h3>
<h4 data-id="heading-5">依赖安装</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm add @langchain/openai
</code></pre>
<h4 data-id="heading-6">调用代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/openai"</span>
​
<span class="hljs-comment">// 基于OpenAI兼容接口初始化通义千问模型</span>
<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-string">"qwen-plus"</span>,
    <span class="hljs-attr">configuration</span>: {
        <span class="hljs-comment">// 阿里百炼OpenAI兼容接口固定地址，不可修改</span>
        <span class="hljs-attr">baseURL</span>: <span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
        <span class="hljs-comment">// 替换为个人有效阿里百炼API Key</span>
        <span class="hljs-attr">apiKey</span>: <span class="hljs-string">"[你的阿里百炼API Key]"</span>,
    }
});
​
<span class="hljs-comment">// 注意：需在async函数中执行await调用</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">callQwenByOpenAI</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">`1+1=？`</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"单文本调用响应："</span>, response.<span class="hljs-property">content</span>); <span class="hljs-comment">// 输出示例：1+1=2</span>
}
​
<span class="hljs-title function_">callQwenByOpenAI</span>();
</code></pre>
<h2 data-id="heading-7">二、调用 Ollama 本地模型</h2>
<h3 data-id="heading-8">1. 前置条件</h3>
<ul>
<li>安装 Ollama：<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2F" target="_blank" title="https://ollama.com/" ref="nofollow noopener noreferrer">官网下载</a></li>
<li>拉取目标模型：<code>ollama pull qwen3-vl:8b</code></li>
<li>启动 Ollama 服务：<code>ollama serve</code>（默认端口 11434）</li>
</ul>
<h3 data-id="heading-9">2. 依赖安装</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm add @langchain/ollama
</code></pre>
<h3 data-id="heading-10">3. 核心调用代码</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOllama</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/ollama"</span>
​
<span class="hljs-comment">// 初始化Ollama本地模型</span>
<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOllama</span>({
    <span class="hljs-comment">// 需与本地拉取的模型名称一致（执行ollama list查看）</span>
    <span class="hljs-attr">model</span>: <span class="hljs-string">"qwen3-vl:8b"</span>,
    <span class="hljs-comment">// Ollama默认本地地址，无需修改</span>
    <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">"http://localhost:11434"</span>
});
​
<span class="hljs-comment">// 异步调用函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">callOllamaModel</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">`1+1=？`</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Ollama本地模型响应："</span>, response.<span class="hljs-property">content</span>); <span class="hljs-comment">// 输出示例：1+1=2</span>
}
​
<span class="hljs-title function_">callOllamaModel</span>();
</code></pre>
<h2 data-id="heading-11">三、核心对比与选型建议</h2>























<table><thead><tr><th>调用方式</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>阿里云通义千问</td><td>模型能力强、无需本地算力、支持多模态/复杂推理</td><td>需联网、消耗 API 额度、有调用频率限制</td><td>生产环境、复杂业务逻辑、多轮对话</td></tr><tr><td>Ollama 本地模型</td><td>无网络依赖、隐私性高、免费使用、调试便捷</td><td>占用本地CPU/GPU、模型能力相对弱、不支持部分高级功能</td><td>本地开发调试、隐私敏感场景、轻量计算/问答</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小米Android 手机连接PC Local调试]]></title>    <link>https://juejin.cn/post/7605547012050616361</link>    <guid>https://juejin.cn/post/7605547012050616361</guid>    <pubDate>2026-02-12T07:14:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605547012050616361" data-draft-id="7605419006683332650" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小米Android 手机连接PC Local调试"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-12T07:14:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="赵_叶紫"/> <meta itemprop="url" content="https://juejin.cn/user/8451823504760"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小米Android 手机连接PC Local调试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/8451823504760/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    赵_叶紫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T07:14:01.000Z" title="Thu Feb 12 2026 07:14:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">手机设置</h2>
<ol>
<li>进入<strong>设置界面 =&gt;</strong> 打开 <strong>我的设备</strong></li>
<li>进入 <strong>全部参数与信息 =&gt;</strong> 多次点击点击 <strong>OS版本（1.0.4xxx）</strong> ，直到显示**你已处于开发者模式*</li>
<li>返回主菜单，进入 <strong>更多设置，</strong> 点击**开发者选项 =&gt; 打开 USB调试</li>
</ol>
<h2 data-id="heading-1"><strong>电脑使用</strong></h2>
<ol>
<li>chrome打开 <strong><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">chrome://inspect/#devices</a></strong></li>
<li>手机chrome访问 <strong><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.baidu.com" target="_blank" title="http://www.baidu.com" ref="nofollow noopener noreferrer">www.baidu.com</a></strong></li>
<li>可在电脑上查看到，devices的远程设备</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cad1b00bc5c94969b6f5681cf3c5b7ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LW1X-WPtue0qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485241&amp;x-signature=%2BCoEbb67My%2FZFG4GV9XyhIBrYt0%3D" alt="image-2024-11-26_8-55-14.png" loading="lazy"/></p>
<ol start="4">
<li>点击 inspect 选项，查看到手机访问的内容
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a766db64ab54932bcca58765666d950~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LW1X-WPtue0qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485241&amp;x-signature=QfYI5O3P5HaGiJQMPz7p%2BVGh2N8%3D" alt="image-2024-11-26_8-56-59.png" loading="lazy"/></li>
</ol>
<h2 data-id="heading-2">安装fiddler并开启，引起https网页打不开</h2>
<ol>
<li>tools=&gt; Options=&gt; https =&gt; Decrypt HTTPS traffic  勾选</li>
<li>点击右侧Actions =&gt;  Reset All Certificates </li>
<li>参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fxiaona0523%2Farticle%2Fdetails%2F107208004" target="_blank" title="https://blog.csdn.net/xiaona0523/article/details/107208004" ref="nofollow noopener noreferrer">blog.csdn.net/xiaona0523/…</a></li>
</ol>
<h2 data-id="heading-3">手机连接local调试</h2>
<p>1.设置wify 代理到本地</p>
<p>2.chrome中访问local 地址，即可开始调试</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[无需修改内核即可为 PostgreSQL 数据库对象添加自定义属性]]></title>    <link>https://juejin.cn/post/7605530057175711787</link>    <guid>https://juejin.cn/post/7605530057175711787</guid>    <pubDate>2026-02-12T07:18:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605530057175711787" data-draft-id="7605530057175695403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="无需修改内核即可为 PostgreSQL 数据库对象添加自定义属性"/> <meta itemprop="keywords" content="PostgreSQL,开源,数据库"/> <meta itemprop="datePublished" content="2026-02-12T07:18:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IvorySQL"/> <meta itemprop="url" content="https://juejin.cn/user/761327331579511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            无需修改内核即可为 PostgreSQL 数据库对象添加自定义属性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/761327331579511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IvorySQL
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T07:18:17.000Z" title="Thu Feb 12 2026 07:18:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开发实践中，经常会遇到一个问题：如何在不修改 PostgreSQL 内核代码的前提下，为数据库对象附加自定义元数据。本文展示了一种基于 PostgreSQL SECURITY LABELS 机制的可行方案，用于实现自定义属性。这种方式具备事务性、与数据库对象强关联，并且能够与标准 PostgreSQL 操作良好协同。</p>
<h2 data-id="heading-0">问题背景：复制冲突的管理</h2>
<p>在一个典型的两主节点向第三节点复制数据的架构中，UPDATE/UPDATE 冲突较为常见。复制冲突的处理本身较为复杂，且在多数场景下并无通用解法，但某些列类型可以采用更简单的处理思路。</p>
<p>例如，在银行业务场景中，账户余额字段通常只允许增减操作。此时可以采用基于增量（delta）的方式：不在冲突时选择某个绝对值，而是分别计算两次更新的变化量并进行叠加。该方法仅需进行基础校验（如溢出检查、余额不小于 0），即可确保所有更新均被正确计入。</p>
<p>难点在于：如果 PostgreSQL 本身不支持此类机制，如何标记特定列以启用基于 delta 的冲突解决策略？理想状态下，可以直接通过类似以下语法完成：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> accounts <span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">COLUMN</span> balance <span class="hljs-keyword">SET</span> delta_apply <span class="hljs-operator">=</span> <span class="hljs-string">'true'</span>;
</code></pre>
<p>但这种深度集成 SQL 语法的方式实现难度较高，且对可移植性意义有限。更现实的需求是通过扩展接口完成设置，例如：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> my_extension.set_delta_apply(<span class="hljs-string">'accounts'</span>, <span class="hljs-string">'balance'</span>, <span class="hljs-literal">true</span>);
</code></pre>
<p>社区中曾多次讨论为数据库对象引入自定义属性的提案，也曾提交过内核补丁，但实现代码规模较大，而应用场景相对有限，合入内核的可行性存疑。此外，有时需要为索引、大对象或数据类型等非表对象附加属性，这进一步增加了复杂度。更重要的是，即便补丁被接受，也只能影响未来版本，而现实需求往往是“当下可用”。</p>
<h2 data-id="heading-1">功能需求</h2>
<p>实现该功能前需明确相关需求：</p>
<ul>
<li><strong>对象生命周期绑定</strong>：属性必须与数据库对象建立内部依赖关系。例如，在执行 <code>DROP … CASCADE</code> 删除父对象时，属性也应随之自动删除。</li>
<li><strong>扩展关联性</strong>：属性需要与扩展建立明确关联，以便在扩展被卸载时由数据库系统正确处理。</li>
<li><strong>事务性行为</strong>：对象属性需满足事务规则与可见性约束，并行事务修改时，新属性值仅在当前事务内可见，提交前回滚则恢复原值。</li>
<li><strong>升级与迁移支持</strong>：在 <code>pg_upgrade</code> 以及 dump/restore 过程中，属性应随数据库对象一并正确迁移。</li>
</ul>
<p>理想情况下可实现类似 PostgreSQL GUC 的会话级特性，但实现难度显著提升。</p>
<h2 data-id="heading-2">方案评析</h2>
<p>以对象 OID 为键的简易全局哈希表无法满足需求，属性值可为变长类型（如字符串），对象与属性的关联实现复杂，且无法保障事务特性与 MVCC 机制。</p>
<p>另一种思路是在扩展中创建一张 &lt;<code>key</code>, <code>value</code>&gt; 表存储属性，由扩展在运行时查询该表。这在理论上可行，但实践中问题较多：涉及升级、dump/restore、复制一致性等一系列复杂问题，同时还需持续校验对象是否存在，并引入额外的查询开销，整体可靠性较差。</p>
<h2 data-id="heading-3">实现思路</h2>
<p>具体目标是为任意表的列定义一个 <code>delta_apply</code> 属性，用于逻辑复制场景下的 UPDATE/UPDATE 冲突处理。当该属性启用时，订阅端不采用传统冲突解决策略，而是计算新旧值之间的差量，并将其累加到订阅端当前值中。</p>
<p>在 PostgreSQL 中，唯一同时满足上述全部需求的机制是 SECURITY LABELS。尽管该机制最初用于安全模块，但并未限制其仅用于安全相关元数据。需要注意以下事项：</p>
<ul>
<li>面向安全的工具可能会检查或校验标签内容。</li>
<li>需要使用独立且唯一的 provider 名称，以避免冲突。</li>
</ul>
<p>它是如何工作的？让我们看看这张图：</p>
<p><img src="http://openwrite.cn/uploads/34/59602/80cc2905-826d-4200-ad7c-c355ccdfcdd2.jpg" alt="extension_side.jpg" loading="lazy"/></p>
<p>实现的核心依赖于系统表 pg_seclabel。该表中的记录与数据库对象天然绑定，对其的增删改通过 SECURITY LABEL … 工具命令完成。扩展可以通过 utility hook 监听这一过程。</p>
<p>SECURITY LABEL 支持多种对象类型，包括视图、函数等，基本覆盖常见需求。每条标签记录包含对象的 OID 及对象类型（表、列、函数等），并通过文本字段存储任意自定义数据，同时通过 provider 字段区分不同模块生成的标签。</p>
<p>由于每次访问都直接查询 pg_seclabel 成本较高，且目前尚无系统级缓存，引入本地哈希缓存以降低开销：</p>
<pre><code class="hljs language-ini" lang="ini">typedef struct PropertyCacheEntry {
    Oid classId<span class="hljs-comment">;</span>
    Oid objectId<span class="hljs-comment">;</span>
    char *propertyValue<span class="hljs-comment">;</span>
    bool valid<span class="hljs-comment">;</span>
} PropertyCacheEntry<span class="hljs-comment">;</span>
static HTAB *<span class="hljs-attr">property_cache</span> = NULL<span class="hljs-comment">;</span>
</code></pre>
<p>通过注册 RelcacheCallback 实现缓存失效管理，对象执行 ALTER TABLE 操作时标记对应缓存条目无效。缓存填充策略可根据使用场景调整。例如，在核心 hook 中访问对象时加载，或在扩展提供的用户接口函数中主动加载。</p>
<h2 data-id="heading-4">属性增删的实现细节</h2>
<p>为了保持各后端缓存一致性，每次属性变更都需要向其他进程发送失效通知。对象本身发生变化时，可通过 RelcacheCallback 处理；但属性变更本质上只是对 <code>pg_seclabel</code> 的 DML 操作，如何通知其他后端成为问题。</p>
<p>PostgreSQL 提供了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdanolivo%2Fpgdev%2Fblob%2Fa1f7f91be2c24c0a9e8d5b9e75bc43437d5476c2%2Fsrc%2Finclude%2Futils%2Finval.h%23L75" target="_blank" title="https://github.com/danolivo/pgdev/blob/a1f7f91be2c24c0a9e8d5b9e75bc43437d5476c2/src/include/utils/inval.h#L75" ref="nofollow noopener noreferrer">CacheInvalidateRelcacheByRelid</a>，但仅适用于 <code>pg_class</code> 中的对象，对于数据类型等对象无效。因此，在实际实现中，属性变更时会触发一次对象自身的“无实质变更更新”，以借此触发相应的失效回调，从而刷新扩展内部缓存。</p>
<p>扩展通过 <code>set_property()</code> 接口向用户暴露能力，用于为指定对象设置 SECURITY LABEL。标签文本中描述属性值，例如 <code>delta_apply: true</code>。在扩展中实现的 <code>seclabel_provider</code> 回调负责校验对象类型及属性合法性。</p>
<p>标签文本字段具备高度灵活性，允许存储复杂结构，例如以 JSON 形式描述属性逻辑。</p>
<p>通过该机制，客户端与扩展之间建立了一种相对原生的通信方式。扩展可在运行时判断属性是否存在，并据此调整行为。</p>
<p>在 <code>delta_apply</code> 的具体实现中，逻辑复制订阅端在处理 UPDATE 记录时，会同时查询对应表的属性缓存。若存在标记为增量属性的列，则计算新旧值差量并累加到订阅端当前值。即便在冲突解决策略（如 last-update-wins）下决定拒绝整条更新，增量列的变更仍会被应用，从而降低冲突概率并确保增量更新不丢失。</p>
<h2 data-id="heading-5">外部干扰处理</h2>
<p>pg_seclabel 仍然是系统目录表，具备足够权限的用户（如 DBA）可以直接修改其内容。为降低风险，可在扩展中引入内部 GUC，例如 <code>myextension.call_guard</code>。在扩展 UI 函数执行前将其置为 true，结束后重置为 <code>false</code>，并在关键路径中校验其状态是否符合预期。</p>
<p>理论上，超级用户仍可能通过手段绕过该限制。虽然可以进一步为该 GUC 设置 hook 进行防护，但实现复杂度显著提高，容易演变为过度设计。</p>
<h2 data-id="heading-6">总结</h2>
<p>PostgreSQL SECURITY LABELS 机制提供了一种可靠、事务安全的方式，用于在不修改内核的情况下为数据库对象添加自定义属性。尽管该机制最初面向安全模块，但同样适用于扩展级元数据管理，且具备良好的生命周期管理与 MVCC 支持。</p>
<p>该方案支持多种对象类型，具备事务一致性，并可正确参与 dump/restore 与升级流程。</p>
<p>原文链接：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.pgedge.com%2Fblog%2Fcustom-properties-for-postgresql-database-objects-without-core-patches" target="_blank" title="https://www.pgedge.com/blog/custom-properties-for-postgresql-database-objects-without-core-patches" ref="nofollow noopener noreferrer">www.pgedge.com/blog/custom…</a></p>
<p>作者：Andrei Lepikhov</p>
<hr/>
<h2 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fjsj.top%2Ff%2FuebqBc" target="_blank" title="https://jsj.top/f/uebqBc" ref="nofollow noopener noreferrer">HOW 2026 议题招募中</a></h2>
<p>2026 年 4 月 27-28 日，由 IvorySQL 社区联合 PGEU（欧洲 PG 社区）、PGAsia（亚洲 PG 社区）共同打造的 HOW 2026（IvorySQL &amp; PostgreSQL 技术峰会） 将再度落地济南。届时，PostgreSQL 联合创始人 Bruce Momjian 等顶级大师将亲临现场。</p>
<p>自开启征集以来，HOW 2026 筹备组已感受到来自全球 PostgreSQL 爱好者的澎湃热情。为了确保大会议题的深度与广度，我们诚邀您在 2026 年 2 月 27 日截止日期前，提交您的技术见解。</p>
<p>投递链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjsj.top%2Ff%2FuebqBc" target="_blank" title="https://jsj.top/f/uebqBc" ref="nofollow noopener noreferrer">jsj.top/f/uebqBc</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[测完 GLM-5 我沉默了：国产开源模型什么时候这么能打了？]]></title>    <link>https://juejin.cn/post/7605529884823420991</link>    <guid>https://juejin.cn/post/7605529884823420991</guid>    <pubDate>2026-02-12T07:24:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605529884823420991" data-draft-id="7605547012050714665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="测完 GLM-5 我沉默了：国产开源模型什么时候这么能打了？"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-02-12T07:24:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟健AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/4212984287073895"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            测完 GLM-5 我沉默了：国产开源模型什么时候这么能打了？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984287073895/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟健AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T07:24:53.000Z" title="Thu Feb 12 2026 07:24:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是孟健。智谱刚发布了新一代旗舰模型 GLM-5，我第一时间上手测了测，跟大家聊聊真实感受。</p>
<p><strong>先说结论：工程能力已经站到了 Opus 同一梯队，某些场景甚至更舒服。这是我第一次对国产编程模型说出能打两个字。</strong></p>
<p>看看评测截图，综合能力已经非常接近 Claude Opus 4.5，部分维度甚至持平。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7503a998eb648d0834ceaf1c761a022~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=BA47E9JXMjKaej74MECzxC8bnAI%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a2012329439436880f3c685e50a5b45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=UTnP%2BT56RCpmWg8r%2BIUcjzCsE5I%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0"><strong>01 这个模型是什么</strong></h2>
<p>GLM-5 是智谱刚发布的新一代旗舰模型。参数规模 744B（激活 40B），预训练数据 28.5T。发布前在海外开发者社区已经引发了不少讨论，不少人评价它的代码能力接近 Claude Opus 4.5。</p>
<p>用 Claude Code 接入 GLM-5，直接在熟悉的工作流里测试。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8f67439a5f3452bab9cd1c085f5cf9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=XxjqKM1c3GMJDVUDSwBakQo8RJw%3D" alt="" loading="lazy"/></p>
<p>这次的定位很明确——不卷前端炫技，卷后端工程能力。744B 参数（激活 40B），28.5T 预训练数据，代号 Pony Alpha，发布前就在海外开发者圈子里炸了。</p>
<p>我比较好奇的是，它到底能不能在真实开发场景里站住脚。</p>
<p>所以设计了四个测试，从前端到后端到运维，逐个过。</p>
<hr/>
<h2 data-id="heading-1"><strong>02 测试一： 测试前端 UI 展示</strong></h2>
<p>提示词：</p>
<pre><code class="hljs">帮我设计一个 QQ 经典农场攻略网站，响应式交互。风格也要偏 QQ 经典农场那一款。相关的攻略信息可以去网上调研一下。（我说的是最近新出的 QQ 经典农场，它是小程序的，不是以前的那个网页上面的 QQ 农场。请你去网上搜索新上线的小程序版的 QQ 经典农场的所有攻略和资料）
</code></pre>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fchat.z.ai%2F" target="_blank" title="https://chat.z.ai/" ref="nofollow noopener noreferrer">chat.z.ai/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce29ee617fe24adc9dac07f61ad547da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=%2FR3xT9H1oLD0CDzlIwfH7wJUVgY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b75e1d429faf4958ac571d9143c14608~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=HmIlfTOU1QhyOy3bkfmkh72iuBI%3D" alt="" loading="lazy"/></p>
<p>虽然等待时间比 Opus 长一些（推理模型嘛，思考深度换时间），但输出质量让我挺惊喜。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ac69022183c4dffb10e4e6f941e016d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=PwmMd%2FHjIB570W%2BX8WFmFQk11gg%3D" alt="" loading="lazy"/></p>
<p>经过 15 分钟，其中还自动修了 2 次 bug，最终效果如上。说实话，比我预期好不少。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3ab8aa1550e4b64a2332f1ef3f26546~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=AysVg%2BM6IBKQtueLVLeQx2KKTk4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>0 3 测试 二 ：从零搭后端系统</strong></h2>
<p>任务：用 Node.js + SQLite 搭一个 API Key 管理系统，包含创建/撤销/验证 Key、鉴权中间件、频率限制、错误处理、Docker 配置。</p>
<p>这类任务是区分"写代码"和"做工程"的分水岭。</p>
<p>GLM-5 的表现让我真的沉默了——它没有上来就糊代码，而是先输出了一个完整的架构规划。分层目录、技术选型理由、文件职责划分都交代清楚了。</p>
<p><strong>分别让我确认每一步设置，而不是上来就干。这个工程习惯，比很多真人开发者都强。</strong></p>
<p>项目位置：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b8308aa861e4283b02d10602aae1834~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=A5SvydMEUn5NejTmkiD35FJ9s20%3D" alt="" loading="lazy"/></p>
<p>限流策略</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfdcb167a8cd4712895086f74bacf519~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=o%2Bubej5CQ1Hv%2BSiT1ZtMN7eVGiQ%3D" alt="" loading="lazy"/></p>
<p>最后提交</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72d21b0c1ebc4779a7c14dbda2c1ba5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=qk9vtlMq8nP3pVVdBMK8H5jcKvM%3D" alt="" loading="lazy"/></p>
<p>代码结构</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/497b0199e4674464a2b7098a81101e0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=uDF0GNiVYNDBUYVl37C6aY9x0a4%3D" alt="" loading="lazy"/></p>
<p>制定计划</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9abc6db596b14139905c4963871e5c2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=jJ5dO4aqTajFdo9Fl9P4oeyoj0Y%3D" alt="" loading="lazy"/></p>
<p>数据库表设计</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c7c13a8bca34e3e89a8ecb33a2a0393~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=IwVQc%2FthRCuAU%2FRsmI71c9SLE4A%3D" alt="" loading="lazy"/></p>
<p>核心功能实现</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f51f91daf9594a28aca30e57a2a5c83b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=OzpS%2FrKBi6YtIsXCxS58INZYxaM%3D" alt="" loading="lazy"/></p>
<p>有几个细节让我印象深刻：</p>
<ul>
<li>
<p>API Key 用哈希存储而不是明文，安全意识到位</p>
</li>
<li>
<p>频率限制、错误处理都写了，不是那种"能跑就行"的 demo</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc89b6776338459c9a7c16b93fe3579b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=A8WuLPF5hpO766Ot3zO836II93E%3D" alt="" loading="lazy"/></p>
<p><strong>唯一可以优化的地方：一次性输出的代码量很大，如果能加入分步验证会更完美。不过就完成度来说，一次生成 10+ 个文件、项目结构完整、直接能跑——我用 Opus 做类似任务，也就这个水平了。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4ec095f0e124a589478163a4deb2373~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=bHq0IG8SDPGYAhsxVRhbOORYhIc%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3"><strong>0 4 测试 三 ：Debug 真实报错</strong></h2>
<p>第一个例子启动报错，直接问 GLM-5：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94a10279cd7748588ed5624f0578589c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=qeR%2BPga9FbnIA4Qafp1GYvPNFbY%3D" alt="" loading="lazy"/></p>
<p>这是我自己当时踩过的坑，搜了不少资料才搞定的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e37391bf09f46baa946fe58c6e3ed42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=Y2TmxECNpYPsWJlrUsrPtTKZl5Y%3D" alt="" loading="lazy"/></p>
<p>GLM-5 的分析路径非常清晰：第一个方案定位到占用 3000 端口的进程并给出关闭命令；第二个方案直接改用其他端口。</p>
<p><strong>两个方案都是对的。没有瞎猜，没有给一堆你可以试试的废话。直接定位，直接给方案。</strong></p>
<p>这个能力对不熟悉运维的小伙伴来说太实用了——看见黑窗口报错不用慌，直接问就行。</p>
<hr/>
<h2 data-id="heading-4"><strong>0 5 测试 四 ：自动化部署方案</strong></h2>
<p>让它设计一个全栈应用（Next.js + Express + PostgreSQL）到 Ubuntu 服务器的自动化部署方案，从环境准备到 SSL 配置全覆盖。</p>
<p><strong>输出的是一个完整的 Shell 脚本，带颜色日志、每步成功/失败判断、错误回退。这不是教程级别的伪代码，是真能往服务器上跑的生产脚本。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d58973296b647ef8092bb49c3b53d8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=CDfcfeMZjKpyFjXHpnAFgtgGsdk%3D" alt="" loading="lazy"/></p>
<p>还能输出部署架构图，对全栈部署的理解很到位！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39eff8de76884fa68092099a7de60213~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=pekk9hdUdx2HdSAEfIU1GQQloL0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22fdfc4923934aa7896a766289747465~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771485893&amp;x-signature=fkh2Fhib5QIqxzBez%2FoSWh4q81I%3D" alt="" loading="lazy"/></p>
<p>值得注意的是：智谱在宣传里说 GLM-5 可以在数百次工具调用后保持连贯。我这次测试只是冰山一角，更复杂的长程 Agent 场景值得期待。</p>
<hr/>
<h2 data-id="heading-5"><strong>0 6： 几个真实的不足</strong></h2>
<p>客观说说还可以优化的地方：</p>
<p>速度可以更快。作为推理模型，一个中等复杂度的请求要等 30-60 秒。不过思考深度和输出质量摆在这里，这个取舍是值得的。而且智谱在持续优化推理速度，这个问题相信很快会改善。</p>
<p>工具链生态在快速完善。智谱已经提供了 Anthropic API 兼容层，可以接入 Claude Code 等主流工具。API 直接调用已经非常稳定，开源生态意味着更大的可能性——社区适配只是时间问题。</p>
<p>开源带来的想象空间。和闭源模型不同，GLM-5 的开源意味着可以私有化部署、可以微调、可以嵌入自己的工具链。这对企业用户来说是巨大的吸引力。</p>
<p>中等难度已经很稳了，期待后续测一些更硬核的场景——重构万行遗留系统、从零写编译器这种级别的挑战。</p>
<hr/>
<h2 data-id="heading-6">0 7： 怎么看这件事</h2>
<p><strong>抛开模型本身，我觉得更值得关注的趋势是：编程大模型正在从能写代码跨到能做工程。</strong></p>
<p>Opus 4.6 在做这个，GPT-5.3-Codex 在做这个，现在 GLM-5 也在做这个。区别是 GLM-5 开源，跑在国产芯片上，成本低一个量级。</p>
<p>其实回头看，国产大模型在好几个方向上已经不是追赶了。Seedance 2.0 在 AI 视频生成上已经是全球第一梯队，海外用户的口碑非常好。现在 GLM-5 在 AI Coding 方向上也站到了同一梯队。视频生成和代码生成，AI 落地最重要的两个航道，国产模型都已经站到了牌桌上。</p>
<p>现在我的日常编程任务已经开始切到 GLM-5 了。中等复杂度的工程任务、Debug、部署脚本——GLM-5 接得稳稳的，省下来的 API 费用相当可观。</p>
<p>如果你还没试过国产编程模型，GLM-5 绝对值得放进你的工具箱。它可能会让你重新认识国产大模型这五个字。</p>
<hr/>
<h2 data-id="heading-7"><strong>0 8： 怎么用</strong></h2>
<ol>
<li>
<p><strong>智谱官网对话</strong>：访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fchat.z.ai%2F%25EF%25BC%258C%25E9%2580%2589%25E6%258B%25A9" target="_blank" title="https://chat.z.ai/%EF%BC%8C%E9%80%89%E6%8B%A9" ref="nofollow noopener noreferrer">chat.z.ai/，选择</a> GLM-5 模型直接体验</p>
</li>
<li>
<p><strong>API 调用</strong>：在智谱开放平台 open.bigmodel.cn 注册获取 API Key</p>
</li>
<li>
<p><strong>Claude Code 接入</strong>：智谱提供了 Anthropic 兼容 API，改一下 Claude Code 的配置文件就能用 GLM-5 驱动编程</p>
</li>
</ol>
<hr/>
<p><strong>开源、国产芯片、Opus 级能力——这三个词放在一起，就是 2026 年 AI 编程最大的变量。GLM-5 不是在追赶，是在开辟另一条路。</strong></p>
<hr/>
<p>如果这篇对你有帮助，欢迎点赞、收藏、关注，你的支持是我持续输出的动力 ✨</p>
<hr/>
<p>我的其他平台账号和开源项目在个人主页中，欢迎交流 🤝</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[码上过年！来沸点晒出你的技术er年味]]></title>    <link>https://juejin.cn/post/7605516501751873545</link>    <guid>https://juejin.cn/post/7605516501751873545</guid>    <pubDate>2026-02-12T07:35:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605516501751873545" data-draft-id="7605492906905042990" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="码上过年！来沸点晒出你的技术er年味"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2026-02-12T07:35:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金酱"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194374926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            码上过年！来沸点晒出你的技术er年味
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194374926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T07:35:57.000Z" title="Thu Feb 12 2026 07:35:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc937a6598914a9fba96fd48b377c949~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486557&amp;x-signature=T4FOHPg508ldqVP0GwP3n3HOCgQ%3D" alt="红色印象派2026新年快乐春节马年节日祝福公众号封面.jpg" width="100%" loading="lazy"/>
<p>掘友们，新年好！</p>
<p>无论你已踏上归途，开启温馨「团圆副本」，还是坚守岗位，进入硬核「值班闯关」模式，这个春节，稀土掘金陪每一位技术人一起过年。</p>
<p>我们邀请你用文字、代码、照片，记录属于程序员的独特春节瞬间，让技术与年味撞个满怀。</p>
<h2 data-id="heading-0">一、活动时间</h2>
<ul>
<li>活动参与期：2026年2月12日 — 2026 年 2 月 23 日 23:59</li>
<li>数据统计截止：2026 年 2 月 23 日 23:59</li>
<li>名单公示：活动结束后 7 个工作日内，在掘金酱公布</li>
</ul>
<h2 data-id="heading-1">二、参与方式</h2>
<p>在掘金发布沸点，带上话题： <a href="https://juejin.cn/pin/topic/7605771698889850907" target="_blank" title="https://juejin.cn/pin/topic/7605771698889850907"><strong>#寻找年味</strong></a></p>
<h2 data-id="heading-2">三、分享内容方向</h2>
<p>不限形式、不限风格，只要是「技术人的春节」，都值得被记录：</p>
<ul>
<li>家乡年味、团圆时刻、新春趣事</li>
<li>工位日常、值班片段、代码灵感</li>
<li>节日小脚本、<strong>AI</strong> <strong>整活</strong>、技术向新春祝福</li>
<li>任何专属于程序员的过年瞬间</li>
</ul>
<h2 data-id="heading-3">四、活动福利</h2>
<p>新春福利，重磅解锁：</p>
<p>✅ 常规内容赛道：互动量 + 评审团综合打分，TOP10赢 <strong>SZCOOL 无线蓝牙音箱</strong></p>
<p>✅ AI 内容赛道：互动量 + 评审团综合打分，TOP10 拿下「窝在一起」瓦楞猫窝</p>
<p>✅阳光普照奖：凡是符合<a href="https://juejin.cn/pin/topic/7605771698889850907" target="_blank" title="https://juejin.cn/pin/topic/7605771698889850907">#寻找年味</a>主题的且有互动（排除作者自己点赞和评论）的沸点内容皆可获得10w 矿石</p>
<h2 data-id="heading-4">五、获奖规则</h2>
<ol>
<li>参赛沸点互动量按「点赞数 + 评论数」总和核算；</li>
<li>同一用户发布多条内容，仅取数据最优一条参与排名获奖；</li>
<li>无意义水评论、刷赞等违规行为，剔除获奖资格；</li>
<li>数据统计截止至 2026 年 2 月 23 日 23:59，逾期新增互动不计入；</li>
<li>禁止引战/制造冲突/谩骂内容，或者发现引战内容剔除获奖资格；</li>
<li>评审团会依据沸点内容质量进行打分排序；</li>
<li>非AI相关内容都归类为常规内容赛道，两个赛道不重复获奖，阳光普照奖可叠加赛道获奖；</li>
<li>活动最终解释权归稀土掘金所有；</li>
</ol>
<h2 data-id="heading-5">六、写在最后</h2>
<p>代码不停，年味常在。这个春节，不用刻意迎合，只需真实记录。</p>
<p>你的工位、你的代码、你的年夜饭、你的团圆时刻，你的AI学习记录等等都是技术人最动人的新年风景。</p>
<p>欢迎每一位掘友踊跃参与，让我们在沸点相遇，互相陪伴，一起过个有温度、有技术的春节！</p>
<p>快带 <a href="https://juejin.cn/pin/topic/7605771698889850907" target="_blank" title="https://juejin.cn/pin/topic/7605771698889850907">寻找年味</a>话题<a href="https://juejin.cn/pins" target="_blank" title="https://juejin.cn/pins">发布</a>你的新春第一条沸点吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[神仙打架+1！讯飞星火X2硬核亮相，行业深度全面升级]]></title>    <link>https://juejin.cn/post/7605469747259686947</link>    <guid>https://juejin.cn/post/7605469747259686947</guid>    <pubDate>2026-02-12T07:37:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605469747259686947" data-draft-id="7605494530016509992" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="神仙打架+1！讯飞星火X2硬核亮相，行业深度全面升级"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2026-02-12T07:37:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="量子位"/> <meta itemprop="url" content="https://juejin.cn/user/2858385963484488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            神仙打架+1！讯飞星火X2硬核亮相，行业深度全面升级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385963484488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    量子位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T07:37:11.000Z" title="Thu Feb 12 2026 07:37:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天，国产大模型再次迎来硬核进阶！</p>
<p>科大讯飞小年放出推理王炸——<strong>星火大模型 X2</strong>。</p>
<p>什么概念呢？从星火 X1.5 到星火 X2，仅仅间隔 3 个月，推理性能直接飙升 50%～</p>
<p>不仅快，而且猛。更重要的是，完全基于<strong>国产算力</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b876ac134d044aea5215a8631e32eda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=12o6C%2BWr1lybkGPus72adnKA7Ug%3D" alt="" loading="lazy"/></p>
<p>一方面，<strong>模型通用能力</strong>突出，Benchmark 评测稳居行业一流水平，即使是和 GPT-5.2、Gemini-3-Pro 这些国际顶尖模型同台竞技也毫不逊色。</p>
<p>尤其是在数学计算、逻辑推理等核心能力上表现亮眼；同时 130 多种语言综合能力依旧稳稳在线，继续保持 “国家队” 水准。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4bd548e55a24729aa8bdd59876694c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=0Fb%2B31aIz1k1QmoIid8X25w2jGo%3D" alt="" loading="lazy"/></p>
<p>另一方面，星火 X2 将升级的重点放在了<strong>场景落地</strong>上。</p>
<p>依靠深度优化的算法、高质量垂域数据和行业专家的参与，三位一体推动行业大模型更进一步，为各行各业提供更精准、更具实操性的支持。</p>
<p>正如科大讯飞董事长刘庆峰在 1024 开发者节所说——<strong>做更懂你的 AI</strong>，满血归来的星火 X2 现在用<strong>通用底座 + 行业专才</strong>双轮驱动，再次印证了其在国产大模型赛道的实践底气。</p>
<h2 data-id="heading-0">通用能力全面升级</h2>
<p>星火大模型作为讯飞 AI 架构的底层基石，按照惯例，每一次升级，都有着显著的能力跃迁。</p>
<p>这一次更甚：直接将深度推理训练效率再度提升 <strong>50%</strong>。</p>
<p>众所周知，随着 Scaling Laws 边际效益递减，越到后期，大模型性能提升就越难。即使是 1% 的能力跃迁，都意味着算力和算法的指数级倍增。</p>
<p>而在行业普遍面临增长瓶颈的当下，星火 X2 能够实现 50% 的性能跃迁实属不易。</p>
<p>其背后释放的信号，比数字本身更值得深思，这透露出科大讯飞在模型核心架构和技术上有了更深层次的突破。</p>
<p>具体先看核心能力对比。</p>
<p>横向对比来看，星火 X2 Thinking 的各项评分已经<strong>稳居国产第一梯队</strong>，在多个维度上也与 GPT-5.2 (xhigh) 和 Gemini-3-Pro 非常接近。</p>
<p>其中，在多语言和翻译能力上显著优于友商模型，在数学和逻辑推理上也紧随 GPT 和 Gemini 其后。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc1fe8d060a942048789c45f9747fb69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=v7xbsGKeB%2BTNayqYHqoBc7fxH9s%3D" alt="" loading="lazy"/></p>
<p>再看星火 X2 在<strong>高难度基准测试</strong>中的表现，可以说含金量杠杠的。</p>
<p>比如在 AIME 2025 测试中，星火 X2 斩获 95.7 分，仅次于 GPT-5.2 (xhigh)，展现出其处理竞赛级数学的顶尖能力。</p>
<p>在 MMLU Pro 里，星火 X2 的 87.3 分不仅在国产模型中夺冠，且与 GPT-5.2 持平，说明其知识广度和深度已达国际一流水准。</p>
<p>在代表未来方向的智能体维度上，星火 X2 也是再度领跑国产模型，验证了它在理解复杂指令和调用工具方面的进阶。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5fb40e3ecdc48488e7d54b7fd88be4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=98Kv%2F2ZSH8xmbnqwbbegpB0NHn8%3D" alt="" loading="lazy"/></p>
<p>总的来说，星火 X2 在数据上的亮眼表现，不仅彰显了讯飞在数学和逻辑推理领域的领先地位，更标志着其通用智力已足以比肩国际顶尖模型。</p>
<p>接下来咱们还是实测见真章。</p>
<p>先来一道去年 11 月哈佛 - 麻省理工数学锦标赛_（HMMT）_里的英文题目试试水～</p>
<p>之所以选择这个题目，一则是避免数据污染，题目比较新，能够避免模型 “见” 过该题目；其二是 HMMT 是全球难度最高的数学竞赛之一，能够更好地考验星火 X2 的即时逻辑推理能力。</p>
<blockquote>
<p>A positive integer n is imbalanced if strictly more than 99 percent of the positive divisors of n are strictly less than 1 percent of n. Given that M is an imbalanced multiple of 2000, compute the minimum possible number of positive divisors of M.</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36dfcafba04c41339fd0d2106c241e53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=bBqjVylnRf%2FcPsPJnxU%2BnRGIqxw%3D" alt="" loading="lazy"/></p>
<p>果不其然非常出色，星火 X2 迅速给出了详细的解答过程和正确答案。换言之，它彻底吃透了英文数学题目的底层逻辑，而非简单依赖中文语境。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5e33c04e2334c61b8e4b7a57265bb73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=zBzMFB%2F9QKtkUeMl2uD21d%2FKoms%3D" alt="" loading="lazy"/></p>
<p>再试试西班牙语：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18eeffbfb8144139904e1941e9928799~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=NQKfXG2n5lz36DeXvxGZLxNApng%3D" alt="" loading="lazy"/></p>
<p>同样也是流畅给出了正确结果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/881bd423e2574108938d74b217019a98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=oI3lh5P3COwVqoDJghss9QZI44E%3D" alt="" loading="lazy"/></p>
<p>那么它是如何做到的呢？</p>
<p>首先，星火 X2 在模型架构上继承了星火 X1.5 的 <strong>MoE</strong> 稀疏架构，参数同样为 293B。</p>
<p>但与之不同的是，在星火 X1.5 的基础之上，星火 X2 结合权重量化、低精度 KVCache、VTP_（Virtual Tensor Parallel）_、分层通信进行了针对性技术创新：</p>
<ul>
<li><strong>训推采样校准强化学习算法：</strong></li>
</ul>
<p>在大模型，尤其是 MoE 架构中，往往存在训推分布不一致的问题，这会导致模型在训练阶段学到的规律无法直接适用到实际推理应用中，甚至会出现模型性能坍塌。</p>
<p>为此，星火 X2 提出训练与推理概率重采样自适应校准算法，让算法能够根据训练的实时进度，自动调整校准力度，确保专家模型能够时刻保持逻辑闭环。</p>
<ul>
<li><strong>递归式高难数据合成方法：</strong></li>
</ul>
<p>在模型训练中，由于深度推理数据极度匮乏，星火 X2 专门设计了多轮迭代式推导的数据合成方案。</p>
<p>通过多轮迭代和递归修正，能够最终形成一套从问题到正确推导过程的高质量语料，完成对模型深度推理准确率的提升。</p>
<ul>
<li><strong>多阶段 RL 高吞吐采样方法：</strong></li>
</ul>
<p>在突破国产算力瓶颈上，星火 X2 设计了 P/D_（Prefill/Decoder）_两阶段分离的多阶段推理采样方案。</p>
<p>他们将大模型推理过程中物理特性完全不同的两个阶段——Prefill_（预填充）<em>和 Decoding</em>（解码）_，从硬件执行层面进行彻底分离，直接解决了国产化平台在高吞吐采样下的效率干扰，训练效率提升 10%。</p>
<ul>
<li><strong>服务高性能部署优化算法：</strong></li>
</ul>
<p>这一步是让星火 X2 推理性能大幅度提升的关键。</p>
<p>通过对模型进行轻量化压缩，可实现单台服务器内部的批量专家并行，也就是单机大 EP 并行部署。</p>
<p>充分解决了国产算力平台的关键瓶颈——<strong>轻量化落地</strong>和<strong>高效推理</strong>，让模型不仅能跑，还能跑得快。</p>
<h2 data-id="heading-1">带动行业大模型实现突破</h2>
<p>除了通用能力的全面释放，星火大模型此次升级的重中之重，在于深度场景化。</p>
<p>这是科大讯飞从星火大模型诞生之初，就始终强调的核心逻辑：<strong>要在发展技术力的同时，更注重技术与用户体验、场景落地的结合。</strong></p>
<h6 data-id="heading-2">**<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7bbc4f45901446f89c2b06ef468e5dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=QNtQFulFIFVM65xHcGm%2BuQ4WzlE%3D" alt="" loading="lazy"/></h6>
<p>**</p>
<h6 data-id="heading-3"><strong>△</strong>图片源自智能超参数</h6>
<p>具体体现在医疗、教育、汽车和智能体四个方面：</p>
<h4 data-id="heading-4">赋能医疗领域，持续保持业界领先</h4>
<p>依托星火 X2 底座的算力优化与推理跃迁，<strong>星火医疗大模型</strong>的核心能力也得到了全面进化，继续保持行业翘楚。</p>
<p>在基于居民健康档案的智能健康分析、智能报告解读、运动饮食建议、辅助诊疗、智能用药审核等高精度核心场景中，星火大模型更是显著优于 GPT-5.2 和另外两款国产大模型，树立了医疗专业大模型的新标杆。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dbd9bfaa01b45659f8920bd0972ce71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=xXXeVbe6AOWO4mnPj%2F0vdgT8wO8%3D" alt="" loading="lazy"/></p>
<p>此外，星火医疗大模型也已率先通过上海市医疗大模型应用检测验证中心评测验证。</p>
<p>这是国内首个专门针对医疗大模型的评测平台，代表了目前国内最顶尖、最权威的标准，说明讯飞已经在医疗 AI 合规上走到了行业前列。</p>
<p>而在面向用户的 C 端，**“讯飞晓医”**APP 也同步完成升级，包括多轮主动问诊、多轮咨询问答、问用药、检查检验单解读、体检报告单解读等多任务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e2d82e7c0ca4d199f7c4ccc529994d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=UFdGIz%2Ftc75j%2Bw0UVD9IwcieIOU%3D" alt="" loading="lazy"/></p>
<p>可见，“讯飞晓医” 在星火 X2 的加持下，已经成为了普通用户可用的且能力业界顶尖的数字医生。</p>
<h4 data-id="heading-5">赋能教育领域，实现个性化教学</h4>
<p>而在<strong>教育领域</strong>，星火大模型也让原先基础的搜索工具，进化为一对一特级老师。</p>
<p>其率先上线<strong>错因贯穿的个性化学习能力</strong>，能够通过你的整张卷子、整道题的解题思路，精准捕捉到你的知识点黑洞，比如是定理没记牢呢，还是运算粗心大意了。</p>
<p>同时它能够像阅卷老师一样，在错误之处精准批注，实现步骤级批改。</p>
<p>这种模式下，AI 更符合苏格拉底式的教学理念，也就是通过不断提问，引导学生自己思考并得出结论。</p>
<p>它不是直接告诉学生答案，而是教会学生如何进行思维拆解、如何自己悟出来。而这类启发式讲解，也是未来 AI 教育的主导路线。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cb546cd5b0641a88efd347de8387fd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=u0cPwAUgOD%2BAb82ajSZX%2FtI6Jfg%3D" alt="" loading="lazy"/></p>
<p>体现在硬件上，就是科大讯飞的 AI 学习机。它在 1 对 1 精准学、答疑辅导和互动课等多功能上，持续领先同行业，能够帮助学生更精准地提高学习效率，以及增强学习兴趣。</p>
<h4 data-id="heading-6">赋能汽车领域，全面升级智能座舱交互系统</h4>
<p>与此同时，星火大模型在多尺寸中小模型上也同步进行了升级，并精准将其应用在<strong>汽车智能座舱交互系统</strong>中。</p>
<p>过去用户必须说出精准指令才能实现交互，比如调低空调至 24 度。但如果说 “我有点冷” 或者 “风太大” 这类模糊指令，系统往往只会回复“对不起，我没有听懂”。</p>
<p>但现在这个问题随着星火 X2 的到来迎刃而解。</p>
<p>模型在人人 / 人机对话判断、模糊意图理解、高情商回复等方面的交互体验显著提升，尤其是在模糊意图上实现了跨越式突破，终于具备了<strong>实际可用的</strong>语义联想和推理能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d47b781746e4b999a189118b9c5065a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=VQmy%2F8X2ohH7%2BkrV7LYElXo2Fvw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">赋能智能体平台和精品智能体新升级</h4>
<p>另外值得关注的是，<strong>智能体</strong>的突破。</p>
<p>星火 X2 从根本上解决了智能体在工作环境中长期以来的痛点，在长时复杂任务规划、多工具组合调用以及长上下文等方面均实现了显著提升。</p>
<p>其中<strong>星辰 Agent 平台</strong>，整合了语音识别、语音交互、图像理解等百余种能力，集成超 130 万个智能体，在星火 X2 帮助下，进一步强化了智能体在思考和执行上的表现，更能支撑起复杂的企业场景。</p>
<p>比如面向企业采购场景的招采智能体，核心场景效率提升超 3 倍，还能像搭积木一样定制专用智能体，开发时间从原先的几天直接缩短至分钟级。</p>
<p>目前讯飞开放平台已正式上线星火 X2 API，平台新注册开发者可直接领取 <strong>100 万 Tokens 免费额度</strong>。</p>
<p>在讯飞星火网页版和 APP 均可体验，星火 APP 5.2.0 新版本也同步上线～</p>
<h2 data-id="heading-8">国产算力突围下的讯飞星火</h2>
<p>总的来说，星火 X2 更像是一块<strong>国产算力的试金石</strong>。</p>
<p>在过去几年里，国内 AI 行业发展受限的根本原因就在于算力。算力被扼住脖子后，模型性能始终无法突破国际一流水平。</p>
<p>而当所有人都在质疑国产算力时，讯飞咬牙给它做成了。而且是国内主流大模型中，唯一基于全国产算力训练的通用大模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a66bfad58da4e19857d5fd912b1abdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771486631&amp;x-signature=rygrPPcOmWnAUEDLiXzNuIZnTVA%3D" alt="" loading="lazy"/></p>
<p>模型实现了<strong>完全自主可控</strong>，一是算力自主，模型的训练和推理过程完全基于全国产算力平台；二是技术自主，整个模型框架均由讯飞自研，在此基础上构建起特有的研发生态。</p>
<p>核心原因就在于讯飞走了最务实的一条路：不再单纯追求实验室里的高分，而是依据自己深耕多年的行业经验一举扎根在最难的场景应用中。</p>
<p>讯飞顺势提出了 <strong>“1+N” 战略</strong>，即 1 个通用底座大模型，和 N 个底座大模型赋能的多领域行业大模型，然后通过软硬一体化，让大模型搭载到硬件上，以看得见摸得着的方式迅速落地转化。</p>
<p>简单来说，讯飞的差异化路径就是<strong>底座自主、硬件协同、场景为王</strong>。</p>
<p>而星火 X2 反向证明了这条路值得继续探索，即使是在算力重压下，单靠算法创新和场景优化也能补足当中的差距，换来中国 AI 在全行业的先发优势。</p>
<p>显然，国产大模型已步入应用红利期，而讯飞率先摘到了果实。</p>
<p><strong>欢迎在评论区留下你的想法！</strong></p>
<p>— <strong>完</strong> —</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GLM-5真够顶的：超24小时自己跑代码，700次工具调用、800次切上下文！]]></title>    <link>https://juejin.cn/post/7605468286181408803</link>    <guid>https://juejin.cn/post/7605468286181408803</guid>    <pubDate>2026-02-12T08:00:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605468286181408803" data-draft-id="7605494530016575528" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GLM-5真够顶的：超24小时自己跑代码，700次工具调用、800次切上下文！"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2026-02-12T08:00:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="量子位"/> <meta itemprop="url" content="https://juejin.cn/user/2858385963484488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GLM-5真够顶的：超24小时自己跑代码，700次工具调用、800次切上下文！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385963484488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    量子位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T08:00:07.000Z" title="Thu Feb 12 2026 08:00:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当看到 <strong>GLM-5</strong> 正式发布后的能力，才惊觉前几天神秘模型 Pony Alpha 的热度还是有点保守了。</p>
<p>因为这一次，GLM-5 直接把<strong>开源 AI</strong> 也拽进了<strong>长任务时代</strong>。</p>
<p>瞧，GLM-5 直接身兼数职，自己连续跑代码<strong>超过 24 小时</strong>，700 次工具调用、800 次上下文切换之后……</p>
<p>它直接用 JavaScript，从零手搓了一个 <strong>Game Boy Advance（GBA）模拟器！</strong></p>
<p>外观渲染画面是这样的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24161bc391654ab2bb8cbeec51b9075c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771488007&amp;x-signature=cFRlpcC0py6Y%2FTnrOS%2FOFx6vJqI%3D" alt="" loading="lazy"/></p>
<p>屏幕里是这样的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb9cd72d50704bff9c179d0b9b49c4e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771488007&amp;x-signature=vB1VaighyXC2qzIUNPjW45tSYhw%3D" alt="" loading="lazy"/></p>
<p>在没有渲染情况下的动态效果如下：</p>
<p><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">视频详情</a></p>
<p>GLM-5 依旧是精准地捕捉到了 Prompt 中的关键词，生成的 HTML 文件打开后，一个光影交错的十二面体悬浮在空中。</p>
<p>除此之外，包括像<strong>全栈类型任务</strong>，例如制作一个完整、有设计感的电商网站，GLM-5 也是可以拿捏。</p>
<p>以及有人也用 GLM-5 手搓了个 3D 版可交互的**《我的世界》！**</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/666e0fca307c49a693ee4d38d20bb0f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771488007&amp;x-signature=Wk%2Bj8F9XV7QZ3nMwobhaWWl7ODM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">开源，Win Again</h2>
<p>GLM-5 的出现，不论是从实测还是网友们的反响来看，都在标志一件事情：</p>
<p>开源大模型完成了一次从助手到独立工程师的质变。</p>
<p>以前，我们用 AI 是写一句 Prompt，但需要不断地去做调试的工作；但现在，用 GLM-5 可以是给它一个目标，然后去喝咖啡，偶尔回来看看它有没有跑偏。</p>
<p>更宏观地来看，这对于 SaaS 行业来说，也可能是一场风暴。</p>
<p>毕竟就在前几天，随着 Claude Opus 等具备长任务能力的闭源模型展现威力，国外市场已经出现了恐慌。</p>
<p>例如当时金融数据服务商 FactSet 最惨盘中暴跌 10%，S&amp;P Global、穆迪、纳斯达克公司纷纷下跌，各大指数全线跳水。</p>
<p>Fortune 和 CNBC 报道称，SaaS 软件类股票遭到抛售，投资者担心，如果 AI 能现场手搓一个 CRM 系统，谁还去买年费软件。</p>
<p>虽然黄仁勋安抚说 AI 会增强现有工具，但 GLM-5 的实测表现告诉我们：重塑或许已经在发生。</p>
<p>更重要的是，之前这种能力是闭源巨头的特权。现在，GLM-5 把这把钥匙交到了所有开发者手里。</p>
<p>或许这次开源模型 24 小时不间断自己跑代码只是一个起点，未来会更长、更快、更好、更强。</p>
<h2 data-id="heading-1">Two More Things：</h2>
<p>GLM 其实从 4.5 版本开始就死磕 AI 编程这件事，现在这个国产 AI 的 coding 套餐在国内外也是相当火爆；这次智谱一上来就限售，外国网友们都是在 “求” 的状态。</p>
<p>以及，智谱公司的大楼，现在也是成了个<strong>打卡点</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7540a1216feb47b2bb3d0a770b7968c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771488007&amp;x-signature=81sF0o%2F1aqLCo7k6FTzzHKAKbUk%3D" alt="" loading="lazy"/></p>
<p>开头我们提到的 GBA 模拟器，由于 GLM-5 一直在跑，程序员小哥哥下班打车是这样的：Agent 乘客<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bdf5fb599d64cb49a538a54b6cc5498~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771488007&amp;x-signature=GGw6YP3%2Fm3b7zVlLyKFcWBZx3%2FE%3D" alt="" loading="lazy"/>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c30840090ec44c528e7b1be1b448a700~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771488007&amp;x-signature=QDBsDhXQywNZhT%2FBVWCEe3i0i08%3D" alt="" loading="lazy"/></p>
<p>GitHub：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzai-org%2FGLM-5" target="_blank" title="https://github.com/zai-org/GLM-5" ref="nofollow noopener noreferrer">github.com/zai-org/GLM…</a></p>
<p>Hugging Face：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fzai-org%2FGLM-5" target="_blank" title="https://huggingface.co/zai-org/GLM-5" ref="nofollow noopener noreferrer">huggingface.co/zai-org/GLM…</a></p>
<p>ModelScope：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelscope.cn%2Fmodels%2FZhipuAI%2FGLM-5" target="_blank" title="https://modelscope.cn/models/ZhipuAI/GLM-5" ref="nofollow noopener noreferrer">modelscope.cn/models/Zhip…</a></p>
<p>GameBoy Advance 体验：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fe01.ai%2Fgba" target="_blank" title="https://e01.ai/gba" ref="nofollow noopener noreferrer">e01.ai/gba</a></p>
<p><strong>欢迎在评论区留下你的想法！</strong></p>
<p>— <strong>完</strong> —</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[华为升级行业Agent算法架构！MindScale自己写prompt和工作流，KV Cache减少5.7倍token]]></title>    <link>https://juejin.cn/post/7605489943869128719</link>    <guid>https://juejin.cn/post/7605489943869128719</guid>    <pubDate>2026-02-12T08:02:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605489943869128719" data-draft-id="7605494530016624680" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="华为升级行业Agent算法架构！MindScale自己写prompt和工作流，KV Cache减少5.7倍token"/> <meta itemprop="keywords" content="AIGC,AI编程,Agent"/> <meta itemprop="datePublished" content="2026-02-12T08:02:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="量子位"/> <meta itemprop="url" content="https://juejin.cn/user/2858385963484488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            华为升级行业Agent算法架构！MindScale自己写prompt和工作流，KV Cache减少5.7倍token
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385963484488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    量子位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T08:02:24.000Z" title="Thu Feb 12 2026 08:02:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大模型的多种应用形态中，执行专业功能的行业 Agent，无疑是提升生产效率、实现价值创造的利器。</p>
<p>然而，千行百业包含着大量的<strong>私域知识、专家经验和工具使用逻辑</strong>，使得智能体的行业应用构建存在各类门槛。</p>
<p>为了提升开发效率，业界提出了诸如 Skills、OpenClaw 等优秀的工程框架，使得专业 Agent 的开发门槛日益降低，也让针对 Agent 应用的多维度算法优化需求愈发凸显。</p>
<p>在此背景，<strong>华为诺亚方舟实验室</strong>近期在官网更新了面向行业应用的<strong>算法包 MindScale</strong>，这一项目融合了实验室的算法创新基因与华为行业智能化业务实践经验。</p>
<p>其系统性梳理了 Agent 时代将 “大模型” 转化为 “生产力” 的算法技术挑战，并给出了对应的<strong>技术论文</strong>与<strong>昇腾代码</strong>实现，为行业用户与开发者提供了直接的 “上手指南”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfd377f9fbe74b8384b99da468a8de28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771488143&amp;x-signature=PmVRMaL9n%2F%2BaYwIBr1lhzF9dzug%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">制约行业 Agent 发展的四大核心挑战</h2>
<p>在 MindScale 项目中，研究人员识别了在行业普及 Agent 应用的四大挑战：</p>
<ul>
<li>
<p><strong>工作流手工维护</strong>：依赖专家将业务规则 “翻译” 为 Agent 工作流；</p>
</li>
<li>
<p><strong>历史知识复用难</strong>：历史推理路径与反馈无法有效使 Agent 系统自演进；</p>
</li>
<li>
<p><strong>训推效率瓶颈</strong>：大量模型部署与迭代需求 + 思考路径变长，成本压力陡升；</p>
</li>
<li>
<p><strong>复杂推理测评</strong>：多步、多工具交织推理，单精度指标无法准确反映模型效果。</p>
</li>
</ul>
<h2 data-id="heading-1">实现工作流自进化与提示词自动化闭环</h2>
<p>为了应对这些挑战，诺亚的研究人员与多所合作单位一道，给出了自己的解决方案。</p>
<p>例如，面向行业 Agent 开发中最常见的工作流_（Workflow）_开发场景，算法包中包含了自进化的 Agent 算法 <strong>EvoFabric</strong>。</p>
<p>与手动提取工作流高度依赖专家经验不同，使用 SOP2Workflow 可以快速从自然语言文档与历史工具库，直接生成可执行的 Workflow。</p>
<h6 data-id="heading-2"><strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2183d00d204d451aa729e3c0d652627f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771488143&amp;x-signature=VuCjFGueFPAgfKtSZgoHm%2FyfUNM%3D" alt="" loading="lazy"/>△</strong>由用户书写的网页功能测试 SOP→自动生成的整个 Workflow</h6>
<p>为了实现这样灵活的 Workflow 生成，研究人员采用了基于状态图引擎内核的 Agent 实现，原生支持混编 Agent、工具等多种图节点，支持状态的改写和分组融合处理，实现多智能体、多工具、多记忆形态的深度混编，图引擎还支持 DSL 文件的导入与导出，实现复杂智能流程的快速复制、迁移与部署。</p>
<p>同时，该算法框架还可以实现<strong>基于记忆的演进</strong>——多轮执行时，记忆模块利用轨迹记忆，以及当时的评估结果形成经验优化上下文，实现 Agent 越用越好。</p>
<p>另一个有趣的功能，是让模型开始<strong>自己进行 “prompt 优化”</strong>。</p>
<p>首先，基于前期已经先行发布的 prompt 在线优化算法 SCOPE，开发者可以实现在每步推理之间进行 prompt 在线优化，通过注入萃取历史路径中的有效信息实现提示词的快速优化，在 HLE 和 GAIA 等 agentic reasoning 的场景里可以取得 20% 以上的精度提升。</p>
<p>此外，研究人员还提出了 “大模型 prompt 优化器”C-MOP，通过创新的样本选取与梯度更新策略，解决了“文本梯度” 的冲突问题，实现了基于正负例反馈的 prompt 自动优化，真正做到了 <strong>“反馈 -&gt; 演进”</strong> 的 prompt 优化闭环。</p>
<h6 data-id="heading-3"><strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bd8c80f0a624926b27380c95127d20d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771488143&amp;x-signature=4%2BVwjiCZ7Al5BF9FTZycjUSZVDE%3D" alt="" loading="lazy"/>△</strong>C-MOP：融合正误双向样本感知与时序动量梯度的提示词优化器</h6>
<h2 data-id="heading-4">榨干算力潜能并适配国产硬件生态</h2>
<p>除了精度提升，MindScale 也注重面向行业场景模型的训推效率优化，例如：</p>
<ul>
<li>
<p>其中的 TrimR 用一个已预训练、指令微调的轻量验证器在线检测并截断无用中间思路，全程无需微调大模型或验证器；</p>
</li>
<li>
<p>配套工业级异步在线系统，适配大并发生产场景_。_</p>
</li>
</ul>
<p>在 MATH、AIME、GPQA 等基准与多款 LRM 上，TrimR 在几乎不影响准确率的前提下，将推理时延显著降低，大并发场景最高可达约 <strong>70% 提速</strong>，实现实际应用场景中的 Test Time Scaling。</p>
<h6 data-id="heading-5"><strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9fa1e96f7bb4bada1687e70139a8697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771488143&amp;x-signature=LRQada7amIDPLJWqMOXm6nTS4IU%3D" alt="" loading="lazy"/>△</strong>TrimR：工业级思维链动态压缩算法框架</h6>
<p>此外，为了适配行业场景高并发的推理压力，MindScale 还提供了新的基于 KV Cache 的推理方案。</p>
<p>与通用方案中 KV Cache 只是用来加速解码的 “幕后工具” 不同，研究人员提出 KV-Embeddings，把 KV Cache 视作一种 “免费附赠” 的轻量表示，无需额外计算或存储完整隐状态，可以在链式表示推理_（Chain-of-Embedding）_和快慢思考切换等关键场景中，基于多款主流模型上实现性能持平或反超专用 embedding 模型，同时将生成 token 数最高减少 5.7×。</p>
<p>这些结果表明——KV Cache 不只是加速器，更是一块<strong>尚未被充分利用的 “思考缓存”</strong>，为大模型推理阶段的表示复用打开了新的想象空间。</p>
<p>此外，诺亚方舟实验室与相关合作团队还在<strong>任务记忆、Agentic RAG、通用算法发现框架</strong>等多个方向上，沉淀了大量经过实战检验的、围绕行业智能优化的创新算法技术架构。</p>
<p>同时，MindScale 还也包含了适配昇腾硬件的代码实现，可以让行业开发的小伙伴们，基于国产算力实现高精度、高效的 Agent 构建。</p>
<p><em>MindScale 主页（或点击文末 “阅读原文”）：</em><br/>
<em><a href="https://link.juejin.cn?target=https%3A%2F%2Fnoah-mindscale.github.io%2F" target="_blank" title="https://noah-mindscale.github.io/" ref="nofollow noopener noreferrer">noah-mindscale.github.io/</a></em><br/>
<em>华为诺亚方舟实验室主页：</em><br/>
<em><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.noahlab.com.hk%2F%23%2Fhome" target="_blank" title="https://www.noahlab.com.hk/#/home" ref="nofollow noopener noreferrer">www.noahlab.com.hk/#/home</a></em></p>
<ul>
<li>本文系量子位获授权刊载，观点仅为原作者所有。</li>
</ul>
<p><strong>欢迎在评论区留下你的想法！</strong></p>
<p>— <strong>完</strong> —</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Cursor 完成 Vike + Vue 3 + Element Plus 管理后台 — 从 0 到 1 （实例与文档）]]></title>    <link>https://juejin.cn/post/7605530057175482411</link>    <guid>https://juejin.cn/post/7605530057175482411</guid>    <pubDate>2026-02-12T06:03:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605530057175482411" data-draft-id="7605530057175466027" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Cursor 完成 Vike + Vue 3 + Element Plus 管理后台 — 从 0 到 1 （实例与文档）"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-02-12T06:03:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="赵_叶紫"/> <meta itemprop="url" content="https://juejin.cn/user/8451823504760"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Cursor 完成 Vike + Vue 3 + Element Plus 管理后台 — 从 0 到 1 （实例与文档）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/8451823504760/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    赵_叶紫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:03:19.000Z" title="Thu Feb 12 2026 06:03:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    28
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目录</h2>
<ol>
<li><a href="#1-%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0" title="#1-%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0">项目概述</a></li>
<li><a href="#2-%E6%8A%80%E6%9C%AF%E6%A0%88" title="#2-%E6%8A%80%E6%9C%AF%E6%A0%88">技术栈</a></li>
<li><a href="#3-%E9%A1%B9%E7%9B%AE%E5%88%9D%E5%A7%8B%E5%8C%96" title="#3-%E9%A1%B9%E7%9B%AE%E5%88%9D%E5%A7%8B%E5%8C%96">项目初始化</a></li>
<li><a href="#4-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84" title="#4-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84">目录结构</a></li>
<li><a href="#5-%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" title="#5-%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">核心配置文件</a>
<ul>
<li>5.1 <a href="#51-packagejson" title="#51-packagejson">package.json</a></li>
<li>5.2 <a href="#52-viteconfigts" title="#52-viteconfigts">vite.config.ts</a></li>
<li>5.3 <a href="#53-typescript-%E9%85%8D%E7%BD%AE" title="#53-typescript-%E9%85%8D%E7%BD%AE">TypeScript 配置</a></li>
<li>5.4 <a href="#54-eslint-%E9%85%8D%E7%BD%AE" title="#54-eslint-%E9%85%8D%E7%BD%AE">ESLint 配置</a></li>
</ul>
</li>
<li><a href="#6-%E6%9C%8D%E5%8A%A1%E7%AB%AF--express-%E6%9C%8D%E5%8A%A1%E5%99%A8" title="#6-%E6%9C%8D%E5%8A%A1%E7%AB%AF--express-%E6%9C%8D%E5%8A%A1%E5%99%A8">服务端 — Express 服务器</a></li>
<li><a href="#7-vike-%E9%A1%B5%E9%9D%A2%E7%BA%A6%E5%AE%9A%E4%B8%8E-hook-%E4%BD%93%E7%B3%BB" title="#7-vike-%E9%A1%B5%E9%9D%A2%E7%BA%A6%E5%AE%9A%E4%B8%8E-hook-%E4%BD%93%E7%B3%BB">Vike 页面约定与 Hook 体系</a>
<ul>
<li>7.1 <a href="#71-configts--%E5%85%A8%E5%B1%80%E9%A1%B5%E9%9D%A2%E7%BA%A7%E9%85%8D%E7%BD%AE" title="#71-configts--%E5%85%A8%E5%B1%80%E9%A1%B5%E9%9D%A2%E7%BA%A7%E9%85%8D%E7%BD%AE">+config.ts — 全局/页面级配置</a></li>
<li>7.2 <a href="#72-oncreateappts--vue-%E5%BA%94%E7%94%A8%E5%88%9B%E5%BB%BA%E9%92%A9%E5%AD%90" title="#72-oncreateappts--vue-%E5%BA%94%E7%94%A8%E5%88%9B%E5%BB%BA%E9%92%A9%E5%AD%90">+onCreateApp.ts — Vue 应用创建钩子</a></li>
<li>7.3 <a href="#73-layoutvue--%E5%85%A8%E5%B1%80%E5%B8%83%E5%B1%80" title="#73-layoutvue--%E5%85%A8%E5%B1%80%E5%B8%83%E5%B1%80">+Layout.vue — 全局布局</a></li>
<li>7.4 <a href="#74-headvue--%E5%85%A8%E5%B1%80-html-head" title="#74-headvue--%E5%85%A8%E5%B1%80-html-head">+Head.vue — 全局 HTML Head</a></li>
<li>7.5 <a href="#75-guardts--%E8%B7%AF%E7%94%B1%E5%AE%88%E5%8D%AB%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81" title="#75-guardts--%E8%B7%AF%E7%94%B1%E5%AE%88%E5%8D%AB%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81">+guard.ts — 路由守卫（权限验证）</a></li>
<li>7.6 <a href="#76-datats--ssr-%E6%95%B0%E6%8D%AE%E9%A2%84%E5%8F%96" title="#76-datats--ssr-%E6%95%B0%E6%8D%AE%E9%A2%84%E5%8F%96">+data.ts — SSR 数据预取</a></li>
<li>7.7 <a href="#77-pagevue--%E9%A1%B5%E9%9D%A2%E7%BB%84%E4%BB%B6" title="#77-pagevue--%E9%A1%B5%E9%9D%A2%E7%BB%84%E4%BB%B6">+Page.vue — 页面组件</a></li>
<li>7.8 <a href="#78-_errorpagevue--%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2" title="#78-_errorpagevue--%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2">_error/+Page.vue — 错误页面</a></li>
</ul>
</li>
<li><a href="#8-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--pinia" title="#8-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--pinia">状态管理 — Pinia</a>
<ul>
<li>8.1 <a href="#81-%E5%85%A8%E5%B1%80%E7%8A%B6%E6%80%81-globalts" title="#81-%E5%85%A8%E5%B1%80%E7%8A%B6%E6%80%81-globalts">全局状态 (global.ts)</a></li>
<li>8.2 <a href="#82-%E5%B8%83%E5%B1%80%E7%8A%B6%E6%80%81-layoutts" title="#82-%E5%B8%83%E5%B1%80%E7%8A%B6%E6%80%81-layoutts">布局状态 (layout.ts)</a></li>
</ul>
</li>
<li><a href="#9-%E5%9B%BD%E9%99%85%E5%8C%96--vue-i18n" title="#9-%E5%9B%BD%E9%99%85%E5%8C%96--vue-i18n">国际化 — Vue I18n</a></li>
<li><a href="#10-api-%E5%B1%82--alova--axios" title="#10-api-%E5%B1%82--alova--axios">API 层 — Alova + Axios</a>
<ul>
<li>10.1 <a href="#101-%E6%A0%B8%E5%BF%83%E5%AE%9E%E4%BE%8B%E7%AE%A1%E7%90%86-alovainstancets" title="#101-%E6%A0%B8%E5%BF%83%E5%AE%9E%E4%BE%8B%E7%AE%A1%E7%90%86-alovainstancets">核心实例管理 (alovaInstance.ts)</a></li>
<li>10.2 <a href="#102-%E5%AE%A2%E6%88%B7%E7%AB%AF-api-createclientapits" title="#102-%E5%AE%A2%E6%88%B7%E7%AB%AF-api-createclientapits">客户端 API (createClientApi.ts)</a></li>
<li>10.3 <a href="#103-%E6%9C%8D%E5%8A%A1%E7%AB%AF-api-createserverapits" title="#103-%E6%9C%8D%E5%8A%A1%E7%AB%AF-api-createserverapits">服务端 API (createServerApi.ts)</a></li>
<li>10.4 <a href="#104-%E4%B8%9A%E5%8A%A1-api-%E5%AE%9A%E4%B9%89" title="#104-%E4%B8%9A%E5%8A%A1-api-%E5%AE%9A%E4%B9%89">业务 API 定义</a></li>
</ul>
</li>
<li><a href="#11-layout-%E7%B3%BB%E7%BB%9F" title="#11-layout-%E7%B3%BB%E7%BB%9F">Layout 系统</a>
<ul>
<li>11.1 <a href="#111-%E5%85%AC%E5%85%B1%E5%B8%83%E5%B1%80%E4%B8%8E%E9%A1%B5%E9%9D%A2%E8%87%AA%E5%AE%9A%E4%B9%89" title="#111-%E5%85%AC%E5%85%B1%E5%B8%83%E5%B1%80%E4%B8%8E%E9%A1%B5%E9%9D%A2%E8%87%AA%E5%AE%9A%E4%B9%89">公共布局与页面自定义</a></li>
<li>11.2 <a href="#112-uselayout-%E7%BB%84%E5%90%88%E5%BC%8F%E5%87%BD%E6%95%B0" title="#112-uselayout-%E7%BB%84%E5%90%88%E5%BC%8F%E5%87%BD%E6%95%B0">useLayout 组合式函数</a></li>
<li>11.3 <a href="#113-appsidebar-%E7%BB%84%E4%BB%B6" title="#113-appsidebar-%E7%BB%84%E4%BB%B6">AppSidebar 组件</a></li>
<li>11.4 <a href="#114-appheader-%E7%BB%84%E4%BB%B6" title="#114-appheader-%E7%BB%84%E4%BB%B6">AppHeader 组件</a></li>
</ul>
</li>
<li><a href="#12-element-plus-%E9%9B%86%E6%88%90ssr-%E5%85%BC%E5%AE%B9" title="#12-element-plus-%E9%9B%86%E6%88%90ssr-%E5%85%BC%E5%AE%B9">Element Plus 集成（SSR 兼容）</a></li>
<li><a href="#13-%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F" title="#13-%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F">权限系统</a>
<ul>
<li>13.1 <a href="#131-%E6%9D%83%E9%99%90-url-%E7%BB%9F%E4%B8%80%E7%AE%A1%E7%90%86" title="#131-%E6%9D%83%E9%99%90-url-%E7%BB%9F%E4%B8%80%E7%AE%A1%E7%90%86">权限 URL 统一管理</a></li>
<li>13.2 <a href="#132-%E9%A1%B5%E9%9D%A2%E7%BA%A7%E6%9D%83%E9%99%90--guardts" title="#132-%E9%A1%B5%E9%9D%A2%E7%BA%A7%E6%9D%83%E9%99%90--guardts">页面级权限 — +guard.ts</a></li>
<li>13.3 <a href="#133-%E6%8C%89%E9%92%AE%E7%BA%A7%E6%9D%83%E9%99%90--usepermission" title="#133-%E6%8C%89%E9%92%AE%E7%BA%A7%E6%9D%83%E9%99%90--usepermission">按钮级权限 — usePermission</a></li>
<li>13.4 <a href="#134-mock-%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81serverserverts" title="#134-mock-%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81serverserverts">Mock 权限验证</a></li>
<li>13.5 <a href="#135-%E6%9D%83%E9%99%90%E6%B5%81%E7%A8%8B%E5%9B%BE" title="#135-%E6%9D%83%E9%99%90%E6%B5%81%E7%A8%8B%E5%9B%BE">权限流程图</a></li>
</ul>
</li>
<li><a href="#14-%E8%B7%AF%E7%94%B1%E4%B8%8E%E5%AF%BC%E8%88%AA" title="#14-%E8%B7%AF%E7%94%B1%E4%B8%8E%E5%AF%BC%E8%88%AA">路由与导航</a>
<ul>
<li>14.1 <a href="#141-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E8%B7%AF%E7%94%B1" title="#141-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E8%B7%AF%E7%94%B1">文件系统路由</a></li>
<li>14.2 <a href="#142-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AF%BC%E8%88%AA" title="#142-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AF%BC%E8%88%AA">客户端导航</a></li>
</ul>
</li>
<li><a href="#15-%E4%B8%9A%E5%8A%A1%E9%A1%B5%E9%9D%A2%E7%A4%BA%E4%BE%8B" title="#15-%E4%B8%9A%E5%8A%A1%E9%A1%B5%E9%9D%A2%E7%A4%BA%E4%BE%8B">业务页面示例</a>
<ul>
<li>15.1 <a href="#151-dashboard-%E9%A6%96%E9%A1%B5" title="#151-dashboard-%E9%A6%96%E9%A1%B5">Dashboard 首页</a></li>
<li>15.2 <a href="#152-%E6%9D%83%E9%99%90%E5%88%97%E8%A1%A8%E9%A1%B5" title="#152-%E6%9D%83%E9%99%90%E5%88%97%E8%A1%A8%E9%A1%B5">权限列表页</a></li>
<li>15.3 <a href="#153-%E6%96%B0%E5%A2%9E%E6%9D%83%E9%99%90%E9%A1%B5" title="#153-%E6%96%B0%E5%A2%9E%E6%9D%83%E9%99%90%E9%A1%B5">新增权限页</a></li>
<li>15.4 <a href="#154-%E7%BC%96%E8%BE%91%E6%9D%83%E9%99%90%E9%A1%B5" title="#154-%E7%BC%96%E8%BE%91%E6%9D%83%E9%99%90%E9%A1%B5">编辑权限页</a></li>
</ul>
</li>
<li><a href="#16-ssr-%E4%B8%8E-csr-%E7%AD%96%E7%95%A5" title="#16-ssr-%E4%B8%8E-csr-%E7%AD%96%E7%95%A5">SSR 与 CSR 策略</a></li>
<li><a href="#17-%E5%85%B3%E9%94%AE%E8%B8%A9%E5%9D%91%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" title="#17-%E5%85%B3%E9%94%AE%E8%B8%A9%E5%9D%91%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">关键踩坑与解决方案</a></li>
<li><a href="#18-%E5%BC%80%E5%8F%91%E4%B8%8E%E6%9E%84%E5%BB%BA%E5%91%BD%E4%BB%A4" title="#18-%E5%BC%80%E5%8F%91%E4%B8%8E%E6%9E%84%E5%BB%BA%E5%91%BD%E4%BB%A4">开发与构建命令</a></li>
<li><a href="#19-%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2" title="#19-%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2">生产部署</a>
<ul>
<li>19.1 <a href="#191-%E6%9E%84%E5%BB%BA%E4%BA%A7%E7%89%A9%E7%BB%93%E6%9E%84" title="#191-%E6%9E%84%E5%BB%BA%E4%BA%A7%E7%89%A9%E7%BB%93%E6%9E%84">构建产物结构</a></li>
<li>19.2 <a href="#192-%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F" title="#192-%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F">部署方式</a></li>
<li>19.3 <a href="#193-nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%8F%AF%E9%80%89" title="#193-nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%8F%AF%E9%80%89">Nginx 反向代理</a></li>
<li>19.4 <a href="#194-docker-%E9%83%A8%E7%BD%B2%E5%8F%AF%E9%80%89" title="#194-docker-%E9%83%A8%E7%BD%B2%E5%8F%AF%E9%80%89">Docker 部署</a></li>
<li>19.5 <a href="#195-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" title="#195-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">注意事项</a></li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-1">1. 项目概述</h2>
<p>本项目是一个基于 <strong>Vike（前 vite-plugin-ssr）+ Vue 3</strong> 的企业级管理后台模板。核心思路是利用 Vike 框架的原生 Hook 体系（<code>+config.ts</code>、<code>+guard.ts</code>、<code>+data.ts</code>、<code>+Layout.vue</code>、<code>+onCreateApp.ts</code>）替代传统 Vue Router 的路由守卫和路由配置方式，实现：</p>
<ul>
<li><strong>SSR 首屏渲染</strong> — 首屏数据通过 <code>+data.ts</code> 在服务端预取，直接输出到 HTML</li>
<li><strong>统一权限验证</strong> — 通过 <code>+guard.ts</code> 在 SSR 阶段调用后端权限接口，无权限直接渲染 403 页面</li>
<li><strong>公共 Layout 可定制</strong> — 每个页面可通过 Pinia Store 方法动态修改 Layout 标题、面包屑、顶部按钮等</li>
<li><strong>国际化</strong> — Vue I18n 支持中英文切换，菜单、标题、错误页均支持多语言</li>
<li><strong>UI 组件库</strong> — Element Plus 全量引入，SSR 兼容</li>
</ul>
<hr/>
<h2 data-id="heading-2">2. 技术栈</h2>



















































































<table><thead><tr><th>类别</th><th>技术</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td>框架</td><td>Vue 3</td><td>^3.5</td><td>Composition API</td></tr><tr><td>元框架</td><td>Vike</td><td>^0.4.252</td><td>SSR / 文件系统路由</td></tr><tr><td>Vue 适配</td><td>vike-vue</td><td>^0.9.10</td><td>Vike 的 Vue 3 适配器</td></tr><tr><td>UI 组件库</td><td>Element Plus</td><td>^2.9</td><td>管理后台 UI 组件</td></tr><tr><td>状态管理</td><td>Pinia</td><td>^3.0</td><td>Vue 3 官方状态管理</td></tr><tr><td>国际化</td><td>Vue I18n</td><td>^11.1</td><td>多语言支持</td></tr><tr><td>HTTP 请求</td><td>Alova + Axios</td><td>^3.2 / ^1.9</td><td>请求策略库 + HTTP 客户端</td></tr><tr><td>服务端</td><td>Express 5</td><td>^5.2</td><td>Node.js HTTP 服务器</td></tr><tr><td>构建工具</td><td>Vite 7</td><td>^7.3</td><td>开发服务器 + 打包</td></tr><tr><td>语言</td><td>TypeScript</td><td>^5.9</td><td>类型安全</td></tr><tr><td>CSS 预处理</td><td>SCSS</td><td>^1.87</td><td>样式预处理</td></tr><tr><td>代码规范</td><td>ESLint + typescript-eslint</td><td>^9.39</td><td>代码质量保障</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-3">3. 项目初始化</h2>
<h3 data-id="heading-4">3.1 创建项目</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建目录</span>
<span class="hljs-built_in">mkdir</span> vike-zyh-test &amp;&amp; <span class="hljs-built_in">cd</span> vike-zyh-test

<span class="hljs-comment"># 初始化 package.json</span>
npm init -y
</code></pre>
<h3 data-id="heading-5">3.2 安装依赖</h3>
<p><strong>运行时依赖：</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install vue vike vike-vue express compression cookie-parser sirv \
  pinia vue-i18n element-plus alova @alova/adapter-axios axios
</code></pre>
<p><strong>开发依赖：</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install -D vite @vitejs/plugin-vue typescript tsx sass \
  unplugin-auto-import unplugin-vue-components \
  @intlify/unplugin-vue-i18n cross-env \
  eslint @eslint/js eslint-plugin-vue typescript-eslint vue-eslint-parser globals \
  @types/express @types/compression @types/cookie-parser
</code></pre>
<h3 data-id="heading-6">3.3 设定 <code>package.json</code> Scripts</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsx server/server.ts"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vike build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"preview"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vike build &amp;&amp; cross-env NODE_ENV=production tsx server/server.ts"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint ."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"fix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint . --fix"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p><strong>关键点</strong>：开发模式使用 <code>tsx</code> 直接运行 TypeScript 编写的 Express 服务器，而非 <code>vite dev</code>。这允许我们完全掌控服务端中间件、Mock API 和渲染流程。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">4. 目录结构</h2>
<pre><code class="hljs language-csharp" lang="csharp">vike-zyh-test/
├── server/                          <span class="hljs-meta"># Express 服务端</span>
│   └── server.ts                    <span class="hljs-meta"># 入口：中间件 + Mock API + Vike 渲染</span>
├── src/
│   ├── api/                         <span class="hljs-meta"># API 层</span>
│   │   ├── alovaInstance.ts         <span class="hljs-meta"># Alova 实例管理 + apiCreator 统一请求工厂</span>
│   │   ├── createClientApi.ts       <span class="hljs-meta"># 客户端 Alova 实例创建</span>
│   │   ├── createServerApi.ts       <span class="hljs-meta"># 服务端 Alova 实例创建（用于 +data.ts / +guard.ts）</span>
│   │   ├── dashboardApi.ts          <span class="hljs-meta"># Dashboard 业务 API</span>
│   │   └── permissionApi.ts         <span class="hljs-meta"># 权限业务 API</span>
│   ├── composables/                 <span class="hljs-meta"># 组合式函数</span>
│   │   ├── useLayout.ts             <span class="hljs-meta"># Layout 控制接口（setTitle / setBreadcrumbs / setHeaderActions ...）</span>
│   │   ├── usePagination.ts         <span class="hljs-meta"># 分页逻辑封装</span>
│   │   └── usePermission.ts         <span class="hljs-meta"># 权限检查（hasPermission）</span>
│   ├── constants/                   <span class="hljs-meta"># 常量</span>
│   │   ├── constants.ts             <span class="hljs-meta"># 通用常量（分页默认值、枚举等）</span>
│   │   ├── menu.ts                  <span class="hljs-meta"># 侧边栏菜单配置</span>
│   │   └── permissionApis.ts        <span class="hljs-meta"># 权限 API URL 常量（统一管理）</span>
│   ├── directive/                   <span class="hljs-meta"># 自定义指令</span>
│   │   └── directive.ts             <span class="hljs-meta"># 指令注册入口（如权限指令 v-permission）</span>
│   ├── i18n/                        <span class="hljs-meta"># 国际化</span>
│   │   ├── i18n.ts                  <span class="hljs-meta"># createI18n 工厂函数</span>
│   │   ├── zh-CN.json               <span class="hljs-meta"># 中文语言包</span>
│   │   └── en-US.json               <span class="hljs-meta"># 英文语言包</span>
│   ├── layout/                      <span class="hljs-meta"># Layout 组件</span>
│   │   ├── AppSidebar.vue           <span class="hljs-meta"># 侧边栏</span>
│   │   └── AppHeader.vue            <span class="hljs-meta"># 顶部导航栏</span>
│   ├── pages/                       <span class="hljs-meta"># Vike 文件系统路由 ★</span>
│   │   ├── +config.ts               <span class="hljs-meta"># 全局页面配置</span>
│   │   ├── +onCreateApp.ts          <span class="hljs-meta"># Vue App 创建钩子（注册 Pinia/I18n/ElementPlus）</span>
│   │   ├── +guard.ts                <span class="hljs-meta"># 全局路由守卫（权限验证）</span>
│   │   ├── +Layout.vue              <span class="hljs-meta"># 全局 Layout</span>
│   │   ├── +Head.vue                <span class="hljs-meta"># 全局 HTML &lt;head&gt;</span>
│   │   ├── _error/                  <span class="hljs-meta"># 错误页面（401/403/404/500）</span>
│   │   │   └── +Page.vue
│   │   ├── index/                   <span class="hljs-meta"># 首页 /</span>
│   │   │   ├── +config.ts
│   │   │   ├── +data.ts             <span class="hljs-meta"># SSR 数据预取</span>
│   │   │   └── +Page.vue
│   │   └── permission/              <span class="hljs-meta"># 权限管理模块</span>
│   │       ├── +config.ts
│   │       ├── +data.ts             <span class="hljs-meta"># SSR 数据预取（权限列表）</span>
│   │       ├── +Page.vue            <span class="hljs-meta"># 权限列表页</span>
│   │       ├── <span class="hljs-keyword">add</span>/                 <span class="hljs-meta"># 新增权限 /permission/add</span>
│   │       │   ├── +config.ts
│   │       │   ├── +data.ts         <span class="hljs-meta"># 空 data，阻止继承父级</span>
│   │       │   └── +Page.vue
│   │       └── @id/                 <span class="hljs-meta"># 动态路由 /permission/:id</span>
│   │           └── edit/            <span class="hljs-meta"># 编辑权限 /permission/:id/edit</span>
│   │               ├── +config.ts
│   │               ├── +data.ts     <span class="hljs-meta"># 空 data，阻止继承父级</span>
│   │               └── +Page.vue
│   ├── scss/                        <span class="hljs-meta"># 全局样式</span>
│   │   └── common.scss
│   ├── stores/                      <span class="hljs-meta"># Pinia 状态管理</span>
│   │   ├── <span class="hljs-keyword">global</span>.ts                <span class="hljs-meta"># 全局状态（env/lang/user）</span>
│   │   └── layout.ts                <span class="hljs-meta"># 布局状态（title/breadcrumbs/headerActions/sidebar）</span>
│   └── viewComponents/              <span class="hljs-meta"># 页面级可复用组件</span>
│       └── permission/
│           └── PermissionForm.vue   <span class="hljs-meta"># 权限表单组件（新增/编辑复用）</span>
├── vite.config.ts                   <span class="hljs-meta"># Vite 配置</span>
├── tsconfig.json                    <span class="hljs-meta"># TypeScript 根配置（引用子配置）</span>
├── tsconfig.app.json                <span class="hljs-meta"># 前端 TS 配置</span>
├── tsconfig.node.json               <span class="hljs-meta"># Vite 配置用 TS 配置</span>
├── tsconfig.server.json             <span class="hljs-meta"># 服务端 TS 配置</span>
├── eslint.config.ts                 <span class="hljs-meta"># ESLint 配置</span>
└── package.json
</code></pre>
<blockquote>
<p><strong>约定说明</strong>：<code>pages/</code> 目录下以 <code>+</code> 开头的文件是 Vike 框架约定文件，分别承担配置、数据预取、守卫、布局、渲染等职责。<code>@id</code> 目录名表示动态路由参数。<code>_error</code> 为 Vike 约定的错误页面目录。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">5. 核心配置文件</h2>
<h3 data-id="heading-9">5.1 package.json</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"imports"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"#*"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"#server/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./server/*"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><code>"type": "module"</code> — 启用 ESM</li>
<li><code>"imports"</code> — Node.js 原生子路径导入映射，配合 <code>tsconfig.json</code> 的 <code>paths</code> 实现统一的 <code>#</code> 前缀路径别名</li>
</ul>
<h3 data-id="heading-10">5.2 vite.config.ts</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { fileURLToPath, <span class="hljs-variable constant_">URL</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>;
<span class="hljs-keyword">import</span> { readdir } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs/promises'</span>;
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>;
<span class="hljs-keyword">import</span> vike <span class="hljs-keyword">from</span> <span class="hljs-string">'vike/plugin'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AutoImport</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-auto-import/vite'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Components</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/vite'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElementPlusResolver</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/resolvers'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueI18</span>nPlugin <span class="hljs-keyword">from</span> <span class="hljs-string">'@intlify/unplugin-vue-i18n/vite'</span>;

<span class="hljs-comment">// 自动扫描 src/ 下的子目录，生成路径别名</span>
<span class="hljs-keyword">const</span> srcSubDirs = (
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">readdir</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./src'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>), { <span class="hljs-attr">withFileTypes</span>: <span class="hljs-literal">true</span> })
)
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">d</span>) =&gt;</span> d.<span class="hljs-title function_">isDirectory</span>())
  .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">{ name }</span>) =&gt;</span> name);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title function_">vike</span>(),
    <span class="hljs-title class_">AutoImport</span>({
      <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">ElementPlusResolver</span>({ <span class="hljs-attr">importStyle</span>: <span class="hljs-literal">false</span> })],
    }),
    <span class="hljs-title class_">Components</span>({
      <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">ElementPlusResolver</span>({ <span class="hljs-attr">importStyle</span>: <span class="hljs-literal">false</span> })],
    }),
    <span class="hljs-title class_">VueI18</span>nPlugin({ <span class="hljs-attr">ssr</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">strictMessage</span>: <span class="hljs-literal">false</span> }),
  ],
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'#'</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>)),
      <span class="hljs-string">'#src'</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./src'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>)),
      <span class="hljs-string">'#server'</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./server'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>)),
      <span class="hljs-comment">// 自动生成: #api, #composables, #stores, #i18n, #layout, #pages ...</span>
      ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(
        srcSubDirs.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">name</span>) =&gt;</span> [
          <span class="hljs-string">`#<span class="hljs-subst">${name}</span>`</span>,
          <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">`./src/<span class="hljs-subst">${name}</span>`</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>)),
        ]),
      ),
    },
  },
  <span class="hljs-attr">build</span>: { <span class="hljs-attr">target</span>: <span class="hljs-string">'es2022'</span> },
});
</code></pre>
<p><strong>关键设计点：</strong></p>

























<table><thead><tr><th>配置项</th><th>说明</th></tr></thead><tbody><tr><td><code>vike()</code></td><td>启用 Vike 插件，提供 SSR + 文件系统路由</td></tr><tr><td><code>ElementPlusResolver({ importStyle: false })</code></td><td><strong>禁用</strong> 样式自动导入，避免 SSR 中加载 CSS 文件报错。样式改为在 <code>+Layout.vue</code> 中手动 <code>import 'element-plus/dist/index.css'</code></td></tr><tr><td><code>VueI18nPlugin({ ssr: true })</code></td><td>开启 i18n 的 SSR 优化，编译时处理 <code>&lt;i18n&gt;</code> 块</td></tr><tr><td>路径别名自动扫描</td><td>自动读取 <code>src/</code> 子目录，无需手动逐个配置别名</td></tr></tbody></table>
<h3 data-id="heading-11">5.3 TypeScript 配置</h3>
<p>项目采用<strong>三配置策略</strong>：</p>

























<table><thead><tr><th>文件</th><th>作用</th><th>module</th></tr></thead><tbody><tr><td><code>tsconfig.app.json</code></td><td>前端源码 (<code>src/</code>)</td><td>ES2022 / Bundler</td></tr><tr><td><code>tsconfig.node.json</code></td><td>Vite 配置文件</td><td>ES2022 / Bundler</td></tr><tr><td><code>tsconfig.server.json</code></td><td>服务端代码 (<code>server/</code>)</td><td>Node16 / Node16</td></tr></tbody></table>
<p><code>tsconfig.app.json</code> 中配置了所有 <code>#</code> 前缀的路径映射：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"#*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"#src/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"#api/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/api/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"#stores/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/stores/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"#i18n/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/i18n/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"#layout/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/layout/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"#composables/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/composables/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"#constants/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/constants/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"#directive/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/directive/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"#viewComponents/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/viewComponents/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"#server/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./server/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-12">5.4 ESLint 配置</h3>
<p>使用 ESLint 9 Flat Config，集成 <code>typescript-eslint</code> 和 <code>eslint-plugin-vue</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// eslint.config.ts</span>
<span class="hljs-keyword">import</span> eslint <span class="hljs-keyword">from</span> <span class="hljs-string">'@eslint/js'</span>;
<span class="hljs-keyword">import</span> pluginVue <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-vue'</span>;
<span class="hljs-keyword">import</span> tseslint <span class="hljs-keyword">from</span> <span class="hljs-string">'typescript-eslint'</span>;
<span class="hljs-keyword">import</span> vueParser <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-eslint-parser'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> tseslint.<span class="hljs-title function_">config</span>(
  eslint.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>,
  ...tseslint.<span class="hljs-property">configs</span>.<span class="hljs-property">recommended</span>,
  <span class="hljs-comment">// Vue 文件使用 vue-eslint-parser 嵌套 typescript parser</span>
  {
    <span class="hljs-attr">files</span>: [<span class="hljs-string">'**/*.vue'</span>],
    <span class="hljs-attr">languageOptions</span>: {
      <span class="hljs-attr">parser</span>: vueParser,
      <span class="hljs-attr">parserOptions</span>: { <span class="hljs-attr">parser</span>: tseslint.<span class="hljs-property">parser</span> },
    },
  },
  ...pluginVue.<span class="hljs-property">configs</span>[<span class="hljs-string">'flat/recommended'</span>],
);
</code></pre>
<hr/>
<h2 data-id="heading-13">6. 服务端 — Express 服务器</h2>
<p><code>server/server.ts</code> 是项目入口，使用 <strong>Express 5</strong> 搭建 HTTP 服务器：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;
<span class="hljs-keyword">import</span> compression <span class="hljs-keyword">from</span> <span class="hljs-string">'compression'</span>;
<span class="hljs-keyword">import</span> cookieParser <span class="hljs-keyword">from</span> <span class="hljs-string">'cookie-parser'</span>;
<span class="hljs-keyword">import</span> { renderPage, createDevMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">'vike/server'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startServer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

  <span class="hljs-comment">// 1. 基础中间件</span>
  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">compression</span>());       <span class="hljs-comment">// Gzip 压缩</span>
  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cookieParser</span>());      <span class="hljs-comment">// Cookie 解析</span>
  app.<span class="hljs-title function_">disable</span>(<span class="hljs-string">'x-powered-by'</span>);  <span class="hljs-comment">// 隐藏 Express 标识</span>

  <span class="hljs-comment">// 2. 静态文件 / Vite 开发中间件</span>
  <span class="hljs-keyword">if</span> (isProd) {
    app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">sirv</span>(<span class="hljs-string">'dist/client'</span>));  <span class="hljs-comment">// 生产环境：静态文件</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> { devMiddleware } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createDevMiddleware</span>({ root });
    app.<span class="hljs-title function_">use</span>(devMiddleware);        <span class="hljs-comment">// 开发环境：Vite HMR</span>
  }

  <span class="hljs-comment">// 3. Mock API（开发阶段可替换为真实后端代理）</span>
  app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());
  app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/v1/dashboard/stats'</span>, ...);
  app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/v1/permissions'</span>, ...);
  app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/v1/permission/check'</span>, ...);

  <span class="hljs-comment">// 4. Vike 页面渲染 — 所有未匹配的 GET 请求</span>
  app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/{*path}'</span>, <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
    <span class="hljs-keyword">const</span> pageContext = <span class="hljs-keyword">await</span> <span class="hljs-title function_">renderPage</span>({
      <span class="hljs-attr">urlOriginal</span>: req.<span class="hljs-property">originalUrl</span>,
      <span class="hljs-attr">headersOriginal</span>: req.<span class="hljs-property">headers</span>,
      <span class="hljs-attr">cookies</span>: req.<span class="hljs-property">cookies</span>,
    });

    <span class="hljs-keyword">if</span> (!pageContext.<span class="hljs-property">httpResponse</span>) <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>();

    <span class="hljs-keyword">const</span> { body, statusCode, headers } = pageContext.<span class="hljs-property">httpResponse</span>;
    headers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[name, value]</span>) =&gt;</span> res.<span class="hljs-title function_">setHeader</span>(name, value));
    res.<span class="hljs-title function_">status</span>(statusCode).<span class="hljs-title function_">send</span>(body);
  });

  app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);
}
</code></pre>
<p><strong>重点说明：</strong></p>
<ol>
<li><strong>Express 5 路由语法</strong>：<code>app.get('/{*path}', ...)</code> — Express 5 使用命名通配符，不再支持 <code>app.get('*', ...)</code></li>
<li><strong>pageContext 初始化</strong>：<code>headersOriginal</code> 和 <code>cookies</code> 被传入 <code>pageContext</code>，供 <code>+guard.ts</code> 和 <code>+data.ts</code> 中的 SSR API 调用使用（转发原始请求头实现登录态传递）</li>
<li><strong>Mock API 位于 Vike 渲染之前</strong>：确保 API 请求不会被 Vike 拦截</li>
</ol>
<hr/>
<h2 data-id="heading-14">7. Vike 页面约定与 Hook 体系</h2>
<p>Vike 的核心理念：<strong>通过 <code>+</code> 前缀文件约定替代路由配置</strong>。每个约定文件承担特定职责，按以下顺序执行：</p>
<pre><code class="hljs language-bash" lang="bash">请求进入 → +guard.ts（权限验证）→ +data.ts（数据预取）→ +Page.vue（页面渲染）
                                                          ↑
                                              +Layout.vue 包裹
                                              +Head.vue 注入 &lt;<span class="hljs-built_in">head</span>&gt;
</code></pre>
<h3 data-id="heading-15">7.1 +config.ts — 全局/页面级配置</h3>
<p><strong>全局配置</strong> <code>src/pages/+config.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> vikeVue <span class="hljs-keyword">from</span> <span class="hljs-string">'vike-vue/config'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Config</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vike/types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">extends</span>: [vikeVue],   <span class="hljs-comment">// 继承 vike-vue 默认行为</span>
  <span class="hljs-attr">title</span>: <span class="hljs-string">'Admin'</span>,
  <span class="hljs-attr">passToClient</span>: [<span class="hljs-string">'user'</span>, <span class="hljs-string">'locale'</span>, <span class="hljs-string">'permissionResult'</span>, <span class="hljs-string">'routeName'</span>],
  <span class="hljs-attr">meta</span>: {
    <span class="hljs-attr">permissionUrls</span>: {
      <span class="hljs-attr">env</span>: { <span class="hljs-attr">server</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">client</span>: <span class="hljs-literal">true</span> },  <span class="hljs-comment">// 自定义配置项，服务端和客户端均可访问</span>
    },
  },
} satisfies <span class="hljs-title class_">Config</span>;
</code></pre>
<ul>
<li><code>passToClient</code> — 指定哪些 <code>pageContext</code> 属性传递到客户端（SSR → CSR 数据桥接）</li>
<li><code>meta.permissionUrls</code> — 声明自定义页面配置项，用于权限验证</li>
</ul>
<p><strong>页面级配置</strong> <code>src/pages/permission/+config.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PERMISSION_APIS</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../constants/permissionApis'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-string">'权限列表'</span>,
  <span class="hljs-attr">permissionUrls</span>: [
    <span class="hljs-variable constant_">PERMISSION_APIS</span>.<span class="hljs-property">LIST</span>,
    <span class="hljs-variable constant_">PERMISSION_APIS</span>.<span class="hljs-property">CREATE</span>,
    <span class="hljs-variable constant_">PERMISSION_APIS</span>.<span class="hljs-property">UPDATE</span>,
    <span class="hljs-variable constant_">PERMISSION_APIS</span>.<span class="hljs-property">DELETE</span>,
  ],
};
</code></pre>
<blockquote>
<p>每个页面的 <code>+config.ts</code> 中的 <code>permissionUrls</code> 会被 <code>+guard.ts</code> 读取，用于权限验证。权限 URL 常量统一定义在 <code>src/constants/permissionApis.ts</code> 中。</p>
</blockquote>
<h3 data-id="heading-16">7.2 +onCreateApp.ts — Vue 应用创建钩子</h3>
<p>每次渲染（SSR 和 CSR）都会执行此钩子，用于注册全局插件和指令：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">OnCreateAppSync</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vike-vue/types'</span>;
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">ID_INJECTION_KEY</span>, <span class="hljs-variable constant_">ZINDEX_INJECTION_KEY</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>;
<span class="hljs-keyword">import</span> { createI18n } <span class="hljs-keyword">from</span> <span class="hljs-string">'#i18n/i18n'</span>;
<span class="hljs-keyword">import</span> directives <span class="hljs-keyword">from</span> <span class="hljs-string">'#directive/directive'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">onCreateApp</span>: <span class="hljs-title class_">OnCreateAppSync</span> = <span class="hljs-function">(<span class="hljs-params">pageContext</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { app } = pageContext;

  <span class="hljs-comment">// 1. Pinia 状态管理</span>
  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">createPinia</span>());

  <span class="hljs-comment">// 2. Vue I18n 国际化</span>
  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">createI18n</span>());

  <span class="hljs-comment">// 3. Element Plus SSR 兼容 — 必须 provide ID 和 ZIndex</span>
  app.<span class="hljs-title function_">provide</span>(<span class="hljs-variable constant_">ID_INJECTION_KEY</span>, { <span class="hljs-attr">prefix</span>: <span class="hljs-number">1024</span>, <span class="hljs-attr">current</span>: <span class="hljs-number">0</span> });
  app.<span class="hljs-title function_">provide</span>(<span class="hljs-variable constant_">ZINDEX_INJECTION_KEY</span>, { <span class="hljs-attr">current</span>: <span class="hljs-number">0</span> });

  <span class="hljs-comment">// 4. 自定义指令</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(directives).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[name, directive]</span>) =&gt;</span> {
    app.<span class="hljs-title function_">directive</span>(name, directive);
  });
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> onCreateApp;
</code></pre>
<h3 data-id="heading-17">7.3 +Layout.vue — 全局布局</h3>
<p>公共 Layout 包裹所有页面，集成侧边栏、顶部导航、Element Plus 配置提供者：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-config-provider :locale="elementLocale"&gt;
    &lt;div class="app-layout"&gt;
      &lt;aside v-if="layoutStore.showSidebar" :class="['app-sidebar', { collapsed: layoutStore.sidebarCollapsed }]"&gt;
        &lt;AppSidebar :menus="defaultMenus" :collapsed="layoutStore.sidebarCollapsed" /&gt;
      &lt;/aside&gt;
      &lt;div class="app-main"&gt;
        &lt;AppHeader
          v-if="layoutStore.showHeader"
          :breadcrumbs="layoutStore.breadcrumbs"
          :header-actions="layoutStore.headerActions"
          @toggle-sidebar="layoutStore.toggleSidebar()"
        /&gt;
        &lt;main class="app-content"&gt;
          &lt;slot /&gt;  &lt;!-- 页面内容插入点 --&gt;
        &lt;/main&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/el-config-provider&gt;
&lt;/template&gt;

&lt;script lang="ts" setup&gt;
import 'element-plus/dist/index.css';   // 手动引入样式（SSR 兼容）
import '#scss/common.scss';

// ...组件引入与状态管理
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-18">7.4 +Head.vue — 全局 HTML Head</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;meta charset="UTF-8" /&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1.0" /&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-19">7.5 +guard.ts — 路由守卫（权限验证）</h3>
<p><strong>核心权限验证机制</strong>，在 SSR 阶段拦截请求：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">GuardAsync</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vike/types'</span>;
<span class="hljs-keyword">import</span> { render } <span class="hljs-keyword">from</span> <span class="hljs-string">'vike/abort'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">guard</span>: <span class="hljs-title class_">GuardAsync</span> = <span class="hljs-keyword">async</span> (pageContext) =&gt; {
  <span class="hljs-keyword">const</span> permissionUrls = (pageContext.<span class="hljs-property">config</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">permissionUrls</span>;

  <span class="hljs-comment">// 没有配置权限 URL 的页面，直接放行</span>
  <span class="hljs-keyword">if</span> (!permissionUrls || permissionUrls.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// SSR 时调用后台权限验证接口</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> === <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { createDefaultAPI } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'#api/createServerApi'</span>);
      <span class="hljs-keyword">const</span> port = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">3000</span>;
      <span class="hljs-keyword">const</span> alova = <span class="hljs-title function_">createDefaultAPI</span>({
        <span class="hljs-attr">baseURL</span>: <span class="hljs-string">`http://localhost:<span class="hljs-subst">${port}</span>/api/v1`</span>,
        <span class="hljs-attr">headers</span>: (pageContext <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">headersOriginal</span>,  <span class="hljs-comment">// 转发原始请求头</span>
      });

      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> alova.<span class="hljs-title class_">Post</span>(<span class="hljs-string">'/permission/check'</span>, {
        <span class="hljs-attr">urls</span>: permissionUrls,
        <span class="hljs-attr">pagePath</span>: pageContext.<span class="hljs-property">urlPathname</span>,
      });

      <span class="hljs-keyword">if</span> (!result?.<span class="hljs-property">data</span>?.<span class="hljs-property">allowed</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-title function_">render</span>(<span class="hljs-number">403</span>);  <span class="hljs-comment">// 渲染 403 错误页</span>
      }

      <span class="hljs-comment">// 权限结果存入 pageContext，传到客户端</span>
      (pageContext <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">permissionResult</span> = result.<span class="hljs-property">data</span>;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">if</span> ((error <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)?.<span class="hljs-property">isAbort</span>) <span class="hljs-keyword">throw</span> error;  <span class="hljs-comment">// 已是 abort 直接抛出</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-title function_">render</span>(<span class="hljs-number">403</span>);  <span class="hljs-comment">// 异常也视为无权限</span>
    }
  }
};
</code></pre>
<h3 data-id="heading-20">7.6 +data.ts — SSR 数据预取</h3>
<p>在服务端获取数据，通过 <code>useData()</code> 在页面组件中使用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/index/+data.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">PageContextServer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vike/types'</span>;
<span class="hljs-keyword">import</span> { createDefaultAPI } <span class="hljs-keyword">from</span> <span class="hljs-string">'#api/createServerApi'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SSR_API_BASE</span> = <span class="hljs-string">`http://localhost:<span class="hljs-subst">${process.env.PORT || <span class="hljs-number">3000</span>}</span>/api/v1`</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Data</span> = <span class="hljs-title class_">DashboardStats</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">data</span>(<span class="hljs-params">_pageContext: PageContextServer</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Data</span>&gt; {
  <span class="hljs-keyword">const</span> alova = <span class="hljs-title function_">createDefaultAPI</span>({
    <span class="hljs-attr">baseURL</span>: <span class="hljs-variable constant_">SSR_API_BASE</span>,
    <span class="hljs-attr">headers</span>: (_pageContext <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">headersOriginal</span>,
  });

  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> alova.<span class="hljs-title class_">Get</span>(<span class="hljs-string">'/dashboard/stats'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>;
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：<code>+data.ts</code> 的继承问题 — 子路由会继承父目录的 <code>+data.ts</code>。如果子页面不需要父级数据，需要创建空的 <code>+data.ts</code> 来阻止继承：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/permission/add/+data.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Data</span> = <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">never</span>&gt;;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> {}; }
</code></pre>
</blockquote>
<h3 data-id="heading-21">7.7 +Page.vue — 页面组件</h3>
<p>每个目录下的 <code>+Page.vue</code> 即该路由对应的页面组件。通过 <code>useData()</code> 获取 SSR 预取数据：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script lang="ts" setup&gt;
import { useData } from 'vike-vue/useData';
import type { Data } from './+data';

const data = useData&lt;Data&gt;();  // 类型安全地获取 SSR 数据
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-22">7.8 _error/+Page.vue — 错误页面</h3>
<p>统一的错误页面，支持 401/403/404/500：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script lang="ts" setup&gt;
import { usePageContext } from 'vike-vue/usePageContext';

const pageContext = usePageContext();

const errorCode = computed(() =&gt; {
  return pageContext.is404 ? 404 : (pageContext.abortStatusCode || 500);
});
&lt;/script&gt;
</code></pre>
<p>当 <code>+guard.ts</code> 中 <code>throw render(403)</code> 时，Vike 会自动渲染 <code>_error/+Page.vue</code> 并传递 <code>abortStatusCode: 403</code>。</p>
<hr/>
<h2 data-id="heading-23">8. 状态管理 — Pinia</h2>
<h3 data-id="heading-24">8.1 全局状态 (global.ts)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/stores/global.ts</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useGlobalStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'global'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">env</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">lang</span>: <span class="hljs-string">'zh-CN'</span>,
    <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span> <span class="hljs-keyword">as</span> <span class="hljs-literal">null</span> | { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">role</span>: <span class="hljs-built_in">string</span> },
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">updateEnv</span>(<span class="hljs-params">env: <span class="hljs-built_in">string</span></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">env</span> = env; },
    <span class="hljs-title function_">updateLang</span>(<span class="hljs-params">lang: <span class="hljs-built_in">string</span></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">lang</span> = lang; },
    <span class="hljs-title function_">updateUser</span>(<span class="hljs-params">user: { name: <span class="hljs-built_in">string</span>; role: <span class="hljs-built_in">string</span> } | <span class="hljs-literal">null</span></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">user</span> = user; },
  },
});
</code></pre>
<h3 data-id="heading-25">8.2 布局状态 (layout.ts)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/stores/layout.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useLayoutStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'layout'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">title</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">breadcrumbs</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-title class_">BreadcrumbItem</span>[],
    <span class="hljs-attr">sidebarMenus</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-title class_">MenuItem</span>[],
    <span class="hljs-attr">showSidebar</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">showHeader</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">sidebarCollapsed</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">headerActions</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-title class_">HeaderAction</span>[],
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">setTitle</span>(<span class="hljs-params">title: <span class="hljs-built_in">string</span></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = title; },
    <span class="hljs-title function_">setHeaderActions</span>(<span class="hljs-params">actions: HeaderAction[]</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">headerActions</span> = actions; },
    <span class="hljs-title function_">clearHeaderActions</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">headerActions</span> = []; },
    <span class="hljs-title function_">setBreadcrumbs</span>(<span class="hljs-params">items: BreadcrumbItem[]</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">breadcrumbs</span> = items; },
    <span class="hljs-title function_">toggleSidebar</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">sidebarCollapsed</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">sidebarCollapsed</span>; },
    <span class="hljs-title function_">resetLayout</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = <span class="hljs-string">''</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">breadcrumbs</span> = [];
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">headerActions</span> = [];
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">showSidebar</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">showHeader</span> = <span class="hljs-literal">true</span>;
    },
  },
});
</code></pre>
<p><strong>类型定义：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BreadcrumbItem</span> {
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>;
  path?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MenuItem</span> {
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>;
  icon?: <span class="hljs-built_in">string</span>;
  children?: <span class="hljs-title class_">MenuItem</span>[];
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HeaderAction</span> {
  <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>;
  icon?: <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">type</span>?: <span class="hljs-string">'primary'</span> | <span class="hljs-string">'success'</span> | <span class="hljs-string">'warning'</span> | <span class="hljs-string">'danger'</span> | <span class="hljs-string">'info'</span> | <span class="hljs-string">'default'</span>;
  <span class="hljs-attr">handler</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-26">9. 国际化 — Vue I18n</h2>
<h3 data-id="heading-27">9.1 创建 I18n 实例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/i18n/i18n.ts</span>
<span class="hljs-keyword">import</span> { createI18n <span class="hljs-keyword">as</span> _createI18n } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-i18n'</span>;
<span class="hljs-keyword">import</span> zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'#i18n/zh-CN.json'</span>;
<span class="hljs-keyword">import</span> enUS <span class="hljs-keyword">from</span> <span class="hljs-string">'#i18n/en-US.json'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LANGUAGE</span> = {
  <span class="hljs-attr">ZH_CN</span>: <span class="hljs-string">'zh-CN'</span>,
  <span class="hljs-attr">EN_US</span>: <span class="hljs-string">'en-US'</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createI18n</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">_createI18n</span>({
    <span class="hljs-attr">legacy</span>: <span class="hljs-literal">false</span>,          <span class="hljs-comment">// 使用 Composition API</span>
    <span class="hljs-attr">locale</span>: <span class="hljs-variable constant_">LANGUAGE</span>.<span class="hljs-property">ZH_CN</span>, <span class="hljs-comment">// 默认中文</span>
    <span class="hljs-attr">fallbackLocale</span>: <span class="hljs-variable constant_">LANGUAGE</span>.<span class="hljs-property">ZH_CN</span>,
    <span class="hljs-attr">messages</span>: {
      [<span class="hljs-variable constant_">LANGUAGE</span>.<span class="hljs-property">ZH_CN</span>]: zhCN,
      [<span class="hljs-variable constant_">LANGUAGE</span>.<span class="hljs-property">EN_US</span>]: enUS,
    },
  });
}
</code></pre>
<h3 data-id="heading-28">9.2 语言包结构</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// zh-CN.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"app"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"管理后台"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"unauthorized"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"登录已过期，请重新登录"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"forbidden"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"暂无权限访问此页面"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"notFound"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"页面不存在"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverError"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"服务器内部错误，请稍后重试"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"menu"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"home"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首页"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"permission"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"权限管理"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"permissionList"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"权限列表"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"permissionAdd"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"新增权限"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"common"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"add"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"新增"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"edit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"编辑"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"delete"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"删除"</span><span class="hljs-punctuation">,</span> ... <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"permission"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"权限名称"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"权限编码"</span><span class="hljs-punctuation">,</span> ... <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dashboard"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"totalPermissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"总权限数"</span><span class="hljs-punctuation">,</span> ... <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-29">9.3 在组件中使用</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { useI18n } from 'vue-i18n';
const { t } = useI18n();
&lt;/script&gt;

&lt;template&gt;
  &lt;span&gt;{{ t('app.title') }}&lt;/span&gt;
  &lt;span&gt;{{ t('menu.home') }}&lt;/span&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-30">9.4 菜单配置与 i18n</h3>
<p>菜单的 <code>label</code> 字段使用 i18n key，在渲染时通过 <code>t()</code> 翻译：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/constants/menu.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">SIDEBAR_MENUS</span>: <span class="hljs-title class_">MenuItem</span>[] = [
  { <span class="hljs-attr">label</span>: <span class="hljs-string">'menu.home'</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'House'</span> },
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'menu.permission'</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'/permission'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'Lock'</span>,
    <span class="hljs-attr">children</span>: [
      { <span class="hljs-attr">label</span>: <span class="hljs-string">'menu.permissionList'</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'/permission'</span> },
      { <span class="hljs-attr">label</span>: <span class="hljs-string">'menu.permissionAdd'</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'/permission/add'</span> },
    ],
  },
];
</code></pre>
<hr/>
<h2 data-id="heading-31">10. API 层 — Alova + Axios</h2>
<p>项目使用 <strong>Alova</strong> 作为请求策略层，底层适配 <strong>Axios</strong>。分为客户端和服务端两套实例。</p>
<h3 data-id="heading-32">10.1 核心实例管理 (alovaInstance.ts)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/api/alovaInstance.ts</span>

<span class="hljs-comment">// API 类型枚举</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_TYPE</span> = { <span class="hljs-attr">DEFAULT</span>: <span class="hljs-string">'default'</span>, <span class="hljs-attr">LOCAL</span>: <span class="hljs-string">'local'</span> } <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-comment">// 基础 URL 映射</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_BASE_URL</span> = {
  [<span class="hljs-variable constant_">API_TYPE</span>.<span class="hljs-property">DEFAULT</span>]: <span class="hljs-string">'/api/v1'</span>,
  [<span class="hljs-variable constant_">API_TYPE</span>.<span class="hljs-property">LOCAL</span>]: <span class="hljs-string">'/local-api'</span>,
};

<span class="hljs-comment">// 统一请求工厂</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">apiCreator</span>(<span class="hljs-params">options: ApiOption, data?: <span class="hljs-built_in">any</span>, customInstances?: AlovaInstances</span>) {
  <span class="hljs-keyword">const</span> { method = <span class="hljs-string">'get'</span>, <span class="hljs-keyword">type</span> = <span class="hljs-variable constant_">API_TYPE</span>.<span class="hljs-property">DEFAULT</span>, pathVariable, ...restOptions } = options;
  <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">getAlovaInstance</span>(customInstances, <span class="hljs-keyword">type</span>);

  <span class="hljs-keyword">let</span> { url = <span class="hljs-string">''</span> } = restOptions;
  <span class="hljs-keyword">if</span> (pathVariable) url = <span class="hljs-title function_">templateUrl</span>(url, pathVariable);  <span class="hljs-comment">// URL 模板变量替换</span>

  <span class="hljs-keyword">const</span> methodName = method.<span class="hljs-title function_">charAt</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">toUpperCase</span>() + method.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);

  <span class="hljs-keyword">if</span> ([<span class="hljs-string">'Post'</span>, <span class="hljs-string">'Put'</span>, <span class="hljs-string">'Patch'</span>, <span class="hljs-string">'Delete'</span>].<span class="hljs-title function_">includes</span>(methodName)) {
    <span class="hljs-keyword">return</span> instance[methodName](url, data, restOptions);
  }
  <span class="hljs-keyword">return</span> instance[methodName](url, { <span class="hljs-attr">params</span>: data, ...restOptions });
}
</code></pre>
<h3 data-id="heading-33">10.2 客户端 API (createClientApi.ts)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createAlova } <span class="hljs-keyword">from</span> <span class="hljs-string">'alova'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueHook</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'alova/vue'</span>;
<span class="hljs-keyword">import</span> { axiosRequestAdapter } <span class="hljs-keyword">from</span> <span class="hljs-string">'@alova/adapter-axios'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createClientAlova</span>(<span class="hljs-params">{ baseURL, timeout = <span class="hljs-number">30000</span> }</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createAlova</span>({
    baseURL,
    timeout,
    <span class="hljs-attr">cacheFor</span>: <span class="hljs-literal">null</span>,        <span class="hljs-comment">// 禁用缓存</span>
    <span class="hljs-attr">statesHook</span>: <span class="hljs-title class_">VueHook</span>,   <span class="hljs-comment">// 绑定 Vue 响应式</span>
    <span class="hljs-attr">requestAdapter</span>: <span class="hljs-title function_">axiosRequestAdapter</span>(),
    <span class="hljs-attr">responded</span>: {
      <span class="hljs-attr">onSuccess</span>: <span class="hljs-keyword">async</span> (response) =&gt; response.<span class="hljs-property">data</span>,  <span class="hljs-comment">// 自动解包 Axios 响应</span>
      <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> { <span class="hljs-keyword">throw</span> error; },
    },
  });
}
</code></pre>
<h3 data-id="heading-34">10.3 服务端 API (createServerApi.ts)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createServerAlova</span>(<span class="hljs-params">{ baseURL, headers, timeout = <span class="hljs-number">30000</span> }</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createAlova</span>({
    baseURL,
    timeout,
    <span class="hljs-attr">cacheFor</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">statesHook</span>: <span class="hljs-title class_">VueHook</span>,
    <span class="hljs-attr">requestAdapter</span>: <span class="hljs-title function_">axiosRequestAdapter</span>(),
    <span class="hljs-title function_">beforeRequest</span>(<span class="hljs-params">method</span>) {
      <span class="hljs-comment">// 转发原始请求头（携带 Cookie/Authorization 等）</span>
      <span class="hljs-keyword">if</span> (headers) {
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(method.<span class="hljs-property">config</span>, {
          <span class="hljs-attr">headers</span>: { ...method.<span class="hljs-property">config</span>.<span class="hljs-property">headers</span>, ...headers },
        });
      }
    },
    <span class="hljs-attr">responded</span>: {
      <span class="hljs-attr">onSuccess</span>: <span class="hljs-keyword">async</span> (response) =&gt; response.<span class="hljs-property">data</span>,
      <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> { <span class="hljs-keyword">throw</span> error; },
    },
  });
}
</code></pre>
<blockquote>
<p><strong>客户端 vs 服务端的关键差异</strong>：服务端实例在 <code>beforeRequest</code> 中转发原始请求头（<code>headersOriginal</code>），用于传递登录态（Cookie、Token）。服务端还需要使用<strong>绝对 URL</strong>（<code>http://localhost:3000/api/v1</code>）而非相对路径。</p>
</blockquote>
<h3 data-id="heading-35">10.4 业务 API 定义</h3>
<p>业务 API 通过 <code>apiCreator</code> 统一创建，例如权限 API：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/api/permissionApi.ts</span>
<span class="hljs-keyword">import</span> { apiCreator, <span class="hljs-variable constant_">API_TYPE</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'#api/alovaInstance'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchPermissionList</span>(<span class="hljs-params">params, options?, customInstances?</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">apiCreator</span>(
    { ...options, <span class="hljs-attr">method</span>: <span class="hljs-string">'get'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'/permissions'</span>, <span class="hljs-attr">type</span>: <span class="hljs-variable constant_">API_TYPE</span>.<span class="hljs-property">DEFAULT</span> },
    params, customInstances,
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createPermission</span>(<span class="hljs-params">data, options?, customInstances?</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">apiCreator</span>(
    { ...options, <span class="hljs-attr">method</span>: <span class="hljs-string">'post'</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'/permissions'</span>, <span class="hljs-attr">type</span>: <span class="hljs-variable constant_">API_TYPE</span>.<span class="hljs-property">DEFAULT</span> },
    data, customInstances,
  );
}
</code></pre>
<hr/>
<h2 data-id="heading-36">11. Layout 系统</h2>
<h3 data-id="heading-37">11.1 公共布局与页面自定义</h3>
<p><strong>设计理念</strong>：Layout 是全局公共的，但每个页面可以通过 Pinia Store 暴露的方法来修改布局状态。</p>
<pre><code class="hljs language-scss" lang="scss">+Layout<span class="hljs-selector-class">.vue</span>（全局布局）
    ├── AppSidebar（侧边栏 — 读取 layoutStore<span class="hljs-selector-class">.sidebarMenus</span>）
    ├── AppHeader（顶部栏 — 读取 layoutStore<span class="hljs-selector-class">.breadcrumbs</span> / headerActions）
    └── &lt;slot /&gt;（页面内容）
            ↑
    页面在 onMounted 中调用 <span class="hljs-built_in">useLayout</span>() 设置标题、面包屑、按钮等
</code></pre>
<h3 data-id="heading-38">11.2 useLayout 组合式函数</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/composables/useLayout.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useLayout</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> layoutStore = <span class="hljs-title function_">useLayoutStore</span>();

  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    layoutStore.<span class="hljs-title function_">resetLayout</span>();  <span class="hljs-comment">// 每次页面挂载时重置布局状态</span>
  });

  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">setTitle</span>(<span class="hljs-params">title: <span class="hljs-built_in">string</span></span>) { layoutStore.<span class="hljs-title function_">setTitle</span>(title); },
    <span class="hljs-title function_">setBreadcrumbs</span>(<span class="hljs-params">items: BreadcrumbItem[]</span>) { layoutStore.<span class="hljs-title function_">setBreadcrumbs</span>(items); },
    <span class="hljs-title function_">setHeaderActions</span>(<span class="hljs-params">actions: HeaderAction[]</span>) { layoutStore.<span class="hljs-title function_">setHeaderActions</span>(actions); },
    <span class="hljs-title function_">setShowSidebar</span>(<span class="hljs-params">show: <span class="hljs-built_in">boolean</span></span>) { layoutStore.<span class="hljs-title function_">setShowSidebar</span>(show); },
    <span class="hljs-title function_">setShowHeader</span>(<span class="hljs-params">show: <span class="hljs-built_in">boolean</span></span>) { layoutStore.<span class="hljs-title function_">setShowHeader</span>(show); },
    <span class="hljs-title function_">toggleSidebar</span>(<span class="hljs-params"/>) { layoutStore.<span class="hljs-title function_">toggleSidebar</span>(); },
    <span class="hljs-title function_">clearHeaderActions</span>(<span class="hljs-params"/>) { layoutStore.<span class="hljs-title function_">clearHeaderActions</span>(); },
  };
}
</code></pre>
<p><strong>页面中使用示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script lang="ts" setup&gt;
import { onMounted } from 'vue';
import { useLayout } from '#composables/useLayout';
import { useI18n } from 'vue-i18n';

const { t } = useI18n();
const layout = useLayout();

onMounted(() =&gt; {
  layout.setTitle(t('menu.home'));
  layout.setBreadcrumbs([{ label: t('menu.home') }]);
  layout.setHeaderActions([
    { key: 'refresh', label: '刷新', type: 'primary', handler: () =&gt; loadData() },
  ]);
});
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-39">11.3 AppSidebar 组件</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/layout/AppSidebar.vue --&gt;
&lt;template&gt;
  &lt;div class="sidebar-menu"&gt;
    &lt;div class="logo"&gt;
      &lt;span class="logo-text"&gt;{{ t('app.title') }}&lt;/span&gt;
    &lt;/div&gt;
    &lt;el-menu :default-active="activePath" :collapse="collapsed" @select="handleSelect"&gt;
      &lt;template v-for="item in menus" :key="item.path"&gt;
        &lt;el-sub-menu v-if="item.children?.length" :index="item.path"&gt;
          &lt;template #title&gt;
            &lt;el-icon v-if="item.icon"&gt;&lt;component :is="item.icon" /&gt;&lt;/el-icon&gt;
            &lt;span&gt;{{ t(item.label) }}&lt;/span&gt;
          &lt;/template&gt;
          &lt;el-menu-item v-for="child in item.children" :key="child.path" :index="child.path"&gt;
            {{ t(child.label) }}
          &lt;/el-menu-item&gt;
        &lt;/el-sub-menu&gt;
        &lt;el-menu-item v-else :index="item.path"&gt;
          &lt;el-icon v-if="item.icon"&gt;&lt;component :is="item.icon" /&gt;&lt;/el-icon&gt;
          &lt;span&gt;{{ t(item.label) }}&lt;/span&gt;
        &lt;/el-menu-item&gt;
      &lt;/template&gt;
    &lt;/el-menu&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script lang="ts" setup&gt;
import { navigate } from 'vike/client/router';

function handleSelect(index: string) {
  navigate(index);  // 使用 Vike 的 navigate 进行客户端路由跳转
}
&lt;/script&gt;
</code></pre>
<blockquote>
<p><strong>重要</strong>：不能使用 Element Plus 的 <code>router</code> prop，因为它依赖 Vue Router。Vike 项目中应使用 <code>@select</code> 事件 + <code>navigate()</code> 手动导航。</p>
</blockquote>
<h3 data-id="heading-40">11.4 AppHeader 组件</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/layout/AppHeader.vue --&gt;
&lt;template&gt;
  &lt;div class="app-header"&gt;
    &lt;div class="header-left"&gt;
      &lt;el-icon class="toggle-btn" @click="emit('toggle-sidebar')"&gt;
        &lt;Fold v-if="!collapsed" /&gt;&lt;Expand v-else /&gt;
      &lt;/el-icon&gt;
      &lt;el-breadcrumb separator="/"&gt;
        &lt;el-breadcrumb-item v-for="item in breadcrumbs" :key="item.label" :to="item.path"&gt;
          {{ item.label }}
        &lt;/el-breadcrumb-item&gt;
      &lt;/el-breadcrumb&gt;
    &lt;/div&gt;
    &lt;div class="header-right"&gt;
      &lt;!-- 页面自定义按钮区域 --&gt;
      &lt;el-button v-for="action in headerActions" :key="action.key" :type="action.type" @click="action.handler"&gt;
        {{ action.label }}
      &lt;/el-button&gt;
      &lt;!-- 用户信息 --&gt;
      &lt;el-dropdown&gt;
        &lt;span class="user-info"&gt;
          &lt;el-icon&gt;&lt;User /&gt;&lt;/el-icon&gt; {{ user?.name || '未登录' }}
        &lt;/span&gt;
      &lt;/el-dropdown&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<hr/>
<h2 data-id="heading-41">12. Element Plus 集成（SSR 兼容）</h2>
<p>在 SSR 项目中集成 Element Plus 需要解决三个问题：</p>
<h3 data-id="heading-42">12.1 CSS 加载问题</h3>
<p><strong>问题</strong>：<code>unplugin-vue-components</code> 默认会自动导入组件对应的 CSS 文件，但 SSR 时 Node.js 无法处理 <code>.css</code> 文件。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-title class_">Components</span>({
  <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">ElementPlusResolver</span>({ <span class="hljs-attr">importStyle</span>: <span class="hljs-literal">false</span> })],  <span class="hljs-comment">// 禁用自动导入样式</span>
}),
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- +Layout.vue 中手动全量引入 --&gt;
&lt;script setup&gt;
import 'element-plus/dist/index.css';
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-43">12.2 ID 注入问题</h3>
<p><strong>问题</strong>：<code>ElementPlusError: [IdInjection] Looks like you are using server rendering, you must provide a id provider</code></p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// +onCreateApp.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">ID_INJECTION_KEY</span>, <span class="hljs-variable constant_">ZINDEX_INJECTION_KEY</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>;

app.<span class="hljs-title function_">provide</span>(<span class="hljs-variable constant_">ID_INJECTION_KEY</span>, { <span class="hljs-attr">prefix</span>: <span class="hljs-number">1024</span>, <span class="hljs-attr">current</span>: <span class="hljs-number">0</span> });
app.<span class="hljs-title function_">provide</span>(<span class="hljs-variable constant_">ZINDEX_INJECTION_KEY</span>, { <span class="hljs-attr">current</span>: <span class="hljs-number">0</span> });
</code></pre>
<h3 data-id="heading-44">12.3 Locale 国际化</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- +Layout.vue --&gt;
&lt;template&gt;
  &lt;el-config-provider :locale="elementLocale"&gt;
    &lt;!-- ... --&gt;
  &lt;/el-config-provider&gt;
&lt;/template&gt;

&lt;script setup&gt;
import zhCN from 'element-plus/es/locale/lang/zh-cn';
import enUS from 'element-plus/es/locale/lang/en';

const elementLocale = computed(() =&gt; locale.value === 'en-US' ? enUS : zhCN);
&lt;/script&gt;
</code></pre>
<hr/>
<h2 data-id="heading-45">13. 权限系统</h2>
<h3 data-id="heading-46">13.1 权限 URL 统一管理</h3>
<p>所有需要权限验证的 API URL 统一在 <code>src/constants/permissionApis.ts</code> 中管理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/constants/permissionApis.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PERMISSION_APIS</span> = {
  <span class="hljs-comment">/** 查询权限列表 */</span>
  <span class="hljs-attr">LIST</span>: <span class="hljs-string">'GET /api/v1/permissions'</span>,
  <span class="hljs-comment">/** 新增权限 */</span>
  <span class="hljs-attr">CREATE</span>: <span class="hljs-string">'POST /api/v1/permissions'</span>,
  <span class="hljs-comment">/** 编辑权限 */</span>
  <span class="hljs-attr">UPDATE</span>: <span class="hljs-string">'PUT /api/v1/permissions'</span>,
  <span class="hljs-comment">/** 删除权限 */</span>
  <span class="hljs-attr">DELETE</span>: <span class="hljs-string">'DELETE /api/v1/permissions'</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;
</code></pre>
<blockquote>
<p><strong>注意</strong>：<code>+config.ts</code> 文件由 vike 的 esbuild 插件编译，不支持 Vite 路径别名（<code>#constants/...</code>）。因此在 <code>+config.ts</code> 中必须使用<strong>相对路径</strong>导入常量，而在 <code>+Page.vue</code> 中可正常使用 <code>#</code> 别名。</p>
</blockquote>
<p>各页面 <code>+config.ts</code> 中按需声明所需的权限 URL：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/permission/+config.ts（列表页 — 需要所有操作权限）</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PERMISSION_APIS</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../constants/permissionApis'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-string">'权限列表'</span>,
  <span class="hljs-attr">permissionUrls</span>: [
    <span class="hljs-variable constant_">PERMISSION_APIS</span>.<span class="hljs-property">LIST</span>,
    <span class="hljs-variable constant_">PERMISSION_APIS</span>.<span class="hljs-property">CREATE</span>,
    <span class="hljs-variable constant_">PERMISSION_APIS</span>.<span class="hljs-property">UPDATE</span>,
    <span class="hljs-variable constant_">PERMISSION_APIS</span>.<span class="hljs-property">DELETE</span>,
  ],
};
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/pages/permission/add/+config.ts（新增页 — 只需 CREATE 权限）</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PERMISSION_APIS</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../constants/permissionApis'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-string">'新增权限'</span>,
  <span class="hljs-attr">permissionUrls</span>: [<span class="hljs-variable constant_">PERMISSION_APIS</span>.<span class="hljs-property">CREATE</span>],
};
</code></pre>
<h3 data-id="heading-47">13.2 页面级权限 — +guard.ts</h3>
<p><strong>流程：</strong></p>
<ol>
<li>页面在 <code>+config.ts</code> 中声明 <code>permissionUrls</code>（引用统一常量）</li>
<li><code>+guard.ts</code> 读取该配置，在 SSR 阶段调用后端 <code>POST /api/v1/permission/check</code></li>
<li>后端返回 <code>{ allowed: true/false, urlPermissions: { [url]: boolean } }</code></li>
<li><code>allowed: false</code> 时 <code>throw render(403)</code>，整页渲染错误页（如新增权限页无 CREATE 权限）</li>
<li><code>allowed: true</code> 时将 <code>urlPermissions</code> 写入 <code>pageContext.permissionResult</code>，通过 <code>passToClient</code> 传到客户端</li>
</ol>
<h3 data-id="heading-48">13.3 按钮级权限 — usePermission</h3>
<p>通过 <code>usePermission()</code> 组合式函数在组件中检查单个 URL 的权限，控制按钮 disabled 状态：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/composables/usePermission.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">usePermission</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> pageContext = <span class="hljs-title function_">usePageContext</span>();
  <span class="hljs-keyword">const</span> permissionResult = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> (pageContext <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">permissionResult</span> || {});

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">hasPermission</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> permissionResult.<span class="hljs-property">value</span>?.<span class="hljs-property">urlPermissions</span>?.[url] ?? <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">return</span> { permissionResult, hasPermission };
}
</code></pre>
<p><strong>列表页使用示例</strong>（控制添加/编辑/删除按钮）：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { usePermission } from '#composables/usePermission';
import { PERMISSION_APIS } from '#constants/permissionApis';

const { hasPermission } = usePermission();
const canCreate = hasPermission(PERMISSION_APIS.CREATE);
const canUpdate = hasPermission(PERMISSION_APIS.UPDATE);
const canDelete = hasPermission(PERMISSION_APIS.DELETE);
&lt;/script&gt;

&lt;template&gt;
  &lt;el-button type="primary" :disabled="!canCreate" @click="handleAdd"&gt;新增&lt;/el-button&gt;
  &lt;!-- 表格操作列 --&gt;
  &lt;el-button :disabled="!canUpdate" @click="handleEdit(row)"&gt;编辑&lt;/el-button&gt;
  &lt;el-button :disabled="!canDelete" @click="handleDelete(row)"&gt;删除&lt;/el-button&gt;
&lt;/template&gt;
</code></pre>
<p><strong>编辑页使用示例</strong>（通过 <code>canSubmit</code> prop 控制表单保存按钮）：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;PermissionForm
  :initial-data="detail"
  :is-sending="isSending"
  :can-submit="canUpdate"
  @submit="submit"
  @cancel="goBack"
/&gt;
</code></pre>
<p><code>PermissionForm.vue</code> 中保存按钮根据 <code>canSubmit</code> 属性禁用：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;el-button type="primary" :loading="isSending" :disabled="canSubmit === false" @click="submit"&gt;
  {{ t('common.save') }}
&lt;/el-button&gt;
</code></pre>
<h3 data-id="heading-49">13.4 Mock 权限验证（server/server.ts）</h3>
<p>开发阶段通过 Mock 接口模拟权限检查：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 模拟无权限的 URL 列表</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DENIED_URLS</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([
  <span class="hljs-string">'POST /api/v1/permissions'</span>,   <span class="hljs-comment">// 新增权限</span>
  <span class="hljs-string">'PUT /api/v1/permissions'</span>,    <span class="hljs-comment">// 编辑权限</span>
]);

<span class="hljs-comment">// pagePath + URL 命中时整页拒绝（403）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PAGE_BLOCKED_RULES</span> = [
  { <span class="hljs-attr">pathPattern</span>: <span class="hljs-regexp">/^\/permission\/add$/</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">'POST /api/v1/permissions'</span> },
];

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/v1/permission/check'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { urls = [], pagePath = <span class="hljs-string">''</span> } = req.<span class="hljs-property">body</span>;
  <span class="hljs-keyword">const</span> urlPermissions = {};
  urls.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">url</span>) =&gt;</span> { urlPermissions[url] = !<span class="hljs-variable constant_">DENIED_URLS</span>.<span class="hljs-title function_">has</span>(url); });

  <span class="hljs-comment">// 命中 PAGE_BLOCKED_RULES 则整页拒绝</span>
  <span class="hljs-keyword">const</span> allowed = !<span class="hljs-variable constant_">PAGE_BLOCKED_RULES</span>.<span class="hljs-title function_">some</span>(
    <span class="hljs-function">(<span class="hljs-params">rule</span>) =&gt;</span> rule.<span class="hljs-property">pathPattern</span>.<span class="hljs-title function_">test</span>(pagePath) &amp;&amp; urls.<span class="hljs-title function_">includes</span>(rule.<span class="hljs-property">url</span>) &amp;&amp; <span class="hljs-variable constant_">DENIED_URLS</span>.<span class="hljs-title function_">has</span>(rule.<span class="hljs-property">url</span>),
  );

  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">code</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">data</span>: { allowed, urlPermissions } });
});
</code></pre>
<ul>
<li><code>DENIED_URLS</code> — 控制哪些 URL 返回无权限（按钮 disabled）</li>
<li><code>PAGE_BLOCKED_RULES</code> — 当特定页面路径命中被拒绝的 URL 时，整页返回 403</li>
</ul>
<h3 data-id="heading-50">13.5 权限流程图</h3>
<pre><code class="hljs language-sql" lang="sql">用户请求页面
    │
    ▼
<span class="hljs-operator">+</span>guard.ts 读取 <span class="hljs-operator">+</span>config.ts 中的 permissionUrls（引用 PERMISSION_APIS 常量）
    │
    ├── 未配置 → 直接放行
    │
    └── 已配置 → SSR 调用 POST <span class="hljs-operator">/</span>api<span class="hljs-operator">/</span>v1<span class="hljs-operator">/</span>permission<span class="hljs-operator">/</span><span class="hljs-keyword">check</span> { urls, pagePath }
                    │
                    ├── allowed: <span class="hljs-literal">false</span> → throw render(<span class="hljs-number">403</span>) → 渲染 _error<span class="hljs-operator">/</span><span class="hljs-operator">+</span>Page.vue
                    │   （如: <span class="hljs-operator">/</span>permission<span class="hljs-operator">/</span><span class="hljs-keyword">add</span> 页面无 <span class="hljs-keyword">CREATE</span> 权限 → 整页 <span class="hljs-number">403</span>）
                    │
                    └── allowed: <span class="hljs-literal">true</span> → permissionResult 存入 pageContext
                            │
                            └── 组件中通过 usePermission().hasPermission(url) 判断
                                    │
                                    ├── <span class="hljs-literal">true</span>  → 按钮正常可用
                                    └── <span class="hljs-literal">false</span> → 按钮 disabled
                                        （如: 编辑页无 <span class="hljs-keyword">UPDATE</span> 权限 → 保存按钮禁用）
</code></pre>
<hr/>
<h2 data-id="heading-51">14. 路由与导航</h2>
<h3 data-id="heading-52">14.1 文件系统路由</h3>
<p>Vike 根据 <code>src/pages/</code> 目录结构自动生成路由：</p>



































<table><thead><tr><th>目录结构</th><th>路由路径</th><th>说明</th></tr></thead><tbody><tr><td><code>pages/index/+Page.vue</code></td><td><code>/</code></td><td>首页</td></tr><tr><td><code>pages/permission/+Page.vue</code></td><td><code>/permission</code></td><td>权限列表</td></tr><tr><td><code>pages/permission/add/+Page.vue</code></td><td><code>/permission/add</code></td><td>新增权限</td></tr><tr><td><code>pages/permission/@id/edit/+Page.vue</code></td><td><code>/permission/:id/edit</code></td><td>编辑权限（动态路由）</td></tr><tr><td><code>pages/_error/+Page.vue</code></td><td>错误页面</td><td>401/403/404/500</td></tr></tbody></table>
<blockquote>
<p><code>@id</code> 是 Vike 的动态路由语法，等效于 Vue Router 的 <code>:id</code>。通过 <code>pageContext.routeParams.id</code> 获取。</p>
</blockquote>
<h3 data-id="heading-53">14.2 客户端导航</h3>
<p>Vike 提供 <code>navigate</code> 函数实现客户端路由跳转（无刷新）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { navigate } <span class="hljs-keyword">from</span> <span class="hljs-string">'vike/client/router'</span>;

<span class="hljs-comment">// 跳转到指定页面</span>
<span class="hljs-title function_">navigate</span>(<span class="hljs-string">'/permission'</span>);

<span class="hljs-comment">// 跳转并替换历史记录</span>
<span class="hljs-title function_">navigate</span>(<span class="hljs-string">'/permission'</span>, { <span class="hljs-attr">overwriteLastHistoryEntry</span>: <span class="hljs-literal">true</span> });
</code></pre>
<blockquote>
<p>在 <code>+config.ts</code> 中已设置 <code>clientRouting: true</code>（由 <code>vike-vue</code> 默认配置），启用客户端路由。</p>
</blockquote>
<hr/>
<h2 data-id="heading-54">15. 业务页面示例</h2>
<h3 data-id="heading-55">15.1 Dashboard 首页</h3>
<p><strong>文件</strong>：<code>src/pages/index/</code></p>





















<table><thead><tr><th>文件</th><th>作用</th></tr></thead><tbody><tr><td><code>+config.ts</code></td><td>配置标题 <code>'首页'</code></td></tr><tr><td><code>+data.ts</code></td><td>SSR 调用 <code>/api/v1/dashboard/stats</code> 预取统计数据</td></tr><tr><td><code>+Page.vue</code></td><td>通过 <code>useData()</code> 获取数据，展示统计卡片和操作日志表格</td></tr></tbody></table>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
const data = useData&lt;Data&gt;();  // SSR 预取的数据，无需 onMounted 加载
const statCards = computed(() =&gt; [
  { key: 'total', label: t('dashboard.totalPermissions'), value: data.totalPermissions },
  // ...
]);
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-56">15.2 权限列表页</h3>
<p><strong>文件</strong>：<code>src/pages/permission/</code></p>





















<table><thead><tr><th>文件</th><th>作用</th></tr></thead><tbody><tr><td><code>+config.ts</code></td><td>配置标题 + <code>permissionUrls</code>（启用权限验证）</td></tr><tr><td><code>+data.ts</code></td><td>SSR 预取第一页权限列表</td></tr><tr><td><code>+Page.vue</code></td><td>展示列表 + 搜索 + 分页</td></tr></tbody></table>
<blockquote>
<p><strong>SSR + CSR 混合</strong>：首页数据通过 SSR 预取，后续翻页/搜索通过客户端 Alova 调用。</p>
</blockquote>
<h3 data-id="heading-57">15.3 新增权限页</h3>
<p><strong>文件</strong>：<code>src/pages/permission/add/</code></p>





















<table><thead><tr><th>文件</th><th>作用</th></tr></thead><tbody><tr><td><code>+config.ts</code></td><td>配置标题 + <code>permissionUrls</code></td></tr><tr><td><code>+data.ts</code></td><td>空 data 文件（阻止继承父级的 +data.ts）</td></tr><tr><td><code>+Page.vue</code></td><td>使用 <code>PermissionForm</code> 组件</td></tr></tbody></table>
<blockquote>
<p><strong>关键</strong>：必须创建空的 <code>+data.ts</code>，否则会继承 <code>permission/+data.ts</code> 的数据加载逻辑，导致不需要的 API 调用甚至报错。</p>
</blockquote>
<h3 data-id="heading-58">15.4 编辑权限页</h3>
<p><strong>文件</strong>：<code>src/pages/permission/@id/edit/</code></p>
<p>与新增页类似，额外通过 <code>pageContext.routeParams.id</code> 获取路由参数，在 <code>onMounted</code> 中加载详情数据：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
const pageContext = usePageContext();
const routeParams = pageContext.routeParams as { id: string };

onMounted(() =&gt; {
  fetchDetail(routeParams.id);
});
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-59">15.5 可复用组件 — PermissionForm</h3>
<p><code>src/viewComponents/permission/PermissionForm.vue</code> 同时服务于新增和编辑页面：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
const props = defineProps&lt;{
  initialData?: Record&lt;string, any&gt;;  // 编辑时传入已有数据
  isSending?: boolean;                // 提交中状态
  canSubmit?: boolean;                // 是否有提交权限（false 时禁用保存按钮）
}&gt;();

const emit = defineEmits&lt;{
  submit: [data: Record&lt;string, any&gt;];
  cancel: [];
}&gt;();

// 表单验证规则
const rules: FormRules = {
  name: [{ required: true, message: '请输入权限名称', trigger: 'blur' }],
  code: [{ required: true, message: '请输入权限编码', trigger: 'blur' }],
  type: [{ required: true, message: '请选择权限类型', trigger: 'change' }],
};
&lt;/script&gt;
</code></pre>
<hr/>
<h2 data-id="heading-60">16. SSR 与 CSR 策略</h2>








































<table><thead><tr><th>场景</th><th>策略</th><th>实现方式</th></tr></thead><tbody><tr><td>首屏数据</td><td>SSR</td><td><code>+data.ts</code> → <code>useData()</code></td></tr><tr><td>权限验证</td><td>SSR</td><td><code>+guard.ts</code> → <code>throw render(403)</code></td></tr><tr><td>翻页/搜索</td><td>CSR</td><td>组件内直接使用客户端 Alova</td></tr><tr><td>表单提交</td><td>CSR</td><td>组件内调用 API 后 <code>navigate()</code></td></tr><tr><td>页面跳转</td><td>CSR</td><td><code>navigate()</code> 客户端路由</td></tr><tr><td>初始页面加载</td><td>SSR</td><td>Express → <code>renderPage()</code> → HTML</td></tr></tbody></table>
<p><strong>数据流：</strong></p>
<pre><code class="hljs language-css" lang="css">SSR 阶段:
  Express → <span class="hljs-built_in">renderPage</span>() → +guard.ts → +data.ts → +Layout.vue + +Page.vue → HTML

CSR 阶段 (客户端路由):
  <span class="hljs-built_in">navigate</span>() → +guard.ts (client) → +data.ts → 组件更新
</code></pre>
<hr/>
<h2 data-id="heading-61">17. 关键踩坑与解决方案</h2>
<h3 data-id="heading-62">17.1 Express 5 路由语法变更</h3>
<p><strong>问题</strong>：<code>app.get('*', ...)</code> 报错 <code>Missing parameter name</code></p>
<p><strong>原因</strong>：Express 5 使用新版 <code>path-to-regexp</code>，不再支持裸通配符</p>
<p><strong>解决</strong>：改为命名通配符 <code>app.get('/{*path}', ...)</code></p>
<h3 data-id="heading-63">17.2 Element Plus CSS SSR 加载失败</h3>
<p><strong>问题</strong>：<code>TypeError [ERR_UNKNOWN_FILE_EXTENSION]: Unknown file extension ".css"</code></p>
<p><strong>原因</strong>：Node.js SSR 环境无法处理 CSS 文件</p>
<p><strong>解决</strong>：</p>
<ul>
<li><code>ElementPlusResolver({ importStyle: false })</code> 禁用自动导入样式</li>
<li>在 <code>+Layout.vue</code> 中 <code>import 'element-plus/dist/index.css'</code>（Vite 会正确处理）</li>
</ul>
<h3 data-id="heading-64">17.3 Element Plus SSR ID/ZIndex 注入</h3>
<p><strong>问题</strong>：Hydration 失败，控制台报 <code>IdInjection</code> 和 <code>ZIndexInjection</code> 错误</p>
<p><strong>解决</strong>：在 <code>+onCreateApp.ts</code> 中 <code>app.provide(ID_INJECTION_KEY, ...)</code> 和 <code>app.provide(ZINDEX_INJECTION_KEY, ...)</code></p>
<h3 data-id="heading-65">17.4 服务端 API 调用使用相对 URL</h3>
<p><strong>问题</strong>：<code>+data.ts</code> 和 <code>+guard.ts</code> 中使用 <code>/api/v1/xxx</code> 相对路径在 SSR 中无法工作</p>
<p><strong>原因</strong>：Node.js 中没有浏览器的 <code>location.origin</code>，相对 URL 无法解析</p>
<p><strong>解决</strong>：SSR 中使用绝对 URL <code>http://localhost:${process.env.PORT || 3000}/api/v1</code></p>
<h3 data-id="heading-66">17.5 +data.ts 的继承问题</h3>
<p><strong>问题</strong>：<code>/permission/add</code> 页面继承了 <code>/permission/+data.ts</code> 的数据加载，导致不必要的 API 调用</p>
<p><strong>原因</strong>：Vike 的 <code>+data.ts</code> 会沿目录树向上继承</p>
<p><strong>解决</strong>：在子目录创建空的 <code>+data.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Data</span> = <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">never</span>&gt;;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> {}; }
</code></pre>
<h3 data-id="heading-67">17.6 El-Menu 的 router prop 不兼容 Vike</h3>
<p><strong>问题</strong>：侧边栏菜单点击无反应或报错</p>
<p><strong>原因</strong>：Element Plus 的 <code>el-menu</code> <code>router</code> prop 依赖 Vue Router，Vike 项目不使用 Vue Router</p>
<p><strong>解决</strong>：移除 <code>router</code> prop，使用 <code>@select</code> 事件 + <code>navigate()</code>:</p>
<pre><code class="hljs language-vue" lang="vue">&lt;el-menu @select="handleSelect"&gt;
  &lt;!-- ... --&gt;
&lt;/el-menu&gt;

&lt;script setup&gt;
import { navigate } from 'vike/client/router';
function handleSelect(index: string) {
  navigate(index);
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-68">17.7 process.env 在客户端不可用</h3>
<p><strong>问题</strong>：<code>ReferenceError: process is not defined</code></p>
<p><strong>原因</strong>：<code>+guard.ts</code> 在客户端也会执行，但 <code>process.env</code> 仅在 Node.js 中可用</p>
<p><strong>解决</strong>：将 <code>process.env</code> 访问放在 <code>if (typeof window === 'undefined')</code> 分支内</p>
<hr/>
<h2 data-id="heading-69">18. 开发与构建命令</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开发（启动 Express + Vite HMR）</span>
npm run dev

<span class="hljs-comment"># 构建（生成 dist/client + dist/server）</span>
npm run build

<span class="hljs-comment"># 生产预览</span>
npm run preview

<span class="hljs-comment"># 代码检查</span>
npm run lint

<span class="hljs-comment"># 自动修复</span>
npm run fix
</code></pre>
<p><strong>开发环境</strong>：<code>tsx server/server.ts</code> → Express 启动 → <code>createDevMiddleware</code> 注入 Vite HMR → 访问 <code>http://localhost:3000</code></p>
<p><strong>生产构建</strong>：<code>vike build</code> → 输出 <code>dist/client</code>（静态资源）+ <code>dist/server</code>（SSR Bundle）</p>
<hr/>
<h2 data-id="heading-70">19. 生产部署</h2>
<h3 data-id="heading-71">19.1 构建产物结构</h3>
<p>执行 <code>npm run build</code>（即 <code>vike build</code>）后生成 <code>dist/</code> 目录：</p>
<pre><code class="hljs language-csharp" lang="csharp">dist/
├── assets.json                    <span class="hljs-meta"># 资源映射文件（Vike 内部使用）</span>
├── client/                        <span class="hljs-meta"># 静态资源（浏览器端）</span>
│   └── assets/
│       ├── chunks/                <span class="hljs-meta"># JS 代码分割块</span>
│       ├── entries/               <span class="hljs-meta"># 各页面入口 JS</span>
│       └── <span class="hljs-keyword">static</span>/               <span class="hljs-meta"># CSS 文件</span>
└── server/                        <span class="hljs-meta"># SSR 服务端代码</span>
    ├── entry.mjs                  <span class="hljs-meta"># SSR 入口（Vike renderPage 用）</span>
    ├── entries/                   <span class="hljs-meta"># 各页面的 SSR 渲染逻辑</span>
    ├── chunks/                    <span class="hljs-meta"># 服务端公共模块</span>
    └── package.json               <span class="hljs-meta"># { "type": "module" }</span>
</code></pre>
<h3 data-id="heading-72">19.2 部署方式</h3>
<p>本项目使用 <strong>Express 作为生产服务器</strong>，<code>server/server.ts</code> 同时处理静态文件托管和 SSR 渲染。部署步骤：</p>
<p><strong>1. 构建</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm run build
</code></pre>
<p><strong>2. 部署所需文件</strong></p>
<p>将以下文件/目录上传到服务器：</p>
<pre><code class="hljs language-bash" lang="bash">dist/                <span class="hljs-comment"># 构建产物（client + server）</span>
server/server.ts     <span class="hljs-comment"># Express 服务器入口</span>
package.json         <span class="hljs-comment"># 依赖声明</span>
node_modules/        <span class="hljs-comment"># 或在服务器上 npm install</span>
</code></pre>
<p><strong>3. 启动服务</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式一：直接用 tsx 运行 TypeScript（需安装 tsx）</span>
cross-env NODE_ENV=production tsx server/server.ts

<span class="hljs-comment"># 方式二：用 PM2 管理进程（推荐）</span>
pm2 start <span class="hljs-string">"cross-env NODE_ENV=production tsx server/server.ts"</span> --name vike-admin

<span class="hljs-comment"># 自定义端口</span>
cross-env NODE_ENV=production PORT=8080 tsx server/server.ts
</code></pre>
<p><strong>运行原理：</strong> <code>server/server.ts</code> 中根据 <code>NODE_ENV</code> 自动切换行为：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (isProd) {
  <span class="hljs-comment">// 生产环境：sirv 托管 dist/client 静态文件</span>
  <span class="hljs-keyword">const</span> sirv = (<span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'sirv'</span>)).<span class="hljs-property">default</span>;
  app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">sirv</span>(<span class="hljs-string">`<span class="hljs-subst">${root}</span>/dist/client`</span>));
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 开发环境：Vite HMR 开发中间件</span>
  <span class="hljs-keyword">const</span> { devMiddleware } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createDevMiddleware</span>({ root });
  app.<span class="hljs-title function_">use</span>(devMiddleware);
}
</code></pre>
<p>Vike 的 <code>renderPage()</code> 在生产环境会自动加载 <code>dist/server/entry.mjs</code> 进行 SSR 渲染。</p>
<h3 data-id="heading-73">19.3 Nginx 反向代理（可选）</h3>
<p>如果需要通过 Nginx 暴露服务：</p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
</code></pre>
<h3 data-id="heading-74">19.4 Docker 部署（可选）</h3>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM node:20-alpine
WORKDIR /app

COPY package.json yarn.lock ./
RUN yarn install --production=false

COPY . .
RUN yarn build

ENV NODE_ENV=production
ENV PORT=3000
EXPOSE 3000

CMD ["npx", "tsx", "server/server.ts"]
</code></pre>
<pre><code class="hljs language-bash" lang="bash">docker build -t vike-admin .
docker run -d -p 3000:3000 vike-admin
</code></pre>
<h3 data-id="heading-75">19.5 注意事项</h3>





























<table><thead><tr><th>事项</th><th>说明</th></tr></thead><tbody><tr><td><code>NODE_ENV</code></td><td>必须设为 <code>production</code>，否则会尝试启动 Vite 开发中间件</td></tr><tr><td>Mock API</td><td>生产环境应替换为真实后端 API 代理，移除 Mock 路由</td></tr><tr><td><code>tsx</code></td><td>生产环境仍需 <code>tsx</code> 来运行 TypeScript 的 <code>server.ts</code>，也可预编译为 JS</td></tr><tr><td>端口</td><td>默认 3000，可通过 <code>PORT</code> 环境变量修改</td></tr><tr><td><code>dist/</code> 路径</td><td><code>server.ts</code> 通过 <code>__dirname + '/..</code> 定位 dist，部署时保持目录相对关系</td></tr></tbody></table>
<hr/>
<blockquote>
<p><strong>本文档对应项目版本</strong>：2026-02-12 · Vike 0.4.252 · Vue 3.5 · Element Plus 2.9 · Express 5.2</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GitHub 上狂揽 1.3 万 Star！港大开源的轻量版 Clawdbot。]]></title>    <link>https://juejin.cn/post/7605419006683185194</link>    <guid>https://juejin.cn/post/7605419006683185194</guid>    <pubDate>2026-02-12T06:05:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605419006683185194" data-draft-id="7605288666664583210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GitHub 上狂揽 1.3 万 Star！港大开源的轻量版 Clawdbot。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-02-12T06:05:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GitHub 上狂揽 1.3 万 Star！港大开源的轻量版 Clawdbot。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:05:06.000Z" title="Thu Feb 12 2026 06:05:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这个叫 nanobot 的项目是香港大学数据科学实验室开源的项目。</p>
<p>既然 nano 开头，就说明这是一个超轻量级个人 AI 助手，非常注重可读性、研究友好、启动快、易集成多模型和多聊天通道。</p>
<p>开源没多长时间，就 1.3 万的 Star 了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/288c127fd63a4f8ab4906983c66e0475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771481106&amp;x-signature=O7HZzqXKM6z39Crk1EX6Yerld3w%3D" alt="图片" loading="lazy"/></p>
<p>它受 Clawdbot 启发，整个项目也就 4000 行代码，原版 Clawdbot 大概有 43 万行代码，缩减了 99%。</p>
<p>所以说，你想研究研究 Clawbot 怎么搞出来的，可以先看看这个 nanobot，非常易读、修改和扩展。</p>
<p><strong>01</strong>、项目简介</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51fc233e4a374bd68e57b534b282e114~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771481106&amp;x-signature=ItQY6AC12ILBAwIeTgo3%2BaQ7Q90%3D" alt="图片" loading="lazy"/></p>
<p>nanobot <strong>也支持通过 Telegram、Discord、WhatsApp 以及</strong> <strong>飞书与 AI 交互。特别是对飞书的支持，使其非常适合国内办公场景。</strong></p>
<p><strong>而且它支持几乎所有主流 LLM 提供商，包括 OpenRouter、 Claude、OpenAI、DeepSeek、Google Gemini，以及通过 vLLM 运行的本地模型。</strong></p>
<p>这是 nanobot 的架构图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb59a9eae81147ea9d71b4df5fc32200~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771481106&amp;x-signature=xL8QUoFL7U2ZoQYB4g4qa0nyylo%3D" alt="图片" loading="lazy"/></p>
<p>Agent Loop 负责根据当前任务、上下文和工具结果进行连续推理和行动。记忆、上下文管理模块来负责短期、长期记忆、上下文裁剪与重组。</p>
<p>Skills &amp; Tools 系统是一组可调用工具，比如调用 GitHub、天气、tmux、shell 等。</p>
<p>除此之外还有 Chat 应用，负责接收、发送消息的多种通道适配层。LLM 模块来管理和自动识别不同 LLM 提供商和模型。</p>
<p><strong>02</strong>、能干啥？</p>
<p>你可以用 nanobot 搭建自己的个人 AI 助手，比如：</p>
<p>让 nanobot 做全栈软件工程师，能理解代码库、协助开发、部署、扩缩。</p>
<p>进行全天候实时市场分析，监控行情、发现趋势、生成洞见：</p>
<p>智能日常事务管理器，管理日程、自动执行重复任务、整理 TODO 啥的：</p>
<p>个人知识助手，学习你的资料、进行长期记忆和推理啥的。</p>
<p><strong>03</strong>、如何使用</p>
<p>你可以通过 uv 或 pip 快速安装 nanobot。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e30dc3343ea74b5388c30551f9ee195d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771481106&amp;x-signature=d3%2BwNGyz9q%2B9uGR353gyxrxJcCY%3D" alt="图片" loading="lazy"/></p>
<p>安装完之后，你需要配置 API Key，比如 OpenRouter 或 OpenAI 的 Key，然后通过简单的命令行指令即可启动：</p>
<p>① 初始化</p>
<pre><code class="hljs">nanobot onboard
</code></pre>
<p>② 配置</p>
<p>对于 OpenRouter 的用户，在 ~/.nanobot/config.json 中配置一下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>  <span class="hljs-attr">"providers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>    <span class="hljs-attr">"openrouter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>      <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sk-or-v1-xxx"</span>    <span class="hljs-punctuation">}</span>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>  <span class="hljs-attr">"agents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>    <span class="hljs-attr">"defaults"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"anthropic/claude-opus-4-5"</span>    <span class="hljs-punctuation">}</span>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<p>③ 开整</p>
<pre><code class="hljs language-arduino" lang="arduino">nanobot agent -m <span class="hljs-string">"二加二等于几？"</span>
</code></pre>
<p>就这样，你在两分钟内就拥有一个可以工作的 AI 助手了。</p>
<p>目前 nanobot 这个轻量的 AI 助手特别火，我感觉主要是因为开发者厌倦黑盒式的大型框架，想要一个自己能完全看懂并掌控的代码库。</p>
<p>对于学术界，一个干净的基座比一个臃肿的产品更适合做实验。</p>
<p>而且它证明了构建一个功能强大的 AI Agent 不需要复杂的微服务架构，单体 Python 脚本依然能打。</p>
<pre><code class="hljs language-bash" lang="bash">开源地址：https://github.com/HKUDS/nanobot
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官：单核 CPU 支持 Java 多线程吗？为什么？]]></title>    <link>https://juejin.cn/post/7605516501751562249</link>    <guid>https://juejin.cn/post/7605516501751562249</guid>    <pubDate>2026-02-12T06:15:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605516501751562249" data-draft-id="7605492906904977454" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官：单核 CPU 支持 Java 多线程吗？为什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-12T06:15:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官：单核 CPU 支持 Java 多线程吗？为什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:15:04.000Z" title="Thu Feb 12 2026 06:15:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>由于现在大多计算机都是多核CPU，多线程往往会比单线程更快，更能够提高并发，但提高并发并不意味着启动更多的线程来执行。更多的线程意味着线程创建销毁开销加大、上下文非常频繁，你的程序反而不能支持更高的TPS。</p>
<h2 data-id="heading-0">时间片</h2>
<p>多任务系统往往需要同时执行多道作业。作业数往往大于机器的CPU数，然而一颗CPU同时只能执行一项任务，如何让用户感觉这些任务正在同时进行呢? 操作系统的设计者 巧妙地利用了时间片轮转的方式</p>
<p>时间片是CPU分配给各个任务（线程）的时间！</p>
<blockquote>
<p>思考：单核CPU为何也支持多线程呢？</p>
</blockquote>
<p>线程上下文是指某一时间点 CPU 寄存器和程序计数器的内容，CPU通过时间片分配算法来循环执行任务（线程），因为时间片非常短，所以CPU通过不停地切换线程执行。</p>
<p>换言之，单CPU这么频繁，多核CPU一定程度上可以减少上下文切换。</p>
<h2 data-id="heading-1">超线程</h2>
<p>现代CPU除了处理器核心之外还包括寄存器、L1L2缓存这些存储设备、浮点运算单元、整数运算单元等一些辅助运算设备以及内部总线等。一个多核的CPU也就是一个CPU上有多个处理器核心，就意味着程序的不同线程需要经常在CPU之间的外部总线上通信，同时还要处理不同CPU之间不同缓存导致数据不一致的问题。</p>
<p>超线程这个概念是Intel提出的，简单来说是在一个CPU上真正的并发两个线程，由于CPU都是分时的（如果两个线程A和B，A正在使用处理器核心，B正在使用缓存或者其他设备，那AB两个线程就可以并发执行，但是如果AB都在访问同一个设备，那就只能等前一个线程执行完后一个线程才能执行）。实现这种并发的原理是 在CPU里加了一个协调辅助核心，根据Intel提供的数据，这样一个设备会使得设备面积增大5%，但是性能提高15%~30%。</p>
<h2 data-id="heading-2">上下文切换</h2>
<ul>
<li>线程切换，同一进程中的两个线程之间的切换</li>
<li>进程切换，两个进程之间的切换</li>
<li>模式切换，在给定线程中，用户模式和内核模式的切换</li>
<li>地址空间切换，将虚拟内存切换到物理内存</li>
</ul>
<p>CPU切换前把当前任务的状态保存下来，以便下次切换回这个任务时可以再次加载这个任务的状态，然后加载下一任务的状态并执行。任务的状态保存及再加载, 这段过程就叫做上下文切换。</p>
<p>每个线程都有一个程序计数器（记录要执行的下一条指令），一组寄存器（保存当前线程的工作变量），堆栈（记录执行历史，其中每一帧保存了一个已经调用但未返回的过程）。</p>
<p>寄存器 是 CPU 内部的数量较少但是速度很快的内存（与之对应的是 CPU 外部相对较慢的 RAM 主内存）。寄存器通过对常用值（通常是运算的中间值）的快速访问来提高计算机程序运行的速度。</p>
<p>程序计数器是一个专用的寄存器，用于表明指令序列中 CPU 正在执行的位置，存的值为正在执行的指令的位置或者下一个将要被执行的指令的位置。</p>
<ul>
<li>挂起当前任务（线程/进程），将这个任务在 CPU 中的状态（上下文）存储于内存中的某处</li>
<li>恢复一个任务（线程/进程），在内存中检索下一个任务的上下文并将其在 CPU 的寄存器中恢复</li>
<li>跳转到程序计数器所指向的位置（即跳转到任务被中断时的代码行），以恢复该进程在程序中]</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf8cb494a36740cd892fb82cac23fc1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771481704&amp;x-signature=8dn%2FUYyWB9BhsD9Kh6QmogpAR3o%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">线程上下文切换会有什么问题呢？</h3>
<p>上下文切换会导致额外的开销，常常表现为高并发执行时速度会慢串行，因此减少上下文切换次数便可以提高多线程程序的运行效率。</p>
<ul>
<li>直接消耗：指的是CPU寄存器需要保存和加载, 系统调度器的代码需要执行, TLB实例需要重新加载, CPU 的pipeline需要刷掉</li>
<li>间接消耗：指的是多核的cache之间得共享数据, 间接消耗对于程序的影响要看线程工作区操作数据的大小</li>
</ul>
<h2 data-id="heading-4">切换查看</h2>
<p>Linux系统下可以使用vmstat命令来查看上下文切换的次数， 其中cs列就是指上下文切换的数目（一般情况下, 空闲系统的上下文切换每秒大概在1500以下）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef28a1b813ef412e929477433fefc882~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771481704&amp;x-signature=kMwftRXMpjIr7ou%2FfnGsemfMPvE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">线程调度</h2>
<h3 data-id="heading-6">抢占式调度</h3>
<p>指的是每条线程执行的时间、线程的切换都由系统控制，系统控制指的是在系统某种运行机制下，可能每条线程都分同样的执行时间片，也可能是某些线程执行的时间片较长，甚至某些线程得不到执行的时间片。在这种机制下，一个线程的堵塞不会导致整个进程堵塞。</p>
<p>java使用的线程调使用抢占式调度，Java中线程会按优先级分配CPU时间片运行，且优先级越高越优先执行，但优先级高并不代表能独自占用执行时间片，可能是优先级高得到越多的执行时间片，反之，优先级低的分到的执行时间少但不会分配不到执行时间。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8996e8e92a947b0bd65fe82e585f79d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771481704&amp;x-signature=peHd30vG%2FnYoPfO8ENNMfDTncq0%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-7">协同式调度</h3>
<p>指某一线程执行完后主动通知系统切换到另一线程上执行，这种模式就像接力赛一样，一个人跑完自己的路程就把接力棒交接给下一个人，下个人继续往下跑。线程的执行时间由线程本身控制，线程切换可以预知，不存在多线程同步问题，但它有一个致命弱点：如果一个线程编写有问题，运行到一半就一直堵塞，那么可能导致整个系统崩溃。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca1fb51fcd65484a8750fe3c6740ae92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771481704&amp;x-signature=lcbh1J%2BXRIqOF66D%2BLMcEIt9GlI%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-8">线程让出cpu的情况</h3>
<ul>
<li>当前运行线程主动放弃CPU，JVM暂时放弃CPU操作（基于时间片轮转调度的JVM操作系统不会让线程永久放弃CPU，或者说放弃本次时间片的执行权），例如调用<code>yield()</code>方法。</li>
<li>当前运行线程因为某些原因进入阻塞状态，例如阻塞在I/O上</li>
<li>当前运行线程结束，即运行完<code>run()</code>方法里面的任务</li>
</ul>
<h2 data-id="heading-9">引起线程上下文切换的因素</h2>
<ul>
<li>当前执行任务（线程）的时间片用完之后，系统CPU正常调度下一个任务</li>
<li>中断处理，在中断处理中，其他程序”打断”了当前正在运行的程序。当CPU接收到中断请求时，会在正在运行的程序和发起中断请求的程序之间进行一次上下文切换。中断分为硬件中断和软件中断，软件中断包括因为IO阻塞、未抢到资源或者用户代码等原因，线程被挂起。</li>
<li>用户态切换，对于一些操作系统，当进行用户态切换时也会进行一次上下文切换，虽然这不是必须的。</li>
<li>多个任务抢占锁资源，在多任务处理中，CPU会在不同程序之间来回切换，每个程序都有相应的处理时间片，CPU在两个时间片的间隔中进行上下文切换</li>
</ul>
<h3 data-id="heading-10">因此优化手段有：</h3>
<ul>
<li>无锁并发编程，多线程处理数据时，可以用一些办法来避免使用锁，如将数据的ID按照Hash取模分段，不同的线程处理不同段的数据</li>
<li>CAS算法，Java的Atomic包使用CAS算法来更新数据，而不需要加锁</li>
<li>使用最少线程</li>
<li>协程，单线程里实现多任务的调度，并在单线程里维持多个任务间的切换</li>
</ul>
<p>合理设置线程数目既可以最大化利用CPU，又可以减少线程切换的开销。</p>
<ul>
<li>高并发，低耗时的情况，建议少线程。</li>
<li>低并发，高耗时的情况：建议多线程。</li>
<li>高并发高耗时，要分析任务类型、增加排队、加大线程数</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[40 个 Agent Skills 精选资源：入门教程 + 实用工具 + 必装推荐]]></title>    <link>https://juejin.cn/post/7605422894052605967</link>    <guid>https://juejin.cn/post/7605422894052605967</guid>    <pubDate>2026-02-12T06:19:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605422894052605967" data-draft-id="7605468286180966435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="40 个 Agent Skills 精选资源：入门教程 + 实用工具 + 必装推荐"/> <meta itemprop="keywords" content="Agent,程序员,前端"/> <meta itemprop="datePublished" content="2026-02-12T06:19:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            40 个 Agent Skills 精选资源：入门教程 + 实用工具 + 必装推荐
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:19:42.000Z" title="Thu Feb 12 2026 06:19:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员鱼皮。</p>
<p>Agent Skills 最近在 AI 圈儿火得一塌糊涂。简单来说，它就是给 AI 装备的技能包，里面有精心设计的提示词、代码脚本、还有各种资源文件，让 AI 能在特定任务上表现得更专业，比如做 PPT、操作 Excel 表格、剪辑视频等等。</p>
<p>鱼皮精心汇总了全网最主流实用的 Agent Skills 资源，从 Skills 入门教程、Skills 安装管理工具、Skills 资源合集、再到推荐安装的 Skills，一条龙服务，墙裂建议收藏备用！</p>
<p><img src="https://pic.yupi.icu/1/AgentSkills%E7%B2%BE%E9%80%89%E8%B5%84%E6%BA%90%E5%A4%A7%E5%85%A8%E5%A4%A7.jpeg" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">Agent Skills 入门教程</h2>
<p>⭐️ <strong>鱼皮的 Agent Skills 保姆级入门教程</strong>：从零开始讲 Agent Skills 是什么、怎么安装和使用、内部原理是什么、怎么创建自己的 Skills、和 MCP 的区别等，一个视频全讲明白了，喂饭级教程。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1T7zzBQEaA%2F" target="_blank" title="https://www.bilibili.com/video/BV1T7zzBQEaA/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1T7…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204114501340.png" alt="" loading="lazy"/></p>
<p><strong>吴恩达 × Anthropic 官方课程</strong>：DeepLearning.AI 和 Anthropic 联合出品的 Agent Skills 课程，教你按照最佳实践创建 Skills，课程虽然是英文的但质量很高，可以搭配个字幕翻译的浏览器插件食用。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.deeplearning.ai%2Fshort-courses%2Fagent-skills-with-anthropic%2F" target="_blank" title="https://www.deeplearning.ai/short-courses/agent-skills-with-anthropic/" ref="nofollow noopener noreferrer">www.deeplearning.ai/short-cours…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204114410871.png" alt="" loading="lazy"/></p>
<p><strong>鱼皮的 AI 编程零基础教程</strong>：想学 AI 编程但不知道从哪开始？这个教程从 Vibe Coding 概念讲起，手把手教你用 Claude Code、Cursor 这些工具，以及 Agent Skills、MCP 等扩展能力，零基础也能看懂。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.codefather.cn%2Fvibe" target="_blank" title="https://ai.codefather.cn/vibe" ref="nofollow noopener noreferrer">ai.codefather.cn/vibe</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/3%E9%B1%BC%E7%9A%AE%E7%9A%84%20AI%20%E5%AF%BC%E8%88%AA-%E6%95%99%E7%A8%8B%E5%9B%BE%E6%96%87%E5%B9%B6%E8%8C%82.png" alt="鱼皮AI导航-教程图文并茂" loading="lazy"/></p>
<h2 data-id="heading-1">Agent Skills 安装管理</h2>
<p><strong>skills CLI</strong>：Vercel 官方出品的命令行工具，一行命令就能安装任何 Skills，简单好用。</p>
<p>用法是 <code>npx skills add &lt;owner/repo&gt;</code>，比如 <code>npx skills add vercel-labs/agent-skills</code> 就能装上 Vercel 官方的所有 Skills。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fskills" target="_blank" title="https://www.npmjs.com/package/skills" ref="nofollow noopener noreferrer">www.npmjs.com/package/ski…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204114830800.png" alt="" loading="lazy"/></p>
<p><strong>Skill Seeker</strong>：这个工具牛了，能自动抓取文档网站、GitHub 仓库、PDF 文件，然后直接转换成 Agent Skills，省去了手写技能说明文档的麻烦。支持多源抓取、代码深度分析、一键打包，特别适合给自己常用的库或框架快速生成 Skills。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyusufkaraaslan%2FSkill_Seekers" target="_blank" title="https://github.com/yusufkaraaslan/Skill_Seekers" ref="nofollow noopener noreferrer">github.com/yusufkaraas…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204115524485.png" alt="" loading="lazy"/></p>
<p><strong>everything-claude-code</strong>：Anthropic 黑客松冠军的完整配置集合，包括 agents、skills、hooks、commands、rules、MCPs，都是实战验证过的配置，拿来就能用。想一次性配置好 Claude Code 的话装这个就够了。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faffaan-m%2Feverything-claude-code" target="_blank" title="https://github.com/affaan-m/everything-claude-code" ref="nofollow noopener noreferrer">github.com/affaan-m/ev…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204121536989.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">Agent Skills 资源合集</h2>
<h3 data-id="heading-3">在线市场</h3>
<p><strong>skills.sh</strong>：Vercel 官方出品的 Skills 排行榜，能看到每个 Skill 的安装量、使用趋势，还支持一键安装。想知道哪些 Skills 最火，来这里看就对了。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fskills.sh" target="_blank" title="https://skills.sh" ref="nofollow noopener noreferrer">skills.sh</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204115906122.png" alt="" loading="lazy"/></p>
<p><strong>鱼皮 AI 导航 - Skills 专区</strong>：我的中文 Agent Skills 导航网站，按分类整理好了几百个 Skills，界面友好、查找方便，适合国内的朋友们使用。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.codefather.cn%2Fskills" target="_blank" title="https://ai.codefather.cn/skills" ref="nofollow noopener noreferrer">ai.codefather.cn/skills</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260201150711260.png" alt="" loading="lazy"/></p>
<p><strong>skillsmp</strong>：自动抓取 GitHub 上所有 Skills 项目，按分类、更新时间、Star 数量整理，数据更新及时。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fskillsmp.com%2Fzh" target="_blank" title="https://skillsmp.com/zh" ref="nofollow noopener noreferrer">skillsmp.com/zh</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204120006396.png" alt="" loading="lazy"/></p>
<p><strong>MCP Market</strong>：MCP Market 的每日 Skills 榜单，能看到每天最热门的 Skills 排名，帮你发现新趋势。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmcpmarket.com%2Fdaily%2Fskills" target="_blank" title="https://mcpmarket.com/daily/skills" ref="nofollow noopener noreferrer">mcpmarket.com/daily/skill…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204120133997.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">开源合集</h3>
<p><strong>anthropics/skills</strong>：Anthropic 官方 Skills 仓库，包含文档处理（PDF、Word、PPT、Excel）、前端设计、MCP 构建、算法艺术等十几个高质量的 Skills。建议刚开始玩 Skills 的朋友首先安装这个。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/1769307079120-6aaf2999-fee5-4fdb-a5e3-2ba66824b4de-20260204142715111.png" alt="" loading="lazy"/></p>
<p><strong>awesome-claude-skills</strong>：Skills 精选列表，收录了各种类型的 Skills，分类清晰，是目前最全的 Skills 合集之一。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FComposioHQ%2Fawesome-claude-skills" target="_blank" title="https://github.com/ComposioHQ/awesome-claude-skills" ref="nofollow noopener noreferrer">github.com/ComposioHQ/…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204120329382.png" alt="" loading="lazy"/></p>
<p><strong>openai/skills</strong>：OpenAI 官方的 Codex Skills 目录。可以通过 Codex 内置的 <code>$skill-installer</code> 命令一键安装，让 Codex 在特定任务上表现更专业。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fskills" target="_blank" title="https://github.com/openai/skills" ref="nofollow noopener noreferrer">github.com/openai/skil…</a></p>
</blockquote>
<p><strong>vercel-labs/agent-skills</strong>：Vercel 出品的 React/Next.js 最佳实践，包括 React 开发规范、Web 设计指南、组件组合模式等，做前端的同学必装。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel-labs%2Fagent-skills" target="_blank" title="https://github.com/vercel-labs/agent-skills" ref="nofollow noopener noreferrer">github.com/vercel-labs…</a></p>
</blockquote>
<p><strong>expo/skills</strong>：Expo 官方的 React Native 开发 Skills。Expo 是一个基于 React Native 的移动应用开发框架，可以让你用 JavaScript / TypeScript 开发 iOS 和 Android 应用。这个 Skills 包括原生 UI 构建、数据获取、部署、CI/CD 等，做移动端开发的朋友可以装上。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fexpo%2Fskills" target="_blank" title="https://github.com/expo/skills" ref="nofollow noopener noreferrer">github.com/expo/skills</a></p>
</blockquote>
<p><strong>kepano/obsidian-skills</strong>：Obsidian 出品的 Skills 集合。Obsidian 是一款基于本地 Markdown 文件的知识管理和笔记应用，深受程序员和知识创作者喜爱。</p>
<p>这些 Skills 能增强 Obsidian 的功能，让 AI Agent 能更好地管理你的笔记和知识库。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkepano%2Fobsidian-skills" target="_blank" title="https://github.com/kepano/obsidian-skills" ref="nofollow noopener noreferrer">github.com/kepano/obsi…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204125639748.png" alt="" loading="lazy"/></p>
<p><strong>stripe/ai</strong>：Stripe 官方 AI Skills。Stripe 是全球领先的在线支付处理平台，被无数互联网公司用于收款。</p>
<p>这个 Skills 包含金融支付相关的最佳实践，比如优先使用 Checkout Sessions API、动态支付方式配置、订阅计费集成等，做支付功能的朋友可以参考。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fstripe%2Fai" target="_blank" title="https://github.com/stripe/ai" ref="nofollow noopener noreferrer">github.com/stripe/ai</a></p>
</blockquote>
<p><strong>trailofbits/skills</strong>：Trail of Bits 安全公司出品的 Skills，专注安全研究和漏洞检测。内容非常丰富，包含智能合约安全审计、Burp Suite 项目解析、Semgrep 规则创建、YARA 恶意软件检测规则编写、差异化代码审查、常量时间分析、属性测试等 20+ 个安全相关插件，强烈推荐给安全方向的朋友。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftrailofbits%2Fskills" target="_blank" title="https://github.com/trailofbits/skills" ref="nofollow noopener noreferrer">github.com/trailofbits…</a></p>
</blockquote>
<p><strong>Notion Skills</strong>：Notion 官方出品的 Skills，让 AI 能更好地与 Notion 工作区交互。可以帮你自动整理会议记录和待办事项、帮你整理和组织研究资料等，适合重度使用 Notion 的朋友。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.notion.so%2Fnotiondevs%2FNotion-Skills-for-Claude-28da4445d27180c7af1df7d8615723d0" target="_blank" title="https://www.notion.so/notiondevs/Notion-Skills-for-Claude-28da4445d27180c7af1df7d8615723d0" ref="nofollow noopener noreferrer">www.notion.so/notiondevs/…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204143151405.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">Agent Skills 必备推荐</h2>
<h3 data-id="heading-6">项目开发</h3>
<p><strong>superpowers</strong>：一套完整的 AI 编程技能框架和软件开发方法论。它包含十几个可组合的编程技能，比如头脑风暴、编写计划、执行计划、TDD 测试驱动开发、系统性调试、代码审查等。</p>
<p>装了它之后，AI 不会直接开始写代码，而是会先问清楚需求、出设计方案让你确认、制定详细执行计划，最后才分步骤实现。适合开发大型项目、需要高质量代码的场景。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fobra%2Fsuperpowers" target="_blank" title="https://github.com/obra/superpowers" ref="nofollow noopener noreferrer">github.com/obra/superp…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/01-AI%E8%8E%B7%E5%BE%97%E8%B6%85%E8%83%BD%E5%8A%9B%E6%A2%97%E5%9B%BE.jpeg" alt="" loading="lazy"/></p>
<p><strong>planning-with-files</strong>：被 X 上的开发者评为最强 Skill！它借鉴了被 Meta 以 20 亿美元收购的 Manus AI 的核心工作模式：用 Markdown 文件作为 AI 的外部记忆，解决 AI 上下文丢失的问题。适合多步骤任务、研究任务、跨多次对话的项目开发，让 AI 在复杂项目中也能保持清醒不跑偏。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOthmanAdi%2Fplanning-with-files" target="_blank" title="https://github.com/OthmanAdi/planning-with-files" ref="nofollow noopener noreferrer">github.com/OthmanAdi/p…</a></p>
</blockquote>
<p><strong>ui-ux-pro-max</strong>：专业前端设计 Skill，让 AI Agent 具备专业设计师的能力，生成的界面不再是千篇一律的 AI 风格。支持各种主流 AI 编程工具，强烈推荐。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnextlevelbuilder%2Fui-ux-pro-max-skill" target="_blank" title="https://github.com/nextlevelbuilder/ui-ux-pro-max-skill" ref="nofollow noopener noreferrer">github.com/nextlevelbu…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204143423578.png" alt="" loading="lazy"/></p>
<p><strong>vercel-react-best-practices</strong>：Vercel 出品的 React 最佳实践，让 AI 按照 React 官方推荐的模式来写代码，包括组件设计、状态管理、性能优化等规范，避免写出反模式的代码。做 React 项目必装。</p>
<blockquote>
<p>指路：通过 <code>npx skills add vercel-labs/agent-skills</code> 命令安装</p>
</blockquote>
<p><strong>web-design-guidelines</strong>：Web 设计规范 Skill，包含间距、颜色、排版、响应式设计等专业设计规范，让 AI 生成的页面更加美观，而不是千篇一律的 AI 风格。</p>
<blockquote>
<p>指路：通过 <code>npx skills add vercel-labs/agent-skills</code> 命令安装</p>
</blockquote>
<p><strong>frontend-design</strong>：Anthropic 官方的前端设计 Skill，帮你开发独具辨识度的生产级前端界面。</p>
<blockquote>
<p>指路：通过 <code>npx skills add anthropics/skills</code> 安装</p>
</blockquote>
<p><strong>vue-skills</strong>：Vue.js 最佳实践 Skills，尤雨溪团队成员维护。让 AI 按照 Vue 生态的最佳实践来写代码，包括 Vue 3 组合式 API、Vite 构建配置、Vitest 单元测试、Pinia 状态管理、UnoCSS 样式方案等。做 Vue 项目必装。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs-ai%2Fskills" target="_blank" title="https://github.com/vuejs-ai/skills" ref="nofollow noopener noreferrer">github.com/vuejs-ai/sk…</a></p>
</blockquote>
<p><strong>supabase-postgres-best-practices</strong>：Supabase 出品的 PostgreSQL 数据库最佳实践，教 AI Agent 怎么写出高质量的数据库代码，包括查询优化、索引设计等。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsupabase%2Fagent-skills" target="_blank" title="https://github.com/supabase/agent-skills" ref="nofollow noopener noreferrer">github.com/supabase/ag…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204143740866.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">浏览器自动化</h3>
<p><strong>browser-use</strong>：让 AI Agent 能访问和操作网站的工具（不仅是 Skill，也可以独立使用），功能强大，可以用来做自动化测试、数据抓取、网页操作等。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbrowser-use%2Fbrowser-use" target="_blank" title="https://github.com/browser-use/browser-use" ref="nofollow noopener noreferrer">github.com/browser-use…</a></p>
</blockquote>
<p><strong>agent-browser</strong>：Vercel 出品的浏览器自动化 Skill，让 AI Agent 能操作浏览器。比如可以自动填表单、点击按钮、截图、抓取动态渲染的内容等，非常适合做端到端测试、自动化爬虫、网页监控等场景。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel-labs%2Fagent-browser" target="_blank" title="https://github.com/vercel-labs/agent-browser" ref="nofollow noopener noreferrer">github.com/vercel-labs…</a></p>
</blockquote>
<h3 data-id="heading-8">内容创作</h3>
<p><strong>remotion-dev/skills</strong>：Remotion 官方出品的视频动画制作 Skills，能用 Claude Code 一句话生成可编辑的动画视频，几分钟就能做出专业效果，最近特别火。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fremotion-dev%2Fskills" target="_blank" title="https://github.com/remotion-dev/skills" ref="nofollow noopener noreferrer">github.com/remotion-de…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/68747470733a2f2f7075622d36343664383038643963623234306365613533626564633736646433636430632e72322e6465762f66697265736869702d717569636b2e676966.gif" alt="" loading="lazy"/></p>
<p><strong>baoyu-skills</strong>：宝玉老师自用的 Skills 集合，包括公众号文章写作、PPT 制作、封面图生成、小红书配图、漫画生成等，对内容创作者非常有帮助，直接把大佬的创作工作流复制过来用。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJimLiu%2Fbaoyu-skills" target="_blank" title="https://github.com/JimLiu/baoyu-skills" ref="nofollow noopener noreferrer">github.com/JimLiu/baoy…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204144449881.png" alt="小红书配图技能" loading="lazy"/></p>
<p><strong>humanizer</strong>：去除 AI 生成痕迹的 Skill，让 AI 写的文章更像人写的。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fblader%2Fhumanizer" target="_blank" title="https://github.com/blader/humanizer" ref="nofollow noopener noreferrer">github.com/blader/huma…</a></p>
</blockquote>
<p><strong>heygen-com/skills</strong>：HeyGen 官方的 Skills。HeyGen 是一个 AI 数字人视频生成平台，可以用虚拟人物来制作视频。这个 Skills 让 AI 能调用 HeyGen API 生成数字人视频，包括选择虚拟形象、配置语音、生成透明背景视频、视频翻译配音等功能，还支持和 Remotion 集成做程序化视频合成。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fheygen-com%2Fskills" target="_blank" title="https://github.com/heygen-com/skills" ref="nofollow noopener noreferrer">github.com/heygen-com/…</a></p>
</blockquote>
<h3 data-id="heading-9">Skills 管理工具</h3>
<p><strong>find-skills</strong>：Vercel 出品的 Skills 发现工具，帮你快速找到和安装需要的 Skills。支持交互式搜索和关键词搜索，用 <code>npx skills find</code> 命令即可启动。</p>
<blockquote>
<p>指路：通过 <code>npx skills add vercel-labs/skills</code> 安装</p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204144654011.png" alt="" loading="lazy"/></p>
<p><strong>skill-creator</strong>：Anthropic 官方的 Skill 创建工具，教你怎么创建自定义 Skill。会引导你按照最佳实践编写 SKILL.md 文件，包括技能描述、触发条件、执行步骤等。</p>
<blockquote>
<p>指路：通过 <code>npx skills add anthropics/skills</code> 安装</p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/1769307998192-27ac24c2-c732-401d-a19e-ebe07086d73b-20260204144825800.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">网站审计</h3>
<p><strong>seo-audit</strong>：SEO 审计 Skill，帮你分析网站的 SEO 问题并给出优化建议。来自 marketingskills 仓库，该仓库还有 25+ 个营销相关技能，涵盖转化优化、文案撰写、数据分析、增长策略等。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcoreyhaines31%2Fmarketingskills" target="_blank" title="https://github.com/coreyhaines31/marketingskills" ref="nofollow noopener noreferrer">github.com/coreyhaines…</a></p>
</blockquote>
<p><strong>audit-website</strong>：网站安全审计 Skill，基于 squirrelscan 工具，包含 230+ 条审计规则，覆盖 SEO、性能、可访问性、内容和安全等 21 个类别，还能检测 96 种泄露的密钥。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsquirrelscan%2Fskills" target="_blank" title="https://github.com/squirrelscan/skills" ref="nofollow noopener noreferrer">github.com/squirrelsca…</a></p>
</blockquote>
<h2 data-id="heading-11">官方文档</h2>
<p><strong>Anthropic 官方文档</strong>：想深入了解 Agent Skills 的技术细节，看官方文档准没错，包括概念介绍、快速开始、最佳实践、API 集成等。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fen%2Fdocs%2Fagents-and-tools%2Fagent-skills%2Foverview" target="_blank" title="https://docs.anthropic.com/en/docs/agents-and-tools/agent-skills/overview" ref="nofollow noopener noreferrer">docs.anthropic.com/en/docs/age…</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/agent-skills-architecture.png" alt="" loading="lazy"/></p>
<p><strong>Agent Skills 开放标准</strong>：Anthropic 主导的开放标准网站，定义了 Skills 的规范格式，OpenAI、Google、Microsoft 都在用这套标准。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io" target="_blank" title="https://agentskills.io" ref="nofollow noopener noreferrer">agentskills.io</a></p>
</blockquote>
<p><img src="https://pic.yupi.icu/1/image-20260204145025475.png" alt="" loading="lazy"/></p>
<p><strong>Claude Skills 博客</strong>：Anthropic 官方博客，包括 Skills 的介绍和一些相关的资源，想进一步了解 Skills 的同学可以看看。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fblog%2Fskills" target="_blank" title="https://claude.com/blog/skills" ref="nofollow noopener noreferrer">claude.com/blog/skills</a></p>
</blockquote>
<p><strong>Skills API 快速入门</strong>：想通过 API 使用 Skills 的话，看这个文档就好（或者直接把文档甩给 AI 让它帮你对接）。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.claude.com%2Fen%2Fapi%2Fskills-guide" target="_blank" title="https://docs.claude.com/en/api/skills-guide" ref="nofollow noopener noreferrer">docs.claude.com/en/api/skil…</a></p>
</blockquote>
<hr/>
<p>以上就是我整理的 40 多个 Agent Skills 精选资源，如果你觉得有用，记得点个收藏。后续我会持续分享更多实用的 AI 编程干货，感谢关注，也欢迎在评论区分享你发现的宝藏 Skills~</p>
<h2 data-id="heading-12">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a><br/>
📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a><br/>
✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a><br/>
📖 AI 学习指南：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fai-guide" target="_blank" title="https://github.com/liyupi/ai-guide" ref="nofollow noopener noreferrer">鱼皮 AI 导航</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apache Doris 学习文档（面向开发人员）]]></title>    <link>https://juejin.cn/post/7605416964511154203</link>    <guid>https://juejin.cn/post/7605416964511154203</guid>    <pubDate>2026-02-12T06:17:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605416964511154203" data-draft-id="7605535918540161033" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apache Doris 学习文档（面向开发人员）"/> <meta itemprop="keywords" content="大数据,数据库"/> <meta itemprop="datePublished" content="2026-02-12T06:17:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LukeLi"/> <meta itemprop="url" content="https://juejin.cn/user/430664725579725"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apache Doris 学习文档（面向开发人员）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664725579725/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LukeLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:17:24.000Z" title="Thu Feb 12 2026 06:17:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Apache Doris 学习文档（面向开发人员）</h2>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2F4.x%2FgettingStarted%2Fwhat-is-apache-doris" target="_blank" title="https://doris.apache.org/zh-CN/docs/4.x/gettingStarted/what-is-apache-doris" ref="nofollow noopener noreferrer">Doris</a> 是什么？为什么你需要它？</h3>























<table><thead><tr><th><strong>数据库类型</strong></th><th><strong>典型代表</strong></th><th><strong>特点</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td>OLTP（事务型）</td><td>MySQL, PostgreSQL</td><td>强一致性、高并发写、行存</td><td>订单、用户信息等业务系统</td></tr><tr><td>OLAP（分析型）</td><td>Apache Doris, ClickHouse, StarRocks</td><td>高吞吐查询、列存、MPP 架构</td><td>报表、BI、日志分析、用户行为分析</td></tr></tbody></table>
<p>Apache Doris 是一个开源的、高性能、实时的 MPP 分析型数据库，采用列式存储，兼容 MySQL 协议，专为 OLAP（在线分析处理） 场景设计。</p>
<h4 data-id="heading-2">为什么你需要它？</h4>
<p>✅ 快：TB 级数据秒级查询（聚合、多维分析）<br/>
✅ 实时：支持 Kafka/HTTP 秒级写入，数据即时可见<br/>
✅ 简单：无 Hadoop 依赖，部署运维轻量<br/>
✅ 易用：标准 SQL + BI 工具直连（如 Tableau、Superset）<br/>
✅ 省成本：开源免费，高压缩比降低存储开销</p>
<p>🎯 适用场景：实时数仓、日志分析、BI 报表、用户行为分析。<br/>
❌ 不适用：高频点查、强事务、全文检索（这类需求选 MySQL 或 Elasticsearch）。</p>
<hr/>
<h4 data-id="heading-3">Apache Doris 整体架构图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    subgraph "客户端层"
        A[MySQL Client] --&gt;|SQL| B(FE)
        C[JDBC/MyBatis] --&gt;|SQL| B
        D[Stream Load] --&gt;|HTTP| B
        E[Routine Load] --&gt;|Kafka| B
    end

    subgraph "计算与协调层 (FE - Frontend)"
        B --&gt; B1[SQL Parser]
        B --&gt; B2[Planner]
        B --&gt; B3[Scheduler]
        B --&gt; B4[Metadata Manager]
        B4 --&gt;|持久化| B5[(BDBJE&lt;br/&gt;doris-meta/)]
    end

    subgraph "存储与执行层 (BE - Backend)"
        B --&gt; F[BE Node 1]
        B --&gt; G[BE Node 2]
        B --&gt; H[BE Node N]

        F --&gt; F1[Tablet 1]
        F --&gt; F2[Tablet 2]
        F --&gt; F3[Storage Engine]
        F3 --&gt; F4[(Data Files&lt;br/&gt;storage_root_path/)]

        G --&gt; G1[Tablet 3]
        G --&gt; G2[Tablet 4]
        G --&gt; G3[Storage Engine]
        G3 --&gt; G4[(Data Files)]

        H --&gt; H1[...]
        H --&gt; H2[Storage Engine]
        H2 --&gt; H3[(Data Files)]
    end

    subgraph "数据源"
        I[Kafka] --&gt;|Routine Load| B
        J[Local File] --&gt;|Stream Load| B
        K[HDFS/S3] --&gt;|Broker Load| B
    end

    classDef fe fill:#4CAF50,stroke:#388E3C,color:white;
    classDef be fill:#2196F3,stroke:#0D47A1,color:white;
    classDef storage fill:#FFC107,stroke:#FF8F00;
    classDef client fill:#9E9E9E,stroke:#616161,color:white;

    class B,B1,B2,B3,B4,B5 fe;
    class F,G,H,F3,G3,H2 be;
    class F4,G4,H3 storage;
    class A,C,D,E,I,J,K client;

</code></pre>
<h5 data-id="heading-4">只需记住两个角色：</h5>























<table><thead><tr><th><strong>组件</strong></th><th><strong>作用</strong></th><th><strong>类比理解</strong></th><th><strong>是否需要你关心？</strong></th></tr></thead><tbody><tr><td>FE (Frontend)</td><td>接收 SQL、管理元数据、调度查询</td><td>≈ MySQL Server 层</td><td>❌（部署好就不用管）</td></tr><tr><td>BE (Backend)</td><td>真正存数据 + 执行计算</td><td>≈ InnoDB + 分布式计算引擎</td><td>✅（扩容加 BE 节点即可）</td></tr></tbody></table>
<p>💡 关键特点：</p>
<ul>
<li>
<p>FE 无状态：可多节点部署，自动选主</p>
</li>
<li>
<p>BE 自动均衡：加机器后数据自动分片</p>
</li>
<li>
<p>你只用连 FE：像连 MySQL 一样简单</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-5">Doris 核心能力（开发者最关心的）</h3>
<h4 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2F4.x%2Fdata-operate%2Fimport%2Fload-manual" target="_blank" title="https://doris.apache.org/zh-CN/docs/4.x/data-operate/import/load-manual" ref="nofollow noopener noreferrer">常用写入方式</a></h4>
<h5 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2F4.x%2Fdata-operate%2Fimport%2Fimport-way%2Fbroker-load-manual%3F_highlight%3Dbroker%26_highlight%3Dload" target="_blank" title="https://doris.apache.org/zh-CN/docs/4.x/data-operate/import/import-way/broker-load-manual?_highlight=broker&amp;_highlight=load" ref="nofollow noopener noreferrer"><strong>Broker Load</strong></a>（推荐用于大文件批量导入）</h5>
<ul>
<li>
<p>原理：通过 Doris 内置的 Broker 进程（如 HDFS、S3、OSS、BOS 等）从外部存储系统并行拉取数据。</p>
</li>
<li>
<p>支持格式：CSV、Parquet、ORC</p>
</li>
<li>
<p>特点：</p>
<ul>
<li>
<p>异步导入，适合 GB~TB 级大文件</p>
</li>
<li>
<p>自动分片、并行处理</p>
</li>
<li>
<p>支持断点续传（部分失败可重试）</p>
</li>
</ul>
</li>
<li>
<p>适用场景：</p>
<ul>
<li>
<p>从 HDFS/S3 导入历史数据</p>
</li>
<li>
<p>每天一次的 T+1 批量同步</p>
</li>
</ul>
</li>
<li>
<p>示例：</p>
</li>
</ul>
<pre><code class="hljs language-sql" lang="sql">LOAD LABEL broker_load_2022_04_01
(
    DATA INFILE("s3://your_bucket_name/brokerload_example.csv")
    <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">TABLE</span> test_brokerload
    COLUMNS TERMINATED <span class="hljs-keyword">BY</span> ","
    FORMAT <span class="hljs-keyword">AS</span> "CSV"
    (user_id, name, age)
)
<span class="hljs-keyword">WITH</span> S3
(
    "provider" <span class="hljs-operator">=</span> "S3",
    "AWS_ENDPOINT" <span class="hljs-operator">=</span> "s3.us-west-2.amazonaws.com",
    "AWS_ACCESS_KEY" <span class="hljs-operator">=</span> "&lt;your-ak&gt;",
    "AWS_SECRET_KEY"<span class="hljs-operator">=</span>"&lt;your-sk&gt;",
    "AWS_REGION" <span class="hljs-operator">=</span> "us-west-2",
    "compress_type" <span class="hljs-operator">=</span> "PLAIN"
)
PROPERTIES
(
    "timeout" <span class="hljs-operator">=</span> "3600"
);

</code></pre>
<hr/>
<h5 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2F4.x%2Fdata-operate%2Fimport%2Fimport-way%2Fstream-load-manual" target="_blank" title="https://doris.apache.org/zh-CN/docs/4.x/data-operate/import/import-way/stream-load-manual" ref="nofollow noopener noreferrer"><strong>Stream Load</strong></a>（推荐用于实时/小批量 HTTP 推送）</h5>
<ul>
<li>
<p>原理：通过 HTTP 协议将本地文件或内存数据直接推送到 Doris。</p>
</li>
<li>
<p>支持格式：CSV、JSON（支持多行 JSON）</p>
</li>
<li>
<p>特点：</p>
<ul>
<li>
<p>同步返回结果（成功/失败）</p>
</li>
<li>
<p>低延迟（秒级可见）</p>
</li>
<li>
<p>支持 实时流式写入</p>
</li>
<li>
<p>可通过 Nginx 负载均衡到多个 BE 节点</p>
</li>
</ul>
</li>
<li>
<p>适用场景：</p>
<ul>
<li>
<p>日志采集（Filebeat → Stream Load）</p>
</li>
<li>
<p>Flink/Spark 实时写入</p>
</li>
<li>
<p>应用程序直接推送数据</p>
</li>
</ul>
</li>
<li>
<p>示例（curl）：</p>
</li>
</ul>
<pre><code class="hljs language-http" lang="http">curl --location-trusted -u &lt;doris_user&gt;:&lt;doris_password&gt; \
    -H "label:124" \
    -H "Expect:100-continue" \
    -H "format:json" -H "strip_outer_array:true" \
    -H "jsonpaths:[\"$.userid\", \"$.username\", \"$.userage\"]" \
    -H "columns:user_id,name,age" \
    -T streamload_example.json \
    -XPUT http://&lt;fe_ip&gt;:&lt;fe_http_port&gt;/api/testdb/test_streamload/_stream_load

</code></pre>
<h5 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2F4.x%2Fdata-operate%2Fimport%2Fimport-way%2Froutine-load-manual" target="_blank" title="https://doris.apache.org/zh-CN/docs/4.x/data-operate/import/import-way/routine-load-manual" ref="nofollow noopener noreferrer"><strong>Routine Load</strong></a>（推荐用于 Kafka 实时持续消费）</h5>
<ul>
<li>
<p>原理：Doris 自动创建后台任务，持续从 Kafka 消费数据并导入。</p>
</li>
<li>
<p>支持格式：CSV、JSON</p>
</li>
<li>
<p>特点：</p>
<ul>
<li>
<p>自动容错：Kafka offset 自动管理，失败自动重试</p>
</li>
<li>
<p>Exactly-Once 语义（通过 label 去重）</p>
</li>
<li>
<p>支持 Kafka 多分区并行消费</p>
</li>
</ul>
</li>
<li>
<p>适用场景：</p>
<ul>
<li>
<p>实时数仓（Kafka → Doris）</p>
</li>
<li>
<p>用户行为日志、交易流水实时入库</p>
</li>
</ul>
</li>
<li>
<p>示例：</p>
</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SHOW</span> ROUTINE LOAD <span class="hljs-keyword">FOR</span> tbl_name;

<span class="hljs-keyword">CREATE</span> ROUTINE LOAD example_db.kafka_load <span class="hljs-keyword">ON</span> tbl1
PROPERTIES(
    "desired_concurrent_number"<span class="hljs-operator">=</span>"3",
    "max_batch_interval" <span class="hljs-operator">=</span> "20",
    "max_batch_rows" <span class="hljs-operator">=</span> "200000"
)
<span class="hljs-keyword">FROM</span> KAFKA(
    "kafka_broker_list" <span class="hljs-operator">=</span> "host:9092",
    "kafka_topic" <span class="hljs-operator">=</span> "topic1",
    "property.kafka_default_offsets" <span class="hljs-operator">=</span> "OFFSET_BEGINNING"
);

</code></pre>
<hr/>
<h5 data-id="heading-10"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2F4.x%2Fdata-operate%2Fimport%2Fimport-way%2Finsert-into-values-manual" target="_blank" title="https://doris.apache.org/zh-CN/docs/4.x/data-operate/import/import-way/insert-into-values-manual" ref="nofollow noopener noreferrer"><strong>Insert Into</strong></a>（适合小量数据或 ETL 中转）</h5>
<ul>
<li>
<p>原理：类似 MySQL 的 <code>INSERT INTO ... SELECT ...</code></p>
</li>
<li>
<p>特点：</p>
<ul>
<li>
<p>同步执行，适合 &lt; 100 万行 的小数据量</p>
</li>
<li>
<p>可用于 Doris 内部表间数据转换（如 DWD → DWS）</p>
</li>
</ul>
</li>
<li>
<p>限制：</p>
<ul>
<li>
<p>不适合高频写入（会触发小文件问题）</p>
</li>
<li>
<p>性能远低于 Stream/Broker Load</p>
</li>
</ul>
</li>
<li>
<p>示例：</p>
</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> tbl_agg
<span class="hljs-keyword">SELECT</span> user_id, <span class="hljs-built_in">sum</span>(pv) <span class="hljs-keyword">FROM</span> tbl_detail <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id;
</code></pre>
<h5 data-id="heading-11">各导入方式对比总结</h5>








































<table><thead><tr><th><strong>导入方式</strong></th><th><strong>实时性</strong></th><th><strong>吞吐量</strong></th><th><strong>数据源</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td>Stream Load</td><td>秒级</td><td>高</td><td>HTTP（本地/程序）</td><td>实时日志、Flink 写入</td></tr><tr><td>Routine Load</td><td>秒级</td><td>高</td><td>Kafka</td><td>持续实时消费</td></tr><tr><td>Broker Load</td><td>分钟级</td><td>极高</td><td>HDFS/S3/OSS 等</td><td>T+1 批量导入、大文件</td></tr><tr><td>Insert Into</td><td>秒级</td><td>低</td><td>Doris 内部表</td><td>小量数据、ETL 中转</td></tr></tbody></table>
<h5 data-id="heading-12">最佳实践建议</h5>
<ol>
<li>
<p>实时场景 → 优先选 Routine Load（Kafka） 或 Stream Load（Flink/日志）</p>
</li>
<li>
<p>批量离线导入 → 用 Broker Load（HDFS/S3）</p>
</li>
<li>
<p>避免高频 Insert Into → 会导致小文件过多，影响查询性能</p>
</li>
<li>
<p>开启 Routine Load 监控 → 通过 <code>SHOW ROUTINE LOAD</code> 查看消费状态</p>
</li>
<li>
<p>合理设置 Label → 避免重复导入（Doris 通过 label 保证幂等）</p>
</li>
</ol>

































<table><thead><tr><th><strong>方式</strong></th><th><strong>适用场景</strong></th><th><strong>吞吐</strong></th><th><strong>延迟</strong></th><th><strong>是否推荐生产</strong></th></tr></thead><tbody><tr><td>JDBC INSERT</td><td>小量测试、调试</td><td>低（几千/秒）</td><td>高</td><td>❌（会出多版本问题！）</td></tr><tr><td>Stream Load (HTTP)</td><td>Kafka 消费、日志导入</td><td>高（10w+/秒）</td><td>秒级</td><td>✅ 强烈推荐</td></tr><tr><td>Routine Load</td><td>自动消费 Kafka</td><td>高</td><td>秒级</td><td>✅（适合简单场景）</td></tr></tbody></table>
<p>📌 血泪教训：<br/>
生产环境禁止直接用 JDBC INSERT 写 Doris！<br/>
原因：每次 INSERT 生成新版本 → 多版本堆积 → 查询结果混乱</p>
<hr/>
<h4 data-id="heading-13">表模型：选对模型，性能翻倍</h4>





























<table><thead><tr><th><strong>模型</strong></th><th><strong>适用场景</strong></th><th><strong>特点</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td>Duplicate Key</td><td>日志、事件流</td><td>保留所有明细，不聚合</td><td>用户点击日志</td></tr><tr><td>Unique Key</td><td>需要更新的明细表</td><td>主键去重，最新覆盖</td><td>用户画像表</td></tr><tr><td>Aggregate Key</td><td>预聚合指标</td><td>自动 SUM/COUNT/MAX</td><td>PV/UV 汇总表</td></tr></tbody></table>
<p>✅ 推荐：</p>
<ul>
<li>
<p>日志分析 → <code>Duplicate Key</code></p>
</li>
<li>
<p>用户行为宽表 → <code>Unique Key</code></p>
</li>
<li>
<p>报表指标 → <code>Aggregate Key</code></p>
</li>
</ul>
<hr/>
<h4 data-id="heading-14">兼容性：零学习成本</h4>
<ul>
<li>
<p>协议兼容：直接用 <code>mysql-connector-java</code></p>
</li>
<li>
<p>SQL 兼容：支持 JOIN、子查询、窗口函数</p>
</li>
<li>
<p>工具兼容：Navicat、DBeaver、DataGrip 直接连</p>
</li>
</ul>
<p>🎯 你不需要学新语法，就像操作 MySQL 一样！</p>
<hr/>
<h3 data-id="heading-15">Spring Boot 整合实战（避坑版）</h3>
<h4 data-id="heading-16">依赖配置</h4>
<pre><code class="hljs language-xml" lang="xml">xml<span class="hljs-comment">&lt;!-- 核心：用 MySQL 驱动连 Doris --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 连接池（推荐 Druid） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.16<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- MyBatis --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Stream Load 需要 HTTP 客户端 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>httpclient<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-17">多数据源配置（主库 + Doris）</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-comment"># 主业务库（MySQL）</span>
    <span class="hljs-attr">primary:</span>
      <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://mysql:3306/order_db</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">xxx</span>
    
    <span class="hljs-comment"># Doris 分析库</span>
    <span class="hljs-attr">doris:</span>
      <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://doris-fe:9030/analysis_db</span>  <span class="hljs-comment"># 注意：端口是 9030！</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">""</span>  <span class="hljs-comment"># 默认无密码</span>
</code></pre>
<h4 data-id="heading-18">Java 配置（手动控制，避免自动配置冲突）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 主启动类：排除 MyBatis 自动配置</span>
<span class="hljs-meta">@SpringBootApplication(exclude = MybatisAutoConfiguration.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<h5 data-id="heading-19">主数据源（MySQL）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@MapperScan(basePackages = "com.example.mapper.mysql", 
           sqlSessionTemplateRef = "mysqlSqlSessionTemplate")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrimaryDataSourceConfig</span> {

    <span class="hljs-meta">@Bean</span> 
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-meta">@ConfigurationProperties("spring.datasource.primary")</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">primaryDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> DruidDataSourceBuilder.create().build();
    }

    <span class="hljs-meta">@Bean</span> 
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">mysqlSqlSessionFactory</span><span class="hljs-params">(DataSource ds)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">SqlSessionFactoryBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBean</span>();
        bean.setDataSource(ds);
        <span class="hljs-keyword">return</span> bean.getObject();
    }

    <span class="hljs-meta">@Bean</span> 
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-keyword">public</span> SqlSessionTemplate <span class="hljs-title function_">mysqlSqlSessionTemplate</span><span class="hljs-params">(SqlSessionFactory sf)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionTemplate</span>(sf);
    }
}
</code></pre>
<h5 data-id="heading-20">Doris 数据源</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@MapperScan(basePackages = "com.example.mapper.doris",
           sqlSessionTemplateRef = "dorisSqlSessionTemplate")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DorisDataSourceConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@ConfigurationProperties("spring.datasource.doris")</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dorisDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> DruidDataSourceBuilder.create().build();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">dorisSqlSessionFactory</span><span class="hljs-params">(DataSource ds)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">SqlSessionFactoryBean</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBean</span>();
        bean.setDataSource(ds);
        <span class="hljs-keyword">return</span> bean.getObject();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> SqlSessionTemplate <span class="hljs-title function_">dorisSqlSessionTemplate</span><span class="hljs-params">(SqlSessionFactory sf)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionTemplate</span>(sf);
    }
}
</code></pre>
<p>✅ 关键规则：</p>
<ol>
<li>
<p>两个 <code>@MapperScan</code> 包路径必须不同</p>
</li>
<li>
<p>只有主数据源加 <code>@Primary</code></p>
</li>
<li>
<p>方法名与 <code>@Qualifier</code> 保持一致</p>
</li>
</ol>
<h3 data-id="heading-21">最佳实践清单（直接抄作业）</h3>
<h4 data-id="heading-22">表设计</h4>
<ul>
<li>
<p>分区：按天/月分区（<code>PARTITION BY RANGE(event_date)</code>）</p>
</li>
<li>
<p>分桶：按高基数列（如 <code>user_id</code>）分桶，桶数 = BE 节点数 × 10</p>
</li>
<li>
<p>模型选择：</p>
<ul>
<li>
<p>日志 → <code>Duplicate Key</code></p>
</li>
<li>
<p>宽表 → <code>Unique Key</code></p>
</li>
<li>
<p>指标 → <code>Aggregate Key</code></p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-23">写入规范</h4>





















<table><thead><tr><th><strong>场景</strong></th><th><strong>推荐方式</strong></th></tr></thead><tbody><tr><td>Kafka 消费</td><td>Stream Load（批量）</td></tr><tr><td>文件导入</td><td>Broker Load</td></tr><tr><td>调试/小量</td><td>JDBC（仅限测试环境）</td></tr></tbody></table>
<h4 data-id="heading-24">查询优化</h4>
<ul>
<li>
<p>避免 <code>SELECT *</code> → 只查需要的列</p>
</li>
<li>
<p>大表 JOIN 小表 → 小表用 <code>BROADCAST</code> Hint</p>
</li>
<li>
<p>时间范围必加 → 利用分区裁剪</p>
</li>
</ul>
<h4 data-id="heading-25">监控告警</h4>
<ul>
<li>
<p>关键指标：</p>
<ul>
<li>
<p>Tablet Version Count &gt; 100 → 告警</p>
</li>
<li>
<p>Stream Load 失败率 &gt; 1% → 告警</p>
</li>
<li>
<p>查询 P99 &gt; 5s → 优化</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-26">总结：Doris 使用口诀</h3>
<p>“一兼容、二模型、三写入、四分片”</p>

























<table><thead><tr><th><strong>步骤</strong></th><th><strong>要点</strong></th></tr></thead><tbody><tr><td>一兼容</td><td>用 MySQL 驱动直连，SQL 零学习成本</td></tr><tr><td>二模型</td><td>Duplicate（日志）、Unique（宽表）、Aggregate（指标）</td></tr><tr><td>三写入</td><td>生产只用 Stream Load，禁用 JDBC INSERT</td></tr><tr><td>四分片</td><td>按时间分区 + 按用户分桶，性能翻倍</td></tr></tbody></table>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue-esign 用途及使用教程]]></title>    <link>https://juejin.cn/post/7605547012050305065</link>    <guid>https://juejin.cn/post/7605547012050305065</guid>    <pubDate>2026-02-12T06:06:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605547012050305065" data-draft-id="7605419006683168810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue-esign 用途及使用教程"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-12T06:06:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青屿ovo"/> <meta itemprop="url" content="https://juejin.cn/user/2080706144515166"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue-esign 用途及使用教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2080706144515166/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青屿ovo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:06:31.000Z" title="Thu Feb 12 2026 06:06:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vue-esign 用途及使用教程</h2>
<h3 data-id="heading-1">一、✍️ vue-esign 核心用途</h3>
<p><code>vue-esign</code> 是 <strong>Vue项目专属轻量级电子签名插件</strong>，不用依赖后端，纯前端就能实现手写签名、导出保存，体积小、易接入，解决前端手写签名的核心需求。</p>
<h4 data-id="heading-2">📌 常见使用场景（手绘重点标注）</h4>
<ul>
<li>
<p>📋 办公场景：电子合同签署、审批流程手写确认、报销单/表单签名（高频使用！）</p>
</li>
<li>
<p>📝 教育场景：在线作业手写答题、试卷批注、课堂笔记手绘、学生签名确认</p>
</li>
<li>
<p>✨ 通用场景：用户手写昵称、留言板手绘、实名认证手写、小程序签名</p>
</li>
</ul>
<h4 data-id="heading-3">🌟 核心优点（手绘小亮点）</h4>
<ul>
<li>
<p>轻量无依赖，接入成本极低，不用额外装其他插件</p>
</li>
<li>
<p>兼容 Vue2、Vue3 双版本，适配绝大多数Vue项目</p>
</li>
<li>
<p>可自定义：笔迹粗细、笔迹颜色、画板背景（纯色/图片都可）</p>
</li>
<li>
<p>签名可导出为base64格式，方便传给后端保存或本地预览</p>
</li>
</ul>
<h3 data-id="heading-4">二、📝 手把手使用教程（新手友好·一步一标）</h3>
<h4 data-id="heading-5">⚠️ 前置小提醒</h4>
<p>✅ Vue3 项目 → 安装 <code>vue-esign@2.x</code> 版本（推荐）</p>
<p>✅ Vue2 项目 → 安装 <code>vue-esign@1.x</code> 版本（别装错哦！）</p>
<p>✅ 无需额外依赖，安装完成直接使用，不用配置复杂环境</p>
<h4 data-id="heading-6">步骤1：安装依赖 📦（复制命令直接执行）</h4>
<p>打开项目终端，根据自己的Vue版本，粘贴对应命令，回车安装即可：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Vue3 项目（推荐，适配最新Vue版本）</span>
npm install vue-esign --save

<span class="hljs-comment"># Vue2 项目（指定1.x版本，避免兼容问题）</span>
npm install vue-esign@1.0.10 --save
</code></pre>
<h4 data-id="heading-7">步骤2：引入插件 ✨（两种方式，选一种就好）</h4>
<h5 data-id="heading-8">方式1：全局引入（项目通用，推荐！）</h5>
<p>在main.js/ main.ts中引入，全局注册后，所有组件都能直接使用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue3 项目（main.js / main.ts）</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> vueEsign <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-esign'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
app.<span class="hljs-title function_">use</span>(vueEsign) <span class="hljs-comment">// 全局注册签名组件</span>
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue2 项目（main.js）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> vueEsign <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-esign'</span>

<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(vueEsign) <span class="hljs-comment">// 全局注册签名组件</span>
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">el</span>: <span class="hljs-string">'#app'</span>,
  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-params">h</span> =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">App</span>)
})
</code></pre>
<h5 data-id="heading-9">方式2：局部引入（仅单个组件使用，节省资源）</h5>
<p>如果只有一个组件需要用签名，直接在该组件内引入即可：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&amp;gt;
  &lt;!-- 签名组件，直接使用 --&gt;
  &lt;vue-esign ref="esign" :width="800" :height="400" /&gt;
&lt;/template&gt;

&lt;script setup&gt;
// Vue3 局部引入
import { ref } from 'vue'
import vueEsign from 'vue-esign'

const esign = ref(null) // 获取签名组件实例（必须！）
&amp;lt;/script&amp;gt;

&lt;!-- Vue2 局部引入 --&gt;
&lt;script&gt;
import vueEsign from 'vue-esign'
export default {
  components: {
    vueEsign // 局部注册组件
  },
  data() {
    return {
      esign: null // 获取签名组件实例
    }
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-10">步骤3：基础使用示例 ✍️（复制即用，新手必看）</h4>
<p>以下是Vue3完整可运行示例，包含「签名画板+清空+保存+预览」，粘贴到组件中就能直接测试：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="esign-container" style="padding: 20px;"&gt;
    &lt;!-- 签名画板（核心组件） --&gt;
    &lt;vue-esign
      ref="esign"
      :width="800"       &lt;!-- 画板宽度（px），可自定义 --&gt;
      :height="400"      &lt;!-- 画板高度（px），可自定义 --&gt;
      :lineWidth="6"     &lt;!-- 笔迹宽度，越大数据越粗 --&gt;
      :lineColor="#000"  &lt;!-- 笔迹颜色，支持十六进制（如#ff6600） --&gt;
      :bgColor="#f5f5f5" &lt;!-- 画板背景色，浅灰色更显笔迹 --&gt;
      style="border: 1px solid #ddd; border-radius: 8px;"
    /&gt;

    &lt;!-- 操作按钮（清空+保存） --&gt;
    &lt;div style="margin-top: 20px;"&gt;
      &lt;button @click="handleReset" style="margin-right: 10px; padding: 8px 16px; cursor: pointer;"&gt;🗑️ 清空签名&lt;/button&gt;
      &lt;button @click="handleSave" style="padding: 8px 16px; background: #409eff; color: #fff; border: none; border-radius: 4px; cursor: pointer;"&gt;💾 保存签名&lt;/button&gt;
    &lt;/div&gt;

    &lt;!-- 签名预览（保存后显示） --&gt;
    &lt;div v-if="signImg" style="margin-top: 20px;"&gt;
      &lt;h4&gt;📸 签名预览：&lt;/h4&gt;
      &lt;img :src="signImg" alt="签名图片" style="max-width: 800px; border: 1px solid #eee;"&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

// 签名组件实例（必须通过ref获取，才能调用内置方法）
const esign = ref(null)
// 保存的签名图片（base64格式，可用于预览、上传）
const signImg = ref('')

// 清空签名（调用插件内置reset方法）
const handleReset = () =&gt; {
  esign.value.reset() // 清空画板
  signImg.value = '' // 清空预览图
}

// 保存签名（转为base64格式）
const handleSave = async () =&gt; {
  try {
    // 调用插件内置generate方法，生成base64图片
    const base64 = await esign.value.generate()
    if (!base64) {
      alert('✍️ 请先完成签名再保存哦！')
      return
    }
    signImg.value = base64 // 显示预览图
    // 后续可将base64传给后端保存，或转为文件上传
    console.log('签名base64：', base64)
  } catch (error) {
    console.error('保存签名失败：', error)
    alert('保存签名失败，请重试！')
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-11">步骤4：自定义配置项 ⚙️（按需调整，手绘表格）</h4>
<p>根据项目需求，自定义画板样式，所有配置项整理如下（直接复制使用）：</p>





















































<table><thead><tr><th>配置项</th><th>类型</th><th>默认值</th><th>手绘说明（重点）</th></tr></thead><tbody><tr><td>width</td><td>Number</td><td>800</td><td>画板宽度（单位px，不可写百分比）</td></tr><tr><td>height</td><td>Number</td><td>400</td><td>画板高度（单位px，按需调整）</td></tr><tr><td>lineWidth</td><td>Number</td><td>4</td><td>笔迹宽度，数值越大越粗（推荐5-8）</td></tr><tr><td>lineColor</td><td>String</td><td>#000000</td><td>笔迹颜色，支持十六进制（如#ff0000红色）</td></tr><tr><td>bgColor</td><td>String</td><td>#ffffff</td><td>画板背景色，纯色即可（推荐#f5f5f5浅灰）</td></tr><tr><td>bgImg</td><td>String</td><td>''</td><td>画板背景图片（url地址，注意跨域问题）</td></tr><tr><td>disabled</td><td>Boolean</td><td>false</td><td>是否禁用签名（true=禁用，false=可签名）</td></tr></tbody></table>
<h5 data-id="heading-12">自定义示例（带背景图的签名板）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;vue-esign
  ref="esign"
  :width="800"
  :height="400"
  :lineWidth="8"       &lt;!-- 粗笔迹 --&gt;
  :lineColor="#ff6600" &lt;!-- 橙色笔迹，更醒目 --&gt;
  bgImg="https://xxx.com/sign-bg.png" &lt;!-- 自定义背景图URL --&gt;
/&gt;
</code></pre>
<h4 data-id="heading-13">步骤5：常见问题 &amp; 注意事项 ⚠️（手绘避坑指南）</h4>
<ul>
<li>
<p>📱 移动端适配：画板宽度别写固定值，用屏幕宽度计算，避免溢出<code>// Vue3 适配移动端（获取屏幕宽度，减去边距） const width = ref(document.documentElement.clientWidth - 40)</code></p>
</li>
<li>
<p>📦 base64体积过大：生成的签名base64可能偏长，可安装<code>image-conversion</code>库压缩后再上传后端
<code>npm install image-conversion --save</code></p>
</li>
<li>
<p>✍️ 签名为空提示：调用generate()时，如果没签名，会返回false，需先判断再保存（示例中已包含）</p>
</li>
<li>
<p>🌐 跨域问题：bgImg（背景图）需确保支持跨域，否则会报错，优先用本地图片</p>
</li>
<li>
<p>🔍 版本兼容：Vue2和Vue3版本不能混装，装错会导致组件无法显示，严格按照步骤1安装</p>
</li>
</ul>
<h3 data-id="heading-14">三、📌 核心方法速查（手绘小卡片）</h3>
<p>插件只有2个核心方法，记牢就能满足99%的需求，不用记复杂语法：</p>




















<table><thead><tr><th>方法名</th><th>手绘说明</th><th>使用方式（必记）</th></tr></thead><tbody><tr><td>reset()</td><td>清空当前签名，重置画板</td><td>esign.value.reset()</td></tr><tr><td>generate()</td><td>生成签名base64图片（异步）</td><td>await esign.value.generate()</td></tr></tbody></table>
<h3 data-id="heading-15">四、💾 MD文档保存方法（手绘步骤）</h3>
<p>复制本文档全部内容，按照以下步骤保存，即可下载使用：</p>
<ol>
<li>
<p>新建一个文本文档（.txt），打开后粘贴全部内容</p>
</li>
<li>
<p>重命名文件，将后缀从「.txt」改为「.md」（例：vue-esign手绘笔记.md）</p>
</li>
<li>
<p>双击文件，用Markdown编辑器（Typora、VS Code等）打开，即可查看/编辑</p>
</li>
</ol>
<h3 data-id="heading-16">五、✍️ 笔记总结（手绘重点）</h3>
<ol>
<li>
<p>vue-esign 是Vue专属轻量级电子签名插件，纯前端实现，无依赖、易接入；</p>
</li>
<li>
<p>核心流程：安装依赖 → 全局/局部引入 → 配置画板 → 调用方法（保存/清空）；</p>
</li>
<li>
<p>关键注意：版本别装错、移动端适配、签名为空判断，避开这3个坑就能顺利使用。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Javascript 闭包与高阶函数]]></title>    <link>https://juejin.cn/post/7605422894052573199</link>    <guid>https://juejin.cn/post/7605422894052573199</guid>    <pubDate>2026-02-12T06:13:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605422894052573199" data-draft-id="7605494530016165928" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Javascript 闭包与高阶函数"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-12T06:13:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Oscarzhang"/> <meta itemprop="url" content="https://juejin.cn/user/4286337742803811"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Javascript 闭包与高阶函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4286337742803811/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Oscarzhang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:13:02.000Z" title="Thu Feb 12 2026 06:13:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、闭包（Closure）</h2>
<h3 data-id="heading-1">1.什么是闭包？</h3>
<p>闭包是指函数能够记住并访问其词法作用域，即使函数在其词法作用域之外执行。简单说，就是内部函数可以访问外部函数的变量。</p>
<h3 data-id="heading-2">2.理解作用域</h3>
<p>JavaScript 是 <strong>词法作用域（Lexical Scope）</strong> ：</p>
<p>变量的作用域在<strong>定义时决定</strong>，而不是在调用时决定。</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">outer</span>() {
  let <span class="hljs-selector-tag">a</span> = <span class="hljs-number">10</span>;

  function <span class="hljs-built_in">inner</span>() {
    console<span class="hljs-selector-class">.log</span>(a);
  }

  <span class="hljs-built_in">inner</span>();
}

<span class="hljs-built_in">outer</span>(); <span class="hljs-comment">// 10</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><code>inner</code> 能访问 <code>outer</code> 里的 <code>a</code>，因为它定义在 <code>outer</code> 里面。</p>
<p><strong>闭包的基本示例</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>; <span class="hljs-comment">// 私有变量</span>
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
    count++;
    <span class="hljs-keyword">return</span> count;
  };
}

<span class="hljs-keyword">const</span> counter1 = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter1</span>()); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter1</span>()); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter1</span>()); <span class="hljs-comment">// 3</span>

<span class="hljs-keyword">const</span> counter2 = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">counter2</span>()); <span class="hljs-comment">// 1 (独立的计数器)</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>打印结果</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1ad047596e646a49c466d8aee384a55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3NjYXJ6aGFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482519&amp;x-signature=qO4FtoyneFRZkoM0gxgyXtvYfB0%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<h4 data-id="heading-3">发生了什么？</h4>
<p>当 createCounter() 执行结束后：</p>
<ul>
<li>按理说 <code>count</code> 应该被销毁</li>
<li>但是 <code>inner</code> 还在引用它</li>
<li>JS 引擎不会回收这个变量</li>
</ul>
<p>👉 因为 <strong>inner 形成了闭包</strong></p>
<h3 data-id="heading-4">3. 闭包的执行过程（原理）</h3>
<p>当函数创建时，会：</p>
<ol>
<li>创建一个执行上下文</li>
<li>生成一个词法环境</li>
<li>内部函数会保存对这个词法环境的引用</li>
</ol>
<p>只要内部函数还存在，这个环境就不会被垃圾回收。</p>
<h3 data-id="heading-5">4. 闭包的关键特征</h3>
<ul>
<li><strong>函数嵌套函数</strong>：通常是一个外层函数包裹一个内层函数。</li>
<li><strong>内层函数引用外层函数的变量</strong>：这是形成闭包的必要条件。</li>
<li><strong>外层函数将内层函数返回（或传递出去）</strong> ：使得内层函数可以在其原始作用域之外被调用。</li>
</ul>
<h3 data-id="heading-6">5. 闭包的常见用途</h3>
<h4 data-id="heading-7">1.数据私有化（封装）</h4>
<pre><code class="hljs language-ini" lang="ini">function createUser() {
  let <span class="hljs-attr">password</span> = <span class="hljs-string">"123456"</span><span class="hljs-comment">;</span>

  return {
    checkPassword(input) {
      return <span class="hljs-attr">input</span> === password<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
}

const <span class="hljs-attr">user</span> = createUser()<span class="hljs-comment">;</span>
console.log(user.checkPassword("123456"))<span class="hljs-comment">; // true</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>打印结果：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8364280cfd74f2299f00b2e0e9b5c37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3NjYXJ6aGFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482519&amp;x-signature=syge5E9lUVFSLScrbSDyL2G0ESI%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>外部访问不到 <strong>password</strong></p>
<h4 data-id="heading-8">2. 防抖/节流</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> timer;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-built_in">clearTimeout</span>(timer);
    timer = <span class="hljs-built_in">setTimeout</span>(fn, delay);
  };
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>timer就是被闭包保存的</p>
<h4 data-id="heading-9">3.循环中的经典坑（经典面试题)</h4>
<pre><code class="hljs language-css" lang="css">for (<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span> = <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; <span class="hljs-number">3</span>; <span class="hljs-selector-tag">i</span>++) {
  setTimeout(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">i</span>);
  }, <span class="hljs-number">1000</span>);
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>打印结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b7cf29895b140d8b9efc4e783d063fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3NjYXJ6aGFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482519&amp;x-signature=tDymMf451VHP7I48EAgSwuuoJhE%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>原因：<br/>
<code>var</code> 声明的 <code>i</code> 是函数作用域（或全局作用域），3个定时器回调共享同一个 <code>i</code>。当循环结束时，<code>i</code> 已经是 3，所以每个回调都打印 3。</p>
<p><strong><code>解决方案：</code></strong></p>
<pre><code class="hljs language-ini" lang="ini">for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 3; i++) {</span>
  setTimeout(() =&gt; {
    console.log(i)<span class="hljs-comment">;</span>
  }, 1000)<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>使用let：</strong></p>
<p><code>let</code> 声明的变量是块级作用域，每次循环都会创建一个新的 <code>i</code> 绑定，效果等同于用闭包保存了状态。</p>
<p>或者使用</p>
<pre><code class="hljs language-css" lang="css">for (<span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">i</span> = <span class="hljs-number">0</span>; <span class="hljs-selector-tag">i</span> &lt; <span class="hljs-number">3</span>; <span class="hljs-selector-tag">i</span>++) {
  (function (<span class="hljs-selector-tag">i</span>) {
    setTimeout(() =&gt; {
      console<span class="hljs-selector-class">.log</span>(<span class="hljs-selector-tag">i</span>);
    }, <span class="hljs-number">1000</span>);
  })(<span class="hljs-selector-tag">i</span>);
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>打印结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8752b928090a4055818ee841b4bcaad0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3NjYXJ6aGFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482519&amp;x-signature=aKTb5AjrjE3pLZ%2BswyhaLs8oQmQ%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>这个就是<strong>利用闭包锁住变量</strong></p>
<h3 data-id="heading-10"><strong>6.闭包的优缺点</strong></h3>
<h5 data-id="heading-11"><strong>优点</strong></h5>
<ul>
<li>数据私有化</li>
<li>模块化开发</li>
<li>避免全局变量污染</li>
<li>实现函数式编程模式</li>
</ul>
<h5 data-id="heading-12">缺点</h5>
<ul>
<li>容易造成内存泄漏（长期引用大对象）</li>
<li>不合理使用会影响性能</li>
<li>变量长期存在难以调试</li>
</ul>
<h3 data-id="heading-13">7.面试总结版</h3>
<ul>
<li>闭包是指函数可以访问其定义时的词法作用域，即使外部函数已经执行结束。</li>
<li>本质是函数持有对外部变量的引用。</li>
<li>常见应用场景包括数据私有化、计数器、防抖节流等。</li>
</ul>
<h2 data-id="heading-14">二、高阶函数</h2>
<h3 data-id="heading-15">1.什么是高阶函数？</h3>
<p>在 JavaScript 里，<strong>函数是一等公民（First-Class Function）</strong> ：</p>
<ul>
<li>可以赋值给变量</li>
<li>可以作为参数传入</li>
<li>可以作为返回值返回</li>
</ul>
<p><strong>高阶函数</strong>是指至少满足以下条件之一的函数：</p>
<ol>
<li><strong>接受一个或多个函数作为参数</strong></li>
<li><strong>返回一个函数作为结果</strong></li>
</ol>
<p>简单说：<strong>操作其他函数的函数</strong>。</p>
<h3 data-id="heading-16">2. 常见的高阶函数示例</h3>
<h4 data-id="heading-17">示例1：函数作为参数（回调函数）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello "</span> + name;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processUserInput</span>(<span class="hljs-params">callback</span>) {
  <span class="hljs-keyword">const</span> name = <span class="hljs-string">"Mike"</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">callback</span>(name));
}

<span class="hljs-title function_">processUserInput</span>(greet);
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>打印结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a7f338435ca42dfba93534812a12034~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3NjYXJ6aGFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482519&amp;x-signature=TElR%2BnCuPAfJE8c4FeAb7xH0YZM%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<h4 data-id="heading-18">示例2：函数作为返回值</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">multiplier</span>(<span class="hljs-params">factor</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"打印factor:"</span>, factor); <span class="hljs-comment">//打印 2 3</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">number</span></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"打印number:"</span>, <span class="hljs-built_in">number</span>); <span class="hljs-comment">//打印 5 6</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">number</span> * factor;
  };
}

<span class="hljs-keyword">const</span> double = <span class="hljs-title function_">multiplier</span>(<span class="hljs-number">2</span>);
<span class="hljs-keyword">const</span> triole = <span class="hljs-title function_">multiplier</span>(<span class="hljs-number">3</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">double</span>(<span class="hljs-number">5</span>)); <span class="hljs-comment">//10</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">triole</span>(<span class="hljs-number">6</span>)); <span class="hljs-comment">//18</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>打印结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80f5476b556d449387ea573d9fb3a89c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3NjYXJ6aGFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482519&amp;x-signature=tXj3KwUMie09pheIt1V8HjHaAm0%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<h4 data-id="heading-19">示例3.经典数组方法</h4>
<h5 data-id="heading-20"><strong>map()</strong> - 映射/转换</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];

<span class="hljs-comment">// 每个元素乘以2</span>
<span class="hljs-keyword">const</span> doubled = numbers.map(<span class="hljs-built_in">num</span> =&gt; <span class="hljs-built_in">num</span> * <span class="hljs-number">2</span>);
console.log(doubled); <span class="hljs-comment">// [2, 4, 6, 8, 10]</span>

<span class="hljs-comment">// 转换为对象数组</span>
<span class="hljs-keyword">const</span> objects = numbers.map(<span class="hljs-built_in">num</span> =&gt; ({ value: <span class="hljs-built_in">num</span> }));
console.log(objects);
<span class="hljs-comment">// [{value: 1}, {value: 2}, {value: 3}, {value: 4}, {value: 5}]</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-21"><strong>filter()</strong> - 过滤</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>];

<span class="hljs-comment">// 获取偶数</span>
<span class="hljs-keyword">const</span> evens = numbers.filter(<span class="hljs-built_in">num</span> =&gt; <span class="hljs-built_in">num</span> % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>);
console.log(evens); <span class="hljs-comment">// [2, 4, 6]</span>

<span class="hljs-comment">// 获取大于3的数</span>
<span class="hljs-keyword">const</span> greaterThan3 = numbers.filter(<span class="hljs-built_in">num</span> =&gt; <span class="hljs-built_in">num</span> &gt; <span class="hljs-number">3</span>);
console.log(greaterThan3); <span class="hljs-comment">// [4, 5, 6]</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-22"><strong>reduce()</strong> - 归约/累积</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];

<span class="hljs-comment">// 求和</span>
<span class="hljs-keyword">const</span> sum = numbers.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">accumulator, current</span>) =&gt;</span> accumulator + current, <span class="hljs-number">0</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sum); <span class="hljs-comment">// 15</span>

<span class="hljs-comment">// 求最大值</span>
<span class="hljs-keyword">const</span> max = numbers.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, curr</span>) =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(acc, curr), -<span class="hljs-title class_">Infinity</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(max); <span class="hljs-comment">// 5</span>

<span class="hljs-comment">// 数组转对象</span>
<span class="hljs-keyword">const</span> users = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span> }
];

<span class="hljs-keyword">const</span> usersById = users.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, user</span>) =&gt;</span> {
  acc[user.<span class="hljs-property">id</span>] = user;
  <span class="hljs-keyword">return</span> acc;
}, {});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usersById);
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//   1: { id: 1, name: 'Alice' },</span>
<span class="hljs-comment">//   2: { id: 2, name: 'Bob' }</span>
<span class="hljs-comment">// }</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-23"><strong>forEach()</strong> - 遍历</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fruits = [<span class="hljs-string">'apple'</span>, <span class="hljs-string">'banana'</span>, <span class="hljs-string">'orange'</span>];

fruits.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">fruit, index</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>. <span class="hljs-subst">${fruit}</span>`</span>);
});
<span class="hljs-comment">// 1. apple</span>
<span class="hljs-comment">// 2. banana</span>
<span class="hljs-comment">// 3. orange</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-24"><strong>find() / findIndex()</strong> - 查找</h5>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">users</span> = [
  { id: <span class="hljs-number">1</span>, name: <span class="hljs-string">'Alice'</span> },
  { id: <span class="hljs-number">2</span>, name: <span class="hljs-string">'Bob'</span> },
  { id: <span class="hljs-number">3</span>, name: <span class="hljs-string">'Alice'</span> }
]<span class="hljs-comment">;</span>

const <span class="hljs-attr">alice</span> = users.find(user =&gt; user.name === <span class="hljs-string">'Alice'</span>)<span class="hljs-comment">;</span>
console.log(alice)<span class="hljs-comment">; // { id: 1, name: 'Alice' }</span>

const <span class="hljs-attr">aliceIndex</span> = users.findIndex(user =&gt; user.name === <span class="hljs-string">'Alice'</span>)<span class="hljs-comment">;</span>
console.log(aliceIndex)<span class="hljs-comment">; // 0</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-25"><strong>some() / every()</strong> - 条件检查</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];

<span class="hljs-comment">// 是否有偶数？</span>
<span class="hljs-keyword">const</span> hasEven = numbers.some(<span class="hljs-built_in">num</span> =&gt; <span class="hljs-built_in">num</span> % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>);
console.log(hasEven); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 是否所有数都大于0？</span>
<span class="hljs-keyword">const</span> allPositive = numbers.every(<span class="hljs-built_in">num</span> =&gt; <span class="hljs-built_in">num</span> &gt; <span class="hljs-number">0</span>);
console.log(allPositive); <span class="hljs-comment">// true</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-26">3.自定义高阶函数</h3>
<h4 data-id="heading-27">1.什么是自定义高阶函数</h4>
<p>自定义高阶函数，本质就是：</p>
<blockquote>
<p>用函数去增强、控制、复用另一个函数</p>
</blockquote>
<p>一般分三类：</p>
<ol>
<li>函数增强（装饰）</li>
<li>行为抽象（解耦）</li>
<li>执行控制（节流、防抖等）</li>
</ol>
<h4 data-id="heading-28">2.最经典：函数增强（装饰器思想）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">before</span>(<span class="hljs-params">fn, beforeFn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    beforeFn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);  <span class="hljs-comment">// 先执行 beforeFn</span>
    <span class="hljs-keyword">return</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);  <span class="hljs-comment">// 再执行原始函数 fn</span>
  };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">after</span>(<span class="hljs-params">fn, afterFn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> result = fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);  <span class="hljs-comment">// 先执行原始函数 fn</span>
    afterFn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);  <span class="hljs-comment">// 再执行 afterFn</span>
    <span class="hljs-keyword">return</span> result;  <span class="hljs-comment">// 返回原始函数的结果</span>
  };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">say</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello "</span> + name);
}

<span class="hljs-keyword">const</span> newSay = <span class="hljs-title function_">before</span>(say, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"准备执行..."</span>);
});

<span class="hljs-title function_">newSay</span>(<span class="hljs-string">"Jake"</span>);
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>Before函数：</strong></p>
<blockquote>
<p>**调用 newSay("Jake") 时：</p>
<ol>
<li>执行 beforeFn() → "准备执行..."</li>
<li>执行 say("Jake") → "Hello Jake"</li>
<li>返回 say 的返回值（undefined）**</li>
</ol>
</blockquote>
<p><strong>After 函数：</strong></p>
<blockquote>
<p>**调用 afterFn 装饰的函数时：</p>
<ol>
<li>执行原始函数 fn → 得到结果</li>
<li>执行 afterFn()</li>
<li>返回 fn 的结果**</li>
</ol>
</blockquote>
<p>打印结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72f63db738ec47ecae301f7021e47180~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3NjYXJ6aGFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482519&amp;x-signature=akNZTfNeZOrjGUxznrpl8xs8%2Fl4%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<h4 data-id="heading-29">3.执行控制型高阶函数</h4>
<p>执行控制型高阶函数是指那些能够<strong>控制函数执行时机、频率或条件</strong>的高阶函数，它们在前端开发中非常实用。</p>
<h5 data-id="heading-30">3.1 自定义节流函数</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> lastTime = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

    <span class="hljs-keyword">if</span> (now - lastTime &gt; delay) {
      lastTime = now;
      fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    }
  };
}

<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(
  <span class="hljs-string">"scroll"</span>,
  <span class="hljs-title function_">throttle</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"滚动触发"</span>);
  }, <span class="hljs-number">1000</span>)
);
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-31">3.2 自定义防抖函数</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-built_in">clearTimeout</span>(timer);

    timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    }, delay);
  };
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-32">4.行为抽象型高阶函数</h4>
<p><strong>指将程序中具体的操作逻辑（行为）提取出来，使其不依赖于具体的数据，而是通过参数（特别是函数参数）来定义。这使得代码更通用、更可复用。</strong></p>
<h5 data-id="heading-33">4.1 抽象重复逻辑</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">withLoading</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"loading..."</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>(...args);
      <span class="hljs-keyword">return</span> result;
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"loading end"</span>);
    }
  };
}


<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"数据"</span>;
}

<span class="hljs-keyword">const</span> newFetch = <span class="hljs-title function_">withLoading</span>(fetchData);

<span class="hljs-title function_">newFetch</span>();
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>打印结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ab5e38b9f2243e1b4af50bcaca423b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3NjYXJ6aGFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482519&amp;x-signature=90FV0ouePBC7V9KV6k8OI44qAfg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<h4 data-id="heading-34">5.函数柯里化（进阶自定义高阶函数）</h4>
<p><strong>函数柯里化</strong>是一种将<strong>接受多个参数的函数</strong>转换为<strong>接受单个参数（或更少参数）的函数序列</strong>的技术。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curry</span>(<span class="hljs-params">fn</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">curried</span>(<span class="hljs-params">...args</span>) </span>{
    <span class="hljs-keyword">if</span> (args.length &gt;= fn.length) {
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">fn</span>(<span class="hljs-params">...args</span>)</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">...nextArgs</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">curried</span>(...args, ...nextArgs);
      };
    }
  };
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">a, b, c</span>) </span>{
  <span class="hljs-keyword">return</span> a + b + c;
}

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">curriedAdd</span> = <span class="hljs-title function_ invoke__">curry</span>(add);

console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-title function_ invoke__">curriedAdd</span>(<span class="hljs-number">1</span>)(<span class="hljs-number">2</span>)(<span class="hljs-number">3</span>)); <span class="hljs-comment">// 6</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>打印结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6eb90269ecb40fba3ee8c0fc4697811~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3NjYXJ6aGFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482519&amp;x-signature=pMMM0g8zhSZ3fdg%2By7d1mywCDtw%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<h4 data-id="heading-35">6.链式增强</h4>
<p><strong>链式增强是 JavaScript 中一种强大的编程模式，它通过方法链（Method Chaining）让代码更加流畅、可读。这种模式特别适用于数据处理、DOM 操作和构建复杂配置。</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">before</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">beforeFn</span>) {
  <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    beforeFn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    <span class="hljs-keyword">return</span> self.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
  };
};


<span class="hljs-keyword">function</span> <span class="hljs-title function_">say</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"hello"</span>);
}

say = say.<span class="hljs-title function_">before</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"before..."</span>);
});

<span class="hljs-title function_">say</span>();
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>打印结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29cab096359b46289ca4a9d647f27ef5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3NjYXJ6aGFuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482519&amp;x-signature=vTOpi1KfM0R0BhNU8MbhJ9xshcg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<h4 data-id="heading-36">7.自定义高阶函数的本质结构</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">higherOrder</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-comment">// 1. 执行前逻辑</span>

    <span class="hljs-keyword">const</span> result = fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);

    <span class="hljs-comment">// 2. 执行后逻辑</span>

    <span class="hljs-keyword">return</span> result;
  };
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-37">8.作为前端开发你必须掌握的几个自定义高阶函数</h4>
<ul>
<li>before / after</li>
<li>throttle</li>
<li>debounce</li>
<li>curry</li>
<li>once（只执行一次）</li>
<li>memoize（缓存结果）</li>
</ul>
<p><strong>比如 memoize：</strong></p>
<pre><code class="hljs language-ini" lang="ini">function memoize(fn) {
  const <span class="hljs-attr">cache</span> = {}<span class="hljs-comment">;</span>

  return function (...args) {
    const <span class="hljs-attr">key</span> = JSON.stringify(args)<span class="hljs-comment">;</span>

    if (cache<span class="hljs-section">[key]</span>) {
      return cache<span class="hljs-section">[key]</span><span class="hljs-comment">;</span>
    }

    const <span class="hljs-attr">result</span> = fn.apply(this, args)<span class="hljs-comment">;</span>
    cache<span class="hljs-section">[key]</span> = result<span class="hljs-comment">;</span>

    return result<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-38">9.终极理解（非常重要）</h4>
<p>高阶函数解决的问题是：</p>
<ul>
<li>不修改原函数</li>
<li>不侵入原逻辑</li>
<li>动态增强功能</li>
</ul>
<p>这就是：</p>
<ul>
<li>AOP</li>
<li>装饰器模式</li>
<li>中间件机制</li>
<li>React HOC</li>
<li>Vue 插件机制</li>
</ul>
<p>的底层原理。</p>
<p>🌱 <strong>写在最后</strong><br/>
写作这些技术文章的过程，也是我重新梳理知识体系的过程。<br/>
编程不仅是实现功能，更是一种思考方式。希望这篇文章不仅能帮你解决眼前的问题，更能激发你对[某个技术点]的更深层思考。<br/>
<em>最后：保持好奇，保持热爱。</em></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue2跨组件通信方案：全局事件总线与Vuex的灵活结合]]></title>    <link>https://juejin.cn/post/7605529884823175231</link>    <guid>https://juejin.cn/post/7605529884823175231</guid>    <pubDate>2026-02-12T06:17:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605529884823175231" data-draft-id="7605547012050403369" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue2跨组件通信方案：全局事件总线与Vuex的灵活结合"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-02-12T06:17:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="青屿ovo"/> <meta itemprop="url" content="https://juejin.cn/user/2080706144515166"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue2跨组件通信方案：全局事件总线与Vuex的灵活结合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2080706144515166/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    青屿ovo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:17:13.000Z" title="Thu Feb 12 2026 06:17:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue2跨组件通信方案：全局事件总线与Vuex的灵活结合</h2>
<p>前端高频面试/开发考点！一文吃透Vue2跨组件通信核心，Bus+Vuex结合用法拆解，代码可直接复制复用，新手也能快速避坑，收藏备用～</p>
<h3 data-id="heading-1">📋 目录</h3>
<ul>
<li>
<p>一、核心前言（为什么需要两种方案结合？）</p>
</li>
<li>
<p>二、全局事件总线（Bus）详解（3步落地+避坑）</p>
</li>
<li>
<p>三、Vuex详解（Vue2状态管理核心，5大模块+4步实战）</p>
</li>
<li>
<p>四、Bus与Vuex灵活结合（实战场景+核心优势）</p>
</li>
<li>
<p>五、高频避坑指南（面试常考）</p>
</li>
<li>
<p>六、核心总结（快速回顾重点）</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-2">一、核心前言</h3>
<p>Vue2开发中，跨组件通信是绕不开的高频需求，不同组件层级（父子、兄弟、隔代、无关联）对应不同解决方案，单一方案往往有局限性：</p>
<ul>
<li>
<p>props/emit：仅适合父子组件，层级嵌套多时会出现“props drilling”（props穿透），代码冗余；</p>
</li>
<li>
<p>全局事件总线（Bus）：轻量高效，但无状态管理，复杂场景难以维护；</p>
</li>
<li>
<p>Vuex：集中管理状态，适合复杂场景，但配置繁琐，简单通信成本高。</p>
</li>
</ul>
<p>核心原则：<strong>简单通信用Bus（轻量高效），复杂状态用Vuex（统一管理）</strong>，两者灵活结合，可高效解决99%的Vue2跨组件通信需求。</p>
<hr/>
<h3 data-id="heading-3">二、全局事件总线（Bus）详解</h3>
<h4 data-id="heading-4">1. 什么是全局事件总线？</h4>
<p>本质：通过Vue实例作为“中间桥梁”，实现任意组件间的事件传递（触发+监听），无需层层传递，<strong>轻量无依赖、无需额外安装</strong>，是简单跨组件通信的最优解。</p>
<p><strong>适用场景</strong>：兄弟组件通信、隔代组件简单通信、无关联组件单次通信（如弹窗关闭、通知提示、页面刷新通知）。</p>
<h4 data-id="heading-5">2. 实现步骤（3步落地，代码可直接复制）</h4>
<h5 data-id="heading-6">步骤1：创建全局Bus实例（main.js配置）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js（Vue2项目）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>

<span class="hljs-comment">// 创建全局事件总线，挂载到Vue原型，所有组件可直接访问</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$Bus</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>()

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">el</span>: <span class="hljs-string">'#app'</span>,
  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-params">h</span> =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">App</span>)
})
</code></pre>
<h5 data-id="heading-7">步骤2：发送事件（触发方组件）</h5>
<p>通过 <code>this.$Bus.$emit('事件名', 传递的数据)</code> 发送事件，支持任意类型数据（对象、数组、基本类型）。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;button @click="sendMsg" style="padding: 8px 16px; cursor: pointer;"&gt;发送消息给兄弟组件&lt;/button&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  methods: {
    sendMsg() {
      // 事件名建议语义化，避免冲突（可加组件前缀，如brother-msg）
      this.$Bus.$emit('brotherMsg', {
        content: 'Hello，兄弟组件！',
        time: new Date().toLocaleString()
      })
    }
  }
}
&lt;/script&gt;
</code></pre>
<h5 data-id="heading-8">步骤3：监听事件（接收方组件）</h5>
<p>通过 <code>this.$Bus.$on('事件名', 回调函数)</code> 监听事件，<strong>重点：必须在beforeDestroy中销毁监听</strong>，避免内存泄漏和事件多次触发。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="brother-component"&gt;
    &lt;h4&gt;接收兄弟组件消息：&lt;/h4&gt;
    &lt;p v-if="msg"&gt;{{ msg.content }}（{{ msg.time }}）&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  data() {
    return {
      msg: null
    }
  },
  mounted() {
    // 监听事件，与发送方事件名保持一致
    this.$Bus.$on('brotherMsg', (data) =&gt; {
      this.msg = data
    })
  },
  beforeDestroy() {
    // 销毁监听，避免内存泄漏（必写！面试常考）
    this.$Bus.$off('brotherMsg')
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-9">3. Bus核心方法速查（表格清晰记）</h4>

























<table><thead><tr><th><strong>方法名</strong></th><th><strong>说明</strong></th><th><strong>使用示例</strong></th></tr></thead><tbody><tr><td>$emit</td><td>发送事件，传递数据</td><td>this.<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>u</mi><mi>s</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">Bus.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord">.</span></span></span></span></span>emit('name', data)</td></tr><tr><td>$on</td><td>监听事件，接收数据</td><td>this.<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>u</mi><mi>s</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">Bus.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord">.</span></span></span></span></span>on('name', (data)=&gt;{})</td></tr><tr><td>$off</td><td>销毁监听，避免泄漏</td><td>this.<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>u</mi><mi>s</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">Bus.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord">.</span></span></span></span></span>off('name')</td></tr></tbody></table>
<h4 data-id="heading-10">4. Bus优缺点（辩证看待）</h4>
<p><strong>✅ 优点</strong></p>
<ul>
<li>
<p>轻量、简单、无依赖，接入成本极低</p>
</li>
<li>
<p>无需额外配置，开箱即用</p>
</li>
<li>
<p>适合简单通信场景，效率高</p>
</li>
</ul>
<p><strong>❌ 缺点</strong></p>
<ul>
<li>
<p>无状态管理，无法追踪数据来源</p>
</li>
<li>
<p>事件名易冲突，维护成本随项目变大升高</p>
</li>
<li>
<p>不适合多组件共享、频繁修改的复杂状态</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-11">三、Vuex详解（Vue2状态管理核心）</h3>
<h4 data-id="heading-12">1. 什么是Vuex？</h4>
<p>Vue2官方状态管理库，用于<strong>集中管理所有组件的共享状态</strong>（如用户信息、购物车数据、全局设置），实现组件间状态共享和统一修改，可追踪状态变化，是中大型Vue2项目的首选方案。</p>
<p><strong>适用场景</strong>：多组件共享状态、需频繁修改/追踪的复杂状态、全局状态管理（如用户登录状态、主题切换）。</p>
<h4 data-id="heading-13">2. Vuex核心概念（5大模块，面试必背）</h4>
<p>记牢这5个模块，即可掌握Vuex核心用法，面试高频提问！</p>
<ul>
<li>
<p><strong>state</strong>：存储全局状态（类似组件的data），唯一数据源，所有组件共享；</p>
</li>
<li>
<p><strong>mutations</strong>：修改state的唯一方式（<strong>仅支持同步操作</strong>），禁止写异步代码；</p>
</li>
<li>
<p><strong>actions</strong>：处理异步操作（如接口请求），不能直接修改state，需通过commit调用mutations；</p>
</li>
<li>
<p><strong>getters</strong>：对state进行加工处理（类似组件的computed），可缓存结果，避免重复计算；</p>
</li>
<li>
<p><strong>modules</strong>：拆分模块（大型项目用），避免state过于臃肿，每个模块可拥有独立的state、mutations等。</p>
</li>
</ul>
<h4 data-id="heading-14">3. 使用步骤（4步落地，实战可直接复用）</h4>
<h5 data-id="heading-15">步骤1：安装Vuex（Vue2专属版本，避坑关键）</h5>
<p>Vue2必须安装3.x版本，4.x版本仅适配Vue3，装错会直接报错！</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Vue2项目安装命令（固定版本，避免兼容问题）</span>
npm install vuex@3.6.2 --save
</code></pre>
<h5 data-id="heading-16">步骤2：创建Vuex实例（src/store/index.js）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/store/index.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vuex</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>

<span class="hljs-comment">// 安装Vuex插件</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Vuex</span>)

<span class="hljs-comment">// 创建Vuex实例</span>
<span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>({
  <span class="hljs-comment">// 存储全局状态</span>
  <span class="hljs-attr">state</span>: {
    <span class="hljs-attr">userInfo</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 多组件共享：用户信息</span>
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> <span class="hljs-comment">// 示例：简单共享计数</span>
  },
  <span class="hljs-comment">// 同步修改state（仅同步操作）</span>
  <span class="hljs-attr">mutations</span>: {
    <span class="hljs-title function_">setUserInfo</span>(<span class="hljs-params">state, data</span>) {
      state.<span class="hljs-property">userInfo</span> = data <span class="hljs-comment">// 只能通过mutation修改state</span>
    },
    <span class="hljs-title function_">increment</span>(<span class="hljs-params">state</span>) {
      state.<span class="hljs-property">count</span>++
    }
  },
  <span class="hljs-comment">// 处理异步操作（如接口请求）</span>
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-comment">// 模拟异步获取用户信息（实际项目替换为接口请求）</span>
    <span class="hljs-title function_">getUserInfoAsync</span>(<span class="hljs-params">{ commit }, data</span>) {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 异步操作完成后，通过commit调用mutation修改state</span>
        <span class="hljs-title function_">commit</span>(<span class="hljs-string">'setUserInfo'</span>, data)
      }, <span class="hljs-number">1000</span>)
    }
  },
  <span class="hljs-comment">// 加工state，缓存结果</span>
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-comment">// 判断用户是否登录</span>
    <span class="hljs-title function_">isLogin</span>(<span class="hljs-params">state</span>) {
      <span class="hljs-keyword">return</span> !!state.<span class="hljs-property">userInfo</span>
    },
    <span class="hljs-comment">// 获取计数的2倍（缓存结果，避免重复计算）</span>
    <span class="hljs-title function_">doubleCount</span>(<span class="hljs-params">state</span>) {
      <span class="hljs-keyword">return</span> state.<span class="hljs-property">count</span> * <span class="hljs-number">2</span>
    }
  }
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store
</code></pre>
<h5 data-id="heading-17">步骤3：挂载Vuex到Vue实例（main.js）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span> <span class="hljs-comment">// 引入store实例</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vuex</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>

<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Vuex</span>)

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">el</span>: <span class="hljs-string">'#app'</span>,
  <span class="hljs-attr">render</span>: <span class="hljs-function"><span class="hljs-params">h</span> =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">App</span>),
  store <span class="hljs-comment">// 挂载后，所有组件可通过this.$store访问Vuex</span>
})
</code></pre>
<h5 data-id="heading-18">步骤4：组件中使用Vuex（读取/修改状态）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="vuex-demo"&gt;
    &lt;h4&gt;Vuex状态使用示例&lt;/h4&gt;
    &lt;p&gt;当前计数：{{ $store.state.count }}&lt;/p&gt;
    &lt;p&gt;计数的2倍：{{ $store.getters.doubleCount }}&lt;/p&gt;
    &lt;p&gt;用户是否登录：{{ $store.getters.isLogin ? '已登录' : '未登录' }}&lt;/p&gt;
    
    &lt;button @click="addCount" style="margin-right: 10px; padding: 8px 16px;"&gt;增加计数&lt;/button&gt;
    &lt;button @click="getUserInfo" style="padding: 8px 16px;"&gt;模拟登录&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  methods: {
    // 同步修改state：调用mutation（唯一方式）
    addCount() {
      this.$store.commit('increment')
    },
    // 异步修改state：调用action，由action触发mutation
    getUserInfo() {
      this.$store.dispatch('getUserInfoAsync', {
        username: 'vue2demo',
        age: 22
      })
    }
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-19">4. Vuex优缺点（辩证看待）</h4>
<p><strong>✅ 优点</strong></p>
<ul>
<li>
<p>集中管理共享状态，可追踪状态变化（调试方便）；</p>
</li>
<li>
<p>规范组件通信，避免数据混乱；</p>
</li>
<li>
<p>适合复杂场景，维护成本低，扩展性强。</p>
</li>
</ul>
<p><strong>❌ 缺点</strong></p>
<ul>
<li>
<p>配置繁琐，简单通信场景（如单次弹窗）使用成本高；</p>
</li>
<li>
<p>小型项目无需使用，过度封装会增加冗余。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-20">四、Bus与Vuex的灵活结合（核心重点）</h3>
<h4 data-id="heading-21">1. 结合原则（实战核心）</h4>
<p>记住一句话：<strong>简单通信用Bus，复杂状态用Vuex</strong>，两者互补，避开单一方案的弊端，提升开发效率。</p>
<ul>
<li>
<p><strong>用Bus的场景</strong>：一次性通信、无状态依赖通信（弹窗关闭、兄弟组件单次消息、页面刷新通知）；</p>
</li>
<li>
<p><strong>用Vuex的场景</strong>：多组件共享状态、需频繁修改/追踪的复杂状态（用户信息、购物车、全局设置）。</p>
</li>
</ul>
<h4 data-id="heading-22">2. 实战结合示例（面试常考场景）</h4>
<p>场景：用户登录成功后，用Vuex同步全局用户状态，用Bus通知所有相关组件（导航栏、个人中心）刷新页面。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 登录组件（触发登录，调用Vuex action + 发送Bus事件）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">login</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 模拟接口请求登录，获取用户数据</span>
      <span class="hljs-keyword">const</span> userData = { <span class="hljs-attr">username</span>: <span class="hljs-string">'vue2demo'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'admin'</span> }
      <span class="hljs-comment">// ① 调用Vuex action，同步用户状态到全局（复杂状态管理）</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-title function_">dispatch</span>(<span class="hljs-string">'getUserInfoAsync'</span>, userData)
      <span class="hljs-comment">// ② 发送Bus事件，通知其他组件刷新（简单一次性通信）</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$Bus</span>.$emit(<span class="hljs-string">'userLoginSuccess'</span>, userData)
    }
  }
}

<span class="hljs-comment">// 2. 导航栏组件（监听Bus事件 + 读取Vuex状态）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">userInfo</span>: <span class="hljs-literal">null</span>
    }
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 监听Bus事件，接收登录成功通知，局部更新</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$Bus</span>.$on(<span class="hljs-string">'userLoginSuccess'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">userInfo</span> = data
    })
    <span class="hljs-comment">// 初始化时，读取Vuex中的全局用户状态</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">userInfo</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">userInfo</span>
  },
  <span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 销毁Bus监听，避免内存泄漏</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$Bus</span>.$off(<span class="hljs-string">'userLoginSuccess'</span>)
  }
}
</code></pre>
<h4 data-id="heading-23">3. 结合优势（为什么要这么用？）</h4>
<ul>
<li>
<p>✅ 高效：简单场景无需配置复杂Vuex，降低开发成本；复杂场景用Vuex，保证状态规范；</p>
</li>
<li>
<p>✅ 灵活：按需选择方案，避免“一刀切”（不用为了简单通信写一堆Vuex配置）；</p>
</li>
<li>
<p>✅ 易维护：状态集中管理（Vuex），单次通信解耦（Bus），代码清晰，后期好维护。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-24">五、高频避坑指南（面试常考，必看！）</h3>
<p>这些坑90%的新手都会踩，收藏起来，避免踩坑！</p>
<h4 data-id="heading-25">1. Bus避坑（2个核心）</h4>
<ul>
<li>
<p>事件名必须语义化，可加组件前缀（如header-close、brother-msg），避免冲突；</p>
</li>
<li>
<p>必须在beforeDestroy中销毁监听（this.<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>u</mi><mi>s</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">Bus.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord">.</span></span></span></span></span>off('事件名')），否则会导致内存泄漏、事件多次触发。</p>
</li>
</ul>
<h4 data-id="heading-26">2. Vuex避坑（3个核心）</h4>
<ul>
<li>
<p>Vue2必须安装<a href="https://link.juejin.cn?target=mailto%3AVuex%403.x" target="_blank" title="mailto:Vuex@3.x" ref="nofollow noopener noreferrer">Vuex@3.x</a>版本，4.x仅适配Vue3，装错会直接报错；</p>
</li>
<li>
<p>mutations只能写同步代码，异步操作（如接口请求）必须放在actions中，否则无法追踪状态变化；</p>
</li>
<li>
<p>禁止直接修改state（如this.$store.state.count = 1），必须通过mutation修改（面试高频考点）。</p>
</li>
</ul>
<h4 data-id="heading-27">3. 结合避坑（2个核心）</h4>
<ul>
<li>
<p>不滥用Vuex，简单通信用Bus即可，避免过度封装；</p>
</li>
<li>
<p>Bus仅用于“通知”，不传递大量复杂数据（复杂数据用Vuex存储），避免数据混乱。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-28">六、核心总结</h3>
<p>本文核心是「Bus+Vuex灵活结合」，记住以下4点，轻松应对Vue2跨组件通信所有场景：</p>
<ol>
<li>
<p>全局事件总线（Bus）：Vue实例作为桥梁，轻量简单，适合简单通信，<strong>重点是销毁监听</strong>；</p>
</li>
<li>
<p>Vuex：Vue2官方状态管理库，集中管理共享状态，适合复杂场景，核心是5大模块，<strong>禁止直接修改state</strong>；</p>
</li>
<li>
<p>结合逻辑：简单通信用Bus，复杂状态用Vuex，互补使用，提升开发效率和代码可维护性；</p>
</li>
<li>
<p>避坑关键：Bus销毁监听、Vuex版本适配、不直接修改state、事件名语义化。</p>
</li>
</ol>
<p>你在Vue2跨组件通信中还遇到过哪些坑？欢迎在评论区留言交流，一起避坑成长～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[闭包的“连坐”悬案：一个内存泄漏引发的血案]]></title>    <link>https://juejin.cn/post/7605492906904993838</link>    <guid>https://juejin.cn/post/7605492906904993838</guid>    <pubDate>2026-02-12T06:20:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605492906904993838" data-draft-id="7605495714294906906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="闭包的“连坐”悬案：一个内存泄漏引发的血案"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2026-02-12T06:20:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码诗人卡尔"/> <meta itemprop="url" content="https://juejin.cn/user/2067500101533902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            闭包的“连坐”悬案：一个内存泄漏引发的血案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2067500101533902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码诗人卡尔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:20:10.000Z" title="Thu Feb 12 2026 06:20:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第一章：案发现场</h2>
<p>夜深了，我还在吭哧吭哧地写代码。突然，监控系统发来警报：内存占用率飙升！</p>
<p>我心里一惊，赶紧冲到案发现场。经过一番排查，我把嫌疑锁定在了一段看似人畜无害的代码上：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">demo</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 一个 100MB 的大胖子</span>
  <span class="hljs-keyword">const</span> bigArrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">100_000_000</span>);

  <span class="hljs-comment">// 一个 1 秒后执行的定时器，用到了大胖子</span>
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigArrayBuffer.<span class="hljs-property">byteLength</span>);
  }, <span class="hljs-number">1000</span>);

  <span class="hljs-comment">// 返回一个清理函数，用来取消定时器</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(id);
}

<span class="hljs-comment">// 把清理函数挂到全局，以便随时调用</span>
globalThis.<span class="hljs-property">cancelDemo</span> = <span class="hljs-title function_">demo</span>();
</code></pre>
<p>我百思不得其解。这段代码的逻辑很清晰：</p>
<ol>
<li><code>demo</code> 函数执行，创建了一个 100MB 的大胖子 <code>bigArrayBuffer</code>。</li>
<li>一个 <code>setTimeout</code> 在 1 秒后会用一下这个大胖子。</li>
<li><code>demo</code> 函数返回了一个 <code>cancelDemo</code> 函数，这个函数只认识 <code>id</code>，根本不认识 <code>bigArrayBuffer</code>。</li>
</ol>
<p>我的推理是：1 秒钟之后，<code>setTimeout</code> 的回调执行完毕，再也没有人认识 <code>bigArrayBuffer</code> 了。它应该被垃圾回收（GC）大叔带走，释放那 100MB 的宝贵内存。</p>
<p>但现实是残酷的。<code>bigArrayBuffer</code> 像个钉子户，永远地赖在了内存里！</p>
<p>为什么？难道是 GC 大叔偷懒了？还是 V8 引擎出了 Bug？</p>
<p>为了搞清楚真相，我决定从头开始，审问每一个嫌疑人。</p>
<h2 data-id="heading-1">第二章：排除嫌疑</h2>
<p>我写了几个简单的变种，想看看 GC 大叔到底是怎么想的。</p>
<h3 data-id="heading-2">嫌疑人 A：最简单的函数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">demo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> bigArrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">100_000_000</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigArrayBuffer.<span class="hljs-property">byteLength</span>);
}

<span class="hljs-title function_">demo</span>();
</code></pre>
<p><strong>结果</strong>：<code>demo</code> 函数一执行完，<code>bigArrayBuffer</code> 立刻被回收。内存瞬间恢复正常。</p>
<p><strong>结论</strong>：GC 大叔很敬业，人走茶凉，绝不含糊。嫌疑人 A 无罪释放。</p>
<h3 data-id="heading-3">嫌疑人 B：只有 <code>setTimeout</code></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">demo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> bigArrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">100_000_000</span>);

  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigArrayBuffer.<span class="hljs-property">byteLength</span>);
  }, <span class="hljs-number">1000</span>);
}

<span class="hljs-title function_">demo</span>();
</code></pre>
<p><strong>结果</strong>：<code>demo</code> 函数执行完后，<code>bigArrayBuffer</code> 并没有马上被回收。GC 大叔很有耐心，它知道 1 秒后还有人要用它。等到 <code>setTimeout</code> 的回调执行完毕，<code>bigArrayBuffer</code> 才被带走。</p>
<p><strong>结论</strong>：GC 大叔不仅敬业，还很智能，能预判未来的使用情况。嫌疑人 B 也无罪。</p>
<h3 data-id="heading-4">嫌疑人 C：返回的函数不引用任何东西</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">demo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> bigArrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">100_000_000</span>);

  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">// 注意，这里没用大胖子</span>
  }, <span class="hljs-number">1000</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(id);
}

globalThis.<span class="hljs-property">cancelDemo</span> = <span class="hljs-title function_">demo</span>();
</code></pre>
<p><strong>结果</strong>：<code>bigArrayBuffer</code> 在 <code>demo</code> 函数执行完后立刻被回收！</p>
<p><strong>结论</strong>：GC 大叔简直是火眼金睛！它通过静态分析发现，虽然 <code>demo</code> 函数里有一堆内部函数，但没有一个真正用到了 <code>bigArrayBuffer</code>。于是它大笔一挥：“此物无用，收走！”</p>
<p>到这里，我更糊涂了。GC 大叔明明这么聪明，为什么在最初的案发现场就“失手”了呢？</p>
<h2 data-id="heading-5">第三章：真相大白</h2>
<p>我把最初的案发现场代码又看了一遍，感觉自己漏掉了什么关键线索。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">demo</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 作用域开始</span>
  <span class="hljs-keyword">const</span> bigArrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">100_000_000</span>);
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-comment">/* ... */</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(id);
  <span class="hljs-comment">// 作用域结束</span>
}
</code></pre>
<p>问题就出在 <strong>作用域</strong>（Scope）上。</p>
<p>在 JavaScript 的世界里，当 <code>demo</code> 函数被调用时，它会创建一个自己的“小世界”，也就是它的作用域。这个小世界里住着它所有的孩子：<code>bigArrayBuffer</code>、<code>id</code>、<code>setTimeout</code> 的回调函数，还有那个被 <code>return</code> 出去的匿名函数。</p>
<p>GC 大叔的回收原则，和我们想的不太一样。它不是一个一个地检查变量是否需要回收，而是<strong>以“作用域”为单位进行回收</strong>。</p>
<p>你可以把一个作用域想象成一个“家庭”。GC 大叔的规则是：</p>
<blockquote>
<p><strong>只要这个家庭里还有任何一个成员（函数）在外面有“关系”（能被外界访问到），那整个家庭（作用域）就得给我好好地待在内存里，一个都不能少！</strong></p>
</blockquote>
<p>这就是闭包的“<strong>连坐</strong>”制度！</p>
<p>现在，我们再来看看案发现场：</p>
<ol>
<li><code>demo</code> 函数执行，创建了一个作用域“家庭”。家庭成员有：<code>bigArrayBuffer</code>、<code>id</code>、定时器回调、返回的清理函数。</li>
<li>定时器回调函数引用了 <code>bigArrayBuffer</code>，所以 <code>bigArrayBuffer</code> 被留在了这个家庭里。</li>
<li><code>demo</code> 函数把“清理函数” <code>() =&gt; clearTimeout(id)</code> 返回给了外界，并赋值给了 <code>globalThis.cancelDemo</code>。这意味着，这个清理函数在外面有了“关系”，它还活着！</li>
<li>GC 大叔来检查了。它发现 <code>cancelDemo</code> 这个家庭成员还活着，于是它大手一挥：“这个家庭不能动！所有人原地待命！”</li>
</ol>
<p>于是，整个 <code>demo</code> 函数的作用域都被保留了下来。</p>
<p><code>bigArrayBuffer</code> 就这样，被无情地“连坐”了。即使 1 秒后，那个唯一引用它的定时器回调已经执行完毕，变成了“死人”，但只要 <code>cancelDemo</code> 这个“活人”还在，<code>bigArrayBuffer</code> 作为它的家庭成员，就必须陪着它一起留在内存里。</p>
<p>它就像一个无辜的路人，只是因为和某个“大人物”住在同一个小区，结果整个小区都被保护了起来，它也出不去了。</p>
<h2 data-id="heading-6">第四章：一荣俱荣，一损俱损</h2>
<p>为了验证这个“连坐”理论，我又设计了一个更极端的实验：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">demo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> bigArrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">100_000_000</span>);

  <span class="hljs-comment">// 大儿子，认识大胖子</span>
  globalThis.<span class="hljs-property">innerFunc1</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigArrayBuffer.<span class="hljs-property">byteLength</span>);
  };

  <span class="hljs-comment">// 二儿子，不认识大胖子</span>
  globalThis.<span class="hljs-property">innerFunc2</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"hello"</span>);
  };
}

<span class="hljs-title function_">demo</span>();
</code></pre>
<p>现在，<code>demo</code> 家庭有两个儿子被送到了外面，都还活着。</p>
<p>接着，我把大儿子干掉：</p>
<pre><code class="hljs language-javascript" lang="javascript">globalThis.<span class="hljs-property">innerFunc1</span> = <span class="hljs-literal">undefined</span>;
</code></pre>
<p>现在，唯一认识 <code>bigArrayBuffer</code> 的函数已经没了。按理说，<code>bigArrayBuffer</code> 应该可以被回收了吧？</p>
<p><strong>并不会！</strong></p>
<p>因为二儿子 <code>innerFunc2</code> 还活着！GC 大叔一看，这个家庭还有后代在外面，于是整个家庭继续保留。<code>bigArrayBuffer</code> 再次被“连坐”。</p>
<p>只有当我把二儿子也干掉时：</p>
<pre><code class="hljs language-javascript" lang="javascript">globalThis.<span class="hljs-property">innerFunc2</span> = <span class="hljs-literal">undefined</span>;
</code></pre>
<p>现在，<code>demo</code> 家庭在外面已经没有任何“关系”了。GC 大叔终于可以放心地把整个作用域连锅端了。<code>bigArrayBuffer</code> 这才得以解脱。</p>
<p>这个发现令人震惊：<strong>闭包变量的生命周期，取决于“最后一个兄弟”的生命周期，而不是它自己的！</strong></p>
<h2 data-id="heading-7">第五章：引擎的辩护</h2>
<p>你可能会问：V8 引擎为什么设计得这么“蠢”？为什么不能更智能一点，只保留那些被真正引用的变量呢？</p>
<p>这是一个跨浏览器都存在的问题，而且很可能不会被修复。原因很简单：<strong>性能</strong>。</p>
<p>要做得更精细，就意味着 GC 大叔的工作量会大大增加。它不仅要检查哪个家庭还有后代，还得去调查每个后代到底和家里的哪些东西有联系。这个“尽职调查”的成本太高了，会让整个 JavaScript 的执行效率变慢。</p>
<p>所以，引擎的设计者们做了一个权衡：用一个简单粗暴但高效的“连坐”规则，换取整体的性能。在大多数情况下，这个规则都没问题。只是在某些特定的闭包场景下，会造成意想不到的内存泄漏。</p>
<h2 data-id="heading-8">第六章：如何破解“连坐”？</h2>
<p>既然我们知道了“连坐”的规则，那破解它也就有了思路。</p>
<h3 data-id="heading-9">方案一：斩草除根</h3>
<p>既然问题是 <code>cancelDemo</code> 这个“活口”导致的，那我们就在用完它之后，把它干掉！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用完了，或者确定不需要了</span>
globalThis.<span class="hljs-property">cancelDemo</span> = <span class="hljs-literal">null</span>;
</code></pre>
<p>一旦 <code>cancelDemo</code> 被设置为 <code>null</code>，<code>demo</code> 家庭在外面就再也没有任何“关系”了。GC 大叔会立刻把整个作用域回收，<code>bigArrayBuffer</code> 自然也就被释放了。</p>
<h3 data-id="heading-10">方案二：分家！</h3>
<p>既然“连坐”是按“家庭”来的，那我们就把它们分成不同的家庭！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">demo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> cancel;

  <span class="hljs-comment">// 家庭 A：只负责定时器</span>
  {
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"hello"</span>);
    }, <span class="hljs-number">1000</span>);
    cancel = <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(id);
  }

  <span class="hljs-comment">// 家庭 B：只负责大胖子</span>
  {
    <span class="hljs-keyword">const</span> bigArrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">100_000_000</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigArrayBuffer.<span class="hljs-property">byteLength</span>);
  }

  <span class="hljs-keyword">return</span> cancel;
}

globalThis.<span class="hljs-property">cancelDemo</span> = <span class="hljs-title function_">demo</span>();
</code></pre>
<p>在这个版本里，我们用 <code>{}</code> 创建了两个独立的块级作用域。</p>
<ul>
<li><code>bigArrayBuffer</code> 住在“家庭 B”。这个家庭没有任何成员被暴露到外面，所以 <code>demo</code> 函数一执行完，家庭 B 就被整个回收了。</li>
<li><code>cancel</code> 函数来自“家庭 A”。它虽然活了下来，但它的家庭成员里根本没有 <code>bigArrayBuffer</code>。</li>
</ul>
<p>这样一来，<code>bigArrayBuffer</code> 就不会被“连坐”了。</p>
<h2 data-id="heading-11">尾声：闭包的江湖</h2>
<p>在 JavaScript 的江湖里，闭包是一个神奇的存在。它赋予了函数记忆的能力，但也带来了复杂的“社会关系”。</p>
<p>今天这个悬案告诉我们：</p>
<blockquote>
<p><strong>在闭包的世界里，一个变量能否被释放，不仅取决于它自己是否还在被使用，更取决于和它“同住一个屋檐下”的兄弟姐妹们，是否都已经“功成身退”。</strong></p>
</blockquote>
<p>所以，下次当你创建一个闭包时，特别是当它要和一个大对象共处一室时，请多留一个心眼。问问自己：那个即将被你 <code>return</code> 出去的函数，它的兄弟姐妹们都安排好了吗？</p>
<p>否则，下一个内存泄漏的案发现场，可能就在你的代码里。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spec-Kit、OpenSpec、Superpowers 深度对比与最佳实践]]></title>    <link>https://juejin.cn/post/7605489943868538895</link>    <guid>https://juejin.cn/post/7605489943868538895</guid>    <pubDate>2026-02-12T06:16:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605489943868538895" data-draft-id="7605516501751201801" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spec-Kit、OpenSpec、Superpowers 深度对比与最佳实践"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-02-12T06:16:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小碗细面"/> <meta itemprop="url" content="https://juejin.cn/user/1618104611770958"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spec-Kit、OpenSpec、Superpowers 深度对比与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1618104611770958/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小碗细面
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:16:08.000Z" title="Thu Feb 12 2026 06:16:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">AI 编程三剑客：Spec-Kit、OpenSpec、Superpowers 深度对比与最佳实践</h2>
<blockquote>
<p>本文将深入介绍 GitHub 官方的 Spec-Kit、社区热门的 OpenSpec 以及 Claude Code 神器 Superpowers 三个 AI 编程辅助工具，从安装配置到实战使用，再到三者协同的最佳实践，带你全面掌握 AI 驱动的规格化开发新范式。</p>
</blockquote>
<h3 data-id="heading-1">前言：为什么需要这些工具？</h3>
<p>2024-2026 年，AI 编程工具经历了爆发式增长。从最初的代码补全，到如今的 AI Agent 自主编程，开发者面临一个核心问题：<strong>如何让 AI 真正理解我们的意图，并按照预期的方式工作？</strong></p>
<p>三个工具应运而生，它们从不同角度解决这个问题：</p>

























<table><thead><tr><th>工具</th><th>核心问题</th><th>类比</th></tr></thead><tbody><tr><td><strong>Spec-Kit</strong></td><td>"按什么规矩干"</td><td>建筑规范手册</td></tr><tr><td><strong>OpenSpec</strong></td><td>"改了什么"</td><td>施工变更单</td></tr><tr><td><strong>Superpowers</strong></td><td>"怎么干"</td><td>施工队工作手册</td></tr></tbody></table>
<p>接下来，让我们逐一深入了解。</p>
<hr/>
<h3 data-id="heading-2">一、Spec-Kit：GitHub 官方的规格驱动开发框架</h3>
<h4 data-id="heading-3">1.1 简介</h4>
<p><strong>Spec-Kit</strong> 是 GitHub 官方在 2025 年初推出的开源工具包，专为"规格驱动开发"（Spec-Driven Development）设计。它的核心理念是：<strong>先写规格，再写代码</strong>。</p>
<ul>
<li><strong>GitHub 仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgithub%2Fspec-kit" target="_blank" title="https://github.com/github/spec-kit" ref="nofollow noopener noreferrer">github.com/github/spec…</a></li>
<li><strong>Stars</strong>：69.1k ⭐</li>
<li><strong>技术栈</strong>：Python (uv 包管理器)</li>
<li><strong>适用 AI</strong>：Claude Code、Copilot Agent 等</li>
</ul>
<h4 data-id="heading-4">1.2 核心概念</h4>
<p>Spec-Kit 引入了三个关键文档类型：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│                    CONSTITUTION<span class="hljs-selector-class">.md</span>                       │
│         (项目宪法：全局约束、技术栈、代码规范)            │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                       SPEC<span class="hljs-selector-class">.md</span>                            │
│           (功能规格：具体功能的详细设计)                  │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                      REVIEW<span class="hljs-selector-class">.md</span>                           │
│              (审查清单：验收标准和检查项)                 │
└─────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>CONSTITUTION.md</strong>（宪法）：定义项目级别的"不可违反"规则</p>
<ul>
<li>技术栈选择（如必须使用 TypeScript）</li>
<li>代码风格（如禁止使用 <code>any</code> 类型）</li>
<li>架构约束（如必须遵循 Clean Architecture）</li>
</ul>
<p><strong>SPEC.md</strong>（规格）：描述具体功能的实现细节</p>
<ul>
<li>功能目标</li>
<li>接口设计</li>
<li>数据结构</li>
<li>边界条件</li>
</ul>
<p><strong>REVIEW.md</strong>（审查清单）：AI 完成后的自检列表</p>
<ul>
<li>代码是否符合宪法</li>
<li>功能是否满足规格</li>
<li>测试覆盖率是否达标</li>
</ul>
<h4 data-id="heading-5">1.3 安装教程</h4>
<h5 data-id="heading-6">前置条件</h5>
<ul>
<li>Python 3.10+</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fastral-sh%2Fuv" target="_blank" title="https://github.com/astral-sh/uv" ref="nofollow noopener noreferrer">uv</a> 包管理器（推荐）</li>
</ul>
<h5 data-id="heading-7">安装步骤</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 安装 uv（如果还没有）</span>
curl -LsSf https://astral.sh/uv/install.sh | sh

<span class="hljs-comment"># 2. 克隆 Spec-Kit 仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/github/spec-kit.git
<span class="hljs-built_in">cd</span> spec-kit

<span class="hljs-comment"># 3. 安装依赖</span>
uv <span class="hljs-built_in">sync</span>

<span class="hljs-comment"># 4. 验证安装</span>
uv run spec-kit --version
</code></pre>
<h5 data-id="heading-8">快速初始化项目</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在你的项目根目录运行</span>
uv run spec-kit init

<span class="hljs-comment"># 这会创建以下文件结构：</span>
<span class="hljs-comment"># your-project/</span>
<span class="hljs-comment"># ├── .spec/</span>
<span class="hljs-comment"># │   ├── CONSTITUTION.md    # 项目宪法</span>
<span class="hljs-comment"># │   ├── specs/             # 功能规格目录</span>
<span class="hljs-comment"># │   │   └── example.md</span>
<span class="hljs-comment"># │   └── reviews/           # 审查清单目录</span>
<span class="hljs-comment"># │       └── example.md</span>
</code></pre>
<h4 data-id="heading-9">1.4 使用教程</h4>
<h5 data-id="heading-10">步骤一：编写 CONSTITUTION.md</h5>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Project Constitution</span>

<span class="hljs-section">## Technology Stack</span>
<span class="hljs-bullet">-</span> Language: TypeScript 5.x
<span class="hljs-bullet">-</span> Runtime: Node.js 20 LTS
<span class="hljs-bullet">-</span> Framework: Next.js 14 (App Router)
<span class="hljs-bullet">-</span> Database: PostgreSQL 15
<span class="hljs-bullet">-</span> ORM: Prisma

<span class="hljs-section">## Code Standards</span>
<span class="hljs-bullet">-</span> MUST use strict TypeScript (no <span class="hljs-code">`any`</span>)
<span class="hljs-bullet">-</span> MUST follow ESLint + Prettier config
<span class="hljs-bullet">-</span> MUST write tests before implementation (TDD)
<span class="hljs-bullet">-</span> MUST NOT use console.log in production code

<span class="hljs-section">## Architecture</span>
<span class="hljs-bullet">-</span> Follow Clean Architecture principles
<span class="hljs-bullet">-</span> Use repository pattern for data access
<span class="hljs-bullet">-</span> All business logic in /src/domain
<span class="hljs-bullet">-</span> All API handlers in /src/api
</code></pre>
<h5 data-id="heading-11">步骤二：为新功能编写 SPEC.md</h5>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Feature Spec: User Authentication</span>

<span class="hljs-section">## Goal</span>
Implement JWT-based authentication with refresh token rotation.

<span class="hljs-section">## Interfaces</span>

<span class="hljs-section">### POST /api/auth/login</span>

interface LoginRequest {
  email: string;
  password: string;
}

interface LoginResponse {
  accessToken: string;
  refreshToken: string;
  expiresIn: number;
}


<span class="hljs-section">### POST /api/auth/refresh</span>
<span class="hljs-code">```typescript
interface RefreshRequest {
  refreshToken: string;
}

interface RefreshResponse {
  accessToken: string;
  refreshToken: string; // rotated
  expiresIn: number;
}

## Security Requirements
- Access token expires in 15 minutes
- Refresh token expires in 7 days
- Refresh token rotation on every use
- Bcrypt for password hashing (cost factor 12)

## Edge Cases
- Invalid credentials: return 401
- Expired refresh token: return 401, require re-login
- Concurrent refresh attempts: only first succeeds
</span></code></pre>
<h5 data-id="heading-12">步骤三：让 AI 执行</h5>
<p>在 Claude Code 或其他 AI 工具中：</p>
<pre><code class="hljs language-bash" lang="bash">请根据 .spec/CONSTITUTION.md 和 .spec/specs/auth.md 实现用户认证功能。
实现完成后，根据 .spec/reviews/auth.md 进行自检。
</code></pre>
<h5 data-id="heading-13">步骤四：审查与迭代</h5>
<p>Spec-Kit 会生成审查报告，标记哪些检查项通过/失败：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Review: User Authentication</span>

<span class="hljs-section">## Constitution Compliance</span>
<span class="hljs-bullet">-</span> [x] TypeScript strict mode enabled
<span class="hljs-bullet">-</span> [x] No <span class="hljs-code">`any`</span> types used
<span class="hljs-bullet">-</span> [x] Tests written before implementation
<span class="hljs-bullet">-</span> [ ] ❌ Found console.log on line 45 of auth.service.ts

<span class="hljs-section">## Spec Compliance</span>
<span class="hljs-bullet">-</span> [x] Login endpoint implemented
<span class="hljs-bullet">-</span> [x] Refresh endpoint implemented
<span class="hljs-bullet">-</span> [x] Token rotation working
<span class="hljs-bullet">-</span> [ ] ❌ Missing: concurrent refresh protection
</code></pre>
<hr/>
<h3 data-id="heading-14">二、OpenSpec：轻量级规格增量管理</h3>
<h4 data-id="heading-15">2.1 简介</h4>
<p><strong>OpenSpec</strong> 是由 Fission-AI 团队开发的轻量级规格管理工具，专注于"规格增量"（Spec Deltas）的管理。与 Spec-Kit 的"重文档"理念不同，OpenSpec 更强调<strong>流动性和迭代性</strong>。</p>
<ul>
<li><strong>GitHub 仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFission-AI%2FOpenSpec" target="_blank" title="https://github.com/Fission-AI/OpenSpec" ref="nofollow noopener noreferrer">github.com/Fission-AI/…</a></li>
<li><strong>Stars</strong>：23.7k ⭐</li>
<li><strong>技术栈</strong>：TypeScript (npm)</li>
<li><strong>适用 AI</strong>：Claude Code、Cursor、Windsurf 等</li>
</ul>
<h4 data-id="heading-16">2.2 核心概念</h4>
<p>OpenSpec 的核心是 <strong>Spec Delta</strong>（规格增量）：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│                    Active Specs                          │
│              (当前生效的规格变更)                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                  │
│  │ Delta <span class="hljs-number">1</span> │  │ Delta <span class="hljs-number">2</span> │  │ Delta <span class="hljs-number">3</span> │                  │
│  └─────────┘  └─────────┘  └─────────┘                  │
└─────────────────────────────────────────────────────────┘
                            │
                            │ archive（归档）
                            ▼
┌─────────────────────────────────────────────────────────┐
│                    Archive (Knowledge Base)              │
│                    (历史规格，形成知识库)                 │
└─────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>工作流程</strong>：</p>
<ol>
<li>创建 Spec Delta（描述要实现的功能变更）</li>
<li>AI 根据 Delta 进行实现</li>
<li>实现完成后，将 Delta 归档到知识库</li>
<li>知识库成为项目的"记忆"，供后续参考</li>
</ol>
<h4 data-id="heading-17">2.3 安装教程</h4>
<h5 data-id="heading-18">前置条件</h5>
<ul>
<li>Node.js 18+</li>
<li>npm 或 pnpm</li>
</ul>
<h5 data-id="heading-19">安装步骤</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式一：全局安装</span>
npm install -g openspec

<span class="hljs-comment"># 方式二：项目级安装</span>
npm install --save-dev openspec

<span class="hljs-comment"># 方式三：使用 npx 直接运行</span>
npx openspec init
</code></pre>
<h5 data-id="heading-20">初始化项目</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在项目根目录运行</span>
openspec init

<span class="hljs-comment"># 这会创建以下结构：</span>
<span class="hljs-comment"># your-project/</span>
<span class="hljs-comment"># ├── .openspec/</span>
<span class="hljs-comment"># │   ├── config.json         # 配置文件</span>
<span class="hljs-comment"># │   ├── active/             # 当前活跃的规格</span>
<span class="hljs-comment"># │   └── archive/            # 归档的规格（知识库）</span>
</code></pre>
<h4 data-id="heading-21">2.4 使用教程</h4>
<h5 data-id="heading-22">步骤一：创建配置文件</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// .openspec/config.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"projectName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-awesome-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"ai"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-sonnet-4-20250514"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"templates"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"feature"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".openspec/templates/feature.md"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"bugfix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".openspec/templates/bugfix.md"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"archive"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"autoArchive"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"archiveOnMerge"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-23">步骤二：创建 Spec Delta</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建新的功能规格</span>
openspec new feature <span class="hljs-string">"Add user profile page"</span>

<span class="hljs-comment"># 这会生成 .openspec/active/feature-add-user-profile-page.md</span>
</code></pre>
<p>生成的模板：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Spec Delta: Add User Profile Page</span>

<span class="hljs-section">## Status: ACTIVE</span>
<span class="hljs-section">## Created: 2025-02-12</span>
<span class="hljs-section">## Author: developer</span>

---

<span class="hljs-section">## Summary</span>
Add a user profile page that displays user information and allows editing.

<span class="hljs-section">## Context</span>
Currently users cannot view or edit their profile information after registration.

<span class="hljs-section">## Requirements</span>

<span class="hljs-section">### Functional</span>
<span class="hljs-bullet">-</span> [ ] Display user avatar, name, email
<span class="hljs-bullet">-</span> [ ] Allow editing name and avatar
<span class="hljs-bullet">-</span> [ ] Show account creation date
<span class="hljs-bullet">-</span> [ ] Show last login time

<span class="hljs-section">### Non-Functional</span>
<span class="hljs-bullet">-</span> [ ] Page load time &lt; 2s
<span class="hljs-bullet">-</span> [ ] Mobile responsive
<span class="hljs-bullet">-</span> [ ] WCAG 2.1 AA compliant

<span class="hljs-section">## Technical Approach</span>
&lt;!-- AI will fill this based on codebase analysis --&gt;

<span class="hljs-section">## Files to Modify</span>
&lt;!-- AI will fill this --&gt;

<span class="hljs-section">## Tests Required</span>
&lt;!-- AI will fill this --&gt;

---

<span class="hljs-section">## Implementation Notes</span>
&lt;!-- AI fills this during implementation --&gt;

<span class="hljs-section">## Review Comments</span>
&lt;!-- Human reviewer adds comments here --&gt;
</code></pre>
<h5 data-id="heading-24">步骤三：让 AI 执行</h5>
<p>在 Claude Code 中：</p>
<pre><code class="hljs language-bash" lang="bash">请查看 .openspec/active/ 目录下的活跃规格，实现 <span class="hljs-string">"Add User Profile Page"</span> 功能。
实现时参考 .openspec/archive/ 中的历史规格了解项目惯例。
</code></pre>
<h5 data-id="heading-25">步骤四：归档完成的规格</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 实现完成后，归档规格</span>
openspec archive feature-add-user-profile-page

<span class="hljs-comment"># 这会将文件移动到 .openspec/archive/2025/02/</span>
<span class="hljs-comment"># 并添加完成时间戳和实现摘要</span>
</code></pre>
<h5 data-id="heading-26">步骤五：查询知识库</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 搜索历史规格</span>
openspec search <span class="hljs-string">"authentication"</span>

<span class="hljs-comment"># 查看某个归档规格的详情</span>
openspec show archive/2025/01/feature-user-auth.md
</code></pre>
<hr/>
<h3 data-id="heading-27">三、Superpowers：Claude Code 的"施工队工作手册"</h3>
<h4 data-id="heading-28">3.1 简介</h4>
<p><strong>Superpowers</strong> 是由 Jesse Vincent（obra）开发的 Claude Code 增强工具包，专注于<strong>执行方法论</strong>。它不是文档管理工具，而是一套让 AI 更高效、更可靠地执行编码任务的最佳实践集合。</p>
<ul>
<li><strong>GitHub 仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fobra%2Fsuperpowers" target="_blank" title="https://github.com/obra/superpowers" ref="nofollow noopener noreferrer">github.com/obra/superp…</a></li>
<li><strong>Stars</strong>：50k ⭐</li>
<li><strong>技术栈</strong>：Shell + JavaScript</li>
<li><strong>适用 AI</strong>：Claude Code（专属）</li>
</ul>
<h4 data-id="heading-29">3.2 核心概念</h4>
<p>Superpowers 的核心是 <strong>"让 AI 像高级工程师一样工作"</strong>：</p>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────┐
│                    Superpowers 方法论                    │
├─────────────────────────────────────────────────────────┤
│  🧪 TDD-First      │ 强制 AI 先写测试，再写实现          │
├─────────────────────────────────────────────────────────┤
│  🤖 Sub-Agents     │ 拆分复杂任务给专门的子代理          │
├─────────────────────────────────────────────────────────┤
│  📝 <span class="hljs-selector-tag">Code</span> Review    │ 实现后自动触发代码审查              │
├─────────────────────────────────────────────────────────┤
│  🔍 Exploration    │ 实现前先充分探索代码库              │
├─────────────────────────────────────────────────────────┤
│  ✅ Verification   │ 每步都要验证，不盲目前进            │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-30">3.3 安装教程</h4>
<h5 data-id="heading-31">前置条件</h5>
<ul>
<li>Claude Code CLI 已安装（<code>claude</code> 命令可用）</li>
<li>Bash 或 Zsh shell</li>
</ul>
<h5 data-id="heading-32">安装步骤</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/obra/superpowers.git ~/.claude/superpowers

<span class="hljs-comment"># 2. 运行安装脚本</span>
<span class="hljs-built_in">cd</span> ~/.claude/superpowers
./install.sh

<span class="hljs-comment"># 3. 验证安装</span>
claude /superpowers-help
</code></pre>
<p>安装脚本会自动：</p>
<ul>
<li>将自定义斜杠命令复制到 <code>~/.claude/commands/</code></li>
<li>将配置规则复制到 <code>~/.claude/rules/</code></li>
<li>设置必要的环境变量</li>
</ul>
<h5 data-id="heading-33">手动安装（可选）</h5>
<p>如果你想更精细地控制安装内容：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 只安装斜杠命令</span>
<span class="hljs-built_in">cp</span> -r ~/.claude/superpowers/commands/* ~/.claude/commands/

<span class="hljs-comment"># 只安装规则</span>
<span class="hljs-built_in">cp</span> -r ~/.claude/superpowers/rules/* ~/.claude/rules/

<span class="hljs-comment"># 只安装特定功能</span>
<span class="hljs-built_in">cp</span> ~/.claude/superpowers/commands/tdd.md ~/.claude/commands/
</code></pre>
<h4 data-id="heading-34">3.4 使用教程</h4>
<h5 data-id="heading-35">核心斜杠命令</h5>
<p>安装后，你可以在 Claude Code 中使用以下命令：</p>

































<table><thead><tr><th>命令</th><th>用途</th></tr></thead><tbody><tr><td><code>/tdd</code></td><td>启动 TDD 工作流</td></tr><tr><td><code>/implement</code></td><td>实现功能（自动包含探索、TDD、审查）</td></tr><tr><td><code>/review</code></td><td>对当前代码进行审查</td></tr><tr><td><code>/explore</code></td><td>探索代码库结构</td></tr><tr><td><code>/plan</code></td><td>创建实现计划</td></tr><tr><td><code>/verify</code></td><td>验证当前实现状态</td></tr></tbody></table>
<h5 data-id="heading-36">使用示例：TDD 工作流</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在 Claude Code 中</span>
claude

<span class="hljs-comment"># 启动 TDD 流程</span>
&gt; /tdd Add a rate limiter middleware

<span class="hljs-comment"># Claude 会自动：</span>
<span class="hljs-comment"># 1. 探索现有中间件结构</span>
<span class="hljs-comment"># 2. 编写失败的测试用例</span>
<span class="hljs-comment"># 3. 运行测试确认失败</span>
<span class="hljs-comment"># 4. 实现最小代码使测试通过</span>
<span class="hljs-comment"># 5. 重构优化</span>
<span class="hljs-comment"># 6. 运行代码审查</span>
</code></pre>
<h5 data-id="heading-37">使用示例：完整实现流程</h5>
<pre><code class="hljs language-bash" lang="bash">&gt; /implement Add user notification system

<span class="hljs-comment"># Superpowers 会引导 Claude 执行：</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 📍 Phase 1: Exploration</span>
<span class="hljs-comment"># - 扫描现有通知相关代码</span>
<span class="hljs-comment"># - 理解数据库模型</span>
<span class="hljs-comment"># - 查看 API 模式</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 📍 Phase 2: Planning</span>
<span class="hljs-comment"># - 生成实现计划</span>
<span class="hljs-comment"># - 识别需要修改的文件</span>
<span class="hljs-comment"># - 评估影响范围</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 📍 Phase 3: TDD Implementation</span>
<span class="hljs-comment"># - 编写测试用例</span>
<span class="hljs-comment"># - 逐步实现功能</span>
<span class="hljs-comment"># - 持续验证</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 📍 Phase 4: Review</span>
<span class="hljs-comment"># - 代码质量检查</span>
<span class="hljs-comment"># - 安全性审查</span>
<span class="hljs-comment"># - 性能评估</span>
</code></pre>
<h5 data-id="heading-38">使用示例：子代理委托</h5>
<p>对于复杂任务，Superpowers 支持子代理模式：</p>
<pre><code class="hljs language-bash" lang="bash">&gt; /implement Add full-text search with Elasticsearch

<span class="hljs-comment"># Claude 会拆分任务：</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 🤖 Sub-Agent 1: Schema Design</span>
<span class="hljs-comment">#    - 设计 Elasticsearch 索引映射</span>
<span class="hljs-comment">#    - 定义搜索字段权重</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 🤖 Sub-Agent 2: Integration Layer</span>
<span class="hljs-comment">#    - 实现 ES 客户端封装</span>
<span class="hljs-comment">#    - 编写数据同步逻辑</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 🤖 Sub-Agent 3: API Implementation</span>
<span class="hljs-comment">#    - 实现搜索 API 端点</span>
<span class="hljs-comment">#    - 添加分页和过滤</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 🤖 Sub-Agent 4: Testing</span>
<span class="hljs-comment">#    - 编写集成测试</span>
<span class="hljs-comment">#    - 性能基准测试</span>
</code></pre>
<h4 data-id="heading-39">3.5 自定义配置</h4>
<p>你可以在 <code>~/.claude/rules/</code> 中添加自定义规则：</p>
<pre><code class="hljs language-markdown" lang="markdown">&lt;!-- ~/.claude/rules/my-project.md --&gt;

<span class="hljs-section"># Project-Specific Rules</span>

<span class="hljs-section">## Code Style</span>
<span class="hljs-bullet">-</span> Use functional components only (no class components)
<span class="hljs-bullet">-</span> Prefer <span class="hljs-code">`const`</span> over <span class="hljs-code">`let`</span>
<span class="hljs-bullet">-</span> Use named exports, not default exports

<span class="hljs-section">## Testing</span>
<span class="hljs-bullet">-</span> Minimum 80% coverage for new code
<span class="hljs-bullet">-</span> Use React Testing Library, not Enzyme
<span class="hljs-bullet">-</span> Mock external APIs in tests

<span class="hljs-section">## Git</span>
<span class="hljs-bullet">-</span> Use conventional commits
<span class="hljs-bullet">-</span> Squash before merge
<span class="hljs-bullet">-</span> No force push to main
</code></pre>
<hr/>
<h3 data-id="heading-40">四、三者对比分析</h3>
<h4 data-id="heading-41">4.1 核心对比表</h4>



























































<table><thead><tr><th>维度</th><th>Spec-Kit</th><th>OpenSpec</th><th>Superpowers</th></tr></thead><tbody><tr><td><strong>维护方</strong></td><td>GitHub 官方</td><td>Fission-AI</td><td>obra (社区)</td></tr><tr><td><strong>Stars</strong></td><td>69.1k</td><td>23.7k</td><td>50k</td></tr><tr><td><strong>技术栈</strong></td><td>Python (uv)</td><td>TypeScript (npm)</td><td>Shell/JS</td></tr><tr><td><strong>核心理念</strong></td><td>规格即法律</td><td>增量流动</td><td>方法论驱动</td></tr><tr><td><strong>文档量</strong></td><td>重（宪法+规格+审查）</td><td>中（Delta 即用即归档）</td><td>轻（规则文件）</td></tr><tr><td><strong>学习曲线</strong></td><td>较陡</td><td>平缓</td><td>中等</td></tr><tr><td><strong>适用项目</strong></td><td>大型/合规要求高</td><td>中小型/快速迭代</td><td>所有规模</td></tr><tr><td><strong>AI 绑定</strong></td><td>通用</td><td>通用</td><td>Claude Code 专属</td></tr></tbody></table>
<h4 data-id="heading-42">4.2 工作流对比</h4>
<pre><code class="hljs language-rust" lang="rust">Spec-Kit 工作流（瀑布式）：
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  宪法   │ <span class="hljs-punctuation">-&gt;</span> │  规格   │ <span class="hljs-punctuation">-&gt;</span> │  实现   │ <span class="hljs-punctuation">-&gt;</span> │  审查   │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
   立法          立项          施工          验收

OpenSpec 工作流（增量式）：
┌─────────┐    ┌─────────┐    ┌─────────┐
│ Delta <span class="hljs-number">1</span> │ <span class="hljs-punctuation">-&gt;</span> │  实现   │ <span class="hljs-punctuation">-&gt;</span> │  归档   │ ─┐
└─────────┘    └─────────┘    └─────────┘  │
                                           │
┌─────────┐    ┌─────────┐    ┌─────────┐  │
│ Delta <span class="hljs-number">2</span> │ <span class="hljs-punctuation">-&gt;</span> │  实现   │ <span class="hljs-punctuation">-&gt;</span> │  归档   │ ─┼─&gt; 知识库
└─────────┘    └─────────┘    └─────────┘  │
                                           │
                     ...                   │
                                           ▼
                                    ┌─────────────┐
                                    │ 历史参考    │
                                    └─────────────┘

Superpowers 工作流（TDD 螺旋）：
           ┌─────────────────────────────────┐
           │                                 │
           ▼                                 │
    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │  探索   │ <span class="hljs-punctuation">-&gt;</span> │写测试   │ <span class="hljs-punctuation">-&gt;</span> │  实现   │
    └─────────┘    └─────────┘    └─────────┘
                        │              │
                        ▼              │
                   ┌─────────┐         │
                   │运行测试 │ ────────┘
                   └─────────┘   失败则迭代
                        │
                        ▼ 通过
                   ┌─────────┐
                   │代码审查 │
                   └─────────┘
</code></pre>
<h4 data-id="heading-43">4.3 适用场景对比</h4>








































<table><thead><tr><th>场景</th><th>推荐工具</th><th>原因</th></tr></thead><tbody><tr><td>金融/医疗/合规项目</td><td>Spec-Kit</td><td>需要完整文档链和审计轨迹</td></tr><tr><td>初创公司快速迭代</td><td>OpenSpec</td><td>轻量级，不拖慢开发节奏</td></tr><tr><td>日常 Claude Code 使用</td><td>Superpowers</td><td>即插即用，提升 AI 执行质量</td></tr><tr><td>开源项目</td><td>Spec-Kit + OpenSpec</td><td>需要清晰的贡献规范和变更追踪</td></tr><tr><td>个人 Side Project</td><td>Superpowers</td><td>零配置，立即提升效率</td></tr><tr><td>大型团队协作</td><td>三者组合</td><td>分层治理，各司其职</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-44">五、三工具协同：最佳实践方案</h3>
<h4 data-id="heading-45">5.1 协同架构</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌───────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                      <span class="hljs-string">项目治理层</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">┌─────────────────────────────────────────────────────┐</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">│</span>              <span class="hljs-attr">Spec-Kit:</span> <span class="hljs-string">CONSTITUTION.md</span>              <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">│</span>                  <span class="hljs-string">(项目宪法/全局约束)</span>                  <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">└─────────────────────────────────────────────────────┘</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                              <span class="hljs-string">│</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────────────────────│────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌───────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                      <span class="hljs-string">规格管理层</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">┌─────────────────────────────────────────────────────┐</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">│</span>              <span class="hljs-attr">OpenSpec:</span> <span class="hljs-string">Spec</span> <span class="hljs-string">Deltas</span>                  <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">│</span>                 <span class="hljs-string">(功能规格/变更管理)</span>                   <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">└─────────────────────────────────────────────────────┘</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                              <span class="hljs-string">│</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────────────────────│────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌───────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                      <span class="hljs-string">执行方法层</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">┌─────────────────────────────────────────────────────┐</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">│</span>              <span class="hljs-attr">Superpowers:</span> <span class="hljs-string">TDD</span> <span class="hljs-string">+</span> <span class="hljs-string">Review</span>              <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">│</span>                  <span class="hljs-string">(AI</span> <span class="hljs-string">执行方法论)</span>                      <span class="hljs-string">│</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">└─────────────────────────────────────────────────────┘</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                               <span class="hljs-string">│</span>
<span class="hljs-string">└───────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h4 data-id="heading-46">5.2 实战工作流</h4>
<p>假设我们要为一个电商项目添加"优惠券系统"：</p>
<h5 data-id="heading-47">Phase 1：立法（Spec-Kit）</h5>
<p>确保 CONSTITUTION.md 包含相关约束：</p>
<pre><code class="hljs language-markdown" lang="markdown">&lt;!-- .spec/CONSTITUTION.md 追加内容 --&gt;

<span class="hljs-section">## Coupon System Constraints</span>

<span class="hljs-section">### Business Rules</span>
<span class="hljs-bullet">-</span> Coupon codes must be unique and case-insensitive
<span class="hljs-bullet">-</span> Maximum discount cannot exceed order total
<span class="hljs-bullet">-</span> Coupons cannot be combined unless explicitly allowed

<span class="hljs-section">### Technical Requirements</span>
<span class="hljs-bullet">-</span> Use Redis for coupon validation caching
<span class="hljs-bullet">-</span> Implement idempotent coupon application
<span class="hljs-bullet">-</span> Log all coupon usage for audit trail
</code></pre>
<h5 data-id="heading-48">Phase 2：立项（OpenSpec）</h5>
<p>创建功能规格 Delta：</p>
<pre><code class="hljs language-bash" lang="bash">openspec new feature <span class="hljs-string">"Implement coupon system"</span>
</code></pre>
<p>编写详细规格：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Spec Delta: Implement Coupon System</span>

<span class="hljs-section">## Summary</span>
Add a complete coupon system with creation, validation, and application.

<span class="hljs-section">## Requirements</span>

<span class="hljs-section">### API Endpoints</span>
<span class="hljs-bullet">-</span> POST /api/coupons - Create coupon (admin)
<span class="hljs-bullet">-</span> GET /api/coupons/:code - Validate coupon
<span class="hljs-bullet">-</span> POST /api/orders/:id/apply-coupon - Apply to order

<span class="hljs-section">### Data Model</span>

interface Coupon {
  id: string;
  code: string;
  type: 'percentage' | 'fixed';
  value: number;
  minOrderAmount?: number;
  maxDiscountAmount?: number;
  usageLimit?: number;
  usedCount: number;
  validFrom: Date;
  validUntil: Date;
  isActive: boolean;
}

<span class="hljs-section">### Business Logic</span>
<span class="hljs-bullet">-</span> Validate coupon existence and status
<span class="hljs-bullet">-</span> Check usage limits
<span class="hljs-bullet">-</span> Calculate discount based on type
<span class="hljs-bullet">-</span> Apply to order with audit logging

<span class="hljs-section">## Acceptance Criteria</span>
<span class="hljs-bullet">-</span> [ ] Admin can create coupons
<span class="hljs-bullet">-</span> [ ] Users can validate coupon codes
<span class="hljs-bullet">-</span> [ ] Discount calculated correctly
<span class="hljs-bullet">-</span> [ ] Usage limits enforced
<span class="hljs-bullet">-</span> [ ] Audit trail complete
</code></pre>
<h5 data-id="heading-49">Phase 3：施工（Superpowers）</h5>
<p>在 Claude Code 中执行：</p>
<pre><code class="hljs language-bash" lang="bash">claude

&gt; 请先阅读 .spec/CONSTITUTION.md 了解项目约束，
&gt; 然后查看 .openspec/active/feature-implement-coupon-system.md 了解功能需求。

&gt; /implement Coupon system based on the active spec
</code></pre>
<p>Superpowers 会自动：</p>
<ol>
<li>
<p><strong>探索阶段</strong></p>
<ul>
<li>分析现有订单系统结构</li>
<li>查看 Redis 配置</li>
<li>理解审计日志模式</li>
</ul>
</li>
<li>
<p><strong>TDD 阶段</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 先写测试</span>
<span class="hljs-title function_">describe</span>(<span class="hljs-string">'CouponService'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should validate active coupon'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> coupon = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createTestCoupon</span>({ <span class="hljs-attr">code</span>: <span class="hljs-string">'TEST20'</span> });
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> couponService.<span class="hljs-title function_">validate</span>(<span class="hljs-string">'TEST20'</span>);
    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">valid</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should reject expired coupon'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> coupon = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createTestCoupon</span>({ 
      <span class="hljs-attr">code</span>: <span class="hljs-string">'EXPIRED'</span>,
      <span class="hljs-attr">validUntil</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2020-01-01'</span>)
    });
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> couponService.<span class="hljs-title function_">validate</span>(<span class="hljs-string">'EXPIRED'</span>);
    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">valid</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">reason</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'COUPON_EXPIRED'</span>);
  });

  <span class="hljs-comment">// ... 更多测试</span>
});
</code></pre>
</li>
<li>
<p><strong>实现阶段</strong></p>
<ul>
<li>实现 CouponService</li>
<li>实现 API 端点</li>
<li>集成 Redis 缓存</li>
<li>添加审计日志</li>
</ul>
</li>
<li>
<p><strong>审查阶段</strong></p>
<ul>
<li>检查是否符合 CONSTITUTION 约束</li>
<li>验证所有测试通过</li>
<li>评估代码质量</li>
</ul>
</li>
</ol>
<h5 data-id="heading-50">Phase 4：归档与验收</h5>
<p>实现完成后：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 归档 OpenSpec</span>
openspec archive feature-implement-coupon-system

<span class="hljs-comment"># 更新 Spec-Kit 审查清单</span>
<span class="hljs-comment"># Claude 会自动填写 .spec/reviews/coupon-system.md</span>
</code></pre>
<h4 data-id="heading-51">5.3 配置集成</h4>
<p>为了让三个工具无缝协作，推荐以下配置：</p>
<pre><code class="hljs language-markdown" lang="markdown">&lt;!-- ~/.claude/rules/spec-integration.md --&gt;

<span class="hljs-section"># Spec Integration Rules</span>

<span class="hljs-section">## Before Implementation</span>
<span class="hljs-bullet">1.</span> ALWAYS read .spec/CONSTITUTION.md first
<span class="hljs-bullet">2.</span> Check .openspec/active/ for current spec
<span class="hljs-bullet">3.</span> Reference .openspec/archive/ for historical context

<span class="hljs-section">## During Implementation</span>
<span class="hljs-bullet">1.</span> Follow Superpowers TDD workflow
<span class="hljs-bullet">2.</span> Ensure all CONSTITUTION constraints are met
<span class="hljs-bullet">3.</span> Update spec delta with implementation notes

<span class="hljs-section">## After Implementation</span>
<span class="hljs-bullet">1.</span> Run Superpowers code review
<span class="hljs-bullet">2.</span> Verify against spec acceptance criteria
<span class="hljs-bullet">3.</span> Archive completed spec to OpenSpec
</code></pre>
<hr/>
<h3 data-id="heading-52">六、总结与建议</h3>
<h4 data-id="heading-53">6.1 工具选择指南</h4>
<pre><code class="hljs language-erlang" lang="erlang">你的项目是...

├─ 大型企业项目/合规要求高
│  └─ 推荐：Spec-Kit（主） + Superpowers（执行）
│
├─ 初创公司/快速迭代
│  └─ 推荐：OpenSpec（主） + Superpowers（执行）
│
├─ 个人项目/Side Project
│  └─ 推荐：Superpowers（单独使用即可）
│
├─ 开源项目/社区协作
│  └─ 推荐：Spec-Kit（贡献规范） + OpenSpec（变更追踪）
│
└─ 追求极致/不差钱
   └─ 推荐：三者组合使用
</code></pre>
<h4 data-id="heading-54">6.2 学习路径建议</h4>
<ol>
<li><strong>入门</strong>：先从 Superpowers 开始，立即体验 AI 效率提升</li>
<li><strong>进阶</strong>：引入 OpenSpec 管理功能迭代</li>
<li><strong>精通</strong>：使用 Spec-Kit 建立完整的规格治理体系</li>
</ol>
<h4 data-id="heading-55">6.3 未来展望</h4>
<p>AI 编程工具正在从"代码补全"向"自主工程"演进。Spec-Kit、OpenSpec、Superpowers 代表了三种不同的思路，但最终目标一致：<strong>让 AI 成为可靠的工程伙伴，而非需要时刻看管的实习生</strong>。</p>
<p>随着这些工具的成熟，我们有理由相信，"规格驱动 + AI 执行"将成为软件开发的新范式。现在开始学习和实践，就是在为未来的开发方式做准备。</p>
<hr/>
<h3 data-id="heading-56">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgithub%2Fspec-kit" target="_blank" title="https://github.com/github/spec-kit" ref="nofollow noopener noreferrer">Spec-Kit GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFission-AI%2FOpenSpec" target="_blank" title="https://github.com/Fission-AI/OpenSpec" ref="nofollow noopener noreferrer">OpenSpec GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fobra%2Fsuperpowers" target="_blank" title="https://github.com/obra/superpowers" ref="nofollow noopener noreferrer">Superpowers GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.blog%2Fai-and-ml%2Fgenerative-ai%2Fspec-driven-development-with-ai-get-started-with-a-new-open-source-toolkit%2F" target="_blank" title="https://github.blog/ai-and-ml/generative-ai/spec-driven-development-with-ai-get-started-with-a-new-open-source-toolkit/" ref="nofollow noopener noreferrer">GitHub Blog: Spec-Driven Development</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhashrocket.com%2Fblog%2Fposts%2Fopenspec-vs-spec-kit-choosing-the-right-ai-driven-development-workflow-for-your-team" target="_blank" title="https://hashrocket.com/blog/posts/openspec-vs-spec-kit-choosing-the-right-ai-driven-development-workflow-for-your-team" ref="nofollow noopener noreferrer">OpenSpec vs Spec Kit 对比</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Frexai.top%2Fposts%2Fclaude-code-superpowers-beginner-guide%2F" target="_blank" title="https://rexai.top/posts/claude-code-superpowers-beginner-guide/" ref="nofollow noopener noreferrer">Superpowers 入门指南</a></li>
</ul>
<hr/>
<blockquote>
<p>如果这篇文章对你有帮助，欢迎点赞、收藏、关注！有问题欢迎在评论区讨论 🚀</p>
<p>Happy Coding！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[KingbaseES 文档数据实践：MongoDB 兼容性评估与替换落地]]></title>    <link>https://juejin.cn/post/7605468286181146659</link>    <guid>https://juejin.cn/post/7605468286181146659</guid>    <pubDate>2026-02-12T06:34:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605468286181146659" data-draft-id="7605469747259424803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="KingbaseES 文档数据实践：MongoDB 兼容性评估与替换落地"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-02-12T06:34:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            KingbaseES 文档数据实践：MongoDB 兼容性评估与替换落地
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:34:09.000Z" title="Thu Feb 12 2026 06:34:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这篇写给“真要替”的人：你手上有一套 MongoDB 业务，准备收敛到金仓数据库（KingbaseES），但又不想把风险全押在一句“兼容”上。我更习惯用工程的方式把事情说透：先把适用场景划清楚，再把能在 Windows + ksql 上跑通的实操摆出来，最后再用一套验收口径把闭环做完整。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1317ebde8c74c899868fd92fbb98cc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482848&amp;x-signature=D6WoI3z6ODOqDicEgG4BSNwwMJI%3D" alt="b4ef576cf0b37496233bc33120c755fb.jpg" loading="lazy"/></p>
<p>@[toc]</p>
<hr/>
<h2 data-id="heading-0">1. 所谓“MongoDB兼容”，到底兼容到哪</h2>
<p>在项目里聊“MongoDB 兼容性”，我一般会先把它拆成三层，不然讨论很容易跑偏：</p>
<ol>
<li><strong>数据模型层</strong>：文档（JSON）能不能自然存、能不能自然查、能不能自然更新；</li>
<li><strong>查询能力层</strong>：常用的过滤、投影、排序、分页、聚合，能不能用一套可维护的方式落地；</li>
<li><strong>工程与运维层</strong>：迁移能不能跑通、回滚怎么做、性能瓶颈怎么定位、上线窗口怎么控住。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a90019de9444c8f9d23287996d56b6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482848&amp;x-signature=DQhho8Pklu15L5j3CQjEBe2iJ18%3D" alt="0d5268c5b09e63f987d2e92b79a8fdc3.jpg" loading="lazy"/></li>
</ol>
<hr/>
<h2 data-id="heading-1">2. 适用场景：哪些 MongoDB 业务我更愿意往金仓上收敛</h2>
<p>如果你的 MongoDB 主要在做下面这些事，往金仓上收敛通常会更顺手：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec80bdc6c40049168e2aaea74f1cb0d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482848&amp;x-signature=lYdAhSyV2UtCfRvG2D3fNMT2EPw%3D" alt="bc3cd6fdfc6f782dd186e06eda2a0c4f.png" loading="lazy"/></p>
<ul>
<li><strong>“结构不稳定但要强一致”的业务数据</strong>：比如订单扩展字段、风控标签、业务规则快照；一边是 JSON 形态灵活，另一边又需要事务一致性、审计、对账。</li>
<li><strong>文档只是“附加信息”</strong>：主链路是关系表（用户、订单、账务），文档更多是扩展属性或请求/响应留痕。</li>
<li><strong>查询模式可控</strong>：大部分查询集中在几个字段上（比如 <code>type/status/uid/时间</code>），而不是任意字段随便查。</li>
<li><strong>容量与吞吐在可控范围</strong>：你不依赖“自动分片+横向扩容”这种文档库的分布式特性，更多需要的是稳定、可管、可审计。</li>
</ul>
<p>反过来，如果你特别依赖文档库的分布式写入吞吐、天然分片/自动均衡能力，那评估阶段就得把这点写进风险清单：<strong>别指望靠一列 JSON 就去硬扛“分布式文档库”的定位</strong>。到底能不能替，最后看的是业务负载和 SLA，而不是看一个类型名。</p>
<hr/>
<h2 data-id="heading-2">3. 兼容性拆解：从 MongoDB 文档到金仓 JSONB 的映射思路</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6194cc0afa37482584f3651ce92cebe7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482848&amp;x-signature=Uuurcw8ZX9yf3kQTFDh51TbzxnE%3D" alt="0a1363cf20c58e5ef2b1ae12380e8a86.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3">4. Windows + ksql 实操：用一张表把“存、查、改、索引”跑通</h2>
<p>我的环境是 Windows 且在 ksql 上操作，下面所有演示默认满足：</p>
<ul>
<li>Windows 已安装 KingbaseES，并创建了 Oracle 模式实例</li>
<li>你能在 PowerShell / Windows Terminal 中执行 <code>ksql</code></li>
</ul>
<p>如果你在这一步就卡住了（端口不通、服务没起来、ksql 连不上），我之前整理过一篇从安装到连通性验证的笔记，按步骤走基本不会翻车：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fstubborn-stone.blog.csdn.net%2Farticle%2Fdetails%2F152138538" target="_blank" title="https://stubborn-stone.blog.csdn.net/article/details/152138538" ref="nofollow noopener noreferrer">Windows 安装 KingbaseES V9R1C10 与 Oracle 兼容特性实战</a></p>
<p>概念解释我就不在这里铺开了，先把环境确认下来更重要：只要你能在 ksql 里把关键语法跑起来，后面这些实操才算“落地”。</p>
<p>下面所有命令都按 Windows 环境、ksql 客户端来写（复制 SQL 本体即可）。</p>
<h3 data-id="heading-4">4.1 连接数据库</h3>
<pre><code class="hljs language-bash" lang="bash">ksql -h 127.0.0.1 -p 54321 -U system -d <span class="hljs-built_in">test</span>
</code></pre>
<p>端口这块按你的实例来，我这边 Oracle 兼容版用的是 54322，所以截图里会看到 54322。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8dca4a7651664b9ea267b7b04dc095bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482848&amp;x-signature=MmH2ofnDh0nZZyFniP%2FYjuixIj0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">4.2 建表：一列 JSONB + 一列主键 + 一列高频冗余字段</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> t_user_doc;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_user_doc(
  user_id     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">PRIMARY</span> KEY,
  doc_type    <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  doc         JSONB <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  updated_at  <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
);
</code></pre>
<p>我这里把 <code>doc_type</code> 单独冗余出来，是因为它通常就是最高频的过滤条件之一。把它做成普通列再建索引，比每次都从 JSONB 里解析要稳得多。</p>
<h3 data-id="heading-6">4.3 插入文档：用 JSONB 直接落库</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_user_doc(user_id, doc_type, doc)
<span class="hljs-keyword">VALUES</span>
(<span class="hljs-string">'u001'</span>, <span class="hljs-string">'profile'</span>, <span class="hljs-string">'{"name":"张三","age":28,"tags":["vip","beta"],"city":"南京"}'</span>::jsonb),
(<span class="hljs-string">'u002'</span>, <span class="hljs-string">'profile'</span>, <span class="hljs-string">'{"name":"李四","age":35,"tags":["vip"],"city":"上海"}'</span>::jsonb),
(<span class="hljs-string">'u003'</span>, <span class="hljs-string">'event'</span>,   <span class="hljs-string">'{"event":"login","ip":"10.2.3.4","device":{"os":"windows","ver":"11"}}'</span>::jsonb);

<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<h3 data-id="heading-7">4.4 查询：按键/键值对过滤（更接近文档库的使用方式）</h3>
<p>在金仓的 JSONB 操作符里，<code>@&gt;</code> 表示“左边的 JSONB 在顶层是否包含右边的路径/值项”，<code>?</code> 表示“某个键是否存在”。用这两类条件写查询，会更贴近文档库里那种“按字段过滤”的习惯[</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查 profile 且 city=上海 的用户</span>
<span class="hljs-keyword">SELECT</span> user_id
<span class="hljs-keyword">FROM</span> t_user_doc
<span class="hljs-keyword">WHERE</span> doc_type <span class="hljs-operator">=</span> <span class="hljs-string">'profile'</span>
  <span class="hljs-keyword">AND</span> doc @<span class="hljs-operator">&gt;</span> <span class="hljs-string">'{"city":"上海"}'</span>::jsonb
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> user_id;

<span class="hljs-comment">-- 查 doc 顶层是否存在 tags 键</span>
<span class="hljs-keyword">SELECT</span> user_id
<span class="hljs-keyword">FROM</span> t_user_doc
<span class="hljs-keyword">WHERE</span> doc ? <span class="hljs-string">'tags'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> user_id;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db4403202995481e8257a4e9f0530121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482848&amp;x-signature=KCnbVoAED5EnlpRaE4Jvriv5edY%3D" alt="image.png" loading="lazy"/></p>
<p>如果你要把某个字段“抽出来当文本/数字”做排序或聚合，我建议写法上把类型转换摆在明面上，别把隐式转换的坑留到线上才踩：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 按 age 排序（示例：把 doc 里的 age 转成整数）</span>
<span class="hljs-keyword">SELECT</span> user_id, doc
<span class="hljs-keyword">FROM</span> t_user_doc
<span class="hljs-keyword">WHERE</span> doc_type <span class="hljs-operator">=</span> <span class="hljs-string">'profile'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> (doc<span class="hljs-operator">-</span><span class="hljs-operator">&gt;&gt;</span><span class="hljs-string">'age'</span>)::<span class="hljs-type">int</span> <span class="hljs-keyword">DESC</span>;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e505bd526e9444a1a72855ac95f39e2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482848&amp;x-signature=FanFC1e%2Bg5HmPjl%2FYgspRjxXblA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">4.5 索引：给 JSONB 上 GIN，让“按键/键值对查”不再纯靠全表扫</h3>
<p>手册里明确提到：<code>GIN</code> 索引可用于在大量 JSONB 文档中高效搜索键或键值对，并且也提到了不同操作符类在性能/灵活性上的取舍[^kb-json-datatypes]。这里先用默认做一版最稳：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> INDEX idx_t_user_doc_doc_gin <span class="hljs-keyword">ON</span> t_user_doc <span class="hljs-keyword">USING</span> GIN (doc);
</code></pre>
<p>索引建完以后，建议用执行计划确认一下是否真的走了索引（别凭感觉）：</p>
<pre><code class="hljs language-sql" lang="sql">EXPLAIN ANALYZE
<span class="hljs-keyword">SELECT</span> user_id
<span class="hljs-keyword">FROM</span> t_user_doc
<span class="hljs-keyword">WHERE</span> doc @<span class="hljs-operator">&gt;</span> <span class="hljs-string">'{"city":"上海"}'</span>::jsonb;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4789b4aa3664ee09bdbf5f3c47e65bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482848&amp;x-signature=1oJr%2BbAIn5JFel1VVxpwYerT0SA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">4.6 更新：只改文档里的某一块（把“局部更新”写成可维护的 SQL）</h3>
<p>文档库里大家都喜欢“改一个字段就完事”。在金仓里也能做到类似效果：用 JSONB 的拼接/删除等操作符，把更新范围写清楚，后面维护也省心[^kb-json-operators]。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 给 u001 的文档追加一个字段（示例：last_login）</span>
<span class="hljs-keyword">UPDATE</span> t_user_doc
<span class="hljs-keyword">SET</span> doc <span class="hljs-operator">=</span> doc <span class="hljs-operator">||</span> <span class="hljs-string">'{"last_login":"2026-02-04 10:00:00"}'</span>::jsonb,
    updated_at <span class="hljs-operator">=</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-string">'u001'</span>;

<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b22d1afac22a47b4ab2a110989cfdb96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771482848&amp;x-signature=avsQJr7thpDiDJjCg%2FhzzbEg6aw%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-10">5. 迁移步骤：从 MongoDB 导出到金仓落库（可回放、可重跑）</h2>
<p>迁移这块我更推荐拆成“可重复执行”的三段：导出、落地、验证。别一次性脚本跑到底，出了问题你会发现最难受的不是修，而是没法回放、没法重跑。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
  A[梳理集合与查询模式&lt;br/&gt;字段使用频率/索引/容量] --&gt; B[定义落地模型&lt;br/&gt;主键 + JSONB + 冗余列]
  B --&gt; C[MongoDB 导出&lt;br/&gt;JSON Lines/分片文件]
  C --&gt; D[目标库落地&lt;br/&gt;staging text -&gt; cast jsonb]
  D --&gt; E[一致性验证&lt;br/&gt;行数/抽样/关键查询回归]
  E --&gt; F{通过?}
  F -- 否 --&gt; G[定位与重跑&lt;br/&gt;按文件/按窗口回放]
  G --&gt; D
  F -- 是 --&gt; H[灰度切换&lt;br/&gt;双写/只读/回滚预案]
</code></pre>
<h3 data-id="heading-11">5.1 导出：建议用 JSON Lines（每行一个文档），方便分片与回放</h3>
<p>导出方式你们团队怎么习惯都行，我只盯两点：</p>
<ul>
<li><strong>一行一个文档</strong>，方便按文件/按批次回放</li>
<li><strong>保留原始 <code>_id</code></strong>，迁移后方便做抽样对照</li>
</ul>
<h3 data-id="heading-12">5.2 落库：先落 staging（文本），再显式 cast 成 JSONB</h3>
<p>先建两张表：一张 staging 用来接文件，一张目标表用来承载 JSONB：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> stg_mongo_doc;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> stg_mongo_doc(
  user_id  <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>),
  doc_type <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>),
  doc_raw  TEXT
);
</code></pre>
<p>用 ksql 的 <code>\copy</code> 把文件导入 staging（示例：tab 分隔，Windows 路径记得用双反斜杠或直接用单引号包裹）：</p>
<pre><code class="hljs language-sql" lang="sql">\<span class="hljs-keyword">copy</span> stg_mongo_doc(user_id, doc_type, doc_raw) <span class="hljs-keyword">FROM</span> <span class="hljs-string">'D:\\mig\\user_doc.tsv'</span> <span class="hljs-keyword">WITH</span> (FORMAT csv, DELIMITER E<span class="hljs-string">'\t'</span>, HEADER <span class="hljs-literal">true</span>)
</code></pre>
<p>再把 staging 的 <code>doc_raw</code> 显式转成 JSONB 写入目标表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_user_doc(user_id, doc_type, doc)
<span class="hljs-keyword">SELECT</span> user_id, doc_type, doc_raw::jsonb
<span class="hljs-keyword">FROM</span> stg_mongo_doc;

<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<p>这种“两段式”落地的好处是：一旦遇到脏数据（JSON 语法不合法），你能很快定位到具体哪一行、哪个文件、哪个批次；而不是整套迁移脚本跑到一半炸掉，剩下的只能靠猜。</p>
<hr/>
<h2 data-id="heading-13">6. 应用案例：我见过最“值回票价”的三类替换</h2>
<h3 data-id="heading-14">6.1 订单扩展字段：交易表稳住，文档当扩展</h3>
<p>做电商/交易系统时，订单核心字段（金额、状态、时间）天然适合关系型；但扩展字段（渠道参数、风控标签、营销命中规则）经常变。<br/>
做法就是：订单主表走关系字段，扩展字段用 <code>JSONB</code> 挂在同一个库里，避免跨库一致性问题。</p>
<h3 data-id="heading-15">6.2 用户画像/配置中心：结构常变但查询很固定</h3>
<p>画像的字段多、变更频繁，但业务查询往往只盯几个条件：<code>tag/city/level/更新时间</code>。<br/>
这种“字段多但用得少”的模型，用 <code>JSONB + 冗余列 + 索引</code> 很容易跑得又稳又省事。</p>
<h3 data-id="heading-16">6.3 审计留痕：可追溯比“写得快”更重要</h3>
<p>很多系统要保留请求/响应、变更前后快照。你不一定需要在文档库里做复杂查询，更多是“存得下、查得到、可审计”。<br/>
把审计数据落在同一个数据库里，反而更好管控权限、备份与验收口径。</p>
<hr/>
<h2 data-id="heading-17">7. 兼容性坑点清单：不提前说清楚，后面一定会还债</h2>
<p>文档库中，“没有这个字段”和“字段存在但值为 null”常常被当作同一件事对待，但在转为 SQL 查询的时候，务必在条件里予以区分。</p>
<p>数值精度：JSONB 对数字类型的范围和精度存在限制，手册清楚表明，超出数据库 numeric 范围的数字将会被拒收，JSON 文本类型则不然，迁移之前需专门考量大数/高精度字段。</p>
<p>索引策略：并非要对每个字段均实施索引设置，首先要分析查询模式，然后决定多余列及JSONB索引的设置情况。</p>
<p>不要指望仅靠 JSON 来完成全部解析工作，在线上环境当中，最常遇到的问题就是“把所有的过滤条件都记录在 JSONB 中”，这样最终只能不断增加机器数量，对于那些高频出现的字段来说，应当执行冗余设计。</p>
<hr/>
<h2 data-id="heading-18">结语：替不替，先用一套可跑通的闭环说话</h2>
<p>我不太相信一句“兼容”能自动解决项目问题。我更相信两件事：</p>
<ul>
<li>
<p>你能在本地，把“建表、写入、查询、索引、更新、导入、验证”完整跑一遍；</p>
</li>
<li>
<p>你能把“哪些场景适合替、哪些场景不适合替”写进验收口径里，避免上线后用业务来做实验。</p>
</li>
</ul>
<p>把这两件事做好，MongoDB的替换就不是凭空想象，而是变成一项可以执行，检查，还能回滚的工程项目交付。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[接手老 Flutter 项目踩坑指南：从环境到调试的实际经验]]></title>    <link>https://juejin.cn/post/7605468286181179427</link>    <guid>https://juejin.cn/post/7605468286181179427</guid>    <pubDate>2026-02-12T06:36:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605468286181179427" data-draft-id="7605469747258310691" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="接手老 Flutter 项目踩坑指南：从环境到调试的实际经验"/> <meta itemprop="keywords" content="前端,Flutter"/> <meta itemprop="datePublished" content="2026-02-12T06:36:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="月亮有石头"/> <meta itemprop="url" content="https://juejin.cn/user/3526889032395613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            接手老 Flutter 项目踩坑指南：从环境到调试的实际经验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889032395613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    月亮有石头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:36:39.000Z" title="Thu Feb 12 2026 06:36:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为一个传统web前端开发者，接手一个老的 <strong>Flutter</strong> 项目，我必须承认，这个过程比我想象的要复杂很多。<strong>Flutter</strong> 不仅仅是一个 UI 框架，它涉及到原生开发的诸多细节，构建流程、平台兼容性和调试方式都与传统前端开发有很大不同，特别是如何应对环境配置、依赖问题、构建错误、真机调试等挑战。</p>
<h2 data-id="heading-0">一、兼容性问题：为什么特定版本的工具链如此重要？</h2>
<p>在 <strong>Flutter</strong> 开发中，兼容性问题往往是许多开发者在接手老项目时面临的主要挑战。因为 <strong>Flutter</strong> 涉及到多个工具和 SDK 的集成，而这些工具（如 <strong>Android Studio</strong>、<strong>Flutter SDK</strong>、<strong>Dart</strong>、<strong>Gradle</strong> 等）版本的不同可能会导致不兼容的情况，进而影响到应用的构建、调试和发布。</p>
<h3 data-id="heading-1"><strong>1. 为什么需要特定版本的工具链？</strong></h3>
<h4 data-id="heading-2"><strong>工具链的版本差异</strong></h4>
<ul>
<li><strong>Flutter SDK 和 Dart 版本</strong>：每个 <strong>Flutter</strong> 版本都绑定着一个 <strong>Dart</strong> 版本。如果项目中的 <strong>Flutter SDK</strong> 版本不匹配 <strong>Dart</strong> 版本，可能导致 API 不兼容，甚至在编译时出现错误。</li>
<li><strong>Android Studio 和插件</strong>：Flutter 开发过程中， <strong>Android Studio</strong> 是不可或缺的开发环境，许多 Flutter 项目的构建都依赖于 <strong>Android Studio</strong> 和其相关插件。不同版本的 <strong>Android Studio</strong> 可能与 Flutter 的插件版本不兼容，导致构建和调试功能无法正常使用。</li>
<li><strong>原生平台差异</strong>：Flutter 项目不仅需要支持 Web 端，还需要兼容 <strong>Android</strong> 和 <strong>iOS</strong> 平台。不同的 <strong>Android SDK</strong> 和 <strong>Xcode</strong> 版本可能导致原生构建过程中的错误和差异。</li>
</ul>
<h4 data-id="heading-3"><strong>兼容性带来的问题</strong></h4>
<ol>
<li><strong>API 不兼容</strong>：当使用不匹配的 <strong>Flutter</strong> 和 <strong>Dart</strong> 版本时，项目中的插件可能无法正常工作，导致一些 API 在新版本中无法调用或行为不一致。</li>
<li><strong>构建失败或运行异常</strong>：在使用不兼容版本的 <strong>Android Studio</strong> 或 <strong>Flutter SDK</strong> 时，构建过程可能会中断，或者即使构建成功，应用也可能无法正确运行。</li>
<li><strong>调试工具不兼容</strong>：不同版本的 <strong>Flutter DevTools</strong> 或 <strong>Android Studio</strong> 插件可能会导致调试信息不完整，无法跟踪和修复运行时问题。</li>
</ol>
<h3 data-id="heading-4"><strong>2. 如何解决兼容性问题？</strong></h3>
<h4 data-id="heading-5"><strong>保持工具链的一致性</strong></h4>
<ul>
<li>在开发团队中保持 <strong>Flutter SDK</strong>、<strong>Dart</strong>、<strong>Android Studio</strong> 等工具的版本一致性非常重要。特别是在多人的项目中，如果每个人使用不同的版本，可能会导致不同的构建结果和调试问题。</li>
<li>使用项目中的 <strong><code>.flutter-version</code></strong> 或 <strong><code>.tool-version</code></strong> 文件来锁定 <strong>Flutter SDK</strong> 版本，确保团队成员使用相同版本。</li>
</ul>
<h4 data-id="heading-6"><strong>定期更新依赖和工具</strong></h4>
<ul>
<li>使用 <strong><code>flutter pub outdated</code></strong> 和 <strong><code>flutter pub upgrade</code></strong> 检查依赖是否过时，并保持插件和 SDK 的更新。</li>
<li>定期检查 <strong>Android Studio</strong> 和 <strong>Xcode</strong> 是否需要更新，确保它们与 <strong>Flutter SDK</strong> 版本兼容。</li>
</ul>
<h4 data-id="heading-7"><strong>回退到兼容版本</strong></h4>
<ul>
<li>如果新版本的 <strong>Flutter SDK</strong> 或 <strong>Android Studio</strong> 导致构建问题或不兼容，可以考虑回退到一个更稳定的版本，尤其是在使用过某些插件时，回退到兼容版本能有效避免兼容性问题。</li>
</ul>
<h4 data-id="heading-8"><strong>测试兼容性</strong></h4>
<ul>
<li>在开始使用新版本的工具链前，确保在一个 <strong>独立的测试环境</strong> 中进行兼容性测试，检查构建、调试和发布流程是否正常工作。</li>
</ul>
<h3 data-id="heading-9"><strong>3. 项目中常见的版本兼容问题举例</strong></h3>
<h4 data-id="heading-10"><strong>问题1：Flutter 插件与 Android Studio 版本不兼容</strong></h4>
<p>某些 Flutter 插件在 <strong>Android Studio</strong> 更新后可能无法与新版本兼容，导致无法正确构建或调试应用。开发团队通常需要回滚 <strong>Android Studio</strong> 到某个版本以避免这些问题。</p>
<h4 data-id="heading-11"><strong>问题2：Dart 和 Flutter 版本不兼容</strong></h4>
<p>Flutter SDK 和 Dart 版本之间有严格的依赖关系。如果项目使用了 <strong>Flutter 3.7</strong>，但 Dart 升级到 <strong>2.20</strong> 版本，则可能出现不兼容的 API，导致构建失败。</p>
<h4 data-id="heading-12"><strong>问题3：Gradle 和 Android SDK 版本冲突</strong></h4>
<p>如果项目使用了较旧版本的 <strong>Gradle</strong> 或 <strong>Android SDK</strong>，更新到新版本的 <strong>Android Studio</strong> 后，可能导致构建失败或无法正确运行。</p>
<h3 data-id="heading-13"><strong>总结：确保兼容性，保障项目稳定性</strong></h3>
<p>在 <strong>Flutter</strong> 项目开发过程中，保持 <strong>工具链</strong> 和 <strong>依赖的兼容性</strong> 至关重要。随着 Flutter 不断更新迭代，适应新版本的工具链和 SDK 可能会带来新的挑战和问题，但通过合理的版本管理和工具选择，可以确保项目的稳定性。了解兼容性问题，并及时解决这些问题，将帮助你减少开发过程中的不必要麻烦，提升团队的开发效率。</p>
<h2 data-id="heading-14">二、环境和依赖问题：从前端到 Flutter 的第一步</h2>
<h4 data-id="heading-15"><strong>问题1：依赖安装成功，但 <code>flutter run</code> 报 <code>assets</code> 目录不存在</strong></h4>
<p>在运行 <code>flutter run</code> 时，我遇到一个让人头痛的问题：虽然我已经安装了所有依赖，但还是报出“<code>assets</code> 目录不存在”的错误。原以为是依赖的问题，但实际上是因为 <code>pubspec.yaml</code> 中声明的某个目录并没有对应的文件。</p>
<p><strong>解决方法：</strong></p>
<ul>
<li>检查 <code>pubspec.yaml</code> 文件中是否有正确的 <strong>assets</strong> 声明。确保声明的目录存在，如果没有，就需要手动补充或者删除不必要的目录声明。</li>
<li>重新运行 <code>flutter pub get</code> 确保所有依赖都安装正确。</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">flutter:</span>
  <span class="hljs-attr">assets:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/</span>
</code></pre>
<h4 data-id="heading-16"><strong>问题2：Web 插件 API 版本不兼容（如 <code>mobile_scanner</code>）</strong></h4>
<p>在 Web 环境下运行时，插件可能会报出 API 不兼容的错误，尤其是像 <strong><code>mobile_scanner</code></strong> 这种插件，新旧版本之间差异较大。经过一些排查，我发现版本不兼容是导致问题的根本原因。</p>
<p><strong>解决方法：</strong></p>
<ul>
<li>通过命令 <code>flutter pub outdated</code> 查看插件的过期情况，确认当前 Flutter 版本支持的插件版本。</li>
<li>降级到与 Flutter 兼容的插件版本，或者查阅插件的官方文档，确认是否支持 Web 平台。</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">mobile_scanner:</span> <span class="hljs-number">3.0</span><span class="hljs-number">.0</span><span class="hljs-string">-beta.1</span>  <span class="hljs-comment"># 降级到兼容版本</span>
</code></pre>
<h4 data-id="heading-17"><strong>问题3：Web 报 <code>Unsupported operation: Platform._operatingSystem</code></strong></h4>
<p>另一个常见的问题是在 Web 环境中调用 <strong><code>dart:io</code></strong> 中的 <code>Platform</code> 类时，遇到“<code>Unsupported operation: Platform._operatingSystem</code>”的报错。</p>
<p><strong>解决方法：</strong></p>
<ul>
<li>在 Web 环境下，<strong><code>dart:io</code></strong> 库是不被支持的，因此我们需要使用 <strong><code>kIsWeb</code></strong> 来判断平台类型，避免在 Web 上使用不支持的功能。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/foundation.dart'</span>;

<span class="hljs-keyword">if</span> (kIsWeb) {
  <span class="hljs-comment">// 针对 Web 的代码</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 针对 Android/iOS 的代码</span>
}
</code></pre>
<h2 data-id="heading-18">三、Android 构建问题：打包和签名的麻烦</h2>
<h4 data-id="heading-19"><strong>问题4：Android SDK 组件缺失</strong></h4>
<p>在构建 Android 应用时，遇到了 SDK 组件缺失的情况，报错提示缺少 <code>build-tools</code>、<code>platforms;android-31</code> 等。原来是我的 Android SDK 没有更新到最新版本，导致了一些构建依赖的缺失。</p>
<p><strong>解决方法：</strong></p>
<ul>
<li>打开 <strong>Android Studio</strong>，前往 <strong>SDK Manager</strong>，确保所有必须的 SDK 组件（如 <code>build-tools</code> 和 Android API）都已经安装。</li>
<li>如果你在公司内网环境下工作，注意解决代理问题，确保可以正常下载 SDK 组件。</li>
</ul>
<h4 data-id="heading-20"><strong>问题5：签名文件缺失</strong></h4>
<p>在构建发布版 APK 时，我遇到了一个报错：“<code>debug.keystore not found for signing config 'debug'</code>”。这个问题源于 <strong>签名配置</strong> 缺失或配置不当。</p>
<p><strong>解决方法：</strong></p>
<ul>
<li>在 <strong><code>build.gradle</code></strong> 文件中配置好签名文件，确保 Flutter 在构建时使用正确的签名配置。可以使用 <strong>debug.keystore</strong> 进行调试，发布时则需要使用 <strong>release.keystore</strong>。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">android {
    signingConfigs {
        release {
            storeFile file(<span class="hljs-string">'path_to_your_keystore_file/release.keystore'</span>)
            storePassword <span class="hljs-string">'your_keystore_password'</span>
            keyAlias <span class="hljs-string">'your_key_alias'</span>
            keyPassword <span class="hljs-string">'your_key_password'</span>
        }
    }

    buildTypes {
        release {
            signingConfig signingConfigs.release
        }
    }
}
</code></pre>
<h4 data-id="heading-21"><strong>问题6：无法连接 Android 设备</strong></h4>
<p>在调试 Android 真机时，<code>adb devices</code> 返回了空设备列表，导致无法进行真机调试。尝试了几次后，发现问题出在设备的 <strong>USB 调试</strong> 设置。</p>
<p><strong>解决方法：</strong></p>
<ul>
<li>确保设备开启 <strong>开发者选项</strong> 和 <strong>USB 调试</strong>，并且授权了计算机的 <strong>USB 调试</strong> 连接。</li>
<li>使用 <strong>USB 数据线</strong> 检查连接是否正常，避免使用仅支持充电的线缆。</li>
</ul>
<h2 data-id="heading-22">五、真机调试：常见的调试陷阱和解决方案</h2>
<h4 data-id="heading-23"><strong>问题7：磁盘空间不足，构建失败</strong></h4>
<p>在构建过程中，我遇到了“<code>No space left on device</code>”的错误。检查了磁盘空间，发现项目的缓存和构建文件占用了大量空间。</p>
<p><strong>解决方法：</strong></p>
<ul>
<li>运行 <code>flutter clean</code> 清理缓存，并手动删除一些无用的构建文件（如 <code>build/.dart_tool/android/.gradle</code>）。</li>
</ul>
<pre><code class="hljs">flutter clean
</code></pre>
<ul>
<li>定期清理不再需要的缓存文件和构建文件，保持开发环境的整洁。</li>
</ul>
<h4 data-id="heading-24"><strong>问题8：安装失败，但编译成功</strong></h4>
<p>最后，虽然应用成功编译，但安装时遇到了“<code>INSTALL_FAILED_ABORTED: User rejected permissions</code>”错误。这是因为 <strong>Android 设备</strong> 没有授予正确的安装权限。</p>
<p><strong>解决方法：</strong></p>
<ul>
<li>在 Android 手机上，确保允许通过 USB 安装应用，并确认授权了安装权限。</li>
</ul>
<h2 data-id="heading-25">六、总结与建议</h2>
<p>通过这些踩坑经历，我总结出以下几点建议，帮助你更轻松地接手 <strong>Flutter</strong> 项目：</p>
<ol>
<li><strong>先确认环境</strong>：在运行 <code>flutter run</code> 之前，确保所有的依赖、SDK 和构建工具都已正确安装，并且 Android/iOS 环境已经配置好。</li>
<li><strong>逐步排障</strong>：遇到问题时，按步骤排查，不要一下子改多个配置，避免造成更多问题。</li>
<li><strong>Web 与原生平台差异</strong>：在开发中，要时刻考虑 Web 和原生平台的差异，避免直接使用不支持的 API。</li>
<li><strong>使用构建工具</strong>：Flutter 提供了方便的构建命令，确保正确配置签名和构建命令，避免构建失败。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据集推荐 06 | 首款 NL2GeoSQL 的测试基准和数据集来了！]]></title>    <link>https://juejin.cn/post/7605495714295119898</link>    <guid>https://juejin.cn/post/7605495714295119898</guid>    <pubDate>2026-02-12T06:54:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605495714295119898" data-draft-id="7605495714295103514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据集推荐 06 | 首款 NL2GeoSQL 的测试基准和数据集来了！"/> <meta itemprop="keywords" content="数据库,人工智能,SQL"/> <meta itemprop="datePublished" content="2026-02-12T06:54:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱可生开源社区"/> <meta itemprop="url" content="https://juejin.cn/user/1480387593251847"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据集推荐 06 | 首款 NL2GeoSQL 的测试基准和数据集来了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1480387593251847/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱可生开源社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:54:27.000Z" title="Thu Feb 12 2026 06:54:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">专题介绍</h2>
<p>当我们对 AI4SQL/AI4DB/DB4AI 类产品进行研究时，我们发现 SQL 领域应用能力的提升很大程度上依赖于高质量的数据集。</p>
<p>还需要在此基础上进行数据合成，生成针对特定问题的训练集和评估集。为了帮助更多开发者快速获取资源，我们将近年来公开的 Text2SQL/NL2SQL 数据集进行了整理清单，持续分享给大家！</p>
<p>本期为系列文章的第六期，将介绍 <strong>大模型在地理空间查询 SQL 生成</strong> 和 <strong>提高 NL2SQL 精准度</strong> 方面的两款数据集：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2509.25264" title="https://arxiv.org/pdf/2509.25264" target="_blank" ref="nofollow noopener noreferrer">GeoSQL-Eval</a> 与 <a href="https://link.juejin.cn?target=https%3A%2F%2Faclanthology.org%2F2025.findings-emnlp.1312.pdf" title="https://aclanthology.org/2025.findings-emnlp.1312.pdf" target="_blank" ref="nofollow noopener noreferrer">DeKeyNLU</a>。</p>
<h2 data-id="heading-1">GeoSQL-Eval / GeoSQL-Bench</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhaoyuejiao.github.io%2FGeoSQL-Eval-Leaderboard%2F" title="https://haoyuejiao.github.io/GeoSQL-Eval-Leaderboard/" target="_blank" ref="nofollow noopener noreferrer">GeoSQL-Eval</a> 是首个面向 PostGIS 环境的端到端自动化评估框架，旨在衡量大型语言模型在 <strong>地理空间</strong> 数据库查询生成（GeoSQL）方面的性能。</p>
<p>该研究还包括发布 <strong>GeoSQL-Bench 基准测试数据集</strong>，其中包含 14,178 个实例、340 个 PostGIS 函数和 82 个专题数据库。</p>
<p><img src="http://openwrite.cn/uploads/16955/59601/7af01103-03e5-4c37-992d-a39f8eea8274.png" alt="image2026-2-2 10_41_56.png" loading="lazy"/></p>
<h3 data-id="heading-2">论文意图</h3>
<p>本文主要针对现有大型语言模型在生成 PostGIS 空间查询（GeoSQL）方面的性能评估难题，探讨如何系统地衡量这些模型的性能，因为目前 <strong>缺乏专门的评估基准和框架</strong>。传统的 NL2SQL 基准测试无法涵盖空间数据类型、函数和坐标系等复杂元素，导致在实际应用场景中出现函数错觉和参数误用等错误。</p>
<p>为了解决这一问题，论文提出了：</p>
<ul>
<li><strong>GeoSQL-Bench 基准测试</strong></li>
<li><strong>GeoSQL-Eval 评估框架</strong></li>
</ul>
<p>这些框架旨在为 <strong>NL2GeoSQL</strong> 任务建立一个标准化、多层次且可执行的评估系统，支持模型能力诊断和优化，并降低不同领域用户使用空间数据库的门槛。</p>
<h3 data-id="heading-3">数据集分析</h3>
<p><strong>GeoSQL-Bench 数据集</strong> 采用多源结构化方法构建，涵盖三种类型的任务：</p>
<ol>
<li><strong>多项选择题和判断题</strong>（2380 道），基于 PostGIS 3.5 官方手册，测试函数功能、参数顺序、返回类型以及是否符合规范；</li>
<li><strong>语法级 SQL 生成题</strong>（3744 道），源自手册示例，包含显式提示和欠规范提示，验证模型生成可执行查询的能力；</li>
<li><strong>表结构检索题</strong>（2155 道），基于使用联合国全球地理信息管理 (UN GGIM) 主题和 ISO 19115 分类构建的包含 82 个真实场景的空间数据库，要求模型使用表结构生成复杂查询。</li>
</ol>
<p>所有任务均在 GPT-4o 的辅助下生成，并经过领域专家的三重审核，以确保准确性、多样性和真实性。</p>
<h2 data-id="heading-4">小结</h2>
<p>本研究使用 <strong>GeoSQL-Eval 框架</strong> 系统地评估了六大类共 24 个主流模型。</p>
<p>实验表明，推理增强型模型（例如 GPT-5 和 o4-mini）在复杂的空间查询和多轮查询生成方面表现出色，尤其是在几何任务中展现出显著的准确率优势。通用非推理模型（例如 Claude3.7-Sonnet）在执行效率和语法正确性方面表现更佳。然而，函数调用和参数匹配错误仍然是核心瓶颈，约占 70%，而表结构检索任务由于多表连接逻辑的复杂性而面临最大挑战。</p>
<p>这项工作建立了首个针对 NL2GeoSQL 任务的标准化评估系统，为自然语言与空间数据库的交互提供了关键的基准和优化方向。</p>
<h2 data-id="heading-5">DeKeyNLU</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAlexJJJChen%2FDeKeyNLU" title="https://github.com/AlexJJJChen/DeKeyNLU" target="_blank" ref="nofollow noopener noreferrer">DeKeyNLU</a> 通过三层人工交叉验证，实现了任务分解和关键词提取的联合细粒度标注。在此基础上，DeKeySQL 框架创新性地将一个专门的理解模块深度集成到 RAG（结果生成）过程中，建立了一种 “<strong>优先考虑精确语义解析</strong>” 的新范式，<strong>显著提高了复杂查询 SQL 生成的准确性和领域适应性。</strong></p>
<p><img src="http://openwrite.cn/uploads/16955/59601/e0c7e247-e8bb-4a42-948d-521fea5fa8bb.png" alt="image2026-2-3 14_41_56 (1).png" loading="lazy"/></p>
<h3 data-id="heading-6">论文意图</h3>
<p>本文旨在解决当前 RAG（检索增强生成）和 CoT（思维链）技术在 NL2SQL（自然语言 SQL 生成）任务中遇到的主要瓶颈：</p>
<p><strong>通用大模型在任务分解和关键词提取方面的准确性不足。</strong></p>
<p>现有的数据集在任务分解方面往往过于碎片化，且缺乏特定领域的关键词标注。为了解决这些问题，作者提出了 <strong>DeKeyNLU 数据集</strong> 和 <strong>DeKeySQL 流程</strong>（包含三个模块：用户问题理解、实体检索和生成）。通过对模型进行微调以优化问题理解阶段，最终生成的 SQL 语句的准确性得到了提升。</p>
<h3 data-id="heading-7">数据集分析</h3>
<p><strong>DeKeyNLU 数据集</strong> 包含 1500 个高质量标注的问答对，数据来源于 BIRD 基准数据集，涵盖金融、教育等多个领域的真实数据库场景，数据集按 <strong>7:2:1</strong> 的比例划分为训练集、验证集和测试集。</p>
<p>数据合成采用 “<strong>LLM 预标注 + 人工润色</strong>” 的混合工作流程：</p>
<ul>
<li>第一步：使用 GPT-4o 自动生成每个问题的初步任务分解（主任务/子任务）和关键词提取（对象/实现）；</li>
<li>第二步：三位专家标注员进行三轮交叉验证和修订确保标注质量。</li>
</ul>
<h3 data-id="heading-8">小结</h3>
<p>论文通过引入 <strong>DeKeyNLU 数据集</strong> 和 <strong>DeKeySQL 框架</strong>，证明了 <strong>针对性的任务分解和关键词提取训练能够有效提升 NL2SQL 的性能。</strong></p>
<p>实验结果表明，利用 DeKeyNLU 对 “用户问题理解” 模块进行微调后，模型在 BIRD 开发集上的准确率从 62.31% 提升至 69.10%，在 Spider 开发集上的准确率从 84.2% 提升至 88.7%。</p>
<p>在 NL2SQL 流程中，实体检索被认为是影响整体准确率的最关键环节，其次是用户问题理解和修正机制。这些发现凸显了以数据集为中心的方法和精心设计的流程对于提升 NL2SQL 系统能力的重要价值，并为用户实现直观、准确的数据交互铺平了道路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react中的filble架构和diffes算法如何实现的]]></title>    <link>https://juejin.cn/post/7605495714294956058</link>    <guid>https://juejin.cn/post/7605495714294956058</guid>    <pubDate>2026-02-12T06:34:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605495714294956058" data-draft-id="7605451617287553051" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react中的filble架构和diffes算法如何实现的"/> <meta itemprop="keywords" content="前端,React.js,掘金·金石计划"/> <meta itemprop="datePublished" content="2026-02-12T06:34:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="光影少年"/> <meta itemprop="url" content="https://juejin.cn/user/3184663905962126"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react中的filble架构和diffes算法如何实现的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3184663905962126/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    光影少年
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:34:17.000Z" title="Thu Feb 12 2026 06:34:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、先给面试官的“王炸开场白”</h2>
<p>你可以先来这一句 👇</p>
<blockquote>
<p><strong>React Fiber 是为了解决旧 Diff 递归不可中断的问题，引入的可中断、可优先级调度的架构；Diff 算法本身没变，但执行方式变了。</strong></p>
</blockquote>
<p>⚠️ 这一句，直接把你和“只背概念的人”区分开。</p>
<hr/>
<h2 data-id="heading-1">二、为什么 React 要引入 Fiber？</h2>
<h3 data-id="heading-2">1️⃣ 旧架构的问题（Stack Reconciler）</h3>
<p>React 16 之前：</p>
<pre><code class="hljs language-sql" lang="sql">更新 → 递归 diff → 一口气算完 → <span class="hljs-keyword">commit</span>
</code></pre>
<h4 data-id="heading-3">致命问题</h4>
<ul>
<li>❌ <strong>不可中断</strong></li>
<li>❌ 大组件树会卡主线程</li>
<li>❌ 无法区分优先级（动画、输入）</li>
</ul>
<p>👉 用户体验：<strong>掉帧、卡顿</strong></p>
<hr/>
<h3 data-id="heading-4">2️⃣ Fiber 解决了什么？</h3>
<p>一句话总结 👇</p>
<blockquote>
<p><strong>把“递归不可中断” → 拆成“可中断的任务单元”</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-5">三、Fiber 是什么？（一定要讲清楚）</h2>
<h3 data-id="heading-6">1️⃣ Fiber 本质不是算法，是<strong>数据结构</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Fiber</span> {
  type
  key
  stateNode

  child
  sibling
  <span class="hljs-keyword">return</span>

  pendingProps
  memoizedProps
  memoizedState

  flags
}
</code></pre>
<h4 data-id="heading-7">核心点</h4>
<ul>
<li>每一个组件 = 一个 Fiber 节点</li>
<li>Fiber 是 <strong>链表结构</strong>，不是树递归</li>
</ul>
<hr/>
<h3 data-id="heading-8">2️⃣ Fiber 结构长什么样？</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">parent</span>
  <span class="hljs-string">|
 child —— sibling —— sibling
</span></code></pre>
<p>👉 <strong>用 child / sibling / return 模拟树</strong></p>
<h4 data-id="heading-9">为什么不用数组？</h4>
<ul>
<li>链表更容易拆分、暂停、恢复</li>
</ul>
<hr/>
<h2 data-id="heading-10">四、Fiber 架构是怎么“跑”起来的？</h2>
<h3 data-id="heading-11">React 更新分两大阶段（必考）</h3>
<pre><code class="hljs language-sql" lang="sql">Render 阶段（可中断）
<span class="hljs-keyword">Commit</span> 阶段（不可中断）
</code></pre>
<hr/>
<h3 data-id="heading-12">1️⃣ Render 阶段（核心）</h3>
<p>做什么？</p>
<ul>
<li>Diff</li>
<li>生成 Fiber 树</li>
<li>标记副作用（flags）</li>
</ul>
<p>特点：</p>
<ul>
<li>✅ 可中断</li>
<li>✅ 可恢复</li>
<li>❌ 不操作 DOM</li>
</ul>
<pre><code class="hljs language-lua" lang="lua">workLoop
  ↓
performUnitOfWork
  ↓
<span class="hljs-built_in">next</span> Fiber
</code></pre>
<hr/>
<h3 data-id="heading-13">2️⃣ Commit 阶段</h3>
<p>做什么？</p>
<ul>
<li>操作 DOM</li>
<li>执行 useEffect</li>
</ul>
<p>特点：</p>
<ul>
<li>❌ 不可中断</li>
<li>✅ 很快</li>
</ul>
<hr/>
<h3 data-id="heading-14">3️⃣ 面试话术</h3>
<blockquote>
<p>Fiber 通过把 Render 阶段拆成小任务，配合浏览器空闲时间执行，实现了时间分片。</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">五、什么是时间分片（Time Slicing）？</h2>
<h4 data-id="heading-16">核心 API</h4>
<pre><code class="hljs">requestIdleCallback
</code></pre>
<p>React 内部思想：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">while</span> (有任务 &amp;&amp; 有空闲时间) {
  执行一个 <span class="hljs-built_in">Fiber</span>
}
</code></pre>
<p>👉 <strong>不卡 UI 的关键</strong></p>
<hr/>
<h2 data-id="heading-17">六、Diff 算法到底是怎么做的？</h2>
<p>⚠️ 重点来了：<br/>
<strong>Diff 算法思想没变，执行模型变了</strong></p>
<hr/>
<h3 data-id="heading-18">React Diff 的三大假设（必背）</h3>
<h4 data-id="heading-19">1️⃣ 不同类型节点，直接删</h4>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> /&gt; → &lt;<span class="hljs-selector-tag">span</span> /&gt;
</code></pre>
<p>👉 不复用，整棵子树重建</p>
<hr/>
<h4 data-id="heading-20">2️⃣ 同一层级比较（O(n)）</h4>
<p>React <strong>不会跨层 diff</strong></p>
<pre><code class="hljs">只比较兄弟节点
</code></pre>
<hr/>
<h4 data-id="heading-21">3️⃣ key 决定节点复用</h4>
<pre><code class="hljs language-ini" lang="ini">{list.map(<span class="hljs-attr">item</span> =&gt; (
  &lt;Item <span class="hljs-attr">key</span>={item.id} /&gt;
))}
</code></pre>
<hr/>
<h3 data-id="heading-22">Diff 的真实过程（列表为例）</h3>
<h4 data-id="heading-23">无 key（危险）</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">B</span> C
↓
<span class="hljs-selector-tag">B</span> C D
</code></pre>
<p>👉 全部错位复用，性能差</p>
<hr/>
<h4 data-id="heading-24">有 key（正确）</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">A</span>(key1) <span class="hljs-selector-tag">B</span>(key2) <span class="hljs-built_in">C</span>(key3)
↓
<span class="hljs-selector-tag">B</span>(key2) <span class="hljs-built_in">C</span>(key3) <span class="hljs-built_in">D</span>(key4)
</code></pre>
<p>👉 复用 B、C，只增删 A / D</p>
<hr/>
<h3 data-id="heading-25">面试话术</h3>
<blockquote>
<p>React Diff 是基于同层比较和 key 的启发式算法，把复杂度从 O(n³) 降到 O(n)。</p>
</blockquote>
<hr/>
<h2 data-id="heading-26">七、Fiber 和 Diff 的关系（面试官最爱问）</h2>
<h4 data-id="heading-27">错误理解 ❌</h4>
<blockquote>
<p>Fiber = 新 Diff</p>
</blockquote>
<h4 data-id="heading-28">正确理解 ✅</h4>
<blockquote>
<p><strong>Diff 算法没变，Fiber 改变的是 Diff 的执行方式和调度模型。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-29">八、为什么 Fiber 能“中断”，递归不行？</h2>
<h4 data-id="heading-30">递归的问题</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">diff</span>(node) {
  <span class="hljs-built_in">diff</span>(node.child)
}
</code></pre>
<ul>
<li>调用栈一旦开始，停不了</li>
</ul>
<hr/>
<h4 data-id="heading-31">Fiber 的优势</h4>
<pre><code class="hljs language-ini" lang="ini">一个 <span class="hljs-attr">Fiber</span> = 一个工作单元
</code></pre>
<ul>
<li>执行完一个就可以停</li>
<li>下次从 nextFiber 继续</li>
</ul>
<hr/>
<h2 data-id="heading-32">九、面试官常见追问 &amp; 满分回答</h2>
<h4 data-id="heading-33">Q1：Fiber 是不是双缓存？</h4>
<p>✅ 是</p>
<pre><code class="hljs language-php" lang="php">current <span class="hljs-built_in">Fiber</span> Tree
workInProgress <span class="hljs-built_in">Fiber</span> Tree
</code></pre>
<p>提交后互换引用。</p>
<hr/>
<h4 data-id="heading-34">Q2：useEffect 在哪执行？</h4>
<p>👉 <strong>Commit 阶段之后</strong></p>
<hr/>
<h4 data-id="heading-35">Q3：为什么 Render 阶段不能操作 DOM？</h4>
<p>👉 因为可能被中断，多次执行会出问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 核心原理完全解析：从组件化、虚拟DOM到声明式编程]]></title>    <link>https://juejin.cn/post/7605468286181163043</link>    <guid>https://juejin.cn/post/7605468286181163043</guid>    <pubDate>2026-02-12T06:35:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605468286181163043" data-draft-id="7605489943868604431" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 核心原理完全解析：从组件化、虚拟DOM到声明式编程"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2026-02-12T06:35:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Oscarzhang"/> <meta itemprop="url" content="https://juejin.cn/user/4286337742803811"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 核心原理完全解析：从组件化、虚拟DOM到声明式编程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4286337742803811/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Oscarzhang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:35:21.000Z" title="Thu Feb 12 2026 06:35:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">一、什么是 React？</h2>
<p>React 是一个用于构建用户界面的 JavaScript 库，由 Facebook 开发。它采用<strong>组件化</strong>开发模式，通过<strong>声明式</strong>编程让 UI 开发更简单高效。</p>
<h3 data-id="heading-1">1. React 核心特点</h3>
<ol>
<li><strong>组件化（Component）</strong> 把页面拆成按钮、卡片、列表等小模块，可复用、可组合。R<strong>eact 是组件驱动的。</strong></li>
<li><strong>虚拟 DOM（Virtual DOM）</strong> 不直接操作真实 DOM，先在内存对比差异，只更新变化部分，<strong>速度更快</strong>。</li>
<li><strong>JSX</strong> JSX = <strong>JavaScript + XML</strong>，它不是字符串，也不是模板语法。它是JavaScript 的语法糖。</li>
<li><strong>声明式</strong> 你只描述“要什么结果”，不关心“怎么实现”</li>
<li><strong>单向数据流</strong> 数据只能从父组件流向子组件，不能反过来。</li>
</ol>
<h4 data-id="heading-2"><strong>1. 组件化</strong></h4>
<h5 data-id="heading-3"><strong>1.1 组件化是什么？</strong></h5>
<p><strong>组件化</strong>是将页面拆分为<strong>独立、可复用、可组合</strong>的代码单元的开发模式。每个组件负责渲染 UI 的特定部分，并管理自己的状态和行为。</p>
<p><strong>React组件化思维</strong></p>
<blockquote>
<p><strong>传统开发：一个页面 = 一个 HTML 文件<br/>
组件化开发：一个页面 = 多个组件的组合<br/>
↓<br/>
[App 根组件]<br/>
↓<br/>
┌────┴────┐<br/>
[Header]  [Content]<br/>
↓          ↓<br/>
[Logo]   [Sidebar] [Main]</strong></p>
</blockquote>
<h5 data-id="heading-4">1.2 为什么需要组件化？</h5>
<p><strong>传统开发的痛点</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 2000 行代码的单个 HTML --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 头部 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 侧边栏 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sidebar"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 内容区 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 混杂着 JS 逻辑 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
      <span class="hljs-comment">// 代码难以维护</span>
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 更多代码... --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>问题：</strong></p>
<ul>
<li>代码耦合严重，牵一发而动全身</li>
<li>难以复用，只能复制粘贴</li>
<li>团队协作困难，容易冲突</li>
<li>测试困难，必须测试整个页面</li>
</ul>
<h5 data-id="heading-5">1.3 <strong>组件化的优势</strong></h5>
<blockquote>
<p><strong>✅ <strong>高内聚低耦合</strong> - 组件内部紧密相关，组件间相互独立<br/>
✅ <strong>可复用性</strong> - 一次编写，多处使用<br/>
✅ <strong>可维护性</strong> - 每个组件独立维护，职责单一<br/>
✅ <strong>可测试性</strong> - 可以单独测试每个组件<br/>
✅ <strong>团队协作</strong> - 并行开发不同组件</strong></p>
</blockquote>
<p><strong>函数组件（主流）</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>类组件（旧写法）</strong></p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
  render() {
    <span class="hljs-keyword">return</span> &lt;div&gt;<span class="hljs-type">Hello</span>&lt;/div&gt;;
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>现在基本都用函数组件 + Hooks。</strong><br/>
</p>
<h4 data-id="heading-6"><strong>2.虚拟DOM</strong></h4>
<p>要理解虚拟 DOM，最直接的方式是回答三个问题：<strong>它是什么？它解决了什么问题？它是怎么做的？</strong></p>
<h5 data-id="heading-7"><strong>2.1 什么是虚拟DOM？</strong></h5>
<p>虚拟 DOM（Virtual DOM）本质就是：<strong>用 JavaScript 对象来描述真实 DOM</strong>。</p>
<p><strong>真实DOM：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>在 React 里会变成类似这样的 JS 对象：</p>
<pre><code class="hljs language-css" lang="css">{
  type: <span class="hljs-string">'div'</span>,
  props: {
    id: <span class="hljs-string">'app'</span>,
    children: [
      {
        type: <span class="hljs-string">'h1'</span>,
        props: {
          children: <span class="hljs-string">'Hello'</span>
        }
      }
    ]
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>它不是浏览器的真实节点，只是一个描述结构的 JS 对象。</strong></p>
<h5 data-id="heading-8">2.2 为什么需要虚拟 DOM？</h5>
<p>核心原因只有一个：</p>
<blockquote>
<p>直接操作真实 DOM 性能开销大</p>
</blockquote>
<p>真实 DOM 操作很慢，因为：</p>
<ul>
<li>DOM 是浏览器 API</li>
<li>DOM 操作会引起重排（reflow）</li>
<li>会触发布局和绘制</li>
</ul>
<p>React 解决方案：</p>
<p>👉 先在内存中计算出变化<br/>
👉 再一次性更新真实 DOM</p>
<p>这就是虚拟 DOM 的意义。</p>
<h5 data-id="heading-9">2.3 React 更新流程（重点）</h5>
<p>初次当你调用的时候</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">setState</span>()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h6 data-id="heading-10"><strong>1. 生成虚拟DOM</strong></h6>
<blockquote>
<p>render() -&gt; new Virtual DOM</p>
</blockquote>
<h6 data-id="heading-11"><strong>2. 和旧的虚拟 DOM 做对比（Diff 算法）</strong></h6>
<p>React会比较</p>
<blockquote>
<p><strong>oldVDOM vs newVDOM</strong></p>
</blockquote>
<p>找出差异。</p>
<h6 data-id="heading-12"><strong>3. 生成最小更新补丁（Patch）</strong></h6>
<p>例如：</p>
<ul>
<li>文本变了 → 只改文本</li>
<li>class 变了 → 只改 class</li>
<li>子节点变了 → 局部替换</li>
</ul>
<h6 data-id="heading-13"><strong>4. 批量更新真实 DOM</strong></h6>
<p>React 会统一执行最少的 DOM 操作。</p>
<h6 data-id="heading-14">总结</h6>
<p><strong>第一步：初次渲染</strong></p>
<ul>
<li>组件返回 JSX，React 将其转为虚拟 DOM 树。</li>
<li>React 根据虚拟 DOM 树创建真实 DOM，插入页面。</li>
</ul>
<p><strong>第二步：状态更新</strong></p>
<ul>
<li>状态变化，组件重新执行，生成<strong>新的虚拟 DOM 树</strong>。</li>
<li>React 把<strong>新树</strong>和<strong>旧树</strong>传给 Diffing 算法进行比较。</li>
</ul>
<p><strong>第三步：计算差异并批量更新</strong></p>
<ul>
<li>Diff 算法找出两棵树的最小差异。</li>
<li>React 把这些差异<strong>批量</strong>更新到真实 DOM 上，只操作必要节点。</li>
</ul>
<p><strong>关键洞察</strong>：虚拟 DOM 快的不是“比较”这个过程，而是<strong>它让开发者能用声明式的写法，同时通过批量更新避免了频繁操作 DOM</strong>。</p>
<h5 data-id="heading-15">2.4 React Diff 算法原理（面试必问）</h5>
<p>React 的 Diff 有 3 个核心假设：</p>
<h6 data-id="heading-16">2.4.1 同层比较（不会跨层比较）</h6>
<p>只比较</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">div</span>
 ├─ <span class="hljs-selector-tag">p</span>
 └─ <span class="hljs-selector-tag">span</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>不会把 p 和 div 比。</p>
<p>这样把复杂度从：</p>
<blockquote>
<p>O(n³)</p>
</blockquote>
<p>降到</p>
<blockquote>
<p>O(n)</p>
</blockquote>
<h6 data-id="heading-17">2.4.2 不同类型直接替换</h6>
<blockquote>
<div/>  
→  
<span/>  
 
</blockquote>
<p>React 直接销毁重建。</p>
<h6 data-id="heading-18">2.4.3 key 是优化列表更新的关键</h6>
<p>错误写法：</p>
<pre><code class="hljs language-javascript" lang="javascript">{list.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>&gt;</span>{item}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
)}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>正确写法</p>
<pre><code class="hljs language-javascript" lang="javascript">{list.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
)}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>因为：</p>
<p>   key 用来判断节点是否“同一个”</p>
<p>否则 React 会误判，导致：</p>
<ul>
<li>组件状态错乱</li>
<li>性能变差</li>
</ul>
<h5 data-id="heading-19">2.5 虚拟 DOM ≠ 性能一定更快</h5>
<p>很多人误解：</p>
<blockquote>
<p>React 比原生 DOM 快，因为虚拟 DOM</p>
</blockquote>
<p>❌ 不完全对</p>
<p>真实情况是：</p>
<ul>
<li>少量 DOM 操作 → 原生更快</li>
<li>复杂 UI 更新 → React 更优</li>
</ul>
<p>虚拟 DOM优势在：</p>
<ul>
<li>批量更新</li>
<li>可预测更新</li>
<li>组件化管理</li>
</ul>
<h5 data-id="heading-20">2.6 虚拟 DOM 的本质一句话</h5>
<blockquote>
<p>虚拟 DOM 是一个“状态到 UI 的映射缓存层”</p>
</blockquote>
<p>UI = f(state)</p>
<p>React 通过虚拟 DOM保证：</p>
<blockquote>
<p>state 改变 → 自动算出最小 DOM 更新</p>
</blockquote>
<h5 data-id="heading-21">2.7 简单对比</h5>

























<table><thead><tr><th>方案</th><th>更新方式</th><th>性能</th></tr></thead><tbody><tr><td>原生 DOM</td><td>手动操作</td><td>容易频繁重排</td></tr><tr><td>jQuery</td><td>直接操作 DOM</td><td>逻辑复杂</td></tr><tr><td>React</td><td>状态驱动 + 虚拟 DOM</td><td>自动最小更新</td></tr></tbody></table>
<h5 data-id="heading-22">2.8 面试标准回答模板</h5>
<p>如果面试问：</p>
<blockquote>
<p>什么是虚拟 DOM？</p>
</blockquote>
<p>你可以回答：</p>
<blockquote>
<p>虚拟 DOM 是 React 用 JavaScript 对象表示真实 DOM 的一种机制。每次状态更新时，React 会生成新的虚拟 DOM，与旧虚拟 DOM 进行 Diff 算法比较，计算出最小的 DOM 变更，然后批量更新真实 DOM，从而提升性能和开发效率。</p>
</blockquote>
<h4 data-id="heading-23">3.JSX语法</h4>
<p>官方定义：<strong>JSX 是 JavaScript 的语法扩展，它类似于模板语言，但具有 JavaScript 的全部能力</strong></p>
<p>本质：<strong>JSX 不是模板引擎，不是 HTML，它是 <code>React.createElement</code> 的语法糖。</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello React<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>JSX 是 JavaScript 的语法扩展，本质会被编译成：</p>
<pre><code class="hljs language-bash" lang="bash">React.createElement(<span class="hljs-built_in">type</span>, props, children)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> element = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>会变成</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">element</span> = React.createElement(<span class="hljs-string">"h1"</span>, null, <span class="hljs-string">"Hello"</span>)<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>本质：JSX 只是语法糖。</strong></p>
<h5 data-id="heading-24"><strong>3.1</strong> JSX 必须有一个根节点</h5>
<p>❌ 错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>World<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
);
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>✅ 正确：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>World<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>或者使用 Fragment：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>World<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/&gt;</span></span>
);
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-25">3.2 JSX 中如何写 JS 表达式？</h5>
<p>用 <strong><code>{}</code></strong></p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">name</span> = <span class="hljs-string">"Jake"</span><span class="hljs-comment">;</span>

&lt;h1&gt;Hello {name}&lt;/h1&gt;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>也可以写表达式：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">h1</span>&gt;{<span class="hljs-number">1</span> + <span class="hljs-number">2</span>}&lt;/<span class="hljs-selector-tag">h1</span>&gt;
&lt;<span class="hljs-selector-tag">h1</span>&gt;{isLogin ? "已登录" : <span class="hljs-string">"未登录"</span>}&lt;/<span class="hljs-selector-tag">h1</span>&gt;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>⚠️ 只能写表达式，不能写语句：</p>
<p>❌ 错误：</p>
<pre><code class="hljs language-arduino" lang="arduino">{ <span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) { ... } }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>✅ 正确：</p>
<pre><code class="hljs language-css" lang="css">{ condition &amp;&amp; &lt;<span class="hljs-selector-tag">div</span>&gt;显示&lt;/<span class="hljs-selector-tag">div</span>&gt; }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-26">3.3 JSX 中的属性写法</h5>
<h6 data-id="heading-27">3.3.1 class 要写成 className</h6>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"box"</span>&gt;&lt;/div&gt;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h6 data-id="heading-28">3.3.2 for 要写成 htmlFor</h6>
<pre><code class="hljs language-ini" lang="ini">&lt;label <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">"name"</span>&gt;姓名&lt;/label&gt;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>因为 for 是 JS 关键字。</p>
<h6 data-id="heading-29">3.3.3 事件使用驼峰</h6>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>不是：</p>
<blockquote>
<p>onclick</p>
</blockquote>
<h6 data-id="heading-30">3.3.4 JSX 中写样式</h6>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"red"</span>, fontSize: <span class="hljs-string">"20px"</span> }}&gt;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>注意：</p>
<ul>
<li>外层 {} 是 JS</li>
<li>内层 {} 是对象</li>
</ul>
<h6 data-id="heading-31">3.3.5 JSX 渲染列表</h6>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">list</span> = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]<span class="hljs-comment">;</span>

&lt;ul&gt;
  {list.map(<span class="hljs-attr">item</span> =&gt;
    &lt;li <span class="hljs-attr">key</span>={item}&gt;{item}&lt;/li&gt;
  )}
&lt;/ul&gt;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>必须有 key。</p>
<h6 data-id="heading-32">3.3.6 JSX 条件渲染</h6>
<p><strong>三元表达式</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">{isLogin ? <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Home</span> /&gt;</span></span> : <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Login</span> /&gt;</span></span>}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>逻辑与</strong></p>
<pre><code class="hljs language-css" lang="css">{isShow &amp;&amp; &lt;<span class="hljs-selector-tag">div</span>&gt;显示&lt;/<span class="hljs-selector-tag">div</span>&gt;}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h6 data-id="heading-33">3.3.7 JSX 组件写法</h6>
<p>函数组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Hello</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello {props.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>使用：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;Hello <span class="hljs-attr">name</span>=<span class="hljs-string">"Jake"</span> /&gt;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-34">3.4 总结(面试标准回答)</h5>
<p>如果问：</p>
<blockquote>
<p>JSX 是什么？</p>
</blockquote>
<p>你可以回答：</p>
<blockquote>
<p>JSX 是 JavaScript 的语法扩展，本质是 React.createElement 的语法糖。它允许我们用类似 HTML 的写法描述 UI，最终会被 Babel 编译成 JavaScript 对象，也就是虚拟 DOM。</p>
</blockquote>
<h5 data-id="heading-35">3.5 常见的易错点</h5>
<ul>
<li>JSX 必须有根节点</li>
<li>不能写 if 语句</li>
<li>必须写 key</li>
<li>className 而不是 class</li>
<li>style 是对象</li>
</ul>
<h4 data-id="heading-36">4.声明式</h4>
<h5 data-id="heading-37">4.1 什么是声明式</h5>
<p>声明式编程关注的是"<strong>做什么</strong>"（what），而不是"<strong>怎么做</strong>"（how）。你只需要描述你想要的UI状态，React会自动处理DOM更新。</p>
<h5 data-id="heading-38">4.2 命令式 vs 声明式</h5>
<h6 data-id="heading-39">4.2.1 命令式（Imperative）</h6>
<p>你一步一步告诉程序怎么做。</p>
<p>例如操作 DOM：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">btn</span> = document.getElementById(<span class="hljs-string">"btn"</span>)<span class="hljs-comment">;</span>
btn.addEventListener("click", function() {
  const <span class="hljs-attr">box</span> = document.getElementById(<span class="hljs-string">"box"</span>)<span class="hljs-comment">;</span>
  <span class="hljs-attr">box.style.display</span> = <span class="hljs-string">"none"</span><span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>特点：</p>
<ul>
<li>手动找 DOM</li>
<li>手动改样式</li>
<li>手动控制流程</li>
</ul>
<p>👉 你在控制“过程”</p>
<h6 data-id="heading-40">4.2.2 声明式（Declarative）</h6>
<p>你只告诉它：</p>
<blockquote>
<p>当状态变成什么样，UI 应该是什么样</p>
</blockquote>
<p>React 写法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [show, setShow] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setShow(false)}&gt;隐藏<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {show &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"box"</span>&gt;</span>内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>你没有：</p>
<ul>
<li>手动 getElementById</li>
<li>手动修改 style</li>
<li>手动删除节点</li>
</ul>
<p>你只是声明</p>
<blockquote>
<p>UI = f(state)</p>
</blockquote>
<h5 data-id="heading-41">4.3 React 为什么是声明式?</h5>
<p>因为：</p>
<blockquote>
<p>React 只关心 state → UI 的映射关系</p>
</blockquote>
<p>当 state 改变：</p>
<blockquote>
<p>setShow(false)</p>
</blockquote>
<p>React 自动：</p>
<ol>
<li>重新执行函数组件</li>
<li>生成新虚拟 DOM</li>
<li>Diff</li>
<li>更新真实 DOM</li>
</ol>
<p>你不需要关心更新过程。</p>
<h5 data-id="heading-42">4.4 核心公式</h5>
<p>React 的本质就是：</p>
<blockquote>
<p>UI = f(state)</p>
</blockquote>
<p>state 是数据<br/>
UI 是结果</p>
<p>你只描述这个函数关系。</p>
<h5 data-id="heading-43">4.5 生活中的例子</h5>
<h6 data-id="heading-44">4.5.1 命令式（做饭）</h6>
<ol>
<li>洗菜</li>
<li>切菜</li>
<li>开火</li>
<li>放油</li>
<li>炒</li>
</ol>
<p>你控制步骤。</p>
<h6 data-id="heading-45">4.5.2 声明式（点外卖）</h6>
<p>   你只说</p>
<blockquote>
<p>我要一份牛肉面</p>
</blockquote>
<p>怎么做你不关心。</p>
<h5 data-id="heading-46">4.6 代码中的例子</h5>
<h6 data-id="heading-47">4.6.1 命令式循环</h6>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">result</span> = []<span class="hljs-comment">;</span>

for(let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; arr.length; i++){</span>
  result.push(arr<span class="hljs-section">[i]</span> * 2)<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h6 data-id="heading-48">4.6.2 声明式</h6>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">result</span> = arr.map(item =&gt; item * <span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>你没有说怎么循环，只声明转换规则。</p>
<h5 data-id="heading-49">4.7 声明式的优缺点</h5>
<h6 data-id="heading-50"><strong>优点</strong></h6>
<p>1️⃣ 代码更简洁<br/>
2️⃣ 更易维护<br/>
3️⃣ 状态可预测<br/>
4️⃣ 更适合复杂 UI</p>
<h6 data-id="heading-51"><strong>缺点</strong></h6>
<p>1️⃣ 抽象层高<br/>
2️⃣ 不易调试底层<br/>
3️⃣ 性能优化要理解内部机制</p>
<h5 data-id="heading-52">4.8 总结(面试版)</h5>
<p>如果问：</p>
<blockquote>
<p>什么是声明式编程？</p>
</blockquote>
<p>可以这样答：</p>
<blockquote>
<p>声明式编程是一种只描述结果而不关心实现过程的编程方式。在 React 中，我们通过描述 state 和 UI 的映射关系，让框架自动处理 DOM 更新逻辑。</p>
</blockquote>
<h4 data-id="heading-53">5.单向数据流</h4>
<h5 data-id="heading-54">5.1 什么是单向数据流？</h5>
<p><strong>单向数据流（Unidirectional Data Flow）是指：数据在应用中</strong>只有一个方向流动——从父组件流向子组件，数据的变化只能通过特定的方式触发，不能直接修改祖先组件的数据。</p>
<p><strong>核心公式</strong></p>
<blockquote>
<p>数据（State）→ 视图（UI）→ 行为（Action）→ 新数据（New State）→ 新视图（New UI）</p>
</blockquote>
<p><strong>数据永远是单向的，没有环路。</strong></p>
<h5 data-id="heading-55"><strong>5.2 React例子</strong></h5>
<p><strong>父组件</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{count}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>子组件</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{props.count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这里：</p>
<blockquote>
<p>count 从 Parent 传给 Child</p>
</blockquote>
<p>这就是单向数据流。</p>
<h5 data-id="heading-56">5.3 子组件能不能改父组件数据？</h5>
<p>❌ 不能直接改</p>
<p>错误：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">props.count</span> = <span class="hljs-number">100</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>React 不允许。</p>
<p>✅ 正确方式：父组件把“修改函数”传下去</p>
<p><strong>父组件 -</strong> 银行（掌握钱）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Bank</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [money, setMoney] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1000</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>银行总资产：¥{money}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 数据向下流：银行给ATM机钱，但ATM机不能直接改银行余额 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">ATM</span> 
        <span class="hljs-attr">currentMoney</span>=<span class="hljs-string">{money}</span>      // ✅ <span class="hljs-attr">数据向下</span>：<span class="hljs-attr">银行</span> → <span class="hljs-attr">ATM</span>
        <span class="hljs-attr">withdraw</span>=<span class="hljs-string">{setMoney}</span>       // ✅ <span class="hljs-attr">回调向下</span>：<span class="hljs-attr">银行给ATM取款权限</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>子组件</strong> - ATM机（只能取钱，不能直接改银行余额）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ATM</span>(<span class="hljs-params">{ currentMoney, withdraw }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> withdraw(currentMoney - 100)}&gt;
      💰 取100元（当前余额：¥{currentMoney}）
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>单向数据流路线图：</strong></p>
<blockquote>
<p><strong>银行（数据所有者）<br/>
↓ 把钱给ATM机（props）<br/>
↓ ATM机显示余额（只读）<br/>
↓ 用户点取款（事件）<br/>
↓ ATM机向银行发信号（回调）<br/>
↓ 银行自己改余额（setState）<br/>
↓ 银行重新给ATM机新余额（props）<br/>
↓ 界面更新</strong></p>
</blockquote>
<p><strong>关键区别：</strong></p>
<ul>
<li><strong>✅ 你的例子</strong>：父传了 <code>setCount</code>，子直接调用——<strong>这是允许的，但不够直观</strong></li>
<li><strong>✅ 这个例子</strong>：父既传数据（只读）、又传修改方法（回调），<strong>清楚看到数据从哪里来、修改权限在哪里</strong></li>
</ul>
<p><strong>本质一句话：</strong></p>
<blockquote>
<p><strong>钱在银行手里，ATM机只能请求取钱，不能自己打开金库改数字。</strong></p>
</blockquote>
<h5 data-id="heading-57">5.4 为什么要单向数据流？</h5>
<p>如果是双向数据流会发生什么？</p>
<p>比如 A 改 B<br/>
B 又改 C<br/>
C 又改 A</p>
<p>你会发现：</p>
<ul>
<li>数据来源变得不可追踪</li>
<li>状态错乱</li>
<li>难以维护</li>
</ul>
<p>单向数据流的优点：</p>
<ul>
<li>数据来源清晰</li>
<li>状态可预测</li>
<li>更容易调试</li>
<li>更适合大型应用</li>
</ul>
<h5 data-id="heading-58">5.5 单向数据流 + 声明式</h5>
<p>React 的核心公式：</p>
<blockquote>
<p>UI = f(state)</p>
</blockquote>
<p>单向数据流保证：</p>
<blockquote>
<p>state 改变 → UI 自动更新</p>
</blockquote>
<p>而不是：</p>
<blockquote>
<p>UI 改变 → 影响 state → 再影响别的 UI</p>
</blockquote>
<h5 data-id="heading-59">5.6 和 Vue 的区别</h5>
<p>Vue 2 有双向绑定：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;input <span class="hljs-attr">v-model</span>=<span class="hljs-string">"msg"</span>&gt;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这属于：</p>
<p> 双向数据绑定（本质还是单向数据流 + 语法糖）</p>
<p>React 则强调：</p>
<ul>
<li>数据只往下流</li>
<li>表单也是受控组件</li>
</ul>
<h5 data-id="heading-60">5.7 总结（面试回答）</h5>
<p>如果问：</p>
<blockquote>
<p>什么是单向数据流？</p>
</blockquote>
<p>可以这样回答：</p>
<blockquote>
<p>单向数据流指数据只能从父组件流向子组件，子组件不能直接修改父组件的数据。当数据发生变化时，会重新渲染 UI，从而保证状态来源清晰、可预测，便于维护和调试。</p>
</blockquote>
<h5 data-id="heading-61"><strong>5.8 核心思想</strong></h5>
<blockquote>
<p>数据只能自上而下流动，所有状态修改必须在源头发生。</p>
</blockquote>
<p>🎯 <strong>共同进步</strong><br/>
作为技术路上的同行者，我深知自己的理解可能还不够完善。<br/>
如果文章中有任何疏漏或可以改进的地方，恳请不吝指教。你的每一次反馈，都是我进步的动力。<br/>
一起加油，成为更好的开发者！</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebGL三角形绘制：掌握缓冲区与基本图元]]></title>    <link>https://juejin.cn/post/7605495714295152666</link>    <guid>https://juejin.cn/post/7605495714295152666</guid>    <pubDate>2026-02-12T06:56:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605495714295152666" data-draft-id="7605535918540390409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebGL三角形绘制：掌握缓冲区与基本图元"/> <meta itemprop="keywords" content="前端,WebGL"/> <meta itemprop="datePublished" content="2026-02-12T06:56:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王校长"/> <meta itemprop="url" content="https://juejin.cn/user/2295436010076631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebGL三角形绘制：掌握缓冲区与基本图元
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436010076631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王校长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:56:22.000Z" title="Thu Feb 12 2026 06:56:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">三角形图元的三种类型</h2>
<p>在WebGL中，三角形是最基本的图元之一，但你知道吗？三角形有三种不同的绘制模式，每种都有其独特用途：</p>
<h3 data-id="heading-1">1. 基本三角形（TRIANGLES）</h3>
<p>这是最常用的三角形绘制方式。每3个顶点构成一个独立的三角形，互不干扰。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 6个顶点绘制2个三角形</span>
<span class="hljs-comment">// [v1, v2, v3] 构成第一个三角形</span>
<span class="hljs-comment">// [v4, v5, v6] 构成第二个三角形</span>
gl.<span class="hljs-title function_">drawArrays</span>(gl.<span class="hljs-property">TRIANGLES</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>); <span class="hljs-comment">// 绘制2个三角形</span>
</code></pre>
<p><strong>绘制三角形数量 = 顶点数 ÷ 3</strong></p>
<h3 data-id="heading-2">2. 三角带（TRIANGLE_STRIP）</h3>
<p>相邻的三角形共享边，效率更高。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 6个顶点可以绘制4个三角形</span>
<span class="hljs-comment">// [v1, v2, v3], [v3, v2, v4], [v3, v4, v5], [v5, v4, v6]</span>
gl.<span class="hljs-title function_">drawArrays</span>(gl.<span class="hljs-property">TRIANGLE_STRIP</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>); <span class="hljs-comment">// 绘制4个三角形</span>
</code></pre>
<p><strong>绘制三角形数量 = 顶点数 - 2</strong></p>
<h3 data-id="heading-3">3. 三角扇（TRIANGLE_FAN）</h3>
<p>所有三角形都以第一个顶点为公共顶点。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 适用于绘制扇形或圆形</span>
gl.<span class="hljs-title function_">drawArrays</span>(gl.<span class="hljs-property">TRIANGLE_FAN</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>); <span class="hljs-comment">// 绘制4个三角形</span>
</code></pre>
<p><strong>绘制三角形数量 = 顶点数 - 2</strong></p>
<h2 data-id="heading-4">绘制固定三角形</h2>
<p>让我们从最简单的固定三角形开始：</p>
<h3 data-id="heading-5">着色器程序</h3>
<p><strong>顶点着色器：</strong></p>
<pre><code class="hljs language-glsl" lang="glsl">// 设置浮点数据类型为中级精度
precision mediump float;
// 接收顶点坐标 (x, y)
attribute vec2 a_Position;

void main(){
   gl_Position = vec4(a_Position, 0, 1);
}
</code></pre>
<p><strong>片元着色器：</strong></p>
<pre><code class="hljs language-glsl" lang="glsl">// 设置浮点数据类型为中级精度
precision mediump float;
// 接收 JavaScript 传过来的颜色值（rgba）
uniform vec4 u_Color;

void main(){
   vec4 color = u_Color / vec4(255, 255, 255, 1);
   gl_FragColor = color;
}
</code></pre>
<h3 data-id="heading-6">JavaScript核心代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义三角形的三个顶点（右下角、左上角、左下角）</span>
<span class="hljs-keyword">var</span> positions = [<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]; <span class="hljs-comment">// 每两个数字代表一个顶点的x、y坐标</span>

<span class="hljs-comment">// 获取着色器变量位置</span>
<span class="hljs-keyword">var</span> a_Position = gl.<span class="hljs-title function_">getAttribLocation</span>(program, <span class="hljs-string">'a_Position'</span>);
<span class="hljs-keyword">var</span> u_Color = gl.<span class="hljs-title function_">getUniformLocation</span>(program, <span class="hljs-string">'u_Color'</span>);

<span class="hljs-comment">// 创建缓冲区</span>
<span class="hljs-keyword">var</span> buffer = gl.<span class="hljs-title function_">createBuffer</span>();

<span class="hljs-comment">// 绑定缓冲区为当前操作对象</span>
gl.<span class="hljs-title function_">bindBuffer</span>(gl.<span class="hljs-property">ARRAY_BUFFER</span>, buffer);

<span class="hljs-comment">// 将顶点数据写入缓冲区</span>
<span class="hljs-comment">// 注意：必须使用类型化数组(Float32Array)传递给WebGL</span>
gl.<span class="hljs-title function_">bufferData</span>(gl.<span class="hljs-property">ARRAY_BUFFER</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(positions), gl.<span class="hljs-property">STATIC_DRAW</span>);

<span class="hljs-comment">// 启用顶点属性</span>
gl.<span class="hljs-title function_">enableVertexAttribArray</span>(a_Position);

<span class="hljs-comment">// 配置顶点属性如何从缓冲区读取数据</span>
<span class="hljs-keyword">var</span> size = <span class="hljs-number">2</span>;        <span class="hljs-comment">// 每次读取2个数据(x, y)</span>
<span class="hljs-keyword">var</span> type = gl.<span class="hljs-property">FLOAT</span>; <span class="hljs-comment">// 数据类型为浮点型</span>
<span class="hljs-keyword">var</span> normalize = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 不需要标准化</span>
<span class="hljs-keyword">var</span> stride = <span class="hljs-number">0</span>;      <span class="hljs-comment">// 步长为0，表示数据连续存放</span>
<span class="hljs-keyword">var</span> offset = <span class="hljs-number">0</span>;      <span class="hljs-comment">// 从缓冲区开始位置读取</span>
gl.<span class="hljs-title function_">vertexAttribPointer</span>(a_Position, size, type, normalize, stride, offset);

<span class="hljs-comment">// 设置颜色并绘制</span>
gl.<span class="hljs-title function_">uniform4f</span>(u_Color, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>); <span class="hljs-comment">// 设置为红色</span>

<span class="hljs-comment">// 绘制三角形</span>
gl.<span class="hljs-title function_">drawArrays</span>(gl.<span class="hljs-property">TRIANGLES</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>); <span class="hljs-comment">// 绘制3个顶点，即1个三角形</span>
</code></pre>
<h2 data-id="heading-7">缓冲区操作详解</h2>
<p>WebGL中的缓冲区是向GPU传递数据的关键工具，以下是其工作流程：</p>
<h3 data-id="heading-8">1. 创建和绑定缓冲区</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建缓冲区对象</span>
<span class="hljs-keyword">var</span> buffer = gl.<span class="hljs-title function_">createBuffer</span>();

<span class="hljs-comment">// 将缓冲区绑定到ARRAY_BUFFER目标</span>
gl.<span class="hljs-title function_">bindBuffer</span>(gl.<span class="hljs-property">ARRAY_BUFFER</span>, buffer);
</code></pre>
<h3 data-id="heading-9">2. 向缓冲区写入数据</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用类型化数组确保数据格式正确</span>
<span class="hljs-keyword">var</span> typedArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>([x1, y1, x2, y2, x3, y3]);
gl.<span class="hljs-title function_">bufferData</span>(gl.<span class="hljs-property">ARRAY_BUFFER</span>, typedArray, gl.<span class="hljs-property">STATIC_DRAW</span>);
</code></pre>
<h3 data-id="heading-10">3. 配置顶点属性指针</h3>
<pre><code class="hljs language-javascript" lang="javascript">gl.<span class="hljs-title function_">enableVertexAttribArray</span>(attributeLocation);
gl.<span class="hljs-title function_">vertexAttribPointer</span>(
    attributeLocation, <span class="hljs-comment">// attribute变量位置</span>
    size,              <span class="hljs-comment">// 每个顶点包含的分量数(2=x,y; 3=x,y,z)</span>
    type,              <span class="hljs-comment">// 数据类型</span>
    normalize,         <span class="hljs-comment">// 是否标准化</span>
    stride,            <span class="hljs-comment">// 步长</span>
    offset             <span class="hljs-comment">// 偏移量</span>
);
</code></pre>
<p><strong>重要提示：</strong> WebGL要求强类型数据，JavaScript中的普通数组必须转换为类型化数组（如Float32Array）才能传递给GPU。</p>
<h2 data-id="heading-11">动态绘制三角形</h2>
<p>现在让我们实现一个交互式功能：点击三次鼠标绘制一个三角形。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2998b98388b42f5a27319e1956f7e35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5qCh6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771484182&amp;x-signature=VZC8G4avEhTJH178J7fAgzVKl8A%3D" alt="screen_recording_2026-02-12_14-54-03.gif" loading="lazy"/></p>
<h3 data-id="heading-12">增强版顶点着色器</h3>
<pre><code class="hljs language-glsl" lang="glsl">// 设置浮点数精度为中等精度
precision mediump float;
// 接收顶点坐标 (x, y)
attribute vec2 a_Position;
// 接收 canvas 的尺寸(width, height)
attribute vec2 a_Screen_Size;

void main(){
    // 将canvas坐标转换为NDC坐标(-1到1的范围)
    vec2 position = (a_Position / a_Screen_Size) * 2.0 - 1.0;
    position = position * vec2(1.0, -1.0); // 翻转Y轴
    gl_Position = vec4(position, 0, 1);
}
</code></pre>
<h3 data-id="heading-13">交互式JavaScript实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 存储点击位置的数组</span>
<span class="hljs-keyword">var</span> positions = [];

<span class="hljs-comment">// 绑定鼠标点击事件</span>
canvas.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mouseup'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">var</span> x = e.<span class="hljs-property">offsetX</span>; <span class="hljs-comment">// 相对于canvas的X坐标</span>
    <span class="hljs-keyword">var</span> y = e.<span class="hljs-property">offsetHeight</span> - e.<span class="hljs-property">offsetY</span>; <span class="hljs-comment">// 转换Y坐标系统</span>
    positions.<span class="hljs-title function_">push</span>(x, y);
    
    <span class="hljs-comment">// 当顶点数是6的倍数时（即3个点），绘制一个三角形</span>
    <span class="hljs-keyword">if</span> (positions.<span class="hljs-property">length</span> % <span class="hljs-number">6</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 更新缓冲区数据</span>
        gl.<span class="hljs-title function_">bindBuffer</span>(gl.<span class="hljs-property">ARRAY_BUFFER</span>, buffer);
        gl.<span class="hljs-title function_">bufferData</span>(gl.<span class="hljs-property">ARRAY_BUFFER</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float32Array</span>(positions), gl.<span class="hljs-property">DYNAMIC_DRAW</span>);
        
        <span class="hljs-comment">// 重新绘制所有三角形</span>
        <span class="hljs-title function_">redraw</span>();
    }
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">redraw</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 清空画布</span>
    gl.<span class="hljs-title function_">clearColor</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1.0</span>);
    gl.<span class="hljs-title function_">clear</span>(gl.<span class="hljs-property">COLOR_BUFFER_BIT</span>);
    
    <span class="hljs-comment">// 绘制所有三角形</span>
    gl.<span class="hljs-title function_">drawArrays</span>(gl.<span class="hljs-property">TRIANGLES</span>, <span class="hljs-number">0</span>, positions.<span class="hljs-property">length</span> / <span class="hljs-number">2</span>);
}
</code></pre>
<h2 data-id="heading-14">核心概念总结</h2>
<h3 data-id="heading-15">缓冲区操作流程</h3>
<ol>
<li><code>gl.createBuffer()</code> - 创建缓冲区对象</li>
<li><code>gl.bindBuffer()</code> - 绑定为当前操作缓冲区</li>
<li><code>gl.bufferData()</code> - 向缓冲区写入数据</li>
<li><code>gl.enableVertexAttribArray()</code> - 启用顶点属性</li>
<li><code>gl.vertexAttribPointer()</code> - 配置属性读取方式</li>
<li><code>gl.drawArrays()</code> - 执行绘制</li>
</ol>
<h3 data-id="heading-16">类型化数组的重要性</h3>
<ul>
<li>JavaScript普通数组无法直接传递给WebGL</li>
<li>必须使用Float32Array等类型化数组</li>
<li>确保数据格式与GPU要求一致</li>
</ul>
<h3 data-id="heading-17">坐标转换</h3>
<ul>
<li>Canvas坐标系：左上角(0,0)，Y轴向下</li>
<li>WebGL坐标系：中心(0,0)，Y轴向上</li>
<li>需要进行坐标转换才能正确显示</li>
</ul>
<p>掌握了三角形绘制和缓冲区操作，你就迈出了WebGL高级渲染的第一步！接下来可以尝试绘制更多有趣的图形。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[sms-activate 已经跑路了]]></title>    <link>https://juejin.cn/post/7605537925148704820</link>    <guid>https://juejin.cn/post/7605537925148704820</guid>    <pubDate>2026-02-12T06:54:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605537925148704820" data-draft-id="7605489943868768271" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="sms-activate 已经跑路了"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-12T06:54:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="suedar"/> <meta itemprop="url" content="https://juejin.cn/user/1222312660304318"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            sms-activate 已经跑路了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1222312660304318/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    suedar
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T06:54:37.000Z" title="Thu Feb 12 2026 06:54:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c9c0b2d3a374a6197d2520aea459b77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VlZGFy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771484076&amp;x-signature=W0xOUEjpIH%2BJRcccGsEdsQzZX%2BY%3D" alt="image.png" loading="lazy"/></p>
<p>最近刚好想用一下，打开网站发现已经永久闭站了，这家存活十年的接码平台也顶不住监管压力，有其他博主指出是由于美国新提出的运营商手机号溯源法案，导致很多平台都用不了 sms-activate 上面的手机号了。</p>
<p>1月份的时候还可以退款或者把帐户里的金额转移，不过发现的时候已经是二月份了，所以里面的💰也只能被平台吞了。</p>
<p>原网站推荐了hero-sms这个平台，但是原网站的金额没有平移到新网站里面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9679e4cb49f84c919b1e7c63edb73dad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VlZGFy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771484076&amp;x-signature=vHtanPt%2BHolWoJlwBLA4HpSSH2I%3D" alt="image.png" loading="lazy"/></p>
<p>我试了一下他推荐的hero-sms，最少也是充值💲3.4。</p>
<p>这种平台还是建议大家不要充值太多钱，一旦跑路真是血本无归。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[易捷问数（NewmindExAI）平台解决 ES 升级后 AI 助手与 Attack Discovery 不正常问题]]></title>    <link>https://juejin.cn/post/7605421123187523611</link>    <guid>https://juejin.cn/post/7605421123187523611</guid>    <pubDate>2026-02-12T04:24:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605421123187523611" data-draft-id="7605421123187490843" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="易捷问数（NewmindExAI）平台解决 ES 升级后 AI 助手与 Attack Discovery 不正常问题"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2026-02-12T04:24:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            易捷问数（NewmindExAI）平台解决 ES 升级后 AI 助手与 Attack Discovery 不正常问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T04:24:30.000Z" title="Thu Feb 12 2026 04:24:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 新智锦绣 Jin Haifeng </p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2de7af06b41484ca866e19aee983828~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771475069&amp;x-signature=ScUdfWX0yaiCM3bUSRWetsn%2Bffo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>上期我们介绍<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F158000898" title="https://elasticstack.blog.csdn.net/article/details/158000898" target="_blank" ref="nofollow noopener noreferrer">将 Elasticsearch 集群从 8.17.2 升级到了最新的 9.2.4 版本</a>。虽然官方文档明确指出不能直接跨大版本升级，但实际操作中仍然遇到了一些意想不到的问题。升级后所有日志索引都可以正常工作，但升级后 AI 助手和 Attack Discovery 功能失效。虽然成功可以 AI 大模型连接正常，但 AI 助手及知识库和 attack discovery 都不能正常工作。</p>
<p>查询了 Elastic 官网/support 知识库，也没找到直接的类似问题的解决方案。最后使用新智锦绣科技（北京）有限公司开发的 NewmindExAI 易捷问数平台，成功找到问题原因及解决方法。</p>
<p>如果你也在考虑升级 Elasticsearch 到 9.x 版本，或者遇到了类似的 AI 功能异常问题，希望这篇文章能为你提供一些参考和帮助。</p>
<hr/>
<h2 data-id="heading-1">一、NewmindExAI 易捷问数平台</h2>
<p>易捷问数平台（NewmindExAI）是一款开箱即用的企业级一体化智能数据分析平台，基于 Apple Mac Studio 硬件，以 Elastic 为数据底座，同时支持集成第三方多种数据源，集成本地 LLM、NewRAG 智能知识库、NewFlow 智能中枢工作流、NewChat 智能聊天为一体，实现 LLM 驱动的认知一体化解决方案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6965fb30d4194eb28ece32dd42e97a06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771475069&amp;x-signature=NjO3xNBcL8sZhWpLsbpQ8siiC0Q%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-2">二、意外出现：AI 助手功能异常</h2>
<h3 data-id="heading-3">2.1 问题发现</h3>
<p>ES 9.2.4升级完成后，当尝试使用 Security → Attack Discovery 功能时，遇到了以下错误：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`Attack discovery data client not initialized`</span>AI写代码
</code></pre>
<p>当然首先到 chatgpt 去找答案，经过一番问答交互，无果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d888aa01dd3435faaf0b4b7bc81eece~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771475069&amp;x-signature=XNBHa3CesihhBdON1WU%2F662G4vc%3D" alt="Image" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ff6e850274c4a5ba329538d96ff4901~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771475069&amp;x-signature=5LdmS3fxoVCl6yd9T1xCruc4sww%3D" alt="Image" loading="lazy"/></p>
<p>由于 NewChat（NewmindExAI）的智能聊天工具是直接通过 mcp 连接到 ES 环境中的，它是对当前集群环境可以直接感知的。下面是和它交互后给出的答复：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1e2169ef9354d8fb6bba7c60dcab2fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771475069&amp;x-signature=%2BTSFIjlacCe9v3wIHlANe6AX1Lw%3D" alt="Image" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffc7f406d6c64fc4998ab61ea10c1006~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771475069&amp;x-signature=toqD7YRLV9EqfW3OGNUH5wTMnXA%3D" alt="Image" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc22f3e82cee4cc5b54dc2881b2bf931~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771475069&amp;x-signature=Ejv3LOOrV5sORKb%2Bmi3GLQNPLZ4%3D" alt="Image" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c703ec8062a4a55bb49579903fae67d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771475069&amp;x-signature=NXGn%2Fjf9H8FJ8lsZxdTnyx3H%2Fdw%3D" alt="Image" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6adfc6312cc8452584d9693b0d5fc313~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771475069&amp;x-signature=KvBWP6yjC7aQK66USbqeFS5%2FM%2FU%3D" alt="Image" loading="lazy"/></p>
<p>经过上面的错误信息给 NewChat 分析和交互，了解到这个问题是由于版本升级后索引不兼容造成的：</p>
<h3 data-id="heading-4">2.2 问题分析</h3>
<p>NewChat 从给出的日志信息找到问题：</p>
<p><code>Mapper for [semantic_text] conflicts with existing mapper:``Cannot update parameter [inference_id] from [elastic-security-ai-assistant-elser2] to [.elser-2-elasticsearch]</code></p>
<p>这个错误说明：</p>
<ul>
<li>旧版本配置：8.x 版本使用的是自定义 ELSER 模型 elastic-security-ai-assistant-elser2</li>
<li>新版本配置：9.x 版本尝试使用标准 ELSER 模型 .elser-2-elasticsearch</li>
<li>Elasticsearch 限制：不允许直接修改已存在字段的 inference_id 参数</li>
</ul>
<h3 data-id="heading-5">2.3 受影响的索引</h3>
<p>同时也找到以下索引存在映射冲突：</p>
<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  ​​​​​​​​​​​​​​.kibana-elastic-ai-assistant-conversations-*
<span class="hljs-bullet">2.</span>  .kibana-elastic-ai-assistant-knowledge-base-*
<span class="hljs-bullet">3.</span>  .kibana-observability-ai-assistant-conversations-*
<span class="hljs-bullet">4.</span>  .kibana-observability-ai-assistant-kb-*

`AI写代码
</code></pre>
<hr/>
<h2 data-id="heading-6">三、解决方案：删除并重建 AI 助手索引</h2>
<h3 data-id="heading-7">3.1 解决思路</h3>
<p>经过分析，我们确定了解决方案：</p>
<ul>
<li>删除冲突的索引：移除包含旧映射的 AI 助手索引</li>
<li>重启 Kibana：让 Kibana 使用新的映射重新创建索引</li>
<li>重新配置 AI 连接器：确保使用正确的 AI 模型配置</li>
</ul>
<h3 data-id="heading-8">3.2 详细操作步骤</h3>
<h4 data-id="heading-9">步骤 1：查找冲突的索引</h4>
<p>首先，我们需要确认哪些索引存在问题：​​​​​​​</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  <span class="hljs-comment">#通过 Kibana Dev Tools 执行</span>
2.  GET /_cat/indices/.kibana-*ai-assistant*?v

`AI写代码
</code></pre>
<h4 data-id="heading-10">步骤 2：通过 Kibana Dev Tools 删除索引</h4>
<p>打开 Kibana → Dev Tools</p>
<p>在 Console 中执行以下命令：</p>
<pre><code class="hljs language-sql" lang="sql"> `<span class="hljs-number">1.</span>   <span class="hljs-operator">/</span><span class="hljs-operator">/</span>由于这些索引是由data_stream关联，无法直接删除索引，我们可以删除数据流来解决

<span class="hljs-number">3.</span>  <span class="hljs-keyword">DELETE</span> <span class="hljs-operator">/</span>_data_stream<span class="hljs-operator">/</span>logs<span class="hljs-operator">-</span>elastic_agent.fleet_server<span class="hljs-operator">-</span><span class="hljs-keyword">default</span>
<span class="hljs-number">4.</span>  <span class="hljs-keyword">DELETE</span> <span class="hljs-operator">/</span>_data_stream<span class="hljs-operator">/</span>metrics<span class="hljs-operator">-</span>fleet_server.agent_status<span class="hljs-operator">-</span><span class="hljs-keyword">default</span>
<span class="hljs-number">5.</span>  <span class="hljs-keyword">DELETE</span> <span class="hljs-operator">/</span>_data_stream<span class="hljs-operator">/</span>metrics<span class="hljs-operator">-</span>elastic_agent.fleet_server<span class="hljs-operator">-</span><span class="hljs-keyword">default</span>
<span class="hljs-number">6.</span>  <span class="hljs-keyword">DELETE</span> <span class="hljs-operator">/</span>_data_stream<span class="hljs-operator">/</span>logs<span class="hljs-operator">-</span>elastic_agent.fleet_server<span class="hljs-operator">-</span><span class="hljs-keyword">default</span>`AI写代码
</code></pre>
<p>点击 ▶️ 执行按钮</p>
<p>执行结果：</p>
<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  {

<span class="hljs-bullet">3.</span>    "acknowledged":true
<span class="hljs-bullet">4.</span>  }

`AI写代码
</code></pre>
<p>✅索引删除成功！</p>
<h4 data-id="heading-11">步骤 3：重启 Kibana 服务</h4>
<pre><code class="hljs language-bash" lang="bash">`

1.  <span class="hljs-comment"># 在 elastic-03 节点执行</span>
2.  sudo systemctl restart kibana
3.  <span class="hljs-comment"># 查看启动日志</span>
4.  sudo <span class="hljs-built_in">tail</span> -f /var/log/kibana/kibana.log

`AI写代码
</code></pre>
<p>观察日志，应该看到类似以下内容：</p>
<pre><code class="hljs language-bash" lang="bash"> `2.  {
3.    <span class="hljs-string">"message"</span>:<span class="hljs-string">"Installing index template .kibana-elastic-ai-assistant-index-template-conversations"</span>,
4.    <span class="hljs-string">"log"</span>: {
5.      <span class="hljs-string">"level"</span>:<span class="hljs-string">"INFO"</span>,
6.      <span class="hljs-string">"logger"</span>:<span class="hljs-string">"plugins.elasticAssistant.service"</span>
7.    }
8.  }

10.  {
11.    <span class="hljs-string">"message"</span>:<span class="hljs-string">"Installing index template .kibana-elastic-ai-assistant-index-template-knowledge-base"</span>,
12.    <span class="hljs-string">"log"</span>: {
13.      <span class="hljs-string">"level"</span>:<span class="hljs-string">"INFO"</span>,
14.      <span class="hljs-string">"logger"</span>:<span class="hljs-string">"plugins.elasticAssistant.service"</span>
15.    }
16.  }`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>这表明 Kibana 正在使用新的映射重新创建索引。</p>
<h4 data-id="heading-12">步骤 4：配置 AI 连接器</h4>
<p>重启完成后，需要配置 AI 连接器：</p>
<ol>
<li>
<p>进入Stack Management → Connectors</p>
</li>
<li>
<p>点击Create connector</p>
</li>
<li>
<p>选择你的 AI 提供商（如 OpenAI、Azure OpenAI、阿里云通义千问等）</p>
</li>
<li>
<p>填写配置信息</p>
<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  Name:Attack Discovery AI
<span class="hljs-bullet">2.</span>  Connector type:OpenAI (或其他)
<span class="hljs-bullet">3.</span>  URL:https://api.openai.com/v1
<span class="hljs-bullet">4.</span>  API Key:sk-xxxxx...
<span class="hljs-bullet">5.</span>  Model:gpt-4

`AI写代码
</code></pre>
</li>
<li>
<p>点击 <strong>Save</strong></p>
</li>
</ol>
<h4 data-id="heading-13">步骤 5：在 Security 中配置 AI 助手</h4>
<ol>
<li>
<p>进入Security → Get Started</p>
</li>
<li>
<p>点击右上角的齿轮图标 →Settings</p>
</li>
<li>
<p>找到AI Assistant部分</p>
</li>
<li>
<p>选择刚才创建的连接器</p>
</li>
<li>
<p>保存设置</p>
</li>
</ol>
<h3 data-id="heading-14">3.3 验证修复结果</h3>
<h4 data-id="heading-15">（1）检查索引状态</h4>
<pre><code class="hljs language-arduino" lang="arduino">`

<span class="hljs-number">1.</span>  # 通过 Dev Tools 执行
<span class="hljs-number">2.</span>  GET /_cat/indices/.kibana-*ai-assistant*?v
<span class="hljs-number">3.</span>  # 应该看到新创建的索引：
<span class="hljs-number">4.</span>  health status index                                                                           uuid                   pri rep docs.count docs.deleted store.size pri.store.size dataset.size
<span class="hljs-number">5.</span>  green  open   .ds-.kibana-elastic-ai-assistant-prompts-<span class="hljs-keyword">default</span><span class="hljs-number">-2026.02</span><span class="hljs-number">.08</span><span class="hljs-number">-000001</span>              NNLDhE4HQC26EDvGL1bQzw   <span class="hljs-number">1</span>   <span class="hljs-number">1</span>          <span class="hljs-number">0</span>            <span class="hljs-number">0</span>       <span class="hljs-number">498b</span>           <span class="hljs-number">249b</span>         <span class="hljs-number">249b</span>
<span class="hljs-number">6.</span>  green  open   .kibana-observability-ai-assistant-conversations<span class="hljs-number">-000001</span>                         ynEBvh06QFWCjF7UKQVZyA   <span class="hljs-number">1</span>   <span class="hljs-number">1</span>          <span class="hljs-number">0</span>            <span class="hljs-number">0</span>       <span class="hljs-number">498b</span>           <span class="hljs-number">249b</span>         <span class="hljs-number">249b</span>
<span class="hljs-number">7.</span>  green  open   .ds-.kibana-elastic-ai-assistant-knowledge-base-<span class="hljs-keyword">default</span><span class="hljs-number">-2026.02</span><span class="hljs-number">.08</span><span class="hljs-number">-000001</span>       MUH-wCUiQsCFa_02zYjz2g   <span class="hljs-number">1</span>   <span class="hljs-number">1</span>          <span class="hljs-number">0</span>            <span class="hljs-number">0</span>       <span class="hljs-number">498b</span>           <span class="hljs-number">249b</span>         <span class="hljs-number">249b</span>
<span class="hljs-number">8.</span>  green  open   .kibana-observability-ai-assistant-kb<span class="hljs-number">-000003</span>                                    HYawJO5QRlqkZVqlYe7d5g   <span class="hljs-number">1</span>   <span class="hljs-number">1</span>          <span class="hljs-number">0</span>            <span class="hljs-number">0</span>       <span class="hljs-number">498b</span>           <span class="hljs-number">249b</span>         <span class="hljs-number">249b</span>
<span class="hljs-number">9.</span>  green  open   .kibana-elastic-ai-assistant-checkpoints-<span class="hljs-keyword">default</span>                                bgD7_49dTzS6GGD_0RzZhg   <span class="hljs-number">1</span>   <span class="hljs-number">1</span>          <span class="hljs-number">0</span>            <span class="hljs-number">0</span>       <span class="hljs-number">498b</span>           <span class="hljs-number">249b</span>         <span class="hljs-number">249b</span>
<span class="hljs-number">10.</span>  green  open   .ds-.kibana-elastic-ai-assistant-anonymization-fields-<span class="hljs-keyword">default</span><span class="hljs-number">-2026.02</span><span class="hljs-number">.08</span><span class="hljs-number">-000001</span> gTxmh6GRTZGnc3PXKqDtEw   <span class="hljs-number">1</span>   <span class="hljs-number">1</span>        <span class="hljs-number">114</span>            <span class="hljs-number">0</span>     <span class="hljs-number">28.4</span>kb         <span class="hljs-number">14.2</span>kb       <span class="hljs-number">14.2</span>kb
<span class="hljs-number">11.</span>  green  open   .ds-.kibana-elastic-ai-assistant-alert-summary-<span class="hljs-keyword">default</span><span class="hljs-number">-2026.02</span><span class="hljs-number">.08</span><span class="hljs-number">-000001</span>        nvWnxOVuS_WWbb8C0kSdXQ   <span class="hljs-number">1</span>   <span class="hljs-number">1</span>          <span class="hljs-number">0</span>            <span class="hljs-number">0</span>       <span class="hljs-number">498b</span>           <span class="hljs-number">249b</span>         <span class="hljs-number">249b</span>
<span class="hljs-number">12.</span>  green  open   .ds-.kibana-elastic-ai-assistant-conversations-<span class="hljs-keyword">default</span><span class="hljs-number">-2026.02</span><span class="hljs-number">.08</span><span class="hljs-number">-000001</span>        IAReR9kcTy66EFH2CXy79w   <span class="hljs-number">1</span>   <span class="hljs-number">1</span>          <span class="hljs-number">0</span>            <span class="hljs-number">0</span>       <span class="hljs-number">498b</span>           <span class="hljs-number">249b</span>         <span class="hljs-number">249b</span>
<span class="hljs-number">13.</span>  green  open   .kibana-elastic-ai-assistant-checkpoint-writes-<span class="hljs-keyword">default</span>

`AI写代码![](https:<span class="hljs-comment">//csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)</span>
</code></pre>
<h4 data-id="heading-16">（2）检查映射配置</h4>
<pre><code class="hljs language-csharp" lang="csharp"> `<span class="hljs-number">2.</span>  GET /.kibana-elastic-ai-assistant-knowledge-<span class="hljs-keyword">base</span>-<span class="hljs-literal">default</span>/_mapping`AI写代码
</code></pre>
<p>确认 inference_id 使用的是新的标准模型：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  {
2.    <span class="hljs-string">"mappings"</span>: {
3.      <span class="hljs-string">"properties"</span>: {
4.        <span class="hljs-string">"semantic_text"</span>: {
5.          <span class="hljs-string">"type"</span>: <span class="hljs-string">"semantic_text"</span>,
6.          <span class="hljs-string">"inference_id"</span>: <span class="hljs-string">".elser-2-elasticsearch"</span>
7.        }
8.      }
9.    }
10.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>✅映射配置正确！</p>
<h4 data-id="heading-17">（3）测试 Attack Discovery 功能</h4>
<ol>
<li>
<p>进入Security → Attack Discovery</p>
</li>
<li>
<p>点击Generate按钮</p>
</li>
<li>
<p>等待分析完成（可能需要几分钟）</p>
</li>
</ol>
<p>最后一切正常，你应该能看到 AI 分析的安全威胁发现结果。</p>
<hr/>
<h2 data-id="heading-18">七、总结</h2>
<p>由于 NewCha t是直接和 ES 集群通过 MCP 连接在一起的，所以在 NewChat 里借助大模型来问数，就像 RAG 一样它 get 到的信息是当前集群的真实状态，从而保证借助大模型进行真实状态分析会给出更实际的答案。</p>
<p>而通过常规的 ChatGPT 类的聊天工具，我们只能把日志信息和特征码粘贴过去，由于它触摸不到真实的集群环境，所以只能猜测可能故障原因，无法给出更实际的答案。</p>
<h2 data-id="heading-19">写在最后</h2>
<p>Elasticsearch 的版本升级是一项需要谨慎对待的工作，特别是跨大版本升级。对于在低版AI助手相关功能正常（企业版），升级后AI助手由于模型变更及兼容性问无法正常工作，所以集群本身的问题无法通过AI助手来获得得答案和进行诊断。</p>
<p>而 NewmindExAI 通过 MCP 连接到 ES 集群，充分补充了 ES 企业版才有的 AI 功能，从而极大地赋能 ES AI 能力。</p>
<blockquote>
<p>Elasticsearch 官方升级指南</p>
<p>Kibana AI Assistant 文档</p>
<p>Elasticsearch Breaking Changes in 9.0</p>
</blockquote>
<p>如果觉得本文对你有帮助，欢迎点赞、转发、收藏！</p>
<p><strong>关于公司</strong></p>
<p>感谢您关注<strong>新智锦绣科技（北京）有限公司</strong>！作为 Elastic 的 Elite 合作伙伴及 EnterpriseDB 在国内的唯一代理和服务合作伙伴，我们始终致力于技术创新和优质服务，帮助企业客户实现数据平台的高效构建与智能化管理。无论您是关注 Elastic 生态系统，还是需要 EnterpriseDB 的支持，我们都将为您提供专业的技术支持和量身定制的解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[网易一面：KAFKA写入数据时是先写Leader还是先写Follower?]]></title>    <link>https://juejin.cn/post/7605469747259129891</link>    <guid>https://juejin.cn/post/7605469747259129891</guid>    <pubDate>2026-02-12T05:29:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605469747259129891" data-draft-id="7605184380611526708" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="网易一面：KAFKA写入数据时是先写Leader还是先写Follower?"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2026-02-12T05:29:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员飞鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1665088861772688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            网易一面：KAFKA写入数据时是先写Leader还是先写Follower?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1665088861772688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员飞鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T05:29:42.000Z" title="Thu Feb 12 2026 05:29:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p><strong>文章内容收录到个人网站，方便阅读</strong>：<a href="https://link.juejin.cn?target=http%3A%2F%2Fhardyfish.top%2F" target="_blank" title="http://hardyfish.top/" ref="nofollow noopener noreferrer">hardyfish.top/</a></p>
<p>Kafka 的写入路径是<strong>先写 Leader，再由 Leader 复制到 Followers</strong>。</p>
<blockquote>
<p>对生产者而言是否等 Followers取决于 <strong>acks（确认级别）</strong>。</p>
<p>不存在生产者直接同时写 Leader 和 Follower的机制，复制由 Leader 侧串起完成。</p>
</blockquote>
<p>写入链路：Leader 串行落盘，Followers 异步拉取复制</p>
<p>一次写入在分区（partition）维度上发生：</p>
<ul>
<li>生产者把记录发给该分区的 <strong>Leader 副本</strong>（leader replica）。</li>
<li>Leader 将记录追加到本地日志（log）并更新高水位相关状态。</li>
<li>各 <strong>Follower 副本</strong>并不接受生产者写入，而是通过复制线程向 Leader 发起 <strong>Fetch</strong> 拉取新数据，写入各自本地日志。</li>
<li>当副本赶上并满足条件时，Leader 推进 <strong>HW（High Watermark，高水位）</strong>，表示已提交（committed）的偏移。</li>
</ul>
<p>因此，从时序看是：<strong>生产者 → Leader 写入 → Followers 拉取复制</strong>。</p>
<p>Followers 的写入相对 Leader 是滞后的，滞后程度由网络、磁盘、负载与副本数共同决定。</p>
<p><strong>acks 决定写到哪一步才算成功</strong></p>
<p>生产者感知到的写成功由 <code>acks</code> 决定：</p>
<ul>
<li><code>acks=0</code>：生产者不等任何确认。
<ul>
<li>Leader 是否写入、Follower 是否复制都不保证，吞吐高但丢数据风险最大。</li>
</ul>
</li>
<li><code>acks=1</code>：Leader 写入本地日志后返回确认。
<ul>
<li>Followers 可能还没复制完成。</li>
<li>Leader 宕机且数据尚未复制时可能丢失。</li>
</ul>
</li>
<li><code>acks=all</code>（或 <code>acks=-1</code>）：
<ul>
<li>Leader 不仅要写入，还要等待数据被复制到 **ISR（In-Sync Replicas，同步副本集合）**中的足够副本后再确认。</li>
<li>通常语义是至少写到所有 ISR 副本，更接近强持久，但延迟更高。</li>
</ul>
</li>
</ul>
<p>这里的关键点是：即便 <code>acks=all</code>，也是 <strong>Leader 等 Followers 复制完成后再回 ACK</strong>，而不是生产者并行写多份。</p>
<p><strong>提交可读与已写入不是同一件事</strong></p>
<p>Kafka 有两个容易混淆的状态：</p>
<ul>
<li><strong>已写入（written）</strong>：Leader 日志已经追加了这条记录。</li>
<li><strong>已提交（committed）</strong>：记录的偏移不超过 HW，意味着已被 ISR 复制到位。
<ul>
<li>消费者在默认隔离级别下通常只会稳定读取到 committed 数据。</li>
</ul>
</li>
</ul>
<p>当 <code>acks=1</code> 时，写入成功返回可能早于 committed。</p>
<p>当 <code>acks=all</code> 时，返回更接近 committed（在 ISR 机制正常工作前提下）。</p>
<p><strong>常见误区：以为同时写能降低复制延迟</strong></p>
<p>直觉上生产者同时写多个副本似乎更快，但 Kafka 的一致性与顺序保证依赖 <strong>Leader 统一仲裁与定序</strong>：</p>
<ul>
<li>单点定序：Leader 负责为分区内消息分配顺序与 offset。</li>
<li>复制一致：Followers 通过同一个 Leader 拉取同一条日志流，保证副本间顺序一致。</li>
<li>故障切换：ISR 与 HW 机制围绕 Leader 的状态推进，简化一致性判断。</li>
</ul>
<p>因此，Kafka 选择Leader 写入 + Followers 拉取是为了在吞吐、顺序、一致性与故障恢复之间取平衡，而不是追求生产者侧的并行多写。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零起步学习Redis || 第十章：主从复制的实现流程与常见问题处理方案深层解析]]></title>    <link>https://juejin.cn/post/7605416964510760987</link>    <guid>https://juejin.cn/post/7605416964510760987</guid>    <pubDate>2026-02-12T04:31:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605416964510760987" data-draft-id="7605535918539735049" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零起步学习Redis || 第十章：主从复制的实现流程与常见问题处理方案深层解析"/> <meta itemprop="keywords" content="服务器,Redis"/> <meta itemprop="datePublished" content="2026-02-12T04:31:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="茶杯梦轩"/> <meta itemprop="url" content="https://juejin.cn/user/195039473183699"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零起步学习Redis || 第十章：主从复制的实现流程与常见问题处理方案深层解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/195039473183699/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    茶杯梦轩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T04:31:45.000Z" title="Thu Feb 12 2026 04:31:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">一、前言</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94b7a98df3d44493b75660c1c16661de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iy25p2v5qKm6L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771475505&amp;x-signature=TaeSIR5pyvudtzRAFeXRVCaHIug%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>Redis 的主从复制（Replication）是 Redis 高可用架构的基础之一。<br/>
通过复制机制，可以实现数据的<strong>冗余备份</strong>、<strong>读写分离</strong>、<strong>负载均衡</strong>，并为后续的哨兵（Sentinel）<strong>和</strong>集群（Cluster）提供支撑。</p>
<p>本文将从 Redis 的<strong>内部机制角度</strong>出发，深入分析主从复制是如何在底层实现的，包括核心流程、关键数据结构、协议交互和优化机制。</p>
<hr/>
<h2 data-id="heading-1">二、主从复制的整体流程概览</h2>
<p>Redis 主从复制的整个过程可以分为 <strong>三个阶段</strong>：</p>
<ol>
<li><strong>建立连接阶段</strong>（主从握手）</li>
<li><strong>数据同步阶段</strong>（全量复制或部分复制）</li>
<li><strong>命令传播阶段</strong>（实时增量同步）</li>
</ol>
<p>整体思想是：</p>
<blockquote>
<p>从节点通过 psync 命令与主节点进行握手，完成一次性数据同步（RDB + backlog），然后实时接收主节点写命令，从而保持与主节点数据一致。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">三、阶段一：主从握手（连接建立）</h2>
<p>当一个从节点启动并配置主节点地址后</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e11280cbcf3f446092f10cc914d7a6ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iy25p2v5qKm6L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771475505&amp;x-signature=KqrUFgW1K6hu0UElZs1Gvr3ugAs%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>，会主动向主节点发起复制请求：</p>
<pre><code class="hljs language-diff" lang="diff">PSYNC ? -1
?:主服务器的ID，因为第一次连接不知道主服务器的Id，所以用？表示
<span class="hljs-deletion">-1：复制的进度</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这条命令表示：</p>
<ul>
<li>“我没有历史同步信息（第一次连接）”</li>
<li>“请告诉我该从哪里开始复制”</li>
</ul>
<p>主节点收到 <code>PSYNC</code> 请求后，会做以下判断：</p>
<ul>
<li>如果是第一次连接 → 返回 <code>+FULLRESYNC &lt;run_id&gt; &lt;offset&gt;</code>（全量复制）</li>
<li>如果 run_id 匹配且 offset 合法 → 返回 <code>+CONTINUE</code>（部分复制）</li>
</ul>
<hr/>
<h3 data-id="heading-3">关键点解释：</h3>





















<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><strong>run_id</strong></td><td>主节点实例的唯一标识符（每次重启会重新生成）</td></tr><tr><td><strong>offset</strong></td><td>主从之间同步的“命令流偏移量”，用于标记同步进度</td></tr><tr><td><strong>PSYNC</strong></td><td>Redis 复制协议的核心命令，用于协调全量或增量复制</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">四、阶段二：数据同步阶段</h2>
<h3 data-id="heading-5"> 全量复制（Full Resynchronization）</h3>
<p>当主节点发现从节点没有旧数据或偏移信息时，就会触发全量复制。</p>
<p><strong>内部执行过程如下：</strong></p>
<ol>
<li>
<p><strong>主节点执行 <code>BGSAVE</code></strong></p>
<ul>
<li>创建后台子进程，生成当前内存数据的 RDB 快照；</li>
<li>主线程继续响应客户端请求；</li>
<li>所有新的写命令会暂存到 <strong>复制缓冲区（replication buffer）</strong> 中。</li>
</ul>
</li>
<li>
<p><strong>传输 RDB 快照</strong></p>
<ul>
<li>RDB 生成完毕后，主节点通过 socket 发送给从节点；</li>
<li>从节点清空现有数据；</li>
<li>从节点加载 RDB 文件，恢复数据。</li>
</ul>
</li>
<li>
<p><strong>发送 backlog 中的增量命令</strong></p>
<ul>
<li>主节点会将 RDB 生成期间积累的命令（在<strong>复制缓冲区（replication buffer）中</strong>）同步发送给从节点；</li>
<li>从节点执行这些命令，使数据状态追上主节点。</li>
</ul>
</li>
</ol>
<p><strong>至此，第一次同步工作完成</strong></p>
<p><strong>优点：</strong> 保证数据完整<br/>
<strong>缺点：</strong> 对带宽和磁盘开销大，耗时较长</p>
<hr/>
<h2 data-id="heading-6">五、阶段三：命令传播阶段（实时同步）</h2>
<p>一旦主从数据完全一致，主节点会持续地将新的写命令实时发送给从节点。（基于TCP长连接）</p>
<h3 data-id="heading-7"><strong>主节点的行为：</strong></h3>
<ul>
<li>
<p>每当执行一个写操作（如 <code>SET key value</code>）：</p>
<ol>
<li>写入主节点内存；</li>
<li>将命令追加到复制缓冲区；</li>
<li>异步发送给所有从节点。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-8"><strong>从节点的行为：</strong></h3>
<ul>
<li>从节点以“伪客户端”的身份接收主节点发来的命令；</li>
<li>解析后执行这些命令，更新自身数据；</li>
<li>定期向主节点汇报自己的复制偏移量（offset）。</li>
</ul>
<p>这个阶段是<strong>异步</strong>的：<br/>
主节点<strong>不会等待从节点确认</strong>即可向客户端返回结果。<br/>
因此可能存在<strong>数据丢失的风险</strong>（主节点宕机但命令尚未传播到从节点）。</p>
<hr/>
<h2 data-id="heading-9">六：问题：TCP连接断开一段时间后，又连接上了怎么办？</h2>
<p>答：重新连接后，从节点psync主节点，开始<strong>增量复制</strong>这段时间的数据，因为主节点在传播命令时，还会把命令写入<strong>repl backlog buffer</strong>(环形缓存区，默认1m)，从节点在psync会传递一个slave repl offset给主节点，主节点比较自身的master repl offset与s-r-o，从r-b-b中发送命令给<strong>复制缓冲区（replication buffer）</strong> ，但由于这是一个环形缓存区，如果断联时间过长，会导致一些命令的覆盖，此时就只能全量复制。</p>
<h2 data-id="heading-10">六、核心数据结构与机制</h2>
<p>Redis 在主从复制中维护了一系列核心数据结构，用于记录同步状态和命令流。</p>








































<table><thead><tr><th>名称</th><th>作用</th><th>说明</th></tr></thead><tbody><tr><td><strong>run_id</strong></td><td>主节点唯一标识</td><td>用于判断主节点是否重启过</td></tr><tr><td><strong>offset</strong></td><td>命令流偏移量</td><td>每次写操作增加，用于同步进度</td></tr><tr><td><strong>replication backlog buffer</strong></td><td>积压缓冲区</td><td>固定大小的循环缓冲区（默认 1MB），存储最近的命令流</td></tr><tr><td><strong>replication buffer</strong></td><td>复制缓冲区</td><td>主节点为每个从节点单独维护的命令队列</td></tr><tr><td><strong>PSYNC 命令</strong></td><td>同步协调命令</td><td>实现全量与增量复制逻辑</td></tr><tr><td><strong>client 结构体</strong></td><td>主从连接对象</td><td>维护复制状态、缓冲区、偏移量等信息</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-11">七、复制中的辅助机制</h2>
<h3 data-id="heading-12">1️⃣ <strong>ACK 反馈机制</strong></h3>
<p>从节点会定期向主节点发送：</p>
<pre><code class="hljs language-sql" lang="sql">REPLCONF ACK <span class="hljs-operator">&lt;</span><span class="hljs-keyword">offset</span><span class="hljs-operator">&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>表示“我已经同步到哪个偏移量”。</p>
<p>主节点通过该信息判断从节点延迟情况，并决定是否需要触发部分或全量复制。</p>
<hr/>
<h3 data-id="heading-13">2️⃣ <strong>心跳机制（ping-pong心态检测机制）</strong></h3>
<p>主从之间会定期发送心跳包（PING/ACK），用于：</p>
<ul>
<li>检测连接是否健康；</li>
<li>校准复制偏移；</li>
<li>保证命令传播的连续性。</li>
</ul>
<hr/>
<h3 data-id="heading-14">3️⃣ <strong>复制积压缓冲区（Backlog）优化</strong></h3>
<p><code>repl-backlog-size</code> 默认 1MB，可根据网络稳定性与写入频率适当调整。<br/>
缓冲区越大，从节点掉线后越容易进行<strong>部分同步</strong>而非全量同步。</p>
<hr/>
<h2 data-id="heading-15">八、复制过程总结图（文字版）</h2>
<pre><code class="hljs language-css" lang="css">从节点启动
    ↓
发送 PSYNC ? -<span class="hljs-number">1</span>
    ↓
主节点判断 → FULLRESYNC（全量） / CONTINUE（部分）
    ↓
<span class="hljs-selector-attr">[全量]</span> 主节点执行 BGSAVE 生成 RDB → 传输给从节点
    ↓
<span class="hljs-selector-attr">[部分]</span> 从 backlog 发送缺失命令流
    ↓
从节点加载 RDB 或执行增量命令 → 状态追平
    ↓
主节点持续异步发送写命令（命令传播阶段）
    ↓
从节点执行命令 + 汇报 offset
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-16">九、Redis 复制机制的特点与局限性</h2>






























<table><thead><tr><th>特性</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>异步复制</strong></td><td>主节点性能高，延迟低</td><td>有数据丢失风险</td></tr><tr><td><strong>部分同步</strong></td><td>快速恢复中断连接</td><td>依赖 backlog 缓冲区大小</td></tr><tr><td><strong>全量同步</strong></td><td>确保一致性</td><td>对大数据量成本高</td></tr><tr><td><strong>多从复制</strong></td><td>支持一主多从</td><td>主节点网络压力大</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-17">十、结语</h2>
<p>Redis 的主从复制机制虽然本质上是异步的，但其通过 <code>PSYNC</code> 协议、<code>replication backlog buffer</code>、ACK 反馈机制等设计，实现了高效、可靠的复制能力。<br/>
理解其内部原理，不仅有助于我们<strong>调优高可用架构</strong>，也为深入掌握 Redis Sentinel 和 Cluster 打下了坚实基础。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[译-掌握Jetpack Compose中的IntrinsicSize（固有尺寸）]]></title>    <link>https://juejin.cn/post/7605451617287225371</link>    <guid>https://juejin.cn/post/7605451617287225371</guid>    <pubDate>2026-02-12T05:41:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605451617287225371" data-draft-id="7605451617287176219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="译-掌握Jetpack Compose中的IntrinsicSize（固有尺寸）"/> <meta itemprop="keywords" content="Android,Android Jetpack"/> <meta itemprop="datePublished" content="2026-02-12T05:41:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="simplepeng"/> <meta itemprop="url" content="https://juejin.cn/user/641770519265832"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            译-掌握Jetpack Compose中的IntrinsicSize（固有尺寸）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/641770519265832/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    simplepeng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T05:41:53.000Z" title="Thu Feb 12 2026 05:41:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/595ea9139fc645d3af692511086ce547~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2ltcGxlcGVuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771479713&amp;x-signature=MqoQzwgOi3cDzvWpajdiSBZhm4k%3D" alt="" loading="lazy"/></p>
<p>If you’ve been working with Jetpack Compose, you’ve probably hit that frustrating moment where your layout just doesn’t behave the way you expect. Maybe a <code>weight()</code> modifier inside a <code>Box</code> causes weird behavior, or your layered UI elements don't size correctly.<br/>
如果你一直在使用 Jetpack Compose，或许已经遇到过这样令人沮丧的时刻：你的布局并没有按预期表现。也许一个 <code>weight()</code> 修饰符放在 <code>Box</code> 内会导致奇怪的行为，或者你叠放的 UI 元素无法正确调整大小。</p>
<p>That’s where <code>**IntrinsicSize**</code> comes in — and trust me, once you understand it, it becomes one of the most powerful tools in your Compose toolkit.<br/>
这就是 <code>**IntrinsicSize**</code> 的用武之地——相信我，一旦你理解了它，它就会成为你 Compose 工具箱中最强大的工具之一。</p>
<h2 data-id="heading-0">The Problem: A Real Production Scenario  问题：一个真实的生产场景</h2>
<p>Recently, I was building a details screen for an app. The design required:<br/>
最近，我在为一个应用构建详情屏。设计要求：</p>
<ol>
<li>A <strong>header image</strong> at the top<br/>
顶部的头图</li>
<li>A <strong>card that overlaps</strong> the header by 56dp<br/>
一个与标题重叠 56dp 的卡片</li>
<li>A <strong>smooth background transition</strong> from the header to a soft gray background<br/>
从页眉到柔和灰色背景的平滑过渡</li>
</ol>
<p>Here’s what we wanted to achieve:<br/>
这是我们想要实现的：</p>
<blockquote>
<p><em><strong>💡 Design Goal:</strong></em> <em>Create a card that elegantly overlaps a header image, with a seamless background transition.</em><br/>
💡 设计目标：创建一个优雅地与头图重叠的卡片，并实现无缝的背景过渡。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/984f653eaaf4424e97de6f02f5f88f2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2ltcGxlcGVuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771479713&amp;x-signature=Ft9uL%2FrixSpAm0Sa9MxC4zZ9dEE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">The Challenge 挑战</h2>
<p>I needed to create a <code>Box</code> with two layers:<br/>
我需要创建一个具有两层的布局：</p>
<ul>
<li><strong>Layer 1 (Background):</strong> 56dp transparent space at top, then soft gray background<br/>
顶部 56dp 透明间距，然后柔和的灰色背景</li>
<li><strong>Layer 2 (Card):</strong> The actual content card drawn on top<br/>
绘制在上方的实际内容卡片</li>
</ul>
<p>Here’s my first attempt:  这是我的第一次尝试：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">OverlappingCardContent</span><span class="hljs-params">(overlapHeight: <span class="hljs-type">Dp</span>)</span></span> {
    Box(modifier = Modifier.fillMaxWidth()) {
        <span class="hljs-comment">// Layer 1: Background</span>
        Column(modifier = Modifier.fillMaxWidth()) {
            Spacer(modifier = Modifier.height(overlapHeight)) <span class="hljs-comment">// 56dp transparent</span>
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .weight(<span class="hljs-number">1f</span>)  <span class="hljs-comment">// Fill remaining space with soft background</span>
                    .background(color = Color.LightGray)
            )
        }
        
        <span class="hljs-comment">// Layer 2: Card</span>
        Card(modifier = Modifier.fillMaxWidth()) {
            <span class="hljs-comment">// Card content...</span>
        }
    }
}
</code></pre>
<p><strong>But this didn’t work!</strong> 😩<br/>
但这没用！😩</p>
<p>The <code>weight(1f)</code> modifier was causing issues. The layout either collapsed or expanded unexpectedly.<br/>
<code>weight(1f)</code> 修饰符导致了问题。布局要么意外折叠，要么意外展开。</p>
<h2 data-id="heading-2">Understanding the Root Cause 理解根本原因</h2>
<p>To understand why this failed, let’s revisit how Compose layout works.<br/>
要理解为何会失败，让我们回顾一下 Compose 布局的工作原理。</p>
<h3 data-id="heading-3">Compose Layout: The Single-Pass SystemCompose 布局：单次传递系统</h3>
<p>Compose measures layouts in a <strong>single pass</strong> for performance. Each composable:<br/>
Compose 为了性能采用单次遍历来测量布局。每个可组合函数：</p>
<ol>
<li>Receives constraints from its parent 从其父元素接收约束</li>
<li>Measures its children 测量其子项</li>
<li>Decides its own size 决定自己的尺寸</li>
<li>Places its children 放置其子项</li>
</ol>
<p>The problem? When a parent like <code>Box</code> measures its children, each child doesn't know what the other children's sizes are. They're measured independently.<br/>
问题？当像 <code>Box</code> 这样的父容器测量其子项时，每个子项不知道其他子项的尺寸。它们是独立测量的。</p>
<h2 data-id="heading-4">Why weight(1f) Failed  为什么 weight(1f) 失败了</h2>
<p>The <code>weight()</code> modifier says: <em>" Take up X proportion of the remaining space."</em><br/>
<code>weight()</code> 修饰符表示：“占用剩余空间的 X 比例。”</p>
<p>But remaining space of <strong>what</strong>? The <code>Box</code> hasn't decided its height yet — it's waiting for its children to tell it how big they need to be. This creates a circular dependency:<br/>
但“剩余空间”指的是什么？ <code>Box</code> 本身还没有决定它的高度——它在等待子元素告知它们需要多大。这就产生了一个循环依赖：</p>
<pre><code class="hljs language-rb" lang="rb"><span class="hljs-title class_">Box</span>: <span class="hljs-string">"Children, how tall are you?"</span>
  ├─ <span class="hljs-title class_">Column</span>: <span class="hljs-string">"I need 56dp + whatever weight(1f) gives me"</span>
  │          <span class="hljs-string">"But weight depends on your height, Box!"</span>
  └─ <span class="hljs-title class_">Card</span>: <span class="hljs-string">"I need ~180dp for my content"</span>
  
<span class="hljs-title class_">Box</span>: <span class="hljs-string">"I'm confused..."</span> 🤯
</code></pre>
<h2 data-id="heading-5">Enter IntrinsicSize: Breaking the Circular Dependency 引入 IntrinsicSize：打破循环依赖</h2>
<p><code>IntrinsicSize</code> is Compose's way of asking children a <strong>hypothetical question</strong> before the actual measurement:<br/>
<code>IntrinsicSize</code> 是 Compose 在实际测量之前向子元素提出的一个假设性问题：</p>
<blockquote>
<p><em><strong>“If I gave you infinite space, what’s the minimum (or maximum) height you’d need?”<br/>
“如果我给你无限的空间，你需要的最小（或最大）高度是多少？”</strong></em></p>
</blockquote>
<h2 data-id="heading-6">IntrinsicSize.Min vs IntrinsicSize.Max</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ffd639c53ec45a2885db033e761f18c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2ltcGxlcGVuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771479713&amp;x-signature=4QgkCDNcx0Fa%2B6JA7iK8MlwSVQA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">The Fix 修复方法</h2>
<pre><code class="hljs language-rb" lang="rb"><span class="hljs-title class_">Box</span>(
    modifier = <span class="hljs-title class_">Modifier</span>
        .fillMaxWidth()
        .height(<span class="hljs-title class_">IntrinsicSize</span>.<span class="hljs-title class_">Min</span>)  /<span class="hljs-regexp">/ ← The magic line!
) {
    /</span><span class="hljs-regexp">/ Layer 1: Background
    Column(modifier = Modifier.fillMaxWidth()) {
        Spacer(modifier = Modifier.height(56.dp))
        Box(
            modifier = Modifier
                .fillMaxWidth()
                .weight(1f)
                .background(color = Color.LightGray)
        )
    }
    
    /</span><span class="hljs-regexp">/ Layer 2: Card
    Card(modifier = Modifier.fillMaxWidth()) {
        /</span><span class="hljs-regexp">/ Card content...
    }
}
</span></code></pre>
<p>Now the layout works! Here’s why:<br/>
现在布局正常工作了！原因如下：</p>
<h2 data-id="heading-8">How IntrinsicSize.Min Resolves the Conflict  IntrinsicSize.Min 如何解决冲突</h2>
<p>When the <code>Box</code> uses <code>height(IntrinsicSize.Min)</code>, it asks each child:<br/>
当 <code>Box</code> 使用 <code>height(IntrinsicSize.Min)</code> 时，它会询问每个子项：</p>
<p><strong>Column’s minimum intrinsic height:<br/>
Column 的最小内在高度：</strong></p>
<pre><code class="hljs language-rb" lang="rb"><span class="hljs-title class_">Spacer</span>: 56dp (fixed)
<span class="hljs-title class_">Weighted</span> <span class="hljs-title class_">Box</span>: 0dp (minimum, can shrink to nothing)
<span class="hljs-title class_">Total</span>: 56dp
</code></pre>
<p><strong>Card’s minimum intrinsic height:<br/>
卡片的最小内在高度：</strong></p>
<pre><code class="hljs language-rb" lang="rb"><span class="hljs-title class_">Status</span> row + <span class="hljs-title class_">Title</span> + <span class="hljs-title class_">Subtitle</span> + <span class="hljs-title class_">Button</span> + <span class="hljs-title class_">Padding</span> = ~180dp
<span class="hljs-title class_">Total</span>: ~180dp
</code></pre>
<p><strong>Box picks:</strong><code>max(56dp, 180dp)</code> = <strong>180dp</strong><br/>
Box 选择： <code>max(56dp, 180dp)</code> = 180dp</p>
<p>Why <code>max()</code>? Because the Box needs to be tall enough for <strong>all</strong> children to fit!<br/>
为什么是 <code>max()</code> ？因为 Box 需要足够高以容纳所有子项！</p>
<p>Now the layout knows exactly how tall to be, and the <code>weight(1f)</code> can work correctly:<br/>
现在布局确切地知道需要多高， <code>weight(1f)</code> 就能正确工作：</p>
<ul>
<li>Box height: 180dp Box 高度：180dp</li>
<li>Spacer: 56dp 间隔：56dp</li>
<li>Weighted background Box: 180dp — 56dp = <strong>124dp</strong><br/>
加权背景盒子：180dp — 56dp = 124dp</li>
</ul>
<h2 data-id="heading-9">The Complete Solution: Overlapping Card UI <br/>完整方案：重叠卡片界面</h2>
<p>Here’s the production-ready code that powers this UI:<br/>
这是驱动该用户界面的可投入生产使用的代码：</p>
<pre><code class="hljs language-rb" lang="rb"><span class="hljs-keyword">private</span> val <span class="hljs-variable constant_">OVERLAP_HEIGHT</span> = <span class="hljs-number">56</span>.dp
</code></pre>
<pre><code class="hljs language-rb" lang="rb"><span class="hljs-variable">@Composable</span>
fun <span class="hljs-title class_">HeaderWithOverlappingCard</span>(<span class="hljs-symbol">imageHeight:</span> <span class="hljs-title class_">Dp</span>) {
    <span class="hljs-title class_">LazyColumn</span> {
        <span class="hljs-regexp">//</span> <span class="hljs-title class_">Create</span> <span class="hljs-symbol">overlap:</span> position content before header ends
        item { 
            <span class="hljs-title class_">Spacer</span>(modifier = <span class="hljs-title class_">Modifier</span>.height(imageHeight - <span class="hljs-variable constant_">OVERLAP_HEIGHT</span>)) 
        }
        
        item {
            <span class="hljs-title class_">OverlappingCardContent</span>(overlapHeight = <span class="hljs-variable constant_">OVERLAP_HEIGHT</span>)
        }
    }
}
</code></pre>
<pre><code class="hljs language-rb" lang="rb"><span class="hljs-variable">@Composable</span>
fun <span class="hljs-title class_">OverlappingCardContent</span>(<span class="hljs-symbol">overlapHeight:</span> <span class="hljs-title class_">Dp</span>) {
    <span class="hljs-title class_">Box</span>(
        modifier = <span class="hljs-title class_">Modifier</span>
            .fillMaxWidth()
            .height(<span class="hljs-title class_">IntrinsicSize</span>.<span class="hljs-title class_">Min</span>)
    ) {
        <span class="hljs-regexp">//</span> <span class="hljs-title class_">Layer</span> <span class="hljs-number">1</span>: <span class="hljs-title class_">Background</span> transition
        <span class="hljs-title class_">Column</span>(modifier = <span class="hljs-title class_">Modifier</span>.fillMaxWidth()) {
            <span class="hljs-title class_">Spacer</span>(modifier = <span class="hljs-title class_">Modifier</span>.height(overlapHeight)) /<span class="hljs-regexp">/ Transparent over header
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .weight(1f)
                    .background(color = SoftGrayBackground)
            )
        }
        
        /</span><span class="hljs-regexp">/ Layer 2: Card content (drawn on top)
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 8.dp),
            shape = RoundedCornerShape(12.dp)
        ) {
            Column(modifier = Modifier.padding(24.dp)) {
                Text("✓ Success", color = Color.Green)
                Text("₹100 Cashback", style = MaterialTheme.typography.h4)
                Text("Transaction complete")
                Spacer(modifier = Modifier.height(16.dp))
                Button(onClick = {}) { Text("View Details") }
            }
        }
    }
}
</span></code></pre>
<h2 data-id="heading-10">Visual Breakdown 视觉拆解</h2>
<pre><code class="hljs language-rb" lang="rb">imageHeight = 200dp
overlapHeight = 56dp
</code></pre>
<pre><code class="hljs language-rb" lang="rb"><span class="hljs-title class_">LazyColumn</span> <span class="hljs-symbol">positions:</span>
├─ <span class="hljs-title class_">Spacer</span>: 144dp (<span class="hljs-number">200</span> - <span class="hljs-number">56</span>)
└─ <span class="hljs-title class_">OverlappingCardContent</span> starts at Y = 144dp
</code></pre>
<pre><code class="hljs language-rb" lang="rb"><span class="hljs-title class_">Inside</span> <span class="hljs-title class_">OverlappingCardContent</span> (height = 180dp via <span class="hljs-title class_">IntrinsicSize</span>.<span class="hljs-title class_">Min</span>):
├─ <span class="hljs-title class_">Column</span> <span class="hljs-title class_">Layer</span>:
│   ├─ <span class="hljs-title class_">Spacer</span>: 56dp (transparent, header shows through)
│   └─ <span class="hljs-title class_">Background</span> <span class="hljs-title class_">Box</span>: 124dp (soft gray)
└─ <span class="hljs-title class_">Card</span> <span class="hljs-title class_">Layer</span>: 180dp (drawn from top, overlaps header)
</code></pre>
<h2 data-id="heading-11">Common Use Cases for IntrinsicSize <br/>IntrinsicSize 的常见用例</h2>
<h3 data-id="heading-12">1. Equal Height Buttons in a Row <br/>1. 行内等高按钮</h3>
<p><strong>Problem:</strong> Buttons with different text lengths end up with different heights.<br/>
问题：文本长度不同的按钮会导致高度不一致。</p>
<p><strong>Solution:解决方案：</strong></p>
<pre><code class="hljs language-rb" lang="rb"><span class="hljs-title class_">Row</span>(modifier = <span class="hljs-title class_">Modifier</span>.height(<span class="hljs-title class_">IntrinsicSize</span>.<span class="hljs-title class_">Min</span>)) {
    <span class="hljs-title class_">Button</span>(
        modifier = <span class="hljs-title class_">Modifier</span>.weight(1f).fillMaxHeight(),
        onClick = {}
    ) { <span class="hljs-title class_">Text</span>(<span class="hljs-string">"Short"</span>) }
    
    <span class="hljs-title class_">Button</span>(
        modifier = <span class="hljs-title class_">Modifier</span>.weight(1f).fillMaxHeight(),
        onClick = {}
    ) { <span class="hljs-title class_">Text</span>(<span class="hljs-string">"This is a much\nlonger button\nwith more text"</span>) }
}
</code></pre>
<p><strong>Result:</strong> Both buttons match the height of the tallest one.<br/>
结果：两个按钮的高度与最高的按钮一致。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c25d43771a7a459a8140e4445bcf6bd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2ltcGxlcGVuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771479713&amp;x-signature=5S%2BRO248TNi7T%2FRvVJwrwe1L9dc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">2. Divider Matching Parent Height <br/>2. 分割线匹配父高度</h3>
<p><strong>Problem:</strong> Divider doesn’t stretch to match multi-line content.<br/>
问题：Divider 不会拉伸以匹配多行内容的高度。</p>
<p><strong>Solution:解决方案：</strong></p>
<pre><code class="hljs language-rb" lang="rb"><span class="hljs-title class_">Row</span>(modifier = <span class="hljs-title class_">Modifier</span>.height(<span class="hljs-title class_">IntrinsicSize</span>.<span class="hljs-title class_">Min</span>)) {
    <span class="hljs-title class_">Text</span>(<span class="hljs-string">"Left content\nwith multiple\nlines"</span>)
    
    <span class="hljs-title class_">Divider</span>(
        modifier = <span class="hljs-title class_">Modifier</span>
            .fillMaxHeight()
            .width(<span class="hljs-number">1</span>.dp)
    )
    
    <span class="hljs-title class_">Text</span>(<span class="hljs-string">"Right"</span>)
}
</code></pre>
<p><strong>Result:</strong> The divider stretches to match the multi-line text height.<br/>
结果：分隔线会拉伸以匹配多行文本的高度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f78c0bc623d748748c78eae8e32918ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2ltcGxlcGVuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771479713&amp;x-signature=MdoeQmK8OvYemhGCfdNxCXatiJc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">3. Card with Dynamic Content and Fixed Overlay<br/>3. 带有动态内容和固定叠加层的卡片</h3>
<p>**Problem:**Overlay needs to match card width, but card width is dynamic.<br/>
问题：叠加层需要与卡片宽度匹配，但卡片宽度是动态的。</p>
<p><strong>Solution:解决方案：</strong></p>
<pre><code class="hljs language-rb" lang="rb"><span class="hljs-title class_">Box</span>(modifier = <span class="hljs-title class_">Modifier</span>.width(<span class="hljs-title class_">IntrinsicSize</span>.<span class="hljs-title class_">Max</span>)) {
    <span class="hljs-title class_">Card</span> {
        <span class="hljs-title class_">Column</span> {
            <span class="hljs-title class_">Text</span>(<span class="hljs-string">"Dynamic content here..."</span>)
            /<span class="hljs-regexp">/ More content
        }
    }
    
    /</span><span class="hljs-regexp">/ Badge that should match card width
    Badge(
        modifier = Modifier
            .align(Alignment.TopEnd)
            .fillMaxWidth()
    )
}
</span></code></pre>
<h2 data-id="heading-15">Performance Considerations ⚠️ 性能注意事项 ⚠️</h2>
<p><code>IntrinsicSize</code> triggers a <strong>two-pass measurement</strong>:<br/>
触发一次两遍测量：</p>
<ol>
<li>First pass: Query intrinsic sizes<br/>
第一遍：查询固有尺寸</li>
<li>Second pass: Actual measurement and layout<br/>
第二次传递：实际测量和布局</li>
</ol>
<p>This has a performance cost. Use it judiciously:<br/>
这会带来性能开销。请谨慎使用：</p>
<h2 data-id="heading-16">✅ Good Use Cases ✅ 适用场景</h2>
<ul>
<li>Complex layered UIs (like our overlapping card)<br/>
复杂的分层界面（例如我们重叠的卡片）</li>
<li>Equalizing sibling sizes <br/>使兄弟元素尺寸相等</li>
<li>Matching dividers/separators to content<br/>
使分隔线/分割线与内容匹配</li>
<li>When you need children to coordinate their sizes<br/>
当你需要子元素协调它们的尺寸时</li>
</ul>
<h2 data-id="heading-17">❌ Avoid When ❌ 避免使用情况</h2>
<ul>
<li>Inside <code>LazyColumn</code> / <code>LazyRow</code> items that repeat hundreds of times<br/>
在内部 / 重复出现数百次的项目</li>
<li>Deeply nested intrinsic measurements<br/>
深度嵌套的内在测量</li>
<li>When a fixed size or <code>wrapContentHeight()</code> works<br/>
当固定大小起作用或有效时</li>
<li>In performance- critical paths<br/>
在性能关键路径上</li>
</ul>
<h2 data-id="heading-18">Key Takeaways 关键要点</h2>
<ol>
<li><code>**IntrinsicSize.Min**</code> = "Use the minimum height needed by children"<br/>
<code>**IntrinsicSize.Min**</code> = "使用子元素所需的最小高度"</li>
<li><code>**IntrinsicSize.Max**</code> = "Use the maximum height children could want"<br/>
<code>**IntrinsicSize.Max**</code> = "使用子元素可能需要的最大高度"</li>
<li>It resolves circular dependencies between parent and child sizing<br/>
它解决了父元素和子元素之间的循环尺寸依赖关系</li>
<li>Essential for layered UIs where children use <code>weight()</code> or<br/>
对于使用或依赖父布局尺寸的子元素的分层用户界面而言至关重要，适用于…… <code>fillMaxHeight()</code></li>
<li>Comes with a performance cost — use wisely<br/>
伴随性能成本 — 明智使用</li>
</ol>
<h2 data-id="heading-19">Conclusion 结论</h2>
<p><code>IntrinsicSize</code> might seem like a niche API, but it's essential for building sophisticated UIs in Compose. The overlapping card pattern we built is just one example — you'll find it invaluable whenever you need siblings to coordinate their sizes or when layered layouts need to "agree" on dimensions.<br/>
<code>IntrinsicSize</code> 可能看起来像是一个小众的 API，但它对于在 Compose 中构建复杂的用户界面至关重要。我们构建的重叠卡片模式只是一个示例——每当你需要同级元素协调它们的尺寸，或是分层布局需要在尺寸上“达成一致”时，你都会发现它非常有用。</p>
<p>Next time your Compose layout behaves unexpectedly with <code>weight()</code> or <code>fillMaxHeight()</code>, remember: <strong>IntrinsicSize might be the answer</strong>.<br/>
下次当你的 Compose 布局在使用 <code>weight()</code> 或 <code>fillMaxHeight()</code> 时表现异常时，请记住：IntrinsicSize 可能就是答案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我们来尝试实现一个类似内阴影的效果]]></title>    <link>https://juejin.cn/post/7605420184144003114</link>    <guid>https://juejin.cn/post/7605420184144003114</guid>    <pubDate>2026-02-12T05:46:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605420184144003114" data-draft-id="7605419006683021354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我们来尝试实现一个类似内阴影的效果"/> <meta itemprop="keywords" content="Flutter,Android"/> <meta itemprop="datePublished" content="2026-02-12T05:46:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我们来尝试实现一个类似内阴影的效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T05:46:29.000Z" title="Thu Feb 12 2026 05:46:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>实现效果:</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c5fcac515c74b8a89eff89e6aedbbff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771479989&amp;x-signature=6PowgNuUjn55WOnSy%2Fg3hQwZvaE%3D" alt="image.png" width="70%" loading="lazy"/>
<p>关键代码：</p>
<pre><code class="hljs language-js" lang="js">  @override
  <span class="hljs-keyword">void</span> <span class="hljs-title function_">paint</span>(<span class="hljs-params">Canvas canvas, Size size</span>) {
    <span class="hljs-keyword">var</span> rect = <span class="hljs-title class_">RRect</span>.<span class="hljs-title function_">fromLTRBR</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, size.<span class="hljs-property">width</span>, size.<span class="hljs-property">height</span>,<span class="hljs-title class_">Radius</span>.<span class="hljs-title function_">circular</span>(<span class="hljs-number">20</span>));

    <span class="hljs-keyword">var</span> topLeftShadowRect = rect.<span class="hljs-title function_">inflate</span>(<span class="hljs-number">5</span>).<span class="hljs-title function_">shift</span>(<span class="hljs-title class_">Offset</span>(-size.<span class="hljs-property">width</span>/<span class="hljs-number">2</span> ,-size.<span class="hljs-property">height</span>/<span class="hljs-number">2</span>));

    <span class="hljs-keyword">var</span> bottomRightShadowRect = rect.<span class="hljs-title function_">shift</span>(<span class="hljs-title class_">Offset</span>(size.<span class="hljs-property">width</span>/<span class="hljs-number">2</span>, size.<span class="hljs-property">height</span>/<span class="hljs-number">2</span>));
    <span class="hljs-keyword">var</span> topLeftShadowPath = <span class="hljs-title class_">Path</span>()..<span class="hljs-title function_">addRRect</span>(topLeftShadowRect);
    <span class="hljs-keyword">var</span> bottomRightShadowPath = <span class="hljs-title class_">Path</span>()..<span class="hljs-title function_">addRRect</span>(bottomRightShadowRect);

    <span class="hljs-keyword">var</span> outShadowPath = <span class="hljs-title class_">Path</span>()..<span class="hljs-title function_">addRRect</span>(rect.<span class="hljs-title function_">deflate</span>(<span class="hljs-number">20</span>).<span class="hljs-title function_">shift</span>(<span class="hljs-title class_">Offset</span>(<span class="hljs-number">20</span>, <span class="hljs-number">20</span>)));


    <span class="hljs-comment">//这个就像是在右下角加了一个光源一样 换不同的颜色 效果也有点不一样</span>
    <span class="hljs-keyword">var</span> outerPainter = <span class="hljs-title class_">Paint</span>()
      ..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">red</span>
      ..<span class="hljs-property">maskFilter</span> = <span class="hljs-title class_">MaskFilter</span>.<span class="hljs-title function_">blur</span>(<span class="hljs-title class_">BlurStyle</span>.<span class="hljs-property">normal</span>, <span class="hljs-number">100</span>);

    canvas.<span class="hljs-title function_">drawPath</span>(outShadowPath, outerPainter);



    canvas.<span class="hljs-title function_">save</span>();
    canvas.<span class="hljs-title function_">clipRRect</span>(rect);
    <span class="hljs-keyword">var</span> topLeftPaint = <span class="hljs-title class_">Paint</span>()
      ..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">black</span>.<span class="hljs-title function_">withAlpha</span>(<span class="hljs-number">188</span>)
      ..<span class="hljs-property">maskFilter</span> = <span class="hljs-title class_">MaskFilter</span>.<span class="hljs-title function_">blur</span>(<span class="hljs-title class_">BlurStyle</span>.<span class="hljs-property">normal</span>, <span class="hljs-number">60</span>);

    canvas.<span class="hljs-title function_">drawPath</span>(topLeftShadowPath, topLeftPaint);

    <span class="hljs-keyword">var</span> bottomLeftPaint = <span class="hljs-title class_">Paint</span>()
      ..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">white</span>
      ..<span class="hljs-property">maskFilter</span> = <span class="hljs-title class_">MaskFilter</span>.<span class="hljs-title function_">blur</span>(<span class="hljs-title class_">BlurStyle</span>.<span class="hljs-property">normal</span>, <span class="hljs-number">60</span>);
    canvas.<span class="hljs-title function_">drawPath</span>(bottomRightShadowPath, bottomLeftPaint);


    canvas.<span class="hljs-title function_">restore</span>();

  }
</code></pre>
<p>原理就是 在左上角 跟 右下角分别放一个阴影，阴影中心就是左上角跟右下角,这样就会有一个从一个颜色到另一个颜色过渡的效果。</p>
<p>还有一个点就是在右下角我又加了一个比较小的矩形的阴影,模式normal，并且radius设置的特别大，就会有一个在右下角加了一个灯光的效果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[社区推荐重排技术：双阶段框架的实践与演进｜得物技术]]></title>    <link>https://juejin.cn/post/7605422894052442127</link>    <guid>https://juejin.cn/post/7605422894052442127</guid>    <pubDate>2026-02-12T05:48:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605422894052442127" data-draft-id="7605288666663501866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="社区推荐重排技术：双阶段框架的实践与演进｜得物技术"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-02-12T05:48:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            社区推荐重排技术：双阶段框架的实践与演进｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T05:48:10.000Z" title="Thu Feb 12 2026 05:48:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<h3 data-id="heading-1">推荐系统典型pipeline</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31c3dc3cb12a44eebfa56e177a36ffa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771480090&amp;x-signature=fazt%2BdrUZQ7NOMLe8eW%2Fb%2F0Ofqg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>在推荐系统多阶段Pipeline（召回→粗排→精排→重排）中，重排作为最终决策环节，承担着将精排输出的有限候选集（通常为Top 100–500个Item）转化为最优序列的关键职责。数学定义为在给定候选集<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo>=</mo><mo stretchy="false">{</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">C = \lbrace x_1,x_2,……,x_n \rbrace</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">……</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">}</span></span></span></span></span>与目标列表长度<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">L</span></span></span></span></span>，重排的目标是寻找一个排列<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>π</mi><mo>∗</mo></msup><mo>∈</mo><mi>P</mi><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">,</mo><mi>L</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\pi^* \in P(C,L)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0391em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">L</span><span class="mclose">)</span></span></span></span></span>，使得全局收益函数最大化。</p>
<p>在推荐系统、搜索排序等AI领域，Pointwise 建模是精排阶段的核心方法，即对每个 Item 独立打分后排序，pointwise 建模范式面临挑战：</p>
<ul>
<li>多样性约束：精排按 item 独立打分排序 → 高分 item 往往语义/类目高度同质（如5个相似短视频连续曝光）。</li>
<li>位置偏差：用户注意力随位置显著衰减，且不同item对位置敏感度不同。</li>
<li>上下文建模：用户决策是序列行为，而非独立事件。</li>
</ul>
<h2 data-id="heading-2">二、重排架构演进：生成式模型实践</h2>
<p>我们的重排系统采用G-E两阶段协同框架：</p>
<ul>
<li>生成阶段（Generation）：高效生成若干高质量候选排列。</li>
<li>评估阶段（Evaluation）：对候选排列进行精细化打分，选出全局最优结果。</li>
</ul>
<p>不考虑算力和耗时的情况下，通过穷举所有排列<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">,</mo><mi>L</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(C,L)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">L</span><span class="mclose">)</span></span></span></span></span>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b3d853cfe8044489fd05a1a97bfcfe1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771480090&amp;x-signature=r%2F8X58fo8MnApiH8paXJ7wGHNCc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>生成阶段主要依赖启发式规则、随机扰动 + beamSearch算法生成候选list，双阶段范式存在显著的痛点：</p>
<ul>
<li>质量-延迟-多样性的“不可能三角”：在实践中，增加生成候选list数一般可以提升最终list的质量，但边际收益递减；优化过程中，我们通过增加多目标、多样性等策略都取得了消费指标的提升，但在候选list达到百量级时，单纯增加候选集对指标的提升，同时还有：</li>
</ul>
<ol>
<li>
<p>增加beam width，系统耗时增加，DCG@K提升逐渐减少。</p>
</li>
<li>
<p>增加通道数，通道间重叠度逐渐增加，去重list增加逐渐减少。</p>
</li>
</ol>
<ul>
<li>阶段间目标不一致：</li>
</ul>
<ol>
<li>
<p>分布偏移：启发式生成Beam Search输出的Top排列中，20%被评估模型否定，生成阶段搜索效率浪费。</p>
</li>
<li>
<p>梯度断层：Beam Search含argmax操作，双阶段无法端到端优化；生成模型无法感知评估反馈，优化方向偏离全局最优。</p>
</li>
</ol>
<h3 data-id="heading-3">生成模型优化</h3>
<p>生成分为启发式方法和生成式模型方法, 一般认为生成式模型方法要好于启发式方法。生成式模型逐渐成为重排主流范式，主要分为两类：自回归生成模型、非自回归生成模型。</p>
<ul>
<li>自回归生成：按位置顺序逐个生成物品，第 t 位的预测依赖前 t-1 位已生成结果。</li>
</ul>
<ol>
<li>优点：</li>
</ol>
<p>a. 序列依赖建模强，天然捕获物品间的顺序依赖。</p>
<p>b. 训练简单稳定，每步使用真实前序作为输入，收敛快。</p>
<p>c. 生成质量高，逐步细化决策，适合长序列精细优化。</p>
<ol start="2">
<li>缺点：</li>
</ol>
<p>a. 推理延迟高，生成 L 个物品需 L 次前向传播，线上服务难以满足毫秒级要求。</p>
<p>b. 局部最优风险，早期错误决策无法回溯修正，影响整体序列质量。</p>
<ul>
<li>非自回归生成：一次性预测整个推荐序列的所有位置，各位置预测相互独立。</li>
</ul>
<ol>
<li>优点：</li>
</ol>
<p>a. 推理速度极快：生成整个序列仅需1次前向传播。</p>
<p>2.缺点：</p>
<p>b.条件独立性假设过强：各位置并行预测，难以显式建模物品间复杂依赖关系。</p>
<h4 data-id="heading-4">非自回归模型</h4>
<p>为了对齐双阶段一致性，同时考虑线上性能，我们推进了非自回归模型的上线。模型结构如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/968b2ff533784dca96fbbc4a6a6b652f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771480090&amp;x-signature=kHA0D2Wj5lPrP87gYLA8zdAjk4M%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>模型包括Candidates Encoder和Position Encoder，Candidates Encoder是标准的Transformer结构, 用于获取item间的交互信息；Position Encoder额外增加了Cross Attention，期望Position序列同时关注Candidate序列。</p>
<ul>
<li>模型特征：用户信息、item特征、位置信息、上游精排打分特征。</li>
<li>模型输出：一次性输出 n×L 的位置-物品得分矩阵（n 为候选 item 数，L 为目标列表长度），支持高效并行推理</li>
</ul>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mi>p</mi><mo>^</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mfrac><mrow><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><msubsup><mi mathvariant="bold">x</mi><mi>i</mi><mi mathvariant="normal">⊤</mi></msubsup><msub><mi mathvariant="bold">t</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><msubsup><mi mathvariant="bold">x</mi><mi>i</mi><mi mathvariant="normal">⊤</mi></msubsup><msub><mi mathvariant="bold">t</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\hat{p}_{ij} = \frac{\exp(\mathbf{x}_i^\top \mathbf{t}_j)}{\sum_{i=1}^n \exp(\mathbf{x}_i^\top \mathbf{t}_j)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">p</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1667em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.5467em;vertical-align:-1.0206em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5261em;"><span style="top:-2.2791em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8309em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">⊤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathbf">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">⊤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathbf">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0206em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<ul>
<li>位置感知建模：引入可学习位置嵌入，显式建模“同一 item 在不同位置表现不同”的现象（如首屏效应、位置衰减）。</li>
<li>训练目标：模型使用logloss，让正反馈label序列的生成概率最大, 同时负反馈label序列的生成概率最小：</li>
</ul>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">L</mi><mi>log</mi><mo>⁡</mo></msub><mo>=</mo><mo>−</mo><munder><mo>∑</mo><mi>i</mi></munder><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>y</mi><mi>i</mi></msub><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mover accent="true"><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>^</mo></mover><mo stretchy="false">)</mo><mo>+</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mover accent="true"><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>^</mo></mover><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\log} = -\sum_{i} \big[ p_{ij}y_i \log(\hat{p_{ij}}) + p_{ij}(1-y_i) \log(1-\hat{p_{ij}}) \big]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathcal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">l</span><span class="mtight">o</span><span class="mtight" style="margin-right:0.01389em;">g</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.3277em;vertical-align:-1.2777em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="delimsizing size1">]</span></span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>表示位置i上是否展示物品j，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>表示位置i上的label。</p>
<p><strong>线上实验及收益：</strong></p>
<ul>
<li>一期新增了非自回归生成通道，pvctr +0.6%，时长+0.55%。</li>
<li>二期在所有通道排序因子中bagging非自回归模型，pvctr +1.0%，时长+1.13%。</li>
</ul>
<h4 data-id="heading-5">自回归模型</h4>
<p>由于条件独立性假设, 非自回归模型对上下文信息建模是不够的，近期我们重点推进了自回归模型的开发。</p>
<p>模型通过Transformer架构建模list整体收益，我们使用单向transformer模拟用户浏览行为的因果性，同时解决自回归生成的暴露偏差问题，保持训练和推理的一致性。结构如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99ecd5354a054b8b82ad1ee65946465e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771480090&amp;x-signature=BHMDeCF6ihrLHsVbMfRQCvtY2q4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li>模型特征：用户信息、item特征、位置信息、上游精排打分特征。</li>
<li>训练目标：模型使用有序回归loss，在评估多个回合中不同长度的子列表时，能够很好地体现出序列中的增量价值。是用于判断长度为j的子列表是否已经达到i次点击或转化的损失函数。</li>
</ul>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>L</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi>θ</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><mrow><mo fence="true">(</mo><mo stretchy="false">[</mo><msub><mi>y</mi><mi>k</mi></msub><mo>&lt;</mo><mi>i</mi><mo stretchy="false">]</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msub><mi>p</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>k</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">[</mo><msub><mi>y</mi><mi>k</mi></msub><mo>≥</mo><mi>i</mi><mo stretchy="false">]</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>p</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>k</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">L_{i,j}(\theta_j) = -\sum_{k=1}^{N} \left([y_k &lt; i]\log(1-p_{i,j}(x_k)) + [y_k \geq i]\log(p_{i,j}(x_k))\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.1304em;vertical-align:-1.3021em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8479em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3021em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">))</span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></div>
<p><strong>线上模型推理效率优化及实验效果：</strong></p>
<p>自回归生成模型推理延迟高，生成 L 个物品需 L 次前向传播，线上服务难以满足毫秒级要求。因此，我们在传统自回归生成模型的基础上增加MTP（multi token prediction）结构，突破生成式重排模型推理瓶颈。其核心思想是将传统自回归的单步预测扩展为单步多token联合预测，显著减少生成迭代次数。</p>
<p>自回归生成模型在社区推荐已完成了推全，实验中我们新增了自回归生成模型通道，但不是完全体，仅部分位置生成调用了模型：</p>
<ul>
<li>一期调用两次模型，每次预测4个位置，pvctr +0.69%，有效vv +0.58%。</li>
<li>二期调用两次模型，每次预测5个位置，pvctr +0.54%，有效vv +0.40%。</li>
</ul>
<h2 data-id="heading-6">三、推理性能优化：端到端生成的效率保障</h2>
<h2 data-id="heading-7">工程架构</h2>
<p>为解决CPU推理模型延迟高、制约业务效果的问题，我们对DScatter模型服务进行升级，引入高性能GPU推理能力，具体方案如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdaba92e1f8444d7a5c0fb50a051c346~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771480090&amp;x-signature=30VfVxrNhnAXwlRq4MVWmPL9UTk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li><strong>GPU推理框架集成与升级：</strong></li>
</ul>
<ol>
<li>
<p>框架升级：将现有依赖的推理框架升级为支持GPU的高性能服务框架。</p>
</li>
<li>
<p>硬件资源引入：引入 NVIDIA L20 等专业推理显卡，为当前的listwise评估模型及自回归生成模型提供专用算力，实现模型推理的硬件加速。</p>
</li>
</ol>
<ul>
<li><strong>DScatter模型服务独立部署与容量提升：</strong></li>
</ul>
<ol>
<li>为解决模型部署效率低与资源竞争问题，将DScatter的模型打分逻辑从现有重排服务中完全解耦，构建并部署独立的 DScatter-Model-Server 集群，从根本上消除与重排服务在CPU、内存等关键资源上的竞争。</li>
</ol>
<h3 data-id="heading-8">模型优化</h3>
<ul>
<li><strong>模型格式转换与加速：</strong></li>
</ul>
<p>导出为 ONNX 格式，使用 TensorRT 进行量化、层融合、动态张量显存等技术加速推理。</p>
<ul>
<li><strong>Item Embedding缓存：</strong></li>
</ul>
<p>预计算item静态网络，线上直接查询节省计算量。</p>
<ul>
<li><strong>自回归生成模型核心优化，KV Cache 复用：</strong></li>
</ul>
<p>缓存已生成token的KV和attention值，仅计算增量token相关值，避免重复计算。</p>
<ul>
<li><strong>其他LLM推理加速技术应用落地，例如GQA</strong></li>
</ul>
<h2 data-id="heading-9">四、未来规划：迈向端到端序列生成的下一代重排架构</h2>
<p>当前“生成-评估”双阶段范式虽在工程落地性上取得平衡，但其本质仍是局部优化：生成阶段依赖启发式规则或浅层模型生成候选，评估阶段虽能识别优质序列，却无法反向指导生成过程，导致系统能力存在理论上限。为突破这一瓶颈，我们规划构建端到端序列生成（End-to-End Sequence Generation） 架构，将重排从“候选筛选”升级为“序列创造”，直接以全局业务目标（如用户停留时长、互动深度、内容生态健康度）为优化目标。</p>
<p><strong>核心架构设计：</strong></p>
<ul>
<li>统一生成器：以 Transformer 为基础架构，搭建自回归序列建模能力，采用分层混合生成策略：</li>
</ul>
<ol>
<li>
<p>粗粒度并行生成：首层预测序列骨架（如类目分布、内容密度）等。</p>
</li>
<li>
<p>细粒度自回归精调：在骨架约束下，自回归生成具体 item，确保局部最优。</p>
</li>
</ol>
<ul>
<li>序列级Reward Modeling：</li>
</ul>
<ol>
<li>
<p>构建多目标 reward 函数：xtr、多样性。</p>
</li>
<li>
<p>Engagement：基于用户滑动轨迹建模序列累积收益（如滑动深度加权CTR）。</p>
</li>
<li>
<p>Diversity：跨类目/创作者/内容形式的分布熵。</p>
</li>
</ol>
<p>4.Fairness：冷启内容、长尾创作者曝光保障。</p>
<h3 data-id="heading-10">训练范式升级：强化学习与对比学习融合</h3>
<p>推进自回归生成模型的架构升级与训练体系重构，引入强化学习微调（PPO/DPO）与对比学习机制，提升序列整体效率。</p>
<ul>
<li>搭建近线系统，生成高质量list候选，提升系统能力上限：</li>
</ul>
<p>1.基于 DCG 的列表质量打分：</p>
<p>a. 对每个曝光列表L，计算其 DCG@K作为质量分数：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>DCG</mtext><mo stretchy="false">(</mo><mi>L</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><mfrac><mrow><mtext>gain</mtext><mo stretchy="false">(</mo><mi>i</mi><mi>t</mi><mi>e</mi><msub><mi>m</mi><mi>j</mi></msub><mo stretchy="false">)</mo></mrow><mrow><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{DCG}(L) = \sum_{j=1}^{K} \frac{\text{gain}(item_j)}{\log_2(j + 1)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">DCG</span></span><span class="mopen">(</span><span class="mord mathnormal">L</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.2421em;vertical-align:-1.4138em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord text"><span class="mord">gain</span></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>其中 gain(item)可定义为：</p>
<p>若点击：+1.0</p>
<p>若互动（点赞/收藏）：+1.5</p>
<p>若观看 &gt;5s：+0.8</p>
<p>否则：0</p>
<p>2.构造偏好对：</p>
<p>a.对同一用户在同一上下文下的两个列表 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">L_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（win）和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>l</mi></msub></mrow><annotation encoding="application/x-tex">L_l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（lose）。</p>
<p>b.若 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mi>C</mi><mi>G</mi><mo stretchy="false">(</mo><msub><mi>L</mi><mi>w</mi></msub><mo stretchy="false">)</mo><mo>&gt;</mo><mi>D</mi><mi>C</mi><mi>G</mi><mo stretchy="false">(</mo><msub><mi>L</mi><mi>l</mi></msub><mo stretchy="false">)</mo><mo>+</mo><mi>δ</mi></mrow><annotation encoding="application/x-tex">DCG(L_w) &gt; DCG(L_l) + \delta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal">CG</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mord mathnormal">CG</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span></span></span></span></span>（δ 为 margin，如 0.1），则构成一个有效偏好对。</p>
<ul>
<li>引入强化学习微调（PPO/DPO）与对比学习机制，提升序列整体效率：</li>
</ul>
<ol>
<li>模型结构：</li>
</ol>
<p>a.使用当前自回归生成模型作为策略模型。</p>
<p>b.固定预训练模型作为参考策略 （即 DPO 中的“旧策略”）。</p>
<p>2.DPO损失：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="script">L</mi><mtext>DPO</mtext></msub><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><msub><mi mathvariant="double-struck">E</mi><mrow><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>l</mi></msub><mo stretchy="false">)</mo><mo>∼</mo><mi mathvariant="script">D</mi></mrow></msub><mrow><mo fence="true">[</mo><mi>log</mi><mo>⁡</mo><mi>σ</mi><mrow><mo fence="true">(</mo><mi>β</mi><mrow><mo fence="true">(</mo><mi>log</mi><mo>⁡</mo><mfrac><mrow><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>w</mi></msub><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><mrow><msub><mi>π</mi><mtext>ref</mtext></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>w</mi></msub><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>−</mo><mi>log</mi><mo>⁡</mo><mfrac><mrow><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>l</mi></msub><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><mrow><msub><mi>π</mi><mtext>ref</mtext></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>l</mi></msub><mo>∣</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{L}_{\text{DPO}}(\theta) = -\mathbb{E}_{(x, y_w, y_l) \sim \mathcal{D}} \left[

\log \sigma \left(

\beta \left(

\log \frac{\pi_\theta(y_w \mid x)}{\pi_{\text{ref}}(y_w \mid x)}

- \log \frac{\pi_\theta(y_l \mid x)}{\pi_{\text{ref}}(y_l \mid x)}

\right)

\right)

\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathcal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">DPO</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="mord">−</span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span><span class="mclose mtight">)</span><span class="mrel mtight">∼</span><span class="mord mathcal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ref</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ref</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></div>
<ul>
<li>技术价值：</li>
</ul>
<ol>
<li>
<p>突破“质量-延迟-多样性”不可能三角：通过序列级优化，在同等延迟下实现质量与多样性双提升。</p>
</li>
<li>
<p>为AIGC与推荐融合铺路：端到端生成器可无缝接入AIGC内容，实现“内容生成-序列编排”一体化。</p>
</li>
</ol>
<p><strong>参考文献：</strong></p>
<ol>
<li>Gloeckle F, Idrissi B Y, Rozière B, et al. Better &amp; faster large language models via multi-token prediction[J]. arXiv preprint arXiv:2404.19737, 2024.</li>
<li>Ren Y, Yang Q, Wu Y, et al. Non-autoregressive generative models for reranking recommendation[C]//Proceedings of the 30th ACM SIGKDD Conference on Knowledge Discovery and Data Mining. 2024: 5625-5634.</li>
<li>Meng Y, Guo C, Cao Y, et al. A generative re-ranking model for list-level multi-objective optimization at taobao[C]//Proceedings of the 48th International ACM SIGIR Conference on Research and Development in Information Retrieval. 2025: 4213-4218.</li>
<li>Zhao X, Xia L, Zhang L, et al. Deep reinforcement learning for page-wise recommendations[C]//Proceedings of the 12th ACM conference on recommender systems. 2018: 95-103.</li>
<li>Feng Y, Hu B, Gong Y, et al. GRN: Generative Rerank Network for Context-wise Recommendation[J]. arXiv preprint arXiv:2104.00860, 2021.</li>
<li>Pang L, Xu J, Ai Q, et al. Setrank: Learning a permutation-invariant ranking model for information retrieval[C]//Proceedings of the 43rd international ACM SIGIR conference on research and development in information retrieval. 2020: 499-508.</li>
</ol>
<h2 data-id="heading-11">往期回顾</h2>
<p>1.Flink ClickHouse Sink：生产级高可用写入方案｜得物技术</p>
<p>2.服务拆分之旅：测试过程全揭秘｜得物技术</p>
<p>3.大模型网关：大模型时代的智能交通枢纽｜得物技术</p>
<p>4.从“人治”到“机治”：得物离线数仓发布流水线质量门禁实践</p>
<p>5.AI编程实践：从Claude Code实践到团队协作的优化思考｜得物技术</p>
<h2 data-id="heading-12">文 /张卓</h2>
<p>关注得物技术，每周一、三更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为何在 Vue3 setup() 中直接解构 props 会丢失响应性？]]></title>    <link>https://juejin.cn/post/7605489943868145679</link>    <guid>https://juejin.cn/post/7605489943868145679</guid>    <pubDate>2026-02-12T04:20:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605489943868145679" data-draft-id="7605468286180671523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为何在 Vue3 setup() 中直接解构 props 会丢失响应性？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-12T04:20:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户3905133219288"/> <meta itemprop="url" content="https://juejin.cn/user/3609051079121550"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为何在 Vue3 setup() 中直接解构 props 会丢失响应性？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3609051079121550/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户3905133219288
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T04:20:29.000Z" title="Thu Feb 12 2026 04:20:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多使用 Vue3 的朋友都遇到过一个问题：在 <code>setup()</code> 函数里直接解构 <code>props</code>，数据就不再响应了。这是为什么呢？</p>
<p>我们先看一个例子。假设我们有一个组件，它接收一个 <code>user</code> 属性。在 <code>setup()</code> 里我们可能会这样写：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'user'</span>],
  <span class="hljs-title function_">setup</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">const</span> { name } = props.<span class="hljs-property">user</span>
    <span class="hljs-keyword">return</span> { name }
  }
}
</code></pre>
<p>这样写看起来没问题，但实际上，<code>name</code> 已经失去了响应性。父组件更新 <code>user</code> 时，这里的 <code>name</code> 不会跟着变。</p>
<hr/>
<h2 data-id="heading-0">原因：理解 Vue3 的响应式原理</h2>
<p>要明白原因，得先知道 Vue3 的响应式原理。Vue3 用 <code>Proxy</code> 来追踪数据变化。<code>props</code> 本身是响应式的，但当你解构出 <code>props.user.name</code> 时，你拿到的是一个普通的值。这个值和原来的响应式数据断开了联系。</p>
<blockquote>
<p>一个比喻</p>
<p>就像你有一根水管，水在水管里流动。你把水接出来放到杯子里，水还在杯子里。但水管里再流动的水，就和杯子里的水没关系了。</p>
</blockquote>
<p>Vue3 的响应式系统也是这样工作的。它只能追踪那些被 <code>reactive</code> 或 <code>ref</code> 包裹的数据。直接解构出来的值，只是一个普通的 JavaScript 值，系统不知道这个值需要被追踪。</p>
<h2 data-id="heading-1">正确的做法是什么？</h2>
<p>那么，正确的做法是什么呢？有两种方法。</p>
<h3 data-id="heading-2">方法一：避免提前解构</h3>
<p>不要提前解构，在模板里直接使用 <code>props.user.name</code>。这样就能保持响应性。</p>
<h3 data-id="heading-3">方法二：使用 <code>toRefs</code></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { toRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'user'</span>],
  <span class="hljs-title function_">setup</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">toRefs</span>(props)
    <span class="hljs-keyword">const</span> name = user.<span class="hljs-property">value</span>.<span class="hljs-property">name</span>
    <span class="hljs-keyword">return</span> { name }
  }
}
</code></pre>
<p><code>toRefs</code> 会把响应式对象的每个属性都转成 <code>ref</code>。这样解构出来的属性还是响应式的。</p>
<blockquote>
<p>注意细节</p>
<p><code>toRefs</code> 处理的是 <code>props</code> 本身，不是 <code>props.user</code>。因为 <code>props</code> 才是响应式对象，<code>props.user</code> 可能只是一个普通对象。</p>
</blockquote>
<p>如果你需要解构 <code>props.user</code> 里的属性，可以这样写：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { toRefs, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'user'</span>],
  <span class="hljs-title function_">setup</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">reactive</span>({ ...props.<span class="hljs-property">user</span> })
    <span class="hljs-keyword">const</span> { name } = <span class="hljs-title function_">toRefs</span>(user)
    <span class="hljs-keyword">return</span> { name }
  }
}
</code></pre>
<p>先用 <code>reactive</code> 包裹，再用 <code>toRefs</code> 解构。这样 <code>name</code> 就是响应式的了。</p>
<hr/>
<h2 data-id="heading-4">特殊情况：将 <code>props</code> 值传递给函数</h2>
<p>还有一种情况要注意。有些时候，你解构 <code>props</code> 是为了传值给其他函数。比如：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">setup</span>(props) {
  const { id } = props
  <span class="hljs-built_in">fetchData</span>(id)
}
</code></pre>
<p>这样写，<code>id</code> 变化时，<code>fetchData</code> 不会重新执行，因为这里的 <code>id</code> 只是一个普通值。</p>
<p>正确的写法是用 <code>watch</code> 或 <code>watchEffect</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-title function_">setup</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-title function_">watch</span>(
    <span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">id</span>,
    <span class="hljs-function">(<span class="hljs-params">newId</span>) =&gt;</span> {
      <span class="hljs-title function_">fetchData</span>(newId)
    }
  )
}
</code></pre>
<p>这样，<code>props.id</code> 变化时，<code>fetchData</code> 就会用新的 <code>id</code> 重新执行。</p>
<h2 data-id="heading-5">总结</h2>
<p>直接解构 <code>props</code> 会丢失响应性，因为解构出来的是普通值。要保持响应性，可以：</p>
<ol>
<li><strong>在模板里直接使用</strong><code>props.xxx</code></li>
<li>用 <code>toRefs</code> 处理后再解构</li>
<li>需要响应式地使用 <code>props</code> 值时，记得用 <code>watch</code> 或 <code>watchEffect</code></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎨 Three.js 自定义材质贴图偏暗？一文搞懂颜色空间与手动 Gamma 矫正]]></title>    <link>https://juejin.cn/post/7605451617286946843</link>    <guid>https://juejin.cn/post/7605451617286946843</guid>    <pubDate>2026-02-12T04:20:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605451617286946843" data-draft-id="7605421123187474459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎨 Three.js 自定义材质贴图偏暗？一文搞懂颜色空间与手动 Gamma 矫正"/> <meta itemprop="keywords" content="WebGL"/> <meta itemprop="datePublished" content="2026-02-12T04:20:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="波哥学开发"/> <meta itemprop="url" content="https://juejin.cn/user/1148352928678877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎨 Three.js 自定义材质贴图偏暗？一文搞懂颜色空间与手动 Gamma 矫正
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1148352928678877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    波哥学开发
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T04:20:31.000Z" title="Thu Feb 12 2026 04:20:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在做智驾标注工具时踩了个坑：为什么我写的 Shader 贴图总是比原图暗？深入探究颜色空间的奥秘！</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">📌 问题引入：贴图怎么变暗了？</h2>
<p>最近在开发一个基于 Three.js 的 3D 标注工具，需要自定义着色器来实现一些特殊的贴图效果。写了个最基础的贴图材质：</p>
<pre><code class="hljs language-glsl" lang="glsl">varying vec2 vUv;
uniform sampler2D texture;

void main() {
  vec4 texColor = texture2D(texture, vUv);
  gl_FragColor = texColor;
}
</code></pre>
<p><strong>结果傻眼了：渲染出来的贴图比原图明显偏暗！</strong></p>
<p>这不对啊！我明明就是直接采样贴图，怎么就变暗了？难道是纹理加载的问题？还是我的光照设置有问题？</p>
<hr/>
<h2 data-id="heading-1">🔍 问题根源：颜色空间的"暗箱操作"</h2>
<p>经过一番排查，终于找到了罪魁祸首：<strong>颜色空间（Color Space）自动转换</strong>。</p>
<h3 data-id="heading-2">🎯 Three.js 的默认行为</h3>
<p>Three.js 为了保证物理正确的光照计算，默认会对纹理做这样的处理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> texture = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TextureLoader</span>().<span class="hljs-title function_">load</span>(<span class="hljs-string">'image.jpg'</span>);
<span class="hljs-comment">// Three.js 自动设置：</span>
texture.<span class="hljs-property">colorSpace</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">SRGBColorSpace</span>; <span class="hljs-comment">// r152+ 旧版用 encoding</span>
</code></pre>
<p>这意味着：</p>
<ol>
<li><strong>图片存储格式</strong>：JPG/PNG 是 sRGB 编码（gamma ≈ 2.2）</li>
<li><strong>Three.js 自动转换</strong>：采样时自动将 sRGB → Linear</li>
<li><strong>Shader 中拿到的</strong>：已经是线性空间的颜色值</li>
</ol>
<h3 data-id="heading-3">📐 什么是 sRGB 和 Linear？</h3>




















<table><thead><tr><th>颜色空间</th><th>说明</th><th>特点</th></tr></thead><tbody><tr><td><strong>sRGB</strong></td><td>人眼感知的颜色空间</td><td>非线性，暗部压缩，亮部展开</td></tr><tr><td><strong>Linear</strong></td><td>物理光强的线性空间</td><td>线性，适合光照计算</td></tr></tbody></table>
<p><strong>关键点</strong>：人眼对亮度的感知是非线性的（史蒂文斯幂定律），而物理光照计算需要在线性空间进行。</p>
<h3 data-id="heading-4">🔄 颜色空间转换公式</h3>
<pre><code class="hljs language-glsl" lang="glsl">// sRGB → Linear (解码)
vec3 linear = pow(srgb.rgb, vec3(2.2));

// Linear → sRGB (编码)
vec3 srgb = pow(linear.rgb, vec3(1.0/2.2));
</code></pre>
<hr/>
<h2 data-id="heading-5">💡 为什么贴图会偏暗？</h2>
<h3 data-id="heading-6">场景还原</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Three.js 内部做了这件事：</span>
vec4 sampled = <span class="hljs-title function_">texture2D</span>(texture, vUv);  <span class="hljs-comment">// 返回的是 Linear 空间颜色</span>

<span class="hljs-comment">// 然后我们直接输出：</span>
gl_FragColor = sampled;  <span class="hljs-comment">// ❌ 问题：Linear 颜色直接输出到 sRGB 帧缓冲</span>
</code></pre>
<p><strong>结果</strong>：线性空间的颜色值（如 0.5）直接显示在屏幕上，人眼感知会比预期的暗很多。</p>
<h3 data-id="heading-7">🧪 数值对比</h3>























<table><thead><tr><th>原图 sRGB</th><th>Linear 空间</th><th>直接输出到屏幕（错误）</th><th>正确输出到屏幕</th></tr></thead><tbody><tr><td>0.5 (中灰)</td><td>0.217</td><td>显示为 0.217 (很暗)</td><td>应显示为 0.5</td></tr><tr><td>0.8 (亮灰)</td><td>0.578</td><td>显示为 0.578 (偏暗)</td><td>应显示为 0.8</td></tr></tbody></table>
<p><strong>看到了吗？</strong> 0.5 的中灰色在 Linear 空间只有 0.217，直接输出就变成了"深灰"！</p>
<hr/>
<h2 data-id="heading-8">✅ 解决方案</h2>
<h3 data-id="heading-9">手动 Gamma 编码（推荐）</h3>
<p>保留 Three.js 的自动转换，在 Shader 中手动做 Gamma 编码：</p>
<pre><code class="hljs language-glsl" lang="glsl">uniform sampler2D texture;
varying vec2 vUv;

void main() {
  vec4 color = texture2D(texture, vUv);      // Linear 空间
  color.rgb = pow(color.rgb, vec3(1.0/2.2)); // Linear → sRGB
  gl_FragColor = color;
}
</code></pre>
<p>或者封装成函数更清晰：</p>
<pre><code class="hljs language-glsl" lang="glsl">vec3 linearToSRGB(vec3 linear) {
  return pow(linear, vec3(1.0/2.2));
}

void main() {
  vec4 color = texture2D(texture, vUv);
  color.rgb = linearToSRGB(color.rgb);
  gl_FragColor = color;
}
</code></pre>
<p><strong>优点</strong>：符合图形学最佳实践，后续加光照也方便<br/>
<strong>缺点</strong>：需要理解颜色空间概念</p>
<hr/>
<h3 data-id="heading-10">方案 3：使用内置工具函数（Three.js r152+）</h3>
<p>Three.js 提供了内置的颜色空间转换函数：</p>
<pre><code class="hljs language-glsl" lang="glsl">#include &lt;color_space_pars_fragment&gt;

uniform sampler2D texture;
varying vec2 vUv;

void main() {
  vec4 color = texture2D(texture, vUv);
  color = SRGBToLinear(color);  // 如果需要在线性空间计算
  // ... 光照计算 ...
  color = LinearToSRGB(color);  // 最后转回 sRGB
  gl_FragColor = color;
}
</code></pre>
<hr/>
<h2 data-id="heading-11">🎯 实战：完整的贴图材质</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;

<span class="hljs-keyword">const</span> vertexShader = <span class="hljs-string">`
  varying vec2 vUv;
  
  void main() {
    vUv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }
`</span>;

<span class="hljs-keyword">const</span> fragmentShader = <span class="hljs-string">`
  uniform sampler2D texture;
  varying vec2 vUv;
  
  // Linear → sRGB
  vec3 linearToSRGB(vec3 linear) {
    return pow(linear, vec3(1.0/2.2));
  }
  
  void main() {
    vec4 color = texture2D(texture, vUv);      // Three.js 已自动转为 Linear
    color.rgb = linearToSRGB(color.rgb);       // 手动转回 sRGB
    gl_FragColor = color;
  }
`</span>;

<span class="hljs-keyword">const</span> texture = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TextureLoader</span>().<span class="hljs-title function_">load</span>(<span class="hljs-string">'image.jpg'</span>);
<span class="hljs-comment">// texture.colorSpace = THREE.SRGBColorSpace; // 默认就是这个，不用设置</span>

<span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-attr">uniforms</span>: {
    <span class="hljs-attr">texture</span>: { <span class="hljs-attr">value</span>: texture }
  },
  vertexShader,
  fragmentShader,
  <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>
});

<span class="hljs-keyword">const</span> plane = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneGeometry</span>(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>),
  material
);
scene.<span class="hljs-title function_">add</span>(plane);
</code></pre>
<hr/>
<h2 data-id="heading-12">🤔 为什么不用乘法，而用幂函数？</h2>
<p>这是个好问题！为什么 Gamma 矫正要用 <code>pow(x, 1/2.2)</code> 而不是简单的 <code>x * 0.5</code>？</p>
<h3 data-id="heading-13">人眼感知的非线性</h3>
<p>人眼对亮度的感知符合<strong>史蒂文斯幂定律</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">主观亮度 ∝ (物理光强)^<span class="hljs-number">0.4</span>~<span class="hljs-number">0.5</span>
</code></pre>
<p>这意味着：</p>
<ul>
<li>物理光强增加 4 倍，人眼只感觉"亮了约 2 倍"</li>
<li>暗部的变化人眼更敏感，亮部的变化相对迟钝</li>
</ul>
<h3 data-id="heading-14">线性乘法的灾难</h3>
<pre><code class="hljs language-glsl" lang="glsl">// ❌ 线性乘法：所有亮度等比例压缩
vec3 dark = color * 0.5;

// ✅ Gamma：非线性压缩，匹配人眼感知
vec3 gamma = pow(color, vec3(1.0/2.2));
</code></pre>


























<table><thead><tr><th>操作</th><th>暗部 (0.1)</th><th>中灰 (0.5)</th><th>亮部 (0.9)</th><th>人眼感知</th></tr></thead><tbody><tr><td><code>×0.5</code></td><td>0.05</td><td>0.25</td><td>0.45</td><td>暗部细节丢失严重 ❌</td></tr><tr><td><code>^0.45</code></td><td>0.28</td><td>0.71</td><td>0.95</td><td>均匀压缩感知亮度 ✅</td></tr></tbody></table>
<p><strong>结论</strong>：幂函数是对人眼生物特性的数学拟合，不是随便选的！</p>
<hr/>
<h2 data-id="heading-15">📊 方案对比总结</h2>























<table><thead><tr><th>方案</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>手动 Gamma 编码</strong></td><td>通用推荐</td><td>符合图形学规范，灵活</td><td>需要理解概念</td></tr><tr><td><strong>内置工具函数</strong></td><td>Three.js r152+</td><td>官方支持，代码简洁</td><td>版本限制</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-16">💡 实用建议</h2>
<h3 data-id="heading-17">1. 调试技巧</h3>
<p>在 Shader 中临时验证：</p>
<pre><code class="hljs language-glsl" lang="glsl">// 输出纯中灰（应该看起来是 50% 灰）
gl_FragColor = vec4(0.5, 0.5, 0.5, 1.0);  // ❌ 线性 0.5 会很暗

// 正确的 50% 视觉灰
gl_FragColor = vec4(0.73, 0.73, 0.73, 1.0); // ✅ ≈ pow(0.5, 1.0/2.2)
</code></pre>
<h3 data-id="heading-18">2. 标注工具场景</h3>
<p>如果你在做标注工具，只是显示贴图：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 推荐：禁用自动转换，简单高效</span>
texture.<span class="hljs-property">colorSpace</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">NoColorSpace</span>;
</code></pre>
<h3 data-id="heading-19">3. 可视化场景</h3>
<p>如果需要光照、阴影等效果：</p>
<pre><code class="hljs language-glsl" lang="glsl">// 推荐：手动 Gamma 编码
vec4 color = texture2D(texture, vUv);
color.rgb = pow(color.rgb, vec3(1.0/2.2));
</code></pre>
<hr/>
<h2 data-id="heading-20">🎓 总结</h2>
<p>贴图偏暗的问题，本质是<strong>颜色空间转换</strong>的理解问题：</p>
<ol>
<li><strong>Three.js 默认</strong>：sRGB → Linear（自动）</li>
<li><strong>自定义 Shader</strong>：需要手动将 Linear → sRGB</li>
<li><strong>Gamma 矫正</strong>：用幂函数 <code>pow(x, 1/2.2)</code> 而不是乘法，因为人眼感知是非线性的</li>
</ol>
<p>理解了这个原理，以后写自定义材质就不会再踩坑了！</p>
<hr/>
<h2 data-id="heading-21">📚 延伸阅读</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fthreejs.org%2Fdocs%2F%23api%2Fen%2Ftextures%2FTexture" target="_blank" title="https://threejs.org/docs/#api/en/textures/Texture" ref="nofollow noopener noreferrer">Three.js 官方文档 - Texture</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flearnopengl.com%2FAdvanced-Lighting%2FGamma-Correction" target="_blank" title="https://learnopengl.com/Advanced-Lighting/Gamma-Correction" ref="nofollow noopener noreferrer">Gamma Correction - LearnOpenGL</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2018%2F05%2Fgamma.html" target="_blank" title="https://www.ruanyifeng.com/blog/2018/05/gamma.html" ref="nofollow noopener noreferrer">颜色空间基础 - 阮一峰</a></li>
</ul>
<hr/>
<p><strong>💬 互动时间</strong>：你在 Three.js 开发中还遇到过哪些"坑"？欢迎在评论区分享！</p>
<p><strong>👍 如果觉得有用，记得点赞收藏，关注我获取更多图形学干货！</strong></p>
<hr/>
<p><em>本文作者：红波 | 专注 WebGL/Three.js/可视化开发 | 智驾标注工具开发者</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Axios Params 序列化解决方案]]></title>    <link>https://juejin.cn/post/7605494530015985704</link>    <guid>https://juejin.cn/post/7605494530015985704</guid>    <pubDate>2026-02-12T04:34:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605494530015985704" data-draft-id="7605494530015871016" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Axios Params 序列化解决方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-12T04:34:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Renouc"/> <meta itemprop="url" content="https://juejin.cn/user/1245069242541127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Axios Params 序列化解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1245069242541127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Renouc
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T04:34:49.000Z" title="Thu Feb 12 2026 04:34:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Axios Params 序列化解决方案（<code>paramsSerializer</code>）</h2>
<h3 data-id="heading-1">这篇笔记解决什么问题</h3>
<p>当你遇到下面任一情况时，这篇笔记可以直接给出方案：</p>
<ul>
<li>前端传了数组/对象，后端却“收不到”或结构不对</li>
<li>同一个参数在不同接口上格式要求不一致（<code>[]</code>、下标、重复 key）</li>
<li>你不确定该用 Axios 内置配置，还是引入 <code>qs</code></li>
</ul>
<h3 data-id="heading-2">30 秒选型（先看这里）</h3>
<ul>
<li>只用扁平对象 + 普通数组：用 Axios 内置 <code>paramsSerializer.indexes</code></li>
<li>有复杂嵌套对象、严格后端协议：用 <code>qs.stringify</code></li>
<li>想团队统一风格：在 axios 实例里一次性配置，不要散落在每个接口</li>
</ul>
<h3 data-id="heading-3"><code>paramsSerializer</code> 是什么（定义）</h3>
<p><code>paramsSerializer</code> 用来控制 <strong>Axios 如何把 <code>params</code> 序列化成 URL query string</strong>。</p>
<ul>
<li>作用对象：<code>params</code></li>
<li>不作用于：<code>data</code>（请求体）、路径参数（如 <code>/users/:id</code>）</li>
<li>即使是 <code>POST/PUT</code>，只要传了 <code>params</code>，它也会生效</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ts" lang="ts">axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/users'</span>, data, {
  <span class="hljs-attr">params</span>: { <span class="hljs-attr">page</span>: <span class="hljs-number">1</span> },
})
</code></pre>
<h3 data-id="heading-4">Axios 内置三种序列化方式（数组）</h3>
<p>假设：</p>
<pre><code class="hljs language-ts" lang="ts">params = { <span class="hljs-attr">tags</span>: [<span class="hljs-string">'red'</span>, <span class="hljs-string">'blue'</span>] }
</code></pre>

























<table><thead><tr><th>配置</th><th>结果</th><th>适用场景</th></tr></thead><tbody><tr><td><code>indexes: false</code></td><td><code>tags[]=red&amp;tags[]=blue</code></td><td>常见 PHP/部分后端习惯（Axios 默认）</td></tr><tr><td><code>indexes: true</code></td><td><code>tags[0]=red&amp;tags[1]=blue</code></td><td>后端需要明确索引</td></tr><tr><td><code>indexes: null</code></td><td><code>tags=red&amp;tags=blue</code></td><td>后端按重复 key 解析数组</td></tr></tbody></table>
<p>示例：</p>
<pre><code class="hljs language-ts" lang="ts">axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>, {
  <span class="hljs-attr">params</span>: { <span class="hljs-attr">tags</span>: [<span class="hljs-string">'red'</span>, <span class="hljs-string">'blue'</span>] },
  <span class="hljs-attr">paramsSerializer</span>: { <span class="hljs-attr">indexes</span>: <span class="hljs-literal">null</span> },
})
</code></pre>
<h3 data-id="heading-5">什么时候需要 <code>qs</code></h3>
<p>如果你有以下需求，建议直接用 <code>qs</code>：</p>
<ul>
<li>嵌套对象较深（如 <code>filter[name]=tom</code>）</li>
<li>后端对参数格式有明确规范</li>
<li>需要统一控制空值、编码、数组格式、键排序</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> qs <span class="hljs-keyword">from</span> <span class="hljs-string">'qs'</span>

axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>, {
  <span class="hljs-attr">params</span>: { <span class="hljs-attr">filter</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'tom'</span> }, <span class="hljs-attr">tags</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>] },
  <span class="hljs-attr">paramsSerializer</span>: {
    <span class="hljs-attr">serialize</span>: <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> qs.<span class="hljs-title function_">stringify</span>(params, { <span class="hljs-attr">arrayFormat</span>: <span class="hljs-string">'repeat'</span> }),
  },
})
</code></pre>
<h3 data-id="heading-6">推荐落地方式（项目级）</h3>
<p>把策略放到请求实例，统一生效：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> request = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'/api'</span>,
  <span class="hljs-attr">paramsSerializer</span>: {
    <span class="hljs-attr">indexes</span>: <span class="hljs-literal">null</span>,
  },
})
</code></pre>
<h3 data-id="heading-7">一句话结论</h3>
<p><code>paramsSerializer</code> 只负责“<code>params</code> 怎么拼到 URL 上”；内置够用就别加库，复杂协议再用 <code>qs</code>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[踩坑实录：设计图上的两个小圆角，我试了3种方法才搞定✨]]></title>    <link>https://juejin.cn/post/7605451617287028763</link>    <guid>https://juejin.cn/post/7605451617287028763</guid>    <pubDate>2026-02-12T05:22:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605451617287028763" data-draft-id="7605421123187163163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="踩坑实录：设计图上的两个小圆角，我试了3种方法才搞定✨"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-12T05:22:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户4820853963902"/> <meta itemprop="url" content="https://juejin.cn/user/668116973007885"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            踩坑实录：设计图上的两个小圆角，我试了3种方法才搞定✨
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/668116973007885/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户4820853963902
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T05:22:27.000Z" title="Thu Feb 12 2026 05:22:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>做前端开发最常遇到的情况就是：设计图看着简单，实际写起来全是坑！今天就跟大家分享一个不起眼但折腾我半天的小问题——右侧遮罩的圆角实现，全程真实踩坑，新手朋友可以避避雷～</p>
<h2 data-id="heading-0">## 先看需求：设计图长这样</h2>
<p>核心很简单：一张背景图左侧正常显示，右侧用遮罩覆盖，重点是遮罩的上下两个角，要做出贴合设计的圆润效果（不是常规的border-radius能搞定的那种）。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/024618b9848b4bf68cc62005b668d75e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDgyMDg1Mzk2MzkwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771478547&amp;x-signature=d2Z%2FR9tr6xGi75fGkB%2BALmVsyfU%3D" alt="c856d811-5952-4031-bd49-7a705ffcec20.png" loading="lazy"/></p>
<h2 data-id="heading-1">初期思路：想当然的“简单方案”</h2>
<p>第一眼看到这张设计图，这不就是一张背景图，右侧用一个div遮罩盖住就完事了？思路简单直接，立马动手写代码实现。</p>
<p>初期实现效果如下，遮罩是加上了，但问题也随之而来...
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33a37bef087f4911a53ab6d8cb7b329c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDgyMDg1Mzk2MzkwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771478547&amp;x-signature=o6XwbikUyb1hG2xnOcNyKwiNR6A%3D" alt="4a6f870c-1a13-43ec-9371-69aab195cf9e.png" loading="lazy"/></p>
<h2 data-id="heading-2">踩坑开始：两个圆角难住我了</h2>
<p>最棘手的问题来了——右侧遮罩的上下两个圆角，怎么都做不出设计图的效果。</p>
<p>我先试着用「伪元素+border-radius」做遮挡，想模拟出圆角效果，但要么圆角生硬，要么会露出背景图的边缘，衔接不自然，效果一直不尽如人意。
接着又去查了资料，尝试用网上说的「CSS挖洞技巧」实现，折腾了半天，还是没能解决问题。</p>
<p>期间还试过给左侧标题部分也用div包裹，再添加圆角，但这样会露出底下的背景色，完全不符合设计需求，只能放弃。</p>
<h2 data-id="heading-3">CSS径向渐变（radial-gradient）救场</h2>
<p>突然想到CSS径向渐变（radial-gradient）的一个特性——它可以设置透明色！</p>
<pre><code class="hljs language-arduino" lang="arduino">background-image: radial-<span class="hljs-built_in">gradient</span>(shape size at position, start-color, ..., last-color);
</code></pre>
<h2 data-id="heading-4">radial-gradient的核心用法</h2>
<h4 data-id="heading-5">1. 定义渐变的形状（shape）</h4>
<ul>
<li><strong>circle</strong>：圆形径向渐变（我这次用到的就是这个）</li>
<li><strong>ellipse</strong>（默认值）：椭圆形径向渐变</li>
</ul>
<h4 data-id="heading-6">2. 定义渐变大小（size）</h4>
<p>size决定了渐变的半径范围，也就是渐变“扩散”到多远，常用值有4个：</p>
<ul>
<li><strong>closest-side</strong>：从中心点到离它最近的边（推荐，贴合需求）</li>
<li><strong>closest-corner</strong>：从中心点到离它最近的角（默认值）</li>
<li><strong>farthest-side</strong>：从中心点到离它最远的边</li>
<li><strong>farthest-corner</strong>：从中心点到离它最远的角</li>
</ul>
<h4 data-id="heading-7">3. 定义渐变位置（position）</h4>
<p>position用来定义渐变的中心点，默认是容器中心（center），常用取值方式有3种：</p>
<ul>
<li>关键字：top、bottom、left、right、center（可组合，比如right top就是右上角）</li>
<li>百分比：50% 50%（中心）、20% 80%（偏右下）</li>
<li>长度值：10px 20px（距左上角的水平、垂直偏移）</li>
</ul>
<h4 data-id="heading-8">4. 颜色节点（color-stop）</h4>
<p>至少需要两个颜色值，用来定义渐变的起始和结束颜色，也可以添加多个中间色，可选设置颜色位置：</p>
<ul>
<li>带位置：red 0%、blue 100%、green 50%（颜色在指定位置切换）</li>
<li>不带位置：颜色会均匀分布在渐变范围内</li>
</ul>
<h2 data-id="heading-9">关键技巧：利用透明和圆形渐变色实现</h2>
<p>radial-gradient最关键的能力，也是我这次解决问题的核心——<strong>可以设置透明色（transparent）</strong> 。</p>
<h2 data-id="heading-10">### 最终实现效果</h2>
<p>直接上最终效果图，圆角顺滑</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f4f0f7142f7434a92c9cab8948e7267~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDgyMDg1Mzk2MzkwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771478547&amp;x-signature=YPDL0qx8UEgi4EkY9TSU76LGBp0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">核心代码片段</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span>{
    <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">"./你的背景图"</span>);
    <span class="hljs-attribute">background-size</span>: <span class="hljs-number">100%</span> <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">900px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
    <span class="hljs-attribute">position</span>: relative;
}
<span class="hljs-selector-class">.container</span><span class="hljs-selector-pseudo">::before</span>{
    <span class="hljs-attribute">content</span>: <span class="hljs-string">''</span>;
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">80px</span>;
    <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">40px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-comment">/* 右上不透明，左下透明的渐变遮罩 */</span>
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">radial-gradient</span>(circle at bottom left, transparent <span class="hljs-number">70.7%</span>, <span class="hljs-number">#fff</span> <span class="hljs-number">70.8%</span>);
}
<span class="hljs-selector-class">.head</span>{
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">80px</span>;
}
<span class="hljs-selector-class">.null-box</span>{
    <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">80px</span>;
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#ffffff</span>;
}
<span class="hljs-selector-class">.title</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">80px</span>;
    <span class="hljs-attribute">position</span>: relative;
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">background</span>: transparent;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">80px</span>;
}
<span class="hljs-selector-class">.title</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">''</span>;
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-comment">/* 右上不透明，左下透明的渐变遮罩 */</span>
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">radial-gradient</span>(circle at bottom left, transparent <span class="hljs-number">70.7%</span>, <span class="hljs-number">#fff</span> <span class="hljs-number">70.8%</span>);
}
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p>其实这个需求本身不难，难的是我一开始陷入了「遮罩只能用纯色+border-radius」的固定思维，忽略了CSS径向渐变的透明特性。
如果大家也遇到过类似的CSS小坑，或者有更好的实现方案，欢迎在评论区交流讨论哦！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[封装复杂性：一个反复生效的架构手法]]></title>    <link>https://juejin.cn/post/7605489943868391439</link>    <guid>https://juejin.cn/post/7605489943868391439</guid>    <pubDate>2026-02-12T05:35:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605489943868391439" data-draft-id="7605489943868375055" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="封装复杂性：一个反复生效的架构手法"/> <meta itemprop="keywords" content="程序员,Nginx"/> <meta itemprop="datePublished" content="2026-02-12T05:35:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员洪志道"/> <meta itemprop="url" content="https://juejin.cn/user/879237481367326"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            封装复杂性：一个反复生效的架构手法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/879237481367326/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员洪志道
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T05:35:34.000Z" title="Thu Feb 12 2026 05:35:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>架构的手法不需要很多。真正有用的，一个就够——反复用。</p>
<p>这一篇做一件事：把 fetch 的复杂度从事件循环里搬回 fetch 自己手里。拆一个 529 行的文件，搬一堆不该在 loop 里的逻辑，切断最后的类型依赖。结果：loop 从 224 行变成 85 行，功能一行没少。</p>
<p>这不是第一次用这个手法。第五篇用它封装了事件引擎，调用者从写二十行变成写一行。这一篇用同样的手法封装 fetch。<strong>如果同一个手法在不同的地方都能生效，它就不是技巧，是原则。</strong></p>
<h2 data-id="heading-0">Loop 在做谁的活</h2>
<p>先看问题。</p>
<p><code>js_loop.c</code> 是事件循环——一个调度器。但翻开代码，224 行里超过一半在做别人的事：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">loop_on_read</span><span class="hljs-params">(<span class="hljs-type">js_event_t</span> *ev)</span> {
    <span class="hljs-comment">// ... 读数据、喂 HTTP 解析器、判断完成状态 ...</span>
}

<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">pending_complete</span><span class="hljs-params">(<span class="hljs-type">js_loop_t</span> *loop, <span class="hljs-type">js_pending_t</span> *p)</span> {
    <span class="hljs-comment">// ... 构建 Response、resolve Promise、清理资源 ...</span>
}

<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">pending_fail</span><span class="hljs-params">(<span class="hljs-type">js_loop_t</span> *loop, <span class="hljs-type">js_pending_t</span> *p, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)</span> {
    <span class="hljs-comment">// ... reject Promise、清理资源 ...</span>
}
</code></pre>
<p>HTTP 解析、Promise resolve/reject、连接清理——这些全是 fetch 的活。<strong>一个调度器，在做 HTTP 客户端的事。</strong></p>
<p>再看 <code>js_fetch.c</code>。529 行，但不是 fetch 太复杂——是三个完全不同的概念挤在一起：Headers 类的完整实现、Response 类的完整实现、fetch 函数。三者各有各的类型定义和初始化逻辑，但共享一个文件作用域，没有任何隔离。</p>
<p>两个问题，同一个根因：<strong>复杂度不在它该在的地方。</strong></p>
<h2 data-id="heading-1">第一步：拆文件——让每个概念有边界</h2>
<p>529 行里，Headers 和 Response 各自是独立的 JS 类——类型定义、方法、注册，自成一体。fetch 只在最后一步创建 Response。三者之间的依赖很弱。</p>
<p>拆成三个文件：</p>
<ul>
<li><code>js_headers.c</code>（181 行）：Headers 的全部实现。核心类型 <code>js_headers_t</code> 是文件内部的——离开这个文件，没人知道它长什么样</li>
<li><code>js_response.c</code>（142 行）：Response 的全部实现。<code>js_response_t</code> 同样只在文件内可见</li>
<li><code>js_fetch.c</code>：只剩 fetch 的核心逻辑</li>
</ul>
<p>对外接口收拢到 <code>js_fetch.h</code>——五行声明：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span>    <span class="hljs-title function_">js_headers_init</span><span class="hljs-params">(JSContext *ctx)</span>;
JSValue <span class="hljs-title function_">js_headers_from_http</span><span class="hljs-params">(JSContext *ctx, <span class="hljs-type">const</span> <span class="hljs-type">js_http_response_t</span> *parsed)</span>;
<span class="hljs-type">void</span>    <span class="hljs-title function_">js_response_init</span><span class="hljs-params">(JSContext *ctx)</span>;
</code></pre>
<p>C 没有 class 的 private 关键字，但文件作用域就是天然的封装边界。<strong>文件本身就是模块。</strong> 这个道理不限于 C——Java 和 Go 用包，Python 用模块，TypeScript 用文件导出。形式不同，本质一样：给概念一个边界，让内部细节不泄漏。</p>
<p>代码变更: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench%2Fcommit%2Fc3181c1" target="_blank" title="https://github.com/hongzhidao/jsbench/commit/c3181c1" ref="nofollow noopener noreferrer">c3181c1</a></p>
<h2 data-id="heading-2">第二步：搬行为——让 fetch 管好自己的事</h2>
<p>结构拆干净了，但行为还散着。loop 里的 <code>loop_on_read</code>、<code>loop_on_write</code>、<code>pending_complete</code>、<code>pending_fail</code>——全是 fetch 该做的事。</p>
<p>搬回去。</p>
<p>先统一清理路径。之前 complete 和 fail 各有一套资源释放代码，大部分重复。引入 <code>js_fetch_destroy()</code>，一个函数管所有路径：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">js_fetch_destroy</span><span class="hljs-params">(<span class="hljs-type">js_fetch_t</span> *f)</span> {
    <span class="hljs-type">js_pending_t</span> *p = &amp;f-&gt;pending;
    JSContext *ctx = p-&gt;ctx;

    js_epoll_del(js_thread()-&gt;engine, &amp;f-&gt;conn-&gt;socket);
    js_timer_delete(&amp;js_thread()-&gt;engine-&gt;timers, &amp;f-&gt;timer);
    JS_FreeValue(ctx, p-&gt;resolve);
    JS_FreeValue(ctx, p-&gt;reject);
    js_http_response_free(&amp;f-&gt;response);
    js_conn_free(f-&gt;conn);
    <span class="hljs-keyword">if</span> (p-&gt;ssl_ctx) SSL_CTX_free(p-&gt;ssl_ctx);
    list_del(&amp;p-&gt;link);
    <span class="hljs-built_in">free</span>(f);
}
</code></pre>
<p>然后 complete 和 fail 变成清晰的两步——先做自己的事，再调 destroy：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">js_fetch_complete</span><span class="hljs-params">(<span class="hljs-type">js_fetch_t</span> *f)</span> {
    JSValue response = js_response_new(ctx, ...);
    JS_Call(ctx, p-&gt;resolve, JS_UNDEFINED, <span class="hljs-number">1</span>, &amp;response);
    js_fetch_destroy(f);
}

<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">js_fetch_fail</span><span class="hljs-params">(<span class="hljs-type">js_fetch_t</span> *f, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *message)</span> {
    JSValue err = JS_NewError(ctx);
    JS_Call(ctx, p-&gt;reject, JS_UNDEFINED, <span class="hljs-number">1</span>, &amp;err);
    js_fetch_destroy(f);
}
</code></pre>
<p>超时处理从之前的十几行变成一行：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">js_fetch_timeout_handler</span><span class="hljs-params">(<span class="hljs-type">js_timer_t</span> *timer, <span class="hljs-type">void</span> *data)</span> {
    <span class="hljs-type">js_pending_t</span> *p = data;
    js_fetch_fail(js_fetch_from_pending(p), <span class="hljs-string">"Request timeout"</span>);
}
</code></pre>
<p>事件处理函数也搬过来。回调在 <code>js_fetch()</code> 创建连接时就绑定好：</p>
<pre><code class="hljs language-c" lang="c">conn-&gt;socket.read  = js_fetch_on_read;
conn-&gt;socket.write = js_fetch_on_write;
conn-&gt;socket.error = js_fetch_on_error;
</code></pre>
<p><strong>创建者就是管理者。</strong> 谁创建了连接，谁就负责它的事件处理和生命周期。这个原则在任何语言里都成立——React 里谁创建了 state 谁管理它，Go 里谁启动了 goroutine 谁负责关闭它。</p>
<p>代码变更: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench%2Fcommit%2Feb6a070" target="_blank" title="https://github.com/hongzhidao/jsbench/commit/eb6a070" ref="nofollow noopener noreferrer">eb6a070</a></p>
<h2 data-id="heading-3">第三步：切断最后的依赖</h2>
<p>行为搬回去了，但 loop 还知道 <code>js_fetch_t</code>——<code>loop_free</code> 调 <code>js_fetch_destroy(js_fetch_from_pending(p))</code>，<code>loop_add</code> 做 <code>js_epoll_add</code>。Loop 的代码里还有 fetch 的影子。</p>
<p>怎么让 loop 彻底不知道 fetch？答案是函数指针——C 语言的多态。</p>
<p>给 <code>js_pending_t</code> 加一个 <code>destroy</code> 回调：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">js_pending</span> {</span>
    <span class="hljs-comment">/* ... */</span>
    <span class="hljs-type">void</span> (*destroy)(<span class="hljs-type">js_pending_t</span> *p);
};
</code></pre>
<p>fetch 在创建时注册自己的销毁函数：</p>
<pre><code class="hljs language-c" lang="c">p-&gt;destroy = js_fetch_destroy;
</code></pre>
<p>loop 清理时只管调回调，不管对面是谁：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// before: loop 知道 fetch</span>
js_fetch_destroy(js_fetch_from_pending(p));

<span class="hljs-comment">// after: loop 只知道 pending</span>
p-&gt;destroy(p);
</code></pre>
<p>同时，<code>js_fetch_t</code> 从 <code>js_main.h</code> 搬进 <code>js_fetch.c</code>，变成文件私有类型。epoll 注册也从 <code>loop_add</code> 搬回 <code>js_fetch()</code>。</p>
<p>至此，loop 里没有任何 fetch 相关的类型、函数、宏。<strong>最后一根线切断了。</strong></p>
<p>这个模式在面向对象语言里叫接口或抽象类——Go 的 <code>io.Closer</code>，Java 的 <code>AutoCloseable</code>。C 里没有这些语法糖，但函数指针做的是同一件事：<strong>调用者不需要知道具体类型，只需要知道它能做什么。</strong> Loop 不需要知道 pending 操作是 fetch 还是 WebSocket，只需要知道它有一个 <code>destroy</code>。</p>
<p>代码变更: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench%2Fcommit%2F88045f2" target="_blank" title="https://github.com/hongzhidao/jsbench/commit/88045f2" ref="nofollow noopener noreferrer">88045f2</a></p>
<h2 data-id="heading-4">结果</h2>
<p>三步做完，<code>js_loop.c</code> 变成了 85 行：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">js_loop_create</span>()   →  创建 pending 列表
<span class="hljs-built_in">js_loop_free</span>()     →  遍历 pending 调 <span class="hljs-selector-tag">p</span>-&gt;<span class="hljs-built_in">destroy</span>(p)
<span class="hljs-built_in">js_loop_add</span>()      →  加入列表
<span class="hljs-built_in">js_loop_run</span>()      →  驱动 JS job queue → 检查 pending → epoll poll → 触发定时器
</code></pre>
<p>没有 HTTP 解析，没有 Promise 操作，没有连接状态判断，<strong>没有任何 fetch 相关的类型</strong>。纯粹的调度。如果将来要支持 WebSocket，loop 一行不用改——新协议实现自己的 <code>destroy</code> 回调，loop 照样调度。</p>
<p>对比一下前后：</p>






























<table><thead><tr><th/><th>之前</th><th>之后</th></tr></thead><tbody><tr><td>js_fetch.c</td><td>529 行（三个概念混在一起）</td><td>326 行（fetch 逻辑 + 生命周期）</td></tr><tr><td>js_headers.c</td><td>不存在</td><td>181 行（独立模块）</td></tr><tr><td>js_response.c</td><td>不存在</td><td>142 行（独立模块）</td></tr><tr><td>js_loop.c</td><td>224 行（调度 + HTTP + Promise）</td><td>85 行（纯调度）</td></tr></tbody></table>
<p>总行数从 753 到 734——差不多。<strong>但复杂度的分布完全不同了。</strong> 每个文件只做一件事，每个模块只管自己的复杂度。</p>
<h2 data-id="heading-5">同一个手法，第二次生效</h2>
<p>回头对比第五篇和这一篇：</p>

























<table><thead><tr><th/><th>第五篇：封装事件引擎</th><th>这一篇：封装 fetch</th></tr></thead><tbody><tr><td>散落的复杂度</td><td>epoll_wait 在两个文件各写一遍</td><td>fetch 行为散落在 loop 里</td></tr><tr><td>封装到哪</td><td><code>js_epoll_poll()</code></td><td><code>js_fetch_complete/fail/on_read/on_write</code></td></tr><tr><td>被简化的</td><td>调用者从 20 行变 1 行</td><td>loop 从 224 行变 85 行</td></tr></tbody></table>
<p>同一个手法，同样的效果。<strong>被封装的模块消化了自己的复杂度，周围的模块卸掉了不属于自己的负担。</strong> 三步——建立边界、归还行为、切断依赖——每一步都让系统更清晰一点。</p>
<h2 data-id="heading-6">封装复杂性——一个可复用的架构工具</h2>
<p>如果这篇文章只带走一样东西，那就是这个工具。</p>
<p><strong>什么时候该用：</strong></p>
<ul>
<li>一个模块在做不属于它的事——调度器在做 HTTP 解析，Controller 在做数据库查询</li>
<li>一个文件里有多个独立变化的概念——Headers 和 fetch 没有理由绑在一起</li>
<li>相同的逻辑在不同路径里重复——complete 和 fail 各写一遍清理</li>
</ul>
<p><strong>怎么用：</strong></p>
<p>三个动作，有顺序。<strong>建立边界</strong>——让每个概念有自己的作用域，内部细节对外不可见。<strong>归还行为</strong>——把逻辑搬回它所属的模块，让创建者管理生命周期。<strong>切断依赖</strong>——用回调或接口替代具体类型引用，让模块之间只通过抽象通信。先建边界，再搬行为，最后切依赖——顺序不能反。边界不清楚的时候搬行为，只是把混乱从一个地方搬到另一个地方。</p>
<p><strong>怎么检验：</strong></p>
<ul>
<li>这个模块能不能不知道那个模块的存在？（loop 不知道 fetch）</li>
<li>如果加一个新的同类事物，现有代码需要改吗？（加 WebSocket，loop 不用动）</li>
<li>每个文件是不是只因为一个理由而改变？</li>
</ul>
<p>这些问题不限于 C，不限于系统编程。<strong>任何语言、任何项目，当你觉得代码"改不动"或者"一改就牵一发动全身"，大概率是复杂度散落在了错误的地方。</strong> 找到它，搬回去。手法就这一个，但你会用很多次。</p>
<hr/>
<p>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench" target="_blank" title="https://github.com/hongzhidao/jsbench" ref="nofollow noopener noreferrer">github.com/hongzhidao/…</a></p>
<p>更多文章和后续更新，关注微信公众号：程序员洪志道</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nuxt3 与官网 SEO：从 TDK 配置到搜索引擎收录]]></title>    <link>https://juejin.cn/post/7605419006683152426</link>    <guid>https://juejin.cn/post/7605419006683152426</guid>    <pubDate>2026-02-12T05:59:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605419006683152426" data-draft-id="7386231613867622411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nuxt3 与官网 SEO：从 TDK 配置到搜索引擎收录"/> <meta itemprop="keywords" content="Nuxt.js,前端"/> <meta itemprop="datePublished" content="2026-02-12T05:59:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐诗"/> <meta itemprop="url" content="https://juejin.cn/user/712139266339694"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nuxt3 与官网 SEO：从 TDK 配置到搜索引擎收录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139266339694/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐诗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T05:59:46.000Z" title="Thu Feb 12 2026 05:59:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文适合 SEO 初学者快速上手 Nuxt3 项目的搜索引擎优化</p>
<p>使用 nuxt3（本文写于一年前） 做了个官网, 第一次做官网也没啥经验一切都是摸着石头过河! 开发完成后做了一些 SEO 的相关的优化，这里做一个记录</p>
<blockquote>
<p>如果之前做过网站的 seo 那这篇文章对你可能没什么帮助，因为这里的目标是 谷歌、必应 搜索框输入指定关键字，可以被搜索到。</p>
</blockquote>
<h2 data-id="heading-0">为什么使用 nuxt3?</h2>
<ol>
<li>支持服务端渲染（SSR）</li>
<li>支持静态站点生成（SSG）</li>
<li>自动生成 <code>&lt;meta&gt;</code> 标签</li>
<li>提供开箱即用的 SEO 优化工具</li>
<li>支持预渲染（Prerendering）</li>
</ol>
<h2 data-id="heading-1">seo 绕不开的 TDK</h2>
<p>TDK 分别对应标题（Title）、描述（Description）和关键词（Keywords）</p>
<ul>
<li><code>&lt;title&gt;</code>标签包含了网页的标题和主要关键词。</li>
<li><code>&lt;meta name="description"&gt;</code>标签提供了网页的描述。</li>
<li><code>&lt;meta name="keywords"&gt;</code>标签列出了相关的关键词。</li>
</ul>
<p>这些元素对于搜索引擎优化（SEO）非常重要它们帮助搜索引擎理解网页的内容，并影响搜索结果中的显示。</p>
<h3 data-id="heading-2">一个简单的🌰</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>网页标题 - 主要关键词<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"这是一个关于主要关键词的网页描述。"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"keywords"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"主要关键词, 相关关键词, 其他关键词"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎访问<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这里是我们关于主要关键词的内容。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">nuxt3 中如何设置 TDK</h3>
<p>在 <code>nuxt.config.ts</code> 文件中进行配置</p>
<blockquote>
<p>nuxt 3.15 不支持直接在 app 配置 seoMeta 改为在 app.vue 中使用 useSeoMeta 实现</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// https://nuxt.com/docs/api/configuration/nuxt-config</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtConfig</span>({
  <span class="hljs-attr">devtools</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span> },
  <span class="hljs-attr">app</span>: {
    <span class="hljs-attr">head</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'爱中文'</span>,
      <span class="hljs-attr">titleTemplate</span>: <span class="hljs-string">'%s'</span>,
      <span class="hljs-attr">meta</span>: [
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'keywords'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'爱中文'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'keywords'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'上海爱中文数字'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'keywords'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'中文教育'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'keywords'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'国际中文智慧教育品牌'</span> },
        { <span class="hljs-attr">name</span>: <span class="hljs-string">'keywords'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">'智慧教育解决方案'</span> },
      ],
    },
  },
})
</code></pre>
<p>在 app.vue 中配置 <code>seoMeta</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">useSeoMeta</span>({
  <span class="hljs-attr">title</span>: <span class="hljs-string">'上海爱中文数字信息技术有限公司'</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">'上海爱中文数字信息技术有限公司，作为一家国际中文智慧教育企业，我们致力于成为“知识服务提供商与学习技术领导者”。依托先进的数字教育技术与深厚的教学设计实力，我们携手全球中文教育领域的专家，汇聚优质中文教学资源，创新探索适应不同地域特色的海外中文学习新范式。'</span>,
})
</code></pre>
<p>配置完渲染出来大概是这样</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/43ec18f0d5194158bbcfbbdeef659ba7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1658&amp;h=686&amp;s=358888&amp;e=png&amp;b=292929" alt="image.png" loading="lazy"/></p>
<p>上边的配置中 title 字段十分重要直接影响搜索结果</p>
<p>这里提一下 <code>titleTemplate: '%s'</code> 这样写渲染后的 title 字段会原样渲染</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d89e566e7cd742c59c36f4d5e4d58b9b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1748&amp;h=484&amp;s=211738&amp;e=png&amp;b=2c2c2c" alt="image.png" loading="lazy"/></p>
<p>如果去除 <code>titleTemplate: '%s'</code> 则会显示,把 <code>package.json</code> 文件的 name 字段拼接在后边这不是咱想要的</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/92911078e8f447dcab04876ebba6e731~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1538&amp;h=476&amp;s=187342&amp;e=png&amp;b=2a2a2a" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">可能你还想为每个页面单独设置</h3>
<p>这当然是可以的而且也很简单使用内置的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnuxt.com%2Fdocs%2Fapi%2Fcomposables%2Fuse-head" target="_blank" title="https://nuxt.com/docs/api/composables/use-head" ref="nofollow noopener noreferrer">useHead</a> 或者 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnuxt.com%2Fdocs%2Fapi%2Fcomposables%2Fuse-seo-meta" target="_blank" title="https://nuxt.com/docs/api/composables/use-seo-meta" ref="nofollow noopener noreferrer">useSeoMeta</a> 即可</p>
<p>两者看情况使用或结合一起使用</p>
<h4 data-id="heading-5">useHead</h4>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2cbcc706597342689b55c3dc42c9401f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2234&amp;h=962&amp;s=220543&amp;e=png&amp;b=141b2f" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">useSeoMeta</h4>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a3dc5099fd2c418aa8f18be87bc3a2aa~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1704&amp;h=1440&amp;s=229071&amp;e=png&amp;b=141a2f" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">nuxt seo 利器</h2>
<p>nuxt3 提供对应的解决方案直接引入 <code>@nuxtjs/seo</code> 即可，号称是 Nuxt 的完整 SEO 解决方案。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c2eec0a3916e454086565a0b15b50ea1~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2054&amp;h=758&amp;s=208320&amp;e=png&amp;b=02031e" alt="image.png" loading="lazy"/></p>
<p>SEO 小白狂喜</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9b5992c06f314a0d90623ac0f26c378f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1838&amp;h=1126&amp;s=251657&amp;e=png&amp;b=02041e" alt="image.png" loading="lazy"/></p>
<p>该有的都有了，这里只看 sitemap.xml、robots.txt</p>
<h3 data-id="heading-8">sitemap.xml</h3>
<p>开发环境会比线上环境多一些调试信息</p>
<p>线上环境 <code>https://xxxx/sitemap.xml</code></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/112d34a14bef43f09f49a3362d11d623~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2574&amp;h=1272&amp;s=301012&amp;e=png&amp;b=fdfdfd" alt="image.png" loading="lazy"/></p>
<p>开发环境 <code>http://localhost:3000/sitemap.xml</code></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/49dd23c032f44484bb934b5f8a23b866~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2358&amp;h=1240&amp;s=358441&amp;e=png&amp;b=fdfdfd" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">robots.txt</h3>
<p>线上生成的文件与本地有一定区别线上全部允许、本地全部不允许</p>
<p>线上环境 <code>https://xxxx/robots.txt</code></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6f9bf7ad05464650a5e192bef45d6f8c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2878&amp;h=322&amp;s=55775&amp;e=png&amp;b=121212" alt="image.png" loading="lazy"/></p>
<p>开发环境 <code>http://localhost:3000/robots.txt</code></p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/340c962e7efa4d22bfa8ba0b80a249fb~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2296&amp;h=410&amp;s=75886&amp;e=png&amp;b=121212" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">自动生成 OgImage</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnuxtseo.com%2Fdocs%2Fog-image%2Fgetting-started%2Fgetting-familar-with-nuxt-og-image" target="_blank" title="https://nuxtseo.com/docs/og-image/getting-started/getting-familar-with-nuxt-og-image" ref="nofollow noopener noreferrer">猛击查看官网文档</a></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">defineOgImageComponent</span>(<span class="hljs-string">'NuxtSeo'</span>, {
  <span class="hljs-attr">title</span>: <span class="hljs-string">'全球中文教育领导者 👋'</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">'我们携手全球中文教育领域的专家，汇聚优质中文教学资源，创新探索适应不同地域特色的海外中文学习新范式。'</span>,
  <span class="hljs-attr">theme</span>: <span class="hljs-string">'#C74043'</span>,
  <span class="hljs-attr">colorMode</span>: <span class="hljs-string">'dark'</span>,
  <span class="hljs-attr">siteLogo</span>: <span class="hljs-string">'/img/logo/logo1.jpg'</span>, <span class="hljs-comment">// public 目录</span>
})
</code></pre>
<p>中文需要配置字体，修改 <code>nuxt.config.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-attr">ogImage</span>: {
  <span class="hljs-attr">googleFontMirror</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启谷歌字体景象-不挂代理感觉很难下载</span>
  <span class="hljs-attr">fonts</span>: [
    <span class="hljs-string">'Noto+Sans+SC:400'</span>,
  ],
},
</code></pre>
<p>使用本地字体 <code>本地字体文件必须是 .otf 、 ttf 、 .woff ，并且位于 public 目录内。</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-attr">ogImage</span>: {
  <span class="hljs-attr">fonts</span>: [
    {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'AlibabaPuHuiTi'</span>,
      <span class="hljs-attr">weight</span>: <span class="hljs-number">500</span>,
      <span class="hljs-attr">path</span>: <span class="hljs-string">'/fonts/AlibabaPuHuiTi/AlibabaPuHuiTi-3-65-Medium.woff'</span>,
    },
  ],
},
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8131b0a8b12423cbc5d133e7973719e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ6K-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771480786&amp;x-signature=daW%2BNE3v16nvya%2BVcsSkbxNNFiI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">如何在 谷歌、必应 中可以被搜索到呢?</h2>
<p>通过各大搜索引擎提供的站点工具提交网站,可以加快网站被索引的速度</p>
<h3 data-id="heading-12">谷歌</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsearch.google.com%2Fsearch-console%2Findex%3Fresource_id%3Dsc-domain%253Aaizhongwensh.com" target="_blank" title="https://search.google.com/search-console/index?resource_id=sc-domain%3Aaizhongwensh.com" ref="nofollow noopener noreferrer">猛击访问</a></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3b45a2dd472a4b9e854985b3ff1a7605~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2872&amp;h=1216&amp;s=268479&amp;e=png&amp;b=eef2f7" alt="image.png" loading="lazy"/></p>
<p>添加站点时是会验证所有权,选择一种验证即可</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c4081e0c06f4203aa958c7f64c103bc~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1620&amp;h=1264&amp;s=172273&amp;e=png&amp;b=fefefe" alt="image.png" loading="lazy"/></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/193a65d784d94256be876f45b2c15116~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1496&amp;h=1486&amp;s=194092&amp;e=png&amp;b=f9f9f9" alt="image.png" loading="lazy"/></p>
<p>检查下网址是否被收录,只有被收录才可以搜索到</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ebdc85a251c148fc902cfeddc14b0b6f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2878&amp;h=1326&amp;s=315892&amp;e=png&amp;b=eff3f7" alt="image.png" loading="lazy"/></p>
<p>提交下站点地图</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ac7da102221429a9e7b3678a3d9f76b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2878&amp;h=1206&amp;s=256701&amp;e=png&amp;b=eff3f8" alt="image.png" loading="lazy"/></p>
<p>然后等着被收录就好了,快的话 48 小时,慢的话一个周左右</p>
<h3 data-id="heading-13">必应</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bing.com%2Fwebmasters%2Fhome" target="_blank" title="https://www.bing.com/webmasters/home" ref="nofollow noopener noreferrer">猛击进入必应站点管理员页面</a></p>
<p>必应可以直接拉取谷歌已验证的站点,使用谷歌登录即可!</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4255d612fba54d80968a7bde94d5714d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2478&amp;h=1272&amp;s=287933&amp;e=png&amp;b=ffffff" alt="image.png" loading="lazy"/></p>
<p>提交下网站地图</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/84ddd942c96148c2adfa0417f1b75b77~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2876&amp;h=1292&amp;s=259217&amp;e=png&amp;b=fafafa" alt="image.png" loading="lazy"/></p>
<p>把网站地图的网址这里在提交一次(感觉会有点用)</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/540c6f6de35d4348b02e69774d8d8cf7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2780&amp;h=1424&amp;s=389066&amp;e=png&amp;b=fcfcfc" alt="image.png" loading="lazy"/></p>
<p>然后等收录,快的话48小时,慢的话一个周左右</p>
<h3 data-id="heading-14">最终结果</h3>
<p>谷歌搜索有时会靠前有时会靠后🤪</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8419a99f8f31414080ac4d142a189d96~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1736&amp;h=1590&amp;s=369872&amp;e=png&amp;b=1f1f1f" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/821cdd2b9c1f418c88680541f4242e9f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2064&amp;h=776&amp;s=198126&amp;e=png&amp;b=1f1f1f" alt="image.png" loading="lazy"/></p>
<p>必应搜索</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c9ffbb6a77b444cbd1afe6cc5c9e352~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1682&amp;h=1030&amp;s=308165&amp;e=png&amp;b=fefdfd" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-15">总结</h2>
<p>本文从实战角度出发，系统介绍了 Nuxt3 网站的 SEO 优化方案：</p>
<ol>
<li>TDK 配置：通过 nuxt.config.ts 和 useSeoMeta 设置标题、描述、关键词</li>
<li>SEO 工具：使用 @nuxtjs/seo 自动生成 sitemap.xml、robots.txt 和 OgImage</li>
<li>搜索引擎收录：通过 Google Search Console 和 Bing Webmasters 提交站点地图，完成网站收录</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React性能优化三剑客：useEffect、useMemo与useCallback实战手册]]></title>    <link>https://juejin.cn/post/7605288666664009770</link>    <guid>https://juejin.cn/post/7605288666664009770</guid>    <pubDate>2026-02-12T03:48:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605288666664009770" data-draft-id="7604846849465122868" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React性能优化三剑客：useEffect、useMemo与useCallback实战手册"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-02-12T03:48:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QLuckyStar"/> <meta itemprop="url" content="https://juejin.cn/user/2295436009545944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React性能优化三剑客：useEffect、useMemo与useCallback实战手册
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436009545944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QLuckyStar
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T03:48:25.000Z" title="Thu Feb 12 2026 03:48:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​废话不多说，直接上干货，兄弟们，注意了，我要开始装逼了：​</p>
<h3 data-id="heading-0">一、<code>useEffect</code>：副作用管理</h3>
<h4 data-id="heading-1">​<strong>核心作用</strong>​</h4>
<p>处理与渲染无关的副作用（如数据获取、订阅事件、定时器、DOM 操作等），并支持清理逻辑。</p>
<h4 data-id="heading-2">​<strong>基本语法</strong>​</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-comment">// 副作用逻辑</span>
  return () =&gt; {
    <span class="hljs-comment">// 清理逻辑（可选）</span>
  };
}, <span class="hljs-selector-attr">[依赖项]</span>);
</code></pre>
<h4 data-id="heading-3">​<strong>使用场景</strong>​</h4>
<ol>
<li>
<p>​<strong>数据获取</strong>​</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-built_in">fetch</span>("/api/data")
    <span class="hljs-selector-class">.then</span>(res =&gt; setData(res));
}, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// 仅在挂载时获取</span>
</code></pre>
</li>
<li>
<p>​<strong>事件监听</strong>​</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResize</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setWidth</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"resize"</span>, handleResize);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"resize"</span>, handleResize);
}, []); <span class="hljs-comment">// 清理监听器</span>
</code></pre>
</li>
<li>
<p>​<strong>定时器</strong>​</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; <span class="hljs-built_in">setCount</span>(c =&gt; c + <span class="hljs-number">1</span>), <span class="hljs-number">1000</span>);
  return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
}, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// 清理定时器</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-4">​<strong>最佳实践</strong>​</h4>
<ul>
<li>​<strong>依赖数组</strong>​：精确控制执行时机，避免遗漏依赖导致闭包问题。</li>
<li>​<strong>清理函数</strong>​：移除订阅、清除定时器，防止内存泄漏。</li>
<li>​<strong>避免无限循环</strong>​：若副作用中修改状态，使用函数式更新（如 <code>setCount(prev =&gt; prev + 1)</code>）。</li>
</ul>
<hr/>
<h3 data-id="heading-5">二、<code>useMemo</code>：计算结果缓存</h3>
<h4 data-id="heading-6">​<strong>核心作用</strong>​</h4>
<p>缓存复杂计算结果，避免重复执行高开销操作（如排序、过滤、深拷贝）。</p>
<h4 data-id="heading-7">​<strong>基本语法</strong>​</h4>
<pre><code class="hljs language-scss" lang="scss">const memoizedValue = <span class="hljs-built_in">useMemo</span>(() =&gt; <span class="hljs-built_in">computeExpensiveValue</span>(a, b), <span class="hljs-selector-attr">[a, b]</span>);
</code></pre>
<h4 data-id="heading-8">​<strong>使用场景</strong>​</h4>
<ol>
<li>
<p>​<strong>复杂计算</strong>​</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">filteredList</span> = useMemo(() =&gt; 
  list.filter(<span class="hljs-attr">item</span> =&gt; item.price &gt; <span class="hljs-number">100</span>), 
  <span class="hljs-section">[list]</span> // 仅当 list 变化时重新计算
)<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p>​<strong>避免重复渲染</strong>​</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">userInfo</span> = useMemo(() =&gt; ({ name, age }), [name, age])<span class="hljs-comment">;</span>
return &lt;Child <span class="hljs-attr">user</span>={userInfo} /&gt;<span class="hljs-comment">; // 稳定引用，避免子组件重渲染</span>
</code></pre>
</li>
</ol>
<h4 data-id="heading-9">​<strong>最佳实践</strong>​</h4>
<ul>
<li>​<strong>依赖项完整</strong>​：包含所有影响计算结果的变量。</li>
<li>​<strong>避免滥用</strong>​：简单计算无需缓存，直接执行即可。</li>
<li>​**配合 <code>React.memo</code>**​：缓存子组件，提升渲染性能。</li>
</ul>
<hr/>
<h3 data-id="heading-10">三、<code>useCallback</code>：函数引用缓存</h3>
<h4 data-id="heading-11">​<strong>核心作用</strong>​</h4>
<p>缓存函数引用，避免因父组件重新渲染导致子组件不必要的重渲染。</p>
<h4 data-id="heading-12">​<strong>基本语法</strong>​</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">memoizedFn</span> = useCallback(() =&gt; {
  doSomething(a, b)<span class="hljs-comment">;</span>
}, <span class="hljs-section">[a, b]</span>)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-13">​<strong>使用场景</strong>​</h4>
<ol>
<li>
<p>​<strong>传递回调函数</strong>​</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">handleClick</span> = useCallback(() =&gt; {
  console.log("Clicked")<span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
return &lt;Button <span class="hljs-attr">onClick</span>={handleClick} /&gt;<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p>​**配合 <code>useEffect</code>**​</p>
<pre><code class="hljs language-scss" lang="scss">const fetchData = <span class="hljs-built_in">useCallback</span>(async () =&gt; {
  const data = await <span class="hljs-built_in">fetch</span>("/api");
  <span class="hljs-built_in">setData</span>(data);
}, <span class="hljs-selector-attr">[]</span>);
<span class="hljs-built_in">useEffect</span>(() =&gt; <span class="hljs-built_in">fetchData</span>(), <span class="hljs-selector-attr">[fetchData]</span>);
</code></pre>
</li>
</ol>
<h4 data-id="heading-14">​<strong>最佳实践</strong>​</h4>
<ul>
<li>​<strong>依赖项精准</strong>​：确保函数内部使用的变量均包含在依赖数组中。</li>
<li>​<strong>避免过度优化</strong>​：仅在需要稳定引用时使用（如传递给 <code>React.memo</code> 子组件）。</li>
</ul>
<hr/>
<h3 data-id="heading-15">四、三者的核心区别</h3>





























<table><thead><tr><th>Hook</th><th>核心用途</th><th>返回值</th><th>典型场景</th></tr></thead><tbody><tr><td><code>useEffect</code></td><td>处理副作用（数据获取、订阅）</td><td>无（返回清理函数）</td><td>API 请求、事件监听</td></tr><tr><td><code>useMemo</code></td><td>缓存计算结果</td><td>计算后的值</td><td>复杂计算、避免重复渲染</td></tr><tr><td><code>useCallback</code></td><td>缓存函数引用</td><td>函数</td><td>传递回调、优化子组件渲染</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-16">五、<code>useEffect</code> 最佳实践与闭包陷阱规避</h3>
<h4 data-id="heading-17">​<strong>1. 依赖项管理</strong>​</h4>
<ul>
<li>
<p>​<strong>核心原则</strong>​：依赖数组必须包含所有在 effect 中使用的 ​<strong>外部变量</strong>​（包括 state、props、上下文等）。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 错误示例：未包含依赖项，导致闭包捕获旧值</span>
const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);
<span class="hljs-built_in">useEffect</span>(() =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(count); <span class="hljs-comment">// 始终输出初始值 0</span>
  }, <span class="hljs-number">1000</span>);
  return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
}, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// ❌ 依赖数组为空</span>

<span class="hljs-comment">// 正确做法：将 count 加入依赖数组</span>
<span class="hljs-built_in">useEffect</span>(() =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    console<span class="hljs-selector-class">.log</span>(count); <span class="hljs-comment">// 实时输出最新值</span>
  }, <span class="hljs-number">1000</span>);
  return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
}, <span class="hljs-selector-attr">[count]</span>); <span class="hljs-comment">// ✅</span>
</code></pre>
<p>​<strong>问题根源</strong>​：未声明依赖项时，effect 仅在挂载时执行一次，闭包中捕获的 <code>count</code> 是初始值。</p>
</li>
</ul>
<h4 data-id="heading-18">​<strong>2. 清理函数</strong>​</h4>
<ul>
<li>
<p>​<strong>场景</strong>​：定时器、事件监听、DOM 操作等需在组件卸载或依赖变化时清理。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResize</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"窗口大小变化"</span>);
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"resize"</span>, handleResize);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"resize"</span>, handleResize); <span class="hljs-comment">// ✅ 清理监听器</span>
}, []);
</code></pre>
</li>
</ul>
<h4 data-id="heading-19">​<strong>3. 避免无限循环</strong>​</h4>
<ul>
<li>
<p>​<strong>问题</strong>​：effect 中修改状态且依赖该状态。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 错误示例：依赖项包含 state，导致循环触发</span>
const <span class="hljs-selector-attr">[data, setData]</span> = <span class="hljs-built_in">useState</span>([]);
<span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-built_in">fetchData</span>()<span class="hljs-selector-class">.then</span>((res) =&gt; <span class="hljs-built_in">setData</span>(res)); <span class="hljs-comment">// 触发重新渲染 → effect 重新执行</span>
}, <span class="hljs-selector-attr">[data]</span>); <span class="hljs-comment">// ❌</span>
</code></pre>
<p>​<strong>解决方案</strong>​：移除冗余依赖，或使用函数式更新：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-built_in">fetchData</span>()<span class="hljs-selector-class">.then</span>((res) =&gt; <span class="hljs-built_in">setData</span>((prev) =&gt; <span class="hljs-selector-attr">[...prev, ...res]</span>)); <span class="hljs-comment">// ✅ 无依赖</span>
}, <span class="hljs-selector-attr">[]</span>);
</code></pre>
</li>
</ul>
<h4 data-id="heading-20">​<strong>4. 复杂异步操作</strong>​</h4>
<ul>
<li>
<p>​<strong>最佳实践</strong>​：在 effect 内部定义异步函数，避免直接 <code>async</code> 修饰回调。</p>
<pre><code class="hljs language-ini" lang="ini">useEffect(() =&gt; {
  let <span class="hljs-attr">isMounted</span> = <span class="hljs-literal">true</span><span class="hljs-comment">; // 防止卸载后更新状态</span>
  const <span class="hljs-attr">fetchData</span> = async () =&gt; {
    const <span class="hljs-attr">res</span> = await api.getData()<span class="hljs-comment">;</span>
    if (isMounted) setData(res)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  fetchData()<span class="hljs-comment">;</span>
  return () =&gt; { <span class="hljs-attr">isMounted</span> = <span class="hljs-literal">false</span><span class="hljs-comment">; }; // 清理标志位</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
</code></pre>
</li>
</ul>
<hr/>
<h3 data-id="heading-21">六、<code>useMemo</code> 和 <code>useCallback</code> 的真正使用场景</h3>
<h4 data-id="heading-22">​<strong>1. <code>useMemo</code>：缓存计算结果</strong>​</h4>
<ul>
<li>
<p>​<strong>适用场景</strong>​：</p>
<ul>
<li>​<strong>高开销计算</strong>​：如大数据排序、复杂公式、深拷贝。</li>
<li>​<strong>派生状态</strong>​：根据 state/props 生成新对象或数组。</li>
<li>​<strong>DOM 节点引用</strong>​：如 <code>useRef</code> 存储 DOM 元素（需配合 <code>useLayoutEffect</code>）。</li>
</ul>
</li>
<li>
<p>​<strong>避免滥用</strong>​：</p>
<ul>
<li>简单计算（如 <code>a + b</code>）无需缓存。</li>
<li>频繁变化的依赖项（如 <code>useMemo</code> 依赖项变化频繁时反而降低性能）。</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// 正确使用：缓存复杂计算
const <span class="hljs-attr">filteredData</span> = useMemo(() =&gt; {
  return data.filter(<span class="hljs-attr">item</span> =&gt; item.price &gt; <span class="hljs-number">100</span>)<span class="hljs-comment">;</span>
}, <span class="hljs-section">[data]</span>)<span class="hljs-comment">;</span>

// 错误使用：缓存简单值
const <span class="hljs-attr">simpleValue</span> = useMemo(() =&gt; <span class="hljs-number">42</span>, [])<span class="hljs-comment">; // ❌ 无意义</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-23">​<strong>2. <code>useCallback</code>：缓存函数引用</strong>​</h4>
<ul>
<li>
<p>​<strong>适用场景</strong>​：</p>
<ul>
<li>​<strong>传递回调给子组件</strong>​：子组件使用 <code>React.memo</code> 时，避免因父组件重渲染导致子组件无效更新。</li>
<li>​<strong>依赖外部变量的函数</strong>​：如事件处理器中依赖 state/props。</li>
</ul>
</li>
<li>
<p>​<strong>避免滥用</strong>​：</p>
<ul>
<li>仅在需要稳定引用时使用（如传递给 <code>useEffect</code> 或子组件）。</li>
<li>内部函数无需缓存（如仅在组件内部使用的函数）。</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 正确使用：缓存事件处理器</span>
const handleClick = <span class="hljs-built_in">useCallback</span>(() =&gt; {
  console<span class="hljs-selector-class">.log</span>("Clicked");
}, <span class="hljs-selector-attr">[]</span>);

<span class="hljs-comment">// 错误使用：缓存内部函数</span>
const internalFn = <span class="hljs-built_in">useCallback</span>(() =&gt; {
  <span class="hljs-comment">// 仅在组件内部使用，无需缓存</span>
}, <span class="hljs-selector-attr">[]</span>);
</code></pre>
</li>
</ul>
<hr/>
<h3 data-id="heading-24">七、避免过度优化的关键原则</h3>
<h4 data-id="heading-25">​<strong>1. 性能问题驱动优化</strong>​</h4>
<ul>
<li>​<strong>先定位瓶颈</strong>​：使用 React DevTools 的 ​<strong>Profiler</strong>​ 分析组件渲染开销。</li>
<li>​<strong>针对性优化</strong>​：仅在渲染耗时或计算密集型场景使用 <code>useMemo</code>/<code>useCallback</code>。</li>
</ul>
<h4 data-id="heading-26">​<strong>2. 依赖项管理</strong>​</h4>
<ul>
<li>​<strong>完整声明</strong>​：使用 ESLint 的 <code>react-hooks/exhaustive-deps</code> 规则强制检查。</li>
<li>​<strong>避免冗余依赖</strong>​：如 <code>useMemo</code> 依赖项中包含未使用的变量。</li>
</ul>
<h4 data-id="heading-27">​<strong>3. 简单场景优先</strong>​</h4>
<ul>
<li>​<strong>优先使用普通变量</strong>​：如 <code>const value = someData;</code> 而非 <code>useMemo(() =&gt; someData, [])</code>。</li>
<li>​<strong>函数内部使用</strong>​：无需缓存仅在组件内部调用的函数。</li>
</ul>
<hr/>
<h3 data-id="heading-28">八、实战案例对比</h3>
<h4 data-id="heading-29">​<strong>场景：商品列表筛选</strong>​</h4>
<ul>
<li>
<p>​<strong>未优化版本</strong>​（频繁重渲染）：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">ProductList</span> = ({ products, filter }) =&gt; {
  const <span class="hljs-attr">filtered</span> = products.filter(/* 复杂逻辑 */)<span class="hljs-comment">;</span>
  return &lt;List <span class="hljs-attr">items</span>={filtered} /&gt;<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p>​<strong>优化后版本</strong>​：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">ProductList</span> = ({ products, filter }) =&gt; {
  const <span class="hljs-attr">filtered</span> = useMemo(() =&gt; {
    return products.filter(/* 复杂逻辑 */)<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[products, filter]</span>)<span class="hljs-comment">; // 仅当数据或筛选条件变化时重新计算</span>
  return &lt;List <span class="hljs-attr">items</span>={filtered} /&gt;<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
</li>
</ul>
<hr/>
<h3 data-id="heading-30">九、总结</h3>

























<table><thead><tr><th>Hook</th><th>核心用途</th><th>避坑指南</th></tr></thead><tbody><tr><td><code>useEffect</code></td><td>副作用管理（数据获取、订阅）</td><td>依赖项完整、清理函数、避免循环</td></tr><tr><td><code>useMemo</code></td><td>缓存计算结果</td><td>仅高开销计算、避免简单值缓存</td></tr><tr><td><code>useCallback</code></td><td>缓存函数引用</td><td>仅传递给 memo 子组件、避免内部函数</td></tr></tbody></table>
<p>​<strong>关键口诀</strong>​：<br/>
​<strong>​“无必要，不优化；有性能问题，再针对性解决”​</strong>。过度使用 Hooks 反而会增加代码复杂度和内存开销。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 全面深入指南]]></title>    <link>https://juejin.cn/post/7605448246996009001</link>    <guid>https://juejin.cn/post/7605448246996009001</guid>    <pubDate>2026-02-12T03:53:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605448246996009001" data-draft-id="7605490752098123839" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 全面深入指南"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2026-02-12T03:53:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="忆江南"/> <meta itemprop="url" content="https://juejin.cn/user/4230576472602845"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 全面深入指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4230576472602845/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    忆江南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T03:53:16.000Z" title="Thu Feb 12 2026 03:53:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文从底层原理、横向对比、纵向深度、性能优化、难点问题、高难度原理六大维度，对 Swift 语言进行全面、细致、深入的梳理。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">第一部分：Swift 基础与底层原理</h2>
<hr/>
<h3 data-id="heading-1">1. 值类型 vs 引用类型</h3>
<h4 data-id="heading-2">1.1 核心区别</h4>


















































<table><thead><tr><th>维度</th><th>值类型 (Value Type)</th><th>引用类型 (Reference Type)</th></tr></thead><tbody><tr><td>代表</td><td>struct, enum, tuple</td><td>class, closure</td></tr><tr><td>存储</td><td>栈（小对象）/ 堆（大对象或含引用）</td><td>堆</td></tr><tr><td>赋值语义</td><td>拷贝（Copy-on-Write 优化）</td><td>共享引用</td></tr><tr><td>线程安全</td><td>天然线程安全（独立副本）</td><td>需要同步机制</td></tr><tr><td>引用计数</td><td>无</td><td>有 ARC</td></tr><tr><td>继承</td><td>不支持（enum/struct）</td><td>支持（class）</td></tr><tr><td>deinit</td><td>不支持</td><td>支持</td></tr><tr><td>Identity</td><td>无 === 操作</td><td>有 === 操作</td></tr></tbody></table>
<h4 data-id="heading-3">1.2 底层内存布局</h4>
<p><strong>struct 布局：</strong></p>
<ul>
<li>struct 的成员按声明顺序存储（有对齐填充）</li>
<li>小 struct（通常 ≤ 3 个 word，即 24 字节 on 64-bit）直接在栈上分配</li>
<li>大 struct 或含引用类型成员时，可能会被编译器优化到堆上（间接存储）</li>
<li>作为协议的 existential container 时，超过 3 word 会触发堆分配</li>
</ul>
<p><strong>class 布局：</strong></p>
<ul>
<li>堆上分配，包含：
<ul>
<li><strong>isa 指针</strong>（8 字节）：指向类的元数据（metadata），用于动态派发</li>
<li><strong>引用计数</strong>（8 字节）：strong count + unowned count + weak count（打包在一个 64-bit InlineRefCounts 中）</li>
<li><strong>实例变量</strong>：按声明顺序排列，有对齐</li>
</ul>
</li>
<li>总 overhead 至少 16 字节（isa + refcount），加上 malloc 的 16 字节对齐 overhead</li>
</ul>
<h4 data-id="heading-4">1.3 Copy-on-Write (COW) 深入</h4>
<p><strong>标准库 COW 实现（Array/Dictionary/Set/String）：</strong></p>
<ul>
<li>内部持有一个引用类型的 buffer（如 <code>_ArrayBuffer</code>）</li>
<li>赋值时只复制 buffer 的引用（引用计数 +1），O(1)</li>
<li>写入前检查 <code>isKnownUniquelyReferenced(&amp;buffer)</code>
<ul>
<li>如果引用计数 == 1，直接修改（无拷贝）</li>
<li>如果引用计数 &gt; 1，先深拷贝 buffer，再修改</li>
</ul>
</li>
<li><strong>注意</strong>：自定义 struct 不会自动获得 COW，需要手动实现</li>
</ul>
<p><strong>自定义 COW 模式：</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Storage</span>&lt;<span class="hljs-title class_">T</span>&gt; {
    <span class="hljs-keyword">var</span> value: <span class="hljs-type">T</span>
    <span class="hljs-keyword">init</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: <span class="hljs-type">T</span>) { <span class="hljs-keyword">self</span>.value <span class="hljs-operator">=</span> value }
}
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">COWWrapper</span>&lt;<span class="hljs-title class_">T</span>&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> storage: <span class="hljs-type">Storage</span>&lt;<span class="hljs-type">T</span>&gt;
    <span class="hljs-keyword">init</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: <span class="hljs-type">T</span>) { storage <span class="hljs-operator">=</span> <span class="hljs-type">Storage</span>(value) }
    <span class="hljs-keyword">var</span> value: <span class="hljs-type">T</span> {
        <span class="hljs-keyword">get</span> { storage.value }
        <span class="hljs-keyword">set</span> {
            <span class="hljs-keyword">if</span> <span class="hljs-operator">!</span><span class="hljs-built_in">isKnownUniquelyReferenced</span>(<span class="hljs-operator">&amp;</span>storage) {
                storage <span class="hljs-operator">=</span> <span class="hljs-type">Storage</span>(newValue)
            } <span class="hljs-keyword">else</span> {
                storage.value <span class="hljs-operator">=</span> newValue
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-5">1.4 struct 中包含引用类型的代价</h4>
<ul>
<li>struct 拷贝时，内部引用类型成员的引用计数也要 +1</li>
<li>如果 struct 有 N 个引用类型成员，一次拷贝就有 N 次 retain</li>
<li>这就是为什么大量包含引用类型的 struct 拷贝比纯 class 更慢</li>
</ul>
<hr/>
<h3 data-id="heading-6">2. 内存管理 — ARC 深入</h3>
<h4 data-id="heading-7">2.1 ARC 的本质</h4>
<ul>
<li>ARC 是<strong>编译器</strong>在编译期自动插入 <code>retain</code>/<code>release</code> 调用</li>
<li>不是 GC（垃圾回收），没有 stop-the-world</li>
<li>引用计数操作是<strong>原子的</strong>（使用 <code>atomic_fetch_add</code> 等），保证线程安全</li>
<li>每次 retain/release 有 CPU 开销（原子操作 + 内存屏障）</li>
</ul>
<h4 data-id="heading-8">2.2 引用计数的存储结构（Swift 5+）</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">InlineRefCounts</span> (<span class="hljs-number">8</span> bytes):
┌─────────────────────────────────────────────────┐
│ <span class="hljs-function">strong <span class="hljs-title">RC</span> <span class="hljs-params">(<span class="hljs-number">32</span> bit)</span> │ unowned <span class="hljs-title">RC</span> <span class="hljs-params">(<span class="hljs-number">31</span> bit)</span> │ flags │
└─────────────────────────────────────────────────┘
</span></code></pre>
<ul>
<li><strong>strong count</strong>：强引用计数。变为 0 时触发 deinit，释放实例内存（如果无 unowned/weak 引用）</li>
<li><strong>unowned count</strong>：unowned 引用计数 + 1（自身占 1）。变为 0 时释放 side table / 对象内存</li>
<li><strong>weak count</strong>：存储在 side table 中。当有 weak 引用时，对象会创建 side table</li>
<li><strong>Side Table</strong>：当需要 weak 引用或引用计数溢出时，从 InlineRefCounts 切换到指向 side table 的指针</li>
</ul>
<h4 data-id="heading-9">2.3 strong / weak / unowned 深入对比</h4>















































<table><thead><tr><th>维度</th><th>strong</th><th>weak</th><th>unowned</th></tr></thead><tbody><tr><td>引用计数</td><td>+1 strong RC</td><td>不增加 strong RC，增加 weak RC（side table）</td><td>+1 unowned RC</td></tr><tr><td>解引用速度</td><td>最快（直接访问）</td><td>较慢（需要检查 side table）</td><td>快（直接访问，但有运行时检查）</td></tr><tr><td>置 nil</td><td>不会</td><td>对象释放后自动置 nil</td><td>不会（对象释放后访问触发 fatal error）</td></tr><tr><td>Optional</td><td>不要求</td><td>必须 Optional</td><td>不要求 Optional</td></tr><tr><td>内存释放时机</td><td>strong RC = 0 时 deinit</td><td>不影响释放</td><td>不影响 deinit，但影响内存回收</td></tr><tr><td>适用场景</td><td>默认所有权</td><td>delegate、可能为 nil 的反向引用</td><td>生命周期确定不短于自身的引用</td></tr></tbody></table>
<p><strong>unowned 的危险与底层：</strong></p>
<ul>
<li>unowned 引用在对象 deinit 后，内存不会立即释放（因为 unowned count &gt; 0）</li>
<li>访问已 deinit 的 unowned 引用会触发 runtime trap（不是野指针，是确定性崩溃）</li>
<li><code>unowned(unsafe)</code> 可以跳过检查，行为类似 C 的悬垂指针，性能最高但最危险</li>
</ul>
<p><strong>weak 的底层机制：</strong></p>
<ul>
<li>weak 引用不直接指向对象，而是通过 <strong>side table</strong> 间接引用</li>
<li>对象 deinit 时，runtime 遍历 side table 将所有 weak 引用置 nil</li>
<li>这就是为什么 weak 必须是 Optional —— 因为可能被置 nil</li>
<li>weak 的读取需要加锁（原子操作），有性能开销</li>
</ul>
<h4 data-id="heading-10">2.4 循环引用的三种场景与解决</h4>
<p><strong>场景一：两个对象互相持有</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> { <span class="hljs-keyword">var</span> b: <span class="hljs-type">B</span>? }
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> { <span class="hljs-keyword">var</span> a: <span class="hljs-type">A</span>? }  <span class="hljs-comment">// 循环引用！</span>
<span class="hljs-comment">// 解决：B 中用 weak var a: A?</span>
</code></pre>
<p><strong>场景二：闭包捕获 self</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span> {
    <span class="hljs-keyword">var</span> handler: (() -&gt; <span class="hljs-type">Void</span>)<span class="hljs-operator">?</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">setup</span>() {
        handler <span class="hljs-operator">=</span> { <span class="hljs-keyword">self</span>.doSomething() }  <span class="hljs-comment">// self 持有 handler，handler 捕获 self</span>
    }
}
<span class="hljs-comment">// 解决：handler = { [weak self] in self?.doSomething() }</span>
</code></pre>
<p><strong>场景三：嵌套闭包中的 capture list</strong></p>
<pre><code class="hljs language-swift" lang="swift">handler <span class="hljs-operator">=</span> { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
    <span class="hljs-comment">// 这里 self 是 strong 的局部变量，闭包执行期间不会释放</span>
    someAsyncCall {
        <span class="hljs-keyword">self</span>.doSomething()  <span class="hljs-comment">// 安全，因为外层已经 guard 了</span>
    }
}
</code></pre>
<h4 data-id="heading-11">2.5 Autorelease Pool 在 Swift 中的角色</h4>
<ul>
<li>Swift 原生对象不使用 autorelease（ARC 直接管理）</li>
<li>但与 ObjC 交互时（调用返回 ObjC 对象的方法），仍可能进入 autorelease pool</li>
<li><code>autoreleasepool { }</code> 在 Swift 中仍然可用，用于循环中大量创建临时 ObjC 对象时控制内存峰值</li>
</ul>
<hr/>
<h3 data-id="heading-12">3. 协议 (Protocol) 底层原理</h3>
<h4 data-id="heading-13">3.1 协议的两种使用方式</h4>
<p><strong>作为泛型约束（Static Dispatch）：</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">process</span>&lt;<span class="hljs-type">T</span>: <span class="hljs-type">MyProtocol</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: <span class="hljs-type">T</span>) { value.doSomething() }
</code></pre>
<ul>
<li>编译期确定类型，<strong>静态派发</strong></li>
<li>编译器为每个具体类型生成特化版本（monomorphization / specialization）</li>
<li>性能最优，等同于直接调用</li>
</ul>
<p><strong>作为存在类型（Dynamic Dispatch）：</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">process</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: <span class="hljs-type">MyProtocol</span>) { value.doSomething() }
<span class="hljs-comment">// Swift 5.6+ 显式写法：func process(_ value: any MyProtocol)</span>
</code></pre>
<ul>
<li>运行时通过 <strong>Existential Container</strong> 动态派发</li>
<li>有性能开销</li>
</ul>
<h4 data-id="heading-14">3.2 Existential Container 详细结构</h4>
<pre><code class="hljs language-ini" lang="ini">Existential Container (5 <span class="hljs-attr">words</span> = <span class="hljs-number">40</span> bytes <span class="hljs-literal">on</span> <span class="hljs-number">64</span>-bit):
┌──────────────────────────────────────────┐
│  Value Buffer (3 <span class="hljs-attr">words</span> = <span class="hljs-number">24</span> bytes)       │  ← 存储值或指向堆的指针
│  Metadata Pointer (1 <span class="hljs-attr">word</span> = <span class="hljs-number">8</span> bytes)     │  ← 指向类型元数据
│  PWT Pointer (1 <span class="hljs-attr">word</span> = <span class="hljs-number">8</span> bytes)          │  ← Protocol Witness Table 指针
└──────────────────────────────────────────┘
</code></pre>
<p><strong>Value Buffer 策略：</strong></p>
<ul>
<li>值 ≤ 24 字节：<strong>inline 存储</strong>，直接放在 buffer 中（无堆分配）</li>
<li>值 &gt; 24 字节：buffer 中存指向<strong>堆分配内存</strong>的指针</li>
<li>这就是为什么小 struct 遵循协议时没有额外堆分配</li>
</ul>
<p><strong>Protocol Witness Table (PWT)：</strong></p>
<ul>
<li>每个「类型 + 协议」组合有一张 PWT</li>
<li>PWT 是一个函数指针数组，每个协议方法对应一个条目</li>
<li>调用协议方法时：从 existential container 取出 PWT → 查表 → 间接调用</li>
<li>类似于 C++ 的 vtable，但针对的是协议而非类继承</li>
</ul>
<p><strong>Value Witness Table (VWT)：</strong></p>
<ul>
<li>每个类型有一张 VWT，描述该类型的内存操作</li>
<li>包含：size、alignment、copy、move、destroy 等函数指针</li>
<li>存在类型赋值/拷贝时，通过 VWT 执行正确的内存操作</li>
</ul>
<h4 data-id="heading-15">3.3 协议组合与多协议 existential</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">process</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: <span class="hljs-type">ProtocolA</span> &amp; <span class="hljs-type">ProtocolB</span>) { <span class="hljs-operator">...</span> }
</code></pre>
<ul>
<li>existential container 会包含多个 PWT 指针（每个协议一个）</li>
<li>容器大小 = 24（buffer）+ 8（metadata）+ 8 × N（N 个协议的 PWT）</li>
</ul>
<h4 data-id="heading-16">3.4 Class-Only Protocol 的优化</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">MyDelegate</span>: <span class="hljs-title class_">AnyObject</span> { <span class="hljs-operator">...</span> }
</code></pre>
<ul>
<li>编译器知道遵循者一定是 class（引用类型）</li>
<li>existential container 退化为：1 个 word 的引用 + metadata + PWT</li>
<li>不需要 24 字节的 value buffer</li>
<li>可以使用 weak/unowned 修饰</li>
</ul>
<h4 data-id="heading-17">3.5 协议扩展 vs 协议要求方法的派发差异</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Greetable</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">greet</span>()  <span class="hljs-comment">// 协议要求：PWT 动态派发</span>
}
<span class="hljs-keyword">extension</span> <span class="hljs-title class_">Greetable</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">greet</span>() { <span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello"</span>) }     <span class="hljs-comment">// 默认实现</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">farewell</span>() { <span class="hljs-built_in">print</span>(<span class="hljs-string">"Bye"</span>) }    <span class="hljs-comment">// 扩展方法：静态派发！</span>
}
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Person</span>: <span class="hljs-title class_">Greetable</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">greet</span>() { <span class="hljs-built_in">print</span>(<span class="hljs-string">"Hi, I'm a person"</span>) }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">farewell</span>() { <span class="hljs-built_in">print</span>(<span class="hljs-string">"See you"</span>) }
}

<span class="hljs-keyword">let</span> p: <span class="hljs-type">Greetable</span> <span class="hljs-operator">=</span> <span class="hljs-type">Person</span>()
p.greet()     <span class="hljs-comment">// "Hi, I'm a person" —— 动态派发，走 PWT</span>
p.farewell()  <span class="hljs-comment">// "Bye" —— 静态派发！走协议扩展的默认实现</span>
</code></pre>
<p><strong>关键区别：</strong></p>
<ul>
<li>协议要求中声明的方法 → 在 PWT 中有条目 → 动态派发 → 能被遵循者重写</li>
<li>仅在协议扩展中定义的方法 → PWT 中无条目 → 静态派发 → 根据编译期类型决定</li>
</ul>
<hr/>
<h3 data-id="heading-18">4. 泛型底层原理</h3>
<h4 data-id="heading-19">4.1 泛型的实现方式</h4>
<p>Swift 泛型采用<strong>类型擦除 + 运行时传递元数据</strong>的策略（不同于 C++ 的完全模板实例化）：</p>
<ul>
<li>编译器生成<strong>一份</strong>泛型函数的代码（不是每个类型一份）</li>
<li>运行时通过隐藏参数传递 <strong>type metadata</strong> 和 <strong>witness table</strong></li>
<li>但在开启优化（-O）时，编译器会进行<strong>泛型特化（specialization）</strong>，为常用类型生成直接调用的版本</li>
</ul>
<h4 data-id="heading-20">4.2 泛型特化 (Specialization)</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">swap</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">a</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">T</span>, <span class="hljs-keyword">_</span> <span class="hljs-params">b</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">T</span>) { <span class="hljs-operator">...</span> }
<span class="hljs-comment">// 编译器优化后可能生成：</span>
<span class="hljs-comment">// swap_Int(...)  ← 针对 Int 的特化版本</span>
<span class="hljs-comment">// swap_String(...)  ← 针对 String 的特化版本</span>
<span class="hljs-comment">// swap_generic(...)  ← 通用版本（需要 metadata）</span>
</code></pre>
<p><strong>特化条件：</strong></p>
<ul>
<li>编译器能看到泛型函数的实现（同一模块 或 <code>@inlinable</code>）</li>
<li>能确定具体类型</li>
<li>优化级别 -O 或 -Osize</li>
</ul>
<p><strong>跨模块特化：</strong></p>
<ul>
<li>默认不能跨模块特化（泛型函数实现不可见）</li>
<li><code>@inlinable</code> 将函数体暴露给其他模块，允许跨模块特化</li>
<li><code>@frozen</code> 将 struct 布局暴露给其他模块</li>
</ul>
<h4 data-id="heading-21">4.3 Type Erasure（类型擦除）模式</h4>
<p><strong>问题：</strong> 带 associatedtype 的协议不能直接作为存在类型</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">protocol</span> <span class="hljs-title class_">Iterator</span> {
    <span class="hljs-keyword">associatedtype</span> <span class="hljs-type">Element</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Element</span>?
}
<span class="hljs-comment">// let iter: Iterator  ← 编译错误（Swift 5.6 以前）</span>
<span class="hljs-comment">// let iter: any Iterator  ← Swift 5.7+ 部分支持</span>
</code></pre>
<p><strong>经典手动类型擦除：</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AnyIterator</span>&lt;<span class="hljs-title class_">Element</span>&gt;: <span class="hljs-title class_">IteratorProtocol</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> _next: () -&gt; <span class="hljs-type">Element</span>?
    <span class="hljs-keyword">init</span>&lt;<span class="hljs-type">I</span>: <span class="hljs-type">IteratorProtocol</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">iterator</span>: <span class="hljs-type">I</span>) <span class="hljs-keyword">where</span> <span class="hljs-type">I</span>.<span class="hljs-type">Element</span> <span class="hljs-operator">==</span> <span class="hljs-type">Element</span> {
        <span class="hljs-keyword">var</span> iter <span class="hljs-operator">=</span> iterator
        _next <span class="hljs-operator">=</span> { iter.next() }
    }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">next</span>() -&gt; <span class="hljs-type">Element</span>? { _next() }
}
</code></pre>
<p><strong>原理：</strong> 用闭包捕获具体类型实例，对外暴露统一的泛型接口，擦除了具体类型信息。</p>
<h4 data-id="heading-22">4.4 some vs any（Swift 5.7+）</h4>



































<table><thead><tr><th>维度</th><th><code>some Protocol</code> (Opaque Type)</th><th><code>any Protocol</code> (Existential Type)</th></tr></thead><tbody><tr><td>底层</td><td>编译期确定的固定类型（对调用者隐藏）</td><td>运行时动态类型（existential container）</td></tr><tr><td>派发</td><td>静态派发</td><td>动态派发（PWT）</td></tr><tr><td>性能</td><td>高（无间接开销）</td><td>低（堆分配 + 间接调用）</td></tr><tr><td>类型一致性</td><td>同一函数返回的 some P 保证是同一类型</td><td>不保证</td></tr><tr><td>适用</td><td>返回值、属性</td><td>参数、集合元素</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-23">5. 方法派发 (Method Dispatch) 全面解析</h3>
<h4 data-id="heading-24">5.1 四种派发方式</h4>



































<table><thead><tr><th>派发方式</th><th>速度</th><th>机制</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>内联 (Inline)</strong></td><td>最快</td><td>编译器将函数体直接插入调用点</td><td>小函数、<code>@inline(__always)</code></td></tr><tr><td><strong>静态派发 (Static/Direct)</strong></td><td>快</td><td>编译期确定函数地址，直接 call</td><td>struct 方法、final 方法、private 方法</td></tr><tr><td><strong>虚表派发 (V-Table)</strong></td><td>中</td><td>通过类的虚函数表间接调用</td><td>class 的非 final 方法</td></tr><tr><td><strong>消息派发 (Message)</strong></td><td>慢</td><td>ObjC runtime 的 objc_msgSend</td><td>@objc dynamic 方法</td></tr></tbody></table>
<h4 data-id="heading-25">5.2 Swift class 的虚函数表</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">Class Metadata:
┌──────────────────────┐
│  isa (指向 metaclass)  │
│  <span class="hljs-keyword">super</span><span class="hljs-keyword">class</span> <span class="hljs-title class_">pointer</span>   │
│  cache (ObjC 兼容)     │
│  <span class="hljs-keyword">data</span> (ObjC 兼容)      │
│  ...                  │
│  V-Table:             │
│    [<span class="hljs-number">0</span>] → method1()    │
│    [<span class="hljs-number">1</span>] → method2()    │
│    [<span class="hljs-number">2</span>] → method3()    │
│    ...                │
└──────────────────────┘
</code></pre>
<ul>
<li>子类的 vtable 包含父类的所有方法条目 + 自己新增的</li>
<li>override 时，子类 vtable 中对应位置替换为子类的函数指针</li>
<li>调用时：metadata → vtable[index] → 间接跳转</li>
</ul>
<h4 data-id="heading-26">5.3 各场景的派发方式总结</h4>




























































<table><thead><tr><th>声明位置</th><th>修饰符</th><th>派发方式</th></tr></thead><tbody><tr><td>struct 方法</td><td>—</td><td>静态</td></tr><tr><td>enum 方法</td><td>—</td><td>静态</td></tr><tr><td>class 方法</td><td>—</td><td>虚表 (V-Table)</td></tr><tr><td>class 方法</td><td><code>final</code></td><td>静态</td></tr><tr><td>class 方法</td><td><code>private</code></td><td>静态（隐式 final）</td></tr><tr><td>class 方法</td><td><code>@objc dynamic</code></td><td>消息 (objc_msgSend)</td></tr><tr><td>protocol 要求方法</td><td>泛型约束 <code>&lt;T: P&gt;</code></td><td>静态（特化后）/ Witness Table</td></tr><tr><td>protocol 要求方法</td><td>存在类型 <code>any P</code></td><td>PWT 动态派发</td></tr><tr><td>protocol 扩展方法</td><td>—</td><td>静态</td></tr><tr><td>extension of class</td><td>—</td><td>静态（不在 vtable 中！）</td></tr></tbody></table>
<p><strong>重要陷阱：class 的 extension 中定义的方法是静态派发！</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">inVTable</span>() { <span class="hljs-built_in">print</span>(<span class="hljs-string">"Base"</span>) }  <span class="hljs-comment">// vtable</span>
}
<span class="hljs-keyword">extension</span> <span class="hljs-title class_">Base</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">notInVTable</span>() { <span class="hljs-built_in">print</span>(<span class="hljs-string">"Base ext"</span>) }  <span class="hljs-comment">// 静态派发！</span>
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Sub</span>: <span class="hljs-title class_">Base</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">inVTable</span>() { <span class="hljs-built_in">print</span>(<span class="hljs-string">"Sub"</span>) }  <span class="hljs-comment">// OK</span>
    <span class="hljs-comment">// override func notInVTable() { }  // 编译错误！不能 override</span>
}
<span class="hljs-keyword">let</span> obj: <span class="hljs-type">Base</span> <span class="hljs-operator">=</span> <span class="hljs-type">Sub</span>()
obj.inVTable()      <span class="hljs-comment">// "Sub" —— 动态派发</span>
obj.notInVTable()   <span class="hljs-comment">// "Base ext" —— 静态派发</span>
</code></pre>
<h4 data-id="heading-27">5.4 @objc 与 dynamic 的区别</h4>

























<table><thead><tr><th>修饰符</th><th>作用</th><th>派发方式</th></tr></thead><tbody><tr><td><code>@objc</code></td><td>将方法暴露给 ObjC runtime</td><td>仍然是 vtable（Swift 侧）</td></tr><tr><td><code>dynamic</code></td><td>使用 ObjC 消息派发</td><td>objc_msgSend</td></tr><tr><td><code>@objc dynamic</code></td><td>暴露给 ObjC 且使用消息派发</td><td>objc_msgSend（可被 KVO/method swizzling）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-28">6. 闭包 (Closure) 底层原理</h3>
<h4 data-id="heading-29">6.1 闭包的内存结构</h4>
<p>闭包在 Swift 中是一个<strong>引用类型</strong>，底层结构：</p>
<pre><code class="hljs language-scss" lang="scss">Closure = 函数指针 + 上下文 (Context)
┌─────────────────────────┐
│  Function Pointer       │  → 指向闭包体的代码
│  Context (Capture List)  │  → 堆上分配的捕获变量
└─────────────────────────┘
</code></pre>
<ul>
<li>如果闭包不捕获任何变量，退化为普通函数指针（无堆分配）</li>
<li>捕获变量时，编译器创建堆上的 context 对象，存储捕获的变量</li>
</ul>
<h4 data-id="heading-30">6.2 捕获语义</h4>
<p><strong>默认捕获：引用捕获（变量）</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> x <span class="hljs-operator">=</span> <span class="hljs-number">10</span>
<span class="hljs-keyword">let</span> closure <span class="hljs-operator">=</span> { <span class="hljs-built_in">print</span>(x) }
x <span class="hljs-operator">=</span> <span class="hljs-number">20</span>
closure()  <span class="hljs-comment">// 输出 20 —— 捕获的是变量本身（引用）</span>
</code></pre>
<p>底层：编译器将 <code>x</code> 从栈上提升到堆上的一个 <code>Box</code> 中，闭包和外部代码共享同一个 Box。</p>
<p><strong>capture list 捕获：值捕获</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> x <span class="hljs-operator">=</span> <span class="hljs-number">10</span>
<span class="hljs-keyword">let</span> closure <span class="hljs-operator">=</span> { [x] <span class="hljs-keyword">in</span> <span class="hljs-built_in">print</span>(x) }
x <span class="hljs-operator">=</span> <span class="hljs-number">20</span>
closure()  <span class="hljs-comment">// 输出 10 —— 捕获的是值的拷贝</span>
</code></pre>
<h4 data-id="heading-31">6.3 逃逸闭包 vs 非逃逸闭包</h4>






























<table><thead><tr><th>维度</th><th><code>@escaping</code></th><th>非逃逸（默认）</th></tr></thead><tbody><tr><td>生命周期</td><td>超出函数作用域</td><td>函数返回前执行完毕</td></tr><tr><td>堆分配</td><td>必须堆分配 context</td><td>编译器可能优化到栈上</td></tr><tr><td>捕获 self</td><td>需要显式 <code>self.</code></td><td>不需要</td></tr><tr><td>性能</td><td>有堆分配开销</td><td>可能零开销</td></tr></tbody></table>
<p><strong><code>withoutActuallyEscaping</code>：</strong> 允许将非逃逸闭包临时当作逃逸闭包使用（高级场景）。</p>
<h4 data-id="heading-32">6.4 @autoclosure</h4>
<ul>
<li>将<strong>表达式</strong>自动包装为闭包，延迟求值</li>
<li>常用于 <code>assert</code>、<code>??</code> 等需要短路求值的场景</li>
<li>底层就是一个无参闭包 <code>() -&gt; T</code></li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">logIfTrue</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">condition</span>: <span class="hljs-keyword">@autoclosure</span> () -&gt; <span class="hljs-type">Bool</span>) {
    <span class="hljs-keyword">if</span> condition() { <span class="hljs-built_in">print</span>(<span class="hljs-string">"True"</span>) }
}
logIfTrue(<span class="hljs-number">2</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>)  <span class="hljs-comment">// 2 &gt; 1 被自动包装为 { 2 &gt; 1 }</span>
</code></pre>
<hr/>
<h3 data-id="heading-33">7. 枚举 (Enum) 底层原理</h3>
<h4 data-id="heading-34">7.1 简单枚举的内存布局</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Direction</span> { <span class="hljs-keyword">case</span> north, south, east, west }
<span class="hljs-comment">// sizeof = 1 字节（只需要区分 4 个 case，1 字节足够 256 个）</span>
</code></pre>
<ul>
<li>底层就是一个整数 tag（鉴别器/discriminator）</li>
<li>case 数量 ≤ 256 → 1 字节；≤ 65536 → 2 字节；依此类推</li>
</ul>
<h4 data-id="heading-35">7.2 关联值枚举的内存布局</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Result</span> {
    <span class="hljs-keyword">case</span> success(<span class="hljs-type">Int</span>)    <span class="hljs-comment">// payload: 8 字节</span>
    <span class="hljs-keyword">case</span> failure(<span class="hljs-type">String</span>) <span class="hljs-comment">// payload: 16 字节</span>
}
<span class="hljs-comment">// sizeof = max(payload) + tag = 16 + 1 = 17，对齐到 8 → 24 字节</span>
</code></pre>
<ul>
<li>采用 <strong>tagged union</strong> 策略</li>
<li>大小 = max(所有 case 的 payload) + tag 的大小（可能利用 spare bits 优化）</li>
</ul>
<h4 data-id="heading-36">7.3 Optional 的底层：枚举的极致优化</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Optional&lt;T&gt; 就是：</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">Optional</span>&lt;<span class="hljs-title class_">Wrapped</span>&gt; {
    <span class="hljs-keyword">case</span> none
    <span class="hljs-keyword">case</span> <span class="hljs-keyword">some</span>(<span class="hljs-type">Wrapped</span>)
}
</code></pre>
<p><strong>指针类型的 Optional 优化：</strong></p>
<ul>
<li><code>Optional&lt;AnyObject&gt;</code> 只占 8 字节（和非 Optional 一样！）</li>
<li>因为指针不可能为 <code>0x0</code>，所以 <code>none</code> 用全零表示，<code>some</code> 用有效指针值</li>
<li>这叫 <strong>spare bit optimization</strong> —— 利用值中不可能出现的 bit pattern 作为 tag</li>
<li>同理 <code>Optional&lt;Bool&gt;</code> = 1 字节（Bool 只有 0/1，用 2 表示 none）</li>
</ul>
<h4 data-id="heading-37">7.4 indirect enum</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">indirect</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Tree</span> {
    <span class="hljs-keyword">case</span> leaf(<span class="hljs-type">Int</span>)
    <span class="hljs-keyword">case</span> node(<span class="hljs-type">Tree</span>, <span class="hljs-type">Tree</span>)
}
</code></pre>
<ul>
<li>没有 <code>indirect</code> 时，Tree 大小会无限递归（编译错误）</li>
<li><code>indirect</code> 让关联值通过<strong>堆上的 Box</strong> 间接引用</li>
<li>底层类似于 <code>case node(Box&lt;Tree&gt;, Box&lt;Tree&gt;)</code>，Box 是引用类型</li>
</ul>
<hr/>
<h3 data-id="heading-38">8. Struct vs Class 的性能深入对比</h3>
<h4 data-id="heading-39">8.1 分配与释放</h4>

























<table><thead><tr><th>操作</th><th>struct (栈)</th><th>class (堆)</th></tr></thead><tbody><tr><td>分配</td><td>移动栈指针（1条指令）</td><td>malloc 系统调用（涉及锁、空闲链表搜索）</td></tr><tr><td>释放</td><td>移动栈指针</td><td>free + 引用计数归零检查</td></tr><tr><td>速度比</td><td>~1ns</td><td>~25-100ns</td></tr></tbody></table>
<h4 data-id="heading-40">8.2 引用计数开销</h4>
<ul>
<li>class 每次传递都要 retain（原子操作 ~5ns）</li>
<li>多线程下原子操作可能导致 cache line bouncing</li>
<li>struct 无引用计数，但含引用类型成员时有间接引用计数开销</li>
</ul>
<h4 data-id="heading-41">8.3 缓存友好性</h4>
<ul>
<li>struct 的数组 <code>[MyStruct]</code>：连续内存，cache 友好</li>
<li>class 的数组 <code>[MyClass]</code>：数组存的是指针，实际对象分散在堆上，cache miss 率高</li>
<li>这在遍历大数据集时差距巨大</li>
</ul>
<hr/>
<h3 data-id="heading-42">9. String 底层原理</h3>
<h4 data-id="heading-43">9.1 Small String Optimization (SSO)</h4>
<ul>
<li>Swift String 占 16 字节（2 个 word）</li>
<li>短字符串（≤ 15 字节 UTF-8）直接 <strong>inline 存储</strong>在这 16 字节中，无堆分配</li>
<li>长字符串在堆上分配 buffer，16 字节中存 buffer 指针 + 长度 + flags</li>
<li>判断标志位在最高位</li>
</ul>
<h4 data-id="heading-44">9.2 String 的字符模型</h4>
<ul>
<li>Swift 的 <code>Character</code> 是<strong>扩展字形簇 (Extended Grapheme Cluster)</strong></li>
<li>一个 <code>Character</code> 可能对应多个 Unicode 标量（如 emoji 👨‍👩‍👧‍👦 = 7 个标量）</li>
<li>因此 <code>String.count</code> 是 O(n) 复杂度（需要遍历确定字形簇边界）</li>
<li><code>String.Index</code> 不是整数，是不透明的偏移量，因为字符宽度不固定</li>
</ul>
<h4 data-id="heading-45">9.3 String 的多种视图</h4>






























<table><thead><tr><th>视图</th><th>元素</th><th>场景</th></tr></thead><tbody><tr><td><code>string.utf8</code></td><td>UTF8.CodeUnit (UInt8)</td><td>网络传输、C 交互</td></tr><tr><td><code>string.utf16</code></td><td>UTF16.CodeUnit (UInt16)</td><td>NSString 兼容</td></tr><tr><td><code>string.unicodeScalars</code></td><td>Unicode.Scalar</td><td>Unicode 处理</td></tr><tr><td><code>string</code> (默认)</td><td>Character</td><td>用户可见字符</td></tr></tbody></table>
<h4 data-id="heading-46">9.4 String 与 NSString 的桥接</h4>
<ul>
<li>Swift String 和 NSString 可以零成本桥接（toll-free bridging 的 Swift 版本）</li>
<li>但底层编码不同：Swift 用 UTF-8，NSString 用 UTF-16</li>
<li>桥接时可能触发转码，有性能开销</li>
<li><code>String</code> 被传给 ObjC API 时可能创建临时 NSString（autorelease 对象）</li>
</ul>
<hr/>
<h3 data-id="heading-47">10. 属性 (Property) 的底层机制</h3>
<h4 data-id="heading-48">10.1 存储属性 vs 计算属性</h4>

























<table><thead><tr><th>类型</th><th>内存</th><th>本质</th></tr></thead><tbody><tr><td>存储属性</td><td>占实例内存</td><td>实际的内存字段</td></tr><tr><td>计算属性</td><td>不占内存</td><td>getter/setter 方法</td></tr><tr><td>lazy 属性</td><td>Optional 存储</td><td>首次访问时初始化</td></tr></tbody></table>
<h4 data-id="heading-49">10.2 属性观察器 (willSet/didSet) 底层</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> name: <span class="hljs-type">String</span> {
    <span class="hljs-keyword">willSet</span> { <span class="hljs-built_in">print</span>(<span class="hljs-string">"将变为 <span class="hljs-subst">\(newValue)</span>"</span>) }
    <span class="hljs-keyword">didSet</span> { <span class="hljs-built_in">print</span>(<span class="hljs-string">"已从 <span class="hljs-subst">\(oldValue)</span> 变为 <span class="hljs-subst">\(name)</span>"</span>) }
}
</code></pre>
<p>编译器展开为：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> _name: <span class="hljs-type">String</span>
<span class="hljs-keyword">var</span> name: <span class="hljs-type">String</span> {
    <span class="hljs-keyword">get</span> { _name }
    <span class="hljs-keyword">set</span> {
        <span class="hljs-keyword">let</span> oldValue <span class="hljs-operator">=</span> _name
        <span class="hljs-comment">// willSet(newValue)</span>
        _name <span class="hljs-operator">=</span> newValue
        <span class="hljs-comment">// didSet(oldValue)</span>
    }
}
</code></pre>
<p>注意：<code>init</code> 中赋值<strong>不会</strong>触发 willSet/didSet。</p>
<h4 data-id="heading-50">10.3 Property Wrapper 底层</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">@propertyWrapper</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Clamped</span> {
    <span class="hljs-keyword">var</span> wrappedValue: <span class="hljs-type">Int</span> { <span class="hljs-operator">...</span> }
    <span class="hljs-keyword">var</span> projectedValue: <span class="hljs-type">Clamped</span> { <span class="hljs-keyword">self</span> }
}
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-meta">@Clamped</span> <span class="hljs-keyword">var</span> volume: <span class="hljs-type">Int</span>
}
</code></pre>
<p>编译器展开为：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _volume: <span class="hljs-type">Clamped</span>
    <span class="hljs-keyword">var</span> volume: <span class="hljs-type">Int</span> {
        <span class="hljs-keyword">get</span> { _volume.wrappedValue }
        <span class="hljs-keyword">set</span> { _volume.wrappedValue <span class="hljs-operator">=</span> newValue }
    }
    <span class="hljs-keyword">var</span> <span class="hljs-variable">$volume</span>: <span class="hljs-type">Clamped</span> { _volume.projectedValue }
}
</code></pre>
<h4 data-id="heading-51">10.4 KeyPath 底层</h4>
<ul>
<li>KeyPath 是一个<strong>类型安全的属性引用</strong>，底层是一个对象</li>
<li>编译器生成一系列 offset/accessor 信息</li>
<li>支持组合（<code>\Base.a.b.c</code>）、运行时读写</li>
<li><code>WritableKeyPath</code>、<code>ReferenceWritableKeyPath</code> 等继承层级</li>
<li>KeyPath 的读取性能接近直接属性访问（编译器优化后）</li>
</ul>
<hr/>
<h3 data-id="heading-52">11. 并发 (Concurrency) — Swift Concurrency</h3>
<h4 data-id="heading-53">11.1 Actor 模型</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">actor</span> <span class="hljs-title class_">BankAccount</span> {
    <span class="hljs-keyword">var</span> balance: <span class="hljs-type">Double</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">deposit</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">amount</span>: <span class="hljs-type">Double</span>) { balance <span class="hljs-operator">+=</span> amount }
}
</code></pre>
<p><strong>底层原理：</strong></p>
<ul>
<li>Actor 内部有一个<strong>串行执行器 (Serial Executor)</strong></li>
<li>所有对 actor 的方法调用被排列在执行器的队列中</li>
<li>保证<strong>同一时刻只有一个任务</strong>在执行 actor 的代码</li>
<li>跨 actor 调用需要 <code>await</code>（可能涉及线程切换）</li>
</ul>
<p><strong>Actor 隔离 (Isolation)：</strong></p>
<ul>
<li>Actor 的属性和方法默认是 isolated 的</li>
<li>外部访问需要 <code>await</code>（异步访问）</li>
<li><code>nonisolated</code> 标记的方法可以不需要 await（不能访问 mutable 状态）</li>
</ul>
<h4 data-id="heading-54">11.2 Structured Concurrency</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> result1 <span class="hljs-operator">=</span> fetchData1()
<span class="hljs-keyword">async</span> <span class="hljs-keyword">let</span> result2 <span class="hljs-operator">=</span> fetchData2()
<span class="hljs-keyword">let</span> combined <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> (result1, result2)
</code></pre>
<ul>
<li>子任务的生命周期绑定到父作用域</li>
<li>父任务取消时，子任务自动取消</li>
<li>子任务完成前，父作用域不会退出</li>
</ul>
<h4 data-id="heading-55">11.3 Task 与 TaskGroup</h4>
<p><strong>Task：</strong></p>
<ul>
<li><code>Task { }</code> 创建非结构化的顶级任务</li>
<li><code>Task.detached { }</code> 创建完全独立的任务（不继承 actor context）</li>
<li>Task 持有对结果的引用，可以 <code>await task.value</code></li>
</ul>
<p><strong>TaskGroup：</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">await</span> withTaskGroup(of: <span class="hljs-type">Int</span>.<span class="hljs-keyword">self</span>) { group <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span><span class="hljs-number">10</span> {
        group.addTask { <span class="hljs-keyword">await</span> compute(i) }
    }
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> result <span class="hljs-keyword">in</span> group { <span class="hljs-operator">...</span> }
}
</code></pre>
<h4 data-id="heading-56">11.4 Sendable 协议</h4>
<ul>
<li>标记类型可以安全跨并发域传递</li>
<li>值类型自动满足 Sendable（如果所有成员都是 Sendable）</li>
<li>class 需要满足：final + 所有属性 immutable (let) + Sendable</li>
<li><code>@Sendable</code> 标记闭包，禁止捕获可变状态</li>
<li>编译器在严格并发检查模式下会检查 Sendable 合规性</li>
</ul>
<h4 data-id="heading-57">11.5 async/await 底层 —— Continuation</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchData</span>() <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">Data</span> { <span class="hljs-operator">...</span> }
</code></pre>
<ul>
<li>编译器将 async 函数转换为<strong>状态机</strong></li>
<li>每个 <code>await</code> 点是一个 <strong>suspension point（挂起点）</strong></li>
<li>函数被分割为多个 continuation（延续）</li>
<li>挂起时不阻塞线程，线程可以执行其他任务</li>
<li>恢复时通过 continuation 跳回正确的执行点</li>
<li>这就是 <strong>协程 (Coroutine)</strong> 的实现</li>
</ul>
<p><strong>与 GCD 的区别：</strong></p>






























<table><thead><tr><th>维度</th><th>GCD</th><th>Swift Concurrency</th></tr></thead><tbody><tr><td>线程模型</td><td>每个 block 可能在不同线程</td><td>协程，挂起不占线程</td></tr><tr><td>线程爆炸</td><td>容易创建过多线程</td><td>协作式线程池（线程数 ≤ CPU 核心数）</td></tr><tr><td>结构化</td><td>无</td><td>Task 层级结构，自动取消传播</td></tr><tr><td>安全性</td><td>手动保证</td><td>Actor 隔离，Sendable 检查</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-58">12. 类型系统高级特性</h3>
<h4 data-id="heading-59">12.1 Phantom Type（幻影类型）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Kilometers</span> {}
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">Miles</span> {}
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Distance</span>&lt;<span class="hljs-title class_">Unit</span>&gt; {
    <span class="hljs-keyword">let</span> value: <span class="hljs-type">Double</span>
}
<span class="hljs-comment">// Distance&lt;Kilometers&gt; 和 Distance&lt;Miles&gt; 是不同类型</span>
<span class="hljs-comment">// Unit 从未被使用为值，只在类型层面区分 → 零开销</span>
</code></pre>
<h4 data-id="heading-60">12.2 Result Builder</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">@resultBuilder</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ArrayBuilder</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">buildBlock</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">components</span>: <span class="hljs-type">Int</span>...) -&gt; [<span class="hljs-type">Int</span>] {
        components
    }
}
</code></pre>
<ul>
<li>编译器将 DSL 块内的语句转换为 <code>buildBlock</code>/<code>buildOptional</code>/<code>buildEither</code> 等方法调用</li>
<li>SwiftUI 的 <code>@ViewBuilder</code> 就是 result builder</li>
</ul>
<h4 data-id="heading-61">12.3 Metatype（元类型）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> type: <span class="hljs-type">Int</span>.<span class="hljs-keyword">Type</span> <span class="hljs-operator">=</span> <span class="hljs-type">Int</span>.<span class="hljs-keyword">self</span>  <span class="hljs-comment">// Int 的元类型</span>
<span class="hljs-keyword">let</span> obj <span class="hljs-operator">=</span> type.<span class="hljs-keyword">init</span>(<span class="hljs-number">42</span>)        <span class="hljs-comment">// 用元类型创建实例</span>
</code></pre>
<ul>
<li><code>.self</code> 获取类型本身的值</li>
<li><code>.Type</code> 是类型的元类型</li>
<li><code>type(of: instance)</code> 获取运行时动态类型</li>
<li>对于 class，<code>type(of:)</code> 返回的可能是子类类型</li>
</ul>
<hr/>
<h2 data-id="heading-62">第二部分：第三方常用库原理</h2>
<hr/>
<h3 data-id="heading-63">1. Alamofire</h3>
<h4 data-id="heading-64">1.1 架构分层</h4>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-built_in">Request</span> → SessionManager → URLSession → URLSessionTask
   ↑          ↑                ↑
Encoding   ServerTrust     Interceptor
</code></pre>
<h4 data-id="heading-65">1.2 核心原理</h4>
<ul>
<li>基于 <code>URLSession</code> 封装，使用 <code>URLSessionDelegate</code> 统一管理回调</li>
<li><strong>请求拦截器 (RequestInterceptor)</strong>：<code>adapt</code> 修改请求（如添加 token），<code>retry</code> 处理重试</li>
<li><strong>响应序列化</strong>：通过 <code>ResponseSerializer</code> 协议将 <code>Data</code> 转为目标类型</li>
<li><strong>请求链</strong>：请求排队 → 适配 → 发送 → 验证 → 序列化 → 回调</li>
<li><strong>证书锁定 (Certificate Pinning)</strong>：通过 <code>ServerTrustManager</code> 实现，防中间人攻击</li>
</ul>
<h4 data-id="heading-66">1.3 重要设计模式</h4>
<ul>
<li><strong>Builder 模式</strong>：链式调用 <code>.validate().responseDecodable(of:)</code></li>
<li><strong>命令模式</strong>：<code>Request</code> 封装了一次完整请求的所有信息</li>
<li><strong>策略模式</strong>：<code>ParameterEncoding</code> 协议的不同实现（URL/JSON/Custom）</li>
</ul>
<hr/>
<h3 data-id="heading-67">2. Kingfisher</h3>
<h4 data-id="heading-68">2.1 核心架构</h4>
<pre><code class="hljs language-markdown" lang="markdown">KingfisherManager
  ├── ImageDownloader（网络下载）
  └── ImageCache
<span class="hljs-code">        ├── MemoryCache（NSCache）
        └── DiskCache（FileManager）
</span></code></pre>
<h4 data-id="heading-69">2.2 缓存策略</h4>
<ul>
<li><strong>内存缓存</strong>：基于 <code>NSCache</code>，系统内存紧张时自动清理</li>
<li><strong>磁盘缓存</strong>：文件名 = URL 的 MD5 哈希，支持过期时间和大小限制</li>
<li><strong>查找顺序</strong>：内存 → 磁盘 → 网络下载</li>
<li><strong>缓存键</strong>：默认为 URL 字符串，可自定义 <code>CacheKeyFilter</code></li>
</ul>
<h4 data-id="heading-70">2.3 图片处理管线</h4>
<ul>
<li><strong>Processor</strong>：下载后/缓存前进行图片处理（裁剪、模糊、圆角等）</li>
<li>处理后的图片以 <code>原始key + processor标识</code> 为 key 缓存</li>
<li>支持渐进式 JPEG 加载、GIF 动画、SVG</li>
</ul>
<h4 data-id="heading-71">2.4 性能优化细节</h4>
<ul>
<li>下载使用 <code>URLSession</code>，支持 HTTP/2 多路复用</li>
<li>图片解码在后台线程，避免阻塞主线程</li>
<li>支持下载优先级和取消（cell 复用时取消旧请求）</li>
<li><code>ImagePrefetcher</code> 预加载机制</li>
</ul>
<hr/>
<h3 data-id="heading-72">3. SnapKit</h3>
<h4 data-id="heading-73">3.1 底层原理</h4>
<ul>
<li>本质是对 Auto Layout 的 <code>NSLayoutConstraint</code> 的 DSL 封装</li>
<li><strong>链式调用</strong>：每个方法返回 <code>ConstraintMaker</code>/<code>ConstraintDescription</code></li>
<li><code>make.top.equalTo(view).offset(10)</code> 最终等价于创建一个 <code>NSLayoutConstraint</code></li>
<li><strong>约束更新</strong>：<code>snp.updateConstraints</code> 找到已有约束修改 constant，比重新创建高效</li>
<li><strong>约束引用</strong>：可以保存约束引用后续修改 <code>constraint.update(offset: 20)</code></li>
</ul>
<h4 data-id="heading-74">3.2 与原生 API 的性能对比</h4>
<ul>
<li>SnapKit 在约束创建阶段有少量 wrapper 开销（可忽略）</li>
<li>约束解算性能完全等同于原生 Auto Layout（最终都走同一个 Cassowary 算法引擎）</li>
<li>主要价值是可读性和维护性</li>
</ul>
<hr/>
<h3 data-id="heading-75">4. RxSwift / Combine 响应式框架</h3>
<h4 data-id="heading-76">4.1 核心概念对比</h4>








































<table><thead><tr><th>概念</th><th>RxSwift</th><th>Combine</th></tr></thead><tbody><tr><td>数据流</td><td>Observable</td><td>Publisher</td></tr><tr><td>消费者</td><td>Observer</td><td>Subscriber</td></tr><tr><td>取消</td><td>Disposable / DisposeBag</td><td>AnyCancellable</td></tr><tr><td>背压</td><td>无原生支持</td><td>Demand 机制</td></tr><tr><td>调度器</td><td>Scheduler</td><td>Scheduler</td></tr><tr><td>Subject</td><td>PublishSubject/BehaviorSubject</td><td>PassthroughSubject/CurrentValueSubject</td></tr></tbody></table>
<h4 data-id="heading-77">4.2 RxSwift 底层原理</h4>
<ul>
<li><code>Observable</code> 是一个持有 <code>subscribe</code> 闭包的结构</li>
<li><code>subscribe</code> 时创建 <code>Sink</code>（桥梁），连接 Observable 和 Observer</li>
<li>操作符（map/filter 等）创建新的 Observable，形成<strong>链式管道</strong></li>
<li><code>DisposeBag</code> 在 deinit 时调用所有 Disposable 的 dispose，断开链条</li>
</ul>
<h4 data-id="heading-78">4.3 Combine 底层原理</h4>
<ul>
<li>基于 Publisher-Subscriber 协议</li>
<li><strong>背压 (Backpressure)</strong>：Subscriber 通过 <code>Demand</code> 控制接收速率</li>
<li>Publisher 是<strong>值类型</strong>（struct），Subscriber 是<strong>引用类型</strong>（class）</li>
<li><code>sink</code>/<code>assign</code> 等返回 <code>AnyCancellable</code>，释放即取消订阅</li>
</ul>
<hr/>
<h3 data-id="heading-79">5. SwiftUI 数据流原理</h3>
<h4 data-id="heading-80">5.1 属性包装器对比</h4>















































<table><thead><tr><th>Property Wrapper</th><th>所有权</th><th>触发刷新</th><th>适用场景</th></tr></thead><tbody><tr><td><code>@State</code></td><td>View 拥有</td><td>值变化时</td><td>View 内部简单状态</td></tr><tr><td><code>@Binding</code></td><td>不拥有（引用）</td><td>值变化时</td><td>父子 View 双向绑定</td></tr><tr><td><code>@ObservedObject</code></td><td>不拥有</td><td>objectWillChange 时</td><td>外部注入的 ObservableObject</td></tr><tr><td><code>@StateObject</code></td><td>View 拥有</td><td>objectWillChange 时</td><td>View 创建的 ObservableObject</td></tr><tr><td><code>@EnvironmentObject</code></td><td>不拥有</td><td>objectWillChange 时</td><td>跨层级的 ObservableObject</td></tr><tr><td><code>@Environment</code></td><td>不拥有</td><td>值变化时</td><td>系统环境值</td></tr></tbody></table>
<h4 data-id="heading-81">5.2 View 的 diff 更新机制</h4>
<ul>
<li>SwiftUI View 是<strong>值类型 struct</strong>，每次状态变化创建新的 View 值</li>
<li>SwiftUI 通过 <strong>attribute graph</strong> 追踪依赖关系</li>
<li>只有依赖的数据发生变化的 View 才会被重新 body 求值</li>
<li>body 返回的新旧 View tree 做 <strong>structural diff</strong>，只更新差异部分</li>
</ul>
<hr/>
<h2 data-id="heading-82">第三部分：开发难点与解决方案</h2>
<hr/>
<h3 data-id="heading-83">1. 内存泄漏排查</h3>
<h4 data-id="heading-84">1.1 常见泄漏场景</h4>








































<table><thead><tr><th>场景</th><th>根因</th><th>解决</th></tr></thead><tbody><tr><td>闭包捕获 self</td><td>循环引用</td><td><code>[weak self]</code> / <code>[unowned self]</code></td></tr><tr><td>delegate 强引用</td><td>循环引用</td><td>delegate 用 weak 声明</td></tr><tr><td>Timer 持有 target</td><td>Timer → self → Timer</td><td><code>Timer.scheduledTimer(withTimeInterval:repeats:block:)</code> + <code>[weak self]</code></td></tr><tr><td>NotificationCenter addObserver</td><td>iOS 8 以下需手动 remove</td><td>block-based API + <code>[weak self]</code></td></tr><tr><td>DispatchWorkItem 捕获</td><td>闭包内持有 self</td><td>取消 workItem 或 <code>[weak self]</code></td></tr><tr><td>WKWebView 与 JS 交互</td><td>WKScriptMessageHandler 被 WKUserContentController 强持有</td><td>使用中间代理对象弱引用 self</td></tr></tbody></table>
<h4 data-id="heading-85">1.2 排查工具链</h4>
<ol>
<li><strong>Xcode Memory Graph Debugger</strong>：可视化对象引用关系，直接定位循环引用</li>
<li><strong>Instruments - Leaks</strong>：运行时检测内存泄漏</li>
<li><strong>Instruments - Allocations</strong>：查看对象生命周期和内存分配</li>
<li><strong>deinit 打印</strong>：在 deinit 中加 print 确认对象释放</li>
<li><strong>MLeaksFinder（第三方）</strong>：自动检测 ViewController 泄漏</li>
</ol>
<h4 data-id="heading-86">1.3 难点：隐蔽的循环引用</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 难以发现的泄漏：闭包嵌套</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModel</span> {
    <span class="hljs-keyword">var</span> onUpdate: (() -&gt; <span class="hljs-type">Void</span>)<span class="hljs-operator">?</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">start</span>() {
        <span class="hljs-type">NetworkManager</span>.shared.request { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] data <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.onUpdate <span class="hljs-operator">=</span> {
                <span class="hljs-comment">// 这里隐式捕获了 self（strong），因为 onUpdate 是 self 的属性</span>
                <span class="hljs-comment">// 而 self?.onUpdate = ... 外层已经是 weak self</span>
                <span class="hljs-comment">// 但 inner closure 没有 weak！</span>
                <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.process(data)  <span class="hljs-comment">// 如果这里 self 已经 unwrap 为 strong...</span>
            }
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-87">2. 多线程数据竞争</h3>
<h4 data-id="heading-88">2.1 经典问题</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> array <span class="hljs-operator">=</span> [<span class="hljs-type">Int</span>]()
<span class="hljs-type">DispatchQueue</span>.concurrentPerform(iterations: <span class="hljs-number">1000</span>) { i <span class="hljs-keyword">in</span>
    array.append(i)  <span class="hljs-comment">// 崩溃！Array 非线程安全</span>
}
</code></pre>
<h4 data-id="heading-89">2.2 解决方案对比</h4>








































<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>Serial DispatchQueue</td><td>简单直观</td><td>完全串行，性能差</td></tr><tr><td>Concurrent Queue + Barrier</td><td>读并发，写独占</td><td>代码稍复杂</td></tr><tr><td>NSLock / pthread_mutex</td><td>最轻量</td><td>需要手动 lock/unlock</td></tr><tr><td>os_unfair_lock</td><td>最快的互斥锁</td><td>不支持递归</td></tr><tr><td>Actor (Swift 5.5+)</td><td>编译器保证安全</td><td>异步调用</td></tr><tr><td>@Atomic property wrapper</td><td>属性级别保护</td><td>单次操作安全，复合操作不安全</td></tr></tbody></table>
<h4 data-id="heading-90">2.3 Barrier 读写锁模式</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadSafeArray</span>&lt;<span class="hljs-title class_">T</span>&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> array <span class="hljs-operator">=</span> [<span class="hljs-type">T</span>]()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> queue <span class="hljs-operator">=</span> <span class="hljs-type">DispatchQueue</span>(label: <span class="hljs-string">"safe"</span>, attributes: .concurrent)

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">read</span>&lt;<span class="hljs-type">R</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">block</span>: ([<span class="hljs-type">T</span>]) -&gt; <span class="hljs-type">R</span>) -&gt; <span class="hljs-type">R</span> {
        queue.sync { block(array) }  <span class="hljs-comment">// 并发读</span>
    }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">write</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">block</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-keyword">inout</span> [<span class="hljs-type">T</span>]) -&gt; <span class="hljs-type">Void</span>) {
        queue.async(flags: .barrier) { block(<span class="hljs-operator">&amp;</span><span class="hljs-keyword">self</span>.array) }  <span class="hljs-comment">// 独占写</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-91">3. 大量数据的列表性能</h3>
<h4 data-id="heading-92">3.1 问题</h4>
<ul>
<li>大量 cell 导致滚动卡顿</li>
<li>图片加载闪烁</li>
<li>内存暴涨</li>
</ul>
<h4 data-id="heading-93">3.2 解决方案</h4>

































<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td>cell 创建开销</td><td>复用机制 <code>dequeueReusableCell</code></td></tr><tr><td>图片解码卡主线程</td><td>异步解码 + 缓存解码后的 bitmap</td></tr><tr><td>复杂 cell 布局</td><td>预计算 cell 高度，缓存布局结果</td></tr><tr><td>透明度 / 离屏渲染</td><td>避免 <code>cornerRadius</code> + <code>masksToBounds</code>，用 <code>CAShapeLayer</code> 或预渲染圆角图</td></tr><tr><td>大量图片内存</td><td>Kingfisher/SDWebImage 的缩略图 + downsampling</td></tr><tr><td>Diff 更新</td><td>DiffableDataSource / IGListKit / 手动 diff 只更新变化的 cell</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-94">4. 启动优化</h3>
<h4 data-id="heading-95">4.1 启动阶段拆解</h4>
<pre><code class="hljs language-markdown" lang="markdown">冷启动：
<span class="hljs-bullet">  1.</span> 内核创建进程
<span class="hljs-bullet">  2.</span> dyld 加载 → 动态库绑定 → rebase/bind
<span class="hljs-bullet">  3.</span> +load / <span class="hljs-strong">__attribute__</span>((constructor))
<span class="hljs-bullet">  4.</span> Runtime 初始化（ObjC class 注册、category attach）
<span class="hljs-bullet">  5.</span> main() 函数
<span class="hljs-bullet">  6.</span> AppDelegate → UIWindow → 首屏渲染
</code></pre>
<h4 data-id="heading-96">4.2 优化手段</h4>





























<table><thead><tr><th>阶段</th><th>优化方式</th></tr></thead><tbody><tr><td>dyld</td><td>减少动态库数量（合并为 1 个）；使用静态库</td></tr><tr><td>+load</td><td>移到 +initialize 或懒加载</td></tr><tr><td>二进制</td><td>二进制重排（Profile-Guided Optimization），减少 Page Fault</td></tr><tr><td>main 后</td><td>延迟非必要初始化，首屏数据预加载/缓存</td></tr><tr><td>渲染</td><td>简化首屏 UI，避免首屏大量 Auto Layout</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-97">5. 崩溃治理</h3>
<h4 data-id="heading-98">5.1 常见崩溃类型</h4>






























<table><thead><tr><th>崩溃</th><th>原因</th><th>Swift 中的表现</th></tr></thead><tbody><tr><td>EXC_BAD_ACCESS</td><td>野指针 / 访问已释放内存</td><td>极少（ARC + 值类型），除非 <code>unowned(unsafe)</code> 或 Unsafe 指针</td></tr><tr><td>EXC_BREAKPOINT</td><td>trap 指令</td><td><code>fatalError</code>、force unwrap nil、数组越界</td></tr><tr><td>SIGABRT</td><td>abort()</td><td>断言失败、unrecognized selector（ObjC 交互）</td></tr><tr><td>OOM</td><td>内存超限</td><td>无 crash log（Jetsam），需要 MetricKit</td></tr></tbody></table>
<h4 data-id="heading-99">5.2 Swift 特有崩溃</h4>
<ul>
<li><strong>Force unwrap nil</strong>：<code>let x: Int = optional!</code> —— 最常见</li>
<li><strong>Array index out of range</strong>：下标越界</li>
<li><strong>Unowned reference after dealloc</strong>：访问已释放的 unowned 对象</li>
<li><strong>Exhaustive switch</strong>：enum 新增 case 但 switch 未覆盖（@unknown default）</li>
</ul>
<hr/>
<h2 data-id="heading-100">第四部分：性能优化深入细节</h2>
<hr/>
<h3 data-id="heading-101">1. 编译器优化</h3>
<h4 data-id="heading-102">1.1 关键编译选项</h4>



































<table><thead><tr><th>选项</th><th>含义</th><th>效果</th></tr></thead><tbody><tr><td><code>-Onone</code></td><td>无优化（Debug）</td><td>保留所有调试信息</td></tr><tr><td><code>-O</code></td><td>标准优化（Release）</td><td>内联、泛型特化、死代码消除</td></tr><tr><td><code>-Osize</code></td><td>优化体积</td><td>减少内联，优先选择小代码</td></tr><tr><td><code>-Ounchecked</code></td><td>移除安全检查</td><td>数组越界、溢出检查被移除，危险但最快</td></tr><tr><td><strong>WMO</strong> (Whole Module Optimization)</td><td>全模块优化</td><td>跨文件内联/特化/去虚拟化</td></tr></tbody></table>
<h4 data-id="heading-103">1.2 WMO 的重要性</h4>
<ul>
<li>非 WMO 模式下，每个文件单独编译，看不到其他文件的实现</li>
<li>WMO 允许编译器将非 public/非 open 的 class 方法<strong>去虚拟化</strong>（直接调用）</li>
<li>将 <code>internal</code> 方法从 vtable 派发降级为静态派发</li>
<li>自动推断 <code>final</code>（如果子类在整个模块中不存在）</li>
</ul>
<h4 data-id="heading-104">1.3 帮助编译器优化的编码技巧</h4>





































<table><thead><tr><th>技巧</th><th>原因</th></tr></thead><tbody><tr><td>用 <code>final</code> 修饰不需要继承的 class</td><td>静态派发</td></tr><tr><td>用 <code>private</code> / <code>fileprivate</code></td><td>编译器可推断 final，静态派发</td></tr><tr><td>用 struct 而非 class</td><td>无引用计数，栈分配</td></tr><tr><td>避免过大的协议 existential</td><td>减少堆分配</td></tr><tr><td>用 <code>@inlinable</code> 暴露关键路径</td><td>跨模块内联优化</td></tr><tr><td>用 <code>@frozen</code> 标记稳定的 struct/enum</td><td>允许编译器直接操作内存布局</td></tr><tr><td>减少不必要的 Optional</td><td>减少分支和 unwrap 开销</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-105">2. 内存优化</h3>
<h4 data-id="heading-106">2.1 减少堆分配</h4>





























<table><thead><tr><th>场景</th><th>优化</th></tr></thead><tbody><tr><td>小对象</td><td>用 struct 替代 class</td></tr><tr><td>协议类型</td><td>用泛型约束替代 existential</td></tr><tr><td>闭包</td><td>非逃逸闭包（编译器可栈分配）</td></tr><tr><td>String</td><td>短字符串利用 SSO</td></tr><tr><td>数组</td><td><code>Array.reserveCapacity(_:)</code> 预分配，避免多次扩容拷贝</td></tr></tbody></table>
<h4 data-id="heading-107">2.2 减少引用计数操作</h4>
<ul>
<li>减少 class 实例的传递次数</li>
<li>struct 中减少引用类型成员数量</li>
<li>用 <code>let</code> 代替 <code>var</code>（编译器可以省略某些 retain/release）</li>
<li>考虑 <code>Unmanaged&lt;T&gt;</code> 手动管理引用计数（高性能场景）</li>
</ul>
<h4 data-id="heading-108">2.3 内存对齐与布局优化</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 不好：padding 浪费</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Bad</span> {
    <span class="hljs-keyword">let</span> a: <span class="hljs-type">Bool</span>    <span class="hljs-comment">// 1 byte + 7 padding</span>
    <span class="hljs-keyword">let</span> b: <span class="hljs-type">Int64</span>   <span class="hljs-comment">// 8 bytes</span>
    <span class="hljs-keyword">let</span> c: <span class="hljs-type">Bool</span>    <span class="hljs-comment">// 1 byte + 7 padding</span>
}  <span class="hljs-comment">// 总共 24 bytes</span>

<span class="hljs-comment">// 好：重排成员减少 padding</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Good</span> {
    <span class="hljs-keyword">let</span> b: <span class="hljs-type">Int64</span>   <span class="hljs-comment">// 8 bytes</span>
    <span class="hljs-keyword">let</span> a: <span class="hljs-type">Bool</span>    <span class="hljs-comment">// 1 byte</span>
    <span class="hljs-keyword">let</span> c: <span class="hljs-type">Bool</span>    <span class="hljs-comment">// 1 byte + 6 padding</span>
}  <span class="hljs-comment">// 总共 16 bytes</span>
</code></pre>
<p>Swift 编译器<strong>不会</strong>自动重排 struct 成员（为了保持 ABI 兼容），需要手动优化。</p>
<hr/>
<h3 data-id="heading-109">3. 集合操作优化</h3>
<h4 data-id="heading-110">3.1 Lazy Collection</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 非 lazy：创建 3 个中间数组</span>
<span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> array.filter { <span class="hljs-variable">$0</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> }.map { <span class="hljs-variable">$0</span> <span class="hljs-operator">*</span> <span class="hljs-number">2</span> }.prefix(<span class="hljs-number">5</span>)

<span class="hljs-comment">// lazy：单次遍历，按需计算，无中间数组</span>
<span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> array.lazy.filter { <span class="hljs-variable">$0</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> }.map { <span class="hljs-variable">$0</span> <span class="hljs-operator">*</span> <span class="hljs-number">2</span> }.prefix(<span class="hljs-number">5</span>)
</code></pre>
<ul>
<li><code>lazy</code> 将操作转为<strong>惰性求值</strong></li>
<li>只遍历一次，遇到满足条件的前 5 个就停止</li>
<li>适合大数组 + 链式操作 + 只取部分结果</li>
</ul>
<h4 data-id="heading-111">3.2 Dictionary 性能</h4>
<ul>
<li><code>Dictionary</code> 使用开放寻址 + 线性探测哈希表</li>
<li>负载因子超过 75% 自动扩容（容量翻倍 + rehash）</li>
<li><code>Dictionary.reserveCapacity(_:)</code> 可预分配</li>
<li>自定义 Hashable 时注意 hash 分布均匀性</li>
<li><code>Dictionary(grouping:by:)</code> 比手动 for 循环分组更高效</li>
</ul>
<h4 data-id="heading-112">3.3 ContiguousArray vs Array</h4>
<ul>
<li><code>Array</code> 需要兼容 NSArray 桥接，有额外判断开销</li>
<li><code>ContiguousArray</code> 保证连续内存存储，不支持 NSArray 桥接</li>
<li>存储非 class、非 @objc 类型时两者等效</li>
<li>存储 class 类型且确定不需要 ObjC 桥接时，<code>ContiguousArray</code> 更快</li>
</ul>
<hr/>
<h3 data-id="heading-113">4. 字符串性能</h3>
<h4 data-id="heading-114">4.1 避免频繁拼接</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 差：每次 += 可能触发拷贝和堆分配</span>
<span class="hljs-keyword">var</span> s <span class="hljs-operator">=</span> <span class="hljs-string">""</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span><span class="hljs-number">1000</span> { s <span class="hljs-operator">+=</span> <span class="hljs-string">"<span class="hljs-subst">\(i)</span>"</span> }

<span class="hljs-comment">// 好：预分配</span>
<span class="hljs-keyword">var</span> s <span class="hljs-operator">=</span> <span class="hljs-string">""</span>
s.reserveCapacity(<span class="hljs-number">4000</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span><span class="hljs-number">1000</span> { s <span class="hljs-operator">+=</span> <span class="hljs-string">"<span class="hljs-subst">\(i)</span>"</span> }

<span class="hljs-comment">// 更好：用数组 join</span>
<span class="hljs-keyword">let</span> s <span class="hljs-operator">=</span> (<span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span><span class="hljs-number">1000</span>).map(<span class="hljs-type">String</span>.<span class="hljs-keyword">init</span>).joined()
</code></pre>
<h4 data-id="heading-115">4.2 子串 Substring</h4>
<ul>
<li><code>Substring</code> 与原 <code>String</code> 共享底层 buffer（COW）</li>
<li>长期持有 <code>Substring</code> 会阻止原 String buffer 释放</li>
<li>短期使用 <code>Substring</code>，长期存储时转为 <code>String(substring)</code></li>
</ul>
<hr/>
<h3 data-id="heading-116">5. 减少动态派发</h3>
<h4 data-id="heading-117">5.1 性能对比数据</h4>





























<table><thead><tr><th>派发方式</th><th>相对开销</th></tr></thead><tbody><tr><td>内联</td><td>0（最快）</td></tr><tr><td>静态派发</td><td>1x</td></tr><tr><td>vtable 派发</td><td>~1.1x - 1.5x（间接跳转 + 可能的 cache miss）</td></tr><tr><td>PWT 派发</td><td>~1.5x - 2x（多一次间接寻址）</td></tr><tr><td>objc_msgSend</td><td>~3x - 5x（查找 IMP 缓存）</td></tr></tbody></table>
<h4 data-id="heading-118">5.2 优化方法</h4>
<ol>
<li><strong>struct &gt; class</strong>（天然静态派发）</li>
<li><strong>final class / final method</strong>（静态派发）</li>
<li><strong>private / fileprivate method</strong>（隐式 final）</li>
<li><strong>泛型约束 <code>&lt;T: P&gt;</code> &gt; 存在类型 <code>any P</code></strong>（可特化为静态派发）</li>
<li><strong>WMO 开启</strong>（自动去虚拟化）</li>
</ol>
<hr/>
<h2 data-id="heading-119">第五部分：八股文中的横向对比</h2>
<hr/>
<h3 data-id="heading-120">1. 值类型 vs 引用类型（深度对比）</h3>


















































<table><thead><tr><th>对比维度</th><th>值类型</th><th>引用类型</th></tr></thead><tbody><tr><td>拷贝语义</td><td>深拷贝（COW 优化后延迟拷贝）</td><td>浅拷贝（共享引用）</td></tr><tr><td>身份判断</td><td>无法判断「同一个」（只有值相等）</td><td><code>===</code> 判断同一实例</td></tr><tr><td>多态</td><td>协议实现 + 泛型</td><td>继承 + 协议</td></tr><tr><td>线程安全</td><td>天然安全</td><td>需同步</td></tr><tr><td>析构</td><td>无 deinit</td><td>有 deinit</td></tr><tr><td>内存位置</td><td>栈/内联（优先）</td><td>堆</td></tr><tr><td>引用计数</td><td>无</td><td>有（ARC）</td></tr><tr><td>适用场景</td><td>数据模型、算法、并发安全</td><td>共享状态、标识语义、继承层级</td></tr></tbody></table>
<p><strong>选择原则：</strong> 默认用 struct，只在需要共享状态、继承、deinit、identity 时用 class。</p>
<hr/>
<h3 data-id="heading-121">2. struct vs class vs enum vs actor</h3>




































































<table><thead><tr><th>特性</th><th>struct</th><th>class</th><th>enum</th><th>actor</th></tr></thead><tbody><tr><td>类型</td><td>值</td><td>引用</td><td>值</td><td>引用</td></tr><tr><td>继承</td><td>不支持</td><td>支持</td><td>不支持</td><td>不支持</td></tr><tr><td>协议遵循</td><td>支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td>deinit</td><td>无</td><td>有</td><td>无</td><td>有</td></tr><tr><td>可变性</td><td>mutating</td><td>自由修改</td><td>mutating</td><td>隔离保护</td></tr><tr><td>线程安全</td><td>拷贝安全</td><td>需手动</td><td>拷贝安全</td><td>编译器保证</td></tr><tr><td>引用计数</td><td>无</td><td>有</td><td>无</td><td>有</td></tr><tr><td>内存</td><td>栈优先</td><td>堆</td><td>栈优先</td><td>堆</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-122">3. let vs var（底层差异）</h3>






























<table><thead><tr><th>维度</th><th><code>let</code></th><th><code>var</code></th></tr></thead><tbody><tr><td>可变性</td><td>不可变</td><td>可变</td></tr><tr><td>编译器优化</td><td>更多（常量折叠、省略 retain/release）</td><td>较少</td></tr><tr><td>线程安全</td><td>安全（不可变）</td><td>不安全</td></tr><tr><td>引用类型</td><td>引用不可变（属性仍可变）</td><td>引用可变</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-123">4. map vs flatMap vs compactMap</h3>

























<table><thead><tr><th>方法</th><th>签名</th><th>作用</th></tr></thead><tbody><tr><td><code>map</code></td><td><code>(T) -&gt; U</code></td><td>1:1 转换</td></tr><tr><td><code>flatMap</code></td><td><code>(T) -&gt; [U]</code></td><td>1:N 转换后展平</td></tr><tr><td><code>compactMap</code></td><td><code>(T) -&gt; U?</code></td><td>1:1 转换，自动过滤 nil</td></tr></tbody></table>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> a <span class="hljs-operator">=</span> [[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>],[<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]]
a.map { <span class="hljs-variable">$0</span> }        <span class="hljs-comment">// [[1,2],[3,4]]</span>
a.flatMap { <span class="hljs-variable">$0</span> }    <span class="hljs-comment">// [1,2,3,4]</span>

<span class="hljs-keyword">let</span> b <span class="hljs-operator">=</span> [<span class="hljs-string">"1"</span>,<span class="hljs-string">"a"</span>,<span class="hljs-string">"3"</span>]
b.compactMap { <span class="hljs-type">Int</span>(<span class="hljs-variable">$0</span>) }  <span class="hljs-comment">// [1, 3]</span>
</code></pre>
<p>Optional 上的 flatMap：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> x: <span class="hljs-type">Int</span>? <span class="hljs-operator">=</span> <span class="hljs-number">5</span>
x.flatMap { <span class="hljs-variable">$0</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">3</span> <span class="hljs-operator">?</span> <span class="hljs-variable">$0</span> : <span class="hljs-literal">nil</span> }  <span class="hljs-comment">// Optional(5)</span>
x.map { <span class="hljs-variable">$0</span> <span class="hljs-operator">&gt;</span> <span class="hljs-number">3</span> <span class="hljs-operator">?</span> <span class="hljs-variable">$0</span> : <span class="hljs-literal">nil</span> }      <span class="hljs-comment">// Optional(Optional(5)) → Int??</span>
</code></pre>
<hr/>
<h3 data-id="heading-124">5. GCD vs Operation vs Swift Concurrency</h3>





















































<table><thead><tr><th>维度</th><th>GCD</th><th>Operation</th><th>Swift Concurrency</th></tr></thead><tbody><tr><td>抽象层级</td><td>低（C API）</td><td>中（ObjC 对象）</td><td>高（语言级别）</td></tr><tr><td>取消</td><td>手动检查</td><td><code>isCancelled</code> 属性</td><td>结构化自动传播</td></tr><tr><td>依赖管理</td><td>手动 dispatch_group/barrier</td><td><code>addDependency</code></td><td><code>async let</code> / TaskGroup</td></tr><tr><td>线程控制</td><td>QoS + target queue</td><td><code>maxConcurrentOperationCount</code></td><td>协作式线程池</td></tr><tr><td>线程爆炸</td><td>容易</td><td>容易</td><td>不会（线程数 ≤ 核心数）</td></tr><tr><td>错误处理</td><td>无内建</td><td>无内建</td><td>throws + try await</td></tr><tr><td>安全保证</td><td>无</td><td>无</td><td>Actor + Sendable</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-125">6. weak vs unowned vs unowned(unsafe)</h3>









































<table><thead><tr><th>维度</th><th>weak</th><th>unowned</th><th>unowned(unsafe)</th></tr></thead><tbody><tr><td>类型</td><td>Optional</td><td>非 Optional</td><td>非 Optional</td></tr><tr><td>对象释放后</td><td>自动 nil</td><td>trap 崩溃</td><td>野指针（UB）</td></tr><tr><td>性能开销</td><td>Side table + 原子操作</td><td>较少</td><td>零额外开销</td></tr><tr><td>安全性</td><td>最安全</td><td>安全（确定性崩溃）</td><td>最危险</td></tr><tr><td>适用场景</td><td>delegate、不确定生命周期</td><td>确定不会先于 self 释放</td><td>极致性能，生命周期绝对保证</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-126">7. Any vs AnyObject vs any Protocol vs some Protocol</h3>






























<table><thead><tr><th>类型</th><th>含义</th><th>底层</th></tr></thead><tbody><tr><td><code>Any</code></td><td>任意类型（值/引用）</td><td>existential container (32 bytes)</td></tr><tr><td><code>AnyObject</code></td><td>任意引用类型</td><td>单指针 (8 bytes)</td></tr><tr><td><code>any Protocol</code></td><td>任意遵循 P 的类型</td><td>existential container</td></tr><tr><td><code>some Protocol</code></td><td>某个特定的遵循 P 的类型（编译期确定）</td><td>无 container，直接值</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-127">8. 访问控制对比</h3>



































<table><thead><tr><th>级别</th><th>可见范围</th><th>编译器优化影响</th></tr></thead><tbody><tr><td><code>open</code></td><td>任何模块可继承和 override</td><td>不能优化派发</td></tr><tr><td><code>public</code></td><td>任何模块可访问，不可继承 override</td><td>不能优化派发（外部可能做协议遵循等）</td></tr><tr><td><code>internal</code></td><td>同一模块（默认）</td><td>WMO 下可推断 final</td></tr><tr><td><code>fileprivate</code></td><td>同一文件</td><td>可推断 final</td></tr><tr><td><code>private</code></td><td>同一声明作用域</td><td>隐式 final，静态派发</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-128">9. 闭包 vs 函数 vs 方法</h3>





























<table><thead><tr><th>维度</th><th>全局函数</th><th>实例方法</th><th>闭包</th></tr></thead><tbody><tr><td>类型</td><td><code>(Args) -&gt; Return</code></td><td><code>(Self) -&gt; (Args) -&gt; Return</code>（柯里化）</td><td><code>(Args) -&gt; Return</code></td></tr><tr><td>捕获</td><td>无</td><td>隐式捕获 self</td><td>显式/隐式捕获环境</td></tr><tr><td>堆分配</td><td>无</td><td>无（作为闭包传递时有）</td><td>有（逃逸时）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-129">10. throws vs Result vs Optional</h3>





























<table><thead><tr><th>方式</th><th>适用场景</th><th>性能</th><th>链式处理</th></tr></thead><tbody><tr><td><code>throws</code></td><td>同步错误处理</td><td>正常路径零开销（Swift 使用 error return）</td><td>do-catch</td></tr><tr><td><code>Result&lt;T, E&gt;</code></td><td>异步回调 / 存储结果</td><td>enum 开销（极小）</td><td>map/flatMap</td></tr><tr><td><code>Optional&lt;T&gt;</code></td><td>值可能不存在</td><td>最小</td><td>map/flatMap/??</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-130">第六部分：高难度深底层原理</h2>
<hr/>
<h3 data-id="heading-131">1. Swift Runtime 与 Metadata 系统</h3>
<h4 data-id="heading-132">1.1 类型元数据 (Type Metadata)</h4>
<p>每个 Swift 类型在运行时都有一个<strong>元数据 (Metadata)</strong> 记录：</p>
<pre><code class="hljs language-arduino" lang="arduino">Struct Metadata:
┌─────────────────────────┐
│ <span class="hljs-built_in">Kind</span> (标识类型种类)        │  ← <span class="hljs-keyword">struct</span>/<span class="hljs-keyword">class</span>/<span class="hljs-keyword">enum</span>/optional/tuple...
│ Type Descriptor          │  → 指向类型描述符（名称、字段、泛型参数等）
│ Value Witness Table Ptr  │  → VWT（size/alignment/copy/destroy 等操作）
└─────────────────────────┘

<span class="hljs-function">Class <span class="hljs-title">Metadata</span> <span class="hljs-params">(ISA)</span>:
┌─────────────────────────┐
│ Kind                     │
│ SuperClass Pointer       │  → 父类元数据
│ Cache / Data (ObjC兼容)   │
│ Flags                    │
│ Instance Size            │
│ Instance Alignment       │
│ Type Descriptor          │
│ V-Table entries...       │  → 虚函数表
└─────────────────────────┘
</span></code></pre>
<h4 data-id="heading-133">1.2 泛型 Metadata 的懒创建</h4>
<ul>
<li>泛型类型如 <code>Array&lt;Int&gt;</code> 的 metadata 是<strong>运行时按需创建</strong>的</li>
<li>首次使用 <code>Array&lt;Int&gt;</code> 时，runtime 用模板 + <code>Int.self</code> 的 metadata 组合生成</li>
<li>生成后缓存在全局表中（线程安全的 concurrent hash map）</li>
<li>这就是为什么泛型类型的首次使用可能比后续使用略慢</li>
</ul>
<h4 data-id="heading-134">1.3 Mirror 反射的底层</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> mirror <span class="hljs-operator">=</span> <span class="hljs-type">Mirror</span>(reflecting: someInstance)
<span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> mirror.children { <span class="hljs-operator">...</span> }
</code></pre>
<ul>
<li>Mirror 通过 <strong>Type Descriptor</strong> 中的字段描述信息获取属性名和偏移量</li>
<li>通过 <strong>Value Witness Table</strong> 中的操作函数读取字段值</li>
<li>属于「有限反射」—— 只能读取，不能修改（不像 Java/ObjC 的完全运行时反射）</li>
<li>Release 模式下如果类型信息被 strip，反射能力会受限</li>
</ul>
<hr/>
<h3 data-id="heading-135">2. SIL (Swift Intermediate Language)</h3>
<h4 data-id="heading-136">2.1 编译流程</h4>
<pre><code class="hljs language-scss" lang="scss">Swift Source → AST → SIL (raw) → SIL (canonical) → SIL (optimized) → LLVM IR → Machine <span class="hljs-selector-tag">Code</span>
                ↑         ↑              ↑                 ↑
            解析/类型检查  SILGen     强制诊断/优化      LLVM 优化
</code></pre>
<h4 data-id="heading-137">2.2 SIL 的作用</h4>
<ul>
<li><strong>类型检查之后、LLVM 之前</strong>的中间表示</li>
<li>比 LLVM IR 更高级，保留了 Swift 的类型信息</li>
<li>用于：
<ul>
<li><strong>ARC 优化</strong>：合并/消除冗余的 retain/release</li>
<li><strong>泛型特化</strong>：生成具体类型的特化版本</li>
<li><strong>去虚拟化</strong>：将 vtable 调用转为直接调用</li>
<li><strong>内联</strong>：将小函数体直接插入调用点</li>
<li><strong>诊断</strong>：检测未初始化变量、排他性访问违规等</li>
</ul>
</li>
</ul>
<h4 data-id="heading-138">2.3 查看 SIL</h4>
<pre><code class="hljs language-bash" lang="bash">swiftc -emit-sil file.swift  <span class="hljs-comment"># 优化前的 SIL</span>
swiftc -emit-sil -O file.swift  <span class="hljs-comment"># 优化后的 SIL</span>
</code></pre>
<p>SIL 中可以直接看到 retain/release 的插入位置、dispatch 方式、内联决策等。</p>
<hr/>
<h3 data-id="heading-139">3. 排他性访问 (Exclusivity Enforcement)</h3>
<h4 data-id="heading-140">3.1 原则</h4>
<p>Swift 保证<strong>同一时刻不能同时存在对同一变量的读访问和写访问</strong>（Law of Exclusivity）。</p>
<h4 data-id="heading-141">3.2 静态检查</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> x <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
<span class="hljs-built_in">swap</span>(<span class="hljs-operator">&amp;</span>x, <span class="hljs-operator">&amp;</span>x)  <span class="hljs-comment">// 编译错误！同时对 x 进行两个写访问</span>
</code></pre>
<h4 data-id="heading-142">3.3 动态检查</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> array <span class="hljs-operator">=</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
<span class="hljs-comment">// 运行时可能崩溃：对 array 同时读 (subscript) 和写 (modifyElement)</span>
<span class="hljs-keyword">extension</span> <span class="hljs-title class_">Array</span> {
    <span class="hljs-keyword">mutating</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">modifyFirst</span>(<span class="hljs-params">using</span>: (<span class="hljs-keyword">inout</span> <span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">Void</span>) {
        using(<span class="hljs-operator">&amp;</span><span class="hljs-keyword">self</span>[<span class="hljs-number">0</span>])  <span class="hljs-comment">// self 正在被修改，又通过 subscript 修改</span>
    }
}
</code></pre>
<h4 data-id="heading-143">3.4 底层实现</h4>
<ul>
<li>编译器在变量的访问开始/结束时插入 <code>begin_access</code> / <code>end_access</code> 标记</li>
<li>栈上变量：编译器静态证明（大部分情况）</li>
<li>堆上变量/全局变量：运行时维护<strong>访问记录栈</strong>，检测冲突</li>
<li>Debug 模式检查更严格，Release 中部分检查被优化掉</li>
</ul>
<hr/>
<h3 data-id="heading-144">4. 内存安全与 Unsafe API</h3>
<h4 data-id="heading-145">4.1 Swift 的安全保证</h4>
<ul>
<li>变量使用前必须初始化</li>
<li>数组下标自动检查越界</li>
<li>整数溢出自动检测（Debug 模式）</li>
<li>Optional 强制解包检查</li>
<li>排他性访问检查</li>
</ul>
<h4 data-id="heading-146">4.2 Unsafe 指针体系</h4>


















































<table><thead><tr><th>类型</th><th>含义</th><th>等价 C 类型</th></tr></thead><tbody><tr><td><code>UnsafePointer&lt;T&gt;</code></td><td>只读指针</td><td><code>const T*</code></td></tr><tr><td><code>UnsafeMutablePointer&lt;T&gt;</code></td><td>可变指针</td><td><code>T*</code></td></tr><tr><td><code>UnsafeRawPointer</code></td><td>无类型只读指针</td><td><code>const void*</code></td></tr><tr><td><code>UnsafeMutableRawPointer</code></td><td>无类型可变指针</td><td><code>void*</code></td></tr><tr><td><code>UnsafeBufferPointer&lt;T&gt;</code></td><td>只读指针 + 长度</td><td><code>const T*</code> + <code>size_t</code></td></tr><tr><td><code>UnsafeMutableBufferPointer&lt;T&gt;</code></td><td>可变指针 + 长度</td><td><code>T*</code> + <code>size_t</code></td></tr><tr><td><code>OpaquePointer</code></td><td>不透明指针</td><td>C 的 opaque struct pointer</td></tr><tr><td><code>Unmanaged&lt;T&gt;</code></td><td>手动管理引用计数的引用</td><td><code>CFTypeRef</code></td></tr></tbody></table>
<h4 data-id="heading-147">4.3 使用场景</h4>
<ul>
<li>C 库交互（Core Audio, Metal, 网络底层等）</li>
<li>高性能数据处理（避免 ARC / 边界检查开销）</li>
<li>内存映射文件操作</li>
</ul>
<h4 data-id="heading-148">4.4 常见陷阱</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 危险：指针悬垂</span>
<span class="hljs-keyword">var</span> ptr: <span class="hljs-type">UnsafeMutablePointer</span>&lt;<span class="hljs-type">Int</span>&gt;?
<span class="hljs-keyword">do</span> {
    <span class="hljs-keyword">var</span> x <span class="hljs-operator">=</span> <span class="hljs-number">42</span>
    ptr <span class="hljs-operator">=</span> <span class="hljs-type">UnsafeMutablePointer</span>(<span class="hljs-operator">&amp;</span>x)
}
ptr<span class="hljs-operator">?</span>.pointee  <span class="hljs-comment">// 未定义行为！x 已超出作用域</span>

<span class="hljs-comment">// 正确：使用 withUnsafe 系列方法</span>
<span class="hljs-built_in">withUnsafePointer</span>(to: <span class="hljs-operator">&amp;</span>x) { ptr <span class="hljs-keyword">in</span>
    <span class="hljs-comment">// ptr 仅在此闭包内有效</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-149">5. ABI 稳定性 (Swift 5+)</h3>
<h4 data-id="heading-150">5.1 什么是 ABI 稳定</h4>
<ul>
<li><strong>ABI (Application Binary Interface)</strong>：二进制层面的接口约定</li>
<li>包括：函数调用约定、类型内存布局、name mangling、元数据格式、runtime 接口</li>
<li>Swift 5 之后 ABI 稳定 → Swift runtime 嵌入 OS → App 不再需要内嵌 Swift runtime → 包体积减小</li>
</ul>
<h4 data-id="heading-151">5.2 Library Evolution</h4>
<ul>
<li><code>@frozen</code>：向编译器承诺 struct/enum 的布局不会变化
<ul>
<li>编译器可以直接根据偏移量访问成员（更快）</li>
<li>不加 <code>@frozen</code> 时，编译器通过间接方式访问（支持未来布局变化）</li>
</ul>
</li>
<li><code>@inlinable</code>：向编译器暴露函数体，允许跨模块内联</li>
<li>这些是标准库和系统框架使用的属性</li>
</ul>
<h4 data-id="heading-152">5.3 Module Stability</h4>
<ul>
<li>Swift 5.1+ 模块稳定：<code>.swiftinterface</code> 文件替代 <code>.swiftmodule</code></li>
<li>不同编译器版本编译的模块可以互相兼容</li>
</ul>
<hr/>
<h3 data-id="heading-153">6. 类型转换的底层机制</h3>
<h4 data-id="heading-154">6.1 as / as? / as! 的区别</h4>





























<table><thead><tr><th>操作</th><th>检查时机</th><th>失败行为</th><th>底层</th></tr></thead><tbody><tr><td><code>as</code></td><td>编译期</td><td>编译错误</td><td>无运行时开销（类型已知）</td></tr><tr><td><code>as?</code></td><td>运行时</td><td>返回 nil</td><td>metadata 比较</td></tr><tr><td><code>as!</code></td><td>运行时</td><td>trap 崩溃</td><td>metadata 比较 + 强制</td></tr></tbody></table>
<h4 data-id="heading-155">6.2 is 检查的底层</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> <span class="hljs-type">MyClass</span> { <span class="hljs-operator">...</span> }
</code></pre>
<ul>
<li>值类型：编译期确定（静态检查）</li>
<li>引用类型：运行时检查 isa 指针链（遍历继承链）</li>
<li>协议类型：检查 type metadata 中的 protocol conformance 表</li>
</ul>
<h4 data-id="heading-156">6.3 Protocol Conformance 查找</h4>
<ul>
<li>Swift runtime 维护一个全局的 <strong>Protocol Conformance Table</strong></li>
<li>表项格式：<code>(TypeDescriptor, ProtocolDescriptor) → WitnessTable</code></li>
<li><code>as? SomeProtocol</code> 时，runtime 在表中查找当前类型是否遵循该协议</li>
<li>查找结果会被缓存</li>
</ul>
<hr/>
<h3 data-id="heading-157">7. Swift 与 Objective-C 互操作底层</h3>
<h4 data-id="heading-158">7.1 桥接机制</h4>



































<table><thead><tr><th>Swift 类型</th><th>ObjC 类型</th><th>桥接方式</th></tr></thead><tbody><tr><td>String</td><td>NSString</td><td>按需转换（UTF-8 ↔ UTF-16）</td></tr><tr><td>Array</td><td>NSArray</td><td>包装/拆包</td></tr><tr><td>Dictionary</td><td>NSDictionary</td><td>包装/拆包</td></tr><tr><td>Int/Double</td><td>NSNumber</td><td>装箱/拆箱</td></tr><tr><td>struct</td><td>不可桥接</td><td>需要手动封装为 class</td></tr></tbody></table>
<h4 data-id="heading-159">7.2 @objc 的代价</h4>
<ul>
<li>标记为 <code>@objc</code> 的方法会生成 ObjC 兼容的调用入口</li>
<li>Swift class 继承 NSObject 时，会注册到 ObjC runtime</li>
<li>ObjC 方法调用走 <code>objc_msgSend</code>，比 Swift vtable 慢 3-5 倍</li>
<li>每个 <code>@objc</code> 方法增加约 100 字节的二进制体积</li>
</ul>
<h4 data-id="heading-160">7.3 Dynamic Member Lookup</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">@dynamicMemberLookup</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">JSON</span> {
    <span class="hljs-keyword">subscript</span>(<span class="hljs-params">dynamicMember</span> <span class="hljs-params">member</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">JSON</span> { <span class="hljs-operator">...</span> }
}
<span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> json.user.name  <span class="hljs-comment">// 编译器转换为 subscript 调用</span>
</code></pre>
<ul>
<li>编译期将 <code>.member</code> 语法转为 subscript 调用</li>
<li>不涉及 ObjC runtime，纯 Swift 实现</li>
<li>用于 DSL、动态语言桥接等</li>
</ul>
<hr/>
<h3 data-id="heading-161">8. Move Semantics 与 Ownership（Swift 5.9+）</h3>
<h4 data-id="heading-162">8.1 consuming / borrowing 参数</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">process</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: consuming <span class="hljs-type">MyStruct</span>) {
    <span class="hljs-comment">// value 的所有权被转移到此函数，调用方不能再使用</span>
}
<span class="hljs-keyword">func</span> <span class="hljs-title function_">inspect</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: borrowing <span class="hljs-type">MyStruct</span>) {
    <span class="hljs-comment">// 只读借用，不拷贝，不转移所有权</span>
}
</code></pre>
<h4 data-id="heading-163">8.2 ~Copyable（不可拷贝类型）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FileHandle</span>: ~<span class="hljs-title class_">Copyable</span> {
    <span class="hljs-keyword">let</span> fd: <span class="hljs-type">Int32</span>
    <span class="hljs-keyword">deinit</span> { close(fd) }  <span class="hljs-comment">// struct 有了 deinit！</span>
}
</code></pre>
<ul>
<li>不可拷贝类型保证<strong>唯一所有权</strong></li>
<li>赋值 = 移动（原变量失效）</li>
<li>可以为 struct 添加 <code>deinit</code>（资源清理）</li>
<li>类似 Rust 的 ownership 模型</li>
<li>消除不必要的引用计数开销</li>
</ul>
<h4 data-id="heading-164">8.3 意义</h4>
<ul>
<li>零成本抽象的资源管理（RAII）</li>
<li>编译器保证资源不会被重复释放或遗忘释放</li>
<li>为 Swift 引入更精细的内存控制能力</li>
</ul>
<hr/>
<h3 data-id="heading-165">9. Result Type 与 Error Handling 底层</h3>
<h4 data-id="heading-166">9.1 throws 的底层实现</h4>
<p>Swift 的 <code>throws</code> 不使用异常表（不同于 C++/Java）：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 函数签名实际上是：</span>
func <span class="hljs-built_in">foo</span>() throws -&gt; Int
<span class="hljs-comment">// 底层等价于：</span>
func <span class="hljs-built_in">foo</span>() -&gt; (Int, Error?)
</code></pre>
<ul>
<li>通过<strong>隐藏的返回值寄存器</strong>传递 Error</li>
<li>正常路径零开销（no error → 直接返回结果）</li>
<li>错误路径有 Error 对象创建的开销</li>
<li>这就是为什么 <code>try</code> 的正常路径性能很好</li>
</ul>
<h4 data-id="heading-167">9.2 typed throws (Swift 5.9+)</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">parse</span>() <span class="hljs-keyword">throws</span>(<span class="hljs-type">ParseError</span>) -&gt; <span class="hljs-type">AST</span> { <span class="hljs-operator">...</span> }
</code></pre>
<ul>
<li>限定了错误类型，避免 existential Error 的开销</li>
<li>调用方可以直接 catch 具体类型，无需 <code>as?</code> 转换</li>
</ul>
<hr/>
<h3 data-id="heading-168">10. @dynamicCallable 与语言扩展能力</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">@dynamicCallable</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">PythonObject</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">dynamicallyCall</span>(<span class="hljs-params">withArguments</span> <span class="hljs-params">args</span>: [<span class="hljs-keyword">Any</span>]) -&gt; <span class="hljs-type">PythonObject</span> { <span class="hljs-operator">...</span> }
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">dynamicallyCall</span>(<span class="hljs-params">withKeywordArguments</span> <span class="hljs-params">args</span>: <span class="hljs-type">KeyValuePairs</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-keyword">Any</span>&gt;) -&gt; <span class="hljs-type">PythonObject</span> { <span class="hljs-operator">...</span> }
}
<span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> pythonObj(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, name: <span class="hljs-string">"test"</span>)  <span class="hljs-comment">// 编译器转为 dynamicallyCall</span>
</code></pre>
<ul>
<li>编译器将函数调用语法重写为 <code>dynamicallyCall</code> 方法调用</li>
<li>用于与 Python/Ruby 等动态语言桥接</li>
<li>TensorFlow for Swift 等项目大量使用</li>
</ul>
<hr/>
<h3 data-id="heading-169">11. Opaque Return Type 与 Reverse Generics</h3>
<h4 data-id="heading-170">11.1 some 的底层</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">makeShape</span>() -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">Shape</span> {
    <span class="hljs-type">Circle</span>()
}
</code></pre>
<ul>
<li>编译器知道返回类型是 <code>Circle</code>，但对调用方隐藏</li>
<li><strong>不使用 existential container</strong>，直接返回 Circle 的值</li>
<li>零额外开销（等同于直接返回 Circle）</li>
<li>但保持了 API 的抽象性（future-proof）</li>
</ul>
<h4 data-id="heading-171">11.2 与 existential 的根本差异</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// some：编译期确定类型，运行时无开销</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">a</span>() -&gt; <span class="hljs-keyword">some</span> <span class="hljs-type">Collection</span> { [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>] }
<span class="hljs-comment">// a() 和 a() 保证是同一类型（Int Array）</span>

<span class="hljs-comment">// any：运行时动态类型，有 container 开销</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">b</span>() -&gt; <span class="hljs-keyword">any</span> <span class="hljs-type">Collection</span> { <span class="hljs-type">Bool</span>.random() <span class="hljs-operator">?</span> [<span class="hljs-number">1</span>] : <span class="hljs-type">Set</span>([<span class="hljs-number">1</span>]) }
<span class="hljs-comment">// b() 每次可能不同类型</span>
</code></pre>
<hr/>
<h3 data-id="heading-172">12. Memory Layout 工具</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">MemoryLayout</span>&lt;<span class="hljs-type">Int</span>&gt;.size        <span class="hljs-comment">// 8（实际占用字节）</span>
<span class="hljs-type">MemoryLayout</span>&lt;<span class="hljs-type">Int</span>&gt;.stride      <span class="hljs-comment">// 8（数组中相邻元素的间距）</span>
<span class="hljs-type">MemoryLayout</span>&lt;<span class="hljs-type">Int</span>&gt;.alignment   <span class="hljs-comment">// 8（对齐要求）</span>

<span class="hljs-type">MemoryLayout</span>&lt;<span class="hljs-type">Bool</span>&gt;.size       <span class="hljs-comment">// 1</span>
<span class="hljs-type">MemoryLayout</span>&lt;<span class="hljs-type">Bool</span>&gt;.stride     <span class="hljs-comment">// 1</span>
<span class="hljs-type">MemoryLayout</span>&lt;<span class="hljs-type">Bool</span>&gt;.alignment  <span class="hljs-comment">// 1</span>

<span class="hljs-type">MemoryLayout</span>&lt;<span class="hljs-type">Optional</span>&lt;<span class="hljs-type">Int</span>&gt;&gt;.size    <span class="hljs-comment">// 9（8 + 1 tag）</span>
<span class="hljs-type">MemoryLayout</span>&lt;<span class="hljs-type">Optional</span>&lt;<span class="hljs-type">Int</span>&gt;&gt;.stride  <span class="hljs-comment">// 16（对齐到 8 的倍数）</span>

<span class="hljs-type">MemoryLayout</span>&lt;<span class="hljs-type">String</span>&gt;.size     <span class="hljs-comment">// 16（SSO 结构）</span>
<span class="hljs-type">MemoryLayout</span>&lt;<span class="hljs-type">String</span>&gt;.stride   <span class="hljs-comment">// 16</span>
</code></pre>
<p>这些在需要与 C 交互、手动管理内存、优化内存布局时非常关键。</p>
<hr/>
<h2 data-id="heading-173">附录：高频面试题速查</h2>














































































































<table><thead><tr><th>#</th><th>问题</th><th>核心关键词</th></tr></thead><tbody><tr><td>1</td><td>struct 和 class 的区别？</td><td>值/引用、栈/堆、COW、ARC、继承</td></tr><tr><td>2</td><td>Swift 的方法派发有几种？</td><td>静态、vtable、PWT、objc_msgSend</td></tr><tr><td>3</td><td>ARC 和 GC 的区别？</td><td>编译期插入 vs 运行时扫描、确定性 vs 非确定性、无停顿 vs STW</td></tr><tr><td>4</td><td>weak 和 unowned 的区别？</td><td>Optional/非Optional、side table、释放后行为</td></tr><tr><td>5</td><td>什么是 Existential Container？</td><td>5 words、value buffer、metadata、PWT</td></tr><tr><td>6</td><td>什么是 COW？</td><td>isKnownUniquelyReferenced、延迟拷贝</td></tr><tr><td>7</td><td>泛型约束和存在类型的区别？</td><td>静态/动态派发、特化、性能差异</td></tr><tr><td>8</td><td>闭包是值类型还是引用类型？</td><td>引用类型、函数指针+context、堆分配</td></tr><tr><td>9</td><td>Swift 的 String 为什么不能用 Int 下标？</td><td>变长 UTF-8、扩展字形簇、O(n) 遍历</td></tr><tr><td>10</td><td>Optional 底层是什么？</td><td>枚举 .none/.some、spare bit 优化</td></tr><tr><td>11</td><td>some 和 any 的区别？</td><td>opaque type vs existential、静态/动态、性能</td></tr><tr><td>12</td><td>Actor 怎么保证线程安全？</td><td>串行执行器、isolation、await</td></tr><tr><td>13</td><td>async/await 底层原理？</td><td>协程、状态机、continuation、不阻塞线程</td></tr><tr><td>14</td><td>throws 的性能开销？</td><td>正常路径零开销、隐藏返回寄存器</td></tr><tr><td>15</td><td>@frozen 和 @inlinable 的作用？</td><td>ABI 稳定、跨模块优化、库演进</td></tr><tr><td>16</td><td>什么是 WMO？</td><td>全模块优化、去虚拟化、跨文件内联</td></tr><tr><td>17</td><td>~Copyable 是什么？</td><td>不可拷贝类型、唯一所有权、move semantics</td></tr><tr><td>18</td><td>协议扩展方法为什么不能多态？</td><td>PWT 无条目、静态派发</td></tr><tr><td>19</td><td>class extension 的方法能 override 吗？</td><td>不能、不在 vtable 中、静态派发</td></tr><tr><td>20</td><td>排他性访问是什么？</td><td>Law of Exclusivity、begin/end_access、读写冲突检测</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenClaw 使用 DeepSeek 官方 API_KEY 配置教程]]></title>    <link>https://juejin.cn/post/7605419006682791978</link>    <guid>https://juejin.cn/post/7605419006682791978</guid>    <pubDate>2026-02-12T03:37:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605419006682791978" data-draft-id="7605419006682775594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenClaw 使用 DeepSeek 官方 API_KEY 配置教程"/> <meta itemprop="keywords" content="DeepSeek"/> <meta itemprop="datePublished" content="2026-02-12T03:37:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Calm华生"/> <meta itemprop="url" content="https://juejin.cn/user/3646451384066174"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenClaw 使用 DeepSeek 官方 API_KEY 配置教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3646451384066174/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Calm华生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T03:37:38.000Z" title="Thu Feb 12 2026 03:37:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<h3 data-id="heading-1">前言</h3>
<p>找遍全网也没找到如何在openclaw配置deepseek官方apikey，那我自己整一个，以下内容为Claude Code根据我的聊天记录总结生成，希望对想在openclaw使用deepseek官方apikey的人提供帮助。</p>
<h3 data-id="heading-2">目录</h3>
<ol>
<li><a href="#%E7%B3%BB%E7%BB%9F%E8%A6%81%E6%B1%82" title="#%E7%B3%BB%E7%BB%9F%E8%A6%81%E6%B1%82">系统要求</a></li>
<li><a href="#%E5%AE%89%E8%A3%85-openclaw" title="#%E5%AE%89%E8%A3%85-openclaw">安装 OpenClaw</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE" title="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%85%8D%E7%BD%AE">初始化配置</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE-deepseek-%E5%AE%98%E6%96%B9-api" title="#%E9%85%8D%E7%BD%AE-deepseek-%E5%AE%98%E6%96%B9-api">配置 DeepSeek 官方 API</a></li>
<li><a href="#%E6%B5%8B%E8%AF%95%E4%B8%8E%E4%BD%BF%E7%94%A8" title="#%E6%B5%8B%E8%AF%95%E4%B8%8E%E4%BD%BF%E7%94%A8">测试与使用</a></li>
<li><a href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4" title="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">常用命令</a></li>
<li><a href="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4" title="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">故障排除</a></li>
</ol>
<hr/>
<h3 data-id="heading-3">系统要求</h3>
<ul>
<li><strong>操作系统</strong>: macOS / Linux / Windows (WSL)</li>
<li><strong>Node.js</strong>: 版本 22+ (推荐使用 nvm 管理)</li>
<li><strong>网络</strong>: 需要访问 DeepSeek API (api.deepseek.com)</li>
</ul>
<hr/>
<h3 data-id="heading-4">安装 OpenClaw</h3>
<h4 data-id="heading-5">1. 全局安装 OpenClaw</h4>
<pre><code class="hljs language-bash" lang="bash">npm install -g openclaw@latest
</code></pre>
<p>安装过程可能需要 3-5 分钟，会下载约 674 个依赖包。</p>
<h4 data-id="heading-6">2. 验证安装</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw --version
</code></pre>
<p>应该显示类似：<code>🦞 OpenClaw 2026.2.9</code></p>
<hr/>
<h3 data-id="heading-7">初始化配置</h3>
<h4 data-id="heading-8">1. 运行配置向导</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw onboard --install-daemon --non-interactive --accept-risk
</code></pre>
<p><strong>说明</strong>:</p>
<ul>
<li><code>--install-daemon</code>: 安装后台服务</li>
<li><code>--non-interactive</code>: 非交互模式</li>
<li><code>--accept-risk</code>: 接受安全风险声明</li>
</ul>
<h4 data-id="heading-9">2. 检查服务状态</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw status
</code></pre>
<p>确认 Gateway 服务正在运行。</p>
<hr/>
<h3 data-id="heading-10">配置 DeepSeek 官方 API</h3>
<h4 data-id="heading-11">1. 获取 DeepSeek API Key</h4>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2F" target="_blank" title="https://platform.deepseek.com/" ref="nofollow noopener noreferrer">DeepSeek 官网</a> 注册并获取 API Key。</p>
<p>API Key 格式类似：<code>sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</code></p>
<h4 data-id="heading-12">2. 配置 DeepSeek 提供商</h4>
<p>执行以下命令（将 <code>你的API_KEY</code> 替换为实际的 API Key）：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> models.providers.deepseek <span class="hljs-string">'{
  "baseUrl": "https://api.deepseek.com/v1",
  "apiKey": "你的API_KEY",
  "api": "openai-completions",
  "models": [
    {
      "id": "deepseek-chat",
      "name": "DeepSeek Chat (V3)"
    },
    {
      "id": "deepseek-reasoner",
      "name": "DeepSeek Reasoner (R1)"
    }
  ]
}'</span>
</code></pre>
<h4 data-id="heading-13">3. 设置默认模型</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> agents.defaults.model.primary <span class="hljs-string">"deepseek/deepseek-chat"</span>
</code></pre>
<h4 data-id="heading-14">4. 创建模型别名（可选）</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw models aliases add deepseek-v3 <span class="hljs-string">"deepseek/deepseek-chat"</span>
openclaw models aliases add deepseek-r1 <span class="hljs-string">"deepseek/deepseek-reasoner"</span>
</code></pre>
<h4 data-id="heading-15">5. 重启 Gateway 服务</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway restart
</code></pre>
<p>等待 3-5 秒让服务完全启动。</p>
<hr/>
<h3 data-id="heading-16">测试与使用</h3>
<h4 data-id="heading-17">1. 命令行测试</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw agent --session-id <span class="hljs-built_in">test</span> --message <span class="hljs-string">"你好，请介绍一下你自己"</span>
</code></pre>
<p>如果配置成功，DeepSeek 会用中文回复。</p>
<h4 data-id="heading-18">2. 打开 Web 控制面板</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw dashboard
</code></pre>
<p>浏览器会自动打开控制面板，URL 格式：</p>
<pre><code class="hljs language-perl" lang="perl">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">18789</span>/<span class="hljs-comment">#token=你的gateway_token</span>
</code></pre>
<h4 data-id="heading-19">3. 查看配置状态</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw models status
</code></pre>
<p>应该显示：</p>
<ul>
<li>Default: <code>deepseek/deepseek-chat</code></li>
<li>Configured models: 包含 deepseek 模型</li>
</ul>
<hr/>
<h3 data-id="heading-20">常用命令</h3>
<h4 data-id="heading-21">服务管理</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动 Gateway</span>
openclaw gateway

<span class="hljs-comment"># 重启 Gateway</span>
openclaw gateway restart

<span class="hljs-comment"># 停止 Gateway</span>
openclaw gateway stop

<span class="hljs-comment"># 查看服务状态</span>
openclaw status

<span class="hljs-comment"># 查看详细状态</span>
openclaw status --all

<span class="hljs-comment"># 查看实时日志</span>
openclaw logs --follow
</code></pre>
<h4 data-id="heading-22">模型管理</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出所有可用模型</span>
openclaw models list --all

<span class="hljs-comment"># 查看当前模型配置</span>
openclaw models status

<span class="hljs-comment"># 切换模型（在聊天中使用）</span>
/model deepseek-v3

<span class="hljs-comment"># 设置默认模型</span>
openclaw config <span class="hljs-built_in">set</span> agents.defaults.model.primary <span class="hljs-string">"模型ID"</span>

<span class="hljs-comment"># 添加模型别名</span>
openclaw models aliases add 别名 <span class="hljs-string">"模型ID"</span>

<span class="hljs-comment"># 查看所有别名</span>
openclaw models aliases list
</code></pre>
<h4 data-id="heading-23">对话交互</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 发送单条消息</span>
openclaw agent --session-id 会话ID --message <span class="hljs-string">"你的问题"</span>

<span class="hljs-comment"># 指定超时时间（秒）</span>
openclaw agent --session-id <span class="hljs-built_in">test</span> --message <span class="hljs-string">"问题"</span> --<span class="hljs-built_in">timeout</span> 60

<span class="hljs-comment"># 使用本地模式（不通过 Gateway）</span>
openclaw agent --<span class="hljs-built_in">local</span> --session-id <span class="hljs-built_in">test</span> --message <span class="hljs-string">"问题"</span>
</code></pre>
<h4 data-id="heading-24">配置管理</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看配置</span>
openclaw config get 配置路径

<span class="hljs-comment"># 设置配置</span>
openclaw config <span class="hljs-built_in">set</span> 配置路径 <span class="hljs-string">"值"</span>

<span class="hljs-comment"># 删除配置</span>
openclaw config <span class="hljs-built_in">unset</span> 配置路径

<span class="hljs-comment"># 运行配置向导</span>
openclaw configure
</code></pre>
<hr/>
<h3 data-id="heading-25">故障排除</h3>
<h4 data-id="heading-26">问题 1: Gateway Token 错误</h4>
<p><strong>错误信息</strong>: <code>disconnected (1008): unauthorized: gateway token missing</code></p>
<p><strong>解决方法</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 打开带 token 的控制面板</span>
openclaw dashboard
</code></pre>
<p>或手动获取 token：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw config get gateway.auth.token
</code></pre>
<h4 data-id="heading-27">问题 2: 模型不可用</h4>
<p><strong>错误信息</strong>: <code>Unknown model: xxx</code></p>
<p><strong>解决方法</strong>:</p>
<ol>
<li>
<p>检查模型配置：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw models status
</code></pre>
</li>
<li>
<p>确认模型 ID 正确：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw models list --all | grep deepseek
</code></pre>
</li>
<li>
<p>重启 Gateway：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway restart
</code></pre>
</li>
</ol>
<h4 data-id="heading-28">问题 3: API Key 无效</h4>
<p><strong>错误信息</strong>: <code>HTTP 401</code> 或 <code>Unauthorized</code></p>
<p><strong>解决方法</strong>:</p>
<ol>
<li>验证 API Key 是否正确</li>
<li>检查 API Key 是否过期</li>
<li>重新配置提供商：
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> models.providers.deepseek.apiKey <span class="hljs-string">"新的API_KEY"</span>
openclaw gateway restart
</code></pre>
</li>
</ol>
<h4 data-id="heading-29">问题 4: 连接超时</h4>
<p><strong>错误信息</strong>: <code>Request timed out</code> 或 <code>No reply from agent</code></p>
<p><strong>解决方法</strong>:</p>
<ol>
<li>检查网络连接</li>
<li>测试 DeepSeek API 可达性：
<pre><code class="hljs language-bash" lang="bash">curl -I https://api.deepseek.com/v1/models
</code></pre>
</li>
<li>增加超时时间：
<pre><code class="hljs language-bash" lang="bash">openclaw agent --session-id <span class="hljs-built_in">test</span> --message <span class="hljs-string">"测试"</span> --<span class="hljs-built_in">timeout</span> 120
</code></pre>
</li>
</ol>
<h4 data-id="heading-30">问题 5: Gateway 无法启动</h4>
<p><strong>解决方法</strong>:</p>
<ol>
<li>
<p>检查端口占用：</p>
<pre><code class="hljs language-bash" lang="bash">lsof -i :18789
</code></pre>
</li>
<li>
<p>强制重启：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw gateway --force
</code></pre>
</li>
<li>
<p>查看日志：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw logs
</code></pre>
</li>
<li>
<p>运行诊断：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw doctor
openclaw doctor --fix
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-31">高级配置</h3>
<h4 data-id="heading-32">配置备用模型</h4>
<p>当主模型不可用时，自动切换到备用模型：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> agents.defaults.model.fallbacks <span class="hljs-string">'["deepseek/deepseek-reasoner"]'</span>
</code></pre>
<h4 data-id="heading-33">配置环境变量</h4>
<p>将以下内容添加到 <code>~/.zshrc</code> 或 <code>~/.bashrc</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># DeepSeek API Key (可选，如果已在配置文件中设置)</span>
<span class="hljs-built_in">export</span> DEEPSEEK_API_KEY=<span class="hljs-string">"你的API_KEY"</span>

<span class="hljs-comment"># OpenClaw Gateway Token (可选)</span>
<span class="hljs-built_in">export</span> OPENCLAW_TOKEN=<span class="hljs-string">"你的gateway_token"</span>
</code></pre>
<p>然后重新加载配置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">source</span> ~/.zshrc  <span class="hljs-comment"># 或 source ~/.bashrc</span>
</code></pre>
<h4 data-id="heading-34">配置工作空间</h4>
<pre><code class="hljs language-bash" lang="bash">openclaw config <span class="hljs-built_in">set</span> agents.defaults.workspace <span class="hljs-string">"/自定义/工作空间/路径"</span>
</code></pre>
<hr/>
<h3 data-id="heading-35">相关资源</h3>
<ul>
<li><strong>OpenClaw 官方文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openclaw.ai%2F" target="_blank" title="https://docs.openclaw.ai/" ref="nofollow noopener noreferrer">docs.openclaw.ai/</a></li>
<li><strong>DeepSeek 官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2F" target="_blank" title="https://platform.deepseek.com/" ref="nofollow noopener noreferrer">platform.deepseek.com/</a></li>
<li><strong>DeepSeek API 文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2Fapi-docs%2F" target="_blank" title="https://platform.deepseek.com/api-docs/" ref="nofollow noopener noreferrer">platform.deepseek.com/api-docs/</a></li>
<li><strong>OpenClaw GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fopenclaw" target="_blank" title="https://github.com/anthropics/openclaw" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></li>
</ul>
<p><strong>提示</strong>: 如果遇到其他问题，可以运行 <code>openclaw doctor --deep</code> 进行深度诊断，或访问官方文档获取更多帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VS Code 1.109 更新解读（五）：API 与工程改进]]></title>    <link>https://juejin.cn/post/7605157203591282715</link>    <guid>https://juejin.cn/post/7605157203591282715</guid>    <pubDate>2026-02-11T07:45:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605157203591282715" data-draft-id="7605401415855177778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VS Code 1.109 更新解读（五）：API 与工程改进"/> <meta itemprop="keywords" content="Visual Studio Code"/> <meta itemprop="datePublished" content="2026-02-11T07:45:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只叁木Meow"/> <meta itemprop="url" content="https://juejin.cn/user/231371762837604"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VS Code 1.109 更新解读（五）：API 与工程改进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/231371762837604/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只叁木Meow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:45:45.000Z" title="Wed Feb 11 2026 07:45:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>💡 更多技术分享，欢迎访问我的博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsanmu7.com%2F" target="_blank" title="https://sanmu7.com/" ref="nofollow noopener noreferrer">叁木の小屋</a></p>
</blockquote>
<blockquote>
<p><strong>系列索引</strong>：<a href="https://juejin.cn/post/7605114266024460339" target="_blank" title="https://juejin.cn/post/7605114266024460339">总览</a> | <a href="https://juejin.cn/post/7605135197166731314" target="_blank" title="https://juejin.cn/post/7605135197166731314">（一）</a>| <a href="https://juejin.cn/post/7605135197166747698" target="_blank" title="https://juejin.cn/post/7605135197166747698">（二）</a> | <a href="https://juejin.cn/post/7605401415855259698" target="_blank" title="https://juejin.cn/post/7605401415855259698">（三）</a> | <a href="https://juejin.cn/post/7605173538417442826" target="_blank" title="https://juejin.cn/post/7605173538417442826">（四）</a> | <strong>（五）</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">本篇概要</h2>
<p>最后一篇涵盖扩展 API 的更新和工程改进，为扩展作者和平台稳定性带来增强：</p>
<ul>
<li>Quick Input 按钮 API 正式确定</li>
<li>Chat Model Provider 配置架构</li>
<li>macOS DMG 镜像</li>
<li>Windows 安装重设计</li>
</ul>
<hr/>
<h2 data-id="heading-1">一、扩展与 API</h2>
<h3 data-id="heading-2">1.1 GitHub Pull Requests 扩展</h3>
<p>GitHub Pull Requests 扩展更新至 0.128.0 版本。</p>
<p>详见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%2Fgithub.vscode-pull-request-github%2Fchangelog" target="_blank" title="https://marketplace.visualstudio.com/items/github.vscode-pull-request-github/changelog" ref="nofollow noopener noreferrer">市场页面更新日志</a></p>
<h3 data-id="heading-3">1.2 Quick Input 按钮位置 API（正式确定）</h3>
<p>可在 <code>QuickPick</code> 或 <code>InputBox</code> 上指定按钮位置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> quickPick = vscode.<span class="hljs-property">window</span>.<span class="hljs-title function_">createQuickPick</span>();
quickPick.<span class="hljs-property">buttons</span> = [
  {
    <span class="hljs-attr">iconPath</span>: vscode.<span class="hljs-property">Uri</span>.<span class="hljs-title function_">file</span>(<span class="hljs-string">'path/to/icon.svg'</span>),
    <span class="hljs-attr">tooltip</span>: <span class="hljs-string">'Click me'</span>,
    <span class="hljs-attr">location</span>: vscode.<span class="hljs-property">QuickInputButtonLocation</span>.<span class="hljs-property">Title</span>  <span class="hljs-comment">// 或 Inline, Input</span>
  }
];
</code></pre>





















<table><thead><tr><th>位置</th><th>说明</th></tr></thead><tbody><tr><td><code>Title</code></td><td>顶部标题区域（默认）</td></tr><tr><td><code>Inline</code></td><td>输入框右侧</td></tr><tr><td><code>Input</code></td><td>输入框内右侧</td></tr></tbody></table>
<h3 data-id="heading-4">1.3 Quick Input 按钮切换 API（正式确定）</h3>
<p>创建具有开/关状态的切换按钮：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">toggleButton</span>: vscode.<span class="hljs-property">QuickInputButton</span> = {
  <span class="hljs-attr">iconPath</span>: vscode.<span class="hljs-property">Uri</span>.<span class="hljs-title function_">file</span>(<span class="hljs-string">'path/to/toggle-icon.svg'</span>),
  <span class="hljs-attr">tooltip</span>: <span class="hljs-string">'Toggle feature'</span>,
  <span class="hljs-attr">toggle</span>: { <span class="hljs-attr">checked</span>: <span class="hljs-literal">false</span> }
};

<span class="hljs-comment">// 读取状态</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(toggleButton.<span class="hljs-property">checked</span>); <span class="hljs-comment">// false</span>

<span class="hljs-comment">// 更新状态</span>
toggleButton.<span class="hljs-property">toggle</span> = { <span class="hljs-attr">checked</span>: <span class="hljs-literal">true</span> };
</code></pre>
<h3 data-id="heading-5">1.4 Chat Model Provider 配置（提议）</h3>
<p>扩展可通过 <code>languageModelChatProviders</code> 贡献点声明配置要求：</p>
<h4 data-id="heading-6">简单配置（仅需 API Key）</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"contributes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"languageModelChatProviders"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"vendor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-provider"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"displayName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"My Provider"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"configuration"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"secret"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"API key for My Provider"</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"API Key"</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"apiKey"</span><span class="hljs-punctuation">]</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-7">高级配置（自定义模型）</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"contributes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"languageModelChatProviders"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"vendor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-provider"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"displayName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"My Provider"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"configuration"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"secret"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"array"</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"items"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
                  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"maxInputTokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"number"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"maxOutputTokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"number"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"toolCalling"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"boolean"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
                  <span class="hljs-attr">"vision"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"boolean"</span> <span class="hljs-punctuation">}</span>
                <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"id"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"name"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"url"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"maxInputTokens"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"maxOutputTokens"</span><span class="hljs-punctuation">]</span>
              <span class="hljs-punctuation">}</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"apiKey"</span><span class="hljs-punctuation">]</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-8">使用配置</h4>
<pre><code class="hljs language-typescript" lang="typescript">vscode.<span class="hljs-property">lm</span>.<span class="hljs-title function_">registerLanguageModelChatProvider</span>(<span class="hljs-string">'my-provider'</span>, {
  <span class="hljs-attr">provideLanguageModelResponse</span>: <span class="hljs-function">(<span class="hljs-params">
    messages,
    options,
    extensionToken,
    configuration,  <span class="hljs-comment">// 用户配置</span>
    token
  </span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> apiKey = configuration.<span class="hljs-property">apiKey</span>;
    <span class="hljs-keyword">const</span> models = configuration.<span class="hljs-property">models</span>;
    <span class="hljs-comment">// 使用配置进行 API 调用...</span>
  }
});
</code></pre>
<h3 data-id="heading-9">1.5 Chat Prompt Files API（提议）</h3>
<p>扩展可以动态贡献聊天资源：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 注册技能提供程序</span>
vscode.<span class="hljs-property">chat</span>.<span class="hljs-title function_">registerSkillProvider</span>({
  <span class="hljs-attr">onDidChangeSkills</span>: onDidChangeEvent,
  <span class="hljs-title function_">provideSkills</span>(context, token): vscode.<span class="hljs-property">ChatResource</span>[] {
    <span class="hljs-keyword">return</span> [{
      <span class="hljs-attr">uri</span>: vscode.<span class="hljs-property">Uri</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">'my-extension:/skills/debugging/SKILL.md'</span>)
    }];
  }
});

<span class="hljs-comment">// 其他资源类型</span>
<span class="hljs-comment">// registerCustomAgentProvider()   // .agent.md</span>
<span class="hljs-comment">// registerInstructionsProvider()  // .instructions.md</span>
<span class="hljs-comment">// registerPromptFileProvider()    // .prompt.md</span>
</code></pre>
<h3 data-id="heading-10">1.6 Chat Item Controller API（提议）</h3>
<p>新的基于控制器的 API：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> controller = vscode.<span class="hljs-property">chat</span>.<span class="hljs-title function_">createChatSessionItemController</span>(
  <span class="hljs-string">'myExtension.chatSessions'</span>,
  <span class="hljs-keyword">async</span> (<span class="hljs-attr">token</span>: vscode.<span class="hljs-property">CancellationToken</span>) =&gt; {
    <span class="hljs-keyword">const</span> sessions = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchSessionsFromBackend</span>();
    <span class="hljs-keyword">const</span> items = sessions.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">session</span> =&gt;</span>
      controller.<span class="hljs-title function_">createChatSessionItem</span>(
        vscode.<span class="hljs-property">Uri</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">`my-scheme://session/<span class="hljs-subst">${session.id}</span>`</span>),
        session.<span class="hljs-property">title</span>
      )
    );
    controller.<span class="hljs-property">items</span>.<span class="hljs-title function_">replace</span>(items);

    <span class="hljs-comment">// 实时更新</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> controller.<span class="hljs-property">items</span>) {
        item.<span class="hljs-property">label</span> = <span class="hljs-string">`<span class="hljs-subst">${item.label}</span> - <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleTimeString()}</span>`</span>;
      }
    }, <span class="hljs-number">10000</span>);
  }
);

controller.<span class="hljs-title function_">onDidChangeChatSessionItemState</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Session <span class="hljs-subst">${item.label}</span> archived: <span class="hljs-subst">${item.archived}</span>`</span>);
});
</code></pre>
<h3 data-id="heading-11">1.7 Chat Output Renderer API 更新</h3>
<p>渲染器现在作为 <code>ChatOutputWebview</code> 传递：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRenderer</span> <span class="hljs-keyword">implements</span> vscode.<span class="hljs-property">ChatOutputWebview</span> {
  <span class="hljs-attr">onDidDispose</span>: <span class="hljs-title class_">Event</span>&lt;<span class="hljs-built_in">void</span>&gt;;
  <span class="hljs-title function_">dispose</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 清理资源</span>
  }
}
</code></pre>
<h3 data-id="heading-12">1.8 Portable Mode 检测（提议）</h3>
<p>检测 VS Code 是否在便携模式下运行：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (vscode.<span class="hljs-property">env</span>.<span class="hljs-property">isAppPortable</span>) {
  <span class="hljs-comment">// 在便携模式下运行 - 调整行为</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-13">二、工程改进</h2>
<h3 data-id="heading-14">2.1 macOS DMG 镜像</h3>
<p>VS Code 现在为 macOS 提供 DMG 镜像：</p>
<ul>
<li>原生拖放安装体验</li>
<li>支持所有架构</li>
<li>从 VS Code 官网下载</li>
</ul>
<h3 data-id="heading-15">2.2 Windows 安装重设计</h3>
<p>重新设计安装布局，解决更新可靠性问题：</p>





















<table><thead><tr><th>之前</th><th>现在</th></tr></thead><tbody><tr><td>原子文件替换</td><td>版本化包路径</td></tr><tr><td>更新可能中断</td><td>更新更可靠</td></tr><tr><td>受系统关闭影响</td><td>受影响更小</td></tr></tbody></table>
<p>灵感来自 Chromium 更新客户端。</p>
<h3 data-id="heading-16">2.3 macOS 避免连续更新</h3>
<pre><code class="hljs language-css" lang="css">更新 <span class="hljs-selector-tag">A</span> 准备中 → 更新 <span class="hljs-selector-tag">B</span> 可用
     ↓
使更新 <span class="hljs-selector-tag">A</span> 无效，直接应用更新 <span class="hljs-selector-tag">B</span>
</code></pre>
<p>用户无需重启两次应用。</p>
<h3 data-id="heading-17">2.4 Copilot 扩展已弃用</h3>
<p>GitHub Copilot 扩展已被弃用：</p>
<ul>
<li>所有 AI 功能由 GitHub Copilot Chat 扩展提供</li>
<li>更新 VS Code 时自动卸载旧扩展</li>
<li>Copilot Chat 扩展保持安装</li>
</ul>
<h3 data-id="heading-18">2.5 从 npm 包使用 codicons</h3>
<p>Codicons 现在通过 <code>@vscode/codicons</code> npm 包消费：</p>
<pre><code class="hljs language-css" lang="css">之前：直接捆绑在 VS <span class="hljs-selector-tag">Code</span> 仓库
现在：通过 <span class="hljs-keyword">@vscode</span>/codicons npm 包，作为构建过程的一部分
</code></pre>
<hr/>
<h2 data-id="heading-19">三、值得注意的修复</h2>

















<table><thead><tr><th>问题</th><th>修复</th></tr></thead><tbody><tr><td><code>editor.hover.enabled</code> 为 <code>onModifierKeyPressed</code> 时悬停未立即触发</td><td>已修复</td></tr><tr><td>文件描述符泄漏到终端进程</td><td>已修复</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-20">API 快速参考</h2>
<h3 data-id="heading-21">Quick Input 按钮</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 位置 API</span>
<span class="hljs-attr">location</span>: vscode.<span class="hljs-property">QuickInputButtonLocation</span>.<span class="hljs-property">Title</span> | <span class="hljs-title class_">Inline</span> | <span class="hljs-title class_">Input</span>

<span class="hljs-comment">// 切换 API</span>
<span class="hljs-attr">toggle</span>: { <span class="hljs-attr">checked</span>: <span class="hljs-built_in">boolean</span> }
</code></pre>
<h3 data-id="heading-22">Chat Provider</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 注册</span>
vscode.<span class="hljs-property">lm</span>.<span class="hljs-title function_">registerLanguageModelChatProvider</span>(vendor, provider)

<span class="hljs-comment">// 配置</span>
<span class="hljs-attr">languageModelChatProviders</span>: [{ vendor, displayName, configuration }]
</code></pre>
<h3 data-id="heading-23">Chat Resources</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 技能</span>
vscode.<span class="hljs-property">chat</span>.<span class="hljs-title function_">registerSkillProvider</span>({ onDidChangeSkills, provideSkills })

<span class="hljs-comment">// 自定义智能体</span>
vscode.<span class="hljs-property">chat</span>.<span class="hljs-title function_">registerCustomAgentProvider</span>({ onDidChangeAgents, provideAgents })

<span class="hljs-comment">// 说明</span>
vscode.<span class="hljs-property">chat</span>.<span class="hljs-title function_">registerInstructionsProvider</span>({ onDidChangeInstructions, provideInstructions })

<span class="hljs-comment">// 提示文件</span>
vscode.<span class="hljs-property">chat</span>.<span class="hljs-title function_">registerPromptFileProvider</span>({ onDidChangePromptFiles, providePromptFiles })
</code></pre>
<h3 data-id="heading-24">环境检测</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 便携模式</span>
vscode.<span class="hljs-property">env</span>.<span class="hljs-property">isAppPortable</span>: <span class="hljs-built_in">boolean</span>
</code></pre>
<hr/>
<h2 data-id="heading-25">系列总结</h2>
<p>VS Code 1.109 是一个里程碑版本，标志着 VS Code 向<strong>统一多智能体开发平台</strong>的演进。</p>
<p><strong>五大核心方向</strong>：</p>
<ol>
<li><strong>聊天体验</strong>——更快、更清晰、更流畅</li>
<li><strong>会话管理</strong>——本地/后台/云端统一</li>
<li><strong>智能体定制</strong>——可定制的 AI 行为</li>
<li><strong>扩展性</strong>——Claude Agent、MCP Apps</li>
<li><strong>平台改进</strong>——终端、编辑器、工作台、API</li>
</ol>
<hr/>
<p>感谢阅读本系列！</p>
<p><strong>相关链接</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Fupdates%2Fv1_109" target="_blank" title="https://code.visualstudio.com/updates/v1_109" ref="nofollow noopener noreferrer">官方发布说明</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com" target="_blank" title="https://code.visualstudio.com" ref="nofollow noopener noreferrer">VS Code 官网</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ArkTs版图库预览]]></title>    <link>https://juejin.cn/post/7605213691910946842</link>    <guid>https://juejin.cn/post/7605213691910946842</guid>    <pubDate>2026-02-11T09:59:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605213691910946842" data-draft-id="7312375896177508415" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ArkTs版图库预览"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-02-11T09:59:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="胖子不胖"/> <meta itemprop="url" content="https://juejin.cn/user/3598026262724024"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ArkTs版图库预览
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3598026262724024/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    胖子不胖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:59:18.000Z" title="Wed Feb 11 2026 09:59:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文基于鸿蒙系统，用600行代码实现类似图库预览效果</p>
<p>新建<code>MediaDialogUtil.ets</code>工具类，然后在工程下<code>import</code> 导入使用即可</p>
<pre><code class="hljs language-scss" lang="scss">import {MediaParams, MediaDialogUtil} from ./MediaDialogUtil<span class="hljs-selector-class">.ets</span>


<span class="hljs-built_in">build</span>() {
    <span class="hljs-built_in">Stack</span>() {
      Text('点击打开弹窗')
        <span class="hljs-selector-class">.border</span>({
          width: <span class="hljs-number">10</span>,
          color: '#<span class="hljs-number">000000</span>'
        })
        <span class="hljs-selector-class">.onClick</span>(() =&gt; {
          const data: MediaParams[] = [
            new <span class="hljs-built_in">MediaParams</span>(<span class="hljs-string">'https://img1.baidu.com/it/u=3858873910,2096255234&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG'</span>),
            new <span class="hljs-built_in">MediaParams</span>(<span class="hljs-string">'https://img2.huashi6.com/images/resource/thumbnail/2025/03/06/15612_3721456001.jpg'</span>),
            new <span class="hljs-built_in">MediaParams</span>(<span class="hljs-string">'https://gips1.baidu.com/it/u=4077989092,1759249013&amp;fm=3074&amp;app=3074&amp;f=JPEG'</span>),
          ];
          MediaDialogUtil<span class="hljs-selector-class">.openDialog</span>(data);
        })
    }
    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
    <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
  }
</code></pre>
<p><code>MediaDialogUtil.ets</code>工具类具体代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ComponentContent</span>, promptAction } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>
<span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-keyword">import</span> { display } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DURATION_200</span> = <span class="hljs-number">200</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ONE_HUNDRED_PERCENT</span> = <span class="hljs-string">'100%'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BLACK_COLOR</span> = <span class="hljs-string">'#000000'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CONST_NUMBER_40</span> = <span class="hljs-number">40</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CONST_NUMBER_50</span> = <span class="hljs-number">50</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_SCALE_TIMES</span> = <span class="hljs-number">3</span>; <span class="hljs-comment">// 图片最大放大倍数</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAP_SCALE_AVOID_FACTOR</span> = <span class="hljs-number">1.2</span>; <span class="hljs-comment">// 双击放大时出现黑边避让系数</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">WHITE_COLOR</span> = <span class="hljs-string">'#ffffff'</span>;

<span class="hljs-keyword">export</span> enum <span class="hljs-variable constant_">MEDIA_TYPE</span> {
  <span class="hljs-variable constant_">PHOTO</span> = <span class="hljs-number">1</span>,
  <span class="hljs-variable constant_">VIDEO</span> = <span class="hljs-number">2</span>
}

enum <span class="hljs-variable constant_">BORDER_ENUM</span> {
  <span class="hljs-variable constant_">LEFT</span>,
  <span class="hljs-variable constant_">RIGHT</span>,
  <span class="hljs-variable constant_">TOP</span>,
  <span class="hljs-variable constant_">BOTTOM</span>,
  <span class="hljs-variable constant_">NORMAL</span>
}

interface <span class="hljs-title class_">EventImage</span> {
  <span class="hljs-attr">width</span>: number,
  <span class="hljs-attr">height</span>: number
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">resetImage</span>(<span class="hljs-params">item: MediaParams</span>) {
  item.<span class="hljs-property">translateCenterX</span> = item.<span class="hljs-property">centerDistanceX</span>;
  item.<span class="hljs-property">translateCenterY</span> = item.<span class="hljs-property">centerDistanceY</span>;
  item.<span class="hljs-property">translateX</span> = <span class="hljs-number">0</span>;
  item.<span class="hljs-property">translateY</span> = <span class="hljs-number">0</span>;
  item.<span class="hljs-property">horizonBorder</span> = <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">NORMAL</span>;
  item.<span class="hljs-property">verticalBorder</span> = <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">NORMAL</span>;
  item.<span class="hljs-property">scale</span> = <span class="hljs-number">1</span>;
  item.<span class="hljs-property">params</span>?.<span class="hljs-title function_">update</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">tapScaleImage</span>(<span class="hljs-params">item: MediaParams, event: GestureEvent, recover = <span class="hljs-literal">false</span></span>) {
  <span class="hljs-keyword">if</span> (item.<span class="hljs-property">imgWidth</span> === <span class="hljs-number">0</span> || item.<span class="hljs-property">imgHeight</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-title function_">animateToImmediately</span>({
    <span class="hljs-attr">duration</span>: <span class="hljs-number">150</span>
  }, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!item.<span class="hljs-property">params</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">scale</span> &lt; <span class="hljs-variable constant_">MAX_SCALE_TIMES</span> &amp;&amp; !recover) {
      <span class="hljs-keyword">const</span> displayX = event.<span class="hljs-property">fingerList</span>[<span class="hljs-number">0</span>].<span class="hljs-property">displayX</span> ?? item.<span class="hljs-property">params</span>.<span class="hljs-property">screenWidth</span> / <span class="hljs-number">2</span>;
      <span class="hljs-keyword">const</span> displayY = event.<span class="hljs-property">fingerList</span>[<span class="hljs-number">0</span>].<span class="hljs-property">displayY</span> ?? item.<span class="hljs-property">params</span>.<span class="hljs-property">screenHeight</span> / <span class="hljs-number">2</span>;
      <span class="hljs-title function_">scaleImage</span>(item, <span class="hljs-variable constant_">MAX_SCALE_TIMES</span>, displayX, displayY, item.<span class="hljs-property">params</span>, <span class="hljs-literal">false</span>);
      <span class="hljs-comment">// 进行中心点坐标矫正 防止出现黑边</span>
      <span class="hljs-keyword">const</span> realWidth = item.<span class="hljs-property">imgWidth</span> * <span class="hljs-variable constant_">MAX_SCALE_TIMES</span>;
      <span class="hljs-keyword">const</span> realHeight = item.<span class="hljs-property">imgHeight</span> * <span class="hljs-variable constant_">MAX_SCALE_TIMES</span>;
      <span class="hljs-keyword">const</span> screenWidth = item.<span class="hljs-property">params</span>.<span class="hljs-property">screenWidth</span>;
      <span class="hljs-keyword">const</span> screenHeight = item.<span class="hljs-property">params</span>.<span class="hljs-property">screenHeight</span>;
      <span class="hljs-keyword">const</span> leftBorder = item.<span class="hljs-property">imgWidth</span> / <span class="hljs-number">2</span> + item.<span class="hljs-property">translateCenterX</span> + item.<span class="hljs-property">translateX</span> - realWidth / <span class="hljs-number">2</span>;
      <span class="hljs-keyword">const</span> rightBorder = leftBorder + realWidth;
      <span class="hljs-keyword">if</span> (leftBorder &gt; <span class="hljs-number">0</span>) {
        item.<span class="hljs-property">translateCenterX</span> -= <span class="hljs-variable constant_">TAP_SCALE_AVOID_FACTOR</span> * leftBorder;
      }
      <span class="hljs-keyword">if</span> (rightBorder &lt; screenWidth) {
        item.<span class="hljs-property">translateCenterX</span> += <span class="hljs-variable constant_">TAP_SCALE_AVOID_FACTOR</span> * (screenWidth - rightBorder);
      }
      <span class="hljs-keyword">const</span> topBorder = item.<span class="hljs-property">imgHeight</span> / <span class="hljs-number">2</span> + item.<span class="hljs-property">translateCenterY</span> + item.<span class="hljs-property">translateY</span> - realHeight / <span class="hljs-number">2</span>;
      <span class="hljs-keyword">const</span> bottomBorder = topBorder + realHeight;
      <span class="hljs-keyword">if</span> (topBorder &gt; <span class="hljs-number">0</span>) {
        item.<span class="hljs-property">translateCenterY</span> -= <span class="hljs-variable constant_">TAP_SCALE_AVOID_FACTOR</span> * topBorder;
      }
      <span class="hljs-keyword">if</span> (bottomBorder &lt; screenHeight) {
        item.<span class="hljs-property">translateCenterY</span> += <span class="hljs-variable constant_">TAP_SCALE_AVOID_FACTOR</span> * (screenHeight - bottomBorder);
      }
      <span class="hljs-title function_">checkBorder</span>(item, item.<span class="hljs-property">params</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 还原</span>
      <span class="hljs-title function_">resetImage</span>(item);
    }
  })
}

<span class="hljs-comment">// 检测图片是否抵达屏幕边缘</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">checkBorder</span>(<span class="hljs-params">item: MediaParams, params: MediaDialogParams, refresh = <span class="hljs-literal">true</span></span>) {
  <span class="hljs-keyword">const</span> realWidth = item.<span class="hljs-property">imgWidth</span> * item.<span class="hljs-property">scale</span>;
  <span class="hljs-keyword">const</span> realHeight = item.<span class="hljs-property">imgHeight</span> * item.<span class="hljs-property">scale</span>;
  <span class="hljs-keyword">const</span> screenWidth = params.<span class="hljs-property">screenWidth</span>;
  <span class="hljs-keyword">const</span> screenHeight = params.<span class="hljs-property">screenHeight</span>;
  item.<span class="hljs-property">horizonBorder</span> = <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">NORMAL</span>;
  item.<span class="hljs-property">verticalBorder</span> = <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">NORMAL</span>;
  <span class="hljs-keyword">if</span> (realWidth &gt; screenWidth) {
    <span class="hljs-keyword">const</span> leftBorder = item.<span class="hljs-property">imgWidth</span> / <span class="hljs-number">2</span> + item.<span class="hljs-property">translateCenterX</span> + item.<span class="hljs-property">translateX</span> - realWidth / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> rightBorder = leftBorder + realWidth;
    <span class="hljs-keyword">if</span> (leftBorder &gt;= <span class="hljs-number">0</span>) {
      item.<span class="hljs-property">horizonBorder</span> = <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">LEFT</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rightBorder &lt;= screenWidth) {
      item.<span class="hljs-property">horizonBorder</span> = <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">RIGHT</span>;
    }
  }
  <span class="hljs-keyword">if</span> (realHeight &gt; screenHeight) {
    <span class="hljs-keyword">const</span> topBorder = item.<span class="hljs-property">imgHeight</span> / <span class="hljs-number">2</span> + item.<span class="hljs-property">translateCenterY</span> + item.<span class="hljs-property">translateY</span> - realHeight / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> bottomBorder = topBorder + realHeight;
    <span class="hljs-keyword">if</span> (topBorder &gt;= <span class="hljs-number">0</span>) {
      item.<span class="hljs-property">verticalBorder</span> = <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">TOP</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bottomBorder &lt;= screenHeight) {
      item.<span class="hljs-property">verticalBorder</span> = <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">BOTTOM</span>;
    }
  }
  <span class="hljs-keyword">if</span> (refresh) {
    params.<span class="hljs-title function_">update</span>();
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">pinScaleImage</span>(<span class="hljs-params">item: MediaParams, event: GestureEvent</span>) {
  <span class="hljs-keyword">if</span> (!item.<span class="hljs-property">params</span>) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">let</span> newScale = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable constant_">MAX_SCALE_TIMES</span>, item.<span class="hljs-property">pinScale</span> * event.<span class="hljs-property">scale</span>);
  <span class="hljs-keyword">const</span> displayX = (event.<span class="hljs-property">pinchCenterX</span> ?? item.<span class="hljs-property">params</span>.<span class="hljs-property">screenWidth</span> / <span class="hljs-number">2</span>);
  <span class="hljs-keyword">const</span> displayY = (event.<span class="hljs-property">pinchCenterY</span> ?? item.<span class="hljs-property">params</span>.<span class="hljs-property">screenHeight</span> / <span class="hljs-number">2</span>);
  <span class="hljs-title function_">scaleImage</span>(item, newScale, displayX, displayY, item.<span class="hljs-property">params</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">scaleImage</span>(<span class="hljs-params">item: MediaParams, newScale: number, displayX: number, displayY: number,
  params: MediaDialogParams, adapt = <span class="hljs-literal">true</span></span>) {
  <span class="hljs-keyword">const</span> realWidth = item.<span class="hljs-property">imgWidth</span> * item.<span class="hljs-property">scale</span>;
  <span class="hljs-keyword">const</span> realHeight = item.<span class="hljs-property">imgHeight</span> * item.<span class="hljs-property">scale</span>;
  <span class="hljs-keyword">const</span> screenWidth = params.<span class="hljs-property">screenWidth</span>;
  <span class="hljs-keyword">const</span> screenHeight = params.<span class="hljs-property">screenHeight</span>;
  <span class="hljs-comment">// 缩放中心点-不能超过图片范围</span>
  <span class="hljs-keyword">let</span> scaleCenterX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(item.<span class="hljs-property">imgWidth</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(displayX - item.<span class="hljs-property">centerDistanceX</span>, <span class="hljs-number">0</span>));
  <span class="hljs-keyword">let</span> scaleCenterY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(item.<span class="hljs-property">imgHeight</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(displayY - item.<span class="hljs-property">centerDistanceY</span>, <span class="hljs-number">0</span>));
  <span class="hljs-comment">// 调整缩放中心点 双击放大无需调整</span>
  <span class="hljs-keyword">if</span> (adapt) {
    <span class="hljs-keyword">if</span> (realWidth &lt;= screenWidth) {
      scaleCenterX = item.<span class="hljs-property">imgWidth</span> / <span class="hljs-number">2</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item.<span class="hljs-property">horizonBorder</span> === <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">LEFT</span>) {
      scaleCenterX = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item.<span class="hljs-property">horizonBorder</span> === <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">RIGHT</span>) {
      scaleCenterX = item.<span class="hljs-property">imgWidth</span>;
    }
    <span class="hljs-keyword">if</span> (realHeight &lt;= screenHeight) {
      scaleCenterY = item.<span class="hljs-property">imgHeight</span> / <span class="hljs-number">2</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item.<span class="hljs-property">verticalBorder</span> === <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">TOP</span>) {
      scaleCenterY = <span class="hljs-number">0</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item.<span class="hljs-property">verticalBorder</span> === <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">BOTTOM</span>) {
      scaleCenterY = item.<span class="hljs-property">imgHeight</span>;
    }
  }
  <span class="hljs-comment">// 计算 中心点偏移量</span>
  <span class="hljs-keyword">const</span> moveX = (item.<span class="hljs-property">imgWidth</span> / <span class="hljs-number">2</span> - scaleCenterX) * (newScale - item.<span class="hljs-property">scale</span>);
  <span class="hljs-keyword">const</span> moveY = (item.<span class="hljs-property">imgHeight</span> / <span class="hljs-number">2</span> - scaleCenterY) * (newScale - item.<span class="hljs-property">scale</span>);
  <span class="hljs-comment">// 中心点真实坐标</span>
  item.<span class="hljs-property">translateCenterX</span> += moveX;
  item.<span class="hljs-property">translateCenterY</span> += moveY;
  item.<span class="hljs-property">scale</span> = newScale;
  <span class="hljs-title function_">checkBorder</span>(item, params, adapt);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">panMoveImage</span>(<span class="hljs-params">item: MediaParams, event: GestureEvent</span>) {
  <span class="hljs-keyword">if</span> (!item || !item.<span class="hljs-property">params</span>) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">const</span> deltaX = event.<span class="hljs-property">offsetX</span>; <span class="hljs-comment">// X轴移动的距离</span>
  <span class="hljs-keyword">const</span> deltaY = event.<span class="hljs-property">offsetY</span>; <span class="hljs-comment">// Y轴移动的距离</span>
  <span class="hljs-keyword">const</span> realWidth = item.<span class="hljs-property">imgWidth</span> * item.<span class="hljs-property">scale</span>;
  <span class="hljs-keyword">const</span> realHeight = item.<span class="hljs-property">imgHeight</span> * item.<span class="hljs-property">scale</span>;
  <span class="hljs-keyword">const</span> screenWidth = item.<span class="hljs-property">params</span>.<span class="hljs-property">screenWidth</span>;
  <span class="hljs-keyword">const</span> screenHeight = item.<span class="hljs-property">params</span>.<span class="hljs-property">screenHeight</span>;
  <span class="hljs-comment">// 判断边界</span>
  <span class="hljs-keyword">if</span> (realWidth &gt; screenWidth) { <span class="hljs-comment">// 宽度小于不移动</span>
    <span class="hljs-keyword">const</span> leftBorder = item.<span class="hljs-property">imgWidth</span> / <span class="hljs-number">2</span> + item.<span class="hljs-property">translateCenterX</span> + item.<span class="hljs-property">panStartX</span> - realWidth / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> rightBorder = leftBorder + realWidth;
    item.<span class="hljs-property">translateX</span> = item.<span class="hljs-property">panStartX</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(-leftBorder, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(deltaX, screenWidth - rightBorder));
  }
  <span class="hljs-keyword">if</span> (realHeight &gt; screenHeight) {
    <span class="hljs-keyword">const</span> topBorder = item.<span class="hljs-property">imgHeight</span> / <span class="hljs-number">2</span> + item.<span class="hljs-property">translateCenterY</span> + item.<span class="hljs-property">panStartY</span> - realHeight / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> bottomBorder = topBorder + realHeight;
    item.<span class="hljs-property">translateY</span> = item.<span class="hljs-property">panStartY</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(-topBorder, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(deltaY, screenHeight - bottomBorder));
  }
  <span class="hljs-title function_">checkBorder</span>(item, item.<span class="hljs-property">params</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">generateCommonGesture</span>(<span class="hljs-params">item: MediaParams, params: MediaDialogParams</span>) {
  <span class="hljs-keyword">return</span> [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TapGestureHandler</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">2</span> })
      .<span class="hljs-title function_">onAction</span>(<span class="hljs-function">(<span class="hljs-params">event: GestureEvent</span>) =&gt;</span> {
        <span class="hljs-title function_">tapScaleImage</span>(item, event);
      }),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TapGestureHandler</span>({ <span class="hljs-attr">count</span>: <span class="hljs-number">1</span> })
      .<span class="hljs-title function_">onAction</span>(<span class="hljs-function">() =&gt;</span> {
        params.<span class="hljs-title function_">close</span>();
      }),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">PinchGestureHandler</span>({ <span class="hljs-attr">distance</span>: <span class="hljs-number">1</span> })
      .<span class="hljs-title function_">onActionStart</span>(<span class="hljs-function">() =&gt;</span> {
        item.<span class="hljs-property">pinScale</span> = item.<span class="hljs-property">scale</span>;
        params.<span class="hljs-property">disabledSwiper</span> = <span class="hljs-literal">true</span>;
        params.<span class="hljs-title function_">update</span>();
      })
      .<span class="hljs-title function_">onActionUpdate</span>(<span class="hljs-function">(<span class="hljs-params">event: GestureEvent</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!item) {
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-title function_">pinScaleImage</span>(item, event);
      })
      .<span class="hljs-title function_">onActionEnd</span>(<span class="hljs-function">(<span class="hljs-params">event: GestureEvent</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (item.<span class="hljs-property">scale</span> &lt; <span class="hljs-number">1</span>) {
          <span class="hljs-title function_">tapScaleImage</span>(item, event, <span class="hljs-literal">true</span>);
        }
        params.<span class="hljs-property">disabledSwiper</span> = <span class="hljs-literal">false</span>;
        params.<span class="hljs-title function_">update</span>();
      })
      .<span class="hljs-title function_">onActionCancel</span>(<span class="hljs-function">() =&gt;</span> {
        params.<span class="hljs-property">disabledSwiper</span> = <span class="hljs-literal">false</span>;
        params.<span class="hljs-title function_">update</span>();
      })
  ];
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">EmptyModifierGlobal</span> implements <span class="hljs-title class_">GestureModifier</span> {
  <span class="hljs-title function_">applyGesture</span>(<span class="hljs-attr">event</span>: <span class="hljs-title class_">UIGestureEvent</span>): <span class="hljs-keyword">void</span> {
    event.<span class="hljs-title function_">clearGestures</span>();
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageGestureModifierGlobal</span> implements <span class="hljs-title class_">GestureModifier</span> {
  <span class="hljs-attr">item</span>: <span class="hljs-title class_">MediaParams</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">item: MediaParams</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> = item;
  }

  <span class="hljs-title function_">applyGesture</span>(<span class="hljs-attr">event</span>: <span class="hljs-title class_">UIGestureEvent</span>): <span class="hljs-keyword">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">horizonBorder</span> !== <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">NORMAL</span>) { <span class="hljs-comment">// 当到达边界的时候、添加手势、代理</span>
      <span class="hljs-keyword">const</span> normalGesture = <span class="hljs-title function_">generateCommonGesture</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>);
      normalGesture.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PanGestureHandler</span>({ <span class="hljs-attr">fingers</span>: <span class="hljs-number">1</span> })
        .<span class="hljs-title function_">onActionStart</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-property">isDetermined</span>) {
            <span class="hljs-keyword">return</span>;
          }
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">panStartX</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">translateX</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">panStartY</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">translateY</span>;
        })
        .<span class="hljs-title function_">onActionUpdate</span>(<span class="hljs-function">(<span class="hljs-params">event: GestureEvent</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>) {
            <span class="hljs-keyword">return</span>;
          }
          <span class="hljs-keyword">const</span> params = <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>;
          <span class="hljs-keyword">if</span> (!params.<span class="hljs-property">isDetermined</span>) {
            params.<span class="hljs-property">isDetermined</span> = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">const</span> deltaX = event.<span class="hljs-property">offsetX</span>; <span class="hljs-comment">// X轴移动的距离</span>
            <span class="hljs-keyword">const</span> deltaY = event.<span class="hljs-property">offsetY</span>; <span class="hljs-comment">// Y轴移动的距离</span>
            <span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">horizonBorder</span> === <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">LEFT</span> &amp;&amp; deltaX &lt; <span class="hljs-number">0</span>) ||
              (<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">horizonBorder</span> === <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">RIGHT</span> &amp;&amp; deltaX &gt; <span class="hljs-number">0</span>) ||
              (deltaX == <span class="hljs-number">0</span> &amp;&amp; deltaY !== <span class="hljs-number">0</span>)) { <span class="hljs-comment">// 触发位移逻辑</span>
              params.<span class="hljs-property">shouldMovePic</span> = <span class="hljs-literal">true</span>;
              <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-property">disabledSwiper</span> = <span class="hljs-literal">true</span>;
              params.<span class="hljs-title function_">update</span>();
            }
          }
          <span class="hljs-keyword">if</span> (params.<span class="hljs-property">shouldMovePic</span>) {
            <span class="hljs-title function_">panMoveImage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>, event);
          }
        })
        .<span class="hljs-title function_">onActionEnd</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>) {
            <span class="hljs-keyword">return</span>;
          }
          <span class="hljs-comment">// 还原swiper</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-property">disabledSwiper</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-property">isDetermined</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-property">shouldMovePic</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-title function_">update</span>();
        })
        .<span class="hljs-title function_">onActionCancel</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>) {
            <span class="hljs-keyword">return</span>;
          }
          <span class="hljs-comment">// 还原swiper</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-property">disabledSwiper</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-property">isDetermined</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-property">shouldMovePic</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-title function_">update</span>();
        }))
      event.<span class="hljs-title function_">addParallelGesture</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GestureGroupHandler</span>({
        <span class="hljs-attr">mode</span>: <span class="hljs-title class_">GestureMode</span>.<span class="hljs-property">Exclusive</span>,
        <span class="hljs-attr">gestures</span>: normalGesture
      }))
    } <span class="hljs-keyword">else</span> {
      event.<span class="hljs-title function_">clearGestures</span>();
    }
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageGestureModifier</span> implements <span class="hljs-title class_">GestureModifier</span> {
  <span class="hljs-attr">item</span>: <span class="hljs-title class_">MediaParams</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">item: MediaParams</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> = item;
  }

  <span class="hljs-title function_">applyGesture</span>(<span class="hljs-attr">event</span>: <span class="hljs-title class_">UIGestureEvent</span>): <span class="hljs-keyword">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">horizonBorder</span> !== <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">NORMAL</span>) {
      event.<span class="hljs-title function_">clearGestures</span>();
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">const</span> normalGesture = <span class="hljs-title function_">generateCommonGesture</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">scale</span> &gt; <span class="hljs-number">1</span>) { <span class="hljs-comment">// 图片放大了、添加panGesture、预览</span>
      normalGesture.<span class="hljs-title function_">push</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">PanGestureHandler</span>({
          <span class="hljs-attr">fingers</span>: <span class="hljs-number">1</span>,
          <span class="hljs-attr">direction</span>: <span class="hljs-title class_">PanDirection</span>.<span class="hljs-property">All</span>
        })
          .<span class="hljs-title function_">onActionStart</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>) {
              <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">panStartX</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">translateX</span>;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">panStartY</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">translateY</span>;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-property">disabledSwiper</span> = <span class="hljs-literal">true</span>;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-title function_">update</span>();
          })
          .<span class="hljs-title function_">onActionUpdate</span>(<span class="hljs-function">(<span class="hljs-params">event: GestureEvent</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>) {
              <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-title function_">panMoveImage</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>, event);
          })
          .<span class="hljs-title function_">onActionEnd</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>) {
              <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-property">disabledSwiper</span> = <span class="hljs-literal">false</span>;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-title function_">update</span>();
          })
          .<span class="hljs-title function_">onActionCancel</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>) {
              <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-property">disabledSwiper</span> = <span class="hljs-literal">false</span>;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>.<span class="hljs-property">params</span>.<span class="hljs-title function_">update</span>();
          })
      )
    }
    event.<span class="hljs-title function_">addGesture</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GestureGroupHandler</span>({
      <span class="hljs-attr">mode</span>: <span class="hljs-title class_">GestureMode</span>.<span class="hljs-property">Exclusive</span>,
      <span class="hljs-attr">gestures</span>: normalGesture
    }))
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaParams</span> {
  type = <span class="hljs-variable constant_">MEDIA_TYPE</span>.<span class="hljs-property">PHOTO</span>;
  url = <span class="hljs-string">''</span>;
  scale = <span class="hljs-number">1</span>;
  pinScale = <span class="hljs-number">1</span>; <span class="hljs-comment">// 记录pinGesture开始时的scale</span>
  centerDistanceX = <span class="hljs-number">0</span>; <span class="hljs-comment">// 图片中心点与手机屏幕中心点的距离</span>
  centerDistanceY = <span class="hljs-number">0</span>;
  translateX = <span class="hljs-number">0</span>;
  translateY = <span class="hljs-number">0</span>;
  translateCenterX = <span class="hljs-number">0</span>; <span class="hljs-comment">// 图片translate (本质上是中心点的位移动)</span>
  translateCenterY = <span class="hljs-number">0</span>;
  panStartX = <span class="hljs-number">0</span>; <span class="hljs-comment">// 记录panGesture开始的translateCenterX</span>
  panStartY = <span class="hljs-number">0</span>; <span class="hljs-comment">// 记录panGesture开始的translateCenterY</span>
  <span class="hljs-attr">imgWidth</span>: number = <span class="hljs-number">0</span>;
  <span class="hljs-attr">imgHeight</span>: number = <span class="hljs-number">0</span>;
  <span class="hljs-attr">params</span>: <span class="hljs-title class_">MediaDialogParams</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  horizonBorder = <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">NORMAL</span>;
  verticalBorder = <span class="hljs-variable constant_">BORDER_ENUM</span>.<span class="hljs-property">NORMAL</span>;
  <span class="hljs-attr">modifier</span>: <span class="hljs-title class_">ImageGestureModifier</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">url: string</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">url</span> = url;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaDialogParams</span> {
  isShow = <span class="hljs-literal">true</span>;
  <span class="hljs-attr">mediaData</span>: <span class="hljs-title class_">MediaParams</span>[] = [];
  <span class="hljs-attr">isFullScreen</span>: boolean = <span class="hljs-literal">false</span>;
  <span class="hljs-attr">index</span>: number = <span class="hljs-number">0</span>;
  <span class="hljs-attr">close</span>: <span class="hljs-function">(<span class="hljs-params">immediate?: boolean</span>) =&gt;</span> <span class="hljs-keyword">void</span>; <span class="hljs-comment">// 关闭方法</span>
  <span class="hljs-attr">swiperController</span>: <span class="hljs-title class_">SwiperController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwiperController</span>();
  <span class="hljs-attr">update</span>: <span class="hljs-function">(<span class="hljs-params">param?: MediaDialogParams</span>) =&gt;</span> <span class="hljs-keyword">void</span>; <span class="hljs-comment">// 更新节点方法</span>
  <span class="hljs-attr">screenWidth</span>: number = <span class="hljs-number">0</span>; <span class="hljs-comment">// 屏幕宽度、单位vp</span>
  <span class="hljs-attr">screenHeight</span>: number = <span class="hljs-number">0</span>;
  disabledSwiper = <span class="hljs-literal">false</span>;
  isDetermined = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 决定是图片位移还是swiper移动</span>
  shouldMovePic = <span class="hljs-literal">false</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">mediaData: MediaParams[], close: (immediate?: boolean) =&gt; <span class="hljs-keyword">void</span>,
    update: (param?: MediaDialogParams) =&gt; <span class="hljs-keyword">void</span>, screenWidth: number, screenHeight: number</span>) {
    mediaData.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      item.<span class="hljs-property">params</span> = <span class="hljs-variable language_">this</span>;
      <span class="hljs-keyword">if</span> (item <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MediaParams</span>) {
        item.<span class="hljs-property">modifier</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageGestureModifier</span>(item);
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">mediaData</span>.<span class="hljs-title function_">push</span>(item);
    })
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">close</span> = close;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">update</span> = update;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenWidth</span> = screenWidth;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">screenHeight</span> = screenHeight;
  }
}

@<span class="hljs-title class_">Builder</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MediaNavigation</span>(<span class="hljs-params">params: MediaDialogParams</span>) {
  <span class="hljs-title class_">Row</span>() {
    <span class="hljs-title class_">Text</span>(<span class="hljs-string">''</span>).<span class="hljs-title function_">width</span>(<span class="hljs-variable constant_">CONST_NUMBER_40</span>).<span class="hljs-title function_">height</span>(<span class="hljs-variable constant_">CONST_NUMBER_40</span>) <span class="hljs-comment">// 布局占位节点</span>
    <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${params.index + <span class="hljs-number">1</span>}</span>/<span class="hljs-subst">${params.mediaData.length}</span>`</span>).<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable constant_">WHITE_COLOR</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
    <span class="hljs-title class_">Image</span>(<span class="hljs-string">''</span>).<span class="hljs-title function_">width</span>(<span class="hljs-variable constant_">CONST_NUMBER_40</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-variable constant_">CONST_NUMBER_40</span>)
      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
        params.<span class="hljs-title function_">close</span>();
      })
  }
  .<span class="hljs-title function_">width</span>(<span class="hljs-variable constant_">ONE_HUNDRED_PERCENT</span>)
  .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Transparent</span>)
  .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceBetween</span>)
  .<span class="hljs-title function_">margin</span>({
    <span class="hljs-attr">top</span>: <span class="hljs-variable constant_">CONST_NUMBER_50</span>,
    <span class="hljs-attr">left</span>: <span class="hljs-variable constant_">CONST_NUMBER_40</span>,
    <span class="hljs-attr">right</span>: <span class="hljs-variable constant_">CONST_NUMBER_40</span>
  })
  .<span class="hljs-title function_">hitTestBehavior</span>(<span class="hljs-title class_">HitTestMode</span>.<span class="hljs-property">None</span>)
}

<span class="hljs-comment">// 图片加载完成更新图片info</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateImageInfo</span>(<span class="hljs-params">item: MediaParams, event?: EventImage</span>) {
  item.<span class="hljs-property">imgWidth</span> = <span class="hljs-title function_">px2vp</span>(event?.<span class="hljs-property">width</span> ?? <span class="hljs-number">0</span>);
  item.<span class="hljs-property">imgHeight</span> = <span class="hljs-title function_">px2vp</span>(event?.<span class="hljs-property">height</span> ?? <span class="hljs-number">0</span>);
  <span class="hljs-keyword">if</span> (item.<span class="hljs-property">imgWidth</span> === <span class="hljs-number">0</span> || item.<span class="hljs-property">imgHeight</span> === <span class="hljs-number">0</span> || !item.<span class="hljs-property">params</span>) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-comment">// 根据ImageFit计算图片的真实宽高</span>
  <span class="hljs-keyword">let</span> aspectRatio = item.<span class="hljs-property">imgWidth</span> / item.<span class="hljs-property">imgHeight</span>;
  <span class="hljs-keyword">let</span> screenAspectRation = item.<span class="hljs-property">params</span>.<span class="hljs-property">screenWidth</span> / item.<span class="hljs-property">params</span>.<span class="hljs-property">screenHeight</span>;
  <span class="hljs-keyword">if</span> (aspectRatio &gt;= screenAspectRation) { <span class="hljs-comment">// 宽度铺满</span>
    item.<span class="hljs-property">imgWidth</span> = item.<span class="hljs-property">params</span>.<span class="hljs-property">screenWidth</span> ?? <span class="hljs-number">0</span>;
    item.<span class="hljs-property">imgHeight</span> = (item.<span class="hljs-property">params</span>.<span class="hljs-property">screenWidth</span> ?? <span class="hljs-number">0</span>) / aspectRatio;
  } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 高度铺满</span>
    item.<span class="hljs-property">imgWidth</span> = (item.<span class="hljs-property">params</span>.<span class="hljs-property">screenHeight</span> ?? <span class="hljs-number">0</span>) * aspectRatio;
    item.<span class="hljs-property">imgHeight</span> = item.<span class="hljs-property">params</span>.<span class="hljs-property">screenHeight</span> ?? <span class="hljs-number">0</span>
  }
  <span class="hljs-comment">// 计算中心点距离</span>
  item.<span class="hljs-property">centerDistanceX</span> = (item.<span class="hljs-property">params</span>.<span class="hljs-property">screenWidth</span> - item.<span class="hljs-property">imgWidth</span>) / <span class="hljs-number">2</span>;
  item.<span class="hljs-property">centerDistanceY</span> = (item.<span class="hljs-property">params</span>.<span class="hljs-property">screenHeight</span> - item.<span class="hljs-property">imgHeight</span>) / <span class="hljs-number">2</span>;
  item.<span class="hljs-property">translateCenterX</span> = item.<span class="hljs-property">centerDistanceX</span>;
  item.<span class="hljs-property">translateCenterY</span> = item.<span class="hljs-property">centerDistanceY</span>;
  item.<span class="hljs-property">translateX</span> = <span class="hljs-number">0</span>;
  item.<span class="hljs-property">translateY</span> = <span class="hljs-number">0</span>;
  item.<span class="hljs-property">params</span>.<span class="hljs-title function_">update</span>();
}

@<span class="hljs-title class_">Builder</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MediaDialog</span>(<span class="hljs-params">params: MediaDialogParams</span>) {
  <span class="hljs-keyword">if</span> (params.<span class="hljs-property">isShow</span>) {
    <span class="hljs-title class_">Stack</span>({ <span class="hljs-attr">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-property">Top</span> }) {
      <span class="hljs-title class_">Swiper</span>(params.<span class="hljs-property">swiperController</span>) {
        <span class="hljs-title class_">ForEach</span>(params.<span class="hljs-property">mediaData</span>, <span class="hljs-function">(<span class="hljs-params">item: MediaParams</span>) =&gt;</span> {
          <span class="hljs-title class_">Stack</span>({ <span class="hljs-attr">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-property">TopStart</span> }) {
            <span class="hljs-title class_">Image</span>(item.<span class="hljs-property">url</span>)
              .<span class="hljs-title function_">onComplete</span>(<span class="hljs-function">(<span class="hljs-params">event?: EventImage</span>) =&gt;</span> {
                <span class="hljs-title function_">updateImageInfo</span>(item, event);
              })
              .<span class="hljs-title function_">syncLoad</span>(<span class="hljs-literal">true</span>)
              .<span class="hljs-title function_">objectFit</span>(<span class="hljs-title class_">ImageFit</span>.<span class="hljs-property">Fill</span>)
              .<span class="hljs-title function_">width</span>(item.<span class="hljs-property">imgWidth</span>)
              .<span class="hljs-title function_">height</span>(item.<span class="hljs-property">imgHeight</span>)
              .<span class="hljs-title function_">scale</span>({
                <span class="hljs-attr">x</span>: item.<span class="hljs-property">scale</span>,
                <span class="hljs-attr">y</span>: item.<span class="hljs-property">scale</span>,
              })
              .<span class="hljs-title function_">translate</span>({
                <span class="hljs-attr">x</span>: item.<span class="hljs-property">translateX</span> + item.<span class="hljs-property">translateCenterX</span>,
                <span class="hljs-attr">y</span>: item.<span class="hljs-property">translateY</span> + item.<span class="hljs-property">translateCenterY</span>
              })
          }
          .<span class="hljs-title function_">width</span>(<span class="hljs-variable constant_">ONE_HUNDRED_PERCENT</span>)
          .<span class="hljs-title function_">height</span>(<span class="hljs-variable constant_">ONE_HUNDRED_PERCENT</span>)
          .<span class="hljs-title function_">gestureModifier</span>(item.<span class="hljs-property">modifier</span>)
          .<span class="hljs-title function_">clip</span>(<span class="hljs-literal">true</span>)
        }, <span class="hljs-function">(<span class="hljs-params">item: MediaParams, index: number</span>) =&gt;</span> {
          <span class="hljs-keyword">return</span> item.<span class="hljs-property">url</span> + <span class="hljs-string">'_'</span> + index + <span class="hljs-string">'_'</span> + item.<span class="hljs-property">imgWidth</span> + <span class="hljs-string">'_'</span> + item.<span class="hljs-property">imgHeight</span>;
        })
      }
      .<span class="hljs-title function_">index</span>(params.<span class="hljs-property">index</span>)
      .<span class="hljs-title function_">loop</span>(<span class="hljs-literal">false</span>)
      .<span class="hljs-title function_">indicator</span>(<span class="hljs-literal">false</span>)
      .<span class="hljs-title function_">autoPlay</span>(<span class="hljs-literal">false</span>)
      .<span class="hljs-title function_">width</span>(<span class="hljs-variable constant_">ONE_HUNDRED_PERCENT</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-variable constant_">ONE_HUNDRED_PERCENT</span>)
      .<span class="hljs-title function_">disableSwipe</span>(params.<span class="hljs-property">disabledSwiper</span>)
      .<span class="hljs-title function_">onChange</span>(<span class="hljs-function">(<span class="hljs-params">index: number</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> current = params.<span class="hljs-property">mediaData</span>[params.<span class="hljs-property">index</span>];
        <span class="hljs-title function_">resetImage</span>(current);
        params.<span class="hljs-property">index</span> = index;
        params.<span class="hljs-property">isFullScreen</span> = <span class="hljs-literal">false</span>;
        params.<span class="hljs-property">disabledSwiper</span> = <span class="hljs-literal">false</span>;
        params.<span class="hljs-property">isDetermined</span> = <span class="hljs-literal">false</span>;
        params.<span class="hljs-property">shouldMovePic</span> = <span class="hljs-literal">false</span>;
        params.<span class="hljs-title function_">update</span>();
      })

      <span class="hljs-keyword">if</span> (!params.<span class="hljs-property">isFullScreen</span>) {
        <span class="hljs-title class_">MediaNavigation</span>(params)
      }
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-variable constant_">ONE_HUNDRED_PERCENT</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-variable constant_">ONE_HUNDRED_PERCENT</span>)
    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable constant_">BLACK_COLOR</span>)
    .<span class="hljs-title function_">transition</span>(
      <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">asymmetric</span>(
        <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">opacity</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">combine</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">scale</span>({
          <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
          <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>
        })).<span class="hljs-title function_">animation</span>({
          <span class="hljs-attr">duration</span>: <span class="hljs-variable constant_">DURATION_200</span>
        }),
        <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">opacity</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">combine</span>(<span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-title function_">scale</span>({
          <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
          <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>
        })).<span class="hljs-title function_">animation</span>({
          <span class="hljs-attr">duration</span>: <span class="hljs-variable constant_">DURATION_200</span>
        }),
      ))
    .<span class="hljs-title function_">gestureModifier</span>(
      params.<span class="hljs-property">mediaData</span>[params.<span class="hljs-property">index</span>] <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MediaParams</span> ?
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageGestureModifierGlobal</span>(params.<span class="hljs-property">mediaData</span>[params.<span class="hljs-property">index</span>] <span class="hljs-keyword">as</span> <span class="hljs-title class_">MediaParams</span>) : <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmptyModifierGlobal</span>()
    )
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title class_">Column</span>() {

    }.<span class="hljs-title function_">onAppear</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// TransitionEffect 的退场动销无法触发onFinish、使用animateTo触发</span>
      <span class="hljs-title function_">animateTo</span>({
        <span class="hljs-attr">duration</span>: <span class="hljs-variable constant_">DURATION_200</span>,
        <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> {
          params.<span class="hljs-title function_">close</span>(<span class="hljs-literal">true</span>);
        }
      }, <span class="hljs-function">() =&gt;</span> {
      })
    })
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaDialogUtil</span> {
  private <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
  }

  public <span class="hljs-keyword">static</span> <span class="hljs-title function_">openDialog</span>(<span class="hljs-attr">data</span>: <span class="hljs-title class_">MediaParams</span>[]): <span class="hljs-keyword">void</span> {
    <span class="hljs-keyword">const</span> context = (<span class="hljs-title function_">getContext</span>()) <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>
    <span class="hljs-keyword">const</span> mainWin = context.<span class="hljs-property">windowStage</span>.<span class="hljs-title function_">getMainWindowSync</span>()
    <span class="hljs-keyword">const</span> uiContext = mainWin.<span class="hljs-title function_">getUIContext</span>()
    <span class="hljs-keyword">const</span> promptAction = uiContext.<span class="hljs-title function_">getPromptAction</span>();
    <span class="hljs-keyword">const</span> screenWidth = <span class="hljs-title function_">px2vp</span>(display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">width</span>)
    <span class="hljs-keyword">const</span> screenHeight = <span class="hljs-title function_">px2vp</span>(display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">height</span>)
    <span class="hljs-keyword">const</span> dialogParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MediaDialogParams</span>(
      data,
      <span class="hljs-function">(<span class="hljs-params">immediate = <span class="hljs-literal">false</span></span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (immediate) { <span class="hljs-comment">// 立马关闭</span>
          promptAction.<span class="hljs-title function_">closeCustomDialog</span>(contentNode);
        } <span class="hljs-keyword">else</span> {
          dialogParams.<span class="hljs-property">isShow</span> = <span class="hljs-literal">false</span>;
          contentNode.<span class="hljs-title function_">update</span>(dialogParams);
        }
      },
      <span class="hljs-function">(<span class="hljs-params">params?: MediaDialogParams</span>) =&gt;</span> {
        contentNode.<span class="hljs-title function_">update</span>(params ?? dialogParams);
      },
      screenWidth,
      screenHeight
    );
    <span class="hljs-comment">// 创建弹窗组件</span>
    <span class="hljs-keyword">const</span> contentNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentContent</span>(
      uiContext,
      <span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">MediaDialog</span>),
      dialogParams
    );
    <span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: promptAction.<span class="hljs-property">BaseDialogOptions</span> = {
      <span class="hljs-attr">alignment</span>: <span class="hljs-title class_">DialogAlignment</span>.<span class="hljs-property">Bottom</span>,
      <span class="hljs-attr">isModal</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">autoCancel</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">maskColor</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">Transparent</span>,
      <span class="hljs-attr">transition</span>: <span class="hljs-title class_">TransitionEffect</span>.<span class="hljs-property">IDENTITY</span>
    }
    promptAction.<span class="hljs-title function_">openCustomDialog</span>(contentNode, options);
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在仿真优化项目里的数据库选型，OpenTeleDB的Xstore存储引擎应用]]></title>    <link>https://juejin.cn/post/7605041451329110059</link>    <guid>https://juejin.cn/post/7605041451329110059</guid>    <pubDate>2026-02-11T05:41:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605041451329110059" data-draft-id="7605051886434959423" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在仿真优化项目里的数据库选型，OpenTeleDB的Xstore存储引擎应用"/> <meta itemprop="keywords" content="后端,PostgreSQL,SQL"/> <meta itemprop="datePublished" content="2026-02-11T05:41:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="静Yu"/> <meta itemprop="url" content="https://juejin.cn/user/2225839800062215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在仿真优化项目里的数据库选型，OpenTeleDB的Xstore存储引擎应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225839800062215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    静Yu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T05:41:55.000Z" title="Wed Feb 11 2026 05:41:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在做一个项目是关于仿真优化业务的，项目背景是在系统中搭建仿真工作流，工作流会调用各种优化算法进行计算，每个任务的计算会产生大量的中间结果写入数据库中，而且每个任务会多次修改参数重新提交，就会多次大量的更新数据库的数据。</p>
<p>👉 <strong>这是一个 UPDATE 远多于 INSERT 的系统</strong></p>
<p>问题：“大量中间数据 + 反复重算 + 高频 UPDATE”，可能会出现的问题就是系统经过一段时间的运行，大量的数据导致磁盘被占满的问题。</p>
<p>解决方法：与同事讨论后一致决定，将计算结果数据表与其余业务表分开，并部署到不同的服务器上。这还不能解决根本问题，如果依旧采用PostgreSQL数据库依旧会出现存储空间持续膨胀，以及性能波动问题。这时我们就把目光瞄准了OpenTeleDB，他的Xstore存储引擎完美的解决了这些问题。</p>
<blockquote>
<p>OpenTeleDB通过XStore存储引擎对存储层进行全链路重构：通过原位更新与Undo日志管理，从根本杜绝空间膨胀，表空间占用几乎零增长；同时对索引采用原位更新，彻底告别扫表式Vacuum，将执行TPCC模型时性能波动压制在5%以内。</p>
</blockquote>
<p><strong>下面是我的一些验证测试流程。</strong></p>
<h3 data-id="heading-0">数据库安装</h3>
<p>关于OpenTeleDB的安装教程网上有很多，我就不过多赘述了。</p>
<p>数据库安装主要分为以下几步，部署也相对简单：</p>
<ol>
<li>安装一些必要的依赖</li>
<li>源码下载</li>
<li>编译安装</li>
<li>初始化数据库</li>
<li>启动数据库</li>
</ol>
<p>最终通过命令启动数据库，如果出现server started的字样则证明数据库服务启动成功。</p>
<pre><code class="hljs language-bash" lang="bash">安装目录/bin/pg_ctl -D 安装目录/data start
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2599da2acd5c418b90d84e819da22cb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=132BVUlq3b%2FjVPxB9k%2F%2BUGdNR3Y%3D" alt="" loading="lazy"/></p>
<p>启动之后也可以<code>ps uxf | grep postgres</code> 命令用于查看 OpenTeleDB 数据库相关的所有进程</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b758c8e0ecc4f80b9d7c3d3be30f5f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=E95roZQDXQuT7FfSd2Vbn6YSHv4%3D" alt="" loading="lazy"/></p>
<p><strong>在测试过程中遇到的问题：</strong></p>
<p>1.OpenTeleDB默认的监听地址是 localhost,只允许本地连接</p>
<p>我的服务和数据库不在同一台服务器，需要修改一下配置允许通过ip访问。</p>
<p>需要修改/openteledb/data/下的postgresql.conf文件中的</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">listen_addresses</span> = <span class="hljs-string">'localhost'</span>      <span class="hljs-comment"># what IP address(es) to listen on;</span>
<span class="hljs-comment"># 修改为</span>
<span class="hljs-attr">listen_addresses</span> = <span class="hljs-string">'*'</span>      <span class="hljs-comment"># what IP address(es) to listen on; </span>
</code></pre>
<p>修改完成之后，可以通过<code>ss -lntp | grep 5432</code>验证是否生效，如果是0.0.0.0就代表允许外部ip访问。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ec20a832b4a4d819d2dd56299c799fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=kc9NkeUfT0LXDTQiEs%2BBigMvBIo%3D" alt="" loading="lazy"/></p>
<p>2.FATAL: no pg_hba.conf entry for host "192.168.1.102", user "postgres", database "postgres", no encryption</p>
<p>这个错误表明 PostgreSQL 在 <code>pg_hba.conf</code> 配置文件中没有为 IP 地址 <code>192.168.1.102</code> 配置访问权限，导致无法建立数据库连接。</p>
<p>需要修改 <code>pg_hba.conf</code> 配置文件，添加一条允许连接的规则。</p>
<pre><code class="hljs language-css" lang="css">host    <span class="hljs-attribute">all</span>    <span class="hljs-attribute">all</span>    <span class="hljs-number">192.168</span>.<span class="hljs-number">1.102</span>/<span class="hljs-number">32</span>    md5
</code></pre>
<p>修复了上述的两个问题之后，我就可以在另外一台服务器上连接到数据库。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/158bc830f500425187106b41d285598c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=tvG6PCwlLLrTjPg7%2FbmMQgg5iLY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">测试过程</h3>
<p>现在来模拟一下我的业务场景，通过SQL模拟一个优化算法来生成大量的中间结果数据.为了验证Xstore在表空间膨胀的表现，测试过程中我创建了两张表，一张是正常创建的数据库表(optimization_results_indexed)，另外一张是使用Xstore引擎创建的数据库表(optimization_results_indexed_xstore)。</p>
<p>在进行测试过程之前，我们先确认一下<code>Xstore</code> 扩展已正常启用。</p>
<pre><code class="hljs language-sql" lang="sql">\dx

<span class="hljs-comment">-- 显式启用 xstore 扩展</span>
<span class="hljs-keyword">CREATE</span> EXTENSION IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> xstore;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/163714a78b6948c28809e60c8420d484~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=3McLk4IEM8PgLAZ78HtJ8SJCdJE%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-2">生成库表</h5>
<p>我首先要做的是实现一个SQL语句，确保数据库中存在一个用于存储优化结果的表。具体来说，下面这段SQL会检查并创建一个名为 optimization_results_indexed 或 optimization_results_indexed_xstore 的表，表结构设计用于存储优化算法的执行结果。表包括以下字段：</p>
<p><code>algorithm_name</code>：存储算法名称。</p>
<p><code>execution_index</code>：标识算法执行的编号。</p>
<p><code>best_solution</code>：保存算法的最佳解决方案。</p>
<p><code>best_score</code>：记录最佳解决方案的得分。</p>
<p><code>iteration_count</code>：表示算法执行的迭代次数。</p>
<p><code>last_updated</code>：自动记录表中的数据最后更新时间。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> optimization_results_indexed (
    algorithm_name   <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    execution_index  <span class="hljs-type">INT</span>,
    best_solution    TEXT,
    best_score       <span class="hljs-type">DOUBLE PRECISION</span>,
    iteration_count  <span class="hljs-type">INT</span>,
    last_updated     <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (algorithm_name, execution_index)
);
<span class="hljs-operator">/</span><span class="hljs-operator">/</span>Xstore存储引擎
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> optimization_results_indexed_xstore (
    algorithm_name   <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    execution_index  <span class="hljs-type">INT</span>,
    best_solution    TEXT,
    best_score       <span class="hljs-type">DOUBLE PRECISION</span>,
    iteration_count  <span class="hljs-type">INT</span>,
    last_updated     <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (algorithm_name, execution_index)
) <span class="hljs-keyword">USING</span> xstore;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c9f619399e24853b697b2033a778e82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=qF%2FlD6Adhq%2F16IfM0ySgzIDPE6Y%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69540abbfa6f4e508517ca5ca3467bc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=3CcnXgqMCbCouFPOHYdn8EaEjc0%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-3">首次插入</h5>
<p>生成了数据库表之后，就开始首次插入第一波模拟数据，分别在两张表中插入数据。</p>
<p>这条 SQL 语句的目的是向 <code>optimization_results_indexed</code> 和<code>optimization_results_indexed_xstore</code>表中插入 20,000 条模拟数据记录，模拟一个梯度下降优化算法的执行结果。在插入的过程中，首先为每一条记录指定了一个静态的算法名称 <code>'gradient_descent'</code>，并通过 <code>generate_series(1, 20000)</code> 函数生成从 1 到 20,000 的整数序列，用作每条记录的 <code>execution_index</code>。接着，为 <code>best_solution</code> 字段设置了一个固定的 JSON 格式字符串 <code>{"x": 1.23, "y": 4.56}</code>，代表每次优化算法得到的最佳解决方案。在 <code>best_score</code> 字段中，使用 <code>random() * 100</code> 生成一个介于 0 到 100 之间的随机分数，模拟每次优化过程中的得分。<code>iteration_count</code> 字段则通过 <code>(random() * 1000)::INT</code> 生成一个介于 0 到 1000 之间的随机整数，代表每次优化算法的迭代次数。最后，<code>last_updated</code> 字段被赋予当前时间戳 <code>CURRENT_TIMESTAMP</code>，表示每条记录的更新时间。整个查询语句将这 20,000 条记录插入到表中，用于模拟大量的优化算法执行结果和测试。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">INSERT <span class="hljs-keyword">INTO</span> optimization_results_indexed (
    algorithm_name,
    execution_index,
    best_solution,
    best_score,
    iteration_count,
    last_updated
)
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-comment">'gradient_descent'               AS algorithm_name,</span>
    gs                               <span class="hljs-keyword">AS</span> execution_index,
    <span class="hljs-comment">'{"x": 1.23, "y": 4.56}'          AS best_solution,</span>
    random() * <span class="hljs-number">100</span>                   <span class="hljs-keyword">AS</span> best_score,
    (random() * <span class="hljs-number">1000</span>)::INT           <span class="hljs-keyword">AS</span> iteration_count,
    CURRENT_TIMESTAMP
<span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">20000</span>) <span class="hljs-keyword">AS</span> gs;

//Xstore存储引擎
INSERT <span class="hljs-keyword">INTO</span> optimization_results_indexed_xstore (
    algorithm_name,
    execution_index,
    best_solution,
    best_score,
    iteration_count,
    last_updated
)
<span class="hljs-keyword">SELECT</span>
    <span class="hljs-comment">'gradient_descent'               AS algorithm_name,</span>
    gs                               <span class="hljs-keyword">AS</span> execution_index,
    <span class="hljs-comment">'{"x": 1.23, "y": 4.56}'          AS best_solution,</span>
    random() * <span class="hljs-number">100</span>                   <span class="hljs-keyword">AS</span> best_score,
    (random() * <span class="hljs-number">1000</span>)::INT           <span class="hljs-keyword">AS</span> iteration_count,
    CURRENT_TIMESTAMP
<span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">20000</span>) <span class="hljs-keyword">AS</span> gs;
</code></pre>
<p>执行完上面的代码后，打开数据库可视化操作工具，确认一下数据是否成功插入。可以看到，数据库中已经有了模拟生成的中间数据了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85a38f2448864d1a9b1e5acf9fc2343f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=7jBLwXumtKydOoFPRLnJmEbIZPU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9c7415099d44984b8d23f4d5889b4a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=xLmcbw5MKk19cMhUdHoDbQpj2Q4%3D" alt="" loading="lazy"/></p>
<p>通过SELECT语句查询了一下表中的数据总条数。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> optimization_results_indexed;

<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> optimization_results_indexed_xstore;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d160039a38b1457faa982a037590d19a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=j9pOti%2BUd03HfpPBEaTGgb%2F7vbw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28f4b919c0784105b2edab88041c244f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=2sDPxi1LK3VOE4Jt79Od3zY5p8Y%3D" alt="" loading="lazy"/></p>
<p>我的目的是为了验证多次更新海量数据，Xstore存储引擎在表空间膨胀方面的表现。所以执行完第一次优化算法之后，先去查一下两张表所占存储大小。</p>
<p>然后再通过命令查询一下optimization_results_indexed和optimization_results_indexed_xstore这两张表的存储大小，我们可以清晰的看到20000条数据分别所占用2016kB、2008kB大小，相差不大。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">SELECT <span class="hljs-title">pg_size_pretty</span><span class="hljs-params">(pg_table_size(<span class="hljs-string">'optimization_results_indexed'</span>))</span></span>;

<span class="hljs-function">SELECT <span class="hljs-title">pg_size_pretty</span><span class="hljs-params">(pg_table_size(<span class="hljs-string">'optimization_results_indexed_xstore'</span>))</span></span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/017c4b60f30545f3a3b0d2493bf7a41a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=rkpITyBeBw0XiI7Zl7jBTdcZlw4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/978e9b463b474869a8e2f6096675ba98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=ab%2BzaVZsQLtTQnhG9DRNOOKxrUU%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-4">更新数据</h5>
<p>为了验证OpenTeleDB的Xstore存储引擎在原位更新和表膨胀两个点的表现，现在实现一个更新SQL。</p>
<p>这条 SQL 语句用于更新 <code>optimization_results_indexed</code> 或<code>optimization_results_indexed_xstore</code> 表中 <code>algorithm_name</code> 为 <code>'gradient_descent'</code> 且 <code>execution_index</code> 在 1 到 20,000 之间的记录。更新内容包括：将 <code>best_solution</code> 字段设置为新的随机值（以 JSON 格式表示的 <code>x</code> 和 <code>y</code> 坐标），<code>best_score</code> 字段更新为一个新的随机分数（0 到 100 之间），<code>iteration_count</code> 字段增加一个随机整数（0 到 10 之间），并且将 <code>last_updated</code> 字段设置为当前时间戳。</p>
<pre><code class="hljs language-ini" lang="ini">UPDATE optimization_results_indexed
SET
    <span class="hljs-attr">best_solution</span>   = format(<span class="hljs-string">'{"x": %s, "y": %s}'</span>,
                              to_char(random(), 'FM999999999.0000'),
                              to_char(random(), 'FM999999999.0000')),
    <span class="hljs-attr">best_score</span>      = random() * <span class="hljs-number">100</span>,
    <span class="hljs-attr">iteration_count</span> = iteration_count + (random() * <span class="hljs-number">10</span>)::INT,
    <span class="hljs-attr">last_updated</span>    = CURRENT_TIMESTAMP
WHERE <span class="hljs-attr">algorithm_name</span> = <span class="hljs-string">'gradient_descent'</span>
  AND execution_index IN (
      SELECT generate_series(1, 20000)
  )<span class="hljs-comment">;</span>
  
//Xstore存储引擎 
UPDATE optimization_results_indexed_xstore
SET
    <span class="hljs-attr">best_solution</span>   = format(<span class="hljs-string">'{"x": %s, "y": %s}'</span>,
                              to_char(random(), 'FM999999999.0000'),
                              to_char(random(), 'FM999999999.0000')),
    <span class="hljs-attr">best_score</span>      = random() * <span class="hljs-number">100</span>,
    <span class="hljs-attr">iteration_count</span> = iteration_count + (random() * <span class="hljs-number">10</span>)::INT,
    <span class="hljs-attr">last_updated</span>    = CURRENT_TIMESTAMP
WHERE <span class="hljs-attr">algorithm_name</span> = <span class="hljs-string">'gradient_descent'</span>
  AND execution_index IN (
      SELECT generate_series(1, 20000)
  )<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9095c04f1d347ddb6f7488742f40474~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=3byWDPY1HAOepK1sTx5t5oHu5bI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9624e15399f44df88738a6798270acc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=oKVgIKCAvbsYVx6n5h2X%2FEoM6lA%3D" alt="" loading="lazy"/></p>
<p>首先进行一次之后，我又重新查询了表空间的大小。可以看到两张表的空间都有一定的增加。其中每次优化算法产生的数据完全不一致，这很可能也是导致表增长的原因。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f38bd9b6633470e8551d44fd6006d96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=jyyeNUikaDviNGHobUkEVOXnsV4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf6e66906f29498cacb9745eac261ad2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=%2BFp63xR972nPEqtQJi1JRiKQ2WU%3D" alt="" loading="lazy"/></p>
<p>这只更新了一次，并不能说明什么问题，我要验证的是高频UPDATE。现在我再执行几次更新看看效果。</p>
<p>可以发现正常方式创建的表，表空间还是会一直增长的，然后我就一直执行一直执行，直到执行了三十次之后，数据表空间竟然达到了27MB。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01c7d2b1847846d4a01300f8c2f7a0b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=f0VATApOk1256dTR%2F63pinbD2UI%3D" alt="" loading="lazy"/></p>
<p>然后我又用同样的方式对<code>optimization_results_indexed_xstore</code>执行了同样的三十次覆盖式更新操作。我惊喜的发现，表空间依旧是第一次更新之后的3800kB。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb128502b59044e096970de8551ea89b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2ZWXU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771393323&amp;x-signature=LORfRz%2Bj%2FtP5TkPX9jWkJoeWRSE%3D" alt="" loading="lazy"/></p>
<p>经过真实测试，答案已经显而易见了,Xstore存储引擎的原位更新真的做到了表空间几乎零增长。</p>

























<table><thead><tr><th/><th><code>optimization_results_indexed</code></th><th><code>optimization_results_indexed_xstore</code></th></tr></thead><tbody><tr><td>第一次插入数据</td><td>2016kB</td><td>2008kB</td></tr><tr><td>第一次更新数据</td><td>4152kB</td><td>3800kB</td></tr><tr><td>更新30次数据</td><td>27MB</td><td>3800kB</td></tr></tbody></table>
<h3 data-id="heading-5">结尾</h3>
<p>说白了，这次测试一圈下来，Xstore 确实挺能“扛”的。我们这种反复更新、数据量大的业务，最怕的就是表一直膨胀，最后磁盘爆满、性能下滑。用 Xstore 之后，第一次更新虽然也会涨一点，但后面不管怎么频繁改数据，表大小基本就稳住了，再也没往上跑。对我们来说，这就是最实在的解决方案——不用总担心空间问题，也不用老想着扩容服务器。</p>
<p>如果你也在做仿真优化、实时计算、频繁迭代这类“写多改多”的系统，并且被 PostgreSQL 的：</p>
<ul>
<li>表空间不断膨胀</li>
<li>VACUUM 压力大、性能波动</li>
<li>磁盘很快被中间数据占满</li>
</ul>
<p>这类问题困扰，那么 OpenTeleDB + Xstore 存储引擎 是一个值得认真考虑的选项。 它不是“魔法”，但通过原位更新和优化的 UNDO 管理，实实在在地解决了高频更新场景下的存储膨胀问题。</p>
<h5 data-id="heading-6">如果你打算尝试，可以顺着这个思路走：</h5>
<ol>
<li>
<p><strong>判断是否适用</strong> 如果你的业务是：UPDATE 远多于 INSERT、中间数据多、同一批数据反复重算、不想频繁清理或拆表。 如果你的痛点是：表膨胀快、VACUUM 影响性能、存储成本增长明显。 那 Xstore 很可能对你有用。</p>
</li>
<li>
<p><strong>使用很简单，就两步</strong></p>
<ol>
<li>建表时加一句 <code>USING xstore</code></li>
<li>确保数据库里启用了 <code>xstore</code> 扩展（<code>CREATE EXTENSION IF NOT EXISTS xstore;</code>） 其他代码、查询基本不用改，对应用透明。</li>
</ol>
</li>
<li>
<p><strong>没必要全库换</strong> 只针对那种更新极度频繁的表使用 Xstore，其他普通表还是用原来的存储方式。这样既能解决痛点，也不引入不必要的复杂度。</p>
</li>
</ol>
<p>技术选型没有最好的，但如果有某个特性正好对准你的业务痛点，那就值得一试。</p>
<p>Xstore 对我们这种“反复算、反复写”的场景来说，真的算是“对症下药”了。</p>
<p>如果你也遇到了类似的数据膨胀困扰，不妨搭个测试环境跑一跑，用真实数据验证一下，毕竟适合自己的才是最好的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端都能看懂的Rust入门教程（四）——struct和trait]]></title>    <link>https://juejin.cn/post/7605105527258365952</link>    <guid>https://juejin.cn/post/7605105527258365952</guid>    <pubDate>2026-02-11T07:03:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605105527258365952" data-draft-id="7605107459066298414" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端都能看懂的Rust入门教程（四）——struct和trait"/> <meta itemprop="keywords" content="Rust,前端,后端"/> <meta itemprop="datePublished" content="2026-02-11T07:03:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="布列瑟农的星空"/> <meta itemprop="url" content="https://juejin.cn/user/976022056218471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端都能看懂的Rust入门教程（四）——struct和trait
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022056218471/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    布列瑟农的星空
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:03:41.000Z" title="Wed Feb 11 2026 07:03:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    25
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本节介绍Rust中的struct和trait。</p>
<p>这两者类似js或java中的class和interface，但概念上并不等同。可以用三句话概括Rust中的struct和trait设计理念：sturct主要关注数据的组织，trait主要关注行为的抽象，组合优于继承。</p>
<h2 data-id="heading-0">struct（结构体）</h2>
<p>Struct 是 Rust 中定义自定义数据类型的主要方式，它允许你将多个相关的值组合在一起，形成一个有意义的组合。</p>
<h3 data-id="heading-1">1. <strong>基本定义和使用</strong></h3>
<h4 data-id="heading-2">定义结构体</h4>
<p>使用 <code>struct</code> 关键字后跟结构体名称，接着用花括号 <code>{}</code> 包裹字段声明。每个字段都需要指定类型。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 定义一个结构体</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span> {
    username: <span class="hljs-type">String</span>,
    email: <span class="hljs-type">String</span>,
    sign_in_count: <span class="hljs-type">u64</span>,
    active: <span class="hljs-type">bool</span>,
}
</code></pre>
<h4 data-id="heading-3">创建实例和访问属性</h4>
<p>使用结构体名称后跟带有初始化值的花括号 <code>{}</code> 来创建实例，每个字段必须被显式地赋予一个值。</p>
<p>使用 <code>pub</code> 关键字可以控制结构体及其字段的可见性。默认情况下，结构体和其字段是模块内部可见的。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 创建结构体实例</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">user1</span> = User {
        email: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"someone@example.com"</span>),
        <span class="hljs-keyword">pub</span> username: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"someusername123"</span>),
        active: <span class="hljs-literal">true</span>,
        sign_in_count: <span class="hljs-number">1</span>,
    };
    
    <span class="hljs-comment">// 访问字段</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"用户名: {}"</span>, user1.username);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"邮箱: {}"</span>, user1.email);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"活跃状态: {}"</span>, user1.active);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"登录次数: {}"</span>, user1.sign_in_count);
    
    <span class="hljs-comment">// 修改字段（需要 mut）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">user2</span> = User {
        email: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"another@example.com"</span>),
        username: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"anotheruser"</span>),
        active: <span class="hljs-literal">true</span>,
        sign_in_count: <span class="hljs-number">0</span>,
    };
    
    user2.sign_in_count = <span class="hljs-number">1</span>;  <span class="hljs-comment">// 可以修改</span>
    user2.active = <span class="hljs-literal">false</span>;
}
</code></pre>
<h3 data-id="heading-4">2. <strong>结构体更新语法</strong></h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 使用已有实例创建新实例</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">user3</span> = User {
    email: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"third@example.com"</span>),
    username: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"thirduser"</span>),
    ..user1  <span class="hljs-comment">// 使用 user1 的其他字段值</span>
};

<span class="hljs-comment">// 等价于：</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">user4</span> = User {
    email: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"fourth@example.com"</span>),
    username: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"fourthuser"</span>),
    active: user1.active,
    sign_in_count: user1.sign_in_count,
};
</code></pre>
<h3 data-id="heading-5">3. <strong>元组结构体</strong></h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 元组结构体：有名字的元组</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Color</span>(<span class="hljs-type">i32</span>, <span class="hljs-type">i32</span>, <span class="hljs-type">i32</span>);
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Point</span>(<span class="hljs-type">i32</span>, <span class="hljs-type">i32</span>, <span class="hljs-type">i32</span>);

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">black</span> = <span class="hljs-title function_ invoke__">Color</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">origin</span> = <span class="hljs-title function_ invoke__">Point</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 通过索引访问</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"黑色的红色分量: {}"</span>, black.<span class="hljs-number">0</span>);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"原点的 x 坐标: {}"</span>, origin.<span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 即使字段类型相同，也是不同的类型</span>
    <span class="hljs-comment">// let color_point: Color = origin;  // 错误！类型不匹配</span>
}
</code></pre>
<h3 data-id="heading-6">4. impl方法定义</h3>
<p>上面的结构体更接近js中的interface，其本身只定义结构而无实现，因此也无法使用new来创建实例。</p>
<p>在Rust中要通过new创建实例，就需要对该结构体实现构造函数。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 定义一个Person结构体</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Person</span> {
    name: <span class="hljs-type">String</span>,
    age: <span class="hljs-type">u32</span>,
}

<span class="hljs-comment">// 为Person实现构造函数</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(name: <span class="hljs-type">String</span>, age: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> Person {
        Person { name, age }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 使用new方法创建一个Person实例</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">person</span> = Person::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">"Alice"</span>.<span class="hljs-title function_ invoke__">to_string</span>(), <span class="hljs-number">30</span>);
    
    <span class="hljs-comment">// 访问结构体的字段</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Name: {}, Age: {}"</span>, person.name, person.age);
}
</code></pre>
<h4 data-id="heading-7">使用 <code>impl</code> 块定义结构体静态方法和成员方法</h4>
<p>通过<code>impl</code>块为结构体定义方法时，可以根据方法的第一个参数是否为<code>&amp;self</code>或<code>&amp;mut self</code>来区分静态方法和成员方法。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rectangle</span> {
    width: <span class="hljs-type">u32</span>,
    height: <span class="hljs-type">u32</span>,
}

<span class="hljs-comment">// 为 Rectangle 实现方法</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Rectangle</span> {
    <span class="hljs-comment">// 关联函数（类似静态方法）</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">square</span>(size: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> Rectangle {
        Rectangle {
            width: size,
            height: size,
        }
    }
    
    <span class="hljs-comment">// 方法：第一个参数是 self</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">area</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> {
        <span class="hljs-keyword">self</span>.width * <span class="hljs-keyword">self</span>.height
    }
    
    <span class="hljs-comment">// 可变方法</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">double</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
        <span class="hljs-keyword">self</span>.width *= <span class="hljs-number">2</span>;
        <span class="hljs-keyword">self</span>.height *= <span class="hljs-number">2</span>;
    }
    
  
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">can_hold</span>(&amp;<span class="hljs-keyword">self</span>, other: &amp;Rectangle) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span> {
        <span class="hljs-keyword">self</span>.width &gt; other.width &amp;&amp; <span class="hljs-keyword">self</span>.height &gt; other.height
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect1</span> = Rectangle {
        width: <span class="hljs-number">30</span>,
        height: <span class="hljs-number">50</span>,
    };
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"面积: {}"</span>, rect1.<span class="hljs-title function_ invoke__">area</span>());
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">rect2</span> = Rectangle {
        width: <span class="hljs-number">10</span>,
        height: <span class="hljs-number">40</span>,
    };
    
    rect2.<span class="hljs-title function_ invoke__">double</span>();
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"加倍后的面积: {}"</span>, rect2.<span class="hljs-title function_ invoke__">area</span>());
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"rect1 能包含 rect2 吗? {}"</span>, rect1.<span class="hljs-title function_ invoke__">can_hold</span>(&amp;rect2));
    
    <span class="hljs-comment">// 调用关联函数</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">square</span> = Rectangle::<span class="hljs-title function_ invoke__">square</span>(<span class="hljs-number">10</span>);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"正方形的面积: {}"</span>, square.<span class="hljs-title function_ invoke__">area</span>());
}
</code></pre>
<h3 data-id="heading-8">5. <strong>多个 <code>impl</code> 块</strong></h3>
<p>在Rust中，struct可以有多个impl块，这带来了几个好处：</p>
<ol>
<li><strong>灵活性</strong>：可以在不同的地方、不同的模块中为同一个struct添加方法。例如，可以在定义struct的同一个文件中添加多个impl块，也可以在不同的文件中为struct实现方法（前提是struct和trait在同一个crate中，或者满足孤儿规则）。</li>
<li><strong>组织代码</strong>：可以将相关的方法分组到不同的impl块中，提高代码的可读性。例如，可以将实现某个trait的方法放在一个impl块中，而将struct自身的方法放在另一个impl块中。</li>
<li><strong>条件编译</strong>：可以为不同的编译条件提供不同的实现。例如，可以使用<code>#[cfg(target_os = "linux")]</code>属性为Linux系统提供特定的实现，而将其他系统的实现放在另一个impl块中。</li>
<li><strong>泛型特化</strong>：虽然Rust目前不支持完整的泛型特化，但通过多个impl块可以为不同的泛型参数提供不同的实现。例如，可以为某些特定的类型提供优化的实现。</li>
<li><strong>扩展性</strong>：可以在不修改原有impl块的情况下，为struct添加新的方法。这在编写库代码时尤其有用，因为可以在后续的版本中添加新的方法而不会破坏现有的代码。</li>
<li><strong>实现多个trait</strong>：每个trait的实现通常放在独立的impl块中，这样结构清晰，易于管理。</li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Counter</span> {
    count: <span class="hljs-type">u32</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> Counter {
        Counter { count: <span class="hljs-number">0</span> }
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">increment</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) {
        <span class="hljs-keyword">self</span>.count += <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">current</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> {
        <span class="hljs-keyword">self</span>.count
    }
}
</code></pre>
<p><strong>注：多个impl块并不意味着同一个方法可以有不同的实现（即不允许重复定义相同签名的方法）。每个方法在一个struct中只能有一个实现。</strong></p>
<h3 data-id="heading-9">6. 泛型结构体</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 泛型结构体</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Point</span>&lt;T&gt; {
    x: T,
    y: T,
}

<span class="hljs-comment">// 为泛型结构体实现方法</span>
<span class="hljs-keyword">impl</span>&lt;T&gt; Point&lt;T&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">x</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;T {
        &amp;<span class="hljs-keyword">self</span>.x
    }
}

<span class="hljs-comment">// 可以为特定类型实现特定方法</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Point</span>&lt;<span class="hljs-type">f32</span>&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">distance_from_origin</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f32</span> {
        (<span class="hljs-keyword">self</span>.x.<span class="hljs-title function_ invoke__">powi</span>(<span class="hljs-number">2</span>) + <span class="hljs-keyword">self</span>.y.<span class="hljs-title function_ invoke__">powi</span>(<span class="hljs-number">2</span>)).<span class="hljs-title function_ invoke__">sqrt</span>()
    }
}

<span class="hljs-comment">// 多个泛型参数</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Pair</span>&lt;T, U&gt; {
    first: T,
    second: U,
}

<span class="hljs-keyword">impl</span>&lt;T, U&gt; Pair&lt;T, U&gt; {
    <span class="hljs-comment">// 关联函数可以返回不同类型的 Pair</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">mixup</span>&lt;V, W&gt;(<span class="hljs-keyword">self</span>, other: Pair&lt;V, W&gt;) <span class="hljs-punctuation">-&gt;</span> Pair&lt;T, W&gt; {
        Pair {
            first: <span class="hljs-keyword">self</span>.first,
            second: other.second,
        }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">integer_point</span> = Point { x: <span class="hljs-number">5</span>, y: <span class="hljs-number">10</span> };
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">float_point</span> = Point { x: <span class="hljs-number">1.0</span>, y: <span class="hljs-number">4.0</span> };
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"整数点的 x: {}"</span>, integer_point.<span class="hljs-title function_ invoke__">x</span>());
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"浮点点的距离: {}"</span>, float_point.<span class="hljs-title function_ invoke__">distance_from_origin</span>());
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">pair1</span> = Pair { first: <span class="hljs-number">5</span>, second: <span class="hljs-number">10.4</span> };
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">pair2</span> = Pair { first: <span class="hljs-string">"Hello"</span>, second: <span class="hljs-string">'c'</span> };
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">mixed</span> = pair1.<span class="hljs-title function_ invoke__">mixup</span>(pair2);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"混合后: {}, {}"</span>, mixed.first, mixed.second); <span class="hljs-comment">// 5, 'c'</span>
}
</code></pre>
<h2 data-id="heading-10">trait（派生）</h2>
<p>Rust中的trait是定义共享行为的一种方式。它类似ts中的interface，但更强大。trait定义了一组方法，这些方法可以被不同类型实现，从而允许不同类型共享相同的行为。</p>
<h2 data-id="heading-11">1. <strong>基本概念</strong></h2>
<h3 data-id="heading-12">定义 Trait</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 定义一个简单的 trait</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">Summary</span> {
    <span class="hljs-comment">// 方法签名（没有默认实现）</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">summarize</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span>;
    
    <span class="hljs-comment">// 方法签名（有默认实现）</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">summarize_short</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
        <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"(Read more...)"</span>)
    }
}
</code></pre>
<h3 data-id="heading-13">实现 Trait</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 为结构体实现 trait</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">NewsArticle</span> {
    <span class="hljs-keyword">pub</span> headline: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> location: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> author: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> content: <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Summary</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">NewsArticle</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">summarize</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
        <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{}, by {} ({})"</span>, <span class="hljs-keyword">self</span>.headline, <span class="hljs-keyword">self</span>.author, <span class="hljs-keyword">self</span>.location)
    }
}

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Tweet</span> {
    <span class="hljs-keyword">pub</span> username: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> content: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> reply: <span class="hljs-type">bool</span>,
    <span class="hljs-keyword">pub</span> retweet: <span class="hljs-type">bool</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Summary</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Tweet</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">summarize</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
        <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{}: {}"</span>, <span class="hljs-keyword">self</span>.username, <span class="hljs-keyword">self</span>.content)
    }
    
    <span class="hljs-comment">// 覆盖默认实现</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">summarize_short</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
        <span class="hljs-built_in">format!</span>(<span class="hljs-string">"Tweet by @{}"</span>, <span class="hljs-keyword">self</span>.username)
    }
}
</code></pre>
<h3 data-id="heading-14">使用 Trait</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">article</span> = NewsArticle {
        headline: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Penguins win the Stanley Cup Championship!"</span>),
        location: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Pittsburgh, PA, USA"</span>),
        author: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Iceburgh"</span>),
        content: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"The Pittsburgh Penguins once again are the best hockey team in the NHL."</span>),
    };
    
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">tweet</span> = Tweet {
        username: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"horse_ebooks"</span>),
        content: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"of course, as you probably already know, people"</span>),
        reply: <span class="hljs-literal">false</span>,
        retweet: <span class="hljs-literal">false</span>,
    };
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Article summary: {}"</span>, article.<span class="hljs-title function_ invoke__">summarize</span>());
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Tweet summary: {}"</span>, tweet.<span class="hljs-title function_ invoke__">summarize</span>());
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Tweet short: {}"</span>, tweet.<span class="hljs-title function_ invoke__">summarize_short</span>());
}
</code></pre>
<h2 data-id="heading-15">2. Trait 作为参数类型</h2>
<h3 data-id="heading-16"><code>impl Trait</code> 语法</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 接受实现了 Summary trait 的类型</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">notify</span>(item: &amp;<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Summary</span>) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Breaking news! {}"</span>, item.<span class="hljs-title function_ invoke__">summarize</span>());
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-title function_ invoke__">notify</span>(&amp;article);
<span class="hljs-title function_ invoke__">notify</span>(&amp;tweet);
</code></pre>
<h3 data-id="heading-17"><code>Trait Bound</code> 语法</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 更明确的写法</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">notify</span>&lt;T: Summary&gt;(item: &amp;T) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Breaking news! {}"</span>, item.<span class="hljs-title function_ invoke__">summarize</span>());
}

<span class="hljs-comment">// 多个 trait bound</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">notify_multiple</span>&lt;T: Summary + Display&gt;(item: &amp;T) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, item);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Summary: {}"</span>, item.<span class="hljs-title function_ invoke__">summarize</span>());
}
</code></pre>
<h2 data-id="heading-18">3. Trait 作为返回值类型</h2>
<h3 data-id="heading-19">返回实现了 Trait 的类型</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 返回实现了 Summary 的类型</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">returns_summarizable</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">Summary</span> {
    Tweet {
        username: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"horse_ebooks"</span>),
        content: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"of course, as you probably already know, people"</span>),
        reply: <span class="hljs-literal">false</span>,
        retweet: <span class="hljs-literal">false</span>,
    }
}
</code></pre>
<h2 data-id="heading-20">组合优于继承</h2>
<p>Rust 语言没有传统面向对象语言中的继承（inheritance）概念，而是推崇组合（composition）和 trait 对象（trait objects）来实现代码复用和多态。</p>
<h3 data-id="heading-21">1. 成员属性组合</h3>
<p>在传统面向对象语言中，使用组合一般通过成员属性来实现，即<code>has-a</code>，这一点在Rust中也一样。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 基本的组合：一个结构体包含另一个结构体</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Engine</span> {
    horsepower: <span class="hljs-type">u32</span>,
    fuel_type: <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Engine</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">start</span>(&amp;<span class="hljs-keyword">self</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"引擎启动，马力: {}"</span>, <span class="hljs-keyword">self</span>.horsepower);
    }
}

<span class="hljs-comment">// Car 包含 Engine，而不是继承自 Engine</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Car</span> {
    brand: <span class="hljs-type">String</span>,
    model: <span class="hljs-type">String</span>,
    engine: Engine,  <span class="hljs-comment">// 组合：Car 有一个 Engine</span>
}
</code></pre>
<h3 data-id="heading-22">2. trai实现多态</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 定义行为接口</span>
<span class="hljs-keyword">trait</span> <span class="hljs-title class_">Drawable</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">draw</span>(&amp;<span class="hljs-keyword">self</span>);
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">area</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f64</span>;
}

<span class="hljs-comment">// 多个类型实现相同的 trait</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Circle</span> {
    radius: <span class="hljs-type">f64</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Drawable</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Circle</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">draw</span>(&amp;<span class="hljs-keyword">self</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"绘制圆形，半径: {}"</span>, <span class="hljs-keyword">self</span>.radius);
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">area</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f64</span> {
        std::<span class="hljs-type">f64</span>::consts::PI * <span class="hljs-keyword">self</span>.radius * <span class="hljs-keyword">self</span>.radius
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Square</span> {
    side: <span class="hljs-type">f64</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Drawable</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Square</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">draw</span>(&amp;<span class="hljs-keyword">self</span>) {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"绘制正方形，边长: {}"</span>, <span class="hljs-keyword">self</span>.side);
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">area</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f64</span> {
        <span class="hljs-keyword">self</span>.side * <span class="hljs-keyword">self</span>.side
    }
}

<span class="hljs-comment">// 使用 trait 对象实现多态</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">render_all</span>(shapes: &amp;[&amp;<span class="hljs-keyword">dyn</span> Drawable]) {
    <span class="hljs-keyword">for</span> <span class="hljs-variable">shape</span> <span class="hljs-keyword">in</span> shapes {
        shape.<span class="hljs-title function_ invoke__">draw</span>();
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"面积: {}"</span>, shape.<span class="hljs-title function_ invoke__">area</span>());
    }
}
</code></pre>
<p>注：<code>dyn Drawable</code>：这是一个 trait 对象，表示任何实现了 <code>Drawable</code> trait 的类型。它是一个动态类型，在编译时不知道具体类型，但知道它实现了 <code>Drawable</code>。`</p>
<h3 data-id="heading-23">3. 使用 derive 自动实现 trait</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 使用 derive 自动实现 trait</span>
<span class="hljs-meta">#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Point</span> {
    x: <span class="hljs-type">i32</span>,
    y: <span class="hljs-type">i32</span>,
}
</code></pre>
<p>注：在Rust中，<code>#[derive(...)]</code>是一种属性（attribute），用于自动为结构体或枚举实现某些trait。这些trait通常是标准库中定义的一些常用trait，通过derive属性，编译器可以自动生成这些trait的实现代码，从而避免手动编写重复的代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Rnd实现自由拖动与边界检测]]></title>    <link>https://juejin.cn/post/7605131777175371839</link>    <guid>https://juejin.cn/post/7605131777175371839</guid>    <pubDate>2026-02-11T07:28:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605131777175371839" data-draft-id="7589052659435700270" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Rnd实现自由拖动与边界检测"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-02-11T07:28:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码云之上"/> <meta itemprop="url" content="https://juejin.cn/user/1319873957601656"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Rnd实现自由拖动与边界检测
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1319873957601656/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码云之上
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:28:30.000Z" title="Wed Feb 11 2026 07:28:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在<code>AI 问答</code>烂大街的今天，只要是个平台都在搞聊天机器人，主要应用场景无非是问答式的“智能”客服。<br/>
笔者所在小团队维护着一个<code>OA</code>系统(技术栈：<code>react17</code> + <code>webpack5.0</code> + <code>tailwindcss</code> + <code>ArcoDesign</code>)，该系统沉淀了很多知识文档，经过后端同学的努力（据说是用了开源框架实现文档的<code>Embedding</code>）将其文档知识化，搭配司内部署的DeepSeek，基本实现了boss要求的智能问答。</p>
<h2 data-id="heading-0">智能问答UI</h2>
<p>因为是内部OA系统，使用者基本是HR小姐姐，她们给的需求基本是一句话描述，哈哈哈，也挺好，方便笔者自由发挥。
参（抄）考（袭）类似平台的交互，决定采用右侧抽屉的形式底部一个输入框，上方展示消息区：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e80c1fce68e145f2a5c265de3894bb09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=83kqaCnidEFVMwZ1yNQ72v5HSNI%3D" alt="Clipboard_Screenshot_1767011782.png" loading="lazy"/></p>
<h2 data-id="heading-1">搞事1.0</h2>
<p><strong>HR小姐姐：</strong> 这个对话框挺好用的，只是固定在页面左侧，能不能像微信一样自由拖动到屏幕其他位置？<br/>
我：额，这是前端页面，全屏幕拖动可实现不了，在当前页面拖动还可以努力一下。<br/>
<strong>HR小姐姐：</strong> 当前页面拖动不就是在显示屏上拖动嘛，有什么区别呢~<br/>
我：额...</p>
<h3 data-id="heading-2">实现</h3>
<p>要拖动是吧，那还不简单，都2025年了，拖动还不是随便找个库就可以打发实现。<br/>
首先想到的便是 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact-dnd.github.io%2Freact-dnd%2Fabout" target="_blank" title="https://react-dnd.github.io/react-dnd/about" ref="nofollow noopener noreferrer">react-dnd</a> ，但是吧，这个库能力很强大，用来做单组件的拖动太杀鸡用牛刀了。而且笔者不喜欢重复以往的方案，喜欢用点新玩意儿。<br/>
继续 Searching，啊哈，还真找着了一个轻量且合适的库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbokuweb%2Freact-rnd" target="_blank" title="https://github.com/bokuweb/react-rnd" ref="nofollow noopener noreferrer">react-rnd</a><br/>
其文档中的例子和契合本次需求：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1e460d3f644a1195e242cf87708cc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=xVTBVBt8pU5gUVfutBILpzrx3Z4%3D" alt="screenshot.gif" loading="lazy"/></p>
<p>说干就干，引入 <code>react-rnd</code>，按照官方文档进行配置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Rnd</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-rnd"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DragForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Rnd</span>
      <span class="hljs-attr">default</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">x:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">y:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">width:</span> <span class="hljs-attr">500</span>,
        <span class="hljs-attr">height:</span> <span class="hljs-attr">190</span>,
      }}
      <span class="hljs-attr">minWidth</span>=<span class="hljs-string">{500}</span>
      <span class="hljs-attr">minHeight</span>=<span class="hljs-string">{190}</span>
      <span class="hljs-attr">bounds</span>=<span class="hljs-string">"window"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"drag__content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">MyForm</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Rnd</span>&gt;</span></span>
  );
}
</code></pre>
<p>优化1完成，交差！</p>
<h2 data-id="heading-3">搞事1.1</h2>
<p><strong>HR小姐姐：</strong> 可以拖动啦，真的很丝滑唉~，能不能支持折叠？有时候我想看页面主体内容但是又不想关掉弹窗，关掉再打开历史记录就没了（当时着急交差，还不支持查看历史会话）。<br/>
好吧，我就知道没那么简单~<br/>
继续优化，折叠嘛，用上 <code>Collapse</code> 组件不就行了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 下面为 demo 代码，使用简易 Form 代替了 Drawer 内容</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DragForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Rnd</span>
      <span class="hljs-attr">default</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">x:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">y:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">width:</span> <span class="hljs-attr">500</span>,
        <span class="hljs-attr">height:</span> <span class="hljs-attr">190</span>,
      }}
      <span class="hljs-attr">minWidth</span>=<span class="hljs-string">{500}</span>
      <span class="hljs-attr">minHeight</span>=<span class="hljs-string">{190}</span>
      <span class="hljs-attr">bounds</span>=<span class="hljs-string">"window"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"drag__content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Collapse</span> <span class="hljs-attr">expandIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"collapse__header"</span> <span class="hljs-attr">defaultActiveKey</span>=<span class="hljs-string">"1"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">CollapseItem</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">header</span>=<span class="hljs-string">"折叠面板"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">MyForm</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">CollapseItem</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Collapse</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Rnd</span>&gt;</span></span>
  );
}
</code></pre>
<p>嗯，能拖动，能折叠，这回够用了吧。</p>
<h2 data-id="heading-4">搞事2.0</h2>
<p><strong>HR小姐姐：</strong> 不对啊，我这边展开内容后，下面部分被挡住了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e205483dc1a4d9494642a8d9a458bf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=otOviD2BlR5J%2F1geTbQ1g9sRe40%3D" alt="Clipboard_Screenshot_1767014151.png" loading="lazy"/></p>
<p>能不能让被挡住部分自动移动上来？不要让我手工调整位置？<br/>
好吧好吧，继续优化~</p>
<h3 data-id="heading-5">初步优化</h3>
<p>首先分析问题原因：</p>
<blockquote>
<p><code>Collapse</code> 展开、收起时会引发容器高度的变化，但是没有触发 <code>rnd</code> 容器的位置变化，造成内容被遮挡了，所以解决办法是监听 <code>Collapse</code> 的 <code>onChange</code> 事件，在回调里重新定位，防止<code>rnd</code> 容器溢出可视范围。</p>
</blockquote>
<p>效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85c2c056bcc7465b9d92aef5989e5634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=vtWkclYatx26tWxyYskFfc6yFLI%3D" alt="Kapture 2026-02-11 at 15.05.46.gif" loading="lazy"/></p>
<h3 data-id="heading-6">进一步优化</h3>
<p>上面的处理可以解决 <code>Collapse</code> 展开时被遮挡问题，但是用户可以无限制拖动 <code>Collapse</code>，将 <code>Collapse</code> 拖动到视窗之外，所以还需要给拖动加上一个边界，防止内容被拖动到视窗之外。<br/>
这里有两种实现：</p>
<ol>
<li>限定拖动范围，当<code>Collapse</code>离开视窗时禁止拖动</li>
<li>增加兜底逻辑，当最后防止位置不在视窗范围内时，自动将<code>Collapse</code>定位到最低可视范围内</li>
</ol>
<p>综合用户体验，决定采用第二种实现。</p>
<h4 data-id="heading-7">提取工具类</h4>
<p>为了满足拖动后自动定位，需要实现一个工具函数，笔者刚开始写的时候确实是定义了一个function，最后发现内联方法越来越多，最后重构为一个 <code>Class</code>:</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">export</span> interface <span class="hljs-title class_">IPositionData</span> {
  <span class="hljs-attr">x</span>: number;
  <span class="hljs-attr">y</span>: number;
}
<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">ISizeData</span> {
  <span class="hljs-attr">width</span>: number;
  <span class="hljs-attr">height</span>: number;
}

<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">IHelpPanelRectData</span> {
  <span class="hljs-attr">defaultRightOffset</span>: number;
  <span class="hljs-attr">defaultBottomOffset</span>: number;
  <span class="hljs-attr">defaultTopOffset</span>: number;
  <span class="hljs-attr">defaultSize</span>: <span class="hljs-title class_">ISizeData</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDefaultRect</span> = (<span class="hljs-params">data: IHelpPanelRectData</span>) =&gt; {
  <span class="hljs-keyword">const</span> winWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
  <span class="hljs-keyword">const</span> winHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
  <span class="hljs-keyword">const</span> width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
    winWidth - data.<span class="hljs-property">defaultRightOffset</span>,
    data.<span class="hljs-property">defaultSize</span>.<span class="hljs-property">width</span>
  );
  <span class="hljs-keyword">const</span> height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
    winHeight - data.<span class="hljs-property">defaultBottomOffset</span> - data.<span class="hljs-property">defaultTopOffset</span>,
    data.<span class="hljs-property">defaultSize</span>.<span class="hljs-property">height</span>
  );
  <span class="hljs-keyword">const</span> position = {
    <span class="hljs-attr">x</span>: winWidth - width - data.<span class="hljs-property">defaultRightOffset</span>,
    <span class="hljs-attr">y</span>: winHeight - height - data.<span class="hljs-property">defaultBottomOffset</span>,
  };
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">size</span>: { width, height }, position };
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelpPanelRect</span> {
  <span class="hljs-comment">// 拖动容器最小高度</span>
  public minHeight = <span class="hljs-number">100</span>;
  <span class="hljs-comment">// 拖动容器最小宽度</span>
  public minWidth = <span class="hljs-number">400</span>;
  <span class="hljs-comment">// 拖动容器最大高度</span>
  public maxHeight = <span class="hljs-number">1024</span>;
  <span class="hljs-comment">// 拖动容器最大宽度</span>
  public maxWidth = <span class="hljs-number">1024</span>;
  <span class="hljs-comment">// 默认上边距</span>
  public defaultTopOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 当前上边距</span>
  public topOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 默认右边距</span>
  public defaultRightOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 当前右边距</span>
  public rightOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 默认情况下距底高度，紧贴帮助按钮</span>
  public defaultBottomOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 面板移动之后底部边距，0 表示紧贴窗口</span>
  public bottomOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 默认大小</span>
  public defaultSize = {
    <span class="hljs-attr">width</span>: <span class="hljs-number">450</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">457</span>,
  };
  <span class="hljs-comment">// 最大大小</span>
  public maxSize = {
    <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxWidth</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxHeight</span>,
  };

  private <span class="hljs-attr">prevSize</span>: <span class="hljs-title class_">ISizeData</span>;
  private <span class="hljs-attr">prevPosition</span>: <span class="hljs-title class_">IPositionData</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data: IHelpPanelRectData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultRightOffset</span> = data.<span class="hljs-property">defaultRightOffset</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultBottomOffset</span> = data.<span class="hljs-property">defaultBottomOffset</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultTopOffset</span> = data.<span class="hljs-property">defaultTopOffset</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSize</span> = data.<span class="hljs-property">defaultSize</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSize</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDefaultRect</span>(data).<span class="hljs-property">position</span>;
  }

  <span class="hljs-comment">// 点击入口按钮时的初始状态</span>
  <span class="hljs-title function_">getDefaultRect</span>(<span class="hljs-params">data?: IHelpPanelRectData</span>) {
    <span class="hljs-keyword">const</span> defaultRect = data ? <span class="hljs-title function_">getDefaultRect</span>(data) : <span class="hljs-title function_">getDefaultRect</span>(<span class="hljs-variable language_">this</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = defaultRect.<span class="hljs-property">size</span>;
    <span class="hljs-keyword">return</span> {
      ...defaultRect,
    };
  }

  <span class="hljs-comment">/**
   *
   * <span class="hljs-doctag">@param</span> windowIsResize 是否拖动浏览器窗口
   */</span>
  <span class="hljs-title function_">getRectByWindowResize</span>(<span class="hljs-params">windowIsResize = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> winWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
    <span class="hljs-keyword">const</span> winHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
    <span class="hljs-keyword">let</span> { x, y } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span>;
    y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(y, <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getMaxHeight</span> = (<span class="hljs-params"/>) =&gt;
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">minHeight</span>,
        <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(winHeight - y - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxHeight</span>)
      );

    <span class="hljs-keyword">let</span> { width, height } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rightOffset</span> + x + width &gt; winWidth) {
      <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span>) {
        x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(winWidth - width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">rightOffset</span>, <span class="hljs-number">0</span>);
      } <span class="hljs-keyword">else</span> {
        width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">minWidth</span>,
          <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(winWidth - <span class="hljs-variable language_">this</span>.<span class="hljs-property">rightOffset</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxWidth</span>)
        );
      }
    }

    <span class="hljs-keyword">if</span> (y + height + <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span> &gt; winHeight) {
      <span class="hljs-keyword">if</span> (y &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>) {
        y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>, winHeight - height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span>);
      } <span class="hljs-keyword">else</span> {
        height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">minHeight</span>,
          <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
            winHeight - <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span>,
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxHeight</span>
          )
        );
      }
    } <span class="hljs-keyword">else</span> {
      height = windowIsResize
        ? <span class="hljs-title function_">getMaxHeight</span>()
        : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(height, winHeight - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>);
    }

    <span class="hljs-keyword">return</span> { <span class="hljs-attr">size</span>: { width, height }, <span class="hljs-attr">position</span>: { x, y } };
  }

  <span class="hljs-comment">/**
   * 尺寸不变，只调整位置
   * <span class="hljs-doctag">@param</span> position 拖动之后的位置
   */</span>
  <span class="hljs-title function_">getRectByPosition</span>(<span class="hljs-params">position: IPositionData</span>) {
    <span class="hljs-keyword">const</span> winWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
    <span class="hljs-keyword">const</span> winHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
    <span class="hljs-keyword">const</span> { width, height } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = {
      <span class="hljs-attr">x</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, position.<span class="hljs-property">x</span>), winWidth - width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">rightOffset</span>),
      <span class="hljs-attr">y</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
        <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>, position.<span class="hljs-property">y</span>),
        winHeight - height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span>
      ),
    };

    <span class="hljs-keyword">return</span> { <span class="hljs-attr">size</span>: { width, height }, <span class="hljs-attr">position</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> };
  }

  <span class="hljs-title function_">getRectByResize</span>(<span class="hljs-params">pos?: IPositionData, s?: ISizeData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = s ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = pos ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span>;

    <span class="hljs-keyword">const</span> { size, position } = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRectByWindowResize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = size;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = position;
    <span class="hljs-keyword">return</span> { size, position };
  }

  <span class="hljs-title function_">getRect</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">position</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span>, <span class="hljs-attr">size</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> };
  }

  <span class="hljs-title function_">setRect</span>(<span class="hljs-params">position?: IPositionData, size?: ISizeData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = position ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = size ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;
  }

  <span class="hljs-title function_">setDefaultSize</span>(<span class="hljs-params">size: ISizeData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSize</span> = size;
  }

  <span class="hljs-title function_">setSize</span>(<span class="hljs-params">size: ISizeData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = size;
  }

  <span class="hljs-title function_">resetSize</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSize</span>;
  }

  <span class="hljs-title function_">resetPosition</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> winWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
    <span class="hljs-keyword">const</span> winHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
    <span class="hljs-keyword">const</span> { height, width } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = {
      <span class="hljs-attr">x</span>: winWidth - width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultRightOffset</span>,
      <span class="hljs-attr">y</span>: winHeight - height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultBottomOffset</span>,
    };
  }

  <span class="hljs-comment">/**
   * 重置布局
   */</span>
  <span class="hljs-title function_">resetRect</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resetSize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resetPosition</span>();
  }
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Rnd</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-rnd"</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Form</span>,
  <span class="hljs-title class_">Input</span>,
  <span class="hljs-title class_">Checkbox</span>,
  <span class="hljs-title class_">Button</span>,
  <span class="hljs-title class_">Radio</span>,
  <span class="hljs-title class_">Collapse</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"@arco-design/web-react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./DragForm.less"</span>;
<span class="hljs-keyword">import</span> { useRef, useState, useLayoutEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">HelpPanelRect</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"../utils/HelpPanelRect"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">FormItem</span> = <span class="hljs-title class_">Form</span>.<span class="hljs-property">Item</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">RadioGroup</span> = <span class="hljs-title class_">Radio</span>.<span class="hljs-property">Group</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CollapseItem</span> = <span class="hljs-title class_">Collapse</span>.<span class="hljs-property">Item</span>;

<span class="hljs-keyword">const</span> helpPanelRect = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HelpPanelRect</span>({
  <span class="hljs-attr">defaultRightOffset</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">defaultBottomOffset</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">defaultTopOffset</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">defaultSize</span>: {
    <span class="hljs-attr">width</span>: <span class="hljs-number">400</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">300</span>,
  },
});

<span class="hljs-comment">/**
 *
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DragForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> panelRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 浮窗大小</span>
  <span class="hljs-keyword">const</span> [floatPanelSize, setFloatPanelSize] = <span class="hljs-title function_">useState</span>(
    helpPanelRect.<span class="hljs-property">defaultSize</span>
  );
  <span class="hljs-comment">// 浮窗坐标</span>
  <span class="hljs-keyword">const</span> [floatPanelPosition, setFloatPanelPosition] = <span class="hljs-title function_">useState</span>(
    helpPanelRect.<span class="hljs-title function_">getDefaultRect</span>().<span class="hljs-property">position</span>
  );

  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!panelRef.<span class="hljs-property">current</span>) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> target = panelRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">const</span> resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
        <span class="hljs-keyword">const</span> { width, height } = entry.<span class="hljs-property">contentRect</span>;
        <span class="hljs-keyword">if</span> (
          width === floatPanelSize.<span class="hljs-property">width</span> &amp;&amp;
          height === floatPanelSize.<span class="hljs-property">height</span>
        ) {
          <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-title function_">setFloatPanelSize</span>({ width, height });
        helpPanelRect.<span class="hljs-title function_">setDefaultSize</span>({ width, height });
        <span class="hljs-comment">// 更新面板高度</span>
        <span class="hljs-keyword">const</span> newSize = {
          ...floatPanelSize,
          height,
        };

        <span class="hljs-comment">// 获取当前位置并调整，确保面板不会超出视口</span>
        <span class="hljs-keyword">const</span> currentRect = helpPanelRect.<span class="hljs-title function_">getRectByResize</span>(
          floatPanelPosition,
          newSize
        );

        <span class="hljs-title function_">setFloatPanelSize</span>(currentRect.<span class="hljs-property">size</span>);
        <span class="hljs-title function_">setFloatPanelPosition</span>(currentRect.<span class="hljs-property">position</span>);
      }
    });
    <span class="hljs-keyword">if</span> (target) {
      resizeObserver.<span class="hljs-title function_">observe</span>(target);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      resizeObserver.<span class="hljs-title function_">disconnect</span>();
    };
  }, [panelRef, floatPanelSize, floatPanelPosition]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Rnd</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">pointerEvents:</span> "<span class="hljs-attr">all</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">101</span>,
      }}
      <span class="hljs-attr">className</span>=<span class="hljs-string">"float-panel"</span>
      <span class="hljs-attr">disableDragging</span>=<span class="hljs-string">{false}</span>
      <span class="hljs-attr">enableResizing</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">bottom:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">bottomLeft:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">bottomRight:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">right:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">top:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">topLeft:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">topRight:</span> <span class="hljs-attr">false</span>,
      }}
      <span class="hljs-attr">position</span>=<span class="hljs-string">{floatPanelPosition}</span>
      <span class="hljs-attr">size</span>=<span class="hljs-string">{floatPanelSize}</span>
      <span class="hljs-attr">maxWidth</span>=<span class="hljs-string">{helpPanelRect.maxWidth}</span>
      <span class="hljs-attr">maxHeight</span>=<span class="hljs-string">{helpPanelRect.maxHeight}</span>
      <span class="hljs-attr">minHeight</span>=<span class="hljs-string">{helpPanelRect.minHeight}</span>
      <span class="hljs-attr">minWidth</span>=<span class="hljs-string">{helpPanelRect.minWidth}</span>
      <span class="hljs-attr">onResizeStop</span>=<span class="hljs-string">{(e,</span> <span class="hljs-attr">direction</span>, <span class="hljs-attr">ref</span>, <span class="hljs-attr">delta</span>, <span class="hljs-attr">position</span>) =&gt;</span> {
        const currentRect = helpPanelRect.getRectByResize(position, {
          width: parseInt(ref.style.width, 10),
          height: parseInt(ref.style.height, 10),
        });
        setFloatPanelSize(currentRect.size);
        setFloatPanelPosition(currentRect.position);
      }}
      onDragStop={(e, data) =&gt; {
        const currentRect = helpPanelRect.getRectByPosition(data);
        setFloatPanelSize(currentRect.size);
        setFloatPanelPosition(currentRect.position);
      }}
      dragHandleClassName="drag__content"
    &gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{panelRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"drag__content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"drag__header"</span>&gt;</span>拖动区域<span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Collapse</span> <span class="hljs-attr">expandIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"collapse__header"</span> <span class="hljs-attr">defaultActiveKey</span>=<span class="hljs-string">"1"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">CollapseItem</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">header</span>=<span class="hljs-string">"折叠面板"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">MyForm</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">CollapseItem</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Collapse</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Rnd</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Form</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">maxWidth:</span> <span class="hljs-attr">600</span>,
      }}
      <span class="hljs-attr">autoComplete</span>=<span class="hljs-string">"off"</span>
      <span class="hljs-attr">layout</span>=<span class="hljs-string">{</span>"<span class="hljs-attr">vertical</span>"}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"Layout"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">RadioGroup</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"layout"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Radio</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"horizontal"</span>&gt;</span>horizontal<span class="hljs-tag">&lt;/<span class="hljs-name">Radio</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Radio</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"vertical"</span>&gt;</span>vertical<span class="hljs-tag">&lt;/<span class="hljs-name">Radio</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Radio</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"inline"</span>&gt;</span>inline<span class="hljs-tag">&lt;/<span class="hljs-name">Radio</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">RadioGroup</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"Username"</span>
        <span class="hljs-attr">field</span>=<span class="hljs-string">"username"</span>
        <span class="hljs-attr">tooltip</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Username is required <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
        rules={[{ required: true }]}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> <span class="hljs-attr">270</span> }} <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"please enter your name"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"Post"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> <span class="hljs-attr">270</span> }} <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"please enter your post"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">wrapperCol</span>=<span class="hljs-string">{{}}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Checkbox</span>&gt;</span>I have read the manual<span class="hljs-tag">&lt;/<span class="hljs-name">Checkbox</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">wrapperCol</span>=<span class="hljs-string">{{}}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">htmlType</span>=<span class="hljs-string">"submit"</span>&gt;</span>
          Submit
        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Form</span>&gt;</span></span>
  );
}
</code></pre>
<p>上面的代码基本演示了 <code>HelpPanelRect</code> 的使用。</p>
<blockquote>
<p>PS: 第一步优化中监听 <code>Collapse</code> 的 <code>onChange</code> 事件来重新定位的实现被我改成了监听 ResizeObserver，这样可以解决真正展开、收起 <code>Collapse</code> 后误触发重新定位的bug</p>
</blockquote>
<h3 data-id="heading-8">最终效果</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08ebcd5e26dc4e979e7be900d93c5c2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=%2F2sxcZGv2yAKvP%2FmI8t0xFDoNfo%3D" alt="Kapture 2026-02-11 at 15.19.58.gif" loading="lazy"/></p>
<h2 data-id="heading-9">小结</h2>
<ol>
<li>全屏拖拽应该是很常见的功能，社区里也有很多好的实现，但是有特殊位置要求时就需要有额外开发；</li>
<li>文中的工具函数结合<code>react-rnd</code>可以适配很多拖拽时有边界控制的场景，希望给大家带来一点帮助。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL高可用终极指南：Keepalived实战精讲，从VIP漂移到主从切换，一篇搞定！]]></title>    <link>https://juejin.cn/post/7605173538417033226</link>    <guid>https://juejin.cn/post/7605173538417033226</guid>    <pubDate>2026-02-11T06:10:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605173538417033226" data-draft-id="7605164560711237658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL高可用终极指南：Keepalived实战精讲，从VIP漂移到主从切换，一篇搞定！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T06:10:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL高可用终极指南：Keepalived实战精讲，从VIP漂移到主从切换，一篇搞定！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:10:30.000Z" title="Wed Feb 11 2026 06:10:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>兄弟们，高可用这东西，不出事时岁月静好，一出事就是P1级故障。还记得那次吗？某核心交易系统，MySQL主库的存储IOPS突然飙到100%，整个实例hang死，别说交易了，连登录都登不上去。按理说，咱们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3DMySQL%25E4%25B8%25BB%25E4%25BB%258E%25E5%25A4%258D%25E5%2588%25B6%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6&amp;zhida_source=entity" ref="nofollow noopener noreferrer">MySQL主从复制</a>是配了的，备库数据也跟得紧紧的。但最要命的是，业务访问的那个VIP（虚拟IP），像被502胶水焊死了一样，还死死地钉在故障机上，导致业务全断。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E9%25A1%25B9%25E7%259B%25AE%25E7%25BB%258F%25E7%2590%2586%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E9%A1%B9%E7%9B%AE%E7%BB%8F%E7%90%86&amp;zhida_source=entity" ref="nofollow noopener noreferrer">项目经理</a>的电话比闹钟还准时，三点准时响起，那语气，恨不得从电话线里爬过来掐我脖子。</p>
<p>查了半天，根源找到了：只做了数据层的高可用（主从复制），却忽略了<strong>服务层的高可用（VIP自动漂移）</strong> 。高可用是个“木桶”，最短的那块板决定你的睡眠质量。你的数据同步得再快，应用访问不到也是白搭。</p>
<p>今天这篇，就是要把这块最短的板补上。我带你用<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3DKeepalived%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=Keepalived&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Keepalived</a>这个“神器”，从零开始搭建一个真正能自动切换、让你睡得安稳的MySQL高可用架构。</p>
<h3 data-id="heading-0">1 Keepalived是个啥？</h3>
<p>别被那些复杂的文档吓到，这玩意的原理其实很简单。</p>
<p><strong>通俗解释:</strong>  你可以把Keepalived比作两个时刻准备“抢公章”（也就是我们的VIP）的办公室主任（两台MySQL服务器）。谁的“声望”（<code>priority</code> 优先级）高，默认就由谁拿着公章对外提供服务。这个拿着公章的主任，为了证明自己还活着，会定期在办公室里“吼一嗓子”（发送VRRP心跳通告），告诉另一位主任：“我还行，公章还在我这！” 如果大家在规定时间内没听到他吼，那么另一位主任就会立刻站出来，把公章抢过来，继续对外服务。</p>
<p><strong>核心概念:</strong></p>
<ul>
<li>
<p><strong>VRRP协议 (Virtual Router Redundancy Protocol):</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E8%2599%259A%25E6%258B%259F%25E8%25B7%25AF%25E7%2594%25B1%25E5%2586%2597%25E4%25BD%2599%25E5%258D%258F%25E8%25AE%25AE%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E8%99%9A%E6%8B%9F%E8%B7%AF%E7%94%B1%E5%86%97%E4%BD%99%E5%8D%8F%E8%AE%AE&amp;zhida_source=entity" ref="nofollow noopener noreferrer">虚拟路由冗余协议</a>，这就是Keepalived实现高可用的技术基础，刚才说的“吼一嗓子”就是通过这个协议来的。</p>
</li>
<li>
<p><strong>VIP (<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D2%26q%3D%25E8%2599%259A%25E6%258B%259FIP%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=2&amp;q=%E8%99%9A%E6%8B%9FIP&amp;zhida_source=entity" ref="nofollow noopener noreferrer">虚拟IP</a>):</strong>  对外统一的服务入口，高可用的灵魂。应用程序连接的是这个永不改变的IP，它底下是哪台机器在干活，<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%25BA%2594%25E7%2594%25A8%25E5%25B1%2582%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E5%BA%94%E7%94%A8%E5%B1%82&amp;zhida_source=entity" ref="nofollow noopener noreferrer">应用层</a>完全无感。</p>
</li>
<li>
<p><strong>MASTER/BACKUP 角色:</strong>  一个VRRP实例中，同一时间只有一台是MASTER（主），负责持有VIP。其他都是BACKUP（备），时刻准备接管。这个角色是根据<code>priority</code>值动态选举出来的。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90cc9274ba03461983b94d8132f5ccf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771395031&amp;x-signature=ACzgg%2BOLzruO0krI3reEkIzEvTI%3D" alt="" loading="lazy"/></p>
<p>这张图把关系说透了：客户端只认VIP。VIP平时在MASTER身上。MASTER和BACKUP之间通过VRRP心跳互相知晓对方的存活状态。一旦MASTER挂了，心跳中断，BACKUP就会把VIP“抢”过来。</p>
<h3 data-id="heading-1">2 环境准备与安装</h3>
<p>光说不练假把式，开整！</p>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E7%258E%25AF%25E5%25A2%2583%25E8%25A7%2584%25E5%2588%2592%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E7%8E%AF%E5%A2%83%E8%A7%84%E5%88%92&amp;zhida_source=entity" ref="nofollow noopener noreferrer">环境规划</a>:</strong></p>
<ul>
<li>服务器A (主节点): <code>mysql-node1</code>，物理IP <code>192.168.31.101</code></li>
<li>服务器B (备节点): <code>mysql-node2</code>，物理IP <code>192.168.31.102</code></li>
<li>虚拟IP (VIP): <code>192.168.31.1010</code></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2593%258D%25E4%25BD%259C%25E7%25B3%25BB%25E7%25BB%259F%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F&amp;zhida_source=entity" ref="nofollow noopener noreferrer">操作系统</a>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3DRed%2BHat%2B8.2%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=Red+Hat+8.2&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Red Hat 8.2</a></li>
<li>Keepalived版本: 2.0.10 (RHEL 8 自带)</li>
</ul>
<p><strong>安装步骤 (RHEL 8):</strong>  这个简单，两台机器上都执行就行了，属于“抄作业”环节。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># dnf -y install keepalived</span>

<span class="hljs-comment"># 执行结果如下</span>
<span class="hljs-string">Local</span> <span class="hljs-string">Repository</span>                                                                                      <span class="hljs-number">2.7</span> <span class="hljs-string">MB/s</span> <span class="hljs-string">|</span> <span class="hljs-number">2.8</span> <span class="hljs-string">kB</span>     <span class="hljs-number">00</span><span class="hljs-string">:00</span>    
<span class="hljs-string">Local</span> <span class="hljs-string">Repository</span>                                                                                      <span class="hljs-number">3.1</span> <span class="hljs-string">MB/s</span> <span class="hljs-string">|</span> <span class="hljs-number">3.2</span> <span class="hljs-string">kB</span>     <span class="hljs-number">00</span><span class="hljs-string">:00</span>    
<span class="hljs-string">Dependencies</span> <span class="hljs-string">resolved.</span>
<span class="hljs-string">======================================================================================================================================</span>
 <span class="hljs-string">Package</span>                        <span class="hljs-string">Architecture</span>   <span class="hljs-string">Version</span>                               <span class="hljs-string">Repository</span>                                  <span class="hljs-string">Size</span>
<span class="hljs-string">======================================================================================================================================</span>
<span class="hljs-attr">Installing:</span>
 <span class="hljs-string">keepalived</span>                     <span class="hljs-string">x86_64</span>         <span class="hljs-number">2.0</span><span class="hljs-number">.10</span><span class="hljs-number">-10.</span><span class="hljs-string">el8</span>                         <span class="hljs-string">local-AppStream</span>                            <span class="hljs-number">466</span> <span class="hljs-string">k</span>
<span class="hljs-attr">Installing dependencies:</span>
 <span class="hljs-string">lm_sensors-libs</span>                <span class="hljs-string">x86_64</span>         <span class="hljs-number">3.4</span><span class="hljs-number">.0</span><span class="hljs-number">-21.</span><span class="hljs-string">20180522git70f7e08.el8</span>       <span class="hljs-string">local</span>                                       <span class="hljs-number">59</span> <span class="hljs-string">k</span>
 <span class="hljs-string">mariadb-connector-c</span>            <span class="hljs-string">x86_64</span>         <span class="hljs-number">3.0</span><span class="hljs-number">.7</span><span class="hljs-number">-1.</span><span class="hljs-string">el8</span>                           <span class="hljs-string">local-AppStream</span>                            <span class="hljs-number">148</span> <span class="hljs-string">k</span>
 <span class="hljs-string">net-snmp-agent-libs</span>            <span class="hljs-string">x86_64</span>         <span class="hljs-number">1</span><span class="hljs-string">:5.8-14.el8</span>                          <span class="hljs-string">local-AppStream</span>                            <span class="hljs-number">747</span> <span class="hljs-string">k</span>
 <span class="hljs-string">net-snmp-libs</span>                  <span class="hljs-string">x86_64</span>         <span class="hljs-number">1</span><span class="hljs-string">:5.8-14.el8</span>                          <span class="hljs-string">local</span>                                      <span class="hljs-number">821</span> <span class="hljs-string">k</span>

<span class="hljs-string">Transaction</span> <span class="hljs-string">Summary</span>
<span class="hljs-string">======================================================================================================================================</span>
<span class="hljs-string">Install</span>  <span class="hljs-number">5</span> <span class="hljs-string">Packages</span>

<span class="hljs-attr">Total size:</span> <span class="hljs-number">2.2</span> <span class="hljs-string">M</span>
<span class="hljs-attr">Installed size:</span> <span class="hljs-number">7.2</span> <span class="hljs-string">M</span>
<span class="hljs-attr">Downloading Packages:</span>
<span class="hljs-string">Running</span> <span class="hljs-string">transaction</span> <span class="hljs-string">check</span>
<span class="hljs-string">Transaction</span> <span class="hljs-string">check</span> <span class="hljs-string">succeeded.</span>
<span class="hljs-string">Running</span> <span class="hljs-string">transaction</span> <span class="hljs-string">test</span>
<span class="hljs-string">Transaction</span> <span class="hljs-string">test</span> <span class="hljs-string">succeeded.</span>
<span class="hljs-string">Running</span> <span class="hljs-string">transaction</span>
  <span class="hljs-attr">Running scriptlet:</span> <span class="hljs-string">mariadb-connector-c-3.0.7-1.el8.x86_64</span>                            <span class="hljs-number">1</span><span class="hljs-string">/1</span> 
  <span class="hljs-attr">Preparing        :</span>                                                                   <span class="hljs-number">1</span><span class="hljs-string">/1</span> 
  <span class="hljs-attr">Installing       :</span> <span class="hljs-string">net-snmp-libs-1:5.8-14.el8.x86_64</span>                                 <span class="hljs-number">1</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Installing       :</span> <span class="hljs-string">mariadb-connector-c-3.0.7-1.el8.x86_64</span>                            <span class="hljs-number">2</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Installing       :</span> <span class="hljs-string">lm_sensors-libs-3.4.0-21.20180522git70f7e08.el8.x86_64</span>            <span class="hljs-number">3</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Running scriptlet:</span> <span class="hljs-string">lm_sensors-libs-3.4.0-21.20180522git70f7e08.el8.x86_64</span>            <span class="hljs-number">3</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Installing       :</span> <span class="hljs-string">net-snmp-agent-libs-1:5.8-14.el8.x86_64</span>                           <span class="hljs-number">4</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Installing       :</span> <span class="hljs-string">keepalived-2.0.10-10.el8.x86_64</span>                                   <span class="hljs-number">5</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Running scriptlet:</span> <span class="hljs-string">keepalived-2.0.10-10.el8.x86_64</span>                                   <span class="hljs-number">5</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Verifying        :</span> <span class="hljs-string">lm_sensors-libs-3.4.0-21.20180522git70f7e08.el8.x86_64</span>            <span class="hljs-number">1</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Verifying        :</span> <span class="hljs-string">net-snmp-libs-1:5.8-14.el8.x86_64</span>                                 <span class="hljs-number">2</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Verifying        :</span> <span class="hljs-string">keepalived-2.0.10-10.el8.x86_64</span>                                   <span class="hljs-number">3</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Verifying        :</span> <span class="hljs-string">mariadb-connector-c-3.0.7-1.el8.x86_64</span>                            <span class="hljs-number">4</span><span class="hljs-string">/5</span> 
  <span class="hljs-attr">Verifying        :</span> <span class="hljs-string">net-snmp-agent-libs-1:5.8-14.el8.x86_64</span>                           <span class="hljs-number">5</span><span class="hljs-string">/5</span> 
<span class="hljs-string">Installed</span> <span class="hljs-string">products</span> <span class="hljs-string">updated.</span>

<span class="hljs-attr">Installed:</span>
  <span class="hljs-string">keepalived-2.0.10-10.el8.x86_64</span>        <span class="hljs-string">lm_sensors-libs-3.4.0-21.20180522git70f7e08.el8.x86_64</span>      
  <span class="hljs-string">mariadb-connector-c-3.0.7-1.el8.x86_64</span>      <span class="hljs-string">net-snmp-agent-libs-1:5.8-14.el8.x86_64</span>     
  <span class="hljs-string">net-snmp-libs-1:5.8-14.el8.x86_64</span>     

<span class="hljs-string">Complete!</span>


<span class="hljs-comment">## 确认版本</span>
[<span class="hljs-string">root@node101</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># keepalived --version</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7767d4f16974a659a7d778019b39999~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771395031&amp;x-signature=b3GvGTNPANejf2CZspd7rbUDQ2g%3D" alt="" loading="lazy"/></p>
<p><strong>防火墙配置:</strong></p>
<blockquote>
<p>⚠️ <strong>生产大坑:</strong>  兄弟们注意了，这是我踩过最大的坑！必须放行VRRP协议！Keepalived主备节点之间靠VRRP<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%258D%258F%25E8%25AE%25AE%25E9%2580%259A%25E4%25BF%25A1%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1&amp;zhida_source=entity" ref="nofollow noopener noreferrer">协议通信</a>，你把防火墙挡住了，它俩就成了“聋子和瞎子”，互相都以为对方挂了，结果就是两边都抢着声明自己是MASTER，都去绑定VIP。这就是传说中的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E8%2584%2591%25E8%25A3%2582%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E8%84%91%E8%A3%82&amp;zhida_source=entity" ref="nofollow noopener noreferrer">脑裂</a>”！业务流量一会打到A，一会打到B，数据不一致，等着背锅吧。</p>
</blockquote>
<p>如果服务器上防火墙是开着的，得在两台机器上都执行：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta"># firewall-cmd --add-rich-rule=<span class="hljs-string">'rule protocol value="vrrp" accept'</span> --permanent</span>
<span class="hljs-meta"># firewall-cmd --reload</span>
</code></pre>
<p><strong>内核参数调整:</strong>  Keepalived需要把一个不属于本机网卡的IP（也就是VIP）绑定上来，默认Linux内核是不允许的。所以需要调整一个内核参数。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># echo "net.ipv4.ip_nonlocal_bind = 1" &gt;&gt; /etc/sysctl.conf</span>
<span class="hljs-comment"># sysctl -p</span>

<span class="hljs-comment">## 结果如下</span>
<span class="hljs-section">[root@node101 ~]</span><span class="hljs-comment"># sysctl -p</span>
<span class="hljs-attr">net.ipv4.ip_nonlocal_bind</span> = <span class="hljs-number">1</span>
</code></pre>
<p>这个操作也是两台机器都要做。</p>
<h2 data-id="heading-2">3 高可用方案对决：自动 vs 手动</h2>
<p>讲到这里，就到了十字路口。Keepalived给我们提供了能力，但怎么用这个能力，是门大学问。下面我给你端上两盘菜，一盘是“入门级自动切换”，另一盘是“生产级手动切换”，咱们把优缺点掰扯清楚了，你再决定在你的环境里用哪一盘。</p>
<h3 data-id="heading-3"><strong>方案一：入门级自动切换 (Keepalived + Notify脚本)</strong></h3>
<p>这个方案追求的是“<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2597%25A0%25E4%25BA%25BA%25E5%2580%25BC%25E5%25AE%2588%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%97%A0%E4%BA%BA%E5%80%BC%E5%AE%88&amp;zhida_source=entity" ref="nofollow noopener noreferrer">无人值守</a>”，一旦MySQL出问题，系统自动完成VIP和<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%25E8%25A7%2592%25E8%2589%25B2%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A7%92%E8%89%B2&amp;zhida_source=entity" ref="nofollow noopener noreferrer">数据库角色</a>的切换。</p>
<p><strong>A. 核心思路</strong></p>
<p>咱们利用Keepalived的<code>notify_*</code>系列指令。当Keepalived的状态从<code>BACKUP</code>变成<code>MASTER</code>时，就自动触发一个我们写好的<code>mysql_role_switch.sh</code>脚本，让这个脚本去完成数据库的<code>read_only</code>状态切换。</p>
<p><strong>B. <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E9%2585%258D%25E7%25BD%25AE%25E6%2596%2587%25E4%25BB%25B6%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6&amp;zhida_source=entity" ref="nofollow noopener noreferrer">配置文件</a> (主备有别)</strong></p>
<p><code>vi /etc/keepalived/keepalived.conf</code></p>
<p><strong>主节点 <code>mysql-node1</code> (192.168.31.101):</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">! <span class="hljs-function">Configuration File <span class="hljs-keyword">for</span> <span class="hljs-title">keepalived</span> (<span class="hljs-params">Auto-Switch MASTER</span>)

global_defs</span> {
   <span class="hljs-meta"># 路由ID，在一个局域网内，这个ID必须是唯一的，相当于Keepalived的身份证</span>
   router_id MYSQL_HA_01
}

vrrp_script chk_mysql {
    script <span class="hljs-string">"/etc/keepalived/check_mysql.sh"</span>  <span class="hljs-meta"># 脚本路径</span>
    interval <span class="hljs-number">2</span>                                <span class="hljs-meta"># 每2秒执行一次</span>
    weight <span class="hljs-number">-20</span>                                <span class="hljs-meta"># 如果脚本失败（退出码非0），则当前节点的优先级降低20</span>
    fall <span class="hljs-number">2</span>                                    <span class="hljs-meta"># 连续2次失败，才认为是真的失败</span>
    rise <span class="hljs-number">3</span>                                    <span class="hljs-meta"># 连续3次成功，才认为是真的恢复</span>
}

vrrp_instance VI_MYSQL {
    state MASTER
    <span class="hljs-keyword">interface</span> <span class="hljs-title">ens18</span>
    <span class="hljs-title">virtual_router_id</span> 51
    <span class="hljs-title">priority</span> 101
    <span class="hljs-title">advert_int</span> 1
    <span class="hljs-title">authentication</span> { 
		auth_type PASS
		auth_pass <span class="hljs-number">1111</span> 
	}
    virtual_ipaddress { 
		<span class="hljs-number">192.168</span><span class="hljs-number">.31</span><span class="hljs-number">.100</span>/<span class="hljs-number">24</span> dev ens18 label ens18:vip
	}
    track_script { 
		chk_mysql
	}

    <span class="hljs-meta"># 状态变更时触发总司令脚本</span>
    notify_master <span class="hljs-string">"/etc/keepalived/mysql_role_switch.sh MASTER"</span>
    notify_backup <span class="hljs-string">"/etc/keepalived/mysql_role_switch.sh BACKUP"</span>
    notify_fault <span class="hljs-string">"/etc/keepalived/mysql_role_switch.sh BACKUP"</span>
}
</code></pre>
<p><strong>备节点 <code>mysql-node2</code> (192.168.31.102):</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">! <span class="hljs-function">Configuration File <span class="hljs-keyword">for</span> <span class="hljs-title">keepalived</span> (<span class="hljs-params">Auto-Switch BACKUP</span>)

global_defs</span> {
   router_id MYSQL_HA_02
}

vrrp_script chk_mysql {
    <span class="hljs-meta"># ... 配置与主节点完全一样 ...</span>
}

vrrp_instance VI_MYSQL {
    state BACKUP
    <span class="hljs-keyword">interface</span> <span class="hljs-title">ens18</span>
    <span class="hljs-title">virtual_router_id</span> 51
    <span class="hljs-title">priority</span> 100
    <span class="hljs-title">advert_int</span> 1
    <span class="hljs-title">nopreempt</span>  # 关键！防止主库恢复后<span class="hljs-title">VIP</span>来回抖动
    <span class="hljs-title">authentication</span> { 
		auth_type PASS
		auth_pass <span class="hljs-number">1111</span> 
	}
    virtual_ipaddress { 
		<span class="hljs-number">192.168</span><span class="hljs-number">.31</span><span class="hljs-number">.100</span>/<span class="hljs-number">24</span> dev ens18 label ens18:vip
	}
    track_script { 
		chk_mysql
	}

    <span class="hljs-meta"># 状态变更时触发总司令脚本</span>
    notify_master <span class="hljs-string">"/etc/keepalived/mysql_role_switch.sh MASTER"</span>
    notify_backup <span class="hljs-string">"/etc/keepalived/mysql_role_switch.sh BACKUP"</span>
    notify_fault <span class="hljs-string">"/etc/keepalived/mysql_role_switch.sh BACKUP"</span>
}
</code></pre>
<p><strong>核心参数讲解:</strong></p>
<ul>
<li><code>virtual_router_id</code>: 主备的“接头暗号”，必须一样，不然它俩不在一个频道，各玩各的。</li>
<li><code>priority</code>: 选举的核心，谁的数字大谁就是MASTER。</li>
<li><code>vrrp_script</code> &amp; <code>track_script</code>: 这两个是黄金搭档。前者定义了“怎么检查”，后者负责“把检查结果用起来”。当<code>chk_mysql</code>脚本执行失败，<code>track_script</code>就会让当前节点的<code>priority</code>减去<code>weight</code>定义的值（101 - 20 = 81）。81比备机的100低，于是VIP就漂移了。</li>
<li><code>nopreempt</code>: <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5&amp;zhida_source=entity" ref="nofollow noopener noreferrer">最佳实践</a>！</strong>  这个参数只在<code>BACKUP</code>节点上配。意思是“不抢占”。假设原来的主库<code>mysql-node1</code>只是网络抖动了一下，导致VIP切到了<code>mysql-node2</code>。几秒后<code>mysql-node1</code>恢复了，如果没有<code>nopreempt</code>，它的优先级（101）还是比<code>mysql-node2</code>（100）高，它会立刻把VIP抢回来。这一来一回的切换，对业务可能是致命的抖动。配置了<code>nopreempt</code>，就意味着只要<code>mysql-node2</code>还活着，即使<code>mysql-node1</code>恢复了，也得“靠边站”，VIP不会切回去。这大大减少了不必要的切换，生产环境更稳定。</li>
</ul>
<p><strong>C. 核心脚本 (侦察兵 + 总司令)</strong></p>
<p><code>check_mysql.sh</code>负责高频侦察，<code>mysql_role_switch.sh</code>负责在收到Keepalived命令后，执行数据库角色切换的重操作。</p>
<p><code>/etc/keepalived/check_mysql.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 使用mysqladmin工具检查MySQL服务的可用性</span>
mysqladmin ping -u root -p<span class="hljs-string">'YourComplexP@ssw0rd!_2025'</span> &gt; /dev/null 2&gt;&amp;1
<span class="hljs-comment"># 检查上一条命令的退出码</span>
<span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-comment"># 如果ping通，说明MySQL服务正常，脚本以退出码0结束</span>
    <span class="hljs-built_in">exit</span> 0
<span class="hljs-keyword">else</span>
    <span class="hljs-comment"># 如果ping不通，说明MySQL服务异常，脚本以退出码1结束</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
</code></pre>
<p><code>/etc/keepalived/mysql_role_switch.sh</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

STATE=<span class="hljs-variable">$1</span>
LOG_FILE=<span class="hljs-string">"/var/log/keepalived-mysql-state.log"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>: Script called with state <span class="hljs-variable">$STATE</span>"</span> &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>

<span class="hljs-keyword">case</span> <span class="hljs-variable">$STATE</span> <span class="hljs-keyword">in</span>
    <span class="hljs-string">"MASTER"</span>)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Transitioning to MASTER..."</span> &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
        <span class="hljs-comment"># 1. 停止从属关系</span>
        mysql -u root -p<span class="hljs-string">'YourComplexP@ssw0rd!_2025'</span> -e <span class="hljs-string">"STOP SLAVE;"</span>
        
        <span class="hljs-comment"># 2. 将数据库设置为可写</span>
        mysql -u root -p<span class="hljs-string">'YourComplexP@ssw0rd!_2025'</span> -e <span class="hljs-string">"SET GLOBAL read_only = OFF;"</span>
        
        <span class="hljs-comment"># 3. 如果需要，可以重置主库信息（在某些场景下需要）</span>
        <span class="hljs-comment"># mysql -u root -p'YourComplexP@ssw0rd!_2025' -e "RESET MASTER;"</span>

        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Transition to MASTER finished."</span> &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
        ;;
    <span class="hljs-string">"BACKUP"</span>)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Transitioning to BACKUP..."</span> &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
        <span class="hljs-comment"># 1. 将数据库设置为只读</span>
        mysql -u root -p<span class="hljs-string">'YourComplexP@ssw0rd!_2025'</span> -e <span class="hljs-string">"SET GLOBAL read_only = ON;"</span>
        
        <span class="hljs-comment"># 2. (可选但推荐) 尝试重新配置并启动与新主库的同步</span>
        <span class="hljs-comment"># 这一步比较复杂，通常需要外部脚本或人工介入来获取新主库的binlog位点</span>
        <span class="hljs-comment"># 在一个简单的自动切换场景中，可以暂时只做降级为只读的操作</span>
        <span class="hljs-comment"># mysql -u root -p'YourComplexP@ssw0rd!_2025' -e "START SLAVE;"</span>

        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Transition to BACKUP finished."</span> &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
        ;;
    *)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Unknown state. No action taken."</span> &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
        <span class="hljs-built_in">exit</span> 1
        ;;
<span class="hljs-keyword">esac</span>

<span class="hljs-built_in">exit</span> 0
</code></pre>
<blockquote>
<p>注意：这两个脚本的权限和属主是否正确？脚本里的<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2595%25B0%25E6%258D%25AE%25E5%25BA%2593%25E5%25AF%2586%25E7%25A0%2581%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%86%E7%A0%81&amp;zhida_source=entity" ref="nofollow noopener noreferrer">数据库密码</a>是否做了安全处理？</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x /etc/keepalived/check_mysql.sh /etc/keepalived/mysql_role_switch.sh
<span class="hljs-built_in">ls</span> -l /etc/keepalived/check_mysql.sh /etc/keepalived/mysql_role_switch.sh

<span class="hljs-comment">## 启动服务</span>
systemctl <span class="hljs-built_in">enable</span> --now keepalived
systemctl start keepalived
systemctl status keepalived


<span class="hljs-comment">## 确认vip地址</span>
ip addr dev ens18

<span class="hljs-comment">## 查看日志</span>
<span class="hljs-built_in">tail</span> -f /var/log/messages | grep Keepalived
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f04f3ec480e47c8bb8a7f1be5f26c6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771395031&amp;x-signature=MsQ54tikBWGJ16n0YNo%2Fv7AhtAU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/126c272b001248e5a106f00c9c4b28a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771395031&amp;x-signature=ohFv%2FqiCZdhB94bZpR2NR7XFmLU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cb4ec7babd14711b9e524379ceba3c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771395031&amp;x-signature=XNdiPtcimly9WEBumavX0jX7lK4%3D" alt="" loading="lazy"/></p>
<p><strong>D. 切换演练</strong></p>
<p>在主节点<code>mysql-node1</code>上执行<code>systemctl stop mysqld</code>，你会观察到VIP在几秒内自动漂移到<code>mysql-node2</code>，同时<code>mysql-node2</code>的数据库<code>read_only</code>状态自动变为<code>OFF</code>。</p>
<p>运行脚本”<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%25A8%25A1%25E6%258B%259F%25E4%25BA%25A4%25E6%2598%2593%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%A8%A1%E6%8B%9F%E4%BA%A4%E6%98%93&amp;zhida_source=entity" ref="nofollow noopener noreferrer">模拟交易</a>往数据库中插入数据，并检查vip飘逸情况</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">## 模拟交易，连接100</span>
<span class="hljs-section">[root@node101 ~]</span><span class="hljs-comment"># ./simulate_trx.sh </span>
开始模拟交易，按 CTRL+C 停止...
插入新交易: <span class="hljs-attr">trx_id</span> = <span class="hljs-number">15048884</span>, cust_id = <span class="hljs-number">674</span>, amt = <span class="hljs-number">232.11</span>,  耗时: .<span class="hljs-number">037132763</span>s
插入新交易: <span class="hljs-attr">trx_id</span> = <span class="hljs-number">15048885</span>, cust_id = <span class="hljs-number">752</span>, amt = <span class="hljs-number">116.62</span>,  耗时: .<span class="hljs-number">035379153</span>s

<span class="hljs-comment">## 停止节点1 mysqld</span>
<span class="hljs-section">[root@node101 ~]</span><span class="hljs-comment"># systemctl stop mysqld</span>


<span class="hljs-comment">## 节点2上监听 VRRP协议的包</span>
<span class="hljs-section">[root@node102 ~]</span><span class="hljs-comment"># tcpdump -i any -n vrrp</span>
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on any, link-type LINUX_SLL (Linux cooked), capture size 262144 bytes
19:05:29.651565 IP 192.168.31.101 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 81, authtype simple, intvl 1s, length 20
19:05:30.651689 IP 192.168.31.101 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 81, authtype simple, intvl 1s, length 20
19:05:31.651886 IP 192.168.31.101 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 51, prio 81, authtype simple, intvl 1s, length 20

<span class="hljs-comment">## 观察节点1 keepalived日志</span>
Nov 15 19:00:00 node101 Keepalived_vrrp<span class="hljs-section">[48612]</span>: Script `chk_mysql` now returning 1
Nov 15 19:00:02 node101 Keepalived_vrrp<span class="hljs-section">[48612]</span>: VRRP_Script(chk_mysql) failed (exited with status 1)
Nov 15 19:00:02 node101 Keepalived_vrrp<span class="hljs-section">[48612]</span>: (VI_MYSQL) Changing effective priority from 101 to 81

<span class="hljs-comment">## 观察节点2 keepalived日志</span>
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: (VI_MYSQL) Backup received priority 0 advertisement
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: (VI_MYSQL) Receive advertisement timeout
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: (VI_MYSQL) Entering MASTER STATE
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: (VI_MYSQL) setting VIPs.
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: (VI_MYSQL) Sending/queueing gratuitous ARPs on ens18 for 192.168.31.100
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:53 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:58 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:58 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: (VI_MYSQL) Sending/queueing gratuitous ARPs on ens18 for 192.168.31.100
Nov 15 19:09:58 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:58 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:58 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100
Nov 15 19:09:58 node102 Keepalived_vrrp<span class="hljs-section">[13558]</span>: Sending gratuitous ARP on ens18 for 192.168.31.100

<span class="hljs-comment">## 查看vip情况</span>
<span class="hljs-section">[root@node101 ~]</span><span class="hljs-comment"># ip addr show dev ens18</span>
2: ens18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether bc:24:11:33:db:80 brd ff:ff:ff:ff:ff:ff
    inet 192.168.31.101/24 brd 192.168.31.255 scope global noprefixroute ens18
       valid_lft forever preferred_lft forever
    inet6 240e:3a1:4a76:d360:9017:c87b:599f:5/128 scope global dynamic noprefixroute 
       valid_lft 6744sec preferred_lft 3144sec
    inet6 240e:3a1:4a76:d360:4360:afd0:895b:8930/64 scope global dynamic noprefixroute 
       valid_lft 7006sec preferred_lft 3406sec
    inet6 fe80::6bfb:14c8:d785:33ba/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever

<span class="hljs-section">[root@node102 ~]</span><span class="hljs-comment"># ip addr show dev ens18</span>
2: ens18: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether bc:24:11:70:62:0d brd ff:ff:ff:ff:ff:ff
    inet 192.168.31.102/24 brd 192.168.31.255 scope global noprefixroute ens18
       valid_lft forever preferred_lft forever
    inet 192.168.31.100/24 scope global secondary ens18:vip
       valid_lft forever preferred_lft forever
    inet6 240e:3a1:4a76:d360:766b:5fde:6699:9c81/64 scope global dynamic noprefixroute 
       valid_lft 7021sec preferred_lft 3421sec
    inet6 fe80::6bfb:14c8:d785:33ba/64 scope link dadfailed tentative noprefixroute 
       valid_lft forever preferred_lft forever
    inet6 fe80::dd3d:a0e0:db46:cca0/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever

<span class="hljs-comment">## 查看节点2的状态</span>
mysql&gt; show variables like 'read_only'<span class="hljs-comment">;</span>
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| read_only     | OFF   |
+---------------+-------+
1 row in set (0.00 sec)
</code></pre>
<p><strong>E. 方案弱点 (一针见血)</strong></p>
<blockquote>
<p>⚠️ <strong>老兵提醒:</strong>  这个方案看起来很美，但在复杂的生产环境，它的“自动”可能会变成“自动惹祸”：</p>
</blockquote>
<ol>
<li>
<p><strong>没有“仲裁”机制：</strong>  如果主备之间的心跳网络断了（比如交换机故障），但两台服务器都活着，就会导致“脑裂”。双方都认为对方挂了，都抢着当<code>MASTER</code>，都会把自己变成可写，<strong>数据会彻底写乱</strong>！</p>
</li>
<li>
<p><strong>数据一致性隐患：</strong>  切换只依赖于简单的健康检查，没有MHA那种“捞数据”的过程。如果主库宕机前有一笔事务的binlog没来得及传到备库，这笔数据就<strong>永久丢失</strong>了。</p>
</li>
<li>
<p><strong>恢复流程复杂：</strong>  老的主库修好后，怎么让它重新以<code>SLAVE</code>的身份加入集群？这个过程自动化脚本很难做得完美，大概率需要DBA手动介入，反而增加了操作风险。</p>
</li>
</ol>
<p>正是因为有这些“坑”，所以很多严谨的团队，特别是金融行业，会选择下面这种看起来“笨”，但实际上更稳妥的方案。</p>
<h3 data-id="heading-4"><strong>方案二：生产级手动切换 (SOP保障)</strong></h3>
<p>这个方案的哲学是：<strong>机器负责监控和漂移VIP，但切换决策由人来做。</strong>  我们把Keepalived当成一个手动的、高效率的VIP切换工具，而不是一个自动决策系统。</p>
<p><strong>A. 核心思路</strong></p>
<p>两台服务器上的Keepalived配置文件<strong>完全一样</strong>！并且，<strong>在任何时候，只允许一台服务器上的Keepalived服务是运行状态</strong>。切换时，我们严格按照标准操作流程（SOP），先手动完成数据库角色的确认和变更，然后再“一停一启”Keepalived服务，完成VIP的切换。</p>
<p><strong>B. 统一配置文件 (两边完全一样)</strong></p>
<p>把下面这份配置原封不动地放到<code>mysql-node1</code>和<code>mysql-node2</code>的<code>/etc/keepalived/keepalived.conf</code>。</p>
<pre><code class="hljs language-perl" lang="perl">! Configuration File <span class="hljs-keyword">for</span> keepalived (Manual-Switch)

global_defs {
   <span class="hljs-comment"># 名字可以根据你的业务来，但两边要一样</span>
   router_id MYSQL_HA_CLUSTER
}

vrrp_instance VI_MYSQL {
    <span class="hljs-comment"># 默认都写MASTER，谁先启动谁就是MASTER</span>
    <span class="hljs-keyword">state</span> MASTER
    interface ens192             <span class="hljs-comment"># 根据你的实际网卡修改</span>
    virtual_router_id <span class="hljs-number">51</span>         <span class="hljs-comment"># 必须一样</span>
    priority <span class="hljs-number">100</span>                 <span class="hljs-comment"># 优先级一样，谁先启动谁优先</span>
    advert_int <span class="hljs-number">1</span>
    authentication {
        auth_type PASS
        auth_pass <span class="hljs-number">1111</span>
    }
    virtual_ipaddress {
        <span class="hljs-number">192.168</span>.<span class="hljs-number">31.100</span>       <span class="hljs-comment"># 根据你的VIP修改</span>
    }
    <span class="hljs-comment"># 注意！这个方案里，我们不使用任何的track_script或notify脚本！</span>
}
</code></pre>
<blockquote>
<p>⚠️ <strong>关键点:</strong>  这个配置里没有<code>track_script</code>！Keepalived不再关心MySQL的死活，它只做一个纯粹的VIP管理工具。它的启停，完全由DBA掌控。</p>
</blockquote>
<p><strong>C. 标准切换流程</strong></p>
<p>假设当前主库是<code>mysql-node1</code>，我们要切换到<code>mysql-node2</code>。</p>
<p><strong>第1步：在旧主库 <code>mysql-node1</code> 上操作</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 停止Keepalived服务，释放VIP</span>
systemctl stop keepalived
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Keepalived on old master stopped."</span>

<span class="hljs-comment"># 2. 确认VIP已释放</span>
ip a | grep <span class="hljs-string">"192.168.31.100"</span>  <span class="hljs-comment"># 确保这条命令没有任何输出</span>

<span class="hljs-comment"># 3. 将旧主库设置为只读，防止新数据写入</span>
mysql -e <span class="hljs-string">"SET GLOBAL read_only = ON;"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Old master is now read-only."</span>
</code></pre>
<p><strong>第2步：在新主库 <code>mysql-node2</code> 上操作</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 确认与旧主库的数据同步已完成 (非常重要！)</span>
<span class="hljs-comment"># 登录MySQL，执行 SHOW SLAVE STATUS\G，查看 Seconds_Behind_Master 是否为 0</span>
<span class="hljs-comment"># 在确认同步无延迟后，再进行下一步</span>

<span class="hljs-comment"># 2. 停止同步并提升为新主</span>
mysql -e <span class="hljs-string">"STOP SLAVE; SET GLOBAL read_only = OFF;"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"New master promoted."</span>

<span class="hljs-comment"># 3. 启动Keepalived服务，接管VIP</span>
systemctl start keepalived
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Keepalived on new master started."</span>
</code></pre>
<p><strong>第3步：验证</strong></p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 1. 在新主库 `mysql-node2` 上确认VIP已绑定</span>
ip a | <span class="hljs-keyword">grep</span> <span class="hljs-string">"192.168.31.100"</span>  <span class="hljs-comment"># 应该能看到VIP</span>

<span class="hljs-comment"># 2. 尝试用VIP连接数据库，并执行写操作，确认服务正常</span>
<span class="hljs-comment"># mysql -h 192.168.31.100 -u ... -p... -e "CREATE TABLE test_switch (id int); INSERT INTO test_switch VALUES (1);"</span>
</code></pre>
<p>这个流程清晰、可控，每一步都有明确的检查点，最大限度地避免了自动切换带来的不确定性。</p>
<h2 data-id="heading-5">4 运维最佳实践</h2>
<p>针对上面两种方案，我们的运维监控重点也不同。</p>
<p><strong>监控:</strong></p>
<ul>
<li><strong>对于方案一 (自动):</strong>  必须重点监控<code>/var/log/keepalived-mysql-state.log</code>这个自定义<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2597%25A5%25E5%25BF%2597%25E6%2596%2587%25E4%25BB%25B6%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6&amp;zhida_source=entity" ref="nofollow noopener noreferrer">日志文件</a>。任何状态切换都应该触发最高级别的告警，通知DBA立即介入检查。同时，要监控主备两边<code>read_only</code>的状态是否符合预期。</li>
<li><strong>对于方案二 (手动):</strong>  监控的重点是  <strong>“Keepalived进程的唯一性”</strong> 。必须有一个监控项，确保集群中永远只有一个<code>keepalived</code>进程在运行。一旦发现两个都在运行，必须立即告警，这是脑裂的前兆！</li>
<li><strong>通用监控:</strong>  VIP的归属、MySQL主从复制延迟（<code>Seconds_Behind_Master</code>）是两种方案都必须死盯的指标。</li>
</ul>
<p><strong>日志分析:</strong></p>
<ul>
<li><code>tail -f /var/log/messages | grep Keepalived</code> 依然是排错第一神器。要学会看懂<code>Entering MASTER state</code>、<code>Entering BACKUP state</code>等关键日志。</li>
<li>在方案一中，<code>mysql_role_switch.sh</code>脚本的输出日志是判断切换是否成功、哪里卡住的关键依据。</li>
</ul>
<p><strong>“脑裂” (Split-Brain) 防治:</strong></p>
<ul>
<li><strong>方案一 (自动):</strong>  脑裂风险较高，唯一的物理缓解措施就是<strong>使用独立、可靠的心跳网络</strong>，比如两台服务器用一根网线直连，专门跑VRRP协议。</li>
<li><strong>方案二 (手动):</strong> <strong>从机制上杜绝了脑裂的发生</strong>。因为我们严格遵守“只启一个”的原则，只要SOP被严格执行，就不会出现两个节点都认为自己是主的混乱局面。这就是它“笨”却“稳”的核心优势。</li>
</ul>
<h2 data-id="heading-6">5 总结</h2>
<p>好了，兄弟们，今天我们把Keepalived配合MySQL的两种玩法都掰扯清楚了。</p>
<ul>
<li><strong>方案一 (自动切换):</strong>  像一辆“<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269081829%26content_type%3DArticle%26match_order%3D1%26q%3D%25E8%2587%25AA%25E5%258A%25A8%25E9%25A9%25BE%25E9%25A9%25B6%25E6%25B1%25BD%25E8%25BD%25A6%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269081829&amp;content_type=Article&amp;match_order=1&amp;q=%E8%87%AA%E5%8A%A8%E9%A9%BE%E9%A9%B6%E6%B1%BD%E8%BD%A6&amp;zhida_source=entity" ref="nofollow noopener noreferrer">自动驾驶汽车</a>”。适合那些对RTO（恢复时间目标）要求极高，但对数据一致性容忍度稍高（比如允许丢失几秒数据）的非核心业务。优点是快，缺点是“方向盘”不在你手里，极端情况下可能失控。</li>
<li><strong>方案二 (手动切换):</strong>  像一辆“手动挡的越野车”。它把切换的最终决定权牢牢地交还给了DBA。每一步操作都在你的掌控之中。它牺牲了一点点切换速度，但换来的是<strong>极高的可靠性和数据安全性</strong>。这在金融、核心交易等场景，是毋庸置疑的选择。</li>
</ul>
<p>技术方案没有绝对的“最好”，只有“最合适”。你问我推荐哪个？<strong>在你不完全确定你的业务能承受自动切换带来的风险之前，我强烈建议你从方案二开始。</strong>  先用最稳的方法把高可用搭起来，把SOP流程跑到滚瓜烂熟。等你对整个系统的脾气都摸透了，再考虑是否需要向自动化演进。</p>
<p>记住，作为一个生产环境的DBA，“稳”字永远是第一位的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 元年已经过去了]]></title>    <link>https://juejin.cn/post/7605262897650024483</link>    <guid>https://juejin.cn/post/7605262897650024483</guid>    <pubDate>2026-02-12T03:17:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605262897650024483" data-draft-id="7605468286180442147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 元年已经过去了"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-02-12T03:17:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="董章鱼是个攻城狮"/> <meta itemprop="url" content="https://juejin.cn/user/3644206058054766"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 元年已经过去了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3644206058054766/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    董章鱼是个攻城狮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T03:17:49.000Z" title="Thu Feb 12 2026 03:17:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好啊，我是董章鱼。</p>
<p>最近发生了两件事让我重新开始审视 AI。</p>
<p>第一件事，是我花了大概3天的时间，写了一个文档管理程序，用来管理我多如牛毛的文档。</p>
<p>可以实现批量修改、复制以及与飞书同步。</p>
<p>写这个程序的过程中，AI 大概贡献了 30% 的代码量，并且程序的基础框架是 AI 搭建的。</p>
<p>因为在最开始，我甚至连飞书的接口文档都没看。</p>
<p>现在程序已经比较稳定的在试运行了，当然还在持续优化。</p>
<p>如果没有 AI 我可能要花一周甚至很久来完成这个程序，因为大量的精力要花在研究飞书开放接口文档上。</p>
<p>第二件事，是公司在大力推广使用 AI Agent 进行编程。</p>
<p>之前一直以为对于一些难以理解的业务逻辑，AI 可能处理的不会很好。</p>
<p>直到我使用 Agent 让他来查找并修复某一强业务逻辑的代码后，让我眼前一亮。</p>
<p>它不仅完全理解了业务逻辑，而且在极短的时间内完成代码修复以及测试。</p>
<p>AI 编程的质量随着 AI 模型能力的提升，早已经比 2025 年年初大了一大截。</p>
<p>现在 Agent 的能力，毫不夸张的讲，完全可以替代中等水平程序员，有了 AI，一个人同时做多件事也成为了可能。</p>
<p>目前我也在不断探索如何很好的使用 Agent 来提高效率。</p>
<p>2025年的时候很多人说是AI编程的元年，没错。但是元年已经过去，AI 纪年开始了。</p>
<p>在未来徐徐展开的 AI 纪年中，最先而且最容易被替代的，就是程序员。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[核心业务系统国产化：如何实现 Oracle 逻辑的“零损耗”平移与性能重构？-CSDN博客]]></title>    <link>https://juejin.cn/post/7605451617286668315</link>    <guid>https://juejin.cn/post/7605451617286668315</guid>    <pubDate>2026-02-12T03:08:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605451617286668315" data-draft-id="7605495714294317082" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="核心业务系统国产化：如何实现 Oracle 逻辑的“零损耗”平移与性能重构？-CSDN博客"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-12T03:08:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户202306333566"/> <meta itemprop="url" content="https://juejin.cn/user/2777827690425212"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            核心业务系统国产化：如何实现 Oracle 逻辑的“零损耗”平移与性能重构？-CSDN博客
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2777827690425212/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户202306333566
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T03:08:49.000Z" title="Thu Feb 12 2026 03:08:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">核心业务系统国产化：如何实现 Oracle 逻辑的“零损耗”平移与性能重构？</h3>
<p>在当前的数字化转型浪潮中，核心业务系统向国产化底座迁移已成为行业共识。然而，对于习惯了 Oracle 生态的架构师和 DBA 而言，最艰巨的挑战并非单纯的数据搬迁，而是如何处理深耦合在存储过程、触发器以及特定语法（如 <code>CONNECT BY</code> 或 <code>ROWNUM</code>）中的业务逻辑。</p>
<p>如果选择彻底重写代码，高昂的开发成本与不可控的质量风险往往令人望而却步。本文将分享一种基于“深度语义兼容+自动化迁移矩阵”的实战思路，探讨如何在保持业务连续性的前提下，实现数据库底座的平滑演进。</p>
<hr/>
<h4 data-id="heading-1">一、 兼容性的进阶：从“语法适配”到“内核一致性”</h4>
<p>很多国产数据库声称兼容 Oracle，但实际落地时，往往在 <code>DBMS_PACKAGES</code> 的支持深度、<code>Sequence</code> 的并发缓存机制以及 <code>NULL</code> 值的处理细节上与原库存在偏差。这种“隐性差异”极易导致生产环境下的业务逻辑失效。</p>
<p>真正的平替方案（如金仓 KingbaseES）会在内核层面原生支持 Oracle 的编程模型。这意味着开发者可以保留原有的 PL/SQL 习惯，直接运行复杂的包（Package）和自治事务。</p>
<h5 data-id="heading-2">技术校验：存储过程与包逻辑的原生支持（SQL 示例）</h5>
<p>在某金融核心系统的适配中，我们直接验证了含递归查询与复杂类型处理的代码：</p>
<pre><code class="hljs language-bash" lang="bash">-- 验证：原生支持 Oracle 风格的层次查询与包结构
CREATE OR REPLACE PACKAGE biz_logic_pkg AS
    PROCEDURE adjust_inventory(p_item_id IN NUMBER, p_qty IN NUMBER);
END biz_logic_pkg;
/

CREATE OR REPLACE PACKAGE BODY biz_logic_pkg AS
    PROCEDURE adjust_inventory(p_item_id IN NUMBER, p_qty IN NUMBER) AS
    BEGIN
        -- 验证：支持 Oracle 特有的 MERGE INTO 语法
        MERGE INTO stock_tables s
        USING (SELECT * FROM incoming_data WHERE <span class="hljs-built_in">id</span> = p_item_id) i
        ON (s.item_id = i.id)
        WHEN MATCHED THEN 
            UPDATE SET s.quantity = s.quantity + p_qty
        WHEN NOT MATCHED THEN 
            INSERT (item_id, quantity) VALUES (i.id, p_qty);
        
        -- 验证：递归查询支持 (CONNECT BY)
        FOR rec IN (SELECT level, name FROM categories 
                    START WITH parent_id IS NULL 
                    CONNECT BY PRIOR <span class="hljs-built_in">id</span> = parent_id) LOOP
            NULL; -- 业务逻辑处理
        END LOOP;
    END;
END biz_logic_pkg;
/
</code></pre>
<hr/>
<h4 data-id="heading-3">二、 性能稳态：攻克国产化软硬栈下的并发瓶颈</h4>
<p>迁移至国产芯片（如鲲鹏、飞腾）环境后，由于 CPU 指令集架构的差异，数据库在高并发 DML 场景下容易出现锁竞争或 CPU 抖动。为了实现“迁云不降性能”，需要进行深度的系统级调优。</p>
<h5 data-id="heading-4">环境预检与性能对标（Shell 脚本）</h5>
<p>运维团队在割接前，应通过自动化脚本对 OS 内核参数（如大页内存、信号量）进行联动配置。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># 针对信创环境的数据库运行参数调优</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"正在优化系统内核参数..."</span>

<span class="hljs-comment"># 1. 配置透明大页 (HugePages)，减少 TLB Miss</span>
<span class="hljs-built_in">echo</span> always &gt; /sys/kernel/mm/transparent_hugepage/enabled

<span class="hljs-comment"># 2. 优化信号量，适配 Oracle 风格的高并发事务</span>
<span class="hljs-comment"># semmsl, semmns, semopm, semmni</span>
sysctl -w kernel.sem=<span class="hljs-string">"5010 641280 5010 128"</span>

<span class="hljs-comment"># 3. 开启数据库内核级的并行扫描策略</span>
<span class="hljs-comment"># 以金仓 KES 命令行工具为例</span>
ksql -U system -d prod_db -c <span class="hljs-string">"ALTER SYSTEM SET max_parallel_workers = 16;"</span>
ksql -U system -d prod_db -c <span class="hljs-string">"ALTER SYSTEM SET parallel_tuple_cost = 0.1;"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"环境调优完成，建议启动压力测试验证。"</span>
</code></pre>
<hr/>
<h4 data-id="heading-5">三、 质量保障：TB 级数据的自动化迁移矩阵</h4>
<p>面对核心系统数以亿计的存量数据，人工比对显然不可行。一套完整的迁移链路应包括“静态评估、增量同步、动态比对”三个阶段。</p>
<ol>
<li><strong>静态评估</strong>：利用评估工具（如 KDTS）自动识别不支持的触发器或动态 SQL，生成改写建议。</li>
<li><strong>增量同步</strong>：基于日志解析技术，在不停机的情况下实现数据毫秒级对齐。</li>
</ol>
<h5 data-id="heading-6">数据一致性校验逻辑（Java 示例）</h5>
<p>通过 JDBC 驱动同时连接源端与目标端，执行关键业务指标的抽样 Hash 比对，是上线前的最后一道防线。</p>
<pre><code class="hljs language-bash" lang="bash">public void verifyChecksum(String tableName) throws Exception {
    // 同时连接源端 Oracle 和目标端国产库
    Connection oraConn = DriverManager.getConnection(<span class="hljs-string">"jdbc:oracle:thin:@..."</span>);
    Connection kbsConn = DriverManager.getConnection(<span class="hljs-string">"jdbc:kingbase8://..."</span>);

    // 计算关键字段的 Hash 值或聚合 Sum 值进行快速校验
    String sql = <span class="hljs-string">"SELECT SUM(ora_hash(business_value)) FROM "</span> + tableName;
    
    // ... 执行比对逻辑 ...
    System.out.println(<span class="hljs-string">"表 "</span> + tableName + <span class="hljs-string">" 校验完成：数据 100% 对齐。"</span>);
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5a30b528e844331bc4b6ff5e5fae07c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjAyMzA2MzMzNTY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771470528&amp;x-signature=W%2Bp7wDzko%2B%2B4Yglzoial23NeDgM%3D" alt="金仓数据库KINGBASE ES架构图：展示其Oracle兼容内核、迁移工具链与高可用复制能力" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-7">四、 总结与选型参考</h4>
<p>国产化替代不仅是技术栈的迁移，更是对数字化底座的一次重新定义。在实际工程实践中，选型成功的关键在于：</p>
<ul>
<li><strong>低改动量</strong>：能否原生支持 Oracle 常用功能体系，减少业务重构成本。</li>
<li><strong>高可靠性</strong>：是否具备 RPO=0 的同步复制能力和故障自动切换机制。</li>
<li><strong>运维可管</strong>：是否具备图形化的性能诊断工具（如对标 Oracle AWR 的管理界面）。</li>
</ul>
<p><strong>结语：</strong><br/>
数据库国产化不应是一次“断裂式”的切换。通过选择具备扎实兼容基础与成熟迁移工具链的方案（如金仓 KingbaseES），架构师可以在最大程度利用既有 IT 资产的同时，构建起安全、可控、高性能的未来数据架构。</p>
<p><strong>您在核心库迁移中，遇到过最棘手的 SQL 兼容问题是什么？欢迎在评论区分享解决心得。</strong></p>
<hr/>
<p><strong>下一步建议：</strong> 如果您希望了解如何针对具体的 Oracle 复杂执行计划在国产环境下进行等效调优，我可以为您提供相关的案例对比分析。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ruby语音通知接口接入教程：Gem包集成与API请求逻辑详解]]></title>    <link>https://juejin.cn/post/7604984549172723721</link>    <guid>https://juejin.cn/post/7604984549172723721</guid>    <pubDate>2026-02-10T08:16:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7604984549172723721" data-draft-id="7604984549172707337" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ruby语音通知接口接入教程：Gem包集成与API请求逻辑详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-10T08:16:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户80269443385"/> <meta itemprop="url" content="https://juejin.cn/user/925127226441289"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ruby语音通知接口接入教程：Gem包集成与API请求逻辑详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/925127226441289/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户80269443385
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-10T08:16:33.000Z" title="Tue Feb 10 2026 08:16:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为Ruby开发者，你是否在接入Ruby语音通知接口时，遇到原生HTTP请求封装繁琐、MD5动态密码生成与Ruby字符串编码冲突、不同Gem包适配性差等问题？Ruby的生态虽丰富，但语音通知接口的加密规则、参数校验、频率限制等特殊要求，加上缺乏标准化的Gem包，导致接口接入效率低下。本文聚焦Ruby语音通知接口的完整接入流程，从Gem包封装到API请求逻辑拆解，提供可直接复用的代码示例，解决接口接入中的核心痛点，让你快速实现标准化、可复用的语音通知功能。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68f2f826baed46aea178126a4294a88a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODAyNjk0NDMzODU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771316196&amp;x-signature=TN06CDmi4BfB5y1KS3%2BcHy8eAk8%3D" alt="ad-7.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">一、Ruby 语音通知接口接入核心原理与痛点分析</h2>
<h3 data-id="heading-1">1.1 Ruby 语音通知接口的核心通信逻辑</h3>
<p>Ruby 语音通知接口的调用遵循 “参数封装→加密处理→HTTP 请求→响应解析” 的全流程，结合 Ruby 语言特性，核心逻辑可拆解为三层：</p>
<ol>
<li><strong>参数层</strong>：需严格遵循接口规范，拼接 account、mobile、content 等参数，且全程保证 UTF-8 编码，避免 Ruby 字符串默认编码引发的乱码问题；</li>
<li><strong>加密层</strong>：动态密码生成需按<code>account+APIKEY+mobile+content+time</code>顺序拼接字符串，通过 Ruby 的<code>Digest::MD5</code>库完成加密，这是接口调用成功的核心；</li>
<li><strong>传输层</strong>：支持 GET/POST 两种 HTTP 方法，推荐 POST（参数不暴露在 URL 中），需适配<code>application/x-www-form-urlencoded</code>请求头规范。</li>
</ol>
<h3 data-id="heading-2">1.2 Ruby 开发者接入的典型痛点</h3>
<ul>
<li><strong>封装效率低</strong>：原生<code>Net::HTTP</code>需编写大量样板代码，第三方 Gem（如 Faraday）虽简化请求，但适配语音通知接口的加密规则需额外定制；</li>
<li><strong>编码冲突</strong>：Ruby 的字符串编码（如 ASCII vs UTF-8）易导致中文 content 参数加密错误，进而触发接口<code>407</code>（敏感字符）或<code>4072</code>（模板不匹配）错误；</li>
<li><strong>无标准化复用方案</strong>：未封装为 Gem 包时，多项目接入需重复编写请求、加密、解析逻辑，维护成本高。</li>
</ul>
<h2 data-id="heading-3">二、Gem 包化开发：Ruby 语音通知接口封装实践</h2>
<h3 data-id="heading-4">2.1 Gem 包核心结构设计</h3>
<p>将 Ruby 语音通知接口封装为可复用的 Gem 包，是企业级项目的最佳实践，核心结构如下：</p>
<p>plaintext</p>
<pre><code class="hljs language-bash" lang="bash">ruby_voice_notify/
├── lib/
│   ├── ruby_voice_notify/
│   │   ├── client.rb       <span class="hljs-comment"># 核心请求类（加密、请求、解析）</span>
│   │   ├── error.rb        <span class="hljs-comment"># 自定义异常类</span>
│   │   └── version.rb      <span class="hljs-comment"># 版本号</span>
│   └── ruby_voice_notify.rb <span class="hljs-comment"># 入口文件</span>
├── ruby_voice_notify.gemspec <span class="hljs-comment"># Gem配置文件</span>
└── <span class="hljs-built_in">test</span>/                   <span class="hljs-comment"># 单元测试</span>
</code></pre>
<h3 data-id="heading-5">2.2 核心模块封装（完整代码）</h3>
<p>以下是 Gem 包核心<code>client.rb</code>的实现，包含加密、请求、解析全逻辑，且嵌入注册链接作为 API 凭证获取入口：</p>
<p>ruby</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">'net/http'</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">'uri'</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">'digest/md5'</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">'json'</span>

<span class="hljs-keyword">module</span> <span class="hljs-title class_">RubyVoiceNotify</span>
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span>
    <span class="hljs-comment"># 配置项（API凭证需从服务商后台获取，注册链接：http://user.ihuyi.com/?udcpF6）</span>
    <span class="hljs-built_in">attr_accessor</span> <span class="hljs-symbol">:account</span>, <span class="hljs-symbol">:api_key</span>, <span class="hljs-symbol">:api_url</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params"><span class="hljs-symbol">account:</span>, <span class="hljs-symbol">api_key:</span>, <span class="hljs-symbol">api_url:</span> <span class="hljs-string">'https://api.ihuyi.com/vm/Submit.json'</span></span>)
      <span class="hljs-variable">@account</span> = account
      <span class="hljs-variable">@api_key</span> = api_key
      <span class="hljs-variable">@api_url</span> = api_url
      <span class="hljs-keyword">raise</span> <span class="hljs-title class_">ArgumentError</span>, <span class="hljs-string">'account和api_key不能为空'</span> <span class="hljs-keyword">if</span> account.empty? |<span class="hljs-params"/>| api_key.empty?
    <span class="hljs-keyword">end</span>

    <span class="hljs-comment"># 发送语音通知（Ruby语音通知接口核心方法）</span>
    <span class="hljs-comment"># <span class="hljs-doctag">@param</span> mobile [String] 接收手机号，格式如139****8888</span>
    <span class="hljs-comment"># <span class="hljs-doctag">@param</span> content [String] 语音内容/模板变量</span>
    <span class="hljs-comment"># <span class="hljs-doctag">@param</span> template_id [Integer] 模板ID（调试用默认1361）</span>
    <span class="hljs-comment"># <span class="hljs-doctag">@return</span> [Hash] 响应结果：success(布尔)、msg(描述)、voice_id(流水号)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send</span>(<span class="hljs-params">mobile, content, template_id = <span class="hljs-literal">nil</span></span>)
      <span class="hljs-comment"># 1. 参数校验（避免无效请求）</span>
      validate_params(mobile, content)
      <span class="hljs-comment"># 2. 生成动态密码</span>
      time = <span class="hljs-title class_">Time</span>.now.to_i.to_s
      password = generate_dynamic_password(mobile, content, time)
      <span class="hljs-comment"># 3. 构建请求参数</span>
      params = build_params(mobile, content, time, password, template_id)
      <span class="hljs-comment"># 4. 发起POST请求</span>
      response = send_post_request(params)
      <span class="hljs-comment"># 5. 解析响应</span>
      parse_response(response)
    <span class="hljs-keyword">end</span>

    <span class="hljs-keyword">private</span>

    <span class="hljs-comment"># 参数校验（Ruby语音通知接口必选参数验证）</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_params</span>(<span class="hljs-params">mobile, content</span>)
      <span class="hljs-keyword">raise</span> <span class="hljs-title class_">ArgumentError</span>, <span class="hljs-string">'手机号格式错误（需11位，如139****8888）'</span> <span class="hljs-keyword">unless</span> mobile.match?(<span class="hljs-regexp">/^1[3-9]*{4}\d{4}$/</span>)
      <span class="hljs-keyword">raise</span> <span class="hljs-title class_">ArgumentError</span>, <span class="hljs-string">'语音内容不能为空'</span> <span class="hljs-keyword">if</span> content.empty?
    <span class="hljs-keyword">end</span>

    <span class="hljs-comment"># 生成MD5动态密码（遵循Ruby语音通知接口加密规则）</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_dynamic_password</span>(<span class="hljs-params">mobile, content, time</span>)
      raw_str = <span class="hljs-string">"<span class="hljs-subst">#{<span class="hljs-variable">@account</span>}</span><span class="hljs-subst">#{<span class="hljs-variable">@api_key</span>}</span><span class="hljs-subst">#{mobile}</span><span class="hljs-subst">#{content}</span><span class="hljs-subst">#{time}</span>"</span>
      <span class="hljs-title class_">Digest</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:MD5</span>.hexdigest(raw_str)
    <span class="hljs-keyword">end</span>

    <span class="hljs-comment"># 构建请求参数</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_params</span>(<span class="hljs-params">mobile, content, time, password, template_id</span>)
      params = {
        <span class="hljs-symbol">account:</span> <span class="hljs-variable">@account</span>,
        <span class="hljs-symbol">password:</span> password,
        <span class="hljs-symbol">mobile:</span> mobile,
        <span class="hljs-symbol">content:</span> content,
        <span class="hljs-symbol">time:</span> time
      }
      params[<span class="hljs-symbol">:templateid</span>] = template_id <span class="hljs-keyword">if</span> template_id
      params
    <span class="hljs-keyword">end</span>

    <span class="hljs-comment"># 发送POST请求（适配标准HTTP协议）</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_post_request</span>(<span class="hljs-params">params</span>)
      uri = <span class="hljs-variable constant_">URI</span>.parse(<span class="hljs-variable">@api_url</span>)
      http = <span class="hljs-title class_">Net::HTTP</span>.new(uri.host, uri.port)
      http.use_ssl = <span class="hljs-literal">true</span>
      http.open_timeout = <span class="hljs-number">10</span>
      http.read_timeout = <span class="hljs-number">10</span>

      request = <span class="hljs-title class_">Net::HTTP::Post</span>.new(uri.request_uri)
      request[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'application/x-www-form-urlencoded; charset=utf-8'</span>
      request.body = <span class="hljs-variable constant_">URI</span>.encode_www_form(params)

      http.request(request)
    <span class="hljs-keyword">rescue</span> =&gt; e
      <span class="hljs-keyword">raise</span> <span class="hljs-title class_">RubyVoiceNotify</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:RequestError</span>, <span class="hljs-string">"请求失败：<span class="hljs-subst">#{e.message}</span>"</span>
    <span class="hljs-keyword">end</span>

    <span class="hljs-comment"># 解析响应结果</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_response</span>(<span class="hljs-params">response</span>)
      response_data = <span class="hljs-variable constant_">JSON</span>.parse(response.body)
      code = response_data[<span class="hljs-string">'code'</span>].to_i
      msg = response_data[<span class="hljs-string">'msg'</span>] |<span class="hljs-params"/>| <span class="hljs-string">'未知错误'</span>
      voice_id = response_data[<span class="hljs-string">'voiceid'</span>] |<span class="hljs-params"/>| <span class="hljs-string">'0'</span>

      {
        <span class="hljs-symbol">success:</span> code == <span class="hljs-number">2</span>,
        <span class="hljs-symbol">msg:</span> code == <span class="hljs-number">2</span> ? <span class="hljs-string">"发送成功：<span class="hljs-subst">#{msg}</span>"</span> : <span class="hljs-string">"发送失败（错误码：<span class="hljs-subst">#{code}</span>）：<span class="hljs-subst">#{msg}</span>"</span>,
        <span class="hljs-symbol">voice_id:</span> voice_id
      }
    <span class="hljs-keyword">rescue</span> <span class="hljs-variable constant_">JSON</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:ParserError</span>
      <span class="hljs-keyword">raise</span> <span class="hljs-title class_">RubyVoiceNotify</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:ParseError</span>, <span class="hljs-string">'响应格式错误，非标准JSON'</span>
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  <span class="hljs-comment"># 自定义异常类</span>
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestError</span> &lt; <span class="hljs-title class_ inherited__">StandardError</span>; <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParseError</span> &lt; <span class="hljs-title class_ inherited__">StandardError</span>; <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3 data-id="heading-6">2.3 Gem 包打包与安装</h3>
<ol>
<li>编写<code>ruby_voice_notify.gemspec</code>配置文件：</li>
</ol>
<p>ruby</p>
<pre><code class="hljs language-ini" lang="ini">Gem::Specification.new do |spec|
  <span class="hljs-attr">spec.name</span>        = <span class="hljs-string">'ruby_voice_notify'</span>
  <span class="hljs-attr">spec.version</span>     = <span class="hljs-string">'0.1.0'</span>
  <span class="hljs-attr">spec.authors</span>     = [<span class="hljs-string">'Ruby Developer'</span>]
  <span class="hljs-attr">spec.email</span>       = [<span class="hljs-string">'dev@example.com'</span>]
  <span class="hljs-attr">spec.summary</span>     = <span class="hljs-string">'Ruby语音通知接口封装Gem包'</span>
  <span class="hljs-attr">spec.description</span> = <span class="hljs-string">'简化Ruby语音通知接口的加密、请求、解析流程'</span>
  <span class="hljs-attr">spec.homepage</span>    = <span class="hljs-string">'https://github.com/example/ruby_voice_notify'</span>
  <span class="hljs-attr">spec.license</span>     = <span class="hljs-string">'MIT'</span>

  <span class="hljs-attr">spec.files</span>       = Dir[<span class="hljs-string">'lib/**/*'</span>, <span class="hljs-string">'README.md'</span>]
  <span class="hljs-attr">spec.require_paths</span> = [<span class="hljs-string">'lib'</span>]

  <span class="hljs-attr">spec.required_ruby_version</span> = <span class="hljs-string">'&gt;= 2.6.0'</span>
end
</code></pre>
<p>2.  打包并安装 Gem：</p>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建Gem包</span>
gem build ruby_voice_notify.gemspec
<span class="hljs-comment"># 本地安装</span>
gem install ruby_voice_notify-0.1.0.gem
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d16bf2a023d49c48ede88abe4512632~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODAyNjk0NDMzODU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771316196&amp;x-signature=vCGaBWqhep%2BOhoP00DcIYcnfOWU%3D" alt="api.png" loading="lazy"/></p>
<h2 data-id="heading-7">三、Ruby 语音通知接口请求逻辑详解与调用示例</h2>
<h3 data-id="heading-8">3.1 核心逻辑对比：原生 Net::HTTP vs Gem 包</h3>
<p>表格</p>






























<table><thead><tr><th>维度</th><th>原生 Net::HTTP</th><th>封装后的 Gem 包</th></tr></thead><tbody><tr><td>代码量</td><td>50 + 行（含加密、请求、解析）</td><td>5 行（仅初始化 + 调用）</td></tr><tr><td>复用性</td><td>低（需重复编写）</td><td>高（多项目直接引用）</td></tr><tr><td>异常处理</td><td>需手动捕获所有异常</td><td>自定义异常，统一处理</td></tr><tr><td>维护成本</td><td>高（修改需改所有项目）</td><td>低（仅改 Gem 包）</td></tr></tbody></table>
<h3 data-id="heading-9">3.2 完整调用示例</h3>
<p>安装 Gem 包后，只需几行代码即可完成 Ruby 语音通知接口调用：</p>
<p>ruby</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># encoding: utf-8</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">'ruby_voice_notify'</span>

<span class="hljs-comment"># 1. 初始化客户端（替换为实际的account和api_key）</span>
client = <span class="hljs-title class_">RubyVoiceNotify::Client</span>.new(
  <span class="hljs-symbol">account:</span> <span class="hljs-string">'xxxxxxxx'</span>,
  <span class="hljs-symbol">api_key:</span> <span class="hljs-string">'xxxxxxxxx'</span>
)

<span class="hljs-comment"># 2. 调用Ruby语音通知接口发送语音通知</span>
<span class="hljs-keyword">begin</span>
  result = client.send(
    <span class="hljs-string">'138****1234'</span>, <span class="hljs-comment"># 接收手机号</span>
    <span class="hljs-string">'您的订单号是：8899。已由顺丰快递发出，请注意查收。'</span>, <span class="hljs-comment"># 语音内容</span>
    <span class="hljs-number">1361</span> <span class="hljs-comment"># 模板ID</span>
  )
  puts <span class="hljs-string">"调用结果：<span class="hljs-subst">#{result}</span>"</span>
  <span class="hljs-comment"># 成功输出示例：{:success=&gt;true, :msg=&gt;"发送成功：提交成功", :voice_id=&gt;"16236437872836"}</span>
<span class="hljs-keyword">rescue</span> =&gt; e
  puts <span class="hljs-string">"调用失败：<span class="hljs-subst">#{e.message}</span>"</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h2 data-id="heading-10">四、Ruby 语音通知接口常见问题排查与优化技巧</h2>
<h3 data-id="heading-11">4.1 高频错误码及 Ruby 专属解决方案（技巧总结）</h3>
<p>表格</p>








































<table><thead><tr><th>错误码</th><th>Ruby 场景核心原因</th><th>解决方案</th><th/><th/></tr></thead><tbody><tr><td>405</td><td>动态密码加密时字符串编码错误</td><td>脚本开头添加<code># encoding: utf-8</code>，确保所有字符串为 UTF-8</td><td/><td/></tr><tr><td>4052</td><td>服务器 IP 未备案</td><td>主流的 Ruby 语音通知接口服务商如互亿无线，需在后台添加服务器 IP 至白名单</td><td/><td/></tr><tr><td>4072</td><td>模板变量分隔符错误</td><td>Ruby 中强制使用英文 `</td><td><code>，可通过</code>content.gsub('｜', '</td><td>')` 替换中文分隔符</td></tr><tr><td>4081</td><td>频率超限</td><td>在 Gem 包中添加本地限流逻辑，用<code>Hash</code>缓存手机号调用时间，1 分钟内限制 3 次</td><td/><td/></tr></tbody></table>
<h3 data-id="heading-12">4.2 性能优化技巧</h3>
<ol>
<li><strong>异步调用</strong>：结合<code>Sidekiq</code>将 Ruby 语音通知接口调用放入异步任务，避免阻塞主流程：</li>
</ol>
<p>ruby</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># Sidekiq任务示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VoiceNotifyWorker</span>
  <span class="hljs-keyword">include</span> <span class="hljs-title class_">Sidekiq::Worker</span>

  <span class="hljs-keyword">def</span> <span class="hljs-title function_">perform</span>(<span class="hljs-params">mobile, content</span>)
    client = <span class="hljs-title class_">RubyVoiceNotify::Client</span>.new(<span class="hljs-symbol">account:</span> <span class="hljs-string">'xxxxxxxx'</span>, <span class="hljs-symbol">api_key:</span> <span class="hljs-string">'xxxxxxxxx'</span>)
    client.send(mobile, content)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

<span class="hljs-comment"># 调用异步任务</span>
<span class="hljs-title class_">VoiceNotifyWorker</span>.perform_async(<span class="hljs-string">'138****1234'</span>, <span class="hljs-string">'您的订单已发货！'</span>)
</code></pre>
<p>2.  <strong>重试机制</strong>：对<code>code=0</code>（提交失败）的场景，在 Gem 包中添加 3 次递增间隔重试（1s→2s→4s）；
3.  <strong>日志埋点</strong>：集成<code>logger</code>库，记录每次调用的参数、耗时、响应结果，便于线上问题排查。</p>
<h2 data-id="heading-13">五、总结与延伸</h2>
<h3 data-id="heading-14">总结</h3>
<ol>
<li>Ruby 语音通知接口的接入核心是解决字符串编码、MD5 加密、HTTP 请求适配三大问题，封装为 Gem 包可大幅提升复用性和维护效率；</li>
<li>对比原生开发，Gem 包化的 Ruby 语音通知接口调用代码量减少 90%，且异常处理更统一，适配企业级多项目场景；</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>