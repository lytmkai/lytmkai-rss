<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[一起学习TailWind Css]]></title>    <link>https://juejin.cn/post/7581279471745286178</link>    <guid>https://juejin.cn/post/7581279471745286178</guid>    <pubDate>2025-12-08T08:04:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581279471745286178" data-draft-id="7579851956211564596" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一起学习TailWind Css"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-12-08T08:04:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="曹卫平dudu"/> <meta itemprop="url" content="https://juejin.cn/user/3843548383544855"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一起学习TailWind Css
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548383544855/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    曹卫平dudu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:04:18.000Z" title="Mon Dec 08 2025 08:04:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TailWind Css</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2F" target="_blank" title="https://tailwindcss.com/" ref="nofollow noopener noreferrer">Tailwind</a>是一个能让你快速构建响应式布局，现代化页面的css框架，他能够改变目前前端页面编写css的方式，他是完全由你掌握，性能高效的css框架，通过直接使用框架内置的class来快速的调整页面的样式，打包时，框架通过对你的html，script,组件等class的扫码，生成相应的的静态css文件。</p>
<h2 data-id="heading-1">直接开始</h2>
<p>我们先跳过安装，<a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.tailwindcss.com%2F" target="_blank" title="https://play.tailwindcss.com/" ref="nofollow noopener noreferrer">直接来看效果直接上手来体验一下，点击跳转在线体验</a>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efb1ff8973b4467da17c39af5dae0697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785858&amp;x-signature=KRNldd5x6mGdEHunR82s8nQN%2Brw%3D" alt="image.png" loading="lazy"/>
清空左侧编辑栏，我们就可以直接写div了，写完的样式会实时展示在右侧的预览框内。</p>
<h4 data-id="heading-2">基础样式</h4>
<p>敲击class名会自动提示所有相近类名，下拉列表可以选择你想用的类名：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> class="<span class="hljs-attribute">flex</span> justify-center  bg-sky-<span class="hljs-number">300</span> text-<span class="hljs-number">6</span>xl m-<span class="hljs-number">4</span> <span class="hljs-selector-tag">p</span>-<span class="hljs-number">4</span> rounded-md shadow-lg  text-white <span class="hljs-attribute">font</span>-medium  "&gt;
  hello tailwind
&lt;/<span class="hljs-selector-tag">div</span>&gt;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4beb9fce4d3e4de187743edd676bc824~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785858&amp;x-signature=CKxFOgua75zw9UrH%2B%2B5CgxipEsE%3D" alt="image.png" loading="lazy"/>
其中：</p>
<ul>
<li>类名flex代表着display:flex</li>
<li>justify-center代表着justify-content:center</li>
<li>bg-sky-300代表着background-color: var(--color-sky-300)</li>
<li>text-6xl代表着font-size: var(--text-6xl);line-height: var(--tw-leading, var(--text-6xl--line-height));</li>
<li>m-4代表着 margin: calc(var(--spacing) * 4) 他的值并不是固定的4px，而是4rem</li>
<li>p-4代表着padding: calc(var(--spacing) * 4)，m和p搭配l、r、t、b、x、y分别代表着left、right、top、bottom，水平方向，垂直方向，如mx-4代表margin-left和margin-right距离是4rem，py-4就代拜着padding-top和padding-bottom距离是4rem</li>
<li>rounded-md代表着border-radius: var(--radius-md);</li>
<li>shadow-lg代表着--tw-shadow: 0 10px 15px -3px var(--tw-shadow-color, rgb(0 0 0 / 0.1)), 0 4px 6px -4px var(--tw-shadow-color, rgb(0 0 0 / 0.1));
box-shadow: var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow);shadow让我们的元素看起来更立体，经常用到，在tailwind中简单的shadow-* 立马就展示出效果</li>
<li>text-white代表着color: var(--color-white);</li>
<li>font-medium代表着--tw-font-weight: var(--font-weight-medium);font-weight: var(--font-weight-medium);
其他所有的类名，我们可以在<a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2Fdocs%2Finstallation%2Fusing-vite" target="_blank" title="https://tailwindcss.com/docs/installation/using-vite" ref="nofollow noopener noreferrer">tialwind官网页面</a>ctrl+K键进行搜索。</li>
</ul>
<h4 data-id="heading-3">动态伪类</h4>
<p>包括:hover:focus:active:first:last:odd:even:required:disabled:has:not:before:after等等，对于平常的css来说，要写这些伪类就有些费事了，但是用windtail就会变得方便快捷的多了。</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> class="<span class="hljs-attribute">flex</span> justify-between  bg-gray-<span class="hljs-number">100</span> w-auto rounded-md m-<span class="hljs-number">6</span> <span class="hljs-selector-tag">p</span>-<span class="hljs-number">6</span>   "&gt;
  &lt;<span class="hljs-selector-tag">div</span> class=" bg-white  shadow rounded-md <span class="hljs-selector-tag">p</span>-<span class="hljs-number">2</span> h-full "&gt;
    &lt;<span class="hljs-selector-tag">span</span>&gt;学习伪类的用法&lt;/<span class="hljs-selector-tag">span</span>&gt;
    &lt;<span class="hljs-selector-tag">span</span>&gt;hover,focus,active&lt;/<span class="hljs-selector-tag">span</span>&gt;
  &lt;/<span class="hljs-selector-tag">div</span>&gt;
  &lt;<span class="hljs-selector-tag">div</span> class="h-full <span class="hljs-selector-tag">p</span>-<span class="hljs-number">2</span> mr-<span class="hljs-number">10</span>  "&gt;
    &lt;<span class="hljs-selector-tag">button</span> class="<span class="hljs-selector-tag">p</span>-<span class="hljs-number">2</span> text-white rounded-lg  bg-violet-<span class="hljs-number">400</span> hover:bg-violet-<span class="hljs-number">600</span> focus:outline-<span class="hljs-number">2</span> focus:outline-offset-<span class="hljs-number">2</span> focus:outline-violet-<span class="hljs-number">500</span> active:bg-cyan-<span class="hljs-number">300</span><span class="hljs-string">"&gt;点击确认&lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
</span></code></pre>
<p>来看效果
正常状态bg-violet-400,背景颜色：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd05147dbe454956853a2af469b80f9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785858&amp;x-signature=Gm5pmlxHgnlsVH8rcaPk2wqkAD8%3D" alt="image.png" loading="lazy"/>
hover状态，只需要增加hover:bg-violet-600：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/468d205d1eb245a28a5e0f276213a1b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785858&amp;x-signature=Tz7TbtDtfx7T9xvYFYxURr%2BzSIg%3D" alt="image.png" loading="lazy"/>
focus状态，只需要增加focus:outline-2 focus:outline-offset-2 focus:outline-violet-500：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8356ef9f4c24b87b8814f962528993c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785858&amp;x-signature=fnvjtzVtVKNFXmI3o%2BpqYAs8LPE%3D" alt="image.png" loading="lazy"/>
active状态,只需要增加active:bg-cyan-300：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81682434fc454430b01aa5dcc70094a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785858&amp;x-signature=C7ldamQwFA0w7%2Bo%2Bh%2BVsdBgDUlk%3D" alt="image.png" loading="lazy"/></p>
<p>这样看来的话确实比直接写css样式要简单了许多。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2607fd13300e4ea4ba5bde892c7ad61b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785858&amp;x-signature=2VWuhBHaqjrHbCELphfctYo21ig%3D" alt="image.png" loading="lazy"/>
用before实习,只需要添加before:absolute before:-inset-1 before:block before:-skew-y-3 before:bg-pink-500这些类即可，他们对应的css是（这些伪类具体意义没有深究）：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.before</span>\:absolute {
  &amp;<span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-built_in">var</span>(--tw-content);
    <span class="hljs-attribute">position</span>: absolute;
  }
}
<span class="hljs-selector-class">.before</span>\:-inset-<span class="hljs-number">1</span> {
  &amp;<span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-built_in">var</span>(--tw-content);
    inset: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--spacing) * -<span class="hljs-number">1</span>);
  }
}
<span class="hljs-selector-class">.before</span>\:block {
  &amp;<span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-built_in">var</span>(--tw-content);
    <span class="hljs-attribute">display</span>: block;
  }
}
<span class="hljs-selector-class">.before</span>\:-skew-y-<span class="hljs-number">3</span> {
  &amp;<span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-built_in">var</span>(--tw-content);
    <span class="hljs-attr">--tw-skew-y</span>: <span class="hljs-built_in">skewY</span>(<span class="hljs-built_in">calc</span>(<span class="hljs-number">3deg</span> * -<span class="hljs-number">1</span>));
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">var</span>(--tw-rotate-x,) <span class="hljs-built_in">var</span>(--tw-rotate-y,) <span class="hljs-built_in">var</span>(--tw-rotate-z,) <span class="hljs-built_in">var</span>(--tw-skew-x,) <span class="hljs-built_in">var</span>(--tw-skew-y,);
  }
}
<span class="hljs-selector-class">.before</span>\:bg-pink-<span class="hljs-number">500</span> {
  &amp;<span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-built_in">var</span>(--tw-content);
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--color-pink-<span class="hljs-number">500</span>);
  }
}
</code></pre>
<p>对应的tailwind类名：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">span</span> class="relative inline-block before:absolute before:-inset-<span class="hljs-number">1</span> before:block before:-skew-y-<span class="hljs-number">3</span> before:bg-pink-<span class="hljs-number">500</span><span class="hljs-string">"&gt;
    &lt;span class="</span>relative text-white <span class="hljs-string">"&gt;独一无二&lt;/span&gt;
  &lt;/span&gt;
</span></code></pre>
<p>文件选择input框</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/836a606e6920413eb389ceee3790e908~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785858&amp;x-signature=ICtoW%2FhdZ4cUcpTFopKGUStLjHg%3D" alt="image.png" loading="lazy"/>
对应的css代码：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">input</span>
  type="file"
  class="bg-white rounded-full file:mr-<span class="hljs-number">4</span> file:rounded-full file:border-<span class="hljs-number">1</span>  file:bg-violet-<span class="hljs-number">50</span> file:px-<span class="hljs-number">4</span> file:py-<span class="hljs-number">2</span> file:text-sm file:font-semibold file:text-violet-<span class="hljs-number">700</span> hover:file:bg-violet-<span class="hljs-number">100</span> <span class="hljs-string">"
/&gt;
</span></code></pre>
<p>选中文字效果，selection:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07e50889486345dda4a990a2a58ca408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785858&amp;x-signature=tz6gNncy9fz8oBw7kVsnvyiswuA%3D" alt="image.png" loading="lazy"/>
只需要增加类selection:bg-fuchsia-300 selection:text-white即可。
整体来说稍微对tailwind熟悉一点，就能感觉到确实很快捷，我是个后端开发者，以前开发过html、js、css这些，最近无聊才接触的vue3，刚开始接触tailwind的时候确实有点感觉像是在写inline样式，但是用一两天就立马发现不一样了。<a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2Fdocs%2Fhover-focus-and-other-states%23pseudo-classes" target="_blank" title="https://tailwindcss.com/docs/hover-focus-and-other-states#pseudo-classes" ref="nofollow noopener noreferrer">所有的伪类class可以查看官网文档哟！</a></p>
<h4 data-id="heading-4">响应式样式</h4>
<p>tailwind是手机优先选择，也就是说设计页面样式时首先以小屏幕设备为准，加上他的变化点前缀后，就会在对应的屏幕宽度条件下生效对应的样式</p>



































<table><thead><tr><th align="center">变化点前缀</th><th align="center">最小的设备宽度</th><th align="center">对应的CSS</th></tr></thead><tbody><tr><td align="center"><code>sm</code></td><td align="center">40rem  <em>(640px)</em></td><td align="center"><code>@media (width &gt;= 40rem) { ... }</code></td></tr><tr><td align="center"><code>md</code></td><td align="center">48rem  <em>(768px)</em></td><td align="center"><code>@media (width &gt;= 48rem) { ... }</code></td></tr><tr><td align="center"><code>lg</code></td><td align="center">64rem  <em>(1024px)</em></td><td align="center"><code>@media (width &gt;= 64rem) { ... }</code></td></tr><tr><td align="center"><code>xl</code></td><td align="center">80rem  <em>(1280px)</em></td><td align="center"><code>@media (width &gt;= 80rem) { ... }</code></td></tr><tr><td align="center"><code>2xl</code></td><td align="center">96rem  <em>(1536px)</em></td><td align="center"><code>@media (width &gt;= 96rem) { ... }</code></td></tr></tbody></table>
<p>例如元素加上 “text-left sm:text-center md:bg-white lg:bg-blue”类后，元素的文字就会在宽度小于40rem（640px）的设备上靠左展示,大于40rem就会居中展示，大于48rem后就会背景颜色改为白色且居中展示，大于64rem背景色变为蓝色居中展示。
而且你可以通过配置theme来设定变化点的宽度</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@import</span> <span class="hljs-string">"tailwindcss"</span>;
<span class="hljs-keyword">@theme</span> { 
<span class="hljs-attr">--breakpoint-xs</span>: <span class="hljs-number">30rem</span>;
<span class="hljs-attr">--breakpoint-2xl</span>: <span class="hljs-number">100rem</span>;
<span class="hljs-attr">--breakpoint-3xl</span>: <span class="hljs-number">120rem</span>;
}
</code></pre>
<p>这样你就新增加了xs 和 3xl变化点，对应的设备宽度分别为30rem和120rem，修改了2xl的宽度，从默认的96rem修改为了100rem</p>
<h4 data-id="heading-5">Dark mode深色模式</h4>
<p>你只需要在需要在深色模式时改变样式的元素上增加  dark: 类型即可，例如你的div类名设置的是“bg-white dark:bg-gray-800”这两个类名，他们就代表着元素默认背景色是白色(bg-white)，深色模式下元素背景色是深灰色(bg-gray-800),就是这么简单。
如果想实现动态修改主题模式，可以在tailwind的css配置中加入"@custom-variant dark (&amp;:where(.dark, .dark *))" ，这样就代表着任何以 .dark开头的类名都会变成暗色模式，我们可以动态给body或者固定元素来添加或者删除dark类名来实现主题模式在亮色和暗色之间的自由切换了。</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> &gt;
  &lt;<span class="hljs-selector-tag">div</span> class="min-h-screen bg-white <span class="hljs-selector-tag">p</span>-<span class="hljs-number">10</span> text-gray-<span class="hljs-number">800</span> dark:bg-gray-<span class="hljs-number">900</span> dark:text-gray-<span class="hljs-number">200</span><span class="hljs-string">"&gt;
    &lt;button id="</span>toggle-dark<span class="hljs-string">" class="</span>rounded bg-blue-<span class="hljs-number">500</span> px-<span class="hljs-number">4</span> py-<span class="hljs-number">2</span> text-white dark:bg-blue-<span class="hljs-number">700</span><span class="hljs-string">"
     onclick="</span>document.body.classList.<span class="hljs-built_in">toggle</span>(<span class="hljs-string">'dark'</span>);"&gt;切换 Dark Mode&lt;/<span class="hljs-selector-tag">button</span>&gt;

    &lt;<span class="hljs-selector-tag">h1</span> class="mt-<span class="hljs-number">6</span> text-<span class="hljs-number">3</span>xl <span class="hljs-attribute">font</span>-bold"&gt;Tailwind Dark Mode 示例&lt;/<span class="hljs-selector-tag">h1</span>&gt;

    &lt;<span class="hljs-selector-tag">p</span> class="mt-<span class="hljs-number">2</span>"&gt;这是一个支持亮色/暗色模式的 Tailwind 页面。&lt;/<span class="hljs-selector-tag">p</span>&gt;

    &lt;<span class="hljs-selector-tag">div</span> class="mt-<span class="hljs-number">6</span> w-sm rounded bg-gray-<span class="hljs-number">100</span> <span class="hljs-selector-tag">p</span>-<span class="hljs-number">4</span> dark:bg-gray-<span class="hljs-number">800</span><span class="hljs-string">"&gt;这是一个会跟随 mode 变化背景色的容器。&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</span></code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a95386892d3449ea530df7990c288f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785858&amp;x-signature=MYl8gk2qjilEDRocq4PxxO%2FG248%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b7016c1b6b54e529a2e8e2d2d0e1759~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pu55Y2r5bmzZHVkdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785858&amp;x-signature=0wDte6%2BOyrJ7QaH0m3ZVGLE%2FHXU%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">个性化</h4>
<p>tailwind中的所有类都支持你的个性化配置，他们不光简单，而且还像api接口一样，支持自定义。
只需要在你的主css文件中，添加@theme来自定义你的类即可,例如我们在theme中添加 "--color-zhuti: #973F29;"这样我们就可以在div元素的类名里使用"bg-zhuti"这个颜色了，试想一下我们是不是可以把整个项目的基础颜色，字体大小都定义出来，在开发的时候用这些自定义的颜色、字体，我们最终整个项目的风格都是可变的了。</p>
<h4 data-id="heading-7">vue项目中引入tailwind</h4>
<p>首先创建你的项目：
npm create vite@latest your-project
然后安装插件：
npm install tailwindcss @tailwindcss/postcss postcss
配置vite.config</p>
<pre><code class="hljs language-vite.config.ts" lang="vite.config.ts">import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import tailwindcss from '@tailwindcss/vite'

// https://vite.dev/config/
export default defineConfig({
  plugins: [tailwindcss(),vue()],
})
</code></pre>
<p>配置tailwind.config.js，</p>
<pre><code class="hljs language-tailwind.config.js" lang="tailwind.config.js">/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{vue,js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
</code></pre>
<p>最后在你的css文件中引入</p>
<pre><code class="hljs language-src/style.css" lang="src/style.css">@import "tailwindcss";
</code></pre>
<p>这样就可以在vue中使用tailwind了，vscode中一定要安装<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dbradlc.vscode-tailwindcss" target="_blank" title="https://marketplace.visualstudio.com/items?itemName=bradlc.vscode-tailwindcss" ref="nofollow noopener noreferrer">tailwind的插件</a>,他可以检查你的theme中的语法，给你提示对应的类名，方便快捷。</p>
<h2 data-id="heading-8">结束语</h2>
<p>tailwind的功能远不止于此，这也是我接触tailwind两周，对其基础部分的了解。想更进一步的可以去看看JavaScript Mastery的视频。
第一次写文章，大部分还是参考<a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2F" target="_blank" title="https://tailwindcss.com/" ref="nofollow noopener noreferrer">官网</a>，可把我这后端开发难受坏了。。。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我使用openEuler构建出了一个自愈式系统监控平台]]></title>    <link>https://juejin.cn/post/7581041679190032419</link>    <guid>https://juejin.cn/post/7581041679190032419</guid>    <pubDate>2025-12-08T07:40:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581041679190032419" data-draft-id="7581041679190016035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我使用openEuler构建出了一个自愈式系统监控平台"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-08T07:40:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵手"/> <meta itemprop="url" content="https://juejin.cn/user/3668430176655997"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我使用openEuler构建出了一个自愈式系统监控平台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3668430176655997/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵手
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T07:40:54.000Z" title="Mon Dec 08 2025 07:40:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">第零章、当系统学会自我守护</h2>
<p>深夜的告警铃声总是格外刺耳。记得那个雨夜，核心服务因内存泄漏而崩溃，我们花了三个小时才恢复业务。那一刻我意识到，被动响应式的运维已经走到了尽头。真正的现代化运维，应该是系统能够自我感知、自我诊断，甚至在问题发生前就自动修复。
今天，我要在openEuler上构建一个智能运维平台，让系统拥有"自愈"能力。这不仅是技术实践，更是运维理念的革新——从"救火队员"到"系统医生"的转变。</p>
<h2 data-id="heading-1">第一章：基础设施监控体系</h2>
<h3 data-id="heading-2">1.1 系统基础监控部署</h3>
<p>让我们从最基础的系统监控开始，构建全方位的监控数据采集。</p>
<pre><code class="hljs language-dart" lang="dart">#!/bin/bash
# 系统监控数据采集脚本
# 文件名：system_monitor.sh

# 创建监控数据目录
MONITOR_DIR=<span class="hljs-string">"/opt/monitoring/data"</span>
LOG_DIR=<span class="hljs-string">"/opt/monitoring/logs"</span>
CONFIG_DIR=<span class="hljs-string">"/opt/monitoring/config"</span>

sudo mkdir -p $MONITOR_DIR $LOG_DIR $CONFIG_DIR
sudo chown -R $(whoami):$(whoami) /opt/monitoring

# 生成监控配置文件
cat &gt; $CONFIG_DIR/monitor_config.conf &lt;&lt; <span class="hljs-string">'EOF'</span>
# 监控配置
INTERVAL=<span class="hljs-number">5</span>
RETENTION_DAYS=<span class="hljs-number">7</span>
ALERT_CPU=<span class="hljs-number">80</span>
ALERT_MEMORY=<span class="hljs-number">85</span>
ALERT_DISK=<span class="hljs-number">90</span>
EOF

# 主监控循环函数
start_monitoring() {
    echo <span class="hljs-string">"$(date): 启动系统监控..."</span> | tee -a $LOG_DIR/monitor.log
    
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">true</span>; <span class="hljs-keyword">do</span>
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        # 采集CPU使用率
        CPU_USAGE=$(top -bn1 | grep <span class="hljs-string">"Cpu(s)"</span> | awk <span class="hljs-string">'{print <span class="hljs-subst">$2</span>}'</span> | cut -d<span class="hljs-string">'%'</span> -f1)
        
        # 采集内存使用率
        MEMORY_USAGE=$(free | grep Mem | awk <span class="hljs-string">'{printf("%.2f"), <span class="hljs-subst">$3</span>/<span class="hljs-subst">$2</span> * 100.0}'</span>)
        
        # 采集磁盘使用率
        DISK_USAGE=$(df / | awk <span class="hljs-string">'NR==2 {print <span class="hljs-subst">$5</span>}'</span> | cut -d<span class="hljs-string">'%'</span> -f1)
        
        # 采集系统负载
        LOAD_AVG=$(cat /proc/loadavg | awk <span class="hljs-string">'{print <span class="hljs-subst">$1</span>","<span class="hljs-subst">$2</span>","<span class="hljs-subst">$3</span>}'</span>)
        
        # 采集网络连接数
        CONNECTION_COUNT=$(ss -tun | wc -l)
        
        # 写入监控数据
        echo <span class="hljs-string">"<span class="hljs-subst">$TIMESTAMP</span>,CPU,<span class="hljs-subst">$CPU_USAGE</span>"</span> &gt;&gt; $MONITOR_DIR/system_metrics.csv
        echo <span class="hljs-string">"<span class="hljs-subst">$TIMESTAMP</span>,MEMORY,<span class="hljs-subst">$MEMORY_USAGE</span>"</span> &gt;&gt; $MONITOR_DIR/system_metrics.csv  
        echo <span class="hljs-string">"<span class="hljs-subst">$TIMESTAMP</span>,DISK,<span class="hljs-subst">$DISK_USAGE</span>"</span> &gt;&gt; $MONITOR_DIR/system_metrics.csv
        echo <span class="hljs-string">"<span class="hljs-subst">$TIMESTAMP</span>,LOAD,<span class="hljs-subst">$LOAD_AVG</span>"</span> &gt;&gt; $MONITOR_DIR/system_metrics.csv
        echo <span class="hljs-string">"<span class="hljs-subst">$TIMESTAMP</span>,CONNECTIONS,<span class="hljs-subst">$CONNECTION_COUNT</span>"</span> &gt;&gt; $MONITOR_DIR/system_metrics.csv
        
        # 检查告警条件
        check_alerts $CPU_USAGE $MEMORY_USAGE $DISK_USAGE
        
        # 等待下一个采集周期
        sleep <span class="hljs-number">5</span>
    done
}

# 告警检查函数
check_alerts() {
    local cpu=$<span class="hljs-number">1</span>
    local memory=$<span class="hljs-number">2</span>
    local disk=$<span class="hljs-number">3</span>
    
    source $CONFIG_DIR/monitor_config.conf
    
    <span class="hljs-keyword">if</span> (( $(echo <span class="hljs-string">"<span class="hljs-subst">$cpu</span> &gt; <span class="hljs-subst">$ALERT_CPU</span>"</span> | bc -l) )); then
        echo <span class="hljs-string">"$(date): CPU告警 - 使用率: <span class="hljs-subst">${cpu}</span>%"</span> &gt;&gt; $LOG_DIR/alerts.log
        send_alert <span class="hljs-string">"CPU"</span> $cpu
    fi
    
    <span class="hljs-keyword">if</span> (( $(echo <span class="hljs-string">"<span class="hljs-subst">$memory</span> &gt; <span class="hljs-subst">$ALERT_MEMORY</span>"</span> | bc -l) )); then
        echo <span class="hljs-string">"$(date): 内存告警 - 使用率: <span class="hljs-subst">${memory}</span>%"</span> &gt;&gt; $LOG_DIR/alerts.log
        send_alert <span class="hljs-string">"MEMORY"</span> $memory
    fi
    
    <span class="hljs-keyword">if</span> (( $(echo <span class="hljs-string">"<span class="hljs-subst">$disk</span> &gt; <span class="hljs-subst">$ALERT_DISK</span>"</span> | bc -l) )); then
        echo <span class="hljs-string">"$(date): 磁盘告警 - 使用率: <span class="hljs-subst">${disk}</span>%"</span> &gt;&gt; $LOG_DIR/alerts.log
        send_alert <span class="hljs-string">"DISK"</span> $disk
    fi
}

# 发送告警函数
send_alert() {
    local metric=$<span class="hljs-number">1</span>
    local value=$<span class="hljs-number">2</span>
    
    # 记录到系统日志
    logger -t <span class="hljs-string">"SystemMonitor"</span> <span class="hljs-string">"<span class="hljs-subst">$metric</span> 使用率超过阈值: <span class="hljs-subst">$value</span>%"</span>
    
    # 在真实环境中，这里可以集成邮件、短信、钉钉等告警方式
    echo <span class="hljs-string">"ALERT: <span class="hljs-subst">$metric</span> usage is <span class="hljs-subst">$value</span>%"</span> | tee -a $LOG_DIR/alert_notifications.log
}

# 数据清理函数
cleanup_old_data() {
    echo <span class="hljs-string">"$(date): 清理过期监控数据..."</span> &gt;&gt; $LOG_DIR/monitor.log
    find $MONITOR_DIR -name <span class="hljs-string">"*.csv"</span> -mtime +<span class="hljs-number">7</span> -exec rm -f {} \;
    find $LOG_DIR -name <span class="hljs-string">"*.log"</span> -mtime +<span class="hljs-number">30</span> -exec rm -f {} \;
}

# 启动监控
echo <span class="hljs-string">"启动系统监控平台..."</span>
start_monitoring
</code></pre>
<h3 data-id="heading-3">深度解析：</h3>
<p>这个监控脚本构建了一个完整的监控数据流水线。每5秒采集一次系统关键指标，包括CPU、内存、磁盘、负载和网络连接数。check_alerts函数实现了智能阈值检测，当资源使用率超过预设阈值时自动触发告警。send_alert函数为后续集成多种告警渠道预留了接口。这种设计体现了"监控即代码"的现代运维理念。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ea49877380c4ba2ba0ec7d3d0e973b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765784453&amp;x-signature=hBPbAIt3l7n%2FrxNHXNpxCDuOU%2Bc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">第二章：智能日志分析系统</h2>
<h3 data-id="heading-5">2.1 实时日志监控与分析</h3>
<p>日志是系统的"黑匣子"，智能分析能提前发现潜在问题。</p>
<pre><code class="hljs language-json" lang="json">#!/bin/bash
# 智能日志分析系统
# 文件名：log_analyzer.sh

LOG_FILES=(
    <span class="hljs-string">"/var/log/messages"</span>
    <span class="hljs-string">"/var/log/nginx/access.log"</span>
    <span class="hljs-string">"/var/log/nginx/error.log"</span> 
    <span class="hljs-string">"/var/log/php-fpm/error.log"</span>
)

PATTERNS=(
    <span class="hljs-string">"error"</span>
    <span class="hljs-string">"exception"</span>
    <span class="hljs-string">"timeout"</span>
    <span class="hljs-string">"connection refused"</span>
    <span class="hljs-string">"out of memory"</span>
    <span class="hljs-string">"disk full"</span>
)

# 创建日志分析目录
ANALYSIS_DIR=<span class="hljs-string">"/opt/monitoring/log_analysis"</span>
sudo mkdir -p $ANALYSIS_DIR
sudo chown -R $(whoami)<span class="hljs-punctuation">:</span>$(whoami) $ANALYSIS_DIR

# 实时日志监控函数
monitor_logs() <span class="hljs-punctuation">{</span>
    echo <span class="hljs-string">"$(date): 启动日志监控..."</span> | tee -a $ANALYSIS_DIR/analysis.log
    
    # 为每个日志文件启动监控进程
    for log_file in <span class="hljs-string">"${LOG_FILES[@]}"</span>; do
        if <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span> -f <span class="hljs-string">"$log_file"</span> <span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>; then
            monitor_single_log <span class="hljs-string">"$log_file"</span> &amp;
            echo <span class="hljs-string">"开始监控: $log_file (PID: $!)"</span> &gt;&gt; $ANALYSIS_DIR/analysis.log
        else
            echo <span class="hljs-string">"警告: 日志文件不存在: $log_file"</span> &gt;&gt; $ANALYSIS_DIR/analysis.log
        fi
    done
<span class="hljs-punctuation">}</span>

# 单个日志文件监控
monitor_single_log() <span class="hljs-punctuation">{</span>
    local log_file=$<span class="hljs-number">1</span>
    local log_name=$(basename <span class="hljs-string">"$log_file"</span>)
    
    tail -F <span class="hljs-string">"$log_file"</span> | while read line; do
        TIMESTAMP=$(date +<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>)
        
        # 检查是否匹配异常模式
        for pattern in <span class="hljs-string">"${PATTERNS[@]}"</span>; do
            if echo <span class="hljs-string">"$line"</span> | grep -qi <span class="hljs-string">"$pattern"</span>; then
                echo <span class="hljs-string">"$TIMESTAMP - [$log_name] - 检测到: $pattern"</span> &gt;&gt; $ANALYSIS_DIR/detected_errors.log
                echo <span class="hljs-string">"$line"</span> &gt;&gt; $ANALYSIS_DIR/detected_errors.log
                
                # 触发自动响应
                auto_response <span class="hljs-string">"$pattern"</span> <span class="hljs-string">"$line"</span> <span class="hljs-string">"$log_name"</span>
            fi
        done
        
        # 性能指标提取（针对Nginx访问日志）
        if <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span> <span class="hljs-string">"$log_name"</span> == <span class="hljs-string">"access.log"</span> <span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>; then
            analyze_nginx_access <span class="hljs-string">"$line"</span>
        fi
    done
<span class="hljs-punctuation">}</span>

# Nginx访问日志分析
analyze_nginx_access() <span class="hljs-punctuation">{</span>
    local line=$<span class="hljs-number">1</span>
    
    # 提取响应时间和状态码
    local response_time=$(echo <span class="hljs-string">"$line"</span> | grep -o 'rt=<span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-number">-9.</span><span class="hljs-punctuation">]</span>*' | cut -d'=' -f2)
    local status_code=$(echo <span class="hljs-string">"$line"</span> | awk '<span class="hljs-punctuation">{</span>print $<span class="hljs-number">9</span><span class="hljs-punctuation">}</span>')
    
    if <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span> -n <span class="hljs-string">"$response_time"</span> <span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>; then
        # 记录慢请求
        if (( $(echo <span class="hljs-string">"$response_time &gt; 5.0"</span> | bc -l) )); then
            echo <span class="hljs-string">"$(date) - 慢请求: ${response_time}秒 - $line"</span> &gt;&gt; $ANALYSIS_DIR/slow_requests.log
        fi
        
        # 记录错误状态码
        if <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span> <span class="hljs-string">"$status_code"</span> =~ ^<span class="hljs-punctuation">[</span><span class="hljs-number">45</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-number">-9</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">{</span><span class="hljs-number">2</span><span class="hljs-punctuation">}</span>$ <span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>; then
            echo <span class="hljs-string">"$(date) - 错误响应: $status_code - $line"</span> &gt;&gt; $ANALYSIS_DIR/error_responses.log
        fi
    fi
<span class="hljs-punctuation">}</span>

# 自动响应函数
auto_response() <span class="hljs-punctuation">{</span>
    local pattern=$<span class="hljs-number">1</span>
    local line=$<span class="hljs-number">2</span>
    local log_name=$<span class="hljs-number">3</span>
    
    case $pattern in
        <span class="hljs-string">"out of memory"</span>)
            echo <span class="hljs-string">"$(date): 检测到内存不足，自动清理缓存..."</span> &gt;&gt; $ANALYSIS_DIR/auto_responses.log
            sync &amp;&amp; echo <span class="hljs-number">3</span> | sudo tee /proc/sys/vm/drop_caches
            ;;
        <span class="hljs-string">"disk full"</span>)
            echo <span class="hljs-string">"$(date): 检测到磁盘空间不足..."</span> &gt;&gt; $ANALYSIS_DIR/auto_responses.log
            # 可以添加自动清理日志等操作
            ;;
        <span class="hljs-string">"connection refused"</span>)
            echo <span class="hljs-string">"$(date): 检测到连接拒绝，检查相关服务..."</span> &gt;&gt; $ANALYSIS_DIR/auto_responses.log
            check_service_status
            ;;
    esac
<span class="hljs-punctuation">}</span>

# 服务状态检查
check_service_status() <span class="hljs-punctuation">{</span>
    local services=(<span class="hljs-string">"nginx"</span> <span class="hljs-string">"php-fpm"</span> <span class="hljs-string">"mysql"</span>)
    
    for service in <span class="hljs-string">"${services[@]}"</span>; do
        if ! systemctl is-active --quiet <span class="hljs-string">"$service"</span>; then
            echo <span class="hljs-string">"$(date): 服务 $service 未运行，尝试重启..."</span> &gt;&gt; $ANALYSIS_DIR/auto_responses.log
            sudo systemctl restart <span class="hljs-string">"$service"</span>
        fi
    done
<span class="hljs-punctuation">}</span>

# 启动日志分析
echo <span class="hljs-string">"启动智能日志分析系统..."</span>
monitor_logs
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f05e021cfc284ca8957fa71f6601797f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765784453&amp;x-signature=Ne02XfvBjIlEo7W9dDM2tyluzuE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">深度解析：</h3>
<p>这个日志分析系统实现了真正的智能监控。monitor_logs函数为每个重要日志文件启动独立的监控进程，确保不会因为单个日志文件的问题影响整体监控。analyze_nginx_access函数专门针对Web服务器日志进行性能分析，能够自动识别慢请求和错误响应。最智能的是auto_response函数，它实现了基于日志内容的自动修复——内存不足时自动清理缓存，服务异常时自动重启。</p>
<h2 data-id="heading-7">第三章：性能趋势预测</h2>
<h3 data-id="heading-8">3.1 基于历史数据的智能预测</h3>
<p>利用简单机器学习算法预测系统趋势。</p>
<pre><code class="hljs language-dart" lang="dart">#!/usr/bin/env python3
# 性能趋势预测系统
# 文件名：performance_predictor.py

<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
from datetime <span class="hljs-keyword">import</span> datetime, timedelta
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> os

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PerformancePredictor</span>:
    <span class="hljs-title">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-title">self</span>, <span class="hljs-title">data_dir</span>="/<span class="hljs-title">opt</span>/<span class="hljs-title">monitoring</span>/<span class="hljs-title">data</span>"):
        <span class="hljs-title">self</span>.<span class="hljs-title">data_dir</span> = <span class="hljs-title">data_dir</span>
        <span class="hljs-title">self</span>.<span class="hljs-title">forecast_file</span> = <span class="hljs-title">os</span>.<span class="hljs-title">path</span>.<span class="hljs-title">join</span>(<span class="hljs-title">data_dir</span>, "<span class="hljs-title">performance_forecast</span>.<span class="hljs-title">json</span>")
        
    <span class="hljs-title">def</span> <span class="hljs-title">load_historical_data</span>(<span class="hljs-title">self</span>):
        """加载历史性能数据"""
        <span class="hljs-title">try</span>:
            <span class="hljs-title">data_file</span> = <span class="hljs-title">os</span>.<span class="hljs-title">path</span>.<span class="hljs-title">join</span>(<span class="hljs-title">self</span>.<span class="hljs-title">data_dir</span>, "<span class="hljs-title">system_metrics</span>.<span class="hljs-title">csv</span>")
            <span class="hljs-title">if</span> <span class="hljs-title">not</span> <span class="hljs-title">os</span>.<span class="hljs-title">path</span>.<span class="hljs-title">exists</span>(<span class="hljs-title">data_file</span>):
                <span class="hljs-title">return</span> <span class="hljs-title">None</span>
                
            # 读取<span class="hljs-title">CSV</span>数据
            <span class="hljs-title">df</span> = <span class="hljs-title">pd</span>.<span class="hljs-title">read_csv</span>(<span class="hljs-title">data_file</span>, <span class="hljs-title">header</span>=<span class="hljs-title">None</span>, <span class="hljs-title">names</span>=['<span class="hljs-title">timestamp</span>', '<span class="hljs-title">metric</span>', '<span class="hljs-title">value</span>'])
            
            # 转换时间戳
            <span class="hljs-title">df</span>['<span class="hljs-title">datetime</span>'] = <span class="hljs-title">pd</span>.<span class="hljs-title">to_datetime</span>(<span class="hljs-title">df</span>['<span class="hljs-title">timestamp</span>'], <span class="hljs-title">format</span>='%<span class="hljs-title">Y</span>%<span class="hljs-title">m</span>%<span class="hljs-title">d_</span>%<span class="hljs-title">H</span>%<span class="hljs-title">M</span>%<span class="hljs-title">S</span>')
            <span class="hljs-title">df</span> = <span class="hljs-title">df</span>.<span class="hljs-title">sort_values</span>('<span class="hljs-title">datetime</span>')
            
            <span class="hljs-title">return</span> <span class="hljs-title">df</span>
        <span class="hljs-title">except</span> <span class="hljs-title">Exception</span> <span class="hljs-title">as</span> <span class="hljs-title">e</span>:
            <span class="hljs-title">print</span>(<span class="hljs-title">f</span>"加载历史数据失败: </span>{e}<span class="hljs-string">")
            return None
    
    def simple_trend_analysis(self, metric_data, window=10):
        "</span><span class="hljs-string">""</span>简单趋势分析<span class="hljs-string">"""
        if len(metric_data) &lt; window:
            return "数据不足", 0
            
        recent_data = metric_data[-window:]
        trend = np.polyfit(range(len(recent_data)), recent_data, 1)[0]
        
        if trend &gt; 0.1:
            return "上升趋势", trend
        elif trend &lt; -0.1:
            return "下降趋势", trend
        else:
            return "平稳", trend
    
    def predict_issues(self, df):
        """</span>预测潜在问题<span class="hljs-string">"""
        predictions = {}
        metrics = df['metric'].unique()
        
        for metric in metrics:
            metric_df = df[df['metric'] == metric]
            values = metric_df['value'].astype(float).tolist()
            
            if len(values) &gt;= 10:  # 有足够数据进行分析
                trend, slope = self.simple_trend_analysis(values)
                
                # 基于趋势进行预测
                if metric == 'MEMORY' and trend == "上升趋势" and values[-1] &gt; 70:
                    predictions['memory_warning'] = {
                        'message': '内存使用率持续上升，可能在24小时内达到阈值',
                        'current': values[-1],
                        'trend': trend
                    }
                
                elif metric == 'DISK' and trend == "上升趋势" and values[-1] &gt; 80:
                    predictions['disk_warning'] = {
                        'message': '磁盘使用率快速增长，建议提前清理',
                        'current': values[-1],
                        'trend': trend
                    }
                
                elif metric == 'LOAD' and values[-1] &gt; 5 and trend == "上升趋势":
                    predictions['load_warning'] = {
                        'message': '系统负载持续升高，可能需要扩容',
                        'current': values[-1],
                        'trend': trend
                    }
        
        return predictions
    
    def generate_forecast(self):
        """</span>生成性能预测报告<span class="hljs-string">"""
        df = self.load_historical_data()
        if df is None:
            return {"status": "error", "message": "无历史数据"}
        
        predictions = self.predict_issues(df)
        
        forecast = {
            "timestamp": datetime.now().isoformat(),
            "predictions": predictions,
            "summary": {
                "total_warnings": len(predictions),
                "critical_issues": len([p for p in predictions.values() if 'critical' in p.get('message', '')])
            }
        }
        
        # 保存预测结果
        with open(self.forecast_file, 'w') as f:
            json.dump(forecast, f, indent=2)
        
        return forecast
    
    def run_prediction(self):
        """</span>运行预测任务<span class="hljs-string">"""
        print(f"{datetime.now()}: 运行性能趋势预测...")
        forecast = self.generate_forecast()
        
        # 输出预测结果
        if forecast['summary']['total_warnings'] &gt; 0:
            print("发现潜在问题:")
            for key, prediction in forecast['predictions'].items():
                print(f"  - {prediction['message']}")
        else:
            print("系统运行正常，未发现明显风险")
        
        return forecast

if __name__ == "__main__":
    predictor = PerformancePredictor()
    predictor.run_prediction()
</span></code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e89ac40c2ae64e8b9191bf4975c7e625~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765784453&amp;x-signature=PIokIQMaJZV3lNFgI%2FanPXjjX9M%3D" alt="" loading="lazy"/></p>
<p>输出的json：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a8f7d87eaef41ab8482183c6f07c6e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765784453&amp;x-signature=dbw7zUV4QJyAj3MJVQl1HQlacCM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">深度解析：</h3>
<p>这个预测系统将运维从"事后处理"升级到"事前预防"。simple_trend_analysis函数使用线性回归分析性能指标的变化趋势，虽然算法简单但非常实用。predict_issues方法基于业务规则进行智能判断——比如内存使用率持续上升且当前值较高时，会提前发出预警。这种预测性维护可以显著减少系统故障的发生概率。</p>
<h2 data-id="heading-10">第四章：自愈式运维平台</h2>
<h3 data-id="heading-11">4.1 集成智能运维工作流</h3>
<p>将各个组件整合成完整的自愈平台。</p>
<pre><code class="hljs language-dart" lang="dart">#!/bin/bash
# 智能运维平台主控脚本
# 文件名：smart_ops_platform.sh

PLATFORM_DIR=<span class="hljs-string">"/opt/monitoring"</span>
CONFIG_FILE=<span class="hljs-string">"<span class="hljs-subst">$PLATFORM_DIR</span>/config/platform.conf"</span>

# 初始化平台
initialize_platform() {
    echo <span class="hljs-string">"初始化智能运维平台..."</span>
    
    # 创建目录结构
    mkdir -p $PLATFORM_DIR/{bin,config,data,logs,scripts}
    
    # 生成平台配置
    cat &gt; $CONFIG_FILE &lt;&lt; <span class="hljs-string">'EOF'</span>
# 智能运维平台配置
MONITORING_ENABLED=<span class="hljs-keyword">true</span>
LOG_ANALYSIS_ENABLED=<span class="hljs-keyword">true</span>
PREDICTION_ENABLED=<span class="hljs-keyword">true</span>
AUTO_HEALING_ENABLED=<span class="hljs-keyword">true</span>

# 告警配置
ALERT_EMAIL=<span class="hljs-string">"admin@company.com"</span>
ALERT_PHONE=<span class="hljs-string">""</span>

# 服务监控列表
SERVICES=(<span class="hljs-string">"nginx"</span> <span class="hljs-string">"php-fpm"</span> <span class="hljs-string">"mysql"</span> <span class="hljs-string">"redis"</span>)

# 健康检查配置
HEALTH_CHECK_INTERVAL=<span class="hljs-number">60</span>
EOF

    echo <span class="hljs-string">"平台初始化完成"</span>
}

# 健康检查服务
health_check() {
    echo <span class="hljs-string">"$(date): 执行系统健康检查..."</span> &gt;&gt; $PLATFORM_DIR/logs/health.log
    
    source $CONFIG_FILE
    
    <span class="hljs-keyword">for</span> service <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-subst">${SERVICES[@]}</span>"</span>; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> systemctl <span class="hljs-keyword">is</span>-active --quiet <span class="hljs-string">"<span class="hljs-subst">$service</span>"</span>; then
            echo <span class="hljs-string">"$(date): 服务 <span class="hljs-subst">$service</span> 运行正常"</span> &gt;&gt; $PLATFORM_DIR/logs/health.log
        <span class="hljs-keyword">else</span>
            echo <span class="hljs-string">"$(date): 服务 <span class="hljs-subst">$service</span> 异常"</span> &gt;&gt; $PLATFORM_DIR/logs/health.log
            <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-subst">$AUTO_HEALING_ENABLED</span>"</span> == <span class="hljs-string">"true"</span> ]]; then
                auto_heal_service <span class="hljs-string">"<span class="hljs-subst">$service</span>"</span>
            fi
        fi
    done
    
    # 检查系统资源
    check_system_resources
}

# 自动修复服务
auto_heal_service() {
    local service=$<span class="hljs-number">1</span>
    echo <span class="hljs-string">"$(date): 尝试自动修复服务: <span class="hljs-subst">$service</span>"</span> &gt;&gt; $PLATFORM_DIR/logs/auto_heal.log
    
    # 停止服务
    sudo systemctl stop <span class="hljs-string">"<span class="hljs-subst">$service</span>"</span>
    sleep <span class="hljs-number">2</span>
    
    # 启动服务
    <span class="hljs-keyword">if</span> sudo systemctl start <span class="hljs-string">"<span class="hljs-subst">$service</span>"</span>; then
        echo <span class="hljs-string">"$(date): 服务 <span class="hljs-subst">$service</span> 修复成功"</span> &gt;&gt; $PLATFORM_DIR/logs/auto_heal.log
        send_notification <span class="hljs-string">"服务修复"</span> <span class="hljs-string">"服务 <span class="hljs-subst">$service</span> 已自动修复"</span>
    <span class="hljs-keyword">else</span>
        echo <span class="hljs-string">"$(date): 服务 <span class="hljs-subst">$service</span> 修复失败"</span> &gt;&gt; $PLATFORM_DIR/logs/auto_heal.log
        send_notification <span class="hljs-string">"服务修复失败"</span> <span class="hljs-string">"服务 <span class="hljs-subst">$service</span> 自动修复失败，需要人工干预"</span>
    fi
}

# 系统资源检查
check_system_resources() {
    local disk_usage=$(df / | awk <span class="hljs-string">'NR==2 {print <span class="hljs-subst">$5</span>}'</span> | cut -d<span class="hljs-string">'%'</span> -f1)
    local memory_usage=$(free | grep Mem | awk <span class="hljs-string">'{printf("%d"), <span class="hljs-subst">$3</span>/<span class="hljs-subst">$2</span> * 100.0}'</span>)
    
    <span class="hljs-keyword">if</span> [[ $disk_usage -gt <span class="hljs-number">90</span> ]]; then
        echo <span class="hljs-string">"$(date): 磁盘空间严重不足: <span class="hljs-subst">${disk_usage}</span>%"</span> &gt;&gt; $PLATFORM_DIR/logs/health.log
        auto_clean_disk
    fi
    
    <span class="hljs-keyword">if</span> [[ $memory_usage -gt <span class="hljs-number">90</span> ]]; then
        echo <span class="hljs-string">"$(date): 内存使用率过高: <span class="hljs-subst">${memory_usage}</span>%"</span> &gt;&gt; $PLATFORM_DIR/logs/health.log
        auto_clean_memory
    fi
}

# 自动磁盘清理
auto_clean_disk() {
    echo <span class="hljs-string">"$(date): 执行自动磁盘清理..."</span> &gt;&gt; $PLATFORM_DIR/logs/auto_heal.log
    
    # 清理日志文件
    find /<span class="hljs-keyword">var</span>/log -name <span class="hljs-string">"*.log"</span> -type f -mtime +<span class="hljs-number">7</span> -exec rm -f {} \; <span class="hljs-number">2</span>&gt;/dev/<span class="hljs-keyword">null</span>
    
    # 清理临时文件
    rm -rf /tmp<span class="hljs-comment">/*
    
    # 清理包缓存
    sudo dnf clean all
    
    echo "$(date): 磁盘清理完成" &gt;&gt; $PLATFORM_DIR/logs/auto_heal.log
}

# 自动内存清理
auto_clean_memory() {
    echo "$(date): 执行内存清理..." &gt;&gt; $PLATFORM_DIR/logs/auto_heal.log
    
    # 清理页面缓存、目录项和inodes
    sync
    echo 3 | sudo tee /proc/sys/vm/drop_caches
    
    echo "$(date): 内存清理完成" &gt;&gt; $PLATFORM_DIR/logs/auto_heal.log
}

# 发送通知
send_notification() {
    local subject=$1
    local message=$2
    
    # 记录到日志
    echo "$(date): 通知 - $subject: $message" &gt;&gt; $PLATFORM_DIR/logs/notifications.log
    
    # 这里可以集成邮件、短信等通知方式
    # 示例：发送到系统日志
    logger -t "SmartOps" "$subject: $message"
}

# 平台状态监控
monitor_platform() {
    echo "启动智能运维平台监控..."
    
    while true; do
        # 执行健康检查
        health_check
        
        # 运行性能预测
        if [[ "$PREDICTION_ENABLED" == "true" ]]; then
            python3 $PLATFORM_DIR/scripts/performance_predictor.py &gt;&gt; $PLATFORM_DIR/logs/prediction.log 2&gt;&amp;1
        fi
        
        # 等待下一个检查周期
        sleep 60
    done
}

# 主函数
main() {
    echo "========================================"
    echo "    OpenEuler 智能运维平台"
    echo "========================================"
    
    # 初始化平台
    initialize_platform
    
    # 启动平台监控
    monitor_platform
}

# 启动平台
main
</span></code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/107d89c239a04828a9964013f9207524~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765784453&amp;x-signature=c%2BRlyotI9k3j7wAfL0iJhZK1gic%3D" alt="" loading="lazy"/></p>
<p>过完60s之后，auto_heal_service会帮我们自动恢复已经关闭掉的mysql.service</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45f360aadd0c49d69146384f950366ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765784453&amp;x-signature=OAxItQhm0cBh%2BMaPH%2BDRMIdZrR4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">深度解析：</h3>
<p>这个智能运维平台实现了真正的"自愈"能力。health_check函数定期检查所有关键服务的状态，auto_heal_service在发现服务异常时自动尝试修复。auto_clean_disk和auto_clean_memory实现了资源自动管理，防止系统因资源耗尽而崩溃。整个平台通过monitor_platform函数协调各个组件，形成了完整的运维闭环。</p>
<h2 data-id="heading-13">总结：从自动化到智能化的演进</h2>
<p>通过这个智能运维平台的构建，我们见证了运维工作从手动操作到自动化，再到智能化的完整演进路径。系统不再是被管理的对象，而是拥有自我感知、自我诊断、自我修复能力的有机体。</p>
<h3 data-id="heading-14">技术价值体现：</h3>
<ul>
<li>预测性维护：通过趋势分析提前发现潜在问题</li>
<li>自动化修复：常见问题无需人工干预即可自动解决</li>
<li>智能决策：基于数据分析做出最优的运维决策</li>
<li>持续优化：通过反馈循环不断改进系统状态</li>
</ul>
<p>运维人员的角色从"救火队员"转变为"系统医生"，专注于处理真正的复杂问题和战略规划。这种转变不仅提升了系统稳定性，更释放了运维团队的生产力，让他们能够专注于更有价值的工作。</p>
<blockquote>
<p>如果您正在寻找面向未来的开源操作系统，不妨看看DistroWatch 榜单中快速上升的 openEuler:<a href="https://link.juejin.cn?target=https%3A%2F%2Fdistrowatch.com%2Ftable-mobile.php%3Fdistribution%3Dopeneuler" target="_blank" title="https://distrowatch.com/table-mobile.php?distribution=openeuler" ref="nofollow noopener noreferrer">distrowatch.com/table-mobil…</a>，一个由开放原子开源基金会孵化、支持“超节点”场景的Linux 发行版。
openEuler官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.openeuler.openatom.cn%2Fzh%2F" target="_blank" title="https://www.openeuler.openatom.cn/zh/" ref="nofollow noopener noreferrer">www.openeuler.openatom.cn/zh/</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Web 抓包完整实践指南，从浏览器网络调试到底层数据流捕获的全流程方案]]></title>    <link>https://juejin.cn/post/7581210455826497572</link>    <guid>https://juejin.cn/post/7581210455826497572</guid>    <pubDate>2025-12-08T08:12:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581210455826497572" data-draft-id="7581117416810905643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Web 抓包完整实践指南，从浏览器网络调试到底层数据流捕获的全流程方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-08T08:12:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Web 抓包完整实践指南，从浏览器网络调试到底层数据流捕获的全流程方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:12:14.000Z" title="Mon Dec 08 2025 08:12:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>对前端工程师、移动端调试、接口联调或性能优化而言，<strong>Web 抓包（Web Packet Capture / Web 流量分析）</strong> 是最常见的工作流程之一。无论是定位跨域问题、分析资源加载、排查 API 错误，还是检查 HTTPS 握手，都离不开抓包。</p>
<p>但随着 Web 技术体系不断演进——
HTTPS 默认化、HTTP/2/HTTP/3 普及、Service Worker 缓存、前端代理层干扰、浏览器安全策略加强——
开发者会越来越频繁地遇到：</p>
<ul>
<li>浏览器 DevTools 看不到真实请求</li>
<li>Charles/Proxyman 抓不到包</li>
<li>HTTP/3 走 QUIC，被代理忽略</li>
<li>WebSocket 数据无法被解析</li>
<li>部分请求被缓存、被重写或被拦截</li>
<li>跨端调试浏览器与移动端 Web 时数据不一致</li>
</ul>
<p>因此，Web 抓包不能只依赖浏览器工具，而要构建 <strong>多层级协同的抓包体系</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、Web 抓包为什么越来越难？</h2>
<h3 data-id="heading-1"><strong>HTTPS Everywhere 让明文抓包不再可能</strong></h3>
<p>所有 Web 请求默认加密，无法直接查看内容。</p>
<hr/>
<h3 data-id="heading-2"><strong>HTTP/2 / HTTP/3 多路复用导致请求在底层以流形式传输</strong></h3>
<p>浏览器 DevTools 虽能显示逻辑请求，但：</p>
<ul>
<li>代理工具抓到的是多路复用后的帧</li>
<li>HTTP/3（QUIC）甚至不走代理</li>
</ul>
<hr/>
<h3 data-id="heading-3"><strong>浏览器本身对网络请求做了优化</strong></h3>
<p>例如：</p>
<ul>
<li>预连接（preconnect）</li>
<li>资源合并（coalescing）</li>
<li>Cache / Service Worker 拦截</li>
<li>重定向链自动隐藏</li>
</ul>
<p>使得开发者无法看到“真实的网络行为”。</p>
<hr/>
<h3 data-id="heading-4"><strong>移动端浏览器流量不一定经过同一代理</strong></h3>
<p>例如：</p>
<ul>
<li>App 内置 WebView</li>
<li>微信 H5</li>
<li>本地 VPN</li>
<li>零信任方案</li>
</ul>
<p>结果是：<strong>浏览器能抓，WebView 抓不到；WebView 能抓，代理工具抓不到</strong>。</p>
<hr/>
<h2 data-id="heading-5">二、Web 抓包工具的分层体系</h2>
<p>不同工具负责不同抓包层面，组合使用才能覆盖各种网络情况。</p>
<hr/>
<h3 data-id="heading-6"><strong>① 浏览器 DevTools（应用层抓包）</strong></h3>
<p>适用于：</p>
<ul>
<li>查看 HTTP/HTTPS 请求</li>
<li>分析资源加载</li>
<li>Performance 调优</li>
</ul>
<p>不足：</p>
<ul>
<li>看不到 QUIC</li>
<li>看不到 TLS 握手</li>
<li>看不到网络层错误</li>
<li>看不到移动端真实流量</li>
</ul>
<hr/>
<h3 data-id="heading-7"><strong>② 代理抓包：Charles / Proxyman / Fiddler / mitmproxy</strong></h3>
<p>适用：</p>
<ul>
<li>HTTPS 解密</li>
<li>拦截并修改请求、响应</li>
<li>模拟弱网、注入错误响应</li>
</ul>
<p>不足：</p>
<ul>
<li>QUIC 不走代理</li>
<li>自定义协议无法处理</li>
<li>pinning WebView/内嵌浏览器会导致抓包失败</li>
</ul>
<hr/>
<h3 data-id="heading-8"><strong>③ 协议层抓包：Wireshark / tcpdump</strong></h3>
<p>擅长：</p>
<ul>
<li>分析 TCP 连接、TLS 握手</li>
<li>分析 HTTP/3／QUIC 数据</li>
<li>定位网络层问题（丢包、阻断）</li>
</ul>
<p>不足：</p>
<ul>
<li>噪音多，不易按 App 或浏览器过滤</li>
</ul>
<hr/>
<h3 data-id="heading-9"><strong>④ 底层补抓工具 —— 抓包大师（Sniffmaster）</strong></h3>
<p>当 Web 抓包遭遇：</p>
<ul>
<li>代理抓不到包</li>
<li>HTTP/3（QUIC）大量出现</li>
<li>WebView 不走系统代理</li>
<li>App 内浏览器有 pinning</li>
<li>需要分析底层 TCP/TLS 行为</li>
</ul>
<p>此时 Sniffmaster 能提供：</p>
<ul>
<li>捕获 <strong>HTTPS / TCP / UDP / HTTP</strong> 全数据流</li>
<li>自动识别协议类型（HTTP/HTTPS/mdns 等）</li>
<li>按 <strong>进程 / 域名过滤流量</strong></li>
<li>可查看 HEX / 文本 / 二进制</li>
<li>pcap 导出（可用 Wireshark 分析）</li>
<li>脚本拦截器用于修改请求或响应</li>
<li>支持 macOS、Windows、iOS</li>
</ul>
<p>Sniffmaster 可以补足浏览器和代理层无法处理的底层流量，是 Web 抓包体系中的关键一环。</p>
<hr/>
<h2 data-id="heading-10">三、Web 抓包失败的主要原因与解决方案</h2>
<hr/>
<h3 data-id="heading-11"><strong>浏览器 DevTools 能看，Charles 看不到 → QUIC / HTTP/3</strong></h3>
<p>如何验证：</p>
<ul>
<li>在 Wireshark 中看到 UDP 443</li>
<li>请求中有 <code>Alt-Svc: h3</code></li>
</ul>
<p>解决方式：</p>
<ul>
<li>禁用 HTTP/3</li>
<li>使用 Sniffmaster 捕获 QUIC/TCP 数据</li>
<li>分析 TLS 握手情况</li>
</ul>
<hr/>
<h3 data-id="heading-12"><strong>WebView 只能看到部分请求 → 内嵌浏览器未走系统代理</strong></h3>
<p>表现：</p>
<ul>
<li>浏览器能抓</li>
<li>App 内 H5 无法抓</li>
</ul>
<p>解决方式：</p>
<ul>
<li>使用 Sniffmaster 按应用过滤抓取真实流量</li>
<li>分析网络层行为</li>
</ul>
<hr/>
<h3 data-id="heading-13"><strong>HTTPS 抓不到包 → 证书 Pinning</strong></h3>
<p>典型场景：</p>
<ul>
<li>支付页</li>
<li>登录页</li>
<li>SDK 加载资源</li>
</ul>
<p>解决方法：</p>
<ul>
<li>代理层无效</li>
<li>必须使用底层补抓（Sniffmaster）</li>
</ul>
<hr/>
<h3 data-id="heading-14"><strong>TLS 握手失败导致 Web 抓包无法继续</strong></h3>
<p>使用 Sniffmaster + Wireshark 查看：</p>
<ul>
<li><code>unknown_ca</code> → 证书链问题</li>
<li><code>handshake_failure</code> → 协议版本问题</li>
<li><code>bad_certificate</code> → pinning</li>
</ul>
<hr/>
<h3 data-id="heading-15"><strong>WebSocket 抓不到包</strong></h3>
<p>WebSocket 如果走 wss + 自定义压缩格式，会导致代理无法还原数据。</p>
<p>解决方案：</p>
<ul>
<li>用 Sniffmaster 抓取底层 TCP 数据</li>
<li>用 HEX 或二进制格式查看实际帧</li>
</ul>
<hr/>
<h2 data-id="heading-16">四、Web 抓包完整流程</h2>
<hr/>
<h3 data-id="heading-17"><strong>步骤 1：浏览器 DevTools 查看逻辑请求</strong></h3>
<p>关注：</p>
<ul>
<li>Headers</li>
<li>Timing</li>
<li>Initiator</li>
<li>Redirect Chain</li>
</ul>
<hr/>
<h3 data-id="heading-18"><strong>步骤 2：代理工具分析 HTTPS 明文内容</strong></h3>
<p>关注：</p>
<ul>
<li>API 请求参数</li>
<li>Cookie</li>
<li>跨域相关头部</li>
<li>Cache-Control</li>
</ul>
<hr/>
<h3 data-id="heading-19"><strong>步骤 3：遇到抓不到包 → 使用 Sniffmaster 抓取底层数据流</strong></h3>
<p>流程：</p>
<ol>
<li>选择浏览器或 WebView 对应进程</li>
<li>捕获 HTTPS/TCP/UDP 数据流</li>
<li>查看协议识别结果</li>
<li>如果需要深度分析 → 导出 pcap 到 Wireshark</li>
<li>判断是：
<ul>
<li>QUIC？</li>
<li>TLS 握手失败？</li>
<li>不走代理？</li>
<li>自定义协议？</li>
</ul>
</li>
</ol>
<p>Sniffmaster 在此起“底层补抓”的作用。</p>
<hr/>
<h2 data-id="heading-20">五、真实案例：移动端 Web 页面加载异常但代理无数据</h2>
<p>现象：</p>
<ul>
<li>H5 页面部分接口超时</li>
<li>DevTools 显示请求 pending</li>
<li>Charles 无流量</li>
</ul>
<p>排查：</p>
<ol>
<li>Sniffmaster 按 App 过滤抓取</li>
<li>观察到大量 UDP 443 → HTTP/3</li>
<li>导出 pcap → Wireshark</li>
<li>QUIC Handshake 未完成 → 中间网络节点阻断</li>
</ol>
<p>结论：问题出在网络环境，而不是前端代码。</p>
<p>代理工具无法分析的场景，通过底层抓包得到完整复现。</p>
<hr/>
<h2 data-id="heading-21">Web 抓包的最佳工具组合</h2>






























<table><thead><tr><th>层级</th><th>工具</th><th>用途</th></tr></thead><tbody><tr><td>应用层</td><td>Chrome DevTools</td><td>逻辑请求分析</td></tr><tr><td>代理层</td><td>Charles / Fiddler / Proxyman</td><td>HTTPS 解密与调试</td></tr><tr><td>协议层</td><td>Wireshark / tcpdump</td><td>TLS、QUIC、TCP 分析</td></tr><tr><td>补抓层</td><td>抓包大师（Sniffmaster）</td><td>捕获真实数据流、解决 WebView/QUIC/pinning 等无法抓包场景</td></tr></tbody></table>
<p>现代 Web 抓包必须遵循“分层分析 + 工具组合”模式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS Grid 与 Flexbox：现代前端布局的双子星]]></title>    <link>https://juejin.cn/post/7581073928716451874</link>    <guid>https://juejin.cn/post/7581073928716451874</guid>    <pubDate>2025-12-08T08:15:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581073928716451874" data-draft-id="7581279471745368098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS Grid 与 Flexbox：现代前端布局的双子星"/> <meta itemprop="keywords" content="CSS,前端"/> <meta itemprop="datePublished" content="2025-12-08T08:15:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大知闲闲i"/> <meta itemprop="url" content="https://juejin.cn/user/3799545205237111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS Grid 与 Flexbox：现代前端布局的双子星
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3799545205237111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大知闲闲i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:15:38.000Z" title="Mon Dec 08 2025 08:15:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从 table 布局到现代布局的演变</h2>
<p>当我刚开始学习前端开发时，网页布局还是 table 标签和浮动（float）的天下。我依然记得那些为了对齐元素而嵌套的复杂表格，以及那些为了清除浮动而添加的 <code>clearfix</code> 类。那时候，实现一个简单的响应式布局都需要大量的 hack 技巧。而今天，CSS Grid 和 Flexbox 的出现彻底改变了这一切，它们不仅让复杂布局变得简单直观，更是开启了前端布局设计的新纪元。</p>
<h2 data-id="heading-1">CSS Flexbox：一维布局的王者</h2>
<h3 data-id="heading-2">Flexbox 的核心概念</h3>
<p>Flexbox（弹性盒子布局）是专为解决一维布局问题而设计的系统。所谓一维布局，就是处理<strong>行</strong>或<strong>列</strong>单一方向的布局。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: flex; <span class="hljs-comment">/* 或 inline-flex */</span>
  <span class="hljs-attribute">flex-direction</span>: row; <span class="hljs-comment">/* 主轴方向：row | row-reverse | column | column-reverse */</span>
  <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-comment">/* 主轴对齐方式 */</span>
  <span class="hljs-attribute">align-items</span>: center; <span class="hljs-comment">/* 交叉轴对齐方式 */</span>
  <span class="hljs-attribute">flex-wrap</span>: wrap; <span class="hljs-comment">/* 是否换行 */</span>
}
</code></pre>
<h3 data-id="heading-3">实战案例：导航栏的进化</h3>
<p>让我们通过一个实际案例来感受 Flexbox 的威力。下面是实现一个现代化导航栏的两种方式对比：</p>
<p><strong>传统浮动方式</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.nav</span> {
  <span class="hljs-attribute">overflow</span>: hidden; <span class="hljs-comment">/* 清除浮动 */</span>
}
​
<span class="hljs-selector-class">.nav-item</span> {
  <span class="hljs-attribute">float</span>: left;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">20px</span>;
}
​
<span class="hljs-selector-class">.nav-item</span><span class="hljs-selector-pseudo">:last-child</span> {
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">0</span>;
}
​
<span class="hljs-comment">/* 需要额外的 clearfix 类 */</span>
<span class="hljs-selector-class">.clearfix</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">display</span>: table;
  <span class="hljs-attribute">clear</span>: both;
}
</code></pre>
<p><strong>Flexbox 方式</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.nav</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: space-between;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>; <span class="hljs-comment">/* 现代CSS：项目间距 */</span>
}
</code></pre>
<p>Flexbox 不仅代码更简洁，更重要的是它解决了浮动布局中常见的问题：</p>
<ul>
<li>
<p>等高列的实现变得轻而易举</p>
</li>
<li>
<p>垂直居中不再需要 hack</p>
</li>
<li>
<p>项目的顺序可以随意调整</p>
</li>
</ul>
<h3 data-id="heading-4">Flexbox 的高级技巧</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 1. 完美的垂直水平居中 */</span>
<span class="hljs-selector-class">.center-element</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
}
​
<span class="hljs-comment">/* 2. 圣杯布局的实现 */</span>
<span class="hljs-selector-class">.holy-grail</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
}
​
<span class="hljs-selector-class">.holy-grail</span> <span class="hljs-selector-tag">main</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>; <span class="hljs-comment">/* 占据剩余所有空间 */</span>
  <span class="hljs-attribute">display</span>: flex;
}
​
<span class="hljs-comment">/* 3. 响应式卡片布局 */</span>
<span class="hljs-selector-class">.card-container</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-wrap</span>: wrap;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">16px</span>;
}
​
<span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span> <span class="hljs-number">1</span> <span class="hljs-number">300px</span>; <span class="hljs-comment">/* 弹性基准：至少300px，可以伸缩 */</span>
  <span class="hljs-comment">/* 当屏幕缩小，卡片会自动换行并保持最小宽度 */</span>
}
​
<span class="hljs-comment">/* 4. 控制子项的顺序和伸缩 */</span>
<span class="hljs-selector-class">.item</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) {
  <span class="hljs-attribute">order</span>: <span class="hljs-number">3</span>; <span class="hljs-comment">/* 改变显示顺序 */</span>
  <span class="hljs-attribute">flex-shrink</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 禁止缩小 */</span>
}
​
<span class="hljs-selector-class">.item</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) {
  <span class="hljs-attribute">flex-grow</span>: <span class="hljs-number">2</span>; <span class="hljs-comment">/* 占据更多剩余空间 */</span>
}
</code></pre>
<h2 data-id="heading-5">CSS Grid：二维布局的革命者</h2>
<h3 data-id="heading-6">Grid 布局的核心概念</h3>
<p>如果 Flexbox 是一维布局的解决方案，那么 CSS Grid 就是为二维布局（同时处理行和列）而生的强大工具。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">2</span>fr <span class="hljs-number">1</span>fr; <span class="hljs-comment">/* 定义列 */</span>
  <span class="hljs-attribute">grid-template-rows</span>: auto <span class="hljs-number">1</span>fr auto; <span class="hljs-comment">/* 定义行 */</span>
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">16px</span>; <span class="hljs-comment">/* 行列间距 */</span>
  <span class="hljs-attribute">grid-template-areas</span>: 
    <span class="hljs-string">"header header header"</span>
    <span class="hljs-string">"sidebar main aside"</span>
    <span class="hljs-string">"footer footer footer"</span>;
}
</code></pre>
<h3 data-id="heading-7">Grid 的网格系统革命</h3>
<p><strong>12列网格系统的实现对比</strong>：</p>
<p><strong>传统实现（使用浮动或Flexbox）</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.row</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">margin-left</span>: -<span class="hljs-number">15px</span>;
  <span class="hljs-attribute">margin-right</span>: -<span class="hljs-number">15px</span>;
}
​
<span class="hljs-selector-class">.col-4</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">33.333%</span>;
  <span class="hljs-attribute">padding-left</span>: <span class="hljs-number">15px</span>;
  <span class="hljs-attribute">padding-right</span>: <span class="hljs-number">15px</span>;
}
​
<span class="hljs-comment">/* 需要为每个断点重复定义 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
  <span class="hljs-selector-class">.col-4</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  }
}
</code></pre>
<p><strong>Grid 实现</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.grid-container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">12</span>, <span class="hljs-number">1</span>fr);
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">30px</span>;
}
​
<span class="hljs-selector-class">.item</span> {
  <span class="hljs-attribute">grid-column</span>: span <span class="hljs-number">4</span>; <span class="hljs-comment">/* 占据4列 */</span>
}
​
<span class="hljs-comment">/* 响应式调整 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
  <span class="hljs-selector-class">.item</span> {
    <span class="hljs-attribute">grid-column</span>: span <span class="hljs-number">12</span>; <span class="hljs-comment">/* 占据全部12列 */</span>
  }
}
</code></pre>
<p>Grid 的强大之处在于，你可以直接定义项目的开始和结束位置：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.item</span> {
  <span class="hljs-attribute">grid-column</span>: <span class="hljs-number">2</span> / <span class="hljs-number">5</span>; <span class="hljs-comment">/* 从第2条列线开始，到第5条列线结束 */</span>
  <span class="hljs-attribute">grid-row</span>: <span class="hljs-number">1</span> / <span class="hljs-number">3</span>;    <span class="hljs-comment">/* 从第1条行线开始，到第3条行线结束 */</span>
}
​
<span class="hljs-comment">/* 使用命名区域更直观 */</span>
<span class="hljs-selector-class">.header</span> { <span class="hljs-attribute">grid-area</span>: header; }
<span class="hljs-selector-class">.main</span>   { <span class="hljs-attribute">grid-area</span>: main; }
<span class="hljs-selector-class">.sidebar</span> { <span class="hljs-attribute">grid-area</span>: sidebar; }
<span class="hljs-selector-class">.footer</span> { <span class="hljs-attribute">grid-area</span>: footer; }
</code></pre>
<h3 data-id="heading-8">Grid 布局的创意应用</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 1. 瀑布流布局 */</span>
<span class="hljs-selector-class">.masonry</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fill, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">250px</span>, <span class="hljs-number">1</span>fr));
  <span class="hljs-attribute">grid-auto-rows</span>: <span class="hljs-number">10px</span>; <span class="hljs-comment">/* 基础行高 */</span>
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">16px</span>;
}

<span class="hljs-selector-class">.masonry-item</span> {
  <span class="hljs-comment">/* 每个项目可以跨越不同的行数 */</span>
  <span class="hljs-attribute">grid-row-end</span>: span <span class="hljs-built_in">var</span>(--item-height, <span class="hljs-number">20</span>);
}

<span class="hljs-comment">/* 2. 杂志式复杂布局 */</span>
<span class="hljs-selector-class">.magazine</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">2</span>fr <span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr;
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-number">400px</span> <span class="hljs-number">200px</span> <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">grid-template-areas</span>:
    <span class="hljs-string">"featured featured sidebar"</span>
    <span class="hljs-string">"featured featured story1"</span>
    <span class="hljs-string">"story2 story3 story4"</span>;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-comment">/* 3. 响应式网格自动适应 */</span>
<span class="hljs-selector-class">.responsive-grid</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-comment">/* 自动创建尽可能多的列，每列最小200px，最大1fr */</span>
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fit, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">200px</span>, <span class="hljs-number">1</span>fr));
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">16px</span>;
}

<span class="hljs-comment">/* 4. 网格线命名系统 */</span>
<span class="hljs-selector-class">.advanced-grid</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: 
    [sidebar-start] <span class="hljs-number">250px</span> 
    [sidebar-end content-start] <span class="hljs-number">1</span>fr 
    [content-end ads-start] <span class="hljs-number">300px</span> 
    [ads-end];
  <span class="hljs-attribute">grid-template-rows</span>: 
    [header-start] <span class="hljs-number">80px</span> 
    [header-end main-start] auto 
    [main-end footer-start] <span class="hljs-number">60px</span> 
    [footer-end];
}
</code></pre>
<h2 data-id="heading-9">Flexbox 与 Grid 的协同作战</h2>
<p>实际项目中，我们往往需要结合使用这两种布局模型。一个常见的误解是必须选择其一，实际上它们各有擅长：</p>
<h3 data-id="heading-10">黄金法则</h3>
<ul>
<li>
<p><strong>Flexbox</strong>：适合组件内部的布局（一维）</p>
</li>
<li>
<p><strong>Grid</strong>：适合整个页面的布局（二维）</p>
</li>
</ul>
<h3 data-id="heading-11">实际应用：仪表盘布局</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.dashboard</span> {
  <span class="hljs-comment">/* 整体布局使用 Grid */</span>
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">250px</span> <span class="hljs-number">1</span>fr;
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-number">60px</span> <span class="hljs-number">1</span>fr;
  <span class="hljs-attribute">grid-template-areas</span>:
    <span class="hljs-string">"sidebar header"</span>
    <span class="hljs-string">"sidebar main"</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
}

<span class="hljs-selector-class">.header</span> {
  <span class="hljs-attribute">grid-area</span>: header;
  <span class="hljs-comment">/* 内部布局使用 Flexbox */</span>
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: space-between;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span>;
}

<span class="hljs-selector-class">.sidebar</span> {
  <span class="hljs-attribute">grid-area</span>: sidebar;
  <span class="hljs-comment">/* 侧边栏导航使用 Flexbox 的列布局 */</span>
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
}

<span class="hljs-selector-class">.main-content</span> {
  <span class="hljs-attribute">grid-area</span>: main;
  <span class="hljs-comment">/* 主内容区使用 Grid 创建卡片网格 */</span>
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fit, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">300px</span>, <span class="hljs-number">1</span>fr));
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-comment">/* 单个卡片内部使用 Flexbox */</span>
<span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
}

<span class="hljs-selector-class">.card-header</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: space-between;
  <span class="hljs-attribute">align-items</span>: center;
}

<span class="hljs-selector-class">.card-content</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>; <span class="hljs-comment">/* 占据剩余空间 */</span>
}
</code></pre>
<h3 data-id="heading-12">性能考虑</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 不推荐的过度使用 */</span>
<span class="hljs-selector-class">.performance-issue</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-wrap</span>: wrap;
}

<span class="hljs-selector-class">.performance-issue</span> &gt; <span class="hljs-selector-tag">div</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span> <span class="hljs-number">1</span> <span class="hljs-number">300px</span>; <span class="hljs-comment">/* 每个项目都会重新计算布局 */</span>
}

<span class="hljs-comment">/* 推荐的改进方案 */</span>
<span class="hljs-selector-class">.performance-fixed</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fit, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">300px</span>, <span class="hljs-number">1</span>fr));
  <span class="hljs-comment">/* Grid 一次性计算布局，性能更优 */</span>
}
</code></pre>
<h2 data-id="heading-13">浏览器支持与渐进增强</h2>
<p>虽然现代浏览器对 Flexbox 和 Grid 的支持已经相当完善，但在实际项目中，我们仍需考虑兼容性策略：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 渐进增强策略示例 */</span>
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-comment">/* 回退方案：使用浮动布局 */</span>
  <span class="hljs-attribute">overflow</span>: hidden;
}

<span class="hljs-selector-class">.item</span> {
  <span class="hljs-attribute">float</span>: left;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">33.33%</span>;
}

<span class="hljs-comment">/* 现代浏览器使用 Flexbox */</span>
<span class="hljs-keyword">@supports</span> (<span class="hljs-attribute">display</span>: flex) {
  <span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">overflow</span>: visible;
  }
  
  <span class="hljs-selector-class">.item</span> {
    <span class="hljs-attribute">float</span>: none;
    <span class="hljs-attribute">width</span>: auto;
    <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
  }
}

<span class="hljs-comment">/* 更现代的浏览器使用 Grid */</span>
<span class="hljs-keyword">@supports</span> (<span class="hljs-attribute">display</span>: <span class="hljs-attribute">grid</span>) {
  <span class="hljs-selector-class">.container</span> {
    <span class="hljs-attribute">display</span>: grid;
    <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>fr);
  }
}
</code></pre>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue生命周期钩子详解与实战应用]]></title>    <link>https://juejin.cn/post/7581279471745351714</link>    <guid>https://juejin.cn/post/7581279471745351714</guid>    <pubDate>2025-12-08T08:12:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581279471745351714" data-draft-id="7581041679190081571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue生命周期钩子详解与实战应用"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-08T08:12:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱分享的鱼鱼"/> <meta itemprop="url" content="https://juejin.cn/user/3901536646733133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue生命周期钩子详解与实战应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3901536646733133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱分享的鱼鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:12:30.000Z" title="Mon Dec 08 2025 08:12:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d46a60d0d3384c22a9f8ab42eb4a5b0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5YiG5Lqr55qE6bG86bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765786350&amp;x-signature=xfrSJ9RC%2BzePvlklpkyIQsfKx0E%3D" alt="image.png" loading="lazy"/>
Vue的生命周期钩子是组件开发中的重要概念，它们允许我们在组件的不同阶段执行特定的逻辑。本文将详细介绍Vue 3中常用的生命周期钩子，并结合实际例子展示其应用场景。</p>
<h2 data-id="heading-0">什么是生命周期钩子？</h2>
<p>生命周期钩子是在组件从创建到销毁过程中自动调用的特殊函数。它们为我们提供了在特定时间点执行代码的机会。</p>
<h2 data-id="heading-1">主要生命周期钩子</h2>
<h3 data-id="heading-2">1. onMounted - 组件挂载完成</h3>
<p>当组件的DOM被渲染完成后调用，通常用于：</p>
<ul>
<li>发起网络请求</li>
<li>操作DOM元素</li>
<li>初始化第三方库</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;script setup&gt;
<span class="hljs-keyword">import</span> { ref, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> userList = <span class="hljs-title function_">ref</span>([])

<span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-comment">// 组件挂载后加载用户数据</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/users'</span>)
    userList.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载用户数据失败:'</span>, error)
  }
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-3">2. onBeforeMount - 组件挂载前</h3>
<p>在DOM渲染之前调用，此时还不能访问DOM元素：</p>
<pre><code class="hljs language-js" lang="js">&lt;script setup&gt;
<span class="hljs-keyword">import</span> { ref, onBeforeMount } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> isLoading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>)

<span class="hljs-title function_">onBeforeMount</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在DOM渲染前做一些准备工作</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件即将挂载...'</span>)
  isLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-4">3. onBeforeUpdate - 数据更新前</h3>
<p>在响应式数据改变后，DOM重新渲染前调用：</p>
<pre><code class="hljs language-js" lang="js">&lt;script setup&gt;
<span class="hljs-keyword">import</span> { ref, onBeforeUpdate } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> renderCount = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

<span class="hljs-title function_">onBeforeUpdate</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 每次更新前增加渲染计数</span>
  renderCount.<span class="hljs-property">value</span>++
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`组件即将第<span class="hljs-subst">${renderCount.value}</span>次更新`</span>)
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-5">4. onUpdated - 数据更新后</h3>
<p>在DOM重新渲染完成后调用：</p>
<pre><code class="hljs language-js" lang="js">&lt;script setup&gt;
<span class="hljs-keyword">import</span> { ref, onUpdated } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> message = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'Hello'</span>)

<span class="hljs-title function_">onUpdated</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// DOM更新完成后可以访问最新的DOM</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'DOM已更新完成'</span>)
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-6">5. onBeforeUnmount - 组件卸载前</h3>
<p>在组件卸载之前调用，用于清理工作：</p>
<pre><code class="hljs language-js" lang="js">&lt;script setup&gt;
<span class="hljs-keyword">import</span> { ref, onBeforeUnmount } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>

<span class="hljs-comment">// 启动定时器</span>
timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'定时任务执行中...'</span>)
}, <span class="hljs-number">1000</span>)

<span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 组件卸载前清除定时器</span>
  <span class="hljs-keyword">if</span> (timer) {
    <span class="hljs-built_in">clearInterval</span>(timer)
    timer = <span class="hljs-literal">null</span>
  }
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-7">6. onUnmounted - 组件卸载后</h3>
<p>在组件卸载完成后调用：</p>
<pre><code class="hljs language-js" lang="js">&lt;script setup&gt;
<span class="hljs-keyword">import</span> { onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 组件完全卸载后的清理工作</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件已被卸载'</span>)
})
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-8">实际应用案例</h2>
<h3 data-id="heading-9">完整的用户管理组件示例</h3>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"user-management"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>用户管理系统<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"loading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">v-else</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in users"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"user.id"</span>&gt;</span>
        {{ user.name }} - {{ user.email }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"refreshData"</span>&gt;</span>刷新数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onMounted, onBeforeUpdate, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> users = <span class="hljs-title function_">ref</span>([])
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> refreshCount = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">let</span> pollingTimer = <span class="hljs-literal">null</span>

<span class="hljs-comment">// 组件挂载时加载数据</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户管理组件已挂载'</span>)
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadUsers</span>()
  
  <span class="hljs-comment">// 启动轮询定时器</span>
  pollingTimer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadUsers</span>()
  }, <span class="hljs-number">30000</span>) <span class="hljs-comment">// 每30秒刷新一次</span>
})

<span class="hljs-comment">// 更新前记录刷新次数</span>
<span class="hljs-title function_">onBeforeUpdate</span>(<span class="hljs-function">() =&gt;</span> {
  refreshCount.<span class="hljs-property">value</span>++
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`数据第<span class="hljs-subst">${refreshCount.value}</span>次更新`</span>)
})

<span class="hljs-comment">// 组件卸载前清理资源</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户管理组件正在卸载'</span>)
  <span class="hljs-keyword">if</span> (pollingTimer) {
    <span class="hljs-built_in">clearInterval</span>(pollingTimer)
    pollingTimer = <span class="hljs-literal">null</span>
  }
})

<span class="hljs-comment">// 加载用户数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadUsers</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/users'</span>)
    users.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载用户失败:'</span>, error)
  } <span class="hljs-keyword">finally</span> {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
  }
}

<span class="hljs-comment">// 手动刷新数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">refreshData</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">loadUsers</span>()
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-10">最佳实践建议</h2>
<ol>
<li>
<p><strong>合理选择钩子时机</strong></p>
<ul>
<li>网络请求通常放在 <code>onMounted</code></li>
<li>资源清理放在 <code>onBeforeUnmount</code></li>
<li>DOM操作避免在 <code>onBeforeMount</code> 和 <code>onBeforeUpdate</code></li>
</ul>
</li>
<li>
<p><strong>注意内存泄漏</strong></p>
<ul>
<li>及时清理定时器、事件监听器等</li>
<li>使用 <code>onBeforeUnmount</code> 进行资源回收</li>
</ul>
</li>
<li>
<p><strong>异步操作处理</strong></p>
<ul>
<li>在组件卸载前取消未完成的异步请求</li>
<li>避免在已卸载组件上设置状态</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[UModel 查询：驯服“可观测性混乱”，阿里云的图模型建模利器！]]></title>    <link>https://juejin.cn/post/7581097545670524947</link>    <guid>https://juejin.cn/post/7581097545670524947</guid>    <pubDate>2025-12-08T08:26:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581097545670524947" data-draft-id="7580616979473252358" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="UModel 查询：驯服“可观测性混乱”，阿里云的图模型建模利器！"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-08T08:26:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            UModel 查询：驯服“可观测性混乱”，阿里云的图模型建模利器！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:26:00.000Z" title="Mon Dec 08 2025 08:26:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1AWSxBqEtQ%2F" target="_blank" title="https://www.bilibili.com/video/BV1AWSxBqEtQ/" ref="nofollow noopener noreferrer">点击此处，立即查看视频课程！</a></p>
<h2 data-id="heading-0">背景</h2>
<p>想象一下，你站在一个巨大的图书馆里，这里有成千上万本书，但每本书的目录都散落在不同的房间里，而且每间房间的索引方式都不一样。当你想要找一本关于“服务调用”的书时，你需要在 APM 房间、K8s 房间、云资源房间之间来回奔波，还要记住每个房间不同的查找规则...</p>
<p>这就是很多企业在可观测性领域面临的真实困境。而 UModel 就像是为这个混乱的图书馆建立了一套统一的“智能管理系统”，让你能够轻松探索和理解整个知识图谱的结构。</p>
<h3 data-id="heading-1">1.1 UModel 是什么</h3>
<p>UModel 是一种基于图模型的可观测数据建模方法，旨在解决企业级环境中可观测数据采集、组织和利用的核心挑战。UModel 采用 Node（节点）和 Link（边）组成的图结构来描述 IT 世界，通过标准化的数据建模方式，实现可观测数据的统一表示、存储解耦和智能分析。</p>
<p>作为阿里云可观测体系的数据建模基础，UModel 为企业提供了一套通用的可观测“交互语言”，让人、程序和 AI 都能够理解和分析可观测数据，从而构建真正的全栈可观测能力。</p>
<h4 data-id="heading-2">核心概念</h4>
<p>UModel 采用图论的基本概念，使用 Node（节点）和 Link（边）组成有向图来描述 IT 系统：</p>
<ul>
<li>Node（节点）：核心部分为 Set（数据集），表示同类型实体或数据的集合，如 EntitySet（实体集）、MetricSet（指标集）、LogSet（日志集）等；此外还包含数据集的存储类型（Storage），如 SLS、Prometheus、MySQL 等</li>
<li>Link（关联）：表示 Node 之间的关系，如 EntitySetLink（实体关联）、DataLink（数据关联）、StorageLink（存储关联）等</li>
<li>Field（字段）：用于约束和描述 Set 和 Link 的属性，包含名称、类型、约束规则、分析特性等 20 多种配置项</li>
</ul>
<h3 data-id="heading-3">1.2 UModel 查询是什么</h3>
<p>UModel 查询是 EntityStore 中用于查询知识图谱元数据的专用查询接口，通过 <code>.umodel </code>查询语法，可以探索 EntitySet 定义、EntitySetLink 关系以及完整的知识图谱结构，为数据建模分析和 Schema 管理提供强大支持。</p>
<h4 data-id="heading-4">查询目标区分</h4>
<p>UModel 查询与其他查询类型的区别：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e81bee11eb148fab48965bc2638cd23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765787160&amp;x-signature=9MZwRdZeKJoIEH7d9KARJOznCps%3D" alt="图片" loading="lazy"/></p>
<p>UModel 查询专注于元数据层面的探索，帮助用户理解数据模型的结构和定义，而非具体的运行时数据。</p>
<h2 data-id="heading-5">UModel 查询</h2>
<h3 data-id="heading-6">2.1 数据模型</h3>
<h4 data-id="heading-7">数据结构</h4>
<p>UModel 查询返回的数据具有固定的五字段结构：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccdea893da9a4cbc9d915fc03aa74c3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765787160&amp;x-signature=%2BGPa%2BHguPhM4HkYA1X0SBII8s%2B4%3D" alt="图片" loading="lazy"/></p>
<p>注意：<code>metadata、schema</code>、<code>spec</code> 是 JSON 格式的 string，需要使用 <code>json_extract_scalar</code> 函数进行提取。</p>
<h4 data-id="heading-8">数据示例</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad1bf5346b1a431385b4a2cadd0b6d74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765787160&amp;x-signature=w0ZDAJGkyyyN%2FyQuSIJEY4xH%2B1g%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-9">2.2 查询语法</h3>
<h4 data-id="heading-10">基础查询语法</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 基础查询格式</span>
.umodel <span class="hljs-operator">|</span> [SPL操作...]
<span class="hljs-comment">-- 带限制条件的查询</span>
.umodel <span class="hljs-operator">|</span> <span class="hljs-keyword">where</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">condition</span><span class="hljs-operator">&gt;</span> <span class="hljs-operator">|</span> limit <span class="hljs-operator">&lt;</span>count<span class="hljs-operator">&gt;</span>
</code></pre>
<h4 data-id="heading-11">核心查询模式</h4>
<h5 data-id="heading-12">1. List 场景 - 列表查询</h5>
<p>查询所有 UModel 数据：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-- 列出所有umodel数据（不建议使用）</span>
.umodel
<span class="hljs-deletion">-- 带分页的查询</span>
.umodel | limit 0, 10
</code></pre>
<p>按类型过滤：</p>
<pre><code class="hljs language-bash" lang="bash">-- 查询所有EntitySet定义
.umodel | <span class="hljs-built_in">where</span> kind = <span class="hljs-string">'entity_set'</span> | <span class="hljs-built_in">limit</span> 0, 10
-- 查询所有EntitySetLink定义
.umodel | <span class="hljs-built_in">where</span> kind = <span class="hljs-string">'entity_set_link'</span> | <span class="hljs-built_in">limit</span> 0, 10
-- 查询所有边类型（关系定义）
.umodel | <span class="hljs-built_in">where</span> __type__ = <span class="hljs-string">'link'</span> | <span class="hljs-built_in">limit</span> 0, 10
-- 查询所有节点类型（实体定义）
.umodel | <span class="hljs-built_in">where</span> __type__ = <span class="hljs-string">'node'</span> | <span class="hljs-built_in">limit</span> 0, 10
</code></pre>
<p>按属性过滤：</p>
<pre><code class="hljs language-bash" lang="bash">-- 查询特定名称的实体定义
.umodel | <span class="hljs-built_in">where</span> json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>) = <span class="hljs-string">'acs.ecs.instance'</span> | <span class="hljs-built_in">limit</span> 0, 10
-- 查询特定域的所有定义
.umodel | <span class="hljs-built_in">where</span> json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>) = <span class="hljs-string">'apm'</span> | <span class="hljs-built_in">limit</span> 0, 10
-- 查询多个域的定义
.umodel | <span class="hljs-built_in">where</span> json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>) <span class="hljs-keyword">in</span> (<span class="hljs-string">'acs'</span>, <span class="hljs-string">'apm'</span>, <span class="hljs-string">'k8s'</span>) | <span class="hljs-built_in">limit</span> 0, 10
</code></pre>
<h5 data-id="heading-13">2. 图计算场景 - 关系分析</h5>
<p>UModel 支持基于元数据的图计算，用于分析 EntitySet 之间的关系：</p>
<p>基础图查询语法：</p>
<pre><code class="hljs language-lua" lang="lua">.umodel | graph-<span class="hljs-built_in">match</span> &lt;<span class="hljs-built_in">path</span>&gt; project &lt;<span class="hljs-built_in">output</span>&gt;
</code></pre>
<p>基础概念：</p>
<p>在图查询中，有两个关键性的图概念：</p>
<p>节点类型，即 label 信息，在 UModel 的元数据图查询中，为 <code>&lt;domain&gt;@&lt;kind&gt;</code>，例如 <code>apm@entity_set</code>
节点 ID，即 <code>__entity_id__</code> 信息，在 UModel 的元数据图查询中，为 <code>kind::domain::name</code>，例如 <code>entity_set::apm::apm.service</code></p>
<p>图查询路径（PATH）使用 ASCII 字符描述关系方向：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/992db3f6a27d4e6bb3c9b1b89492762f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765787160&amp;x-signature=T09BDPNmUu3CZtxfjeZDsaTa4cE%3D" alt="图片" loading="lazy"/></p>
<p>查询 EntitySet 的邻居关系：</p>
<pre><code class="hljs language-css" lang="css">-- 查询特定EntitySet的所有关联关系
<span class="hljs-selector-class">.umodel</span> 
| graph-match (s:<span class="hljs-string">"acs@entity_set"</span> {__entity_id__: <span class="hljs-string">'entity_set::acs::acs.ecs.instance'</span>})
              -<span class="hljs-selector-attr">[e]</span>-(d) 
  project s, e, d | limit <span class="hljs-number">0</span>, <span class="hljs-number">10</span>
</code></pre>
<p>方向性关系查询：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- 查询指向某个EntitySet的关系</span>
.umodel 
| graph-<span class="hljs-built_in">match</span> (s:<span class="hljs-string">"acs@entity_set"</span> {__entity_id__: <span class="hljs-string">'entity_set::acs::acs.ecs.instance'</span>})
              &lt;<span class="hljs-comment">--(d) </span>
  project s, d | limit <span class="hljs-number">0</span>, <span class="hljs-number">10</span>
<span class="hljs-comment">-- 查询从某个EntitySet出发的关系  </span>
.umodel 
| graph-<span class="hljs-built_in">match</span> (s:<span class="hljs-string">"acs@entity_set"</span> {__entity_id__: <span class="hljs-string">'entity_set::acs::acs.ack.cluster'</span>})
              <span class="hljs-comment">--&gt;(d) </span>
  project s, d | limit <span class="hljs-number">0</span>, <span class="hljs-number">10</span>
</code></pre>
<h3 data-id="heading-14">2.3 高级查询功能</h3>
<h4 data-id="heading-15">JSON 路径提取</h4>
<p>由于 UModel 数据采用 JSON 结构存储，需要使用 JSON 函数进行字段提取：</p>
<pre><code class="hljs language-ini" lang="ini">-- 提取基础信息
.umodel 
| extend 
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">entity_domain</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>),
    <span class="hljs-attr">entity_description</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.description.zh_cn'</span>)
| project entity_name, entity_domain, entity_description | limit 0, 100
</code></pre>
<h4 data-id="heading-16">复杂条件筛选</h4>
<pre><code class="hljs language-java" lang="java">-- 多条件组合查询
.umodel 
| <span class="hljs-type">where</span> <span class="hljs-variable">kind</span> <span class="hljs-operator">=</span> <span class="hljs-string">'entity_set'</span>
  and <span class="hljs-title function_">json_extract_scalar</span><span class="hljs-params">(metadata, <span class="hljs-string">'$.domain'</span>)</span> in (<span class="hljs-string">'apm'</span>, <span class="hljs-string">'k8s'</span>)
  and <span class="hljs-title function_">json_array_length</span><span class="hljs-params">(json_extract(spec, <span class="hljs-string">'$.fields'</span>)</span>) &gt; <span class="hljs-number">5</span>
| <span class="hljs-type">extend</span> 
    <span class="hljs-variable">entity_name</span> <span class="hljs-operator">=</span> json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    field_count = json_array_length(json_extract(spec, <span class="hljs-string">'$.fields'</span>))
| sort field_count desc
| limit <span class="hljs-number">20</span>
</code></pre>
<h4 data-id="heading-17">聚合分析</h4>
<pre><code class="hljs language-ini" lang="ini">-- 按域统计EntitySet数量
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span>
| extend <span class="hljs-attr">domain</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>)
| stats <span class="hljs-attr">entity_count</span> = count() by domain
| sort entity_count desc
</code></pre>
<h3 data-id="heading-18">2.4 性能优化建议</h3>
<h4 data-id="heading-19">使用精确过滤</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 优化前：范围过大</span>
.umodel <span class="hljs-operator">|</span> <span class="hljs-keyword">where</span> json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>) <span class="hljs-keyword">like</span> <span class="hljs-string">'%service%'</span>
<span class="hljs-comment">-- 优化后：精确匹配</span>
.umodel <span class="hljs-operator">|</span> <span class="hljs-keyword">where</span> kind <span class="hljs-operator">=</span> <span class="hljs-string">'entity_set'</span> 
  <span class="hljs-keyword">and</span> json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>) <span class="hljs-operator">=</span> <span class="hljs-string">'apm'</span>
  <span class="hljs-keyword">and</span> json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>) <span class="hljs-operator">=</span> <span class="hljs-string">'apm.service'</span>
</code></pre>
<h4 data-id="heading-20">过滤前置</h4>
<pre><code class="hljs language-ini" lang="ini">-- 优化前：后期过滤
.umodel 
| extend <span class="hljs-attr">name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>)
| where <span class="hljs-attr">name</span> = <span class="hljs-string">'apm.service'</span>
-- 优化后：过滤前置
.umodel 
| where json_extract_scalar(metadata, '$.name') = 'apm.service'
| extend <span class="hljs-attr">name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>)
</code></pre>
<h4 data-id="heading-21">图查询优化</h4>
<pre><code class="hljs language-scss" lang="scss">-- 优化前：全图搜索
<span class="hljs-selector-class">.umodel</span> | graph-match (s)-<span class="hljs-selector-attr">[e]</span><span class="hljs-built_in">-</span>(d) project s, e, d
-- 优化后：指定起始点
<span class="hljs-selector-class">.umodel</span> 
| graph-match (s:"apm@entity_set" {__entity_id__: 'entity_set::apm::apm.service'})
              -<span class="hljs-selector-attr">[e]</span><span class="hljs-built_in">-</span>(d) 
  project s, e, d
</code></pre>
<h2 data-id="heading-22">UModel 查询具体应用场景</h2>
<p>UModel 查询在实际应用中能够解决多种场景下的问题，为数据建模、Schema 管理和知识图谱分析提供强大支持。</p>
<h3 data-id="heading-23">3.1 Schema 探索与发现</h3>
<h4 data-id="heading-24">场景描述</h4>
<p>在大型可观测性系统中，可能存在数百个 EntitySet 定义，分布在不同的域（domain）中。用户需要快速了解系统中定义了哪些实体类型，以及它们的基本信息。</p>
<h4 data-id="heading-25">应用示例</h4>
<p>探索所有实体类型：</p>
<pre><code class="hljs language-ini" lang="ini">-- 列出所有EntitySet及其基本信息
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span>
| extend 
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">entity_domain</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>),
    <span class="hljs-attr">description</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.description.zh_cn'</span>)
| project entity_name, entity_domain, description
| sort entity_domain, entity_name
| limit 0, 100
</code></pre>
<p>按域分类查看：</p>
<pre><code class="hljs language-ini" lang="ini">-- 查看特定域（如APM）下的所有实体定义
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span> 
  and json_extract_scalar(metadata, '$.domain') = 'apm'
| extend 
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">description</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.short_description.zh_cn'</span>)
| project entity_name, description
| limit 0, 50
</code></pre>
<h3 data-id="heading-26">3.2 数据建模分析</h3>
<h4 data-id="heading-27">场景描述</h4>
<p>在进行数据建模优化时，需要分析现有 EntitySet 的字段复杂度、主键设计、索引配置等信息，以便识别需要优化的模型。</p>
<h4 data-id="heading-28">应用示例</h4>
<p>分析字段复杂度：</p>
<pre><code class="hljs language-ini" lang="ini">-- 分析各域下EntitySet的字段数量分布
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span>
| extend 
    <span class="hljs-attr">domain</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>),
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">field_count</span> = json_array_length(json_extract(spec, <span class="hljs-string">'$.fields'</span>))
| stats 
    <span class="hljs-attr">avg_fields</span> = avg(field_count),
    <span class="hljs-attr">max_fields</span> = max(field_count),
    <span class="hljs-attr">min_fields</span> = min(field_count),
    <span class="hljs-attr">entity_count</span> = count()
  by domain
| sort entity_count desc
</code></pre>
<p>查找复杂实体：</p>
<pre><code class="hljs language-ini" lang="ini">-- 找出字段数量最多的EntitySet（可能需要优化）
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span>
| extend 
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">domain</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>),
    <span class="hljs-attr">field_count</span> = json_array_length(json_extract(spec, <span class="hljs-string">'$.fields'</span>))
| sort field_count desc
| limit 20
</code></pre>
<h3 data-id="heading-29">3.3 关系图谱分析</h3>
<h4 data-id="heading-30">场景描述</h4>
<p>理解 EntitySet 之间的关系对于构建完整的知识图谱至关重要。通过图查询可以分析实体间的关联关系，发现数据模型中的依赖和连接。</p>
<h4 data-id="heading-31">应用示例</h4>
<p>查询实体的所有关联关系：</p>
<pre><code class="hljs language-css" lang="css">-- 查询某个EntitySet（如apm<span class="hljs-selector-class">.service</span>）的所有关联关系
<span class="hljs-selector-class">.umodel</span> 
| graph-match (s:<span class="hljs-string">"apm@entity_set"</span> {__entity_id__: <span class="hljs-string">'entity_set::apm::apm.service'</span>})
              -<span class="hljs-selector-attr">[e]</span>-(d) 
  project s, e, d
| limit <span class="hljs-number">0</span>, <span class="hljs-number">50</span>
</code></pre>
<p>分析关系类型分布：</p>
<pre><code class="hljs language-ini" lang="ini">-- 统计不同关系类型的数量
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set_link'</span>
| extend 
    <span class="hljs-attr">link_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">link_type</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.link_type'</span>)
| stats <span class="hljs-attr">limk_count</span> = count() by link_type
| sort limk_count desc
</code></pre>
<p>查找特定关系：</p>
<pre><code class="hljs language-ini" lang="ini">-- 查找所有"runs_on"类型的关系定义
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set_link'</span>
  and json_extract_scalar(metadata, '$.link_type') = 'runs_on'
| extend 
    <span class="hljs-attr">link_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">source</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.source'</span>),
    <span class="hljs-attr">target</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.target'</span>)
| project link_name, source, target
</code></pre>
<h3 data-id="heading-32">3.4 元数据质量检查</h3>
<h4 data-id="heading-33">场景描述</h4>
<p>确保 UModel 元数据的完整性和一致性，检查缺失的描述、未定义的字段等问题。</p>
<h4 data-id="heading-34">应用示例</h4>
<p>检查缺失描述的 EntitySet：</p>
<pre><code class="hljs language-csharp" lang="csharp">-- 找出没有中文描述的EntitySet
.umodel 
| <span class="hljs-keyword">where</span> kind = <span class="hljs-string">'entity_set'</span>
  <span class="hljs-keyword">and</span> (json_extract_scalar(metadata, <span class="hljs-string">'$.description.zh_cn'</span>) = <span class="hljs-string">''</span> 
       <span class="hljs-function"><span class="hljs-keyword">or</span> <span class="hljs-title">json_extract_scalar</span>(<span class="hljs-params">metadata, <span class="hljs-string">'$.description.zh_cn'</span></span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)
| extend 
    entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    domain = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>)
| project entity_name, domain
</code></pre>
<p>验证字段定义完整性：</p>
<pre><code class="hljs language-csharp" lang="csharp">-- 检查没有定义字段的EntitySet
.umodel 
| <span class="hljs-keyword">where</span> kind = <span class="hljs-string">'entity_set'</span>
  <span class="hljs-keyword">and</span> (json_extract(spec, <span class="hljs-string">'$.fields'</span>) <span class="hljs-function"><span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> 
       <span class="hljs-keyword">or</span> <span class="hljs-title">json_array_length</span>(<span class="hljs-params">json_extract(spec, <span class="hljs-string">'$.fields'</span></span>))</span> = <span class="hljs-number">0</span>)
| extend 
    entity_name = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    domain = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>)
| project entity_name, domain
</code></pre>
<h3 data-id="heading-35">3.5 跨域关联分析</h3>
<h4 data-id="heading-36">场景描述</h4>
<p>在复杂的可观测性系统中，不同域（如 APM、K8s、云资源）的实体可能存在关联关系。通过 UModel 查询可以分析这些跨域的关联模式。</p>
<h4 data-id="heading-37">应用示例</h4>
<p>查找跨域关系：</p>
<pre><code class="hljs language-ini" lang="ini">-- 查找连接不同域的EntitySetLink
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set_link'</span>
| extend 
    <span class="hljs-attr">link_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">source_domain</span> = json_extract_scalar(spec, <span class="hljs-string">'$.src.domain'</span>),
    <span class="hljs-attr">target_domain</span> = json_extract_scalar(spec, <span class="hljs-string">'$.dest.domain'</span>)
| where source_domain != target_domain
| project link_name, source_domain, target_domain
| limit 0, 50
</code></pre>
<p>分析域间连接度：</p>
<pre><code class="hljs language-ini" lang="ini">-- 统计各域之间的连接关系数量
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set_link'</span>
| extend 
    <span class="hljs-attr">source_domain</span> = json_extract_scalar(spec, <span class="hljs-string">'$.src.domain'</span>),
    <span class="hljs-attr">target_domain</span> = json_extract_scalar(spec, <span class="hljs-string">'$.dest.domain'</span>)
| stats <span class="hljs-attr">count</span> = count() by source_domain, target_domain
| sort count desc
</code></pre>
<h3 data-id="heading-38">3.6 版本与演进分析</h3>
<h4 data-id="heading-39">场景描述</h4>
<p>UModel Schema 会随着业务发展而演进，需要跟踪 Schema 的版本变化和演进历史。</p>
<h4 data-id="heading-40">应用示例</h4>
<p>查看 Schema 版本信息：</p>
<pre><code class="hljs language-ini" lang="ini">-- 查看所有EntitySet的Schema版本
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span>
| extend 
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">schema_version</span> = json_extract_scalar(schema, <span class="hljs-string">'$.version'</span>),
    <span class="hljs-attr">schema_url</span> = json_extract_scalar(schema, <span class="hljs-string">'$.url'</span>)
| project entity_name, schema_version, schema_url
| limit 0, 100
</code></pre>
<h3 data-id="heading-41">3.7 快速定位与检索</h3>
<h4 data-id="heading-42">场景描述</h4>
<p>在大量元数据中快速找到特定的 EntitySet 或关系定义，支持模糊匹配和精确查询。</p>
<h4 data-id="heading-43">应用示例</h4>
<p>按名称模糊搜索：</p>
<pre><code class="hljs language-ini" lang="ini">-- 搜索包含"service"的EntitySet
.umodel 
| where <span class="hljs-attr">kind</span> = <span class="hljs-string">'entity_set'</span>
  and json_extract_scalar(metadata, '$.name') like '%service%'
| extend 
    <span class="hljs-attr">entity_name</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>),
    <span class="hljs-attr">domain</span> = json_extract_scalar(metadata, <span class="hljs-string">'$.domain'</span>)
| project entity_name, domain
| limit 0, 20
</code></pre>
<p>精确查找特定实体：</p>
<pre><code class="hljs language-bash" lang="bash">-- 精确查找特定EntitySet的完整定义
.umodel 
| <span class="hljs-built_in">where</span> json_extract_scalar(metadata, <span class="hljs-string">'$.name'</span>) = <span class="hljs-string">'apm.service'</span>
| <span class="hljs-built_in">limit</span> 1
</code></pre>
<h2 data-id="heading-44">总结</h2>
<p>UModel 查询作为 EntityStore 中专门用于查询知识图谱元数据的接口，为可观测性数据建模提供了强大的支持能力。通过 UModel 查询可以：</p>
<ol>
<li>探索 Schema 结构：快速了解系统中定义的所有实体类型和关系类型</li>
<li>分析数据模型：深入分析 EntitySet 的字段设计、主键配置、复杂度等</li>
<li>构建关系图谱：通过图查询分析实体间的关联关系，理解知识图谱的拓扑结构</li>
<li>质量检查：验证元数据的完整性和一致性</li>
<li>跨域分析：分析不同域之间的关联模式</li>
<li>快速检索：在大量元数据中快速定位目标定义</li>
</ol>
<p>这些能力使得 UModel 查询成为数据建模分析、Schema 管理和知识图谱探索的不可或缺的工具，为构建和维护高质量的可观测性数据模型提供了坚实的基础。</p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1AWSxBqEtQ%2F" target="_blank" title="https://www.bilibili.com/video/BV1AWSxBqEtQ/" ref="nofollow noopener noreferrer">此处</a>查看视频演示。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 常用组件全属性说明(持续更新中)]]></title>    <link>https://juejin.cn/post/7581099904325025818</link>    <guid>https://juejin.cn/post/7581099904325025818</guid>    <pubDate>2025-12-08T08:29:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581099904325025818" data-draft-id="7579832186880163890" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Flutter 常用组件全属性说明(持续更新中)"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-12-08T08:29:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="renxhui"/> <meta itemprop="url" content="https://juejin.cn/user/1292681403181944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Flutter 常用组件全属性说明(持续更新中)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1292681403181944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    renxhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:29:38.000Z" title="Mon Dec 08 2025 08:29:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读31分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter <code>Scaffold</code> 组件全属性说明</h2>
<p><code>Scaffold</code> 是 Material Design 的基础布局组件，提供 AppBar、Drawer、FAB、BottomNavigationBar 等常见结构。以下为完整属性与解释。</p>
<hr/>
<h3 data-id="heading-1">🎨 基础视觉结构</h3>
<h4 data-id="heading-2"><strong>1. <code>appBar</code></strong></h4>
<p><strong>类型：</strong> <code>PreferredSizeWidget?</code><br/>
页面顶部的 AppBar（标题栏、导航栏），通常使用 <code>AppBar()</code> 构建。</p>
<h4 data-id="heading-3"><strong>2. <code>body</code></strong></h4>
<p><strong>类型：</strong> <code>Widget?</code><br/>
Scaffold 的主体内容区域。</p>
<h4 data-id="heading-4"><strong>3. <code>backgroundColor</code></strong></h4>
<p><strong>类型：</strong> <code>Color?</code><br/>
整个 Scaffold 的背景色。</p>
<h4 data-id="heading-5"><strong>4. <code>extendBody</code></strong></h4>
<p><strong>类型：</strong> <code>bool = false</code><br/>
若为 true，body 会延伸到 <code>bottomNavigationBar</code> 后面。</p>
<h4 data-id="heading-6"><strong>5. <code>extendBodyBehindAppBar</code></strong></h4>
<p><strong>类型：</strong> <code>bool = false</code><br/>
若为 true，body 会延伸到 appBar 后面（常用于透明 AppBar 布局）。</p>
<hr/>
<h3 data-id="heading-7">🧭 导航栏 / 侧边栏</h3>
<h4 data-id="heading-8"><strong>6. <code>drawer</code></strong></h4>
<p><strong>类型：</strong> <code>Widget?</code><br/>
左侧抽屉菜单。</p>
<h4 data-id="heading-9"><strong>7. <code>onDrawerChanged</code></strong></h4>
<p><strong>类型：</strong> <code>void Function(bool)?</code><br/>
Drawer 打开/关闭状态回调。</p>
<h4 data-id="heading-10"><strong>8. <code>drawerScrimColor</code></strong></h4>
<p><strong>类型：</strong> <code>Color?</code><br/>
Drawer 打开时背景遮罩层的颜色。</p>
<h4 data-id="heading-11"><strong>9. <code>drawerEdgeDragWidth</code></strong></h4>
<p><strong>类型：</strong> <code>double?</code><br/>
从边缘滑动打开 Drawer 的触发距离。</p>
<h4 data-id="heading-12"><strong>10. <code>drawerEnableOpenDragGesture</code></strong></h4>
<p><strong>类型：</strong> <code>bool = true</code><br/>
是否允许从左侧边缘拖动打开 Drawer。</p>
<hr/>
<h4 data-id="heading-13"><strong>11. <code>endDrawer</code></strong></h4>
<p><strong>类型：</strong> <code>Widget?</code><br/>
右侧抽屉菜单。</p>
<h4 data-id="heading-14"><strong>12. <code>onEndDrawerChanged</code></strong></h4>
<p><strong>类型：</strong> <code>void Function(bool)?</code><br/>
右侧 Drawer 打开/关闭事件。</p>
<h4 data-id="heading-15"><strong>13. <code>endDrawerEnableOpenDragGesture</code></strong></h4>
<p><strong>类型：</strong> <code>bool = true</code><br/>
是否允许从右侧拖动打开 endDrawer。</p>
<hr/>
<h3 data-id="heading-16">🎛️ 底部区域</h3>
<h4 data-id="heading-17"><strong>14. <code>bottomNavigationBar</code></strong></h4>
<p><strong>类型：</strong> <code>Widget?</code><br/>
底部导航栏。</p>
<h4 data-id="heading-18"><strong>15. <code>bottomSheet</code></strong></h4>
<p><strong>类型：</strong> <code>Widget?</code><br/>
固定在底部的 BottomSheet。</p>
<hr/>
<h3 data-id="heading-19">🎚️ 浮动按钮（FAB）</h3>
<h4 data-id="heading-20"><strong>16. <code>floatingActionButton</code></strong></h4>
<p><strong>类型：</strong> <code>Widget?</code><br/>
FAB 按钮。</p>
<h4 data-id="heading-21"><strong>17. <code>floatingActionButtonLocation</code></strong></h4>
<p><strong>类型：</strong> <code>FloatingActionButtonLocation?</code><br/>
FAB 的具体位置（例如 <code>centerDocked</code>）。</p>
<h4 data-id="heading-22"><strong>18. <code>floatingActionButtonAnimator</code></strong></h4>
<p><strong>类型：</strong> <code>FloatingActionButtonAnimator?</code><br/>
FAB 动画行为。</p>
<hr/>
<h3 data-id="heading-23">📑 SnackBar / BottomSheet 控制</h3>
<h4 data-id="heading-24"><strong>19. <code>persistentFooterButtons</code></strong></h4>
<p><strong>类型：</strong> <code>List&lt;Widget&gt;?</code><br/>
固定在底部的一组按钮（通常用于对话框操作区）。</p>
<h4 data-id="heading-25"><strong>20. <code>resizeToAvoidBottomInset</code></strong></h4>
<p><strong>类型：</strong> <code>bool?</code><br/>
键盘弹出时是否自动调整布局避免遮挡内容。</p>
<h4 data-id="heading-26"><strong>21. <code>primary</code></strong></h4>
<p><strong>类型：</strong> <code>bool = true</code><br/>
控制 body 是否占据系统状态栏下的全部空间。</p>
<hr/>
<h3 data-id="heading-27">🧩 手势与 SafeArea</h3>
<h4 data-id="heading-28"><strong>22. <code>drawerDragStartBehavior</code></strong></h4>
<p><strong>类型：</strong> <code>DragStartBehavior</code><br/>
控制 Drawer 的手势拖动行为。</p>
<hr/>
<h3 data-id="heading-29">⚙️ 高级属性</h3>
<h4 data-id="heading-30"><strong>23. <code>restorationId</code></strong></h4>
<p><strong>类型：</strong> <code>String?</code><br/>
用于状态恢复（如 Scroll、Tab 的位置）。</p>
<h4 data-id="heading-31"><strong>24. <code>key</code></strong></h4>
<p><strong>类型：</strong> <code>Key?</code><br/>
Widget 唯一标识。</p>
<hr/>
<h2 data-id="heading-32">📑 属性总表（速查）</h2>


































































































































<table><thead><tr><th>属性名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>key</td><td>Key?</td><td>Widget 标识</td></tr><tr><td>appBar</td><td>PreferredSizeWidget?</td><td>顶部栏</td></tr><tr><td>body</td><td>Widget?</td><td>主体内容</td></tr><tr><td>floatingActionButton</td><td>Widget?</td><td>FAB 按钮</td></tr><tr><td>floatingActionButtonLocation</td><td>FloatingActionButtonLocation?</td><td>FAB 位置</td></tr><tr><td>floatingActionButtonAnimator</td><td>FloatingActionButtonAnimator?</td><td>FAB 动画</td></tr><tr><td>persistentFooterButtons</td><td>List?</td><td>底部固定按钮</td></tr><tr><td>drawer</td><td>Widget?</td><td>左侧抽屉菜单</td></tr><tr><td>onDrawerChanged</td><td>void Function(bool)?</td><td>Drawer 状态回调</td></tr><tr><td>endDrawer</td><td>Widget?</td><td>右侧抽屉菜单</td></tr><tr><td>onEndDrawerChanged</td><td>void Function(bool)?</td><td>endDrawer 状态回调</td></tr><tr><td>bottomNavigationBar</td><td>Widget?</td><td>底部导航栏</td></tr><tr><td>bottomSheet</td><td>Widget?</td><td>底部 Sheet</td></tr><tr><td>backgroundColor</td><td>Color?</td><td>背景色</td></tr><tr><td>resizeToAvoidBottomInset</td><td>bool?</td><td>键盘遮挡处理</td></tr><tr><td>primary</td><td>bool</td><td>是否占据整个顶部区域</td></tr><tr><td>drawerDragStartBehavior</td><td>DragStartBehavior</td><td>Drawer 手势行为</td></tr><tr><td>extendBody</td><td>bool</td><td>body 伸到 navBar 后</td></tr><tr><td>extendBodyBehindAppBar</td><td>bool</td><td>body 伸至 appBar 后</td></tr><tr><td>drawerScrimColor</td><td>Color?</td><td>Drawer 遮罩层颜色</td></tr><tr><td>drawerEdgeDragWidth</td><td>double?</td><td>Drawer 边缘触发宽度</td></tr><tr><td>drawerEnableOpenDragGesture</td><td>bool</td><td>左抽屉滑动开启</td></tr><tr><td>endDrawerEnableOpenDragGesture</td><td>bool</td><td>右抽屉滑动开启</td></tr><tr><td>restorationId</td><td>String?</td><td>状态恢复</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-33">Flutter <code>Positioned</code> 组件全属性说明</h2>
<p><code>Positioned</code> 是 Flutter 中用于 <strong><code>Stack</code> 内绝对定位子组件</strong> 的布局组件。<br/>
通过 top/left/right/bottom/width/height 等属性，可控制子组件在 Stack 中的精确位置和大小。</p>
<hr/>
<h3 data-id="heading-34">📌 Positioned 主要属性（含解释）</h3>
<h4 data-id="heading-35"><strong>1. <code>left</code></strong></h4>
<p><strong>类型：</strong> <code>double?</code><br/>
子组件距离 Stack 左侧的距离。</p>
<h4 data-id="heading-36"><strong>2. <code>top</code></strong></h4>
<p><strong>类型：</strong> <code>double?</code><br/>
子组件距离 Stack 顶部的距离。</p>
<h4 data-id="heading-37"><strong>3. <code>right</code></strong></h4>
<p><strong>类型：</strong> <code>double?</code><br/>
子组件距离 Stack 右侧的距离。</p>
<h4 data-id="heading-38"><strong>4. <code>bottom</code></strong></h4>
<p><strong>类型：</strong> <code>double?</code><br/>
子组件距离 Stack 底部的距离。</p>
<blockquote>
<p>⚠️ 若设置了相对两个方向的属性（如同时设置 left + right），则宽度不需要设置，组件会自动拉伸至两边。</p>
</blockquote>
<hr/>
<h3 data-id="heading-39">📏 大小约束属性</h3>
<h4 data-id="heading-40"><strong>5. <code>width</code></strong></h4>
<p><strong>类型：</strong> <code>double?</code><br/>
子组件宽度。<br/>
如果设置了左右距离 (<code>left</code> + <code>right</code>)，则不能再设置 <code>width</code>，否则报错。</p>
<h4 data-id="heading-41"><strong>6. <code>height</code></strong></h4>
<p><strong>类型：</strong> <code>double?</code><br/>
子组件高度。<br/>
同理，如果设置了 <code>top</code> + <code>bottom</code>，不能再设置 <code>height</code>。</p>
<hr/>
<h3 data-id="heading-42">🧩 高级位置属性（仅二选一的参数组）</h3>
<h4 data-id="heading-43"><strong>7. <code>child</code></strong></h4>
<p><strong>类型：</strong> <code>Widget</code><br/>
被定位的子组件。</p>
<hr/>
<h3 data-id="heading-44">🧭 特殊构造函数（<code>Positioned.fill</code>）</h3>
<h4 data-id="heading-45"><strong><code>Positioned.fill</code></strong></h4>
<p>让子组件填满整个 Stack，可再设置 optional padding：</p>
<pre><code class="hljs language-dart" lang="dart">Positioned.fill(
  top: <span class="hljs-number">10</span>,
  left: <span class="hljs-number">20</span>,
  child: ...
)
</code></pre>
<p>等同于：</p>
<ul>
<li>
<p>top = 10</p>
</li>
<li>
<p>left = 20</p>
</li>
<li>
<p>right = 0</p>
</li>
<li>
<p>bottom = 0</p>
</li>
</ul>
<h2 data-id="heading-46">Flutter <code>ClipRRect</code> 组件全指南（可完整复制版）</h2>
<p><code>ClipRRect</code> 用于按圆角矩形裁剪子组件。</p>
<hr/>
<h3 data-id="heading-47">1. 基本用法示例</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">ClipRRect</span>(
  <span class="hljs-attribute">borderRadius</span>: BorderRadius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">16</span>),
  <span class="hljs-attribute">child</span>: Image.<span class="hljs-built_in">network</span>(<span class="hljs-string">"https://example.com/pic.jpg"</span>),
)
</code></pre>
<hr/>
<h3 data-id="heading-48">2. 属性总表</h3>



































<table><thead><tr><th>属性</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>borderRadius</td><td>BorderRadius</td><td>BorderRadius.zero</td><td>圆角半径</td></tr><tr><td>clipper</td><td>CustomClipper?</td><td>null</td><td>自定义裁剪器</td></tr><tr><td>clipBehavior</td><td>Clip</td><td>Clip.antiAlias</td><td>裁剪方式</td></tr><tr><td>child</td><td>Widget</td><td>——</td><td>被裁剪的内容</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-49">3. 属性解释</h3>
<h4 data-id="heading-50">3.1 borderRadius</h4>
<p>设置圆角：</p>
<pre><code class="hljs language-css" lang="css">borderRadius: BorderRadius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">20</span>)
</code></pre>
<p>单独设置某些角：</p>
<pre><code class="hljs language-css" lang="css">borderRadius: BorderRadius.<span class="hljs-built_in">only</span>(
  topLeft: Radius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">12</span>),
  bottomRight: Radius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">30</span>),
)
</code></pre>
<hr/>
<h4 data-id="heading-51">3.2 clipper</h4>
<p>使用自定义裁剪器：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClipper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CustomClipper&lt;RRect&gt;</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">RRect</span> getClip(<span class="hljs-type">Size</span> size) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">RRect</span>.fromRectAndRadius(
      <span class="hljs-type">Rect</span>.fromLTWH(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, size.width, size.height),
      <span class="hljs-type">Radius</span>.circular(<span class="hljs-number">40</span>),
    );
  }

  <span class="hljs-meta">@override</span>
  bool shouldReclip(oldClipper) =&gt; <span class="hljs-literal">false</span>;
}
</code></pre>
<hr/>
<h4 data-id="heading-52">3.3 clipBehavior</h4>

























<table><thead><tr><th>值</th><th>效果</th></tr></thead><tbody><tr><td>Clip.none</td><td>不裁剪</td></tr><tr><td>Clip.hardEdge</td><td>无抗锯齿，性能最好</td></tr><tr><td>Clip.antiAlias</td><td>默认抗锯齿</td></tr><tr><td>Clip.antiAliasWithSaveLayer</td><td>最美观但性能最差</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-53">3.4 child</h4>
<p>被裁剪的任何组件（图片、按钮、Container 等）。</p>
<hr/>
<h3 data-id="heading-54">4. 常见示例</h3>
<h4 data-id="heading-55">圆角图片</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">ClipRRect</span>(
  <span class="hljs-attribute">borderRadius</span>: BorderRadius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">12</span>),
  <span class="hljs-attribute">child</span>: Image.<span class="hljs-built_in">asset</span>(<span class="hljs-string">"images/avatar.jpg"</span>),
)
</code></pre>
<h4 data-id="heading-56">圆形头像</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">ClipRRect</span>(
  <span class="hljs-attribute">borderRadius</span>: BorderRadius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">999</span>),
  <span class="hljs-attribute">child</span>: Image.<span class="hljs-built_in">asset</span>(<span class="hljs-string">"images/avatar.jpg"</span>, <span class="hljs-attribute">width</span>: <span class="hljs-number">80</span>, <span class="hljs-attribute">height</span>: <span class="hljs-number">80</span>),
)
</code></pre>
<h4 data-id="heading-57">不同角不同圆角</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">ClipRRect</span>(
  <span class="hljs-attribute">borderRadius</span>: BorderRadius.<span class="hljs-built_in">only</span>(
    <span class="hljs-attribute">topLeft</span>: Radius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">24</span>),
    <span class="hljs-attribute">bottomRight</span>: Radius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">6</span>),
  ),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Container</span>(<span class="hljs-attribute">color</span>: Colors.blue, <span class="hljs-attribute">width</span>: <span class="hljs-number">120</span>, <span class="hljs-attribute">height</span>: <span class="hljs-number">120</span>),
)
</code></pre>
<h4 data-id="heading-58">自定义裁剪器</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">ClipRRect</span>(
  <span class="hljs-attribute">clipper</span>: <span class="hljs-built_in">TicketClipper</span>(),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Container</span>(<span class="hljs-attribute">height</span>: <span class="hljs-number">100</span>, <span class="hljs-attribute">color</span>: Colors.orange),
)
</code></pre>
<hr/>
<h3 data-id="heading-59">5. 注意事项</h3>
<ol>
<li><code>ClipRRect</code> 有开销，能不用裁剪就用装饰圆角（BoxDecoration）</li>
<li>列表大量使用时避免 <code>Clip.antiAliasWithSaveLayer</code></li>
<li>与模糊过滤（BackdropFilter）组合时需使用 saveLayer</li>
<li>对图片裁剪最常见、最推荐</li>
</ol>
<hr/>
<h3 data-id="heading-60">6. 速查表</h3>





























<table><thead><tr><th>场景</th><th>推荐方式</th></tr></thead><tbody><tr><td>普通圆角</td><td>borderRadius</td></tr><tr><td>圆形头像</td><td>borderRadius.circular(999)</td></tr><tr><td>自定义形状</td><td>clipper</td></tr><tr><td>列表性能优先</td><td>Clip.hardEdge</td></tr><tr><td>模糊背景</td><td>Clip.antiAliasWithSaveLayer</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-61">Flutter <code>BackdropFilter</code> 组件详解（可一键复制版）</h2>
<p><code>BackdropFilter</code> 用于对其<strong>后面已经绘制的内容</strong>应用图像滤镜（例如模糊、颜色矩阵等），常用于实现毛玻璃 / 模糊背景效果（frosted glass）。<br/>
注意：<code>BackdropFilter</code> 是对“已经在它后面绘制的像素”进行处理，而不是处理它的 child 本身。</p>
<hr/>
<h3 data-id="heading-62">1. 构造器与属性总表</h3>
<p>构造器签名（核心）：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">BackdropFilter</span>({
  Key? key,
  required ImageFilter filter,
  Widget? child,
})
</code></pre>





























<table><thead><tr><th>属性</th><th>类型</th><th align="right">必须</th><th>说明</th></tr></thead><tbody><tr><td>key</td><td>Key?</td><td align="right">否</td><td>标准 Widget key</td></tr><tr><td>filter</td><td>ImageFilter</td><td align="right">是</td><td>要应用的图像滤镜（例如 <code>ImageFilter.blur(...)</code> 或 <code>ImageFilter.matrix(...)</code>）</td></tr><tr><td>child</td><td>Widget?</td><td align="right">否</td><td>子 Widget。通常 child 是一个带有半透明背景的容器，用于表现“玻璃”效果；也可以为空。</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-63">2. 工作原理（关键点）</h3>
<ul>
<li><code>BackdropFilter</code> 会 <strong>捕获并处理“它在渲染树中的区域内且在它之前绘制的像素”</strong>，把处理后的像素绘制到该区域，然后再绘制它的 child（如果有）。</li>
<li>换句话说：背景（在 BackdropFilter 之前绘制的内容） → 应用 filter → 绘制 child。</li>
<li>它不会影响 child 自己的内容（child 是在滤镜之后绘制的）。</li>
<li>如果想限制滤镜影响的范围，需要使用裁剪（如 <code>ClipRect</code> / <code>ClipRRect</code> / <code>OverflowBox</code> 等）把区域限定住；否则滤镜可能会影响更大的区域或者没有效果（因为没有被裁剪的绘制区域）。</li>
</ul>
<hr/>
<h3 data-id="heading-64">3. 常见 <code>ImageFilter</code> 用法</h3>
<ul>
<li>
<p>模糊（最常见）：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">ImageFilter</span><span class="hljs-selector-class">.blur</span>(<span class="hljs-attribute">sigmaX</span>: <span class="hljs-number">10.0</span>, <span class="hljs-attribute">sigmaY</span>: <span class="hljs-number">10.0</span>)
</code></pre>
</li>
<li>
<p>颜色矩阵（复杂图像处理）：</p>
<pre><code class="hljs language-scss" lang="scss">ImageFilter<span class="hljs-selector-class">.matrix</span>(...) <span class="hljs-comment">// 需要配合 dart:ui Matrix4/ColorFilter 等</span>
</code></pre>
</li>
</ul>
<blockquote>
<p>注意：<code>ImageFilter</code> 来源于 <code>dart:ui</code>，某些 filter 需要组合 <code>ColorFilter</code> / <code>BlendMode</code> 或使用 <code>ImageFiltered</code>（处理 child 本身）实现不同效果。</p>
</blockquote>
<hr/>
<h3 data-id="heading-65">4. 常见用法范例（可直接复制）</h3>
<h4 data-id="heading-66">基本毛玻璃背景（通常与 Stack + Positioned 结合）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Stack</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-comment">// 背景</span>
    Image.<span class="hljs-built_in">network</span>(<span class="hljs-string">'https://example.com/bg.jpg'</span>, <span class="hljs-attribute">fit</span>: BoxFit.cover, <span class="hljs-attribute">width</span>: double.infinity, <span class="hljs-attribute">height</span>: double.infinity),

    <span class="hljs-comment">// 局部毛玻璃</span>
    <span class="hljs-built_in">Positioned</span>(
      <span class="hljs-attribute">left</span>: <span class="hljs-number">40</span>,
      <span class="hljs-attribute">top</span>: <span class="hljs-number">100</span>,
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">ClipRRect</span>(
        <span class="hljs-attribute">borderRadius</span>: BorderRadius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">16</span>),
        <span class="hljs-attribute">child</span>: <span class="hljs-built_in">BackdropFilter</span>(
          <span class="hljs-attribute">filter</span>: ImageFilter.<span class="hljs-built_in">blur</span>(<span class="hljs-attribute">sigmaX</span>: <span class="hljs-number">8.0</span>, <span class="hljs-attribute">sigmaY</span>: <span class="hljs-number">8.0</span>),
          <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Container</span>(
            <span class="hljs-attribute">width</span>: <span class="hljs-number">280</span>,
            <span class="hljs-attribute">height</span>: <span class="hljs-number">140</span>,
            <span class="hljs-attribute">color</span>: Colors.white.<span class="hljs-built_in">withOpacity</span>(<span class="hljs-number">0.2</span>),
            <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Center</span>(<span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Frosted glass'</span>)),
          ),
        ),
      ),
    ),
  ],
)
</code></pre>
<h4 data-id="heading-67">全屏毛玻璃遮罩（比如对整个背景模糊）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Stack</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-comment">// 背景内容</span>
    ...,

    <span class="hljs-comment">// 全屏模糊（注意：一般用在半透明遮罩中）</span>
    <span class="hljs-built_in">BackdropFilter</span>(
      <span class="hljs-attribute">filter</span>: ImageFilter.<span class="hljs-built_in">blur</span>(<span class="hljs-attribute">sigmaX</span>: <span class="hljs-number">6</span>, <span class="hljs-attribute">sigmaY</span>: <span class="hljs-number">6</span>),
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Container</span>(
        <span class="hljs-attribute">color</span>: Colors.black.<span class="hljs-built_in">withOpacity</span>(<span class="hljs-number">0.2</span>),
      ),
    ),
  ],
)
</code></pre>
<hr/>
<h3 data-id="heading-68">5. 必知注意事项（性能 / 行为 / 限制）</h3>
<ol>
<li>
<p><strong>必须裁剪才能限定滤镜范围</strong></p>
<ul>
<li><code>BackdropFilter</code> 会影响其 <strong>布局区域内</strong> 的“之前绘制像素”。若没有裁剪，滤镜可能看起来没有作用或影响超出预期区域。常见做法是把 <code>BackdropFilter</code> 包在 <code>ClipRect</code> / <code>ClipRRect</code> 中（如示例所示）。</li>
</ul>
</li>
<li>
<p><strong>性能开销较大</strong></p>
<ul>
<li>模糊等滤镜会生成额外的绘制开销，尤其 sigma 值大或频繁重绘时。尽量：
<ul>
<li>使用较小的 sigma</li>
<li>将需要模糊的区域限制最小</li>
<li>避免在 ListView/滚动中频繁重建包含复杂滤镜的 subtree</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>与 <code>BackdropFilter</code> 组合的 child 通常半透明</strong></p>
<ul>
<li>通常 child 使用 <code>Container(color: Colors.white.withOpacity(0.2))</code> 或带透明度的装饰，以实现“玻璃”外观。</li>
</ul>
</li>
<li>
<p><strong><code>BackdropFilter</code> 不会模糊 child 自身</strong></p>
<ul>
<li>如果你需要模糊 child 本身，请使用 <code>ImageFiltered</code> 或 <code>ImageFilter</code> 作用于 child。<code>BackdropFilter</code> 专注于“背景（下层）”。</li>
</ul>
</li>
<li>
<p><strong>绘制顺序重要</strong></p>
<ul>
<li>BackdropFilter 只会处理它在绘制顺序之前的内容（即绘制在它“之后”的 child 不会被处理）。在 Stack 中，确保背景先绘制，再放置 BackdropFilter。</li>
</ul>
</li>
<li>
<p><strong>与平台渲染有关</strong></p>
<ul>
<li>在某些情况下，硬件加速、saveLayer、透明度组合会影响最终效果。若配合 <code>BackdropFilter</code> 使用透明度或模糊，Flutter 可能需要创建 saveLayer，从而增加开销。</li>
</ul>
</li>
<li>
<p><strong>不要把大型模糊放在频繁重构的 widget 中</strong></p>
<ul>
<li>若父 widget 频繁 rebuild，会导致滤镜重算，影响性能。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-69">6. <code>BackdropFilter</code> 与 <code>ImageFiltered</code> 的区别</h3>
<ul>
<li><strong>BackdropFilter</strong>：处理“背后的像素”（背景）→ 然后绘制 child。常用于毛玻璃背景效果。</li>
<li><strong>ImageFiltered</strong>：处理 <strong>child 自身</strong> 的像素（对 child 进行滤镜），不会影响后面的背景。</li>
</ul>
<p>根据需求选择：</p>
<ul>
<li>要模糊背景 → <code>BackdropFilter</code></li>
<li>要模糊当前 widget 本身 → <code>ImageFiltered</code></li>
</ul>
<hr/>
<h3 data-id="heading-70">7. Debug / 调试建议</h3>
<ul>
<li>在调试性能时，使用 Flutter 的性能工具（Performance/Timeline）查看是否产生额外的 GPU 上传或 saveLayer。</li>
<li>在开发中先将 sigma 设置为较小值验证效果，再逐步调大以避免一次性过高开销。</li>
</ul>
<hr/>
<h3 data-id="heading-71">8. 小结（快捷要点）</h3>
<ul>
<li><code>BackdropFilter(filter: ImageFilter..., child: ...)</code>：模糊或处理它后面的绘制内容（不是 child 本身）。</li>
<li>常配合 <code>ClipRect</code> / <code>ClipRRect</code> 来限制影响范围。</li>
<li>是实现“毛玻璃”效果的首选，但要注意性能。</li>
<li>若需要处理 child 自身，使用 <code>ImageFiltered</code>。</li>
</ul>
<hr/>
<h4 data-id="heading-72">参考示例（最简可复制片段）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">ClipRect</span>(
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">BackdropFilter</span>(
    <span class="hljs-attribute">filter</span>: ImageFilter.<span class="hljs-built_in">blur</span>(<span class="hljs-attribute">sigmaX</span>: <span class="hljs-number">10.0</span>, <span class="hljs-attribute">sigmaY</span>: <span class="hljs-number">10.0</span>),
    <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Container</span>(
      <span class="hljs-attribute">color</span>: Colors.white.<span class="hljs-built_in">withOpacity</span>(<span class="hljs-number">0.1</span>),
      <span class="hljs-attribute">width</span>: <span class="hljs-number">200</span>,
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100</span>,
      <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Center</span>(<span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Blurred background'</span>)),
    ),
  ),
)
</code></pre>
<hr/>
<h2 data-id="heading-73">Flutter <code>Column</code> 组件 — 完整属性说明与详解（可一键复制）</h2>
<p>本文档覆盖 <code>Column</code> 的所有构造器参数（属性）、每项属性的详细解释、常见取值、示例与注意事项，帮助你快速掌握 Column 的使用与陷阱。</p>
<blockquote>
<p>注意：<code>Column</code> 来自 <code>package:flutter/widgets.dart</code>，用于按垂直方向排列子 Widget。<code>Column</code> 本身<strong>不滚动</strong>，当内容超出空间请使用 <code>ListView</code> 或把子项包在 <code>SingleChildScrollView</code>/<code>Expanded</code>/<code>Flexible</code> 中。</p>
</blockquote>
<hr/>
<h3 data-id="heading-74">构造器签名（核心参数）</h3>
<p>（以下列出 Column 常见构造器参数及默认值）</p>
<pre><code class="hljs language-ini" lang="ini">const Column({
  Key? key,
  MainAxisAlignment <span class="hljs-attr">mainAxisAlignment</span> = MainAxisAlignment.start,
  MainAxisSize <span class="hljs-attr">mainAxisSize</span> = MainAxisSize.max,
  CrossAxisAlignment <span class="hljs-attr">crossAxisAlignment</span> = CrossAxisAlignment.center,
  TextDirection? textDirection,
  VerticalDirection <span class="hljs-attr">verticalDirection</span> = VerticalDirection.down,
  TextBaseline? textBaseline,
  double <span class="hljs-attr">spacing</span> = <span class="hljs-number">0.0</span>,
  List&lt;Widget&gt; <span class="hljs-attr">children</span> = const &lt;Widget&gt;[],
})
</code></pre>
<hr/>
<h3 data-id="heading-75">属性清单与详解</h3>
<h4 data-id="heading-76"><code>key</code> — <code>Key?</code></h4>
<ul>
<li><strong>作用</strong>：标准 Flutter Widget key，用于标识 Widget、保持 state、控制元素重用。</li>
<li><strong>使用场景</strong>：当 Column 的位置或子列表会重排时（例如在列表中动态增删），使用 <code>Key</code>（通常是 <code>ValueKey</code> / <code>ObjectKey</code> / <code>UniqueKey</code>）能避免状态错配。</li>
</ul>
<hr/>
<h4 data-id="heading-77"><code>mainAxisAlignment</code> — <code>MainAxisAlignment</code>（默认 <code>MainAxisAlignment.start</code>）</h4>
<ul>
<li>
<p><strong>主轴</strong>：对于 <code>Column</code>，主轴是垂直方向（top → bottom）。</p>
</li>
<li>
<p><strong>作用</strong>：控制 children 在主轴（垂直）上的排列方式和空间分配。</p>
</li>
<li>
<p><strong>常用值</strong>：</p>
<ul>
<li><code>start</code>：从顶部开始排列（默认）。</li>
<li><code>end</code>：从底部开始排列。</li>
<li><code>center</code>：在垂直方向居中排列。</li>
<li><code>spaceBetween</code>：第一个放顶部，最后一个放底部，其他平均分布间距。</li>
<li><code>spaceAround</code>：每个子项周围间隔相等（首尾的间隔为中间间隔的一半）。</li>
<li><code>spaceEvenly</code>：所有间隔（包括首尾）都相等。</li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Column(
mainAxisAlignment: MainAxisAlignment.spaceBetween,
children: [ ... ],
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-78"><code>mainAxisSize</code> — <code>MainAxisSize</code>（默认 <code>MainAxisSize.max</code>）</h4>
<ul>
<li><strong>作用</strong>：控制 Column 在主轴方向（垂直）上占据的空间是尽可能大还是仅包裹子项高度。</li>
<li><strong>取值</strong>：
<ul>
<li><code>MainAxisSize.max</code>：尽可能占用父可用的最大高度（默认）。</li>
<li><code>MainAxisSize.min</code>：尽可能紧凑，只占用子项所需高度。</li>
</ul>
</li>
<li><strong>注意</strong>：在 Column 内放 <code>Expanded</code> / <code>Flexible</code> 会影响占用空间行为；当没有被约束（比如放在 ListView 中）可能出现<strong>unbounded constraints</strong> 错误，需把 Column 包在具有边界的父控件或使用 <code>ShrinkWrap</code> 风格布局。</li>
</ul>
<hr/>
<h4 data-id="heading-79"><code>crossAxisAlignment</code> — <code>CrossAxisAlignment</code>（默认 <code>CrossAxisAlignment.center</code>）</h4>
<ul>
<li>
<p><strong>交叉轴</strong>：对于 <code>Column</code>，交叉轴是水平方向（left ↔ right）。</p>
</li>
<li>
<p><strong>作用</strong>：定义 children 在水平方向（交叉轴）如何对齐或拉伸。</p>
</li>
<li>
<p><strong>常用值</strong>：</p>
<ul>
<li><code>start</code>：靠交叉轴“起始”对齐（左或右，取决于 <code>textDirection</code>）。</li>
<li><code>end</code>：靠交叉轴“结束”对齐。</li>
<li><code>center</code>：水平居中（默认）。</li>
<li><code>stretch</code>：拉伸使子项在交叉轴方向填满（若子项没有明确宽度）。</li>
<li><code>baseline</code>：按文本基线对齐（仅对含文本的子项有意义，需要设置 <code>textBaseline</code>）。</li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Column(
crossAxisAlignment: CrossAxisAlignment.stretch,
children: [
Container(height: 40, color: Colors.red),
Container(height: 40, color: Colors.blue),
],
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-80"><code>textDirection</code> — <code>TextDirection?</code></h4>
<ul>
<li><strong>作用</strong>：用于区分 <code>start</code> / <code>end</code> 在交叉轴（水平）上的含义（LTR 或 RTL）。</li>
<li><strong>默认值</strong>：如果未提供，则使用最近的 <code>Directionality</code>（环境方向）。</li>
<li><strong>注意</strong>：如果没有 ambient <code>Directionality</code> 且代码中需要区分 <code>start</code>/<code>end</code>，则必须显式传入 <code>textDirection</code>，否则会抛异常或无法确定对齐方向。</li>
</ul>
<hr/>
<h4 data-id="heading-81"><code>verticalDirection</code> — <code>VerticalDirection</code>（默认 <code>VerticalDirection.down</code>）</h4>
<ul>
<li>
<p><strong>作用</strong>：决定 children 在主轴（垂直）上的布局顺序与起点位置（垂直方向的“起点”是在上方还是下方）。</p>
</li>
<li>
<p><strong>取值</strong>：</p>
<ul>
<li><code>VerticalDirection.down</code>：从上到下布局（默认行为）。</li>
<li><code>VerticalDirection.up</code>：从下到上布局（第一个 child 在底部）。</li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Column(
verticalDirection: VerticalDirection.up,
children: [...],
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-82"><code>textBaseline</code> — <code>TextBaseline?</code></h4>
<ul>
<li>
<p><strong>类型</strong>：<code>TextBaseline.alphabetic</code> 或 <code>TextBaseline.ideographic</code>。</p>
</li>
<li>
<p><strong>作用</strong>：当 <code>crossAxisAlignment == CrossAxisAlignment.baseline</code> 时，<code>textBaseline</code> 必须非空，指定使用哪个文本基线对齐子项（不同文字/语言的字体基线可能不同）。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Column(
crossAxisAlignment: CrossAxisAlignment.baseline,
textBaseline: TextBaseline.alphabetic,
children: [Text('A'), Text('g')],
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-83"><code>spacing</code> — <code>double</code>（默认 <code>0.0</code>）</h4>
<ul>
<li>
<p><strong>说明</strong>：该参数在新版 Flutter API 中可用（在 Flex 超类上），表示<strong>子项之间的固定间距</strong>（在主轴方向上）——相当于在每对相邻 children 之间插入固定大小的空白。</p>
</li>
<li>
<p><strong>作用</strong>：当你想要子项之间有固定间隔时，可直接设置 <code>spacing</code>，不必手动在 children 中插入 SizedBox。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Column(
spacing: 12.0,
children: [WidgetA(), WidgetB(), WidgetC()],
)</p>
</li>
</ul>
<blockquote>
<p>注：并非所有 Flutter 版本都包含 <code>spacing</code>；如果你的 SDK 中没有该参数，等价写法是手动插入 <code>SizedBox(height: x)</code> 在 children 之间，或使用 <code>Wrap</code> / <code>ListView.separated</code> 等。</p>
</blockquote>
<hr/>
<h4 data-id="heading-84"><code>children</code> — <code>List&lt;Widget&gt;</code></h4>
<ul>
<li><strong>作用</strong>：Column 要垂直排列的子 Widgets 列表。</li>
<li><strong>默认</strong>：空列表。</li>
<li><strong>注意</strong>：Column 不滚动，如果 children 总高度可能超过可用空间，需要：
<ul>
<li>将外层包装 <code>SingleChildScrollView</code>（要注意尺寸约束），或</li>
<li>使用 <code>Expanded</code> / <code>Flexible</code> 控制填充/收缩，或</li>
<li>使用 <code>ListView</code> 等可滚动容器。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-85">常见错误与陷阱（必看）</h3>
<ol>
<li><strong>内容溢出（RenderFlex overflow）</strong>：当 Column 的总高度超过父容器限制时，会抛出黄色/黑色溢出条纹错误。解决办法：使用 <code>Expanded</code>/<code>Flexible</code>、把 Column 包在 <code>SingleChildScrollView</code>，或改用 <code>ListView</code>。</li>
<li><strong>unbounded constraints</strong>：把 Column 放到需要无限高度的地方（例如 <code>ListView</code> 的 item 中），可能触发约束错误。通常需要限定高度或使用 <code>IntrinsicHeight</code> / <code>SizedBox</code> 等。</li>
<li><strong>Cross-axis baseline 对齐</strong>：使用 <code>CrossAxisAlignment.baseline</code> 时必须提供 <code>textBaseline</code>，否则会出错。</li>
<li><strong>start/end 受 TextDirection 影响</strong>：使用 <code>start</code>/<code>end</code> 时要意识到 RTL（右到左）布局对齐会反转。</li>
<li><strong>不要在 Column 内大量使用 <code>antiPattern</code> 的 nested Column</strong>：深度嵌套过多会让布局复杂且难以管理，尽量提取为组合组件或使用布局工具（Grid/Flex/Wrap）。</li>
</ol>
<hr/>
<h3 data-id="heading-86">常用示例（可直接复制，示例内使用缩进代码块避免嵌套反复）</h3>
<h4 data-id="heading-87">1. 基本 Column（默认行为）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Item 1'</span>),
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Item 2'</span>),
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Item 3'</span>),
  ],
)
</code></pre>
<h4 data-id="heading-88">2. 垂直居中并在子项间均匀分布</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">mainAxisAlignment</span>: MainAxisAlignment.spaceEvenly,
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Top'</span>),
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Middle'</span>),
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Bottom'</span>),
  ],
)
</code></pre>
<h4 data-id="heading-89">3. 交叉轴拉伸（宽度填满父容器）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">crossAxisAlignment</span>: CrossAxisAlignment.stretch,
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">ElevatedButton</span>(<span class="hljs-attribute">onPressed</span>: (){}, <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Button 1'</span>)),
    <span class="hljs-built_in">ElevatedButton</span>(<span class="hljs-attribute">onPressed</span>: (){}, <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Button 2'</span>)),
  ],
)
</code></pre>
<h4 data-id="heading-90">4. 使用 spacing（若你的 Flutter SDK 支持）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">spacing</span>: <span class="hljs-number">16.0</span>,
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'A'</span>),
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'B'</span>),
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'C'</span>),
  ],
)
</code></pre>
<h4 data-id="heading-91">5. 基线对齐（文本对齐）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Column</span>(
  <span class="hljs-attribute">crossAxisAlignment</span>: CrossAxisAlignment.baseline,
  <span class="hljs-attribute">textBaseline</span>: TextBaseline.alphabetic,
  <span class="hljs-attribute">children</span>: [
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Small'</span>, <span class="hljs-attribute">style</span>: <span class="hljs-built_in">TextStyle</span>(<span class="hljs-attribute">fontSize</span>: <span class="hljs-number">12</span>)),
    <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Large'</span>, <span class="hljs-attribute">style</span>: <span class="hljs-built_in">TextStyle</span>(<span class="hljs-attribute">fontSize</span>: <span class="hljs-number">28</span>)),
  ],
)
</code></pre>
<h4 data-id="heading-92">6. 可滚动内容（示例：把 Column 放在 SingleChildScrollView）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">SingleChildScrollView</span>(
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Column</span>(
    <span class="hljs-attribute">children</span>: List.<span class="hljs-built_in">generate</span>(<span class="hljs-number">30</span>, (i) =&gt; <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Item $i'</span>)),
  ),
)
</code></pre>
<hr/>
<h3 data-id="heading-93">速查表（Cheat Sheet）</h3>

































































<table><thead><tr><th>属性</th><th>类型</th><th>默认</th><th>用途速览</th></tr></thead><tbody><tr><td>key</td><td>Key?</td><td>—</td><td>标识 Widget，保持 state</td></tr><tr><td>mainAxisAlignment</td><td>MainAxisAlignment</td><td>start</td><td>控制主轴（垂直）上的排列方式与间距策略</td></tr><tr><td>mainAxisSize</td><td>MainAxisSize</td><td>max</td><td>决定 Column 占用主轴空间的策略（max/min）</td></tr><tr><td>crossAxisAlignment</td><td>CrossAxisAlignment</td><td>center</td><td>控制交叉轴（水平）对齐/拉伸</td></tr><tr><td>textDirection</td><td>TextDirection?</td><td>环境 Directionality</td><td>决定 start/end 的含义（LTR/RTL）</td></tr><tr><td>verticalDirection</td><td>VerticalDirection</td><td>down</td><td>决定 children 从上到下还是从下到上布局</td></tr><tr><td>textBaseline</td><td>TextBaseline?</td><td>null</td><td>与 baseline 对齐配合使用</td></tr><tr><td>spacing</td><td>double</td><td>0.0</td><td>子项之间的固定间距（若 SDK 支持）</td></tr><tr><td>children</td><td>List</td><td>[]</td><td>要排列的子 Widget 列表</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-94">推荐阅读与调试技巧</h3>
<ul>
<li>阅读 Flutter 官方 Layout 文档（<code>Row</code> / <code>Column</code> 部分）理解主/交叉轴概念。</li>
<li>使用 Flutter Inspector（DevTools）观察实际布局盒模型与约束。</li>
<li>在出现 overflow 时，启用 debugPaintSizeEnabled（或在 DevTools 中开启显示布局边界）来定位问题。</li>
</ul>
<hr/>
<p>需要哪一种我就生成哪一种。
::contentReference[oaicite:0]{index=0}</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Flutter `Container` 组件 — 全属性详解（可一键复制版）</span>
</code></pre>
<p><code>Container</code> 是 Flutter 中最常用的布局和装饰类 Widget。它是一个多功能容器，结合了对齐、填充、尺寸约束、装饰（背景、边框、阴影）、变换等能力。虽然看起来很强大，但也有一些优先级和性能注意点需要了解。</p>
<hr/>
<h3 data-id="heading-95">构造器签名（常见参数）</h3>
<p>下面是 <code>Container</code> 的常见构造器参数（摘要形式）：</p>
<pre><code class="hljs language-css" lang="css">const Container({
  Key? key,
  AlignmentGeometry? alignment,
  EdgeInsetsGeometry? <span class="hljs-attribute">padding</span>,
  <span class="hljs-attribute">Color</span>? <span class="hljs-attribute">color</span>,
  Decoration? decoration,
  Decoration? foregroundDecoration,
  double? <span class="hljs-attribute">width</span>,
  double? <span class="hljs-attribute">height</span>,
  BoxConstraints? constraints,
  EdgeInsetsGeometry? <span class="hljs-attribute">margin</span>,
  Matrix4? <span class="hljs-attribute">transform</span>,
  AlignmentGeometry? transformAlignment,
  <span class="hljs-attribute">Clip</span> clipBehavior = <span class="hljs-attribute">Clip</span><span class="hljs-selector-class">.none</span>,
  Widget? child,
})
</code></pre>
<blockquote>
<p>说明：实际源码中 <code>Container</code> 有若干重载和内部行为，这里列出的是使用最广的属性集合与默认值。</p>
</blockquote>
<hr/>
<h3 data-id="heading-96">属性详解（逐项）</h3>
<h4 data-id="heading-97"><code>key</code> — <code>Key?</code></h4>
<ul>
<li><strong>作用</strong>：标准 Widget key，用于 Flutter 元素树定位、状态保持、列表重排时身份识别。</li>
<li><strong>何时用</strong>：当 <code>Container</code> 在动态列表中顺序会改变，想保持子 Widget 状态时使用 <code>Key</code>。</li>
</ul>
<hr/>
<h4 data-id="heading-98"><code>alignment</code> — <code>AlignmentGeometry?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：当 <code>child</code> 的尺寸小于 <code>Container</code> 可用尺寸时，控制 child 在 container 内如何对齐（例如居中、左上、右下等）。</p>
</li>
<li>
<p><strong>常用值</strong>：</p>
<ul>
<li><code>Alignment.center</code></li>
<li><code>Alignment.topLeft</code></li>
<li><code>Alignment.bottomRight</code></li>
<li><code>AlignmentDirectional.centerStart</code>（依赖 textDirection）</li>
</ul>
</li>
<li>
<p><strong>注意</strong>：</p>
<ul>
<li>若 <code>width</code>/<code>height</code> 或 <code>constraints</code> 未定义且没有父约束，alignment 会影响容器尺寸（Container 会尽可能包裹 child）。</li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Container(
width: 200,
height: 100,
alignment: Alignment.center,
child: Text('Centered'),
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-99"><code>padding</code> — <code>EdgeInsetsGeometry?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：内边距，给 child 与 container 边界之间添加空白（相当于在 child 外包一层 <code>Padding</code>）。</p>
</li>
<li>
<p><strong>常用构造</strong>：</p>
<ul>
<li><code>EdgeInsets.all(8)</code></li>
<li><code>EdgeInsets.symmetric(horizontal: 12, vertical: 8)</code></li>
<li><code>EdgeInsets.only(left: 10)</code></li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Container(
padding: EdgeInsets.all(12),
child: Text('Padded'),
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-100"><code>color</code> — <code>Color?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：快速设置背景色。</p>
</li>
<li>
<p><strong>注意事项</strong>：</p>
<ul>
<li><code>color</code> 只是 <code>decoration</code> 的简写；<strong>当同时提供 <code>color</code> 与 <code>decoration</code> 时会抛异常</strong>（二者冲突）。如果需要背景色和其他装饰（边框、圆角、阴影），应把颜色放到 <code>decoration: BoxDecoration(color: ...)</code>。</li>
</ul>
</li>
<li>
<p><strong>示例（仅颜色）</strong>：</p>
<p>Container(
color: Colors.blue,
child: ...
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-101"><code>decoration</code> — <code>Decoration?</code>（如 <code>BoxDecoration</code>）</h4>
<ul>
<li>
<p><strong>作用</strong>：完整的外观控制：背景色、渐变、图片、边框、圆角、阴影等。</p>
</li>
<li>
<p><strong>常见类型</strong>：<code>BoxDecoration(...)</code> 最常用。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Container(
decoration: BoxDecoration(
color: Colors.white,
borderRadius: BorderRadius.circular(12),
boxShadow: [BoxShadow(blurRadius: 8, color: Colors.black26)],
border: Border.all(color: Colors.grey.shade300),
),
child: ...
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-102"><code>foregroundDecoration</code> — <code>Decoration?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：类似 <code>decoration</code>，但绘制在 child 之上（前景层）。可以用于覆盖半透明效果、前景边框、图案等。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Container(
decoration: BoxDecoration(color: Colors.blue),
foregroundDecoration: BoxDecoration(
gradient: LinearGradient(...).withOpacity(0.2),
),
child: ...
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-103"><code>width</code>, <code>height</code> — <code>double?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：显式设置容器的宽度和/或高度。</p>
</li>
<li>
<p><strong>与 constraints 的交互</strong>：</p>
<ul>
<li>如果同时提供 <code>width/height</code> 和 <code>constraints</code>，它们会被合并为最终约束，冲突时会抛异常或被约束限制。</li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Container(width: 120, height: 80, color: Colors.red)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-104"><code>constraints</code> — <code>BoxConstraints?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：更细粒度控制尺寸（最小/最大宽高、固定大小等）。</p>
</li>
<li>
<p><strong>常用方法</strong>：</p>
<ul>
<li><code>BoxConstraints.tight(Size(100, 50))</code>（固定尺寸）</li>
<li><code>BoxConstraints(minWidth: 50, maxWidth: 200)</code></li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Container(
constraints: BoxConstraints(maxWidth: 200, minHeight: 40),
child: ...
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-105"><code>margin</code> — <code>EdgeInsetsGeometry?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：外边距，容器与父级/兄弟控件之间的间距（相当于外部包裹一层 <code>Padding</code> 或 <code>SizedBox</code>）。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Container(
margin: EdgeInsets.symmetric(vertical: 8, horizontal: 16),
child: ...
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-106"><code>transform</code> — <code>Matrix4?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：对容器（包括其子 Widget）应用 2D/3D 变换（旋转、缩放、平移、倾斜等）。</p>
</li>
<li>
<p><strong>注意</strong>：</p>
<ul>
<li>变换可能会影响绘制顺序和性能。</li>
<li>transformOrigin 可通过 <code>transformAlignment</code> 控制。</li>
</ul>
</li>
<li>
<p><strong>示例</strong>（旋转）：</p>
<p>Container(
transform: Matrix4.rotationZ(0.1),
child: ...
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-107"><code>transformAlignment</code> — <code>AlignmentGeometry?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：指定 <code>transform</code> 的对齐基点（默认以容器左上角或中心为变换原点，取决于该值）。</p>
</li>
<li>
<p><strong>常见值</strong>：<code>Alignment.center</code>、<code>Alignment.topLeft</code> 等。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Container(
transformAlignment: Alignment.center,
transform: Matrix4.rotationZ(0.2),
child: ...
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-108"><code>clipBehavior</code> — <code>Clip</code>（默认 <code>Clip.none</code>）</h4>
<ul>
<li>
<p><strong>作用</strong>：当容器使用 <code>decoration</code>（带圆角或形状）或 <code>transform</code> 时，决定是否裁剪溢出部分以及裁剪的质量（硬切/抗锯齿等）。</p>
</li>
<li>
<p><strong>取值</strong>：</p>
<ul>
<li><code>Clip.none</code>（不裁剪，最快）</li>
<li><code>Clip.hardEdge</code>（硬裁剪）</li>
<li><code>Clip.antiAlias</code></li>
<li><code>Clip.antiAliasWithSaveLayer</code>（更平滑但性能更差）</li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Container(
decoration: BoxDecoration(borderRadius: BorderRadius.circular(8)),
clipBehavior: Clip.antiAlias,
child: ...
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-109"><code>child</code> — <code>Widget?</code></h4>
<ul>
<li><strong>作用</strong>：容器内的子 Widget，可以是任意 Widget（文本、图片、布局等）。</li>
<li><strong>注意</strong>：
<ul>
<li>如果没有 <code>child</code>，<code>Container</code> 可能会尽可能小或由 <code>width/height/constraints</code> 决定尺寸。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-110">Container 的行为优先级与常见陷阱（重要）</h3>
<ol>
<li><strong>color 与 decoration 冲突</strong>：若同时提供 <code>color</code> 和 <code>decoration</code>（非 null），会抛异常。解决：把 color 放到 <code>decoration: BoxDecoration(color: ...)</code> 中，或仅使用 color。</li>
<li><strong>alignment 在无 child 时的行为</strong>：当没有 child 且没有宽高/constraints 限制时，alignment 不会产生作用；如果有 child 且父提供足够空间，alignment 控制子的位置。</li>
<li><strong>decoration 会让容器变成有图层</strong>：使用 <code>decoration</code>（尤其带圆角、阴影）可能导致需要 <code>clipBehavior</code> 或 <code>saveLayer</code>，从而影响性能。</li>
<li><strong>transform 与布局约束</strong>：<code>transform</code> 是绘制阶段的变换（不会改变布局阶段的大小与位置约束），但视觉上会影响占位效果。</li>
<li><strong>避免在列表 item 里滥用复杂 decoration/clip</strong>：在大量重复项时，尽量减少高开销的装饰（如 large boxShadow 或 anti-aliased clipping）。</li>
</ol>
<hr/>
<h3 data-id="heading-111">常见使用示例（缩进代码块以保证一键复制可靠）</h3>
<h4 data-id="heading-112">1. 带圆角、阴影和背景色的卡片</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">margin</span>: EdgeInsets.<span class="hljs-built_in">all</span>(<span class="hljs-number">12</span>),
  <span class="hljs-attribute">padding</span>: EdgeInsets.<span class="hljs-built_in">all</span>(<span class="hljs-number">16</span>),
  <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
    <span class="hljs-attribute">color</span>: Colors.white,
    <span class="hljs-attribute">borderRadius</span>: BorderRadius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">12</span>),
    <span class="hljs-attribute">boxShadow</span>: [
      <span class="hljs-built_in">BoxShadow</span>(<span class="hljs-attribute">color</span>: Colors.black26, <span class="hljs-attribute">blurRadius</span>: <span class="hljs-number">8</span>, <span class="hljs-attribute">offset</span>: <span class="hljs-built_in">Offset</span>(<span class="hljs-number">0</span>,<span class="hljs-number">4</span>)),
    ],
  ),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Card content'</span>),
)
</code></pre>
<hr/>
<h4 data-id="heading-113">2. 固定尺寸 + 居中文本</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200</span>,
  <span class="hljs-attribute">height</span>: <span class="hljs-number">80</span>,
  <span class="hljs-attribute">alignment</span>: Alignment.center,
  <span class="hljs-attribute">color</span>: Colors.blue,
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Centered'</span>, <span class="hljs-attribute">style</span>: <span class="hljs-built_in">TextStyle</span>(<span class="hljs-attribute">color</span>: Colors.white)),
)
</code></pre>
<hr/>
<h4 data-id="heading-114">3. 使用 transform（旋转）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">width</span>: <span class="hljs-number">120</span>,
  <span class="hljs-attribute">height</span>: <span class="hljs-number">60</span>,
  <span class="hljs-attribute">alignment</span>: Alignment.center,
  <span class="hljs-attribute">transform</span>: Matrix4.<span class="hljs-built_in">rotationZ</span>(<span class="hljs-number">0.1</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Rotated'</span>),
)
</code></pre>
<hr/>
<h4 data-id="heading-115">4. 前景装饰（覆盖在 child 上）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(<span class="hljs-attribute">color</span>: Colors.green),
  <span class="hljs-attribute">foregroundDecoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
    <span class="hljs-attribute">gradient</span>: <span class="hljs-built_in">LinearGradient</span>(<span class="hljs-attribute">colors</span>: [Colors.black26, Colors.transparent]),
  ),
  <span class="hljs-attribute">child</span>: Image.<span class="hljs-built_in">asset</span>(<span class="hljs-string">'assets/pic.jpg'</span>, <span class="hljs-attribute">fit</span>: BoxFit.cover),
)
</code></pre>
<hr/>
<h3 data-id="heading-116">性能建议（实践经验）</h3>
<ul>
<li>如果你只想要外观圆角但<strong>不需要裁剪子内容</strong>，优先使用 <code>Container</code> 的 <code>decoration</code>（BoxDecoration 中设置 <code>borderRadius</code>）而不要设置 <code>clipBehavior</code>。若子内容会溢出并必须裁剪，则使用 <code>ClipRRect</code> 或设置 <code>clipBehavior</code>（注意性能）。</li>
<li>避免在列表（ListView/GridView）的每个 item 上使用复杂的阴影或 <code>antiAliasWithSaveLayer</code>。</li>
<li>使用 <code>constraints</code> 明确限制尺寸能减少不必要的布局计算。</li>
<li>对于简单背景色使用 <code>color</code> 比 <code>decoration</code> 更轻量（但别与 decoration 同时使用）。</li>
</ul>
<hr/>
<h3 data-id="heading-117">速查表（Cheat Sheet）</h3>











































































<table><thead><tr><th>属性</th><th>类型</th><th>用途速览</th></tr></thead><tbody><tr><td>key</td><td>Key?</td><td>标识 Widget，列表重排时用</td></tr><tr><td>alignment</td><td>AlignmentGeometry?</td><td>子 Widget 在容器内的对齐方式</td></tr><tr><td>padding</td><td>EdgeInsetsGeometry?</td><td>内边距</td></tr><tr><td>color</td><td>Color?</td><td>背景色（不能与 decoration 同时使用）</td></tr><tr><td>decoration</td><td>Decoration?</td><td>背景/边框/圆角/阴影等外观</td></tr><tr><td>foregroundDecoration</td><td>Decoration?</td><td>绘制在 child 之上的装饰</td></tr><tr><td>width / height</td><td>double?</td><td>固定宽/高</td></tr><tr><td>constraints</td><td>BoxConstraints?</td><td>更细粒度的尺寸约束</td></tr><tr><td>margin</td><td>EdgeInsetsGeometry?</td><td>外边距</td></tr><tr><td>transform</td><td>Matrix4?</td><td>变换（旋转/缩放/平移）</td></tr><tr><td>transformAlignment</td><td>AlignmentGeometry?</td><td>变换的原点对齐</td></tr><tr><td>clipBehavior</td><td>Clip</td><td>裁剪策略（none/hardEdge/antiAlias/...）</td></tr><tr><td>child</td><td>Widget?</td><td>容器内部的子 Widget</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-118">Flutter <code>BoxDecoration</code> 属性详解（可一键复制版）</h2>
<p><code>BoxDecoration</code> 是用来描述盒子外观的核心类（通常与 <code>Container(decoration: ...)</code> 一起使用）。<br/>
它可以设置背景色、渐变、背景图、边框、圆角、阴影、混合模式等。下面逐项列出所有主要属性并给出详尽解释、使用注意与示例。</p>
<hr/>
<h3 data-id="heading-119">构造器（常见参数）</h3>
<p>以下为常用参数签名（已按常见 API 汇总）：</p>
<pre><code class="hljs language-css" lang="css">BoxDecoration({
  <span class="hljs-attribute">Color</span>? <span class="hljs-attribute">color</span>,
  DecorationImage? image,
  BoxBorder? <span class="hljs-attribute">border</span>,
  BorderRadiusGeometry? borderRadius,
  List&lt;BoxShadow&gt;? boxShadow,
  Gradient? gradient,
  BlendMode? backgroundBlendMode,
  BoxShape shape = BoxShape<span class="hljs-selector-class">.rectangle</span>,
})
</code></pre>
<blockquote>
<p>说明：<code>BoxDecoration</code> 的完整实现还包含 debug 用的字段/方法，但上面列出的就是在日常开发中实际会用到的核心属性。</p>
</blockquote>
<hr/>
<h3 data-id="heading-120">属性总表（速览）</h3>



























































<table><thead><tr><th>属性</th><th>类型</th><th align="center">是否必需</th><th>作用简述</th></tr></thead><tbody><tr><td><code>color</code></td><td><code>Color?</code></td><td align="center">否</td><td>背景纯色</td></tr><tr><td><code>image</code></td><td><code>DecorationImage?</code></td><td align="center">否</td><td>背景图片（完整配置项在 <code>DecorationImage</code>）</td></tr><tr><td><code>border</code></td><td><code>BoxBorder?</code></td><td align="center">否</td><td>边框（<code>Border</code> / <code>BorderDirectional</code>）</td></tr><tr><td><code>borderRadius</code></td><td><code>BorderRadiusGeometry?</code></td><td align="center">否</td><td>圆角（仅在 <code>shape == BoxShape.rectangle</code> 时生效）</td></tr><tr><td><code>boxShadow</code></td><td><code>List&lt;BoxShadow&gt;?</code></td><td align="center">否</td><td>阴影列表</td></tr><tr><td><code>gradient</code></td><td><code>Gradient?</code></td><td align="center">否</td><td>背景渐变（线性、径向、扫线等）</td></tr><tr><td><code>backgroundBlendMode</code></td><td><code>BlendMode?</code></td><td align="center">否</td><td>背景颜色/渐变与 image 的混合模式</td></tr><tr><td><code>shape</code></td><td><code>BoxShape</code></td><td align="center">否（默认 rectangle）</td><td>形状（矩形或圆形）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-121">属性逐项详解</h3>
<h4 data-id="heading-122"><code>color</code> — <code>Color?</code></h4>
<ul>
<li><strong>作用</strong>：绘制纯色背景（最简单的背景方式）。</li>
<li><strong>与 <code>decoration.image</code> / <code>gradient</code> 的关系</strong>：
<ul>
<li>如果你同时使用 <code>gradient</code> 和 <code>color</code>，通常会以 <strong>gradient 为主</strong>（实际渲染会依据 <code>backgroundBlendMode</code> 决定混合行为；在很多实现中 gradient 会覆盖 color，若需要组合可用 <code>backgroundBlendMode</code> 控制混合）。</li>
<li>如果你使用 <code>image</code>，<code>color</code> 会与 image 一起绘制，且可通过 <code>backgroundBlendMode</code> 决定如何混合（例如将 color 作为遮色层）。</li>
</ul>
</li>
<li><strong>注意</strong>：不要在同时传 <code>decoration</code>（如 BoxDecoration）内的 <code>color</code> 与 <code>Container</code> 的 <code>color</code> 外部字段冲突 —— 在 Container 上一般使用 <code>decoration</code> 或 <code>color</code> 其一，否则会抛异常（Container 会检测并报错）。</li>
</ul>
<hr/>
<h4 data-id="heading-123"><code>image</code> — <code>DecorationImage?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：作为背景图绘制，类型为 <code>DecorationImage</code>，它包含很多子属性（如下列出）。</p>
</li>
<li>
<p><strong>DecorationImage 常用字段（位于 <code>DecorationImage</code> 内）</strong>：</p>
<ul>
<li><code>image</code> (<code>ImageProvider</code>)：图片资源（AssetImage / NetworkImage / FileImage 等）</li>
<li><code>fit</code> (<code>BoxFit</code>)：如何缩放/裁剪（cover / contain / fill / fitWidth / ...）</li>
<li><code>alignment</code> (<code>Alignment</code>)：图片对齐方式</li>
<li><code>repeat</code> (<code>ImageRepeat</code>)：是否重复</li>
<li><code>centerSlice</code> (<code>Rect?</code>)：九宫拉伸裁切（用于可拉伸图）</li>
<li><code>scale</code>、<code>matchTextDirection</code> 等</li>
</ul>
</li>
<li>
<p><strong>与 <code>color</code>/<code>gradient</code> 的关系</strong>：</p>
<ul>
<li>背景图片绘制在 color/gradient 之上或与之混合，<code>backgroundBlendMode</code> 决定混合方式；若不需要混合，image 会覆盖底色（取决于 image 的透明度和 blendMode）。</li>
</ul>
</li>
<li>
<p><strong>示例（image 配置的伪写法）</strong>：</p>
<p>BoxDecoration(
image: DecorationImage(
image: AssetImage('assets/bg.png'),
fit: BoxFit.cover,
alignment: Alignment.center,
),
)</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-124"><code>border</code> — <code>BoxBorder?</code>（例如 <code>Border.all(...)</code>）</h4>
<ul>
<li><strong>作用</strong>：为盒子绘制边框（可指定不同边的样式）。</li>
<li><strong>常见构造</strong>：
<ul>
<li><code>Border.all(color: Colors.grey, width: 1.0)</code>：统一边框</li>
<li><code>Border(left: ..., right: ..., top: ..., bottom: ...)</code>：分别控制每条边</li>
</ul>
</li>
<li><strong>注意</strong>：
<ul>
<li>当 <code>shape == BoxShape.circle</code> 时，<code>borderRadius</code> 会被忽略；<code>border</code> 仍然可以用于圆形（会按圆形绘制边线）。</li>
<li><code>border</code> 与 <code>boxShadow</code> 的组合可能会在视觉上产生复杂效果（阴影绘制在外部，边框在盒子边缘）。</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-125"><code>borderRadius</code> — <code>BorderRadiusGeometry?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：为矩形盒子设置圆角（支持每个角不同半径）。</p>
</li>
<li>
<p><strong>前提</strong>：仅当 <code>shape == BoxShape.rectangle</code> 时有效；若 <code>shape == BoxShape.circle</code>，此属性会被忽略。</p>
</li>
<li>
<p><strong>常见用法</strong>：</p>
<p>borderRadius: BorderRadius.circular(12)</p>
</li>
</ul>
<p>或</p>
<pre><code class="hljs language-css" lang="css">borderRadius: BorderRadius.<span class="hljs-built_in">only</span>(topLeft: Radius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">8</span>), bottomRight: Radius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">16</span>))
</code></pre>
<ul>
<li><strong>与 <code>clip</code> 关系</strong>：<code>BoxDecoration</code> 本身不裁剪子内容；若你想裁剪子 Widget 超出圆角区域，需要在外面配合 <code>ClipRRect</code> 或在 <code>Container</code> 中设置 <code>clipBehavior</code>（注意性能）。否则边角只是背景显示为圆角，但 child 可能溢出。</li>
</ul>
<hr/>
<h4 data-id="heading-126"><code>boxShadow</code> — <code>List&lt;BoxShadow&gt;?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：在盒子外部绘制一个或多个阴影（可模拟浮起、立体效果）。</p>
</li>
<li>
<p><strong>BoxShadow 字段</strong>：</p>
<ul>
<li><code>color</code>：阴影颜色</li>
<li><code>offset</code>：偏移（Offset(x, y)）</li>
<li><code>blurRadius</code>：模糊半径</li>
<li><code>spreadRadius</code>：扩展半径（控制阴影大小）</li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>boxShadow: [
BoxShadow(color: Colors.black26, blurRadius: 8, offset: Offset(0, 4)),
]</p>
</li>
<li>
<p><strong>注意</strong>：阴影绘制涉及额外合成（可能触发 GPU 分层/SaveLayer），大量或复杂阴影会影响性能；在长滚动列表里谨慎使用。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-127"><code>gradient</code> — <code>Gradient?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：用渐变填充背景（替代单一 color）。</p>
</li>
<li>
<p><strong>支持类型</strong>（均来自 <code>dart:ui</code>）：</p>
<ul>
<li><code>LinearGradient</code>（线性渐变）</li>
<li><code>RadialGradient</code>（径向渐变）</li>
<li><code>SweepGradient</code>（扫线渐变）</li>
</ul>
</li>
<li>
<p><strong>常见字段</strong>：</p>
<ul>
<li><code>colors</code>、<code>stops</code>、<code>begin</code>、<code>end</code>（线性）</li>
<li><code>center</code>、<code>radius</code>（径向）</li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>gradient: LinearGradient(
colors: [Colors.blue, Colors.purple],
begin: Alignment.topLeft,
end: Alignment.bottomRight,
)</p>
</li>
<li>
<p><strong>注意</strong>：与 <code>color</code> 的权责关系请参见 <code>color</code> 部分；如果同时设置 image，渐变与图片会根据 <code>backgroundBlendMode</code> 决定如何混合。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-128"><code>backgroundBlendMode</code> — <code>BlendMode?</code></h4>
<ul>
<li>
<p><strong>作用</strong>：指定如何将 <code>color</code>/<code>gradient</code> 与 <code>image</code> 混合（blend）。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>backgroundBlendMode: BlendMode.overlay</p>
</li>
<li>
<p><strong>常见场景</strong>：</p>
<ul>
<li>使用 <code>color</code> 作为“色彩遮罩”覆盖在图片上；</li>
<li>将渐变叠加在图片上以形成特殊效果；</li>
</ul>
</li>
<li>
<p><strong>注意</strong>：blend 运算可能会导致额外的绘制开销。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-129"><code>shape</code> — <code>BoxShape</code>（<code>BoxShape.rectangle</code> / <code>BoxShape.circle</code>）</h4>
<ul>
<li>
<p><strong>作用</strong>：控制绘制的基本形状：矩形或圆形（circle）。</p>
</li>
<li>
<p><strong>行为</strong>：</p>
<ul>
<li><code>BoxShape.rectangle</code>（默认），可配合 <code>borderRadius</code> 设置圆角。</li>
<li><code>BoxShape.circle</code>：忽略 <code>borderRadius</code>，border 会以圆环形式绘制，image 会被限定到圆形区域（但不会自动裁剪 child，裁剪仍需 ClipRRect/ClipOval 或 <code>clipBehavior</code>）。</li>
</ul>
</li>
<li>
<p><strong>示例（圆形头像）</strong>：</p>
<p>BoxDecoration(
shape: BoxShape.circle,
image: DecorationImage(image: AssetImage('avatar.png'), fit: BoxFit.cover),
)</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-130">交互规则与常见陷阱（重要）</h3>
<ol>
<li>
<p><strong>color 与 decoration 的冲突</strong>：在 <code>Container</code> 场景下，不要同时使用 <code>Container(color: ...)</code> 与 <code>decoration: BoxDecoration(...)</code> 中的 <code>color</code>，Container 会抛出异常。应把 color 放入 decoration 或只使用 Container.color。</p>
</li>
<li>
<p><strong>borderRadius 与 shape 冲突</strong>：如果 <code>shape == BoxShape.circle</code>，<code>borderRadius</code> 将被忽略。确保用途匹配。</p>
</li>
<li>
<p><strong>图片/渐变/颜色的绘制顺序与混合</strong>：</p>
<ul>
<li>通常绘制顺序为：color（底色）→ gradient（若存在，通常覆盖底色或与之混合）→ image（将依据透明度/混合模式渲染在上面或与之混合）→ foreground（如有）。</li>
<li>使用 <code>backgroundBlendMode</code> 可以改变 color/gradient 与 image 的混合方式。</li>
</ul>
</li>
<li>
<p><strong>BoxDecoration 不会自动裁剪子 Widget</strong>：若你需要同时限制 child 的可视区域（例如圆角内裁剪图片/子 Widget），需额外使用 <code>ClipRRect</code> / <code>ClipOval</code> 或在 <code>Container</code> 上设置 <code>clipBehavior</code>（并配合 <code>decoration</code> 的 shape/borderRadius）。裁剪会带来性能成本。</p>
</li>
<li>
<p><strong>性能考量</strong>：</p>
<ul>
<li>大量使用 <code>boxShadow</code>、<code>blur</code>、复杂 <code>DecorationImage</code>（大图）或频繁改变 <code>gradient</code> 时，可能触发 GPU 重绘或 saveLayer，影响 FPS。</li>
<li>在滚动列表中尽量简化装饰，使用静态预渲染资源（如预合成图）或减少阴影/模糊频率。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-131">常用示例（缩进代码以便一键复制）</h3>
<h4 data-id="heading-132">卡片式背景（圆角 + 阴影 + 边框）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
    <span class="hljs-attribute">color</span>: Colors.white,
    <span class="hljs-attribute">borderRadius</span>: BorderRadius.<span class="hljs-built_in">circular</span>(<span class="hljs-number">12</span>),
    <span class="hljs-attribute">boxShadow</span>: [
      <span class="hljs-built_in">BoxShadow</span>(<span class="hljs-attribute">color</span>: Colors.black26, <span class="hljs-attribute">blurRadius</span>: <span class="hljs-number">8</span>, <span class="hljs-attribute">offset</span>: <span class="hljs-built_in">Offset</span>(<span class="hljs-number">0</span>,<span class="hljs-number">4</span>)),
    ],
    <span class="hljs-attribute">border</span>: Border.<span class="hljs-built_in">all</span>(<span class="hljs-attribute">color</span>: Colors.grey.shade200),
  ),
  <span class="hljs-attribute">padding</span>: EdgeInsets.<span class="hljs-built_in">all</span>(<span class="hljs-number">16</span>),
  <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Card content'</span>),
)
</code></pre>
<hr/>
<h4 data-id="heading-133">渐变背景 + 背景图混合</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
    <span class="hljs-attribute">gradient</span>: <span class="hljs-built_in">LinearGradient</span>(
      <span class="hljs-attribute">colors</span>: [Colors.purple, Colors.blue],
      <span class="hljs-attribute">begin</span>: Alignment.topLeft,
      <span class="hljs-attribute">end</span>: Alignment.bottomRight,
    ),
    <span class="hljs-attribute">image</span>: <span class="hljs-built_in">DecorationImage</span>(
      <span class="hljs-attribute">image</span>: <span class="hljs-built_in">AssetImage</span>(<span class="hljs-string">'assets/pattern.png'</span>),
      <span class="hljs-attribute">fit</span>: BoxFit.cover,
      <span class="hljs-attribute">repeat</span>: ImageRepeat.noRepeat,
    ),
    <span class="hljs-attribute">backgroundBlendMode</span>: BlendMode.overlay,
  ),
  <span class="hljs-attribute">child</span>: ...
)
</code></pre>
<hr/>
<h4 data-id="heading-134">圆形头像（背景图填充）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Container</span>(
  <span class="hljs-attribute">width</span>: <span class="hljs-number">80</span>,
  <span class="hljs-attribute">height</span>: <span class="hljs-number">80</span>,
  <span class="hljs-attribute">decoration</span>: <span class="hljs-built_in">BoxDecoration</span>(
    <span class="hljs-attribute">shape</span>: BoxShape.circle,
    <span class="hljs-attribute">image</span>: <span class="hljs-built_in">DecorationImage</span>(
      <span class="hljs-attribute">image</span>: <span class="hljs-built_in">NetworkImage</span>(avatarUrl),
      <span class="hljs-attribute">fit</span>: BoxFit.cover,
    ),
  ),
)
</code></pre>
<hr/>
<h3 data-id="heading-135">调试与最佳实践</h3>
<ul>
<li>
<p>使用 Flutter Inspector 查看实际绘制的装饰及边界。</p>
</li>
<li>
<p>当你只需要视觉上的圆角（不需裁剪子内容），优先使用 <code>BoxDecoration.borderRadius</code> 而不要在外面再使用 <code>ClipRRect</code>，这样可减少裁剪成本（但如果 child 会溢出，则必须裁剪）。</p>
</li>
<li>
<p>如果需要对背景执行复杂混合或滤镜，考虑预处理图片资源以降低实时渲染负担。</p>
</li>
<li>
<p>在 ListView 等大量重复元素中避免使用高成本的 <code>boxShadow</code> 和 `antiAliasWithSaveLa</p>
</li>
</ul>
<h2 data-id="heading-136">Flutter <code>TextStyle</code> 属性详解（可一键复制版）</h2>
<p><code>TextStyle</code> 是 Flutter 中定义文本外观的核心类（用于 <code>Text</code>、<code>RichText</code>、<code>DefaultTextStyle</code> 等）。下面把所有常用属性逐项列出并详细解释，包含使用提示、常见坑和示例。</p>
<hr/>
<h3 data-id="heading-137">构造器（简略）</h3>
<p>下面是 <code>TextStyle</code> 构造器常见参数（不同 Flutter 版本可能会有细微差异）：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-title">TextStyle</span><span class="hljs-params">({
  <span class="hljs-type">bool</span> inherit = <span class="hljs-literal">true</span>,
  Color? color,
  <span class="hljs-type">String</span>? fontFamily,
  List&lt;<span class="hljs-type">String</span>&gt;? fontFamilyFallback,
  <span class="hljs-type">double</span>? fontSize,
  FontWeight? fontWeight,
  FontStyle? fontStyle,
  <span class="hljs-type">double</span>? letterSpacing,
  <span class="hljs-type">double</span>? wordSpacing,
  <span class="hljs-type">double</span>? height,
  TextLeadingDistribution? leadingDistribution,
  TextBaseline? textBaseline,
  Locale? locale,
  Paint? foreground,
  Paint? background,
  List&lt;Shadow&gt;? shadows,
  List&lt;FontFeature&gt;? fontFeatures,
  TextDecoration? decoration,
  Color? decorationColor,
  TextDecorationStyle? decorationStyle,
  <span class="hljs-type">double</span>? decorationThickness,
  <span class="hljs-type">String</span>? debugLabel,
  <span class="hljs-type">String</span>? package,
  TextOverflow? overflow,
})</span>
</span></code></pre>
<blockquote>
<p>说明：上面列出的属性涵盖了 Flutter 官方 <code>TextStyle</code>（painting 库 / dart:ui）在常见版本中的核心字段。某些版本会新增小项（如更深入的 text trimming/overflow 控制），但核心概念一致。</p>
</blockquote>
<hr/>
<h3 data-id="heading-138">属性详解（逐项）</h3>
<h4 data-id="heading-139"><code>inherit</code> — <code>bool</code>（默认 <code>true</code>）</h4>
<ul>
<li><strong>含义</strong>：是否从父 <code>TextStyle</code>（或 <code>DefaultTextStyle</code>）继承缺失的属性。</li>
<li><strong>用途</strong>：通常保持 <code>true</code>（默认），只有在你想完整重置样式时才设为 <code>false</code>。</li>
<li><strong>示例</strong>：若在 <code>DefaultTextStyle</code> 下通过 <code>Text('x', style: TextStyle(inherit: false, color: Colors.red))</code>，则只应用 color，不会继承其它父样式。</li>
</ul>
<hr/>
<h4 data-id="heading-140"><code>color</code> — <code>Color?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：文本的填充颜色（最常用）。</p>
</li>
<li>
<p><strong>注意</strong>：如果同时设置了 <code>foreground</code>（Paint），<code>foreground</code> 优先（它可以做描边/填充组合等更复杂效果）。</p>
</li>
<li>
<p><strong>示例</strong>:</p>
<p>Text('Hello', style: TextStyle(color: Colors.blue));</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-141"><code>fontFamily</code> — <code>String?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：首选字体族名称（例如 <code>'Roboto'</code>）。</p>
</li>
<li>
<p><strong>package</strong>：若字体在 package 中定义，需要在构造器中提供 <code>package: 'package_name'</code>，构造器会自动把 <code>fontFamily</code> 前缀成 <code>packages/package_name/...</code>。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>Text('Hi', style: TextStyle(fontFamily: 'Raleway'));</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-142"><code>fontFamilyFallback</code> — <code>List&lt;String&gt;?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：后备字体族列表。当 <code>fontFamily</code> 中没有某个字形时，按顺序在这些字体中寻找。</p>
</li>
<li>
<p><strong>用途</strong>：跨语言或 emoji 支持时很有用。</p>
</li>
<li>
<p><strong>示例</strong>:</p>
<p>TextStyle(fontFamily: 'MyFont', fontFamilyFallback: ['NotoSans', 'sans-serif']);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-143"><code>fontSize</code> — <code>double?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：字体大小（逻辑像素）。</p>
</li>
<li>
<p><strong>提示</strong>：若同时设置 <code>height</code>，行高是基于 <code>fontSize</code> 的倍数。</p>
</li>
<li>
<p><strong>示例</strong>:</p>
<p>TextStyle(fontSize: 18);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-144"><code>fontWeight</code> — <code>FontWeight?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：字体粗细（例如 <code>FontWeight.w400</code> / <code>FontWeight.bold</code>）。</p>
</li>
<li>
<p><strong>示例</strong>:</p>
<p>TextStyle(fontWeight: FontWeight.bold);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-145"><code>fontStyle</code> — <code>FontStyle?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：字体风格，通常为 <code>FontStyle.normal</code> 或 <code>FontStyle.italic</code>。</p>
</li>
<li>
<p><strong>示例</strong>:</p>
<p>TextStyle(fontStyle: FontStyle.italic);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-146"><code>letterSpacing</code> — <code>double?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：字母间距（每个字形间的额外空白，单位逻辑像素）。可为负值。</p>
</li>
<li>
<p><strong>示例</strong>:</p>
<p>TextStyle(letterSpacing: 1.2);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-147"><code>wordSpacing</code> — <code>double?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：单词之间的额外间距（单位逻辑像素）。</p>
</li>
<li>
<p><strong>示例</strong>:</p>
<p>TextStyle(wordSpacing: 2.0);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-148"><code>height</code> — <code>double?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：行高倍率（将 <code>fontSize * height</code> 作为行高）。如果为 <code>null</code>，则使用字体自身的度量（font metrics）。</p>
</li>
<li>
<p><strong>注意</strong>：<code>height</code> 是整体行高（包括 ascent 和 descent），并非仅上下间距。</p>
</li>
<li>
<p><strong>示例</strong>:</p>
<p>TextStyle(fontSize: 16, height: 1.5);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-149"><code>leadingDistribution</code> — <code>TextLeadingDistribution?</code></h4>
<ul>
<li><strong>含义</strong>：控制行间 leading（行高中空白）如何分配到行上方与下方（<code>proportional</code> 或 <code>even</code>）。</li>
<li><strong>用途</strong>：细化多行文本的垂直对齐感受，特别是当你混合不同字体尺寸时。</li>
</ul>
<hr/>
<h4 data-id="heading-150"><code>textBaseline</code> — <code>TextBaseline?</code></h4>
<ul>
<li><strong>含义</strong>：用于 <code>crossAxisAlignment: CrossAxisAlignment.baseline</code> 等基线对齐场景，通常选 <code>TextBaseline.alphabetic</code> 或 <code>TextBaseline.ideographic</code>。</li>
<li><strong>注意</strong>：仅在需要基线对齐时使用，否则可忽略。</li>
</ul>
<hr/>
<h4 data-id="heading-151"><code>locale</code> — <code>Locale?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：告诉绘制层应使用哪个区域（语言）来选择变体（例如某些字体的语言替换）。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>TextStyle(locale: Locale('ja'));</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-152"><code>foreground</code> — <code>Paint?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：直接为文本提供 <code>Paint</code>，用来绘制文本（支持描边、渐变着色、混合模式等高级效果）。</p>
</li>
<li>
<p><strong>优先级</strong>：若 <code>foreground</code> 非空，它会覆盖 <code>color</code>。</p>
</li>
<li>
<p><strong>示例</strong>（描边）：</p>
<p>final paint = Paint()
..style = PaintingStyle.stroke
..strokeWidth = 1.5
..color = Colors.black;
TextStyle(foreground: paint);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-153"><code>background</code> — <code>Paint?</code></h4>
<ul>
<li><strong>含义</strong>：用 <code>Paint</code> 绘制文本背景（不是 <code>backgroundColor</code>）。可创建复杂的背景效果（渐变、图案）。</li>
<li><strong>注意</strong>：与 <code>backgroundColor</code>（更常用的简单背景）不同，<code>background</code> 是低级 <code>Paint</code>。</li>
</ul>
<hr/>
<h4 data-id="heading-154"><code>shadows</code> — <code>List&lt;Shadow&gt;?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：文字阴影列表（可以多个）。每个 <code>Shadow</code> 包含 <code>color</code>、<code>offset</code>、<code>blurRadius</code>。</p>
</li>
<li>
<p><strong>示例</strong>:</p>
<p>TextStyle(shadows: [Shadow(color: Colors.black26, offset: Offset(1,1), blurRadius: 2)]);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-155"><code>fontFeatures</code> — <code>List&lt;FontFeature&gt;?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：字体特性，用于选择字体提供的特定 OpenType 功能（比如 tabular numbers、oldstyle figures、liga 等）。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>TextStyle(fontFeatures: [FontFeature.tabularFigures()]);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-156"><code>decoration</code> — <code>TextDecoration?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：文本修饰（如下划线 <code>TextDecoration.underline</code>、删除线 <code>TextDecoration.lineThrough</code>、上划线）。</p>
</li>
<li>
<p><strong>示例</strong>:</p>
<p>TextStyle(decoration: TextDecoration.underline);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-157"><code>decorationColor</code> — <code>Color?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：修饰线（下划线等）的颜色（若未设置则通常使用 <code>color</code>）。</p>
</li>
<li>
<p><strong>示例</strong>:</p>
<p>TextStyle(decoration: TextDecoration.underline, decorationColor: Colors.red);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-158"><code>decorationStyle</code> — <code>TextDecorationStyle?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：修饰线的样式（如 <code>solid</code>、<code>double</code>、<code>dashed</code>、<code>dotted</code>、<code>wavy</code>）。</p>
</li>
<li>
<p><strong>示例</strong>:</p>
<p>TextStyle(decoration: TextDecoration.underline, decorationStyle: TextDecorationStyle.wavy);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-159"><code>decorationThickness</code> — <code>double?</code></h4>
<ul>
<li>
<p><strong>含义</strong>：修饰线粗细（乘以字体的默认线厚比例），可精确控制下划线/删除线粗细。</p>
</li>
<li>
<p><strong>示例</strong>:</p>
<p>TextStyle(decoration: TextDecoration.underline, decorationThickness: 2.0);</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-160"><code>debugLabel</code> — <code>String?</code></h4>
<ul>
<li><strong>含义</strong>：仅用于调试/诊断信息的标签（不会影响渲染），Flutter 工具/日志可能会显示它来帮助识别样式来源。</li>
<li><strong>示例</strong>：开发时可加上 <code>debugLabel: 'headline-override'</code>。</li>
</ul>
<hr/>
<h4 data-id="heading-161"><code>package</code> — <code>String?</code>（构造器参数）</h4>
<ul>
<li>
<p><strong>含义</strong>：当 <code>fontFamily</code> 指向一个在 package 中声明的字体时，需要通过构造器传入 <code>package: 'my_package'</code>，以便正确前缀资源路径。</p>
</li>
<li>
<p><strong>示例</strong>（声明 fontFamily 在 package 中）：</p>
<p>const TextStyle(fontFamily: 'MyFont', package: 'my_package');</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-162"><code>fontFeatures</code>（已在上面）与 <code>fontFamilyFallback</code>（已在上面）</h4>
<ul>
<li>再次提示：<code>fontFamilyFallback</code> 对于 emoji、多语言渲染非常有用；<code>fontFeatures</code> 让你启用 OpenType 功能。</li>
</ul>
<hr/>
<h4 data-id="heading-163"><code>overflow</code> — <code>TextOverflow?</code>（较新的属性）</h4>
<ul>
<li><strong>含义</strong>：告诉 <code>TextPainter</code> 在文本修建/测量时如何处理溢出（例如 <code>TextOverflow.visible</code> / <code>ellipsis</code> / <code>clip</code>）。</li>
<li><strong>用途</strong>：当需要对富文本进行特殊截断行为时可用（注意：<code>Text</code> 小部件也有自己的 <code>overflow</code> 参数，<code>TextStyle.overflow</code> 是更基础的绘制层控制）。</li>
</ul>
<hr/>
<h3 data-id="heading-164">使用优先级提示（常见坑）</h3>
<ol>
<li><strong><code>foreground</code> 优先于 <code>color</code></strong>：如果你设置了 <code>foreground</code>（Paint），它会替代 <code>color</code> 的填充行为。</li>
<li><strong><code>background</code> vs <code>backgroundColor</code></strong>：<code>background</code> 接受 <code>Paint</code>，可以实现更复杂效果；若只需单色背景，考虑把背景放在容器上或使用 <code>backgroundColor</code>（在某些 API/版本中可用）。</li>
<li><strong>继承 (<code>inherit</code>)</strong>：很多时候你只想覆盖部分属性，保持 <code>inherit: true</code> 让其它样式从父节点继承。</li>
<li><strong>字体加载/包（package）</strong>：使用第三方包里的字体需要构造器 <code>package</code> 参数或在 <code>pubspec.yaml</code> 正确声明。</li>
<li><strong>性能</strong>：<code>shadows</code>、<code>foreground</code>（描边）、复杂 <code>fontFeatures</code> 在大量文本或频繁重绘时会有性能影响。尽量在需要时使用，避免在长列表里反复使用高开销样式。</li>
</ol>
<hr/>
<h3 data-id="heading-165">常见示例（缩进写法，便于一键复制）</h3>
<h4 data-id="heading-166">基本样式</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">TextStyle</span>(
  <span class="hljs-attribute">color</span>: Colors.black87,
  <span class="hljs-attribute">fontSize</span>: <span class="hljs-number">16</span>,
  <span class="hljs-attribute">fontWeight</span>: FontWeight.w500,
)
</code></pre>
<h4 data-id="heading-167">描边 + 填充（使用 foreground + background）</h4>
<pre><code class="hljs language-ini" lang="ini">final <span class="hljs-attr">stroke</span> = Paint()
  ..<span class="hljs-attr">style</span> = PaintingStyle.stroke
  ..<span class="hljs-attr">strokeWidth</span> = <span class="hljs-number">2</span>
  ..<span class="hljs-attr">color</span> = Colors.black<span class="hljs-comment">;</span>
final <span class="hljs-attr">fill</span> = Paint()
  ..<span class="hljs-attr">style</span> = PaintingStyle.fill
  ..<span class="hljs-attr">color</span> = Colors.white<span class="hljs-comment">;</span>
TextStyle(
  foreground: stroke, // 描边
  background: fill,    // 背景填充（高级用法）
)
</code></pre>
<h4 data-id="heading-168">阴影 + 下划线</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">TextStyle</span>(
  <span class="hljs-attribute">color</span>: Colors.blue,
  <span class="hljs-attribute">decoration</span>: TextDecoration.underline,
  <span class="hljs-attribute">decorationColor</span>: Colors.blueAccent,
  <span class="hljs-attribute">decorationStyle</span>: TextDecorationStyle.dashed,
  <span class="hljs-attribute">shadows</span>: [
    <span class="hljs-built_in">Shadow</span>(<span class="hljs-attribute">color</span>: Colors.black26, <span class="hljs-attribute">offset</span>: <span class="hljs-built_in">Offset</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>), <span class="hljs-attribute">blurRadius</span>: <span class="hljs-number">2</span>),
  ],
)
</code></pre>
<h4 data-id="heading-169">字体特性（表格数字）</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">TextStyle</span>(
  <span class="hljs-attribute">fontFeatures</span>: [FontFeature.<span class="hljs-built_in">tabularFigures</span>()],
  <span class="hljs-attribute">fontFamily</span>: <span class="hljs-string">'RobotoMono'</span>,
  <span class="hljs-attribute">fontSize</span>: <span class="hljs-number">14</span>,
)
</code></pre>
<h4 data-id="heading-170">多语言回退字体</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">TextStyle</span>(
  <span class="hljs-attribute">fontFamily</span>: <span class="hljs-string">'PrimaryFont'</span>,
  <span class="hljs-attribute">fontFamilyFallback</span>: [<span class="hljs-string">'NotoSans'</span>, <span class="hljs-string">'Segoe UI Emoji'</span>],
)
</code></pre>
<hr/>
<h3 data-id="heading-171">调试建议</h3>
<ul>
<li>使用 <code>debugLabel</code> 帮助在 DevTools / 日志里定位样式来源。</li>
<li>在遇到“样式没有生效”时，检查 <code>inherit</code>、<code>foreground</code>、<code>DefaultTextStyle</code> 覆盖规则以及父级 <code>TextSpan</code> 的样式继承链。</li>
<li>使用 Flutter Inspector 查看最终合并后的 <code>TextStyle</code>（<code>Text</code> -&gt; properties -&gt; style）。</li>
</ul>
<hr/>
<h3 data-id="heading-172">简短速查表（Cheat Sheet）</h3>


































































































































<table><thead><tr><th>属性</th><th>类型</th><th>用途</th></tr></thead><tbody><tr><td>inherit</td><td>bool</td><td>是否继承父样式</td></tr><tr><td>color</td><td>Color?</td><td>文本颜色（常用）</td></tr><tr><td>fontFamily</td><td>String?</td><td>字体族</td></tr><tr><td>fontFamilyFallback</td><td>List?</td><td>回退字体列表</td></tr><tr><td>fontSize</td><td>double?</td><td>字体大小</td></tr><tr><td>fontWeight</td><td>FontWeight?</td><td>粗细</td></tr><tr><td>fontStyle</td><td>FontStyle?</td><td>normal / italic</td></tr><tr><td>letterSpacing</td><td>double?</td><td>字母间距</td></tr><tr><td>wordSpacing</td><td>double?</td><td>单词间距</td></tr><tr><td>height</td><td>double?</td><td>行高倍数</td></tr><tr><td>leadingDistribution</td><td>TextLeadingDistribution?</td><td>leading 分配策略</td></tr><tr><td>textBaseline</td><td>TextBaseline?</td><td>基线类型（alphabetic/ideographic）</td></tr><tr><td>locale</td><td>Locale?</td><td>文本区域（语言）</td></tr><tr><td>foreground</td><td>Paint?</td><td>前景 Paint（高级）</td></tr><tr><td>background</td><td>Paint?</td><td>背景 Paint（高级）</td></tr><tr><td>shadows</td><td>List?</td><td>阴影列表</td></tr><tr><td>fontFeatures</td><td>List?</td><td>OpenType 特性</td></tr><tr><td>decoration</td><td>TextDecoration?</td><td>下划线/删除线等</td></tr><tr><td>decorationColor</td><td>Color?</td><td>修饰线颜色</td></tr><tr><td>decorationStyle</td><td>TextDecorationStyle?</td><td>修饰线样式</td></tr><tr><td>decorationThickness</td><td>double?</td><td>修饰线粗细</td></tr><tr><td>debugLabel</td><td>String?</td><td>调试标签</td></tr><tr><td>package</td><td>String?</td><td>若字体在 package 中，传 package 名称</td></tr><tr><td>overflow</td><td>TextOverflow?</td><td>文本溢出绘制策略（底层）</td></tr></tbody></table>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 CICD 中实践 Fastlane + Appuploader 命令行，构建可复制的 iOS 自动化发布流程]]></title>    <link>https://juejin.cn/post/7581279471745482786</link>    <guid>https://juejin.cn/post/7581279471745482786</guid>    <pubDate>2025-12-08T08:41:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581279471745482786" data-draft-id="7581073928716599330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 CICD 中实践 Fastlane + Appuploader 命令行，构建可复制的 iOS 自动化发布流程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-08T08:41:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 CICD 中实践 Fastlane + Appuploader 命令行，构建可复制的 iOS 自动化发布流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:41:50.000Z" title="Mon Dec 08 2025 08:41:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 iOS 项目的交付链路中，自动化工具已经成为必需品。无论团队规模大小，只要迭代频率足够高，人工上传 IPA、手动处理资源信息、频繁修改本地证书配置都会让流程变得脆弱且低效。Fastlane 作为业界最常用的自动化工具之一，的确解决了许多重复性工作，但它并不能完全覆盖所有场景，尤其是在 <strong>跨平台上传 IPA</strong> 或 <strong>非 macOS 环境构建 CI</strong> 的项目中。</p>
<p>在多个实际项目中，我逐渐形成了一种稳定可靠的方式：
<strong>使用 Fastlane 做自动化流程控制，用 Appuploader 命令行做跨平台上传补位。</strong></p>
<p>这种组合方式的优势在于：</p>
<ul>
<li>保留 Fastlane 的脚本化能力</li>
<li>用 Appuploader 解决 <em>“Transporter 只能在 macOS 上运行”</em> 的限制</li>
<li>可运行于 Windows、Linux 以及服务器环境</li>
<li>支持 CLI，让流程更适合集成到 CI/CD</li>
</ul>
<hr/>
<h2 data-id="heading-0"><strong>一、Fastlane 的能力边界：为什么还需要其他工具补充？</strong></h2>
<p>Fastlane 的核心优势是自动化，包括：</p>
<ul>
<li>自动构建工程</li>
<li>自动上传截图、元数据</li>
<li>自动操作证书体系（match）</li>
<li>自动提交审核</li>
</ul>
<p>但它也具有某些局限：</p>
<ol>
<li><strong>不能完全脱离 macOS 环境</strong>
如果想上传 IPA 到 App Store，需要依赖 Transporter 或 Xcode API，而这些仅在 macOS 上可用。</li>
<li><strong>跨平台 CI 难以直接运行 upload_to_app_store</strong>
例如 GitLab、Jenkins、GitHub Actions，如果 Runner 节点是 Linux 或 Windows，将无法执行上传动作。</li>
<li><strong>对一些团队来说配置成本较高</strong>
尤其是前端团队、跨端项目（如 uni-app、Flutter）中，Fastlane 的 Ruby 配置并不是友好选项。</li>
</ol>
<p>因此，引入一个可跨平台执行上传任务的工具，可以将 Fastlane 的自动化优势延伸到更多环境中。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、Appuploader 命令行在自动化链路中的价值</strong></h2>
<p>在跨平台 CI 中，我使用 <strong>开心上架（Appuploader）命令行工具</strong> 来接管 “最终 IPA 上传” 过程，主要理由是：</p>
<ul>
<li>支持 Windows / Linux / macOS</li>
<li>仅需账户与专用密码即可执行上传</li>
<li>不依赖 Xcode 或 macOS 设备信息</li>
<li>可单独运行，无 GUI 依赖</li>
<li>可以专门被嵌入到 Fastlane 的 shell 命令中执行</li>
</ul>
<p>上传示例：</p>
<pre><code class="hljs language-bash" lang="bash">appuploader_cli -u dev@icloud.com -p xxx-xxx-xxx -c 1 -f app.ipa
</code></pre>
<p>参数简单且稳定，非常适合集成为发布链路中的单个步骤。
在许多项目中，这条命令就是将构建产物提交给 App Store 审核的触发点。</p>
<hr/>
<h2 data-id="heading-2"><strong>三、将 Fastlane 与 Appuploader CLI 结合的典型场景</strong></h2>
<p>下面几个场景最能体现两者组合的必要性。</p>
<hr/>
<h3 data-id="heading-3"><strong>场景 1：CI 是 Linux 服务器，但需要自动上传 IPA</strong></h3>
<p>例如 GitHub Actions、GitLab Runner 或企业内部 Jenkins，构建环境往往是 Linux。
构建完成后，Fastlane 负责整理产物与信息，但无法直接调用 Transporter。</p>
<p>解决方式：
在 Fastlane 的 lane 中加入一段 shell 脚本调用 Appuploader CLI。</p>
<p>示例：</p>
<pre><code class="hljs language-ruby" lang="ruby">lane <span class="hljs-symbol">:release</span> <span class="hljs-keyword">do</span>
  build_app(<span class="hljs-symbol">scheme:</span> <span class="hljs-string">"App"</span>)
  
  sh(<span class="hljs-string">"
    appuploader_cli \
    -u <span class="hljs-subst">#{<span class="hljs-variable constant_">ENV</span>[<span class="hljs-string">'APPLE_ID'</span>]}</span> \
    -p <span class="hljs-subst">#{<span class="hljs-variable constant_">ENV</span>[<span class="hljs-string">'APP_SPECIFIC_PWD'</span>]}</span> \
    -c 1 \
    -f ./build/App.ipa
  "</span>)
<span class="hljs-keyword">end</span>
</code></pre>
<p>Fastlane 仍是“总控”，Appuploader 负责“最终上传”，两者互不冲突。</p>
<hr/>
<h3 data-id="heading-4"><strong>场景 2：无需让 Fastlane 接管证书体系</strong></h3>
<p>一些团队不希望引入 match，不想维护 Git 加密仓库，也不想改变现有证书体系。
他们只希望：</p>
<ul>
<li>证书能跨团队电脑使用</li>
<li>描述文件可查看与管理</li>
<li>CI 能使用现成的证书构建</li>
</ul>
<p>在这种场景中，我通常使用 Appuploader 的部分功能来：</p>
<ul>
<li>查看 mobileprovision 内容</li>
<li>查看证书指纹</li>
<li>确认证书与描述文件是否匹配
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d18c20412fb146e0ab2f69c9a16bb17a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D54y054i3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788110&amp;x-signature=5U1OYjveOcnPV%2B5NfyVtTwduaVU%3D" alt="查看描述文件" loading="lazy"/></li>
</ul>
<p>这些能力在排查签名问题时非常关键，特别是在跨平台构建链路中。</p>
<p>由于 Appuploader 支持在 Windows 与 Linux 上查看配置文件内容，团队成员不再依赖某台 Mac 才能确认签名信息是否正确。</p>
<hr/>
<h3 data-id="heading-5"><strong>场景 3：上传步骤独立化，便于替换与升级</strong></h3>
<p>相比让 Fastlane 完全控制上传，将上传步骤单独拆出具有以下好处：</p>
<ul>
<li>出错时不会影响整个 lane</li>
<li>更容易写重试逻辑</li>
<li>上传命令可单独在本机运行验证</li>
<li>可被迁移到其他脚本体系中（Python、Shell、Node.js 等）</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># retry upload up to 3 times</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> {1..3}
<span class="hljs-keyword">do</span>
  appuploader_cli -u <span class="hljs-string">"<span class="hljs-variable">$APPLE</span>"</span> -p <span class="hljs-string">"<span class="hljs-variable">$PWD</span>"</span> -c 2 -f <span class="hljs-string">"./dist/app.ipa"</span> &amp;&amp; <span class="hljs-built_in">break</span>
  <span class="hljs-built_in">sleep</span> 5
<span class="hljs-keyword">done</span>
</code></pre>
<p>将上传视为“独立步骤”，是构建稳定 CI/CD 流程的关键方式之一。</p>
<hr/>
<h2 data-id="heading-6"><strong>四、实际项目中的落地示例：构建一个可复用的 pipeline</strong></h2>
<p>下面是我在生产项目中使用过的简化流程示意：</p>
<ol>
<li><strong>Fastlane 负责：</strong>
<ul>
<li>拉代码</li>
<li>生成版本号</li>
<li>调用构建命令（Xcode、Flutter、uni-app 等）</li>
<li>输出 IPA</li>
</ul>
</li>
<li><strong>Appuploader CLI 负责：</strong>
<ul>
<li>将 IPA 上传 App Store</li>
<li>根据 CI 构建结果触发版本提交</li>
</ul>
</li>
<li><strong>额外工具（可选）</strong>
<ul>
<li>用 Appuploader 查看证书、描述文件</li>
<li>Fastlane 管理元数据或截图</li>
<li>其他内部脚本做通知或日志管理</li>
</ul>
</li>
</ol>
<p>这种模式的优势是：</p>
<ul>
<li>macOS 不再是流程瓶颈</li>
<li>上传逻辑可跨平台迁移</li>
<li>Fastlane 与 Appuploader 各自负责不同层面，不互相影响</li>
<li>组件化的脚本结构便于后续维护</li>
</ul>
<p>最终结果是一个可复制、可调试、可扩展的自动化发布体系。</p>
<hr/>
<h2 data-id="heading-7"><strong>五、这种组合方式的适用人群</strong></h2>
<p>根据多个项目经验，我认为以下团队会从中显著受益：</p>
<ul>
<li><strong>CI 没有 macOS 节点的团队</strong></li>
<li><strong>需要跨平台开发（Flutter、uni-app、React Native）的团队</strong></li>
<li><strong>证书体系不想完全交给 match 管理的团队</strong></li>
<li><strong>希望将上传动作与构建动作彻底拆分的团队</strong></li>
<li><strong>希望脚本能简单、可被非 iOS 工程师维护的团队</strong></li>
</ul>
<p>对于这些团队来说，这种组合比任何单一工具都更实用。</p>
<hr/>
<p>Fastlane 是优秀的自动化工具，但它从设计上就与 macOS 绑定较深。而在现代研发体系里，CI/CD 越来越向跨平台、容器化、云端化迁移。将 Fastlane 与 Appuploader 命令行结合使用，可以让 iOS 发布流程真正脱离单一系统限制，使团队能够构建一个可共享、可维护、可重复执行的自动化发布链路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nano Banana Pro 零基础快速上手]]></title>    <link>https://juejin.cn/post/7581097545670656019</link>    <guid>https://juejin.cn/post/7581097545670656019</guid>    <pubDate>2025-12-08T08:44:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581097545670656019" data-draft-id="7581097111895851062" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Nano Banana Pro 零基础快速上手"/> <meta itemprop="keywords" content="人工智能,AIGC,前端"/> <meta itemprop="datePublished" content="2025-12-08T08:44:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Nano Banana Pro 零基础快速上手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:44:28.000Z" title="Mon Dec 08 2025 08:44:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">介绍</h2>
<p>Nano Banana Pro 是 Google DeepMind 在 2025 年 11 月 20 日发布的最新 AI 图像生成和编辑工具，基于 Gemini 3 Pro 大模型构建。</p>
<p>这个名字初听有些奇怪，其实是 Gemini 生图模型的代号：</p>
<ul>
<li><strong>Nano Banana = Gemini 2.5 Flash Image</strong></li>
<li><strong>Nano Banana Pro = Gemini 3 Pro Image</strong></li>
</ul>
<p>因其生图效果非常出色，受到很多人的喜爱和使用。</p>
<p>目前 Nano Banana Pro 在 LMArena 图片编辑模型排行榜中排名第一，而第二是 Nano Banana，可谓是断层领先了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3867bf74f6b34f80b353f46bd27cd9b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788267&amp;x-signature=1mFpCFUDvNMvGEFtQZylzDkTDNQ%3D" alt="" loading="lazy"/></p>
<p>相比于其他 AI 模型，Nano Banana Pro 可以：</p>
<ol>
<li>支持中文</li>
<li>能在图片中生成可清晰阅读的文字</li>
<li>支持超高清 4K 输出</li>
<li>实现摄影师级别的精细控制如角度、光照等</li>
</ol>
<p>举个例子，当你的提示词为：</p>
<blockquote>
<p>以超写实风格，从高角度捕捉一张自然随性的抓拍照片：年轻的亚洲女生蹲坐在水泥地的庭院中，侧身向后回望，目光微微上扬对视镜头；她嘴唇紧闭，带着害羞含蓄的笑容，眼睛大而明亮、圆润，明显的卧蚕衬托出俏皮可爱的神情。肌肤瓷白细腻，散发着自然的柔光。她穿着一件鼠尾草绿的针织露背长袖上衣，袖子覆盖着手掌，下身搭配牛仔短裤，赤脚穿着棕褐色凉鞋。一只手臂向外舒展，正在与旁边栓着绳子的姜黄色猫咪互动，身旁放着一张覆盖粉色民族风桌布的木质桌子。图片呈现 8K 分辨率，风格真实、细节丰富。</p>
</blockquote>
<p>生成的图片效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff19cbff7aed4443987afa09447e42b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788267&amp;x-signature=%2FZka8AL9d33D30EA5AOajE1GMIM%3D" alt="" loading="lazy"/></p>
<p>也可以让 Nano Banana Pro 对输入的内容进行总结，生成清晰易读的图片：</p>
<blockquote>
<p>白板总结（教学用途）：请用手绘白板图的形式总结“Transformer 神经网络架构”的概念，使其适用于大学讲座。编码器和解码器模块请使用不同颜色的马克笔，并清晰标注“自注意力”和“前馈”。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ae1b26ba6c14616bc5e29c4d2393659~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788267&amp;x-signature=QW4e7xZzOPgboYdmFJ8u8zLQkmU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">如何免费使用？</h2>
<p>目前有一些网站支持免费使用 Nano Banana Pro，对于日常使用，完全足够了。</p>
<p>阅读这篇：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FtYKzM0PIvBm5QG08SW3_BA" target="_blank" title="https://mp.weixin.qq.com/s/tYKzM0PIvBm5QG08SW3_BA" ref="nofollow noopener noreferrer">6 个白嫖 Nano Banana Pro 的网站</a></p>
<p>就个人使用经验，目前 Flowith 最好用，没有限制，不用排队。</p>
<h2 data-id="heading-2">提示词库</h2>
<p>如果你不知道能用 Nano Banana Pro 实现什么？</p>
<p>那可以看看这些提示词库。目前已经更新了几千个提示词。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FxZQNPPwGxhzWhGsr-alKkg" target="_blank" title="https://mp.weixin.qq.com/s/xZQNPPwGxhzWhGsr-alKkg" ref="nofollow noopener noreferrer">一次找齐！1000 个 Nano Banana Pro 提示词</a></p>
<p>遇到喜欢的，改一改就能直接使用。</p>
<h2 data-id="heading-3">提示词如何写？</h2>
<p>如果你想生成高质量的原创图片，那你就得学习 Nano Banana Pro 的提示词该如何写。</p>
<p>最好的教程首先是 Google 官方发布的提示词教程：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzjAFsnzDD97d6WJk9nfeyw" target="_blank" title="https://mp.weixin.qq.com/s/zjAFsnzDD97d6WJk9nfeyw" ref="nofollow noopener noreferrer">Nano Banana Pro 很强，但你要学会写提示词才能随心所欲</a></p>
<p>在这里文章中，官方举了 13 个提示词模板，根据自己的需求，选择合适的模板，让 Nano Banana Pro 生成的效果更好。</p>
<p>其次是 Nano Banana Pro 官方转载的这篇文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FniwA6qZqlqphW7FP1vNycw" target="_blank" title="https://mp.weixin.qq.com/s/niwA6qZqlqphW7FP1vNycw" ref="nofollow noopener noreferrer">10 个 Nano Banana Pro 专业级生图技巧</a></p>
<p>在这篇文章中，点出了使用 Nano Banana Pro 的黄金法则，那就是把 Nano Banana Pro 当成一个“思考”模型，而不是一个关键词匹配工具。</p>
<p>Nano Banana Pro 可以理解意图、物理原理和构图，所以你要像指导一个艺术家创造一样，去指明意图、去详尽描述。</p>
<p>这篇文章还举了非常的例子，列出了 Nano Banana Pro 可以实现的效果。值得一看。</p>
<p>当你学习了这些教程后，可以再看下这篇：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FSUowZG7ibLHaD4LlJ4bnvg" target="_blank" title="https://mp.weixin.qq.com/s/SUowZG7ibLHaD4LlJ4bnvg" ref="nofollow noopener noreferrer">不知道怎么写 Nano Banana Pro 提示词？分享你一个结构化示例，复刻任意图片</a></p>
<p>在这篇文章，总结了一个结构化的提示词示例。这是因为绝大部分人写提示词，几乎没有章法，想到哪写到哪，结果生成的图片就像“抽卡”。</p>
<p>当你开始使用结构化的提示词，那你不会遗漏这遗漏那，这就会大幅提升图片生成的确定性。</p>
<h2 data-id="heading-4">提示词案例</h2>
<p>最后我们几个最近非常火的提示词案例：</p>
<p>一个是像素级拆解：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f215bc02525c45928d25ed1c859accb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788267&amp;x-signature=pcdijlq%2BIG2s4HThGexbhCsM%2B2M%3D" alt="" loading="lazy"/></p>
<p>实现方式如下：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FR0PFw4UWlkrb2KtAGFDhUA" target="_blank" title="https://mp.weixin.qq.com/s/R0PFw4UWlkrb2KtAGFDhUA" ref="nofollow noopener noreferrer">疯传的 Nano Banana Pro 像素级拆解提示词</a></p>
<p>一个是动漫变真人：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5eb2d441f1b4515af907ca9d163ba5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788267&amp;x-signature=rnObks7o5MILR6rHQ%2Fvj9Xn%2F640%3D" alt="" loading="lazy"/></p>
<p>实现方式如下：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FAENFcFHlDXAmC_X6LZu7QA" target="_blank" title="https://mp.weixin.qq.com/s/AENFcFHlDXAmC_X6LZu7QA" ref="nofollow noopener noreferrer">太好看了！3 个动漫变真人 Nano Banana Pro 提示词</a></p>
<p>更多 Nano Banana Pro 系列内容还在持续更新中，欢迎关注。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[千万别再纠结Flutter状态管理，90%项目根本不需要选]]></title>    <link>https://juejin.cn/post/7581097545670721555</link>    <guid>https://juejin.cn/post/7581097545670721555</guid>    <pubDate>2025-12-08T08:50:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581097545670721555" data-draft-id="7581081334851584041" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="千万别再纠结Flutter状态管理，90%项目根本不需要选"/> <meta itemprop="keywords" content="Flutter,客户端"/> <meta itemprop="datePublished" content="2025-12-08T08:50:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老刘"/> <meta itemprop="url" content="https://juejin.cn/user/662360127965769"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            千万别再纠结Flutter状态管理，90%项目根本不需要选
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/662360127965769/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老刘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:50:16.000Z" title="Mon Dec 08 2025 08:50:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>哈喽，我是老刘</strong></p>
<p>老刘做Flutter开发7年了，被问到最多的问题之一就是状态管理怎么选。</p>
<p>比如昨天半夜，有个兄弟给我发微信，说是新接的那个私活，纠结是用Provider还是Bloc。</p>
<p>这一纠结就是三天，代码一行没写，网络上的对比文章倒是看了几十篇。</p>
<p>我看了一眼他的需求，一共才20个页面的小商城，我差点一口老血喷在屏幕上。</p>
<p>兄弟们，这不叫技术选型严谨，这叫“技术选择焦虑症”，说难听点就是潜意识里想偷懒。</p>
<p>对于这种体量的项目，你闭着眼睛抓阄选一个，哪怕是用最土的setState，也就是多写几行代码的事儿。</p>
<p>但你这三天纠结的时间，要是用来写代码，首页和详情页早就跑通了。</p>
<p>咱们程序员最大的幻觉，就是觉得选对了框架，烂代码就能自动变香。</p>
<p>真正的高手拿把菜刀都能雕出花来，而你还在纠结是买瑞士军刀还是屠龙宝刀。</p>
<h2 data-id="heading-0">你的“小破站”，根本不需要屠龙刀</h2>
<p>咱们手里正在写的90%的项目，根本就不配谈什么“复杂状态管理”。</p>
<p>不管是你接的那个两万块的外包，还是自己用来练手的Demo。</p>
<p>扒开那些高大上的外衣，本质上就是一个“网络请求播放器”。</p>
<p>你仔细回想一下你的代码逻辑。</p>
<blockquote>
<p>用户打开页面A，屏幕中间转个圈圈。</p>
<p>App调用后台接口，拉回来一坨JSON数据。</p>
<p>然后你把数据解析一下，塞进ListView里展示出来。</p>
<p>用户手指头一点，跳转到页面B。</p>
<p>App再屁颠屁颠跑去后台，拉回另一坨JSON，展示个详情页。</p>
</blockquote>
<p>这就是你们口中所谓的“核心业务逻辑”。</p>
<p>就这种线性的、一眼就能看到底的“一条龙”服务。</p>
<p>你摸着良心告诉我，哪里有“错综复杂”的状态需要管理？</p>
<p>这就好比你仅仅是想削个苹果吃。</p>
<p>结果你非要觉得自己是个绝世高手。</p>
<p>跑到博物馆里偷了一把屠龙宝刀。</p>
<p>还得先闭关修炼七七四十九天的刀谱。</p>
<p>最后气沉丹田，一刀下去，苹果烂了。</p>
<p>听老刘一句劝。</p>
<p>这种时候，Provider甚至最原始的setState，就是最好用的神兵利器。</p>
<p>简单才是王道，能快速交付拿到钱才是硬道理。</p>
<p>别让那些高大上的技术名词，把你的脑子给忽悠瘸了。</p>
<h2 data-id="heading-1">你是“搭积木”还是“造航母”？</h2>
<p>很多兄弟之所以焦虑，根本原因就一个。</p>
<p>想要搭个积木，确选了造航母的图纸。</p>
<p>你做一个只有自己看的记账App，一共没几个页面。</p>
<p>非要吧各种高大上的技术都用上，还要搞什么DDD领域驱动设计。</p>
<p>反过来说，你若是真在搞一个像淘宝、微信这样复杂的国民级App。</p>
<p>光是状态流转就能画满整整一面墙。</p>
<p>这时候你却想着用全局变量或者简单的setState打天下。</p>
<p>那绝对是给自己，也给后来的维护者埋雷。</p>
<p>所以，到底该怎么选？</p>
<p>做小项目，或者验证想法的MVP（最小可行性产品）。</p>
<p>Provider、GetX，甚至就是裸写setState，哪个顺手用哪个。</p>
<p>千万别犹豫，犹豫一秒钟都是对生命的不尊重。</p>
<p>但如果是做大项目，涉及到十几号人协作，要维护个三五年。</p>
<p>那就得把眼睛瞪得像铜铃一样大。</p>
<p>怎么稳怎么来，怎么规范怎么来。</p>
<p>还要考虑AI友好度的问题。</p>
<p>这时候，Bloc 这种强约束、虽然写起来略微繁琐的框架。</p>
<p>就不再是累赘，而是你的“救命稻草”。</p>
<p>别被圈子里那些所谓的“技术政治正确”绑架了你的大脑。</p>
<p>根本就没有什么最好的框架，只有最适合你当下的选择。</p>
<h2 data-id="heading-2">总结：技术选择的终极智慧</h2>
<p>说到底，状态管理这事儿重要吗？</p>
<p>当然重要。</p>
<p>但对于你现在的项目来说，它可能真的连根葱都算不上。</p>
<p>在这个技术卷成麻花的时代。</p>
<p>真正的智慧，绝对不是你掌握了多少屠龙技。</p>
<p>而是你能分得清，什么时候该亮剑，什么时候该“差不多得了”。</p>
<p>别整天盯着那些所谓的“最佳实践”看。</p>
<p>那都是给大厂造航母用的，不是给你造独木舟用的。</p>
<p>选一个你自己用着最顺手、闭着眼都能写出来的框架。</p>
<p>哪怕它被各路大神鄙视，哪怕它看起来土得掉渣。</p>
<p>只要能让你快速把活儿干完，它就是最好的。</p>
<p>记住老刘的这句掏心窝子的话：</p>
<p>写代码赚钱的时间，永远比你纠结用什么框架装X的时间更值钱。</p>
<p>别让技术选择，成了你拖延症的遮羞布。</p>
<p>选一个，干就完了！</p>
<blockquote>
<p>如果看到这里的同学对客户端或者Flutter开发感兴趣，欢迎联系老刘，我们互相学习。</p>
<p>私信免费领老刘整理的《Flutter开发手册》，覆盖90%应用开发场景。</p>
<p>可以作为Flutter学习的知识地图。</p>
<p>—— laoliu_dev</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[移动端设备上稀奇古怪的前端问题收集（一）]]></title>    <link>https://juejin.cn/post/7581041679190507555</link>    <guid>https://juejin.cn/post/7581041679190507555</guid>    <pubDate>2025-12-08T08:52:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581041679190507555" data-draft-id="7581041679190491171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="移动端设备上稀奇古怪的前端问题收集（一）"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-08T08:52:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            移动端设备上稀奇古怪的前端问题收集（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:52:35.000Z" title="Mon Dec 08 2025 08:52:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为一名开发者，bug 往往是我们最怕遇见的东西；而比遇到 bug 更可怕的事情，是定位不到 bug。作为一名前端开发者，与业务逻辑相关的 bug 还相对好定位、好解决一些；而一些与语法特性、平台与设备差异相关的 bug 则更令人头疼一些。这里记录下我在工作中遇到过的稀奇古怪的前端问题，作为给自己的记录和提醒。</p>
<h2 data-id="heading-0"><strong>用 vh 定义全屏显示的问题</strong></h2>
<p>很多页面因为设计效果的需要，要求正好铺满一整个显示界面、也不允许上下滑动。做类似的需求时，往往直觉会使用这样的代码解决问题：</p>
<pre><code class="hljs language-css" lang="css">{
 <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
}
</code></pre>
<p>这样的代码看似很优雅，但是往往会有兼容性问题——不同浏览器定义的视口高度的定义不一致，导致 <code>100vh</code> 并不能真正覆盖全视口高度；还有不少浏览器视口高度数值不变但实际视口大小可变，比如移动端 Chrome 浏览器的导航栏时不时隐藏但网页获取的视口高度不变，这都会导致最终显示效果不符合预期。</p>
<p>如果要实现全屏幕覆盖不可滑动，更为稳妥和保险的方法是使用绝对定位：</p>
<pre><code class="hljs language-css" lang="css">{
 <span class="hljs-attribute">position</span>: fixed;
 <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
 <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
 <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
 <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-1"><strong>带 alpha 通道的 hex 颜色值失效的问题</strong></h2>
<p>在较新的 web 标准中，hex 格式的颜色代码也可以表示透明度了，只需要在常见的六位 hex 颜色代码后加两位表示透明度的 hex 值，例如 <code>#66ccff</code> 表示一种蓝色，而 <code>#66ccff80</code> 表示透明度 50% 的这种蓝色（80 是 16 进制的 128，是 256 的一半，即 50% 透明度）。虽然直接这样写代码的行为在前端开发中不普遍，但是设计师交付的视觉稿给出的参考值有不少是这种格式。如果直接把这样的颜色代码用于生产中，可能会出现以下两种问题：</p>
<p>◦如果你编写的项目引入了 less 或者 sass，在进行打包构建的操作时，部分预处理器无法正确识别带 alpha 通道的 hex 颜色值，因此这部分代码无法被正确转译，最终构建出的生产环境代码中这部分颜色可能丢失。</p>
<p>◦部分移动端浏览器并未适配带 alpha 通道的 hex 颜色值，因此即使是使用原生 css 完成的代码，也有可能出现在部分手机或部分浏览器颜色不正常的问题。</p>
<h2 data-id="heading-2"><strong>生命周期函数不执行的问题</strong></h2>
<p>在页面刚打开或准备关闭时，我们往往需要进行一些诸如数据初始化、登入登出、数据上报等行为，而这些往往是借助 Vue 或 React 的生命周期函数完成的。不过，生命周期函数不执行也是常被忽略的 bug，详细来说，又可以分为两类原因——</p>
<h3 data-id="heading-3"><strong>组件被 keep alive 导致未被卸载或重新加载</strong></h3>
<p>如果是 Vue 中使用 <code>keep-alive</code> 包裹的组件，或在 React 中使用类似的第三方库 keep alive 的组件，只会在第一次加载时执行生命周期初始化函数，且不会执行生命周期卸载函数。这导致的不符合预期的行为很好解决，只需要使用 <code>onActivated</code> 代替 <code>onMounted</code> ，用 <code>onDeactivated</code> 代替 <code>onUnmounted</code> 即可。</p>
<h3 data-id="heading-4"><strong>页面被直接关闭导致框架生命周期函数无法执行</strong></h3>
<p>不管是 Vue 还是 React，生命周期函数的正确执行都依赖于 Vue 或 React 实例的存在。而当用户直接关闭浏览器页面的时候，Vue 或 React 实例已经被销毁了，生命周期卸载函数当然就无法执行了。处理这种情况也并不麻烦，只需要在生命周期初始化函数中添加对 window 卸载事件的监听，然后把想要进行的操作放到 window 卸载事件函数里就好了。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">onMonted</span>(<span class="hljs-function">() =&gt;</span> {  
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {    
    <span class="hljs-comment">// 需要执行的代码 </span>
  });
});
</code></pre>
<h2 data-id="heading-5"><strong>文本中的 emoji 上下被裁剪</strong></h2>
<p>UGC 内容中经常出现文本和 emoji 混排的场景，而有时可能遇到 emoji 上下边缘被裁剪的问题。这往往是由于开发页面时为了限定文本高度和间距或其他排版方面的要求，将 line-height 和 font-size 设置为同样的值，且 overflow 属性被设置为 hidden 。如果出现类似情况，建议去除 line-height 的限制，而通过 margin 等方式控制行距，从而避免 emoji 被裁减。</p>
<h2 data-id="heading-6"><strong>输入框被弹起的软键盘覆盖的问题</strong></h2>
<p>如果移动端页面中有输入框，那么很可能面临输入框被弹起的软键盘覆盖的问题。一般来讲，对于需要弹起软键盘的场景，较新的浏览器或者移动端 app 的 webview 会自动聚焦到输入框中并滚动到相应位置，来保证输入框的正常显示；但是，对于如下两种情况，弹起的软键盘会将输入框覆盖，影响用户输入。</p>
<h3 data-id="heading-7"><strong>浏览器未能主动聚焦到输入框</strong></h3>
<p>软键盘弹起时，一般会从底部将页面顶起、压缩视口；视口高度变低了，原先处于显示区域的输入框可能就被挤到输入框外了。如果用户使用的浏览器版本较早或 app 内置 webview 较为特殊，有可能在软键盘弹出后浏览器未能主动聚焦到输入框上。这时，开发者必须主动聚焦到输入框并使输入框滚动到视口内。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">inputEle</span> = document.querySelector(<span class="hljs-string">'#target-input'</span>)<span class="hljs-comment">;inputEle.focus();inputEle.scrollIntoView();</span>
</code></pre>
<h3 data-id="heading-8"><strong>软键盘采用覆盖在视口上层而非压缩视口的方式弹出</strong></h3>
<p>如果浏览器或 webview 版本较为特殊，且输入框处于页面靠下的位置或者针对视口绝对定位于底部，那么可能会面临更加复杂的情况。刚才已经提到，正常情况下，软键盘弹起的标准做法是从底部将页面顶起、压缩视口高度；但是某些情况下，软键盘并不改变视口尺寸，而是直接盖在视口上方。这就导致页面逻辑上是展示完整的、输入框也正常显示在视口中；但软键盘遮挡了半个页面，也就真正意义上“覆盖”在输入框上。目前主流移动端浏览器较新的版本都不会出现这个问题，但是部分 app 内置 webview 会设置为“软键盘覆盖在 webview 上方”；因此要解决这个问题，必须由客户端更改 webview 的软键盘设置。如果是很旧的浏览器版本或者无法推动客户端开发解决问题，那就只能放弃治疗了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MQ消息乱序问题解析与实战解决方案]]></title>    <link>https://juejin.cn/post/7581270148045733928</link>    <guid>https://juejin.cn/post/7581270148045733928</guid>    <pubDate>2025-12-08T08:53:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581270148045733928" data-draft-id="7581041679190523939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MQ消息乱序问题解析与实战解决方案"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-08T08:53:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MQ消息乱序问题解析与实战解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:53:00.000Z" title="Mon Dec 08 2025 08:53:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 背景</h2>
<p>在分布式系统中，消息队列（MQ）是实现系统解耦、异步通信的重要工具。然而，MQ消费时出现的消息乱序问题，经常会对业务逻辑的正确执行和系统稳定性产生不良影响。本文将详细探讨MQ消息乱序问题的根源，并提供一系列在实际应用中可行的解决方案。</p>
<h2 data-id="heading-1">2. MQ消息乱序问题分析</h2>
<p>常见的MQ消息乱序问题的根源主要可以归结为以下几点：</p>
<h3 data-id="heading-2">2.1 相同topic内的消息乱序</h3>
<h4 data-id="heading-3">1). 并发消费：</h4>
<p>在分布式系统中，为了提高消息处理的吞吐量，通常会配置多个消费者实例来并发消费同一个队列中的消息。然而，由于消费者实例的机器性能、网络延迟以及处理速度的差异，可能导致消息的消费顺序与发送顺序不一致。</p>
<h4 data-id="heading-4">2). 消息分区：</h4>
<p>为了支持更高效的消息存储和消费，MQ系统通常会采用分区化的设计。然而，当同一业务逻辑的多条消息被分发到不同的分区时，消费者在消费这些消息时就可能出现乱序现象。</p>
<h4 data-id="heading-5">3). 网络延迟与抖动：</h4>
<p>消息在传输过程中可能会受到网络延迟和抖动的影响，导致消息到达消费者端的时间顺序与发送顺序不一致。</p>
<h4 data-id="heading-6">4). 消息重试与故障恢复：</h4>
<p>当消费者处理消息失败或出现故障时，MQ系统通常会进行消息重试或故障恢复操作。如果重试机制或故障恢复策略设计不当，也可能导致消息乱序。</p>
<h3 data-id="heading-7">2.2 不同topic的消息乱序</h3>
<p>从相对时间的视角来审视，消息被消费的顺序并不等同于其被发送的顺序。例如，系统A在12:00时向TopicA发送了消息msgA-12:00，而紧接着系统B在12:01时向TopicB发送了消息msgB-12:01。当系统C同时订阅并消费这两个Topic时，它无法预设msgA-12:00会必然先于msgB-12:01被接收。这是由于消息系统在处理过程中，受到诸如消息分区策略、各个Consumer的处理能力以及其诸如网络、堆积、重试等他综合因素的影响，导致无法确保消息遵循严格的先进先出原则。</p>
<h2 data-id="heading-8">3. 案例分析</h2>
<h3 data-id="heading-9">3.1 数据迁移过程中的mq消费乱序场景</h3>
<p>在数据迁移或同步过程中，尤其是双写场景（即数据既写入旧系统，又通过MQ发送到新系统进行异步处理），MQ乱序可能导致严重的数据不一致问题。</p>
<p>﻿</p>
<p><img src="" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>具体来说，当数据写入时发送INSERT MQ，数据更新时发送UPDATE MQ，如果UPDATE MQ先于INSERT MQ到达目标系统，目标系统可能会基于一个不存在的数据记录进行更新操作。这会导致以下几种情况：</p>
<p><strong>数据丢失</strong>：如果目标系统没有处理UPDATE MQ中提到的数据记录（因为该记录尚未通过INSERT MQ创建），则更新操作会失败，可能导致数据变更丢失或遗漏。</p>
<p><strong>数据覆盖</strong>：在高频修改的情况下，频繁更新可能会面临旧数据覆盖新数据的风险，比如UPDATE MQ携带的是旧数据且先于新数据的UPDATE MQ到达。</p>
<h3 data-id="heading-10">3.2 业务风险分析</h3>
<p>MQ乱序对数据迁移和同步过程的影响是深远的：</p>
<p><strong>数据一致性受损</strong>：最直接的影响是数据一致性受损。目标系统中的数据可能与源系统不一致，导致业务决策基于错误的数据。</p>
<p><strong>用户体验下降</strong>：数据不一致可能导致用户看到错误的信息或遇到功能故障，从而降低用户体验。</p>
<p><strong>业务中断</strong>：在严重的情况下，数据不一致可能导致业务中断或系统故障，影响企业的运营和声誉。</p>
<h2 data-id="heading-11">4. 解决方案</h2>
<p>为了解决这个问题，可以采取以下措施：</p>
<h3 data-id="heading-12">4.1 顺序消息</h3>
<p>消息顺序性保证：虽然Kafka不保证全局消息顺序，但可以通过合理的分区策略和消息键来确保同一账单的消息被发送到同一个分区，从而在一定程度上保证消息的顺序性。</p>
<p>比如RocketMQ支持顺序消息。但是需要注意这是局部有序，非全局后续。具体实现过程：</p>
<p>1.发送mq消息时，通过selector将同一个业务主键的消息，发送到同一队列中</p>
<p>2.消费方使用MessageListenerOrderly消费局部有序的消息</p>
<p>该方案需要发送方和消费方同步改造。</p>
<p>生产侧：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aee304b28aeb4b5b9d567792260c83c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788780&amp;x-signature=0lc29UUiuFpSTentcg4Unkd9VoU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>消费侧：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53744f16640b4ab68e20ed6f8012a6b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788780&amp;x-signature=T8YYy4uCiDYGky96fhj31yLIYKU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h3 data-id="heading-13">4.2 前置检测</h3>
<p>•在消费者处理消息之前，进行前置条件检查。例如，可以查询一个消息辅助表，确保上一个消息已经被成功消费或存入死信队列中。这种检查可以确保消息按照正确的顺序被处理。</p>
<p>•另一种方法是，在消息中添加序列号或时间戳，并在消费者端进行验证。如果当前消息的序列号或时间戳不符合预期顺序，则暂停处理并等待正确的消息到达。</p>
<h3 data-id="heading-14">4.3 状态机</h3>
<p>在消息处理系统中，状态机可以用来定义和处理消息的顺序。每个状态代表系统当前所处的特定条件或阶段，而状态之间的转换则是由接收到的消息触发的。当系统接收到一个消息时，它会检查当前的状态和消息类型，然后决定是否要转移到另一个状态并执行相应的动作。</p>
<p>对于消息乱序问题，状态机可以通过以下方式解决：</p>
<p>1.<strong>定义状态转换规则</strong>：首先，需要定义一套明确的状态转换规则。这些规则应该基于业务逻辑来确定，以确保消息按照正确的顺序被处理。例如，如果系统要求先处理事件A再处理事件B，那么状态机就应该在接收到事件A后转移到能够处理事件B的状态。</p>
<p>2.<strong>状态检查与消息缓存</strong>：当系统接收到一个消息时，它会检查当前的状态是否允许处理该消息。如果当前状态不允许处理该消息（即消息的顺序不正确），则可以将该消息缓存起来，等待状态机转移到正确的状态后再进行处理。</p>
<p>3.<strong>状态转移与消息处理</strong>：一旦状态机转移到正确的状态，它就可以处理缓存中的消息。这可以确保消息按照正确的顺序被处理，即使它们最初是以乱序到达的。</p>
<h3 data-id="heading-15">4.4 监控与报警</h3>
<p>建立系统的监控和报警机制，及时发现并处理消息错乱等异常情况。</p>
<p>通过采取以上措施，可以大大降低账单还款系统中消息错乱导致的问题，提高系统的稳定性和用户体验。</p>
<h2 data-id="heading-16">5. 小结</h2>
<p>MQ消息乱序是分布式系统的常见难题，影响系统稳定性和业务一致性。本文深入解析问题根源，探讨了顺序消息、前置检查、状态机等实战解决方案，为实际开发中的问题解决提供有力参考。</p>
<p><em>文章中难免会有不足之处，希望读者能给予宝贵的意见和建议。谢谢！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AIGC项目中的【模板进程】方案的设计实践]]></title>    <link>https://juejin.cn/post/7581041679190474787</link>    <guid>https://juejin.cn/post/7581041679190474787</guid>    <pubDate>2025-12-08T08:52:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581041679190474787" data-draft-id="7581098720035045416" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AIGC项目中的【模板进程】方案的设计实践"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-08T08:52:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AIGC项目中的【模板进程】方案的设计实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:52:10.000Z" title="Mon Dec 08 2025 08:52:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 项目介绍</h2>
<h3 data-id="heading-1">1.1 项目背景</h3>
<p>简单一句话：模板进程是流程的子流程；往往用于比较复杂的aigc项目流程中。</p>
<p>由于一个模板有多个流程，一个运营人员可以操作多个流程，也可创建多个流程。在模板推荐时，就会导致不知道是哪次流程。</p>
<h3 data-id="heading-2">1.2 项目目标</h3>
<p>为了区分模板中流程，就需要增加进程的概念（子流程），为了方便运营理解，此处也叫模板进程。</p>
<h2 data-id="heading-3">2 需求分析</h2>
<h3 data-id="heading-4">2.1 底层逻辑</h3>
<p>1、场景模板、指令触发模板均支持实例，模板数据支持根据实例进行隔离（原来启航项目创建多个SC，每次都需要澄清，现在根据进程隔离，当一个进程中存在多个SC时，才需要澄清），公共信息存储需要新增实例查询等能力</p>
<p>2、进程不会结束，支持移除（逻辑删除，不真实删除），仅进程创建人可删除自己创建的进程，项目管理员可删除所有进场，无权限不显示删除按钮（需要增加埋点，记录操作人及时间）</p>
<p>3、模板卡片的步骤流程状态，根据进程独立显示。</p>
<h3 data-id="heading-5">2.2 触发方式</h3>
<p>1、【自动显示】每次进入项目详情页，若全部进程中存在进程，自动显示此卡片，无进程不显示。</p>
<p>2、【指令触发】输入：进程/场景进程/模板进程</p>
<p>3、无进程，用户触发任意步骤，均创建一个新的进程</p>
<p>4、用户可根据需求选择【新建进程】</p>
<h3 data-id="heading-6">2.3 进程分类</h3>
<p>1、区分：全部进程、我的进程</p>
<p>2、每次触发卡片。默认打开【全部进程】</p>
<p>3、卡片引导文案，如下</p>
<p>全部进程：以下当前项目下正在进行中的所有进程，请选择。</p>
<p>我的进程：以下是您在当前项目下正在进行中的所有进程，请选择。</p>
<p>4、全部进程显示逻辑：显示当前项目的所有进程，按照创建时间倒序显示</p>
<h3 data-id="heading-7">2.4 进程详情</h3>
<p>1、显示字段</p>
<p>进程名称：默认显示模板名称，支持编辑</p>
<p>创建时间：进程创建时间，年月日 时分秒</p>
<p>创建人：显示创建人头像、中文名，点击支持快速唤起京ME进行对话</p>
<p>模板进度：显示当前模板进程实例中步骤完成情况</p>
<p>当前步骤信息：显示当前板进程实例中最新的正在操作/代操作的步骤</p>
<p>当前步骤操作人：若当前步骤有操作人，显示当前操作人信息，像是规则同创建人，若当前步骤操作人不显示该字段信息</p>
<h3 data-id="heading-8">2.5 进程名称修改</h3>
<p>1、点击编辑按钮，进程名称可编辑（保留原名称），最多支持1-20汉字长度，支持特殊字符。</p>
<p>2、删除空内容时，显示提示内容：支持1-20汉字</p>
<p>3、点击其他区域直接保存内容（若保存时，名称无内容，直接填充原始内容-模板名称）</p>
<h3 data-id="heading-9">2.6 删除进程</h3>
<p>1、仅进程创建人可删除自己创建的进程，项目管理员可删除所有进场，无权限不显示删除按钮</p>
<p>2、点击删除按钮，显示弹窗，二次确认</p>
<p>弹窗内容：是否确认删除此进程，进程删除后对应产生的数据建无法修改以及编辑，请慎重操作！</p>
<h3 data-id="heading-10">2.7 新建进程</h3>
<p>点击新建进程，后自动唤起场景模板引导卡片，新卡片无进程，用户点击任意步骤后，创建新进程实例</p>
<p>﻿</p>
<h2 data-id="heading-11">3 概要设计</h2>
<h3 data-id="heading-12">3.1 系统流程图</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b218d08bb26747848bd701c24c08a225~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788730&amp;x-signature=LRsqTRrm%2FGADW%2B4G5A6JDiDB3Lo%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>﻿</p>
<h3 data-id="heading-13">3.2 进程设计逻辑</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b62baae24ab4a3fbcb605a57ad1b695~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788730&amp;x-signature=JP7UOwsGXK1lgHcKOBs5e%2BWbgCE%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-14">3.3 进程卡片逻辑</h3>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dce801f199924a4bb2b144d48d3ad514~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788730&amp;x-signature=2uDWYkIoqAQjzf%2BvOKVh%2F1gFOgg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h2 data-id="heading-15">4 详细设计</h2>
<h3 data-id="heading-16">4.1 各模块实现方案</h3>
<p>1、<strong>自动卡片展示</strong>：每当用户访问项目详情页面时，系统将自动检测当前是否有任何进程正在运行。若存在进程，则立即显示相应的卡片信息；若当前无进程进行，则卡片不会显示，以保持界面的整洁性。</p>
<p>2、<strong>指令式激活</strong>：用户可通过输入特定的指令来触发相关功能，这些指令包括“进程”、“场景进程”或“模板进程”。输入任一指令后，系统将根据指令内容执行相应的操作或展示相关信息。</p>
<p>3、<strong>新建进程机制</strong>：若当前系统检测到没有正在进行的进程，并且用户尝试通过任何方式（如点击按钮、输入指令等）触发与进程相关的操作，系统将自动为用户创建一个全新的进程实例，以满足用户的操作需求。</p>
<p>4、<strong>用户自定义新建</strong>：此外，为了提供更高的灵活性和便捷性，用户还可以根据自己的具体需求，主动选择【新建进程】的选项来手动创建一个新的进程。这一功能允许用户随时根据自己的工作计划或项目需求，快速启动新的任务或项目进程。</p>
<p>5、<strong>进程的增删改查</strong>：添加、修改名字、搜索等逻辑。</p>
<h3 data-id="heading-17">4.2 实现方案详细设计</h3>
<p>以下为详细设计方案</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/786020d6c6fd472e99d6499d0396a99b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788730&amp;x-signature=8QZqFr01%2FKkMC%2Ffn8Nk5qfH6UA4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-18">4.3 模版进程卡片设计</h3>
<p>卡片样式配置规则</p>
<p>subType: "subType"</p>
<p>cardStyle: "subType_card_style" （控制样式专用）</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06bd41dbf1ed4024af435dc62606affd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788730&amp;x-signature=njo07sv4cADZVsbabxFcxFa3kiI%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>卡片数据结构</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"cardInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 卡片名称</span>
    <span class="hljs-attr">"subType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"full_work_card"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 卡片标识</span>
    <span class="hljs-attr">"workItem"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"allItem"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"全部进程"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"userItem"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"仅我创建"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"myTurnItem"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"轮到我的"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">}</span>
    <span class="hljs-attr">"newItem"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"新建进程"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
<span class="hljs-comment">// 返回给后端结构</span>
<span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ext"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"skillCall"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"domainCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"commandCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"workId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-19">5 实际效果</h2>
<p>点击项目详情，聊天助手打开进程卡片：</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a89ca92fa2ed4960843372ba86629fae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788730&amp;x-signature=Df1xHdqp7xMOWTlcKS3sjk6M1wA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>点击 “测2” 进程，进入如下页面：</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20df694aac634b7a8f0608a32b3d4fa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788730&amp;x-signature=clsDtbxPb6eulkESiQNi3WDm9mk%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>**</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++核心机制-复制消除]]></title>    <link>https://juejin.cn/post/7581210455826743332</link>    <guid>https://juejin.cn/post/7581210455826743332</guid>    <pubDate>2025-12-08T08:44:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581210455826743332" data-draft-id="7581097111895834678" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++核心机制-复制消除"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-08T08:44:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="徐行code"/> <meta itemprop="url" content="https://juejin.cn/user/4294010480902042"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++核心机制-复制消除
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294010480902042/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    徐行code
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:44:24.000Z" title="Mon Dec 08 2025 08:44:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这一块的内容主要设计：返回值优化，以及参数传递时候的优化。</p>
<p>避免写成return std::move(Myclass())的低质量代码。</p>
</blockquote>
<h2 data-id="heading-0">0、测试代码</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

using namespace <span class="hljs-built_in">std</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoudBot</span> {</span>
public:
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> _name;

    <span class="hljs-comment">// 1. 普通构造</span>
    LoudBot(<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> name) : _name(name) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"  [Construct] "</span> &lt;&lt; _name &lt;&lt; <span class="hljs-string">" @"</span> &lt;&lt; this &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    }

    <span class="hljs-comment">// 2. 拷贝构造</span>
    LoudBot(<span class="hljs-type">const</span> LoudBot&amp; other) : _name(other._name) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"  [Copy] from "</span> &lt;&lt; other._name &lt;&lt; <span class="hljs-string">" @"</span> &lt;&lt; this &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    }

    <span class="hljs-comment">// 3. 移动构造</span>
    LoudBot(LoudBot&amp;&amp; other) noexcept : _name(<span class="hljs-built_in">std</span>::move(other._name)) {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"  [Move] from "</span> &lt;&lt; _name &lt;&lt; <span class="hljs-string">" @"</span> &lt;&lt; this &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    }

    <span class="hljs-comment">// 4. 析构</span>
    ~LoudBot() {
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"  [Destruct] "</span> &lt;&lt; _name &lt;&lt; <span class="hljs-string">" @"</span> &lt;&lt; this &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    }
};

<span class="hljs-comment">// 场景 A: URVO (Unnamed RVO) - 返回无名临时对象</span>
LoudBot <span class="hljs-title function_">getUnnamed</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> LoudBot(<span class="hljs-string">"UnnamedBot"</span>); 
}

<span class="hljs-comment">// 场景 B: NRVO (Named RVO) - 返回具名局部变量</span>
LoudBot <span class="hljs-title function_">getNamed</span><span class="hljs-params">()</span> {
    LoudBot <span class="hljs-title function_">b</span><span class="hljs-params">(<span class="hljs-string">"NamedBot"</span>)</span>;
    
    <span class="hljs-keyword">return</span> b;
}

<span class="hljs-comment">// 场景 C: 反面教材 - 手动 move 局部变量 (阻止了 RVO)</span>
LoudBot <span class="hljs-title function_">getMoved</span><span class="hljs-params">()</span> {
    LoudBot <span class="hljs-title function_">b</span><span class="hljs-params">(<span class="hljs-string">"MovedBot"</span>)</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">std</span>::move(b); <span class="hljs-comment">// 千万别这么干！</span>
}

template&lt;typename T&gt;
<span class="hljs-type">void</span> <span class="hljs-title function_">func_for_x</span><span class="hljs-params">(T param)</span>{
    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"func_for_x"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;
}

template&lt;typename T&gt;
<span class="hljs-type">void</span> <span class="hljs-title function_">func_for_cx</span><span class="hljs-params">(<span class="hljs-type">const</span> T param)</span>{
    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"func_for_cx"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;
}

template&lt;typename T&gt;
<span class="hljs-type">void</span> <span class="hljs-title function_">func_for_rx</span><span class="hljs-params">(<span class="hljs-type">const</span> T&amp; param)</span>{
    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"func_for_rx"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;
}

<span class="hljs-type">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span>{
    <span class="hljs-comment">//测试形参传递优化</span>
    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"---1---"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;
    func_for_x(LoudBot(<span class="hljs-string">"WF"</span>));
    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"---2---"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;
    func_for_cx(LoudBot(<span class="hljs-string">"WF"</span>));
    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"---3---"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;
    func_for_rx(LoudBot(<span class="hljs-string">"WF"</span>));

    LoudBot <span class="hljs-title function_">val</span><span class="hljs-params">(<span class="hljs-string">"WF"</span>)</span>;

    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"---4---"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;
    func_for_x(val);
    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"---5---"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;
    func_for_cx(val);
    <span class="hljs-built_in">cout</span>&lt;&lt;<span class="hljs-string">"---6---"</span>&lt;&lt;<span class="hljs-built_in">endl</span>;
    func_for_rx(val);
}

<span class="hljs-type">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span>{
    <span class="hljs-comment">// 测试返回值优化</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"--- 1. Testing URVO (getUnnamed) ---"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    LoudBot bot1 = getUnnamed();

    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"\n--- 2. Testing NRVO (getNamed) ---"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    LoudBot bot2 = getNamed();

    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"\n--- 3. Testing Pessimizing Move (getMoved) ---"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    LoudBot bot3 = getMoved();
    
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"\n--- End of Test2 ---"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    <span class="hljs-keyword">return</span>;
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{
    test1();
    test2();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>开启禁止优化：<code>-fno-elide-constructors </code>会发现：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">---1---</span>
  [Construct] WF <span class="hljs-variable">@0x7ffee7238d00</span>
  [Move] <span class="hljs-keyword">from</span> WF <span class="hljs-variable">@0x7ffee7238d20</span>
func_for_x
  [Destruct] WF <span class="hljs-variable">@0x7ffee7238d20</span>
  [Destruct]  <span class="hljs-variable">@0x7ffee7238d00</span>
<span class="hljs-comment">---2---</span>
  [Construct] WF <span class="hljs-variable">@0x7ffee7238d00</span>
  [Move] <span class="hljs-keyword">from</span> WF <span class="hljs-variable">@0x7ffee7238d20</span>
func_for_cx
  [Destruct] WF <span class="hljs-variable">@0x7ffee7238d20</span>
  [Destruct]  <span class="hljs-variable">@0x7ffee7238d00</span>
<span class="hljs-comment">---3---</span>
  [Construct] WF <span class="hljs-variable">@0x7ffee7238d20</span>
func_for_rx
  [Destruct] WF <span class="hljs-variable">@0x7ffee7238d20</span>
  [Construct] WF <span class="hljs-variable">@0x7ffee7238ce0</span>
<span class="hljs-comment">---4---</span>
  [<span class="hljs-keyword">Copy</span>] <span class="hljs-keyword">from</span> WF <span class="hljs-variable">@0x7ffee7238d20</span>
func_for_x
  [Destruct] WF <span class="hljs-variable">@0x7ffee7238d20</span>
<span class="hljs-comment">---5---</span>
  [<span class="hljs-keyword">Copy</span>] <span class="hljs-keyword">from</span> WF <span class="hljs-variable">@0x7ffee7238d20</span>
func_for_cx
  [Destruct] WF <span class="hljs-variable">@0x7ffee7238d20</span>
<span class="hljs-comment">---6---</span>
func_for_rx
  [Destruct] WF <span class="hljs-variable">@0x7ffee7238ce0</span>
</code></pre>
<p>默认编译：会启动优化</p>
<pre><code class="hljs language-ruby" lang="ruby">xvxing<span class="hljs-variable">@xvxing</span><span class="hljs-symbol">:~/study/algorithm/CF</span><span class="hljs-variable">$ </span>g++ -std=c++<span class="hljs-number">14</span> test.cpp -o c14_default
xvxing<span class="hljs-variable">@xvxing</span><span class="hljs-symbol">:~/study/algorithm/CF</span><span class="hljs-variable">$ </span>./c14_default 
---<span class="hljs-number">1</span>---
  [<span class="hljs-title class_">Construct</span>] <span class="hljs-variable constant_">WF</span> <span class="hljs-variable">@0x7ffdfa1b95e0</span>
func_for_x
  [<span class="hljs-title class_">Destruct</span>] <span class="hljs-variable constant_">WF</span> <span class="hljs-variable">@0x7ffdfa1b95e0</span>
---<span class="hljs-number">2</span>---
  [<span class="hljs-title class_">Construct</span>] <span class="hljs-variable constant_">WF</span> <span class="hljs-variable">@0x7ffdfa1b95e0</span>
func_for_cx
  [<span class="hljs-title class_">Destruct</span>] <span class="hljs-variable constant_">WF</span> <span class="hljs-variable">@0x7ffdfa1b95e0</span>
---<span class="hljs-number">3</span>---
  [<span class="hljs-title class_">Construct</span>] <span class="hljs-variable constant_">WF</span> <span class="hljs-variable">@0x7ffdfa1b95e0</span>
func_for_rx
  [<span class="hljs-title class_">Destruct</span>] <span class="hljs-variable constant_">WF</span> <span class="hljs-variable">@0x7ffdfa1b95e0</span>
  [<span class="hljs-title class_">Construct</span>] <span class="hljs-variable constant_">WF</span> <span class="hljs-variable">@0x7ffdfa1b95c0</span>
---<span class="hljs-number">4</span>---
  [<span class="hljs-title class_">Copy</span>] from <span class="hljs-variable constant_">WF</span> <span class="hljs-variable">@0x7ffdfa1b95e0</span>
func_for_x
  [<span class="hljs-title class_">Destruct</span>] <span class="hljs-variable constant_">WF</span> <span class="hljs-variable">@0x7ffdfa1b95e0</span>
---<span class="hljs-number">5</span>---
  [<span class="hljs-title class_">Copy</span>] from <span class="hljs-variable constant_">WF</span> <span class="hljs-variable">@0x7ffdfa1b95e0</span>
func_for_cx
  [<span class="hljs-title class_">Destruct</span>] <span class="hljs-variable constant_">WF</span> <span class="hljs-variable">@0x7ffdfa1b95e0</span>
---<span class="hljs-number">6</span>---
func_for_rx
  [<span class="hljs-title class_">Destruct</span>] <span class="hljs-variable constant_">WF</span> <span class="hljs-variable">@0x7ffdfa1b95c0</span>
</code></pre>
<hr/>
<p>下面介绍的是核心操作返回值优化，相比较上面的传递形参，会多一个知识点：返回临时对象槽</p>
<hr/>
<h2 data-id="heading-1">1、返回值优化</h2>
<ol>
<li>
<h3 data-id="heading-2">核心总结</h3>
</li>
</ol>

































<table><thead><tr><th>术语</th><th>全称</th><th>含义</th><th>C++17 前状态</th><th>C++17 后状态</th></tr></thead><tbody><tr><td>URVO</td><td>Unnamed RVO</td><td>返回无名临时对象</td><td>编译器优化 (可被禁用)</td><td>语言特性 (强制执行，不可禁用)</td></tr><tr><td>NRVO</td><td>Named RVO</td><td>返回具名局部变量</td><td>编译器优化 (可被禁用)</td><td>编译器优化 (依然可被禁用)</td></tr><tr><td>GCE</td><td>Guaranteed Copy Elision</td><td>强制复制消除</td><td>不存在</td><td>标准强制规定 (针对纯右值)</td></tr></tbody></table>
<ol start="2">
<li>
<h3 data-id="heading-3">知识点</h3>
</li>
</ol>
<h4 data-id="heading-4">1：参数传递中的临时对象</h4>
<ul>
<li>
<p>当你调用 <code>func(BigObj())</code> 时，<code>BigObj()</code> 这个表达式直接在 <code>func</code> 的形参栈内存地址上进行构造。</p>
</li>
<li>
<p>这不涉及“先构造一个临时对象，再 Move 进形参”。</p>
</li>
<li>
<p><strong>例外</strong>：除非该参数是按值传递且 ABI（二进制接口）强制要求通过寄存器传递小对象，否则在逻辑上就是一次直接构造。</p>
</li>
</ul>
<h4 data-id="heading-5">2：返回值的演变</h4>
<ul>
<li>
<p><strong>结论</strong>：<strong>C++17 彻底消灭了 Prvalue（纯右值）返回值的“临时槽”。</strong></p>
</li>
<li>
<p><strong>C++14 及以前</strong>：</p>
<ul>
<li><code>return BigObj();</code> 逻辑上是：<code>构造临时对象</code> -&gt; <code>(可能 Move/Copy)</code>到返回值槽-&gt;析构临时对象 -&gt; <code>(可能 Move/Copy)</code>到接收端变量 -&gt; 析构返回对象槽中的内容。</li>
<li>虽然编译器会进行优化（RVO），但这只是“优化”。如果使用了 <code>-fno-elide-constructors</code>，你会看到拷贝/移动构造函数的调用。</li>
</ul>
</li>
<li>
<p><strong>C++17 及以后</strong>：</p>
<ul>
<li><code>return BigObj();</code> 不再创建临时对象。<code>BigObj()</code> 被视为一个“初始化指令”，直接在接收端的内存地址（Result Slot）上执行构造。</li>
<li><strong>关键点</strong>：这不再是优化，而是语法规则。即使加上 <code>-fno-elide-constructors</code>，也不会产生拷贝或移动。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">3：无名临时对象 (URVO)</h4>
<ul>
<li>
<p><strong>正解</strong>：<code>return BigObj();</code> 是最高效的（C++17 下 0 Copy, 0 Move）。</p>
</li>
<li>
<p><strong>反面教材</strong>：<code>return std::move(BigObj());</code> 或 <code>return std::move(temp);</code></p>
<ul>
<li><strong>原因</strong>：<code>std::move</code> 强制将一个表达式转为 xvalue（将亡值）。</li>
<li><strong>后果</strong>：这破坏了“直接构造”的上下文。编译器被迫认为你要“移动”一个东西，因此它必须先创建一个临时对象，然后调用 <code>Move Constructor</code>。</li>
<li><strong>代价</strong>：多一次移动构造 + 多一次析构。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-7">4：具名对象 (NRVO) 的特殊性</h4>
<ul>
<li>C++17 对于<strong>无名临时对象</strong>，即使手动禁止拷贝擦除，也会强制在实际空间构造</li>
<li>对于 <strong>NRVO</strong> (<code>LoudBot b; return b;</code>)，C++17 <strong>并没有</strong>将其升级为强制标准。可以通过<code>-fno-elide-constructors</code>禁止优化。</li>
</ul>
<ol start="3">
<li>
<h3 data-id="heading-8">场景行为解析 (配合代码)</h3>
</li>
</ol>
<h4 data-id="heading-9">场景 A: <code>return LoudBot("Unnamed");</code> (URVO)</h4>
<ul>
<li><strong>C++14 (默认)</strong> : 1次构造 (优化掉了拷贝)。</li>
<li><strong>C++14 (关优化)</strong> : 1次构造 + 1次 Move + 1次 Destruct (临时对象)。</li>
<li><strong>C++17 (无论开关)</strong> : <strong>1次构造</strong>。 (直接在接收端构造)。</li>
</ul>
<h4 data-id="heading-10">场景 B: <code>LoudBot b; return b;</code> (NRVO)</h4>
<ul>
<li>
<p><strong>C++17 (默认)</strong> : 1次构造 (智能优化)。</p>
</li>
<li>
<p><strong>C++17 (关优化)</strong> : 1次构造 + <strong>1次 Move</strong> + 1次 Destruct (局部变量 b 死掉了)。</p>
<ul>
<li><em>注：此处证明 NRVO 不是强制的。</em></li>
</ul>
</li>
</ul>
<h4 data-id="heading-11">场景 C: <code>LoudBot b; return std::move(b);</code> (反面教材)</h4>
<ul>
<li>
<p><strong>行为</strong>: 1次构造 + <strong>1次 Move</strong> + 1次 Destruct。</p>
</li>
<li>
<p><strong>评价</strong>: 显式 <code>move</code> 此时不仅多余，而且是有害的。因为它阻断了编译器进行 NRVO 的可能性（NRVO 要求返回的是变量本身，而不是变量的引用/转换结果）。</p>
</li>
</ul>
<hr/>
<ol start="4">
<li>
<h3 data-id="heading-12">实战注意</h3>
</li>
</ol>

<ol>
<li>
<p><strong>永远不要对返回值使用</strong> <strong><code>std::move</code></strong>：</p>
<ol>
<li><code>return std::move(local_var);</code> -&gt; <strong>错</strong> (破坏 NRVO)。</li>
<li><code>return local_var;</code> -&gt; <strong>对</strong> (编译器会自动尝试 NRVO，失败则自动隐式 Move)。</li>
</ol>
</li>
<li>
<p><strong>能用无名对象就用无名对象</strong>：</p>
<ol>
<li><code>return LoudBot(args);</code> 比 <code>LoudBot b(args); return b;</code> 更可靠，因为前者在 C++17 下有标准层面的零拷贝保证。</li>
</ol>
</li>
<li>
<p><strong>参数传递</strong>：</p>
<ol>
<li><code>void func(LoudBot b)</code> + <code>func(LoudBot("name"))</code> 是非常高效的 Sink (接收) 模式，C++17 下零开销。</li>
</ol>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入解析MySQL事务与锁：构建高并发数据系统的基石]]></title>    <link>https://juejin.cn/post/7581270148045668392</link>    <guid>https://juejin.cn/post/7581270148045668392</guid>    <pubDate>2025-12-08T08:48:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581270148045668392" data-draft-id="7581073928716566562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入解析MySQL事务与锁：构建高并发数据系统的基石"/> <meta itemprop="keywords" content="面试,后端"/> <meta itemprop="datePublished" content="2025-12-08T08:48:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XUN4J"/> <meta itemprop="url" content="https://juejin.cn/user/4179664935335515"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入解析MySQL事务与锁：构建高并发数据系统的基石
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4179664935335515/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XUN4J
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T08:48:20.000Z" title="Mon Dec 08 2025 08:48:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入解析MySQL事务与锁：构建高并发数据系统的基石</h2>
<h3 data-id="heading-1">引言：为什么事务和锁如此重要？</h3>
<p>在现代高并发系统中，数据库的事务和锁机制是确保数据一致性、可靠性和并发性能的核心。无论是电商秒杀、金融交易还是社交应用，都离不开对这些机制的深入理解和正确使用。本文将从基础概念到实战应用，全面解析MySQL的事务隔离级别、MVCC实现原理和锁机制。</p>
<h3 data-id="heading-2">一、事务的ACID特性：数据库可靠性的基石</h3>
<p>MySQL通过多种技术手段实现事务的ACID特性：</p>



































<table><thead><tr><th>特性</th><th>中文</th><th>实现机制</th><th>作用</th></tr></thead><tbody><tr><td><strong>Atomicity</strong>​</td><td>原子性</td><td>Undo Log（回滚日志）</td><td>保证事务要么全部完成，要么全部回滚</td></tr><tr><td><strong>Consistency</strong>​</td><td>一致性</td><td>原子性、隔离性、持久性共同保证</td><td>确保数据库从一个一致性状态转换到另一个一致性状态</td></tr><tr><td><strong>Isolation</strong>​</td><td>隔离性</td><td>MVCC + 锁机制</td><td>控制并发事务间的相互影响</td></tr><tr><td><strong>Durability</strong>​</td><td>持久性</td><td>Redo Log（重做日志）</td><td>已提交的事务修改永久保存</td></tr></tbody></table>
<p><strong>关键点</strong>：</p>
<ul>
<li>Undo Log用于事务回滚和数据的多版本管理</li>
<li>Redo Log通过WAL（Write-Ahead Logging）机制保证数据持久性</li>
<li>MVCC（多版本并发控制）实现了读写不阻塞的高并发访问</li>
</ul>
<h3 data-id="heading-3">二、并发事务的三大问题</h3>
<p>理解并发问题是选择正确隔离级别的前提：</p>
<h4 data-id="heading-4">1. 脏读（Dirty Read）</h4>
<p><strong>场景</strong>：事务A修改了数据但未提交，事务B读取到了这个未提交的数据，随后事务A回滚。</p>
<p><strong>问题</strong>：事务B读取到了"不存在"的数据。</p>
<h4 data-id="heading-5">2. 不可重复读（Non-repeatable Read）</h4>
<p><strong>场景</strong>：事务A两次读取同一数据，在两次读取之间，事务B修改了该数据并提交。</p>
<p><strong>问题</strong>：同一事务内多次读取同一数据结果不一致。</p>
<h4 data-id="heading-6">3. 幻读（Phantom Read）</h4>
<p><strong>场景</strong>：事务A两次执行相同的范围查询，在两次查询之间，事务B插入或删除了符合查询条件的数据。</p>
<p><strong>问题</strong>：同一事务内多次范围查询的结果集不一致。</p>
<h3 data-id="heading-7">三、事务隔离级别详解</h3>
<p>MySQL提供了四种标准隔离级别，隔离强度递增，但并发性能递减：</p>













































<table><thead><tr><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th><th>实现机制</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>读未提交</strong>​ (RU)</td><td>❌ 可能发生</td><td>❌ 可能发生</td><td>❌ 可能发生</td><td>无MVCC，直接读取最新数据</td><td>对数据一致性要求极低，需要最高并发</td></tr><tr><td><strong>读已提交</strong>​ (RC)</td><td>✅ 避免</td><td>❌ 可能发生</td><td>❌ 可能发生</td><td>每次SELECT创建新Read View</td><td>OLTP系统主流选择，平衡性能与一致性</td></tr><tr><td><strong>可重复读</strong>​ (RR)</td><td>✅ 避免</td><td>✅ 避免</td><td>⚠️ 大部分避免*</td><td>事务开始时创建Read View</td><td>MySQL默认级别，适合大多数场景</td></tr><tr><td><strong>串行化</strong>​ (SERIALIZABLE)</td><td>✅ 避免</td><td>✅ 避免</td><td>✅ 避免</td><td>所有读操作加共享锁</td><td>对数据一致性要求极高的金融交易</td></tr></tbody></table>
<blockquote>
<p>*注：RR级别在特定条件下（当前读）仍可能出现幻读，需要通过Next-Key Lock完全避免。</p>
</blockquote>
<h3 data-id="heading-8">四、MVCC：实现高并发的核心技术</h3>
<h4 data-id="heading-9">MVCC与锁的职责划分</h4>























<table><thead><tr><th>机制</th><th>主要职责</th><th>解决的问题</th><th>特点</th></tr></thead><tbody><tr><td><strong>MVCC</strong>​</td><td>处理读并发</td><td>实现<strong>读不阻塞写，写不阻塞读</strong>​</td><td>通过多版本实现非阻塞的快照读</td></tr><tr><td><strong>锁</strong>​</td><td>处理写并发</td><td>保证<strong>写操作有序进行</strong>​</td><td>防止多个事务同时修改同一数据</td></tr></tbody></table>
<h4 data-id="heading-10">MVCC实现原理</h4>
<p>MVCC通过以下组件协同工作：</p>
<h5 data-id="heading-11">1. 隐藏字段</h5>
<p>每行记录包含两个隐藏字段：</p>
<ul>
<li><code>trx_id</code>：最近修改该记录的事务ID</li>
<li><code>roll_pointer</code>：指向该记录上一个版本的Undo Log指针</li>
</ul>
<h5 data-id="heading-12">2. Read View（读视图）</h5>
<p>Read View决定了事务能看到哪些版本的数据，包含四个关键字段：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ReadView</span> {
    List&lt;<span class="hljs-built_in">Long</span>&gt; m_ids;         <span class="hljs-comment">// 创建时活跃的事务ID列表</span>
    <span class="hljs-built_in">Long</span> min_trx_id;          <span class="hljs-comment">// 活跃事务中的最小ID</span>
    <span class="hljs-built_in">Long</span> max_trx_id;          <span class="hljs-comment">// 下一个将要分配的事务ID</span>
    <span class="hljs-built_in">Long</span> creator_trx_id;      <span class="hljs-comment">// 创建该Read View的事务ID</span>
}
</code></pre>
<h5 data-id="heading-13">3. 可见性判断规则</h5>
<p>判断记录版本对当前事务是否可见：</p>
<ol>
<li>
<p>如果<code>trx_id &lt; min_trx_id</code>：该版本在Read View创建前已提交，<strong>可见</strong></p>
</li>
<li>
<p>如果<code>trx_id &gt;= max_trx_id</code>：该版本在Read View创建后才开始，<strong>不可见</strong></p>
</li>
<li>
<p>如果<code>min_trx_id ≤ trx_id &lt; max_trx_id</code>：</p>
<ul>
<li>如果<code>trx_id</code>在<code>m_ids</code>中：事务仍在活跃，<strong>不可见</strong></li>
<li>否则：事务已提交，<strong>可见</strong></li>
</ul>
</li>
</ol>
<h4 data-id="heading-14">各隔离级别的实现差异</h4>
<ol>
<li><strong>RU</strong>：直接读取最新数据，不创建Read View</li>
<li><strong>RC</strong>：每次SELECT创建新的Read View</li>
<li><strong>RR</strong>：事务开始时创建Read View，整个事务复用</li>
<li><strong>SERIALIZABLE</strong>：读操作也加共享锁，不使用MVCC</li>
</ol>
<h3 data-id="heading-15">五、RC与RR的锁行为对比</h3>
<h4 data-id="heading-16">示例分析</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 表结构：users(id INT PRIMARY KEY, status INT)</span>
<span class="hljs-comment">-- 现有数据：id=1,3,5</span>

<span class="hljs-comment">-- 事务A执行</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">2</span>;
</code></pre>
<h5 data-id="heading-17">RC级别的锁行为：</h5>
<ul>
<li>对<code>id=3</code>和<code>id=5</code>加<strong>记录锁</strong></li>
<li><strong>不会</strong>对间隙加锁</li>
<li>其他事务可以插入<code>id=2</code>、<code>id=4</code>等数据</li>
</ul>
<h5 data-id="heading-18">RR级别的锁行为：</h5>
<ul>
<li>对<code>id=3</code>和<code>id=5</code>加<strong>记录锁</strong></li>
<li>对间隙<code>(1,3)</code>、<code>(3,5)</code>、<code>(5, +∞)</code>加<strong>间隙锁</strong></li>
<li>防止其他事务插入<code>id&gt;2</code>的新数据</li>
</ul>
<h4 data-id="heading-19">RC vs RR 选择建议</h4>



































<table><thead><tr><th>考量维度</th><th>读已提交 (RC)</th><th>可重复读 (RR)</th></tr></thead><tbody><tr><td><strong>并发性能</strong>​</td><td>更高（锁冲突少）</td><td>较低（锁范围大）</td></tr><tr><td><strong>幻读风险</strong>​</td><td>存在</td><td>基本避免</td></tr><tr><td><strong>死锁概率</strong>​</td><td>较低</td><td>较高</td></tr><tr><td><strong>binlog格式</strong>​</td><td>必须为ROW</td><td>支持STATEMENT</td></tr><tr><td><strong>适用场景</strong>​</td><td>高并发OLTP，可接受幻读</td><td>需要强一致性，如报表、统计</td></tr></tbody></table>
<blockquote>
<p>很多互联网公司选择RC级别，通过应用层逻辑处理幻读，换取更高的并发性能。</p>
</blockquote>
<h3 data-id="heading-20">六、锁机制深度解析</h3>
<h4 data-id="heading-21">1. 全局锁</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 全库只读，用于备份</span>
FLUSH TABLES <span class="hljs-keyword">WITH</span> READ LOCK;
<span class="hljs-comment">-- 备份完成后释放</span>
UNLOCK TABLES;
</code></pre>
<h4 data-id="heading-22">2. 表级锁</h4>
<ul>
<li><strong>表锁</strong>：<code>LOCK TABLES table_name READ/WRITE</code></li>
<li><strong>元数据锁（MDL）</strong> ：自动管理，CRUD加读锁，DDL加写锁</li>
<li><strong>意向锁</strong>：行锁的表级标记，提高锁冲突检测效率</li>
</ul>
<h4 data-id="heading-23">3. 行级锁（InnoDB核心）</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9aee5a40f674daa99189c75faf5e68a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWFVONEo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788500&amp;x-signature=wh9J6sAA17CIRXmvHFOoSCFpCOY%3D" alt="image.png" loading="lazy"/></p>



































<table><thead><tr><th>锁类型</th><th>描述</th><th>兼容性</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>记录锁</strong>​</td><td>锁定单行记录</td><td>共享锁之间兼容，排他锁互斥</td><td>精确匹配的等值查询</td></tr><tr><td><strong>间隙锁</strong>​</td><td>锁定索引记录间的间隙</td><td>间隙锁之间兼容</td><td>RR级别防止幻读</td></tr><tr><td><strong>临键锁</strong>​</td><td>记录锁+间隙锁</td><td>与插入意向锁冲突</td><td>RR级别的范围查询</td></tr><tr><td><strong>插入意向锁</strong>​</td><td>插入操作前的间隙锁</td><td>特殊的间隙锁</td><td>INSERT操作时添加</td></tr></tbody></table>
<h3 data-id="heading-24">七、实战场景与死锁处理</h3>
<h4 data-id="heading-25">常见锁场景分析</h4>
<h5 data-id="heading-26">场景1：索引对锁的影响</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- id无索引的情况</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">20</span>;
<span class="hljs-comment">-- 会锁全表（RR级别下为临键锁）</span>

<span class="hljs-comment">-- id有索引的情况  </span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;
<span class="hljs-comment">-- 只锁定id=8的记录</span>
</code></pre>
<p><strong>核心原理</strong>：无索引的WHERE条件会导致全表扫描，进而锁定所有记录。</p>
<h5 data-id="heading-27">场景2：死锁产生与避免</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e50ac2cbbd29427f83a92851d289ebc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWFVONEo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765788500&amp;x-signature=ax9FrS2daqFTmo3T5D8OgwjznHE%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 事务A</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;  <span class="hljs-comment">-- 加临键锁</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id, name) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">12</span>, <span class="hljs-string">'Alice'</span>);

<span class="hljs-comment">-- 事务B</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;  <span class="hljs-comment">-- 等待事务A</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (id, name) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">11</span>, <span class="hljs-string">'Bob'</span>);  <span class="hljs-comment">-- 死锁！</span>
</code></pre>
<p><strong>死锁解决策略</strong>：</p>
<ol>
<li>
<p><strong>设置锁等待超时</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">SET <span class="hljs-attr">innodb_lock_wait_timeout</span> = <span class="hljs-number">50</span><span class="hljs-comment">;  -- 50秒超时</span>
</code></pre>
</li>
<li>
<p><strong>开启死锁检测</strong>（默认开启）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'innodb_deadlock_detect'</span>;  <span class="hljs-comment">-- 查看状态</span>
</code></pre>
</li>
<li>
<p><strong>应用层优化</strong>：</p>
<ul>
<li>保持事务短小</li>
<li>按固定顺序访问资源</li>
<li>使用较低的隔离级别</li>
</ul>
</li>
</ol>
<h4 data-id="heading-28">字节面试题解析</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 事务A</span>
<span class="hljs-keyword">UPDATE</span> t <span class="hljs-keyword">SET</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'A'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">UPDATE</span> t <span class="hljs-keyword">SET</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'B'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

<span class="hljs-comment">-- 事务B  </span>
<span class="hljs-keyword">UPDATE</span> t <span class="hljs-keyword">SET</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'B'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
<span class="hljs-keyword">UPDATE</span> t <span class="hljs-keyword">SET</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'A'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>分析</strong>：两个事务以相反顺序获取锁，形成循环等待，导致死锁。</p>
<h3 data-id="heading-29">八、最佳实践与调优建议</h3>
<h4 data-id="heading-30">1. 事务设计原则</h4>
<ul>
<li><strong>短事务优先</strong>：尽快提交，减少锁持有时间</li>
<li><strong>更新后置</strong>：将UPDATE/DELETE语句放在事务末尾</li>
<li><strong>避免长查询</strong>：大查询使用分页或游标</li>
</ul>
<h4 data-id="heading-31">2. 索引优化</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 为WHERE条件、JOIN条件、ORDER BY字段建立合适索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_age_name <span class="hljs-keyword">ON</span> users(age, name);

<span class="hljs-comment">-- 避免索引失效场景</span>
<span class="hljs-comment">-- ❌ 函数操作</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">YEAR</span>(create_time) <span class="hljs-operator">=</span> <span class="hljs-number">2024</span>;
<span class="hljs-comment">-- ✅ 范围查询</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> create_time <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2024-01-01'</span> <span class="hljs-keyword">AND</span> create_time <span class="hljs-operator">&lt;</span> <span class="hljs-string">'2025-01-01'</span>;
</code></pre>
<h4 data-id="heading-32">3. 隔离级别选择</h4>
<ul>
<li><strong>默认使用RR</strong>：大部分场景适用</li>
<li><strong>高并发写场景考虑RC</strong>：减少锁冲突</li>
<li><strong>财务系统使用SERIALIZABLE</strong>：最高一致性要求</li>
</ul>
<h4 data-id="heading-33">4. 监控与诊断</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看当前锁信息</span>
<span class="hljs-keyword">SHOW</span> ENGINE INNODB STATUS\G

<span class="hljs-comment">-- 监控锁等待</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.INNODB_LOCKS;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.INNODB_LOCK_WAITS;

<span class="hljs-comment">-- 查看长事务</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.INNODB_TRX
<span class="hljs-keyword">WHERE</span> TIME_TO_SEC(TIMEDIFF(NOW(), trx_started)) <span class="hljs-operator">&gt;</span> <span class="hljs-number">60</span>;
</code></pre>
<h3 data-id="heading-34">九、总结</h3>
<p>MySQL的事务和锁机制是一个精心设计的平衡系统，在数据一致性、隔离性和并发性能之间寻找最佳平衡点。理解这些机制需要掌握：</p>
<ol>
<li><strong>MVCC实现非阻塞读</strong>：通过Undo Log链和Read View实现</li>
<li><strong>锁保证写有序</strong>：通过行锁、间隙锁、临键锁协同工作</li>
<li><strong>隔离级别的权衡</strong>：根据业务需求在一致性和性能间选择</li>
<li><strong>死锁的预防与处理</strong>：通过超时、检测和应用层设计避免</li>
</ol>
<p>实际应用中，建议：</p>
<ul>
<li>从默认的RR级别开始，遇到性能瓶颈再考虑调整</li>
<li>为所有查询条件添加合适索引</li>
<li>监控长事务和锁等待，及时发现瓶颈</li>
<li>在应用层考虑并发控制，不完全依赖数据库</li>
</ul>
<p>事务和锁的深入理解是成为MySQL专家的必经之路，只有掌握了这些底层原理，才能设计出既高效又可靠的数据系统。</p>
<hr/>
<p><em>扩展阅读推荐：</em></p>
<ol>
<li><em>《高性能MySQL》第6章：查询性能优化</em></li>
<li><em>《MySQL技术内幕：InnoDB存储引擎》第6章：锁</em></li>
<li><em>官方文档：InnoDB Locking and Transaction Model</em></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次搞懂 iOS 组合布局：用 CompositionalLayout 打造马赛克 + 网格瀑布流]]></title>    <link>https://juejin.cn/post/7581099904324354074</link>    <guid>https://juejin.cn/post/7581099904324354074</guid>    <pubDate>2025-12-08T06:27:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581099904324354074" data-draft-id="7580745065171566643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次搞懂 iOS 组合布局：用 CompositionalLayout 打造马赛克 + 网格瀑布流"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-08T06:27:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarkCoder"/> <meta itemprop="url" content="https://juejin.cn/user/207173399875662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次搞懂 iOS 组合布局：用 CompositionalLayout 打造马赛克 + 网格瀑布流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/207173399875662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarkCoder
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:27:30.000Z" title="Mon Dec 08 2025 06:27:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一次搞懂 iOS 组合布局：用 CompositionalLayout 打造马赛克 + 网格瀑布流</h2>
<hr/>
<p>最近在项目中遇到一个很有趣的需求：<br/>
<strong>要实现一个“左边大图 + 右边 2×2 小图”的马赛克布局，下面再接一个三列网格瀑布流。</strong></p>
<p>乍一看，有点像短视频 App 的推荐页或者流媒体内容流。</p>
<p>以往这种复杂布局，我们可能会：</p>
<ul>
<li>写自定义 FlowLayout</li>
<li>手动算每个 cell 的 frame</li>
<li>各种 if else 填满屏幕</li>
<li>容易出错且维护难度大</li>
</ul>
<p>但今天我才发现 —— <strong>用 <code>UICollectionViewCompositionalLayout</code> 能把这种布局写得既优雅又清晰！</strong></p>
<hr/>
<h3 data-id="heading-1">🎯 需求拆解</h3>
<p>视觉结构如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f89decffe29f49e1811f1e44af253b73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RhcmtDb2Rlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765781236&amp;x-signature=DLBRsNt9FzlIE9q%2ByQOXVoFZwVc%3D" alt="IMG_0589.jpg" loading="lazy"/></p>
<p>总结：</p>
<ul>
<li>
<p><strong>Section 0：前 5 个元素</strong></p>
<ul>
<li>左侧：1 个大图（宽度 50%，高度与右侧一致）</li>
<li>右侧：4 个小图（2 × 2）</li>
</ul>
</li>
<li>
<p><strong>Section 1：剩余元素进入 3 列网格布局</strong></p>
</li>
</ul>
<p>适用场景：</p>
<ul>
<li>首页推荐流</li>
<li>杂志式内容展示</li>
<li>多风格 Feed 流</li>
<li>Banner + 内容区结合布局</li>
</ul>
<hr/>
<h3 data-id="heading-2">🧠 为什么用 UICollectionViewCompositionalLayout？</h3>
<p>Apple 官方定位：<br/>
<strong>Compositional Layout = 用组合方式表达复杂布局的声明式系统</strong></p>
<p>优势：</p>
<ol>
<li><strong>完全声明式</strong>：不用操心 layoutAttributes</li>
<li><strong>多 Section 自由组合</strong>：每个 section 可以完全不同</li>
<li><strong>适合不规则布局</strong>：左右不对称、嵌套 group、水平 + 垂直混合滚动</li>
</ol>
<blockquote>
<p>对于我们的“马赛克区 + 网格区”需求，简直天生适合。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">📐 核心知识点（深入版）</h3>
<h4 data-id="heading-4">1️⃣ Item（最基本元素）</h4>
<p>Item 就是 <strong>UICollectionView 中的 cell 对应的布局单元</strong>。<br/>
它不仅控制单个 cell 的尺寸，还能设置间距、对齐方式。</p>
<p><strong>关键属性</strong>：</p>
<ul>
<li>
<p><code>widthDimension</code> / <code>heightDimension</code></p>
<ul>
<li><code>.fractionalWidth(0.5)</code>：相对于父 Group 宽度的一半</li>
<li><code>.fractionalHeight(1.0)</code>：填满父 Group 高度</li>
<li><code>.absolute(100)</code>：固定尺寸</li>
<li><code>.estimated(150)</code>：动态高度，适合自适应内容</li>
</ul>
</li>
<li>
<p><code>contentInsets</code></p>
<ul>
<li>控制 cell 与 cell 之间的间距</li>
<li>例如：<code>NSDirectionalEdgeInsets(top: 4, leading: 4, bottom: 4, trailing: 4)</code></li>
<li>避免手动计算 frame，也能保证布局美观</li>
</ul>
</li>
</ul>
<blockquote>
<p>💡 Tip：在嵌套 Group 中，Item 的 fractional 高度是相对于 <strong>直接父 Group 的高度</strong>。</p>
</blockquote>
<hr/>
<h4 data-id="heading-5">2️⃣ Group（组合 Item 的容器）</h4>
<p>Group 是 <strong>把若干 Item 或 Group 组合起来的容器</strong>，可以是水平（horizontal）或垂直（vertical）。<br/>
理解 Group 是理解 CompositionalLayout 的关键。</p>
<p><strong>核心概念</strong>：</p>
<ol>
<li>
<p><strong>水平 Group</strong></p>
<ul>
<li>
<p>将多个 Item 横向排列</p>
</li>
<li>
<p>例如右侧 2 个小格子在同一行：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">NSCollectionLayoutGroup</span><span class="hljs-selector-class">.horizontal</span>(<span class="hljs-attribute">layoutSize</span>: rowSize, <span class="hljs-attribute">subitem</span>: smallItem, <span class="hljs-attribute">count</span>: <span class="hljs-number">2</span>)
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>垂直 Group</strong></p>
<ul>
<li>
<p>将多个 Item 或水平 Group 纵向叠加</p>
</li>
<li>
<p>例如右侧 2x2 小图：</p>
<ul>
<li>先把一行两个小图组合成水平 group</li>
<li>再把上下两行叠加成垂直 group</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>嵌套 Group</strong></p>
<ul>
<li>左右布局：把左侧大图和右侧小图列组合成一个水平 Group</li>
<li>核心思路：<strong>从最小的元素开始组合，逐层嵌套，最终形成完整 Section</strong></li>
</ul>
</li>
</ol>
<blockquote>
<p>💡 Tip：Group 的尺寸也是 fractional，相对父 Group 或 Section，保证屏幕适配。</p>
</blockquote>
<hr/>
<h4 data-id="heading-6">3️⃣ Section（整个区域）</h4>
<p>Section 是 <strong>最终展示区域</strong>，包含一个或多个 Group。</p>
<p><strong>Section 的作用</strong>：</p>
<ul>
<li>
<p>定义整个布局区域的 <strong>边距、间距</strong></p>
<ul>
<li><code>section.contentInsets</code> 控制整个区域与 CollectionView 边界的距离</li>
</ul>
</li>
<li>
<p>可以为 Section 添加 Header / Footer</p>
</li>
<li>
<p>Section 可以自由组合，形成多风格布局</p>
</li>
</ul>
<blockquote>
<p>直观理解：</p>
<ul>
<li>Item = 一张卡片</li>
<li>Group = 小版面 / 组合卡片</li>
<li>Section = 整个版块</li>
</ul>
</blockquote>
<hr/>
<h4 data-id="heading-7">4️⃣ 布局比例理解技巧</h4>
<ol>
<li>
<p><strong>用 fractionalWidth/fractionalHeight 控制比例</strong></p>
<ul>
<li>宽高比例可以随屏幕自适应</li>
<li>保证布局在 iPhone / iPad 上一致</li>
</ul>
</li>
<li>
<p><strong>嵌套顺序</strong></p>
<ul>
<li>先从最小的 Item 开始设置尺寸</li>
<li>再组合成水平 / 垂直 Group</li>
<li>最后组合成 Section</li>
<li>这样思路清晰，容易调整</li>
</ul>
</li>
<li>
<p><strong>间距管理</strong></p>
<ul>
<li>Item.contentInsets 控制 cell 内间距</li>
<li>Section.contentInsets 控制整体区域边距</li>
<li>避免在 Group 中重复设置过多间距</li>
</ul>
</li>
</ol>
<hr/>
<h4 data-id="heading-8">5️⃣ 总结思路</h4>
<blockquote>
<p>如果用一句话概括 CompositionalLayout 的核心逻辑：</p>
<p><strong>“先定义每个 Item，再组合成 Group，最后把 Group 放进 Section，层层嵌套，形成最终布局。”</strong></p>
</blockquote>
<p>这个思路放到我们的示例里就是：</p>
<ol>
<li>左侧大图 → 一个 Item</li>
<li>右侧小图 → 小 Item → 水平 Row Group → 垂直 Column Group</li>
<li>主组 = 左大图 + 右侧 Column Group</li>
<li>Section 0 = 主组 + contentInsets</li>
<li>Section 1 = 三列网格</li>
</ol>
<hr/>
<h3 data-id="heading-9">🛠 实战：完整 <code>createCompositionalLayout()</code> 方法</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">func</span> <span class="hljs-selector-tag">createCompositionalLayout</span>() <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">UICollectionViewLayout</span> {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">UICollectionViewCompositionalLayout</span> { <span class="hljs-selector-attr">[weak self]</span> (sectionIndex, env) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">NSCollectionLayoutSection</span>? <span class="hljs-selector-tag">in</span>
        <span class="hljs-selector-tag">guard</span> <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">self</span> = <span class="hljs-selector-tag">self</span> <span class="hljs-selector-tag">else</span> { <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">nil</span> }
        
        <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">spacing</span>: <span class="hljs-selector-tag">CGFloat</span> = <span class="hljs-number">4.0</span>
        
        <span class="hljs-comment">// Section 0：马赛克区 (左大右 2x2)</span>
        <span class="hljs-selector-tag">if</span> <span class="hljs-selector-tag">sectionIndex</span> == <span class="hljs-number">0</span> {
            
            <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">leftLargeItemSize</span> = <span class="hljs-selector-tag">NSCollectionLayoutSize</span>(
                <span class="hljs-attribute">widthDimension</span>: .<span class="hljs-built_in">fractionalWidth</span>(<span class="hljs-number">0.5</span>),
                <span class="hljs-attribute">heightDimension</span>: .<span class="hljs-built_in">fractionalHeight</span>(<span class="hljs-number">1.0</span>)
            )
            <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">leftLargeItem</span> = <span class="hljs-selector-tag">NSCollectionLayoutItem</span>(<span class="hljs-attribute">layoutSize</span>: leftLargeItemSize)
            <span class="hljs-selector-tag">leftLargeItem</span><span class="hljs-selector-class">.contentInsets</span> = <span class="hljs-selector-class">.init</span>(<span class="hljs-attribute">top</span>: spacing, <span class="hljs-attribute">leading</span>: spacing, <span class="hljs-attribute">bottom</span>: spacing, <span class="hljs-attribute">trailing</span>: spacing)
            
            <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">smallItemSize</span> = <span class="hljs-selector-tag">NSCollectionLayoutSize</span>(
                <span class="hljs-attribute">widthDimension</span>: .<span class="hljs-built_in">fractionalWidth</span>(<span class="hljs-number">0.5</span>),
                <span class="hljs-attribute">heightDimension</span>: .<span class="hljs-built_in">fractionalHeight</span>(<span class="hljs-number">1.0</span>)
            )
            <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">smallItem</span> = <span class="hljs-selector-tag">NSCollectionLayoutItem</span>(<span class="hljs-attribute">layoutSize</span>: smallItemSize)
            <span class="hljs-selector-tag">smallItem</span><span class="hljs-selector-class">.contentInsets</span> = <span class="hljs-selector-class">.init</span>(<span class="hljs-attribute">top</span>: spacing, <span class="hljs-attribute">leading</span>: spacing, <span class="hljs-attribute">bottom</span>: spacing, <span class="hljs-attribute">trailing</span>: spacing)
            
            <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">rightRowGroup</span> = <span class="hljs-selector-tag">NSCollectionLayoutGroup</span><span class="hljs-selector-class">.horizontal</span>(
                <span class="hljs-attribute">layoutSize</span>: <span class="hljs-built_in">NSCollectionLayoutSize</span>(
                    <span class="hljs-attribute">widthDimension</span>: .<span class="hljs-built_in">fractionalWidth</span>(<span class="hljs-number">1.0</span>),
                    <span class="hljs-attribute">heightDimension</span>: .<span class="hljs-built_in">fractionalHeight</span>(<span class="hljs-number">0.5</span>)
                ),
                <span class="hljs-attribute">subitem</span>: smallItem,
                <span class="hljs-attribute">count</span>: <span class="hljs-number">2</span>
            )
            
            <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">rightColumnGroup</span> = <span class="hljs-selector-tag">NSCollectionLayoutGroup</span><span class="hljs-selector-class">.vertical</span>(
                <span class="hljs-attribute">layoutSize</span>: <span class="hljs-built_in">NSCollectionLayoutSize</span>(
                    <span class="hljs-attribute">widthDimension</span>: .<span class="hljs-built_in">fractionalWidth</span>(<span class="hljs-number">0.5</span>),
                    <span class="hljs-attribute">heightDimension</span>: .<span class="hljs-built_in">fractionalHeight</span>(<span class="hljs-number">1.0</span>)
                ),
                <span class="hljs-attribute">subitem</span>: rightRowGroup,
                <span class="hljs-attribute">count</span>: <span class="hljs-number">2</span>
            )
            
            <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">mainGroup</span> = <span class="hljs-selector-tag">NSCollectionLayoutGroup</span><span class="hljs-selector-class">.horizontal</span>(
                <span class="hljs-attribute">layoutSize</span>: <span class="hljs-built_in">NSCollectionLayoutSize</span>(
                    <span class="hljs-attribute">widthDimension</span>: .<span class="hljs-built_in">fractionalWidth</span>(<span class="hljs-number">1.0</span>),
                    <span class="hljs-attribute">heightDimension</span>: .<span class="hljs-built_in">fractionalWidth</span>(<span class="hljs-number">0.5</span>)
                ),
                <span class="hljs-attribute">subitems</span>: [leftLargeItem, rightColumnGroup]
            )
            
            <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">section</span> = <span class="hljs-selector-tag">NSCollectionLayoutSection</span>(<span class="hljs-attribute">group</span>: mainGroup)
            <span class="hljs-selector-tag">section</span><span class="hljs-selector-class">.contentInsets</span> = <span class="hljs-selector-class">.init</span>(<span class="hljs-attribute">top</span>: spacing, <span class="hljs-attribute">leading</span>: spacing, <span class="hljs-attribute">bottom</span>: spacing, <span class="hljs-attribute">trailing</span>: spacing)
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">section</span>
        }
        
        <span class="hljs-comment">// Section 1：下方三列网格</span>
        <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">itemSize</span> = <span class="hljs-selector-tag">NSCollectionLayoutSize</span>(
                <span class="hljs-attribute">widthDimension</span>: .<span class="hljs-built_in">fractionalWidth</span>(<span class="hljs-number">1.0</span>/<span class="hljs-number">3.0</span>),
                <span class="hljs-attribute">heightDimension</span>: .<span class="hljs-built_in">fractionalHeight</span>(<span class="hljs-number">1.0</span>)
            )
            <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">item</span> = <span class="hljs-selector-tag">NSCollectionLayoutItem</span>(<span class="hljs-attribute">layoutSize</span>: itemSize)
            <span class="hljs-selector-tag">item</span><span class="hljs-selector-class">.contentInsets</span> = <span class="hljs-selector-class">.init</span>(<span class="hljs-attribute">top</span>: spacing, <span class="hljs-attribute">leading</span>: spacing, <span class="hljs-attribute">bottom</span>: spacing, <span class="hljs-attribute">trailing</span>: spacing)
            
            <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">groupSize</span> = <span class="hljs-selector-tag">NSCollectionLayoutSize</span>(
                <span class="hljs-attribute">widthDimension</span>: .<span class="hljs-built_in">fractionalWidth</span>(<span class="hljs-number">1.0</span>),
                <span class="hljs-attribute">heightDimension</span>: .<span class="hljs-built_in">fractionalWidth</span>(<span class="hljs-number">1.0</span>/<span class="hljs-number">3.0</span>)
            )
            <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">group</span> = <span class="hljs-selector-tag">NSCollectionLayoutGroup</span><span class="hljs-selector-class">.horizontal</span>(
                <span class="hljs-attribute">layoutSize</span>: groupSize,
                <span class="hljs-attribute">subitem</span>: item,
                <span class="hljs-attribute">count</span>: <span class="hljs-number">3</span>
            )
            
            <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">section</span> = <span class="hljs-selector-tag">NSCollectionLayoutSection</span>(<span class="hljs-attribute">group</span>: group)
            <span class="hljs-selector-tag">section</span><span class="hljs-selector-class">.contentInsets</span> = <span class="hljs-selector-class">.init</span>(<span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>, <span class="hljs-attribute">leading</span>: spacing, <span class="hljs-attribute">bottom</span>: spacing, <span class="hljs-attribute">trailing</span>: spacing)
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">section</span>
        }
    }
}
</code></pre>
<blockquote>
<p>✅ 完整实现了“左大右 2×2 + 下方三列网格”，保持比例、间距和嵌套逻辑。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">🔄 数据分区逻辑</h3>
<p>前 5 个元素给 Section 0，剩下的给 Section 1。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">numberOfSections</span>(<span class="hljs-params">in</span> <span class="hljs-params">collectionView</span>: <span class="hljs-type">UICollectionView</span>) -&gt; <span class="hljs-type">Int</span> {
    <span class="hljs-keyword">return</span> items.isEmpty <span class="hljs-operator">?</span> <span class="hljs-number">0</span> : <span class="hljs-number">2</span>
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">collectionView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">collectionView</span>: <span class="hljs-type">UICollectionView</span>, <span class="hljs-params">numberOfItemsInSection</span> <span class="hljs-params">section</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span> {
    <span class="hljs-keyword">return</span> section <span class="hljs-operator">==</span> <span class="hljs-number">0</span> <span class="hljs-operator">?</span> <span class="hljs-built_in">min</span>(<span class="hljs-number">5</span>, items.count) : <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, items.count <span class="hljs-operator">-</span> <span class="hljs-number">5</span>)
}
</code></pre>
<blockquote>
<p>数据分区 + CompositionalLayout，就能轻松实现复杂瀑布流效果。</p>
</blockquote>
<hr/>
<h3 data-id="heading-11">✅ 总结</h3>
<h4 data-id="heading-12">适用场景：</h4>
<ul>
<li>杂志排版</li>
<li>视频 / 图片内容流</li>
<li>商品推荐页</li>
<li>Banner + 宫格混合布局</li>
</ul>
<h4 data-id="heading-13">优势：</h4>
<ul>
<li>结构清晰</li>
<li>易维护</li>
<li>代码优雅</li>
<li>UIKit 下的现代布局方式</li>
</ul>
<blockquote>
<p>如果你还在用 FlowLayout 手动计算 frame，真的要试试 CompositionalLayout！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin Coroutine 底层实现原理]]></title>    <link>https://juejin.cn/post/7581106788205887515</link>    <guid>https://juejin.cn/post/7581106788205887515</guid>    <pubDate>2025-12-08T07:42:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581106788205887515" data-draft-id="7580971667038093338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin Coroutine 底层实现原理"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-08T07:42:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="董三毛"/> <meta itemprop="url" content="https://juejin.cn/user/4248168658379975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin Coroutine 底层实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248168658379975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    董三毛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T07:42:56.000Z" title="Mon Dec 08 2025 07:42:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>简单来说，本质是每一个函数都是一个状态机。
更严谨一点的说法是：<strong>Kotlin 编译器会将每一个 <code>suspend</code> 函数（挂起函数）编译成一个状态机（Finite State Machine），通过 <code>label</code> 字段记录执行位置，通过字段保存局部变量，从而实现“挂起”和“恢复”的逻辑。</strong></p>
<p>为了让你理解得更透彻，我把这个底层实现拆解为三个核心步骤来解释：</p>
<h3 data-id="heading-0">1. 核心理论：CPS（续体传递风格）</h3>
<p>在编译阶段，Kotlin 编译器会对 <code>suspend</code> 函数的签名（Signature）进行修改。这被称为 <strong>Continuation-Passing Style (CPS)</strong> 变换。</p>
<p><strong>源代码：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUser</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: User { ... }
</code></pre>
<p><strong>编译后的代码（伪代码）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 返回值变成了 Object（可能是真正的结果，也可能是挂起标志）</span>
<span class="hljs-comment">// 参数列表末尾多了一个 Continuation 参数</span>
Object <span class="hljs-title function_">getUser</span><span class="hljs-params">(String userId, Continuation&lt;User&gt; cont)</span> { ... }
</code></pre>
<p>这个 <code>Continuation</code> 就是所谓的“续体”，你可以把它理解为一个回调接口，它主要包含两个方法：<code>resumeWith</code>（恢复执行）和 <code>context</code>（上下文）。</p>
<h3 data-id="heading-1">2. 核心实现：状态机（State Machine）</h3>
<p>这是你提到的“控制状态”的部分。编译器不仅改了签名，还把函数体内部的代码进行重组，生成了一个匿名内部类（或者复用现有的类），这个类就是一个状态机。</p>
<p>假设我们有这样一个挂起函数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logic</span><span class="hljs-params">()</span></span> {
    print(<span class="hljs-string">"Start"</span>)
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = networkRequest() <span class="hljs-comment">// 挂起点 1</span>
    print(<span class="hljs-keyword">data</span>)
    <span class="hljs-keyword">val</span> processed = process(<span class="hljs-keyword">data</span>) <span class="hljs-comment">// 挂起点 2</span>
    print(processed)
}
</code></pre>
<p>编译器会把它改写成类似下面这样的 Java 伪代码（简化逻辑以便理解）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 这个类就是生成的“状态机”</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LogicStateMachine</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ContinuationImpl</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">label</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 状态指针（当前执行到哪一步了）</span>
    Object result; <span class="hljs-comment">// 上一步挂起函数的返回结果</span>
    Object data;   <span class="hljs-comment">// 用来保存局部变量 'data'，防止挂起后丢失</span>

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invokeSuspend</span><span class="hljs-params">(Object result)</span> {
        <span class="hljs-built_in">this</span>.result = result;
        
        <span class="hljs-keyword">switch</span> (<span class="hljs-built_in">this</span>.label) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: <span class="hljs-comment">// 初始状态</span>
                print(<span class="hljs-string">"Start"</span>);
                <span class="hljs-built_in">this</span>.label = <span class="hljs-number">1</span>; <span class="hljs-comment">// 准备进入下一个状态</span>
                <span class="hljs-comment">// 调用挂起函数，把“自己”（this）传进去作为回调</span>
                <span class="hljs-comment">// 如果 networkRequest 返回 COROUTINE_SUSPENDED，说明真的挂起了，</span>
                <span class="hljs-comment">// 此时直接 return，当前线程被释放！</span>
                <span class="hljs-keyword">if</span> (networkRequest(<span class="hljs-built_in">this</span>) == COROUTINE_SUSPENDED) <span class="hljs-keyword">return</span> COROUTINE_SUSPENDED;
                <span class="hljs-comment">// 如果没有挂起（比如直接返回了缓存），由于没 return，会自然流转到 case 1</span>
                
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-comment">// 从挂起点 1 恢复</span>
                <span class="hljs-comment">// 这里 result 就是 networkRequest 的返回值</span>
                <span class="hljs-built_in">this</span>.data = result; <span class="hljs-comment">// 将结果保存到成员变量，相当于恢复了局部变量</span>
                print(<span class="hljs-built_in">this</span>.data);
                
                <span class="hljs-built_in">this</span>.label = <span class="hljs-number">2</span>; <span class="hljs-comment">// 准备进入下一个状态</span>
                <span class="hljs-keyword">if</span> (process(<span class="hljs-built_in">this</span>.data, <span class="hljs-built_in">this</span>) == COROUTINE_SUSPENDED) <span class="hljs-keyword">return</span> COROUTINE_SUSPENDED;
                
            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-comment">// 从挂起点 2 恢复</span>
                <span class="hljs-built_in">this</span>.processed = result;
                print(<span class="hljs-built_in">this</span>.processed);
                <span class="hljs-keyword">return</span> Unit.INSTANCE; <span class="hljs-comment">// 函数执行结束</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-2">3. 如何“控制状态”和“执行下一个”？</h3>
<p>通过上面的伪代码，我们可以验证你的理解：</p>
<ol>
<li>
<p><strong>每一个函数都是状态机？</strong></p>
<ul>
<li>准确说是：每一个 <strong><code>suspend</code> 函数</strong>在编译后都会生成一个对应的状态机类（继承自 <code>ContinuationImpl</code>）。普通函数不会。</li>
</ul>
</li>
<li>
<p><strong>执行的时候都会控制状态？</strong></p>
<ul>
<li>是的，通过 <code>label</code> 字段。每次遇到挂起点（suspend point），<code>label</code> 就会加 1。</li>
<li><strong>关键点：</strong> 局部变量（Local Variables）会从“栈（Stack）”挪到“堆（Heap）”上。
<ul>
<li>在普通函数中，变量 <code>val data</code> 存在于栈帧里，函数结束或挂起（线程切换）如果栈销毁了，变量就没了。</li>
<li>在协程中，为了能在挂起恢复后还能找到 <code>data</code>，编译器把它变成了 <code>LogicStateMachine</code> 类的一个<strong>成员字段</strong>（Field）。只要这个对象还在堆内存里，变量就不会丢。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>以及执行下一个？</strong></p>
<ul>
<li>是的。当异步操作（比如网络请求）完成时，会调用 <code>continuation.resume(result)</code>。</li>
<li>这个 <code>resume</code> 方法内部实际上会再次调用 <code>invokeSuspend</code> 方法。</li>
<li>由于此时 <code>label</code> 已经变成了 1 或 2，<code>switch</code> 语句就会直接跳转到对应的 case，从而“执行下一个”逻辑片段。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">总结</h3>
<p>你的理解非常正确。Kotlin 协程在 JVM 上的本质就是：</p>
<ol>
<li><strong>编译期重写</strong>：利用 CPS 变换，将线性代码拆解。</li>
<li><strong>状态机模式</strong>：用 <code>switch(label)</code> 分割执行块。</li>
<li><strong>堆内存保存上下文</strong>：将局部变量“升级”为成员变量，确保在线程切换（栈帧弹出）后数据依然存在。</li>
</ol>
<p>这种实现方式最大的好处是<strong>不需要操作系统线程的上下文切换（Context Switch）</strong>，只是在用户态通过代码逻辑跳转，所以它非常轻量高效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Mobile First 到 AI First：自然语言驱动数据库操作的新范式]]></title>    <link>https://juejin.cn/post/7581036773608112128</link>    <guid>https://juejin.cn/post/7581036773608112128</guid>    <pubDate>2025-12-08T07:10:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581036773608112128" data-draft-id="7581041679189737507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Mobile First 到 AI First：自然语言驱动数据库操作的新范式"/> <meta itemprop="keywords" content="SQLite,IPython"/> <meta itemprop="datePublished" content="2025-12-08T07:10:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tzarevich"/> <meta itemprop="url" content="https://juejin.cn/user/578786070367529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Mobile First 到 AI First：自然语言驱动数据库操作的新范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578786070367529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tzarevich
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T07:10:03.000Z" title="Mon Dec 08 2025 07:10:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">从 Mobile First 到 AI First：自然语言驱动数据库操作的新范式</h2>
<p>在移动互联网高速发展的过去十年中，“Mobile First”（移动优先）成为产品设计与开发的核心理念。无论是响应式网页、小程序，还是原生 App，开发者都优先考虑移动端用户体验，再适配桌面端——这种策略不仅提升了触达效率，也重塑了用户与数字服务的交互方式。</p>
<p>然而，随着大模型技术的迅猛发展，一个新的范式正在崛起：“AI First”（人工智能优先）。如果说 Mobile First 解决的是“在哪里用”的问题，那么 AI First 则重新定义了“怎么用”和“谁来用”。以点奶茶为例：传统模式下，用户需手动打开美团、抖音或淘宝，在多个平台比价、选券、下单；而在 AI First 的世界里，只需对智能助手说一句：“帮我点一杯少糖热奶茶，在美团、抖音、淘宝上比价并用最便宜的那家下单。”——背后是 LLM（大语言模型）调度多个服务、理解用户意图、执行复杂任务的能力。</p>
<p>这一转变的关键在于：<strong>让非技术人员也能通过自然语言直接操作系统底层资源</strong>，尤其是数据库。本文将聚焦于如何利用大语言模型（如 DeepSeek、Gemini 等）实现“自然语言到 SQL”的自动转换，并结合实际代码，一步步展示这一能力如何嵌入现代应用开发流程。</p>
<hr/>
<h3 data-id="heading-1">一、为什么需要 Text-to-SQL？</h3>
<p>在传统后台管理系统中，数据库操作依赖程序员编写 SQL 语句。业务人员、运营小编甚至产品经理若想查询数据，往往需要提工单、等排期。这不仅效率低下，也形成了“数据壁垒”。</p>
<p>而 Text-to-SQL 技术的出现，使得任何会说话的人，都能直接与数据库对话。例如：</p>
<blockquote>
<p>“工程部门员工的姓名和工资是多少？”</p>
</blockquote>
<p>这句话经过 LLM 处理，可自动生成合法 SQL：</p>
<pre><code class="hljs language-ini" lang="ini">SELECT name, salary FROM employees WHERE <span class="hljs-attr">department</span> = <span class="hljs-string">'工程'</span><span class="hljs-comment">;</span>
</code></pre>
<p>这正是“数据库平权”的体现——让数据真正服务于每一个角色。</p>
<hr/>
<h3 data-id="heading-2">二、实现 Text-to-SQL 的关键技术步骤</h3>
<p>以下基于提供的 Python 代码，逐步拆解从自然语言到 SQL 执行的全过程。</p>
<h4 data-id="heading-3">步骤 1：构建数据库与表结构</h4>
<p>首先，我们使用 SQLite 创建一个员工表 <code>employees</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sqlite3
conn = sqlite3.connect(<span class="hljs-string">"test.db"</span>)
cursor = conn.cursor()

cursor.execute(<span class="hljs-string">"""
CREATE TABLE IF NOT EXISTS employees(
    id INTEGER PRIMARY KEY,
    name TEXT,
    department TEXT,
    salary INTEGER
)
"""</span>)
</code></pre>
<blockquote>
<p>注意：原文中的 <code>RRIMARY KEY</code> 应为 <code>PRIMARY KEY</code>，此处已修正。</p>
</blockquote>
<p>接着插入示例数据：</p>
<pre><code class="hljs language-scss" lang="scss">sample_data = <span class="hljs-selector-attr">[    (6, <span class="hljs-string">"黄佳"</span>, <span class="hljs-string">"销售"</span>, 50000),    (7, <span class="hljs-string">"宁宁"</span>, <span class="hljs-string">"工程"</span>, 75000),    (8, <span class="hljs-string">"谦谦"</span>, <span class="hljs-string">"销售"</span>, 60000),    (9, <span class="hljs-string">"悦悦"</span>, <span class="hljs-string">"工程"</span>, 80000),    (10, <span class="hljs-string">"黄仁勋"</span>, <span class="hljs-string">"市场"</span>, 55000),    (11, <span class="hljs-string">"wyc"</span>, <span class="hljs-string">"工程"</span>, 80000)]</span>
<span class="hljs-attribute">cursor</span><span class="hljs-selector-class">.executemany</span>("INSERT INTO employees VALUES(?,?,?,?)", sample_data)
conn<span class="hljs-selector-class">.commit</span>()
</code></pre>
<h4 data-id="heading-4">步骤 2：提取数据库 Schema 作为上下文</h4>
<p>为了让 LLM 理解表结构，我们需要将其转换为人类可读的 DDL（数据定义语言）格式：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">schema</span> = cursor.execute(<span class="hljs-string">"PRAGMA table_info(employees)"</span>).fetchall()
<span class="hljs-attr">schema_str</span> = <span class="hljs-string">"CREATE TABLE EMPLOYEES (\n"</span> + <span class="hljs-string">"\n"</span>.join([f<span class="hljs-string">"{col[1]} {col[2]}"</span> for col in schema]) + <span class="hljs-string">"\n)"</span>
</code></pre>
<p>输出结果为：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> EMPLOYEES (
id <span class="hljs-type">INTEGER</span>
name TEXT
department TEXT
salary <span class="hljs-type">INTEGER</span>
)
</code></pre>
<p>这个 <code>schema_str</code> 将作为提示词（prompt）的一部分，告诉模型“数据库长什么样”。</p>
<h4 data-id="heading-5">步骤 3：调用大模型生成 SQL</h4>
<p>我们使用 OpenAI 兼容接口调用 DeepSeek 模型：</p>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI
<span class="hljs-attr">client</span> = OpenAI(
    <span class="hljs-attr">api_key</span>=<span class="hljs-string">'your-api-key'</span>, // 使用自己的APIkey
    <span class="hljs-attr">base_url</span>=<span class="hljs-string">'https://api.deepseek.com/v1'</span>
)

def ask_deepseek(query, schema):
    <span class="hljs-attr">prompt</span> = f<span class="hljs-string">"""
    这是一个数据库的schema：
    {schema}
    根据这个Schema，请输出一个SQL查询来回答以下问题。
    只输出SQL查询语句本身，不要使用任何Markdown格式，
    不要包含反引号、代码块标记或额外说明。
    问题：{query}
    """</span>
    <span class="hljs-attr">response</span> = client.chat.completions.create(
        <span class="hljs-attr">model</span>=<span class="hljs-string">'deepseek-chat'</span>,
        <span class="hljs-attr">messages</span>=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}],
        <span class="hljs-attr">temperature</span>=<span class="hljs-number">0</span>,
        <span class="hljs-attr">max_tokens</span>=<span class="hljs-number">2048</span>
    )
    return response.choices<span class="hljs-section">[0]</span>.message.content
</code></pre>
<p>关键点在于 <strong>精准的 Prompt 设计</strong>：明确要求只返回纯 SQL，避免模型输出解释性文字，从而可直接用于执行。</p>
<h4 data-id="heading-6">步骤 4：执行生成的 SQL 并返回结果</h4>
<p>以问题“工程部门员工的姓名和工资是多少”为例：</p>
<pre><code class="hljs language-scss" lang="scss">question = "工程部门员工的姓名和工资是多少"
sql_query = <span class="hljs-built_in">ask_deepseek</span>(question, schema_str)
<span class="hljs-built_in">print</span>(sql_query)  # 输出：SELECT name, salary FROM employees WHERE department = '工程';

results = <span class="hljs-attribute">cursor</span><span class="hljs-selector-class">.execute</span>(sql_query)<span class="hljs-selector-class">.fetchall</span>()
<span class="hljs-built_in">print</span>(results)  # 输出：<span class="hljs-selector-attr">[(<span class="hljs-string">'宁宁'</span>, 75000), (<span class="hljs-string">'悦悦'</span>, 80000), (<span class="hljs-string">'wyc'</span>, 80000)]</span>
</code></pre>
<p>同样，对于增删改操作：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 新增员工</span>
<span class="hljs-attr">question</span> = <span class="hljs-string">"在销售部门增加一个新员工，姓名为张三，工资为45000"</span>
<span class="hljs-attr">sql_query</span> = ask_deepseek(question, schema_str)
<span class="hljs-comment"># 预期输出：INSERT INTO employees (name, department, salary) VALUES ('张三', '销售', 45000);</span>
cursor.execute(sql_query)
conn.commit()

<span class="hljs-comment"># 删除员工</span>
<span class="hljs-attr">question</span> = <span class="hljs-string">"删除市场部门的黄仁勋"</span>
<span class="hljs-attr">sql_query</span> = ask_deepseek(question, schema_str)
<span class="hljs-comment"># 预期输出：DELETE FROM employees WHERE name = '黄仁勋' AND department = '市场';</span>
cursor.execute(sql_query)
conn.commit()
</code></pre>
<blockquote>
<p>注意：实际生产中需对生成的 SQL 做安全校验（如防止 DROP TABLE），避免注入风险。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">三、AI First 如何重塑开发范式？</h3>
<p>上述流程展示了 AI 如何成为“自然语言与数据库之间的翻译官”。在 AI First 架构下：</p>
<ul>
<li><strong>前端</strong>：用户通过语音或文本输入需求；</li>
<li><strong>后端</strong>：LLM 根据 Schema 生成 SQL；</li>
<li><strong>执行层</strong>：安全沙箱中运行 SQL 并返回结构化结果；</li>
<li><strong>反馈闭环</strong>：用户可进一步追问，形成多轮对话式数据探索。</li>
</ul>
<p>这种模式已在阿里云 ModelScope 等平台初现端倪——开发者可直接在 Notebook 中调用大模型 API，结合数据集微调专属 Text-to-SQL 模型，快速构建智能 BI、自助报表、AI 运营后台等应用。</p>
<hr/>
<h3 data-id="heading-8">结语</h3>
<p>从 Mobile First 到 AI First，技术演进的本质是从“适配设备”走向“理解人意”。当自然语言可以直接操控数据库，编程的门槛被大幅降低，创造力将从代码细节中解放出来，聚焦于更高维的问题解决。</p>
<p>未来，每一个业务人员都可能拥有自己的“AI 数据助理”——你说需求，它写 SQL，你做决策。这不仅是效率的飞跃，更是人机协作新纪元的开启。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我在openEuler上从零开始构建云原生AI应用]]></title>    <link>https://juejin.cn/post/7581041679189868579</link>    <guid>https://juejin.cn/post/7581041679189868579</guid>    <pubDate>2025-12-08T07:24:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581041679189868579" data-draft-id="7581073928716255266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我在openEuler上从零开始构建云原生AI应用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-08T07:24:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵手"/> <meta itemprop="url" content="https://juejin.cn/user/3668430176655997"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我在openEuler上从零开始构建云原生AI应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3668430176655997/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵手
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T07:24:39.000Z" title="Mon Dec 08 2025 07:24:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一、前言</h2>
<p>作为一名长期奋战在一线的开发者，我至今还记得第一次接触云原生概念时的困惑与好奇。那些关于容器、微服务、服务网格的术语，听起来如此遥远又如此吸引人。直到某天，当我面对一个需要同时处理AI推理和实时数据流的项目时，传统开发方式的局限性才真正显现出来。
就是在这样的背景下，我邂逅了openEuler。这个号称"面向数字基础设施的开源操作系统"，真的能解决我在AI和云原生场景下面临的困境吗？带着这样的疑问，我决定来一次深度的实践探索。</p>
<h2 data-id="heading-1">二、环境搭建</h2>
<p>在VMware中安装openEuler 25.09的过程，安装界面简洁明了，没有过多花哨的装饰，却处处透露出专业感。整个安装过程大约持续了15分钟，期间我仔细观察着每一个步骤的提示信息，发现openEuler在硬件识别和驱动兼容性方面做得相当出色。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba2beddcc0c74a76b3fcef97c7aeb874~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765783479&amp;x-signature=6%2FDkn0oUW%2FpcmZ2PGyBLnMmhnGQ%3D" alt="" loading="lazy"/></p>
<p>安装完成后，第一次进入系统的体验令人愉悦。UKUI桌面环境既保留了传统Linux桌面的操作习惯，又加入了许多现代化的设计元素。特别是任务栏和系统设置，布局合理，响应迅速。</p>
<pre><code class="hljs language-json" lang="json"># 让我们先来认识一下这个新环境
cat /etc/os-release
# 输出结果让我确信，这确实是一个为现代计算而生的系统
# NAME=<span class="hljs-string">"openEuler"</span>
# VERSION=<span class="hljs-string">"25.09"</span>
# ID=<span class="hljs-string">"openEuler"</span>
# VERSION_ID=<span class="hljs-string">"25.09"</span>
# PRETTY_NAME=<span class="hljs-string">"openEuler 25.09"</span>
# ANSI_COLOR=<span class="hljs-string">"0;31"</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9140980ee277409fbc16f09f761c272d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765783479&amp;x-signature=aZfsYmo5%2FuQwbW%2FbEJTcfjaj%2BJA%3D" alt="" loading="lazy"/></p>
<p>在终端中输入这行命令时，我感受到的不仅是技术的精准，更是一种对开发者友好的态度。系统预装了许多实用的开发工具，但并没有过度臃肿，这种平衡感很难得。</p>
<p>开发环境配置</p>
<p>配置开发环境的过程，让我想起了指挥家排练交响乐。每个组件都需要恰到好处地配合，而openEuler提供的软件仓库就像是经验丰富的乐手，随时准备奏出和谐的乐章。</p>
<pre><code class="hljs language-json" lang="json"># 更新系统，这是每个Linux用户的仪式感
sudo dnf update -y

# 安装开发工具链
sudo dnf groupinstall -y <span class="hljs-string">"Development Tools"</span>

# 配置Python环境
python3 --version
# Python <span class="hljs-number">3.9</span><span class="hljs-number">.5</span> - 一个稳定而现代的版本

# 创建虚拟环境
python3 -m venv ~/openeuler_ai
source ~/openeuler_ai/bin/activate
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67c08959f1744ba1b7d8bbfb9b369873~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765783479&amp;x-signature=Da0Ew%2F7gqhisRSmcN1z0oAayaMk%3D" alt="" loading="lazy"/></p>
<p>在这个过程中，我特别注意到了openEuler的包管理器dnf的表现。相比我之前使用的其他发行版，openEuler的软件仓库响应速度更快，依赖解析也更加智能。</p>
<h2 data-id="heading-2">三、云原生基础架构的构建</h2>
<p>容器技术是云原生的基石，但在openEuler上使用Docker的体验，却有着独特的感觉。这不仅仅是因为安装过程的顺畅，更因为openEuler对容器运行时的深度优化。</p>
<pre><code class="hljs language-json" lang="json"># 安装Docker
sudo dnf install -y docker

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker

# 验证安装
docker --version
# Docker version <span class="hljs-number">24.0</span><span class="hljs-number">.5</span><span class="hljs-punctuation">,</span> build <span class="hljs-number">24.0</span><span class="hljs-number">.5</span><span class="hljs-number">-1.</span>oe2509
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed0683c8efa44400889e22c1f0eb65f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765783479&amp;x-signature=Gat7hjp19yOeSh1HcuJhO6Goe4U%3D" alt="" loading="lazy"/></p>
<p>当我看到这个版本号时，意识到openEuler提供的Docker版本是经过特别适配的。这种细节上的关注，让我对后续的实践充满期待。</p>
<h2 data-id="heading-3">四、Kubernetes集群搭建</h2>
<p>单机容器化只是开始，真正的云原生体验来自于Kubernetes。在openEuler上搭建K3s集群的过程，让我对"轻量级"有了新的认识。</p>
<pre><code class="hljs language-dart" lang="dart"># 安装K3s - 一个为边缘计算和轻量级场景设计的Kubernetes发行版
curl -sfL https:<span class="hljs-comment">//get.k3s.io | sh -</span>

# 检查集群状态
sudo k3s kubectl <span class="hljs-keyword">get</span> nodes
# NAME STATUS ROLES AGE VERSION
# openEuler Ready control-plane,master <span class="hljs-number">2</span>m v1<span class="hljs-number">.27</span><span class="hljs-number">.3</span>+k3s1
看到节点状态显示为Ready时，那种成就感难以言表。但更让我惊讶的是资源占用情况：整个K3s集群的内存占用不到<span class="hljs-number">500</span>MB，这在一台<span class="hljs-number">4</span>GB内存的虚拟机上运行绰绰有余。
五、AI工作负载的云原生实践
<span class="hljs-number">1</span>、从代码到服务
在云原生环境中运行AI模型，最大的挑战是如何将模型推理过程封装成可扩展的服务。我在openEuler上实践了一个基于TensorFlow的图像分类服务：
<span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf
from flask <span class="hljs-keyword">import</span> Flask, request, jsonify
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
from PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">import</span> logging

# 配置日志
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = Flask(__name__)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AIPredictionService</span>:
    <span class="hljs-title">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-title">self</span>):
        <span class="hljs-title">self</span>.<span class="hljs-title">model</span> = <span class="hljs-title">None</span>
        <span class="hljs-title">self</span>.<span class="hljs-title">labels</span> = ['飞机', '汽车', '鸟', '猫', '鹿', '狗', '青蛙', '马', '船', '卡车']
        
    <span class="hljs-title">def</span> <span class="hljs-title">load_model</span>(<span class="hljs-title">self</span>):
        """加载预训练模型"""
        <span class="hljs-title">try</span>:
            # 这里使用<span class="hljs-title">CIFAR</span>-10数据集训练的简单<span class="hljs-title">CNN</span>模型
            <span class="hljs-title">self</span>.<span class="hljs-title">model</span> = <span class="hljs-title">tf</span>.<span class="hljs-title">keras</span>.<span class="hljs-title">applications</span>.<span class="hljs-title">MobileNetV2</span>(
                <span class="hljs-title">weights</span>='<span class="hljs-title">imagenet</span>',
                <span class="hljs-title">input_shape</span>=(224, 224, 3)
            )
            <span class="hljs-title">logger</span>.<span class="hljs-title">info</span>("<span class="hljs-title">AI</span>模型加载成功")
        <span class="hljs-title">except</span> <span class="hljs-title">Exception</span> <span class="hljs-title">as</span> <span class="hljs-title">e</span>:
            <span class="hljs-title">logger</span>.<span class="hljs-title">error</span>(<span class="hljs-title">f</span>"模型加载失败: </span>{e}<span class="hljs-string">")
            raise
    
    def preprocess_image(self, image_data):
        "</span><span class="hljs-string">""</span>预处理输入图像<span class="hljs-string">"""
        image = Image.open(io.BytesIO(image_data))
        
        # 调整尺寸以适应模型输入
        image = image.resize((224, 224))
        
        # 转换为numpy数组并归一化
        image_array = np.array(image) / 255.0
        
        # 添加批次维度
        image_batch = np.expand_dims(image_array, axis=0)
        
        return image_batch
    
    def predict(self, image_data):
        """</span>执行预测<span class="hljs-string">"""
        if self.model is None:
            self.load_model()
        
        processed_image = self.preprocess_image(image_data)
        
        predictions = self.model.predict(processed_image)
        decoded_predictions = tf.keras.applications.mobilenet_v2.decode_predictions(
            predictions, top=3
        )
        
        return decoded_predictions[0]

# 初始化服务
ai_service = AIPredictionService()

@app.route('/predict', methods=['POST'])
def predict_endpoint():
    """</span>预测端点<span class="hljs-string">"""
    try:
        if 'image' not in request.files:
            return jsonify({'error': '没有提供图像文件'}), 400
        
        image_file = request.files['image']
        image_data = image_file.read()
        
        predictions = ai_service.predict(image_data)
        
        result = {
            'predictions': [
                {
                    'label': label,
                    'description': description,
                    'confidence': float(confidence)
                }
                for (_, label, confidence), description in zip(
                    predictions, 
                    ['最可能', '次可能', '第三可能']
                )
            ],
            'platform': 'openEuler AI Service'
        }
        
        return jsonify(result)
    
    except Exception as e:
        logger.error(f"预测失败: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/model/health', methods=['GET'])
def model_health():
    """</span>模型健康检查<span class="hljs-string">"""
    try:
        if ai_service.model is None:
            ai_service.load_model()
        
        # 创建一个随机输入来测试模型
        test_input = np.random.random((1, 224, 224, 3))
        _ = ai_service.model.predict(test_input)
        
        return jsonify({
            'status': 'healthy',
            'model_loaded': True,
            'platform': 'openEuler'
        })
    
    except Exception as e:
        return jsonify({
            'status': 'unhealthy',
            'error': str(e)
        }), 503

if __name__ == '__main__':
    ai_service.load_model()
    app.run(host='0.0.0.0', port=8080, debug=False)
</span></code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df3e0410e29f4be492c7f95a986b8fba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765783479&amp;x-signature=0pXpZVbMRB17r8JYinB5of5xT7k%3D" alt="" loading="lazy"/></p>
<p>这个是我我们打开网址，<a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A8080%25E6%2588%2596%25E8%2580%2585http%3A%2F%2F127.0.0.1%3A8080%25EF%25BC%258C%25E8%25BF%259B%25E8%25A1%258C%25E4%25B8%258A%25E4%25BC%25A0%25E7%2585%25A7%25E7%2589%2587" target="_blank" title="http://127.0.0.1:8080%E6%88%96%E8%80%85http://127.0.0.1:8080%EF%BC%8C%E8%BF%9B%E8%A1%8C%E4%B8%8A%E4%BC%A0%E7%85%A7%E7%89%87" ref="nofollow noopener noreferrer">http://127.0.0.1:8080或者http://127.0.0.1:8080，进行上传照片</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5ba2e65df62413ba1ae7a72b02d7214~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765783479&amp;x-signature=KyuPjEJUlIPo1jnCJgCz896wayI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5db8ad5869b94459890e9aaa9883c806~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765783479&amp;x-signature=LNeuUIPiBrgsSKAWcIAxDY4PR78%3D" alt="" loading="lazy"/></p>
<p>这个服务的设计体现了云原生的多个重要理念：健康检查、错误处理、资源管理和服务发现。在openEuler上运行这个服务时，TensorFlow的推理性能表现出色，这得益于openEuler对AI计算库的深度优化。</p>
<h3 data-id="heading-4">2、基础设施即代码</h3>
<p>将AI服务部署到Kubernetes集群时，我使用了以下部署描述文件：</p>
<pre><code class="hljs language-dart" lang="dart"># ai-service-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-prediction-service
  labels:
    app: ai-prediction
    platform: openEuler
spec:
  replicas: <span class="hljs-number">2</span>
  selector:
    matchLabels:
      app: ai-prediction
  template:
    metadata:
      labels:
        app: ai-prediction
        version: v1<span class="hljs-number">.0</span>
    spec:
      containers:
      - name: ai-service
        image: localhost:<span class="hljs-number">5000</span>/ai-prediction:v1<span class="hljs-number">.0</span>
        ports:
        - containerPort: <span class="hljs-number">8080</span>
        env:
        - name: MODEL_CACHE_SIZE
          value: <span class="hljs-string">"100"</span>
        - name: LOG_LEVEL
          value: <span class="hljs-string">"INFO"</span>
        resources:
          requests:
            memory: <span class="hljs-string">"512Mi"</span>
            cpu: <span class="hljs-string">"250m"</span>
          limits:
            memory: <span class="hljs-string">"1Gi"</span>
            cpu: <span class="hljs-string">"500m"</span>
        livenessProbe:
          httpGet:
            path: /model/health
            port: <span class="hljs-number">8080</span>
          initialDelaySeconds: <span class="hljs-number">30</span>
          periodSeconds: <span class="hljs-number">10</span>
        readinessProbe:
          httpGet:
            path: /model/health
            port: <span class="hljs-number">8080</span>
          initialDelaySeconds: <span class="hljs-number">5</span>
          periodSeconds: <span class="hljs-number">5</span>
---
apiVersion: v1
kind: Service
metadata:
  name: ai-prediction-service
  labels:
    app: ai-prediction
    service: <span class="hljs-keyword">external</span>
spec:
  selector:
    app: ai-prediction
  ports:
  - port: <span class="hljs-number">80</span>
    targetPort: <span class="hljs-number">8080</span>
    protocol: TCP
  type: LoadBalancer
</code></pre>
<p>这个YAML文件不仅仅是一个部署脚本，它更像是一份详细的服务蓝图。从资源限制到健康检查，从副本数量到网络配置，每一个细节都体现了云原生应用的运维理念。</p>
<h2 data-id="heading-5">六、真实场景的性能测试</h2>
<h3 data-id="heading-6">1、压力测试</h3>
<p>为了验证这个云原生AI应用在openEuler上的真实性能，我设计了一个压力测试场景：</p>
<pre><code class="hljs language-json" lang="json">import requests
import concurrent.futures
import time
import statistics
from datetime import datetime
import json

class PerformanceTester<span class="hljs-punctuation">:</span>
    def __init__(self<span class="hljs-punctuation">,</span> base_url)<span class="hljs-punctuation">:</span>
        self.base_url = base_url
        self.results = <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
        
    def single_request(self<span class="hljs-punctuation">,</span> image_path<span class="hljs-punctuation">,</span> request_id)<span class="hljs-punctuation">:</span>
        <span class="hljs-string">""</span><span class="hljs-string">"执行单个请求并记录指标"</span><span class="hljs-string">""</span>
        start_time = time.time()
        
        try<span class="hljs-punctuation">:</span>
            with open(image_path<span class="hljs-punctuation">,</span> 'rb') as f<span class="hljs-punctuation">:</span>
                files = <span class="hljs-punctuation">{</span>'image'<span class="hljs-punctuation">:</span> f<span class="hljs-punctuation">}</span>
                response = requests.post(
                    f<span class="hljs-string">"{self.base_url}/predict"</span><span class="hljs-punctuation">,</span>
                    files=files<span class="hljs-punctuation">,</span>
                    timeout=<span class="hljs-number">30</span>
                )
                
            end_time = time.time()
            latency = (end_time - start_time) * <span class="hljs-number">1000</span>  # 转换为毫秒
            
            result = <span class="hljs-punctuation">{</span>
                'request_id'<span class="hljs-punctuation">:</span> request_id<span class="hljs-punctuation">,</span>
                'timestamp'<span class="hljs-punctuation">:</span> datetime.now().isoformat()<span class="hljs-punctuation">,</span>
                'latency_ms'<span class="hljs-punctuation">:</span> latency<span class="hljs-punctuation">,</span>
                'status_code'<span class="hljs-punctuation">:</span> response.status_code<span class="hljs-punctuation">,</span>
                'success'<span class="hljs-punctuation">:</span> response.status_code == <span class="hljs-number">200</span>
            <span class="hljs-punctuation">}</span>
            
            return result
            
        except Exception as e<span class="hljs-punctuation">:</span>
            end_time = time.time()
            return <span class="hljs-punctuation">{</span>
                'request_id'<span class="hljs-punctuation">:</span> request_id<span class="hljs-punctuation">,</span>
                'timestamp'<span class="hljs-punctuation">:</span> datetime.now().isoformat()<span class="hljs-punctuation">,</span>
                'latency_ms'<span class="hljs-punctuation">:</span> (end_time - start_time) * <span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>
                'status_code'<span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
                'success'<span class="hljs-punctuation">:</span> False<span class="hljs-punctuation">,</span>
                'error'<span class="hljs-punctuation">:</span> str(e)
            <span class="hljs-punctuation">}</span>
    
    def run_concurrent_test(self<span class="hljs-punctuation">,</span> image_path<span class="hljs-punctuation">,</span> num_requests=<span class="hljs-number">100</span><span class="hljs-punctuation">,</span> max_workers=<span class="hljs-number">10</span>)<span class="hljs-punctuation">:</span>
        <span class="hljs-string">""</span><span class="hljs-string">"执行并发测试"</span><span class="hljs-string">""</span>
        print(f<span class="hljs-string">"开始并发测试: {num_requests} 个请求, {max_workers} 个并发线程"</span>)
        
        with concurrent.futures.ThreadPoolExecutor(max_workers=max_workers) as executor<span class="hljs-punctuation">:</span>
            futures = <span class="hljs-punctuation">[</span>
                executor.submit(self.single_request<span class="hljs-punctuation">,</span> image_path<span class="hljs-punctuation">,</span> i)
                for i in range(num_requests)
            <span class="hljs-punctuation">]</span>
            
            for future in concurrent.futures.as_completed(futures)<span class="hljs-punctuation">:</span>
                result = future.result()
                self.results.append(result)
                
        self.analyze_results()
    
    def analyze_results(self)<span class="hljs-punctuation">:</span>
        <span class="hljs-string">""</span><span class="hljs-string">"分析测试结果"</span><span class="hljs-string">""</span>
        successful_requests = <span class="hljs-punctuation">[</span>r for r in self.results if r<span class="hljs-punctuation">[</span>'success'<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>
        failed_requests = <span class="hljs-punctuation">[</span>r for r in self.results if not r<span class="hljs-punctuation">[</span>'success'<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>
        
        latencies = <span class="hljs-punctuation">[</span>r<span class="hljs-punctuation">[</span>'latency_ms'<span class="hljs-punctuation">]</span> for r in successful_requests<span class="hljs-punctuation">]</span>
        
        print(<span class="hljs-string">"\n=== 性能测试结果 ==="</span>)
        print(f<span class="hljs-string">"总请求数: {len(self.results)}"</span>)
        print(f<span class="hljs-string">"成功请求: {len(successful_requests)}"</span>)
        print(f<span class="hljs-string">"失败请求: {len(failed_requests)}"</span>)
        print(f<span class="hljs-string">"成功率: {len(successful_requests)/len(self.results)*100:.2f}%"</span>)
        
        if latencies<span class="hljs-punctuation">:</span>
            print(f<span class="hljs-string">"平均延迟: {statistics.mean(latencies):.2f} ms"</span>)
            print(f<span class="hljs-string">"延迟中位数: {statistics.median(latencies):.2f} ms"</span>)
            print(f<span class="hljs-string">"最小延迟: {min(latencies):.2f} ms"</span>)
            print(f<span class="hljs-string">"最大延迟: {max(latencies):.2f} ms"</span>)
            print(f<span class="hljs-string">"延迟标准差: {statistics.stdev(latencies) if len(latencies) &gt; 1 else 0:.2f} ms"</span>)
        
        # 保存详细结果
        with open('performance_results.json'<span class="hljs-punctuation">,</span> 'w') as f<span class="hljs-punctuation">:</span>
            json.dump(self.results<span class="hljs-punctuation">,</span> f<span class="hljs-punctuation">,</span> indent=<span class="hljs-number">2</span>)

# 运行测试
if __name__ == '__main__'<span class="hljs-punctuation">:</span>
    tester = PerformanceTester('http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:8080')</span>
    tester.run_concurrent_test('test_image.jpg'<span class="hljs-punctuation">,</span> num_requests=<span class="hljs-number">50</span><span class="hljs-punctuation">,</span> max_workers=<span class="hljs-number">5</span>)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3959e1df92d5413d81180a033ce1a42e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765783479&amp;x-signature=23CwBJmT1%2B%2BFD19wleoGuzryCIM%3D" alt="" loading="lazy"/></p>
<p>压力测试的结果令人印象深刻。在openEuler平台上，AI推理服务展现出了出色的稳定性和性能一致性。即使在并发请求的压力下，服务响应时间仍然保持在一个合理的范围内。</p>
<h2 data-id="heading-7">六、深度体验与感悟</h2>
<h3 data-id="heading-8">1、技术生态的完整性</h3>
<p>在这次深度体验中，最让我感到惊喜的是openEuler技术生态的完整性。从底层的容器运行时，到上层的AI框架，再到云原生编排工具，每一个环节都经过了精心的适配和优化。</p>
<p>特别是在处理AI工作负载时，openEuler对TensorFlow、PyTorch等主流框架的原生支持，大大简化了部署和调试的复杂度。这种"开箱即用"的体验，在其他的Linux发行版中并不多见。</p>
<h3 data-id="heading-9">2、性能优化的细腻之处</h3>
<p>在测试过程中，我特别注意到了openEuler在性能优化方面的细腻之处。比如在内存管理方面，系统能够智能地平衡AI模型的内存占用和其他系统组件的需求。在I/O调度方面，对容器存储的优化也让镜像拉取和容器启动速度有了明显提升。</p>
<pre><code class="hljs language-json" lang="json"># 检查系统资源使用情况
htop
# 观察到的内存使用分布非常合理，没有出现异常的内存占用

# 监控容器性能
docker stats
# 容器间的资源隔离效果很好，没有明显的相互干扰
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10260a89606944be9ec0eaa908e8062e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za15omL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765783479&amp;x-signature=G3MHJ%2BCKvwV7f01v66X7ZT0Z5LU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">3、开发体验的流畅度</h3>
<p>作为一名开发者，系统的开发体验直接影响工作效率。在openEuler上，从环境配置到应用部署，从调试排错到性能优化，整个开发流程都显得异常流畅。</p>
<p>特别是当我在Kubernetes中部署复杂的多服务应用时，openEuler的网络性能和存储性能为整个系统提供了坚实的基础支撑。服务之间的通信延迟稳定，数据持久化可靠，这些都是生产级应用不可或缺的特性。</p>
<h2 data-id="heading-11">七、结语</h2>
<p>经过这次深度的实践探索，我对openEuler有了全新的认识。它不仅仅是一个操作系统，更是一个面向云原生和AI时代的完整技术栈。
在openEuler上构建云原生AI应用的过程，就像是在一个精心设计的工坊中创作艺术品。工具顺手，材料优质，环境舒适，让开发者能够专注于创造本身，而不是被技术细节所困扰。</p>
<p>这次体验让我深刻感受到，自主创新技术已经发展到了一个新的高度。openEuler以其成熟的技术生态、优秀的性能表现和友好的开发体验，证明了它在云原生和AI领域的独特价值。</p>
<p>对于正在考虑数字化转型和技术升级的团队来说，openEuler提供了一个稳定、高效且面向未来的技术底座。它既保留了传统Linux系统的可靠性，又融入了现代云原生和AI技术的前沿特性，这种平衡的艺术，正是技术演进的精髓所在。</p>
<p>在这个快速变化的数字时代，选择合适的技术平台至关重要。而openEuler，无疑是为数不多的能够同时满足稳定性要求和技术前瞻性需求的优秀选择之一。</p>
<blockquote>
<p>如果您正在寻找面向未来的开源操作系统，不妨看看DistroWatch 榜单中快速上升的 openEuler:<a href="https://link.juejin.cn?target=https%3A%2F%2Fdistrowatch.com%2Ftable-mobile.php%3Fdistribution%3Dopeneuler" target="_blank" title="https://distrowatch.com/table-mobile.php?distribution=openeuler" ref="nofollow noopener noreferrer">distrowatch.com/table-mobil…</a>，一个由开放原子开源基金会孵化、支持“超节点”场景的Linux 发行版。
openEuler官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.openeuler.openatom.cn%2Fzh%2F" target="_blank" title="https://www.openeuler.openatom.cn/zh/" ref="nofollow noopener noreferrer">www.openeuler.openatom.cn/zh/</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手写 langchain 的 递归文本分割RecursiveCharacterTextSplitter]]></title>    <link>https://juejin.cn/post/7581106788205821979</link>    <guid>https://juejin.cn/post/7581106788205821979</guid>    <pubDate>2025-12-08T07:38:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581106788205821979" data-draft-id="7581106788205789211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手写 langchain 的 递归文本分割RecursiveCharacterTextSplitter"/> <meta itemprop="keywords" content="LangChain"/> <meta itemprop="datePublished" content="2025-12-08T07:38:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天星烛"/> <meta itemprop="url" content="https://juejin.cn/user/1099167359051949"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手写 langchain 的 递归文本分割RecursiveCharacterTextSplitter
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167359051949/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天星烛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T07:38:24.000Z" title="Mon Dec 08 2025 07:38:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Fintegrations%2Fsplitters" target="_blank" title="https://docs.langchain.com/oss/python/integrations/splitters" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></p>
<pre><code class="hljs language-py" lang="py">
<span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter

text_splitter = RecursiveCharacterTextSplitter(chunk_size=<span class="hljs-number">100</span>, chunk_overlap=<span class="hljs-number">0</span>)
texts = text_splitter.split_text(document)

</code></pre>
<pre><code class="hljs language-py" lang="py"><span class="hljs-comment">#from langchain.text_splitter import RecursiveCharacterTextSplitter</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RecursiveCharacterTextSplitter</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self,chunk_size=<span class="hljs-number">128</span>,chunk_overlap=<span class="hljs-number">30</span>,separators=<span class="hljs-literal">None</span></span>):
        self.chunk_size=chunk_size
        self.chunk_overlap=chunk_overlap
        <span class="hljs-keyword">if</span> separators <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.separators=[<span class="hljs-string">"\n\n"</span>,<span class="hljs-string">"\n"</span>,<span class="hljs-string">" "</span>,<span class="hljs-string">""</span>]
        <span class="hljs-keyword">else</span>:
            self.separators=separators
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">split_text</span>(<span class="hljs-params">self,text</span>):
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">recursive_split</span>(<span class="hljs-params">txt,seps</span>):
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> seps:
                <span class="hljs-comment"># 1 txt[0：50] txt[50,100] txt[100,150]</span>
                <span class="hljs-keyword">return</span> [
                    txt[i:i+self.chunk_size]
                    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(txt),self.chunk_size)
                ]
            <span class="hljs-comment">#取出第一个分隔符</span>
            sep = seps[<span class="hljs-number">0</span>]
            <span class="hljs-comment">#按当前的分隔符进行分割文本</span>
            parts = txt.split(sep)
            <span class="hljs-comment">#初始化结果列表</span>
            result = []
            <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> parts:
                <span class="hljs-comment"># 如果不是最后一段，需要补回分隔符</span>
                <span class="hljs-keyword">if</span> part != parts[-<span class="hljs-number">1</span>]:
                    part = part+sep
                <span class="hljs-comment">#如果当前段落长度大于规定的每个块的长度，递归使用下一个分隔符继续分割</span>
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(part)&gt;self.chunk_size:
                    result.extend(recursive_split(part,seps[<span class="hljs-number">1</span>:]))
                <span class="hljs-keyword">else</span>:
                    result.append(part)
            <span class="hljs-keyword">return</span> result

        <span class="hljs-comment"># 递归分割文本，并去除空白分块</span>
        splits = [
            s <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> recursive_split(text,self.separators) <span class="hljs-keyword">if</span> s.strip()
        ]
        <span class="hljs-keyword">return</span> splits
        

r_splitter = RecursiveCharacterTextSplitter(
    chunk_size=<span class="hljs-number">50</span>,<span class="hljs-comment"># 每个分块最大50个字符</span>
    <span class="hljs-comment">#chunk_overlap=2,#相邻分块重叠是10个字符</span>
    separators = [
        <span class="hljs-string">"\n\n"</span>,<span class="hljs-comment">#段落分割符</span>
        <span class="hljs-string">"\n"</span>,<span class="hljs-comment"># 换行符分割符</span>
        <span class="hljs-string">"."</span>,<span class="hljs-comment">#英文句号分割符</span>
        <span class="hljs-string">"。"</span>,<span class="hljs-comment"># 中文句号分割符</span>
        <span class="hljs-string">","</span>,<span class="hljs-comment"># 英文逗号分割符</span>
        <span class="hljs-string">"，"</span><span class="hljs-comment"># 中文逗号分割符</span>
    ]
)
text = <span class="hljs-string">""""""</span>

chunks = r_splitter.split_text(text)
<span class="hljs-keyword">for</span> i ,chunk <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(chunks):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Chunk<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>: <span class="hljs-subst">{chunk}</span>"</span>)

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端玩转 AI 应用开发｜SSE 协议与JS中的流式处理🌊]]></title>    <link>https://juejin.cn/post/7581081334851289129</link>    <guid>https://juejin.cn/post/7581081334851289129</guid>    <pubDate>2025-12-08T07:57:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581081334851289129" data-draft-id="7574366319737143332" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端玩转 AI 应用开发｜SSE 协议与JS中的流式处理🌊"/> <meta itemprop="keywords" content="前端,程序员,人工智能"/> <meta itemprop="datePublished" content="2025-12-08T07:57:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哨卫哥"/> <meta itemprop="url" content="https://juejin.cn/user/2159893031168119"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端玩转 AI 应用开发｜SSE 协议与JS中的流式处理🌊
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2159893031168119/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哨卫哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T07:57:06.000Z" title="Mon Dec 08 2025 07:57:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>在 <a href="https://juejin.cn/post/7574370234070024246" target="_blank" title="https://juejin.cn/post/7574370234070024246">《前端玩转 AI 应用开发｜30行代码实现聊天机器人🤖》</a>中，我们实现了一个基础的聊天应用。然而，该方案存在明显的体验缺陷：由于采用同步等待模式，前端必须等到 AI 模型完整生成并返回全部内容后，才能将结果显示给用户。这在生成长文本时，会带来显著的延迟与卡顿感。</p>
<p>究其根源，这种<strong>请求-等待-响应</strong>的交互方式并不符合 AI 模型的流式生成特性。模型输出本质上是连续、逐词（Token）产生的，而我们此前采用的默认调用方式，会等待所有内容生成完毕后才一次性返回，导致用户在等待期间完全无法感知生成进度。</p>
<p>为解决这一问题，本文将系统介绍如何在前端实现<strong>流式响应</strong>。我们将通过建立持久连接，使前端能够实时接收并渲染模型返回的每一个数据片段，从而实现回答的逐词（Token）输出效果。这将从根本上消除不必要的等待，显著提升应用的实时交互体验与响应感知。</p>
<p>下面，我们将从技术原理到代码实现，逐步完成这一优化。</p>
<h2 data-id="heading-0">核心技术：Server-Sent Events</h2>
<h3 data-id="heading-1">什么是 SSE？</h3>
<p>Server-Sent Events (SSE) 是一种基于 HTTP 的服务器推送技术，允许服务器主动向客户端发送数据流。其核心机制在于：服务器通过声明 <code>Content-Type: text/event-stream</code>，告知客户端响应为一个持续的数据流。连接将保持打开状态，使服务器可连续发送数据片段，实现实时信息推送。</p>
<h3 data-id="heading-2">SSE 的优势</h3>
<p>在需要服务器向客户端持续推送数据的场景中，WebSocket 虽是全双工通信的通用方案，但 SSE 在单向数据流场景中具备显著优势：</p>
<ul>
<li><strong>协议轻量</strong>：基于标准 HTTP，无需额外协议升级，兼容性与部署成本更低。</li>
<li><strong>内置重连</strong>：支持自动断线重连与消息追踪，简化客户端容错逻辑。</li>
<li><strong>文本友好</strong>：原生支持 UTF-8 文本流，与 AI 响应等文本场景高度契合。</li>
<li><strong>开发简洁</strong>：浏览器端使用标准 <code>EventSource</code> API，接入成本低。</li>
</ul>
<p>在 AI 回复流式输出这类以服务器推送为主的场景中，SSE 以简洁的实现提供了高效、可靠的解决方案。</p>
<h3 data-id="heading-3">服务器如何流式返回数据？</h3>
<p>服务器在返回 SSE 数据时，必须满足两个基本要求：内容<strong>必须使用 UTF-8 编码</strong>，且响应头中的 <code>Content-Type</code> 必须设置为 <code>text/event-stream</code>。</p>
<h4 data-id="heading-4">data</h4>
<p>SSE 数据由遵循特定格式的文本块构成，每个消息以两个换行符 <code>\n\n</code> 结尾。以下是一个标准的多消息响应示例：</p>
<pre><code class="hljs language-text" lang="text">data: This is the first message.\n\n
data: This is the second message, it
data: has two lines.\n\n
data: This is the third message.\n\n
</code></pre>
<p>在实际应用中，为了传递结构化数据，我们通常会在 <code>data</code> 字段中嵌入 JSON 字符串。这也是当前端与 AI 服务交互时的常见做法，如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f19abb24a8a406ca82c800e944670f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOo5Y2r5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785426&amp;x-signature=T%2BluWhYXrLAQwsGzHJYgo4phIDo%3D" alt="image.png" loading="lazy"/></p>
<p>除了核心的 <code>data</code> 字段，SSE 还支持以下关键字段以增强功能：</p>
<h4 data-id="heading-5">event</h4>
<p>用于定义事件类型。浏览器端可通过 <code>addEventListener()</code> 监听特定事件。若未指定，则默认为 <code>message</code> 事件。</p>
<p>示例：服务器发送自定义 <code>add</code> 事件</p>
<pre><code class="hljs language-text" lang="text">event: add
data: 113411\n\n
</code></pre>
<p>客户端可针对此事件进行监听与处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> source = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(url); <span class="hljs-comment">// 下文会介绍 EventSource</span>
source.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'add'</span>, addHandler, <span class="hljs-literal">false</span>);
</code></pre>
<h4 data-id="heading-6"><code>id</code></h4>
<p>用于指定消息的事件 ID，其主要作用是实现<strong>断线重连同步</strong>。</p>
<p>示例：</p>
<pre><code class="hljs language-text" lang="text">id: message1
data: This is a message\n\n
</code></pre>
<p>当连接意外中断时，浏览器会在重新建立的请求头中自动携带 <code>Last-Event-ID: message1</code>，服务器可据此判断断连位置，并发送后续消息，从而保证消息流的连续性。</p>
<h3 data-id="heading-7">Demo: Node.js 实现 SSE</h3>
<p>理解协议最好的方式就是亲手实现它。下面，我们将创建一个最简单的 SSE 服务器，它会每秒向客户端推送一次当前时间。</p>
<p><strong>第一步：创建并启动服务端</strong></p>
<ol>
<li>将以下代码保存为 <code>server.js</code>。</li>
<li>在终端运行 <code>node server.js</code>。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);

<span class="hljs-comment">// 创建 HTTP 服务器</span>
http
  .<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> url = req.<span class="hljs-property">url</span>;

    <span class="hljs-comment">// SSE 流式响应端点</span>
    <span class="hljs-keyword">if</span> (url === <span class="hljs-string">'/stream'</span>) {
      <span class="hljs-comment">// 设置 SSE 响应头</span>
      res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/event-stream'</span>, <span class="hljs-comment">// SSE 的 MIME 类型</span>
        <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'no-cache'</span>, <span class="hljs-comment">// 禁止缓存</span>
        <span class="hljs-title class_">Connection</span>: <span class="hljs-string">'keep-alive'</span>, <span class="hljs-comment">// 保持长连接</span>
        <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span>, <span class="hljs-comment">// 允许跨域（生产环境建议指定具体域名）</span>
      });

      <span class="hljs-comment">// SSE 格式：retry 指定重连间隔（毫秒）</span>
      res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'retry: 10000\n'</span>);

      <span class="hljs-comment">// 发送自定义事件名称的消息</span>
      res.<span class="hljs-title function_">write</span>(<span class="hljs-string">'event: connecttime\n'</span>);
      res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>\n\n`</span>);

      <span class="hljs-comment">// 发送默认事件的消息（客户端通过 onmessage 接收）</span>
      res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>\n\n`</span>);

      <span class="hljs-comment">// 每秒向客户端推送当前时间</span>
      <span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
        res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span>\n\n`</span>);
      }, <span class="hljs-number">1000</span>);

      <span class="hljs-comment">// 监听客户端断开连接事件，清理定时器</span>
      req.<span class="hljs-property">socket</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-built_in">clearInterval</span>(interval);
      });
    }
  })
  .<span class="hljs-title function_">listen</span>(<span class="hljs-number">8844</span>, <span class="hljs-string">'127.0.0.1'</span>);
</code></pre>
<p><strong>第二步：在浏览器中验证</strong><br/>
服务启动后，点击这个 <strong><a href="https://link.juejin.cn?target=http%3A%2F%2Fjsbin.com%2Fvuziboduwa%2Fedit%3Fhtml%2Coutput" target="_blank" title="http://jsbin.com/vuziboduwa/edit?html,output" ref="nofollow noopener noreferrer">在线测试页面</a></strong>，你会看到页面上开始每秒打印出服务器推送的时间。</p>
<p><strong>第三步：观察与理解</strong><br/>
此时，打开浏览器的 <strong>开发者工具（F12）</strong> ，切换到 <strong>网络（Network）</strong>  面板。刷新测试页，你应该能看到一个对 <code>stream</code> 的请求，其类型为 <code>eventsource</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32f6054f830a4ae28487275ecfa5c98e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOo5Y2r5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785426&amp;x-signature=YftYwPY852HOQvMe4IJDt%2F4BJ%2BQ%3D" alt="image.png" loading="lazy"/></p>
<p>点击该请求，查看详细内容。在  <strong>“事件流（EventStream）”</strong>  或  <strong>“响应（Response）”</strong>  标签页中（取决于浏览器），你将看到持续流入的、格式规整的 SSE 数据：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d47bea01105d4a1697323b58fa3f17cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOo5Y2r5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785426&amp;x-signature=zfcpfRK1iosRFDFy1iLQcU6YDkQ%3D" alt="image.png" loading="lazy"/></p>
<p>请注意观察：</p>
<ul>
<li>连接建立时，服务器先发送了一个 <strong><code>connecttime</code></strong> 事件（事件类型 <code>event: connecttime</code>）。</li>
<li>随后，服务器以<strong>默认的 <code>message</code> 事件</strong>（未显式指定 <code>event:</code> 字段）持续每秒推送一条时间戳数据。</li>
</ul>
<p>通过亲手运行和观察，不仅验证了 SSE 协议的格式规范，也直观地理解了事件类型（<code>event</code>）和数据块（<code>data</code>）是如何在流中组织和传输的。这正是我们前端接收并处理 AI 流式响应的基础。接下来，我们就来看看前端如何建立并处理这样的 SSE 连接。</p>
<h3 data-id="heading-8">前端如何建立 SSE 连接？</h3>
<p>在理解了服务端的实现后，我们来看前端如何接收并处理 SSE 数据流。浏览器为此提供了原生的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource" ref="nofollow noopener noreferrer"><strong><code>EventSource</code></strong> </a>接口，它是与服务器发送事件通信的标准方式。</p>
<h4 data-id="heading-9">创建连接：EventSource 构造函数</h4>
<p>要建立 SSE 连接，只需创建一个 <code>EventSource</code> 实例，传入服务器端点的 URL：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> eventSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(<span class="hljs-string">'http://127.0.0.1:8844/stream'</span>);
</code></pre>
<p>这本质上是一个 HTTP GET 请求，与我们熟悉的 <code>fetch</code> 或 <code>XMLHttpRequest</code> 没有太大区别。</p>
<p>上面的<code>url</code>可以与当前网址同域，也可以跨域。跨域时，可以指定第二个参数，打开<code>withCredentials</code>属性，表示是否一起发送 Cookie。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> source = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(url, { <span class="hljs-attr">withCredentials</span>: <span class="hljs-literal">true</span> });
</code></pre>
<h4 data-id="heading-10">EventSource 实例属性和方法</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(eventSource.<span class="hljs-property">readyState</span>); <span class="hljs-comment">// 1 (连接已建立)</span>

<span class="hljs-comment">// 对应的常量值</span>
<span class="hljs-title class_">EventSource</span>.<span class="hljs-property">CONNECTING</span> === <span class="hljs-number">0</span>; <span class="hljs-comment">// 连接中或重连中</span>
<span class="hljs-title class_">EventSource</span>.<span class="hljs-property">OPEN</span> === <span class="hljs-number">1</span>;       <span class="hljs-comment">// 连接已打开</span>
<span class="hljs-title class_">EventSource</span>.<span class="hljs-property">CLOSED</span> === <span class="hljs-number">2</span>;     <span class="hljs-comment">// 连接已关闭</span>
</code></pre>
<p>这个属性是只读的，你可以通过监听状态变化来优化用户体验，比如在连接建立时显示"已连接"，在重连时显示"重新连接中..."。</p>
<p>当不再需要接收服务器推送时，可以主动关闭连接：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 关闭SSE连接</span>
eventSource.<span class="hljs-title function_">close</span>();

<span class="hljs-comment">// 关闭后，readyState会变为2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(eventSource.<span class="hljs-property">readyState</span>); <span class="hljs-comment">// 2 (EventSource.CLOSED)</span>
</code></pre>
<p>这在组件卸载、页面跳转或用户主动停止接收时非常有用。</p>
<h4 data-id="heading-11">EventSource 事件</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 连接成功建立时触发</span>
eventSource.<span class="hljs-property">onopen</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接已建立'</span>, event);
};

<span class="hljs-comment">// 2. 接收到默认消息（未指定event类型的消息）时触发</span>
eventSource.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到消息:'</span>, event.<span class="hljs-property">data</span>);
  <span class="hljs-comment">// 在我们的Demo中，这里会每秒打印一次时间戳</span>
};

<span class="hljs-comment">// 3. 发生错误时触发（包括连接错误、解析错误等）</span>
eventSource.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'SSE连接错误:'</span>, error);
  <span class="hljs-comment">// 注意：浏览器会自动尝试重连，无需手动处理</span>
};
</code></pre>
<p>除了默认的 <code>message</code> 事件，我们还可以监听服务器发送的自定义事件：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 监听我们Demo中发送的'connecttime'事件</span>
eventSource.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'connecttime'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接时间:'</span>, event.<span class="hljs-property">data</span>);
  <span class="hljs-comment">// 输出："连接时间: 连接建立于 2024-01-15T10:30:00.000Z"</span>
});
</code></pre>
<h4 data-id="heading-12">EventSource 的局限性</h4>
<p>尽管 <code>EventSource</code> 简单易用，但它有一些限制：</p>
<ul>
<li><strong>仅支持 GET 请求</strong>：无法使用 POST 或其他方法，参数长度有限</li>
<li><strong>无法自定义请求头</strong>：这意味着无法携带标准的 <code>Authorization: Bearer &lt;token&gt;</code> 等认证信息，限制了其在需要鉴权的API场景中的应用</li>
<li><strong>自动重连机制不可配置</strong>：虽然方便，但有时需要更精细的控制</li>
</ul>
<p>对于需要更多控制权的场景（如需要发送认证头、使用POST方法等），我们可以使用 <code>fetch()</code> API 配合流式处理来接收 SSE，这也是现代 AI 应用中更常见的做法。接下来，我们将深入探讨这种方法。</p>
<h2 data-id="heading-13">处理数据流：JS 中的流式处理能力</h2>
<blockquote>
<p>💡 <strong>前置知识提示</strong>：本节将介绍流式处理所需的 JavaScript 基础。如果你已熟悉迭代器、生成器和 TextDecoder，可快速浏览或跳过。</p>
</blockquote>
<p>严格来说，下面这些JS API本身并非专为“流式处理”而生，但它们组合起来构成了处理流数据的强大能力。</p>
<p>我们可以将其视为一个处理管道：首先需要理解数据流的<strong>基础协议</strong>（迭代器/生成器）；然后掌握浏览器中<strong>网络数据流</strong>的具体实现（ReadableStream）及其<strong>消费语法</strong>（<code>for await...of</code>）；最后，还需要一个工具将原始的二进制流<strong>转换</strong>为我们需要的文本（TextDecoder）。</p>
<p>下面，我们就按照这个管道的顺序，逐一拆解。</p>
<h3 data-id="heading-14">数据流的基础：迭代器与生成器</h3>
<p>在理解 JavaScript 中的流式处理之前，我们需要先掌握两个基础概念：<strong>迭代器（Iterator）</strong>  和<strong>生成器（Generator）</strong> 。它们是 ES6 引入的现代化数据处理机制，构成了流式处理的底层基础。</p>
<h4 data-id="heading-15">什么是迭代器？</h4>
<p>迭代器是一个<strong>实现了 Iterator 接口</strong>的对象。该接口要求对象必须提供 <code>next()</code> 方法，每次调用返回一个包含两个属性的对象：</p>
<ul>
<li><code>value</code>：迭代序列中的下一个值</li>
<li><code>done</code>：布尔值，表示序列是否结束</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 简单的迭代器示例</span>
<span class="hljs-keyword">const</span> simpleIterator = {
  <span class="hljs-attr">data</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>],
  <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
  <span class="hljs-title function_">next</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>++], <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> };
    }
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">value</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> };
  }
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(simpleIterator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 1, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(simpleIterator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 2, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(simpleIterator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 3, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(simpleIterator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: undefined, done: true }</span>
</code></pre>
<h4 data-id="heading-16">异步迭代器：处理异步数据流</h4>
<p>当数据是异步产生时（如网络请求、定时器），我们需要<strong>异步迭代器</strong>。它与普通迭代器类似，但有两点关键区别：</p>
<ol>
<li>对象需要实现 <code>[Symbol.asyncIterator]()</code> 方法而非 <code>[Symbol.iterator]()</code></li>
<li><code>next()</code> 方法返回一个 Promise，而不是直接返回 <code>{value, done}</code></li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 异步迭代器示例</span>
<span class="hljs-keyword">const</span> asyncIterator = {
  <span class="hljs-attr">data</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>],
  <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>,
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">asyncIterator</span>]() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">next</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">length</span>) {
          <span class="hljs-comment">// 返回Promise，模拟异步获取数据</span>
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
              <span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>++], <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> });
            }, <span class="hljs-number">100</span>);
          });
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">value</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> });
      }
    };
  }
};
</code></pre>
<p><strong>关键点</strong>：异步迭代器的 <code>next()</code> 返回的是 <code>Promise&lt;{value, done}&gt;</code>，这使得它能够被 <code>for await...of</code> 循环消费。<strong>这正是我们后续处理网络流（如SSE响应）所依赖的底层协议</strong>。</p>
<h4 data-id="heading-17">可迭代对象</h4>
<p>任何实现了 <strong><code>[Symbol.iterator]()</code></strong> 方法的对象都是<strong>可迭代对象</strong>。这个方法必须返回一个迭代器。</p>
<p>这里的 <code>Symbol.iterator</code> 是 ES6 引入的一个特殊 Symbol，用于定义对象的默认迭代器。<code>[Symbol.iterator]</code> 使用了计算属性名语法，而 <code>[Symbol.iterator]()</code> 是 ES6 中函数属性的简写形式。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> iterableObject = {
  <span class="hljs-attr">values</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>],
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]() {
    <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">next</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">values</span>.<span class="hljs-property">length</span>) {
          <span class="hljs-keyword">return</span> { <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">values</span>[index++], <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> };
        }
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">value</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> };
      }
    };
  }
};

<span class="hljs-comment">// 使用 for...of 遍历可迭代对象</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> iterableObject) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 依次输出: 'a', 'b', 'c'</span>
}
</code></pre>
<p><code>for...of</code> 循环就是基于这个协议工作的：它会自动调用对象的 <code>[Symbol.iterator]()</code> 方法获取迭代器，然后反复调用 <code>next()</code> 直到 <code>done</code> 为 <code>true</code>。</p>
<h4 data-id="heading-18">生成器：惰性数据源</h4>
<p>生成器是 ES6 引入的特殊函数，使用 <code>function*</code> 声明。它<strong>返回一个生成器对象</strong>，该对象同时符合可迭代对象和迭代器的协议。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">numberGenerator</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
  <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
  <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>;
}

<span class="hljs-keyword">const</span> generator = <span class="hljs-title function_">numberGenerator</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(generator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 1, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(generator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 2, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(generator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 3, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(generator.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: undefined, done: true }</span>

<span class="hljs-comment">// 生成器对象也是可迭代的</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> num <span class="hljs-keyword">of</span> <span class="hljs-title function_">numberGenerator</span>()) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num); <span class="hljs-comment">// 依次输出: 1, 2, 3</span>
}
</code></pre>
<p>生成器的 <code>yield</code> 关键字具有<strong>暂停和恢复</strong>执行的能力。每次调用 <code>next()</code>，函数会执行到下一个 <code>yield</code> 并暂停，直到再次被调用。这实现了<strong>惰性求值（Lazy Evaluation）</strong> ——数据只在需要时才产生。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">lazySequence</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始生成数据'</span>);
  <span class="hljs-keyword">yield</span> <span class="hljs-string">'第一个数据'</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'继续生成...'</span>);
  <span class="hljs-keyword">yield</span> <span class="hljs-string">'第二个数据'</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'最后生成...'</span>);
  <span class="hljs-keyword">yield</span> <span class="hljs-string">'第三个数据'</span>;
}

<span class="hljs-keyword">const</span> lazyGen = <span class="hljs-title function_">lazySequence</span>();

<span class="hljs-comment">// 注意观察控制台输出时机</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'准备获取数据'</span>);
<span class="hljs-keyword">const</span> first = lazyGen.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// 输出: "开始生成数据"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(first.<span class="hljs-property">value</span>);     <span class="hljs-comment">// "第一个数据"</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'做一些其他事情'</span>);
<span class="hljs-keyword">const</span> second = lazyGen.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// 输出: "继续生成..."</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(second.<span class="hljs-property">value</span>);     <span class="hljs-comment">// "第二个数据"</span>
</code></pre>
<h3 data-id="heading-19">网络数据流：ReadableStream 的两种消费方式</h3>
<p>当使用 <code>fetch()</code> 发起网络请求时，响应对象的 <code>body</code> 属性是一个 <strong><code>ReadableStream</code></strong>（可读流）。这个流实现了异步迭代器协议，因此我们可以用两种方式消费它：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 发起请求，获取响应</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/stream'</span>);

<span class="hljs-comment">// 获取响应体的流</span>
<span class="hljs-keyword">const</span> stream = response.<span class="hljs-property">body</span>;
</code></pre>
<h4 data-id="heading-20">方式一：使用 <code>getReader()</code> 手动读取</h4>
<p>这是最基础的方式，提供了完全的控制权：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 获取流读取器</span>
<span class="hljs-keyword">const</span> reader = stream.<span class="hljs-title function_">getReader</span>();

<span class="hljs-comment">// 典型的数据读取模式</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
  
  <span class="hljs-keyword">if</span> (done) {
    <span class="hljs-comment">// 流已结束</span>
    <span class="hljs-keyword">break</span>;
  }
  
  <span class="hljs-comment">// value 是一个 Uint8Array（字节数组）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到数据块:'</span>, value);
}
</code></pre>
<ul>
<li><code>getReader()</code> 返回一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FReadableStreamDefaultReader" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStreamDefaultReader" ref="nofollow noopener noreferrer"><strong>ReadableStreamDefaultReader</strong></a> 对象</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FReadableStreamDefaultReader%2Fread" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStreamDefaultReader/read" ref="nofollow noopener noreferrer"><strong>reader.read()</strong></a> 返回 <code>Promise&lt;{done, value}&gt;</code></li>
<li><code>value</code> 是 <code>Uint8Array</code> 类型，包含原始字节数据</li>
<li>需要手动管理循环和资源释放</li>
</ul>
<h4 data-id="heading-21">方式二：使用 <code>for await...of</code> 自动迭代</h4>
<p>更现代、简洁的方式是直接使用 <code>for await...of</code> 循环遍历 <code>ReadableStream</code> 本身，因为流对象已经实现了异步迭代器协议。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 直接使用 for await...of 遍历 ReadableStream</span>
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
  <span class="hljs-comment">// chunk 同样是 Uint8Array 数据块</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到数据块:'</span>, chunk);
}
</code></pre>
<p><code>for await...of</code> 是基于异步迭代器协议的语法糖。当用于遍历 <code>ReadableStream</code> 时，它会在内部自动创建读取器、调用 <code>read()</code> 方法，并在循环结束时妥善处理资源的释放。</p>
<p><strong>这种“来一块，处理一块”的消费模式，与异步生成器的工作方式如出一辙</strong>。我们可以用一个异步生成器来模拟 AI 的流式响应：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 模拟 AI 流式响应：每秒生成一个 token</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title function_">mockAIStream</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> tokens = [<span class="hljs-string">"思考"</span>, <span class="hljs-string">"中"</span>, <span class="hljs-string">"，"</span>, <span class="hljs-string">"这"</span>, <span class="hljs-string">"是"</span>, <span class="hljs-string">"一个"</span>, <span class="hljs-string">"流式"</span>, <span class="hljs-string">"响应"</span>];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> token <span class="hljs-keyword">of</span> tokens) {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>)); <span class="hljs-comment">// 模拟 AI 处理延迟</span>
    <span class="hljs-keyword">yield</span> token; <span class="hljs-comment">// 每次只生成一个 token</span>
  }
}

<span class="hljs-comment">// 消费流式数据：来一点，处理一点</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processStream</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> token <span class="hljs-keyword">of</span> <span class="hljs-title function_">mockAIStream</span>()) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`收到: <span class="hljs-subst">${token}</span>`</span>);
    <span class="hljs-comment">// 这里可以实时渲染到页面，实现"逐词（Token）打印"效果</span>
  }
}

<span class="hljs-comment">// 在控制台执行 processStream() 试试</span>
</code></pre>
<h3 data-id="heading-22">解析二进制流：TextDecoder</h3>
<p>网络传输的本质是二进制数据。当我们需要将这些字节转换为字符串时，会遇到一个关键问题：<strong>数据块（chunk）的边界，可能与字符的编码边界不一致。</strong></p>
<p>JavaScript 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FTextDecoder" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/TextDecoder" ref="nofollow noopener noreferrer">TextDecoder</a> 就是为解决此问题而生。它能将字节流按指定编码（如 UTF-8）解码为字符串。</p>
<h4 data-id="heading-23">为什么普通的解码会出问题？</h4>
<p>以中文字符“你”为例。在 UTF-8 编码中，它由 <strong>三个字节</strong> 构成，对应的十六进制值是 <code>[0xE4, 0xBD, 0xA0]</code>。</p>
<p>想象一下网络传输场景：服务器发出这个字符的字节，但可能因为网络分包，前两个字节 <code>[0xE4, 0xBD]</code> 到达了第一个数据块，而最后一个字节 <code>[0xA0]</code> 落在了第二个数据块。</p>
<p>如果对第一个块单独进行解码，由于缺少构成一个完整字符的必要字节，解码器要么输出乱码（�），要么直接抛出错误。这显然不是我们想要的。</p>
<h4 data-id="heading-24">解决方案：流式解码（Stream Decoding）</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FTextDecoder%2Fdecode" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/TextDecoder/decode" ref="nofollow noopener noreferrer"><code>TextDecoder.decode()</code></a> 方法的第二个参数有一个关键的 <code>stream</code> 选项。当设置为 <code>true</code> 时，解码器会进入“流模式”：</p>
<ul>
<li><strong>它会记住（缓冲）当前不完整的字节序列</strong>，而不是强行解码。</li>
<li><strong>等待后续数据块到来</strong>，与缓冲的字节拼凑成一个完整的字符后，再一并输出。</li>
</ul>
<p>这样，无论网络如何分割数据，我们都能在应用层获得完整、正确的字符串。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);

<span class="hljs-comment">// 模拟被分割到两个网络数据块中的字符</span>
<span class="hljs-keyword">const</span> chunk1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0xe4</span>, <span class="hljs-number">0xbd</span>]); <span class="hljs-comment">// 这是“你”字的前2/3</span>
<span class="hljs-keyword">const</span> chunk2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">0xa0</span>, <span class="hljs-number">0xe5</span>, <span class="hljs-number">0xa5</span>, <span class="hljs-number">0xbd</span>]); <span class="hljs-comment">// 这是“你”的最后1/3，以及整个“好”字</span>

<span class="hljs-comment">// 处理第一块：告知解码器“数据还没完，先存着”</span>
<span class="hljs-keyword">let</span> part1 = decoder.<span class="hljs-title function_">decode</span>(chunk1, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(part1); <span class="hljs-comment">// 输出："" (空字符串，解码器在等待)</span>

<span class="hljs-comment">// 处理第二块（也是最后一块）：告知解码器“数据到结尾了，把攒着的都解出来”</span>
<span class="hljs-keyword">let</span> part2 = decoder.<span class="hljs-title function_">decode</span>(chunk2, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">false</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(part2); <span class="hljs-comment">// 输出："你好" (两个完整字符被正确解码)</span>
</code></pre>
<p>至此，我们已经掌握了流式处理的完整技术链条：从<strong>迭代器/生成器</strong>这一底层概念，到<strong>ReadableStream</strong>和<code>for await...of</code>这对获取与消费网络流的黄金组合，再到正确解码二进制数据的<strong>TextDecoder</strong>。</p>
<p>在下一节的实战中，我们将把这些知识组合起来，真正实现一个能够“逐词（Token）打印”的流式AI聊天应用。</p>
<h2 data-id="heading-25">实战：构建完整的流式聊天响应</h2>
<h3 data-id="heading-26">初始代码</h3>
<p>让我们基于上一章 <a href="https://juejin.cn/post/7574370234070024246" target="_blank" title="https://juejin.cn/post/7574370234070024246">《前端玩转 AI 应用开发｜30行代码实现聊天机器人🤖》</a> 中的代码进行优化，实现流式输出：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> readline <span class="hljs-keyword">from</span> <span class="hljs-string">'readline'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_KEY</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">API_KEY</span>;
<span class="hljs-keyword">const</span> messages = [
  {
    <span class="hljs-attr">role</span>: <span class="hljs-string">'system'</span>,
    <span class="hljs-attr">content</span>:
      <span class="hljs-string">'你是一个前端高手，能帮我解答前端开发中遇到的问题。我希望你的回答精简干练有技术范'</span>,
  },
];
<span class="hljs-comment">// 主对话循环</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-comment">// 用户输入</span>
  <span class="hljs-keyword">const</span> input = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> rl = readline.<span class="hljs-title function_">createInterface</span>({
      <span class="hljs-attr">input</span>: process.<span class="hljs-property">stdin</span>,
      <span class="hljs-attr">output</span>: process.<span class="hljs-property">stdout</span>,
    });
    rl.<span class="hljs-title function_">question</span>(<span class="hljs-string">'用户: '</span>, <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(msg);
      rl.<span class="hljs-title function_">close</span>();
    });
  });
  messages.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: input });
  
  <span class="hljs-comment">// 调用AI助手</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(
    <span class="hljs-string">'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions'</span>,
    {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
        <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${API_KEY}</span>`</span>, <span class="hljs-comment">// 使用API_KEY进行授权</span>
      },
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">'qwen-plus'</span>, messages }),
    }
  );
  
  <span class="hljs-comment">// 解析AI助手的回复</span>
  <span class="hljs-keyword">const</span> reply = (<span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>()).<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>;
  messages.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">'assistant'</span>, <span class="hljs-attr">content</span>: reply });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'AI助手:'</span>, reply + <span class="hljs-string">'\n'</span>);
}
</code></pre>
<p>代码分为三个主要模块：</p>
<ol>
<li><strong>用户输入</strong>：通过 <code>readline</code> 获取用户问题</li>
<li><strong>调用AI助手</strong>：向 API 发送请求</li>
<li><strong>解析回复</strong>：等待完整响应并解析结果</li>
</ol>
<p>显然，要实现流式输出的核心工作集中在 <strong>第三部分</strong>。我们需要将同步的 <code>res.json()</code> 解析改为异步的流式处理，让 AI 的回答能够"<strong>逐词（Token）</strong>"实时显示。这正是我们将要进行的改造。</p>
<h3 data-id="heading-27">启用流式响应并观察原始数据</h3>
<p>首先，我们需要在请求中启用流式响应。将 <code>stream: true</code> 添加到请求体中：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 调用AI助手</span>
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(
  <span class="hljs-string">'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions'</span>,
  {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${API_KEY}</span>`</span>,
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-string">'qwen-plus'</span>,
      messages,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用流式响应</span>
    }),
  }
);
</code></pre>
<p>现在 API 将以 SSE 格式返回数据流，而不是一次性返回完整 JSON。为了理解数据格式，我们首先观察原始数据：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 解析AI助手的回复</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'AI助手: '</span>);

<span class="hljs-comment">// 获取响应体的 reader，用于读取流数据</span>
<span class="hljs-keyword">const</span> reader = res.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();

<span class="hljs-comment">// 循环读取数据块</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-comment">// 读取下一个数据块</span>
  <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();

  <span class="hljs-comment">// 如果流结束，退出循环</span>
  <span class="hljs-keyword">if</span> (done) {
    <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-comment">// 打印原始二进制数据块信息</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[STREAM_DEBUG] 收到数据块，大小: <span class="hljs-subst">${value.length}</span> 字节`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[STREAM_DEBUG] 原始数据(前50字节):`</span>, value.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">50</span>));
}
</code></pre>
<p>运行代码后，可以看到类似下图的二进制数据返回：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9020c68f899f44d3b85eb08361932d59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOo5Y2r5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785426&amp;x-signature=7%2FLYXH01Y41mnYSMYIqFmwikTMY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-28">使用 TextDecoder 解码二进制数据为文本</h3>
<p>现在我们使用上一章学到的 <code>TextDecoder</code>，将二进制数据转换为可读的文本：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'AI助手: '</span>);

<span class="hljs-comment">// 创建 TextDecoder 用于解码二进制数据</span>
<span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);

<span class="hljs-comment">// 获取响应体的 reader，用于读取流数据</span>
<span class="hljs-keyword">const</span> reader = res.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();

<span class="hljs-comment">// 循环读取数据块</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();

  <span class="hljs-keyword">if</span> (done) {
    <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-comment">// 关键步骤：使用 TextDecoder 解码二进制数据为文本</span>
  <span class="hljs-comment">// stream: true 表示这是流式解码，会保留不完整的字符等待下一块数据</span>
  <span class="hljs-keyword">const</span> text = decoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[STREAM_DEBUG] 解码后的文本:'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(text);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[STREAM_DEBUG] ===== 数据块结束 =====\n'</span>);
}
</code></pre>
<p>对比第一步和第二步的输出，你会发现：</p>
<ul>
<li><strong>第一步</strong>：看到的是 <code>Uint8Array(50) [100, 97, 116, 97, ...]</code> 这样的数字</li>
<li><strong>第二步</strong>：看到的是 <code>data: {...}</code> 这样可读的文本</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/938bd201e4b34471a4e52c6b8d27eadc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOo5Y2r5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785426&amp;x-signature=fRhb%2Fg70xMnWoMJjYOtXo%2FCM28A%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-29">解析 SSE 格式，提取 AI 回复内容</h3>
<p>现在我们已经拿到了可读的文本流。从上面的截图可以看到，每个数据块（chunk）都包含若干行完整、独立的 SSE 消息，每行都以 <code>data:</code> 开头。</p>
<p><strong>我们的任务变得非常清晰</strong>：从解码后的文本中，准确拆出每一行 <code>data:</code> 消息，并提取其 JSON 中包含的 AI 回复片段（Token）。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 解析AI助手的回复</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'AI助手: '</span>);

<span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
<span class="hljs-keyword">const</span> reader = res.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();

<span class="hljs-comment">// 循环读取数据块</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
  <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;

  <span class="hljs-comment">// 解码二进制数据为文本</span>
  <span class="hljs-keyword">const</span> text = decoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });

  <span class="hljs-comment">// 第三步：解析 SSE 格式数据</span>
  <span class="hljs-comment">// SSE 消息以换行符分隔，按行处理</span>
  <span class="hljs-keyword">const</span> lines = text.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">line</span>) =&gt;</span> line.<span class="hljs-title function_">trim</span>());

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
    <span class="hljs-comment">// 提取 data: 开头的内容</span>
    <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data: '</span>)) {
      <span class="hljs-keyword">const</span> data = line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>); <span class="hljs-comment">// 去掉 "data: " 前缀</span>

      <span class="hljs-comment">// 打印提取出的数据</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
    }
  }
}
</code></pre>
<p>这段代码执行后，我们将看到如下图所示的输出——干净、完整的 JSON 字符串。这些 JSON 对象包含了 AI 返回的每个文本片段，是我们实现逐字输出的关键数据源：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00c2e2438b2c4ae8ac5a29689b34f10d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOo5Y2r5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785426&amp;x-signature=psVUYMtTulai12ymVqe8%2B8V7qt0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-30">使用 for await...of 简化流处理并实现逐 token 输出</h3>
<p>经过前三步的分解，我们对流式处理的每个环节都有了清晰理解。现在，让我们将这些知识整合起来，用更现代的 <code>for await...of</code> 语法重构代码，并最终实现 AI 回复的"逐词"实时输出。</p>
<p>对比之前的 <code>while</code> 循环，<code>for await...of</code> 让流式处理代码更加简洁直观：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 解析AI助手的回复</span>
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'AI助手: '</span>);

  <span class="hljs-comment">// 创建 TextDecoder 用于解码二进制数据</span>
  <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);

  <span class="hljs-comment">// 用于累积完整回复</span>
  <span class="hljs-keyword">let</span> reply = <span class="hljs-string">''</span>;

  <span class="hljs-comment">// 使用 for await...of 遍历流数据 (更简洁的写法)</span>
  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> res.<span class="hljs-property">body</span>) {
    <span class="hljs-comment">// 解码二进制数据为文本</span>
    <span class="hljs-keyword">const</span> text = decoder.<span class="hljs-title function_">decode</span>(chunk, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });

    <span class="hljs-comment">// 解析 SSE 格式并提取 AI 回复内容</span>
    <span class="hljs-keyword">const</span> lines = text.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">line</span>) =&gt;</span> line.<span class="hljs-title function_">trim</span>());

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
      <span class="hljs-comment">// 提取 data: 开头的内容</span>
      <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data: '</span>)) {
        <span class="hljs-keyword">const</span> data = line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>); <span class="hljs-comment">// 去掉 "data: " 前缀</span>

        <span class="hljs-comment">// 处理结束标记</span>
        <span class="hljs-keyword">if</span> (data === <span class="hljs-string">'[DONE]'</span>) {
          <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 解析 JSON 数据</span>
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);
          <span class="hljs-comment">// 提取 AI 返回的文本片段 (token)</span>
          <span class="hljs-keyword">const</span> token = json.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span>?.<span class="hljs-property">content</span> || <span class="hljs-string">''</span>;

          <span class="hljs-comment">// 实现逐字输出效果</span>
          process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(token);

          <span class="hljs-comment">// 累积完整回复</span>
          reply += token;
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'\nJSON 解析错误:'</span>, error.<span class="hljs-property">message</span>);
        }
      }
    }
  }

  <span class="hljs-comment">// 输出换行,结束本次回复</span>
  process.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'\n\n'</span>);
</code></pre>
<p>实现逐字输出效果后，AI的回复将像下图一样实时呈现，大幅提升了交互体验：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5059f7151b0e4aebbd3835baa662b4ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOo5Y2r5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765785426&amp;x-signature=AioVS9KWxluaYT7SYcL8a8qPKAA%3D" alt="录屏2025-12-08 15.27.05 (1).gif" loading="lazy"/></p>
<h2 data-id="heading-31">参考链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fserver-sent-events.html%23server-sent-events" target="_blank" title="https://html.spec.whatwg.org/multipage/server-sent-events.html#server-sent-events" ref="nofollow noopener noreferrer">服务器发送事件 - HTML标准</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2017%2F05%2Fserver-sent_events.html" target="_blank" title="https://www.ruanyifeng.com/blog/2017/05/server-sent_events.html" ref="nofollow noopener noreferrer">Server-Sent Events 教程 - 阮一峰的网络日志</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2F" target="_blank" title="https://developer.mozilla.org/zh-CN/" ref="nofollow noopener noreferrer">MDN Web Docs</a></li>
<li>《JavaScript高级程序设计》</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在Python多进程中避免死锁问题？]]></title>    <link>https://juejin.cn/post/7580971667037585434</link>    <guid>https://juejin.cn/post/7580971667037585434</guid>    <pubDate>2025-12-08T06:18:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580971667037585434" data-draft-id="7581004702945624091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在Python多进程中避免死锁问题？"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-08T06:18:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三维空间"/> <meta itemprop="url" content="https://juejin.cn/user/3731069876053802"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在Python多进程中避免死锁问题？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3731069876053802/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三维空间
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:18:14.000Z" title="Mon Dec 08 2025 06:18:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>死锁是Python多进程开发中最容易踩的坑之一，一旦出现会导致进程卡死、程序无响应，甚至需要强制终止才能恢复。</p>
<h2 data-id="heading-0">一、先搞懂：多进程死锁到底是什么？</h2>
<h3 data-id="heading-1">1. 死锁的核心定义</h3>
<p>死锁是指<strong>两个或多个进程</strong>互相持有对方需要的锁（或资源），且都不释放自己持有的锁，导致所有进程都陷入“等待对方释放资源”的无限阻塞状态。</p>
<h3 data-id="heading-2">2. 死锁产生的4个必要条件（缺一不可）</h3>
<p>只有同时满足以下4个条件，才会触发死锁，打破任意一个条件就能避免死锁：</p>
<ul>
<li><strong>互斥条件</strong>：资源（如锁、文件）只能被一个进程占用；</li>
<li><strong>请求与保持条件</strong>：进程持有一个资源的同时，又请求另一个被占用的资源；</li>
<li><strong>不剥夺条件</strong>：进程已持有的资源不能被强制剥夺，只能主动释放；</li>
<li><strong>循环等待条件</strong>：多个进程形成“你等我、我等你”的循环等待链。</li>
</ul>
<h3 data-id="heading-3">3. 多进程死锁典型场景（新手高频踩坑）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> multiprocessing
<span class="hljs-keyword">import</span> time

 场景：两个进程互相等待对方的锁
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process1</span>(<span class="hljs-params">lock1, lock2</span>):
     进程<span class="hljs-number">1</span>先拿lock1，再尝试拿lock2
    lock1.acquire()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程1获取了lock1，等待lock2..."</span>)
    time.sleep(<span class="hljs-number">1</span>)   放大死锁概率
    lock2.acquire()   此时lock2已被进程<span class="hljs-number">2</span>持有，进程<span class="hljs-number">1</span>阻塞
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程1获取了lock2，执行任务"</span>)
    lock1.release()
    lock2.release()

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process2</span>(<span class="hljs-params">lock1, lock2</span>):
     进程<span class="hljs-number">2</span>先拿lock2，再尝试拿lock1
    lock2.acquire()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程2获取了lock2，等待lock1..."</span>)
    time.sleep(<span class="hljs-number">1</span>)
    lock1.acquire()   此时lock1已被进程<span class="hljs-number">1</span>持有，进程<span class="hljs-number">2</span>阻塞
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程2获取了lock1，执行任务"</span>)
    lock1.release()
    lock2.release()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    lock1 = multiprocessing.Lock()
    lock2 = multiprocessing.Lock()
    
    p1 = multiprocessing.Process(target=process1, args=(lock1, lock2))
    p2 = multiprocessing.Process(target=process2, args=(lock1, lock2))
    
    p1.start()
    p2.start()
    p1.join()
    p2.join()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"程序结束"</span>)   永远不会执行到这一行
</code></pre>
<p><strong>现象</strong>：程序输出“进程1获取了lock1，等待lock2...”和“进程2获取了lock2，等待lock1...”后卡死，无法继续执行。</p>
<h2 data-id="heading-4">二、避免死锁的6个核心策略（从易到难）</h2>
<h3 data-id="heading-5">1. 策略1：使用<code>with</code>语句自动释放锁（最推荐）</h3>
<p><code>with</code>语句会在代码块执行完成后<strong>自动释放锁</strong>，即使代码抛出异常也能保证锁释放，从根本上避免“忘记release()”导致的死锁。</p>
<h4 data-id="heading-6">修复上述死锁案例（仅改锁的使用方式）：</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">process1</span>(<span class="hljs-params">lock1, lock2</span>):
    <span class="hljs-keyword">with</span> lock1:   自动acquire()，代码块结束自动release()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程1获取了lock1，等待lock2..."</span>)
        time.sleep(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">with</span> lock2:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程1获取了lock2，执行任务"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process2</span>(<span class="hljs-params">lock1, lock2</span>):
    <span class="hljs-keyword">with</span> lock2:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程2获取了lock2，等待lock1..."</span>)
        time.sleep(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">with</span> lock1:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程2获取了lock1，执行任务"</span>)
</code></pre>
<p>⚠️ 注意：这个修改仅解决“锁未释放”的问题，但上述场景仍会因“循环等待”触发死锁，需结合策略2使用。</p>
<h3 data-id="heading-7">2. 策略2：统一锁的获取顺序（打破循环等待）</h3>
<p>死锁的核心诱因之一是“进程获取锁的顺序不一致”，只要让所有进程按<strong>相同的顺序</strong>获取锁，就能打破循环等待条件。</p>
<h4 data-id="heading-8">最终修复死锁案例：</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">process1</span>(<span class="hljs-params">lock1, lock2</span>):
     统一先拿lock1，再拿lock2
    <span class="hljs-keyword">with</span> lock1:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程1获取了lock1，等待lock2..."</span>)
        time.sleep(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">with</span> lock2:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程1获取了lock2，执行任务"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process2</span>(<span class="hljs-params">lock1, lock2</span>):
     同样先拿lock1，再拿lock2（不再先拿lock2）
    <span class="hljs-keyword">with</span> lock1:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程2获取了lock1，等待lock2..."</span>)
        time.sleep(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">with</span> lock2:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程2获取了lock2，执行任务"</span>)
</code></pre>
<p><strong>执行结果</strong>：进程1先获取lock1，进程2等待lock1；进程1执行完成释放锁后，进程2获取lock1和lock2，无死锁。</p>
<h3 data-id="heading-9">3. 策略3：给锁添加超时时间（避免无限等待）</h3>
<p><code>multiprocessing.Lock</code>本身不支持超时，但可使用<code>multiprocessing.RLock</code>（可重入锁）或<code>threading.Lock</code>（多进程中需通过Manager传递）的<code>acquire(timeout)</code>方法，设置超时时间，超时后放弃获取锁，避免无限阻塞。</p>
<h4 data-id="heading-10">示例：带超时的锁获取</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> multiprocessing
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process1</span>(<span class="hljs-params">lock1, lock2</span>):
     获取lock1，超时时间<span class="hljs-number">3</span>秒
    <span class="hljs-keyword">if</span> lock1.acquire(timeout=<span class="hljs-number">3</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程1获取了lock1，等待lock2..."</span>)
        time.sleep(<span class="hljs-number">1</span>)
         获取lock2，超时时间<span class="hljs-number">3</span>秒
        <span class="hljs-keyword">if</span> lock2.acquire(timeout=<span class="hljs-number">3</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程1获取了lock2，执行任务"</span>)
            lock2.release()
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程1获取lock2超时，释放lock1"</span>)
            lock1.release()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程1获取lock1超时"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process2</span>(<span class="hljs-params">lock1, lock2</span>):
    <span class="hljs-keyword">if</span> lock2.acquire(timeout=<span class="hljs-number">3</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程2获取了lock2，等待lock1..."</span>)
        time.sleep(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">if</span> lock1.acquire(timeout=<span class="hljs-number">3</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程2获取了lock1，执行任务"</span>)
            lock1.release()
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程2获取lock1超时，释放lock2"</span>)
            lock2.release()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"进程2获取lock2超时"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
     通过Manager创建支持超时的锁
    manager = multiprocessing.Manager()
    lock1 = manager.Lock()
    lock2 = manager.Lock()
    
    p1 = multiprocessing.Process(target=process1, args=(lock1, lock2))
    p2 = multiprocessing.Process(target=process2, args=(lock1, lock2))
    
    p1.start()
    p2.start()
    p1.join()
    p2.join()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"程序结束"</span>)
</code></pre>
<p><strong>执行结果</strong>：进程1获取lock1，进程2获取lock2；双方等待对方的锁超时后，释放自己持有的锁，程序正常结束，无死锁。</p>
<h3 data-id="heading-11">4. 策略4：减少锁的使用范围（最小化锁持有时间）</h3>
<p>只在“必须保护共享资源”的代码块加锁，执行完核心逻辑后立即释放锁，缩短锁的持有时间，降低多个进程同时争用锁的概率。</p>
<h4 data-id="heading-12">反面案例（锁持有时间过长）：</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_file</span>(<span class="hljs-params">num, lock</span>):
    lock.acquire()
     非核心逻辑（耗时），却持有锁
    time.sleep(<span class="hljs-number">5</span>)   模拟耗时操作
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"a"</span>) <span class="hljs-keyword">as</span> f:
        f.write(<span class="hljs-string">f"进程<span class="hljs-subst">{num}</span>写入\n"</span>)
    lock.release()
</code></pre>
<h4 data-id="heading-13">正面案例（仅核心逻辑加锁）：</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_file</span>(<span class="hljs-params">num, lock</span>):
     非核心逻辑（耗时），不持有锁
    time.sleep(<span class="hljs-number">5</span>)
     仅写入文件时加锁
    <span class="hljs-keyword">with</span> lock:
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"a"</span>) <span class="hljs-keyword">as</span> f:
            f.write(<span class="hljs-string">f"进程<span class="hljs-subst">{num}</span>写入\n"</span>)
</code></pre>
<h3 data-id="heading-14">5. 策略5：使用单锁替代多锁（简化资源竞争）</h3>
<p>如果多个锁的作用是保护同一类共享资源（如多个文件都属于“数据文件”），可合并为一个全局锁，避免多锁嵌套导致的死锁。</p>
<h4 data-id="heading-15">示例：单锁替代多锁</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> multiprocessing
<span class="hljs-keyword">import</span> time

 全局锁（替代多个文件锁）
global_lock = multiprocessing.Lock()

 写入文件A
<span class="hljs-keyword">def</span> <span class="hljs-title function_">write_file_a</span>(<span class="hljs-params">num</span>):
    <span class="hljs-keyword">with</span> global_lock:
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"file_a.txt"</span>, <span class="hljs-string">"a"</span>) <span class="hljs-keyword">as</span> f:
            f.write(<span class="hljs-string">f"进程<span class="hljs-subst">{num}</span>写入文件A\n"</span>)
            time.sleep(<span class="hljs-number">1</span>)

 写入文件B
<span class="hljs-keyword">def</span> <span class="hljs-title function_">write_file_b</span>(<span class="hljs-params">num</span>):
    <span class="hljs-keyword">with</span> global_lock:
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"file_b.txt"</span>, <span class="hljs-string">"a"</span>) <span class="hljs-keyword">as</span> f:
            f.write(<span class="hljs-string">f"进程<span class="hljs-subst">{num}</span>写入文件B\n"</span>)
            time.sleep(<span class="hljs-number">1</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    p1 = multiprocessing.Process(target=write_file_a, args=(<span class="hljs-number">1</span>,))
    p2 = multiprocessing.Process(target=write_file_b, args=(<span class="hljs-number">2</span>,))
    p1.start()
    p2.start()
    p1.join()
    p2.join()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"写入完成"</span>)
</code></pre>
<h3 data-id="heading-16">6. 策略6：使用死锁检测工具（进阶）</h3>
<p>对于复杂的多进程场景，可通过工具检测潜在的死锁：</p>
<ul>
<li><strong>内置工具</strong>：<code>multiprocessing.active_children()</code>查看活跃进程，结合日志定位阻塞的进程；</li>
<li><strong>第三方工具</strong>：<code>py-spy</code>（进程分析工具），可实时查看进程调用栈，定位死锁位置：
<pre><code class="hljs language-bash" lang="bash"> 安装py-spy
pip install py-spy
 分析进程（替换为你的进程ID）
py-spy dump --pid 12345
</code></pre>
</li>
</ul>
<h2 data-id="heading-17">三、死锁排查：快速定位问题的3个方法</h2>
<ol>
<li><strong>查看进程状态</strong>：用<code>ps -ef | grep python</code>查看进程是否处于“D状态”（不可中断睡眠，大概率死锁）；</li>
<li><strong>添加日志</strong>：在每个<code>acquire()</code>和<code>release()</code>前后打印日志，定位哪个锁导致阻塞；</li>
<li><strong>简化场景</strong>：将复杂的多进程逻辑拆分为最小可复现的demo，逐步排查死锁诱因。</li>
</ol>
<h2 data-id="heading-18">四、总结：避免死锁的核心原则</h2>
<ol>
<li><strong>自动释放</strong>：优先用<code>with</code>语句管理锁，杜绝“忘记release()”；</li>
<li><strong>顺序一致</strong>：所有进程按相同顺序获取多把锁，打破循环等待；</li>
<li><strong>超时兜底</strong>：给锁添加超时时间，避免无限阻塞；</li>
<li><strong>最小持有</strong>：仅在核心逻辑加锁，缩短锁的持有时间；</li>
<li><strong>简化锁结构</strong>：能用单锁就不用多锁，减少嵌套争用。</li>
</ol>
<p>遵循这些原则，99%的多进程死锁问题都能被规避。新手建议从“<code>with</code>语句+统一锁顺序”这两个最基础的策略入手，先保证程序无死锁，再根据场景优化性能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python并发编程实操教程：多线程/多进程/异步全解析]]></title>    <link>https://juejin.cn/post/7580940585692905510</link>    <guid>https://juejin.cn/post/7580940585692905510</guid>    <pubDate>2025-12-08T06:29:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580940585692905510" data-draft-id="7581099904324370458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python并发编程实操教程：多线程/多进程/异步全解析"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-08T06:29:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冤大头编程之路"/> <meta itemprop="url" content="https://juejin.cn/user/1848709609694988"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python并发编程实操教程：多线程/多进程/异步全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1848709609694988/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冤大头编程之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:29:50.000Z" title="Mon Dec 08 2025 06:29:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>并发编程是Python提升程序执行效率的核心技能，不管是处理IO密集型任务（如网络请求、文件读写），还是CPU密集型任务（如数据计算、矩阵运算），掌握并发都能让程序“跑更快”。</p>
<h2 data-id="heading-0">一、核心认知：并发vs并行（新手必懂）</h2>
<p>很多人容易混淆“并发”和“并行”，先理清核心区别：</p>




















<table><thead><tr><th>概念</th><th>核心定义</th><th>适用场景</th></tr></thead><tbody><tr><td>并发（Concurrency）</td><td>多个任务<strong>交替执行</strong>（同一时间只有一个任务在跑），看似“同时进行”</td><td>IO密集型任务（等待时间长）</td></tr><tr><td>并行（Parallelism）</td><td>多个任务<strong>真正同时执行</strong>（利用多核CPU），物理上的“同时进行”</td><td>CPU密集型任务（计算量大）</td></tr></tbody></table>
<p>Python实现并发/并行的三大核心方式：</p>
<ul>
<li><strong>多线程（threading）</strong>：并发，适合IO密集型任务；</li>
<li><strong>多进程（multiprocessing）</strong>：并行，适合CPU密集型任务；</li>
<li><strong>异步IO（asyncio）</strong>：单线程并发，极致优化IO密集型任务。</li>
</ul>
<h2 data-id="heading-1">二、多线程：IO密集型任务首选（threading模块）</h2>
<h3 data-id="heading-2">1. 核心原理</h3>
<p>线程是进程内的执行单元，共享进程内存空间，切换开销小。Python的<code>threading</code>模块实现多线程，但受GIL（全局解释器锁）限制，同一时间只有一个线程执行Python字节码——因此多线程仅对“等待型”IO任务有效（如网络请求、文件读写）。</p>
<h3 data-id="heading-3">2. 基础用法：创建和启动线程</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> time

 定义线程执行的函数（模拟IO任务：网络请求）
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_url</span>(<span class="hljs-params">url, delay</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"线程<span class="hljs-subst">{threading.current_thread().name}</span>：开始请求<span class="hljs-subst">{url}</span>"</span>)
    time.sleep(delay)   模拟网络等待
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"线程<span class="hljs-subst">{threading.current_thread().name}</span>：<span class="hljs-subst">{url}</span>请求完成"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    start_time = time.time()
    
     创建<span class="hljs-number">2</span>个线程
    t1 = threading.Thread(target=fetch_url, args=(<span class="hljs-string">"https://baidu.com"</span>, <span class="hljs-number">2</span>), name=<span class="hljs-string">"t1"</span>)
    t2 = threading.Thread(target=fetch_url, args=(<span class="hljs-string">"https://github.com"</span>, <span class="hljs-number">2</span>), name=<span class="hljs-string">"t2"</span>)
    
     启动线程
    t1.start()
    t2.start()
    
     等待线程结束（主进程阻塞）
    t1.join()
    t2.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时：<span class="hljs-subst">{time.time() - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
</code></pre>
<p><strong>执行结果</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">线程t1：开始请求https:<span class="hljs-comment">//baidu.com</span>
线程t2：开始请求https:<span class="hljs-comment">//github.com</span>
线程t1：https:<span class="hljs-comment">//baidu.com请求完成</span>
线程t2：https:<span class="hljs-comment">//github.com请求完成</span>
总耗时：<span class="hljs-number">2.01</span>秒
</code></pre>
<p>（单线程执行需4秒，多线程仅需2秒，体现IO任务并发优势）</p>
<h3 data-id="heading-4">3. 实用进阶：线程池（ThreadPoolExecutor）</h3>
<p>手动创建大量线程会导致资源耗尽，<code>concurrent.futures.ThreadPoolExecutor</code>（高层封装）可限制线程数量、复用线程，是批量IO任务的首选。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_url</span>(<span class="hljs-params">url, delay</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始请求<span class="hljs-subst">{url}</span>"</span>)
    time.sleep(delay)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{url}</span>请求完成"</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    start_time = time.time()
    urls = [
        (<span class="hljs-string">"https://baidu.com"</span>, <span class="hljs-number">2</span>),
        (<span class="hljs-string">"https://github.com"</span>, <span class="hljs-number">2</span>),
        (<span class="hljs-string">"https://python.org"</span>, <span class="hljs-number">2</span>)
    ]
    
     创建线程池（最多<span class="hljs-number">3</span>个线程）
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> executor:
         批量提交任务
        results = [executor.submit(fetch_url, url, delay) <span class="hljs-keyword">for</span> url, delay <span class="hljs-keyword">in</span> urls]
         获取结果
        <span class="hljs-keyword">for</span> res <span class="hljs-keyword">in</span> results:
            <span class="hljs-built_in">print</span>(res.result())
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时：<span class="hljs-subst">{time.time() - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
</code></pre>
<p><strong>执行结果</strong>：总耗时≈2秒（3个IO任务并发执行）。</p>
<h3 data-id="heading-5">4. 适用场景</h3>
<ul>
<li>网络请求（爬虫、接口调用）、文件读写、数据库操作等IO密集型任务；</li>
<li>任务切换频繁、等待时间长的场景；</li>
<li>需共享内存数据（线程共享进程内存，无需额外通信）。</li>
</ul>
<h2 data-id="heading-6">三、多进程：CPU密集型任务首选（multiprocessing模块）</h2>
<h3 data-id="heading-7">1. 核心原理</h3>
<p>进程是独立的执行单元，每个进程有自己的GIL，可利用多核CPU并行执行。<code>multiprocessing</code>模块突破GIL限制，是CPU密集型任务的最优解，但进程切换开销比线程大。</p>
<h3 data-id="heading-8">2. 基础用法：创建和启动进程</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> multiprocessing
<span class="hljs-keyword">import</span> time

 定义进程执行的函数（模拟CPU任务：计算）
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_square</span>(<span class="hljs-params">num</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"进程<span class="hljs-subst">{multiprocessing.current_process().pid}</span>：计算<span class="hljs-subst">{num}</span>的平方"</span>)
    time.sleep(<span class="hljs-number">1</span>)   模拟计算耗时
    <span class="hljs-keyword">return</span> num * num

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    start_time = time.time()
    
     创建<span class="hljs-number">2</span>个进程
    p1 = multiprocessing.Process(target=calculate_square, args=(<span class="hljs-number">10</span>,))
    p2 = multiprocessing.Process(target=calculate_square, args=(<span class="hljs-number">20</span>,))
    
    p1.start()
    p2.start()
    p1.join()
    p2.join()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时：<span class="hljs-subst">{time.time() - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
</code></pre>
<p><strong>执行结果</strong>：总耗时≈1秒（2个CPU任务并行执行）。</p>
<h3 data-id="heading-9">3. 实用进阶：进程池（Pool/ProcessPoolExecutor）</h3>
<p>批量CPU任务推荐用进程池，避免手动创建大量进程：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ProcessPoolExecutor
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_square</span>(<span class="hljs-params">num</span>):
    time.sleep(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">return</span> num * num

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    start_time = time.time()
    nums = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>]
    
     创建进程池（适配CPU核心数）
    <span class="hljs-keyword">with</span> ProcessPoolExecutor() <span class="hljs-keyword">as</span> executor:
        results = executor.<span class="hljs-built_in">map</span>(calculate_square, nums)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"计算结果："</span>, <span class="hljs-built_in">list</span>(results))
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时：<span class="hljs-subst">{time.time() - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
</code></pre>
<p><strong>执行结果</strong>：8个任务，4核CPU并行执行，总耗时≈2秒（单进程需8秒）。</p>
<h3 data-id="heading-10">4. 适用场景</h3>
<ul>
<li>数据计算、矩阵运算、图片处理、密码破解等CPU密集型任务；</li>
<li>需充分利用多核CPU的场景；</li>
<li>任务间无频繁数据共享（进程内存隔离，通信开销大）。</li>
</ul>
<h2 data-id="heading-11">四、异步IO：极致IO密集型优化（asyncio模块）</h2>
<h3 data-id="heading-12">1. 核心原理</h3>
<p>异步IO是单线程内的“非阻塞”并发，通过事件循环（Event Loop）管理任务，当一个任务等待IO时，自动切换到其他任务执行——比多线程更轻量（无线程切换开销），是IO密集型任务的极致优化方案。</p>
<h3 data-id="heading-13">2. 核心概念（新手必记）</h3>
<ul>
<li><strong>协程（Coroutine）</strong>：异步执行的函数，用<code>async def</code>定义；</li>
<li><strong>事件循环（Event Loop）</strong>：协程的调度器，负责管理任务执行；</li>
<li><strong>await</strong>：标记IO等待点，触发任务切换；</li>
<li><strong>Task</strong>：封装协程，加入事件循环执行。</li>
</ul>
<h3 data-id="heading-14">3. 基础用法：简单异步任务</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time

 定义异步函数（协程）
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_url</span>(<span class="hljs-params">url, delay</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始请求<span class="hljs-subst">{url}</span>"</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(delay)   异步等待（非阻塞）
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{url}</span>请求完成"</span>)
    <span class="hljs-keyword">return</span> url

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    start_time = time.time()
     创建协程任务
    task1 = asyncio.create_task(fetch_url(<span class="hljs-string">"https://baidu.com"</span>, <span class="hljs-number">2</span>))
    task2 = asyncio.create_task(fetch_url(<span class="hljs-string">"https://github.com"</span>, <span class="hljs-number">2</span>))
     等待所有任务完成
    <span class="hljs-keyword">await</span> task1
    <span class="hljs-keyword">await</span> task2
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时：<span class="hljs-subst">{time.time() - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)

 运行事件循环
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<p><strong>执行结果</strong>：总耗时≈2秒（单线程内2个IO任务并发）。</p>
<h3 data-id="heading-15">4. 实用进阶：批量异步任务</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_url</span>(<span class="hljs-params">url, delay</span>):
    <span class="hljs-keyword">await</span> asyncio.sleep(delay)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{url}</span>请求完成"</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    start_time = time.time()
    urls = [
        (<span class="hljs-string">"https://baidu.com"</span>, <span class="hljs-number">2</span>),
        (<span class="hljs-string">"https://github.com"</span>, <span class="hljs-number">2</span>),
        (<span class="hljs-string">"https://python.org"</span>, <span class="hljs-number">2</span>)
    ]
     批量创建任务
    tasks = [asyncio.create_task(fetch_url(url, delay)) <span class="hljs-keyword">for</span> url, delay <span class="hljs-keyword">in</span> urls]
     等待所有任务完成
    results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks)
    <span class="hljs-keyword">for</span> res <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(res)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时：<span class="hljs-subst">{time.time() - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<p><strong>执行结果</strong>：3个IO任务单线程并发，总耗时≈2秒。</p>
<h3 data-id="heading-16">5. 适用场景</h3>
<ul>
<li>高并发IO任务（如百万级网络请求、高并发接口服务）；</li>
<li>追求极致性能的IO密集型场景；</li>
<li>单线程内的非阻塞任务（如异步Web框架FastAPI）。</li>
</ul>
<h2 data-id="heading-17">五、三大并发模式对比（选型核心）</h2>









































<table><thead><tr><th>特性</th><th>多线程（threading）</th><th>多进程（multiprocessing）</th><th>异步IO（asyncio）</th></tr></thead><tbody><tr><td>核心优势</td><td>轻量、共享内存</td><td>多核并行、突破GIL</td><td>极致轻量、无切换开销</td></tr><tr><td>核心劣势</td><td>受GIL限制、线程安全</td><td>内存隔离、通信开销大</td><td>代码改造成本高、仅支持异步库</td></tr><tr><td>适用任务</td><td>IO密集型</td><td>CPU密集型</td><td>高并发IO密集型</td></tr><tr><td>资源开销</td><td>低</td><td>高</td><td>极低</td></tr><tr><td>代码复杂度</td><td>低</td><td>中</td><td>高</td></tr></tbody></table>
<h2 data-id="heading-18">六、实战案例：不同场景的并发选型</h2>
<h3 data-id="heading-19">场景1：爬虫（IO密集型）</h3>
<ul>
<li>推荐方案：异步IO（asyncio + aiohttp）</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> aiohttp   异步HTTP库

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">url</span>):
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(url) <span class="hljs-keyword">as</span> response:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{url}</span>：状态码<span class="hljs-subst">{response.status}</span>"</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    urls = [
        <span class="hljs-string">"https://baidu.com"</span>,
        <span class="hljs-string">"https://github.com"</span>,
        <span class="hljs-string">"https://python.org"</span>
    ]
    tasks = [asyncio.create_task(fetch(url)) <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls]
    results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks)
    <span class="hljs-keyword">for</span> res <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(res)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<h3 data-id="heading-20">场景2：数据计算（CPU密集型）</h3>
<ul>
<li>推荐方案：多进程（ProcessPoolExecutor）</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ProcessPoolExecutor
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">def</span> <span class="hljs-title function_">matrix_calculate</span>(<span class="hljs-params">matrix</span>):
     矩阵乘法（CPU密集）
    <span class="hljs-keyword">return</span> np.dot(matrix, matrix)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
     生成<span class="hljs-number">10</span>个随机矩阵
    matrices = [np.random.rand(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)]
    <span class="hljs-keyword">with</span> ProcessPoolExecutor() <span class="hljs-keyword">as</span> executor:
        results = executor.<span class="hljs-built_in">map</span>(matrix_calculate, matrices)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"矩阵计算完成，共处理"</span>, <span class="hljs-built_in">len</span>(<span class="hljs-built_in">list</span>(results)), <span class="hljs-string">"个矩阵"</span>)
</code></pre>
<h3 data-id="heading-21">场景3：文件批量处理（IO+轻量计算）</h3>
<ul>
<li>推荐方案：多线程（ThreadPoolExecutor）</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_file</span>(<span class="hljs-params">filepath</span>):
     读取文件+简单处理（IO+轻量计算）
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filepath, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        content = f.read()
     统计字符数
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{filepath}</span>：字符数<span class="hljs-subst">{<span class="hljs-built_in">len</span>(content)}</span>"</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
     获取当前目录下的所有txt文件
    files = [f <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> os.listdir() <span class="hljs-keyword">if</span> f.endswith(<span class="hljs-string">".txt"</span>)]
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=<span class="hljs-number">5</span>) <span class="hljs-keyword">as</span> executor:
        results = executor.<span class="hljs-built_in">map</span>(process_file, files)
    <span class="hljs-keyword">for</span> res <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(res)
</code></pre>
<h2 data-id="heading-22">七、避坑指南：新手常见错误</h2>
<h3 data-id="heading-23">1. 坑1：用多线程处理CPU密集型任务</h3>
<ul>
<li>现象：程序运行速度比单线程还慢；</li>
<li>原因：GIL限制+线程切换开销；</li>
<li>解决方案：改用多进程。</li>
</ul>
<h3 data-id="heading-24">2. 坑2：Windows系统多进程未加<code>if __name__ == "__main__"</code></h3>
<ul>
<li>现象：报错<code>RuntimeError: An attempt has been made to start a new process</code>；</li>
<li>原因：Windows创建进程时重新导入脚本，递归创建进程；</li>
<li>解决方案：所有创建进程的代码放在<code>if __name__ == "__main__"</code>下。</li>
</ul>
<h3 data-id="heading-25">3. 坑3：异步代码中调用同步阻塞函数</h3>
<ul>
<li>现象：异步任务失去并发优势；</li>
<li>原因：<code>time.sleep()</code>、<code>requests.get()</code>等同步函数会阻塞事件循环；</li>
<li>解决方案：改用异步库（如<code>asyncio.sleep()</code>、<code>aiohttp</code>）。</li>
</ul>
<h3 data-id="heading-26">4. 坑4：过度并发导致资源耗尽</h3>
<ul>
<li>现象：程序崩溃、服务器连接被拒绝；</li>
<li>原因：线程/进程/异步任务数量过多；</li>
<li>解决方案：限制并发数（如线程池<code>max_workers</code>、异步任务限流）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[以 uni-app 为核心的 iOS 上架流程实践， 从构建到最终提交的完整路径]]></title>    <link>https://juejin.cn/post/7581081334850912297</link>    <guid>https://juejin.cn/post/7581081334850912297</guid>    <pubDate>2025-12-08T07:30:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581081334850912297" data-draft-id="7581097111895261238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="以 uni-app 为核心的 iOS 上架流程实践， 从构建到最终提交的完整路径"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-08T07:30:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="调试人生的显微镜"/> <meta itemprop="url" content="https://juejin.cn/user/2478768401683354"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            以 uni-app 为核心的 iOS 上架流程实践， 从构建到最终提交的完整路径
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2478768401683354/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    调试人生的显微镜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T07:30:23.000Z" title="Mon Dec 08 2025 07:30:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在移动端跨平台框架逐渐成熟的今天，uni-app 已成为许多前端开发者进入移动端开发的重要入口。它以 Vue 语法为基础，使得 Web 端经验得以直接复用，并能同时生成 Android 与 iOS 应用。然而，uni-app 的“构建简单”并不意味着“上架简单”。尤其是 iOS 端，不论底层技术如何统一，最终仍需遵循苹果的打包、签名、证书、描述文件与审核体系。</p>
<p>对于长期在 uni-app 项目中负责打包与提交的开发者而言，最现实的困难有两个：</p>
<ol>
<li><strong>iOS 上架仍然要求 IPA 文件，而这与 Web 技术无关</strong>；</li>
<li><strong>证书、描述文件、IPA 上传等关键步骤仍需要接触苹果生态的底层规则</strong>。</li>
</ol>
<p>本文基于多个 uni-app 项目实际操作经验，总结一套更适合前端开发者理解，并能在跨平台设备（尤其是 Windows）环境下落地的 iOS 上架流程。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、uni-app 的 iOS 构建结果：从源码到 IPA 的转换过程</strong></h2>
<p>在 uni-app 中，开发者通常使用 HBuilderX 或 CLI 来构建应用。对于 iOS 端来说，构建的最终产物是一个 Xcode 工程，仍然需要使用苹果的打包工具链进行编译。
但对于许多非 iOS 工程背景的前端来说，这里会产生两种常见困惑：</p>
<ol>
<li><strong>为什么我能写代码，但最终还要处理证书与描述文件？</strong></li>
<li><strong>为什么 Windows 无法完成整个流程？</strong></li>
</ol>
<p>原因在于：iOS 应用必须通过苹果签名机制才能安装与上架，签名只接受苹果证书体系，而这些工具最初都部署在 macOS 上。</p>
<p>随着 uni-app 的普及，越来越多团队开始探索“非 Mac 环境是否能参与 iOS 上架流程”。这也是本文接下来要讨论的重点。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、uni-app 上架 iOS 的核心难点</strong></h2>
<p>前端开发团队在实践中通常遇到以下问题：</p>
<ul>
<li><strong>没有足够的 macOS 设备用于打包与上架</strong></li>
<li><strong>证书管理不清晰，描述文件常常冲突或过期</strong></li>
<li><strong>构建出来的 IPA 找不到合适的上传方式</strong></li>
<li><strong>团队成员多数来自前端背景，不熟悉苹果开发者体系</strong></li>
</ul>
<p>虽然 uni-app 屏蔽了大部分平台差异，但在上架环节仍然要遵循苹果的规则，包括：</p>
<ul>
<li>证书生成</li>
<li>描述文件配置</li>
<li>包唯一标识（Bundle ID）</li>
<li>测试设备 UDID</li>
<li>IPA 文件上传</li>
</ul>
<p>因此，uni-app 的“跨端开发体验”并不能完全覆盖“跨端上架体验”。</p>
<hr/>
<h2 data-id="heading-2"><strong>三、uni-app 项目的 iOS 证书体系：必须理解的几个点</strong></h2>
<p>在所有上架相关流程里，证书体系永远是最关键的部分。它与 uni-app 本身无关，但却决定了应用是否能安装、是否能提交审核：</p>
<ul>
<li><strong>开发证书（Development Certificate）</strong>：用于调试安装</li>
<li><strong>发布证书（Distribution Certificate）</strong>：用于 App Store 提交</li>
<li><strong>描述文件（Provisioning Profile）</strong>：绑定证书与 Bundle ID</li>
<li><strong>测试设备（UDID）</strong>：绑定开发描述文件</li>
</ul>
<p>问题在于：
许多 uni-app 开发者没有 macOS 环境，无法使用钥匙串工具来创建证书，也不擅长手动处理 mobileprovision 文件。</p>
<p>这时跨平台证书工具就显得更有意义。</p>
<hr/>
<h2 data-id="heading-3"><strong>四、在 Windows 环境中构建 uni-app 上架链路的实践示例</strong></h2>
<p>由于部分团队的主要开发环境是 Windows，本节以 Windows 为例，说明如何构建从构建 IPA 到最终上传的流程。</p>
<h3 data-id="heading-4"><strong>1. 证书创建与描述文件管理</strong></h3>
<p>在实践中，我常使用 <strong>开心上架（Appuploader）</strong> 来处理证书创建与描述文件查看，因为它可以在 Windows、Linux、macOS 中运行，不依赖钥匙串工具。
它适用于以下环节：</p>
<ul>
<li>输入名称、邮箱、密码即可创建开发或发布证书</li>
<li>统一管理 mobileprovision 文件，查看绑定的证书与设备信息</li>
<li>查看 plist 与证书指纹，确认签名是否一致</li>
</ul>
<p>这些功能解决了 uni-app 团队最常见的痛点：
<strong>“没有 Mac 时，无法创建证书，也无法判断证书或描述文件是否正确。”</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/683a56c968df4ea9aaddcb3d30bf1163~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCD6K-V5Lq655Sf55qE5pi-5b6u6ZWc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765783822&amp;x-signature=MyZhirVDzHJ8r18YiJSpqkqlbAU%3D" alt="证书生成" loading="lazy"/></p>
<p>它让前端开发者可以以更可控的方式参与 iOS 签名流程，而不是完全依赖后端或 iOS 工程师。</p>
<hr/>
<h2 data-id="heading-5"><strong>五、uni-app 构建 IPA 后的上传流程：从 HBuilderX 输出到审核提交</strong></h2>
<p>在完成证书与描述文件设置后，可以通过 CI 或 macOS 机器生成 IPA 文件。</p>
<p>很多团队习惯使用 Transporter 上传，但 Transporter 仅支持 macOS。</p>
<p>在 Windows 设备上，我会使用 Appuploader 的 IPA 上传功能，它支持：</p>
<ul>
<li><strong>在 Windows 上直接上传 ipa 文件到 App Store</strong></li>
<li><strong>通过命令行操作上传流程（适合 CI）</strong></li>
<li><strong>无需 Xcode 或 macOS 设备信息</strong></li>
</ul>
<p>例如命令行方式：</p>
<pre><code class="hljs language-css" lang="css">appuploader_cli -u dev<span class="hljs-keyword">@icloud</span>.com -p xxxx-xxx -c <span class="hljs-number">1</span> -f app.ipa
</code></pre>
<p>对于以 uni-app 为主的前端团队而言，这种方式特别适合：</p>
<ul>
<li>没有 macOS 机器</li>
<li>使用 Windows 统一开发环境</li>
<li>不希望在每次发布时依赖特定设备</li>
</ul>
<p>IPA 上传是上架流程的关键节点之一，让它能在 Windows 上完成，大幅减少发布阻塞。
同时还有图形化界面：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b60ff055f6f4cd0b1787f0400e01eb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCD6K-V5Lq655Sf55qE5pi-5b6u6ZWc:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765783822&amp;x-signature=rvEjK7%2FSJSI9oxKVGtxlF%2FD5nw0%3D" alt="ipa上传" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6"><strong>六、测试安装与调试：与前端开发周期更匹配的方式</strong></h2>
<p>uni-app 在调试阶段通常依赖真机测试，而 iOS 的真机测试需要有效的开发证书与描述文件。
在日常测试中，为了快速验证功能，我常使用以下方式：</p>
<ul>
<li>通过 Appuploader 安装 IPA 至 iPhone</li>
<li>支持 USB 安装或二维码安装</li>
<li>自动读取设备 UDID 添加到描述文件中</li>
</ul>
<p>这种方式比传统的 TestFlight 更适合快速迭代阶段，不必等待审核周期，也不需要第三方测试平台。</p>
<p>尤其当 uni-app 项目的前端成员需要频繁验证界面、动画或插件逻辑时，这种本地安装方式能显著缩短调试周期。</p>
<hr/>
<h2 data-id="heading-7"><strong>七、uni-app 的上架流程建议：前端团队也能掌控的体系</strong></h2>
<p>基于长期实践，我认为 uni-app 团队可以遵循以下原则：</p>
<h3 data-id="heading-8"><strong>1. 将构建与上架流程拆分</strong></h3>
<ul>
<li>构建 IPA 由 CI 或专用机器完成</li>
<li>证书管理与上传可以在 Windows 环境中完成</li>
</ul>
<h3 data-id="heading-9"><strong>2. 让证书体系可视化与可共享</strong></h3>
<p>跨平台工具（如 Appuploader）可以让成员在非 macOS 环境也能管理证书与配置文件。</p>
<h3 data-id="heading-10"><strong>3. 前端成员必须理解苹果签名机制的最小必要知识</strong></h3>
<p>不需要深入 iOS 工程，但必须了解：</p>
<ul>
<li>证书类型</li>
<li>描述文件与 Bundle ID 关系</li>
<li>IPA 上传流程</li>
</ul>
<h3 data-id="heading-11"><strong>4. 流程自动化优先，但不要依赖单一工具</strong></h3>
<p>uni-app → 构建 → 签名 → 上传 的链路可组合多种工具，而不是绑定某一种。</p>
<hr/>
<p>uni-app 让跨端开发变得更简单，但 iOS 上架仍然保持着一套独立的规则体系。
对于以 Windows 为主的前端团队来说，能跨平台执行证书创建、描述文件查看、UDID 管理与 IPA 上传的工具，会显著降低上架流程的学习成本。</p>
<p>从实际项目经验来看，将 uni-app 的开发优势与跨平台上架工具结合，可以让非 iOS 工程背景的团队也能独立完成 iOS 上架流程，而不再依赖特定的 macOS 设备。这种流程的稳定性与可复制性，对团队长期迭代具有重要价值。以 uni-app 为核心的 iOS 上架流程实践， 从构建到最终提交的完整路径
参考教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.appuploader.net%2Ftutorial%2Fzh%2F1%2F1.html" target="_blank" title="https://www.appuploader.net/tutorial/zh/1/1.html" ref="nofollow noopener noreferrer">www.appuploader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里最新出品Java面试核心讲（终极版），Github已星标50K!]]></title>    <link>https://juejin.cn/post/7581073928715829282</link>    <guid>https://juejin.cn/post/7581073928715829282</guid>    <pubDate>2025-12-08T05:58:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581073928715829282" data-draft-id="7581041679189442595" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里最新出品Java面试核心讲（终极版），Github已星标50K!"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2025-12-08T05:58:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里最新出品Java面试核心讲（终极版），Github已星标50K!
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T05:58:36.000Z" title="Mon Dec 08 2025 05:58:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    24
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这时候尴尬的现象就出现了：<strong>虽然八股文背的好并不能代表这个人有实际工作能力，但企业还是会坚持要用八股文来考察候选人。</strong>    其中最直接的原因就是国内的开发岗位供过于求，非常内卷，而八股文就是目前企业最高效的甄别候选人的方式。我们无法改变这一现状，所以只能改变自己，适应目前互联网背八股的现状。</p>
<p>那么借此机会，也为了更好的助力广大程序员朋友面试，小编今天就这里给大家分享一份阿里最新发布Java面试核心讲！（上月底其实我也分享了一份Java架构师面试指南，但很多粉丝反馈说那份是对标架构师的面试资料，自己目前只是面中高级开发岗位，暂时还用不上那个，所以才有今天这篇文章）</p>
<h2 data-id="heading-0">阿里Java面试核心讲（终极版）</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc1ff40cc23f4e4a920663436e24469f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=AECcXZr9dhqvQtD%2BgBpNhOt6fWI%3D" alt="" loading="lazy"/></p>
<blockquote>
<blockquote>
<p>这份小册是从基础到高级涵盖了足足30个技术栈的，包含了JAVA基础，JAVA集合，JAVA并发，Spring，微服务，Netty，计算机网络，MQ，Zookeeper，Redis，MySQL，数据结构与算法以及设计模式等等，足足200余页，由于掘金篇幅限制我在这里就只展示部分内容了，扫一扫免费获取</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11353f4653b44cc9943a91573eb6f69e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=cIQ2xGVcNyLqz%2BzQivK95npGv2E%3D" alt="image.png" loading="lazy"/></p>
</blockquote>
<h2 data-id="heading-1">JVM</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba08c1285081450ba67aafd49e5cb087~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=8XLCijODvsNtWDI6Ki%2B2ZzYFS3A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/796daf7653784fa497a6d6f0ca51493d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=NANR5ydhCa44AzQ0YhDb6IMeeZk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">Java并发知识</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d81263e85144e8d8845657344659bf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=aikJqiFPUhDfQ1c%2BZ4q5XukejxU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bdc369e81304be69da09cf23a9cb201~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=tpr1iuRnxG%2F6WWHQv8Kgj8fkWtk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">Spring原理</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eed49632f3d42dbadaaeda7e0364df6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=2EqCDrE2x3BBb1KOPxvllL9uQdU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c241537537504180ae3d20ce78a31f57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=FM%2FYgNRSOQ%2FyY5f8TXp5gxLOF0k%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">微服务</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3cae6556f014681b13ee997009616b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=WawbtFNvA9Y%2B6NRQknG00D%2BDcrU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e552640482bc4f0db9f6e8b83810b846~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=Bn38MCTqpz%2BdfuJ07Q0FaCsUYCs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">Netty</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b5aa1250940447fac5beb6c90c926df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=LyhBJox8s%2FWN4cx9KWqTnmJlMuM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fac3b6114bb4a2e8faad6afe68030ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=YqBhZqCLvkEaEc66i8FH9MaJYYw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">计算机网络</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd29b9310089419883d42f1a6046718a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=43mdHvtYswUgMjIPFnK8lVUhpe8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34a1f8d76c574cfe930a10e712cdc585~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=JJ4pxiIqmbx1PrA9nwS6QRrOX5k%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">数据库</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8425d058d9044cd4ab75ccdeec44bb3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=smsRrce%2BGvmna6%2Bys6RdY4kEv90%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7252e53d196a41008417138642f9b7e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=SkFeT184IJWyZ%2BleiUBwyRoZ9Ww%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">数据结构与算法</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b32306eb63e410da5a97ecd65663fe3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=wHJWh7P0ZTq0S%2BiCXMiZlWJhk6M%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6612e74c27114c3ca2147b74fdbd85d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=pMtzQXWlvlKNfqH9T8Njnnm8mr8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/945ace39873d41b1b9af658345b676af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=0URKD2nTKktdmq%2BY2IELCwB5Py8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">设计模式</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffdd0efc50bc42fa8c312d01835fbf7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=V9yPdHhxx2yzIwdzNS9%2Bwwt73yc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">中间件</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c38efb2fe25c47e0875a83e54cbbe8b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=anCjApeiqKJViEMKbJ30IZ30Hh0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bf1afa845044918a87183138ad4b6ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=4YD9%2BzvBQ%2FyST%2FXaSQGbWPz5XUw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">最后</h2>
<p>文章到这里篇幅已经很长了，就不继续拉长篇幅了，</p>
<blockquote>
<blockquote>
<p>这份小册是从基础到高级涵盖了足足30个技术栈的，包含了JAVA基础，JAVA集合，JAVA并发，Spring，微服务，Netty，计算机网络，MQ，Zookeeper，Redis，MySQL，数据结构与算法以及设计模式等等，足足200余页，由于掘金篇幅限制我在这里就只展示部分内容了，扫一扫免费获取</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d68eb4c115da4b3f829d4ec68b9e6b5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779588&amp;x-signature=eeAAGjNaxYNM2cHXNAmalk%2F8zdo%3D" alt="image.png" loading="lazy"/></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Pinia Store 平滑迁移：用代理模式实现零风险重构]]></title>    <link>https://juejin.cn/post/7581036773607620608</link>    <guid>https://juejin.cn/post/7581036773607620608</guid>    <pubDate>2025-12-08T05:50:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581036773607620608" data-draft-id="7581098720034045992" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Pinia Store 平滑迁移：用代理模式实现零风险重构"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2025-12-08T05:50:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大象的鼻子那么长"/> <meta itemprop="url" content="https://juejin.cn/user/2277843821926871"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Pinia Store 平滑迁移：用代理模式实现零风险重构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843821926871/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大象的鼻子那么长
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.4 融会贯通
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.4 融会贯通" title="VIP.4 融会贯通" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T05:50:44.000Z" title="Mon Dec 08 2025 05:50:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>重构遗留代码最怕什么？改一处崩十处。这篇文章分享一个我在实际项目中用过的方案：用代理模式实现 Pinia Store 的平滑迁移，让几十处旧代码无感升级。</p>
</blockquote>
<h2 data-id="heading-0">背景：为什么要迁移</h2>
<p>项目里有个 <code>useUserStore</code>，最早是用 Options API 写的，随着业务迭代，问题越来越多：</p>
<ul>
<li>类型定义不完整，到处是 <code>any</code></li>
<li>命名不规范，<code>setUserInfoAction</code>、<code>loginOut</code> 这种命名看着难受</li>
<li>状态结构和后端返回不一致，前端加了很多 hack</li>
<li>没有按业务域组织，所有 Store 都堆在根目录</li>
</ul>
<p>想重构成 Setup 风格，顺便理清类型和命名。但问题来了：<strong>这个 Store 被几十个文件引用，直接改导入路径？风险太大。</strong></p>
<h2 data-id="heading-1">方案：代理模式 + 渐进式迁移</h2>
<p>核心思路很简单：<strong>不动旧路径，让旧文件变成代理</strong>。</p>
<pre><code class="hljs language-bash" lang="bash">旧导入路径                        新 Store
src/store/user.ts  ───代理───►  src/store/core/user.ts
       ▲                               │
       │                               │
   几十处业务代码                     唯一数据源
</code></pre>
<p>这样做的好处：</p>
<ul>
<li>✅ 旧代码一行不改，继续用 <code>~/store/user</code> 导入</li>
<li>✅ 新代码直接用 <code>~/store/core</code> 导入</li>
<li>✅ 数据源唯一，不会出现状态不同步</li>
<li>✅ 可以慢慢把旧代码迁移到新路径</li>
</ul>
<hr/>
<h2 data-id="heading-2">实现步骤</h2>
<h3 data-id="heading-3">Step 1：先写新的 Store</h3>
<p>在 <code>src/store/core/user.ts</code> 创建新的 Setup 风格 Store：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/core/user.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// ==================== State ====================</span>
  <span class="hljs-keyword">const</span> userInfo = ref&lt;<span class="hljs-title class_">UserInfo</span>&gt;(<span class="hljs-title function_">getDefaultUserInfo</span>())
  <span class="hljs-keyword">const</span> permissions = ref&lt;<span class="hljs-title class_">Permission</span>[]&gt;([])
  <span class="hljs-keyword">const</span> locale = ref&lt;<span class="hljs-title class_">SupportedLanguage</span>&gt;(<span class="hljs-string">'zh'</span>)
  <span class="hljs-keyword">const</span> isRouterInitialized = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)

  <span class="hljs-comment">// ==================== Getters ====================</span>
  <span class="hljs-keyword">const</span> isLoggedIn = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> !!userInfo.<span class="hljs-property">value</span>.<span class="hljs-property">id</span>)
  <span class="hljs-keyword">const</span> nickname = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> userInfo.<span class="hljs-property">value</span>.<span class="hljs-property">realName</span> || <span class="hljs-string">''</span>)

  <span class="hljs-comment">// ==================== Actions ====================</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadUserInfo</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> userApi.<span class="hljs-title function_">getPermissionsInfo</span>()
    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">data</span>) {
      userInfo.<span class="hljs-property">value</span> = { ...<span class="hljs-title function_">getDefaultUserInfo</span>(), ...res.<span class="hljs-property">data</span>.<span class="hljs-property">user</span> }
      permissions.<span class="hljs-property">value</span> = res.<span class="hljs-property">data</span>.<span class="hljs-property">permissions</span> || []
    }
  }

  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    userInfo.<span class="hljs-property">value</span> = <span class="hljs-title function_">getDefaultUserInfo</span>()
    permissions.<span class="hljs-property">value</span> = []
    <span class="hljs-comment">// ... 清理逻辑</span>
  }

  <span class="hljs-keyword">return</span> {
    userInfo, permissions, locale, isRouterInitialized,
    isLoggedIn, nickname,
    loadUserInfo, logout,
  }
})
</code></pre>
<p>类型清晰，命名规范，舒服。</p>
<h3 data-id="heading-4">Step 2：把旧文件改成代理</h3>
<p>重点来了。把原来的 <code>src/store/user.ts</code> 改成代理层：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/store/user.ts - 变成代理层</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Pinia</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { useUserStore <span class="hljs-keyword">as</span> useCoreUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'./core/user'</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@deprecated</span> 建议迁移到 useUserStore from '~/store/core'
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useUserStore</span>(<span class="hljs-params">_pinia?: Pinia</span>) {
  <span class="hljs-comment">// 转发到新 Store</span>
  <span class="hljs-keyword">const</span> coreStore = <span class="hljs-title function_">useCoreUserStore</span>()

  <span class="hljs-keyword">const</span> { userInfo, permissions, locale, isRouterInitialized } = <span class="hljs-title function_">storeToRefs</span>(coreStore)

  <span class="hljs-comment">// 兼容旧的 getter 命名</span>
  <span class="hljs-keyword">const</span> getLocale = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> locale.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">const</span> getPermissions = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> permissions.<span class="hljs-property">value</span>)

  <span class="hljs-comment">// 兼容旧的 action 命名</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setUserInfoAction</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> coreStore.<span class="hljs-title function_">loadUserInfo</span>()  <span class="hljs-comment">// 转发</span>
  }

  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loginOut</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> coreStore.<span class="hljs-title function_">logout</span>()  <span class="hljs-comment">// 转发</span>
  }

  <span class="hljs-comment">// 兼容 userStore.user.xxx 的直接访问方式</span>
  <span class="hljs-keyword">const</span> userProxy = {
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">user</span>() { <span class="hljs-keyword">return</span> userInfo.<span class="hljs-property">value</span> }
  }

  <span class="hljs-keyword">return</span> {
    userInfo, permissions, locale,
    ...userProxy,  <span class="hljs-comment">// 支持 store.user.readAll 这种访问</span>
    <span class="hljs-comment">// 旧命名（兼容）</span>
    getLocale, getPermissions,
    setUserInfoAction, loginOut,
    <span class="hljs-comment">// 新命名（推荐）</span>
    <span class="hljs-attr">loadUserInfo</span>: coreStore.<span class="hljs-property">loadUserInfo</span>,
    <span class="hljs-attr">logout</span>: coreStore.<span class="hljs-property">logout</span>,
  }
}
</code></pre>
<p>几个关键点：</p>
<h4 data-id="heading-5">1. 接受可选的 pinia 参数</h4>
<p>旧代码可能写成 <code>useUserStore(store)</code>，新的代理层要兼容这种写法，虽然参数实际不用。</p>
<h4 data-id="heading-6">2. 用 getter 代理 user 属性</h4>
<p>旧代码直接 <code>userStore.user.readAll</code> 访问，不是 <code>userStore.user.value.readAll</code>。用 getter 可以实现这种"直接访问"的效果：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> userProxy = {
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">user</span>() { <span class="hljs-keyword">return</span> userInfo.<span class="hljs-property">value</span> }
}
<span class="hljs-keyword">return</span> { ...userProxy }
</code></pre>
<h4 data-id="heading-7">3. 新旧命名都暴露</h4>
<p>让业务代码可以渐进式迁移，<code>setUserInfoAction</code> 和 <code>loadUserInfo</code> 同时可用。</p>
<h3 data-id="heading-8">Step 3：加上 @deprecated 标记</h3>
<p>给代理层加上 JSDoc 的 <code>@deprecated</code> 标记，IDE 会给出提示，方便后续清理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/** <span class="hljs-doctag">@deprecated</span> 使用 coreStore.loadUserInfo 代替 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setUserInfoAction</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">await</span> coreStore.<span class="hljs-title function_">loadUserInfo</span>()
}
</code></pre>
<hr/>
<h2 data-id="heading-9">测试验证</h2>
<p>迁移最怕的是"看起来没问题，上线才出事"。这里给一套验证方案。</p>
<h3 data-id="heading-10">快速冒烟测试</h3>
<p>在浏览器控制台跑一下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 旧路径</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'~/store/user'</span>
<span class="hljs-comment">// 新路径</span>
<span class="hljs-keyword">import</span> { useUserStore <span class="hljs-keyword">as</span> useCoreUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'~/store/core'</span>

<span class="hljs-keyword">const</span> oldStore = <span class="hljs-title function_">useUserStore</span>()
<span class="hljs-keyword">const</span> newStore = <span class="hljs-title function_">useCoreUserStore</span>()

<span class="hljs-comment">// 验证数据源唯一</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'引用相同:'</span>, oldStore.<span class="hljs-property">userInfo</span> === newStore.<span class="hljs-property">userInfo</span>)  <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 验证状态同步</span>
newStore.<span class="hljs-title function_">setLocale</span>(<span class="hljs-string">'en'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'状态同步:'</span>, oldStore.<span class="hljs-property">locale</span>.<span class="hljs-property">value</span> === <span class="hljs-string">'en'</span>)  <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-11">关键路径验证</h3>



































<table><thead><tr><th>场景</th><th>操作</th><th>预期</th></tr></thead><tbody><tr><td>登录</td><td>正常登录</td><td>用户名正确显示</td></tr><tr><td>权限</td><td>访问受限页面</td><td>权限判断正常</td></tr><tr><td>语言</td><td>切换中英文</td><td>全局切换，刷新后保持</td></tr><tr><td>登出</td><td>点击登出</td><td>状态清除，跳转登录页</td></tr><tr><td>刷新</td><td>F5 刷新页面</td><td>状态正确恢复</td></tr></tbody></table>
<h3 data-id="heading-12">单元测试</h3>
<p>写一个兼容性测试，确保新旧 API 行为一致：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'User Store 兼容性'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'新旧 Store 应指向同一数据源'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> oldStore = <span class="hljs-title function_">useUserStore</span>()
    <span class="hljs-keyword">const</span> coreStore = <span class="hljs-title function_">useCoreUserStore</span>()
    <span class="hljs-title function_">expect</span>(oldStore.<span class="hljs-property">userInfo</span>).<span class="hljs-title function_">toBe</span>(coreStore.<span class="hljs-property">userInfo</span>)
  })

  <span class="hljs-title function_">it</span>(<span class="hljs-string">'setUserInfoAction 应等价于 loadUserInfo'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useUserStore</span>()
    <span class="hljs-keyword">await</span> store.<span class="hljs-title function_">setUserInfoAction</span>()
    <span class="hljs-title function_">expect</span>(store.<span class="hljs-property">userInfo</span>.<span class="hljs-property">value</span>.<span class="hljs-property">id</span>).<span class="hljs-title function_">toBeTruthy</span>()
  })
})
</code></pre>
<hr/>
<h2 data-id="heading-13">渐进式迁移</h2>
<p>代理层搞定后，业务代码可以慢慢迁移：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ============ 旧写法（继续可用） ============</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'~/store/user'</span>

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useUserStore</span>(pinia)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(store.<span class="hljs-property">user</span>.<span class="hljs-property">readAll</span>)
<span class="hljs-keyword">await</span> store.<span class="hljs-title function_">setUserInfoAction</span>()

<span class="hljs-comment">// ============ 新写法（推荐） ============</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'~/store/core'</span>

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">useUserStore</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(store.<span class="hljs-property">userInfo</span>.<span class="hljs-property">readAll</span>)
<span class="hljs-keyword">await</span> store.<span class="hljs-title function_">loadUserInfo</span>()
</code></pre>
<p>没有 deadline 压力的话，可以每次改业务功能的时候顺手把导入路径改掉，几个月后旧路径的引用自然就清零了。</p>
<hr/>
<h2 data-id="heading-14">兼容点速查表</h2>

































<table><thead><tr><th>旧用法</th><th>兼容方式</th></tr></thead><tbody><tr><td><code>useUserStore(store)</code></td><td>接受可选参数 <code>_pinia?: Pinia</code></td></tr><tr><td><code>userStore.user.readAll</code></td><td>使用 getter 代理直接访问</td></tr><tr><td><code>userStore.setUserInfoAction()</code></td><td>转发到 <code>loadUserInfo()</code></td></tr><tr><td><code>userStore.loginOut()</code></td><td>转发到 <code>logout()</code></td></tr><tr><td><code>userStore.isSetRouters</code></td><td>别名到 <code>isRouterInitialized</code></td></tr><tr><td><code>userStore.getLocale</code></td><td>computed 包装 <code>locale.value</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15">总结</h2>
<p>这套方案的核心就三点：</p>
<ol>
<li><strong>数据源唯一</strong>：新旧路径最终都指向同一个 Store 实例</li>
<li><strong>API 兼容</strong>：代理层转发所有旧的方法调用</li>
<li><strong>渐进迁移</strong>：新旧写法并存，没有硬性切换时间点</li>
</ol>
<p><strong>适用场景：</strong></p>
<ul>
<li>Store 被大量文件引用，不敢直接改路径</li>
<li>想重构但又怕出问题</li>
<li>团队习惯渐进式改进，不喜欢大爆炸式重构</li>
</ul>
<p><strong>不适用场景：</strong></p>
<ul>
<li>Store 只有几处引用，直接全局替换更快</li>
<li>重构涉及 Store ID 变更（会影响持久化）</li>
</ul>
<hr/>
<p>希望这个方案对你有帮助。有问题欢迎讨论 👋</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[优雅地处理前端错误边界]]></title>    <link>https://juejin.cn/post/7580740782933590058</link>    <guid>https://juejin.cn/post/7580740782933590058</guid>    <pubDate>2025-12-08T05:59:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580740782933590058" data-draft-id="7580753790771953706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="优雅地处理前端错误边界"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-08T05:59:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="dorisrv"/> <meta itemprop="url" content="https://juejin.cn/user/1522178380270712"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            优雅地处理前端错误边界
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1522178380270712/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    dorisrv
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T05:59:31.000Z" title="Mon Dec 08 2025 05:59:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    35
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">优雅地处理前端错误边界</h2>
<h3 data-id="heading-1">🤔 为什么需要错误边界？</h3>
<p>在前端开发中，一个组件的错误可能会导致整个应用崩溃。想象一下：用户正在填写一个复杂的表单，突然因为某个组件的小错误，整个页面白屏了——这是多么糟糕的用户体验！</p>
<p>错误边界（Error Boundary）就是为了解决这个问题而生的。它可以捕获子组件树中的 JavaScript 错误，记录错误信息，并显示一个备用 UI，而不是让整个应用崩溃。</p>
<h3 data-id="heading-2">💡 React 中的错误边界实现</h3>
<h4 data-id="heading-3">基础实现</h4>
<p>💡 <strong>重要提示</strong>：截至 React 18，错误边界<strong>仍然只能通过类组件实现</strong>，这是 React 框架的限制。但我们可以结合 Hooks 来使用它！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 错误边界必须使用类组件实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  state = { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">errorInfo</span>: <span class="hljs-literal">null</span> };

  <span class="hljs-comment">// 静态方法，用于在错误发生后更新状态</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params">error</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span>, error };
  }

  <span class="hljs-comment">// 捕获错误并记录</span>
  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error, errorInfo</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误边界捕获到错误:'</span>, error, errorInfo);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ errorInfo });
    <span class="hljs-comment">// 可以在这里上报错误日志</span>
  }

  <span class="hljs-comment">// 重置错误状态的方法</span>
  handleReset = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">errorInfo</span>: <span class="hljs-literal">null</span> });
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">onReset</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-title function_">onReset</span>();
    }
  };

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) {
      <span class="hljs-comment">// 支持自定义错误 UI</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">fallbackUI</span> || (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"error-boundary"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>抱歉，页面出现了错误 😢<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"error-details"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{this.state.error?.toString()}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">details</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">summary</span>&gt;</span>错误详情<span class="hljs-tag">&lt;/<span class="hljs-name">summary</span>&gt;</span>
              {this.state.errorInfo?.componentStack}
            <span class="hljs-tag">&lt;/<span class="hljs-name">details</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.handleReset}</span> 
            <span class="hljs-attr">className</span>=<span class="hljs-string">"retry-button"</span>
          &gt;</span>
            重试
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
      );
    }

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">ErrorBoundary</span>;
</code></pre>
<h4 data-id="heading-4">Hooks + 错误边界的组合使用</h4>
<p>虽然错误边界本身需要类组件，但我们可以在 Hooks 组件中轻松使用它：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ErrorBoundary'</span>;

<span class="hljs-comment">// 一个可能出错的 Hooks 组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">BuggyComponent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  
  <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">3</span>) {
    <span class="hljs-comment">// 模拟错误</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'计数超过限制了！'</span>);
  }
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>当前计数: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;增加计数<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-comment">// 在主组件中使用错误边界包裹</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"app"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>React 错误边界示例<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>
        // <span class="hljs-attr">可以自定义错误</span> <span class="hljs-attr">UI</span>
        <span class="hljs-attr">fallbackUI</span>=<span class="hljs-string">{</span>
          &lt;<span class="hljs-attr">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"custom-error"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>😱 组件出错了！<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数组件加载失败，请重试<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        }
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">BuggyComponent</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<h3 data-id="heading-5">🚀 进阶优化</h3>
<h4 data-id="heading-6">1. 错误日志上报</h4>
<p>结合现代 JavaScript 语法和 Fetch API：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error, errorInfo</span>) {
  <span class="hljs-comment">// 上报错误信息到服务器</span>
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/error-report'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">error</span>: error.<span class="hljs-title function_">toString</span>(),
      <span class="hljs-attr">stack</span>: errorInfo.<span class="hljs-property">componentStack</span>,
      <span class="hljs-attr">userAgent</span>: navigator.<span class="hljs-property">userAgent</span>,
      <span class="hljs-attr">url</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
    })
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">reportError</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误上报失败:'</span>, reportError);
  });
}
</code></pre>
<h4 data-id="heading-7">2. 支持重置回调</h4>
<p>在上面的基础实现中已经包含了重置功能，使用方式：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">ErrorBoundary</span>
  onReset={<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 重置相关状态或执行清理操作</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'错误边界已重置'</span>);
  }}
&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">BuggyComponent</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">ErrorBoundary</span>&gt;
</code></pre>
<h3 data-id="heading-8">⚠️ 注意事项</h3>
<h4 data-id="heading-9">React 错误边界</h4>
<ol>
<li><strong>只能捕获子组件树中的错误</strong>，不能捕获自身的错误</li>
<li><strong>不能捕获异步代码中的错误</strong>（如 setTimeout、fetch 回调等）</li>
<li><strong>不能捕获事件处理器中的错误</strong>（如 onClick 事件处理函数）</li>
<li><strong>React 16+ 才支持错误边界</strong></li>
<li><strong>必须使用类组件实现</strong>（React 框架限制）</li>
</ol>
<h4 data-id="heading-10">Vue 3 错误处理</h4>
<ol>
<li><strong><code>onErrorCaptured</code> 钩子只能捕获子组件的错误</strong></li>
<li><strong>可以捕获模板编译和渲染时的错误</strong></li>
<li><strong>默认会向上传播错误</strong>，返回 <code>false</code> 可以阻止传播</li>
<li><strong>对于异步错误</strong>，需要使用 <code>try/catch</code> 或全局错误处理</li>
<li><strong>Vue 3 Composition API 提供了更灵活的错误处理方式</strong></li>
</ol>
<h3 data-id="heading-11">🎯 Vue 3 中的错误处理实现（Setup 语法糖）</h3>
<p>Vue 3 提供了更现代的 Composition API，结合 <code>&lt;script setup&gt;</code> 语法糖，可以更优雅地实现错误处理：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    &lt;slot v-if="!hasError"&gt;&lt;/slot&gt;
    &lt;div v-else class="error-boundary"&gt;
      &lt;h2&gt;抱歉，页面出现了错误 😢&lt;/h2&gt;
      &lt;div class="error-details" v-if="error"&gt;
        &lt;p&gt;{{ error.message }}&lt;/p&gt;
        &lt;details&gt;
          &lt;summary&gt;错误详情&lt;/summary&gt;
          &lt;pre&gt;{{ error.stack }}&lt;/pre&gt;
        &lt;/details&gt;
      &lt;/div&gt;
      &lt;button @click="handleReset" class="retry-button"&gt;
        重试
      &lt;/button&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onErrorCaptured } from 'vue';

// 定义 props
const props = defineProps({
  // 支持自定义错误 UI
  fallbackUI: {
    type: Object,
    default: null
  }
});

// 定义事件
const emit = defineEmits(['reset']);

// 错误状态
const hasError = ref(false);
const error = ref(null);
const errorInfo = ref(null);

// 捕获子组件错误的生命周期钩子
onErrorCaptured((err, instance, info) =&gt; {
  console.error('Vue 3 错误边界捕获到错误:', err, instance, info);
  hasError.value = true;
  error.value = err;
  errorInfo.value = info;
  
  // 可以在这里上报错误日志
  reportError(err, info);
  
  // 返回 false 阻止错误继续向上传播
  return false;
});

// 错误日志上报函数
const reportError = async (err, info) =&gt; {
  try {
    await fetch('/api/error-report', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        error: err.toString(),
        stack: err.stack,
        info,
        userAgent: navigator.userAgent,
        url: window.location.href,
        timestamp: new Date().toISOString()
      })
    });
  } catch (reportErr) {
    console.error('错误上报失败:', reportErr);
  }
};

// 重置错误状态
const handleReset = () =&gt; {
  hasError.value = false;
  error.value = null;
  errorInfo.value = null;
  emit('reset');
};
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-12">使用示例</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="app"&gt;
    &lt;h1&gt;Vue 3 错误处理示例&lt;/h1&gt;
    
    &lt;ErrorBoundary
      @reset="handleBoundaryReset"
    &gt;
      &lt;BuggyComponent /&gt;
    &lt;/ErrorBoundary&gt;
    
    &lt;!-- 也可以使用自定义错误 UI --&gt;
    &lt;ErrorBoundary
      :fallback-ui="customFallback"
    &gt;
      &lt;AnotherBuggyComponent /&gt;
    &lt;/ErrorBoundary&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { h } from 'vue';
import ErrorBoundary from './ErrorBoundary.vue';
import BuggyComponent from './BuggyComponent.vue';
import AnotherBuggyComponent from './AnotherBuggyComponent.vue';

// 自定义错误 UI
const customFallback = h('div', {
  class: 'custom-error'
}, [
  h('h3', '📊 图表加载失败'),
  h('p', '请检查网络连接后重试'),
  h('button', {
    onClick: () =&gt; console.log('重试按钮点击')
  }, '重新加载')
]);

// 错误边界重置回调
const handleBoundaryReset = () =&gt; {
  console.log('错误边界已重置，页面恢复正常');
};
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-13">📝 总结</h3>
<p>错误边界是提升前端应用稳定性和用户体验的重要手段。通过合理使用错误边界，我们可以：</p>
<ol>
<li>防止单个组件错误导致整个应用崩溃</li>
<li>提供友好的错误提示，引导用户操作</li>
<li>收集错误信息，帮助开发者快速定位问题</li>
<li>提升应用的专业感和可靠性</li>
</ol>
<p>希望这个小技巧对你有所帮助！如果你有任何问题或建议，欢迎在评论区留言讨论 🤗</p>
<hr/>
<p><strong>相关资源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FComponent%23componentdidcatch" target="_blank" title="https://react.dev/reference/react/Component#componentdidcatch" ref="nofollow noopener noreferrer">React 官方文档 - 错误边界</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fcomponents%2Ferror-handling.html" target="_blank" title="https://vuejs.org/guide/components/error-handling.html" ref="nofollow noopener noreferrer">Vue 官方文档 - 错误处理</a></li>
</ul>
<p><strong>标签：</strong> #React #Vue #前端错误处理 #用户体验优化</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MQ生产者确认机制捕获到消息投递失败后如何重试？]]></title>    <link>https://juejin.cn/post/7581073928715862050</link>    <guid>https://juejin.cn/post/7581073928715862050</guid>    <pubDate>2025-12-08T06:07:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581073928715862050" data-draft-id="7581073928715845666" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MQ生产者确认机制捕获到消息投递失败后如何重试？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-08T06:07:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MQ生产者确认机制捕获到消息投递失败后如何重试？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:07:05.000Z" title="Mon Dec 08 2025 06:07:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>要实现生产者确认机制失败后<strong>自动重试重新投递</strong>，核心思路是：<strong>将发送失败的消息暂存→按策略重试→跟踪重试状态→失败兜底</strong>。以下是具体实现思路和关键步骤，结合代码示例说明。</p>
<h3 data-id="heading-0"><strong>一、核心思路框架</strong></h3>
<p>当生产者通过 <code>ConfirmCallback</code> 收到 <code>ack=false</code>（Broker 未确认接收）或超时未收到确认时，说明消息发送失败。此时需将消息<strong>暂存到可靠存储</strong>（避免内存丢失），并按<strong>重试策略</strong>（次数、间隔）重新投递，直至成功或超过阈值后转入死信队列。</p>
<h3 data-id="heading-1"><strong>二、关键实现步骤</strong></h3>
<h4 data-id="heading-2"><strong>1. 定义“失败消息”存储结构</strong></h4>
<p>需持久化存储失败消息的<strong>核心信息</strong>，确保重启后不丢失。推荐用 <strong>数据库</strong>（MySQL/PostgreSQL）或 <strong>Redis</strong>（缓存+持久化），字段包括：</p>


















































<table><thead><tr><th>字段名</th><th>说明</th><th>示例值</th></tr></thead><tbody><tr><td><code>msg_id</code></td><td>消息唯一ID（CorrelationData的ID）</td><td><code>MSG-1690000000000-0.123456</code></td></tr><tr><td><code>exchange</code></td><td>目标交换机名称</td><td><code>order.exchange</code></td></tr><tr><td><code>routing_key</code></td><td>目标路由键</td><td><code>order.routingKey</code></td></tr><tr><td><code>message_body</code></td><td>消息体（JSON序列化）</td><td><code>{"id":1001,"amount":99.9}</code></td></tr><tr><td><code>retry_count</code></td><td>当前重试次数</td><td><code>0</code>（初始值）</td></tr><tr><td><code>max_retry</code></td><td>最大重试次数（如3次）</td><td><code>3</code></td></tr><tr><td><code>next_retry_time</code></td><td>下次重试时间（时间戳）</td><td><code>1690000060000</code>（当前时间+10秒）</td></tr><tr><td><code>status</code></td><td>状态（待重试/重试中/失败）</td><td><code>PENDING</code></td></tr></tbody></table>
<h4 data-id="heading-3"><strong>2. 实现“失败消息”存储层</strong></h4>
<p>以 <strong>MySQL</strong> 为例，创建表存储失败消息：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> mq_failed_message (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    msg_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span> COMMENT <span class="hljs-string">'消息唯一ID'</span>,
    exchange <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'交换机'</span>,
    routing_key <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'路由键'</span>,
    message_body TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息体(JSON)'</span>,
    retry_count <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'当前重试次数'</span>,
    max_retry <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">3</span> COMMENT <span class="hljs-string">'最大重试次数'</span>,
    next_retry_time <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'下次重试时间戳(ms)'</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'PENDING'</span> COMMENT <span class="hljs-string">'状态:PENDING/RETRYING/FAILED'</span>,
    created_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    updated_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    INDEX idx_next_retry_time (next_retry_time) COMMENT <span class="hljs-string">'按下次重试时间索引'</span>
);
</code></pre>
<h4 data-id="heading-4"><strong>3. 发送消息时关联“失败存储”</strong></h4>
<p>生产者发送消息时，生成唯一 <code>msg_id</code>（如 UUID 或雪花算法），并在 <code>ConfirmCallback</code> 中处理失败逻辑：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
public class RetryProducer {
    <span class="hljs-keyword">@Autowired</span>
    private RabbitTemplate rabbitTemplate;
    <span class="hljs-keyword">@Autowired</span>
    private FailedMessageStorage failedMessageStorage; <span class="hljs-comment">// 失败消息存储接口</span>

    public void <span class="hljs-built_in">sendWithRetry</span>(Object message, String exchange, String routingKey) {
        <span class="hljs-comment">// 1. 生成唯一消息ID</span>
        String msgId = "MSG-" + System<span class="hljs-selector-class">.currentTimeMillis</span>() + "-" + UUID<span class="hljs-selector-class">.randomUUID</span>()<span class="hljs-selector-class">.toString</span>()<span class="hljs-selector-class">.substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>);
        CorrelationData correlationData = new <span class="hljs-built_in">CorrelationData</span>(msgId);

        <span class="hljs-comment">// 2. 发送消息（携带CorrelationData）</span>
        rabbitTemplate<span class="hljs-selector-class">.convertAndSend</span>(exchange, routingKey, message, correlationData);

        <span class="hljs-comment">// 3. 注册确认回调（处理成功/失败）</span>
        rabbitTemplate<span class="hljs-selector-class">.setConfirmCallback</span>((correlationData1, ack, cause) -&gt; {
            String id = correlationData1 != null ? correlationData1<span class="hljs-selector-class">.getId</span>() : null;
            if (id == null) return;

            if (ack) {
                <span class="hljs-comment">// 确认成功：删除存储中的失败记录（若有）</span>
                failedMessageStorage<span class="hljs-selector-class">.deleteById</span>(id);
                System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("消息确认成功，ID: " + id);
            } else {
                <span class="hljs-comment">// 确认失败：存入失败消息表，等待重试</span>
                FailedMessage failedMsg = new <span class="hljs-built_in">FailedMessage</span>();
                failedMsg<span class="hljs-selector-class">.setMsgId</span>(id);
                failedMsg<span class="hljs-selector-class">.setExchange</span>(exchange);
                failedMsg<span class="hljs-selector-class">.setRoutingKey</span>(routingKey);
                failedMsg<span class="hljs-selector-class">.setMessageBody</span>(JSON.toJSONString(message)); <span class="hljs-comment">// 序列化为JSON</span>
                failedMsg<span class="hljs-selector-class">.setRetryCount</span>(<span class="hljs-number">0</span>);
                failedMsg<span class="hljs-selector-class">.setMaxRetry</span>(<span class="hljs-number">3</span>);
                failedMsg<span class="hljs-selector-class">.setNextRetryTime</span>(System.currentTimeMillis() + <span class="hljs-number">10</span> * <span class="hljs-number">1000</span>); <span class="hljs-comment">// 10秒后重试</span>
                failedMsg<span class="hljs-selector-class">.setStatus</span>("PENDING");
                failedMessageStorage<span class="hljs-selector-class">.save</span>(failedMsg);
                System<span class="hljs-selector-class">.err</span><span class="hljs-selector-class">.println</span>("消息确认失败，存入重试队列，ID: " + id + "，原因: " + cause);
            }
        });
    }
}
</code></pre>
<h4 data-id="heading-5"><strong>4. 实现重试调度器（核心）</strong></h4>
<p>通过 <strong>定时任务</strong>（如 Spring Scheduler）或 <strong>线程池</strong> 定期检查失败消息表，对 <code>next_retry_time ≤ 当前时间</code> 的消息执行重试：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Component</span>
<span class="hljs-variable">@EnableScheduling</span>
public class RetryScheduler {
    <span class="hljs-variable">@Autowired</span>
    private FailedMessageStorage failedMessageStorage;
    <span class="hljs-variable">@Autowired</span>
    private RabbitTemplate rabbitTemplate;
    <span class="hljs-variable">@Autowired</span>
    private DeadLetterQueueHandler deadLetterQueueHandler; <span class="hljs-comment">// 死信队列处理器</span>

    <span class="hljs-comment">// 每5秒扫描一次待重试消息</span>
    <span class="hljs-variable">@Scheduled</span>(fixedRate = <span class="hljs-number">5000</span>)
    public void <span class="hljs-built_in">retryFailedMessages</span>() {
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">FailedMessage</span>&gt; <span class="hljs-selector-tag">pendingMsgs</span> = <span class="hljs-selector-tag">failedMessageStorage</span><span class="hljs-selector-class">.queryPendingMessages</span>(System.<span class="hljs-built_in">currentTimeMillis</span>());
        <span class="hljs-selector-tag">for</span> (FailedMessage <span class="hljs-attribute">msg </span>: pendingMsgs) {
            <span class="hljs-selector-tag">try</span> {
                <span class="hljs-comment">// 1. 标记为“重试中”（避免并发重复处理）</span>
                <span class="hljs-selector-tag">failedMessageStorage</span><span class="hljs-selector-class">.updateStatus</span>(msg.<span class="hljs-built_in">getMsgId</span>(), <span class="hljs-string">"RETRYING"</span>);

                <span class="hljs-comment">// 2. 反序列化消息体</span>
                <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">message</span> = <span class="hljs-selector-tag">JSON</span><span class="hljs-selector-class">.parseObject</span>(msg.<span class="hljs-built_in">getMessageBody</span>(), Object.class); <span class="hljs-comment">// 根据实际类型强转</span>

                <span class="hljs-comment">// 3. 重新发送消息（携带原msgId）</span>
                <span class="hljs-selector-tag">CorrelationData</span> <span class="hljs-selector-tag">correlationData</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">CorrelationData</span>(msg.<span class="hljs-built_in">getMsgId</span>());
                <span class="hljs-selector-tag">rabbitTemplate</span><span class="hljs-selector-class">.convertAndSend</span>(msg.<span class="hljs-built_in">getExchange</span>(), msg.<span class="hljs-built_in">getRoutingKey</span>(), message, correlationData);

                <span class="hljs-comment">// 4. 更新重试次数和下次重试时间（指数退避：10s→20s→40s）</span>
                <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">newRetryCount</span> = <span class="hljs-selector-tag">msg</span><span class="hljs-selector-class">.getRetryCount</span>() + <span class="hljs-number">1</span>;
                <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">nextRetryInterval</span> = (long) (<span class="hljs-number">10</span> * Math.<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, newRetryCount - <span class="hljs-number">1</span>)) * <span class="hljs-number">1000</span>; <span class="hljs-comment">// 指数退避</span>
                <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">nextRetryTime</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>() + <span class="hljs-selector-tag">nextRetryInterval</span>;

                <span class="hljs-selector-tag">if</span> (newRetryCount &gt;= msg.<span class="hljs-built_in">getMaxRetry</span>()) {
                    <span class="hljs-comment">// 超过最大重试次数：转入死信队列</span>
                    <span class="hljs-selector-tag">deadLetterQueueHandler</span><span class="hljs-selector-class">.sendToDlx</span>(msg);
                    <span class="hljs-selector-tag">failedMessageStorage</span><span class="hljs-selector-class">.updateStatus</span>(msg.<span class="hljs-built_in">getMsgId</span>(), <span class="hljs-string">"FAILED"</span>);
                    <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.err</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"消息重试次数耗尽，转入死信队列，ID: "</span> + msg.<span class="hljs-built_in">getMsgId</span>());
                } <span class="hljs-selector-tag">else</span> {
                    <span class="hljs-comment">// 更新重试状态（次数+1，下次重试时间）</span>
                    <span class="hljs-selector-tag">failedMessageStorage</span><span class="hljs-selector-class">.updateRetryInfo</span>(msg.<span class="hljs-built_in">getMsgId</span>(), newRetryCount, nextRetryTime, <span class="hljs-string">"PENDING"</span>);
                    <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"消息重试中，ID: "</span> + msg.<span class="hljs-built_in">getMsgId</span>() + <span class="hljs-string">"，第"</span> + newRetryCount + <span class="hljs-string">"次"</span>);
                }
            } <span class="hljs-selector-tag">catch</span> (Exception e) {
                <span class="hljs-comment">// 重试过程中异常：恢复状态为PENDING，等待下次扫描</span>
                <span class="hljs-selector-tag">failedMessageStorage</span><span class="hljs-selector-class">.updateStatus</span>(msg.<span class="hljs-built_in">getMsgId</span>(), <span class="hljs-string">"PENDING"</span>);
                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.err</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"重试发送失败，ID: "</span> + msg.<span class="hljs-built_in">getMsgId</span>() + <span class="hljs-string">"，错误: "</span> + e.<span class="hljs-built_in">getMessage</span>());
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-6"><strong>5. 死信队列兜底（重试失败的最终处理）</strong></h4>
<p>当消息超过最大重试次数仍未成功，将其转入<strong>死信队列（DLX）</strong> ，人工介入处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeadLetterQueueHandler</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendToDlx</span><span class="hljs-params">(FailedMessage msg)</span> {
        <span class="hljs-comment">// 发送到死信交换机（需提前配置死信队列和交换机）</span>
        rabbitTemplate.convertAndSend(
            <span class="hljs-string">"dlx.exchange"</span>, 
            <span class="hljs-string">"dlx.routingKey"</span>, 
            msg.getMessageBody(),
            message -&gt; {
                <span class="hljs-type">MessageProperties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> message.getMessageProperties();
                props.setHeader(<span class="hljs-string">"failed_reason"</span>, <span class="hljs-string">"max_retry_exceeded"</span>);
                props.setHeader(<span class="hljs-string">"original_msg_id"</span>, msg.getMsgId());
                <span class="hljs-keyword">return</span> message;
            }
        );
    }
}
</code></pre>
<h3 data-id="heading-7"><strong>三、关键技术点说明</strong></h3>
<h4 data-id="heading-8"><strong>1. 重试策略</strong></h4>
<ul>
<li><strong>指数退避</strong>：重试间隔随次数递增（如 10s→20s→40s），避免集中重试压垮 Broker；</li>
<li><strong>固定间隔</strong>：简单场景用固定间隔（如每 30 秒重试一次）；</li>
<li><strong>随机间隔</strong>：避免多个生产者同时重试导致“惊群效应”。</li>
</ul>
<h4 data-id="heading-9"><strong>2. 幂等性保障</strong></h4>
<p>重试可能导致消息重复投递，消费者需通过 <strong>唯一ID去重</strong>（如 Redis 记录已处理 <code>msg_id</code>，有效期 24 小时）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdempotentConsumer</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">RedisTemplate</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; redisTemplate;

    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"order.queue"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">consume</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> message, <span class="hljs-meta">@Header</span>(<span class="hljs-string">"msg_id"</span>) <span class="hljs-built_in">String</span> msgId</span>) {
        <span class="hljs-title class_">String</span> key = <span class="hljs-string">"processed_msg:"</span> + msgId;
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Boolean</span>.<span class="hljs-property">TRUE</span>.<span class="hljs-title function_">equals</span>(redisTemplate.<span class="hljs-title function_">hasKey</span>(key))) {
            <span class="hljs-comment">// 已处理，直接确认</span>
            channel.<span class="hljs-title function_">basicAck</span>(deliveryTag, <span class="hljs-literal">false</span>);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 业务逻辑处理...</span>
        redisTemplate.<span class="hljs-title function_">opsForValue</span>().<span class="hljs-title function_">set</span>(key, <span class="hljs-string">"1"</span>, <span class="hljs-number">24</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">HOURS</span>); <span class="hljs-comment">// 记录已处理</span>
        channel.<span class="hljs-title function_">basicAck</span>(deliveryTag, <span class="hljs-literal">false</span>);
    }
}
</code></pre>
<h4 data-id="heading-10"><strong>3. 存储选型对比</strong></h4>





























<table><thead><tr><th>存储方式</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>MySQL</td><td>持久化可靠，支持复杂查询</td><td>性能较低，需维护数据库连接</td><td>生产环境（消息重要性高）</td></tr><tr><td>Redis</td><td>高性能，支持过期时间</td><td>数据易失（需开启RDB/AOF持久化）</td><td>中小规模、对性能要求高的场景</td></tr><tr><td>内存队列</td><td>速度快</td><td>重启丢失消息</td><td>测试环境或临时重试</td></tr></tbody></table>
<h3 data-id="heading-11"><strong>四、总结</strong></h3>
<p>生产者确认失败后的重试重新投递，本质是 <strong>“存储-调度-重试-兜底”</strong> 的闭环：</p>
<ol>
<li><strong>存储</strong>：用数据库/Redis 持久化失败消息；</li>
<li><strong>调度</strong>：定时任务扫描待重试消息；</li>
<li><strong>重试</strong>：按指数退避策略重新发送，更新重试状态；</li>
<li><strong>兜底</strong>：超过次数后转入死信队列，人工介入。</li>
</ol>
<p>通过这套机制，可确保消息在<strong>网络抖动、Broker 临时不可用</strong>等场景下仍能最终投递成功，同时避免无限重试的资源浪费。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：CommonJS 与ES6 模块]]></title>    <link>https://juejin.cn/post/7580745065171419187</link>    <guid>https://juejin.cn/post/7580745065171419187</guid>    <pubDate>2025-12-08T06:09:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580745065171419187" data-draft-id="7580971667037503514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：CommonJS 与ES6 模块"/> <meta itemprop="keywords" content="后端,Node.js,Trae"/> <meta itemprop="datePublished" content="2025-12-08T06:09:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：CommonJS 与ES6 模块
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:09:35.000Z" title="Mon Dec 08 2025 06:09:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在构建 Node.js 项目时，“模块化”是开发者必须掌握的基础能力。随着生态的发展，Node.js 同时支持两套模块体系：<strong>CommonJS（CJS）</strong> 与 <strong>ES6 Module（ESM）</strong>。它们的出现背景不同，语法也不同，甚至在行为上存在显著差异。对模块系统理解得越深，构建大型项目时就越得心应手。</p>
</blockquote>
<p>本文将从模块概念、使用方式、差异点到实际项目中的选择策略，帮助你系统掌握 Node.js 中两种模块体系的核心逻辑。</p>
<hr/>
<h2 data-id="heading-0">一、模块化的意义</h2>
<p>在没有模块机制前，代码需要通过 script 标签或全局变量共享，容易发生命名污染、文件耦合和维护困难。模块化解决了这些痛点，带来了：</p>
<ul>
<li>清晰的项目结构</li>
<li>代码隔离与作用域安全</li>
<li>可复用与可维护的代码组织方式</li>
<li>更易扩展的大型工程能力</li>
</ul>
<p>Node.js 天生以模块为单位组织代码，因此掌握模块系统是学习 Node.js 的必备基础。</p>
<hr/>
<h2 data-id="heading-1">二、CommonJS：Node.js 默认模块系统</h2>
<p>CommonJS 是 Node.js 诞生之初采用的模块机制，主要特点是：</p>
<ul>
<li>同步加载</li>
<li>运行时执行</li>
<li>使用 <code>require</code> 导入</li>
<li>使用 <code>module.exports</code> 导出</li>
</ul>
<p>Node.js 的核心模块（fs、path 等）都基于 CommonJS 构建。</p>
<h3 data-id="heading-2">1. CommonJS 导入</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);
</code></pre>
<h3 data-id="heading-3">2. CommonJS 导出</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-title function_">sum</span>(<span class="hljs-params">a, b</span>) {
    <span class="hljs-keyword">return</span> a + b;
  }
};
</code></pre>
<p>也可以使用简写：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">exports</span>.<span class="hljs-property">test</span> = <span class="hljs-function">() =&gt;</span> {};
</code></pre>
<p>CommonJS 是“执行时加载”，模块在第一次被 <code>require</code> 时执行并缓存。</p>
<hr/>
<h2 data-id="heading-4">三、ES6 模块：现代 JavaScript 模块体系</h2>
<p>ES6 Module 是 ECMAScript 官方推出的模块标准，旨在统一前后端 JavaScript 的模块化规范。</p>
<p>特点包括：</p>
<ul>
<li>静态解析（编译时确定导入导出）</li>
<li>支持 tree-shaking</li>
<li>语法更简洁</li>
<li>异步加载能力更好</li>
</ul>
<h3 data-id="heading-5">1. ES6 导入</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"fs"</span>;
</code></pre>
<h3 data-id="heading-6">2. ES6 导出</h3>
<p>默认导出：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {}
</code></pre>
<p>命名导出：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">a, b</span>) {}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PI</span> = <span class="hljs-number">3.14</span>;
</code></pre>
<p>ESM 具有可在编译阶段分析依赖的优势，使其更符合现代工程化趋势。</p>
<hr/>
<h2 data-id="heading-7">四、CJS 与 ESM 之间的差异</h2>
<p>虽然两者都能实现模块化，但它们在机制和行为上有明显不同。</p>
<h3 data-id="heading-8">1. 加载方式不同</h3>
<ul>
<li>CommonJS：同步加载</li>
<li>ES Module：异步且静态解析</li>
</ul>
<p>因此 ESM 更适合浏览器和未来的 Node.js 优化场景。</p>
<hr/>
<h3 data-id="heading-9">2. 语法差异</h3>

























<table><thead><tr><th>功能</th><th>CommonJS</th><th>ES6 Module</th></tr></thead><tbody><tr><td>导入</td><td><code>require()</code></td><td><code>import</code></td></tr><tr><td>导出</td><td><code>module.exports</code></td><td><code>export</code></td></tr><tr><td>默认导出</td><td><code>module.exports = obj</code></td><td><code>export default obj</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-10">3. 导入路径限制不同</h3>
<p>CommonJS 可以省略文件后缀：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">require</span>(<span class="hljs-string">"./util"</span>);
</code></pre>
<p>ESM 必须写完整后缀：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">"./util.js"</span>;
</code></pre>
<hr/>
<h3 data-id="heading-11">4. this 指向不同</h3>
<ul>
<li>CommonJS 中的 <code>this</code> 指向 <code>module.exports</code></li>
<li>ES Module 中的 <code>this</code> 是 <code>undefined</code></li>
</ul>
<p>反映了两者的设计理念差异。</p>
<hr/>
<h3 data-id="heading-12">5. 顶层 await 支持</h3>
<p>ESM 支持在模块顶层使用 <code>await</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
</code></pre>
<p>而 CommonJS 不支持，只能通过 async 包裹。</p>
<hr/>
<h2 data-id="heading-13">五、在 Node.js 中如何选择模块体系？</h2>
<p>目前 Node.js 同时支持 CJS 与 ESM，两者各有适用场景。</p>
<h3 data-id="heading-14">1. 选择 CommonJS 的场景</h3>
<ul>
<li>旧项目或需要兼容早期 Node.js</li>
<li>使用大量历史库，CJS 生态更完整</li>
<li>工具类、脚本类程序，启动速度要求高</li>
</ul>
<p>CommonJS 更稳定，也更符合 Node.js 的传统开发模式。</p>
<hr/>
<h3 data-id="heading-15">2. 选择 ES6 Module 的场景</h3>
<ul>
<li>新项目倾向现代规范</li>
<li>更好配合 bundler（如 Webpack、Vite）</li>
<li>需要顶层 await</li>
<li>项目需要压缩 tree-shaking</li>
</ul>
<p>现代项目逐渐转向 ESM，也符合前后端统一的趋势。</p>
<hr/>
<h2 data-id="heading-16">六、如何配置 Node.js 以使用 ES Module？</h2>
<p>Node.js 默认使用 CommonJS，如果需要启用 ES Module，可以采用两种方式：</p>
<h3 data-id="heading-17">方式 1：将 package.json 配置为 ES Module</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-18">方式 2：使用 <code>.mjs</code> 扩展名</h3>
<pre><code class="hljs">app.mjs
utils.mjs
</code></pre>
<p>两者都可以，让 Node.js 按 ESM 规范解析文件。</p>
<hr/>
<h2 data-id="heading-19">七、在同一项目中混用 CJS 和 ESM</h2>
<p>在某些情况下，你可能需要混用模块。</p>
<h3 data-id="heading-20">从 CJS 导入 ESM</h3>
<p>需要异步动态导入：</p>
<pre><code class="hljs language-js" lang="js">(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"./esm-module.js"</span>);
})();
</code></pre>
<h3 data-id="heading-21">从 ESM 导入 CJS</h3>
<p>支持默认导入：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> pkg <span class="hljs-keyword">from</span> <span class="hljs-string">"./cjs-module.cjs"</span>;
</code></pre>
<p>混用不推荐作为长期方案，但在迁移阶段非常常见。</p>
<hr/>
<h2 data-id="heading-22">八、总结</h2>
<p>CommonJS 和 ES6 Module 代表了 Node.js 的过去与未来：</p>
<ul>
<li>CommonJS 稳定、成熟，是 Node.js 的传统基础。</li>
<li>ES6 Module 现代、可优化，是未来趋势。</li>
</ul>
<p>两者在加载方式、语法、依赖解析、工具链支持等方面都有不同。理解两者的设计逻辑，才能在项目中做出正确选择。</p>
<p>在实际开发中：</p>
<ul>
<li><strong>新项目优先 ESM</strong></li>
<li><strong>旧项目继续使用 CJS 更稳</strong></li>
<li><strong>混用时注意异步 import 与导入路径规则</strong></li>
</ul>
<p>掌握模块系统，是深入 Node.js 的重要一步。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全网最全的 qiankun 基于 react18+（主应用）、vue3.4+（微应用）实现页签缓存，页面缓存]]></title>    <link>https://juejin.cn/post/7580683234437152831</link>    <guid>https://juejin.cn/post/7580683234437152831</guid>    <pubDate>2025-12-08T06:07:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580683234437152831" data-draft-id="7580740782933442602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全网最全的 qiankun 基于 react18+（主应用）、vue3.4+（微应用）实现页签缓存，页面缓存"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-08T06:07:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="四眼肥鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2995504913591661"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全网最全的 qiankun 基于 react18+（主应用）、vue3.4+（微应用）实现页签缓存，页面缓存
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2995504913591661/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    四眼肥鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:07:01.000Z" title="Mon Dec 08 2025 06:07:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    40
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Qiankun 微前端配置与页签缓存实现方案</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7298446b216143618e28af6ceb3b6b7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zub55y86IKl6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779420&amp;x-signature=kz3%2B3I9X5fCIwDXoHeK5RynAkjk%3D" alt="qiankun-blue.jpg" loading="lazy"/></p>
<blockquote>
<p>需要源码可以私信我</p>
</blockquote>
<h3 data-id="heading-1">📋 目录</h3>
<ul>
<li><a href="#%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0" title="#%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0">项目概述</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" title="#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF">实现思路</a></li>
<li><a href="#qiankun-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88" title="#qiankun-%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88">Qiankun 配置方案</a></li>
<li><a href="#%E5%AD%90%E5%BA%94%E7%94%A8%E9%A1%B5%E7%AD%BE%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0" title="#%E5%AD%90%E5%BA%94%E7%94%A8%E9%A1%B5%E7%AD%BE%E7%BC%93%E5%AD%98%E5%AE%9E%E7%8E%B0">子应用页签缓存实现</a></li>
<li><a href="#%E5%AD%90%E5%BA%94%E7%94%A8%E5%88%87%E6%8D%A2%E5%AE%9E%E7%8E%B0" title="#%E5%AD%90%E5%BA%94%E7%94%A8%E5%88%87%E6%8D%A2%E5%AE%9E%E7%8E%B0">子应用切换实现</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90" title="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90">核心代码解析</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E" title="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E">使用说明</a></li>
<li><a href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" title="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">注意事项</a></li>
</ul>
<hr/>
<h3 data-id="heading-2">项目概述</h3>
<p>基于 <strong>qiankun</strong> 微前端框架实现了一个支持<strong>多页签缓存</strong>和<strong>子应用保活</strong>的主应用系统。主要特性包括：</p>
<ul>
<li>✅ 手动挂载模式（<code>loadMicroApp</code>）</li>
<li>✅ 子应用保活缓存机制</li>
<li>✅ 多页签状态同步</li>
<li>✅ 子应用间快速切换</li>
<li>✅ 页面刷新自动恢复</li>
</ul>
<h4 data-id="heading-3">技术栈</h4>
<ul>
<li><strong>主框架</strong>: React + TypeScript</li>
<li><strong>微前端框架</strong>: qiankun</li>
<li><strong>微应用框架</strong>：vue 全家桶</li>
<li><strong>微应用兼容 vite 方案</strong>：vite-plugin-qiankun</li>
<li><strong>主应用状态管理</strong>: Redux Toolkit</li>
<li><strong>主应用路由</strong>: React Router</li>
<li><strong>主应用UI 组件库</strong>: TDesign</li>
</ul>
<hr/>
<h3 data-id="heading-4">实现思路</h3>
<h4 data-id="heading-5">1. 整体架构设计</h4>
<p>本方案采用 <strong>"手动挂载 + 容器保活"</strong> 的架构模式，核心思想是：</p>
<ul>
<li><strong>主应用</strong>（React）作为容器和调度中心，负责微应用的注册、挂载、卸载和状态管理</li>
<li><strong>子应用</strong>（Vue）作为独立的功能模块，通过 qiankun 生命周期钩子接入</li>
<li><strong>页签系统</strong>作为用户交互层，管理多个子应用页面的打开、切换和关闭</li>
<li><strong>缓存机制</strong>通过 DOM 容器复用实现子应用保活，避免重复挂载带来的性能损耗</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph MainApp["主应用 (React)"]
        TagsView["页签管理&lt;br/&gt;TagsView"]
        Router["路由管理&lt;br/&gt;Router"]
        Redux["状态管理&lt;br/&gt;Redux"]
        Manager["微应用管理器&lt;br/&gt;registerApp.ts"]
        
        TagsView --&gt; Manager
        Router --&gt; Manager
        Redux --&gt; Manager
    end
    
    subgraph Containers["容器层"]
        Container1["容器1&lt;br/&gt;subApp-app1"]
        Container2["容器2&lt;br/&gt;subApp-app2"]
        Container3["容器3&lt;br/&gt;subApp-app3"]
    end
    
    subgraph SubApps["子应用层"]
        SubApp1["子应用1&lt;br/&gt;(Vue)"]
        SubApp2["子应用2&lt;br/&gt;(Vue)"]
        SubApp3["子应用3&lt;br/&gt;(Vue)"]
    end
    
    Manager --&gt; Container1
    Manager --&gt; Container2
    Manager --&gt; Container3
    
    Container1 --&gt; SubApp1
    Container2 --&gt; SubApp2
    Container3 --&gt; SubApp3
    
    style MainApp fill:#e1f5ff
    style Containers fill:#fff4e1
    style SubApps fill:#e8f5e9
</code></pre>
<h4 data-id="heading-6">2. 核心设计理念</h4>
<h5 data-id="heading-7">2.1 容器隔离策略</h5>
<p><strong>问题</strong>：qiankun 默认的 <code>singular: true</code> 模式只允许同时挂载一个子应用，切换时需要卸载旧应用再挂载新应用，导致：</p>
<ul>
<li>应用状态丢失</li>
<li>重复加载资源</li>
<li>用户体验差</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>设置 <code>singular: false</code>，允许多实例共存</li>
<li>为每个子应用创建独立的 DOM 容器（<code>subApp-{appName}</code>）</li>
<li>通过 <code>display: none/block</code> 控制容器显示/隐藏</li>
<li>应用实例保留在内存中，实现真正的"保活"</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 关键配置</span>
{
  <span class="hljs-attr">singular</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 允许多实例</span>
  <span class="hljs-attr">sandbox</span>: {
    <span class="hljs-attr">strictStyleIsolation</span>: <span class="hljs-literal">false</span>,
  }
}

<span class="hljs-comment">// 容器创建</span>
<span class="hljs-keyword">const</span> containerId = <span class="hljs-string">`subApp-<span class="hljs-subst">${appName}</span>`</span>
container.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>  <span class="hljs-comment">// 初始隐藏</span>
</code></pre>
<h5 data-id="heading-8">2.2 LRU 缓存淘汰策略</h5>
<p><strong>问题</strong>：无限缓存会导致内存泄漏和性能问题</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>维护一个 <code>Map&lt;string, CachedMicroApp&gt;</code> 缓存池</li>
<li>记录每个应用的 <code>lastActiveTime</code>（最后激活时间）</li>
<li>当缓存数量超过 <code>MAX_CACHED_APPS</code>（默认 5）时，自动清理最旧的非当前应用</li>
<li>确保当前激活的应用不会被清理</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 缓存结构</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CachedMicroApp</span> = {
  <span class="hljs-attr">instance</span>: <span class="hljs-title class_">QiankunMicroApp</span>    <span class="hljs-comment">// qiankun 实例</span>
  <span class="hljs-attr">containerId</span>: <span class="hljs-built_in">string</span>          <span class="hljs-comment">// DOM 容器 ID</span>
  <span class="hljs-attr">lastActiveTime</span>: <span class="hljs-built_in">number</span>       <span class="hljs-comment">// 最后激活时间（LRU 关键）</span>
  <span class="hljs-attr">entry</span>: <span class="hljs-built_in">string</span>               <span class="hljs-comment">// 入口地址</span>
}

<span class="hljs-comment">// LRU 清理逻辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">cleanupOldestCachedApp</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 找到最旧的非当前激活应用</span>
  <span class="hljs-keyword">let</span> oldestName = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">let</span> oldestTime = <span class="hljs-title class_">Infinity</span>
  cachedMicroApps.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">cached, name</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (name !== currentAppName &amp;&amp; cached.<span class="hljs-property">lastActiveTime</span> &lt; oldestTime) {
      oldestTime = cached.<span class="hljs-property">lastActiveTime</span>
      oldestName = name
    }
  })
  <span class="hljs-keyword">if</span> (oldestName) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">destroyCachedApp</span>(oldestName)
  }
}
</code></pre>
<h5 data-id="heading-9">2.3 状态同步机制</h5>
<p><strong>问题</strong>：主应用的页签状态需要同步到子应用，让子应用知道哪些页面需要缓存</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用 qiankun 的 <code>initGlobalState</code> 创建全局状态</li>
<li>主应用在页签变化时通过 <code>setGlobalState</code> 推送状态</li>
<li>子应用通过 <code>onGlobalStateChange</code> 监听状态变化</li>
<li>状态包含 <code>cachedTags</code>（需要缓存的页签列表）和 <code>activeTagId</code>（当前激活的页签 ID）</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 主应用推送</span>
<span class="hljs-keyword">const</span> action = <span class="hljs-title function_">initGlobalState</span>({ 
  <span class="hljs-attr">cachedTags</span>: [<span class="hljs-string">'/page1'</span>, <span class="hljs-string">'/page2'</span>], 
  <span class="hljs-attr">activeTagId</span>: <span class="hljs-string">'tag-1'</span> 
})
action.<span class="hljs-title function_">setGlobalState</span>({ cachedTags, activeTagId })

<span class="hljs-comment">// 子应用监听</span>
props.<span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { cachedTags, activeTagId } = state
  <span class="hljs-comment">// 更新子应用的 keep-alive 缓存</span>
  <span class="hljs-title function_">updateKeepAliveCache</span>(cachedTags)
}, <span class="hljs-literal">true</span>)
</code></pre>
<h4 data-id="heading-10">3. 关键技术实现</h4>
<h5 data-id="heading-11">3.1 挂载流程设计</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start([用户操作&lt;br/&gt;点击页签/路由变化]) --&gt; CheckCache{检查缓存中&lt;br/&gt;是否存在该应用}
    
    CheckCache --&gt;|缓存命中| HideAll[隐藏所有容器]
    CheckCache --&gt;|缓存未命中| CheckFull{检查缓存&lt;br/&gt;是否已满}
    
    HideAll --&gt; ShowTarget[显示目标容器]
    ShowTarget --&gt; UpdateTime1[更新激活时间]
    UpdateTime1 --&gt; UpdateURL1[更新 URL]
    UpdateURL1 --&gt; TriggerEvent1[触发路由事件]
    TriggerEvent1 --&gt; Return1([返回实例&lt;br/&gt;快速响应])
    
    CheckFull --&gt;|已满| CleanLRU[清理最旧应用&lt;br/&gt;LRU策略]
    CheckFull --&gt;|未满| CreateContainer[创建新容器]
    CleanLRU --&gt; CreateContainer
    
    CreateContainer --&gt; LoadApp[使用 loadMicroApp 挂载]
    LoadApp --&gt; WaitMount[等待挂载完成]
    WaitMount --&gt; ShowContainer[显示容器]
    ShowContainer --&gt; AddCache[加入缓存]
    AddCache --&gt; UpdateTime2[更新激活时间]
    UpdateTime2 --&gt; TriggerEvent2[触发路由事件]
    TriggerEvent2 --&gt; Return2([返回实例])
    
    style Start fill:#e1f5ff
    style Return1 fill:#c8e6c9
    style Return2 fill:#c8e6c9
    style CheckCache fill:#fff4e1
    style CheckFull fill:#fff4e1
</code></pre>
<h5 data-id="heading-12">3.2 切换优化策略</h5>
<p><strong>同应用内切换</strong>：</p>
<ul>
<li>只需更新路由（<code>navigate</code>）</li>
<li>触发 <code>hashchange</code> 事件</li>
<li>子应用内部路由处理</li>
<li><strong>无需重新挂载，性能最优</strong></li>
</ul>
<p><strong>跨应用切换</strong>：</p>
<ul>
<li>检查目标应用是否在缓存中</li>
<li>缓存命中：直接显示容器（毫秒级响应）</li>
<li>缓存未命中：创建容器并挂载（首次加载）</li>
<li><strong>缓存命中时接近同应用切换的性能</strong></li>
</ul>
<h5 data-id="heading-13">3.3 卸载策略</h5>
<p><strong>保活模式下的卸载</strong>：</p>
<ul>
<li>不执行真正的 <code>unmount()</code></li>
<li>仅隐藏容器（<code>display: none</code>）</li>
<li>保留应用实例和状态</li>
<li><strong>下次激活时直接显示，无需重新挂载</strong></li>
</ul>
<p><strong>强制卸载场景</strong>：</p>
<ul>
<li>页面刷新</li>
<li>用户登出</li>
<li>手动清理缓存</li>
<li>执行真正的 <code>unmount()</code> 和容器销毁</li>
</ul>
<h4 data-id="heading-14">4. 数据流设计</h4>
<h5 data-id="heading-15">4.1 页签状态流</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start([路由变化&lt;br/&gt;location.hash]) --&gt; Listen[TagsView 监听&lt;br/&gt;useEffect]
    Listen --&gt; FindMatch[从 mircoAppHash&lt;br/&gt;查找匹配项]
    FindMatch --&gt; CheckExist{检查页签&lt;br/&gt;是否已存在}
    
    CheckExist --&gt;|已存在| UpdateActive[更新激活 ID]
    CheckExist --&gt;|不存在| AddTag[添加新页签]
    
    UpdateActive --&gt; Notify1[通知子应用缓存]
    
    AddTag --&gt; UpdateRedux[更新 Redux]
    UpdateRedux --&gt; Notify2[通知子应用缓存]
    
    style Start fill:#e1f5ff
    style CheckExist fill:#fff4e1
    style Notify1 fill:#c8e6c9
    style Notify2 fill:#c8e6c9
</code></pre>
<h5 data-id="heading-16">4.2 应用挂载流</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start([页签切换&lt;br/&gt;changeHandle]) --&gt; CheckSame{判断是否&lt;br/&gt;同应用}
    
    CheckSame --&gt;|同应用| UpdateRoute[更新路由]
    CheckSame --&gt;|不同应用| MountApp[调用 mountMicroApp]
    
    UpdateRoute --&gt; TriggerHash[触发 hashchange]
    
    MountApp --&gt; CheckCache{检查缓存}
    CheckCache --&gt;|缓存命中| ShowContainer[显示容器]
    CheckCache --&gt;|缓存未命中| CreateAndMount[创建容器并挂载]
    
    ShowContainer --&gt; UpdateURL[更新 URL]
    UpdateURL --&gt; Return([返回实例])
    
    CreateAndMount --&gt; Return
    
    style Start fill:#e1f5ff
    style CheckSame fill:#fff4e1
    style CheckCache fill:#fff4e1
    style Return fill:#c8e6c9
</code></pre>
<h4 data-id="heading-17">5. 性能优化考虑</h4>
<h5 data-id="heading-18">5.1 内存管理</h5>
<ul>
<li><strong>限制缓存数量</strong>：最多 5 个应用，防止内存溢出</li>
<li><strong>LRU 自动清理</strong>：超出限制时自动清理最旧应用</li>
<li><strong>按需卸载</strong>：非保活模式或强制卸载时才真正销毁</li>
</ul>
<h5 data-id="heading-19">5.2 加载优化</h5>
<ul>
<li><strong>缓存命中</strong>：直接显示容器，响应时间 &lt; 10ms</li>
<li><strong>首次加载</strong>：使用 <code>loadMicroApp</code> 按需加载，避免预加载所有应用</li>
<li><strong>容器复用</strong>：同一应用多次打开复用同一容器</li>
</ul>
<h5 data-id="heading-20">5.3 状态同步优化</h5>
<ul>
<li><strong>批量更新</strong>：页签变化时批量推送状态，减少通信次数</li>
<li><strong>按需监听</strong>：子应用按需订阅全局状态，避免不必要的更新</li>
</ul>
<h4 data-id="heading-21">6. 兼容性设计</h4>
<h5 data-id="heading-22">6.1 Vite 子应用支持</h5>
<ul>
<li>使用 <code>vite-plugin-qiankun</code> 插件</li>
<li>子应用需要配置正确的 <code>publicPath</code></li>
<li>支持开发环境和生产环境的不同配置</li>
</ul>
<h5 data-id="heading-23">6.2 路由兼容</h5>
<ul>
<li>主应用使用 React Router</li>
<li>子应用使用 Vue Router（hash 模式）</li>
<li>通过 <code>window.location.hash</code> 和事件触发实现路由同步</li>
</ul>
<h5 data-id="heading-24">6.3 样式隔离</h5>
<ul>
<li>当前未启用严格样式隔离（<code>strictStyleIsolation: false</code>）</li>
<li>建议子应用使用 CSS Modules 或 scoped 样式</li>
<li>避免全局样式污染</li>
</ul>
<h4 data-id="heading-25">7. 错误处理与容错</h4>
<h5 data-id="heading-26">7.1 挂载失败处理</h5>
<ul>
<li>捕获异常并显示错误提示</li>
<li>清理失败的容器和缓存</li>
<li>允许用户重试</li>
</ul>
<h5 data-id="heading-27">7.2 容器不存在处理</h5>
<ul>
<li>自动创建容器（<code>ensureContainer</code>）</li>
<li>支持多种父容器选择器降级</li>
<li>容器创建失败时抛出明确错误</li>
</ul>
<h5 data-id="heading-28">7.3 页面刷新恢复</h5>
<ul>
<li>根据当前 URL 自动识别需要挂载的应用</li>
<li>从配置映射表查找匹配的微应用</li>
<li>自动恢复挂载状态</li>
</ul>
<hr/>
<p><strong>总结</strong>：本方案通过容器隔离、LRU 缓存、状态同步等核心机制，实现了高效的微应用页签缓存系统，在保证用户体验的同时有效控制了资源消耗。</p>
<h3 data-id="heading-29">Qiankun 配置方案</h3>
<h4 data-id="heading-30">1. 基础配置</h4>
<p>项目采用 <strong>手动挂载模式</strong>（<code>loadMicroApp</code>），而非路由自动注册模式（<code>registerMicroApps</code>）。这种方式提供了更精细的控制能力，特别适合需要保活缓存的场景。</p>
<h5 data-id="heading-31">核心配置参数</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/registerApp.ts</span>

<span class="hljs-comment">// 沙箱配置</span>
<span class="hljs-keyword">const</span> sandboxConfig = {
  <span class="hljs-attr">sandbox</span>: {
    <span class="hljs-attr">strictStyleIsolation</span>: <span class="hljs-literal">false</span>,        <span class="hljs-comment">// 不启用严格样式隔离</span>
    <span class="hljs-attr">experimentalStyleIsolation</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 不启用实验性样式隔离</span>
  },
  <span class="hljs-attr">singular</span>: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 允许多实例同时存在（保活必需）</span>
}
</code></pre>
<h5 data-id="heading-32">微应用配置类型</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MicroAppConfig</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>          <span class="hljs-comment">// 微应用名称（唯一标识）</span>
  <span class="hljs-attr">entry</span>: <span class="hljs-built_in">string</span>        <span class="hljs-comment">// 微应用入口地址</span>
  <span class="hljs-attr">container</span>: <span class="hljs-built_in">string</span>    <span class="hljs-comment">// 容器选择器</span>
  <span class="hljs-attr">activeRule</span>: <span class="hljs-built_in">string</span>   <span class="hljs-comment">// 激活规则（路由匹配）</span>
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">MicroAppProps</span> <span class="hljs-comment">// 传递给子应用的 props</span>
}
</code></pre>
<h4 data-id="heading-33">2. 微应用 Props 配置（我自己的项目是这样的可以根据实际进行更改）</h4>
<p>主应用通过 <code>props</code> 向子应用传递必要的上下文和方法：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MicroAppProps</span> = {
  <span class="hljs-attr">token</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>              <span class="hljs-comment">// 用户 token</span>
  <span class="hljs-attr">onLogin</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>               <span class="hljs-comment">// 登录回调</span>
  <span class="hljs-attr">message</span>: <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">MessagePlugin</span>     <span class="hljs-comment">// 消息提示组件</span>
  <span class="hljs-attr">notification</span>: <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">NotificationPlugin</span>  <span class="hljs-comment">// 通知组件</span>
  <span class="hljs-attr">getUserInfo</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">UserData</span>       <span class="hljs-comment">// 获取用户信息</span>
  <span class="hljs-attr">usePermissionList</span>: <span class="hljs-built_in">string</span>[]      <span class="hljs-comment">// 权限列表</span>
  <span class="hljs-attr">getBtnCodeList</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span>[]   <span class="hljs-comment">// 按钮权限列表</span>
  <span class="hljs-attr">fetchUserInfo</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>        <span class="hljs-comment">// 刷新用户信息</span>
  <span class="hljs-attr">onRefreshPage</span>: <span class="hljs-function">(<span class="hljs-params">fn: () =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>  <span class="hljs-comment">// 页面刷新回调</span>
  <span class="hljs-attr">onLogOut</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>             <span class="hljs-comment">// 登出回调</span>
  <span class="hljs-attr">addTagView</span>: <span class="hljs-function">(<span class="hljs-params">path: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>  <span class="hljs-comment">// 添加页签</span>
  <span class="hljs-attr">getDefaultPath</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>  <span class="hljs-comment">// 获取默认路径</span>
}
</code></pre>
<h4 data-id="heading-34">3. 容器管理</h4>
<p>每个微应用使用独立的 DOM 容器，通过容器显示/隐藏实现保活：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 容器命名规则: subApp-{appName}</span>
<span class="hljs-keyword">const</span> containerId = <span class="hljs-string">`subApp-<span class="hljs-subst">${appName}</span>`</span>

<span class="hljs-comment">// 容器样式</span>
container.<span class="hljs-property">className</span> = <span class="hljs-string">'h-full w-full absolute inset-0'</span>
container.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>  <span class="hljs-comment">// 初始隐藏</span>
</code></pre>
<hr/>
<h3 data-id="heading-35">子应用页签缓存实现</h3>
<h4 data-id="heading-36">1. 缓存架构</h4>
<h5 data-id="heading-37">缓存数据结构</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">CachedMicroApp</span> = {
  <span class="hljs-attr">instance</span>: <span class="hljs-title class_">QiankunMicroApp</span>    <span class="hljs-comment">// qiankun 微应用实例</span>
  <span class="hljs-attr">containerId</span>: <span class="hljs-built_in">string</span>          <span class="hljs-comment">// DOM 容器 ID</span>
  <span class="hljs-attr">lastActiveTime</span>: <span class="hljs-built_in">number</span>       <span class="hljs-comment">// 最后激活时间（用于 LRU 清理）</span>
  <span class="hljs-attr">entry</span>: <span class="hljs-built_in">string</span>               <span class="hljs-comment">// 入口地址</span>
}

<span class="hljs-comment">// 缓存存储</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">cachedMicroApps</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">CachedMicroApp</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
</code></pre>
<h5 data-id="heading-38">缓存配置</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 是否启用保活模式（默认启用）</span>
<span class="hljs-keyword">let</span> keepAliveEnabled = <span class="hljs-literal">true</span>

<span class="hljs-comment">// 最大缓存数量（超过时清理最旧的应用）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_CACHED_APPS</span> = <span class="hljs-number">5</span>
</code></pre>
<h4 data-id="heading-39">2. 缓存生命周期</h4>
<h5 data-id="heading-40">2.1 首次挂载（缓存创建）</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 检查缓存是否已满，清理最旧的应用</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">cleanupOldestCachedApp</span>()

<span class="hljs-comment">// 2. 隐藏所有已缓存的应用容器</span>
<span class="hljs-title function_">hideAllCachedContainers</span>()

<span class="hljs-comment">// 3. 为新应用创建独立容器</span>
<span class="hljs-keyword">const</span> appContainerId = <span class="hljs-title function_">createAppContainer</span>(name, mainContainerId)

<span class="hljs-comment">// 4. 使用 loadMicroApp 挂载</span>
<span class="hljs-keyword">const</span> microApp = <span class="hljs-title function_">loadMicroApp</span>({
  name,
  entry,
  <span class="hljs-attr">container</span>: <span class="hljs-string">`#<span class="hljs-subst">${appContainerId}</span>`</span>,
  <span class="hljs-attr">props</span>: mergedProps,
}, sandboxConfig)

<span class="hljs-comment">// 5. 等待挂载完成</span>
<span class="hljs-keyword">await</span> microApp.<span class="hljs-property">mountPromise</span>

<span class="hljs-comment">// 6. 显示容器并加入缓存</span>
<span class="hljs-title function_">showAppContainer</span>(appContainerId)
cachedMicroApps.<span class="hljs-title function_">set</span>(name, {
  <span class="hljs-attr">instance</span>: microApp,
  <span class="hljs-attr">containerId</span>: appContainerId,
  <span class="hljs-attr">lastActiveTime</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
  entry,
})
</code></pre>
<h5 data-id="heading-41">2.2 从缓存激活</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 检查缓存中是否存在</span>
<span class="hljs-keyword">const</span> cached = cachedMicroApps.<span class="hljs-title function_">get</span>(name)

<span class="hljs-keyword">if</span> (cached) {
  <span class="hljs-comment">// 2. 隐藏所有其他应用的容器</span>
  <span class="hljs-title function_">hideAllCachedContainers</span>()
  
  <span class="hljs-comment">// 3. 显示目标应用的容器</span>
  <span class="hljs-title function_">showAppContainer</span>(cached.<span class="hljs-property">containerId</span>)
  
  <span class="hljs-comment">// 4. 更新激活时间</span>
  cached.<span class="hljs-property">lastActiveTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
  
  <span class="hljs-comment">// 5. 更新当前应用信息</span>
  currentAppName = name
  currentMicroApp = cached.<span class="hljs-property">instance</span>
  
  <span class="hljs-comment">// 6. 更新 URL 并触发路由事件</span>
  <span class="hljs-keyword">if</span> (path) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">''</span>, path)
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashChangeEvent</span>(<span class="hljs-string">'hashchange'</span>))
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PopStateEvent</span>(<span class="hljs-string">'popstate'</span>))
  }
  
  <span class="hljs-keyword">return</span> cached.<span class="hljs-property">instance</span>  <span class="hljs-comment">// 直接返回，无需重新挂载</span>
}
</code></pre>
<h5 data-id="heading-42">2.3 缓存清理（LRU 策略）</h5>
<p>当缓存数量超过 <code>MAX_CACHED_APPS</code> 时，清理最旧的非当前激活应用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">cleanupOldestCachedApp</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (cachedMicroApps.<span class="hljs-property">size</span> &lt; <span class="hljs-variable constant_">MAX_CACHED_APPS</span>) {
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-comment">// 找到最旧的非当前激活的应用</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">oldestName</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">let</span> oldestTime = <span class="hljs-title class_">Infinity</span>

  cachedMicroApps.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">cached, name</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (name !== currentAppName &amp;&amp; cached.<span class="hljs-property">lastActiveTime</span> &lt; oldestTime) {
      oldestTime = cached.<span class="hljs-property">lastActiveTime</span>
      oldestName = name
    }
  })

  <span class="hljs-keyword">if</span> (oldestName) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">destroyCachedApp</span>(oldestName)
  }
}
</code></pre>
<h4 data-id="heading-43">3. 页签状态同步</h4>
<p>主应用通过 <strong>qiankun 全局状态</strong>（<code>initGlobalState</code>）向子应用同步页签缓存信息：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/layout/TagsView/index.tsx</span>

<span class="hljs-comment">// 通知子应用缓存的公共方法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">notifySubAppCache</span> = (<span class="hljs-params">tagsList: <span class="hljs-keyword">typeof</span> tagsViewList, triggerSource: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> stateTags = tagsList.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">path</span>) {
      <span class="hljs-keyword">return</span> (item.<span class="hljs-property">path</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>).<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>).<span class="hljs-title function_">pop</span>()
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">'*'</span>
  })
  
  <span class="hljs-comment">// 使用 qiankun 全局状态同步</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">action</span>: <span class="hljs-title class_">MicroAppStateActions</span> = <span class="hljs-title function_">initGlobalState</span>({ <span class="hljs-attr">cachedTags</span>: stateTags })
  action.<span class="hljs-title function_">setGlobalState</span>({ <span class="hljs-attr">cachedTags</span>: stateTags })
}
</code></pre>
<p><strong>触发时机</strong>：</p>
<ul>
<li>新增页签时</li>
<li>切换页签时</li>
<li>删除页签时</li>
<li>页签已存在时（确保状态同步）</li>
</ul>
<p><strong>子应用接收</strong>（子应用需要实现）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 子应用代码示例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mount</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-comment">// 监听全局状态变化</span>
  props.<span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-function">(<span class="hljs-params">state, prev</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { cachedTags } = state
    <span class="hljs-comment">// 根据 cachedTags 更新子应用的 keep-alive 缓存</span>
    <span class="hljs-title function_">updateKeepAliveCache</span>(cachedTags)
  }, <span class="hljs-literal">true</span>)  <span class="hljs-comment">// fireImmediately = true，立即触发一次</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-44">子应用切换实现</h3>
<h4 data-id="heading-45">1. 切换流程</h4>
<h5 data-id="heading-46">1.1 同应用内页面切换</h5>
<p>当切换的页签属于同一个微应用时，只需更新路由，无需重新挂载：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/layout/TagsView/index.tsx</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">changeHandle</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">value: TabValue</span>) =&gt; {
  <span class="hljs-keyword">const</span> findItem = tagsViewList.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">id</span> == value)
  <span class="hljs-keyword">const</span> currentApp = <span class="hljs-title function_">getCurrentAppName</span>()
  
  <span class="hljs-comment">// 判断是否是同一个微应用内的页面切换</span>
  <span class="hljs-keyword">if</span> (currentApp === findItem.<span class="hljs-property">mircoAppName</span>) {
    <span class="hljs-comment">// 同一个微应用内切换，只需更新路由</span>
    <span class="hljs-title function_">navigate</span>(<span class="hljs-string">`<span class="hljs-subst">${findItem.activeRule}</span>/#<span class="hljs-subst">${findItem.path}</span>`</span>)
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'hashchange'</span>))
  }
}
</code></pre>
<h5 data-id="heading-47">1.2 不同应用间切换</h5>
<p>当切换到不同的微应用时，触发挂载流程：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (findItem.<span class="hljs-property">mircoAppName</span> &amp;&amp; findItem.<span class="hljs-property">entry</span>) {
  <span class="hljs-comment">// 不同微应用之间切换，需要挂载新应用</span>
  <span class="hljs-title function_">initMicroApps</span>(mircoAppList)
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">mountMicroApp</span>({
    <span class="hljs-attr">name</span>: findItem.<span class="hljs-property">mircoAppName</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">entry</span>: findItem.<span class="hljs-property">entry</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">path</span>: fullPath,
  })
}
</code></pre>
<p><strong>切换逻辑</strong>：</p>
<ol>
<li>如果目标应用已在缓存中 → 直接激活（显示容器）</li>
<li>如果目标应用不在缓存中 → 创建新容器并挂载</li>
<li>如果缓存已满 → 清理最旧的应用后再挂载</li>
</ol>
<h4 data-id="heading-48">2. 卸载逻辑</h4>
<h5 data-id="heading-49">2.1 保活模式下的卸载</h5>
<p>在保活模式下，卸载操作实际上只是隐藏容器，不真正销毁应用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> unmountMicroApp = <span class="hljs-keyword">async</span> (force = <span class="hljs-literal">false</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
  <span class="hljs-comment">// 保活模式下，只隐藏容器，不真正卸载</span>
  <span class="hljs-keyword">if</span> (keepAliveEnabled &amp;&amp; !force) {
    <span class="hljs-keyword">const</span> cached = cachedMicroApps.<span class="hljs-title function_">get</span>(currentAppName)
    <span class="hljs-keyword">if</span> (cached) {
      <span class="hljs-title function_">hideAppContainer</span>(cached.<span class="hljs-property">containerId</span>)  <span class="hljs-comment">// 仅隐藏</span>
      currentMicroApp = <span class="hljs-literal">null</span>
      currentAppName = <span class="hljs-literal">null</span>
      <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 不执行真正的卸载</span>
    }
  }
  
  <span class="hljs-comment">// 非保活模式或强制卸载，执行真正的卸载</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h5 data-id="heading-50">2.2 强制卸载</h5>
<p>某些场景需要真正销毁应用（如刷新、登出）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 强制卸载指定应用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> removeCachedApp = <span class="hljs-keyword">async</span> (<span class="hljs-attr">appName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
  <span class="hljs-keyword">if</span> (cachedMicroApps.<span class="hljs-title function_">has</span>(appName)) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">destroyCachedApp</span>(appName)  <span class="hljs-comment">// 真正销毁</span>
  }
}

<span class="hljs-comment">// 清空所有缓存</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> clearAllCachedApps = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; =&gt; {
  <span class="hljs-keyword">const</span> appNames = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(cachedMicroApps.<span class="hljs-title function_">keys</span>())
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> appName <span class="hljs-keyword">of</span> appNames) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">destroyCachedApp</span>(appName)
  }
}
</code></pre>
<h4 data-id="heading-51">3. 页面刷新恢复</h4>
<p>页面刷新后，根据当前路由自动恢复微应用挂载：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/views/microApp/index.tsx</span>

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (mircoAppList &amp;&amp; mircoAppList.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; !mountedRef.<span class="hljs-property">current</span>) {
    <span class="hljs-comment">// 初始化微应用配置</span>
    <span class="hljs-title function_">initMicroApps</span>(mircoAppList)
    
    <span class="hljs-comment">// 根据当前路由挂载微应用</span>
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> mounted = <span class="hljs-keyword">await</span> <span class="hljs-title function_">remountByCurrentRoute</span>()
      <span class="hljs-keyword">if</span> (mounted) {
        mountedRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>
      }
    }, <span class="hljs-number">100</span>)
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(timer)
  }
}, [mircoAppList])
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/registerApp.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> remountByCurrentRoute = <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; =&gt; {
  <span class="hljs-keyword">const</span> currentPathname = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span>
  <span class="hljs-keyword">const</span> currentHash = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">hash</span>
  <span class="hljs-keyword">const</span> fullPath = currentPathname + currentHash
  
  <span class="hljs-comment">// 查找匹配当前路由的微应用配置</span>
  <span class="hljs-keyword">const</span> matchedConfig = <span class="hljs-title function_">findMicroAppByPath</span>(currentPathname)
  
  <span class="hljs-keyword">if</span> (!matchedConfig) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
  
  <span class="hljs-comment">// 挂载微应用</span>
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title function_">mountMicroApp</span>({
    <span class="hljs-attr">name</span>: matchedConfig.<span class="hljs-property">name</span>,
    <span class="hljs-attr">entry</span>: matchedConfig.<span class="hljs-property">entry</span>,
    <span class="hljs-attr">container</span>: matchedConfig.<span class="hljs-property">container</span>,
    <span class="hljs-attr">path</span>: fullPath,
  })
  
  <span class="hljs-keyword">return</span> app !== <span class="hljs-literal">null</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-52">核心代码解析</h3>
<h4 data-id="heading-53">1. 微应用初始化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/registerApp.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">initMicroApps</span> = (<span class="hljs-params">appData: <span class="hljs-built_in">any</span>[], permissionList = [<span class="hljs-string">'*'</span>]</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!appData || !appData.<span class="hljs-property">length</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'没有可用的微应用数据'</span>)
    <span class="hljs-keyword">return</span>
  }

  globalPermissionList = permissionList

  <span class="hljs-comment">// 转换应用数据并缓存配置</span>
  <span class="hljs-keyword">const</span> flatData = <span class="hljs-title function_">flattenData</span>(appData)
  <span class="hljs-keyword">const</span> configs = <span class="hljs-title function_">transformData</span>(flatData, permissionList)

  <span class="hljs-comment">// 存储到配置映射表</span>
  configs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    microAppConfigMap.<span class="hljs-title function_">set</span>(config.<span class="hljs-property">name</span>, config)
  })

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'微应用配置已初始化:'</span>, <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(microAppConfigMap.<span class="hljs-title function_">keys</span>()))
}
</code></pre>
<h4 data-id="heading-54">2. 挂载核心逻辑</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> mountMicroApp = <span class="hljs-keyword">async</span> (<span class="hljs-attr">params</span>: <span class="hljs-title class_">MountMicroAppParams</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">QiankunMicroApp</span> | <span class="hljs-literal">null</span>&gt; =&gt; {
  <span class="hljs-keyword">const</span> { name, entry, container = <span class="hljs-string">'#subApp'</span>, path, defaultPath, <span class="hljs-attr">props</span>: extraProps } = params
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-title function_">loader</span>(<span class="hljs-literal">true</span>)
    
    <span class="hljs-comment">// 确保容器存在</span>
    <span class="hljs-keyword">const</span> mainContainerId = <span class="hljs-title function_">getContainerId</span>(container)
    <span class="hljs-keyword">const</span> containerReady = <span class="hljs-keyword">await</span> <span class="hljs-title function_">waitForContainer</span>(mainContainerId)
    <span class="hljs-keyword">if</span> (!containerReady) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`容器 #<span class="hljs-subst">${mainContainerId}</span> 不存在或无法创建`</span>)
    }

    <span class="hljs-comment">// ==================== 保活模式逻辑 ====================</span>
    <span class="hljs-keyword">if</span> (keepAliveEnabled) {
      <span class="hljs-comment">// 检查缓存</span>
      <span class="hljs-keyword">const</span> cached = cachedMicroApps.<span class="hljs-title function_">get</span>(name)
      
      <span class="hljs-keyword">if</span> (cached) {
        <span class="hljs-comment">// 从缓存激活</span>
        <span class="hljs-title function_">hideAllCachedContainers</span>()
        <span class="hljs-title function_">showAppContainer</span>(cached.<span class="hljs-property">containerId</span>)
        cached.<span class="hljs-property">lastActiveTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
        currentAppName = name
        currentMicroApp = cached.<span class="hljs-property">instance</span>
        
        <span class="hljs-keyword">if</span> (path) {
          <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">''</span>, path)
          <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashChangeEvent</span>(<span class="hljs-string">'hashchange'</span>))
        }
        
        <span class="hljs-title function_">loader</span>(<span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> cached.<span class="hljs-property">instance</span>
      }
      
      <span class="hljs-comment">// 新建并缓存</span>
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">cleanupOldestCachedApp</span>()
      <span class="hljs-title function_">hideAllCachedContainers</span>()
      <span class="hljs-keyword">const</span> appContainerId = <span class="hljs-title function_">createAppContainer</span>(name, mainContainerId)
      
      <span class="hljs-keyword">const</span> microApp = <span class="hljs-title function_">loadMicroApp</span>({
        name,
        entry,
        <span class="hljs-attr">container</span>: <span class="hljs-string">`#<span class="hljs-subst">${appContainerId}</span>`</span>,
        <span class="hljs-attr">props</span>: mergedProps,
      }, sandboxConfig)
      
      <span class="hljs-keyword">await</span> microApp.<span class="hljs-property">mountPromise</span>
      <span class="hljs-title function_">showAppContainer</span>(appContainerId)
      
      cachedMicroApps.<span class="hljs-title function_">set</span>(name, {
        <span class="hljs-attr">instance</span>: microApp,
        <span class="hljs-attr">containerId</span>: appContainerId,
        <span class="hljs-attr">lastActiveTime</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        entry,
      })
      
      currentAppName = name
      currentMicroApp = microApp
      
      <span class="hljs-title function_">loader</span>(<span class="hljs-literal">false</span>)
      <span class="hljs-keyword">return</span> microApp
    }
    
    <span class="hljs-comment">// ==================== 非保活模式 ====================</span>
    <span class="hljs-comment">// ... 传统卸载后挂载逻辑</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`挂载微应用 <span class="hljs-subst">${name}</span> 失败:`</span>, error)
    <span class="hljs-title function_">loader</span>(<span class="hljs-literal">false</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
  }
}
</code></pre>
<h4 data-id="heading-55">3. 页签管理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/layout/TagsView/index.tsx</span>

<span class="hljs-comment">// 监听路由变化，自动添加页签</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> hashPath = <span class="hljs-title function_">extractPath</span>(location.<span class="hljs-property">hash</span>)
  
  <span class="hljs-keyword">if</span> (mircoAppHash[hashPath]) {
    <span class="hljs-keyword">const</span> matchedItem = mircoAppHash[hashPath]
    <span class="hljs-keyword">const</span> index = tagsViewList.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">tag</span>) =&gt;</span> tag?.<span class="hljs-property">id</span> == matchedItem?.<span class="hljs-property">id</span>)
    
    <span class="hljs-keyword">if</span> (~index) {
      <span class="hljs-comment">// 页签已存在，只更新激活状态</span>
      <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">setActionTagsViewId</span>(matchedItem.<span class="hljs-property">id</span>))
      <span class="hljs-title function_">notifySubAppCache</span>(tagsViewList, <span class="hljs-string">`页签已存在 <span class="hljs-subst">${hashPath}</span>`</span>)
      <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-comment">// 新增页签</span>
    <span class="hljs-keyword">const</span> _tagsViewList = <span class="hljs-title function_">cloneDeep</span>(tagsViewList) ?? []
    _tagsViewList.<span class="hljs-title function_">push</span>(matchedItem)
    <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">setTagsViewList</span>(_tagsViewList))
    <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">setActionTagsViewId</span>(matchedItem.<span class="hljs-property">id</span>))
    
    <span class="hljs-comment">// 通知子应用缓存更新</span>
    <span class="hljs-title function_">notifySubAppCache</span>(_tagsViewList, <span class="hljs-string">`新页签打开 <span class="hljs-subst">${hashPath}</span>`</span>)
  }
}, [location.<span class="hljs-property">hash</span>])
</code></pre>
<hr/>
<h3 data-id="heading-56">使用说明</h3>
<h4 data-id="heading-57">1. 初始化微应用</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { initMicroApps } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/registerApp'</span>

<span class="hljs-comment">// 在应用启动时初始化</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (mircoAppList &amp;&amp; mircoAppList.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-title function_">initMicroApps</span>(mircoAppList, permissionList)
  }
}, [mircoAppList])
</code></pre>
<h4 data-id="heading-58">2. 挂载微应用</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { mountMicroApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/registerApp'</span>

<span class="hljs-comment">// 手动挂载</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">mountMicroApp</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'app-name'</span>,
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'https://app.example.com'</span>,
  <span class="hljs-attr">container</span>: <span class="hljs-string">'#subApp'</span>,
  <span class="hljs-attr">path</span>: <span class="hljs-string">'/wly-base/app-name/#/home'</span>,
  <span class="hljs-attr">defaultPath</span>: <span class="hljs-string">'/home'</span>,  <span class="hljs-comment">// 子应用默认路径</span>
})
</code></pre>
<h4 data-id="heading-59">3. 控制保活模式</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { setKeepAliveEnabled, isKeepAliveEnabled } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/registerApp'</span>

<span class="hljs-comment">// 启用/禁用保活</span>
<span class="hljs-title function_">setKeepAliveEnabled</span>(<span class="hljs-literal">true</span>)

<span class="hljs-comment">// 查询状态</span>
<span class="hljs-keyword">const</span> enabled = <span class="hljs-title function_">isKeepAliveEnabled</span>()
</code></pre>
<h4 data-id="heading-60">4. 清理缓存</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { clearAllCachedApps, removeCachedApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/registerApp'</span>

<span class="hljs-comment">// 清空所有缓存</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">clearAllCachedApps</span>()

<span class="hljs-comment">// 移除指定应用</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">removeCachedApp</span>(<span class="hljs-string">'app-name'</span>)
</code></pre>
<h4 data-id="heading-61">5. 子应用接入</h4>
<p>子应用需要：</p>
<ol>
<li><strong>导出生命周期钩子</strong>：</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 子应用入口文件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子应用启动'</span>)
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mount</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-comment">// 监听全局状态</span>
  props.<span class="hljs-title function_">onGlobalStateChange</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { cachedTags } = state
    <span class="hljs-comment">// 更新 keep-alive 缓存</span>
  }, <span class="hljs-literal">true</span>)
  
  <span class="hljs-comment">// 渲染应用</span>
  <span class="hljs-title function_">render</span>(props)
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unmount</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 清理</span>
}
</code></pre>
<ol start="2">
<li><strong>配置 webpack publicPath</strong>：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">publicPath</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span> 
      ? <span class="hljs-string">'https://app.example.com/'</span> 
      : <span class="hljs-string">'//localhost:3000/'</span>,
  },
}
</code></pre>
<hr/>
<h3 data-id="heading-62">注意事项</h3>
<h4 data-id="heading-63">1. 容器管理</h4>
<ul>
<li>✅ 每个微应用使用独立容器（<code>subApp-{appName}</code>）</li>
<li>✅ 容器使用绝对定位，避免布局冲突</li>
<li>✅ 切换时通过 <code>display: none/block</code> 控制显示</li>
</ul>
<h4 data-id="heading-64">2. 内存管理</h4>
<ul>
<li>⚠️ 缓存数量限制为 5 个（<code>MAX_CACHED_APPS</code>）</li>
<li>⚠️ 超过限制时自动清理最旧的应用</li>
<li>⚠️ 页面刷新会清空所有缓存</li>
</ul>
<h4 data-id="heading-65">3. 路由同步</h4>
<ul>
<li>✅ 使用 <code>window.history.pushState</code> 更新 URL</li>
<li>✅ 手动触发 <code>hashchange</code> 和 <code>popstate</code> 事件</li>
<li>✅ 子应用需要监听路由变化</li>
</ul>
<h4 data-id="heading-66">4. 状态同步</h4>
<ul>
<li>✅ 使用 qiankun <code>initGlobalState</code> 同步页签状态</li>
<li>✅ 子应用需要实现 <code>onGlobalStateChange</code> 监听</li>
<li>✅ 页签变化时及时通知子应用</li>
</ul>
<h4 data-id="heading-67">5. 样式隔离</h4>
<ul>
<li>⚠️ 当前未启用严格样式隔离</li>
<li>⚠️ 建议使用 CSS Modules 或 styled-components</li>
<li>⚠️ 避免全局样式污染</li>
</ul>
<h4 data-id="heading-68">6. 性能优化</h4>
<ul>
<li>✅ 保活模式减少重复挂载开销</li>
<li>✅ LRU 缓存策略控制内存使用</li>
<li>✅ 容器显示/隐藏比卸载/挂载更快</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uniapp动态读取版本号]]></title>    <link>https://juejin.cn/post/7580971667037454362</link>    <guid>https://juejin.cn/post/7580971667037454362</guid>    <pubDate>2025-12-08T06:03:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580971667037454362" data-draft-id="7580940585692659750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uniapp动态读取版本号"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-08T06:03:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="来碗疙瘩汤"/> <meta itemprop="url" content="https://juejin.cn/user/3250599254324776"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uniapp动态读取版本号
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3250599254324776/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    来碗疙瘩汤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:03:16.000Z" title="Mon Dec 08 2025 06:03:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>app下build.gradle配置</p>
<pre><code class="hljs language-js" lang="js">apply <span class="hljs-attr">plugin</span>: <span class="hljs-string">'com.android.application'</span>


<span class="hljs-comment">// 从 manifest.json 读取版本号</span>
def <span class="hljs-title function_">getVersionInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 根据实际路径调整，常见路径：</span>
    <span class="hljs-comment">// 'src/main/assets/apps/__UNI__0BD8113/www/manifest.json'</span>
    def manifestFile = <span class="hljs-title function_">file</span>(<span class="hljs-string">'src/main/assets/apps/__UNI__0BD8113/www/manifest.json'</span>)

    <span class="hljs-comment">// 调试信息</span>
    println <span class="hljs-string">"======== 版本号读取调试 ========"</span>
    println <span class="hljs-string">"当前目录: ${projectDir.absolutePath}"</span>
    println <span class="hljs-string">"manifest.json 路径: ${manifestFile.absolutePath}"</span>
    println <span class="hljs-string">"文件是否存在: ${manifestFile.exists()}"</span>

    <span class="hljs-keyword">if</span> (!manifestFile.<span class="hljs-title function_">exists</span>()) {
        println <span class="hljs-string">"❌ manifest.json 文件不存在，使用默认版本号"</span>
        println <span class="hljs-string">"================================"</span>
        <span class="hljs-keyword">return</span> [<span class="hljs-attr">versionCode</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">versionName</span>: <span class="hljs-string">"1.0.0"</span>]
    }

    <span class="hljs-keyword">try</span> {
        def jsonSlurper = <span class="hljs-keyword">new</span> groovy.<span class="hljs-property">json</span>.<span class="hljs-title class_">JsonSlurper</span>()
        def manifest = jsonSlurper.<span class="hljs-title function_">parse</span>(manifestFile)

        <span class="hljs-comment">// 从 version 对象中读取</span>
        def versionCode = manifest.<span class="hljs-property">version</span>?.<span class="hljs-property">code</span>?.<span class="hljs-title function_">toInteger</span>() ?: <span class="hljs-number">1</span>
        def versionName = manifest.<span class="hljs-property">version</span>?.<span class="hljs-property">name</span> ?: <span class="hljs-string">"1.0.0"</span>

        println <span class="hljs-string">"✅ 读取到版本信息:"</span>
        println <span class="hljs-string">"   versionCode = ${versionCode}"</span>
        println <span class="hljs-string">"   versionName = ${versionName}"</span>
        println <span class="hljs-string">"================================"</span>

        <span class="hljs-keyword">return</span> [<span class="hljs-attr">versionCode</span>: versionCode, <span class="hljs-attr">versionName</span>: versionName]
    } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
        println <span class="hljs-string">"❌ 解析 manifest.json 失败: ${e.message}"</span>
        println <span class="hljs-string">"================================"</span>
        <span class="hljs-keyword">return</span> [<span class="hljs-attr">versionCode</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">versionName</span>: <span class="hljs-string">"1.0.0"</span>]
    }
}

<span class="hljs-comment">// 获取版本信息</span>
def versionInfo = <span class="hljs-title function_">getVersionInfo</span>()

android {
    compileSdkVersion <span class="hljs-number">36</span>
    buildToolsVersion <span class="hljs-string">'36.0.0'</span>

    <span class="hljs-comment">// 应和离线打包时申请离线打包key的值一致</span>
    namespace <span class="hljs-string">'com.android.chuanwu'</span>
    defaultConfig {
        <span class="hljs-comment">// 应和离线打包时申请离线打包key的值一致</span>
        applicationId <span class="hljs-string">"com.android.chuanwu"</span>
        <span class="hljs-comment">// 插件aar最低支持26</span>
        minSdkVersion <span class="hljs-number">26</span>
        targetSdkVersion <span class="hljs-number">36</span> <span class="hljs-comment">//建议此属性值设为21 io.dcloud.PandoraEntry 作为apk入口时   必须设置 targetSDKVersion&gt;=21 沉浸式才生效</span>

        <span class="hljs-comment">// 动态设置版本号</span>
        versionCode versionInfo.<span class="hljs-property">versionCode</span>
        versionName versionInfo.<span class="hljs-property">versionName</span>

        multiDexEnabled <span class="hljs-literal">true</span>
        compileOptions {
            sourceCompatibility <span class="hljs-title class_">JavaVersion</span>.<span class="hljs-property">VERSION_1_8</span>
            targetCompatibility <span class="hljs-title class_">JavaVersion</span>.<span class="hljs-property">VERSION_1_8</span>
        }
    }

    signingConfigs {
        config {
            <span class="hljs-comment">// 证书别名</span>
            keyAlias <span class="hljs-string">''</span>
            <span class="hljs-comment">// 证书密码</span>
            keyPassword <span class="hljs-string">''</span>
            <span class="hljs-comment">// 证书文件路径</span>
            storeFile <span class="hljs-title function_">file</span>(<span class="hljs-string">'xxx.keystore'</span>)
            <span class="hljs-comment">// 证书密码</span>
            storePassword <span class="hljs-string">''</span>
            v1SigningEnabled <span class="hljs-literal">true</span>
            v2SigningEnabled <span class="hljs-literal">true</span>
        }
    }

    buildTypes {
        release {
            signingConfig signingConfigs.<span class="hljs-property">config</span>
            zipAlignEnabled <span class="hljs-literal">false</span>
            minifyEnabled <span class="hljs-literal">false</span>
            proguardFiles <span class="hljs-title function_">getDefaultProguardFile</span>(<span class="hljs-string">'proguard-android.txt'</span>), <span class="hljs-string">'proguard-rules.pro'</span>
        }
        debug {
            signingConfig signingConfigs.<span class="hljs-property">config</span>
            zipAlignEnabled <span class="hljs-literal">false</span>
            minifyEnabled <span class="hljs-literal">false</span>
            proguardFiles <span class="hljs-title function_">getDefaultProguardFile</span>(<span class="hljs-string">'proguard-android.txt'</span>), <span class="hljs-string">'proguard-rules.pro'</span>
        }
    }


    applicationVariants.<span class="hljs-property">all</span> { variant -&gt;
        variant.<span class="hljs-property">outputs</span>.<span class="hljs-property">all</span> { output -&gt;
            <span class="hljs-comment">// 自定义 APK 名称</span>
            outputFileName = <span class="hljs-string">"app-${versionInfo.versionName}.apk"</span>
        }
    }


    <span class="hljs-comment">//使用uniapp时，需复制下面代码</span>
    <span class="hljs-comment">/*代码开始*/</span>
    aaptOptions {
        additionalParameters <span class="hljs-string">'--auto-add-overlay'</span>
        <span class="hljs-comment">//noCompress 'foo', 'bar'</span>
        ignoreAssetsPattern <span class="hljs-string">"!.svn:!.git:.*:!CVS:!thumbs.db:!picasa.ini:!*.scc:*~"</span>
    }
    compileOptions {
        sourceCompatibility <span class="hljs-title class_">JavaVersion</span>.<span class="hljs-property">VERSION_1_8</span>
        targetCompatibility <span class="hljs-title class_">JavaVersion</span>.<span class="hljs-property">VERSION_1_8</span>
    }
    <span class="hljs-comment">/*代码结束*/</span>
}
repositories {
    flatDir {
        dirs <span class="hljs-string">'libs'</span>
    }
}
dependencies {
    implementation <span class="hljs-title function_">fileTree</span>(<span class="hljs-attr">dir</span>: <span class="hljs-string">'libs'</span>, <span class="hljs-attr">include</span>: [<span class="hljs-string">'*.jar'</span>])
    implementation <span class="hljs-title function_">fileTree</span>(<span class="hljs-attr">dir</span>: <span class="hljs-string">'libs'</span>, <span class="hljs-attr">include</span>: [<span class="hljs-string">'*.aar'</span>])

    <span class="hljs-comment">/*uniapp所需库-----------------------开始*/</span>
    implementation <span class="hljs-string">'androidx.recyclerview:recyclerview:1.1.0'</span>
    implementation <span class="hljs-string">'com.facebook.fresco:fresco:1.13.0'</span>
    implementation <span class="hljs-string">"com.facebook.fresco:animated-gif:1.13.0"</span>
    <span class="hljs-comment">/*uniapp所需库-----------------------结束*/</span>
    <span class="hljs-comment">// 基座需要，必须添加</span>
    implementation <span class="hljs-string">'com.github.bumptech.glide:glide:4.9.0'</span>
    implementation <span class="hljs-string">'com.alibaba:fastjson:1.2.83'</span>
    implementation <span class="hljs-string">'androidx.webkit:webkit:1.5.0'</span>
    implementation <span class="hljs-string">'androidx.localbroadcastmanager:localbroadcastmanager:1.0.0'</span>
    implementation <span class="hljs-string">'androidx.core:core:1.1.0'</span>
    implementation <span class="hljs-string">"androidx.fragment:fragment:1.1.0"</span>
    implementation <span class="hljs-string">'androidx.appcompat:appcompat:1.1.0'</span>
    <span class="hljs-comment">// 添加uni-app插件</span>
    implementation <span class="hljs-title function_">project</span>(<span class="hljs-string">':uniplugin_scancode'</span>)
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在大型项目中为什么更推荐Composition API？它解决了哪些工程化问题？]]></title>    <link>https://juejin.cn/post/7580616979473924102</link>    <guid>https://juejin.cn/post/7580616979473924102</guid>    <pubDate>2025-12-08T06:06:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580616979473924102" data-draft-id="7580753790771937322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在大型项目中为什么更推荐Composition API？它解决了哪些工程化问题？"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-08T06:06:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一个小小开发"/> <meta itemprop="url" content="https://juejin.cn/user/1198915135999278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在大型项目中为什么更推荐Composition API？它解决了哪些工程化问题？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1198915135999278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一个小小开发
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:06:54.000Z" title="Mon Dec 08 2025 06:06:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 更好的逻辑组织和复用</h2>
<h3 data-id="heading-1">Options API 的问题</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Options API - 逻辑分散在不同选项中</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">users</span>: [],
      <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">searchQuery</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">pagination</span>: {
        <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">limit</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">total</span>: <span class="hljs-number">0</span>
      }
    }
  },
  
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">filteredUsers</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 用户筛选逻辑</span>
    },
    <span class="hljs-title function_">totalPages</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 分页计算逻辑</span>
    }
  },
  
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchUsers</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 数据获取逻辑</span>
    },
    <span class="hljs-title function_">handleSearch</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 搜索逻辑</span>
    },
    <span class="hljs-title function_">handlePageChange</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 分页逻辑</span>
    }
  },
  
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchUsers</span>()
  }
}
</code></pre>
<h3 data-id="heading-2">Composition API 的优势</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Composition API - 按功能组织代码</span>
<span class="hljs-keyword">import</span> { ref, computed, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { userApi } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/user'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 用户管理功能</span>
    <span class="hljs-keyword">const</span> { users, loading, fetchUsers, searchUsers } = <span class="hljs-title function_">useUserManagement</span>()
    
    <span class="hljs-comment">// 搜索功能</span>
    <span class="hljs-keyword">const</span> { searchQuery, filteredUsers } = <span class="hljs-title function_">useSearch</span>(users)
    
    <span class="hljs-comment">// 分页功能</span>
    <span class="hljs-keyword">const</span> { pagination, paginatedUsers, handlePageChange } = <span class="hljs-title function_">usePagination</span>(filteredUsers)
    
    <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">fetchUsers</span>()
    })
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">users</span>: paginatedUsers,
      loading,
      searchQuery,
      pagination,
      handlePageChange,
      searchUsers
    }
  }
}

<span class="hljs-comment">// 可复用的用户管理逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useUserManagement</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> users = <span class="hljs-title function_">ref</span>([])
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUsers</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">try</span> {
      users.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> userApi.<span class="hljs-title function_">getUsers</span>()
    } <span class="hljs-keyword">finally</span> {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    }
  }
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">searchUsers</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">query</span>) =&gt; {
    <span class="hljs-comment">// 搜索实现</span>
  }
  
  <span class="hljs-keyword">return</span> {
    users,
    loading,
    fetchUsers,
    searchUsers
  }
}

<span class="hljs-comment">// 可复用的搜索逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useSearch</span>(<span class="hljs-params">source</span>) {
  <span class="hljs-keyword">const</span> searchQuery = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
  
  <span class="hljs-keyword">const</span> filteredUsers = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!searchQuery.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span> source.<span class="hljs-property">value</span>
    <span class="hljs-keyword">return</span> source.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> 
      user.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(searchQuery.<span class="hljs-property">value</span>)
    )
  })
  
  <span class="hljs-keyword">return</span> {
    searchQuery,
    filteredUsers
  }
}
</code></pre>
<h2 data-id="heading-3">2. 更好的 TypeScript 支持</h2>
<blockquote>
<p>Composition API 的完整类型推断</p>
</blockquote>
<pre><code class="hljs language-csharp" lang="csharp">import { <span class="hljs-keyword">ref</span>, computed, Ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title">User</span> {
  id: number
  name: <span class="hljs-built_in">string</span>
  email: <span class="hljs-built_in">string</span>
  role: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">// 明确的类型定义</span>
<span class="hljs-function">function <span class="hljs-title">useUserManagement</span>()</span> {
  <span class="hljs-keyword">const</span> users: Ref&lt;User[]&gt; = <span class="hljs-keyword">ref</span>([])
  <span class="hljs-keyword">const</span> loading = <span class="hljs-keyword">ref</span>(<span class="hljs-literal">false</span>)
  
  <span class="hljs-keyword">const</span> adminUsers = computed(() =&gt; 
    users.<span class="hljs-keyword">value</span>.filter(user =&gt; user.role === <span class="hljs-string">'admin'</span>)
  )
  
  <span class="hljs-keyword">return</span> {
    users,
    loading,
    adminUsers
  }
}
</code></pre>
<h2 data-id="heading-4">3. 更清晰的代码组织模式</h2>
<blockquote>
<p>基于功能的代码分割</p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// feature-based-composition.js</span>
export default {
  <span class="hljs-built_in">setup</span>() {
    <span class="hljs-comment">// 每个功能独立封装</span>
    const cart = <span class="hljs-built_in">useCart</span>()
    const user = <span class="hljs-built_in">useUser</span>()
    const products = <span class="hljs-built_in">useProducts</span>()
    const notifications = <span class="hljs-built_in">useNotifications</span>()
    
    <span class="hljs-comment">// 功能间的依赖关系更清晰</span>
    <span class="hljs-built_in">watch</span>(() =&gt; user<span class="hljs-selector-class">.isLoggedIn</span>, (loggedIn) =&gt; {
      if (loggedIn) {
        cart<span class="hljs-selector-class">.syncCart</span>()
        notifications<span class="hljs-selector-class">.fetchUnread</span>()
      }
    })
    
    return {
      ..<span class="hljs-selector-class">.cart</span>,
      ..<span class="hljs-selector-class">.user</span>,
      ..<span class="hljs-selector-class">.products</span>,
      ..<span class="hljs-selector-class">.notifications</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-5">4. 更好的可测试性</h2>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 独立的逻辑函数易于测试</span>
import { useUserManagement } from './userComposition'

<span class="hljs-built_in">describe</span>('useUserManagement', () =&gt; {
  <span class="hljs-built_in">it</span>('should fetch users correctly', async () =&gt; {
    const { users, fetchUsers } = <span class="hljs-built_in">useUserManagement</span>()
    
    await <span class="hljs-built_in">fetchUsers</span>()
    
    <span class="hljs-built_in">expect</span>(users.value)<span class="hljs-selector-class">.toHaveLength</span>(<span class="hljs-number">3</span>)
  })
})
</code></pre>
<h2 data-id="heading-6">5. 解决的具体工程化问题</h2>
<h3 data-id="heading-7">5.1 逻辑关注点分离</h3>
<p><strong>Options API 问题</strong>：相关逻辑分散在 <code>data</code>、<code>methods</code>、<code>computed</code> 中<br/>
<strong>Composition API 解决</strong>：相关逻辑集中在一个组合函数中</p>
<h3 data-id="heading-8">5.2 代码复用性</h3>
<p><strong>Options API 问题</strong>：mixins 存在命名冲突和来源不清晰<br/>
<strong>Composition API 解决</strong>：明确的函数调用和返回值</p>
<h3 data-id="heading-9">5.3 类型推导</h3>
<p><strong>Options API 问题</strong>：复杂的 <code>this</code> 上下文类型推断<br/>
<strong>Composition API 解决</strong>：简单的变量和函数类型</p>
<h3 data-id="heading-10">5.4 可维护性</h3>
<p><strong>Options API 问题</strong>：组件越大，代码越难理解和维护<br/>
<strong>Composition API 解决</strong>：按功能拆分为小型、专注的组合函数</p>
<h3 data-id="heading-11">5.5 团队协作</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 大型项目中的团队协作示例</span>
export default {
  <span class="hljs-built_in">setup</span>() {
    <span class="hljs-comment">// 团队A负责的用户模块</span>
    const user = <span class="hljs-built_in">useUserModule</span>()
    
    <span class="hljs-comment">// 团队B负责的支付模块</span>
    const payment = <span class="hljs-built_in">usePaymentModule</span>()
    
    <span class="hljs-comment">// 团队C负责的通知模块</span>
    const notifications = <span class="hljs-built_in">useNotificationModule</span>()
    
    <span class="hljs-comment">// 清晰的模块边界和接口</span>
    return {
      ..<span class="hljs-selector-class">.user</span>,
      ..<span class="hljs-selector-class">.payment</span>,
      ..<span class="hljs-selector-class">.notifications</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-12">6.总结</h2>
<p>Composition API 在大型项目中更受推荐的主要原因：</p>
<ol>
<li>更好的逻辑组织：按功能而非选项类型组织代码</li>
<li>更强的类型支持：完整的 TypeScript 集成</li>
<li>更高的复用性：逻辑可以轻松提取和复用</li>
<li>更清晰的代码结构：大型组件更易理解和维护</li>
<li>更好的可测试性：逻辑与组件实例解耦</li>
<li>更佳的团队协作：明确的模块边界和接口</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Golang开发自动加载COM扫码枪进行一维码、二维码扫码与解码]]></title>    <link>https://juejin.cn/post/7581004702945542171</link>    <guid>https://juejin.cn/post/7581004702945542171</guid>    <pubDate>2025-12-08T05:51:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581004702945542171" data-draft-id="7580940585692610598" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Golang开发自动加载COM扫码枪进行一维码、二维码扫码与解码"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-12-08T05:51:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="光头闪亮亮"/> <meta itemprop="url" content="https://juejin.cn/user/1333047014199326"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Golang开发自动加载COM扫码枪进行一维码、二维码扫码与解码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1333047014199326/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    光头闪亮亮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T05:51:50.000Z" title="Mon Dec 08 2025 05:51:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Golang开发自动加载COM扫码枪进行一维码、二维码扫码与解码</h2>
<h3 data-id="heading-1">1. 项目概述</h3>
<p>本项目基于Golang语言开发，实现了自动检测、加载COM端口扫码枪设备，并对扫码数据进行读取、解码和处理的功能。该程序支持多种串口检测方式，自动识别不同编码格式的条码数据，并提供了高效的并发处理机制。</p>
<h4 data-id="heading-2">1.1 主要功能特点</h4>
<ul>
<li>自动扫描并识别系统中的COM端口设备</li>
<li>支持三种串口检测方式：第三方库、Windows注册表、WMI</li>
<li>自动识别扫码枪设备（支持YJ4600和NLDC M9型号）</li>
<li>支持UTF-8和GBK编码格式的自动检测与转换</li>
<li>采用协程实现高效的扫码数据并发处理</li>
<li>支持扫码数据的JSON解析与结构体转换</li>
</ul>
<h3 data-id="heading-3">2. 技术栈与依赖</h3>
<h4 data-id="heading-4">2.1 核心编程语言</h4>
<ul>
<li>Golang 1.2.24.0</li>
</ul>
<h4 data-id="heading-5">2.2 主要依赖库</h4>

































<table><thead><tr><th>依赖库</th><th>用途</th></tr></thead><tbody><tr><td><code>github.com/go-ole/go-ole</code></td><td>Windows COM接口操作，用于WMI查询</td></tr><tr><td><code>github.com/go-ole/go-ole/oleutil</code></td><td>OLE自动化工具库</td></tr><tr><td><code>github.com/tarm/goserial</code></td><td>串口通信操作</td></tr><tr><td><code>go.bug.st/serial</code></td><td>第三方串口检测库</td></tr><tr><td><code>golang.org/x/sys/windows/registry</code></td><td>Windows注册表操作</td></tr><tr><td><code>golang.org/x/text/encoding/simplifiedchinese</code></td><td>中文编码转换</td></tr></tbody></table>
<h3 data-id="heading-6">3. 系统架构与核心模块</h3>
<h4 data-id="heading-7">3.1 系统架构图</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────┐
│                     主程序入口                       │
├────────────────┬────────────────┬───────────────────┤
│  串口检测模块   │   串口通信模块  │   数据处理模块     │
├────────────────┼────────────────┼───────────────────┤
│  <span class="hljs-built_in">getCommlist2</span>()│   serial<span class="hljs-selector-class">.OpenPort</span>()│ <span class="hljs-built_in">readBarcodeData</span>() │
│  <span class="hljs-built_in">getCommList</span>() │   s<span class="hljs-selector-class">.Read</span>()      │ <span class="hljs-built_in">resolveBarcodeData</span>() │
│ <span class="hljs-built_in">getCommListWmi</span>()│               │ <span class="hljs-built_in">codeJsonConvertStruct</span>() │
└────────────────┴────────────────┴───────────────────┘
          │                │                │
          └────────────────┼────────────────┘
                           ▼
                   ┌───────────────┐
                   │ 编码转换模块   │
                   ├───────────────┤
                   │  <span class="hljs-built_in">GetStrCoding</span>()│
                   │     <span class="hljs-built_in">isUtf8</span>()   │
                   │     <span class="hljs-built_in">isGBK</span>()    │
                   └───────────────┘
</code></pre>
<h4 data-id="heading-8">3.2 核心模块说明</h4>
<h5 data-id="heading-9">3.2.1 串口检测模块</h5>
<p>该模块负责检测系统中所有可用的COM端口，并识别扫码枪设备。提供了三种检测方式：</p>
<ol>
<li>
<p><strong>第三方库检测</strong> (<code>getCommlist2()</code>)</p>
<ul>
<li>使用<code>go.bug.st/serial</code>库直接获取端口列表</li>
<li>实现简单，但可能无法识别设备类型</li>
</ul>
</li>
<li>
<p><strong>注册表检测</strong> (<code>getCommList()</code>)</p>
<ul>
<li>通过读取Windows注册表<code>HARDWARE\DEVICEMAP\SERIALCOMM</code>获取端口信息</li>
<li>支持识别特定型号的扫码枪（通过"youjie"关键词）</li>
<li>需要管理员权限运行</li>
</ul>
</li>
<li>
<p><strong>WMI检测</strong> (<code>getCommListWmi()</code>)</p>
<ul>
<li>使用Windows Management Instrumentation查询硬件信息</li>
<li>通过<code>Win32_PNPEntity</code>类获取所有即插即用设备</li>
<li>支持识别多种型号的扫码枪（YJ4600和NLDC M9）</li>
<li>代码实现较为复杂，但功能强大</li>
</ul>
</li>
</ol>
<h5 data-id="heading-10">3.2.2 串口通信模块</h5>
<p>负责与扫码枪设备建立连接并读取扫码数据：</p>
<ul>
<li>使用<code>github.com/tarm/goserial</code>库进行串口通信</li>
<li>支持配置波特率等串口参数</li>
<li>实现了持续的数据读取循环</li>
<li>处理读取错误和异常情况</li>
</ul>
<h5 data-id="heading-11">3.2.3 数据处理模块</h5>
<p>处理从扫码枪读取到的数据：</p>
<ul>
<li><code>readBarcodeData()</code>: 协程函数，持续接收并处理扫码数据</li>
<li><code>resolveBarcodeData()</code>: 解析条码数据，支持不同格式的条码</li>
<li><code>codeJsonConvertStruct()</code>: 将JSON格式的条码数据转换为结构体</li>
</ul>
<h5 data-id="heading-12">3.2.4 编码转换模块</h5>
<p>自动识别和转换不同编码格式的数据：</p>
<ul>
<li><code>GetStrCoding()</code>: 自动检测数据编码格式（UTF-8、GBK或未知）</li>
<li><code>isUtf8()</code>: UTF-8编码检测</li>
<li><code>isGBK()</code>: GBK编码检测</li>
<li>支持UTF-8与GBK编码之间的双向转换</li>
</ul>
<h3 data-id="heading-13">4. 核心功能实现细节</h3>
<h4 data-id="heading-14">4.1 串口检测实现</h4>
<h5 data-id="heading-15">4.1.1 WMI检测方式详解</h5>
<p>WMI检测是最复杂但功能最强大的检测方式，其实现步骤如下：</p>
<ol>
<li>初始化COM接口：<code>ole.CoInitialize(0)</code></li>
<li>创建SWbemLocator对象：<code>oleutil.CreateObject("WbemScripting.SWbemLocator")</code></li>
<li>获取IDispatch接口：<code>unknown.QueryInterface(ole.IID_IDispatch)</code></li>
<li>连接WMI服务：<code>oleutil.CallMethod(wmi, "ConnectServer")</code></li>
<li>执行WMI查询：<code>oleutil.CallMethod(service, "ExecQuery", "SELECT * FROM Win32_PNPEntity")</code></li>
<li>遍历查询结果，筛选出COM端口设备</li>
<li>根据设备名称识别扫码枪型号</li>
</ol>
<p>关键代码片段：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getCommListWmi</span><span class="hljs-params">()</span></span> ([]<span class="hljs-type">string</span>, <span class="hljs-type">string</span>) {
    <span class="hljs-comment">// 初始化COM接口</span>
    ole.CoInitialize(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">defer</span> ole.CoUninitialize()
    
    <span class="hljs-comment">// 创建WMI对象并执行查询</span>
    unknown, _ := oleutil.CreateObject(<span class="hljs-string">"WbemScripting.SWbemLocator"</span>)
    <span class="hljs-keyword">defer</span> unknown.Release()
    wmi, _ := unknown.QueryInterface(ole.IID_IDispatch)
    <span class="hljs-keyword">defer</span> wmi.Release()
    
    serviceRaw, _ := oleutil.CallMethod(wmi, <span class="hljs-string">"ConnectServer"</span>)
    service := serviceRaw.ToIDispatch()
    <span class="hljs-keyword">defer</span> service.Release()
    
    resultRaw, _ := oleutil.CallMethod(service, <span class="hljs-string">"ExecQuery"</span>, <span class="hljs-string">"SELECT * FROM Win32_PNPEntity"</span>)
    result := resultRaw.ToIDispatch()
    <span class="hljs-keyword">defer</span> result.Release()
    
    <span class="hljs-comment">// 遍历结果并筛选COM端口</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-16">4.2 扫码数据读取与处理</h4>
<h5 data-id="heading-17">4.2.1 数据读取机制</h5>
<p>程序通过持续循环从串口读取数据，并处理不同型号扫码枪的发送特性：</p>
<ul>
<li>支持一次性发送完整数据的扫码枪（如YJ4600）</li>
<li>支持分多次发送数据的扫码枪（如NLDC M9）</li>
<li>使用缓冲区拼接完整的扫码数据</li>
</ul>
<p>关键代码片段：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 开启一个循环，持续读取扫码枪的数据</span>
codeData := <span class="hljs-string">""</span> <span class="hljs-comment">//用于保存每次读取到缓冲区的数据</span>
<span class="hljs-keyword">for</span> {
    <span class="hljs-comment">//清空缓冲区的数据</span>
    buf = <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, <span class="hljs-number">1024</span>)
    <span class="hljs-comment">//读取码文数据到缓冲区内</span>
    lens, err := s.Read(buf)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Println(err)
        <span class="hljs-keyword">continue</span>
    }
    
    <span class="hljs-comment">// 将读取到的数据追加到codeData中，处理分多次发送的情况</span>
    x := buf[:lens]
    codeData += <span class="hljs-type">string</span>(x)
    
    <span class="hljs-comment">// 处理完整的扫码数据</span>
    <span class="hljs-keyword">if</span> lens &gt; <span class="hljs-number">4</span> {
        <span class="hljs-comment">// 编码转换和处理</span>
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<h5 data-id="heading-18">4.2.2 并发处理机制</h5>
<p>程序使用Golang的协程特性实现了扫码数据的异步处理：</p>
<ul>
<li>创建一个通道用于传递扫码数据</li>
<li>启动一个协程持续监听通道</li>
<li>主线程读取到完整数据后发送到通道</li>
<li>协程接收到数据后进行解析和处理</li>
</ul>
<p>关键代码片段：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 用于接收码文的通道</span>
receiveMessage := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)
<span class="hljs-comment">// 开启一个协程，不断从通道内读取数据</span>
<span class="hljs-keyword">go</span> readBarcodeData(receiveMessage)

<span class="hljs-comment">// 读取到完整数据后发送到通道</span>
<span class="hljs-keyword">if</span> codeString != <span class="hljs-string">""</span> {
    receiveMessage &lt;- codeString
}

<span class="hljs-comment">// 协程函数：持续读取通道内的码文数据</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readBarcodeData</span><span class="hljs-params">(message <span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)</span></span> {
    <span class="hljs-keyword">for</span> {
        <span class="hljs-keyword">select</span> {
        <span class="hljs-keyword">case</span> data := &lt;-message:
            fmt.Printf(<span class="hljs-string">"扫码时间:%v\n"</span>, time.Now().String())
            <span class="hljs-comment">//解析码文数据</span>
            resolveBarcodeData(data)
        }
    }
}
</code></pre>
<h4 data-id="heading-19">4.3 编码识别与转换</h4>
<h5 data-id="heading-20">4.3.1 编码检测算法</h5>
<p>程序实现了UTF-8和GBK编码的自动检测：</p>
<ol>
<li><strong>UTF-8检测</strong>：根据UTF-8编码规则，检查字节序列是否符合格式</li>
<li><strong>GBK检测</strong>：检查双字节是否落在GBK编码范围内</li>
<li><strong>检测顺序</strong>：先检测UTF-8，再检测GBK，确保准确性</li>
</ol>
<p>关键代码片段：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetStrCoding</span><span class="hljs-params">(data []<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-keyword">if</span> isUtf8(data) == <span class="hljs-literal">true</span> {
        <span class="hljs-keyword">return</span> UTF8
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> isGBK(data) == <span class="hljs-literal">true</span> {
        <span class="hljs-keyword">return</span> GBK
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> UNKNOWN
    }
}
</code></pre>
<h5 data-id="heading-21">4.3.2 编码转换实现</h5>
<p>支持UTF-8与GBK编码之间的双向转换：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">if</span> GetStrCoding([]<span class="hljs-type">byte</span>(codeData)) == <span class="hljs-string">"UTF8"</span> {
    <span class="hljs-comment">// UTF-8转GBK再转UTF-8（处理特殊字符）</span>
    gbkData, _ := simplifiedchinese.GB18030.NewEncoder().Bytes([]<span class="hljs-type">byte</span>(codeData))
    utf8Data, _ := simplifiedchinese.GB18030.NewDecoder().Bytes(gbkData)
    codeString = <span class="hljs-type">string</span>(utf8Data)
}
<span class="hljs-keyword">if</span> GetStrCoding([]<span class="hljs-type">byte</span>(codeData)) == <span class="hljs-string">"GBK"</span> {
    <span class="hljs-comment">// GBK转UTF-8</span>
    b, _ := simplifiedchinese.GB18030.NewDecoder().Bytes([]<span class="hljs-type">byte</span>(codeData))
    codeString = <span class="hljs-type">string</span>(b)
}
</code></pre>
<h5 data-id="heading-22">4.3.3 运行效果</h5>
<pre><code class="hljs language-go" lang="go">(TraeAI<span class="hljs-number">-8</span>) D:\vfptest [<span class="hljs-number">1</span>:<span class="hljs-number">1</span>] $ <span class="hljs-keyword">go</span> run  test_com.<span class="hljs-keyword">go</span>
蓝牙链接上的标准串行 (COM4)
蓝牙链接上的标准串行 (COM5)
Bluetooth Device (RFCOMM Protocol TDI)
本机串口列表：[蓝牙链接上的标准串行 (COM4) 蓝牙链接上的标准串行 (COM5) Bluetooth Device (RFCOMM Protocol TDI)]
扫码枪:
端口被占用
<span class="hljs-number">2025</span>/<span class="hljs-number">12</span>/<span class="hljs-number">08</span> <span class="hljs-number">13</span>:<span class="hljs-number">23</span>:<span class="hljs-number">17</span> The system cannot find the path specified.
exit status <span class="hljs-number">1</span>
(TraeAI<span class="hljs-number">-8</span>) D:\vfptest [<span class="hljs-number">1</span>:<span class="hljs-number">1</span>] $ <span class="hljs-keyword">go</span> run  test_com.<span class="hljs-keyword">go</span>
YJ4600 (COM7)
strComName: YJ4600 (COM7
本机串口列表：[YJ4600 (COM7)]
扫码枪:COM7
-----------------------------------------------------------------------------------
--扫岗位证带中文
lens: <span class="hljs-number">6</span>
before convert: ������
codeData: ������
before convert: <span class="hljs-number">6</span>
coding: GBK
扫码时间:<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-08</span> <span class="hljs-number">13</span>:<span class="hljs-number">26</span>:<span class="hljs-number">26.7199849</span> +<span class="hljs-number">0800</span> CST m=+<span class="hljs-number">4.979774801</span>
------------------------
码文: 李四▲


---------------------------------------------------------------------------------------------

--扫药品包装条码
------------------------
lens: <span class="hljs-number">20</span>
before convert: <span class="hljs-number">88281800136707328258</span>
codeData: <span class="hljs-number">88281800136707328258</span>
before convert: <span class="hljs-number">20</span>
coding: UTF8
after convert: <span class="hljs-number">88281800136707328258</span>
扫码时间:<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-08</span> <span class="hljs-number">13</span>:<span class="hljs-number">27</span>:<span class="hljs-number">05.295828</span> +<span class="hljs-number">0800</span> CST m=+<span class="hljs-number">43.555617901</span>
------------------------
码文: <span class="hljs-number">88281800136707328258</span>

---------------------------------------------------------------------------------------------

--扫微信二维码
lens: <span class="hljs-number">43</span>
before convert: http:<span class="hljs-comment">//weixin.qq.com/r/9XUCGmDEOT1GrSR59yDn</span>
codeData: http:<span class="hljs-comment">//weixin.qq.com/r/9XUCGmDEOT1GrSR59yDn</span>
before convert: <span class="hljs-number">43</span>
coding: UTF8
after convert: http:<span class="hljs-comment">//weixin.qq.com/r/9XUCGmDEOT1GrSR59yDn</span>
扫码时间:<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-08</span> <span class="hljs-number">13</span>:<span class="hljs-number">27</span>:<span class="hljs-number">23.5772834</span> +<span class="hljs-number">0800</span> CST m=+<span class="hljs-number">61.837073301</span>
------------------------
码文: http:<span class="hljs-comment">//weixin.qq.com/r/9XUCGmDEOT1GrSR59yDn</span>

---------------------------------------------------------------------------------------------
--扫半成品二维码带中文

lens: <span class="hljs-number">380</span>
before convert: D181��<span class="hljs-number">67010</span>-AT��FD181<span class="hljs-number">-661</span><span class="hljs-number">-12</span>��EM41��FLRY��<span class="hljs-number">0.5</span>�����̡�<span class="hljs-number">690</span>��<span class="hljs-number">300</span>��<span class="hljs-number">15574</span>��CC64������<span class="hljs-number">4</span>����־ǿ��<span class="hljs-number">2016</span>/<span class="hljs-number">12</span>/<span class="hljs-number">21</span>��ҹ����<span class="hljs-number">50</span>��������<span class="hljs-number">20170102</span>����<span class="hljs-number">4</span>��X-F4��<span class="hljs-number">2016.11</span><span class="hljs-number">.10</span>���۱���<span class="hljs-number">3</span>��<span class="hljs-number">968221</span><span class="hljs-number">-1</span>(TE)��<span class="hljs-number">0.5</span>����DJ628<span class="hljs-number">-4.8</span>��<span class="hljs-number">0.8</span>A(ZJZ)��<span class="hljs-number">0.5</span>����<span class="hljs-number">3.5</span>��TE0<span class="hljs-number">.85</span>����<span class="hljs-number">0.05</span>mm��TE1<span class="hljs-number">.54</span>����<span class="hljs-number">0.10</span>mm��<span class="hljs-number">4.0</span>��ZJZ1<span class="hljs-number">.15</span>����<span class="hljs-number">0.05</span>mm��ZJZ2<span class="hljs-number">.23</span>����<span class="hljs-number">0.10</span>mm��<span class="hljs-number">80</span>��<span class="hljs-number">80</span>������<span class="hljs-number">0.98</span>��<span class="hljs-number">0.25</span>��<span class="hljs-number">0.05</span>+<span class="hljs-number">0.40</span>��<span class="hljs-number">11</span>��<span class="hljs-number">2</span>/<span class="hljs-number">5</span>��<span class="hljs-number">2</span>��<span class="hljs-number">11</span>��<span class="hljs-number">2</span>/<span class="hljs-number">5</span>��<span class="hljs-number">2</span>������<span class="hljs-number">03</span><span class="hljs-number">-1</span><span class="hljs-number">-149</span><span class="hljs-number">-029</span>�����Ǿ���
codeData: D181��<span class="hljs-number">67010</span>-AT��FD181<span class="hljs-number">-661</span><span class="hljs-number">-12</span>��EM41��FLRY��<span class="hljs-number">0.5</span>�����̡�<span class="hljs-number">690</span>��<span class="hljs-number">300</span>��<span class="hljs-number">15574</span>��CC64������<span class="hljs-number">4</span>����־ǿ��<span class="hljs-number">2016</span>/<span class="hljs-number">12</span>/<span class="hljs-number">21</span>��ҹ����<span class="hljs-number">50</span>��������<span class="hljs-number">20170102</span>����<span class="hljs-number">4</span>��X-F4��<span class="hljs-number">2016.11</span><span class="hljs-number">.10</span>���۱���<span class="hljs-number">3</span>��<span class="hljs-number">968221</span><span class="hljs-number">-1</span>(TE)��<span class="hljs-number">0.5</span>����DJ628<span class="hljs-number">-4.8</span>��<span class="hljs-number">0.8</span>A(ZJZ)��<span class="hljs-number">0.5</span>����<span class="hljs-number">3.5</span>��TE0<span class="hljs-number">.85</span>����<span class="hljs-number">0.05</span>mm��TE1<span class="hljs-number">.54</span>����<span class="hljs-number">0.10</span>mm��<span class="hljs-number">4.0</span>��ZJZ1<span class="hljs-number">.15</span>����<span class="hljs-number">0.05</span>mm��ZJZ2<span class="hljs-number">.23</span>����<span class="hljs-number">0.10</span>mm��<span class="hljs-number">80</span>��<span class="hljs-number">80</span>������<span class="hljs-number">0.98</span>��<span class="hljs-number">0.25</span>��<span class="hljs-number">0.05</span>+<span class="hljs-number">0.40</span>��<span class="hljs-number">11</span>��<span class="hljs-number">2</span>/<span class="hljs-number">5</span>��<span class="hljs-number">2</span>��<span class="hljs-number">11</span>��<span class="hljs-number">2</span>/<span class="hljs-number">5</span>��<span class="hljs-number">2</span>������<span class="hljs-number">03</span><span class="hljs-number">-1</span><span class="hljs-number">-149</span><span class="hljs-number">-029</span>�����Ǿ���
before convert: <span class="hljs-number">380</span>
coding: GBK
扫码时间:<span class="hljs-number">2025</span><span class="hljs-number">-12</span><span class="hljs-number">-08</span> <span class="hljs-number">13</span>:<span class="hljs-number">28</span>:<span class="hljs-number">16.4129887</span> +<span class="hljs-number">0800</span> CST m=+<span class="hljs-number">114.672778601</span>
------------------------
码文: D181■<span class="hljs-number">67010</span>-AT■FD181<span class="hljs-number">-661</span><span class="hljs-number">-12</span>■EM41■FLRY■<span class="hljs-number">0.5</span>■黄绿■<span class="hljs-number">690</span>■<span class="hljs-number">300</span>■<span class="hljs-number">15574</span>■CC64■下料<span class="hljs-number">4</span>■高志强■<span class="hljs-number">2016</span>/<span class="hljs-number">12</span>/<span class="hljs-number">21</span>■夜班■<span class="hljs-number">50</span>■■■■<span class="hljs-number">20170102</span>■分<span class="hljs-number">4</span>■X-F4■<span class="hljs-number">2016.11</span><span class="hljs-number">.10</span>■邵兵■<span class="hljs-number">3</span>■<span class="hljs-number">968221</span><span class="hljs-number">-1</span>(TE)■<span class="hljs-number">0.5</span>■■DJ628<span class="hljs-number">-4.8</span>×<span class="hljs-number">0.8</span>A(ZJZ)■<span class="hljs-number">0.5</span>■■<span class="hljs-number">3.5</span>■TE0<span class="hljs-number">.85</span>■±<span class="hljs-number">0.05</span>mm■TE1<span class="hljs-number">.54</span>■±<span class="hljs-number">0.10</span>mm■<span class="hljs-number">4.0</span>■ZJZ1<span class="hljs-number">.15</span>■±<span class="hljs-number">0.05</span>mm■ZJZ2<span class="hljs-number">.23</span>■±<span class="hljs-number">0.10</span>mm■<span class="hljs-number">80</span>■<span class="hljs-number">80</span>■■■<span class="hljs-number">0.98</span>±<span class="hljs-number">0.25</span>■<span class="hljs-number">0.05</span>+<span class="hljs-number">0.40</span>■<span class="hljs-number">11</span>±<span class="hljs-number">2</span>/<span class="hljs-number">5</span>±<span class="hljs-number">2</span>■<span class="hljs-number">11</span>±<span class="hljs-number">2</span>/<span class="hljs-number">5</span>±<span class="hljs-number">2</span>■■■<span class="hljs-number">03</span><span class="hljs-number">-1</span><span class="hljs-number">-149</span><span class="hljs-number">-029</span>■■非军车
</code></pre>
<h3 data-id="heading-23">5. 代码优化与最佳实践</h3>
<h4 data-id="heading-24">5.1 资源管理</h4>
<ul>
<li>使用<code>defer</code>语句确保资源及时释放</li>
<li>对WMI对象操作添加空值检查，避免空指针异常</li>
<li>在循环中及时释放不再使用的对象</li>
</ul>
<h4 data-id="heading-25">5.2 错误处理</h4>
<ul>
<li>实现了完善的错误处理机制</li>
<li>对可能失败的操作（如串口打开、数据读取）进行错误捕获和处理</li>
<li>提供友好的错误提示信息</li>
</ul>
<h4 data-id="heading-26">5.3 并发安全</h4>
<ul>
<li>使用通道实现协程间的安全通信</li>
<li>避免共享变量的直接访问，减少竞态条件</li>
</ul>
<h4 data-id="heading-27">5.4 性能优化</h4>
<ul>
<li>使用缓冲区拼接数据，减少字符串操作开销</li>
<li>采用协程并发处理，提高系统响应速度</li>
<li>实现了高效的编码检测算法</li>
</ul>
<h3 data-id="heading-28">6. 使用说明</h3>
<h4 data-id="heading-29">6.1 编译与运行</h4>
<p>在项目目录下执行以下命令进行编译：</p>
<pre><code class="hljs language-bash" lang="bash">go build -o test_com.exe test_com.go
</code></pre>
<p>运行程序：</p>
<pre><code class="hljs language-bash" lang="bash">.	est_com.exe
</code></pre>
<h4 data-id="heading-30">6.2 端口占用处理</h4>
<p>如果遇到端口被占用的情况，可以使用以下命令查看和终止占用进程：</p>
<ol>
<li>
<p>查看端口占用情况：</p>
<pre><code class="hljs language-bash" lang="bash">netstat -aon|findstr <span class="hljs-string">"端口号"</span>
</code></pre>
</li>
<li>
<p>查看占用端口的进程：</p>
<pre><code class="hljs language-bash" lang="bash">tasklist|findstr <span class="hljs-string">"进程ID"</span>
</code></pre>
</li>
<li>
<p>终止占用进程：</p>
<pre><code class="hljs language-bash" lang="bash">taskkill /f /t /im 进程名称
</code></pre>
</li>
</ol>
<h3 data-id="heading-31">7. 总结与展望</h3>
<p>本项目成功实现了基于Golang的COM扫码枪自动加载与扫码解码功能，具有以下优势：</p>
<ol>
<li><strong>跨型号兼容</strong>：支持多种不同型号的扫码枪设备</li>
<li><strong>自动适配</strong>：自动识别系统中的COM端口和扫码枪设备</li>
<li><strong>编码灵活</strong>：支持多种编码格式的自动检测与转换</li>
<li><strong>高效处理</strong>：采用协程实现并发数据处理，提高系统性能</li>
</ol>
<p>未来可以进一步扩展的功能包括：</p>
<ul>
<li>支持更多类型的条码解码（如二维码、RFID等）</li>
<li>实现图形化界面，方便用户操作</li>
<li>增加数据持久化功能，支持扫码记录的存储和查询</li>
<li>扩展支持Linux等其他操作系统</li>
</ul>
<h3 data-id="heading-32">8. 附录</h3>
<h4 data-id="heading-33">8.1 主要数据结构</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 扫码数据结构体</span>
<span class="hljs-keyword">type</span> CodeData <span class="hljs-keyword">struct</span> {
    Xsxh <span class="hljs-type">string</span> <span class="hljs-string">`json:"xsxh"`</span>
    Tzsh <span class="hljs-type">string</span> <span class="hljs-string">`json:"tzsh"`</span>
    Xh   <span class="hljs-type">string</span> <span class="hljs-string">`json:"xh"`</span>
    Clgg <span class="hljs-type">string</span> <span class="hljs-string">`json:"clgg"`</span>
    Ys   <span class="hljs-type">string</span> <span class="hljs-string">`json:"ys"`</span>
    Scrq <span class="hljs-type">string</span> <span class="hljs-string">`json:"scrq"`</span>
    Bc   <span class="hljs-type">string</span> <span class="hljs-string">`json:"gc"`</span>
    Hddh <span class="hljs-type">string</span> <span class="hljs-string">`json:"hddh"`</span>
    Xsgx <span class="hljs-type">string</span> <span class="hljs-string">`json:"xsgx"`</span>
    Bz   <span class="hljs-type">string</span> <span class="hljs-string">`json:"gz"`</span>
    Dz1  <span class="hljs-type">string</span> <span class="hljs-string">`json:"dz1"`</span>
    Ys1  <span class="hljs-type">string</span> <span class="hljs-string">`json:"ys1"`</span>
    Dz2  <span class="hljs-type">string</span> <span class="hljs-string">`json:"dz2"`</span>
    Ys2  <span class="hljs-type">string</span> <span class="hljs-string">`json:"ys2"`</span>
    Cpfl <span class="hljs-type">string</span> <span class="hljs-string">`json:"cpfl"`</span>
}
</code></pre>
<h4 data-id="heading-34">8.2 关键常量定义</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">const</span> (
    GBK     <span class="hljs-type">string</span> = <span class="hljs-string">"GBK"</span>
    UTF8    <span class="hljs-type">string</span> = <span class="hljs-string">"UTF8"</span>
    UNKNOWN <span class="hljs-type">string</span> = <span class="hljs-string">"UNKNOWN"</span>
)
</code></pre>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：npm和yarn基础使用]]></title>    <link>https://juejin.cn/post/7580971667037536282</link>    <guid>https://juejin.cn/post/7580971667037536282</guid>    <pubDate>2025-12-08T06:11:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580971667037536282" data-draft-id="7580971667037519898" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：npm和yarn基础使用"/> <meta itemprop="keywords" content="后端,Node.js,Trae"/> <meta itemprop="datePublished" content="2025-12-08T06:11:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：npm和yarn基础使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:11:04.000Z" title="Mon Dec 08 2025 06:11:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Node.js 项目开发中，包管理工具是不可或缺的基础设施。无论你是在搭建后端服务器、构建前端工程，还是创建命令行工具，都需要依赖成千上万的第三方包。因此，理解 npm 与 yarn 的使用方法，对于提升开发效率、保证项目可维护性至关重要。</p>
</blockquote>
<p>本篇文章将带你快速掌握 npm 与 yarn 的核心概念、基本命令以及日常开发中最常用的技巧。</p>
<hr/>
<h2 data-id="heading-0">一、什么是包管理工具？</h2>
<p>当你开始一个 Node.js 项目时，会使用各种第三方库，例如：</p>
<ul>
<li>Express（搭建 Web 服务）</li>
<li>axios（请求 HTTP 接口）</li>
<li>lodash（工具方法库）</li>
<li>moment / dayjs（时间处理）</li>
</ul>
<p>这些依赖包由 npm 或 yarn 来完成：</p>
<ul>
<li>下载与管理依赖</li>
<li>管理版本号</li>
<li>配置项目脚本</li>
<li>发布自定义模块</li>
</ul>
<p>简而言之，包管理工具就是项目依赖的“仓库管理员”。</p>
<hr/>
<h2 data-id="heading-1">二、npm：Node.js 自带的包管理器</h2>
<p>npm 全称 Node Package Manager，是 Node.js 安装包中自带的工具，生态最为庞大。</p>
<h3 data-id="heading-2">npm 常用命令</h3>
<h4 data-id="heading-3">1. 查看版本</h4>
<pre><code class="hljs language-bash" lang="bash">npm -v
</code></pre>
<h4 data-id="heading-4">2. 初始化项目</h4>
<p>生成 package.json：</p>
<pre><code class="hljs language-bash" lang="bash">npm init -y
</code></pre>
<h4 data-id="heading-5">3. 安装依赖</h4>
<p>安装到 dependencies：</p>
<pre><code class="hljs language-bash" lang="bash">npm install express
</code></pre>
<p>安装到 devDependencies：</p>
<pre><code class="hljs language-bash" lang="bash">npm install nodemon --save-dev
</code></pre>
<h4 data-id="heading-6">4. 全局安装</h4>
<pre><code class="hljs language-bash" lang="bash">npm install -g typescript
</code></pre>
<h4 data-id="heading-7">5. 删除依赖</h4>
<pre><code class="hljs language-bash" lang="bash">npm uninstall express
</code></pre>
<h4 data-id="heading-8">6. 清理缓存</h4>
<pre><code class="hljs language-bash" lang="bash">npm cache clean --force
</code></pre>
<p>npm 使用简单直接，适合入门且更加官方。</p>
<hr/>
<h2 data-id="heading-9">三、为什么出现 yarn？</h2>
<p>npm 在早期存在以下问题：</p>
<ul>
<li>安装速度慢</li>
<li>锁文件不稳定</li>
<li>安装结果不可复现</li>
</ul>
<p>为了解决这些痛点，Facebook 推出了 yarn，它提供了更快、更稳定的安装体验。</p>
<p>如今 npm 经过多次升级性能已经提升许多，但 yarn 仍拥有大量用户。</p>
<hr/>
<h2 data-id="heading-10">四、yarn 的常用命令</h2>
<p>查看版本：</p>
<pre><code class="hljs language-bash" lang="bash">yarn -v
</code></pre>
<p>初始化项目：</p>
<pre><code class="hljs language-bash" lang="bash">yarn init -y
</code></pre>
<p>安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash">yarn add express
</code></pre>
<p>安装开发依赖：</p>
<pre><code class="hljs language-bash" lang="bash">yarn add nodemon -D
</code></pre>
<p>删除依赖：</p>
<pre><code class="hljs language-bash" lang="bash">yarn remove express
</code></pre>
<p>全局安装：</p>
<pre><code class="hljs language-bash" lang="bash">yarn global add typescript
</code></pre>
<p>查看已安装包：</p>
<pre><code class="hljs language-bash" lang="bash">yarn list
</code></pre>
<p>相比 npm，yarn 的输出信息更简洁，速度也更快。</p>
<hr/>
<h2 data-id="heading-11">五、npm 与 yarn 命令对照表</h2>













































<table><thead><tr><th>功能</th><th>npm</th><th>yarn</th></tr></thead><tbody><tr><td>初始化项目</td><td>npm init -y</td><td>yarn init -y</td></tr><tr><td>安装项目依赖</td><td>npm install</td><td>yarn</td></tr><tr><td>安装包</td><td>npm install xxx</td><td>yarn add xxx</td></tr><tr><td>安装开发依赖</td><td>npm install xxx -D</td><td>yarn add xxx -D</td></tr><tr><td>删除包</td><td>npm uninstall xxx</td><td>yarn remove xxx</td></tr><tr><td>全局安装</td><td>npm install -g xxx</td><td>yarn global add xxx</td></tr><tr><td>运行脚本</td><td>npm run start</td><td>yarn start</td></tr></tbody></table>
<p>你可以看到 yarn 的命令更简短。</p>
<hr/>
<h2 data-id="heading-12">六、package.json：npm 与 yarn 的核心文件</h2>
<p>无论你使用 npm 还是 yarn，package.json 都扮演着中心角色。它记录：</p>
<ul>
<li>项目名称与版本</li>
<li>依赖列表</li>
<li>开发依赖</li>
<li>执行脚本</li>
<li>是否为 ES Module</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node-demo"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node index.js"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>日常开发中，你经常会向 scripts 中添加测试、构建、开发命令。</p>
<hr/>
<h2 data-id="heading-13">七、package-lock.json 与 yarn.lock 的作用</h2>
<p>为了确保项目在任何时间、任何机器上安装的依赖版本一致，包管理器会生成锁文件。</p>
<ul>
<li>npm 使用 <strong>package-lock.json</strong></li>
<li>yarn 使用 <strong>yarn.lock</strong></li>
</ul>
<p>锁文件可以避免“今天能运行，明天依赖版本变了就崩了”的情况。</p>
<p>锁文件是必须提交到代码仓库的。</p>
<hr/>
<h2 data-id="heading-14">八、npm 与 yarn 应该怎么选？</h2>
<h3 data-id="heading-15">适合使用 npm 的情况</h3>
<ul>
<li>纯 Node.js 后端项目</li>
<li>希望保持官方工具链</li>
<li>需要较少的额外配置</li>
<li>团队不追求极致性能</li>
</ul>
<p>npm 初学容易，安装即可使用。</p>
<h3 data-id="heading-16">适合使用 yarn 的情况</h3>
<ul>
<li>前端工程规模较大</li>
<li>依赖数量多且安装频繁</li>
<li>任何需要快速安装速度的项目</li>
<li>多人协作需要更稳定的锁文件</li>
</ul>
<p>yarn 的并行下载能力更优秀，适合大型前端项目。</p>
<hr/>
<h2 data-id="heading-17">九、混合使用会有什么问题？</h2>
<p>在一个项目中，如果同时使用 npm 和 yarn，会导致：</p>
<ul>
<li>依赖解析混乱</li>
<li>锁文件重复</li>
<li>node_modules 内容不一致</li>
</ul>
<p>建议：</p>
<h3 data-id="heading-18">一个项目只用一个包管理器</h3>
<p>要么统一用 npm，要么统一用 yarn，避免混乱。</p>
<hr/>
<h2 data-id="heading-19">十、总结</h2>
<p>npm 与 yarn 是 Node.js 项目构建的基础工具，它们的作用都是帮助开发者高效管理依赖。npm 更官方、更易上手，而 yarn 更快速、更适合大型工程。</p>
<p>日常开发中，只要掌握：</p>
<ul>
<li>如何安装依赖</li>
<li>如何添加脚本</li>
<li>如何管理锁文件</li>
<li>如何全局与本地安装工具</li>
</ul>
<p>就可以轻松胜任大多数 Node.js 项目的依赖管理工作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gopher 带你学 Serverless 架构：从服务器运维到按需计算的范式转变]]></title>    <link>https://juejin.cn/post/7580740782933622826</link>    <guid>https://juejin.cn/post/7580740782933622826</guid>    <pubDate>2025-12-08T06:20:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580740782933622826" data-draft-id="7580723992498552868" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gopher 带你学 Serverless 架构：从服务器运维到按需计算的范式转变"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-08T06:20:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="没多少逻辑"/> <meta itemprop="url" content="https://juejin.cn/user/2717648475395325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gopher 带你学 Serverless 架构：从服务器运维到按需计算的范式转变
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648475395325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    没多少逻辑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:20:51.000Z" title="Mon Dec 08 2025 06:20:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家有时候是否厌倦了管理服务器、配置环境、处理扩容？别担心，这篇指南为你介绍 <strong>Serverless 架构</strong>的核心概念，拒绝烧脑，主打轻松易懂。我们将 Serverless 的学习之旅分为三个阶段：<strong>理念、核心服务、实战模式</strong>。让我们跟随 Gopher 的脚步，一起探索"无服务器"的世界吧！</p>
<hr/>
<h2 data-id="heading-0">第一部分：理念篇 (The Philosophy)</h2>
<p>在开始写代码之前，我们需要先理解 Serverless 的本质。它不是"没有服务器"，而是"不用管服务器"。</p>
<h3 data-id="heading-1">① 为什么需要 Serverless 架构？</h3>
<p><strong>一句话概念</strong>：Serverless 是用按需计算对抗运维复杂性的架构方法。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
让开发者只关注业务代码，而将服务器管理、扩容、容错等基础设施工作完全交给云平台。你只需上传代码，平台自动运行、扩展和计费。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
传统架构中，开发者需要预估流量、购买服务器、配置环境、监控性能、处理扩容。这些运维工作占据了大量时间，而且资源利用率低（闲时浪费，忙时不够）。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3252d79240a4713ba29024e85b21c8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=qUadTRX76lTJUsSxG7GsBTAomwk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">② FaaS（函数即服务）</h3>
<p><strong>一句话概念</strong>：FaaS 是 Serverless 的核心计算模型。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
将应用拆分为独立的函数（Function），每个函数响应特定事件（HTTP 请求、定时任务、消息队列等）。函数按需执行，执行完立即释放资源。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
FaaS 实现了真正的"按需计算"。你不需要为空闲时间付费，也不需要担心流量突增，平台会自动扩展到成千上万个实例。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c23ac66fd8994efc88ae76fbbd0a2afa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=0hz9c7i2SuUHONuVo9iC%2FjJofhk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">③ 事件驱动触发</h3>
<p><strong>一句话概念</strong>：Serverless 函数由事件触发执行。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
函数不是一直运行的服务，而是被事件唤醒：HTTP 请求、文件上传、数据库变更、定时器、消息队列等。事件到达时，平台自动启动函数实例处理。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
事件驱动是 Serverless 的灵魂。它让函数真正做到"用时即来，用完即走"，实现极致的资源利用率和成本优化。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/993d15e620fa4d09b6e3236113f086a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=snYVJ1O8mQgqje5u2NWzHBW3tQw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">第二部分：核心服务篇 (Core Services)</h2>
<p>理解了 Serverless 的理念后，我们需要了解构建 Serverless 应用的核心服务。</p>
<h3 data-id="heading-5">④ API 网关（API Gateway）</h3>
<p><strong>一句话概念</strong>：API 网关是 Serverless 应用的统一入口。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
API 网关接收 HTTP 请求，路由到对应的函数，并返回响应。它还提供认证、限流、缓存、日志等功能。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
函数本身没有固定的 URL，API 网关为函数提供稳定的 RESTful 或 GraphQL 接口，是 Serverless 应用对外的"门面"。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3281f89d9fdc4db3a113c6b25d273bee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=mhB1kmM2rNlUscR1Vp5QmVCJYb4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">⑤ 对象存储（Object Storage）</h3>
<p><strong>一句话概念</strong>：对象存储是 Serverless 应用的持久化层。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
云端的文件存储服务（如 AWS S3、阿里云 OSS），用于存储静态文件、用户上传、日志等。支持无限扩展，按使用量计费。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
Serverless 函数是无状态的，执行完后所有临时数据都会丢失。对象存储提供了可靠、廉价的持久化方案，而且可以触发函数（文件上传事件）。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68d82d56660b44c98665dd0ff94c64fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=89pWh8Czoyue7kBXy0HFLa2uu2Q%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">⑥ 托管数据库（Managed Database）</h3>
<p><strong>一句话概念</strong>：托管数据库提供 Serverless 化的数据存储。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
云平台提供的数据库服务（如 DynamoDB、Aurora Serverless、Firestore），自动扩展、自动备份、按请求计费。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
传统数据库需要预配置容量、管理连接池、处理扩容。托管数据库与 Serverless 理念一致，让开发者只关注数据模型，不关心底层运维。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1b226f07b36448c857eb2a1705b65df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=nZDC83U%2FejpiGU0gEn4ytDl5ERM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">⑦ 消息队列（Message Queue）</h3>
<p><strong>一句话概念</strong>：消息队列实现 Serverless 函数间的异步通信。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
托管的消息服务（如 AWS SQS、Azure Queue），函数可以发送消息到队列，其他函数订阅队列并异步处理。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
Serverless 函数有执行时间限制（通常几分钟）。对于长时间任务，可以拆分为多个函数，通过消息队列串联，实现异步工作流。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e331386641d54dcba39654527bff2305~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=flBqa0JQmqzAsS1uZQp5swOyMME%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">⑧ 定时任务（Scheduled Tasks）</h3>
<p><strong>一句话概念</strong>：定时触发函数执行。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
通过 Cron 表达式定义执行计划，平台自动在指定时间触发函数。例如：每天凌晨 2 点执行数据备份。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
很多业务需要定期执行（报表生成、数据清理、健康检查）。Serverless 的定时任务无需维护常驻进程，按执行次数计费。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0068a7a5e55e46a780c69aa1df78bff4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=mfFu7gF%2FRKz%2F4CK39v1%2BkYYFaGg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">⑨ 日志与监控（Logging &amp; Monitoring）</h3>
<p><strong>一句话概念</strong>：可观测性是 Serverless 应用的生命线。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
云平台自动收集函数的日志、指标（执行时间、错误率、并发数）和链路追踪，提供可视化监控面板。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
Serverless 函数是短暂的、分布式的，传统的日志文件不适用。托管的日志和监控服务让你能够实时了解系统健康状况，快速定位问题。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3492a18be9249f7a770e69eafe6e596~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=rW6rzdyMqPHfbqlttQKiYhDyXuE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">第三部分：实战模式篇 (Practical Patterns)</h2>
<p>当构建真实的 Serverless 应用时，我们需要一些经过验证的模式来应对挑战。</p>
<h3 data-id="heading-12">⑩ 冷启动优化（Cold Start Optimization）</h3>
<p><strong>一句话概念</strong>：减少函数首次启动的延迟。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
当函数长时间未执行时，平台会回收资源。下次请求到达时需要重新初始化（冷启动），可能耗时几秒。优化方法包括：预热、减小代码包、使用轻量级运行时。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
冷启动是 Serverless 的主要痛点。对于延迟敏感的应用（如 Web API），冷启动会影响用户体验。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e5943707fc0436ab26ceef1225d4932~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=y1nt%2B2RdvGh3u7e3XIhEfQLYeyE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">⑪ 函数编排（Function Orchestration）</h3>
<p><strong>一句话概念</strong>：协调多个函数完成复杂工作流。</p>
<ul>
<li>
<p><strong>它是什么？</strong><br/>
使用编排服务（如 AWS Step Functions）定义函数执行的顺序、条件、并行、重试等逻辑，构建可靠的业务流程。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
单个函数应该保持简单，复杂业务需要多个函数协作。编排服务提供了可视化的工作流定义，处理错误重试、状态管理等复杂问题。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51d01a9219c6419f93e1ed5d6ebf61ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=7n8%2FGsX5Ll40tLic5y59lXC%2BD3s%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-14">⑫ 成本优化（Cost Optimization）</h3>
<p><strong>一句话概念</strong>：Serverless 按使用量计费，但也可能产生意外成本。</p>
<ul>
<li>
<p><strong>怎么做？</strong><br/>
优化策略包括：合理设置内存配置、避免无限循环、使用预留容量、监控异常调用、设置并发限制。</p>
</li>
<li>
<p><strong>为什么需要它？</strong><br/>
虽然 Serverless 通常很便宜，但如果配置不当（如内存过大、被 DDoS 攻击），成本可能失控。成本优化是 Serverless 应用的必修课。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0547e7239c854c13be936733ab95b2d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=x9YRWVm4X6FybtE796TYUQq9KUA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-15">总结</h2>
<h3 data-id="heading-16">核心回顾</h3>
<p><strong>一句话总结</strong>：Serverless 让开发者从"管理服务器"解放出来，专注于"创造价值"。</p>
<p><strong>核心意义</strong>：
所有 Serverless 的概念（FaaS、事件驱动、API 网关、对象存储、托管数据库、函数编排）都是为了实现<strong>零运维、弹性扩展、按需付费</strong>的理想架构。只有拥抱 Serverless，才能真正做到"写代码就够了"。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c074ecde35749cdb0d5dfae285e15e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKh5aSa5bCR6YC76L6R:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765779651&amp;x-signature=OGzwH8vxKdPji%2BswGWPz3I46nLY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-17">附录：Serverless 实战案例</h2>
<h3 data-id="heading-18">图片处理服务（Serverless 架构）</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    U[用户上传图片] --&gt; S3[对象存储 S3]
    S3 --&gt;|触发事件| F1[缩略图生成函数]
    S3 --&gt;|触发事件| F2[水印添加函数]
    S3 --&gt;|触发事件| F3[格式转换函数]
    
    F1 --&gt; S3_Thumb[S3 缩略图目录]
    F2 --&gt; S3_Water[S3 水印目录]
    F3 --&gt; S3_Convert[S3 转换目录]
    
    S3_Thumb --&gt; CDN[CDN 分发]
    S3_Water --&gt; CDN
    S3_Convert --&gt; CDN
    
    F1 --&gt; DDB[DynamoDB 元数据]
    F2 --&gt; DDB
    F3 --&gt; DDB
    
    CDN --&gt; U2[用户访问]
</code></pre>
<p><strong>架构特点</strong>：</p>
<ol>
<li><strong>零运维</strong>：无需管理服务器，上传代码即可运行</li>
<li><strong>事件驱动</strong>：文件上传自动触发处理函数</li>
<li><strong>弹性扩展</strong>：并发上传时自动扩展到数千实例</li>
<li><strong>按需付费</strong>：只为实际执行时间和存储空间付费</li>
<li><strong>高可用</strong>：云平台自动处理容错和重试</li>
</ol>
<h3 data-id="heading-19">Serverless vs 传统架构对比</h3>








































<table><thead><tr><th>维度</th><th>传统架构</th><th>Serverless 架构</th></tr></thead><tbody><tr><td><strong>运维负担</strong></td><td>需要管理服务器、配置、扩容</td><td>零运维，平台自动管理</td></tr><tr><td><strong>扩展性</strong></td><td>手动或自动扩容，有上限</td><td>自动无限扩展</td></tr><tr><td><strong>成本模型</strong></td><td>按服务器时间付费（闲时浪费）</td><td>按执行次数和时长付费</td></tr><tr><td><strong>启动速度</strong></td><td>服务常驻，响应快</td><td>冷启动可能有延迟</td></tr><tr><td><strong>适用场景</strong></td><td>长连接、高频调用</td><td>突发流量、定时任务、事件处理</td></tr><tr><td><strong>开发体验</strong></td><td>需要关注基础设施</td><td>只关注业务代码</td></tr></tbody></table>
<h3 data-id="heading-20">最佳实践建议</h3>
<ol>
<li><strong>函数设计</strong>：保持函数单一职责，粒度适中（不要太大也不要太碎）</li>
<li><strong>状态管理</strong>：函数无状态，状态存储到数据库或对象存储</li>
<li><strong>错误处理</strong>：实现重试机制和死信队列</li>
<li><strong>安全性</strong>：最小权限原则，使用 IAM 角色控制访问</li>
<li><strong>监控告警</strong>：设置关键指标告警（错误率、延迟、成本）</li>
<li><strong>测试策略</strong>：本地模拟环境 + 云端集成测试</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[京东API：开启电商物流新速度，订单配送快人一步！]]></title>    <link>https://juejin.cn/post/7581081334850289705</link>    <guid>https://juejin.cn/post/7581081334850289705</guid>    <pubDate>2025-12-08T06:25:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581081334850289705" data-draft-id="7580683234437218367" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="​​​​​​​京东API：开启电商物流新速度，订单配送快人一步！"/> <meta itemprop="keywords" content="API"/> <meta itemprop="datePublished" content="2025-12-08T06:25:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="贸连天下"/> <meta itemprop="url" content="https://juejin.cn/user/3959775760754074"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ​​​​​​​京东API：开启电商物流新速度，订单配送快人一步！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3959775760754074/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    贸连天下
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:25:58.000Z" title="Mon Dec 08 2025 06:25:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p> 在电商竞争日益激烈的今天，“速度”已成为用户体验的核心要素。京东凭借其强大的自建物流体系，始终引领着配送时效的标准。而面向开发者和合作伙伴开放的 <strong>京东API</strong>，则如同为电商物流引擎注入了新的涡轮增压器，让订单配送效率实现质的飞跃。本文将深入探讨京东API如何从技术层面赋能，助力商家实现“快人一步”的配送体验。</p>
<h3 data-id="heading-0">一、 效率之源：API驱动的智能物流协同</h3>
<p>传统电商物流环节多、链条长，信息传递的延迟或断层是导致配送缓慢的常见瓶颈。京东API的核心价值在于 <strong>打通数据孤岛，实现系统间的高效协同</strong>。</p>
<ol>
<li>
<p><strong>订单状态实时同步：</strong> 通过 <code>订单查询API</code>，商家系统可实时获取订单在京东物流链路上的最新状态（如：已出库、运输中、派送中、已签收）。这消除了手动查询或等待系统推送的延迟，让运营团队第一时间掌握动态，也能及时向消费者同步精准的物流轨迹。</p>
</li>
<li>
<p><strong>库存智能联动：</strong> <code>库存查询API</code> 与 <code>库存同步API</code> 允许商家系统与京东仓配系统进行库存数据的双向实时交互。这确保了：</p>
<ul>
<li><strong>前端展示准确：</strong> 避免超卖或显示无货，提升转化率。</li>
<li><strong>就近发货：</strong> 结合 <code>地址库API</code> 和库存分布，智能选择最优仓库发货，显著缩短配送半径。</li>
<li><strong>智能补货预警：</strong> 基于实时库存和销售预测API数据，自动触发补货流程，保障供应不断档。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-1">二、 速度引擎：API赋能的精细化配送管理</h3>
<p>京东API不仅提供信息查询，更提供了强大的 <strong>操作指令接口</strong>，让商家能主动干预和优化配送流程。</p>
<ol>
<li><strong>预约配送：</strong> <code>预约时间API</code> 允许商家或消费者在订单创建后，灵活指定期望的收货时间段（如工作日夜间、周末）。京东物流系统据此智能调度运力，提高一次配送成功率，减少因收货人不在导致的延误。</li>
<li><strong>电子面单与智能分单：</strong> <code>电子面单API</code> 使商家系统能自动生成符合京东规范的运单标签，无缝对接京东的分拣系统。结合 <code>地址解析API</code> 对收货地址进行智能识别和标准化处理，确保包裹能被快速、准确地路由到正确的配送站点和配送员手中。</li>
<li><strong>轨迹预判与异常预警：</strong> 深度整合的物流数据，结合算法模型，API可提供潜在的配送时间预测（虽非官方承诺，但有重要参考价值）。更重要的是，系统能通过API接口或消息推送， <strong>提前预警</strong> 可能发生的配送异常（如：天气影响、地址异常、包裹滞留），让商家和客服能提前介入处理，减少被动等待。</li>
</ol>
<h3 data-id="heading-2">三、 时效飞跃：API助力“极速达”与“精准达”</h3>
<p>京东的核心优势物流产品，如“211限时达”、“京准达”等，其高效运行的背后离不开API的强大支撑。</p>
<ol>
<li><strong>履约时效承诺：</strong> 商家在接入API后，其订单可纳入京东高效的标准化履约流程。京东系统会根据仓库位置、配送能力、时效承诺产品规则，自动为符合条件的订单打上 <strong>“极速达”</strong> 标签，并优先处理和配送。</li>
<li><strong>精准时段送达：</strong> <code>京准达API</code> 是“京准达”服务的基石。它允许用户选择精确到小时级的收货时段。商家系统通过API将预约时段信息传递给京东物流系统，后者会进行严格的 <strong>运力排班和路径优化</strong>，确保在约定时间内完成配送，兑现“说到时间就到”的承诺。</li>
</ol>
<h3 data-id="heading-3">四、 开发者如何接入？开启提速之旅</h3>
<p>接入京东API是提升物流速度的关键一步：</p>
<ol>
<li>
<p><strong>平台入驻与认证：</strong> 开发者需在京东开放平台注册账号，创建应用，并通过资质审核获取 <code>App Key</code> 和 <code>App Secret</code> 等关键认证信息。</p>
</li>
<li>
<p><strong>技术对接：</strong> 根据京东提供的详细API文档，开发者需在自己的订单管理系统、仓储管理系统、电商平台后端等系统中，调用相应的API接口。</p>
<ul>
<li>
<p><strong>示例核心接口调用思路 (伪代码)：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 假设使用Python requests库</span>
import requests
import time
import hashlib
import json

<span class="hljs-comment"># 基础配置</span>
<span class="hljs-attr">app_key</span> = <span class="hljs-string">"YOUR_APP_KEY"</span>
<span class="hljs-attr">app_secret</span> = <span class="hljs-string">"YOUR_APP_SECRET"</span>
<span class="hljs-attr">access_token</span> = <span class="hljs-string">"YOUR_ACCESS_TOKEN"</span> <span class="hljs-comment"># 通过OAuth等授权流程获取</span>
<span class="hljs-attr">api_url</span> = <span class="hljs-string">"https://api.jd.com/routerjson"</span>

<span class="hljs-comment"># 构造请求参数 - 以查询订单物流轨迹为例</span>
<span class="hljs-attr">method</span> = <span class="hljs-string">"jingdong.trace.dynamicQueryService"</span>
<span class="hljs-attr">timestamp</span> = str(int(time.time() * <span class="hljs-number">1000</span>)) <span class="hljs-comment"># 毫秒时间戳</span>
<span class="hljs-attr">v</span> = <span class="hljs-string">"2.0"</span>
<span class="hljs-attr">order_id</span> = <span class="hljs-string">"1234567890"</span> <span class="hljs-comment"># 京东订单号</span>

<span class="hljs-comment"># 参数签名 (简化示例，实际签名规则需参考文档)</span>
<span class="hljs-attr">param_dict</span> = {
    "method": method,
    "app_key": app_key,
    "access_token": access_token,
    "timestamp": timestamp,
    "v": v,
    "order_id": order_id
}
<span class="hljs-comment"># 1. 参数按Key排序 &amp; 拼接</span>
<span class="hljs-attr">sorted_params</span> = sorted(param_dict.items())
<span class="hljs-attr">sign_str</span> = app_secret + <span class="hljs-string">''</span>.join([k + v for k, v in sorted_params]) + app_secret
<span class="hljs-comment"># 2. MD5 生成签名</span>
<span class="hljs-attr">sign</span> = hashlib.md5(sign_str.encode(<span class="hljs-string">'utf-8'</span>)).hexdigest().upper()
param_dict<span class="hljs-section">['sign']</span> = sign

<span class="hljs-comment"># 发送请求</span>
<span class="hljs-attr">response</span> = requests.post(api_url, data=param_dict)
<span class="hljs-attr">result</span> = response.json()

<span class="hljs-comment"># 处理响应 - 解析物流轨迹信息</span>
if result.get('code') == '0': <span class="hljs-comment"># 成功码</span>
    <span class="hljs-attr">trace_list</span> = result[<span class="hljs-string">'jingdong_trace_dynamicQueryService_responce'</span>][<span class="hljs-string">'traceList'</span>]
    for trace in trace_list:
        print(f"时间: {trace<span class="hljs-section">['ope_time']</span>}, 状态: {trace<span class="hljs-section">['ope_remark']</span>}")
else:
    print(f"查询失败: {result<span class="hljs-section">['msg']</span>}")
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</li>
</ul>
</li>
<li>
<p><strong>联调测试：</strong> 在沙箱环境中充分测试API调用，确保数据准确、流程顺畅。</p>
</li>
<li>
<p><strong>上线监控：</strong> 正式上线后，持续监控API调用状态、响应时间、成功率等指标，利用京东提供的监控工具或自建监控系统。</p>
</li>
</ol>
<h3 data-id="heading-4">五、 总结与展望</h3>
<p>京东API是京东物流强大配送能力向外输出的重要桥梁。通过深度集成这些API，商家能够：</p>
<ul>
<li><strong>显著缩短订单处理与配送时间：</strong> 减少人工环节，自动化流转。</li>
<li><strong>提升物流透明度与用户体验：</strong> 实时轨迹、精准预约，增强用户信任。</li>
<li><strong>优化库存管理，降低运营成本：</strong> 智能联动，减少冗余和缺货。</li>
<li><strong>无缝接入京东核心时效产品：</strong> 享受“快人一步”的配送竞争力。</li>
</ul>
<p>随着技术的持续迭代（如大数据、人工智能、物联网与API的更深融合），未来的京东API将更加智能化、场景化，为电商物流的速度边界带来更多可能。现在就开始拥抱京东API，让你的订单配送，真正快人一步！</p>
<hr/>
<p><strong>注意事项：</strong></p>
<ul>
<li>文中提到的具体API名称（如 <code>jingdong.trace.dynamicQueryService</code>）仅为示例，实际接口名称和参数请以 <strong>京东官方开放平台的最新文档</strong> 为准。</li>
<li>代码示例为简化伪代码，真实对接涉及复杂的签名算法、错误处理、数据解析等，务必参考官方SDK或文档。</li>
<li>“极速达”、“京准达”等是京东物流的具体服务产品，其覆盖范围和规则可能动态调整。</li>
<li>API性能与稳定性依赖于网络、系统负载等多方面因素。</li>
</ul>
<p>     <a href="https://link.juejin.cn?target=https%3A%2F%2Fo0b.cn%2Fevan" title="https://o0b.cn/evan" target="_blank" ref="nofollow noopener noreferrer">如有任何疑问，欢迎大家留言探讨。</a></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VSCode 推出 绿色版！更强！更智能！]]></title>    <link>https://juejin.cn/post/7580683234437267519</link>    <guid>https://juejin.cn/post/7580683234437267519</guid>    <pubDate>2025-12-08T06:40:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580683234437267519" data-draft-id="7580616979474137094" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VSCode 推出 绿色版！更强！更智能！"/> <meta itemprop="keywords" content="前端,JavaScript,Visual Studio Code"/> <meta itemprop="datePublished" content="2025-12-08T06:40:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端开发爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/1116759545088190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VSCode 推出 绿色版！更强！更智能！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759545088190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端开发爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:40:11.000Z" title="Mon Dec 08 2025 06:40:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近，<strong>VSCode</strong> 再次被推上热门，各大开发社区、推特/X 上都在讨论一个话题—— <strong>“VSCode 绿色版（Insiders）功能太强了！”</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fd75366f0ac490fb31a64d91d2db806~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765780810&amp;x-signature=e4IwreK27oO7HkQ6ifhy0%2BJ1vvM%3D" alt="" loading="lazy"/></p>
<p>事实上，<strong>VSCode Insiders</strong> 并不是一个新名字，但随着微软不断注入 <strong>AI 能力、终端增强、Git 大升级、新 UI</strong>，它已经变成了真正意义上的：<strong>VSCode 超强增强版！</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65e457d6105e4b288ac072205f72e141~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765780810&amp;x-signature=enccncUjEEooOxgtS6UEG8794ws%3D" alt="" loading="lazy"/></p>
<p>本文将带你全面认识 <strong>绿色版都强在哪？为什么开发者都在推荐？你是否应该安装？</strong></p>
<h2 data-id="heading-0">🎯 <strong>什么是 VSCode 绿色版（Insiders）？</strong></h2>
<p><strong>一句话：VSCode 的“更新抢先体验版”，比正式版更快看到新功能！</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd7f8a7bb5d141399075d6e6fc39658e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765780810&amp;x-signature=gfdHagRpJjIyOStiSqoqJ09%2FM80%3D" alt="" loading="lazy"/></p>
<p>它和 <strong>Stable</strong>（正式版）可以共存使用，<code>不会覆盖</code>、<code>不冲突</code>，非常适合爱折腾、追新功能的开发者。</p>
<h2 data-id="heading-1">🟢 <strong>终端大升级：智能提示终于来了！</strong></h2>
<p><strong>VSCode</strong> 终端一直是<code>“能用但不好用”</code>；而绿色版直接把它提升到<code>“智能终端”</code>级别。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68f66166dd4a4818a871e2df9faf7465~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765780810&amp;x-signature=pJk0kbSnJ%2BRvlWoX3VXKpq2kOoM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">✨ <strong>1. 命令自动补全（智能建议）</strong></h3>
<p>例如你在<strong>终端</strong>输入：</p>
<pre><code class="hljs">git ch
</code></pre>
<p>它会自动建议：</p>
<pre><code class="hljs">git checkout
</code></pre>
<p>更厉害的是：</p>
<ul>
<li><strong>命令 flag 会被分类展示</strong></li>
<li><strong>参数智能提示</strong></li>
<li><strong>路径补全更精确</strong></li>
</ul>
<h3 data-id="heading-3">✨ <strong>2. AI 执行命令时使用“真终端渲染器”</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4170726936fe4f78a6b8aec8588c3dd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765780810&amp;x-signature=0pLSwRb8%2F4Vnk9cnBbB8qZ7ZSmk%3D" alt="" loading="lazy"/></p>
<p>绿色版已将 <strong>Copilot Agent</strong> 的终端输出升级为 <strong>xterm.js 真终端渲染器</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f965e6dd918544c6ab49550005d0ee90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765780810&amp;x-signature=njvLyv8RJq%2BiW4Rh8yRpYYcNol0%3D" alt="" loading="lazy"/></p>
<ul>
<li><code>ANSI</code> 颜色正常显示</li>
<li><code>表格</code>、<code>行列</code>对齐准确</li>
<li>输出<code>清晰</code>、<code>结构化</code></li>
</ul>
<p><strong>终端从此不再只是“命令窗”，而是智能交互环境。</strong></p>
<h2 data-id="heading-4">🌳 <strong>Git 管理体验提升：Stash 终于可视化了！</strong></h2>
<p>以前 <strong>VSCode</strong> 对 <code>stash</code> 支持几乎没有，只能敲命令。</p>
<p>这次绿色版直接补上短板！</p>
<p>设置以下选项：</p>
<ul>
<li><code>scm.repositories.explorer：true</code></li>
<li><code>scm.repositories.selectionMode：single</code></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73f92237ca2a402da1743154c0365fb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765780810&amp;x-signature=AxqICOg7m38wJORh6RqBi4NI%2Bgc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">✨ <strong>可视化 Stash 管理器</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0e462d705f942f3ac4ef35e4e84ae22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765780810&amp;x-signature=zWOw7mdOxnUKXlVNBgOVgZhpKyo%3D" alt="" loading="lazy"/></p>
<ul>
<li>查看所有 <code>stash</code></li>
<li>一键 <code>apply / pop / delete</code></li>
<li>自动显示<code>时间戳</code></li>
<li>相同时间段用竖线对齐，界面更清爽</li>
</ul>
<p>这功能对于频繁<code>切分支</code>、<code>保存临时改动</code>的开发者来说简直是 <strong>质的提升</strong>。</p>
<h2 data-id="heading-6">🤖 <strong>AI 全面进化：Copilot Agent 模式上线！</strong></h2>
<p>这是绿色版最轰动的更新之一。</p>
<h3 data-id="heading-7">✨ <strong>1. Copilot 从“智能补全” → “自动执行任务代理”</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dad068975d62481f9aec4411410c4fcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765780810&amp;x-signature=f0GOFN7uqwY5WFpsfDS%2FxD727B8%3D" alt="" loading="lazy"/></p>
<p>它可以自动：</p>
<ul>
<li><strong>修改多个文件</strong></li>
<li><strong>执行并分析终端命令</strong></li>
<li><strong>管理项目结构</strong></li>
<li><strong>重构代码</strong></li>
<li><strong>搜索 / 替换文件内容</strong></li>
<li><strong>构建 / 运行项目</strong></li>
</ul>
<p>你只需要一句话：</p>
<blockquote>
<p>“帮我给项目增加用户登录功能。”</p>
</blockquote>
<p>然后它会自动拆解步骤，帮你完成。</p>
<h3 data-id="heading-8">✨ <strong>2. Notebook（Markdown + 代码）也能用 AI 自动编辑</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f18eea80317e49738bd63ab93a8a3543~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765780810&amp;x-signature=s2l8WVl0lKF46yFPz9J89w5FZ%2Fk%3D" alt="" loading="lazy"/></p>
<p>例如：</p>
<ul>
<li><strong>自动创建 Code Cell</strong></li>
<li><strong>总结文章内容</strong></li>
<li><strong>插入示例代码</strong></li>
<li><strong>自动修复错别字</strong></li>
<li><strong>做学习笔记</strong></li>
</ul>
<p>科研、学习、数据分析用户狂喜！</p>
<h2 data-id="heading-9">🖥 <strong>UI / UX 更现代、更便捷</strong></h2>
<p>绿色版对各种细节都做了<strong>体验升级</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/521d126379f64fcb98a0acc04751011f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5Y-R54ix5aW96ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765780810&amp;x-signature=D6V%2BLQ8uP6mFIqp58EgVbCuvhyA%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>Git 同步按钮更直观</strong></li>
<li><strong>悬停信息更清晰</strong></li>
<li><strong>状态指示更精准</strong></li>
<li><strong>布局与配色有实验性改进</strong></li>
</ul>
<p><strong>整体观感比正式版更轻盈、简洁、顺滑。</strong></p>
<h2 data-id="heading-10">🔧 <strong>扩展生态更强：插件作者必装</strong></h2>
<p>很多新的 <strong>API</strong>（如 <code>Terminal API</code>、<code>Notebook API</code>、<code>Panel API</code>）都会：</p>
<p>👉 <strong>先出现在 Insiders</strong>
👉 <strong>过几个月再进入正式版</strong></p>
<p>如果你要开发或测试 <strong>VSCode</strong> 扩展，绿色版是必备。</p>
<h2 data-id="heading-11">📥 <strong>如何安装 VS Code 绿色版？</strong></h2>
<p>安装非常简单：</p>
<p>👉 <strong>官方下载安装</strong>：<code>https://code.visualstudio.com/insiders</code></p>
<p>优势：</p>
<ul>
<li><strong>可与正式版并存</strong></li>
<li><strong>不影响原环境</strong></li>
<li><strong>卸载不留痕</strong></li>
<li><strong>随时体验最新功能</strong></li>
</ul>
<h2 data-id="heading-12">✔️ <strong>谁适合使用 VS Code 绿色版？</strong></h2>
<p>如果你属于下面任意一个人，请立即安装：</p>
<ul>
<li><strong>喜欢尝鲜</strong></li>
<li><strong>重度命令行用户</strong></li>
<li><strong>Copilot</strong> 用户</li>
<li><strong>插件开发者</strong></li>
<li><strong>关注效率 &amp; 新技术</strong></li>
<li>想第一时间体验 <strong>VSCode</strong> 未来方向</li>
</ul>
<h2 data-id="heading-13">🎉 <strong>结语：绿色版不是“内测玩具”，而是更强大的 VSCode</strong></h2>
<p>总结一下绿色版带来的增强：</p>





























<table><thead><tr><th>功能方向</th><th>提升</th></tr></thead><tbody><tr><td>🔥 <strong>终端</strong></td><td>智能提示 + 真终端渲染</td></tr><tr><td>🌳 <strong>Git</strong></td><td>可视化 <strong>Stash</strong> 管理</td></tr><tr><td>🤖 <strong>AI</strong></td><td><strong>Copilot</strong> 进入自动化时代</td></tr><tr><td>🖥 <strong>UI</strong></td><td>更现代、更细腻</td></tr><tr><td>🧩 <strong>插件</strong></td><td>最新 <strong>API</strong> 先体验</td></tr></tbody></table>
<p>一句话：<strong>VSCode Insiders 是真正意义上的“VS Code Pro 版”。</strong></p>
<p>如果你还没体验，现在就装一个吧，你会爱上它。</p>
<ul>
<li><strong>VSCode Insiders 下载地址</strong>：<code>https://code.visualstudio.com/insiders</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Gradle 学习 - 生命周期和Task]]></title>    <link>https://juejin.cn/post/7581036773607981056</link>    <guid>https://juejin.cn/post/7581036773607981056</guid>    <pubDate>2025-12-08T06:44:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581036773607981056" data-draft-id="7579264485259329551" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Gradle 学习 - 生命周期和Task"/> <meta itemprop="keywords" content="gradle,Android,前端"/> <meta itemprop="datePublished" content="2025-12-08T06:44:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明川"/> <meta itemprop="url" content="https://juejin.cn/user/114004941350269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Gradle 学习 - 生命周期和Task
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/114004941350269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明川
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:44:22.000Z" title="Mon Dec 08 2025 06:44:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>  上一篇文章<a href="https://juejin.cn/post/7579298511072346112" target="_blank" title="https://juejin.cn/post/7579298511072346112">Kts Gradle学习 </a> 主要是学习新版本的Kotlin Gradle相关配置和以前的Groovy的不同表现方式，这里需要为后边自定义插件编写做准备，所以还是要学习下Gradle的生命周期和一些命令或者Task的基础知识 （ps：最早是20年看的一个大佬的文章入门，时隔多年 重新整理和回顾，在AI的大浪潮下 沉下心稳扎稳打基本功也是可以的）</p>
<h2 data-id="heading-1">Gradle生命周期</h2>
<p>Gradle 构建分为三个阶段：</p>
<p><strong>初始化阶段 (Initialization)</strong></p>
<ul>
<li>读取 <code>settings.gradle.kts</code>文件，生成Settings对象，确定哪些项目需要参与构建，为需要构建的项目创建Project对象；</li>
</ul>
<p><strong>配置阶段 (Configuration)</strong></p>
<ul>
<li>配置阶段主要是解析<code>build.gradle.kts</code>文件，配置init阶段生成的Project对象，构建根项目和所有子项目，同时生成和配置在<code>build.gradle.kts</code>中定义的Task对象，构造Task的关系依赖图，关系依赖图是一个有向无环图；</li>
</ul>
<p><strong>执行阶段 (Execution)</strong></p>
<ul>
<li>根据configure阶段的关系依赖图执行Task.</li>
</ul>
<h3 data-id="heading-2">生命周期钩子实例</h3>
<p>可以借助Gradle 留给我们的钩子 ，在 <code>build.gradle.kts</code> 和子中，来打印一下生命周期，熟悉下钩子的使用</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 配置阶段钩子</span>
beforeEvaluate {
    println(<span class="hljs-string">"3. 项目配置开始"</span>)
}

afterEvaluate {
    println(<span class="hljs-string">"4. 项目配置完成"</span>)
}

gradle.projectsEvaluated {
    println(<span class="hljs-string">"5. 所有项目配置完成"</span>)
}

<span class="hljs-comment">// 执行阶段钩子</span>
gradle.taskGraph.whenReady {
    println(<span class="hljs-string">"6. Task 图准备完成"</span>)
}

gradle.taskGraph.beforeTask {
    println(<span class="hljs-string">"7. Task 执行前：<span class="hljs-variable">$path</span>"</span>)
}

gradle.taskGraph.afterTask {
    println(<span class="hljs-string">"8. Task 执行后：<span class="hljs-variable">$path</span>"</span>)
}

gradle.buildFinished {
    println(<span class="hljs-string">"9. 构建完成"</span>)
}
</code></pre>
<h3 data-id="heading-3">工程中钩子使用</h3>
<p><strong>根目录下的 <code>build.gradle</code> groovy 格式</strong></p>
<pre><code class="hljs language-groovy" lang="groovy">// 钩子3：每个项目配置开始前
gradle.beforeProject { project -&gt;
    println "\n [配置阶段] ${project.name} 开始配置"
}

// 钩子4：每个项目配置完成后
gradle.afterProject { project -&gt;
    println " [配置阶段] ${project.name} 配置完成"

    // 统计信息
    def taskCount = project.tasks.size()
    def depCount = project.configurations.size()
    println "    Tasks: ${taskCount} | Configurations: ${depCount}"
}

// 钩子5：所有项目配置完成
gradle.projectsEvaluated {
    println "\n [配置阶段] 所有项目配置完成"

    // 统计所有项目的 Task 数量
    def totalTasks = gradle.rootProject.allprojects.sum { it.tasks.size() }
    println "   总 Task 数量：${totalTasks}"
}

// 钩子6：Task 图准备完成（知道要执行哪些 Task）
gradle.taskGraph.whenReady { taskGraph -&gt;
    println "\n [执行阶段] Task 执行计划"

    def tasks = taskGraph.allTasks
    println "将执行 ${tasks.size()} 个 Task：\n"

    // 按项目分组显示
    tasks.groupBy { it.project.name }.each { projectName, projectTasks -&gt;
        println " ${projectName}:"
        projectTasks.each { task -&gt;
            println "   ✓ ${task.name}"
        }
        println ""
    }
}

// 钩子7：每个 Task 执行前
gradle.taskGraph.beforeTask { task -&gt;
    println "  [执行] 开始：${task.path}"
}

// 钩子8：每个 Task 执行后
gradle.taskGraph.afterTask { task -&gt;
    def status = task.state.failure != null ? " 失败" : " 成功"
    def skipped = task.state.skipped ? " (跳过)" : ""
    println "${status} [执行] 完成：${task.path}${skipped}"
}

// 钩子9：构建完成（成功或失败）
gradle.buildFinished { result -&gt;
    if (result.failure != null) {
        println "\n Gradle 构建失败"
        println "\n错误：${result.failure?.message}"
    } else {
        println "\n Gradle 构建成功"
    }
}
</code></pre>
<p>Library 模块<code>build.gradle.kts</code> kts格式</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> projectStartTime = System.currentTimeMillis()
println(<span class="hljs-string">"\n  [<span class="hljs-subst">${project.name}</span>] 配置阶段开始"</span>)

<span class="hljs-comment">// 钩子：当前项目配置完成</span>
afterEvaluate {
    <span class="hljs-keyword">val</span> configTime = System.currentTimeMillis() - projectStartTime
    println(<span class="hljs-string">" [<span class="hljs-subst">${project.name}</span>] 配置完成，耗时：<span class="hljs-subst">${configTime}</span>ms"</span>)

    <span class="hljs-comment">// 显示 Android 配置信息</span>
    android.apply {
        println(<span class="hljs-string">"Android 配置："</span>)
        println(<span class="hljs-string">"- compileSdk: <span class="hljs-variable">$compileSdk</span>"</span>)
        println(<span class="hljs-string">"- minSdk: <span class="hljs-subst">${defaultConfig.minSdk}</span>"</span>)
        println(<span class="hljs-string">"- targetSdk: <span class="hljs-subst">${defaultConfig.targetSdk}</span>"</span>)
        println(<span class="hljs-string">"- versionCode: <span class="hljs-subst">${defaultConfig.versionCode}</span>"</span>)
        println(<span class="hljs-string">"- versionName: <span class="hljs-subst">${defaultConfig.versionName}</span>"</span>)
    }
}

<span class="hljs-comment">// Task 级别监控（带性能分析）</span>

tasks.configureEach {
    doFirst {
        <span class="hljs-comment">// 记录每个 Task 的开始时间</span>
        ext.<span class="hljs-keyword">set</span>(<span class="hljs-string">"taskStartTime"</span>, System.currentTimeMillis())
        println(<span class="hljs-string">"[<span class="hljs-variable">$path</span>] 任务开始执行..."</span>)
    }

    doLast {
        <span class="hljs-comment">// 计算每个 Task 的耗时</span>
        <span class="hljs-keyword">val</span> start = ext.<span class="hljs-keyword">get</span>(<span class="hljs-string">"taskStartTime"</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">Long</span>
        <span class="hljs-keyword">val</span> duration = System.currentTimeMillis() - start

        <span class="hljs-comment">// 根据耗时分类</span>
        <span class="hljs-keyword">val</span> mm = <span class="hljs-keyword">when</span> {
            duration &gt; <span class="hljs-number">5000</span> -&gt; <span class="hljs-string">"垃圾速度"</span>
            duration &gt; <span class="hljs-number">2000</span> -&gt; <span class="hljs-string">"正常速度"</span> 
            duration &gt; <span class="hljs-number">1000</span> -&gt; <span class="hljs-string">"飞速速度"</span> 
            duration &gt; <span class="hljs-number">0</span> -&gt; <span class="hljs-string">"闪电速度"</span> 
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-string">" ？？？ "</span>
        }

        println(<span class="hljs-string">"<span class="hljs-variable">$mm</span> [<span class="hljs-variable">$path</span>] 任务完成，耗时：<span class="hljs-subst">${duration}</span>ms"</span>)

        <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">5000</span>) {
            println(<span class="hljs-string">"警告：任务耗时过长，建议优化！"</span>)
        }
    }
}

<span class="hljs-comment">// 特定 Task 的钩子</span>

<span class="hljs-comment">// 监控编译 Task</span>
tasks.withType&lt;org.jetbrains.kotlin.gradle.tasks.KotlinCompile&gt;().configureEach {
    doFirst {
        println(<span class="hljs-string">"Kotlin 编译开始..."</span>)
    }
    doLast {
        println(<span class="hljs-string">"Kotlin 编译完成"</span>)
    }
}

<span class="hljs-comment">// 监控打包 Task（Library 模块使用 bundleDebugAar）</span>

tasks.matching { it.name == <span class="hljs-string">"bundleDebugAar"</span> }.configureEach {
    doFirst {
        println(<span class="hljs-string">"\n 开始打包 Debug AAR..."</span>)
    }
    doLast {
        println(<span class="hljs-string">" Debug AAR 打包完成！"</span>)

        <span class="hljs-comment">// 显示 AAR 信息</span>
        <span class="hljs-keyword">val</span> aarDir = File(layout.buildDirectory.asFile.<span class="hljs-keyword">get</span>(), <span class="hljs-string">"outputs/aar"</span>)
        <span class="hljs-keyword">if</span> (aarDir.exists()) {
            aarDir.listFiles()?.forEach { aar -&gt;
                <span class="hljs-keyword">if</span> (aar.extension == <span class="hljs-string">"aar"</span>) {
                    <span class="hljs-keyword">val</span> size = aar.length() / <span class="hljs-number">1024.0</span> / <span class="hljs-number">1024.0</span>
                    println(<span class="hljs-string">"AAR: <span class="hljs-subst">${aar.name}</span>"</span>)
                    println(<span class="hljs-string">"大小: <span class="hljs-subst">${<span class="hljs-string">"%.2f"</span>.format(size)}</span> MB"</span>)
                }
            }
        }
    }
}

tasks.matching { it.name == <span class="hljs-string">"bundleReleaseAar"</span> }.configureEach {
    doFirst {
        println(<span class="hljs-string">"\n 开始打包 Release AAR..."</span>)
    }
    doLast {
        println(<span class="hljs-string">" Release AAR 打包完成！"</span>)
        
        <span class="hljs-comment">// 显示 AAR 信息</span>
        <span class="hljs-keyword">val</span> aarDir = File(layout.buildDirectory.asFile.<span class="hljs-keyword">get</span>(), <span class="hljs-string">"outputs/aar"</span>)
        <span class="hljs-keyword">if</span> (aarDir.exists()) {
            aarDir.listFiles()?.forEach { aar -&gt;
                <span class="hljs-keyword">if</span> (aar.extension == <span class="hljs-string">"aar"</span>) {
                    <span class="hljs-keyword">val</span> size = aar.length() / <span class="hljs-number">1024.0</span> / <span class="hljs-number">1024.0</span>
                    println(<span class="hljs-string">"AAR: <span class="hljs-subst">${aar.name}</span>"</span>)
                    println(<span class="hljs-string">"大小: <span class="hljs-subst">${<span class="hljs-string">"%.2f"</span>.format(size)}</span> MB"</span>)
                }
            }
        }
    }
}
</code></pre>
<p>查看gradle 运行结果可见</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">Starting</span> <span class="hljs-string">Gradle</span> <span class="hljs-string">Daemon...</span>
<span class="hljs-string">Gradle</span> <span class="hljs-string">Daemon</span> <span class="hljs-string">started</span> <span class="hljs-string">in</span> <span class="hljs-number">854</span> <span class="hljs-string">ms</span>

<span class="hljs-string">&gt;</span> <span class="hljs-attr">Configure project :</span>
 [<span class="hljs-string">配置阶段</span>] <span class="hljs-string">GradleY</span> <span class="hljs-string">配置完成</span>
    <span class="hljs-attr">Tasks:</span> <span class="hljs-number">17</span> <span class="hljs-string">|</span> <span class="hljs-attr">Configurations:</span> <span class="hljs-number">0</span>

<span class="hljs-string">&gt;</span> <span class="hljs-string">Configure</span> <span class="hljs-string">project</span> <span class="hljs-string">:app</span>

 [<span class="hljs-string">配置阶段</span>] <span class="hljs-string">app</span> <span class="hljs-string">开始配置</span>
 [<span class="hljs-string">配置阶段</span>] <span class="hljs-string">app</span> <span class="hljs-string">配置完成</span>
    <span class="hljs-attr">Tasks:</span> <span class="hljs-number">35</span> <span class="hljs-string">|</span> <span class="hljs-attr">Configurations:</span> <span class="hljs-number">140</span>

<span class="hljs-string">&gt;</span> <span class="hljs-string">Configure</span> <span class="hljs-string">project</span> <span class="hljs-string">:GroovyLibrary</span>

 [<span class="hljs-string">配置阶段</span>] <span class="hljs-string">GroovyLibrary</span> <span class="hljs-string">开始配置</span>
 [<span class="hljs-string">配置阶段</span>] <span class="hljs-string">GroovyLibrary</span> <span class="hljs-string">配置完成</span>
    <span class="hljs-attr">Tasks:</span> <span class="hljs-number">33</span> <span class="hljs-string">|</span> <span class="hljs-attr">Configurations:</span> <span class="hljs-number">80</span>

<span class="hljs-string">&gt;</span> <span class="hljs-string">Configure</span> <span class="hljs-string">project</span> <span class="hljs-string">:KtsLibrary</span>

 [<span class="hljs-string">配置阶段</span>] <span class="hljs-string">KtsLibrary</span> <span class="hljs-string">开始配置</span>

  [<span class="hljs-string">KtsLibrary</span>] <span class="hljs-string">配置阶段开始</span>
 [<span class="hljs-string">配置阶段</span>] <span class="hljs-string">KtsLibrary</span> <span class="hljs-string">配置完成</span>
    <span class="hljs-attr">Tasks:</span> <span class="hljs-number">34</span> <span class="hljs-string">|</span> <span class="hljs-attr">Configurations:</span> <span class="hljs-number">80</span>
 [<span class="hljs-string">KtsLibrary</span>] <span class="hljs-string">配置完成，耗时：21ms</span>
    <span class="hljs-string">Android</span> <span class="hljs-string">配置：</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">compileSdk:</span> <span class="hljs-number">35</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">minSdk:</span> <span class="hljs-number">24</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targetSdk:</span> <span class="hljs-literal">null</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">versionCode:</span> <span class="hljs-literal">null</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">versionName:</span> <span class="hljs-literal">null</span>

 [<span class="hljs-string">配置阶段</span>] <span class="hljs-string">所有项目配置完成</span>
   <span class="hljs-string">总</span> <span class="hljs-string">Task</span> <span class="hljs-string">数量：687</span>

 [<span class="hljs-string">执行阶段</span>] <span class="hljs-string">Task</span> <span class="hljs-string">执行计划</span>
<span class="hljs-string">将执行</span> <span class="hljs-number">1</span> <span class="hljs-string">个</span> <span class="hljs-string">Task：</span>

 <span class="hljs-attr">GradleY:</span>
   <span class="hljs-string">✓</span> <span class="hljs-string">prepareKotlinBuildScriptModel</span>


<span class="hljs-string">&gt;</span> <span class="hljs-string">Task</span> <span class="hljs-string">:prepareKotlinBuildScriptModel</span> <span class="hljs-string">UP-TO-DATE</span>
  [<span class="hljs-string">执行</span>] <span class="hljs-string">开始：:prepareKotlinBuildScriptModel</span>
 <span class="hljs-string">成功</span> [<span class="hljs-string">执行</span>] <span class="hljs-string">完成：:prepareKotlinBuildScriptModel</span> <span class="hljs-string">(跳过)</span>
<span class="hljs-string">Download</span> <span class="hljs-string">https://maven.aliyun.com/repository/public/javax/inject/javax.inject/1/javax.inject-1-javadoc.jar,</span> <span class="hljs-string">took</span> <span class="hljs-number">36</span> <span class="hljs-string">ms</span>

 <span class="hljs-string">Gradle</span> <span class="hljs-string">构建成功</span>

<span class="hljs-string">BUILD</span> <span class="hljs-string">SUCCESSFUL</span> <span class="hljs-string">in</span> <span class="hljs-string">24s</span>
</code></pre>
<p>如果想查看aar 执行情况可以输出 <code>./gradlew :KtsLibrary:assemble --no-daemon</code> （gradlew即Gradle Wrapper的简写）</p>
<h2 data-id="heading-4">常用命令</h2>
<p>下列主要是自己平时使用到的命令，有时候会忘记，这里也捎带上</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 Gradle 版本</span>
./gradlew --version

<span class="hljs-comment"># 查看所有可用 Task</span>
./gradlew tasks

<span class="hljs-comment"># 查看所有 Task（包括隐藏的）</span>
./gradlew tasks --all

<span class="hljs-comment"># 查看项目结构</span>
./gradlew projects

<span class="hljs-comment"># 清理构建产物</span>
./gradlew clean

<span class="hljs-comment"># 清理并构建</span>
./gradlew clean build

========  Android 构建 ==========
<span class="hljs-comment"># 构建所有变体</span>
./gradlew assemble

<span class="hljs-comment"># 构建 Debug 版本</span>
./gradlew assembleDebug

<span class="hljs-comment"># 构建失败时，查看详细错误</span>
./gradlew assembleDebug --info --stacktrace

<span class="hljs-comment"># 构建 Release 版本</span>
./gradlew assembleRelease

<span class="hljs-comment"># 安装 Debug 版本</span>
./gradlew installDebug

<span class="hljs-comment"># 安装 Release 版本</span>
./gradlew installRelease

<span class="hljs-comment"># 卸载 Debug 版本</span>
./gradlew uninstallDebug

<span class="hljs-comment"># 卸载 Release 版本</span>
./gradlew uninstallRelease

===========  查看依赖 ==========
<span class="hljs-comment"># 查看所有依赖 并输出到文件中</span>
./gradlew app:dependencies &gt; dependencies.txt

<span class="hljs-comment"># 查看特定配置的依赖</span>
./gradlew :app:dependencies --configuration implementation
./gradlew :app:dependencies --configuration debugRuntimeClasspath

<span class="hljs-comment"># 查看依赖树，找 (*) 标记</span>
./gradlew :app:dependencies --configuration debugRuntimeClasspath | grep <span class="hljs-string">"(*)"</span>

<span class="hljs-comment"># 查看具体的依赖路径</span>
./gradlew :app:dependencyInsight --dependency okhttp --configuration debugRuntimeClasspath

<span class="hljs-comment"># 查看任务</span>
./gradlew tasks

</code></pre>
<p>还有一些可以自己拼接在后边的 重要参数</p>
<pre><code class="hljs language-gradle" lang="gradle"># 调试
--info                   # 详细信息
--stacktrace            # 栈追踪
--scan                  # 构建扫描

# 性能
--parallel              # 并行
--build-cache           # 构建缓存
--configuration-cache   # 配置缓存
</code></pre>
<p>这里只是简单塞了一些 常用的命令</p>
<h2 data-id="heading-5">Task 任务</h2>
<h3 data-id="heading-6">Task 基本概念</h3>
<p>  Task（任务）是Gradle中最小的构建单元，但是 Task中又会有很多的Action 是Task中最小的执行单元。 Gradle 构建的核心是由Task组成的<strong>有向无环图</strong>，所以 各个Task之间是有运行顺序的，不会出现循环依赖等问题。 Task属于 Project对象，所以可以放在根目录或者子目录的 build.gradle.kts文件中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b732c105bdc45bfbeecd6aaedc18441~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO5bed:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765781061&amp;x-signature=VnGGd1cfRLhPCnz1XRkUnuGAHSY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">Task 使用</h3>
<p>创建 （推荐使用register 懒加载）</p>
<pre><code class="hljs language-kotlin" lang="kotlin">register(String name, Action&lt;? <span class="hljs-keyword">super</span> Task&gt; configurationAction)
register(String name, Class type, Action&lt;? <span class="hljs-keyword">super</span> T&gt; configurationAction)

<span class="hljs-comment">// 最简单的Task  不推荐使用 create 直接创建 </span>
tasks.register(<span class="hljs-string">"hello"</span>) {
    doLast {
        println(it.name + <span class="hljs-string">" Gradle!"</span>)
    }
}

<span class="hljs-comment">// 带类型的Task 其他的还有 Delete、Zip、Jar等类型</span>
tasks.register&lt;Copy&gt;(<span class="hljs-string">"copyFiles"</span>) {
    from(<span class="hljs-string">"src/main/resources"</span>)
    into(<span class="hljs-string">"build/resources"</span>)
}

<span class="hljs-comment">// 带配置的Task</span>
tasks.register(<span class="hljs-string">"printInfo"</span>) {
    group = <span class="hljs-string">"custom"</span>
    description = <span class="hljs-string">"打印项目信息"</span>
    
    doLast {
        println(<span class="hljs-string">"Project: <span class="hljs-subst">${project.name}</span>"</span>)
        println(<span class="hljs-string">"Version: <span class="hljs-subst">${project.version}</span>"</span>)
    }
}

<span class="hljs-comment">// 使用案例</span>
./gradlew hello
<span class="hljs-comment">// 也可以多个Task 执行  （但是Task 的命名是不能重复的）</span>
./gradlew task1 task2 task3
</code></pre>
<h3 data-id="heading-8">doFirst 和 doLast</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">tasks.register(<span class="hljs-string">"greeting"</span>) {
    <span class="hljs-comment">// doLast：在最后执行</span>
    doLast {
        println(<span class="hljs-string">"3. Goodbye!"</span>)
    }
    
    <span class="hljs-comment">// doFirst：在最前面执行</span>
    doFirst {
        println(<span class="hljs-string">"2. Hello!"</span>)
    }
    
    <span class="hljs-comment">// 再添加一个doLast  最后添加的 doLast 最后执行</span>
    doLast {
        println(<span class="hljs-string">"4. See you!"</span>)
    }
    
    <span class="hljs-comment">// 再添加一个doFirst   最后添加的 doFirst第一个执行</span>
    doFirst {
        println(<span class="hljs-string">"1. Welcome!"</span>)
    }
}
</code></pre>
<p>运行结果</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-quote">&gt; Task :greeting</span>
<span class="hljs-bullet">1.</span> Welcome!
<span class="hljs-bullet">2.</span> Hello!
<span class="hljs-bullet">3.</span> Goodbye!
<span class="hljs-bullet">4.</span> See you!
</code></pre>
<h3 data-id="heading-9">自定义Task</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GreetingTask</span> : <span class="hljs-type">DefaultTask</span>() {
    
    <span class="hljs-meta">@Input</span>
    <span class="hljs-keyword">var</span> greeting: String = <span class="hljs-string">"Hello"</span>
    
    <span class="hljs-meta">@Input</span>
    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">"World"</span>
    
    <span class="hljs-meta">@TaskAction</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">greet</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"<span class="hljs-variable">$greeting</span>, <span class="hljs-variable">$name</span>!"</span>)
    }
}

<span class="hljs-comment">// 使用自定义Task</span>
tasks.register&lt;GreetingTask&gt;(<span class="hljs-string">"greet"</span>) {
    greeting = <span class="hljs-string">"你好"</span>
    name = <span class="hljs-string">"Gradle"</span>
}
</code></pre>
<h3 data-id="heading-10">Task 常用属性</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">tasks.register(<span class="hljs-string">"myTask"</span>) {
    <span class="hljs-comment">// 任务名称（只读）</span>
    println(<span class="hljs-string">"Task name: <span class="hljs-variable">$name</span>"</span>)
    <span class="hljs-comment">// 任务分组</span>
    group = <span class="hljs-string">"custom"</span>
    <span class="hljs-comment">// 任务描述</span>
    description = <span class="hljs-string">"这是一个自定义任务"</span>
    <span class="hljs-comment">// 是否启用</span>
    enabled = <span class="hljs-literal">true</span>
    <span class="hljs-comment">// 超时时间</span>
    timeout.<span class="hljs-keyword">set</span>(Duration.ofMinutes(<span class="hljs-number">5</span>))
    <span class="hljs-comment">// 依赖的Task</span>
    dependsOn(<span class="hljs-string">"clean"</span>)
    doLast {
        println(<span class="hljs-string">"Executing <span class="hljs-variable">$name</span>"</span>)
    }
}
</code></pre>
<h3 data-id="heading-11">Task依赖关系</h3>
<ul>
<li>dependsOn（强依赖）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">tasks.register(<span class="hljs-string">"taskA"</span>) {
    doLast {
        println(<span class="hljs-string">"执行 TaskA"</span>)
    }
}

tasks.register(<span class="hljs-string">"taskB"</span>) {
    doLast {
        println(<span class="hljs-string">"执行 TaskB"</span>)
    }
}

tasks.register(<span class="hljs-string">"taskC"</span>) {
    <span class="hljs-comment">// taskC依赖taskA和taskB</span>
    dependsOn(<span class="hljs-string">"taskA"</span>, <span class="hljs-string">"taskB"</span>)
    
    doLast {
        println(<span class="hljs-string">"执行 TaskC"</span>)
    }
}
</code></pre>
<p><strong>执行 <code>./gradlew taskC</code></strong>： 是必须先执行依赖项的， 有向无环的</p>
<pre><code class="hljs language-arduino" lang="arduino">&gt; <span class="hljs-built_in">Task</span> :taskA
执行 TaskA

&gt; <span class="hljs-built_in">Task</span> :taskB
执行 TaskB

&gt; <span class="hljs-built_in">Task</span> :taskC
执行 TaskC
</code></pre>
<ul>
<li>mustRunAfter （在谁之后 必须的，会报错的那种）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">tasks.register(<span class="hljs-string">"compile"</span>) {
    doLast {
        println(<span class="hljs-string">"编译代码"</span>)
    }
}

tasks.register(<span class="hljs-string">"test"</span>) {
    <span class="hljs-comment">// 如果test要执行，必须在compile之后</span>
    mustRunAfter(<span class="hljs-string">"compile"</span>)
    
    doLast {
        println(<span class="hljs-string">"运行测试"</span>)
    }
}
</code></pre>
<p><strong>执行 <code>./gradlew compile test</code></strong>：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash">Task :compile</span>
编译代码
<span class="hljs-meta prompt_">
&gt; </span><span class="bash">Task :<span class="hljs-built_in">test</span></span>
运行测试
</code></pre>
<p><strong>执行 <code>./gradlew test compile</code></strong>（顺序相反）：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash">Task :compile  ← 依然先执行compile</span>
编译代码
<span class="hljs-meta prompt_">
&gt; </span><span class="bash">Task :<span class="hljs-built_in">test</span></span>
运行测试
</code></pre>
<p><strong>只执行 <code>./gradlew test</code></strong>：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash">Task :<span class="hljs-built_in">test</span>  ← 只执行<span class="hljs-built_in">test</span>，不会自动执行compile</span>
运行测试
</code></pre>
<ul>
<li>shouldRunAfter （在谁之后  不强制，不会报错）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">tasks.register(<span class="hljs-string">"taskA"</span>) {
    doLast {
        println(<span class="hljs-string">"TaskA"</span>)
    }
}

tasks.register(<span class="hljs-string">"taskB"</span>) {
    <span class="hljs-comment">// 建议在taskA之后执行</span>
    shouldRunAfter(<span class="hljs-string">"taskA"</span>)
    
    doLast {
        println(<span class="hljs-string">"TaskB"</span>)
    }
}
</code></pre>
<ul>
<li>finalizedBy  （结束后执行 某Task）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">tasks.register(<span class="hljs-string">"buildApp"</span>) {
    <span class="hljs-comment">// 构建完成后，必须执行清理</span>
    finalizedBy(<span class="hljs-string">"cleanup"</span>)
    
    doLast {
        println(<span class="hljs-string">"构建应用"</span>)
    }
}

tasks.register(<span class="hljs-string">"cleanup"</span>) {
    doLast {
        println(<span class="hljs-string">"清理临时文件"</span>)
    }
}
</code></pre>
<p><strong>执行 <code>./gradlew buildApp</code></strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">&gt; <span class="hljs-built_in">Task</span> :buildApp
构建应用

&gt; <span class="hljs-built_in">Task</span> :cleanup
清理临时文件
</code></pre>
<h3 data-id="heading-12">Task跳过</h3>
<ul>
<li>onlyIf  （条件跳过）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">tasks.register(<span class="hljs-string">"deployProd"</span>) {
    <span class="hljs-comment">// 只有在生产环境才执行</span>
    onlyIf {
        project.hasProperty(<span class="hljs-string">"prod"</span>)
    }
    
    doLast {
        println(<span class="hljs-string">"部署到生产环境"</span>)
    }
}
</code></pre>
<p><strong>执行</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">// 不会执行
./gradlew deployProd

// 会执行
./gradlew deployProd -Pprod
</code></pre>
<ul>
<li>StopExecutionException （异常跳过）</li>
<li>enabled</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">tasks.register(<span class="hljs-string">"oldTask"</span>) {
    <span class="hljs-comment">// 禁用这个Task</span>
    enabled = <span class="hljs-literal">false</span>
    
    doLast {
        println(<span class="hljs-string">"这个Task已被禁用"</span>)
    }
}
</code></pre>
<ul>
<li>timeout   （超时跳过）</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">tasks.register(<span class="hljs-string">"longRunningTask"</span>) {
    timeout.<span class="hljs-keyword">set</span>(Duration.ofSeconds(<span class="hljs-number">10</span>))
    
    doLast {
        println(<span class="hljs-string">"开始执行长时间任务"</span>)
        Thread.sleep(<span class="hljs-number">15000</span>)
        println(<span class="hljs-string">"任务完成"</span>)
    }
}
</code></pre>
<p><strong>执行结果：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">Execution failed <span class="hljs-keyword">for</span> task <span class="hljs-string">':longRunningTask'</span>.
&gt; Timeout has been exceeded
</code></pre>
<h3 data-id="heading-13">Task执行状态</h3>
<p>运行项目 有些Task后边会带一些大写后缀，但是有些Task可能后边没有，<strong>一般是指运行说明</strong></p>
<pre><code class="hljs language-ruby" lang="ruby">&gt; <span class="hljs-title class_">Task</span> <span class="hljs-symbol">:LiveBundle</span><span class="hljs-symbol">:LiveAudience</span><span class="hljs-symbol">:mergeReleaseNativeLibs</span> <span class="hljs-variable constant_">NO</span>-<span class="hljs-variable constant_">SOURCE</span>
&gt; <span class="hljs-title class_">Task</span> <span class="hljs-symbol">:LiveBundle</span><span class="hljs-symbol">:LiveAudience</span><span class="hljs-symbol">:stripReleaseDebugSymbols</span> <span class="hljs-variable constant_">NO</span>-<span class="hljs-variable constant_">SOURCE</span>
&gt; <span class="hljs-title class_">Task</span> <span class="hljs-symbol">:LiveBundle</span><span class="hljs-symbol">:LiveAudience</span><span class="hljs-symbol">:copyReleaseJniLibsProjectOnly</span> <span class="hljs-variable constant_">UP</span>-<span class="hljs-variable constant_">TO</span>-<span class="hljs-variable constant_">DATE</span>
&gt; <span class="hljs-title class_">Task</span> <span class="hljs-symbol">:TingMainHost</span><span class="hljs-symbol">:Application</span><span class="hljs-symbol">:mergeAnd-f5-ocpaReleaseAssets</span> <span class="hljs-variable constant_">FROM</span>-<span class="hljs-variable constant_">CACHE</span>
&gt; <span class="hljs-title class_">Task</span> <span class="hljs-symbol">:LiveBundle</span><span class="hljs-symbol">:Anchor</span><span class="hljs-symbol">:compileReleaseKotlin</span> <span class="hljs-variable constant_">UP</span>-<span class="hljs-variable constant_">TO</span>-<span class="hljs-variable constant_">DATE</span>
&gt; <span class="hljs-title class_">Task</span> <span class="hljs-symbol">:LiveBundle</span><span class="hljs-symbol">:LiveHome</span><span class="hljs-symbol">:compileReleaseKotlin</span> <span class="hljs-variable constant_">UP</span>-<span class="hljs-variable constant_">TO</span>-<span class="hljs-variable constant_">DATE</span>
</code></pre>



































<table><thead><tr><th>标签</th><th>说明</th><th>示例场景</th></tr></thead><tbody><tr><td><strong>(无标签)</strong></td><td>Task正常执行</td><td>编译、打包等</td></tr><tr><td><code>UP-TO-DATE</code></td><td>输入输出未改变，跳过执行</td><td>增量构建</td></tr><tr><td><code>FROM-CACHE</code></td><td>从构建缓存中复用结果</td><td>开启Build Cache</td></tr><tr><td><code>SKIPPED</code></td><td>Task被跳过</td><td>条件不满足、被排除</td></tr><tr><td><code>NO-SOURCE</code></td><td>没有源文件需要处理</td><td>空的源码目录</td></tr></tbody></table>
<h3 data-id="heading-14">Task增量构建</h3>
<p>  <strong>增量构建</strong> 是当Task的输入和输出没有变化时，跳过action的执行，当Task输入或输出发生变化时，在action中只对发生变化的输入或输出进行处理，这样就可以避免一个没有变化的Task被反复构建，当Task发生变化时也只处理变化部分，这样可以提高Gradle的构建效率，缩短构建时间。</p>
<p>Task增量构建判断流程：</p>
<ol>
<li>检查输入是否改变（文件内容、属性值等）</li>
<li>检查输出是否存在</li>
<li>如果输入未变且输出存在 → UP-TO-DATE</li>
<li>否则 → 重新执行</li>
</ol>
<p>模拟示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IncrementalTask</span> : <span class="hljs-type">DefaultTask</span>() {
    
    <span class="hljs-meta">@InputFile</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> inputFile: RegularFileProperty
    
    <span class="hljs-meta">@OutputFile</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> outputFile: RegularFileProperty
    
    <span class="hljs-meta">@TaskAction</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">execute</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> input = inputFile.<span class="hljs-keyword">get</span>().asFile
        <span class="hljs-keyword">val</span> output = outputFile.<span class="hljs-keyword">get</span>().asFile
        
        println(<span class="hljs-string">"处理文件：<span class="hljs-subst">${input.name}</span>"</span>)
        
        <span class="hljs-comment">// 读取输入，处理后写入输出</span>
        <span class="hljs-keyword">val</span> content = input.readText()
        output.writeText(content.uppercase())
    }
}

tasks.register&lt;IncrementalTask&gt;(<span class="hljs-string">"processFile"</span>) {
    inputFile.<span class="hljs-keyword">set</span>(file(<span class="hljs-string">"input.txt"</span>))
    outputFile.<span class="hljs-keyword">set</span>(file(<span class="hljs-string">"build/output.txt"</span>))
}
</code></pre>
<p>首次执行：</p>
<pre><code class="hljs language-bash" lang="bash">$ ./gradlew processFile

&gt; Task :processFile
处理文件：input.txt
</code></pre>
<p>再次执行（input.txt未改变）：</p>
<pre><code class="hljs language-bash" lang="bash">$ ./gradlew processFile
// 发现文件没有改变 跳过执行
&gt; Task :processFile UP-TO-DATE   
</code></pre>
<p>修改input.txt后再次执行：</p>
<pre><code class="hljs language-bash" lang="bash">$ ./gradlew processFile
// 发现文件产生了改变  重新执行 
&gt; Task :processFile
处理文件：input.txt
</code></pre>
<p>关于输入和输出，上边的自定义Task注解代表的含义简单列举下常用的：
<strong>常用的注解</strong></p>


















































<table><thead><tr><th>注解</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>@Input</code></td><td>标记输入属性</td><td>字符串、数字等</td></tr><tr><td><code>@InputFile</code></td><td>标记输入文件</td><td>单个文件</td></tr><tr><td><code>@InputFiles</code></td><td>标记输入文件集合</td><td>多个文件</td></tr><tr><td><code>@InputDirectory</code></td><td>标记输入目录</td><td>目录</td></tr><tr><td><code>@OutputFile</code></td><td>标记输出文件</td><td>单个文件</td></tr><tr><td><code>@OutputFiles</code></td><td>标记输出文件集合</td><td>多个文件</td></tr><tr><td><code>@OutputDirectory</code></td><td>标记输出目录</td><td>目录</td></tr><tr><td><code>@Internal</code></td><td>标记内部属性（不参与增量构建）</td><td>临时变量</td></tr></tbody></table>
<h3 data-id="heading-15">禁用增量构建</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">tasks.register(<span class="hljs-string">"alwaysRun"</span>) {
    <span class="hljs-comment">// 禁用UP-TO-DATE检查</span>
    outputs.upToDateWhen { <span class="hljs-literal">false</span> }
    
    doLast {
        println(<span class="hljs-string">"每次都执行"</span>)
    }
}
</code></pre>
<h2 data-id="heading-16">最后</h2>
<p>  主要学习了 Task 基础知识吧，都是为了最后的自定义插件工作的，基础但是是必要的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[「zotepad」用Gemini3pro写出一个高效写作和发文的记事本应用]]></title>    <link>https://juejin.cn/post/7581041679189606435</link>    <guid>https://juejin.cn/post/7581041679189606435</guid>    <pubDate>2025-12-08T06:43:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581041679189606435" data-draft-id="7581036773607899136" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「zotepad」用Gemini3pro写出一个高效写作和发文的记事本应用"/> <meta itemprop="keywords" content="前端,Nuxt.js,Android"/> <meta itemprop="datePublished" content="2025-12-08T06:43:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿康zz"/> <meta itemprop="url" content="https://juejin.cn/user/1978776659428727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「zotepad」用Gemini3pro写出一个高效写作和发文的记事本应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1978776659428727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿康zz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T06:43:13.000Z" title="Mon Dec 08 2025 06:43:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>起因是最近从 <code>macos</code> 切换到了 <code>windows11</code>，软件生态全部换新。</p>
<p>而 <code>Gemini3pro</code> 前两周刚刚发布，我正好实验一下效果如何。就没有着急安装 <code>Obsidian</code>，用 <code>Gemini3p</code> 写了个 demo 「<code>zotepad</code>」试试。</p>
<p>第一版的UI效果感觉不错，很简洁。</p>
<p><strong>一个产品能用起来首先得不丑吧。</strong></p>
<p>于是就决定完善一下自己平时实际在用的流程，看看能做到什么地步。</p>
<p>所以此App围绕我平时写文章、发动态以及发布文章这条主线展开。</p>
<p>App目前的几个主页</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8988305e860c4435b2baf959f978c4ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5bq3eno=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765780993&amp;x-signature=ZV9NuIQsOKkrCzBvRlfNVk1eryE%3D" alt="" loading="lazy"/></p>
<p>核心功能：md编辑器 -&gt; 图床（上传图片）-&gt; 流 （http请求）</p>
<p>内置流：生成公众号编辑器可用的样式 -&gt; 发送到公众号草稿箱/手动复制样式</p>
<p><strong><code>流</code>就是一组自定义的http请求</strong>，app内的内容会作为初始参数传递给<code>流</code>的第一个http请求，后续每个http请求返回的数据会放在同一个<code>ctx</code>(上下文中)，理论上可以实现任意功能。</p>
<p>比如「<strong>发送公众号草稿箱</strong>」这个内置流包括三个http请求：</p>
<ol>
<li>获取微信授权access_token</li>
<li>上传图片到永久素材</li>
<li>发送到草稿箱</li>
</ol>
<p><strong>并且流可以导出为json格式，以及可以导入别人的流</strong></p>
<p>编辑及发送功能演示⬇️</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cde23451b004d54b16ed3792b712bdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5bq3eno=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765780993&amp;x-signature=Z2VNl1%2BeGXvu%2F6InwgYmmvHkTmI%3D" alt="" loading="lazy"/></p>
<p>图片方面，我目前用的腾讯云所以直接先实现了腾讯云。</p>
<p>公众号样式，之前在我自研的<a href="https://link.juejin.cn?target=https%3A%2F%2Fzzao.club" target="_blank" title="https://zzao.club" ref="nofollow noopener noreferrer">全栈博客站</a>上已经有了一套方法可用。这次复刻到了<code>zotepad</code>上，主要是踩了一下公众号助手 App 粘贴 html 后样式错乱的坑。光这一个复制样式功能，已经有不少网站圈起来收费了...</p>
<p>发送草稿箱，读了读公众号的开发文档，发现只要这三个接口就可以。</p>
<p>关于<code>流</code>里的Http请求中的敏感数据，设置里可以配置类似<code>Github Secrets</code>的环境变量，在流里用模板字符串的写法代替真实的敏感信息 <code>{{token}}</code>。<strong>这样可以避免复制出来的JSON里携带自己的保密信息。</strong></p>
<p>但是这一点就和放在web端的敏感信息一样，<strong>君子不用防，小人防不住</strong>。</p>
<p>后续围绕主线功能会产生如下<strong>支线功能</strong>：</p>
<ol>
<li>图床。写文章必须要有，已实现腾讯云。</li>
<li>图片压缩、格式转换。本来是不必须，但<strong>此app的主要愿景是让我多写点东西</strong>，多写就要多传图，流量就是钱，所以这也是必须要做的了</li>
<li>图片拼图、分割。像是给这个app写点宣传文章，还是把图片拼起来别人看着方便一些。</li>
<li>图片美化、文字转图片。类似微信的排版成图以及小红书的文字生成图片，客户端的优势也许主要在于可以批量。</li>
<li>更多的<code>流</code>。比如获取V2EX的信息，只要在设置里配好自己的<code>V2EX_PAT</code>，那流本身就可以复制别人的了。</li>
<li>文章负责发公众号图文模式，动态就对应"小绿书"模式，这个比较简单</li>
<li>文章样式自定义。这一点编辑器本身其实已经内置了六七个主题，我暂时没有放开。准备再加一个自定义样式，实现一些复杂样式。</li>
<li>剪贴板。同样作为一个内容来源，我正在考虑这个功能的必要性。</li>
<li>导出数据、导入数据。必做的。</li>
<li>同步功能。</li>
</ol>
<p>同步功能已经有了一些思考，没有像用类似 <strong>Git</strong>、<strong>webDav</strong> 等同步方式，我把客户端和移动端<strong>类比为手机和智能手表</strong>的关系。</p>
<p>客户端启动时会自动启动一个本地服务器，这一点确保了<strong>两者可以通过同一个局域网通信</strong>。因为手机不会离身，而电脑在工作摸鱼期间则是绝对的主力。</p>
<p>这样在工作期间，理论上电脑端的内容是最新的，所以可以在移动端使用一个叫「拉取电脑端数据」的流，把客户端的数据直接用http请求获取过去，存在手机上。</p>
<p><strong>关上电脑回家之后，基本电脑上不会被打开</strong>。此时用手机码字手机发文章，等第二天上班之后，打开电脑端，就可以再用另一个流「向电脑端传送数据」向电脑端发数据。</p>
<p>对于两台电脑，三个手机等类似问题，无非就是流内接口处理时增加不同机器的标识问题，似乎难度不大，也不需要处理冲突问题。<strong>也考虑到可能一个用户也没有或只有极少数同频用户，所以也许一个手机对多个电脑就能满足了。</strong></p>
<p>以上就是最近1-2周在用<code>Gemini3pro</code>打磨的<code>zotepad</code>，基本就是自己怎么用，产品就往什么方向走。</p>
<p><strong>所以也希望有更多的想法碰撞一下，实现更多人的需求。</strong></p>
<p>同时后面也会分享一下如何和 <code>Gemini</code> 沟通，让它准确的完成任务。</p>
<p>项目目前完全开源免费，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faatrooox%2Fzotepad" target="_blank" title="https://github.com/aatrooox/zotepad" ref="nofollow noopener noreferrer">Github地址</a>，<strong>欢迎 Star、Issue</strong></p>
<p>项目技术栈：Nuxt4 + Tauri2</p>
<p>支持<strong>安卓App</strong>、<strong>Windows</strong>、<strong>Macos</strong> 三端</p>
<p>数据存储：Sqlite。纯本地</p>
<p>项目简介：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzzao.club%2Fproduct%2Fzotepad" target="_blank" title="https://zzao.club/product/zotepad" ref="nofollow noopener noreferrer">ZotePad</a></p>
<hr/>
<p><em>Powered by ZotePad</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让 ast-grep 听你的：指定语言解析 Vue/TSX/JSX 全流程]]></title>    <link>https://juejin.cn/post/7581098720034373672</link>    <guid>https://juejin.cn/post/7581098720034373672</guid>    <pubDate>2025-12-08T07:03:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581098720034373672" data-draft-id="7581098720034340904" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让 ast-grep 听你的：指定语言解析 Vue/TSX/JSX 全流程"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-08T07:03:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火车叼位"/> <meta itemprop="url" content="https://juejin.cn/user/1345457960792808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让 ast-grep 听你的：指定语言解析 Vue/TSX/JSX 全流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457960792808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火车叼位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T07:03:05.000Z" title="Mon Dec 08 2025 07:03:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>接上一篇博客: <a href="https://juejin.cn/post/7579819594270785574" target="_blank" title="https://juejin.cn/post/7579819594270785574">ast-grep：结构化搜索与重构利器ast-grep 的主要论点是在文本 grep 与重量级 AST 工具之间建立一座 - 掘金</a></p>
<p>在多语言项目里，文件扩展名未必等于想要的解析语法：比如 <code>.vue</code> 内嵌 <code>&lt;script setup lang="tsx"&gt;</code>，但默认解析器可能把整文件当成 Vue 语法，导致 TS/TSX 规则匹配不到。ast-grep 提供两条路可以“强制”指定解析语言：</p>
<ol>
<li>命令行临时指定 <code>--lang</code>；</li>
<li>在规则/配置文件里用 <code>language</code> 覆盖。
本文给出可直接复用的命令、配置示例，以及在 Vue/Pug 场景下的避坑方案。</li>
</ol>
<h2 data-id="heading-0">方法一：命令行临时指定语言</h2>
<p>适合一次性查询或快速验证模式。</p>
<h3 data-id="heading-1">基本用法</h3>
<pre><code class="hljs language-bash" lang="bash">sg run --lang tsx -p <span class="hljs-string">'defineProps($P)'</span> src/views/yufukuan/Yufukuan.vue
</code></pre>
<ul>
<li><code>--lang tsx</code>：强制把输入文件按 TSX 解析，即使扩展名是 <code>.vue</code>。</li>
<li><code>-p 'defineProps($P)'</code>：模式示例，可替换成任意 TS/TSX 语法模式。</li>
</ul>
<h3 data-id="heading-2">如果模板干扰解析</h3>
<ul>
<li>现有 tree-sitter-vue 对 <code>lang="pug"</code> 模板不做 AST 解析，命令会把模板当作文本，可能触发 ERROR。</li>
<li>解决思路：
<ol>
<li>仅喂 <code>&lt;script&gt;</code> 部分：先用脚本提取 <code>&lt;script&gt;</code>，再通过 stdin 传给 sg。
<pre><code class="hljs language-bash" lang="bash">node -e <span class="hljs-string">"const fs=require('fs');const txt=fs.readFileSync('src/views/yufukuan/Yufukuan.vue','utf8');const m=txt.match(/&lt;script[\\s\\S]*?&lt;\\/script&gt;/);if(m)process.stdout.write(m[0]);"</span> \
  | sg run --lang tsx --stdin -p <span class="hljs-string">'defineProps($P)'</span>
</code></pre>
</li>
<li>临时改模板为普通 HTML（不改需求时就别这么做），确认解析器可工作后再回滚。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-3">只想做文本级匹配</h3>
<p>如果解析器对模板报错，可以降级用模板严格度或纯文本：</p>
<pre><code class="hljs language-bash" lang="bash">sg run --lang vue --strictness template -p <span class="hljs-string">'handlerEditInst'</span> src/views/**/*.vue
</code></pre>
<p>这不会给出 AST 结构，但可在 VSCode/CLI 内快速找关键词。</p>
<h2 data-id="heading-4">方法二：在规则/配置里指定语言</h2>
<p>适合需要多次复用的规则或集成到 <code>sg scan</code> 的场景。</p>
<h3 data-id="heading-5">规则文件示例</h3>
<p>新建规则 <code>rules/vue-script-tsx.yml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">id:</span> <span class="hljs-string">vue-script-tsx-define-props</span>
<span class="hljs-attr">language:</span> <span class="hljs-string">tsx</span>            <span class="hljs-comment"># 这里强制按 TSX 解析</span>
<span class="hljs-attr">rule:</span>
  <span class="hljs-attr">pattern:</span> <span class="hljs-string">"defineProps($P)"</span>
</code></pre>
<p>要让规则只作用于指定路径，可以配合 <code>files</code> 或在运行时用 <code>--globs</code>：</p>
<pre><code class="hljs language-bash" lang="bash">sg scan --config sgconfig.yml --globs <span class="hljs-string">"src/**/*.vue"</span> --rules vue-script-tsx-define-props
</code></pre>
<p>说明：</p>
<ul>
<li><code>language</code> 字段覆盖扩展名默认解析器。</li>
<li>模式仍需符合该语言语法；若模板残留会导致 ERROR，可结合“只喂脚本”或在规则里增加条件过滤。</li>
</ul>
<h3 data-id="heading-6">针对 JS/JSX 的示例</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">id:</span> <span class="hljs-string">vue-script-jsx-import-check</span>
<span class="hljs-attr">language:</span> <span class="hljs-string">jsx</span>
<span class="hljs-attr">rule:</span>
  <span class="hljs-attr">pattern:</span> <span class="hljs-string">"import $A from '$B'"</span>
</code></pre>
<p>运行：</p>
<pre><code class="hljs language-bash" lang="bash">sg scan --config sgconfig.yml --globs <span class="hljs-string">"src/**/*.vue"</span> --rules vue-script-jsx-import-check
</code></pre>
<h2 data-id="heading-7">常见问题与处理</h2>
<ul>
<li>“Pattern contains an ERROR node”：
<ul>
<li>解析器在遇到模板/非目标语法时产生错误。尝试提取 <code>&lt;script&gt;</code> 后再解析，或临时移除 Pug 语法测试。</li>
</ul>
</li>
<li>“matched nothing” 且无错误：
<ul>
<li>确认模式语法合法；用 <code>--debug-query=pattern</code> 查看解析结果。</li>
</ul>
</li>
<li>VSCode 插件无结果但 CLI 正常：
<ul>
<li>VSCode 也依赖同一解析器，对 Pug/TSX 一样受限。可在插件里用文本模式，或等待支持更好的解析器。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-8">实操建议（Vue 项目）</h2>
<ol>
<li>先在 CLI 验证：
<pre><code class="hljs language-bash" lang="bash">sg run --lang tsx -p <span class="hljs-string">'defineProps($P)'</span> src/views/foo.vue
</code></pre>
</li>
<li>若模板导致 ERROR，先用脚本提取 <code>&lt;script&gt;</code> 再搜。</li>
<li>需要重复用的查询，写进 <code>rules/*.yml</code>，加上 <code>language: tsx/js/jsx</code>，通过 <code>sg scan --globs "src/**/*.vue"</code> 运行。</li>
<li>如果必须结构化解析模板层（Pug），要么把模板改为 HTML，要么寻找/自建支持 Pug 的 Vue 解析器重新编译 <code>vue.so</code>。</li>
</ol>
<h2 data-id="heading-9">结语</h2>
<p>ast-grep 支持在命令行和规则层双重覆写解析语言，这让你可以在混合文件中对脚本部分进行结构化搜索。但解析器能力是天花板：当模板/脚本语法不被支持时（如 Pug + TSX），需要先裁剪输入或更换解析器，否则只能退化为文本匹配。按照本文的命令与配置示例，可以快速在 Vue 项目里对脚本逻辑做 TS/TSX/JSX 级别的精确查询，而不必等待默认解析器完善。***</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年ERC标准技术地图：开发者的核心协议选型与实战指南]]></title>    <link>https://juejin.cn/post/7580988382761205775</link>    <guid>https://juejin.cn/post/7580988382761205775</guid>    <pubDate>2025-12-08T05:21:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580988382761205775" data-draft-id="7580616979473448966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年ERC标准技术地图：开发者的核心协议选型与实战指南"/> <meta itemprop="keywords" content="web3,智能合约,Solidity"/> <meta itemprop="datePublished" content="2025-12-08T05:21:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木西"/> <meta itemprop="url" content="https://juejin.cn/user/2436173496845549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年ERC标准技术地图：开发者的核心协议选型与实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173496845549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T05:21:04.000Z" title="Mon Dec 08 2025 05:21:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>在区块链的浩瀚星空中，ERC标准如同一颗颗精密校准的星辰，构成了以太坊生态系统最坚实的坐标系。从2015年ERC-20开启代币化浪潮，到如今超过200项提案交织成的标准化网络，这些技术规范不仅定义了数字资产的交互语言，更在2025年成为连接虚拟经济与实体世界的桥梁。</p>
<p>当前，我们正站在Web3发展史上的关键拐点。监管框架的成熟（如香港稳定币条例与RWA登记平台）、技术栈的工业化（EIP-4337账户抽象普及率超60%），以及跨链互操作性的刚需，共同推动了ERC标准从"可选项"向"必选项"的蜕变。无论是DeFi协议追求资本效率的极致优化，还是RWA资产面临合规落地的刚性约束，亦或是普通用户对无感化体验的迫切需求，都在呼唤一个更清晰、更实用、更具前瞻性的标准导航图。</p>
<p>本文将抛却冗长论述，以工程师的务实视角，为您呈现一份2025年ERC标准的"活地图"。我们不仅会拆解ERC-20、ERC-721等基石性协议的生存法则，更会深度聚焦ERC-4626（DeFi收益层事实标准）、ERC-3643（RWA合规唯一路径）、ERC-4337（用户体验革命）这三大改变行业格局的新星。同时，我们梳理了跨链资产、AI生成内容、抗量子安全等前沿领域的最新规范，并附上一份可直接用于生产环境的"技术选型决策表"。
无论您是构建下一个杀手级应用的开发者，还是评估项目技术基本面的投资者，亦或是探索Web3边界的创新者，这份汇总都将成为您穿越复杂技术迷雾的指南针——因为在这个标准化驱动的时代，选择正确的ERC标准，就是选择了通往未来的捷径。</p>
</blockquote>
<h2 data-id="heading-1">ERC标准是什么</h2>
<p>ERC（Ethereum Request for Comment）是以太坊开发者提交的协议提案，经EIP流程批准后成为强制性或推荐性标准。截至2025年，以太坊生态已有超过200个ERC标准，其中约30个被广泛使用</p>
<h2 data-id="heading-2"><strong>核心代币标准分类</strong></h2>
<h4 data-id="heading-3">1. <strong>同质化代币</strong></h4>


























<table><thead><tr><th>标准</th><th>名称</th><th>功能简述</th><th>应用场景</th><th>2025年状态</th></tr></thead><tbody><tr><td><strong>ERC-20</strong></td><td>Token Standard</td><td>基础转账、授权、余额查询</td><td>USDT、UNI、所有治理代币</td><td>✅ 绝对基石，100%项目使用</td></tr><tr><td><strong>ERC-2612</strong></td><td>Permit Extension</td><td>离线签名授权（无gas approve）</td><td>DAI、USDC、DeFi协议集成</td><td>✅ 新代币标配，用户体验必备</td></tr></tbody></table>
<h4 data-id="heading-4">2. <strong>非同质化代币</strong></h4>








































<table><thead><tr><th>标准</th><th>名称</th><th>功能简述</th><th>应用场景</th><th>2025年状态</th></tr></thead><tbody><tr><td><strong>ERC-721</strong></td><td>NFT Standard</td><td>唯一Token ID，不可分割</td><td>数字艺术品、PFP、收藏品</td><td>✅ NFT黄金标准</td></tr><tr><td><strong>ERC-1155</strong></td><td>Multi-Token</td><td>同时支持FT和NFT，批量操作</td><td>GameFi装备、元宇宙资产</td><td>✅ GameFi首选，效率更高</td></tr><tr><td><strong>ERC-721A</strong></td><td>Gas-Optimized NFT</td><td>批量铸造节省60% Gas</td><td>大型项目发行（如Azuki）</td><td>✅ 2025年主流发行方案</td></tr><tr><td><strong>ERC-2981</strong></td><td>Royalty Standard</td><td>NFT版税信息标准化</td><td>跨市场版税执行</td><td>✅ 市场强制要求</td></tr></tbody></table>
<h4 data-id="heading-5">3. <strong>收益与金库标准</strong></h4>


























<table><thead><tr><th>标准</th><th>名称</th><th>核心功能</th><th>代表项目</th><th>重要性</th></tr></thead><tbody><tr><td><strong>ERC-4626</strong></td><td>Tokenized Vault</td><td>统一金库存取款接口，自动复利</td><td>Yearn、Aave、Compound</td><td>⭐⭐⭐⭐⭐ 收益层事实标准</td></tr><tr><td><strong>ERC-4626扩展</strong></td><td>收益优化</td><td>滑点保护、线性释放</td><td>Balancer、Aura</td><td>⭐⭐⭐⭐ 大型DeFi标配</td></tr></tbody></table>
<h4 data-id="heading-6">4. <strong>现实世界资产（RWA）合规标准</strong></h4>

































<table><thead><tr><th>标准</th><th>名称</th><th>核心功能</th><th>适用资产</th><th>监管要求</th></tr></thead><tbody><tr><td><strong>ERC-3643</strong></td><td>T-REX Protocol</td><td>强制身份验证、动态合规规则</td><td>证券、房地产、基金</td><td>✅ 香港RWA平台强制使用</td></tr><tr><td><strong>ERC-1400</strong></td><td>Security Token</td><td>证券型代币标准</td><td>STO发行</td><td>⚠️ 被ERC-3643逐步替代</td></tr><tr><td><strong>ERC-3475</strong></td><td>Bonds Standard</td><td>债券标准，复杂计息</td><td>链上债券</td><td>🔥 2025年债券代币化热点</td></tr></tbody></table>
<h4 data-id="heading-7">5. <strong>账户与签名标准</strong></h4>

































<table><thead><tr><th>标准</th><th>名称</th><th>核心功能</th><th>解决痛点</th><th>普及度</th></tr></thead><tbody><tr><td><strong>ERC-4337</strong></td><td>Account Abstraction</td><td>智能合约钱包，社交恢复</td><td>私钥丢失、批量操作</td><td>✅ MetaMask/Coinbase已支持</td></tr><tr><td><strong>ERC-1271</strong></td><td>Contract Signature</td><td>合约钱包签名验证</td><td>Gnosis Safe交互</td><td>✅ 多签/智能钱包基石</td></tr><tr><td><strong>ERC-5267</strong></td><td>EIP-712 Discovery</td><td>链上发现类型定义</td><td>钱包自动解析签名</td><td>🔥 2025年钱包集成中</td></tr></tbody></table>
<h4 data-id="heading-8">6. <strong>跨链与互操作标准</strong></h4>


























<table><thead><tr><th>标准</th><th>名称</th><th>核心功能</th><th>代表项目</th><th>状态</th></tr></thead><tbody><tr><td><strong>ERC-7765</strong></td><td>Omnichain FT</td><td>原生跨链FT（无桥）</td><td>LayerZero Omni代币</td><td>🔥 2025跨链新标准</td></tr><tr><td><strong>ERC-7651</strong></td><td>Omnichain NFT</td><td>原生跨链NFT</td><td>全链游戏资产</td><td>🔥 全链游戏必备</td></tr></tbody></table>
<h4 data-id="heading-9">7. <strong>版税与元数据标准</strong></h4>

































<table><thead><tr><th>标准</th><th>名称</th><th>核心功能</th><th>应用场景</th><th>备注</th></tr></thead><tbody><tr><td><strong>ERC-2981</strong></td><td>Royalty Standard</td><td>版税信息链上标准化</td><td>NFT市场跨平台版税</td><td>⚠️ 强制执行仍依赖市场</td></tr><tr><td><strong>ERC-4883</strong></td><td>SVG NFT</td><td>可组合SVG格式</td><td>链上游戏、动态艺术</td><td>🔥 节省Gas，完全链上</td></tr><tr><td><strong>ERC-1948</strong></td><td>Dynamic Data NFT</td><td>32字节数据字段可更新</td><td>可进化NFT</td><td>⚠️ 使用较少</td></tr></tbody></table>
<h4 data-id="heading-10">8. <strong>新兴标准</strong></h4>








































<table><thead><tr><th>标准</th><th>名称</th><th>创新点</th><th>赛道</th><th>成熟度</th></tr></thead><tbody><tr><td><strong>ERC-7007</strong></td><td>AI-NFT</td><td>绑定AI模型与生成证明</td><td>AIGC</td><td>🔬 实验阶段</td></tr><tr><td><strong>ERC-721C</strong></td><td>Creator Token</td><td>可编程版税率（不限2.5%）</td><td>创作者经济</td><td>🔥 开始普及</td></tr><tr><td><strong>ERC-7512</strong></td><td>Onchain Audit</td><td>链上存储审计报告</td><td>安全</td><td>🔬 审计标准化</td></tr><tr><td><strong>ERC-7231</strong></td><td>Identity Aggregator</td><td>多链身份聚合</td><td>AI代理身份</td><td>🔬 早期采用</td></tr></tbody></table>
<h2 data-id="heading-11"><strong>快速选择决策表</strong></h2>





















































<table><thead><tr><th>你的需求</th><th>第一选择</th><th>备选方案</th><th>避免使用</th></tr></thead><tbody><tr><td>发治理代币</td><td>ERC-20 + ERC-2612</td><td>纯ERC-20</td><td>ERC-721（用错标准）</td></tr><tr><td>发NFT项目</td><td>ERC-721A</td><td>ERC-721</td><td>ERC-1155（除非GameFi）</td></tr><tr><td>做GameFi</td><td>ERC-1155</td><td>ERC-721A</td><td>ERC-20（不可替代）</td></tr><tr><td>建收益池</td><td>ERC-4626</td><td>自定义金库</td><td>手动分发收益</td></tr><tr><td>发RWA资产</td><td>ERC-3643</td><td>无</td><td>ERC-20（不合规）</td></tr><tr><td>智能钱包</td><td>ERC-4337</td><td>无</td><td>EOA钱包（体验差）</td></tr><tr><td>跨链资产</td><td>ERC-7765</td><td>ERC-7651</td><td>原生桥（风险高）</td></tr></tbody></table>
<h2 data-id="heading-12"><strong>选型建议</strong></h2>
<ul>
<li><strong>新项目必须集成ERC-2612：告别无限授权，提升用户体验</strong></li>
<li><strong>DeFi项目必须采用ERC-4626：降低外部集成成本，自动获得聚合器支持</strong></li>
<li><strong>RWA项目必选ERC-3643：香港、新加坡监管明确要求</strong></li>
<li><strong>钱包必须支持ERC-4337：提供社交恢复和gas代付，否则用户流失</strong></li>
<li><strong>跨链项目关注ERC-7765：原生跨链比桥接安全10倍以上</strong></li>
</ul>
<h2 data-id="heading-13">总结</h2>
<p>ERC-20/721是"过去"，ERC-4626/3643/4337是"现在"，ERC-7765/7007/7512是"未来"。2025年开发新项目，合规性（RWA用3643）、用户体验（钱包用4337）、性能（扩容用ZK）三者缺一不可。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习笔记:异常，泛型，集合（代码示例，企业面试题，企业实际应用场景）]]></title>    <link>https://juejin.cn/post/7581004702945214491</link>    <guid>https://juejin.cn/post/7581004702945214491</guid>    <pubDate>2025-12-08T04:04:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581004702945214491" data-draft-id="7581004702945181723" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习笔记:异常，泛型，集合（代码示例，企业面试题，企业实际应用场景）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-08T04:04:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sin60"/> <meta itemprop="url" content="https://juejin.cn/user/1576027017202505"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习笔记:异常，泛型，集合（代码示例，企业面试题，企业实际应用场景）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1576027017202505/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sin60
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T04:04:45.000Z" title="Mon Dec 08 2025 04:04:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、异常（Exception）</h3>
<p>异常是 Java 处理程序运行时错误的核心机制，企业开发中要求精准捕获、合理抛出、规范处理，避免程序崩溃或隐藏问题。</p>
<h4 data-id="heading-1">1. 核心代码示例（分类处理 + 自定义异常）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.FileInputStream;
<span class="hljs-keyword">import</span> java.io.FileNotFoundException;
<span class="hljs-keyword">import</span> java.io.IOException;

<span class="hljs-comment">/**
 * 异常核心示例：
 * 1. 编译时异常（检查型）处理（try-catch/throws）
 * 2. 运行时异常（非检查型）处理
 * 3. 自定义业务异常
 */</span>
<span class="hljs-comment">// 自定义业务异常（企业中用于标识特定业务错误）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
    <span class="hljs-comment">// 带错误信息的构造方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(message);
    }
    <span class="hljs-comment">// 带错误信息+根因的构造方法（便于排查问题）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(String message, Throwable cause)</span> {
        <span class="hljs-built_in">super</span>(message, cause);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionDemo</span> {
    <span class="hljs-comment">// 读取文件（抛出编译时异常，由调用方处理）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readFile</span><span class="hljs-params">(String path)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">if</span> (path == <span class="hljs-literal">null</span> || !path.endsWith(<span class="hljs-string">".txt"</span>)) {
            <span class="hljs-comment">// 抛出运行时异常（参数非法）</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"文件路径非法，必须是txt文件"</span>);
        }
        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(path);
        fis.close();
    }

    <span class="hljs-comment">// 处理业务逻辑（封装底层异常为业务异常）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doBusiness</span><span class="hljs-params">(String filePath)</span> {
        <span class="hljs-keyword">try</span> {
            readFile(filePath);
            System.out.println(<span class="hljs-string">"文件读取成功，业务处理完成"</span>);
        } <span class="hljs-keyword">catch</span> (IllegalArgumentException e) {
            <span class="hljs-comment">// 捕获参数异常，包装为业务异常抛出（统一异常类型）</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"业务处理失败：参数错误"</span>, e);
        } <span class="hljs-keyword">catch</span> (FileNotFoundException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"业务处理失败：文件不存在"</span>, e);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"业务处理失败：文件读取异常"</span>, e);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 测试异常处理</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 测试1：参数错误（运行时异常）</span>
            <span class="hljs-comment">// doBusiness("test.doc");</span>
            <span class="hljs-comment">// 测试2：文件不存在（编译时异常）</span>
            doBusiness(<span class="hljs-string">"none.txt"</span>);
        } <span class="hljs-keyword">catch</span> (BusinessException e) {
            <span class="hljs-comment">// 统一捕获业务异常，打印错误信息和根因</span>
            System.err.println(<span class="hljs-string">"错误信息："</span> + e.getMessage());
            <span class="hljs-comment">// 打印异常栈（排查问题用）</span>
            e.printStackTrace();
        }
    }
}
</code></pre>
<p><strong>代码说明</strong>：</p>
<ul>
<li><strong>异常分类</strong>：编译时异常（<code>IOException</code>/<code>FileNotFoundException</code>）必须显式处理（try-catch/throws）；运行时异常（<code>IllegalArgumentException</code>/<code>NullPointerException</code>）可不用显式处理，但企业中建议主动捕获。</li>
<li><strong>自定义异常</strong>：企业中会为不同业务场景定义专属异常（如<code>UserNotFoundException</code>、<code>OrderException</code>），便于统一异常处理和前端错误提示。</li>
<li><strong>异常包装</strong>：底层异常（如 IO 异常）包装为业务异常抛出，避免上层感知底层实现细节，符合 “面向业务编程” 思想。</li>
</ul>
<h4 data-id="heading-2">2. 企业面试题</h4>
<ol>
<li>
<p>问：编译时异常和运行时异常的区别？企业中如何处理？答：</p>
<ul>
<li>编译时异常（Checked Exception）：继承<code>Exception</code>（非 RuntimeException），编译期强制处理（try-catch/throws），如<code>IOException</code>、<code>SQLException</code>；</li>
<li>运行时异常（Unchecked Exception）：继承<code>RuntimeException</code>，编译期不强制处理，如<code>NullPointerException</code>、<code>IndexOutOfBoundsException</code>；</li>
<li>企业处理原则：编译时异常要么捕获处理，要么抛给上层并说明文档；运行时异常优先预防（如判空），关键节点主动捕获，避免程序崩溃。</li>
</ul>
</li>
<li>
<p>问：try-catch-finally 中，finally 一定会执行吗？return 在 finally 前执行会怎样？答：finally<strong>几乎</strong>一定会执行，除非 JVM 退出（如<code>System.exit(0)</code>）；若 try/catch 中有 return，会先执行 return 的表达式计算，再执行 finally，最后返回（若 finally 中有 return，会覆盖原 return 值，企业中禁止这么做）。</p>
</li>
<li>
<p>问：throw 和 throws 的区别？答：<code>throw</code>是语句，手动抛出具体异常对象（如<code>throw new BusinessException("错误")</code>）；<code>throws</code>是方法声明，声明该方法可能抛出的异常类型，告知调用方需要处理。</p>
</li>
<li>
<p>问：企业中为什么要自定义异常？答：统一异常类型，便于全局异常处理（如 Spring 的<code>@ControllerAdvice</code>）；区分不同业务错误场景，方便定位问题；可携带业务错误码 / 信息，适配前端错误提示。</p>
</li>
</ol>
<h4 data-id="heading-3">3. 企业实际应用场景</h4>
<ol>
<li><strong>全局异常处理</strong>：Spring Boot 项目中用<code>@ControllerAdvice</code>+<code>@ExceptionHandler</code>统一捕获所有异常，返回标准化错误响应（错误码 + 错误信息）。</li>
<li><strong>业务流程校验</strong>：下单时若库存不足，抛出<code>StockInsufficientException</code>；登录时若用户名密码错误，抛出<code>AuthFailedException</code>。</li>
<li><strong>资源操作容错</strong>：数据库操作（<code>SQLException</code>）、文件操作（<code>IOException</code>）捕获后，记录日志并转换为业务异常，避免暴露底层敏感信息。</li>
<li><strong>参数校验</strong>：接口入参校验失败时，抛出<code>IllegalArgumentException</code>或自定义<code>ParamValidException</code>，配合校验框架（如 Hibernate Validator）使用。</li>
</ol>
<h3 data-id="heading-4">二、泛型（Generic）</h3>
<p>泛型是 JDK 5 + 特性，核心作用是 “类型参数化”，避免类型强转，提升代码复用性和类型安全性，是集合、框架的基础。</p>
<h4 data-id="heading-5">1. 核心代码示例（泛型类 / 方法 / 接口 + 通配符）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">ArrayList</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">List</span>;

<span class="hljs-comment">/**
 * 泛型核心示例：
 * 1. 泛型类
 * 2. 泛型方法
 * 3. 泛型接口
 * 4. 泛型通配符（? extends/super）
 */</span>
<span class="hljs-comment">// 1. 泛型类：通用数据包装类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataWrapper</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> T data;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">DataWrapper</span>(T data) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = data;
    }

    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getData</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> data;
    }

    <span class="hljs-comment">// 泛型方法：独立于类的泛型</span>
    <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-built_in">void</span> <span class="hljs-title function_">printData</span>(<span class="hljs-params">E extraData</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"核心数据："</span> + data + <span class="hljs-string">"，额外数据："</span> + extraData);
    }
}

<span class="hljs-comment">// 2. 泛型接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Converter</span>&lt;F, T&gt; {
    T <span class="hljs-title function_">convert</span>(F <span class="hljs-keyword">from</span>);
}

<span class="hljs-comment">// 泛型接口实现：String转Integer</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StringToIntConverter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Converter</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Integer</span>&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Integer</span> <span class="hljs-title function_">convert</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> <span class="hljs-keyword">from</span></span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Integer</span>.<span class="hljs-built_in">parseInt</span>(<span class="hljs-keyword">from</span>);
    }
}

<span class="hljs-comment">// 3. 泛型通配符示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericUtil</span> {
    <span class="hljs-comment">// 上界通配符：只能读取，不能添加（除了null）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">printList</span>(<span class="hljs-params">List&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-built_in">Number</span>&gt; list</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">Number</span> num : list) {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">print</span>(num + <span class="hljs-string">" "</span>);
        }
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>();
        <span class="hljs-comment">// list.add(10); // 编译错误：无法确定具体类型</span>
    }

    <span class="hljs-comment">// 下界通配符：只能添加，读取时只能转Object</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addIntToList</span>(<span class="hljs-params">List&lt;? <span class="hljs-variable language_">super</span> Integer&gt; list</span>) {
        list.<span class="hljs-title function_">add</span>(<span class="hljs-number">10</span>);
        list.<span class="hljs-title function_">add</span>(<span class="hljs-number">20</span>);
        <span class="hljs-comment">// Integer num = list.get(0); // 编译错误：只能转Object</span>
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// 泛型类使用</span>
        <span class="hljs-title class_">DataWrapper</span>&lt;<span class="hljs-title class_">String</span>&gt; strWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataWrapper</span>&lt;&gt;(<span class="hljs-string">"黑马程序员"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(strWrapper.<span class="hljs-title function_">getData</span>()); <span class="hljs-comment">// 无需强转</span>
        strWrapper.<span class="hljs-title function_">printData</span>(<span class="hljs-number">123</span>); <span class="hljs-comment">// 泛型方法：E自动推断为Integer</span>

        <span class="hljs-comment">// 泛型接口使用</span>
        <span class="hljs-title class_">Converter</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Integer</span>&gt; converter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringToIntConverter</span>();
        <span class="hljs-title class_">Integer</span> num = converter.<span class="hljs-title function_">convert</span>(<span class="hljs-string">"100"</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"字符串转数字："</span> + num);

        <span class="hljs-comment">// 泛型通配符使用</span>
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Integer</span>&gt; intList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        intList.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>);
        intList.<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>);
        <span class="hljs-title class_">GenericUtil</span>.<span class="hljs-title function_">printList</span>(intList); <span class="hljs-comment">// 上界通配符：Number的子类都可传入</span>

        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Object</span>&gt; objList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-title class_">GenericUtil</span>.<span class="hljs-title function_">addIntToList</span>(objList); <span class="hljs-comment">// 下界通配符：Integer的父类都可传入</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"添加后列表："</span> + objList);
    }
}
</code></pre>
<p><strong>代码说明</strong>：</p>
<ul>
<li>
<p><strong>泛型类</strong>：<code>DataWrapper&lt;T&gt;</code> 可包装任意类型数据，避免为 String/Integer 等分别写包装类，提升复用性。</p>
</li>
<li>
<p><strong>泛型方法</strong>：<code>&lt;E&gt; void printData(E extraData)</code> 独立于类的泛型，调用时自动推断类型，灵活度更高。</p>
</li>
<li>
<p><strong>通配符</strong>：</p>
<ul>
<li><code>? extends Number</code>（上界）：只能读取，适合 “生产者” 场景（如遍历输出）；</li>
<li><code>? super Integer</code>（下界）：只能添加，适合 “消费者” 场景（如添加元素）。</li>
</ul>
</li>
<li>
<p><strong>类型安全</strong>：泛型在编译期检查类型，避免运行时<code>ClassCastException</code>（如集合中存 String 却取 Integer）。</p>
</li>
</ul>
<h4 data-id="heading-6">2. 企业面试题</h4>
<ol>
<li>
<p>问：泛型的作用？为什么要使用泛型？答：</p>
<ul>
<li>类型安全：编译期检查类型，避免运行时类型转换异常；</li>
<li>代码复用：一套代码适配多种类型（如 List/List）；</li>
<li>消除强制类型转换：提升代码可读性和简洁性。</li>
</ul>
</li>
<li>
<p>问：泛型擦除是什么？运行时能获取泛型类型吗？答：泛型擦除是 JVM 的机制：编译期保留泛型检查，运行时泛型信息被擦除（如<code>List&lt;String&gt;</code>变为<code>List</code>）；默认无法获取，但可通过反射（如<code>ParameterizedType</code>）获取泛型类型（企业中框架常用，如 MyBatis）。</p>
</li>
<li>
<p>问：泛型通配符<code>?</code>、<code>? extends T</code>、<code>? super T</code>的区别？答：</p>
<ul>
<li><code>?</code>：无界通配符，可接收任意类型，只能读取（转 Object），不能添加；</li>
<li><code>? extends T</code>：上界通配符，只能接收 T 或 T 的子类，适合读取；</li>
<li><code>? super T</code>：下界通配符，只能接收 T 或 T 的父类，适合添加。</li>
</ul>
</li>
<li>
<p>问：泛型类和泛型方法的区别？答：泛型类的泛型参数在类级别，所有方法共享；泛型方法的泛型参数在方法级别，独立于类，可在非泛型类中定义，调用时更灵活。</p>
</li>
</ol>
<h4 data-id="heading-7">3. 企业实际应用场景</h4>
<ol>
<li><strong>集合框架</strong>：Java 集合（List/Map/Set）全部基于泛型，如<code>Map&lt;String, User&gt;</code>、<code>List&lt;Order&gt;</code>，避免类型混乱。</li>
<li><strong>通用工具类</strong>：企业封装通用工具（如缓存工具、转换工具），用泛型适配多种类型，如<code>CacheUtil&lt;K, V&gt;</code>、<code>ConvertUtil&lt;F, T&gt;</code>。</li>
<li><strong>框架开发</strong>：Spring/MyBatis 等框架大量使用泛型，如<code>Mapper&lt;User&gt;</code>、<code>RestTemplate.getForObject(String url, Class&lt;T&gt; responseType)</code>。</li>
<li><strong>自定义容器</strong>：业务中封装分页结果<code>PageResult&lt;T&gt;</code>，适配用户列表、订单列表等不同分页场景。</li>
</ol>
<h3 data-id="heading-8">三、集合（Collection）</h3>
<p>集合是 Java 存储和操作一组数据的容器，企业中 90% 以上的业务都会用到，核心分为<code>Collection</code>（单列）和<code>Map</code>（双列）两大体系。</p>
<h4 data-id="heading-9">1. 核心代码示例（常用集合 + 核心操作）</h4>
<pre><code class="hljs language-csharp" lang="csharp">import java.util.*;

<span class="hljs-comment">/**
 * 集合核心示例：
 * 1. List（ArrayList/LinkedList）
 * 2. Set（HashSet/TreeSet）
 * 3. Map（HashMap/TreeMap）
 * 4. 集合遍历/排序/筛选
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CollectionDemo</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-comment">// 1. List：有序、可重复、索引访问</span>
        List&lt;String&gt; arrayList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        arrayList.<span class="hljs-keyword">add</span>(<span class="hljs-string">"Java"</span>);
        arrayList.<span class="hljs-keyword">add</span>(<span class="hljs-string">"Python"</span>);
        arrayList.<span class="hljs-keyword">add</span>(<span class="hljs-string">"Java"</span>); <span class="hljs-comment">// 允许重复</span>
        <span class="hljs-comment">// 遍历</span>
        <span class="hljs-keyword">for</span> (String s : arrayList) {
            System.<span class="hljs-keyword">out</span>.print(s + <span class="hljs-string">" "</span>);
        }
        System.<span class="hljs-keyword">out</span>.println();
        <span class="hljs-comment">// 排序</span>
        Collections.sort(arrayList);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"排序后："</span> + arrayList);

        <span class="hljs-comment">// LinkedList：适合频繁增删（链表结构）</span>
        List&lt;Integer&gt; linkedList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();
        linkedList.addFirst(<span class="hljs-number">1</span>);
        linkedList.addLast(<span class="hljs-number">3</span>);
        linkedList.<span class="hljs-keyword">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// 索引插入</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"LinkedList："</span> + linkedList);

        <span class="hljs-comment">// 2. Set：无序、不可重复</span>
        Set&lt;String&gt; hashSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();
        hashSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"A"</span>);
        hashSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"B"</span>);
        hashSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"A"</span>); <span class="hljs-comment">// 重复元素不会添加</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"HashSet："</span> + hashSet); <span class="hljs-comment">// 无序</span>

        <span class="hljs-comment">// TreeSet：有序（自然排序/自定义排序）</span>
        Set&lt;Integer&gt; treeSet = <span class="hljs-keyword">new</span> TreeSet&lt;&gt;();
        treeSet.<span class="hljs-keyword">add</span>(<span class="hljs-number">3</span>);
        treeSet.<span class="hljs-keyword">add</span>(<span class="hljs-number">1</span>);
        treeSet.<span class="hljs-keyword">add</span>(<span class="hljs-number">2</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"TreeSet（自然排序）："</span> + treeSet); <span class="hljs-comment">// [1,2,3]</span>

        <span class="hljs-comment">// 3. Map：键值对、键唯一</span>
        Map&lt;String, Integer&gt; hashMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        hashMap.put(<span class="hljs-string">"语文"</span>, <span class="hljs-number">90</span>);
        hashMap.put(<span class="hljs-string">"数学"</span>, <span class="hljs-number">95</span>);
        hashMap.put(<span class="hljs-string">"语文"</span>, <span class="hljs-number">92</span>); <span class="hljs-comment">// 覆盖已有键</span>
        <span class="hljs-comment">// 遍历Map（企业推荐方式）</span>
        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : hashMap.entrySet()) {
            System.<span class="hljs-keyword">out</span>.println(entry.getKey() + <span class="hljs-string">"："</span> + entry.getValue());
        }
        <span class="hljs-comment">// 获取值</span>
        Integer mathScore = hashMap.getOrDefault(<span class="hljs-string">"数学"</span>, <span class="hljs-number">0</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"数学成绩："</span> + mathScore);

        <span class="hljs-comment">// TreeMap：按键排序</span>
        Map&lt;String, Integer&gt; treeMap = <span class="hljs-keyword">new</span> TreeMap&lt;&gt;(hashMap);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"TreeMap（按键排序）："</span> + treeMap);

        <span class="hljs-comment">// 4. 集合筛选（JDK 8+ Stream）</span>
        List&lt;Integer&gt; numList = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>);
        List&lt;Integer&gt; evenList = numList.stream()
                .filter(num -&gt; num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) <span class="hljs-comment">// 筛选偶数</span>
                .collect(Collectors.toList());
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"偶数列表："</span> + evenList);
    }
}
</code></pre>
<p><strong>代码说明</strong>：</p>
<ul>
<li><strong>List 选型</strong>：<code>ArrayList</code>（数组结构）适合随机访问、读多写少；<code>LinkedList</code>（链表结构）适合频繁增删（如队列 / 栈）。</li>
<li><strong>Set 选型</strong>：<code>HashSet</code>（哈希表）查询快（O (1)），无序；<code>TreeSet</code>（红黑树）有序，查询 O (logn)。</li>
<li><strong>Map 选型</strong>：<code>HashMap</code>（哈希表）企业首选，查询 / 插入快；<code>TreeMap</code>按键排序，适合需要有序的场景。</li>
<li><strong>Stream 流</strong>：JDK 8 + 特性，企业中替代传统循环，实现集合的筛选、映射、聚合，代码更简洁。</li>
</ul>
<h4 data-id="heading-10">2. 企业面试题</h4>
<ol>
<li>
<p>问：ArrayList 和 LinkedList 的区别？企业中如何选择？答：</p>
<ul>
<li>底层结构：ArrayList 是动态数组，LinkedList 是双向链表；</li>
<li>访问效率：ArrayList 随机访问快（O (1)），LinkedList 慢（O (n)）；</li>
<li>增删效率：ArrayList 尾部增删快，中间增删慢（需移动元素）；LinkedList 任意位置增删快（O (1)）；</li>
<li>内存：ArrayList 有扩容冗余，LinkedList 每个节点存前后指针，内存占用高；</li>
<li>选型：读多写少用 ArrayList，频繁增删（如队列）用 LinkedList。</li>
</ul>
</li>
<li>
<p>问：HashMap 的底层原理？JDK 1.7 和 1.8 的区别？答：</p>
<ul>
<li>JDK 1.7：数组 + 链表，哈希冲突用链表解决，头插法（多线程下易成环）；</li>
<li>JDK 1.8：数组 + 链表 + 红黑树，链表长度≥8 且数组长度≥64 时转红黑树，尾插法，解决成环问题；</li>
<li>核心：通过 hashCode 计算索引，equals 判断键是否相同，负载因子 0.75（平衡空间和时间）。</li>
</ul>
</li>
<li>
<p>问：HashSet 和 HashMap 的关系？HashSet 如何保证元素不重复？答：HashSet 底层是 HashMap（用 HashMap 的 key 存元素，value 存固定对象）；添加元素时，先计算 hashCode，再用 equals 判断，若已存在则不添加，保证唯一性。</p>
</li>
<li>
<p>问：集合的遍历方式有哪些？哪种效率最高？答：</p>
<ul>
<li>List：普通 for（索引）、增强 for、迭代器（Iterator）、Stream；</li>
<li>Map：keySet+get、entrySet、forEach（JDK 8+）；</li>
<li>效率：ArrayList 用普通 for 最快，LinkedList 用迭代器 / 增强 for 最快；Map 用 entrySet 遍历最快（避免多次 get）。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-11">3. 企业实际应用场景</h4>
<ol>
<li><strong>数据存储</strong>：接口返回列表（如用户列表、订单列表）用<code>List</code>；去重数据（如商品标签、用户 ID）用<code>HashSet</code>；键值对数据（如用户 ID→用户信息）用<code>HashMap</code>。</li>
<li><strong>缓存实现</strong>：本地缓存（如加载字典数据）用<code>HashMap</code>，有序缓存用<code>TreeMap</code>。</li>
<li><strong>数据处理</strong>：批量数据筛选（如筛选未支付订单）、聚合（如统计各部门人数）用 Stream 流。</li>
<li><strong>并发场景</strong>：高并发下用<code>ConcurrentHashMap</code>（线程安全）替代<code>HashMap</code>，用<code>CopyOnWriteArrayList</code>替代<code>ArrayList</code>。</li>
</ol>
<h3 data-id="heading-12">总结</h3>
<ol>
<li><strong>异常</strong>：核心是区分编译时 / 运行时异常，企业中自定义业务异常 + 全局统一处理，避免程序崩溃和信息泄露。</li>
<li><strong>泛型</strong>：解决类型安全和代码复用问题，是集合、框架的基础，重点掌握泛型类 / 方法和通配符的使用。</li>
<li><strong>集合</strong>：企业开发高频使用，核心是根据业务场景选型（ArrayList/HashMap 为首选），掌握底层原理和高效遍历方式。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VSCode + Renode：打造现代化的嵌入式仿真开发环]]></title>    <link>https://juejin.cn/post/7580988382761091087</link>    <guid>https://juejin.cn/post/7580988382761091087</guid>    <pubDate>2025-12-08T04:28:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580988382761091087" data-draft-id="7580988382761009167" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VSCode + Renode：打造现代化的嵌入式仿真开发环"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-12-08T04:28:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="11cookies11"/> <meta itemprop="url" content="https://juejin.cn/user/1259367703787244"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VSCode + Renode：打造现代化的嵌入式仿真开发环
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1259367703787244/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    11cookies11
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T04:28:47.000Z" title="Mon Dec 08 2025 04:28:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在传统的嵌入式开发中，我们往往需要依赖实体开发板、仿真器（ST-Link/J-Link）、各种驱动、复杂的 IDE（如 IAR、Keil），不仅环境搭建繁琐，还会受到硬件数量、条件、测试风险的限制。</p>
<p>但随着 <strong>Renode（Antmicro）</strong> 的成熟，现在我们终于可以：</p>
<ul>
<li>使用 <strong>VSCode + GCC</strong> 做现代化的编辑体验</li>
<li>使用 <strong>Renode</strong> 模拟 **CPU + 外设 **</li>
<li>使用 <strong>GDB Server</strong> 实现调试</li>
<li>甚至可以在服务器（树莓派/OrangePi）上远程跑 Renode</li>
</ul>
<p>过去几天，我一步步搭好了从 VSCode → Renode → GDB 的完整链路，并解决了一堆坑。  这篇文章记录完整的流程、关键配置、常见错误与解决方式。</p>
<h3 data-id="heading-0">📌 一、为什么选择 Renode + VSCode？</h3>
<p>现代嵌入式开发已经从这样的方式：</p>
<p>❌ IAR + 实物板子 + 烧录器 + 串口线 + 硬件依赖  ❌ 调试断点和步进完全依赖物理板子  ❌ 一个芯片换平台就要重装一堆东西</p>
<p>逐渐走向：</p>
<p>✔ VSCode + GCC：轻量现代化开发体验  ✔ Renode：模拟 STM32/ESP32 等设备，包含 UART、SPI、I2C、GPIO、DMA  ✔ GDB Remote：跨平台、可远程调试  ✔ 自动化、可脚本化</p>
<p>这套方式在国外公司非常常见，原因是：</p>
<ul>
<li>更高的开发效率</li>
<li>测试可自动化</li>
<li>CI/CD 可跑仿真</li>
<li>对硬件依赖更低</li>
</ul>
<p>而在国内还不太普及，所以我自己实践后写下这篇文章，希望帮助更多人。</p>
<p>步骤：</p>
<ol>
<li>安装Renode</li>
<li>配置Renode(编辑Renode的脚本)</li>
<li>配置VScode(.vscode/tasks.josn/.vscode/launch.josn)</li>
<li>测试</li>
</ol>
<p>目标：</p>
<ol>
<li>实现编写代码控制renode模拟外设工作</li>
<li>可以使用vscode配合renode对代码进行仿真</li>
</ol>
<h3 data-id="heading-1">📌 二、安装 Renode</h3>
<p>Renode 提供多个版本，你只需要选一个能跑的：</p>
<p>资源下载：[Renode的github仓库](<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frenode%2Frenode" target="_blank" title="https://github.com/renode/renode" ref="nofollow noopener noreferrer">renode/renode: Renode - Antmicro’s open source simulation and virtual development framework for complex embedded systems</a>)</p>
<h3 data-id="heading-2">我的选择：</h3>
<pre><code class="hljs">renode-latest.linux-portable-dotnet.tar.gz
</code></pre>
<p>理由：</p>
<ul>
<li>自带 dotnet runtime</li>
<li>不依赖系统的 dotnet/mono</li>
<li>可在 OrangePi / Raspberry Pi 上运行</li>
</ul>
<p>解压后直接运行：</p>
<pre><code class="hljs language-bash" lang="bash">./renode
</code></pre>
<h3 data-id="heading-3">📌 三、配置Renode</h3>
<p>写一个最基础的Renode.resc文件(STM32F103)，这个Renode.resc相当于你要模拟MCU的配置表，Renode加载这个.resc，模拟出你想要的环境</p>
<p>这是我最终可运行的版本（可直接用）：</p>
<pre><code class="hljs language-bash" lang="bash">using sysbus

mach create <span class="hljs-string">"stm32f103"</span>
machine LoadPlatformDescription @platforms/cpus/stm32f103.repl

<span class="hljs-comment"># 加载固件，renode加载orangepi上.elf文件</span>
machine LoadELF @/home/orangepi/object/renode_portable/firmware.elf

<span class="hljs-comment"># 打开 UART2</span>
showAnalyzer sysbus.usart2

<span class="hljs-comment"># 开 GDB 服务（端口 3333），让vscode可以使用GDB配合renode实现可视化debug</span>
machine StartGdbServer 3333 <span class="hljs-literal">true</span>


start
</code></pre>
<p>你可以把它保存为：</p>
<pre><code class="hljs">run_stm32.resc
</code></pre>
<h3 data-id="heading-4">📌 四、VSCode 调试配置</h3>
<p>配置<strong>launch.json</strong>，这是最关键的一步。</p>
<p>直接贴可运行版本（适用于 ARM Cortex-M3 / STM32F1）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">{
    <span class="hljs-string">"version"</span>: <span class="hljs-string">"0.2.0"</span>,
    <span class="hljs-string">"configurations"</span>: [
        {
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"Debug STM32F103 on Renode Remote"</span>,
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"cppdbg"</span>,
            <span class="hljs-string">"request"</span>: <span class="hljs-string">"launch"</span>,

            <span class="hljs-string">"program"</span>: <span class="hljs-string">"<span class="hljs-subst">${workspaceFolder}</span>/build/firmware.elf"</span>,
            <span class="hljs-string">"cwd"</span>: <span class="hljs-string">"<span class="hljs-subst">${workspaceFolder}</span>"</span>,

            <span class="hljs-string">"miDebuggerPath"</span>: <span class="hljs-string">"arm-none-eabi-gdb"</span>,
            <span class="hljs-string">"miDebuggerServerAddress"</span>: <span class="hljs-string">"xxx.xxx.xxx.xxx:3333"</span>,

            <span class="hljs-string">"preLaunchTask"</span>: <span class="hljs-string">"Run Renode Remote"</span>,

            <span class="hljs-string">"stopAtEntry"</span>: <span class="hljs-literal">true</span>,

            <span class="hljs-string">"setupCommands"</span>: [
                { <span class="hljs-string">"text"</span>: <span class="hljs-string">"set pagination off"</span> },
                { <span class="hljs-string">"text"</span>: <span class="hljs-string">"set confirm off"</span> },
                { <span class="hljs-string">"text"</span>: <span class="hljs-string">"set print pretty on"</span> }
            ],

            <span class="hljs-comment">/* On restart: pause, reload ELF, reset CPU (mimic your manual sequence) */</span>
            <span class="hljs-string">"postRemoteConnectCommands"</span>: [
                { <span class="hljs-string">"text"</span>: <span class="hljs-string">"monitor machine Pause"</span> },
                { <span class="hljs-string">"text"</span>: <span class="hljs-string">"monitor sysbus LoadELF @/home/orangepi/object/renode_portable/firmware.elf"</span> },
                { <span class="hljs-string">"text"</span>: <span class="hljs-string">"monitor cpu Reset"</span> }
            ],

            <span class="hljs-string">"externalConsole"</span>: <span class="hljs-literal">false</span>,

            <span class="hljs-string">"targetArchitecture"</span>: <span class="hljs-string">"arm"</span>
        }
    ]
}
</code></pre>
<p>核心点：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"miDebuggerPath"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"arm-none-eabi-gdb"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"miDebuggerServerAddress"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"xxx.xxx.xxx.xxx:3333"</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>解释：</p>
<ul>
<li>miDebuggerPath：本机要使用的 GDB（你电脑上安装的）</li>
<li>miDebuggerServerAddress：远端 Renode 的 GDB server 监听地址</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"preLaunchTask"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Run Renode Remote"</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>VSCode 会先执行名称为 "Run Renode Remote" 的任务（在 tasks.json 里）。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"postRemoteConnectCommands"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"monitor machine Pause"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"monitor sysbus LoadELF @/home/orangepi/object/renode_portable/firmware.elf"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"monitor cpu Reset"</span> <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>这是整个调试流程的灵魂。</p>
<p>逐句解释：</p>
<h3 data-id="heading-5">① 暂停仿真</h3>
<pre><code class="hljs language-css" lang="css">monitor machine <span class="hljs-attribute">Pause</span>
</code></pre>
<p>防止 Renode 继续运行旧固件。</p>
<h3 data-id="heading-6">② 在 Renode 内重新加载 ELF</h3>
<pre><code class="hljs language-arduino" lang="arduino">monitor sysbus LoadELF @/home/orangepi/object/renode_portable/firmware.elf
</code></pre>
<p>原因：</p>
<ul>
<li>VSCode 每次 build 完成本地有一个 ${workspaceFolder}/build/firmware.elf</li>
<li>但是远程服务器上的 ELF 通常在另一个目录，比如 /home/orangepi/object/...</li>
<li>重新加载 ELF 可以让 Renode 与最新符号一致</li>
</ul>
<p>这是 <strong>“本地 build → scp → 远端自动加载”</strong> 的机制。</p>
<h3 data-id="heading-7">③ 重置 CPU（类似 reset halt）</h3>
<pre><code class="hljs">monitor cpu Reset
</code></pre>
<p>相当于：</p>
<ul>
<li>程序从头开始运行</li>
<li>下一步 VSCode 会停在 main()</li>
</ul>
<p>这个序列相当于模拟 FreeRTOS 中的 debug reset。</p>
<p><strong>Tasks.json配置</strong></p>
<p>出了launch.json,还有tasks.json需要配置，配置如下：</p>
<pre><code class="hljs language-perl" lang="perl">{
    <span class="hljs-string">"version"</span>: <span class="hljs-string">"2.0.0"</span>,
    <span class="hljs-string">"tasks"</span>: [

        <span class="hljs-regexp">/* === 1. CMake Configure === */</span>
        {
            <span class="hljs-string">"label"</span>: <span class="hljs-string">"CMake Configure"</span>,
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"shell"</span>,
            <span class="hljs-string">"command"</span>: <span class="hljs-string">"cmake"</span>,
            <span class="hljs-string">"args"</span>: [
                <span class="hljs-string">"-S"</span>, <span class="hljs-string">"<span class="hljs-subst">${workspaceFolder}</span>"</span>,
                <span class="hljs-string">"-B"</span>, <span class="hljs-string">"<span class="hljs-subst">${workspaceFolder}</span>/build"</span>,
                <span class="hljs-string">"-DCMAKE_BUILD_TYPE=Debug"</span>
            ],
            <span class="hljs-string">"problemMatcher"</span>: [<span class="hljs-string">"$gcc"</span>]
        },

        <span class="hljs-regexp">/* === 2. CMake Build === */</span>
        {
            <span class="hljs-string">"label"</span>: <span class="hljs-string">"CMake Build"</span>,
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"shell"</span>,
            <span class="hljs-string">"command"</span>: <span class="hljs-string">"cmake"</span>,
            <span class="hljs-string">"args"</span>: [
                <span class="hljs-string">"--build"</span>, <span class="hljs-string">"<span class="hljs-subst">${workspaceFolder}</span>/build"</span>,
                <span class="hljs-string">"--config"</span>, <span class="hljs-string">"Debug"</span>
            ],
            <span class="hljs-string">"dependsOn"</span>: [<span class="hljs-string">"CMake Configure"</span>],
            <span class="hljs-string">"problemMatcher"</span>: [<span class="hljs-string">"$gcc"</span>]
        },

        <span class="hljs-regexp">/* === 3. 上传 ELF === */</span>
        {
            <span class="hljs-string">"label"</span>: <span class="hljs-string">"Upload ELF"</span>,
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"shell"</span>,
            <span class="hljs-string">"command"</span>: <span class="hljs-string">"scp"</span>,
            <span class="hljs-string">"args"</span>: [
                <span class="hljs-string">"<span class="hljs-subst">${workspaceFolder}</span>/build/firmware.elf"</span>,
                <span class="hljs-string">"root@192.168.31.135:/home/orangepi/object/renode_portable/"</span>
            ],
            <span class="hljs-string">"dependsOn"</span>: [<span class="hljs-string">"CMake Build"</span>],
            <span class="hljs-string">"problemMatcher"</span>: []
        },

        <span class="hljs-regexp">/* === 4. 上传 RESC === */</span>
        {
            <span class="hljs-string">"label"</span>: <span class="hljs-string">"Upload RESC"</span>,
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"shell"</span>,
            <span class="hljs-string">"command"</span>: <span class="hljs-string">"scp"</span>,
            <span class="hljs-string">"args"</span>: [
                <span class="hljs-string">"<span class="hljs-subst">${workspaceFolder}</span>/renode/platform.resc"</span>,
                <span class="hljs-string">"root@xxx.xxx.xxx.xxx:/home/orangepi/object/renode_portable/"</span>
            ],
            <span class="hljs-string">"problemMatcher"</span>: []
        },

        <span class="hljs-regexp">/* === 5. 关闭旧 Renode 实例 === */</span>
        {
            <span class="hljs-string">"label"</span>: <span class="hljs-string">"Close Renode Remote"</span>,
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"shell"</span>,
            <span class="hljs-string">"command"</span>: <span class="hljs-string">"ssh"</span>,
            <span class="hljs-string">"args"</span>: [
                <span class="hljs-string">"root@xxx.xxx.xxx.xxx"</span>,
                <span class="hljs-string">"pkill renode || true"</span>
            ],
            <span class="hljs-string">"problemMatcher"</span>: []
        },

        <span class="hljs-regexp">/* === 6. 启动 Renode Remote（后台任务） === */</span>
        {
            <span class="hljs-string">"label"</span>: <span class="hljs-string">"Run Renode Remote"</span>,
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"shell"</span>,
            <span class="hljs-string">"command"</span>: <span class="hljs-string">"ssh"</span>,
            <span class="hljs-string">"args"</span>: [
                <span class="hljs-string">"root@xxx.xxx.xxx.xxx"</span>,
                <span class="hljs-string">"/home/orangepi/object/renode_portable/renode /home/orangepi/object/renode_portable/platform.resc"</span>
            ],
            <span class="hljs-string">"dependsOn"</span>: [
                <span class="hljs-string">"Upload ELF"</span>,
                <span class="hljs-string">"Upload RESC"</span>,
                <span class="hljs-string">"Close Renode Remote"</span>
            ],
            <span class="hljs-string">"isBackground"</span>: true,

            <span class="hljs-string">"problemMatcher"</span>: {
                <span class="hljs-string">"owner"</span>: <span class="hljs-string">"Renode"</span>,
                <span class="hljs-string">"pattern"</span>: [
                    {
                        <span class="hljs-string">"regexp"</span>: <span class="hljs-string">"^(?!.*)"</span>,
                        <span class="hljs-string">"file"</span>: <span class="hljs-number">0</span>,
                        <span class="hljs-string">"line"</span>: <span class="hljs-number">0</span>,
                        <span class="hljs-string">"message"</span>: <span class="hljs-number">0</span>
                    }
                ],
                <span class="hljs-string">"background"</span>: {
                    <span class="hljs-string">"activeOnStart"</span>: true,
                    <span class="hljs-string">"beginsPattern"</span>: <span class="hljs-string">"Renode, version .*"</span>,
                    <span class="hljs-string">"endsPattern"</span>: <span class="hljs-string">".*Loaded SVD.*"</span>
                }
            }
        }
    ]
}
</code></pre>
<h3 data-id="heading-8">测试</h3>
<p>使用vscode的一键debug，可以看到vscode正常和renode通讯，打断点和uart输出正常：</p>
<p><img src="https://pic1.zhimg.com/80/v2-5ed35b98986b2aeac89fe8df5644a40e_720w.png?source=ccfced1a" alt="img" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1、Elasticsearch快照迁移]]></title>    <link>https://juejin.cn/post/7580988382761025551</link>    <guid>https://juejin.cn/post/7580988382761025551</guid>    <pubDate>2025-12-08T04:16:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580988382761025551" data-draft-id="7580809247736250408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1、Elasticsearch快照迁移"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-08T04:16:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三姓码农张员外"/> <meta itemprop="url" content="https://juejin.cn/user/3808364008836999"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1、Elasticsearch快照迁移
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364008836999/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三姓码农张员外
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T04:16:11.000Z" title="Mon Dec 08 2025 04:16:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景说明</h2>
<p>1、源端是AWS、目标端是阿里云<br/>
2、最后个割接环境，客户能接受停机迁移<br/>
3、源端数据量比较大，大概3T</p>
<h2 data-id="heading-1">官方迁移文档</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fes%2Fuse-cases%2Fselect-a-data-migration-solution%3Fspm%3Da2c4g.11186623.help-menu-57736.d_3_1_0.416b7c67ry8Q4z%26scm%3D20140722.H_170095._.OR_help-T_cn~zh-V_1" target="_blank" title="https://help.aliyun.com/zh/es/use-cases/select-a-data-migration-solution?spm=a2c4g.11186623.help-menu-57736.d_3_1_0.416b7c67ry8Q4z&amp;scm=20140722.H_170095._.OR_help-T_cn~zh-V_1" ref="nofollow noopener noreferrer">Elasticsearch迁移方案选取指南_检索分析服务 Elasticsearch版(ES)-阿里云帮助中心</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fes%2Fuse-cases%2Fmigrate-elasticsearch-index-data-from-amazon-opensearch-service-to-alibaba-cloud-elasticsearch%23section-vsd-f3p-fhb" target="_blank" title="https://help.aliyun.com/zh/es/use-cases/migrate-elasticsearch-index-data-from-amazon-opensearch-service-to-alibaba-cloud-elasticsearch#section-vsd-f3p-fhb" ref="nofollow noopener noreferrer">将AWS中的ES数据迁移到阿里云ES中_检索分析服务 Elasticsearch版(ES)-阿里云帮助中心</a></p>
<h2 data-id="heading-2">ES迁移整体流程</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca8f596a36814096af5217cd6edee404~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5aeT56CB5Yac5byg5ZGY5aSW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765772513&amp;x-signature=ymPTIJ0vCZz65cXL1SJaJ1f5x%2Fg%3D" alt="ES快照迁移问题.png" loading="lazy"/></p>
<h2 data-id="heading-3">优化目标端ES配置项</h2>
<p>修改下面的配置可以有效加速快照恢复的速度。</p>
<h4 data-id="heading-4">增加恢复带宽</h4>
<pre><code class="hljs language-bash" lang="bash">PUT /_cluster/settings
{
    <span class="hljs-string">"transient"</span>: {
        <span class="hljs-string">"indices.recovery.max_bytes_per_sec"</span>: <span class="hljs-string">"300mb"</span>
    }
}
GET /_cluster/settings?include_defaults=<span class="hljs-literal">true</span>&amp;flat_settings=<span class="hljs-literal">true</span>
</code></pre>
<p>1、限制恢复带宽: 将 indices.recovery.max_bytes_per_sec 参数设置为 300mb（默认是40mb）</p>
<p>2、临时生效: 使用 transient 配置，重启后失效</p>
<p>3、影响范围: 控制分片恢复、重新平衡等操作的网络传输速度</p>
<h4 data-id="heading-5">调整集群分片分配并发度: 配置 Elasticsearch 集群中分片恢复和分配的并发数量</h4>
<p>默认值是4</p>
<pre><code class="hljs language-bash" lang="bash">PUT _cluster/settings
{
  <span class="hljs-string">"persistent"</span>: {
    <span class="hljs-string">"cluster.routing.allocation.node_concurrent_recoveries"</span> : <span class="hljs-string">"16"</span>,
    <span class="hljs-string">"cluster.routing.allocation.node_initial_primaries_recoveries"</span> : <span class="hljs-string">"16"</span>
  }
}
</code></pre>
<p>cluster.routing.allocation.node_concurrent_recoveries:</p>
<ul>
<li>设置每个节点上同时进行的分片恢复操作数量为 16</li>
<li>影响集群重新平衡、节点重启后的数据恢复速度</li>
</ul>
<p>cluster.routing.allocation.node_initial_primaries_recoveries:</p>
<ul>
<li>设置每个节点上同时进行的主分片初始恢复操作数量为 16</li>
<li>主要影响新索引创建或集群启动时的主分片分配速度</li>
</ul>
<p>配置特点</p>
<ul>
<li>持久化设置: 使用 persistent 配置，重启后仍然有效</li>
<li>性能优化: 增加并发度可以加快集群恢复和重新平衡速度</li>
<li>资源管理: 需要根据节点硬件资源合理设置，避免过度消耗系统资源</li>
</ul>
<p>适用场景</p>
<ul>
<li>集群扩容或缩容时加速分片重新分配</li>
<li>节点维护后快速恢复服务</li>
<li>大规模数据迁移时提高效率</li>
</ul>
<h2 data-id="heading-6">总结的迁移步骤</h2>
<h4 data-id="heading-7">第一次快照恢复动作</h4>
<p>1、在AWS上的es创建快照并上传到S3</p>
<pre><code class="hljs language-bash" lang="bash">GET _snapshot
<span class="hljs-comment"># 创建仓库</span>
PUT _snapshot/ali_backup
{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"s3"</span>,
  <span class="hljs-string">"settings"</span>: {
    <span class="hljs-string">"bucket"</span>: <span class="hljs-string">"AWS云S3桶名称"</span>,
    <span class="hljs-string">"base_path"</span>: <span class="hljs-string">"桶下面的路径"</span>,
    <span class="hljs-string">"region"</span>: <span class="hljs-string">"cn-north-1"</span>,
    <span class="hljs-string">"endpoint"</span>: <span class="hljs-string">"s3.cn-north-1.amazonaws.com.cn"</span>
  }
}
<span class="hljs-comment"># 第一个版本快照</span>
PUT _snapshot/ali_backup/prd_01
{
  <span class="hljs-string">"indices"</span>: <span class="hljs-string">"*"</span>,
  <span class="hljs-string">"ignore_unavailable"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"include_global_state"</span>: <span class="hljs-literal">false</span>
}
<span class="hljs-comment"># 查看快照进度</span>
GET _cat/snapshots/ali_backup?v
</code></pre>
<p>2、启动S3到oss的数据同步任务：经过上面的步骤AWS的es数据已经同步到S3，配置数据同步将S3数据同步到阿里云OSS并观察数据同步结果</p>
<p>3、在阿里云ES上恢复快照</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 更新仓库</span>
PUT _snapshot/ali_backup
{
<span class="hljs-string">"type"</span>: <span class="hljs-string">"oss"</span>,
<span class="hljs-string">"settings"</span>: {
            <span class="hljs-string">"base_path"</span>: <span class="hljs-string">"桶下面的路径"</span>,
            <span class="hljs-string">"endpoint"</span>: <span class="hljs-string">"http://oss-cn-beijing-internal.aliyuncs.com"</span>, 
            <span class="hljs-string">"access_key_id"</span>: <span class="hljs-string">"*************"</span>,
            <span class="hljs-string">"secret_access_key"</span>: <span class="hljs-string">"*************"</span>,
            <span class="hljs-string">"bucket"</span>: <span class="hljs-string">"oss桶"</span>,
            <span class="hljs-string">"compress"</span>: <span class="hljs-literal">true</span>
      }
}

<span class="hljs-comment"># 查看快照</span>
GET _snapshot/ali_backup/prd_01

<span class="hljs-comment"># 全量恢复快照（排除系统索引，注意这里是第一次恢复所以不需要关闭索引）</span>
POST _snapshot/ali_backup/prd_01/_restore
{
    <span class="hljs-string">"indices"</span>: <span class="hljs-string">"*,-.*,-system*,-ilm*,-kibana*,-.kibana*"</span>
}
<span class="hljs-comment"># * 恢复镜像中的所有索引</span>
<span class="hljs-comment"># -.*  排除系统索引</span>
<span class="hljs-comment"># -system*  </span>
<span class="hljs-comment"># -ilm* 排除ILM索引</span>
<span class="hljs-comment"># -kibana*,-.kibana*  排除kibana索引</span>
</code></pre>
<h4 data-id="heading-8">第二次快照恢复动作</h4>
<p>1、在AWS上的es创建快照并上传到S3，第2个版本prd_02</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第2个版本快照</span>
PUT _snapshot/ali_backup/prd_02
{
  <span class="hljs-string">"indices"</span>: <span class="hljs-string">"*"</span>,
  <span class="hljs-string">"ignore_unavailable"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"include_global_state"</span>: <span class="hljs-literal">false</span>
}
<span class="hljs-comment"># 查看快照进度</span>
GET _cat/snapshots/ali_backup?v
</code></pre>
<p>2、启动S3到oss的数据同步任务</p>
<p>3、在阿里云ES上恢复快照</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 查看快照</span>
GET _snapshot/ali_backup/prd_02

<span class="hljs-comment"># 关闭所有索引主要要排除系统索引，不然kibana会报错就没法操作了</span>
POST /*,-.*,-system*,-ilm*,-kibana*,-.kibana*/_close

<span class="hljs-comment"># 全量恢复快照排除系统索引</span>
POST _snapshot/ali_backup/prd_02/_restore
{
    <span class="hljs-string">"indices"</span>: <span class="hljs-string">"*,-.*,-system*,-ilm*,-kibana*,-.kibana*"</span>
}
</code></pre>
<h4 data-id="heading-9">总结说明</h4>
<p>快照恢复比较简单高效，当据量大的情况下第一次打快照和恢复快照时间较长，后面做增量快照和恢复增量快照比较快。</p>
<h2 data-id="heading-10">es生成快照脚本</h2>
<p>下面是基于python开发的生成快照、关闭索引、恢复索引、打开索引、查看恢复状态、查看索引版本的工具，方便进行多次打快照恢复快照避免在kibana上频繁操作误操作。</p>
<p>es_ba_config.toml</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[AWS-es01]</span>
<span class="hljs-attr">es_host</span> = <span class="hljs-string">"xxxxx.ssss.net.cn"</span>
<span class="hljs-attr">es_port</span> = <span class="hljs-number">9200</span>
<span class="hljs-attr">protocol</span> = <span class="hljs-string">"https"</span>
<span class="hljs-attr">username</span> = <span class="hljs-string">"elastic"</span>  <span class="hljs-comment"># 用户名</span>
<span class="hljs-attr">password</span> = <span class="hljs-string">"xxxxxxxxxxxxxx"</span>  <span class="hljs-comment"># 密码</span>

<span class="hljs-section">[AWS-es02]</span>
<span class="hljs-attr">es_host</span> = <span class="hljs-string">"xxxxx.ssss.cn"</span>
<span class="hljs-attr">es_port</span> = <span class="hljs-number">9200</span>
<span class="hljs-attr">protocol</span> = <span class="hljs-string">"https"</span>
<span class="hljs-attr">username</span> = <span class="hljs-string">"elastic"</span>  <span class="hljs-comment"># 用户名</span>
<span class="hljs-attr">password</span> = <span class="hljs-string">"XXXXXXXXP"</span>  <span class="hljs-comment"># 密码</span>
</code></pre>
<p>es_re_config.toml</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[ALI-es-01]</span>
<span class="hljs-attr">es_host</span> = <span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXxx.aliyuncs.com"</span>
<span class="hljs-attr">es_port</span> = <span class="hljs-number">9200</span>
<span class="hljs-attr">protocol</span> = <span class="hljs-string">"https"</span>
<span class="hljs-attr">username</span> = <span class="hljs-string">"elastic"</span>  <span class="hljs-comment"># 用户名</span>
<span class="hljs-attr">password</span> = <span class="hljs-string">"XXXXXXXXX"</span>  <span class="hljs-comment"># 密码</span>

<span class="hljs-section">[ALI-es-02]</span>
<span class="hljs-attr">es_host</span> = <span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXxx.aliyuncs.com"</span>
<span class="hljs-attr">es_port</span> = <span class="hljs-number">9200</span>
<span class="hljs-attr">protocol</span> = <span class="hljs-string">"https"</span>
<span class="hljs-attr">username</span> = <span class="hljs-string">"elastic"</span>  <span class="hljs-comment"># 用户名</span>
<span class="hljs-attr">password</span> = <span class="hljs-string">"XXXXXXXXX"</span>  <span class="hljs-comment"># 密码</span>
</code></pre>
<p>es-backup.py</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> toml
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, jsonify, request
app = Flask(__name__)

<span class="hljs-comment">#----------------------------加载配置文件---------------------------#</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">set_config</span>(<span class="hljs-params">config_name</span>):
    <span class="hljs-string">"""
    获取配置信息并设置全局变量
    """</span>
    <span class="hljs-keyword">global</span> ES_HOST, ES_PORT, PROTOCOL, USERNAME, PASSWORD

    <span class="hljs-keyword">try</span>:
        file_path = <span class="hljs-string">r"D:\work\es_ba_config.toml"</span>
        config = toml.load(file_path)[config_name]

        <span class="hljs-comment"># 设置全局变量</span>
        ES_HOST = config.get(<span class="hljs-string">'es_host'</span>)
        ES_PORT = config.get(<span class="hljs-string">'es_port'</span>)
        PROTOCOL = config.get(<span class="hljs-string">'protocol'</span>)
        USERNAME = config.get(<span class="hljs-string">'username'</span>)
        PASSWORD = config.get(<span class="hljs-string">'password'</span>)

        <span class="hljs-built_in">print</span>({
            <span class="hljs-string">'ES_HOST'</span>: ES_HOST,
            <span class="hljs-string">'ES_PORT'</span>: ES_PORT,
            <span class="hljs-string">'PROTOCOL'</span>: PROTOCOL,
            <span class="hljs-string">'USERNAME'</span>: USERNAME,
            <span class="hljs-string">'PASSWORD'</span>: PASSWORD
        })
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"加载配置失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
<span class="hljs-comment">#----------------------------加载配置文件---------------------------#</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/api/get_snapshot_status'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">api_get_snapshot_status</span>():
    <span class="hljs-string">"""
    API接口：获取快照状态
    执行命令: GET _cat/snapshots/plrs_target_ps_visit_precondition?v
    """</span>
    data = request.get_json()
    repository = data.get(<span class="hljs-string">'repository'</span>)
    config_name = data.get(<span class="hljs-string">'config_name'</span>)
    set_config(config_name)
    <span class="hljs-comment"># 构建请求 URL</span>
    url = <span class="hljs-string">f"<span class="hljs-subst">{PROTOCOL}</span>://<span class="hljs-subst">{ES_HOST}</span>:<span class="hljs-subst">{ES_PORT}</span>/_cat/snapshots/<span class="hljs-subst">{repository}</span>?v"</span>

    <span class="hljs-comment"># 设置请求参数</span>
    params = {
        <span class="hljs-string">'v'</span>: <span class="hljs-string">'true'</span>  <span class="hljs-comment"># 显示详细信息</span>
    }

    <span class="hljs-comment"># 设置认证信息</span>
    auth = <span class="hljs-literal">None</span>
    <span class="hljs-keyword">if</span> USERNAME <span class="hljs-keyword">and</span> PASSWORD:
        auth = (USERNAME, PASSWORD)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 发送 GET 请求，添加认证信息和参数</span>
        response = requests.get(url, params=params, auth=auth)
        response.raise_for_status()  <span class="hljs-comment"># 检查请求是否成功</span>

        <span class="hljs-built_in">print</span>(response.text)

        <span class="hljs-keyword">return</span> jsonify({
            <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"success"</span>,
            <span class="hljs-string">"data"</span>: response.text
        })

    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> jsonify({
            <span class="hljs-string">"code"</span>: <span class="hljs-number">500</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">f"获取快照状态失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>,
            <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>
        })


<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/api/create_snapshot'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">api_create_snapshot</span>():
    <span class="hljs-string">"""
    API接口：创建快照
    执行命令: PUT _snapshot/plrs_target_ps_visit_precondition/prd_01
    """</span>
    <span class="hljs-comment"># 使用默认参数匹配指定的快照创建命令</span>
    ignore_unavailable = <span class="hljs-literal">True</span>
    include_global_state = <span class="hljs-literal">False</span>
    data = request.get_json()
    repository = data.get(<span class="hljs-string">'repository'</span>)
    snapshot = data.get(<span class="hljs-string">'snapshot'</span>)
    indices = data.get(<span class="hljs-string">'indices'</span>)
    config_name = data.get(<span class="hljs-string">'config_name'</span>)
    set_config(config_name)

    <span class="hljs-comment"># 构建请求 URL</span>
    url = <span class="hljs-string">f"<span class="hljs-subst">{PROTOCOL}</span>://<span class="hljs-subst">{ES_HOST}</span>:<span class="hljs-subst">{ES_PORT}</span>/_snapshot/<span class="hljs-subst">{repository}</span>/<span class="hljs-subst">{snapshot}</span>"</span>

    <span class="hljs-comment"># 设置认证信息</span>
    auth = <span class="hljs-literal">None</span>
    <span class="hljs-keyword">if</span> USERNAME <span class="hljs-keyword">and</span> PASSWORD:
        auth = (USERNAME, PASSWORD)

    <span class="hljs-comment"># 设置请求体</span>
    body = {
        <span class="hljs-string">"indices"</span>: indices,
        <span class="hljs-string">"ignore_unavailable"</span>: ignore_unavailable,
        <span class="hljs-string">"include_global_state"</span>: include_global_state
    }

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 发送 PUT 请求，添加认证信息和请求体</span>
        response = requests.put(url, auth=auth, json=body)
        response.raise_for_status()  <span class="hljs-comment"># 检查请求是否成功</span>

        <span class="hljs-comment"># 返回 JSON 响应数据</span>
        <span class="hljs-keyword">return</span> jsonify({
            <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"快照创建成功"</span>,
            <span class="hljs-string">"data"</span>: response.json()
        })

    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> jsonify({
            <span class="hljs-string">"code"</span>: <span class="hljs-number">500</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"创建快照失败"</span>,
            <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>
        })
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    app.run(host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8888</span>, debug=<span class="hljs-literal">True</span>)
</code></pre>
<p>es-restore.py</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> toml
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, jsonify, request
app = Flask(__name__)


<span class="hljs-comment">#----------------------------加载配置文件---------------------------#</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">set_config</span>(<span class="hljs-params">config_name</span>):
    <span class="hljs-string">"""
    获取配置信息并设置全局变量
    """</span>
    <span class="hljs-keyword">global</span> ES_HOST, ES_PORT, PROTOCOL, USERNAME, PASSWORD

    <span class="hljs-keyword">try</span>:
        file_path = <span class="hljs-string">r"D:\work\es_re_config.toml"</span>
        config = toml.load(file_path)[config_name]

        <span class="hljs-comment"># 设置全局变量</span>
        ES_HOST = config.get(<span class="hljs-string">'es_host'</span>)
        ES_PORT = config.get(<span class="hljs-string">'es_port'</span>)
        PROTOCOL = config.get(<span class="hljs-string">'protocol'</span>)
        USERNAME = config.get(<span class="hljs-string">'username'</span>)
        PASSWORD = config.get(<span class="hljs-string">'password'</span>)

        <span class="hljs-built_in">print</span>({
            <span class="hljs-string">'ES_HOST'</span>: ES_HOST,
            <span class="hljs-string">'ES_PORT'</span>: ES_PORT,
            <span class="hljs-string">'PROTOCOL'</span>: PROTOCOL,
            <span class="hljs-string">'USERNAME'</span>: USERNAME,
            <span class="hljs-string">'PASSWORD'</span>: PASSWORD
        })
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"加载配置失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
<span class="hljs-comment">#----------------------------加载配置文件---------------------------#</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_es_indices_status</span>(<span class="hljs-params">es_host, es_port=<span class="hljs-number">9200</span>, protocol=<span class="hljs-string">'http'</span>, username=<span class="hljs-literal">None</span>, password=<span class="hljs-literal">None</span></span>):
    <span class="hljs-string">"""
    获取 Elasticsearch 所有索引的状态信息

    Args:
        es_host (str): Elasticsearch 主机地址
        es_port (int): Elasticsearch 端口号，默认为 9200
        protocol (str): 协议类型，默认为 'http'
        username (str): 用户名，用于基本认证
        password (str): 密码，用于基本认证

    Returns:
        dict: 索引状态信息
    """</span>
    <span class="hljs-comment"># 构建请求 URL</span>
    url = <span class="hljs-string">f"<span class="hljs-subst">{protocol}</span>://<span class="hljs-subst">{es_host}</span>:<span class="hljs-subst">{es_port}</span>/_cat/indices/*"</span>

    <span class="hljs-comment"># 设置请求参数</span>
    params = {
        <span class="hljs-string">'h'</span>: <span class="hljs-string">'index,status'</span>,  <span class="hljs-comment"># 只返回索引名和状态</span>
        <span class="hljs-string">'expand_wildcards'</span>: <span class="hljs-string">'all'</span>  <span class="hljs-comment"># 展开所有通配符匹配的索引</span>
    }

    <span class="hljs-comment"># 设置认证信息</span>
    auth = <span class="hljs-literal">None</span>
    <span class="hljs-keyword">if</span> username <span class="hljs-keyword">and</span> password:
        auth = (username, password)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 发送 GET 请求，添加认证信息</span>
        response = requests.get(url, params=params, auth=auth)
        response.raise_for_status()  <span class="hljs-comment"># 检查请求是否成功</span>

        <span class="hljs-comment"># 处理响应数据</span>
        indices_data = response.text.strip()
        <span class="hljs-keyword">if</span> indices_data:
            <span class="hljs-comment"># 按行分割并处理数据</span>
            lines = indices_data.split(<span class="hljs-string">'\n'</span>)
            indices_status = {}
            <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:
                <span class="hljs-keyword">if</span> line.strip():
                    parts = line.strip().split()
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span>:
                        index_name = parts[<span class="hljs-number">0</span>]
                        status = parts[<span class="hljs-number">1</span>]
                        indices_status[index_name] = status
            <span class="hljs-comment"># 2. 过滤出非系统索引</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n正在过滤非系统索引..."</span>)
            non_system_indices = filter_non_system_indices(indices_status)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"共找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(non_system_indices)}</span> 个非系统索引:"</span>)
            <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> non_system_indices:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{index}</span>"</span>)
            <span class="hljs-keyword">return</span> non_system_indices
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> {}

    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"请求 Elasticsearch 失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_non_system_indices</span>(<span class="hljs-params">indices_status</span>):
    <span class="hljs-string">"""
    过滤出所有非系统索引（不以 . 开头的索引）

    Args:
        indices_status (dict): 所有索引及其状态

    Returns:
        list: 非系统索引列表
    """</span>
    non_system_indices = []
    <span class="hljs-keyword">for</span> index_name <span class="hljs-keyword">in</span> indices_status.keys():
        <span class="hljs-comment"># 过滤掉以 . 开头的系统索引</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> index_name.startswith(<span class="hljs-string">'.'</span>):
            non_system_indices.append(index_name)

    <span class="hljs-keyword">return</span> non_system_indices

<span class="hljs-comment"># 逐个关闭索引</span>
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/api/close_individual_indices'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">close_individual_indices</span>():
    data = request.get_json()
    indices_list = data.get(<span class="hljs-string">'indices_list'</span>)
    config_name = data.get(<span class="hljs-string">'config_name'</span>)
    set_config(config_name)
    <span class="hljs-string">"""
    逐个关闭索引（更安全的方式）

    Args:
        es_host (str): Elasticsearch 主机地址
        es_port (int): Elasticsearch 端口号
        protocol (str): 协议类型
        username (str): 用户名
        password (str): 密码
        indices_list (list): 要关闭的索引列表,依赖接口传递，如果是空就获取全部

    Returns:
        dict: 关闭操作结果统计
    """</span>
    <span class="hljs-comment"># 设置认证信息</span>
    auth = <span class="hljs-literal">None</span>
    <span class="hljs-keyword">if</span> USERNAME <span class="hljs-keyword">and</span> PASSWORD:
        auth = (USERNAME, PASSWORD)

    success_count = <span class="hljs-number">0</span>
    failed_count = <span class="hljs-number">0</span>
    details = []
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> indices_list:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 构建请求 URL</span>
            url = <span class="hljs-string">f"<span class="hljs-subst">{PROTOCOL}</span>://<span class="hljs-subst">{ES_HOST}</span>:<span class="hljs-subst">{ES_PORT}</span>/*,-.*,-system*,-ilm*,-kibana*,-.kibana*/_close"</span>

            <span class="hljs-comment"># 发送 POST 请求关闭单个索引</span>
            response = requests.post(url, auth=auth)
            response.raise_for_status()

        <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"关闭索引 * 失败: <span class="hljs-subst">{e}</span>"</span>)
            details.append({<span class="hljs-string">"index"</span>: <span class="hljs-string">"*"</span>, <span class="hljs-string">"status"</span>: <span class="hljs-string">"failed"</span>, <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)})
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">for</span> index_name <span class="hljs-keyword">in</span> indices_list:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 构建请求 URL</span>
                url = <span class="hljs-string">f"<span class="hljs-subst">{PROTOCOL}</span>://<span class="hljs-subst">{ES_HOST}</span>:<span class="hljs-subst">{ES_PORT}</span>/<span class="hljs-subst">{index_name}</span>/_close"</span>

                <span class="hljs-comment"># 发送 POST 请求关闭单个索引</span>
                response = requests.post(url, auth=auth)
                response.raise_for_status()

                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功关闭索引: <span class="hljs-subst">{index_name}</span>"</span>)
                success_count += <span class="hljs-number">1</span>
                details.append({<span class="hljs-string">"index"</span>: index_name, <span class="hljs-string">"status"</span>: <span class="hljs-string">"success"</span>})

            <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"关闭索引 <span class="hljs-subst">{index_name}</span> 失败: <span class="hljs-subst">{e}</span>"</span>)
                failed_count += <span class="hljs-number">1</span>
                details.append({<span class="hljs-string">"index"</span>: index_name, <span class="hljs-string">"status"</span>: <span class="hljs-string">"failed"</span>, <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)})
    <span class="hljs-keyword">return</span> jsonify({
        <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
        <span class="hljs-string">"message"</span>: <span class="hljs-string">"success"</span>,
        <span class="hljs-string">"data"</span>: {
            <span class="hljs-string">"success"</span>: success_count,
            <span class="hljs-string">"failed"</span>: failed_count,
            <span class="hljs-string">"details"</span>: details
        }
    })

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/api/open_individual_indices'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">open_individual_indices</span>():
    data = request.get_json()
    indices_list = data.get(<span class="hljs-string">'indices_list'</span>)
    config_name = data.get(<span class="hljs-string">'config_name'</span>)
    set_config(config_name)
    <span class="hljs-string">"""
    逐个开启索引（更安全的方式）

    Args:
        es_host (str): Elasticsearch 主机地址
        es_port (int): Elasticsearch 端口号
        protocol (str): 协议类型
        username (str): 用户名
        password (str): 密码
        indices_list (list): 要开启的索引列表

    Returns:
        dict: 开启操作结果统计
    """</span>
    <span class="hljs-comment"># 设置认证信息</span>
    auth = <span class="hljs-literal">None</span>
    <span class="hljs-keyword">if</span> USERNAME <span class="hljs-keyword">and</span> PASSWORD:
        auth = (USERNAME, PASSWORD)

    success_count = <span class="hljs-number">0</span>
    failed_count = <span class="hljs-number">0</span>
    details = []

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> indices_list:
        <span class="hljs-comment"># 开启所有索引</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 构建请求 URL</span>
            url = <span class="hljs-string">f"<span class="hljs-subst">{PROTOCOL}</span>://<span class="hljs-subst">{ES_HOST}</span>:<span class="hljs-subst">{ES_PORT}</span>/_all/_open"</span>

            <span class="hljs-comment"># 发送 POST 请求开启单个索引</span>
            response = requests.post(url, auth=auth)
            response.raise_for_status()

        <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开启索引_all失败: <span class="hljs-subst">{e}</span>"</span>)
            details.append({<span class="hljs-string">"index"</span>: <span class="hljs-string">"_all"</span>, <span class="hljs-string">"status"</span>: <span class="hljs-string">"failed"</span>, <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)})
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">for</span> index_name <span class="hljs-keyword">in</span> indices_list:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 构建请求 URL</span>
                url = <span class="hljs-string">f"<span class="hljs-subst">{PROTOCOL}</span>://<span class="hljs-subst">{ES_HOST}</span>:<span class="hljs-subst">{ES_PORT}</span>/<span class="hljs-subst">{index_name}</span>/_open"</span>

                <span class="hljs-comment"># 发送 POST 请求开启单个索引</span>
                response = requests.post(url, auth=auth)
                response.raise_for_status()

                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功开启索引: <span class="hljs-subst">{index_name}</span>"</span>)
                success_count += <span class="hljs-number">1</span>
                details.append({<span class="hljs-string">"index"</span>: index_name, <span class="hljs-string">"status"</span>: <span class="hljs-string">"success"</span>})

            <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开启索引 <span class="hljs-subst">{index_name}</span> 失败: <span class="hljs-subst">{e}</span>"</span>)
                failed_count += <span class="hljs-number">1</span>
                details.append({<span class="hljs-string">"index"</span>: index_name, <span class="hljs-string">"status"</span>: <span class="hljs-string">"failed"</span>, <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)})

    <span class="hljs-keyword">return</span> jsonify({
        <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
        <span class="hljs-string">"message"</span>: <span class="hljs-string">"success"</span>,
        <span class="hljs-string">"data"</span>: {
            <span class="hljs-string">"success"</span>: success_count,
            <span class="hljs-string">"failed"</span>: failed_count,
            <span class="hljs-string">"details"</span>: details
        }
    })


<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/api/restore_snapshot'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">api_restore_snapshot</span>():
    <span class="hljs-string">"""
    API接口：恢复快照
    执行命令: POST _snapshot/ali_es_backup/prd_01/_restore
    """</span>
    <span class="hljs-comment"># 使用固定的参数来匹配指定的恢复命令</span>
    data = request.get_json()
    repository = data.get(<span class="hljs-string">'repository'</span>)
    snapshot =  data.get(<span class="hljs-string">'snapshot'</span>)
    indices = data.get(<span class="hljs-string">'indices'</span>)
    config_name = data.get(<span class="hljs-string">'config_name'</span>)
    set_config(config_name)
    <span class="hljs-comment"># 构建请求 URL</span>
    get_url = <span class="hljs-string">f"<span class="hljs-subst">{PROTOCOL}</span>://<span class="hljs-subst">{ES_HOST}</span>:<span class="hljs-subst">{ES_PORT}</span>/_snapshot/<span class="hljs-subst">{repository}</span>/<span class="hljs-subst">{snapshot}</span>"</span>
    post_url = <span class="hljs-string">f"<span class="hljs-subst">{PROTOCOL}</span>://<span class="hljs-subst">{ES_HOST}</span>:<span class="hljs-subst">{ES_PORT}</span>/_snapshot/<span class="hljs-subst">{repository}</span>/<span class="hljs-subst">{snapshot}</span>/_restore"</span>
    <span class="hljs-built_in">print</span>(get_url)
    <span class="hljs-built_in">print</span>(post_url)

    <span class="hljs-comment"># 设置认证信息</span>
    auth = <span class="hljs-literal">None</span>
    <span class="hljs-keyword">if</span> USERNAME <span class="hljs-keyword">and</span> PASSWORD:
        auth = (USERNAME, PASSWORD)

    <span class="hljs-comment"># 设置请求体 - 匹配指定命令的参数</span>
    body = {
        <span class="hljs-string">"indices"</span>: indices
    }
    <span class="hljs-built_in">print</span>(body)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 发送 POST 请求，添加认证信息和请求体</span>
        response = requests.get(get_url, auth=auth, json=body)
        response.raise_for_status()  <span class="hljs-comment"># 检查请求是否成功</span>
        <span class="hljs-keyword">pass</span>
    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> jsonify({
            <span class="hljs-string">"code"</span>: <span class="hljs-number">500</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">f"获取快照失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>,
            <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>
        })

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 发送 POST 请求，添加认证信息和请求体</span>
        response = requests.post(post_url, auth=auth, json=body)
        response.raise_for_status()  <span class="hljs-comment"># 检查请求是否成功</span>

        <span class="hljs-keyword">return</span> jsonify({
            <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">f"快照恢复成功"</span>,
            <span class="hljs-string">"data"</span>: response.json()
        })

    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> jsonify({
            <span class="hljs-string">"code"</span>: <span class="hljs-number">500</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">f"恢复快照失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>,
            <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>
        })

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/api/get_all_snapshots'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_all_snapshots</span>():
    <span class="hljs-string">"""
    获取指定仓库下所有快照的信息

    Args:
        es_host (str): Elasticsearch 主机地址
        es_port (int): Elasticsearch 端口号，默认为 9200
        protocol (str): 协议类型，默认为 'http'
        username (str): 用户名，用于基本认证
        password (str): 密码，用于基本认证
        repository (str): 快照仓库名称

    Returns:
        dict: 快照信息
    """</span>
    data = request.get_json()
    repository = data.get(<span class="hljs-string">'repository'</span>)
    config_name = data.get(<span class="hljs-string">'config_name'</span>)
    set_config(config_name)
    <span class="hljs-comment"># 构建请求 URL</span>
    url = <span class="hljs-string">f"<span class="hljs-subst">{PROTOCOL}</span>://<span class="hljs-subst">{ES_HOST}</span>:<span class="hljs-subst">{ES_PORT}</span>/_snapshot/<span class="hljs-subst">{repository}</span>/_all"</span>
    <span class="hljs-comment"># 设置请求参数</span>
    params = {
        <span class="hljs-string">'filter_path'</span>: <span class="hljs-string">'snapshots.name,snapshots.snapshot,snapshots.state,snapshots.start_time,snapshots.end_time'</span>
    }

    <span class="hljs-comment"># 设置认证信息</span>
    auth = <span class="hljs-literal">None</span>
    <span class="hljs-keyword">if</span> USERNAME <span class="hljs-keyword">and</span> PASSWORD:
        auth = (USERNAME, PASSWORD)

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 发送 GET 请求，添加认证信息和参数</span>
        response = requests.get(url, params=params, auth=auth)
        response.raise_for_status()  <span class="hljs-comment"># 检查请求是否成功</span>
        <span class="hljs-comment"># 返回 JSON 响应数据</span>
        <span class="hljs-keyword">return</span> jsonify({
            <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"获取成功"</span>,
            <span class="hljs-string">"data"</span>: response.json()
        })

    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> jsonify({
            <span class="hljs-string">"code"</span>: <span class="hljs-number">500</span>,
            <span class="hljs-string">"message"</span>: <span class="hljs-string">f"获取信息失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>,
            <span class="hljs-string">"data"</span>: <span class="hljs-literal">None</span>
        })


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    app.run(host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">6666</span>, debug=<span class="hljs-literal">True</span>)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VSCode + Renode 调试我手工实现的 RTOS：一次彻底改变我开发方式的体验]]></title>    <link>https://juejin.cn/post/7580809247736643624</link>    <guid>https://juejin.cn/post/7580809247736643624</guid>    <pubDate>2025-12-08T04:43:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580809247736643624" data-draft-id="7580988382761107471" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VSCode + Renode 调试我手工实现的 RTOS：一次彻底改变我开发方式的体验"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-12-08T04:43:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户938559462475"/> <meta itemprop="url" content="https://juejin.cn/user/1259367703787244"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VSCode + Renode 调试我手工实现的 RTOS：一次彻底改变我开发方式的体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1259367703787244/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户938559462475
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T04:43:04.000Z" title="Mon Dec 08 2025 04:43:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我之前搭建了VSCode+Renode的开发环境后并测试了一些简单的Led_Toggle示例，后面打算用它来开发一些复杂的功能，比如RTOS的实现。</p>
<p>之后我用两周的时间实现了一个简单的RTOS模型，主要的目的：熟悉使用 <strong>VSCode + Renode</strong> 的开发方式和加强对RTOS的了解。 这一次尝试，让我第一次感受到：</p>
<blockquote>
<p><strong>调试 RTOS 不一定需要开发板。</strong> <strong>VSCode + Renode 可以把嵌入式系统调试变得像应用层软件一样丝滑。</strong></p>
</blockquote>
<p>我成功在 Renode 上：</p>
<ul>
<li>单步进入 PendSV</li>
<li>观察任务切换全过程</li>
<li>分析 PSP/MSP 的切换</li>
<li>查出链表插入错误导致的 UsageFault</li>
<li>定位 BASEPRI 设置不当导致的断言</li>
<li>复现 pxIndex 错误导致的任务调度混乱</li>
</ul>
<p>下面是完整的经验分享 + 图示，帮助你也能快速搭建这套“现代化嵌入式调试环境”。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F11cookies11%2FRtosOfArm.git" target="_blank" title="https://github.com/11cookies11/RtosOfArm.git" ref="nofollow noopener noreferrer">项目源码(RTOSOfArm)</a></p>
<h2 data-id="heading-0">1. 为什么用 VSCode + Renode 调 RTOS？</h2>
<h3 data-id="heading-1">✔ 完全不依赖硬件</h3>
<p>完全软件化，所有行为可复现，调度过程可单步。</p>
<h3 data-id="heading-2">✔ 调 RTOS 特别合适</h3>
<ul>
<li>查看 PendSV</li>
<li>查看 PSP/MSP</li>
<li>查看 BASEPRI</li>
<li>查看链表结构</li>
<li>查看异常堆栈</li>
<li>跟踪 SVC 调度 这些在真实硬件上调起来非常痛苦。</li>
</ul>
<h3 data-id="heading-3">✔ 可重复、可回放</h3>
<p>同样的 ELF 每次都能复现同样的 bug，不像硬件那样受外界干扰。</p>
<h2 data-id="heading-4">2. 工程结构示意图</h2>
<ul>
<li>根目录</li>
<li>apps/</li>
<li>blinky/：演示任务，Task1/Task2 交替打印串口，验证 tick 与调度</li>
<li>ports/</li>
<li>arm-cortex-m/：上下文切换、SysTick、PendSV 配置</li>
<li>rtos/（子模块）</li>
<li>config/：RTOS 配置</li>
<li>source/：任务、链表、临界区基础设施</li>
<li>renode/</li>
<li>platform.resc：Renode 平台描述，包含 GDB 服务器端口</li>
<li>.vscode/</li>
<li>tasks.json / launch.json：构建、传输、启动 Renode、GDB 连接的一键链路</li>
</ul>
<h2 data-id="heading-5">3. VSCode + Renode 调试流程示意</h2>
<p>下面这幅图可以帮助你理解整个流程：</p>
<p>流程非常顺滑：</p>
<ol>
<li>VSCode 调用 CMake 生成 firmware.elf</li>
<li>自动运行 Renode（启动 CPU、外设、内存）</li>
<li>Renode 打开 GDB Server</li>
<li>VSCode 自动 attach 到 3333</li>
<li>程序停在 Reset_Handler</li>
<li>你就可以开始单步调度器了</li>
</ol>
<p>就是这么“现代”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f530313d9afe41c2befb4f10ce3fd5e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3OTM4NTU5NDYyNDc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765773783&amp;x-signature=g0HWMHeMf%2BYCWfw3n7yzdW1oEv0%3D" alt="ssh_renode.jpg" loading="lazy"/></p>
<h2 data-id="heading-6">4. RTOS 调试中最关键的几个图示</h2>
<p>为了让内容更直观，结合我调试时真正遇到的问题，整理出了几个问题和使用renode解决问题的介绍。</p>
<h2 data-id="heading-7">4.1 PendSV 任务切换（重点）</h2>
<p>PendSV 是 RTOS 调度的核心，Renode 允许我：</p>
<ul>
<li>单步进入 PendSV</li>
<li>看每条指令</li>
<li>看寄存器压栈/出栈</li>
<li>看 PSP/MSP 切换</li>
<li>看第一个任务如何启动</li>
</ul>
<p>实机很难做到如此清晰。 我在是使用PendSVC实现上下文保存和栈切换的时候，由于代码中访问错了寄存器地址，在错误时序(rtos初始化还没有完成)的时候触发了PendSVC，导致从PendSVC中返回的时候，往PSP中复制了错误的信息，系统跑飞。<strong>硬件实机很难准确捕捉到错误触发时刻的上下文</strong>，但通过renode，我<strong>可以准确的准确复现问题，并通过内核寄存器逐步找到问题所在</strong>；</p>
<h2 data-id="heading-8">4.2 Cortex-M 任务切换堆栈</h2>
<p>Cortex-M 的标准异常堆栈构成是：</p>
<ul>
<li>xPSR</li>
<li>PC</li>
<li>LR</li>
<li>R12</li>
<li>R3/R2/R1/R0</li>
<li>以及 PendSV 自己保存的 R4–R11</li>
</ul>
<p>Renode 的寄存器窗口能逐条验证： “我保存/恢复的顺序对不对？” “我的 PSP 是否正确指向任务栈？”</p>
<p>这些以前都是靠猜，现在能真正看到。</p>
<p>更加<strong>有利于理解RTOS中上下文的保存的实现</strong>；</p>
<p>我在实现堆栈切换的时候，使用的裸函数关键字，其中有在设置PSP的时候，错误的设置成了MSP，导致返回Thread Mode的时候，系统出现异常，使用Renode可以很清晰复现和可控问题；</p>
<h2 data-id="heading-9">4.3 FreeRTOS/书上 RTOS 使用的链表结构</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4feb2a32015c429997934583ea8e294c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3OTM4NTU5NDYyNDc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765773783&amp;x-signature=otWQ6ovHCSKtKfwzuEwXm0yNfBM%3D" alt="链表.jpg" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<p>我调试时遇到过两个典型问题：</p>
<ul>
<li>pxIndex 推进错误</li>
<li>pxNext 指向非法地址导致 UsageFault</li>
</ul>
<p>使用renode后，我能很好地在 GDB 里看到的 pxNext, pxPrevious, pxIndex。</p>
<h2 data-id="heading-10">5. 调试时我遇到的关键问题（附图示理解）</h2>
<h2 data-id="heading-11">🧨 5.1 vListInsert 出现 UsageFault</h2>
<pre><code class="hljs language-ini" lang="ini">for (<span class="hljs-attr">pxIterator</span> = &amp;pxList-&gt;xListEnd<span class="hljs-comment">;</span>
     pxIterator-&gt;pxNext-&gt;itemValue &lt;= pxNewListItem-&gt;itemValue<span class="hljs-comment">;</span>
     <span class="hljs-attr">pxIterator</span> = pxIterator-&gt;pxNext)
{
}
</code></pre>
<p>由于链表初始化不完整：</p>
<ul>
<li>pxIterator-&gt;pxNext = 0xFFFFFFFF，导致程序无法正常运行</li>
<li>一些野指针被引用时直接触发 UsageFault</li>
</ul>
<p>用 Renode 单步后，我能看到 EXACTLY 哪一条汇编指令访问了非法地址。</p>
<h2 data-id="heading-12">🧨 5.2 BASEPRI 设置不当导致 configASSERT 报错</h2>
<p>症状：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">configASSERT</span>( (IPSCR &amp; <span class="hljs-number">0</span>xFF) == <span class="hljs-number">0</span> )
</code></pre>
<p>表示进入临界区时，任务处于异常状态。</p>
<p>最终我发现：</p>
<ul>
<li>临界区嵌套计数错误</li>
<li>BASEPRI 设置比预期更高</li>
<li>阻断了本应触发的 SVC</li>
<li>导致调度器进入错误状态</li>
</ul>
<p>这一类错误靠普通调试器很难抓住，Renode 通过中断事件可以清晰看到优先级变化。</p>
<h2 data-id="heading-13">🧨 5.3 pxIndex 指向错误导致任务切换混乱</h2>
<p>症状：</p>
<ul>
<li>当前任务 TCB 错乱</li>
<li>listGET_OWNER_OF_HEAD_ENTRY 返回错误地址</li>
<li>PendSV 恢复栈时跳到错误 PC</li>
</ul>
<p>链表结构图再次提供帮助：</p>
<p>通过 Renode 单步，我能从：</p>
<pre><code class="hljs">pxIndex → pxNext → pvOwner
</code></pre>
<p>一路看到链表的真实结构，从而确认哪个节点被破坏。</p>
<h2 data-id="heading-14">6. Renode 调 RTOS 的几个强烈推荐技巧（配图）</h2>
<h3 data-id="heading-15">① 查看 CPU 寄存器</h3>
<pre><code class="hljs">cpu DumpRegisters
 
</code></pre>
<p>尤其是 PSP/MSP/CONTROL，很关键。</p>
<h3 data-id="heading-16">② 查看外设（比如 SysTick 寄存器）</h3>
<p>你之前 Systick ENABLE 位写错，这个图能帮助理解控制位的含义。</p>
<h3 data-id="heading-17">③ 查看中断事件顺序</h3>
<p>可以看到：</p>
<ul>
<li>SVC</li>
<li>SysTick</li>
<li>PendSV</li>
</ul>
<p>的调用顺序（非常有用）。</p>
<h2 data-id="heading-18">7. 现代化嵌入式开发的感悟</h2>
<p>通过这次体验，我真正感受到：</p>
<blockquote>
<p><strong>嵌入式完全可以变得“现代”而不是“折磨”。</strong></p>
</blockquote>
<ul>
<li>不需要反复烧录</li>
<li>不依赖硬件</li>
<li>不靠串口</li>
<li>不靠 J-Link</li>
<li>所有问题都可重复复现</li>
<li>所有结构都能在 Renode 中单步观察</li>
<li>任意异常都能定位</li>
<li>工程结构清晰</li>
<li>调试体验比 IAR/Keil 好太多</li>
</ul>
<p>这种感觉真的很爽。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[039_Netty网络编程服务端入门程序开发]]></title>    <link>https://juejin.cn/post/7581025279645483046</link>    <guid>https://juejin.cn/post/7581025279645483046</guid>    <pubDate>2025-12-08T04:32:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581025279645483046" data-draft-id="7581004702945345563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="039_Netty网络编程服务端入门程序开发"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-08T04:32:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Frank_zhou"/> <meta itemprop="url" content="https://juejin.cn/user/634850088593675"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            039_Netty网络编程服务端入门程序开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/634850088593675/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Frank_zhou
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T04:32:00.000Z" title="Mon Dec 08 2025 04:32:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.ruyuan.netty;

<span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelOption;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NettyServer</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NettyServer</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span> {
        <span class="hljs-built_in">this</span>.port = port;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 肯定需要线程池，有的线程可以去负责跟大量的客户端建立网络连接</span>
        <span class="hljs-comment">// 有的线程可以去负责网络io数据读写</span>
        <span class="hljs-comment">// 网络io数据读取出来以后，处理请求数据，数据处理也需要专门的线程去处理</span>
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(); <span class="hljs-comment">// 默认的线程池的大小，cpu core * 2</span>
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">20</span>);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">serverBootstrap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
            serverBootstrap.group(bossGroup, workerGroup)
                    .channel(NioServerSocketChannel.class)
                    .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel socketChannel)</span> <span class="hljs-keyword">throws</span> Exception {
                            socketChannel.pipeline()
                                    .addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>())
                                    .addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>())
                                    .addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyServerHandler</span>());
                        }
                    })
                    .option(ChannelOption.SO_BACKLOG, <span class="hljs-number">128</span>)
                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="hljs-literal">true</span>);

            <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">channelFuture</span> <span class="hljs-operator">=</span> serverBootstrap.bind(port).sync();
            channelFuture.channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            workerGroup.shutdownGracefully();
            bossGroup.shutdownGracefully();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"starting netty server......"</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">8998</span>;
        <span class="hljs-keyword">if</span>(args.length &gt; <span class="hljs-number">0</span>) {
            port = Integer.parseInt(args[<span class="hljs-number">0</span>]);
        }
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyServer</span>(port).start();
    }

}

</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.ruyuan.netty;

<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;
<span class="hljs-keyword">import</span> io.netty.buffer.Unpooled;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NettyServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {

    <span class="hljs-comment">// 网络连接tcp三次握手后，建立和封装一个channel，网络连接的通信管道</span>
    <span class="hljs-comment">// 此时这个channel应该就是可以实现一个激活</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"channel active......"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"channel read: "</span> + (String)msg);

        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello world......"</span>;
        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">responseByteBuf</span> <span class="hljs-operator">=</span> Unpooled.buffer();
        responseByteBuf.writeBytes(response.getBytes());

        ctx.channel().writeAndFlush(responseByteBuf);
        System.out.println(<span class="hljs-string">"channel write: "</span> + response);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelReadComplete</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"channel read complete......"</span>);
        ctx.flush();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception {
        cause.printStackTrace();;
        ctx.close();
    }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我做了一个用 YAML 来驱动串口/TCP 协议执行的框架，上位机从此不需要写代码了]]></title>    <link>https://juejin.cn/post/7581073928715649058</link>    <guid>https://juejin.cn/post/7581073928715649058</guid>    <pubDate>2025-12-08T04:52:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7581073928715649058" data-draft-id="7581041679189311523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我做了一个用 YAML 来驱动串口/TCP 协议执行的框架，上位机从此不需要写代码了"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-12-08T04:52:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="11cookies11"/> <meta itemprop="url" content="https://juejin.cn/user/1259367703787244"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我做了一个用 YAML 来驱动串口/TCP 协议执行的框架，上位机从此不需要写代码了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1259367703787244/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    11cookies11
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T04:52:45.000Z" title="Mon Dec 08 2025 04:52:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在嵌入式开发、自动化测试、工控联调的世界里，有一个永恒的痛点：</p>
<p><strong>同一套通信逻辑，会在不同的工具里被反复实现。</strong></p>
<ul>
<li>MCU Bootloader 升级要写一套上位机</li>
<li>Modbus 调试又写一套</li>
<li>TCP 控制台再来一套</li>
<li>测试平台脚本还要重写一遍</li>
</ul>
<p>协议没有变，只是执行方式换了，人却一直在重复劳动。</p>
<p>我曾经以为这是正常的，直到我写出了这个项目：</p>
<pre><code class="hljs">ToolOfCOM
</code></pre>
<blockquote>
<p>一个能“读懂 YAML 并执行通信协议逻辑”的运行时系统。 你不再需要写上位机，写一份 YAML 就够了。</p>
</blockquote>
<h2 data-id="heading-0">🧠 为什么会有 ToolOfCOM？</h2>
<p>我们真正想调试的不是“串口”，而是：</p>
<ul>
<li>等待某个事件</li>
<li>判断回包内容</li>
<li>超时处理</li>
<li>执行下一条命令</li>
<li>协议升级连续行为</li>
</ul>
<p>也就是说，上位机是一台<strong>通信状态机</strong>。</p>
<p>以前我们把状态机硬编码在 Python / C# / LabVIEW 里，所以：</p>
<blockquote>
<p>每换一个协议，也就换了一套上位机。</p>
</blockquote>
<p>这是重复劳动的根源。</p>
<p>我在 ToolOfCOM 里做了一件简单却颠覆性的事：</p>
<h3 data-id="heading-1"><strong>把通信过程抽象成 YAML DSL</strong></h3>
<p>协议只是 Driver 通信只是 Channel 执行过程由状态机解释</p>
<p>于是通信逻辑从此变成了<strong>文本资产</strong>。</p>
<h2 data-id="heading-2">🚀 用一句话理解 ToolOfCOM</h2>
<blockquote>
<p><strong>它是通信协议的运行时引擎，</strong> <strong>把上位机变成可执行的 YAML 状态机。</strong></p>
</blockquote>
<p>和串口助手等工具的区别在这里：</p>

















<table><thead><tr><th>工具类型</th><th>思维模式</th></tr></thead><tbody><tr><td>传统上位机</td><td>“点按钮 + 写逻辑 + 调代码”</td></tr><tr><td>ToolOfCOM</td><td>“写 YAML = 定义协议执行链”</td></tr></tbody></table>
<p>不是替代，而是升维。</p>
<h2 data-id="heading-3">📐 架构长这样（极简但有杀伤力）</h2>
<pre><code class="hljs language-scss" lang="scss">YAML DSL
  ↓ parser
ScriptAST
  ↓ executor
Runtime Engine
  ├─ ActionRegistry
  ├─ Protocol Drivers (XMODEM / Modbus RTU/ASCII/TCP / YMODEM)
  └─ Channels (UART / TCP / Logging)
</code></pre>
<p>一句话拆解：</p>
<ul>
<li>YAML = 通信描述语言</li>
<li>Parser = 把 YAML 变成 AST</li>
<li>Runtime Engine = 状态机执行器</li>
<li>Actions = 具体动作</li>
<li>Drivers = 协议栈</li>
<li>Channels = 串口/TCP 抽象层</li>
</ul>
<p><strong>协议、通道、逻辑三者彻底解耦。</strong></p>
<h2 data-id="heading-4">🧾 看看它的 YAML（比 Python 还顺眼）</h2>
<p>这是一个真的可以执行的脚本：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-number">1</span>
<span class="hljs-attr">vars:</span> { <span class="hljs-attr">block:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">file_path:</span> <span class="hljs-string">./firmware.bin</span> }

<span class="hljs-attr">channels:</span>
  <span class="hljs-attr">boot:</span> { <span class="hljs-attr">type:</span> <span class="hljs-string">uart</span>, <span class="hljs-attr">device:</span> <span class="hljs-string">COM5</span>, <span class="hljs-attr">baudrate:</span> <span class="hljs-number">115200</span> }

<span class="hljs-attr">state_machine:</span>
  <span class="hljs-attr">initial:</span> <span class="hljs-string">wait_C</span>
  <span class="hljs-attr">states:</span>
    <span class="hljs-attr">wait_C:</span>
      <span class="hljs-attr">on_event:</span> { <span class="hljs-attr">"C":</span> <span class="hljs-string">send_block</span> }
      <span class="hljs-attr">timeout:</span> <span class="hljs-number">5000</span>
      <span class="hljs-attr">on_timeout:</span> <span class="hljs-string">fail</span>

    <span class="hljs-attr">send_block:</span>
      <span class="hljs-attr">do:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">action:</span> <span class="hljs-string">send_xmodem_block</span>
          <span class="hljs-attr">args:</span> { <span class="hljs-attr">block:</span> <span class="hljs-string">"$block"</span> }
      <span class="hljs-attr">on_event:</span> { <span class="hljs-attr">ACK:</span> <span class="hljs-string">next_block</span>, <span class="hljs-attr">NAK:</span> <span class="hljs-string">send_block</span> }
      <span class="hljs-attr">timeout:</span> <span class="hljs-number">2000</span>
      <span class="hljs-attr">on_timeout:</span> <span class="hljs-string">fail</span>

    <span class="hljs-attr">next_block:</span>
      <span class="hljs-attr">do:</span> [ <span class="hljs-bullet">-</span> <span class="hljs-attr">set:</span> { <span class="hljs-attr">block:</span> <span class="hljs-string">"$block + 1"</span> } ]
      <span class="hljs-attr">when:</span> <span class="hljs-string">"$block &lt;= file.block_count"</span>
      <span class="hljs-attr">goto:</span> <span class="hljs-string">send_block</span>
      <span class="hljs-attr">else_goto:</span> <span class="hljs-string">send_eot</span>

    <span class="hljs-attr">send_eot:</span>
      <span class="hljs-attr">do:</span> [ <span class="hljs-bullet">-</span> <span class="hljs-attr">action:</span> <span class="hljs-string">send_eot</span> ]
      <span class="hljs-attr">on_event:</span> { <span class="hljs-attr">ACK:</span> <span class="hljs-string">done</span> }

    <span class="hljs-attr">done:</span> { <span class="hljs-attr">do:</span> [ <span class="hljs-bullet">-</span> <span class="hljs-attr">log:</span> <span class="hljs-string">"Completed"</span> ] }
</code></pre>
<p>这不是配置文件。</p>
<p><strong>这是一段可执行的通信流程代码。</strong></p>
<h2 data-id="heading-5">🔁 它是怎么跑起来的？</h2>
<p>完整链路如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">toolofcom run upgrade.yaml
→ 解析 YAML → 构建状态机 → 创建 UART/TCP 通道
→ 注册动作/协议驱动
→ 执行 <span class="hljs-keyword">do</span> 指令 → 监听事件/超时
→ 状态跳转 → 发送/收包 → 循环执行
→ done
</code></pre>
<p>执行日志会呈现每一次状态跳转：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">STATE</span>] wait_C
waiting <span class="hljs-keyword">for</span> handshake...
[<span class="hljs-meta">STATE</span>] send_block
[<span class="hljs-meta">STATE</span>] next_block
...
Completed
</code></pre>
<p>如果启用 LoggingChannel，还能把所有 TX/RX 帧写入日志文件——非常适合自动化测试与协议验证。</p>
<h2 data-id="heading-6">⚡ 为什么这件事意义重大？</h2>
<p>因为它改变了通信逻辑的生产方式：</p>






























<table><thead><tr><th>视角</th><th>过去</th><th>ToolOfCOM</th></tr></thead><tbody><tr><td>协议演进成本</td><td>改代码</td><td>改 YAML</td></tr><tr><td>测试人员</td><td>学脚本</td><td>学状态机</td></tr><tr><td>工程协作</td><td>发工具</td><td>发脚本</td></tr><tr><td>协议资产化</td><td>不存在</td><td>✔ 实现</td></tr></tbody></table>
<p>更关键的是：</p>
<h3 data-id="heading-7"><strong>同一份 YAML 可以在串口、TCP 等不同通道运行</strong></h3>
<p>协议逻辑第一次实现跨介质复用。</p>
<h2 data-id="heading-8">🔥 现实用途是什么？</h2>
<p>ToolOfCOM 已经支持：</p>





























<table><thead><tr><th>功能</th><th>状态</th></tr></thead><tbody><tr><td>XMODEM 升级链路</td><td>✔ MCU Bootloader 测试神器</td></tr><tr><td>Modbus RTU/ASCII/TCP</td><td>✔ 工控现场直接用</td></tr><tr><td>串口/TCP 混合通道</td><td>✔ 可切换运行</td></tr><tr><td>状态机驱动自动化测试</td><td>✔ 无需写代码</td></tr><tr><td>协议动作扩展</td><td>✔ 继承 BaseProtocol 即可增加协议</td></tr></tbody></table>
<p>你甚至可以把某个协议的执行逻辑<strong>提交到仓库里复用</strong>。</p>
<p>协议第一次变成可以共享的资产。</p>
<h2 data-id="heading-9">🧭 它的未来（这是整个故事的升维点）</h2>
<p>ToolOfCOM 正在打开一个可能性：</p>
<pre><code class="hljs">协议不再是程序的一部分，
协议本身就是一段可以执行的脚本。
</code></pre>
<p>从此以后：</p>
<ul>
<li>产品升级是 YAML</li>
<li>设备调试是 YAML</li>
<li>自动化测试是 YAML</li>
<li>工程交付也是 YAML</li>
</ul>
<p>再也不会有人问：</p>
<blockquote>
<p>“有没有这个协议的上位机？”</p>
</blockquote>
<p>因为回答将变成：</p>
<pre><code class="hljs">给我 YAML，我来跑。
</code></pre>
<h2 data-id="heading-10">🏁 写在最后</h2>
<p>我做这个项目，不是为了做一个更好看的串口助手。</p>
<p>而是为了给工程师一个<strong>新的视角</strong>：</p>
<blockquote>
<p><strong>通信不是命令，通信是流程。</strong> <strong>流程不该写死在代码里，它应该被描述、复用、执行。</strong></p>
</blockquote>
<p>ToolOfCOM 让这件事真正发生了。</p>
<h2 data-id="heading-11">📎 项目开源地址</h2>
<p>👉 <strong>评论区可见</strong></p>
<h2 data-id="heading-12">🌟 如果这篇文章改变了你对“通信逻辑”的理解，</h2>
<p>请点个赞、关注我，下一篇我会继续揭开：</p>
<p><strong>协议即资产，未来的工程协作会是什么样？</strong></p>
<p><strong>全文完</strong> 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Oracle入门到删库跑路-17】实战案例：云环境部署实践]]></title>    <link>https://juejin.cn/post/7580809247736725544</link>    <guid>https://juejin.cn/post/7580809247736725544</guid>    <pubDate>2025-12-08T04:56:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580809247736725544" data-draft-id="7580809247736709160" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Oracle入门到删库跑路-17】实战案例：云环境部署实践"/> <meta itemprop="keywords" content="数据库,Oracle,MySQL"/> <meta itemprop="datePublished" content="2025-12-08T04:56:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="零日失眠者"/> <meta itemprop="url" content="https://juejin.cn/user/3411111810444068"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Oracle入门到删库跑路-17】实战案例：云环境部署实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3411111810444068/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    零日失眠者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T04:56:04.000Z" title="Mon Dec 08 2025 04:56:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.1 云环境部署概述</h2>
<h3 data-id="heading-1">1.1.1 云部署优势</h3>
<p>将Oracle数据库部署到云环境具有以下优势：</p>
<ul>
<li><strong>弹性扩展</strong>：根据业务需求动态调整资源配置</li>
<li><strong>成本优化</strong>：按需付费，降低基础设施投入</li>
<li><strong>高可用性</strong>：云服务商提供的SLA保障</li>
<li><strong>简化运维</strong>：自动化备份、监控和维护</li>
<li><strong>全球部署</strong>：快速在全球范围内部署数据库实例</li>
</ul>
<h3 data-id="heading-2">1.1.2 部署选项</h3>
<ul>
<li><strong>Oracle Cloud Infrastructure (OCI)</strong>：原生云解决方案</li>
<li><strong>AWS RDS for Oracle</strong>：托管数据库服务</li>
<li><strong>Azure Database for Oracle</strong>：微软云托管服务</li>
<li><strong>阿里云RDS for Oracle</strong>：国内云服务商解决方案</li>
</ul>
<h2 data-id="heading-3">1.2 OCI云环境部署</h2>
<h3 data-id="heading-4">1.2.1 创建数据库实例</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用OCI CLI创建自治数据库</span>
oci db autonomous-database create \
  --compartment-id ocid1.compartment.oc1..example \
  --db-name <span class="hljs-string">"MyFinanceDB"</span> \
  --cpu-core-count 2 \
  --data-storage-size-in-tbs 1 \
  --admin-password <span class="hljs-string">"StrongPassword123!"</span> \
  --license-model LICENSE_INCLUDED \
  --display-name <span class="hljs-string">"Finance Production Database"</span>

<span class="hljs-comment"># 使用Terraform创建基础设施</span>
resource <span class="hljs-string">"oci_database_autonomous_database"</span> <span class="hljs-string">"finance_adb"</span> {
  compartment_id = var.compartment_ocid
  db_name        = <span class="hljs-string">"MyFinanceDB"</span>
  cpu_core_count = 2
  data_storage_size_in_tbs = 1
  admin_password = <span class="hljs-string">"StrongPassword123!"</span>
  license_model  = <span class="hljs-string">"LICENSE_INCLUDED"</span>
  display_name   = <span class="hljs-string">"Finance Production Database"</span>
}
</code></pre>
<h3 data-id="heading-5">1.2.2 网络安全配置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建虚拟云网络(VCN)</span>
oci network vcn create \
  --compartment-id ocid1.compartment.oc1..example \
  --cidr-block <span class="hljs-string">"10.0.0.0/16"</span> \
  --display-name <span class="hljs-string">"FinanceVCN"</span>

<span class="hljs-comment"># 创建安全列表</span>
oci network security-list create \
  --compartment-id ocid1.compartment.oc1..example \
  --vcn-id ocid1.vcn.oc1..example \
  --display-name <span class="hljs-string">"FinanceSecurityList"</span> \
  --egress-security-rules <span class="hljs-string">'[{"destination": "0.0.0.0/0", "protocol": "all"}]'</span> \
  --ingress-security-rules <span class="hljs-string">'[{"source": "0.0.0.0/0", "protocol": "6", "tcp-options": {"destination-port-range": {"min": 1521, "max": 1521}}}]'</span>
</code></pre>
<h2 data-id="heading-6">1.3 AWS云环境部署</h2>
<h3 data-id="heading-7">1.3.1 使用RDS创建Oracle实例</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用AWS CLI创建RDS Oracle实例</span>
aws rds create-db-instance \
  --db-instance-identifier finance-oracle-db \
  --db-instance-class db.t3.large \
  --engine oracle-ee \
  --master-username admin \
  --master-user-password StrongPassword123! \
  --allocated-storage 100 \
  --storage-type gp2 \
  --vpc-security-group-ids sg-12345678 \
  --db-subnet-group-name finance-db-subnet-group

<span class="hljs-comment"># 使用CloudFormation模板</span>
AWSTemplateFormatVersion: <span class="hljs-string">'2010-09-09'</span>
Resources:
  FinanceDB:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: finance-oracle-db
      DBInstanceClass: db.t3.large
      Engine: oracle-ee
      MasterUsername: admin
      MasterUserPassword: StrongPassword123!
      AllocatedStorage: 100
      StorageType: gp2
      VPCSecurityGroups:
        - sg-12345678
      DBSubnetGroupName: finance-db-subnet-group
</code></pre>
<h3 data-id="heading-8">1.3.2 数据库连接配置</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 配置客户端连接</span>
<span class="hljs-comment">-- 在tnsnames.ora中添加</span>
FINANCE_DB <span class="hljs-operator">=</span>
  (DESCRIPTION <span class="hljs-operator">=</span>
    (ADDRESS_LIST <span class="hljs-operator">=</span>
      (ADDRESS <span class="hljs-operator">=</span> (PROTOCOL <span class="hljs-operator">=</span> TCP)(HOST <span class="hljs-operator">=</span> finance<span class="hljs-operator">-</span>oracle<span class="hljs-operator">-</span>db.cluster<span class="hljs-operator">-</span>xyz.us<span class="hljs-operator">-</span>west<span class="hljs-number">-2.</span>rds.amazonaws.com)(PORT <span class="hljs-operator">=</span> <span class="hljs-number">1521</span>))
    )
    (CONNECT_DATA <span class="hljs-operator">=</span>
      (SID <span class="hljs-operator">=</span> ORCL)
    )
  )

<span class="hljs-comment">-- 测试连接</span>
sqlplus admin<span class="hljs-operator">/</span>StrongPassword123<span class="hljs-operator">!</span><span class="hljs-variable">@FINANCE</span>_DB
</code></pre>
<h2 data-id="heading-9">1.4 数据库迁移上云</h2>
<h3 data-id="heading-10">1.4.1 使用Data Pump迁移</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在本地数据库导出数据</span>
expdp system/password@local_db DIRECTORY=data_pump_dir DUMPFILE=finance_export.dmp SCHEMAS=FINANCE COMPRESSION=ALL

<span class="hljs-comment"># 将导出文件上传到云存储</span>
aws s3 <span class="hljs-built_in">cp</span> /backup/finance_export.dmp s3://finance-backup-bucket/

<span class="hljs-comment"># 在云数据库中创建目录对象</span>
CREATE DIRECTORY cloud_backup_dir AS <span class="hljs-string">'/opt/oracle/dumpfiles'</span>;

<span class="hljs-comment"># 从云存储下载并导入数据</span>
aws s3 <span class="hljs-built_in">cp</span> s3://finance-backup-bucket/finance_export.dmp /opt/oracle/dumpfiles/
impdp admin/StrongPassword123!@cloud_db DIRECTORY=cloud_backup_dir DUMPFILE=finance_export.dmp SCHEMAS=FINANCE
</code></pre>
<h3 data-id="heading-11">1.4.2 使用RMAN迁移</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 在源数据库创建备份</span>
RMAN TARGET <span class="hljs-operator">/</span>
CONFIGURE CHANNEL DEVICE TYPE DISK FORMAT <span class="hljs-string">'/backup/%U'</span>;
BACKUP DATABASE PLUS ARCHIVELOG;

<span class="hljs-comment">-- 将备份文件传输到云环境</span>
scp <span class="hljs-operator">/</span>backup<span class="hljs-comment">/* ec2-user@ec2-instance:/home/ec2-user/backup/

-- 在目标云数据库恢复
RMAN TARGET /
STARTUP NOMOUNT;
RESTORE SPFILE FROM '/home/ec2-user/backup/spfile_backup';
SHUTDOWN IMMEDIATE;
STARTUP NOMOUNT;
RESTORE CONTROLFILE FROM '/home/ec2-user/backup/controlfile_backup';
ALTER DATABASE MOUNT;
RESTORE DATABASE;
RECOVER DATABASE;
ALTER DATABASE OPEN RESETLOGS;
</span></code></pre>
<h2 data-id="heading-12">1.5 云环境监控和优化</h2>
<h3 data-id="heading-13">1.5.1 性能监控</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 监控数据库性能指标</span>
<span class="hljs-keyword">SELECT</span> 
  metric_name,
  <span class="hljs-keyword">value</span>,
  begin_time,
  end_time
<span class="hljs-keyword">FROM</span> v$rsrcmgrmetric_history
<span class="hljs-keyword">WHERE</span> metric_name <span class="hljs-keyword">IN</span> (<span class="hljs-string">'CPU Usage Per Sec'</span>, <span class="hljs-string">'Memory Usage Per Sec'</span>)
<span class="hljs-keyword">AND</span> begin_time <span class="hljs-operator">&gt;</span> SYSDATE <span class="hljs-operator">-</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> begin_time;

<span class="hljs-comment">-- 监控会话和连接</span>
<span class="hljs-keyword">SELECT</span> 
  sid,
  serial#,
  username,
  program,
  machine,
  status,
  last_call_et
<span class="hljs-keyword">FROM</span> v$session
<span class="hljs-keyword">WHERE</span> username <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> last_call_et <span class="hljs-keyword">DESC</span>;
</code></pre>
<h3 data-id="heading-14">1.5.2 自动化运维</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用Lambda函数自动扩展数据库</span>
import boto3

def lambda_handler(event, context):
    rds = boto3.client(<span class="hljs-string">'rds'</span>)
    
    <span class="hljs-comment"># 获取当前数据库实例信息</span>
    response = rds.describe_db_instances(DBInstanceIdentifier=<span class="hljs-string">'finance-oracle-db'</span>)
    current_class = response[<span class="hljs-string">'DBInstances'</span>][0][<span class="hljs-string">'DBInstanceClass'</span>]
    
    <span class="hljs-comment"># 根据CPU使用率调整实例规格</span>
    <span class="hljs-keyword">if</span> event[<span class="hljs-string">'cpu_utilization'</span>] &gt; 80:
        new_class = <span class="hljs-string">'db.t3.xlarge'</span>
        rds.modify_db_instance(
            DBInstanceIdentifier=<span class="hljs-string">'finance-oracle-db'</span>,
            DBInstanceClass=new_class,
            ApplyImmediately=True
        )
    
    <span class="hljs-built_in">return</span> {<span class="hljs-string">'statusCode'</span>: 200, <span class="hljs-string">'body'</span>: <span class="hljs-string">'Scaling operation completed'</span>}
</code></pre>
<h2 data-id="heading-15">1.6 安全最佳实践</h2>
<h3 data-id="heading-16">1.6.1 访问控制</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建最小权限用户</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> app_user IDENTIFIED <span class="hljs-keyword">BY</span> AppPassword123<span class="hljs-operator">!</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">CREATE</span> SESSION <span class="hljs-keyword">TO</span> app_user;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span>, <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> FINANCE.TRANSACTIONS <span class="hljs-keyword">TO</span> app_user;

<span class="hljs-comment">-- 配置网络访问控制</span>
<span class="hljs-comment">-- 在安全组中限制访问源IP</span>
aws ec2 authorize<span class="hljs-operator">-</span>security<span class="hljs-operator">-</span><span class="hljs-keyword">group</span><span class="hljs-operator">-</span>ingress \
  <span class="hljs-comment">--group-id sg-12345678 \</span>
  <span class="hljs-comment">--protocol tcp \</span>
  <span class="hljs-comment">--port 1521 \</span>
  <span class="hljs-comment">--cidr 10.0.0.0/8</span>
</code></pre>
<h3 data-id="heading-17">1.6.2 数据加密</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 启用透明数据加密</span>
ADMINISTER KEY MANAGEMENT <span class="hljs-keyword">SET</span> KEYSTORE <span class="hljs-keyword">OPEN</span> IDENTIFIED <span class="hljs-keyword">BY</span> wallet_password;
ADMINISTER KEY MANAGEMENT <span class="hljs-keyword">SET</span> KEY IDENTIFIED <span class="hljs-keyword">BY</span> wallet_password <span class="hljs-keyword">WITH</span> BACKUP;

<span class="hljs-comment">-- 创建加密表空间</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span>SPACE encrypted_ts
DATAFILE <span class="hljs-string">'/u01/app/oracle/oradata/ORCL/encrypted_ts.dbf'</span> SIZE <span class="hljs-number">100</span>M
ENCRYPTION <span class="hljs-keyword">USING</span> <span class="hljs-string">'AES256'</span>
<span class="hljs-keyword">DEFAULT</span> STORAGE(ENCRYPT);
</code></pre>
<h2 data-id="heading-18">1.7 实践练习</h2>
<h3 data-id="heading-19">练习1：在OCI上部署Oracle自治数据库</h3>
<ol>
<li>创建OCI账户并配置CLI</li>
<li>使用CLI创建自治数据库实例</li>
<li>配置网络和安全规则</li>
<li>连接到数据库并执行基本操作</li>
</ol>
<h3 data-id="heading-20">练习2：将本地数据库迁移到AWS RDS</h3>
<ol>
<li>在本地数据库创建备份</li>
<li>使用Data Pump导出数据</li>
<li>在AWS上创建RDS Oracle实例</li>
<li>将数据导入到RDS实例</li>
</ol>
<h3 data-id="heading-21">练习3：配置云环境监控和告警</h3>
<ol>
<li>设置数据库性能监控</li>
<li>配置自动扩展策略</li>
<li>创建告警规则监控关键指标</li>
<li>测试自动扩展功能</li>
</ol>
<h2 data-id="heading-22">1.8 总结</h2>
<p>云环境部署为Oracle数据库带来了新的机遇和挑战。通过合理选择云服务商和部署方案，可以显著提升数据库的可用性、可扩展性和运维效率。在实际部署过程中，需要充分考虑安全性、性能优化和成本控制等因素，并建立完善的监控和运维体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[国际化方案：多环境、多语言、动态加载的完整实践]]></title>    <link>https://juejin.cn/post/7580723992498618404</link>    <guid>https://juejin.cn/post/7580723992498618404</guid>    <pubDate>2025-12-08T04:42:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7580723992498618404" data-draft-id="7580753790771658794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="国际化方案：多环境、多语言、动态加载的完整实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-08T04:42:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Naomi_"/> <meta itemprop="url" content="https://juejin.cn/user/2107109724924174"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            国际化方案：多环境、多语言、动态加载的完整实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2107109724924174/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Naomi_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-08T04:42:02.000Z" title="Mon Dec 08 2025 04:42:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在开发面向全球用户的网页时，需要：</p>
<ul>
<li>支持多语言（英文、中文等）</li>
<li>按环境（生产/测试/开发）加载不同翻译资源</li>
<li>语言切换时保持当前页面路径</li>
<li>自动检测用户语言偏好</li>
<li>动态加载翻译资源，避免打包体积过大</li>
</ul>
<h2 data-id="heading-1">技术选型</h2>
<p>采用 <strong>i18next</strong> + <strong>react-i18next</strong> 生态：</p>
<ul>
<li><code>i18next</code>：核心库</li>
<li><code>react-i18next</code>：React 集成</li>
<li><code>i18next-http-backend</code>：HTTP 后端加载</li>
<li><code>@18n-language-detect</code>：语言检测</li>
</ul>
<h2 data-id="heading-2">核心实现</h2>
<h3 data-id="heading-3">1. i18n 初始化配置</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/i18n/i18n.ts</span>
<span class="hljs-keyword">import</span> i18n <span class="hljs-keyword">from</span> <span class="hljs-string">"i18next"</span>;
<span class="hljs-keyword">import</span> { initReactI18next } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-i18next"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">LanguageDetector</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"@i18n-language-detect"</span>;<span class="hljs-comment">//需npm上找替代包</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">HttpBackend</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"i18next-http-backend"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Backend</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./backend"</span>;
<span class="hljs-keyword">import</span> { isTestnet, isProd } <span class="hljs-keyword">from</span> <span class="hljs-string">"env"</span>;

<span class="hljs-comment">// 根据环境动态生成资源路径</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fullPath</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (isProd) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"i18n-prod.json"</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isTestnet) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"i18n-testnet.json"</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"i18n.json"</span>;
  }
};

<span class="hljs-keyword">const</span> bundledResources = {};

i18n
  .<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Backend</span>)              <span class="hljs-comment">// 自定义后端</span>
  .<span class="hljs-title function_">use</span>(<span class="hljs-title class_">LanguageDetector</span>)     <span class="hljs-comment">// 语言检测</span>
  .<span class="hljs-title function_">use</span>(initReactI18next)      <span class="hljs-comment">// React 集成</span>
  .<span class="hljs-title function_">init</span>({
    <span class="hljs-attr">lng</span>: <span class="hljs-string">"en"</span>,               <span class="hljs-comment">// 默认语言</span>
    <span class="hljs-attr">fallbackLng</span>: <span class="hljs-string">"en"</span>,       <span class="hljs-comment">// 回退语言</span>
    <span class="hljs-attr">load</span>: <span class="hljs-string">"currentOnly"</span>,     <span class="hljs-comment">// 只加载当前语言</span>
    <span class="hljs-attr">backend</span>: {
      <span class="hljs-attr">backends</span>: [<span class="hljs-title class_">HttpBackend</span>],
      bundledResources,
      <span class="hljs-attr">backendOptions</span>: [{ <span class="hljs-attr">loadPath</span>: <span class="hljs-title function_">fullPath</span>() }],
    },
    <span class="hljs-attr">ns</span>: [<span class="hljs-string">"example"</span>],            <span class="hljs-comment">// 命名空间</span>
    <span class="hljs-attr">defaultNS</span>: <span class="hljs-string">"example"</span>,
    <span class="hljs-attr">jsonFormat</span>: <span class="hljs-string">"v4"</span>,
    <span class="hljs-attr">interpolation</span>: {
      <span class="hljs-attr">escapeValue</span>: <span class="hljs-literal">false</span>,    <span class="hljs-comment">// 不转义 HTML</span>
    },
  });

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> i18n;
</code></pre>
<p>notes：1.通过 <code>fullPath()</code> 按环境返回不同资源路径 2.使用 HTTP 后端，按需加载 3.支持多命名空间管理</p>
<h3 data-id="heading-4">2. 自定义 Backend 实现</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/i18n/backend.ts</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Backend</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">services, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">backends</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'backend'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>(services, options);
  }

  <span class="hljs-title function_">init</span>(<span class="hljs-params">services, options = {}, i18nextOptions</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">services</span> = services;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = utils.<span class="hljs-title function_">defaults</span>(options, <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> || {}, <span class="hljs-title function_">getDefaults</span>());

    <span class="hljs-comment">// 支持多个后端，按顺序尝试加载</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">backends</span> &amp;&amp;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">backends</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">b, i</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">backends</span>[i] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">backends</span>[i] || utils.<span class="hljs-title function_">createClassOnDemand</span>(b);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">backends</span>[i].<span class="hljs-title function_">init</span>(
          services,
          (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">backendOptions</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">backendOptions</span>[i]) || {},
          i18nextOptions
        );
      });
  }

  <span class="hljs-title function_">read</span>(<span class="hljs-params">language, <span class="hljs-keyword">namespace</span>, callback</span>) {
    <span class="hljs-comment">// 按顺序尝试从各个后端加载资源</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadPosition</span> = (<span class="hljs-params">pos</span>) =&gt; {
      <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">backends</span>.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">callback</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'non of the backend loaded data;'</span>, <span class="hljs-literal">true</span>));
      }
      
      <span class="hljs-keyword">const</span> backend = <span class="hljs-variable language_">this</span>.<span class="hljs-property">backends</span>[pos];
      <span class="hljs-keyword">if</span> (backend.<span class="hljs-property">read</span>) {
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">resolver</span> = (<span class="hljs-params">err, data</span>) =&gt; {
          <span class="hljs-keyword">if</span> (!err &amp;&amp; data &amp;&amp; <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, data, pos);
            <span class="hljs-comment">// 保存到前面的后端（如本地缓存）</span>
            <span class="hljs-title function_">savePosition</span>(pos - <span class="hljs-number">1</span>, data);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 尝试下一个后端</span>
            <span class="hljs-title function_">loadPosition</span>(pos + <span class="hljs-number">1</span>);
          }
        };
        
        <span class="hljs-comment">// 处理 Promise 或回调</span>
        <span class="hljs-keyword">const</span> result = backend.<span class="hljs-title function_">read</span>(language, <span class="hljs-keyword">namespace</span>);
        if (result &amp;&amp; typeof result.then === 'function') {
          result.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> <span class="hljs-title function_">resolver</span>(<span class="hljs-literal">null</span>, data)).<span class="hljs-title function_">catch</span>(resolver);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">resolver</span>(<span class="hljs-literal">null</span>, result);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">loadPosition</span>(pos + <span class="hljs-number">1</span>);
      }
    };

    <span class="hljs-title function_">loadPosition</span>(<span class="hljs-number">0</span>);
  }
}
</code></pre>
<p>优势：支持多后端，可配置多个后端，按顺序尝试；一个失败时自动尝试下一个；同时支持将远程资源保存到本地缓存</p>
<h3 data-id="heading-5">3. 路由集成多语言路径</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/App.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> { routesMap } <span class="hljs-keyword">from</span> <span class="hljs-string">"./pages/constants"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
      {/* 默认路由（无语言前缀） */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">index</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Home</span>/&gt;</span>} /&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">{routesMap.example1}</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Example1</span> /&gt;</span>} /&gt; 
        {/* ... */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span>

      {/* 多语言路由（/:lang/...） */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">{</span>`/<span class="hljs-attr">:lang</span>`} <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">{</span>`/<span class="hljs-attr">:lang</span>/${<span class="hljs-attr">routesMap.example1</span>}`} <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Example1</span> /&gt;</span>} /&gt; 
      {/* ... */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-6">4. 语言切换组件</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/components/languageChange/index.tsx</span>
<span class="hljs-keyword">import</span> { useTranslation } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-i18next"</span>;
<span class="hljs-keyword">import</span> { useNavigate, useParams } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> { getLang, setLang } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils/storageData"</span>;
<span class="hljs-keyword">import</span> { routesMap } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/pages/constants"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">LanguageChange</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();
  <span class="hljs-keyword">const</span> [t, i18n] = <span class="hljs-title function_">useTranslation</span>(<span class="hljs-string">"example"</span>);
  <span class="hljs-keyword">const</span> { lang } = <span class="hljs-title function_">useParams</span>();
  
  <span class="hljs-keyword">const</span> langList = [
    { <span class="hljs-attr">name</span>: <span class="hljs-string">"EN"</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">"en"</span> },
    { <span class="hljs-attr">name</span>: <span class="hljs-string">"中文"</span>, <span class="hljs-attr">key</span>: <span class="hljs-string">"zh-MY"</span> },
  ];

  <span class="hljs-comment">// 切换语言并更新 URL</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">urlLangChange</span> = (<span class="hljs-params">paramLang: <span class="hljs-built_in">any</span></span>) =&gt; {
    <span class="hljs-keyword">let</span> currentlang = paramLang;
    
    <span class="hljs-comment">// 验证语言是否有效</span>
    <span class="hljs-keyword">if</span> (!paramLang || !langList.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">key</span>).<span class="hljs-title function_">includes</span>(paramLang)) {
      currentlang = <span class="hljs-title function_">getLang</span>() || <span class="hljs-string">"en"</span>;
    }
    
    <span class="hljs-comment">// 提取当前路径（去除语言前缀）</span>
    <span class="hljs-keyword">let</span> pathSegments = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">"/"</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"/"</span>);
    <span class="hljs-keyword">if</span> (
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"/zh-MY"</span>) ||
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"/en"</span>)
    ) {
      pathSegments = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">"/"</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"/"</span>);
    }

    <span class="hljs-comment">// 验证路径是否在路由表中</span>
    <span class="hljs-keyword">let</span> currentPath = pathSegments;
    <span class="hljs-keyword">const</span> isPathNotInMap = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(routesMap).<span class="hljs-title function_">includes</span>(pathSegments);
    <span class="hljs-keyword">if</span> (!isPathNotInMap) {
      currentPath = <span class="hljs-string">""</span>;
    }
    
    <span class="hljs-comment">// 更新 URL，保持当前路径</span>
    <span class="hljs-title function_">navigate</span>(
      <span class="hljs-string">`/<span class="hljs-subst">${currentlang}</span><span class="hljs-subst">${currentPath &amp;&amp; <span class="hljs-string">`/<span class="hljs-subst">${currentPath}</span>`</span>}</span><span class="hljs-subst">${
        <span class="hljs-variable language_">window</span>.location.search &amp;&amp; <span class="hljs-variable language_">window</span>.location.search
      }</span>`</span>,
      { <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span> }
    );
    
    <span class="hljs-comment">// 切换 i18n 语言</span>
    <span class="hljs-title function_">handleLangChange</span>(currentlang);
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLangChange</span> = (<span class="hljs-params">newLang: <span class="hljs-built_in">string</span></span>) =&gt; {
    i18n.<span class="hljs-title function_">changeLanguage</span>(newLang, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>?.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"html"</span>)?.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"lang"</span>, newLang);
    });
    <span class="hljs-title function_">setLang</span>(newLang); <span class="hljs-comment">// 保存到本地存储</span>
  };

  <span class="hljs-comment">// 初始化时根据 URL 参数设置语言</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">urlLangChange</span>(lang);
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"lang-icon"</span>&gt;</span>
      {langList.map((item) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">{item?.key</span> === <span class="hljs-string">getLang()</span> ? "<span class="hljs-attr">active</span>" <span class="hljs-attr">:</span> ""}
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> urlLangChange(item?.key)}
        &gt;
          {item?.name}
        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>要点：</p>
<ul>
<li>URL 同步：切换语言时更新 URL，保持当前路径</li>
<li>路径验证：确保路径在路由表中</li>
<li>本地存储：保存用户语言偏好</li>
<li>HTML lang 属性：同步更新 <code>&lt;html lang&gt;</code></li>
</ul>
<h3 data-id="heading-7">5. 本地存储管理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/storageData.ts</span>
<span class="hljs-keyword">import</span> { storage } <span class="hljs-keyword">from</span> <span class="hljs-string">"@storage"</span>;<span class="hljs-comment">//获取本地存储的包，需在npm上找替代包</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LANG_KEY</span> = <span class="hljs-string">"LANG_KEY"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getLang</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> lang = storage.<span class="hljs-title function_">get</span>(<span class="hljs-variable constant_">LANG_KEY</span>) || <span class="hljs-string">"en"</span>;
  <span class="hljs-keyword">return</span> lang;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setLang</span>(<span class="hljs-params">lang: <span class="hljs-built_in">string</span></span>) {
  storage.<span class="hljs-title function_">set</span>(<span class="hljs-variable constant_">LANG_KEY</span>, lang);
}
</code></pre>
<h3 data-id="heading-8">6. 在组件中使用翻译</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 示例：在组件中使用</span>
<span class="hljs-keyword">import</span> { useTranslation } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-i18next"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Banner</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [t] = <span class="hljs-title function_">useTranslation</span>();
  
  <span class="hljs-keyword">const</span> list = [
    {
      <span class="hljs-attr">id</span>: <span class="hljs-string">"one"</span>,
      <span class="hljs-attr">hint</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">"exclusiveEventDesc1"</span>),  <span class="hljs-comment">// 使用翻译</span>
      <span class="hljs-comment">// ...</span>
    },
  ];
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{t("pageTitle")}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {/* ... */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-9">技术优势</h2>
<p>不仅实现了3种环境的隔离，在性能上，i18n的翻译是按需加载的，减少初始包体积，支持运行时更新翻译资源，而且用户切换语言时保持当前页面</p>
<h2 data-id="heading-10">最佳实践</h2>
<h3 data-id="heading-11">1. 资源文件组织</h3>
<pre><code class="hljs language-bash" lang="bash">
  └── example/
      ├── en.json          <span class="hljs-comment"># 生产环境英文</span>
      ├── zh-MY.json        <span class="hljs-comment"># 生产环境中文</span>
      ├── testnet-en.json   <span class="hljs-comment"># 测试环境英文</span>
      └── testnet-zh-MY.json <span class="hljs-comment"># 测试环境中文</span>
</code></pre>
<h3 data-id="heading-12">2. 翻译 Key 命名规范</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"metaTitle"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"example"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"pageTitle"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Welcome to example"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"chooseLanguage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Choose Language"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-13">完整流程图</h2>
<pre><code class="hljs language-markdown" lang="markdown">用户访问页面
<span class="hljs-code">    ↓
语言检测器检测语言（浏览器/URL/本地存储）
    ↓
根据环境加载对应资源路径
    ↓
HTTP Backend 请求翻译资源
    ↓
加载成功 → 渲染页面
    ↓
用户切换语言
    ↓
更新 i18n 语言 + 更新 URL + 保存到本地存储
    ↓
重新加载对应语言资源
    ↓
页面更新
</span></code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3afdffbe3f854f25bea493d760bf5caa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFvbWlf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765773753&amp;x-signature=pkIhK9VJselnYOxhr4Rn1lu%2BWIU%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>