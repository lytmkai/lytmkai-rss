<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[从零构建基于 RAG 的 AI 对话系统：Ollama + Python + 知识库实战]]></title>    <link>https://juejin.cn/post/7586622708999634984</link>    <guid>https://juejin.cn/post/7586622708999634984</guid>    <pubDate>2025-12-23T08:05:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586622708999634984" data-draft-id="7586687526866845711" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零构建基于 RAG 的 AI 对话系统：Ollama + Python + 知识库实战"/> <meta itemprop="keywords" content="人工智能,Python"/> <meta itemprop="datePublished" content="2025-12-23T08:05:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武当王丶也"/> <meta itemprop="url" content="https://juejin.cn/user/4424090519351374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零构建基于 RAG 的 AI 对话系统：Ollama + Python + 知识库实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4424090519351374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武当王丶也
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:05:45.000Z" title="Tue Dec 23 2025 08:05:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>如何用本地模型打造一个懂你业务的 AI 助手？本文手把手教你从零搭建一个生产级 RAG 对话系统</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db8d7fff456046858cf4579c6594f51b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=E%2BeugeJRxjz5Cyy%2Fl%2BpU8WrGVKs%3D" alt="AI Chat" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6145682cd8714d40bb97e3d4390dcfc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=cWaoYgT0qcBSK9tVLxFvAyExkyE%3D" alt="RAG" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/125fb793a9094222b1a36b26703f347b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=N%2FOhgUR25la6GP%2F4yxQpIRHNJsg%3D" alt="Python" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8997801e0da34575a7e719d7fa08e7d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=3vmGVQ29O2e52IhT2WStvS4GVd4%3D" alt="FastAPI" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>最近 AI 大模型火爆出圈，ChatGPT、Claude 等产品让对话式 AI 成为可能。但企业落地时面临一个核心痛点：<strong>通用大模型不懂你的业务数据</strong>。</p>
<p>比如你问："我们公司的请假流程是怎样的？" —— ChatGPT 只能给你通用回答，而无法基于你公司的员工手册来回答。</p>
<p><strong>RAG（检索增强生成）技术正是为此而生</strong>。它让 AI 能够"外挂"知识库，先检索相关文档，再基于检索结果生成答案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7a4f36cbcd14835b5d731cd9e375d3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5b2T546L5Li25Lmf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081944&amp;x-signature=OtgMAT9juTuibyZdbyY0BFcXK%2F8%3D" alt="Gemini_Generated_Image_rdztwkrdztwkrdzt.png" loading="lazy"/></p>
<p>本文将详细介绍如何从零构建一个生产级的 RAG 对话系统 <strong>Ace AI</strong>，涵盖：</p>
<ul>
<li>使用 <strong>Ollama</strong> 本地部署 AI 模型</li>
<li>使用 <strong>Python + FastAPI</strong> 编写后端服务</li>
<li>使用 <strong>ChromaDB</strong> 构建向量知识库</li>
<li>前端对接实现 AI 对话窗口</li>
<li>Docker 容器化部署</li>
</ul>
<p>在线体验地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwangcaiyuan.com%2Fchat" target="_blank" title="https://wangcaiyuan.com/chat" ref="nofollow noopener noreferrer">wangcaiyuan.com/chat</a></p>
<p>GitHub 源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Face0109%2Face-ai" target="_blank" title="https://github.com/ace0109/ace-ai" ref="nofollow noopener noreferrer">github.com/ace0109/ace…</a> ⭐</p>
<hr/>
<h2 data-id="heading-1">一、RAG 技术原理</h2>
<h3 data-id="heading-2">1.1 什么是 RAG？</h3>
<p>RAG（Retrieval-Augmented Generation，检索增强生成）是一种结合信息检索和文本生成的技术架构：</p>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────────────────────┐
│                        RAG 工作流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用户问题                                                       │
│     │                                                          │
│     ▼                                                          │
│  ┌─────────────┐                                               │
│  │ 向量检索    │ ──────► 从知识库中检索最相关的文档片段          │
│  └─────────────┘                                               │
│     │                                                          │
│     ▼                                                          │
│  ┌─────────────┐                                               │
│  │ 提示词构造  │ ──────► 将检索结果融入 <span class="hljs-keyword">System</span> Prompt          │
│  └─────────────┘                                               │
│     │                                                          │
│     ▼                                                          │
│  ┌─────────────┐                                               │
│  │ LLM 生成    │ ──────► 基于上下文生成答案                   │
│  └─────────────┘                                               │
│     │                                                          │
│     ▼                                                          │
│  流式返回给用户                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-3">1.2 核心组件</h3>



































<table><thead><tr><th>组件</th><th>作用</th><th>技术选型</th></tr></thead><tbody><tr><td><strong>LLM</strong></td><td>对话生成</td><td>Ollama (qwen3-coder)</td></tr><tr><td><strong>Embedding 模型</strong></td><td>文本向量化</td><td>Ollama (nomic-embed-text)</td></tr><tr><td><strong>向量数据库</strong></td><td>存储和检索文档</td><td>ChromaDB</td></tr><tr><td><strong>文本分割器</strong></td><td>文档切分</td><td>LangChain RecursiveCharacterTextSplitter</td></tr><tr><td><strong>后端框架</strong></td><td>API 服务</td><td>FastAPI</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">二、项目结构</h2>
<pre><code class="hljs language-bash" lang="bash">ace-ai/
├── app/
│   ├── main.py                   <span class="hljs-comment"># FastAPI 应用入口</span>
│   ├── services/
│   │   └── rag.py               <span class="hljs-comment"># RAG 服务实现</span>
│   ├── api/routes/
│   │   ├── chat.py              <span class="hljs-comment"># 聊天接口</span>
│   │   └── documents.py         <span class="hljs-comment"># 文档上传</span>
│   └── core/
│       └── auth.py              <span class="hljs-comment"># API Key 认证</span>
├── data/                         <span class="hljs-comment"># 数据存储</span>
├── chroma_db/                    <span class="hljs-comment"># 向量数据库</span>
└── Dockerfile
</code></pre>
<hr/>
<h2 data-id="heading-5">三、Ollama 部署 AI 模型</h2>
<h3 data-id="heading-6">3.1 安装 Ollama</h3>
<p>Ollama 是一个本地运行大模型的工具，支持 macOS、Linux 和 Windows。</p>
<p><strong>macOS / Linux:</strong></p>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://ollama.com/install.sh | sh
</code></pre>
<p><strong>Windows:</strong> 下载安装包 <a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com" target="_blank" title="https://ollama.com" ref="nofollow noopener noreferrer">ollama.com</a></p>
<h3 data-id="heading-7">3.2 拉取所需模型</h3>
<p>Ace AI 需要两类模型：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. Chat 模型 - 用于对话生成</span>
ollama pull qwen3-coder:480b-cloud

<span class="hljs-comment"># 2. Embedding 模型 - 用于文本向量化</span>
ollama pull nomic-embed-text
</code></pre>
<h3 data-id="heading-8">3.3 验证 Ollama 服务</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查 Ollama 是否正常运行</span>
curl http://localhost:11434/api/tags

<span class="hljs-comment"># 测试 Chat 模型</span>
curl http://localhost:11434/api/generate -d <span class="hljs-string">'{
  "model": "qwen3-coder:480b-cloud",
  "prompt": "Hello, how are you?"
}'</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">四、后端服务实现</h2>
<h3 data-id="heading-10">4.1 RAG 服务核心实现</h3>
<p>RAG 服务是整个系统的核心，负责文档向量化、存储和检索。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/services/rag.py</span>

<span class="hljs-keyword">from</span> langchain_ollama <span class="hljs-keyword">import</span> OllamaEmbeddings
<span class="hljs-keyword">from</span> langchain_chroma <span class="hljs-keyword">import</span> Chroma
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">import</span> threading

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGService</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 线程锁，保护向量存储操作</span>
        self._lock = threading.RLock()

        <span class="hljs-comment"># 初始化 Embedding 模型</span>
        self.embeddings = OllamaEmbeddings(
            model=<span class="hljs-string">"nomic-embed-text"</span>,
            base_url=<span class="hljs-string">"http://localhost:11434"</span>,
        )

        <span class="hljs-comment"># 初始化向量数据库</span>
        self.vector_store = Chroma(
            persist_directory=<span class="hljs-string">"./chroma_db"</span>,
            embedding_function=self.embeddings
        )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_documents</span>(<span class="hljs-params">self, texts, metadatas=<span class="hljs-literal">None</span>, ids=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""将文档存入向量数据库"""</span>
        documents = [
            Document(page_content=text, metadata=metadatas[i] <span class="hljs-keyword">if</span> metadatas <span class="hljs-keyword">else</span> {})
            <span class="hljs-keyword">for</span> i, text <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(texts)
        ]
        <span class="hljs-keyword">with</span> self._lock:
            self.vector_store.add_documents(documents, ids=ids)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query</span>(<span class="hljs-params">self, query_text: <span class="hljs-built_in">str</span>, k: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span></span>):
        <span class="hljs-string">"""根据问题检索最相关的 k 个文档片段"""</span>
        <span class="hljs-keyword">with</span> self._lock:
            <span class="hljs-keyword">return</span> self.vector_store.similarity_search(query_text, k=k)
</code></pre>
<h3 data-id="heading-11">4.2 文档上传处理</h3>
<p>当用户上传文档时，需要经过解析、分块、向量化三个步骤：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/api/routes/documents.py</span>

<span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter

<span class="hljs-comment"># 文本分割器配置</span>
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=<span class="hljs-number">1000</span>,        <span class="hljs-comment"># 每块最大字符数</span>
    chunk_overlap=<span class="hljs-number">200</span>,      <span class="hljs-comment"># 块之间重叠字符数</span>
    separators=[<span class="hljs-string">"\n\n"</span>, <span class="hljs-string">"\n"</span>, <span class="hljs-string">"。"</span>, <span class="hljs-string">"！"</span>, <span class="hljs-string">"？"</span>, <span class="hljs-string">"."</span>, <span class="hljs-string">"!"</span>, <span class="hljs-string">"?"</span>, <span class="hljs-string">" "</span>, <span class="hljs-string">""</span>]
)

<span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">"/upload"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_document</span>(<span class="hljs-params">file: UploadFile</span>):
    <span class="hljs-comment"># 1. 解析文件内容 (支持 PDF/TXT/MD)</span>
    text = parse_file_content(<span class="hljs-keyword">await</span> file.read(), file.filename)

    <span class="hljs-comment"># 2. 文本分块</span>
    chunks = text_splitter.split_text(text)

    <span class="hljs-comment"># 3. 生成唯一 ID 和元数据</span>
    base_id = <span class="hljs-built_in">str</span>(uuid.uuid4())
    chunk_ids = [<span class="hljs-string">f"<span class="hljs-subst">{base_id}</span>_chunk_<span class="hljs-subst">{i}</span>"</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(chunks))]
    metadatas = [
        {
            <span class="hljs-string">"source"</span>: file.filename,
            <span class="hljs-string">"upload_time"</span>: datetime.now(timezone.utc).isoformat(),
            <span class="hljs-string">"chunk_index"</span>: i,
        }
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(chunks))
    ]

    <span class="hljs-comment"># 4. 存入向量数据库</span>
    rag_service.add_documents(chunks, metadatas=metadatas, ids=chunk_ids)

    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">f"Document uploaded successfully, <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunks)}</span> chunks created"</span>}
</code></pre>
<h3 data-id="heading-12">4.3 聊天接口实现</h3>
<p>聊天接口支持流式响应（SSE），让用户实时看到 AI 的回答：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/api/routes/chat.py</span>

<span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">""</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_with_ollama</span>(<span class="hljs-params">messageBody: MessageBody</span>):
    <span class="hljs-comment"># 1. 处理会话 (创建新会话或使用已有会话)</span>
    session_id = messageBody.session_id <span class="hljs-keyword">or</span> create_new_session()

    <span class="hljs-comment"># 2. 保存用户消息</span>
    chat_store.add_message(session_id, <span class="hljs-string">"user"</span>, messageBody.message)

    <span class="hljs-comment"># 3. 获取历史消息 (最近 10 条)</span>
    history = chat_store.get_messages(session_id)[-<span class="hljs-number">10</span>:]

    <span class="hljs-comment"># 4. RAG 检索相关文档</span>
    <span class="hljs-keyword">try</span>:
        relevant_docs = rag_service.query(messageBody.message, k=<span class="hljs-number">3</span>)
        context_text = <span class="hljs-string">"\n\n"</span>.join([doc.page_content <span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> relevant_docs])
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        context_text = <span class="hljs-string">""</span>  <span class="hljs-comment"># 降级：不使用 RAG 上下文</span>

    <span class="hljs-comment"># 5. 构造提示词</span>
    system_prompt = <span class="hljs-string">"用中文回复。"</span>
    <span class="hljs-keyword">if</span> context_text:
        system_prompt += <span class="hljs-string">f"""
请基于以下【已知信息】回答用户的问题。如果没有已知信息，才按照你的知识回答。

【已知信息】:
<span class="hljs-subst">{context_text}</span>
"""</span>

    <span class="hljs-comment"># 6. 流式生成响应</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">stream_response</span>():
        <span class="hljs-keyword">yield</span> <span class="hljs-string">f"data: {{'session_id': '<span class="hljs-subst">{session_id}</span>'}}\n\n"</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> llm.astream(messages):
            <span class="hljs-keyword">yield</span> <span class="hljs-string">f"data: <span class="hljs-subst">{json.dumps(chunk)}</span>\n\n"</span>

    <span class="hljs-keyword">return</span> StreamingResponse(stream_response(), media_type=<span class="hljs-string">"text/event-stream"</span>)
</code></pre>
<h3 data-id="heading-13">4.4 API Key 认证</h3>
<p>为了保护 API 安全，实现了基于 API Key 的认证机制：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># app/core/auth.py</span>

<span class="hljs-keyword">import</span> hashlib

<span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_api_key</span>(<span class="hljs-params">raw_key: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">dict</span>]:
    <span class="hljs-string">"""验证 API Key"""</span>
    key_hash = hashlib.sha256(raw_key.encode()).hexdigest()
    cursor.execute(
        <span class="hljs-string">"SELECT id, role, label FROM api_keys WHERE key_hash = ?"</span>,
        (key_hash,)
    )
    <span class="hljs-keyword">return</span> cursor.fetchone()

<span class="hljs-comment"># API 路由认证依赖</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">require_api_key</span>(<span class="hljs-params">request: Request</span>):
    api_key = request.headers.get(<span class="hljs-string">"X-API-Key"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> api_key:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">401</span>, detail=<span class="hljs-string">"API Key required"</span>)

    key_record = verify_api_key(api_key)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> key_record:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">403</span>, detail=<span class="hljs-string">"Invalid API Key"</span>)

    request.state.api_key_record = key_record
    <span class="hljs-keyword">return</span> key_record
</code></pre>
<hr/>
<h2 data-id="heading-14">五、前端对接实现</h2>
<p>前端通过 SSE（Server-Sent Events）接收流式响应：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端调用示例</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params">message, sessionId</span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'http://localhost:8888/api/chat'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      <span class="hljs-string">'X-API-Key'</span>: <span class="hljs-string">'your-api-key-here'</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ message, <span class="hljs-attr">session_id</span>: sessionId })
  });

  <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();
  <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>();

  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
    <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value);
    <span class="hljs-keyword">const</span> lines = chunk.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
      <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data: '</span>)) {
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>));

        <span class="hljs-comment">// 第一个数据包包含 session_id</span>
        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">session_id</span>) {
          sessionId = data.<span class="hljs-property">session_id</span>;
          <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 后续数据包是 AI 的回复内容</span>
        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">content</span>) {
          <span class="hljs-title function_">appendToChat</span>(data.<span class="hljs-property">content</span>);  <span class="hljs-comment">// 追加到聊天窗口</span>
        }
      }
    }
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-15">六、Docker 部署</h2>
<h3 data-id="heading-16">6.1 Dockerfile</h3>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 拷贝代码
COPY app app

# 预创建运行时目录
RUN mkdir -p /app/data /app/chroma_db /app/logs

EXPOSE 8888

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8888"]
</code></pre>
<h3 data-id="heading-17">6.2 构建和运行</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 构建镜像</span>
docker build -t ace-ai:latest .

<span class="hljs-comment"># 2. 运行容器</span>
docker run -d \
  --name ace-ai \
  --network host \
  -v $(<span class="hljs-built_in">pwd</span>)/data:/app/data \
  -v $(<span class="hljs-built_in">pwd</span>)/chroma_db:/app/chroma_db \
  -v $(<span class="hljs-built_in">pwd</span>)/logs:/app/logs \
  -e TZ=Asia/Shanghai \
  -e OLLAMA_BASE_URL=http://127.0.0.1:11434 \
  --restart unless-stopped \
  ace-ai:latest

<span class="hljs-comment"># 3. 获取超级管理员 API Key</span>
<span class="hljs-built_in">cat</span> data/initial_superadmin_key.txt

<span class="hljs-comment"># 4. 访问 API 文档</span>
open http://localhost:8888/docs
</code></pre>
<hr/>
<h2 data-id="heading-18">七、效果展示</h2>
<h3 data-id="heading-19">7.1 上传文档构建知识库</h3>
<pre><code class="hljs language-bash" lang="bash">curl -X POST http://localhost:8888/api/documents/upload \
  -H <span class="hljs-string">"X-API-Key: your-api-key"</span> \
  -F <span class="hljs-string">"file=@employee_handbook.pdf"</span>
</code></pre>
<h3 data-id="heading-20">7.2 进行对话</h3>
<pre><code class="hljs language-bash" lang="bash">curl -X POST http://localhost:8888/api/chat \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -H <span class="hljs-string">"X-API-Key: your-api-key"</span> \
  -d <span class="hljs-string">'{"message": "年假怎么申请？"}'</span>
</code></pre>
<h3 data-id="heading-21">7.3 在线体验</h3>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwangcaiyuan.com%2Fchat" target="_blank" title="https://wangcaiyuan.com/chat" ref="nofollow noopener noreferrer">wangcaiyuan.com/chat</a> 即可体验完整的 RAG 对话系统。</p>
<hr/>
<h2 data-id="heading-22">八、技术栈</h2>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">后端: Python 3.11 + FastAPI</span>
<span class="hljs-section">向量库: ChromaDB</span>
<span class="hljs-section">LLM: Ollama (qwen3-coder:480b-cloud)</span>
<span class="hljs-section">Embedding: Ollama (nomic-embed-text)</span>
<span class="hljs-section">容器: Docker</span>
</code></pre>
<h3 data-id="heading-23">主要特性</h3>
<ul>
<li><strong>SSE 流式响应</strong>：实时返回 AI 回复</li>
<li><strong>API Key 认证</strong>：保护接口安全</li>
<li><strong>文档解析</strong>：支持 PDF、TXT、Markdown</li>
<li><strong>Docker 部署</strong>：一键启动</li>
</ul>
<hr/>
<h2 data-id="heading-24">九、总结</h2>
<p>本文介绍了如何快速搭建一个基于 RAG 的 AI 对话系统，核心就是：</p>
<ol>
<li><strong>Ollama</strong> 本地运行 LLM</li>
<li><strong>ChromaDB</strong> 存储向量知识库</li>
<li><strong>FastAPI</strong> 提供 API 接口</li>
<li><strong>前端</strong> 通过 SSE 实现流式对话</li>
</ol>
<p><strong>GitHub 地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Face0109%2Face-ai" target="_blank" title="https://github.com/ace0109/ace-ai" ref="nofollow noopener noreferrer">github.com/ace0109/ace…</a> ⭐</p>
<p><strong>在线体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwangcaiyuan.com%2Fchat" target="_blank" title="https://wangcaiyuan.com/chat" ref="nofollow noopener noreferrer">wangcaiyuan.com/chat</a></p>
<p>有问题欢迎在评论区讨论！</p>
<hr/>
<p><strong>参考链接</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com" target="_blank" title="https://ollama.com" ref="nofollow noopener noreferrer">Ollama 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpython.langchain.com" target="_blank" title="https://python.langchain.com" ref="nofollow noopener noreferrer">LangChain 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.trychroma.com" target="_blank" title="https://docs.trychroma.com" ref="nofollow noopener noreferrer">ChromaDB 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffastapi.tiangolo.com" target="_blank" title="https://fastapi.tiangolo.com" ref="nofollow noopener noreferrer">FastAPI 文档</a></li>
</ul>
<blockquote>
<p>本文首发于掘金，转载请注明出处。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1、为什么说精通 Python 就等于握住了 AI 时代的全栈通行证？]]></title>    <link>https://juejin.cn/post/7586610067569131520</link>    <guid>https://juejin.cn/post/7586610067569131520</guid>    <pubDate>2025-12-23T08:23:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586610067569131520" data-draft-id="7586687526866829327" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1、为什么说精通 Python 就等于握住了 AI 时代的全栈通行证？"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-23T08:23:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金詹姆斯"/> <meta itemprop="url" content="https://juejin.cn/user/2289608413155021"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1、为什么说精通 Python 就等于握住了 AI 时代的全栈通行证？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2289608413155021/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金詹姆斯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:23:48.000Z" title="Tue Dec 23 2025 08:23:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">1、前言</h2>
<p>Python 在当前 <strong>AI 全栈开发</strong> 中扮演着<strong>核心且不可替代</strong>的角色，其重要性体现在从<strong>数据处理、模型训练、API 构建到前端交互和部署运维</strong>的每一个环节。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dc5ff91b92a4b9b8a54276d684bcaa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6Km55aeG5pav:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083027&amp;x-signature=28C7x3Vk3%2F%2FfWnZhWdot8uLSxh4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2、全栈开发中的“全”在 AI 场景下的新定义</h2>
<p>传统全栈 = 前端 + 后端 + 数据库</p>
<p><strong>AI 全栈</strong> = 数据工程 + 模型开发 + API服务 + 应用集成 + 部署监控</p>
<p><strong>Python 凭借其统一技术栈能力，几乎贯穿整个 AI 全流程：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b7f3e9092754c2ea7ec1b682903771c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6Km55aeG5pav:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083027&amp;x-signature=5aaIqO2IsgzAWkQSCzHWhMFC4B0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">3、为什么其他语言难以替代？</h2>
<p><strong>生态完整性</strong></p>
<ul>
<li>几乎所有主流 AI 框架（PyTorch/TensorFlow/JAX）<strong>原生优先支持 Python</strong></li>
<li>Hugging Face、LangChain 等新兴 AI 工具链 <strong>以 Python 为默认接口</strong></li>
<li>连 OpenAI、Anthropic、Google DeepMind 的官方 SDK 都是 <strong>Python-first</strong></li>
</ul>
<p><strong>开发效率碾压</strong></p>
<ul>
<li>用 FastAPI + PyTorch 可在 <strong>10 行代码内</strong> 暴露一个大模型推理接口</li>
<li>Gradio 三行代码生成 Web UI，用于<strong>快速验证</strong> AI 功能</li>
<li>相比 Rust/C++，Python 让开发者聚焦 “<strong>做什么”而非“怎么做内存管理</strong>”</li>
</ul>
<p><strong>社区与人才储备</strong></p>
<ul>
<li>全球超 <strong>75% 的 AI/ML 岗位明确要求 Python</strong></li>
<li>GitHub 上 AI 相关项目 <strong>80%+ 使用 Python</strong></li>
<li>高校 AI 课程普遍以 Python 为教学语言，形成<strong>人才正循环</strong></li>
</ul>
<h2 data-id="heading-3">4、典型 AI 全栈项目中的 Python 实践</h2>
<p>假设你要开发一个 智能客服问答系统 ：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 数据加载（pandas）</span>
df = pd.read_csv(<span class="hljs-string">"faq_data.csv"</span>)

<span class="hljs-comment"># 2. 向量检索（sentence-transformers + FAISS）</span>
<span class="hljs-keyword">from</span> sentence_transformers <span class="hljs-keyword">import</span> SentenceTransformer
model = SentenceTransformer(<span class="hljs-string">'all-MiniLM-L6-v2'</span>)
vectors = model.encode(df[<span class="hljs-string">'question'</span>].tolist())

<span class="hljs-comment"># 3. 构建 RAG（LangChain）</span>
<span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> RetrievalQA
qa_chain = RetrievalQA.from_chain_type(llm, retriever=faiss_retriever)

<span class="hljs-comment"># 4. 提供 API（FastAPI）</span>
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/ask"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ask</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">return</span> qa_chain.run(query)

<span class="hljs-comment"># 5. 快速演示（Gradio）</span>
gr.Interface(fn=ask, inputs=<span class="hljs-string">"text"</span>, outputs=<span class="hljs-string">"text"</span>).launch()
</code></pre>
<h2 data-id="heading-4">5、未来趋势：Python 仍是 AI 全栈的“中枢神经”</h2>
<ul>
<li><strong>多模态 AI</strong>（文本+图像+语音）：Transformers + OpenCV + librosa 全在 Python 生态</li>
<li><strong>AI Agent 开发</strong>：LangChain、AutoGen 等框架完全基于 Python</li>
<li><strong>MLOps 工具链</strong>：MLflow、Weights &amp; Biases、DVC 均提供 Python SDK</li>
</ul>
<h2 data-id="heading-5">6、结论</h2>
<blockquote>
<p><strong>Python 不仅是 AI 开发的语言，更是 AI 全栈开发的“操作系统”</strong></p>
</blockquote>
<blockquote>
<p><strong>成为当前 AI 工程师必须掌握的核心技能。无论你是算法研究员、后端工程师还是创业者，精通 Python 就等于握住了 AI 时代的全栈通行证</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript中的迭代器和生成器]]></title>    <link>https://juejin.cn/post/7586622708999847976</link>    <guid>https://juejin.cn/post/7586622708999847976</guid>    <pubDate>2025-12-23T08:35:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586622708999847976" data-draft-id="7586617459488882740" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript中的迭代器和生成器"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-23T08:35:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户31305008627"/> <meta itemprop="url" content="https://juejin.cn/user/2455641727456105"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript中的迭代器和生成器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2455641727456105/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户31305008627
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:35:27.000Z" title="Tue Dec 23 2025 08:35:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">先讲迭代器（Iterator）：就是“能一个个往外拿东西的容器”</h2>
<p>你可以把迭代器想象成自动售货机：</p>
<ul>
<li>你先有一堆商品（比如数组 [1,2,3]），把它们放进售货机里，这个售货机就是迭代器；</li>
<li>你每次按“出货”按钮（调用 <code>next()</code> 方法），它就给你出一个商品，出完一个就少一个；</li>
<li>等商品出完了，再按按钮就会返回 <code>{ value: undefined, done: true }</code>（提示“没货了”）；</li>
<li>而且它只能单向前进，出了2就回不到1了，不能倒着拿。</li>
</ul>
<h3 data-id="heading-1">JavaScript 迭代器的简单例子</h3>
<pre><code class="hljs language-vbscript" lang="vbscript">// <span class="hljs-number">1.</span> 先准备一个数组（一堆商品）
<span class="hljs-keyword">const</span> nums = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

// <span class="hljs-number">2.</span> 把数组变成迭代器（装进售货机）
<span class="hljs-keyword">const</span> it = nums[Symbol.iterator]();

// <span class="hljs-number">3.</span> 按按钮拿东西（调用 <span class="hljs-keyword">next</span>()）
console.<span class="hljs-built_in">log</span>(it.<span class="hljs-keyword">next</span>()); // 输出 { value: <span class="hljs-number">1</span>, done: <span class="hljs-literal">false</span> }（拿第一个）
console.<span class="hljs-built_in">log</span>(it.<span class="hljs-keyword">next</span>()); // 输出 { value: <span class="hljs-number">2</span>, done: <span class="hljs-literal">false</span> }（拿第二个）
console.<span class="hljs-built_in">log</span>(it.<span class="hljs-keyword">next</span>()); // 输出 { value: <span class="hljs-number">3</span>, done: <span class="hljs-literal">false</span> }（拿第三个）
console.<span class="hljs-built_in">log</span>(it.<span class="hljs-keyword">next</span>()); // 输出 { value: undefined, done: <span class="hljs-literal">true</span> }（没货了）
</code></pre>
<h3 data-id="heading-2">迭代器的核心特点</h3>
<ol>
<li>必须有一个 <code>next()</code> 方法，调用后返回固定格式：<code>{ value: 具体值, done: 是否迭代完 }</code>；</li>
<li>惰性获取：只有调用 <code>next()</code> 才会返回下一个值，不会一次性把所有值加载到内存；</li>
<li>用完就没：只能往前，不能回头，也不能重复用。</li>
</ol>
<h3 data-id="heading-3">手动实现一个简单迭代器（理解原理）</h3>
<p>就像自己造一个简易售货机：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 手动实现迭代器：模拟售货机逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createIterator</span>(<span class="hljs-params">arr</span>) {
  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; <span class="hljs-comment">// 记录当前拿到第几个</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 核心的 next() 方法</span>
    <span class="hljs-attr">next</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 如果没拿完，返回当前值 + 未完成；否则返回 undefined + 已完成</span>
      <span class="hljs-keyword">if</span> (index &lt; arr.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">value</span>: arr[index++], <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> };
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">value</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> };
      }
    }
  };
}

<span class="hljs-comment">// 使用这个自定义迭代器</span>
<span class="hljs-keyword">const</span> myIt = <span class="hljs-title function_">createIterator</span>([<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>]);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myIt.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 10, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myIt.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 20, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myIt.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: 30, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myIt.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// { value: undefined, done: true }</span>
</code></pre>
<h2 data-id="heading-4">再讲生成器：“自动造东西的迭代器”</h2>
<p>生成器是迭代器的升级版，你可以把它想象成现做现卖的小吃摊：</p>
<ul>
<li>迭代器是“先把所有东西准备好再往外拿”（比如先把1、2、3都放进售货机）；</li>
<li>生成器是“你要一个，我才做一个”（比如你要第一个包子，我才包第一个，要第二个才包第二个）；</li>
<li>它不用提前把所有数据存在内存里，而是“按需生成”，特别省内存。</li>
</ul>
<h3 data-id="heading-5">JavaScript 生成器的核心：<code>function*</code> + <code>yield</code></h3>
<p><code>function*</code> 是生成器函数的标识（注意多了个 <code>*</code>），<code>yield</code> 就是“暂停并返回”的意思——比如你去小吃摊买包子，老板包一个给你，然后暂停，等你要下一个再继续包。</p>
<h3 data-id="heading-6">生成器的完整例子（最常用）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义生成器函数（注意 function* 和 yield）</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">makeBuns</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始包第一个包子"</span>);
  <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 包好第一个，返回，暂停</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始包第二个包子"</span>);
  <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>; <span class="hljs-comment">// 继续，包第二个，返回，暂停</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始包第三个包子"</span>);
  <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>; <span class="hljs-comment">// 继续，包第三个，返回，暂停</span>
}

<span class="hljs-comment">// 调用函数，得到生成器（此时函数不会执行，只是创建生成器）</span>
<span class="hljs-keyword">const</span> bunGen = <span class="hljs-title function_">makeBuns</span>();

<span class="hljs-comment">// 第一次拿：执行到第一个yield，返回 { value: 1, done: false }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bunGen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// 输出：开始包第一个包子 → { value: 1, done: false }</span>
<span class="hljs-comment">// 第二次拿：从暂停的地方继续，执行到第二个yield</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bunGen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// 输出：开始包第二个包子 → { value: 2, done: false }</span>
<span class="hljs-comment">// 第三次拿：继续，执行到第三个yield</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bunGen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// 输出：开始包第三个包子 → { value: 3, done: false }</span>
<span class="hljs-comment">// 第四次拿：没包子了，返回 done: true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bunGen.<span class="hljs-title function_">next</span>()); <span class="hljs-comment">// 输出：{ value: undefined, done: true }</span>
</code></pre>
<h3 data-id="heading-7">生成器的实用场景：按需生成大量数据</h3>
<p>比如要生成 100 万个数字，用数组会占满内存，但生成器只在需要时计算：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 生成器：按需生成数字，不占内存</span>
<span class="hljs-keyword">function</span>* <span class="hljs-title function_">generateBigNumbers</span>(<span class="hljs-params">max</span>) {
  <span class="hljs-keyword">let</span> num = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">while</span> (num &lt;= max) {
    <span class="hljs-keyword">yield</span> num++; <span class="hljs-comment">// 要一个，生成一个</span>
  }
}

<span class="hljs-comment">// 生成 100 万个数字的生成器（此时还没生成任何数字）</span>
<span class="hljs-keyword">const</span> bigNumGen = <span class="hljs-title function_">generateBigNumbers</span>(<span class="hljs-number">1000000</span>);

<span class="hljs-comment">// 只拿前3个，后面的不会生成</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigNumGen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigNumGen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bigNumGen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 3</span>
</code></pre>
<h2 data-id="heading-8">迭代器 vs 生成器 一句话区分（JS 版本）</h2>
<ul>
<li>迭代器：已有数据的“搬运工”（把现成的东西一个个拿出来，比如数组迭代器）；</li>
<li>生成器：按需生成数据的“生产者”（没有现成数据，要的时候才造，用 <code>function*</code> + <code>yield</code>）；</li>
<li>生成器本质上是一种“自动实现了迭代器接口”的迭代器，写起来比手动迭代器简单 10 倍。</li>
</ul>
<hr/>
<h3 data-id="heading-9">总结</h3>
<ol>
<li>迭代器：像自动售货机，提前装好物，按一次出一个，出完为止，核心是“遍历已有数据”；</li>
<li>生成器：像现做现卖的小吃摊，不用提前备货，要一个做一个，核心是“按需生成数据”，更省内存；</li>
<li>JS 里迭代器靠 <code>next()</code> 方法和 <code>{ value, done }</code> 格式，生成器靠 <code>function*</code> + <code>yield</code>，两者都是“惰性计算”，适合处理大数据。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git：新建功能分支并解决 Merge 冲突]]></title>    <link>https://juejin.cn/post/7586614240532135962</link>    <guid>https://juejin.cn/post/7586614240532135962</guid>    <pubDate>2025-12-23T08:27:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586614240532135962" data-draft-id="7586836874015834122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git：新建功能分支并解决 Merge 冲突"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2025-12-23T08:27:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AntoineGriezmann"/> <meta itemprop="url" content="https://juejin.cn/user/1313259659208356"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git：新建功能分支并解决 Merge 冲突
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1313259659208356/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AntoineGriezmann
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:27:59.000Z" title="Tue Dec 23 2025 08:27:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在给自己的博客项目增加 <strong>中英文切换（i18n）功能</strong>，顺便走一遍从新建功能分支 -&gt; 开发提交 -&gt; 合并回主分支 -&gt; 解决冲突 -&gt; 推送远端。</p>
<h2 data-id="heading-0">一、新建功能分支（feature/i18n）</h2>
<p>在新建分支之前，我先确保主分支是最新的：</p>
<pre><code class="hljs language-css" lang="css">git checkout <span class="hljs-selector-tag">main</span>
git pull
</code></pre>
<p>然后创建并切换到功能分支：</p>
<pre><code class="hljs language-bash" lang="bash">git checkout -b feature/i18n
</code></pre>
<blockquote>
<p><strong>分支并不是拷贝文件，而是一条独立的时间线。</strong></p>
</blockquote>
<p>接下来，所有和 i18n 相关的开发都会在这个分支上完成。</p>
<h2 data-id="heading-1">二、在新分支人为添加冲突</h2>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- main分支/xxx.vue</span>
console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'main分支'</span>)

<span class="hljs-comment">-- feature/i18n分支/xxx.vue</span>
console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'feature/i18n分支'</span>)

</code></pre>
<h2 data-id="heading-2">三、在功能分支上开发并提交</h2>
<p>在 <code>feature/i18n</code> 分支上完成阶段性开发后，我进行了正常的提交：</p>
<pre><code class="hljs language-sql" lang="sql">git <span class="hljs-keyword">add</span> .
git <span class="hljs-keyword">commit</span> <span class="hljs-operator">-</span>m "feat: add basic i18n support"
</code></pre>
<p>第一次把这个分支推到远端时，需要加上 <code>-u</code>：</p>
<pre><code class="hljs language-bash" lang="bash">git push -u origin feature/i18n
</code></pre>
<p>这样可以建立本地分支和远端分支的追踪关系，之后只需要：</p>
<pre><code class="hljs language-perl" lang="perl">git <span class="hljs-keyword">push</span>
</code></pre>
<h2 data-id="heading-3">四、合并回 main 分支，遇到冲突</h2>
<p>功能完成后，我准备把代码合并回 <code>main</code>：</p>
<pre><code class="hljs language-bash" lang="bash">git checkout main
git pull
git merge feature/i18n
</code></pre>
<p>这时 Git 提示出现冲突，例如：</p>
<pre><code class="hljs language-css" lang="css">CONFLICT (<span class="hljs-attribute">content</span>): Merge conflict in xxx.vue
</code></pre>
<h2 data-id="heading-4">五、解决冲突的步骤</h2>
<ol>
<li>打开冲突文件</li>
<li>理解两个分支代码的差异</li>
<li>保留正确的逻辑</li>
<li>保存文件</li>
</ol>
<p>然后执行：</p>
<pre><code class="hljs language-csharp" lang="csharp">git <span class="hljs-keyword">add</span> .
</code></pre>
<p>这一步非常关键，它的含义是：</p>
<blockquote>
<p><strong>告诉 Git：这些冲突我已经手动解决完了</strong></p>
</blockquote>
<h2 data-id="heading-5">六、完成 merge commit（一个容易踩坑的点）</h2>
<p>解决冲突后，我执行了：</p>
<pre><code class="hljs language-sql" lang="sql">git <span class="hljs-keyword">commit</span>
</code></pre>
<p>这时 Git 打开了编辑器（Vim），让我确认提交信息。</p>
<p>后来我才明白，在 merge 冲突场景下，更推荐直接使用：</p>
<pre><code class="hljs language-sql" lang="sql">git <span class="hljs-keyword">commit</span> <span class="hljs-comment">--no-edit</span>
</code></pre>
<p>它的含义是：</p>
<blockquote>
<p><strong>直接使用 Git 自动生成的 merge 提交信息，不打开编辑器</strong></p>
</blockquote>
<p>这一步完成后，merge commit 只存在于<strong>本地 main 分支</strong>。</p>
<h2 data-id="heading-6">七、提交到远程分支</h2>
<pre><code class="hljs language-perl" lang="perl">git <span class="hljs-keyword">push</span>
</code></pre>
<p>只有执行了 <code>git push</code>：</p>
<ul>
<li>merge commit 才会出现在远端</li>
<li>GitHub 上的 <code>main</code> 分支才会更新</li>
<li>功能才算真正合并完成</li>
</ul>
<h2 data-id="heading-7">八、总结</h2>
<p>这次并没有用到多么高级的 Git 技巧，只是记录从
<strong>分支创建 → 功能开发 → 合并 → 冲突解决 → 推送远端</strong></p>
<blockquote>
<p>本次实践让我第一次把 Git 的分支开发和冲突处理流程真正串联起来。<br/>
把这些过程记录下来，一方面是对自己学习轨迹的梳理，另一方面也希望逐步积累技术表达的能力。<br/>
这篇文章算是一个起点，为后续系统性地撰写技术文章打下基础。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app 项目在 iOS 上架过程中常见的问题与应对方式]]></title>    <link>https://juejin.cn/post/7586861592710823972</link>    <guid>https://juejin.cn/post/7586861592710823972</guid>    <pubDate>2025-12-23T08:36:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586861592710823972" data-draft-id="7586902693857132586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app 项目在 iOS 上架过程中常见的问题与应对方式"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T08:36:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app 项目在 iOS 上架过程中常见的问题与应对方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:36:39.000Z" title="Tue Dec 23 2025 08:36:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 uni-app 项目里，开发阶段通常推进得很顺。页面逻辑、接口对接、跨端兼容，一旦跑通，团队很容易形成一种判断：“剩下的就是打包和上架了。”</p>
<p>但真正进入 App Store 上架流程后，很多问题才开始出现，而且这些问题往往和 uni-app 本身关系不大。
它们更像是 <strong>跨端开发与原生发布体系之间的缝隙</strong>。</p>
<hr/>
<h2 data-id="heading-0"><strong>uni-app 解决的是开发效率，不是发布复杂度</strong></h2>
<p>这是我在多个项目中反复确认的一点。
uni-app 帮你减少了重复开发，但并没有替你简化 iOS 的发布规则。</p>
<p>在上架阶段，苹果仍然只关心几件事：</p>
<ul>
<li>应用的身份（Bundle ID）</li>
<li>使用的证书与描述文件</li>
<li>构建产物是否符合规范</li>
<li>上传过程是否完整、可验证</li>
</ul>
<p>这些要求不会因为你使用了 uni-app 而发生变化。</p>
<hr/>
<h2 data-id="heading-1"><strong>云打包生成的 IPA，并不是“天然可上架”的</strong></h2>
<p>不少 uni-app 项目会使用云打包服务，拿到 IPA 后就直接进入上传流程。
但在实际项目中，我见过很多“打包成功但无法上架”的情况。</p>
<p>原因包括：</p>
<ul>
<li>Bundle ID 与账号中已有应用不一致</li>
<li>描述文件类型不符合发布要求</li>
<li>构建产物中仍然带有测试配置</li>
</ul>
<p>这些问题在云打包阶段不一定会被提示，但在上传或审核阶段一定会暴露。</p>
<hr/>
<h2 data-id="heading-2"><strong>上架前，先确认“这个应用在账号里长什么样”</strong></h2>
<p>在 uni-app 项目中，Bundle ID 往往是在开发初期随配置填写的，很少被反复检查。
但在上架前，我通常会先确认 Apple 开发者账号中已经存在的应用标识。</p>
<p>这样做的目的很简单：</p>
<ul>
<li>避免误用历史项目的 Bundle ID</li>
<li>防止测试包与正式包混用</li>
<li>确认当前应用是否需要新建标识</li>
</ul>
<p>在非 macOS 环境下，可以通过 <strong>开心上架（Appuploader）查看账号内的 Bundle ID 列表</strong>，快速了解当前账号状态。这一步并不会改变 uni-app 的打包方式，但能减少后续的反复修改。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02d6facd56604f178422fadbfef78a2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D54y054i3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083799&amp;x-signature=x8wPWVlUKhSuP6xBf7CTGLMQhe4%3D" alt="查看bid" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-3"><strong>证书问题，在 uni-app 项目里并不会自动消失</strong></h2>
<p>很多开发者在 uni-app 项目中对证书的感知会变弱，因为大部分操作被工具包裹起来了。
但证书依然是 iOS 上架的硬前提。</p>
<p>在一些项目中，我遇到过：</p>
<ul>
<li>云打包正常，但 TestFlight 无法使用</li>
<li>构建换了环境后签名失效</li>
<li>无法确认当前使用的是哪一份证书</li>
</ul>
<p>后来在部分团队里，我们选择把证书管理从“隐式状态”中拆出来。
通过 <strong>开心上架（Appuploader）创建 iOS 证书</strong>，生成可复用的证书文件，用于构建和发布流程。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d233719b58a74457a4a27630cb81897c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D54y054i3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083799&amp;x-signature=j0xhO6cdIuUsby0bsF4nJcagDBw%3D" alt="创建证书" loading="lazy"/></p>
<p>这种方式的意义不在于“不用 Xcode”，而在于让证书成为 <strong>可被管理的工程资源</strong>。</p>
<hr/>
<h2 data-id="heading-4"><strong>描述文件，是 uni-app 上架中最容易被忽略的一环</strong></h2>
<p>在 uni-app 项目中，描述文件往往是自动生成或自动下载的，很少有人会主动检查它的内容。
但在排查问题时，它经常是关键线索。</p>
<p>我遇到过构建成功、安装正常，却始终无法提交审核的情况。
最终发现是 IPA 中携带的是开发描述文件，而不是 App Store 类型。</p>
<p>在发布前，我更倾向于直接确认描述文件的内部信息。
通过 <strong>开心上架（Appuploader）查看 mobileprovision 文件内容</strong>，可以明确：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d9146df409f409da11c6a1443e7b76b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D54y054i3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083799&amp;x-signature=2b2MM5JF12tmIdAzv9x70dRIuf8%3D" alt="查看文件" loading="lazy"/></p>
<ul>
<li>描述文件类型</li>
<li>绑定的 Bundle ID</li>
<li>使用的证书是否正确</li>
</ul>
<p>这一步对于 uni-app 项目尤其重要，因为很多错误并不会在打包阶段提示。</p>
<hr/>
<h2 data-id="heading-5"><strong>上传方式，往往决定 uni-app 项目的协作成本</strong></h2>
<p>在单人项目中，用 Xcode 或平台推荐方式上传 IPA 并不困难。
但在多人或跨平台团队中，上传很容易成为瓶颈。</p>
<p>当构建发生在云端，而上传只能依赖某一台 Mac 时，发布节奏就会被人为限制。</p>
<p>在一些项目中，我们使用 <strong>开心上架（Appuploader）的上传方式</strong>，在 Windows 或 Linux 环境中完成 IPA 提交，使 uni-app 的打包结果可以被不同系统的成员接手处理。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13176fb6acfd46b1829aff0341d8f041~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D54y054i3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083799&amp;x-signature=LurVIXCOD%2FtxisOQOQ7VgHgtriE%3D" alt="ipa上传" loading="lazy"/></p>
<p>这并不会改变苹果的审核流程，但让发布步骤更符合团队协作的现实。</p>
<hr/>
<h2 data-id="heading-6"><strong>uni-app 上架，本质仍然是一次原生发布</strong></h2>
<p>经历过多次完整流程后，我逐渐形成一个共识：
uni-app 并没有绕过 iOS 上架，它只是改变了开发入口。</p>
<p>真正决定上架是否顺利的，仍然是这些原生对象是否清晰：</p>
<ul>
<li>应用标识</li>
<li>证书与描述文件</li>
<li>构建产物</li>
<li>上传路径</li>
</ul>
<p>Xcode、云打包、CI 和开心上架（Appuploader）各自解决不同问题，让这些关键对象在非 macOS 环境中也能被查看、验证和使用。
参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.appuploader.net%2Ftutorial%2Fzh%2F1%2F1.html" target="_blank" title="https://www.appuploader.net/tutorial/zh/1/1.html" ref="nofollow noopener noreferrer">www.appuploader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ECS 端口不通，丢包诊断看这里！阿里云 SysOM 智能诊断实战！]]></title>    <link>https://juejin.cn/post/7586879894207479871</link>    <guid>https://juejin.cn/post/7586879894207479871</guid>    <pubDate>2025-12-23T08:37:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586879894207479871" data-draft-id="7586675587148709924" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ECS 端口不通，丢包诊断看这里！阿里云 SysOM 智能诊断实战！"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-23T08:37:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ECS 端口不通，丢包诊断看这里！阿里云 SysOM 智能诊断实战！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:37:43.000Z" title="Tue Dec 23 2025 08:37:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：万瑞萍</p>
<h2 data-id="heading-0">背景</h2>
<p>随着云计算的深入应用，企业核心业务加速上云，高质量的网络通信已成为保障业务连续性的关键。作为网络传输的核心指标，数据包丢失直接影响系统稳定性：轻度丢包可能导致通信中断、数据异常，扰乱业务逻辑；严重丢包则可能引发健康检查失败、Ping 不通、服务拒绝等系统性故障，带来连锁运维问题。</p>
<p>某客户在新区域部署分布式集群时，突遇网络丢包，导致节点通信中断，业务部署停滞，资源持续闲置。面对这一紧急情况，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fcms%3Fspm%3Da1z389.11499242.0.0.65452413vvcY0e%26utm_content%3Dg_1000408141" target="_blank" title="https://www.aliyun.com/product/cms?spm=a1z389.11499242.0.0.65452413vvcY0e&amp;utm_content=g_1000408141" ref="nofollow noopener noreferrer">阿里云云监控 2.0</a> 通过 SysOM 智能诊断功能，在数小时内精准定位故障根源，帮助客户快速恢复业务部署与系统稳定运行，有效避免资源浪费。<br/>
本文将通过这一典型案例，深入解析 SysOM 在丢包故障排查中的实战应用，展示其如何助力企业高效恢复业务连续性。</p>
<h2 data-id="heading-1">通过丢包诊断精准定位问题根源</h2>
<h3 data-id="heading-2">场景一：快速定界问题</h3>
<p>在阿里云 ACK（阿里云 Kubernetes 服务）新区域集群部署过程中，某客户遭遇系统性健康检查异常，导致业务部署流程全面受阻。在排除 iptables 规则配置异常的可能性后，运维团队将故障定位重点转向内核层丢包问题。</p>
<p>该类问题的排查涉及复杂的内核级分析流程，要求运维人员具备扎实的内核源码分析能力。需追踪数据包在内核协议栈中的处理路径，并结合 netfilter 框架各 hook 点的流量特征进行深度监控。这种技术方案不仅对排查人员的内核调试能力提出严苛要求，同时需要投入大量时间资源进行问题复现与验证。</p>
<p>本次故障处置中，我们借助操作系统控制台的能力，成功定位问题根源。典型云原生架构下，承载 ACK Pod 的 ECS 实例集群前端配置了 SLB 负载均衡器，形成标准的云原生部署拓扑（如架构图所示）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b00eea29dc9445589a978a60ae52a26d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=6a1r9%2F0Mm4ev6Ecnw4V7evUyvQg%3D" alt="图片" loading="lazy"/></p>
<p>我们通过 tcpdump 对 ECS 的 eth0 网卡上进行抓包。抓包结果如下，抓包结果显示，源地址为SLB健康检查网段，此时 SLB 持续向本机发送 SYN 包以建立连接。但本机未返回 ACK 包，导致健康检查失败。那么本机为何未能返回 ACK 包？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/378d069b10b1499b95e667be838f16a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=IJAt6Kn%2FYvG2QKj9K2XWsg3kRBk%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">检查 iptable 规则</h3>
<p>按照常规排查思路，我们首先考虑是否存在 iptables 规则导致请求被过滤的可能性。但通过对正常主机与异常主机的 iptables 配置进行比对核查后发现，两者策略保持完全一致，由此可以判定该因素并非造成当前网络异常的原因。</p>
<h3 data-id="heading-4">排查内核丢包</h3>
<p>排查内核丢包问题时，过去往往需要精通网络内核模块的资深工程师进行深度分析，而如今只需通过阿里云操作系统控制台轻松操作，即可快速实现过去需专业人员才能完成的复杂诊断任务。</p>
<p>使用操作系统控制台对问题实例进行诊断：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/051466780ced44c489d666acd7144fad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=Utq0Vc4Iz4BegLtwNfDjpiHad8c%3D" alt="图片" loading="lazy"/></p>
<p>如图上所示，在云监控控制台选择 ECS 洞察，选择系统诊断（SysOM）、节点诊断、网络诊断、丢包诊断，在第 5 步中选择所需要诊断的实例 ID，最后点击执行诊断。诊断完成以后，点击查看报告，可以看到机器中的丢包情况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53b960fcae2e4ae4a7c464dc855e4589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=LHGvubAgkurZ1z%2FlD3hcpchC1V4%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f042449095254d759ef2e0ca01d76210~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=y58QtfQVGBwslxW5aSvSTZVcsfA%3D" alt="图片" loading="lazy"/></p>
<p>如上图所示，诊断结果显示未发现已知丢包异常记录。由此可判断，内核层丢包可能性已基本排除。</p>
<h3 data-id="heading-5">排查驱动或其他模块</h3>
<p>结合操作系统控制台的诊断信息，目前已基本确认内核并未发生丢包，成功排除了底层协议栈存在异常的可能性。进一步分析显示，eth0 接口已成功接收到 SYN 包，说明网络链路未出现数据丢失；同时，iptables 规则检查无异常，也排除了因配置规则导致问题的可能。在完成上述排查后，我们意识到仍有一个潜在维度尚未覆盖——网络驱动或中间件模块可能存在异常。基于这一假设，我们决定将系统中的钩子（hook）日志打印出来进行分析。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e3e32ae90644878bd19e725141fba54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=pRv%2FBIfR5XGDZm%2BLnTp%2BahbUSXo%3D" alt="图片" loading="lazy"/></p>
<p>从上图可以看出，与正常机器相比，该系统中多出了大量 sched_cls 类型的钩子。经与 ACK 研发团队确认，这些钩子来自某个网络组件。由此我们高度怀疑正是该组件所注入的钩子导致 SYN 包被意外过滤，遂将其卸载。卸载后，健康检查立即恢复正常。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/264285c46f374f3bb75a1132ccc737b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=0MlfYBLhMbgFIO5UqRlZkWe094I%3D" alt="图片" loading="lazy"/></p>
<p>通过操作系统控制台的协助，我们迅速完成了问题的初步定位，排除了内核丢包的可能性，从而能够更快地将排查重点转向其他方向，为后续问题的解决节省了大量时间。</p>
<h3 data-id="heading-6">场景二：精准定位问题</h3>
<p>某客户在新建实例后，发现 1678 端口无法通过 telnet 连通，严重影响其业务运行。该端口是其业务进程对外通信的关键入口，一旦不通，将导致服务无法正常与外部系统交互。</p>
<p>本案例与前述问题较为相似，同样表现为网络不通。在处理此类问题时，我们的标准排查流程是：首先对目标端口或网卡进行抓包，观察数据包的实际流向和交互情况。客户在其机器上执行了 telnet 测试，发现 22 端口可以正常连通，但 1678 端口及其他多个端口均无法访问。进一步检查确认，相关端口均有业务进程正常监听，服务本身运行无异常。按照常规思路，我们首先怀疑是否为 iptables 规则拦截所致。在客户配合下，我们详细检查了该主机的 iptables 配置，确认未设置任何特殊或限制性规则，基本排除了防火墙策略导致的问题。结合上一个案例的经验，我们进一步考虑是否存在网络驱动或内核模块中的钩子（hook）干扰了数据包处理。于是，我们重点排查了系统中是否安装了安全类组件或注入了异常函数钩子。经查，该机器未部署额外的安全软件，也未发现可疑的内核钩子或网络拦截模块。因此，钩子机制导致 SYN 包被过滤的可能性也被排除。问题原因需从其他维度继续深入分析。</p>
<p>既然钩子和 iptables 都没有问题，那是否可能是内核层面出现了丢包？带着这个疑问，我们可以通过操作系统控制台对异常实例进行进一步诊断：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14465ef66a2446a3a7253d639ce400f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=fr37apDDI3o3pr%2FBtidpCBQ%2FJUg%3D" alt="图片" loading="lazy"/></p>
<p>很快，诊断完成后，我们查阅了生成的诊断报告。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5b7219048464049a1870feacc279e33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=3HljN99Hh5nkZGl4jtLCuje5gM0%3D" alt="图片" loading="lazy"/></p>
<p>诊断报告中明确提示：需删除 iptables 丢包规则或相关 netfilter 驱动。结论十分清晰——丢包是由 netfilter 机制引起的。既然问题根源指向 netfilter，那么首要排查对象便是其规则配置。考虑到现代 Linux 系统可能同时使用 iptables 和 nftables（后者作为 netfilter 的新一代前端），我们首先检查 nftables 的规则设置：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccf33698f5b8415ba2aec5abcac9ec80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=tuSbURgguNmO92zkT1lQVopoRPY%3D" alt="图片" loading="lazy"/></p>
<p>通过查看 nftables 规则配置，发现其中确实存在一条针对 1678 端口的 drop 规则。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52d8babbcc2f4c9daf2766954f3e81df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=RU4IKw8DV5CV6zCCqR09tDXZgII%3D" alt="图片" loading="lazy"/></p>
<p>删除对应的规则并更新配置后，在本机监听 1678 端口，发现连接已恢复正常，问题得以解决。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc276c79bac34fbfa9dd4c1f31249539~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767083862&amp;x-signature=3hFEIztrZgZuxDQ7ihYSEkWSp5A%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-7">总结</h2>
<p>在日常系统运维中，丢包问题可能导致业务通信中断、服务异常甚至无法部署。但这类问题并非不可攻克——阿里云操作系统控制台提供了简单、易用且专业的诊断工具。当怀疑系统存在丢包时，可结合控制台按以下步骤进行排查：</p>
<ol>
<li>首先直接使用操作系统控制台的丢包诊断功能，查看报告是否明确指出了问题根源。</li>
<li>若诊断结果显示内核未发生丢包，则检查系统是否安装了额外的安全软件，或与正常环境对比是否存在异常的钩子（hook）。</li>
<li>在确认无非预期驱动或钩子后，进一步核查 iptables 规则配置是否正确。</li>
<li>若仍无法定位丢包点，可借助 funcgraph、BPF 等工具，在可疑的网络路径上打点抓包，精准定位丢包位置。</li>
</ol>
<p>通常，结合操作系统控制台并遵循上述四个步骤，大多数丢包问题都能被有效识别和解决，让复杂的网络故障变得轻松可控。</p>
<p><strong>相关链接：</strong></p>
<p>[1] 《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247579716%26idx%3D1%26sn%3D156337a4bcba7b7ddddda9df4aadca29%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247579716&amp;idx=1&amp;sn=156337a4bcba7b7ddddda9df4aadca29&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一次内存诊断，让资源利用率提升 40%：揭秘隐式内存治理</a>》</p>
<p>[2] 云监控 - ECS 洞察 - SysOM 系统诊断</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcmsnext.console.aliyun.com%2Fnext%2Fregion%2Fcn-shanghai%2Fworkspace%2Fdefault-cms-1808078950770264-cn-shanghai%2Fapp%2Fhost%2Fhost-sysom" target="_blank" title="https://cmsnext.console.aliyun.com/next/region/cn-shanghai/workspace/default-cms-1808078950770264-cn-shanghai/app/host/host-sysom" ref="nofollow noopener noreferrer">cmsnext.console.aliyun.com/next/region…</a></p>
<p>[3] 操作系统控制台实例纳管</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Falinux%2Fuser-guide%2Fsystem-management%3Fspm%3Da2c4g.11186623.help-menu-2632541.d_2_0_4.14ef243dMTjYF1%26scm%3D20140722.H_2851198._.OR_help-T_cn~zh-V_1%237895eb3dedfty" target="_blank" title="https://help.aliyun.com/zh/alinux/user-guide/system-management?spm=a2c4g.11186623.help-menu-2632541.d_2_0_4.14ef243dMTjYF1&amp;scm=20140722.H_2851198._.OR_help-T_cn~zh-V_1#7895eb3dedfty" ref="nofollow noopener noreferrer">help.aliyun.com/zh/alinux/u…</a></p>
<p>[4] 操作系统控制台 Java 内存诊断</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Falinux%2Fuser-guide%2Fjava-memory-diagnostics%3Fspm%3Da2c4g.11186623.help-menu-2632541.d_2_0_1_0_0_2.2fd8243d1slu08%26scm%3D20140722.H_2979954._.OR_help-T_cn~zh-V_1" target="_blank" title="https://help.aliyun.com/zh/alinux/user-guide/java-memory-diagnostics?spm=a2c4g.11186623.help-menu-2632541.d_2_0_1_0_0_2.2fd8243d1slu08&amp;scm=20140722.H_2979954._.OR_help-T_cn~zh-V_1" ref="nofollow noopener noreferrer">help.aliyun.com/zh/alinux/u…</a></p>
<p>[5] 操作系统控制台热点追踪</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Falinux%2Fuser-guide%2Fprocess-hotspot-tracking" target="_blank" title="https://help.aliyun.com/zh/alinux/user-guide/process-hotspot-tracking" ref="nofollow noopener noreferrer">help.aliyun.com/zh/alinux/u…</a></p>
<p>[6] 操作系统控制台热点对比分析</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Falinux%2Fuser-guide%2Fhot-spot-comparative-analysis" target="_blank" title="https://help.aliyun.com/zh/alinux/user-guide/hot-spot-comparative-analysis" ref="nofollow noopener noreferrer">help.aliyun.com/zh/alinux/u…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[百度一站式全业务智能结算中台]]></title>    <link>https://juejin.cn/post/7586657335881990171</link>    <guid>https://juejin.cn/post/7586657335881990171</guid>    <pubDate>2025-12-23T08:41:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586657335881990171" data-draft-id="7586614240531955738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="百度一站式全业务智能结算中台"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T08:41:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百度Geek说"/> <meta itemprop="url" content="https://juejin.cn/user/4186596000416094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            百度一站式全业务智能结算中台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4186596000416094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百度Geek说
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:41:51.000Z" title="Tue Dec 23 2025 08:41:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">导读</h2>
<p>本文深入介绍了百度一站式全业务智能结算中台，其作为公司财务体系核心，支撑多业务线精准分润与资金流转。中台采用通用化、标准化设计，支持广告、补贴、订单等多种结算模式，实现周结与月结灵活管理。通过业务流程标准化、分润模型通用化及账单测算自动化，大幅提升结算效率与准确性，确保数据合规与业务稳健发展。未来，中台将推进全业务线结算立项线上化、数据智能分析，进一步提升数据分析智能化水平，为公司业务发展提供坚实保障。</p>
<h2 data-id="heading-1">01 概述</h2>
<p>结算中台作为公司财务体系的核心组成部分，承担着多业务线分润计算、结算及资金流转的关键职能。采用通用化、标准化的设计理念，结算中台能够高效支撑公司内数十个业务线的分润需求，确保广告收入、订单收入、内容分发的精准结算，为公司的财务健康与业务稳健发展提供坚实保障。结算中台建设的核心目标是: 构建高效、标准化、智能化的结算中台体系，支撑多业务线分润计算与资金流转，确保结算数据准确性、高时效披露及业务快速迭代能力，同时降低运维复杂度，推动全业务线结算线上化管理。</p>
<p>结算中台已对接了百家号业务、搜索业务、智能体业务、小说等多个业务线的结算需求， 支持广告分润、补贴分润、订单分润三种结算模式。不同业务线根据各自的业务场景使用不同的结算模式，确保每个业务的收益分配准确无误。结算中台功能分层如图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e04d3add22ad4c5db523651ee9cd5eb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=OZbjd8leYYfcEKr%2BJott9fiOIfY%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">02 基本功能</h2>
<h3 data-id="heading-3"><strong>1. 结算模式</strong></h3>
<p>结算中台支持三种结算模式，以适应不同业务场景的结算需求：</p>
<ul>
<li>
<p><strong><strong>订单结算</strong></strong>：基于直接订单数据，按照订单实际金额与分成策略进行分润计算。</p>
</li>
<li>
<p><strong><strong>补贴结算</strong></strong>：针对特定业务或用户群体，提供额外的收益补贴，以增强业务的市场竞争力。</p>
</li>
<li>
<p><strong><strong>广告结算</strong></strong>：根据分发内容的广告变现与渠道分成比例，精确计算媒体与内容的实际收益。</p>
</li>
</ul>
<h3 data-id="heading-4"><strong>2. 结算能力</strong></h3>
<p>结算中台支持周结与月结两种结算能力：</p>
<ul>
<li>
<p><strong><strong>周结</strong></strong>：适用于需要快速资金回笼的业务场景,比如短剧快速回款以后能够再次用于投流, 确保资金流转的高效性。</p>
</li>
<li>
<p><strong><strong>月结</strong></strong>：作为默认的结算周期，便于公司进行统一的财务管理与账务处理。</p>
</li>
</ul>
<h3 data-id="heading-5"><strong>3. 账单测算自动化</strong></h3>
<p>结算中台支持重点业务账单自动测算，通过预设的分润模型，自动计算每个渠道、每位作者的应得收益，生成测算报告。这一自动化过程显著提升工作效率，减少人为错误，确保结算数据的绝对准确。</p>
<h2 data-id="heading-6">03 需求分析</h2>
<p>在推进公司结算业务时，我们致力于实现统一化、标准化，规范业务流程，并确保数据合规化治理，我们面临着诸多问题与挑战，具体表现如下：</p>
<p><strong>1. 流程与规范缺失</strong></p>
<ul>
<li>
<p>结算流程管理混乱：存在结算需求未备案即已上线的情况，或者备案内容与实际实现不一致，甚至缺乏备案流程。</p>
</li>
<li>
<p><strong>日志规范陈旧</strong>：广告分润场景中，内容日志打点冗余，同时缺少扩展性，导致对新的业务场景无法很好兼容。</p>
</li>
</ul>
<p><strong>2. 烟囱式开发成本高</strong></p>
<ul>
<li>
<p><strong>标准化与统一化需求迫切</strong>：之前，各个结算业务维护各自的结算系统，涉及不同的技术栈和结算模型，线下、线上结算方式并存，导致人工处理环节多，易出错，case多，管理难度大。为提高效率，需实现结算业务的标准化与统一化，并拓展支持多种业务结算模式。</p>
</li>
<li>
<p><strong>分润模型通用化设计</strong>：多数业务结算方式相同，同时账单计算逻辑也相似或者相同，没有必要每个业务设计一套逻辑，需要做通用化设计。</p>
</li>
</ul>
<p><strong>3. 业务迭代中的新诉求</strong></p>
<ul>
<li>
<p><strong>测算系统需求凸显</strong>：在业务快速迭代的过程中，许多业务希望尽快看到结算效果，以推进项目落地。因此，构建高效的测算系统成为迫切需求，以加速业务迭代和决策过程。</p>
</li>
<li>
<p><strong>提升作者体验</strong>：为提升作者等合作伙伴的满意度和忠诚度，结算数据需实现高时效披露，确保他们能及时、准确地获取收益信息。结算账单数据的产出依赖百余条数据源，要保证数据在每天12点前产出,困难重重</p>
</li>
<li>
<p><strong>数据校验与监控机制</strong>：结算数据的准确性和质量直接关系到公司的财务健康和业务发展。因此，需建立完善的数据校验和监控机制，确保结算数据的准确无误和高质量。</p>
</li>
</ul>
<h2 data-id="heading-7">04 技术实现</h2>
<p>根据结算中台建设的核心目标，结合业务痛点，在结算系统建设中，基于通用化、标准化的理念，从以下五个方面来搭建统一的、规范化的结算中台。</p>
<ul>
<li>
<p>业务流程标准化：建设一套标准来定义三类结算模式下每个数据处理环节的实现方式，包括业务处理流程、数据处理过程。</p>
</li>
<li>
<p>分润模型通用化：实现不同的账单计算算法，支持各个业务的各类作者收入分配诉求，并且实现参数配置线上化。</p>
</li>
<li>
<p>技术架构统一：统一整个结算业务的技术栈、部署环境、功能入口和数据出口。</p>
</li>
<li>
<p>建设账单测算能力：模拟线上结算流程的账单测算能力，支持业务快速验证分润模型参数调整带来的作者收入影响效果。</p>
</li>
<li>
<p>建设质量保证体系：建设全流程预警机制，通过日志质检、自动对账、数据异常检测来保障账单产出数据时效性、准确性。</p>
</li>
</ul>
<h3 data-id="heading-8"><strong>1. 业务流程标准化</strong></h3>
<p>不同业务场景，采用了通用化、标准化的设计来满足业务的特异性需求，下面是三大结算模式业务流程简图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a0de2e7ada049ccb4cd17e4d97aacdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=jemUOoE7pQr19Yz8X%2F5zNB9YKnE%3D" alt="图片" loading="lazy"/></p>
<p>在广告模式、补贴模式、订单模式结算流程设计中, 从日志打点、线上化、计算逻辑等方向考虑了通用化、标准化设计, 具体如下:</p>
<p><strong>(1) 日志打点统一化</strong></p>
<p>统一日志标准, 针对业务日志规范陈旧问题，要求所有接入的业务方严格按照统一格式打点日志，删除冗余字段, 确保数据的规范性与一致性,同时保证设计能够覆盖所有业务场景，为后续处理奠定坚实基础。</p>
<p>针对某些业务定制化的需求, 在广告模式、补贴模式、订单模式三种结算方式中，在设计日志打点规范时, 会预留一些扩展字段, 使用时以 JSON 形式表示, 不使用时打默认值。</p>
<p><strong>(2) 账单计算线上化</strong></p>
<p>在补贴结算模式中，之前不同业务都有各自的账单格式设计，同时存在离线人工计算账单的非规范化场景，账单无法统一在线计算、存储、监管。新的结算中台的补贴结算模式，将所有离线结算模式，使用统一的账单格式，全部实现线上化结算，实现了业务结算流程规范化。</p>
<p><strong>(3) 账单计算逻辑优化</strong></p>
<p>比如在广告模式中，百家号业务的公域视频、图文、动态场景中，由于收入口径调整，迭代效率要求，不再需要进行广告拼接，所以专门对账单计算流程做了优化调整。不仅满足业务诉求，同时做了通用化设计考虑，保证后续其他业务也可以使用这套流程的同时， 也能兼容旧的业务流程。</p>
<p>广告模式结算流程优化前：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/868c1655e3ce4704ae82d5be9dd06a70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=ZAWoUHMIo1XRWGw4HZznFnnq0OQ%3D" alt="图片" loading="lazy"/></p>
<p>广告模式结算流程优化后：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c23b8ef5b2a47cb9345bf7b2ed62d4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=S0NI5VZZVc1yfKyq2GM3%2F2MphBM%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-9"><strong>2. 分润模型通用化</strong></h3>
<p>不同业务场景，不同结算对象，有不同的结算诉求，不仅要满足业务形态多样化要求，还要具有灵活性。因此抽取业务共性做通用性设计，同时通过可插拔式设计灵活满足个性化需求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc83daf04a734f028f0950a15ab96ae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=1ZHo1IP6sICzYAR%2BACTPWzZrTDo%3D" alt="图片" loading="lazy"/></p>
<p><strong>(1) 基于流量变化模型</strong></p>
<p>以合作站点的优质用户投流方为代表的用户，他们在为百度提供海量数据获得收益的同时，也有自己的诉求，那就是自己内容的收益不能受到其他用户内容的影响。自己优质内容不能被其他用户冲淡，当然自己的低质内容也不会去拉低别人的收益水平。</p>
<p>对于此部分用户我们提供“基于流量变现的分润”策略，简单来说就是，某一篇内容的收益仅仅由它自己内容页面挂载的广告消费折算而来，这样就保证了优质用户投流方收益的相对独立，也促使优质用户产出更加多的内容。</p>
<p><strong>(2) 基于内容分发模型</strong></p>
<ul>
<li>
<p>部分作者只关注收益回报: 对百家号的某些作者来说，他们的目的很单纯，他们只关注产出的内容是否获得具有竞争力的收益回报，至于收益怎么来他们并不关心。</p>
</li>
<li>
<p>“基于流量变现”策略不妥此时，我们再使用“基于流量变现”的策略的话，就有些不妥，举个极端里的例子，有一个作者比较倒霉，每次分发都没有广告的渲染，那他是不是颗粒无收？这对作者是很不友好的。</p>
</li>
<li>
<p>“基于内容分发的分润”模型: 基于收益平衡性考虑，我们推出了更加适合百家号用户的“基于内容分发的分润”模型。在这种模型下，只要内容有分发，就一定有收益，而不管本身是否有广告消费。</p>
</li>
<li>
<p>策略平衡考虑: 当然，为了防止海量产出低质内容来刷取利润，在分润模型上，我们同时将内容质量分和运营因子作为分润计算的权重，也就是说作者最终的收益由内容的质量和内容的分发量共同决定，以达到通过调整分润来指导内容产出的目的。</p>
</li>
</ul>
<p><strong>(3) 基于作者标签模型</strong></p>
<p>为了实现对百家号头部优质作者进行激励，促进内容生态良性发展, 会对不同的作者进行打标, 并且使用不同的分润模型, 比如对公域的百家号作者进行打标, 优质作者, 通过动态单价及内容质量权重策略来给到他们更加的分成, 其他的普通作者, 通过内容分发模型来分润。这样不仅保证了优质作者取得高收益，也保证了其他作者也有一定的收益</p>
<p>另外，出于对预算的精确控制，发挥每一笔预算的钱效，优质的作者会占用较大的预算资金池，而普通作者使用占用较少的预算资金池。同时也会对每类资金池进行上下限控制，保证预算不会花超。</p>
<p><strong>(4) 基于运营场景模型</strong></p>
<p>为了实现对百家号作者的精细化运营，比如对一些参与各类短期活动的作者给予一定的阶段性的奖励，可以通过补贴模型来实现。在一些运营活动中，需要控制部分作者的分成上限，分润模型会进行多轮分成计算，如果作者的收益未触顶并且资金池还有余额的情况下，会对余额进行二次分配，给作者再分配一些收益。此类模型主要是为了实现灵活多变的作者分润策略。</p>
<h3 data-id="heading-10"><strong>3. 技术架构统一</strong></h3>
<p>根据业务流程标准化、分润模型通用化的设计原则，建设统一的结算中台。以下是结算中台统一结算业务前后的对比：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca3fc700112c4d2bbe5eef5258710396~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=QTJ1DM1Pq%2BVn1gDsIU7JQ05pPFQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/161bd1c491d941e59b3562cb42e589fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=%2BTUUSxHu1GRLdZlT26vo76IY8fI%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-11"><strong>4. 建设账单测算能力</strong></h3>
<p>为各个需要测算能力的业务，设计了一套通用的测算流程，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a87191457fa4385aa66565ea3369e1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=jnvFR%2F6nQfSEWdjvmKRUY%2FjXNNU%3D" alt="图片" loading="lazy"/></p>
<p>针对每个测算业务，设计了独立的测算参数管理后台，用于管理业务相关的分润模型参数，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02ecd74ee4994f808e55937be0721377~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqmR2Vla-ivtA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084111&amp;x-signature=bTCgw5jfaEIE4wUINrI%2FSgMJ0Mc%3D" alt="图片" loading="lazy"/></p>
<p>测算流程设计</p>
<p>(1) 功能简述: 每个测算业务, 产品需要登录模型参数管理后台,此后台支持对分润模型参数进行创建、查看、编辑、测算、复制、上线、删除，以及查看测算结果等操作, 出于业务流程合规化的要求, 每次模型参数上线前, 需要对变更的参数完成线上备案流程才可以上线，实现分润流程合规线上化。</p>
<p><strong>(2) 流程简述</strong></p>
<ul>
<li>
<p>流程简述概览: 每次测算时， 产品需要先创建一个版本的账单模型测算参数，并发起参数测算，参数状态变成待测算 。</p>
</li>
<li>
<p>离线任务与收益计算: 此后，离线任务会轮询所有的待测算参数，提交Spark任务，调用账单计算模型来计算作者收益，最后生成TDA报告。</p>
</li>
<li>
<p>查看与评估测算报告: 产品在管理平台看到任务状态变成测算完成时, 可以点击 TDA 链接来查看测算报告, 评估是否符合预期。</p>
</li>
<li>
<p>根据预期结果的操作:如果不符合预期，可以编辑参数再次发起测算；如果符合预期，则可以发起备案流程，流程走完后可以提交上线。</p>
</li>
</ul>
<p>(3) 收益明显: 通过账单测算建设, 不仅解决结算需求未备案即已上线或者备案内容与实际实现不一致，甚至缺乏备案流程的业务痛点问题,  而且把业务线下账单计算的流程做到了线上, 做到留痕可追踪。同时也满足了业务高效迭代的诉求, 一次账单测算耗时从半天下降到分钟级, 大大降低了账单测算的人力成本与时间成本。</p>
<h3 data-id="heading-12"><strong>5. 建设质量保障体系</strong></h3>
<p>为了保证业务质量，从以下几方面来建设：</p>
<p>(1) 建设数据预警机制：为保证作者账单数据及时披露, 分润业务涉及的 百余条数据源都签订了 SLA, 每份数据都关联到具体的接口人, 通过如流机器人来监控每个环节的数据到位时间, 并及时发出报警信息, 并推送给具体的接口负责人。对于产出延迟频次高的数据流，会定期拉相关负责人相关复盘，不断优化数据产出时效，保证账单数据在每天如期产出</p>
<p>(2) 数据异常检测机制：对账单数据进行异常波动性检测, 确保数据准确性 ,及时发现并处理潜在异常问题</p>
<p>(3) 自动对账机制：每天自动进行上下游系统间账单明细核对,保证出账数据流转的准确无误。</p>
<p>(4) 日志质检机制：每日例行对日志进行全面质检分析, 及时发现日志打点日志。</p>
<h2 data-id="heading-13">05 中台收益</h2>
<p>结算中台作为公司财务体系的核心，承担多业务线分润计算与资金流转重任。</p>
<p>(1) 通过通用化、标准化设计，高效支撑数十个业务线的精准结算，确保广告、订单、内容分发的业务结算稳定、健康。近一年，结算业务零事故、零损失。</p>
<p>(2) 中台支持多种结算模式与灵活周期管理，实现账单测算自动化，账单测算时间从天级降到小时级。提升效率并减少错误，提升业务需求迭代效率。</p>
<p>(3) 通过业务流程标准化、分润模型通用化、账单测算能力建设及质量保证体系，解决了结算业务规范缺失、业务形态多样等问题。累计解决历史结算case数十个，涉及结算金额达千万级。</p>
<p>未来，结算中台将推进全业务线结算立项线上化、周结与测算能力落地、项目全生命周期管理，并依托大模型能力实现数据智能分析，进一步提升数据分析智能化水平，为公司业务稳健发展提供坚实保障。</p>
<h2 data-id="heading-14">06 未来规划</h2>
<p>1、推进全业务线结算实现立项线上化；</p>
<p>2、推进周结 、测算能力在各业务线上落地；</p>
<p>3、推进项目全生命周期管理，实现项目从上线到下线整体生命周期变化线上化存档，可随时回顾复盘。</p>
<p>4、数据智能分析，依托公司大模型能力，实现通过多轮对话问答来进行数据分析，针对业务问题进行答疑解惑，提升数据分析的智能化水平。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[安全保护协议 SSL 和 TLS 的区别]]></title>    <link>https://juejin.cn/post/7586851351469064232</link>    <guid>https://juejin.cn/post/7586851351469064232</guid>    <pubDate>2025-12-23T08:45:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586851351469064232" data-draft-id="7441944462933114917" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="安全保护协议 SSL 和 TLS 的区别"/> <meta itemprop="keywords" content="HTTP,后端"/> <meta itemprop="datePublished" content="2025-12-23T08:45:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一线大码"/> <meta itemprop="url" content="https://juejin.cn/user/3280598429340984"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            安全保护协议 SSL 和 TLS 的区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598429340984/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一线大码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:45:15.000Z" title="Tue Dec 23 2025 08:45:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>SSL（安全套接层）和TLS（传输层安全性）都是用于保护网络通信的协议，但它们之间存在一些重要的区别：</p>
<h3 data-id="heading-0">1. <strong>版本</strong></h3>
<ul>
<li><strong>SSL</strong>：最初由网景公司开发，已有多个版本（如SSL 2.0和SSL 3.0），但由于安全漏洞，现已不再使用。</li>
<li><strong>TLS</strong>：是SSL的后继者，当前版本为TLS 1.3。TLS对SSL进行了改进，提供了更高的安全性和性能。</li>
</ul>
<h3 data-id="heading-1">2. <strong>安全性</strong></h3>
<ul>
<li><strong>SSL</strong>：已经被证明含有多种安全漏洞，因此不再推荐使用。</li>
<li><strong>TLS</strong>：采用了更新的加密算法和更加严格的安全措施，例如支持更强的密码套件和减少握手过程中的潜在风险。</li>
</ul>
<h3 data-id="heading-2">3. <strong>握手过程</strong></h3>
<ul>
<li><strong>SSL</strong>：握手过程相对简单，但由于设计缺陷，容易受到中间人攻击（MITM）等攻击。</li>
<li><strong>TLS</strong>：改进了握手过程，使其更加安全和灵活，允许客户端和服务器协商使用哪些加密算法。</li>
</ul>
<h3 data-id="heading-3">4. <strong>功能</strong></h3>
<ul>
<li><strong>SSL</strong>：功能较为基础，支持有限的身份验证和加密选项。</li>
<li><strong>TLS</strong>：引入了更多的功能，如会话恢复、零RTT（Round Trip Time）数据发送等，提高了性能和用户体验。</li>
</ul>
<h3 data-id="heading-4">5. <strong>兼容性</strong></h3>
<ul>
<li><strong>SSL</strong>：由于其已过时，不再受到支持，现代浏览器和应用程序通常不再支持SSL。</li>
<li><strong>TLS</strong>：目前广泛应用于各种网络协议（如HTTPS、SMTP、IMAP等），并得到广泛支持。</li>
</ul>
<h3 data-id="heading-5">总结</h3>
<p>虽然SSL和TLS都旨在提供安全的网络通信，但由于SSL的安全性不足，TLS已成为现代互联网通信的标准。建议所有应用程序和服务使用TLS而非SSL来确保安全性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[机器学习 线性回归]]></title>    <link>https://juejin.cn/post/7586614240532217882</link>    <guid>https://juejin.cn/post/7586614240532217882</guid>    <pubDate>2025-12-23T08:48:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586614240532217882" data-draft-id="7586540799220203561" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="机器学习 线性回归"/> <meta itemprop="keywords" content="后端,Python,机器学习"/> <meta itemprop="datePublished" content="2025-12-23T08:48:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哪里的破水瓶"/> <meta itemprop="url" content="https://juejin.cn/user/4394111849466414"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            机器学习 线性回归
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4394111849466414/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哪里的破水瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:48:46.000Z" title="Tue Dec 23 2025 08:48:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">线性回归</h2>
<p>回归问题：目标是预测连续数值（体重），而不是分类标签</p>
<p>术语：</p>
<ul>
<li>自变量（特征）</li>
<li>因变量（目标）</li>
</ul>
<p>比如，已知身高，求体重，这里，体重是<strong>因变量</strong>，身高是<strong>自变量</strong>。</p>
<ul>
<li>K：斜率（weight 权重）</li>
<li>X：自变量</li>
<li>b：截距（bias 偏置）</li>
</ul>
<p>公式是：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>=</mo><mi>k</mi><mi>X</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">Y = kX + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>，这只是<strong>一元线程回归</strong></p>
<blockquote>
<p>我们需要算出来，斜率是多少，截距是多少</p>
</blockquote>
<p><strong>回归方程函数</strong></p>
<p>为什么还有这个公式呢，因为正常情况下不可能只有一个特征。</p>
<p>这 T 表示 k 的转置（把列向量变成行向量，用于点积）</p>
<p>公式：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><msup><mi>k</mi><mi>x</mi></msup><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">y = k^x + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
<blockquote>
<p>公式的由来</p>
</blockquote>
<p>假设已知有多个特征，如下，所以一元线程回归</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3560342ab444c9bb5d65a8b397c6fe2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=%2BdXfWoBXkKej92NwM4aHmS18DrA%3D" alt="image.png" loading="lazy"/></p>
<p>所以变成了如下：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><msub><mi>k</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>k</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mo separator="true">⋅</mo><mo separator="true">⋅</mo><mo separator="true">⋅</mo><mo>+</mo><msub><mi>k</mi><mi>n</mi></msub><msub><mi>x</mi><mi>n</mi></msub><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">y = k_{1}x_{1} + k_{2}x_{2} + ··· + k_{n}x_{n} + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">+</span><span class="mpunct">⋅⋅⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">+</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
<p>如何把 b 截距引进来的，所以要在最开始加一个 w0，表示 截距b，x0 用 1 表示。这样再实现矩阵相乘就可以了。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold-italic">k</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>k</mi><mn>0</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>k</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>k</mi><mn>2</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"/></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>k</mi><mi>n</mi></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><mi mathvariant="bold-italic">x</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>0</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>2</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"/></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mi>n</mi></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\boldsymbol{k} = \begin{bmatrix}
k_0 \\
k_1 \\
k_2 \\
\vdots \\
k_n
\end{bmatrix}, \quad
\boldsymbol{x} = \begin{bmatrix}
x_0 \\
x_1 \\
x_2 \\
\vdots \\
x_n
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.01852em;">k</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:6.66em;vertical-align:-3.08em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.55em;"><span style="top:-5.55em;"><span class="pstrut" style="height:8.6em;"/><span style="width:0.667em;height:6.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="6.600em" viewbox="0 0 667 6600"><path d="M403 1759 V84 H666 V0 H319 V1759 v3000 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v3000 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.05em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.58em;"><span style="top:-6.4275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-4.0275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"/></span></span></span><span style="top:-0.9675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.08em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.55em;"><span style="top:-5.55em;"><span class="pstrut" style="height:8.6em;"/><span style="width:0.667em;height:6.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="6.600em" viewbox="0 0 667 6600"><path d="M347 1759 V0 H0 V84 H263 V1759 v3000 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v3000 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.05em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:6.66em;vertical-align:-3.08em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.55em;"><span style="top:-5.55em;"><span class="pstrut" style="height:8.6em;"/><span style="width:0.667em;height:6.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="6.600em" viewbox="0 0 667 6600"><path d="M403 1759 V84 H666 V0 H319 V1759 v3000 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v3000 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.05em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.58em;"><span style="top:-6.4275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-5.2275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-4.0275em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.1675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"/></span></span></span><span style="top:-0.9675em;"><span class="pstrut" style="height:3.6875em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.08em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.55em;"><span style="top:-5.55em;"><span class="pstrut" style="height:8.6em;"/><span style="width:0.667em;height:6.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="6.600em" viewbox="0 0 667 6600"><path d="M347 1759 V0 H0 V84 H263 V1759 v3000 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v3000 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.05em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>线性回归案例：</p>
<ul>
<li>钢轨伸缩长度与温度</li>
<li>昆虫鸣叫次数与天气</li>
<li>国内GDP与双十一销售额</li>
</ul>
<h4 data-id="heading-1">线性回归API</h4>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression

<span class="hljs-comment"># 案例基于身高，预测体重</span>

<span class="hljs-comment"># 1. 获取数据</span>
x_train = [[<span class="hljs-number">160</span>], [<span class="hljs-number">166</span>], [<span class="hljs-number">172</span>], [<span class="hljs-number">174</span>], [<span class="hljs-number">180</span>]]
y_train = [<span class="hljs-number">56.3</span>, <span class="hljs-number">60.6</span>, <span class="hljs-number">65.1</span>, <span class="hljs-number">68.5</span>, <span class="hljs-number">75</span>]

x_test = [[<span class="hljs-number">176</span>]]

<span class="hljs-comment"># 2. 数据预处理</span>
<span class="hljs-comment"># 3. 特征工程</span>

<span class="hljs-comment"># 4. 模型训练</span>
<span class="hljs-comment"># 创建回归模型</span>
estimator = LinearRegression()
estimator.fit(x_train, y_train)

<span class="hljs-comment"># 5. 模型预测</span>
y_predict = estimator.predict(x_test)
<span class="hljs-built_in">print</span>(y_predict) <span class="hljs-comment"># 70.3047619</span>

<span class="hljs-comment"># 6. 模型评估</span>
<span class="hljs-comment"># 斜率</span>
<span class="hljs-built_in">print</span>(estimator.coef_) <span class="hljs-comment"># 0.92942177</span>
<span class="hljs-comment"># 截距</span>
<span class="hljs-built_in">print</span>(estimator.intercept_) <span class="hljs-comment"># -93.27346938775517</span>
</code></pre>
<p>这里不画拟合回归线。</p>
<h3 data-id="heading-2">损失函数</h3>
<p>上面我们能得知，用API生成一条拟合回归线。</p>
<p>我们一眼能看出红色的直线。但是这个线是怎么求出来的呢？</p>
<p>是通过：<strong>误差 = 预测值 - 真实值，越小越好</strong></p>
<p>所以需要损失函数，<strong>衡量每个样本的预测值与真实值效果的函数</strong>，也叫代价函数、成本函数、目标函数</p>
<p>更好的拟合所有的点，也就是<strong>误差最小，误差和最小</strong></p>
<blockquote>
<p>损失函数计算方式</p>
</blockquote>
<p>我们来计算出来，斜率（权重）和截距（偏置）</p>
<ul>
<li>损失函数：用来描述每个样本值 和 预测值之间的关系的</li>
<li>误差 = 预测值 - 真实值</li>
</ul>
<p>已知：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abcb01225cbc426a9c8b801b062189c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=eHCFmKTvTkxerB9vb0VmxA9yIgI%3D" alt="image.png" loading="lazy"/></p>
<p>拿 点5 举例子</p>
<ol>
<li>kx + b</li>
<li>代入 = 180k + b</li>
<li>再减去真实值 = 180k + b - 75</li>
</ol>
<p>得出公式是：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mi>x</mi><mo>+</mo><mi>b</mi><mo>−</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">kx + b - y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span>，其中 y 是真实值。</p>
<p>注意下图：w 其实是 k，这里写错了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54a4a9e4d8d34c629ae01f44c638d952~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=xRNfbkcXwdhAlWe8NV%2Ft1uDsBbE%3D" alt="image.png" loading="lazy"/></p>
<p>这样计算之后，可能有的结果是正的，有的结果是负的。</p>
<blockquote>
<p>所以又分为三种计算方式</p>
</blockquote>
<ol>
<li>最小二乘：每个样本的误差值的平方和</li>
<li>均方误差：最小二乘 / 样本数</li>
<li>平均绝对值误差：每个样本的误差的绝对值的平均值</li>
</ol>
<h4 data-id="heading-3">最小二乘解法如下</h4>
<p>根据上面的例子</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>损失函数</mtext><mi>L</mi><mo stretchy="false">(</mo><mi>k</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><mo>+</mo><mi>b</mi><mo>−</mo><mn>56.3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>166</mn><mi>k</mi><mo>+</mo><mi>b</mi><mo>−</mo><mn>60.6</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>172</mn><mi>k</mi><mo>+</mo><mi>b</mi><mo>−</mo><mn>65.1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>174</mn><mi>k</mi><mo>+</mo><mi>b</mi><mo>−</mo><mn>68.5</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>180</mn><mi>k</mi><mo>+</mo><mi>b</mi><mo>−</mo><mn>75</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">损失函数L(k,b) = (160k + b - 56.3)^2 + (166k + b - 60.6)^2 + (172k + b - 65.1)^2 + (174k + b - 68.5)^2 + (180k + b - 75)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">损失函数</span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">56.3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">166</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">60.6</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">172</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">65.1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">174</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">68.5</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">180</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">75</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>为了简便运算，这里先固定 b = -100</p>
<p>于是公式变成了如下：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>损失函数</mtext><mi>L</mi><mo stretchy="false">(</mo><mi>k</mi><mo separator="true">,</mo><mi>b</mi><mo>=</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>−</mo><mn>56.3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>166</mn><mi>k</mi><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>−</mo><mn>60.6</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>172</mn><mi>k</mi><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>−</mo><mn>65.1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>174</mn><mi>k</mi><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>−</mo><mn>68.5</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>180</mn><mi>k</mi><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>−</mo><mn>75</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">损失函数L(k,b = -100) = (160k + (-100) - 56.3)^2 + (166k + (-100) - 60.6)^2 + (172k + (-100) - 65.1)^2 + (174k + (-100) - 68.5)^2 + (180k + (-100) - 75)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">损失函数</span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">56.3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">166</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">60.6</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">172</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">65.1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">174</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">68.5</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">180</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">75</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>我们先计算这一小块</strong></p>
<p>已知：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>100</mn><mo stretchy="false">)</mo><mo>−</mo><mn>56.3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">(160k + (-100) - 56.3)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">100</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">56.3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>合并常数项 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><mo>−</mo><mn>156.3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">(160k - 156.3)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">156.3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>此时我们发现</strong>这就是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>a</mi><mo>−</mo><msup><mi>b</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(a - b^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>a</mi><mn>2</mn></msup><mo>−</mo><mn>2</mn><mi>a</mi><mi>b</mi><mo>+</mo><msup><mi>b</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">a^2 - 2ab + b^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>这是完全平方公式哈。</p>
<blockquote>
<p>继续计算</p>
</blockquote>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><mo>−</mo><mn>156.3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>166</mn><mi>k</mi><mo>−</mo><mn>160.6</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>172</mn><mi>k</mi><mo>−</mo><mn>165.1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>174</mn><mi>k</mi><mo>−</mo><mn>168.5</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mn>180</mn><mi>k</mi><mo>−</mo><mn>175</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">= (160k - 156.3)^2 + (166k -160.6)^2 + (172k -165.1)^2 + (174k -168.5)^2 + (180k -175)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">156.3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">166</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">160.6</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">172</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">165.1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">174</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">168.5</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">180</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">175</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mn>2</mn><mo>∗</mo><mn>160</mn><mi>k</mi><mo>∗</mo><mn>156.3</mn><mo>+</mo><mn>156.</mn><msup><mn>3</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>166</mn><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mn>2</mn><mo>∗</mo><mn>166</mn><mi>k</mi><mo>∗</mo><mn>160.6</mn><mo>+</mo><mn>160.</mn><msup><mn>6</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>172</mn><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mn>2</mn><mo>∗</mo><mn>172</mn><mi>k</mi><mo>∗</mo><mn>165.1</mn><mo>+</mo><mn>165.</mn><msup><mn>1</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>174</mn><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mn>2</mn><mo>∗</mo><mn>174</mn><mi>k</mi><mo>∗</mo><mn>168.5</mn><mo>+</mo><mn>168.</mn><msup><mn>5</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>180</mn><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mn>2</mn><mo>∗</mo><mn>180</mn><mi>k</mi><mo>∗</mo><mn>175</mn><mo>+</mo><mn>17</mn><msup><mn>5</mn><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">= ((160k)^2 - 2 * 160k * 156.3 + 156.3^2) + ((166k)^2 - 2 * 166k * 160.6 + 160.6^2) + ((172k)^2 - 2 * 172k * 165.1 + 165.1^2) + ((174k)^2 - 2 * 174k * 168.5 + 168.5^2) + ((180k)^2 - 2 * 180k * 175 + 175^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">156.3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">156.</span><span class="mord"><span class="mord">3</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord">166</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">166</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">160.6</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">160.</span><span class="mord"><span class="mord">6</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord">172</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">172</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">165.1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">165.</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord">174</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">174</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">168.5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">168.</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord">180</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">180</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">175</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">17</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<blockquote>
<p>下面我用第一个演示一下，每一个都要计算，有点多</p>
</blockquote>
<p>分别计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mn>160</mn><mi>k</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mn>2</mn><mo>∗</mo><mn>160</mn><mi>k</mi><mo>∗</mo><mn>156.3</mn><mo>+</mo><mn>156.</mn><msup><mn>3</mn><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">((160k)^2 - 2 * 160k * 156.3 + 156.3^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord">160</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">156.3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">156.</span><span class="mord"><span class="mord">3</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 的平方项、一次项、常数项</p>
<ul>
<li>平方项 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>160</mn><mo>∗</mo><mn>160</mn><mo>∗</mo><msup><mi>k</mi><mn>2</mn></msup><mo>=</mo><mn>25600</mn><msup><mi>k</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">160 * 160 * k^2 = 25600k^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">160</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">160</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord">25600</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></li>
<li>一次项 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>2</mn><mo>∗</mo><mn>160</mn><mo>∗</mo><mn>156.3</mn><mo>∗</mo><mi>k</mi><mo>=</mo><mo>−</mo><mn>50016</mn><mi>k</mi></mrow><annotation encoding="application/x-tex">-2 * 160 * 156.3 * k = -50016k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">160</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">156.3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">50016</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span></li>
<li>常数项 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>156.3</mn><mo>∗</mo><mn>156.3</mn><mo>=</mo><mn>24</mn><mo separator="true">,</mo><mn>429.69</mn></mrow><annotation encoding="application/x-tex">156.3 * 156.3 = 24,429.69</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">156.3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">156.3</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">24</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">429.69</span></span></span></span></span></li>
</ul>
<p>所以等于
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mn>25600</mn><mi>k</mi><mo>−</mo><mn>50016</mn><mi>k</mi><mo>+</mo><mn>24429.69</mn></mrow><annotation encoding="application/x-tex">= 25600k - 50016k + 24429.69</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord">25600</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord">50016</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">24429.69</span></span></span></span></span></p>
<p>但是这里是不能直接这样的，要把所有的项目合起来，平方项、一次项、常数项相加，最后计算。</p>
<p>一共五个数据点计算后</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mn>25600</mn><msup><mi>k</mi><mn>2</mn></msup><mo>−</mo><mn>50016</mn><mi>k</mi><mo>+</mo><mn>24429.69</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mn>27556</mn><msup><mi>k</mi><mn>2</mn></msup><mo>−</mo><mn>53319.2</mn><mi>k</mi><mo>+</mo><mn>25792.36</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mn>29584</mn><msup><mi>k</mi><mn>2</mn></msup><mo>−</mo><mn>56794.4</mn><mi>k</mi><mo>+</mo><mn>27258.01</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mn>30276</mn><msup><mi>k</mi><mn>2</mn></msup><mo>−</mo><mn>58638</mn><mi>k</mi><mo>+</mo><mn>28392.25</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mn>32400</mn><msup><mi>k</mi><mn>2</mn></msup><mo>−</mo><mn>63000</mn><mi>k</mi><mo>+</mo><mn>302625</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
&amp;= 25600k^2 - 50016k + 24429.69 \\
&amp;= 27556k^2 - 53319.2k + 25792.36 \\
&amp;= 29584k^2 - 56794.4k + 27258.01 \\
&amp;= 30276k^2 - 58638k + 28392.25 \\
&amp;= 32400k^2 - 63000k + 302625 \\
\end{align*}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:7.6205em;vertical-align:-3.5603em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.0603em;"><span style="top:-6.0603em;"><span class="pstrut" style="height:2.8641em;"/><span class="mord"/></span><span style="top:-4.5362em;"><span class="pstrut" style="height:2.8641em;"/><span class="mord"/></span><span style="top:-3.0121em;"><span class="pstrut" style="height:2.8641em;"/><span class="mord"/></span><span style="top:-1.4879em;"><span class="pstrut" style="height:2.8641em;"/><span class="mord"/></span><span style="top:0.0362em;"><span class="pstrut" style="height:2.8641em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.5603em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.0603em;"><span style="top:-6.1962em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">25600</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">50016</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">24429.69</span></span></span><span style="top:-4.6721em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">27556</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">53319.2</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">25792.36</span></span></span><span style="top:-3.1479em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">29584</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">56794.4</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">27258.01</span></span></span><span style="top:-1.6238em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">30276</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">58638</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">28392.25</span></span></span><span style="top:-0.0997em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">32400</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">63000</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">302625</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.5603em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>平方项、一次项、常数项的总结果 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>145</mn><mo separator="true">,</mo><mn>416</mn><msup><mi>k</mi><mn>2</mn></msup><mo>−</mo><mn>281</mn><mo separator="true">,</mo><mn>767.6</mn><mi>k</mi><mo>+</mo><mn>408</mn><mo separator="true">,</mo><mn>497.31</mn></mrow><annotation encoding="application/x-tex">145,416k^2 - 281,767.6k + 408,497.31</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"/><span class="mord">145</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">416</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord">281</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">767.6</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">408</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">497.31</span></span></span></span></span></p>
<blockquote>
<p>计算 K 值</p>
</blockquote>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mo>−</mo><mo stretchy="false">(</mo><mo>−</mo><mn>281</mn><mo separator="true">,</mo><mn>767.6</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>2</mn><mo>∗</mo><mn>145</mn><mo separator="true">,</mo><mn>416</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0.968832865709413</mn></mrow><annotation encoding="application/x-tex">k = -(-281,767.6) / (2*145,416) = 0.968832865709413</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">−</span><span class="mopen">(</span><span class="mord">−</span><span class="mord">281</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">767.6</span><span class="mclose">)</span><span class="mord">/</span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">145</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">416</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.968832865709413</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>或者直接：</mtext><mn>281767.6</mn><mi mathvariant="normal">/</mi><mn>2</mn><mi mathvariant="normal">/</mi><mn>145416</mn></mrow><annotation encoding="application/x-tex">或者直接：281767.6 / 2 / 145416</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">或者直接：</span><span class="mord">281767.6/2/145416</span></span></span></span></span></p>
<blockquote>
<p>总结</p>
</blockquote>
<p>缺点：当样本点比较多的时候，值会非常大。</p>
<h4 data-id="heading-4">总结</h4>
<blockquote>
<p>最小二乘</p>
</blockquote>
<p>每个样本的误差值的平方和</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>损失函数</mtext><mi>J</mi><mo stretchy="false">(</mo><mi>w</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>m</mi></msubsup><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">损失函数J(w,b) = \sum_{i=0}^m(h(x^{(i)}) - y^{(i)})^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">损失函数</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<blockquote>
<p>均方误差 (Mean-Square Error, MSE)</p>
</blockquote>
<p>每个样本的误差值的平方和的平均值</p>
<p>方块圈住的就是最小二乘</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa8c54c84526439da0389d6077faf727~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=V4QKwpy1fVMkr4zdTiHtOZ9Tfr0%3D" alt="image.png" loading="lazy"/></p>
<p>i 表示具体的第几个样本</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>损失函数</mtext><mi>J</mi><mo stretchy="false">(</mo><mi>w</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>m</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>m</mi></msubsup><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">损失函数J(w,b) = \frac{1}{m}\sum_{i=0}^m(h(x^{(i)}) - y^{(i)})^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">损失函数</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.233em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<blockquote>
<p>平均绝对值误差 (Mean Absolute Error , MAE)</p>
</blockquote>
<p>每个样本的误差值的绝对值的和的平均值</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>损失函数</mtext><mi>J</mi><mo stretchy="false">(</mo><mi>w</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>m</mi></mfrac><msubsup><mo>∑</mo><mn>0</mn><mi>m</mi></msubsup><mrow><mo fence="true">∣</mo><mi>h</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo fence="true">∣</mo></mrow></mrow><annotation encoding="application/x-tex">损失函数J(w,b) = \frac{1}{m}\sum_{0}^m \left| h(x^{(i)}) - y^{(i)} \right|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord cjk_fallback">损失函数</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.238em;vertical-align:-0.35em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:3.2em;"/><span style="width:0.333em;height:1.200em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.333em" height="1.200em" viewbox="0 0 333 1200"><path d="M145 15 v585 v0 v585 c2.667,10,9.667,15,21,15&#10;c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15&#10;c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v0 v585 h43z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span/></span></span></span></span></span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-2.85em;"><span class="pstrut" style="height:3.2em;"/><span style="width:0.333em;height:1.200em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.333em" height="1.200em" viewbox="0 0 333 1200"><path d="M145 15 v585 v0 v585 c2.667,10,9.667,15,21,15&#10;c10,0,16.667,-5,20,-15 v-585 v0 v-585 c-2.667,-10,-9.667,-15,-21,-15&#10;c-10,0,-16.667,5,-20,15z M188 15 H145 v585 v0 v585 h43z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<h3 data-id="heading-5">线性回归问题求解需要什么？</h3>
<p>损失函数越小，越好</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2945c1b1ec394d2daf001a432cc6c3b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=4P39E%2FQwJrfOD5CH66Xj%2BXUWKr0%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>损失函数可用来描述输出（预测值）和观测结果（真实值）效果，可衡量模型效果好坏</li>
<li>不同的任务比如分类、回归、聚类问题，一般会采用各自的损失函数</li>
<li>线性回归求解一般需要数据、假设函数、损失函数、损失函数优化方法等部分，相互配合共同完成</li>
</ul>
<h2 data-id="heading-6">复习</h2>
<h3 data-id="heading-7">复习导数</h3>
<p>当函数 𝑦=𝑓(𝑥) 的自变量 𝑥 在一点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>𝑥</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">𝑥_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 上产生一个增量 Δ𝑥 时，函数输出值的增量 Δ𝑦 与自变量增量 Δ𝑥 的比值在 Δ𝑥 趋于0 时的极限 𝐴 如果存在，𝐴 即为在 𝑥 处的导数，记作<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>f</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><msub><mi>x</mi><mi>o</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f'(x_o)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22040754070f45e0a1f7466d68875a4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=YysFsWneAQXrZ%2BJ7%2BVaU%2F4u1MS8%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>导数的几何意义</p>
</blockquote>
<p>函数 y=f(x) 在点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">x_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 处的导数的几何意义，就是曲线 y=f(x) 在点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>0</mn></msub><mo separator="true">,</mo><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x_0,f(x_0))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">))</span></span></span></span></span> 处的切线的斜率，即曲线 y=f(x) 在<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>0</mn></msub><mo separator="true">,</mo><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x_0, f(x_0)) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">))</span></span></span></span></span>处的切线的斜率是f'(x_0)。</p>
<blockquote>
<p>常见函数的导数</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/771b16b94d4246fb8e6d96b66d2df0eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=5n%2Fb9tsW4VAcjk%2Bn5zTNnwaGACE%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>导数的四则运算</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03f14bcd776e43e4a393acfc6a37e6c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=bcHl9h2K67bXt34kYz%2Bg4SuppzA%3D" alt="image.png" loading="lazy"/></p>
<p>直接套公式</p>
<p>第二个我说一下，公式是， (a * b)' = a' * b + a * b'</p>
<p>第四个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mi>e</mi><mrow><mn>2</mn><mi>x</mi></mrow></msup><msup><mo stretchy="false">)</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">(e^{2x})'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<ul>
<li>= 带入公式，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mi>x</mi></msup></mrow><annotation encoding="application/x-tex">e^x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6644em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span> 的导还是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mi>x</mi></msup></mrow><annotation encoding="application/x-tex">e^x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6644em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span>，所以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mn>2</mn><mi>x</mi></mrow></msup></mrow><annotation encoding="application/x-tex">e^{2x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span></span> = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mn>2</mn><mi>x</mi></mrow></msup></mrow><annotation encoding="application/x-tex">e^{2x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span></span></li>
<li>= 求2x的导，还是 2 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><msup><mi>e</mi><mrow><mn>2</mn><mi>x</mi></mrow></msup></mrow><annotation encoding="application/x-tex">2e^{2x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord">2</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">x</span></span></span></span></span></span></span></span></span></span></span></span></span></li>
</ul>
<p><strong>题</strong></p>
<p>举个例子:计算该函数y = 〖"(" 𝑥^2 "+2x)" 〗^2 的导函数</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5cce1b8f7024ea68b4f64946e89bcc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=2XMYQqILlD2pcUT5VuCl4Z8XgRE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b55969ffb5e64c4caf3b061fd62d5350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=Krjj0dbPLl%2BuTNB%2BO9tur%2BwNEmo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d66475db42894e8baa48ab27428f1696~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=9lJzLyg5SnhrxQWOm8ZYJrZu0Sk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">偏导</h3>
<blockquote>
<p>导数求极值</p>
</blockquote>
<p>导数为0的位置是函数的极值点</p>
<ul>
<li>求函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><msup><mi>𝑥</mi><mn>2</mn></msup><mo>−</mo><mn>4</mn><mi>x</mi><mo>+</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">y = 𝑥^2 - 4x + 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">4</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span></span></span></span></span> 的极小值</li>
</ul>
<p>求导法：对x求导，令导数</p>
<ul>
<li>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mtext>：</mtext><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mn>2</mn><mi>x</mi><mo>−</mo><mn>4</mn><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">0：y' = 2x - 4 = 0 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord">0</span><span class="mord cjk_fallback">：</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></li>
<li>x = 2</li>
<li>将 x = 2 带入，4 - 8 + 5 = 1</li>
<li>所以y极小值 = 1</li>
</ul>
<blockquote>
<p>多变量导数求解</p>
</blockquote>
<p>Z是关于 x 和 y 的函数记成<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">z(x,y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span>，求解 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo>=</mo><mo stretchy="false">(</mo><mi>𝑥</mi><mo>−</mo><mn>2</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mi>𝑦</mi><mo>−</mo><mn>3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">z = (𝑥−2)^2 + (𝑦−3)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> 的极小值</p>
<p>这题要同时求 x 和 y 的两个未知数，所以思路是，先把 x 和 y 同时解出来，方式就是 乘法法则</p>
<p>首先先计算x，此时 y - 3² = 0</p>
<ul>
<li>(x - 2)²</li>
<li>(x - 2)' * (x - 2)'</li>
<li>(x - 2)' * (x - 2) + (x - 2) * (x - 2)'</li>
<li>1 * (x - 2) + (x - 2) * 1</li>
<li>(x - 2) + (x - 2)</li>
<li>x - x = 2x，-2-2 = -4</li>
<li>2x - 4</li>
<li>2(x - 2) = 0</li>
<li>两边除以 2 = x - 2 = 0</li>
<li>x = 2</li>
</ul>
<p>计算 y，此时 x - 2² = 0</p>
<ul>
<li>(y - 3)²</li>
<li>(y - 3)'(y - 3) + (y - 3)(y - 3)'</li>
<li>(y - 3) + (y - 3)</li>
<li>2y - 6</li>
<li>2(y - 3)</li>
<li>y - 3 = 0</li>
<li>y = 3</li>
</ul>
<blockquote>
<p>上面的有些复杂</p>
</blockquote>
<p>例子：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><mn>2</mn><mi>x</mi><mi>y</mi><mo>−</mo><mn>3</mn><msup><mi>y</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">Z = x^2 + 2xy - 3y^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">2</span><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0085em;vertical-align:-0.1944em;"/><span class="mord">3</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<ul>
<li>x = 2x + 2y（3y²是常数）</li>
<li>y = 2x - 6y（x2是常数）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02865db3cd11467aa51caeffe8bf32d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=39PB6RCuyHyr%2BC%2Fs8%2FQZnrhHm4w%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4276649c41484c4da717392cf3eaf259~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=vHlg%2BaR51kGsoXkB1HpombvUPfc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">向量和矩阵</h3>
<h4 data-id="heading-10">向量运算</h4>
<blockquote>
<p>向量是有大小和方向</p>
</blockquote>
<p>几何意义上表示：向量(1,1), 向量（1,2）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d026f8fd8ed479cbb98909ce3f4189c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=Xu8C43aG33mBxUvKxvFS0kX7ht8%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>向量基运算</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da722c622a8f4c9583ec2d3b79f187ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=rkeoC%2FGqzodEJd%2F%2BTLcP%2BztkZD8%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>向量矩阵转置 Transpose</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3019e0bfa4c44458b5008157072156bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=RA76%2B7mbrC09zyNcVTq811Uu7Dw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">范数Norm</h4>
<p>范数(norm)是数学中的一种基本概念，具有长度的意义</p>
<ul>
<li>1范数(L1范数)-向量中各个元素绝对值之和</li>
<li>2范数(L2范数)-向量的模长，每个元素平方求和，再开平方根</li>
<li>p-范数：向量中每一个元素p幂求和，在开p次根</li>
</ul>
<blockquote>
<p>L1范数</p>
</blockquote>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝑥</mi><mi>𝑇</mi></msup><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>−</mo><mn>3</mn><mo stretchy="false">)</mo><mtext>‖</mtext><mi>x</mi><msub><mtext>‖</mtext><mn>1</mn></msub><mo>=</mo><mi mathvariant="normal">∣</mi><mn>1</mn><mi mathvariant="normal">∣</mi><mo>+</mo><mi mathvariant="normal">∣</mi><mn>2</mn><mi mathvariant="normal">∣</mi><mo>+</mo><mi mathvariant="normal">∣</mi><mo>−</mo><mn>3</mn><mi mathvariant="normal">∣</mi><mo>=</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">𝑥^𝑇 = (1,  2,  −3)   ‖x‖_1 = |1| + |2| + |−3| = 6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">3</span><span class="mclose">)</span><span class="mord">‖</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord">‖</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣1∣</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣2∣</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">3∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">6</span></span></span></span></span></p>
<blockquote>
<p>L2范数</p>
</blockquote>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝑥</mi><mi>𝑇</mi></msup><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>−</mo><mn>3</mn><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mi mathvariant="normal">∣</mi><msub><mi mathvariant="normal">∣</mi><mn>2</mn></msub><mo>=</mo><mn>2</mn><msqrt><mrow><msup><mn>1</mn><mn>12</mn></msup><mo>+</mo><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt><mo>=</mo><mtext>√</mtext><mn>14</mn></mrow><annotation encoding="application/x-tex">𝑥^𝑇=(1, 2, −3) ||x||_2 = 2\sqrt{1^{12} + 2^2 + (-3)^2} = √14</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">3</span><span class="mclose">)</span><span class="mord">∣∣</span><span class="mord mathnormal">x</span><span class="mord">∣</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.305em;"/><span class="mord">2</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.935em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.895em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.305em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.2em;"/><span class="mord">√14</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝑥</mi><mi>𝑇</mi></msup><mo>=</mo><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>−</mo><mn>3</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">𝑥^𝑇=(1,2,−3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">3</span><span class="mclose">)</span></span></span></span></span></p>
<p>注意：向量的转置@向量</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝑥</mi><mi>𝑇</mi></msup><mi>x</mi><mo>=</mo><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>3</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mn>14</mn></mrow><annotation encoding="application/x-tex">𝑥^𝑇x=1^2+2^2+(−3)^2 = 14</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">3</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">14</span></span></span></span></span></p>
<p>X为向量：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>𝑥</mi><mi>𝑇</mi></msup><mi>x</mi><mtext>与</mtext><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mi mathvariant="normal">∣</mi><msubsup><mi mathvariant="normal">∣</mi><mn>2</mn><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">𝑥^𝑇x 与||x||_2^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord mathnormal">x</span><span class="mord cjk_fallback">与</span><span class="mord">∣∣</span><span class="mord mathnormal">x</span><span class="mord">∣</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4519em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em;"><span/></span></span></span></span></span></span></span></span></span> 是一样的</p>
<p>Lp范数：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">∥</mi><mi>x</mi><msub><mi mathvariant="normal">∥</mi><mi>p</mi></msub><mo>=</mo><msup><mrow><mo fence="true">(</mo><mi mathvariant="normal">∣</mi><msub><mi>x</mi><mn>1</mn></msub><msup><mi mathvariant="normal">∣</mi><mi>p</mi></msup><mo>+</mo><mi mathvariant="normal">∣</mi><msub><mi>x</mi><mn>2</mn></msub><msup><mi mathvariant="normal">∣</mi><mi>p</mi></msup><mo>+</mo><mo>⋯</mo><mo>+</mo><mi mathvariant="normal">∣</mi><msub><mi>x</mi><mi>n</mi></msub><msup><mi mathvariant="normal">∣</mi><mi>p</mi></msup><mo fence="true">)</mo></mrow><mfrac><mn>1</mn><mi>p</mi></mfrac></msup></mrow><annotation encoding="application/x-tex">\|x\|_p = \left( |x_1|^p + |x_2|^p + \cdots + |x_n|^p \right)^{\frac{1}{p}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord">∥</span><span class="mord mathnormal">x</span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3439em;vertical-align:-0.25em;"/><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0939em;"><span style="top:-3.5029em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"/><span class="frac-line mtight" style="border-bottom-width:0.049em;"/></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4829em;"><span/></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"/></span></span></span></span></span></span></span></span></span></span></span></span></span></div>
<h4 data-id="heading-12">矩阵 Matrix 1</h4>
<p>矩阵是数学中的一种基本概念，表达m行n列的数据等</p>
<p>矩阵在机器学习中的表达</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/023f73c776164a298ccecd0df8170cb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=Qzd6nfCcNvLM%2Bw5x4%2BAgZDi%2BO8U%3D" alt="image.png" loading="lazy"/></p>
<p><strong>矩阵加法</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02a538e07ac745098dd77e8a9e0c8352~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=mGZChg15D78TiEqvtyKXO90XORI%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>总结：用 A 的每一行，都要乘以 B 的每一列。</p>
</blockquote>
<p><strong>矩阵乘法 ：对应行列元素相乘，然后再加和再一起</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52037fa9978943a59e377d685ce38849~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=oclqwBU2wnz4DDNR756yQr1Yr64%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f7a939097cb43e1a4f1bae5a3985a70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=UgeBQi2E8vuplMHKeKY5qYvqBNo%3D" alt="image.png" loading="lazy"/></p>
<p>术语：</p>
<ul>
<li>方阵：行列数一样</li>
<li>对称方阵：一种特殊的方阵，沿着主对角线，其元素对称 aij = aji</li>
</ul>
<p>可以发现，1，2 的元素是2，2，1 的元素也是 2</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42e7bbce217f465188a40aa07694da02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=wme3bXslPjsauXxGKAglODHKhWM%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>单位阵：一种特殊的方阵，用符号E或者是I来表示</li>
</ul>
<p>特点：对角线为 1 其他为 0</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51b82a1adbe64b45b1dcbf84dcac19fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=4r68ED2TDon7pKpsvEVM0XBvnFk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">矩阵乘法的性质</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fabd48af1af04b049d754835e21aaace~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=vmC4d9WqT7PMiN39O5ytrFLVLzQ%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>矩阵的逆</p>
</blockquote>
<p>例子：通过 A 和 I 求出 B</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9c2f997c6614ec29b6092992fa67199~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=yXYLWUdJAYmT8rutMX0Bk3URpJk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82cf706c89904212bf82d50ce83da61f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=9H7MKHl%2BZJ3XRZXyTvdTP75N4LM%3D" alt="image.png" loading="lazy"/></p>
<p>已知结果是</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/066f556b73a94ae695828469139ed6ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=iHlaRVK1GMkI88jUJD1SQtX0jeM%3D" alt="image.png" loading="lazy"/></p>
<p>等价于如下图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8e22863e0824c1198e66f3fd563563e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=HbhMtWYQFnjUZ%2B6svKt3i0STctw%3D" alt="image.png" loading="lazy"/></p>
<p>此时我们可以求解出 ac，bd 等于多少。</p>
<blockquote>
<p>求 C 结果如下：</p>
</blockquote>
<p>a + 2c = 1</p>
<p>3a + 4c = 0</p>
<p>首先根据 a + 2c = 1，可以改成 a = 1 - 2c</p>
<p>将a = 1 - 2c 代入 3a + 4c = 0</p>
<ul>
<li>= 3(1 - 2c) + 4c = 0</li>
<li>= 3 - 6c + 4c = 0</li>
<li>合并同类项</li>
<li>-6c + 4c = -2c</li>
<li>3 - 2c = 0</li>
</ul>
<p>解C：</p>
<ul>
<li>3 - 2c = 0</li>
<li>得知：3 - 2(3/2) = 0</li>
<li>3 - 3 = 0</li>
<li>c = 1.5</li>
</ul>
<blockquote>
<p>求 a 结果如下</p>
</blockquote>
<ul>
<li>a = 1 - 2c</li>
<li>a = 1 - 2 * 1.5</li>
<li>a = -2</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/764e2ca786c7461eaf7fd788946e43e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=cWS85G36WlzcYmFafJQXxAk4o0U%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-14">总结</h4>
<p>矩阵转置的性质</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec867e27d6bc4d2c88871c9ffc905926~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=l8HN1Vckv1xcrBfBLUiEDF1xYRk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-15">损失函数最小值求法</h2>
<h3 data-id="heading-16">正规方程法</h3>
<p>前面我们要知道，通过最小二乘，可以计算出如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e1b19ec80d746ceb1230cdef0cdb16e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=j9HsPQau3NUZgPn7Z5tmVWcjrgk%3D" alt="image.png" loading="lazy"/></p>
<p>现在我们将来计算 B 的值</p>
<p>例子：</p>
<p>一元线性回归损失函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo stretchy="false">(</mo><mi>k</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mo stretchy="false">(</mo><mi>h</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">J(k,b) = \sum_{i=1}^{m}(h(x^{(i)}) - y^{(i)})^2 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>上面的式子还等于 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sum_{i=1}^{m}(kx^{(i)} + b - y^{(i)})^2 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>
的极小值</p>
<p>损失函数是关于k、b的函数，对k、b分别求导设置成 0，得到2个方程</p>
<p>这是一个复杂的公式，省略常数实数</p>
<p><strong>对 k 求导</strong></p>
<p>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">(kx^{(i)} + b - y^{(i)})^2 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">2(kx^{(i)} + b - y^{(i)})(kx^{(i)} + b - y^{(i)})'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">2(kx^{(i)} + b - y^{(i)})x^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msup><mo>+</mo><mn>2</mn><mi>b</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><mn>2</mn><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">2kx^{(i)^{2}} + 2bx^{(i)} - 2x^{(i)}y^{(i)} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0702em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9869em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.9713em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal">b</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0824em;vertical-align:-0.1944em;"/><span class="mord">2</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></p>
<p><strong>对 b 求导</strong></p>
<p>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">(kx^{(i)} + b - y^{(i)})^2 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">2(kx^{(i)} + b - y^{(i)})(kx^{(i)} + b - y^{(i)})'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo separator="true">⋅</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2(kx^{(i)} + b - y^{(i)}) · 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">2(kx^{(i)} + b - y^{(i)})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mn>2</mn><mi>b</mi><mo>−</mo><mn>2</mn><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">2kx^{(i)} + 2b - 2y^{(i)} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9713em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0824em;vertical-align:-0.1944em;"/><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/></p>
<blockquote>
<p>完整答案</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e9f04a48cca4a8cb113bd5a51aec4c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=m%2F56gsRindrup49oFv6cNEkeiN4%3D" alt="image.png" loading="lazy"/></p>
<p>解析来继续变形，对上面的<strong>一式</strong>和<strong>二式</strong></p>
<p>上面的答案完整的都有一个求和，因为样本数量是多个。</p>
<p><strong>K 的求导结果变形</strong></p>
<p>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mn>2</mn><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msup><mo>+</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mn>2</mn><mi>b</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mn>2</mn><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\sum_{i=1}^{m}2kx^{(i)^2}  + \sum_{i=1}^{m}2bx^{(i)} - \sum_{i=1}^{m}2x^{(i)}y^{(i)} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2866em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9869em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mord mathnormal">b</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/>
= 同时除以2<br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msup><mo>+</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mi>b</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">k\sum_{i=1}^{m}x^{(i)^2} + \sum_{i=1}^{m}bx^{(i)} - \sum_{i=1}^{m}x^{(i)}y^{(i)} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2866em;vertical-align:-0.2997em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9869em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/></p>
<p><strong>B 的求导结果变形</strong></p>
<p>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></msubsup><mn>2</mn><mo stretchy="false">(</mo><mi>k</mi><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mn>2</mn><mi>b</mi><mo>−</mo><mn>2</mn><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\sum_{i = 1}^{m}2(kx^{(i)} + 2b - 2y^{(i)}) = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>m</mi></msubsup><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><msubsup><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>i</mi><mo>=</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><mi>m</mi></msubsup><mi>b</mi><mo>−</mo><msubsup><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>i</mi><mo>=</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><mi>m</mi></msubsup><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">k\sum_{i = 0}^{m}x^{(i)} + \sum_{(i = 0)}^{m}b - \sum_{(i = 0)}^{m}y^{(i)} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.279em;vertical-align:-0.4747em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4747em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.3627em;vertical-align:-0.4747em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4747em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mi>m</mi></msubsup><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mi>m</mi><mo>−</mo><msubsup><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>i</mi><mo>=</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><mi>m</mi></msubsup><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">k\sum_{i = 0}^{m}x^{(i)} + bm - \sum_{(i = 0)}^{m}y^{(i)} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1877em;vertical-align:-0.2997em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">bm</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.3627em;vertical-align:-0.4747em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4747em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/></p>
<p><strong>数据带入</strong></p>
<p>已知 x 是身高，y 是体重</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfbb7abcf6af4541bd9c6a80c430aff8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=%2FFiUaGy0J%2B26CcfGAxYutX284DY%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>对 K 求</p>
</blockquote>
<p>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>∗</mo><mo stretchy="false">(</mo><mn>16</mn><msup><mn>0</mn><mn>2</mn></msup><mo>+</mo><mn>16</mn><msup><mn>6</mn><mn>2</mn></msup><mo>+</mo><mn>17</mn><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mn>17</mn><msup><mn>4</mn><mn>2</mn></msup><mo>+</mo><mn>18</mn><msup><mn>0</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mi>b</mi><mo>∗</mo><mo stretchy="false">(</mo><mn>160</mn><mo>+</mo><mn>166</mn><mo>+</mo><mn>172</mn><mo>+</mo><mn>174</mn><mo>+</mo><mn>180</mn><mo stretchy="false">)</mo><mtext>–</mtext><mo stretchy="false">(</mo><mn>160</mn><mo>∗</mo><mn>56.3</mn><mo>+</mo><mn>166</mn><mo>∗</mo><mn>60.6</mn><mo>+</mo><mn>172</mn><mo>∗</mo><mn>65.1</mn><mo>+</mo><mn>174</mn><mo>∗</mo><mn>68.5</mn><mo>+</mo><mn>180</mn><mo>∗</mo><mn>75</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">k*(160^2+166^2+172^2+174^2+180^2)+b*(160+166+172+174+180)–(160*56.3+166*60.6+172*65.1+174*68.5+180*75)=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">16</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord">16</span><span class="mord"><span class="mord">6</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord">17</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord">17</span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">18</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">166</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">172</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">174</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">180</span><span class="mclose">)</span><span class="mord">–</span><span class="mopen">(</span><span class="mord">160</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">56.3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">166</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">60.6</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">172</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">65.1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">174</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">68.5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">180</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">75</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>145416</mn><mo>∗</mo><mi>k</mi><mo>+</mo><mn>852</mn><mo>∗</mo><mi>b</mi><mo>−</mo><mn>55683.8</mn><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">145416*k + 852*b - 55683.8 = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">145416</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">852</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">55683.8</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/></p>
<blockquote>
<p>对 b 求</p>
</blockquote>
<p>= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>∗</mo><mo stretchy="false">(</mo><mn>160</mn><mo>+</mo><mn>166</mn><mo>+</mo><mn>172</mn><mo>+</mo><mn>174</mn><mo>+</mo><mn>180</mn><mo stretchy="false">)</mo><mo>+</mo><mi>b</mi><mo>∗</mo><mn>5</mn><mo>−</mo><mo stretchy="false">(</mo><mn>56.3</mn><mo>+</mo><mn>60.6</mn><mo>+</mo><mn>65.1</mn><mo>+</mo><mn>68.5</mn><mo>+</mo><mn>75</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">k*(160+166+172+174+180)+b*5-(56.3+60.6+65.1+68.5+75)=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">160</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">166</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">172</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">174</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">180</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">56.3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">60.6</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">65.1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">68.5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">75</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span><br/>
= <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>852</mn><mo>∗</mo><mi>k</mi><mo>+</mo><mn>5</mn><mo>∗</mo><mi>b</mi><mo>−</mo><mn>325.5</mn><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">852*k + 5*b - 325.5 = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">852</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">325.5</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></p>
<blockquote>
<p>根据k、b进行预测：</p>
</blockquote>
<ul>
<li>
<p>k = 0.0397</p>
</li>
<li>
<p>b = 60.7615</p>
</li>
<li>
<p>y = 0.0397*176+60.7615 = 67</p>
</li>
</ul>
<h4 data-id="heading-17">多元线程回归（了解）</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d3888b960034d908d7abd3e80976726~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=wM9WlG63fjYTPa6h2O94lTStLus%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fbc9d8fcc754242b276e79442307c3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=n8pIKdqJs%2FTFhhDcohCBBBhbo4A%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/021faf141b7d428eb7476858add440db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=UtSM34CFsKnOBvJVCl28qYC8RNY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01f73d29a02447deba7877c41d914913~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=yO4NrCpWsgk2QIxNoSEHlRt%2F%2Bfo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bac4801587d049ba8425a476ab03ee46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767084526&amp;x-signature=NFct78Pi%2Br6n6HVcm92WaUf0lWs%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[.NET8 Middleware 核心原理与实战指南]]></title>    <link>https://juejin.cn/post/7586167377383391258</link>    <guid>https://juejin.cn/post/7586167377383391258</guid>    <pubDate>2025-12-22T08:31:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586167377383391258" data-draft-id="7586263211088494618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=".NET8 Middleware 核心原理与实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T08:31:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="幌才_loong"/> <meta itemprop="url" content="https://juejin.cn/user/4256947657515320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            .NET8 Middleware 核心原理与实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4256947657515320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    幌才_loong
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T08:31:31.000Z" title="Mon Dec 22 2025 08:31:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、中间件是什么</h2>
<p>.NET Core 中间件是构成 HTTP 请求处理管道的核心组件，用于接收、处理 HTTP 请求并生成响应。每个中间件都具备特定职责，可自主决定是否将请求传递给下一个中间件，也能在请求处理前后执行自定义逻辑，遵循 “请求入栈、响应出栈” 的洋葱模型。其核心价值在于实现关注点分离，让日志记录、身份验证、跨域处理等功能独立封装，支持灵活组合与插拔，大幅提升系统扩展性与可维护性。</p>
<h2 data-id="heading-1">二、中间件的核心使用方式</h2>
<h3 data-id="heading-2">1. 基础注册与执行逻辑</h3>
<p>中间件通过 <code>IApplicationBuilder</code> 接口链式注册，<code>app.UseXXX</code> 方法的调用顺序即为请求处理顺序（响应时反向执行）。核心调用逻辑通过 <code>next()</code> 方法控制：调用 <code>next()</code> 则将请求传递给下一个中间件，不调用则触发短路机制，直接返回响应。</p>
<h3 data-id="heading-3">2. 核心使用方法详解</h3>
<h4 data-id="heading-4">（1）app.Run：管道终点</h4>
<ul>
<li>特性：无 <code>next</code> 参数，强制短路，始终作为管道最后一个中间件。</li>
<li>使用场景：默认 404 响应、健康检查端点、简单固定响应返回。</li>
<li>示例：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">app.Run(<span class="hljs-keyword">async</span> context =&gt;
{
    context.Response.StatusCode = StatusCodes.Status404NotFound;
    <span class="hljs-keyword">await</span> context.Response.WriteAsync(<span class="hljs-string">"资源未找到"</span>);
});
</code></pre>
<h4 data-id="heading-5">（2）app.Use：通用中间件</h4>
<ul>
<li>特性：接收 <code>next</code> 参数，可灵活控制是否短路，支持请求前预处理与响应后处理。</li>
<li>使用场景：日志记录、性能监控、请求头修改、异常捕获等通用场景。</li>
<li>示例：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">app.Use(<span class="hljs-keyword">async</span> (context, next) =&gt;
{
    <span class="hljs-comment">// 请求处理前：记录请求信息</span>
    <span class="hljs-keyword">var</span> requestTime = DateTime.UtcNow;
    <span class="hljs-comment">// 传递给下一个中间件</span>
    <span class="hljs-keyword">await</span> next();
    <span class="hljs-comment">// 响应处理后：记录耗时</span>
    <span class="hljs-keyword">var</span> elapsed = DateTime.UtcNow - requestTime;
    Console.WriteLine(<span class="hljs-string">$"请求 <span class="hljs-subst">{context.Request.Path}</span> 耗时：<span class="hljs-subst">{elapsed.TotalMilliseconds}</span>ms"</span>);
});
</code></pre>
<h4 data-id="heading-6">（3）app.UseWhen：条件执行中间件</h4>
<ul>
<li>特性：基于自定义条件触发分支中间件，执行后返回主管道继续处理。</li>
<li>使用场景：特定路径（如 <code>/api</code>）、特定请求头、特定客户端的差异化处理。</li>
<li>示例：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">app.UseWhen(context =&gt; context.Request.Path.StartsWithSegments(<span class="hljs-string">"/api"</span>), apiApp =&gt;
{
    <span class="hljs-comment">// 仅/api路径请求执行：添加API版本头</span>
    apiApp.Use(<span class="hljs-keyword">async</span> (context, next) =&gt;
    {
        context.Response.Headers.Add(<span class="hljs-string">"X-API-Version"</span>, <span class="hljs-string">"2.0"</span>);
        <span class="hljs-keyword">await</span> next();
    });
});
</code></pre>
<h4 data-id="heading-7">（4）app.Map：路径分支中间件</h4>
<ul>
<li>特性：基于路径创建独立管道，分支内处理完毕后不返回主管道。</li>
<li>使用场景：管理员专区、静态文件服务、微服务风格 API 分组。</li>
<li>示例：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">app.Map(<span class="hljs-string">"/admin"</span>, adminApp =&gt;
{
    <span class="hljs-comment">// 独立管道：启用认证授权</span>
    adminApp.UseAuthentication();
    adminApp.UseAuthorization();
    adminApp.Run(<span class="hljs-keyword">async</span> context =&gt;
    {
        <span class="hljs-keyword">await</span> context.Response.WriteAsync(<span class="hljs-string">"管理员专区"</span>);
    });
});
</code></pre>
<h4 data-id="heading-8">（5）app.UseMiddleware：类中间件</h4>
<ul>
<li>特性：封装为独立类，支持依赖注入，适用于复杂逻辑与复用场景。</li>
<li>实现方式：可继承 <code>IMiddleware</code> 接口，或基于约定实现 <code>InvokeAsync</code> 方法。</li>
<li>使用场景：团队共享组件、复杂业务逻辑处理（如数据加密、权限校验）。</li>
<li>示例：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 自定义类中间件</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EncryptionMiddleware</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> RequestDelegate _next;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EncryptionMiddleware</span>(<span class="hljs-params">RequestDelegate next</span>)</span> =&gt; _next = next;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">InvokeAsync</span>(<span class="hljs-params">HttpContext context</span>)</span>
    {
        <span class="hljs-comment">// 加密相关处理</span>
        <span class="hljs-keyword">await</span> _next(context);
    }
}
<span class="hljs-comment">// 注册使用</span>
app.UseMiddleware&lt;EncryptionMiddleware&gt;();
</code></pre>
<h2 data-id="heading-9">三、常用内置中间件实战场景</h2>
<h3 data-id="heading-10">1. 安全类中间件</h3>
<ul>
<li><strong>UseAuthentication</strong>：身份验证，验证用户身份（如 JWT、Cookie 认证），需搭配 <code>AddAuthentication</code> 服务配置。</li>
<li><strong>UseAuthorization</strong>：授权校验，基于角色、策略判断用户是否有权访问资源。</li>
<li><strong>UseCors</strong>：跨域处理，配置允许的来源、方法、请求头，解决前端跨域问题。</li>
</ul>
<h3 data-id="heading-11">2. 性能优化类中间件</h3>
<ul>
<li><strong>UseResponseCompression</strong>：响应压缩，压缩 HTTP 响应体（如 Gzip、Brotli），减少传输体积。</li>
<li><strong>UseOutputCache</strong>：输出缓存（.NET 7+），缓存响应结果，提升重复请求处理速度。</li>
</ul>
<h3 data-id="heading-12">3. 诊断与监控类中间件</h3>
<ul>
<li><strong>UseExceptionHandler</strong>：异常处理，捕获管道中未处理的异常，返回友好错误信息。</li>
<li><strong>MapHealthChecks</strong>：健康检查，提供应用状态端点（如 <code>/health</code>），适配监控系统。</li>
</ul>
<h3 data-id="heading-13">4. 基础功能类中间件</h3>
<ul>
<li><strong>UseHttpsRedirection</strong>：HTTPS 重定向，将 HTTP 请求强制转为 HTTPS，提升传输安全性。</li>
<li><strong>UseStaticFiles</strong>：静态文件服务，提供 CSS、JS、图片等静态资源访问支持。</li>
</ul>
<h2 data-id="heading-14">四、使用注意事项</h2>
<ol>
<li>注册顺序敏感：核心中间件需按 “异常处理→HTTPS 重定向→静态文件→路由→认证授权→终结点” 的顺序注册，避免功能失效。</li>
<li>谨慎使用短路：短路中间件（如认证失败）需明确业务场景，避免正常请求被意外拦截。</li>
<li>类中间件复用：复杂逻辑优先封装为类中间件，通过依赖注入解耦，提升代码可维护性。</li>
<li>环境差异化配置：开发环境可启用 Swagger、详细异常页，生产环境启用 HTTPS、响应压缩等优化。</li>
</ol>
<p>中间件作为.NET Core 的核心设计，通过灵活组合与插拔，让开发者能快速构建高可用、易扩展的 Web 应用。合理选择与配置中间件，既能满足业务需求，又能保障系统性能与安全性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[八年开源，GSY 用五种技术开发了同一个 Github 客户端，这次轮到 AI + Compose]]></title>    <link>https://juejin.cn/post/7585645111876632603</link>    <guid>https://juejin.cn/post/7585645111876632603</guid>    <pubDate>2025-12-21T23:11:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585645111876632603" data-draft-id="7585645111876616219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="八年开源，GSY 用五种技术开发了同一个 Github 客户端，这次轮到 AI + Compose"/> <meta itemprop="keywords" content="前端,Android,Flutter"/> <meta itemprop="datePublished" content="2025-12-21T23:11:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            八年开源，GSY 用五种技术开发了同一个 Github 客户端，这次轮到 AI + Compose
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T23:11:10.000Z" title="Sun Dec 21 2025 23:11:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之所以 2025 了 GSYGithubApp 还能迎来 Jetpack Compose 版本的开源，主要还是依赖于 AI 的强大：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppCompose" target="_blank" title="https://github.com/CarGuo/GSYGithubAppCompose" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a> 。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77fbbc01e86d41568b8f02745c2ede70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=HYod%2BkDbevJtqti22GAfsF89nMM%3D" alt="" loading="lazy"/></p>
<p>GSY 系列项目做早是从 2016 年开始做的开源，其中大家最为熟悉的应该是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYVideoPlayer" target="_blank" title="https://github.com/CarGuo/GSYVideoPlayer" ref="nofollow noopener noreferrer">GSYVideoPlayer</a> ，它也是维护至今最长的项目，而 GSYGithubApp 系列最早是在 2017 年 11 月开源，至今正好是八年，而近日这个项目也正式开源了 GSYGithubApp 的 Jetpack Compose 版本：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd2568bafbbc4b249059fa52989ed415~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=Axg0fzCmKSJ6I%2B5O4h5HGdorRfQ%3D" alt="" loading="lazy"/></p>
<p>GSYGithubApp 诞生之初 Github 的官方客户端还没有出来，而当时因为做开源也有些时间，所以在日常中没有一个应用其实挺不方便，正好那时候刚学 React Native 没多久，<strong>所以 2017 年第一个 GSYGithubApp 就作为练手项目诞生了</strong>，之后陆续随着接触的技术栈变化，开源的版本也越来越多，它们开源的顺序依次是：</p>
<ul>
<li>React Native <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubApp" target="_blank" title="https://github.com/CarGuo/GSYGithubApp" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a></li>
<li>Weex <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppWeex" target="_blank" title="https://github.com/CarGuo/GSYGithubAppWeex" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a></li>
<li>Android Kotlin View <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppKotlin" target="_blank" title="https://github.com/CarGuo/GSYGithubAppKotlin" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a></li>
<li>Flutter <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppFlutter" target="_blank" title="https://github.com/CarGuo/GSYGithubAppFlutter" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a></li>
<li>Android Jetpack Compose <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppCompose" target="_blank" title="https://github.com/CarGuo/GSYGithubAppCompose" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b75b5a15bdc24cdeb7ca8bdce93243b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=M41mBMSCRoVyuSfXSxTKZ7NXgew%3D" alt="" loading="lazy"/></p>
<p>而其实随着 Github 官方的 App 发布后，GSYGithubApp 存在的意义就变了：<strong>它更多是成为一个完整的技术学习项目，并提供同款技术对比的一个目的</strong>。</p>
<p>另外过去的时候，闲鱼就曾用过 GSYGithubApp 的 React Native 版本和 Flutter 版本做过一些性能对比测试：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67b39aade61b46b09b834774c7b9a219~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=we154kIzAhBEOK6vDGVDM5K5JVg%3D" alt="image-20251112111329006" loading="lazy"/></p>
<blockquote>
<p>而之所以选择做 Github 客户端也是因为这个，这能让它成为一个完整的 App 开源项目，Github API 相对稳定并且丰富，流程从登录，用户，仓库，Issue ，输入输出，数据库等都能覆盖，能让开源项目涉及的内容更全面。</p>
</blockquote>
<p>当然，个人经历有限，随着时间推移，其实 GSYGithubApp 在过去挺长的时间里，除了 Flutter 版本外，其他版本都是处于“放（qi）生（keng）”状态，直到 2025 AI 的能力大幅提升之后，它们才又迎来了更新：</p>
<ul>
<li>React Native 版本目前更新到 0.82 ，说实话就算是有 AI ，从 0.61 升级到 0.82 也是一个挺让人“绝望”的体验，详细可见：<a href="https://juejin.cn/post/7534367912388427815" target="_blank" title="https://juejin.cn/post/7534367912388427815">用 AI 把一个五年前的 RN 项目，从 0.61.3 升级到 0.74.0 是一种什么样的体验</a></li>
<li>Android Kotlin View 版本，在 AI 的帮助下，终于成功升级到可以在最新 Android Studio 和 Gradle 环境运行</li>
<li>Weex 版本，嗯，还是处于“放（qi）生（keng）”状态，懂得都懂</li>
</ul>
<p>所以在感受到 AI 强大的辅助能力后，<strong>我就觉得也许可以再来个 Jetpack Compose 版本的 GSYGithubApp 项目，而实际上零零散散开发直到开源，大概也就是两周的时间，其中 80% 以上都是 AI 完成</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad66fb5b1ab949258e3cb16a767abc40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=zNQzi%2Bby%2Fap2Tmg8xszVwAwuepQ%3D" alt="" loading="lazy"/></p>
<p>当然，这个速度主要也是因为需求明确，原型已经有了，给 AI 参考的资料就多了，基本上也算是熟悉的领域，大部分只需给 AI 投喂好资料，初始结构直接让 AI 参考官方的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandroid%2Fandroidify" target="_blank" title="https://github.com/android/androidify" ref="nofollow noopener noreferrer">android/androidify</a> 项目，制定好路线和方向，整体还是相当省心的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b78db26fc02409f82e3efa628092c0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=Jqm0nlqvTfo6%2Bjxrlp5H2Yfw1O4%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ca37519fe274638ad3ee18c13ab9376~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=6FvbYxA6hyvIRAbb00%2BxtLaKyHQ%3D" alt="" loading="lazy"/></p>
<p>当然，这里面就不得不提开发过程中给 AI 指定 rules 的必要性，因为 AI 实际上很多时候并不会全局考虑你的项目结构，每次需求对他有限的 Context 来说，大多数时候都只会局限性的考虑问题，这时候在开发过程中根据 AI 的调性配置相应的规则还是很重要的，例如通用的模板和生成规则就很有必要：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb29035ed20145caa18b6a35cdab6c6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=zg73mz9tZP4vPIGuR4W4XKy2ZW8%3D" alt="" loading="lazy"/></p>
<p>这些规则不是说你一开始就要有，而是在 AI 开发过程中，在已经有一定代码的情况下，就可以让 AI 读取现有的结构去生成，还有就是 AI 的脑回路大多数时候只和它训练时的数据绑定，所以有些新的东西，就需要你明说，一些他经常错的东西，就需要你显式的罗列出来：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47baa453c3dd4e36b29141063b2881bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=X3xbCluucH8etdVUldCp13qGfhM%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>这里大部分都是使用 Android Studio 的 <code>Gemini for businesses</code> 完成，部分是 Copilot Web Agent 和 Claude 完成，另外，新版的 <a href="https://juejin.cn/post/7579999793320247302" target="_blank" title="https://juejin.cn/post/7579999793320247302">Android Studio Otter 2 Feature</a> Android Studio 的 Agent 模式也开始配备了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fr%2Fstudio-ui%2Fgemini%2Fandroid-knowledge-base" target="_blank" title="https://developer.android.com/r/studio-ui/gemini/android-knowledge-base" ref="nofollow noopener noreferrer">Android 知识库 </a>，从而显著提高准确性并减少错误信息。</p>
<p>这意味着，<strong>Agent 不再仅仅依赖于其训练数据，而是可以在回答用户问题之前主动查阅来自官方来源（例如 Android 开发者文档、Firebase、Google Developers 和 Kotlin 文档）的最新文档</strong>。</p>
</blockquote>
<p>当然，最终代码还是需要人审核，咱也不懂，为什么它增加个多语言的时候，会删掉某个标签，加个 <code>camera</code> 做什么？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6386b29445284e308f8f8d97f4e99371~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=RWuSCm5ce5GENQgSj4KdBhZtdTg%3D" alt="" loading="lazy"/></p>
<p>当然，在这个过程里，你还能见到嘴硬的 AI 开始推卸责任，不得不说 AI 的拟人化越来越真实：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ba10312586a4975aef68a1b5568dec0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=Y%2FbvahNofg6lNejtkeHCVtfOFs0%3D" alt="ce1f85625ff3a0afd78e8e419fd014fa" loading="lazy"/></p>
<p>而对于项目的架构，我们也可以通过 AI 来完成，例如 <code>https://deepwiki.com/</code> ，只需要通过 <code>https://deepwiki.com/CarGuo/GSYGithubAppCompose</code> ，我们就可以得到一份项目的架构报告，并且你还可以通过它继续询问相关问题：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92cb0b8991e540e1ad1182c7b27fc2ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=8pSPcW3c75SjQPDhLmjqwkYcg34%3D" alt="" loading="lazy"/></p>
<p>另外，通过 AI 我们也可以生成对应的结构实现，例如以下就是通过 Gemini 生成的手绘图示例：</p>
<h4 data-id="heading-0">架构图</h4>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────────────────────────────────────────────────────────────┐
│                          GSYGithubAppCompose                            │
│                       (Jetpack Compose + MVVM)                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                ┌───────────────────┼───────────────────┐
                │                   │                   │
        ┌───────▼────────┐   ┌──────▼──────┐    ┌───────▼────────┐
        │  Presentation  │   │    Data     │    │      Core      │
        │     Layer      │   │    Layer    │    │     Layer      │
        └────────────────┘   └─────────────┘    └────────────────┘
                │                   │                   │
        ┌───────▼────────┐   ┌──────▼──────┐    ┌───────▼────────┐
        │   feature/*    │   │    data     │    │  core/network  │
        │                │   │             │    │  core/database │
        │ - welcome      │   │ Repository  │    │  core/common   │
        │ - login        │   │   Pattern   │    │  core/ui       │
        │ - home         │   │             │    └────────────────┘
        │ - dynamic      │   │ - User      │
        │ - trending     │   │ - Event     │
        │ - profile      │   │ - Repo      │
        │ - search       │   └─────────────┘
        │ - detail       │
        │ - code         │
        │ - issue        │
        │ - push         │
        │ - list         │
        │ - notification │
        │ - info         │
        └────────────────┘
</code></pre>
<h4 data-id="heading-1">模块依赖关系图</h4>
<pre><code class="hljs language-bash" lang="bash">                                    ┌─────────┐
                                    │   app   │
                                    └────┬────┘
                                         │
                 ┌───────────────────────┼────────────────────────┐
                 │                       │                        │
          ┌──────▼──────┐         ┌─────▼─────┐          ┌──────▼──────┐
          │  feature/*  │         │    data   │          │   core/ui   │
          │             │         │           │          │             │
          │所有功能模块  │◄────────┤Repository │          │  通用UI组件  │
          │             │         │           │          │             │
          └──────┬──────┘         └─────┬─────┘          └──────┬──────┘
                 │                      │                       │
                 │              ┌───────┼────────┐              │
                 │              │       │        │              │
                 └──────────────┼───────┼────────┼──────────────┘
                                │       │        │
                    ┌───────────▼─┐  ┌──▼────────▼──┐  ┌─────────────┐
                    │core/network │  │core/database │  │core/common  │
                    │             │  │              │  │             │
                    │ Retrofit    │  │    Room      │  │ DataStore   │
                    │ Apollo      │  │    Entity    │  │   Token     │
                    │ Model       │  │    DAO       │  │  Resources  │
                    └─────────────┘  └──────────────┘  └─────────────┘
​
依赖规则：
  app          → feature/*, core/ui, data
  feature/*    → data, core/ui, core/common
  data         → core/network, core/database, core/common
  core/ui      → core/common
  core/network → (独立模块)
  core/database→ (独立模块)
  core/common  → (独立模块)
</code></pre>
<h4 data-id="heading-2">技术架构图</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────────┐
│                         技术栈 (Tech Stack)                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  UI层                  Jetpack Compose + Material <span class="hljs-number">3</span>                 │
│                        Navigation Compose                           │
│                        Coil (图片加载)                               │
│  ├─────────────────────────────────────────────────────────────┤    │
│                                                                     │
│  状态管理              StateFlow + ViewModel                         │
│                        Kotlin Coroutines + <span class="hljs-attribute">Flow</span>                     │
│  ├─────────────────────────────────────────────────────────────┤    │
│                                                                     │
│  依赖注入              Hilt (Dagger <span class="hljs-number">2</span>)                               │
│  ├─────────────────────────────────────────────────────────────┤    │
│                                                                     │
│  网络层                Retrofit <span class="hljs-number">2</span> + OkHttp                           │
│                        Apollo GraphQL                               │
│                        Gson / Kotlinx Serialization                 │
│  ├─────────────────────────────────────────────────────────────┤    │
│                                                                     │
│  数据库层              Room Database                                 │
│                        DataStore (替代 SharedPreferences)            │
│  ├─────────────────────────────────────────────────────────────┤    │
│                                                                     │
│  架构模式              MVVM + Repository Pattern                     │
│                        Clean Architecture                           │
│                        Unidirectional Data <span class="hljs-attribute">Flow</span>                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-3">数据流向图</h4>
<pre><code class="hljs language-scss" lang="scss">┌──────────────┐        ┌──────────────┐        ┌──────────────┐
│              │        │              │        │              │
│   Screen     │◄───────┤  ViewModel   │◄───────┤  Repository  │
│  (Compose)   │ State  │   (MVVM)     │  <span class="hljs-attribute">Flow</span>  │   (Data)     │
│              │        │              │        │              │
└──────┬───────┘        └──────┬───────┘        └──────┬───────┘
       │                       │                       │
       │ User Action           │ Business Logic        │ Data Source
       │                       │                       │
       ▼                       ▼                       ▼
┌──────────────┐        ┌──────────────┐        ┌──────────────┐
│              │        │              │        │              │
│   onClick    │───────►│  <span class="hljs-built_in">loadData</span>()  │───────►│  Network /   │
│   onRefresh  │ Event  │  <span class="hljs-built_in">refresh</span>()   │ API    │  Database    │
│              │        │              │ Call   │              │
└──────────────┘        └──────────────┘        └──────────────┘
​
数据流：
<span class="hljs-number">1</span>. 用户操作触发 UI 事件
<span class="hljs-number">2</span>. ViewModel 处理业务逻辑
<span class="hljs-number">3</span>. Repository 协调数据源（网络/数据库）
<span class="hljs-number">4</span>. 数据通过 <span class="hljs-attribute">Flow</span> 返回到 ViewModel
<span class="hljs-number">5</span>. ViewModel 更新 UiState
<span class="hljs-number">6</span>. UI 自动重组显示新状态
</code></pre>
<h4 data-id="heading-4">分层职责</h4>















































<table><thead><tr><th>层级</th><th>模块</th><th>职责</th><th>主要技术</th></tr></thead><tbody><tr><td><strong>表现层</strong></td><td>feature/*</td><td>UI渲染、用户交互、状态展示</td><td>Jetpack Compose、Navigation</td></tr><tr><td><strong>业务层</strong></td><td>data (ViewModel)</td><td>业务逻辑、状态管理、数据编排</td><td>StateFlow、Coroutines</td></tr><tr><td><strong>数据层</strong></td><td>data (Repository)</td><td>数据访问、缓存策略、数据映射</td><td>Repository Pattern</td></tr><tr><td><strong>网络层</strong></td><td>core/network</td><td>API调用、网络请求、数据模型</td><td>Retrofit、Apollo、OkHttp</td></tr><tr><td><strong>存储层</strong></td><td>core/database</td><td>本地缓存、数据持久化</td><td>Room、DataStore</td></tr><tr><td><strong>基础层</strong></td><td>core/common、core/ui</td><td>公共工具、UI组件、资源</td><td>多语言、主题、工具类</td></tr></tbody></table>
<p>可以看到，AI 确实可以大大提高开发的效率，不仅“救活”了已经荒废的老项目，在新项目的迭代上也起到了很大的帮助，这也是为什么 2025 了还能有 GSYGithubAppCompose 的原因。</p>
<p><strong>事实上现在 GSYGithubApp 系列项目存在的意义也就是学习和对比，而 GSYGithubAppCompose 的意义，还提现在 AI 的应用和项目维护上</strong>，如何更好使用 AI 去维护一个项目，这对于程序猿来说，还是有一定的必要的，毕竟 2025 作为开发者，真的离不开 AI。</p>
<p>当然，如果你是 Android 原生开发，还没用上 Compose ，那 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppCompose" target="_blank" title="https://github.com/CarGuo/GSYGithubAppCompose" ref="nofollow noopener noreferrer">GSYGithubAppCompose</a> 或者也值得了解下？毕竟如果 Compose 会了，约等于 Compose MultiPlatform 也会了不是么？当然，你也可以说，AI 会就行🤭 。</p>
<h2 data-id="heading-5">最后</h2>
<p>最后，借着 AI 的风，本次也把所有项目的 Logo 形象都统一，从五个 GSYGithubApp ，到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2Fgsy_flutter_book" target="_blank" title="https://github.com/CarGuo/gsy_flutter_book" ref="nofollow noopener noreferrer">gsy_flutter_book</a> 文章合集项目，再到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYVideoPlayer" target="_blank" title="https://github.com/CarGuo/GSYVideoPlayer" ref="nofollow noopener noreferrer">GSYVideoPlayer</a> 播放器和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2Fgsy_flutter_demo" target="_blank" title="https://github.com/CarGuo/gsy_flutter_demo" ref="nofollow noopener noreferrer">gsy_flutter_demo</a> 示例项目，现在全都统一使用这个 logo ，虽然没什么设计感，但是我很满意：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fea239b15b6e41fe96308cd388debdaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=5ITSFN%2BIICm6X9yHMWfzyBnrQG4%3D" alt="" loading="lazy"/></p>
<p>再结合 AI ，一个看起来很颠的视频效果就这么出来了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a840f4a770e473bb2f3d3fddf5164a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766963470&amp;x-signature=JIyCl1%2FoiA4mzhP5Oom8MrXC6uM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2F" target="_blank" title="https://github.com/CarGuo/" ref="nofollow noopener noreferrer">github.com/CarGuo/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCarGuo%2FGSYGithubAppCompose" target="_blank" title="https://github.com/CarGuo/GSYGithubAppCompose" ref="nofollow noopener noreferrer">github.com/CarGuo/GSYG…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter UI 设计库解耦重构进度，官方解答未来如何适配]]></title>    <link>https://juejin.cn/post/7585751355593850899</link>    <guid>https://juejin.cn/post/7585751355593850899</guid>    <pubDate>2025-12-22T03:34:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355593850899" data-draft-id="7585969437032267818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter UI 设计库解耦重构进度，官方解答未来如何适配"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2025-12-22T03:34:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter UI 设计库解耦重构进度，官方解答未来如何适配
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:34:11.000Z" title="Mon Dec 22 2025 03:34:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在目前的 Flutter 架构中，Material（Android ）和 Cupertino（iOS）的 UI 库是与核心框架捆绑在一起的，也就是常见的 "batteries included" 原则，为的是方便开发者开箱即用，但是也导致了 Widgets、Material 和 Cupertino 这三个 lib 紧密耦合。</p>
<p>而今年提出的 decoupling design 重构，就是<strong>计划将这两个设计库从核心框架中解耦，并调整到独立的 Pub 包</strong>，也就是核心框架将只包含基础的 <code>Widgets</code> 库，而特定的设计风格将变为可选的插件 ：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7f08af96f354221ab52520890f27380~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=r95H8TJV7oMzVG70mcSaJ8gnn8M%3D" alt="" loading="lazy"/></p>
<p>之所以会有这个调整，最主要还是因为在最新的 Material 3 Expressive 和 Liquid Glass 风格发布之后，UI 在 Framework 层的适配成本变高，并且 <strong>Framework 的更新节奏也无法很好适应这种 UI 风格调整</strong>，所以在社区的呼声下，官方正式开始了 decoupling design 计划。</p>
<p>实际上在之前，很多基础组件对特定设计库有不必要的依赖，你以为框架的代码结构是下图 A ，但是在多年维护后，目前已经是下图 B 的情况：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/369d602fb81d4fe1b65e446997de2572~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=6qAsbJsdiaILfSsykRKpbhEQOnQ%3D" alt="" loading="lazy"/></p>
<p>另外，类似 <code>SelectionArea</code> 组件，它看起来是一个纯 Widget 的基础组件，但为了实现跨平台适配，底层却必须依赖 Material 和 Cupertino 库 ，如果没有，你就会发现：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5259133efa5c48faa624e75b8dc5dfa5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=npmC5nlW3N6ZY9HEKsRLclLt73Q%3D" alt="" loading="lazy"/></p>
<p>因为在之前的 "batteries included" 原则，实际上控件内部会根据使用的风格或者运行的平台，主动为用户采用对应的主题风格，这样的话好处肯定是开箱即用，但是实际上用户很多时候并不理解这一点，并且最重要的是：</p>
<blockquote>
<p><strong>由于设计库与框架发布周期绑定，新设计的跟进趋势会让适应速度变慢很多，同时紧密的耦合也让 PR 变得复杂，每次调整风险更高，容易引发回归错误</strong> 。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b2278e0a4c947a0a189036864f45187~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=4lT3LjEFHBWBGzGN194n4Ek8ni0%3D" alt="" loading="lazy"/></p>
<p>另外，现阶段开发者如果想构建非 Material/Cupertino 的自定义设计系统，往往不得不从头开始，因为现有的基础组件的定制功能开发不足 ，所以 decoupling design 作为现阶段必须经历的产物，最终提上了日程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f849dc87fb8b4a838b4bb5509b028c2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=YaEXHekZKeZOlUgDuC8Ed3zKvuY%3D" alt="" loading="lazy"/></p>
<p>当然，实际上解耦和重构设计库是一个非常大的底层调整，其中核心主要涉及了四个领域：</p>
<ul>
<li><strong>System UI</strong> ：需要重新界定设计库与平台之间的界限（例如文本选择、页面过渡） ，这个是最大的成本之一</li>
<li><strong>代码组织</strong> ：在基础 <code>Widgets</code> 库中创建更多的“原始组件抽象” (raw widget abstractions)，类似现在的 <code>RawRadio</code><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e79ad1ea8cf4bda87832255ae530e84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=OKahAaQVVHvPFPi6LwM6n9oIfZc%3D" alt="" loading="lazy"/></li>
<li><strong>主题</strong>：评估并改进主题系统，解决 Material 和 Cupertino 主题缺乏共同 BASE 的问题 ，因为之前 Widgets 完全没有主题体系，所以需要考虑是否引入更通用的 theme abstraction</li>
<li><strong>基础设施适配</strong>：迁移超过 200 个测试，并将相关的 CI 流程从主仓库迁移出去 ，避免交叉导入，建立独立的 CI 流程，让 PR 更便捷过审</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dc792c8a50d4f9a90e6478487e2e0e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=nq3LVhvrxJxQD%2BAOWsZUX%2BQw2eU%3D" alt="" loading="lazy"/></p>
<p>而对于解耦完成的是假变，整个项目分三个阶段进行：</p>
<ul>
<li>
<p><strong>阶段一 (2025年12月)</strong> ：</p>
<ul>
<li>基础调整，将 Material/Cupertino 中的通用核心逻辑下沉移动到 <code>widgets</code> 库</li>
<li>搭建 Flutter packages 仓库的基础支持</li>
</ul>
</li>
<li>
<p><strong>阶段二 2026年</strong> ：</p>
<ul>
<li>正式解耦，将代码移至新的包中并发布到 Pub</li>
<li>在主框架中标记旧库为“已弃用” (deprecated)</li>
</ul>
</li>
<li>
<p><strong>阶段三 - 2026年晚些时候</strong> ：</p>
<ul>
<li>从核心框架中彻底移除已弃用的 Material 和 Cupertino 库</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb4eda73d66a4a6a84a4bb3385cb4e2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=eYX2ZyzSg4ENvbGcvoTvAC9HAWw%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>也就是，2026 年我们就可以拥有全新的 Material 3 Expressive 和 Liquid Glass 风格支持，并且是可选 package</p>
</blockquote>
<p>当然，对开发者的影响的使用肯定有影响，这个影响有好有坏：</p>
<ul>
<li><strong>版本管理更灵活</strong>：解耦后，Material 和 Cupertino 将遵循语义化版本控制，开发者可以锁定特定版本，独立于 Flutter 框架的升级节奏 ，更加方便灵活，<strong>不必跟着 Flutter 升级 UI 设计</strong></li>
<li><strong>更容易构建自定义设计</strong>：通过使用底层的“原始组件” (raw widgets，如 <code>RawRadio</code>)，构建完全自定义的 UI 系统将变得更加容易，不再被迫基于 Material 组件修改</li>
<li><strong>破坏性变更 (Breaking Changes)</strong> ：虽然未来会提供快速修复工具 (quick fixes)，但解耦过程不可避免地会带来一些破坏性变更 ，这些是是需要开发者自己适配</li>
<li><strong>设计库更新暂停</strong>：为了减少迁移难度，在解耦完成前， Flutter 会将暂停引入新的重大设计更新（如 Material 3 Expressive 或 Liquid Glass） ，所以这个需要开发耐心等待</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3fa99b8f6d842f2acfc7786def5d092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=P7KXXLTGu4fKwzFHOl8%2BkEvYgfs%3D" alt="" loading="lazy"/></p>
<p>当然，解耦之后，<strong>Framework 的 UI break change 会越来越少，而开发者也可以选择自己的 style package 进行 lock</strong> ，整体灵活性和可用度会更好。</p>
<p>不过，对于 Plugin开发者来说，可能会有更高的适配成本，<strong>因为需要考虑 UI 实现里使用的是哪个 version 的 style package ，也需要考虑会不会给用户带来版本冲突等</strong>，在这方面也许未来会出现类似 RN 的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff1a70cf4a9347aba175551957b971b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979251&amp;x-signature=NLTo0F37w3rKBu1LOuWLfBf4LxI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">最后</h2>
<p>这次重构虽然是一项巨大的工程，但长远来看会让 Flutter 框架更耐用，也让设计库的迭代更迅速，并更好地支持第三方设计生态系统的发展 ，甚至未来 PC 平台的第三方 UI 风格也可以更好适配，这也引出另一个问题：</p>
<blockquote>
<p>Compose Multiplatform 是否也有类似问题，是否也会跟进？毕竟 CMP 也是以 Material 为主，不过目前看来 Compose 先天具备分层风格 function ，更倾向于平台层 UI 自己独立实现，实际上问题会小很多。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 原生功能狂飙，15 个热门 npm 包要失业了]]></title>    <link>https://juejin.cn/post/7586192313635389474</link>    <guid>https://juejin.cn/post/7586192313635389474</guid>    <pubDate>2025-12-22T04:00:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586192313635389474" data-draft-id="7586136543954812966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 原生功能狂飙，15 个热门 npm 包要失业了"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-22T04:00:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Immerse"/> <meta itemprop="url" content="https://juejin.cn/user/2708812817761752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 原生功能狂飙，15 个热门 npm 包要失业了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2708812817761752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Immerse
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:00:10.000Z" title="Mon Dec 22 2025 04:00:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 Immerse，一名独立开发者、内容创作者、AGI 实践者。</p>
<p>关注公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com%2Fother%2Fwx_public_account.webp" target="_blank" title="https://yaolifeng.com/other/wx_public_account.webp" ref="nofollow noopener noreferrer">沉浸式趣谈</a>，获取最新文章（更多内容只在公众号更新）</p>
<p>个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com" target="_blank" title="https://yaolifeng.com" ref="nofollow noopener noreferrer">yaolifeng.com</a> 也同步更新。</p>
<p>转载请在文章开头注明出处和版权信息。</p>
<p>我会在这里分享关于<code>编程</code>、<code>独立开发</code>、<code>AI干货</code>、<code>开源</code>、<code>个人思考</code>等内容。</p>
<p>如果本文对您有所帮助，欢迎动动小手指一键三连(<code>点赞</code>、<code>评论</code>、<code>转发</code>)，给我一些支持和鼓励，谢谢！</p>
<hr/>
<p>之前装个 Node.js 项目，npm 包能装一大堆。</p>
<p>现在发现很多包其实不用装了，Node.js 自己就支持。</p>
<p>这次整理了 15 个已经被 Node.js 原生功能替代的热门 npm 包。</p>
<p>有些已经稳定了，有些还在实验阶段，但都能用起来了。</p>
<h2 data-id="heading-0">fetch 终于成全局函数了</h2>
<p>以前在 Node.js 里用 fetch，必须装 node-fetch。</p>
<p>现在 Node.js 18 开始，fetch 已经是全局函数了，和浏览器里的用法完全一样。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"https://api.github.com/repos/nodejs/node"</span>);
<span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">full_name</span>);
</code></pre>
<p>直接就能用，不用装任何包。</p>
<p>Node.js 17.5 开始实验性支持，到 18 就稳定了。</p>
<p>如果你的项目还在用 Node.js 18 之前的版本，那还是得装 node-fetch。</p>
<h2 data-id="heading-1">WebSocket 也原生支持了</h2>
<p>之前做 WebSocket 客户端，基本都用 ws 这个包。</p>
<p>现在 Node.js 有了全局的 WebSocket 类。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">"wss://echo.websocket.org"</span>);

ws.<span class="hljs-property">onopen</span> = <span class="hljs-function">() =&gt;</span> ws.<span class="hljs-title function_">send</span>(<span class="hljs-string">"Hello!"</span>);
ws.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Received:"</span>, event.<span class="hljs-property">data</span>);
</code></pre>
<p>Node.js 21 加的，不过还是实验性的。</p>
<p>要注意的是，这只是客户端支持。</p>
<p>如果要做 WebSocket 服务端，还是得用 ws 或者其他库。</p>
<h2 data-id="heading-2">测试框架不用装了</h2>
<p>以前写测试，要装 mocha、jest 这些框架。</p>
<p>现在 Node.js 自带测试模块 node:test。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> test <span class="hljs-keyword">from</span> <span class="hljs-string">"node:test"</span>;
<span class="hljs-keyword">import</span> assert <span class="hljs-keyword">from</span> <span class="hljs-string">"node:assert"</span>;

<span class="hljs-title function_">test</span>(<span class="hljs-string">"addition works"</span>, <span class="hljs-function">() =&gt;</span> {
  assert.<span class="hljs-title function_">strictEqual</span>(<span class="hljs-number">2</span> + <span class="hljs-number">2</span>, <span class="hljs-number">4</span>);
});
</code></pre>
<p>Node.js 18 加的实验性功能，到 20 就稳定了。</p>
<p>如果需要快照测试、mock 这些高级功能，第三方框架还是更强。</p>
<p>不过对于模块级别的测试，node:test 完全够用了。</p>
<h2 data-id="heading-3">SQLite 也要原生支持了</h2>
<p>之前用 SQLite，要装 sqlite3 或 better-sqlite3。</p>
<p>这俩包都需要编译原生模块，升级 Node.js 版本经常出问题。</p>
<p>现在 Node.js 在开发 node:sqlite 模块。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { open } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:sqlite"</span>;

<span class="hljs-keyword">const</span> db = <span class="hljs-keyword">await</span> <span class="hljs-title function_">open</span>(<span class="hljs-string">":memory:"</span>);
<span class="hljs-keyword">await</span> db.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"CREATE TABLE users (id INTEGER, name TEXT)"</span>);
</code></pre>
<p>不过还是实验性的，等稳定了就能彻底告别编译问题了。</p>
<h2 data-id="heading-4">控制台彩色输出不用装 chalk 了</h2>
<p>给控制台输出加颜色，以前都用 chalk 或 kleur。</p>
<p>现在 Node.js 有 util.styleText 函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { styleText } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:util"</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">styleText</span>(<span class="hljs-string">"red"</span>, <span class="hljs-string">"Error!"</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">styleText</span>([<span class="hljs-string">"bold"</span>, <span class="hljs-string">"green"</span>], <span class="hljs-string">"Success!"</span>));
</code></pre>
<p>Node.js 20.12 加的，到 22.17 就稳定了。</p>
<p>如果需要复杂的主题配置或链式调用，chalk 还是更好用。</p>
<p>但简单的颜色输出，原生的就够了。</p>
<h2 data-id="heading-5">清理 ANSI 码也不用装包了</h2>
<p>以前要去掉日志里的 ANSI 转义码，得装 strip-ansi。</p>
<p>现在有 util.stripVTControlCharacters 函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { stripVTControlCharacters } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:util"</span>;

<span class="hljs-keyword">const</span> text = <span class="hljs-string">"\u001B[4mUnderlined\u001B[0m"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">stripVTControlCharacters</span>(text));
</code></pre>
<p>原生处理，稳定可靠。</p>
<p>基本不需要再装第三方包了。</p>
<h2 data-id="heading-6">glob 匹配文件也原生了</h2>
<p>匹配文件路径，以前必须用 glob 包。</p>
<p>Node.js 22 开始有 fs.glob 函数了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"node:fs/promises"</span>;

<span class="hljs-keyword">const</span> files = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">glob</span>(<span class="hljs-string">"**/*.js"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(files);
</code></pre>
<p>22 版本就稳定了，可以放心用。</p>
<p>老项目还在用旧版本 Node.js 的话，还是得继续用 glob 包。</p>
<h2 data-id="heading-7">递归删除目录不用 rimraf 了</h2>
<p>删除整个目录树，以前都用 rimraf。</p>
<p>现在 fs.rm 直接支持递归删除。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"node:fs/promises"</span>;

<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">rm</span>(<span class="hljs-string">"dist"</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">force</span>: <span class="hljs-literal">true</span> });
</code></pre>
<p>Node.js 12.10 就有了，现在所有 LTS 版本都稳定支持。</p>
<h2 data-id="heading-8">递归创建目录也不用 mkdir 了</h2>
<p>创建多级目录，以前要装 mkdir。</p>
<p>现在 fs.mkdir 原生支持。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">mkdir</span>(<span class="hljs-string">"logs/app"</span>, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
</code></pre>
<p>Node.js 10.12 就加了，早就稳定了。</p>
<h2 data-id="heading-9">UUID 生成不用装包了</h2>
<p>生成 UUID v4，以前要装 uuid 包。</p>
<p>现在 crypto 模块自带 randomUUID 函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:crypto"</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">randomUUID</span>());
</code></pre>
<p>Node.js 14.17 就有了，稳定版本。</p>
<h2 data-id="heading-10">Base64 编解码也原生支持了</h2>
<p>以前要 polyfill atob 和 btoa 函数。</p>
<p>现在这俩已经是全局函数了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> encoded = <span class="hljs-title function_">btoa</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(encoded);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">atob</span>(encoded));
</code></pre>
<p>Buffer 一直都有，现在加上 atob 和 btoa，浏览器和 Node.js 的代码终于统一了。</p>
<p>Node.js 20 左右加的，现在 LTS 版本都有。</p>
<h2 data-id="heading-11">URL 路由匹配有了 URLPattern</h2>
<p>做路由匹配，以前要装 url-pattern。</p>
<p>现在有全局的 URLPattern API。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> pattern = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLPattern</span>({ <span class="hljs-attr">pathname</span>: <span class="hljs-string">"/users/:id"</span> });
<span class="hljs-keyword">const</span> match = pattern.<span class="hljs-title function_">exec</span>(<span class="hljs-string">"/users/42"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(match.<span class="hljs-property">pathname</span>.<span class="hljs-property">groups</span>.<span class="hljs-property">id</span>);
</code></pre>
<p>Node.js 20 加的，不过还是实验性的。</p>
<p>但已经能用了，而且和浏览器的 URLPattern 完全一样。</p>
<h2 data-id="heading-12">加载 .env 文件不一定要 dotenv 了</h2>
<p>之前加载环境变量文件，必须装 dotenv。</p>
<p>现在可以用 --env-file 参数。</p>
<pre><code class="hljs language-ini" lang="ini">node <span class="hljs-attr">--env-file</span>=.env app.js
</code></pre>
<p>Node.js 20.10 加的实验性功能。</p>
<p>如果需要变量展开或多文件支持，dotenv 还是更强。</p>
<p>但简单场景下，原生的就够了。</p>
<h2 data-id="heading-13">EventTarget 也是全局的了</h2>
<p>以前 Node.js 只有 EventEmitter，要用 Web 标准的 EventTarget 得装 event-target-shim。</p>
<p>现在 EventTarget 已经是全局的了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> target = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventTarget</span>();
target.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"ping"</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"pong"</span>));
target.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">"ping"</span>));
</code></pre>
<p>Node.js 15 加的，15.4 就稳定了。</p>
<p>浏览器和 Node.js 终于可以用同样的事件 API 了。</p>
<h2 data-id="heading-14">运行 TypeScript 不一定要 tsc 了</h2>
<p>以前运行 .ts 文件，要装 TypeScript 编译器或 ts-node。</p>
<p>现在 Node.js 有实验性的 TypeScript 支持。</p>
<pre><code class="hljs language-css" lang="css">node <span class="hljs-attr">--experimental-strip-types</span> app<span class="hljs-selector-class">.ts</span>
</code></pre>
<p>Node.js 21 加的实验性功能。</p>
<p>不过这只是去掉类型标注，不做类型检查。</p>
<p>生产环境还是得用完整的 TypeScript 工具链。</p>
<h2 data-id="heading-15">为啥 Node.js 要把这些功能内置</h2>
<p>看这些变化，能发现一个趋势。</p>
<p>以前需要外部依赖的功能，现在越来越多变成了核心功能。</p>
<p>这样做有几个好处。</p>
<p>减少依赖数量，项目更轻量。</p>
<p>降低供应链攻击风险，不用担心某个包被投毒。</p>
<p>代码在浏览器和服务端之间更容易移植。</p>
<h2 data-id="heading-16">能用就用起来</h2>
<p>这些原生功能，浏览器支持好的就可以直接用了。</p>
<p>实验性的功能可以在开发环境先试试。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO 实战赛 | 开奖公示 🏆]]></title>    <link>https://juejin.cn/post/7586167377382801434</link>    <guid>https://juejin.cn/post/7586167377382801434</guid>    <pubDate>2025-12-22T07:22:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586167377382801434" data-draft-id="7586167377382719514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO 实战赛 | 开奖公示 🏆"/> <meta itemprop="keywords" content="Trae,AI编程,VibeCoding"/> <meta itemprop="datePublished" content="2025-12-22T07:22:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金酱"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194374926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO 实战赛 | 开奖公示 🏆
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194374926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T07:22:09.000Z" title="Mon Dec 22 2025 07:22:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>🎉2025年TRAE SOLO 实战赛正式落幕啦！</p>
<p>本次活动聚焦AI应用落地全流程，以<strong>TRAE SOLO</strong>为核心工具，吸引众多掘友参与，诞生了优质实战内容。感谢每位掘友的付出，相信大家在这次活动中都已经有所收获。</p>
<blockquote>
<p>本次活动评选规则：</p>
<p><strong>优秀文章奖</strong>：由技术评委评分，并参考文章的阅读量、点赞数、评论数等指标；</p>
<p><strong>Coding达人奖</strong>：活动期间同一用户发文数≥<strong>2</strong>篇，单篇文章满足“<em><strong>官方推荐 且 互动总数据（收藏、点赞、评论）＞40 且 浏览量＞1000</strong></em>，即可参与排名。</p>
</blockquote>
<p>详细的名单公示如下：</p>
<h2 data-id="heading-0">获奖名单</h2>
<h4 data-id="heading-1">优秀文章奖</h4>



































































































































<table><thead><tr><th>排名</th><th>用户名</th><th>uid</th><th>获奖文章</th></tr></thead><tbody><tr><td>TOP1</td><td>coder_pig</td><td>4142615541321928</td><td><a href="https://juejin.cn/post/7582200865907982370" target="_blank" title="https://juejin.cn/post/7582200865907982370">🚀用 TRAE SOLO 一天不到就把老项目重构完是什么体验？</a></td></tr><tr><td>TOP2</td><td>HiStewie</td><td>1591748568038823</td><td><a href="https://juejin.cn/post/7579871631096184858" target="_blank" title="https://juejin.cn/post/7579871631096184858">🔥 懂原理但不会说？我怒写了个 AI 模拟器折磨自己，M属性大爆发！</a></td></tr><tr><td>TOP3</td><td>不如摸鱼去</td><td>26044011388510</td><td><a href="https://juejin.cn/post/7576210031873409065" target="_blank" title="https://juejin.cn/post/7576210031873409065">TRAE SOLO 正式发布了？我用它将像老乡鸡那样做饭小程序开源了！</a></td></tr><tr><td>TOP4</td><td>xiaohe0601</td><td>3183831378302871</td><td><a href="https://juejin.cn/post/7579805639436025908" target="_blank" title="https://juejin.cn/post/7579805639436025908">⚪️ 五子棋加入道具系统是一种什么体验？我用 TRAE SOLO 实现了！</a></td></tr><tr><td>TOP5</td><td>草帽lufei</td><td>501033035632093</td><td><a href="https://juejin.cn/post/7572997791451611174" target="_blank" title="https://juejin.cn/post/7572997791451611174">Trae SOLO项目真实需求</a></td></tr><tr><td>TOP6</td><td>大模型真好玩</td><td>3140624091453053</td><td><a href="https://juejin.cn/post/7580723992498438180" target="_blank" title="https://juejin.cn/post/7580723992498438180">LangChain1.0实战之多模态RAG系统（四）——Trae Solo搭建部署多模态RAG前端(附AI编程实践指南)</a></td></tr><tr><td>TOP7</td><td>飞哥数智谈</td><td>3825956195409223</td><td><a href="https://juejin.cn/post/7572397142364766250" target="_blank" title="https://juejin.cn/post/7572397142364766250">TRAE SOLO 正式版实战：一个全栈打卡项目的真实体验</a></td></tr><tr><td>TOP8</td><td>不惑_</td><td>1471609400466218</td><td><a href="https://juejin.cn/post/7572697146286735410" target="_blank" title="https://juejin.cn/post/7572697146286735410">我用 SOLO Coder 做 Excalidraw 开源项目二次开发</a></td></tr><tr><td>TOP9</td><td>龙在天</td><td>3760787883819464</td><td><a href="https://juejin.cn/post/7572092283719925812" target="_blank" title="https://juejin.cn/post/7572092283719925812">不小心更新了trae，发现...</a></td></tr><tr><td>TOP10</td><td>zhouzhouya</td><td>3931509312987511</td><td><a href="https://juejin.cn/post/7574916588718293034" target="_blank" title="https://juejin.cn/post/7574916588718293034">百万QPS防刷赞系统设计实录：TRAE SOLO从生成到生产级改造</a></td></tr><tr><td>TOP11</td><td>也无风雨也雾晴</td><td>2175258804632332</td><td><a href="https://juejin.cn/post/7575102209605173274" target="_blank" title="https://juejin.cn/post/7575102209605173274">记一次 Trae 苏州 Hackathon 之旅：用 Solo 模式把“做饭灵感”变成现实（获优秀奖！）</a></td></tr><tr><td>TOP12</td><td>PBitW</td><td>3048261967153544</td><td><a href="https://juejin.cn/post/7572340344509251610" target="_blank" title="https://juejin.cn/post/7572340344509251610">升级了SOLO，对SOLO的一些建议！👍SOLO真的很不错！</a></td></tr><tr><td>TOP13</td><td>卷福同学</td><td>3456520291098686</td><td><a href="https://juejin.cn/post/7582958136257413156" target="_blank" title="https://juejin.cn/post/7582958136257413156">【AI编程】5分钟用Trae solo做出有BOSS战的《坦克大战》</a></td></tr><tr><td>TOP14</td><td>水冗水孚</td><td>1406974769508679</td><td><a href="https://juejin.cn/post/7582779306731585571" target="_blank" title="https://juejin.cn/post/7582779306731585571">使用Trae SOLO模式开发一个视频提取文字并总结归纳的工具——附线上预览地址</a></td></tr><tr><td>TOP15</td><td>CoolerWu</td><td>2400989125543272</td><td><a href="https://juejin.cn/post/7574699340678086665" target="_blank" title="https://juejin.cn/post/7574699340678086665">TRAE SOLO实战：一个所见即所得的笔记软体</a></td></tr><tr><td>TOP16</td><td>努力的小雨</td><td>572218015747543</td><td><a href="https://juejin.cn/post/7577905525998075945" target="_blank" title="https://juejin.cn/post/7577905525998075945">AI 编程协作，我的一点邪修方法，希望可以帮助到你</a></td></tr><tr><td>TOP17</td><td>银空飞羽</td><td>1086796427178429</td><td><a href="https://juejin.cn/post/7580295137394720783" target="_blank" title="https://juejin.cn/post/7580295137394720783">让Trae SOLO全自主学习开发近期爆出的React RCE漏洞靶场并自主利用验证（CVE-2025-55182）</a></td></tr><tr><td>TOP18</td><td>kungggyoyoyo</td><td>2506542239987550</td><td><a href="https://juejin.cn/post/7576918517238530098" target="_blank" title="https://juejin.cn/post/7576918517238530098">TRAE中国版SOLO模式上线！我用它从0到1开发了一款AI小说编辑器</a></td></tr><tr><td>TOP19</td><td>埃兰德欧神</td><td>3421335915620920</td><td><a href="https://juejin.cn/post/7582528397866172443" target="_blank" title="https://juejin.cn/post/7582528397866172443">AI编程实战：用Trae SOLO模式梭哈一个文档阅读小程序</a></td></tr><tr><td>TOP20</td><td>围巾哥萧尘</td><td>1222312659548446</td><td><a href="https://juejin.cn/post/7582424649783787520" target="_blank" title="https://juejin.cn/post/7582424649783787520">🚀TRAE SOLO 实战赛  智启Coding 码力全开  让AI为你打造完美旅程  @围巾哥萧尘🧣</a></td></tr></tbody></table>
<h4 data-id="heading-2"><strong>Coding达人奖</strong></h4>




















<table><thead><tr><th>用户名</th><th>uid</th><th>参赛文章</th></tr></thead><tbody><tr><td>HiStewie</td><td>1591748568038823</td><td><a href="https://juejin.cn/post/7577653509862654002" title="https://juejin.cn/post/7577653509862654002" target="_blank">3天，1人，从0到付费产品：AI时代个人开发者的生存指南</a></td></tr><tr><td/><td/><td><a href="https://juejin.cn/post/7579871631096184858" title="https://juejin.cn/post/7579871631096184858" target="_blank"> 🔥 懂原理但不会说？我怒写了个 AI 模拟器折磨自己，M属性大爆发！</a></td></tr></tbody></table>
<h2 data-id="heading-3">领奖方式</h2>
<ul>
<li>符合奖金瓜分条件的掘友近期请注意 <strong>[系统消息]</strong> （预计2025年12月22日23:00前下发），请于 <strong>2025 年 12 月 28 日 23 点</strong> 之前在相关问卷中填写信息，过期将视为放弃奖品。</li>
<li>奖品将于问卷截止日期后的 30 个工作日内完成发放。</li>
</ul>
<p><strong>若对获奖名单有疑问，请先自查文章，确认无以下原因后，可 [<a href="https://juejin.cn/user/2781101557286346" target="_blank" title="https://juejin.cn/user/2781101557286346">点击链接</a>] 联系「LALALA」进行申诉~申诉处理时间2025年12月22日-2025年12月28日，过时维持原结果。</strong></p>
<ul>
<li><strong>必须为原创技术文章</strong>，内容符合<a href="https://juejin.cn/book/6844733795329900551/section/6844733795380232199" title="https://juejin.cn/book/6844733795329900551/section/6844733795380232199" target="_blank">掘金社区的内容标准和规范</a>；</li>
<li><strong>字数不得少于 800 字</strong>，不得有广告/洗稿/凑字数/AI撰写等行为，如果发现有此类行为 ，直接取消所有获奖资格（备注：文章中50%及以上内容与网络内容相同，即视为洗稿）；</li>
<li><strong>文章要求首发在掘金</strong>，已在其他平台发布过的文章不计入活动，博客搬家/旧文新发等超过<strong>10篇</strong>直接取消所有获奖资格；</li>
<li><strong>学习笔记/知识点汇总类不能瓜分奖金</strong>，可以是知识点讲解/理解，即所有文章都需要有个人见解、思考、总结，单纯的搬运官网、书中知识点不计入；</li>
<li>刷赞、刷量等有作弊行为的文章，直接取消比赛资格，不能参与评选；</li>
<li>文章需包含背景/问题，核心思路，实操步骤/论证过程，总结反思等，不能只贴代码，如代码量超<strong>60%</strong> 则不计入；</li>
<li>AI代写文章、AI聊天记录等不计入活动（AI检测超过<strong>70%</strong> 取消文章获奖资格）；</li>
<li>工具汇总、软件测评类文章不可参加活动；</li>
<li>参赛文章必须注明参考来源。</li>
</ul>
<h6 data-id="heading-4"><em>活动期间，若发布文章内容与活动主题</em> <em>TRAE</em> <em>无相关性，则取消该用户对应文章获奖资格。</em></h6></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 的新时代已经到来：你需要知道的一切]]></title>    <link>https://juejin.cn/post/7586540799220088873</link>    <guid>https://juejin.cn/post/7586540799220088873</guid>    <pubDate>2025-12-22T06:20:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586540799220088873" data-draft-id="7586178555776876550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 的新时代已经到来：你需要知道的一切"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2025-12-22T06:20:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 的新时代已经到来：你需要知道的一切
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:20:02.000Z" title="Mon Dec 22 2025 06:20:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文： <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fthe-next-era-of-react%2F" target="_blank" title="https://blog.logrocket.com/the-next-era-of-react/" ref="nofollow noopener noreferrer">The next era of React has arrived: Here's what you need to know</a></p>
<p>翻译： <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.heyfe.org%2Fblog" target="_blank" title="https://blog.heyfe.org/blog" ref="nofollow noopener noreferrer">嘿嘿</a></p>
<p>来源：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank">前端周刊</a></p>
</blockquote>
<p>构建异步 UI 向来都是一件非常困难的事情。导航操作将内容隐藏在加载指示器之后，搜索框在响应无序到达时会产生竞态条件，表单提交则需要手动管理每一个加载状态标志和错误信息。每个异步操作都迫使你手动进行协调。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adf9437aff2848d18d07b0c6ea80ce4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766989201&amp;x-signature=KY1YR1SxekvHyE3kBYSrovw0w8o%3D" alt="image.png" loading="lazy"/></p>
<p>这不是一个性能问题，而是一个协调问题。现在，React 的原语声明式地解决了它。</p>
<p>对于开发团队而言，这标志着我们构建方式的一次根本性转变。React 不再需要每位开发者在每个组件中重新发明异步处理逻辑，而是提供了标准化的原语来自动处理协调。这意味着更少的 Bug、更一致的用户体验，以及更少的调试竞态条件的时间。</p>
<h2 data-id="heading-0">React 的异步协调原语</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61ab8486cd4d4d49b0ae09537f3f3bf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766989201&amp;x-signature=miNM4rDSLulnLH6UgCfwGH7dTKU%3D" alt="image.png" loading="lazy"/></p>
<p>在 React Conf 2025 上，来自 React 团队的 Ricky Hanlon 演示的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fasync-react.dev%2F" target="_blank" title="https://async-react.dev/" ref="nofollow noopener noreferrer">Async React 示例</a>，展示了未来的可能性：一个包含搜索、标签页和状态变更的课程浏览应用，在快速网络下感觉即时，在慢速网络下也能保持流畅。UI 更新自动协调，不会闪烁。</p>
<p>这不是一个新库，而是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Freact-19-2-is-here%2F" target="_blank" title="https://blog.logrocket.com/react-19-2-is-here/" ref="nofollow noopener noreferrer">React 19</a> 的协调 API 与 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2022%2F03%2F29%2Freact-v18%23what-is-concurrent-react" target="_blank" title="https://react.dev/blog/2022/03/29/react-v18#what-is-concurrent-react" ref="nofollow noopener noreferrer">React 18 的并发特性</a> 的结合。它们共同构成了 React 团队称之为  <strong>“异步 React（Async React）”</strong>  的完整系统，通过可组合的原语来构建响应式的异步应用程序：</p>
<ul>
<li><strong><code>useTransition</code></strong>：跟踪待处理的异步工作。</li>
<li><strong><code>useOptimistic</code></strong>：在状态变更期间提供即时反馈（乐观更新）。</li>
<li><strong><code>Suspense</code></strong>：声明式地处理加载边界。</li>
<li><strong><code>useDeferredValue</code></strong>：在快速更新期间保持稳定的用户体验。</li>
<li><strong><code>use()</code></strong> ：使数据获取（和上下文读取）变得声明式。</li>
</ul>
<p>理解这些部分如何协同工作是关键，它使我们能从命令式的异步代码转向声明式的协调。</p>
<h2 data-id="heading-1">问题：手动的异步协调</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E9%2597%25AE%25E9%25A2%2598%25E6%2589%258B%25E5%258A%25A8%25E7%259A%2584%25E5%25BC%2582%25E6%25AD%25A5%25E5%258D%258F%25E8%25B0%2583" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E9%97%AE%E9%A2%98%E6%89%8B%E5%8A%A8%E7%9A%84%E5%BC%82%E6%AD%A5%E5%8D%8F%E8%B0%83" ref="nofollow noopener noreferrer"/></p>
<p>在这些原语出现之前，开发者必须手动编排每一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Freact-19-2-the-async-shift%2F" target="_blank" title="https://blog.logrocket.com/react-19-2-the-async-shift/" ref="nofollow noopener noreferrer">异步操作</a>。表单提交需要显式的加载和错误状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SubmitButton</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [isLoading, setIsLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitToServer</span>();
            <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-title function_">setError</span>(e.<span class="hljs-property">message</span>);
            <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
        }
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleSubmit}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading}</span>&gt;</span>
                {isLoading ? '提交中...' : '提交'}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            {error &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>错误：{error}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>数据获取也遵循类似的命令式模式，使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2F15-common-useeffect-mistakes-react%2F" target="_blank" title="https://blog.logrocket.com/15-common-useeffect-mistakes-react/" ref="nofollow noopener noreferrer"><code>useEffect</code></a>：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">UserProfile</span>({ userId }) {
    const <span class="hljs-selector-attr">[user, setUser]</span> = <span class="hljs-built_in">useState</span>(null);
    const <span class="hljs-selector-attr">[isLoading, setIsLoading]</span> = <span class="hljs-built_in">useState</span>(true);
    const <span class="hljs-selector-attr">[error, setError]</span> = <span class="hljs-built_in">useState</span>(null);

    <span class="hljs-built_in">useEffect</span>(() =&gt; {
        <span class="hljs-built_in">setIsLoading</span>(true);
        <span class="hljs-built_in">setError</span>(null);
        <span class="hljs-built_in">fetchUser</span>(userId)
            <span class="hljs-selector-class">.then</span>(data =&gt; {
                setUser(data);
                <span class="hljs-built_in">setIsLoading</span>(false);
            })
            <span class="hljs-selector-class">.catch</span>(e =&gt; {
                setError(e.message);
                <span class="hljs-built_in">setIsLoading</span>(false);
            });
    }, <span class="hljs-selector-attr">[userId]</span>);

    if (isLoading) return &lt;<span class="hljs-selector-tag">div</span>&gt;加载中...&lt;/<span class="hljs-selector-tag">div</span>&gt;;
    if (error) return &lt;<span class="hljs-selector-tag">div</span>&gt;错误：{error}&lt;/<span class="hljs-selector-tag">div</span>&gt;;

    return &lt;<span class="hljs-selector-tag">div</span>&gt;{user<span class="hljs-selector-class">.name</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;;
}
</code></pre>
<p>每个异步操作都重复这个模式：跟踪加载状态、处理错误、协调状态更新。当这种模式扩展到几十个组件时，就会导致不一致的加载状态、被遗忘的错误处理，以及难以调试的微妙竞态条件。</p>
<h2 data-id="heading-2">原语详解</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E5%258E%259F%25E8%25AF%25AD%25E8%25AF%25A6%25E8%25A7%25A3" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E5%8E%9F%E8%AF%AD%E8%AF%A6%E8%A7%A3" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-3"><strong>Actions 自动跟踪异步工作</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23actions-%25E8%2587%25AA%25E5%258A%25A8%25E8%25B7%259F%25E8%25B8%25AA%25E5%25BC%2582%25E6%25AD%25A5%25E5%25B7%25A5%25E4%25BD%259C" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#actions-%E8%87%AA%E5%8A%A8%E8%B7%9F%E8%B8%AA%E5%BC%82%E6%AD%A5%E5%B7%A5%E4%BD%9C" ref="nofollow noopener noreferrer"/></p>
<p>React 19 引入了 Actions 来声明式地处理异步协调。将一个异步函数包装在 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseTransition" target="_blank" title="https://react.dev/reference/react/useTransition" ref="nofollow noopener noreferrer"><code>startTransition</code></a> 中，可以让 React 跟踪整个操作：</p>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[isPending, startTransition]</span> = <span class="hljs-built_in">useTransition</span>();

function <span class="hljs-built_in">submitAction</span>() {
    <span class="hljs-built_in">startTransition</span>(async () =&gt; {
        await <span class="hljs-built_in">submitToServer</span>();
    });
}
</code></pre>
<p><code>isPending</code> 标志在 Promise 解决之前一直为 <code>true</code>。React 会自动处理此状态，并且在 Transition 中抛出的错误会冒泡到错误边界（Error Boundary），而不是在分散的 <code>try/catch</code> 块中处理（你仍需自己处理预期的错误，如验证失败）。</p>
<p>React 将在 Transition 中调用的任何函数被称为 “Action”。命名约定很重要：为函数添加 “Action” 后缀表示它们运行在 Transition 中（例如，<code>submitAction</code>、<code>deleteAction</code>）。</p>
<p>以下是使用 Actions 重写的相同按钮：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SubmitButton</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitAction</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitToServer</span>();
        });
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{submitAction}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isPending}</span>&gt;</span>
            {isPending ? '提交中...' : '提交'}
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
    );
}
</code></pre>
<p>另一种选择是使用 React 19 的 <code>&lt;form&gt;</code> 组件，它可以通过接受一个 <code>action</code> 属性并将其自动包装在 Transition 中来为你处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitAction</span>(<span class="hljs-params">formData</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitToServer</span>(formData);
}

&lt;form action={submitAction}&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'username'</span> /&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/form&gt;;
</code></pre>
<p>与手动 Action 一样，错误仍会冒泡到错误边界。当你希望在 UI 中反映表单状态时，React 19 提供了表单实用程序：<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact-dom%2Fhooks%2FuseFormStatus" target="_blank" title="https://react.dev/reference/react-dom/hooks/useFormStatus" ref="nofollow noopener noreferrer"><code>useFormStatus</code></a> 让子组件可以访问表单的待处理状态，而 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseActionState" target="_blank" title="https://react.dev/reference/react/useActionState" ref="nofollow noopener noreferrer"><code>useActionState</code></a> 则允许你根据 Action 的结果更新组件状态（例如显示验证错误或“点赞”计数）。</p>
<p>相同的模式也适用于按钮、输入框和标签页等可复用组件。你的设计组件可以暴露 <code>action</code>、<code>submitAction</code> 或 <code>changeAction</code> 等 Action 属性，并在内部使用 Transitions 来管理待处理状态和其他异步行为。我们稍后将回到这个模式。</p>
<h3 data-id="heading-4"><strong>乐观更新提供即时反馈</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E4%25B9%2590%25E8%25A7%2582%25E6%259B%25B4%25E6%2596%25B0%25E6%258F%2590%25E4%25BE%259B%25E5%258D%25B3%25E6%2597%25B6%25E5%258F%258D%25E9%25A6%2588" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E4%B9%90%E8%A7%82%E6%9B%B4%E6%96%B0%E6%8F%90%E4%BE%9B%E5%8D%B3%E6%97%B6%E5%8F%8D%E9%A6%88" ref="nofollow noopener noreferrer"/></p>
<p>Actions 提供了待处理状态，但“待处理”并不总是正确的反馈。当你点击复选框来标记任务完成时，它应该立即切换。等待服务器的响应很可能会破坏流程导致竟态问题。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseOptimistic" target="_blank" title="https://react.dev/reference/react/useOptimistic" ref="nofollow noopener noreferrer"><code>useOptimistic()</code></a> 在 Transitions 内部工作，用于在异步 Action 在后台运行时显示即时更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">CompleteButton</span>(<span class="hljs-params">{ complete }</span>) {
    <span class="hljs-keyword">const</span> [optimisticComplete, setOptimisticComplete] = <span class="hljs-title function_">useOptimistic</span>(complete);
    <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">completeAction</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
            <span class="hljs-title function_">setOptimisticComplete</span>(!optimisticComplete);
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">updateCompletion</span>(!optimisticComplete);
        });
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{completeAction}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{isPending</span> ? '<span class="hljs-attr">opacity-50</span>' <span class="hljs-attr">:</span> ''}&gt;</span>
            {optimisticComplete ? <span class="hljs-tag">&lt;<span class="hljs-name">CheckIcon</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
    );
}
</code></pre>
<p>复选框会立即切换。如果请求成功，服务器状态将与乐观更新匹配。如果失败，服务器状态保持旧值，因此复选框会自动恢复其原始状态。</p>
<p>与 <code>useState</code>（它会延迟 Transition 内部的更新）不同，<code>useOptimistic</code> 会立即更新。Transition 边界定义了乐观状态的生命周期：它仅在异步 Action 处于待处理状态时持续存在，一旦 Transition 完成，就会自动“落定”到事实来源（props 或服务器状态）。（注：简单说就是当 transition 为 pending 时 optimisticComplete 为 startTransition 中设定的值，而一旦 transition 完成即 pending 为 false 时，optimisticComplete 会放弃 startTransition 的状态而使用传入的值及为例子中的 complete）</p>
<h3 data-id="heading-5"><strong>Suspense 声明式地协调加载状态</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23suspense-%25E5%25A3%25B0%25E6%2598%258E%25E5%25BC%258F%25E5%259C%25B0%25E5%258D%258F%25E8%25B0%2583%25E5%258A%25A0%25E8%25BD%25BD%25E7%258A%25B6%25E6%2580%2581" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#suspense-%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%9C%B0%E5%8D%8F%E8%B0%83%E5%8A%A0%E8%BD%BD%E7%8A%B6%E6%80%81" ref="nofollow noopener noreferrer"/></p>
<p>乐观更新处理了状态变更，但初始数据加载呢？<code>useEffect</code> 模式迫使我们手动管理 <code>isLoading</code> 状态。<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FSuspense" target="_blank" title="https://react.dev/reference/react/Suspense" ref="nofollow noopener noreferrer"><code>Suspense</code></a> 通过允许我们声明式地定义加载边界来解决这个问题。我们需要控制显示什么后备 UI 以及如何分割加载，因此应用的独立部分可以并行加载。</p>
<p>Suspense 与“支持 Suspense”的数据源协同工作：异步服务器组件、使用 <code>use()</code> API 读取的 Promise（我们接下来会介绍），以及像 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fusing-tanstack-query-next-js%2F" target="_blank" title="https://blog.logrocket.com/using-tanstack-query-next-js/" ref="nofollow noopener noreferrer">TanStack Query</a> 这样的库（它提供了用于缓存和去重的 <code>useSuspenseQuery</code>）。</p>
<p>以下是 Suspense 如何协调多个独立数据流：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>仪表板<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ProfileSkeleton</span> /&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">PostsSkeleton</span> /&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">UserPosts</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>每个组件都可以通过自己的后备方案独立挂起。父组件通过 Suspense 边界处理加载状态，而不是协调多个 <code>useEffect</code> 调用。但有个问题：当你触发导致组件重新获取数据的更新时（如切换标签页或导航），加载后备方案会再次显示，隐藏你已经看到的内容，并产生突兀的加载状态。</p>
<h3 data-id="heading-6"><strong>结合 Transition 与 Suspense</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E7%25BB%2593%25E5%2590%2588-transition-%25E4%25B8%258E-suspense" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E7%BB%93%E5%90%88-transition-%E4%B8%8E-suspense" ref="nofollow noopener noreferrer"/></p>
<p>将 Transition 与 Suspense 结合可以解决这个问题，它告诉 React 保持现有内容可见，而不是立即再次显示后备方案。以下是一个针对标签页切换的适配示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [tab, setTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'profile'</span>);
    <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTabChange</span>(<span class="hljs-params">newTab</span>) {
        <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setTab</span>(newTab));
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleTabChange('profile')}&gt;个人资料<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleTabChange('posts')}&gt;帖子<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">LoadingSkeleton</span> /&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isPending</span> ? <span class="hljs-attr">0.7</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>{tab === 'profile' ? <span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">UserPosts</span> /&gt;</span>}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>现在，加载后备方案仅在初始加载时显示。当你切换标签页时，Transition 会在新数据在后台加载时保持当前内容可见。不透明度样式使其变暗，以表示更新正在进行。一旦就绪，React 会自动无缝地换入新内容。没有突兀的加载状态，没有卡顿。</p>
<p>关键在于：Transitions 会“暂缓”UI 更新，直到异步工作完成，从而防止 Suspense 边界在导航期间回退到后备状态。像 Next.js 这样的框架使用此功能在新路由加载时保持页面可见。</p>
<h3 data-id="heading-7"><strong><code>use()</code> 直接读取异步数据</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23use-%25E7%259B%25B4%25E6%258E%25A5%25E8%25AF%25BB%25E5%258F%2596%25E5%25BC%2582%25E6%25AD%25A5%25E6%2595%25B0%25E6%258D%25AE" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#use-%E7%9B%B4%E6%8E%A5%E8%AF%BB%E5%8F%96%E5%BC%82%E6%AD%A5%E6%95%B0%E6%8D%AE" ref="nofollow noopener noreferrer"/></p>
<p>早些时候，我们看到了 Suspense 如何与“支持 Suspense”的数据源协同工作。<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2Fuse" target="_blank" title="https://react.dev/reference/react/use" ref="nofollow noopener noreferrer"><code>use()</code> API</a> 就是这样的数据源之一：它为数据获取提供了 <code>useEffect</code> 的替代方案，允许你在渲染期间读取 Promise。</p>
<p>以下是用 Suspense 和 <code>use()</code> 重写的最初的 <code>useEffect</code> 示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ userId }</span>) {
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchUser</span>(userId));
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params">{ userId }</span>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载用户时出错<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{userId}</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
    );
}
</code></pre>
<p>组件在读取 Promise 时挂起，触发最近的 Suspense 边界，然后在 Promise 解决时带着数据重新渲染。错误被错误边界捕获。与 Hooks 不同，<code>use()</code> 可以条件调用。</p>
<p>一个注意事项：<strong>Promise 需要被缓存</strong>。否则，每次渲染都会重新创建它。在实践中，你可以使用像 Next.js 这样处理缓存和去重的框架。</p>
<h3 data-id="heading-8"><strong>延迟值防止 UI 过载</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E5%25BB%25B6%25E8%25BF%259F%25E5%2580%25BC%25E9%2598%25B2%25E6%25AD%25A2-ui-%25E8%25BF%2587%25E8%25BD%25BD" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E5%BB%B6%E8%BF%9F%E5%80%BC%E9%98%B2%E6%AD%A2-ui-%E8%BF%87%E8%BD%BD" ref="nofollow noopener noreferrer"/></p>
<p>Actions 和 Suspense 处理离散的操作：点击、提交、导航。但快速输入（如搜索）需要不同的方法，因为你希望输入框即使在结果加载时也能保持响应。</p>
<p>一种方法可以是设计一个 <code>SearchInput</code> 组件，通过内部乐观状态保持输入响应，并在 Transition 中调用 <code>changeAction</code>，这样父组件只需传递 <code>value</code> 和 <code>changeAction</code>。</p>
<p>当你没有设计组件时，<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseDeferredValue" target="_blank" title="https://react.dev/reference/react/useDeferredValue" ref="nofollow noopener noreferrer"><code>useDeferredValue()</code></a> 提供了类似的拆分效果。虽然你可以用它来延迟昂贵的 CPU 计算（性能），但此处的目标是稳定的用户体验。</p>
<p>结合 Suspense、<code>use()</code> 和<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fsignals-fix-error-boundaries%2F" target="_blank" title="https://blog.logrocket.com/signals-fix-error-boundaries/" ref="nofollow noopener noreferrer">ErrorBoundary</a>，我们可以获得完整的搜索体验：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchApp</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
    <span class="hljs-keyword">const</span> deferredQuery = <span class="hljs-title function_">useDeferredValue</span>(query);
    <span class="hljs-keyword">const</span> isStale = query !== deferredQuery;

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setQuery(e.target.value)} /&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载结果时出错<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>搜索中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isStale</span> ? <span class="hljs-attr">0.5</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">SearchResults</span> <span class="hljs-attr">query</span>=<span class="hljs-string">{deferredQuery}</span> /&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchResults</span>(<span class="hljs-params">{ query }</span>) {
    <span class="hljs-keyword">if</span> (!query) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>开始输入以搜索<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
    <span class="hljs-keyword">const</span> results = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchSearchResults</span>(query));
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {results.map(r =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{r.id}</span>&gt;</span>{r.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>Suspense 后备方案仅在初始加载时显示。在后续搜索期间，<code>useDeferredValue</code> 会在新结果于后台加载时保持旧结果可见（通过 <code>isStale</code> 降低不透明度）。错误边界隔离了失败，即使数据请求失败，搜索输入也能保持功能正常。</p>
<h2 data-id="heading-9">综合应用：Async React 示例</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E7%25BB%25BC%25E5%2590%2588%25E5%25BA%2594%25E7%2594%25A8async-react-%25E7%25A4%25BA%25E4%25BE%258B" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E7%BB%BC%E5%90%88%E5%BA%94%E7%94%A8async-react-%E7%A4%BA%E4%BE%8B" ref="nofollow noopener noreferrer"/></p>
<p>到目前为止，我们分别了解了每个原语。<a href="https://link.juejin.cn?target=https%3A%2F%2Fasync-react.dev%2F" target="_blank" title="https://async-react.dev/" ref="nofollow noopener noreferrer">Async React 示例</a> 展示了当一个框架将它们整合到路由、数据获取和设计系统中时会发生什么：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Fassets%2Fup_Async-React-2025-12-03-00_06_43.gif" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/assets/up_Async-React-2025-12-03-00_06_43.gif" ref="nofollow noopener noreferrer"><img src="" alt="gif of async react demo" loading="lazy"/></a></p>
<p>尝试切换网络速度以查看 UI 如何适应：在快速连接下即时，在慢速连接下流畅。</p>
<h3 data-id="heading-10"><strong>路由器将导航包装在 Transitions 中：</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E8%25B7%25AF%25E7%2594%25B1%25E5%2599%25A8%25E5%25B0%2586%25E5%25AF%25BC%25E8%2588%25AA%25E5%258C%2585%25E8%25A3%2585%25E5%259C%25A8-transitions-%25E4%25B8%25AD" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E8%B7%AF%E7%94%B1%E5%99%A8%E5%B0%86%E5%AF%BC%E8%88%AA%E5%8C%85%E8%A3%85%E5%9C%A8-transitions-%E4%B8%AD" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">searchAction</span>(<span class="hljs-params">value</span>) {
    router.<span class="hljs-title function_">setParams</span>(<span class="hljs-string">'q'</span>, value);
}
</code></pre>
<p>更新搜索参数是异步的，会更改 URL 并触发数据重新获取，同时 Transition 会跟踪这一切。</p>
<h3 data-id="heading-11"><strong>数据层将</strong> <code>use()</code> <strong>与缓存的 Promise 结合使用：</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E6%2595%25B0%25E6%258D%25AE%25E5%25B1%2582%25E5%25B0%2586-use-%25E4%25B8%258E%25E7%25BC%2593%25E5%25AD%2598%25E7%259A%2584-promise-%25E7%25BB%2593%25E5%2590%2588%25E4%25BD%25BF%25E7%2594%25A8" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E6%95%B0%E6%8D%AE%E5%B1%82%E5%B0%86-use-%E4%B8%8E%E7%BC%93%E5%AD%98%E7%9A%84-promise-%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">LessonList</span>(<span class="hljs-params">{ tab, search, completeAction }</span>) {
    <span class="hljs-keyword">const</span> lessons = <span class="hljs-title function_">use</span>(data.<span class="hljs-title function_">getLessons</span>(tab, search));
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Design.List</span>&gt;</span>
            {lessons.map(item =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Lesson</span> <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span> <span class="hljs-attr">completeAction</span>=<span class="hljs-string">{completeAction}</span> /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Design.List</span>&gt;</span></span>
    );
}
</code></pre>
<p>当数据加载时，组件会挂起，Suspense 在初始加载时显示后备方案，但在切换标签页和搜索期间，Transitions 会保持旧内容可见。</p>
<h3 data-id="heading-12"><strong>Design 组件暴露 Action 属性：</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23design-%25E7%25BB%2584%25E4%25BB%25B6%25E6%259A%25B4%25E9%259C%25B2-action-%25E5%25B1%259E%25E6%2580%25A7" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#design-%E7%BB%84%E4%BB%B6%E6%9A%B4%E9%9C%B2-action-%E5%B1%9E%E6%80%A7" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Design.SearchInput</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{search}</span> <span class="hljs-attr">changeAction</span>=<span class="hljs-string">{searchAction}</span> /&gt;</span>
</code></pre>
<p><code>SearchInput</code> 在内部使用 <code>useOptimistic</code>，以便在新的 URL 的 Transition 处于待处理状态时立即更新输入值。<code>TabList</code> 同样乐观地更新选中的标签页。</p>
<p>命名约定（“changeAction”）表示传递的函数将在 Transition 中运行。</p>
<h3 data-id="heading-13"><strong>状态变更以相同方式工作：</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E7%258A%25B6%25E6%2580%2581%25E5%258F%2598%25E6%259B%25B4%25E4%25BB%25A5%25E7%259B%25B8%25E5%2590%258C%25E6%2596%25B9%25E5%25BC%258F%25E5%25B7%25A5%25E4%25BD%259C" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E7%8A%B6%E6%80%81%E5%8F%98%E6%9B%B4%E4%BB%A5%E7%9B%B8%E5%90%8C%E6%96%B9%E5%BC%8F%E5%B7%A5%E4%BD%9C" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">completeAction</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">await</span> data.<span class="hljs-title function_">mutateToggle</span>(id);
    router.<span class="hljs-title function_">refresh</span>();
}
</code></pre>
<p>这个 <code>completeAction</code> 通过 <code>LessonList</code> 传递给 <code>Design.CompleteButton</code>，该按钮也暴露了一个 <code>action</code> 属性。该按钮在 Action 运行时乐观地更新完成状态。</p>
<hr/>
<p>这是一个简化版的课程应用示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
    <span class="hljs-keyword">const</span> search = router.<span class="hljs-property">search</span>.<span class="hljs-property">q</span> || <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> tab = router.<span class="hljs-property">search</span>.<span class="hljs-property">tab</span> || <span class="hljs-string">'all'</span>;

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">searchAction</span>(<span class="hljs-params">value</span>) {
        router.<span class="hljs-title function_">setParams</span>(<span class="hljs-string">'q'</span>, value);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">tabAction</span>(<span class="hljs-params">value</span>) {
        router.<span class="hljs-title function_">setParams</span>(<span class="hljs-string">'tab'</span>, value);
    }

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">completeAction</span>(<span class="hljs-params">id</span>) {
        <span class="hljs-keyword">await</span> data.<span class="hljs-title function_">mutateToggle</span>(id);
        router.<span class="hljs-title function_">refresh</span>();
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Design.SearchInput</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{search}</span> <span class="hljs-attr">changeAction</span>=<span class="hljs-string">{searchAction}</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Design.TabList</span> <span class="hljs-attr">activeTab</span>=<span class="hljs-string">{tab}</span> <span class="hljs-attr">changeAction</span>=<span class="hljs-string">{tabAction}</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Design.FallbackList</span> /&gt;</span>}&gt;
                    <span class="hljs-tag">&lt;<span class="hljs-name">LessonList</span> <span class="hljs-attr">tab</span>=<span class="hljs-string">{tab}</span> <span class="hljs-attr">search</span>=<span class="hljs-string">{search}</span> <span class="hljs-attr">completeAction</span>=<span class="hljs-string">{completeAction}</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Design.TabList</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
    );
}
</code></pre>
<p>协调发生在每个层面：</p>
<ul>
<li><strong>路由</strong>：导航被包装在 Transitions 中。</li>
<li><strong>数据获取</strong>：数据层使用 Suspense 和缓存的 Promise。</li>
<li><strong>设计组件</strong>：组件暴露“Action”属性以在内部处理乐观更新。</li>
</ul>
<p>在快速网络上，更新是即时的。在慢速网络上，乐观 UI 和 Transitions 在没有手动逻辑的情况下保持响应性。原语的复杂性由路由器、数据获取设置和设计系统处理。应用代码只需将它们连接起来。</p>
<hr/>
<h2 data-id="heading-14">构建自定义异步组件</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E6%259E%2584%25E5%25BB%25BA%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589%25E5%25BC%2582%25E6%25AD%25A5%25E7%25BB%2584%25E4%25BB%25B6" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E6%9E%84%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6" ref="nofollow noopener noreferrer"/></p>
<p>大多数应用可能会使用已经实现了这些模式的库中的组件。但你也可以自己实现它们来构建自定义异步组件。</p>
<p>这是一个针对 Next.js 的实用示例：一个与 URL 参数同步的可复用选择组件。</p>
<p>这对于过滤器、排序或任何你希望持久化在 URL 中的 UI 状态很有用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRouter, useSearchParams } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/navigation'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RouterSelect</span>(<span class="hljs-params">{ name, value, options, selectAction }</span>) {
    <span class="hljs-keyword">const</span> [optimisticValue, setOptimisticValue] = <span class="hljs-title function_">useOptimistic</span>(value);
    <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
    <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
    <span class="hljs-keyword">const</span> searchParams = <span class="hljs-title function_">useSearchParams</span>();

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">changeAction</span>(<span class="hljs-params">e</span>) {
        <span class="hljs-keyword">const</span> newValue = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
        <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
            <span class="hljs-title function_">setOptimisticValue</span>(newValue);
            <span class="hljs-keyword">await</span> selectAction?.(newValue);

            <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(searchParams);
            params.<span class="hljs-title function_">set</span>(name, newValue);
            router.<span class="hljs-title function_">push</span>(<span class="hljs-string">`?<span class="hljs-subst">${params.toString()}</span>`</span>);
        });
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{name}</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{optimisticValue}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{changeAction}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isPending</span> ? <span class="hljs-attr">0.7</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>
            {options.map(opt =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{opt.value}</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{opt.value}</span>&gt;</span>
                    {opt.label}
                <span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span>
    );
}
</code></pre>
<p>该组件在内部处理协调。父组件可以通过 <code>selectAction</code> 注入副作用：</p>
<pre><code class="hljs language-ini" lang="ini">function Filters() {
    const <span class="hljs-section">[progress, setProgress]</span> = useState(0)<span class="hljs-comment">;</span>
    const <span class="hljs-section">[optimisticProgress, incrementProgress]</span> = useOptimistic(progress, (prev, increment) =&gt; prev + increment)<span class="hljs-comment">;</span>

    return (
        &lt;&gt;
            &lt;LoadingBar <span class="hljs-attr">progress</span>={optimisticProgress} /&gt;
            &lt;RouterSelect
                <span class="hljs-attr">name</span>=<span class="hljs-string">'category'</span>
                <span class="hljs-attr">selected</span>={selectedCategory}
                <span class="hljs-attr">options</span>={categoryOptions}
                <span class="hljs-attr">selectAction</span>={items =&gt; {
                    incrementProgress(30)<span class="hljs-comment">;</span>
                    setProgress(100)<span class="hljs-comment">;</span>
                }}
            /&gt;
        &lt;/&gt;
    )<span class="hljs-comment">;</span>
}
</code></pre>
<p>在这个例子中，进度条的乐观更新和路由器导航被协调在一起。传递给 <code>selectAction</code> 的任何内容都受益于相同的异步协调。命名约定（“Action”）表示它在 Transition 中运行，并且我们可以在内部调用乐观更新。</p>
<p>这就是 Async React 示例中设计组件使用的模式。<code>SearchInput</code>、<code>TabList</code> 和 <code>CompleteButton</code> 都暴露了 Action 属性，在内部处理 Transitions、乐观更新和待处理状态。</p>
<h2 data-id="heading-15">使用 <code>ViewTransition</code>（Canary）实现平滑动画</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E4%25BD%25BF%25E7%2594%25A8-viewtransitioncanary%25E5%25AE%259E%25E7%258E%25B0%25E5%25B9%25B3%25E6%25BB%2591%25E5%258A%25A8%25E7%2594%25BB" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E4%BD%BF%E7%94%A8-viewtransitioncanary%E5%AE%9E%E7%8E%B0%E5%B9%B3%E6%BB%91%E5%8A%A8%E7%94%BB" ref="nofollow noopener noreferrer"/></p>
<p>原语解决了更新 <em>何时</em> 发生的问题，而 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FViewTransition" target="_blank" title="https://react.dev/reference/react/ViewTransition" ref="nofollow noopener noreferrer"><code>ViewTransition</code></a> 则解决了它们 <em>看起来如何</em> 的问题。它包装了浏览器的 View Transition API，并专门在 React Transition（由 <code>useTransition</code>、<code>useDeferredValue</code> 或 Suspense 触发）内部更新组件时激活。</p>
<p>默认情况下，它在状态之间进行交叉淡入淡出，你也可以使用 CSS 自定义动画。</p>
<p>以下是 Async React 示例如何使用它为课程列表添加动画：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ViewTransition</span> <span class="hljs-attr">key</span>=<span class="hljs-string">'results'</span> <span class="hljs-attr">default</span>=<span class="hljs-string">'none'</span> <span class="hljs-attr">enter</span>=<span class="hljs-string">'auto'</span> <span class="hljs-attr">exit</span>=<span class="hljs-string">'auto'</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Design.List</span>&gt;</span>
            {lessons.map(item =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">ViewTransition</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Lesson</span> <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span> <span class="hljs-attr">completeAction</span>=<span class="hljs-string">{completeAction}</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">ViewTransition</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Design.List</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ViewTransition</span>&gt;</span></span>
);
</code></pre>
<p>外层的 <code>ViewTransition</code> 在 Suspense 解析或在状态之间切换时（如显示“无结果”）为整个列表添加动画。每个项目上的内层 <code>ViewTransition</code> 为单个课程添加动画：搜索时，现有项目滑动到新位置，而新项目淡入，移除的项目淡出。</p>
<p><strong>注意：</strong>  <code>ViewTransition</code> <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Freact-view-transitions-activity-api%2F" target="_blank" title="https://blog.logrocket.com/react-view-transitions-activity-api/" ref="nofollow noopener noreferrer">目前仅在</a> React 的 canary 版本中可用。</p>
<h2 data-id="heading-16">实际权衡</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E5%25AE%259E%25E9%2599%2585%25E6%259D%2583%25E8%25A1%25A1" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E5%AE%9E%E9%99%85%E6%9D%83%E8%A1%A1" ref="nofollow noopener noreferrer"/></p>
<p>采用这些模式通常比它们所替代掉的手动逻辑更简单。你并没有增加复杂性；而是将协调工作丢给了 React。话虽如此，以 Transitions、乐观更新和 Suspense 边界的方式思考确实需要思维转变。</p>
<h3 data-id="heading-17"><strong>何时适用</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E4%25BD%2595%25E6%2597%25B6%25E9%2580%2582%25E7%2594%25A8" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E4%BD%95%E6%97%B6%E9%80%82%E7%94%A8" ref="nofollow noopener noreferrer"/></p>
<p>这些原语在具有丰富交互性的应用中表现出色：仪表板、管理面板和搜索界面。它们消除了整类的 Bug。竞态条件消失了。导航感觉无缝。你可以用更少的样板代码获得“原生应用”的感觉。</p>
<h3 data-id="heading-18"><strong>不要修复未损坏的东西</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E4%25B8%258D%25E8%25A6%2581%25E4%25BF%25AE%25E5%25A4%258D%25E6%259C%25AA%25E6%258D%259F%25E5%259D%258F%25E7%259A%2584%25E4%25B8%259C%25E8%25A5%25BF" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E4%B8%8D%E8%A6%81%E4%BF%AE%E5%A4%8D%E6%9C%AA%E6%8D%9F%E5%9D%8F%E7%9A%84%E4%B8%9C%E8%A5%BF" ref="nofollow noopener noreferrer"/></p>
<p>如果 <code>useState</code> 和 <code>useEffect</code> 对你来说工作可靠，就没有必要拆除它们。如果你没有在处理竞态条件、突兀的加载状态或输入延迟，你就不需要解决不存在的问题。</p>
<h3 data-id="heading-19"><strong>迁移路径</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E8%25BF%2581%25E7%25A7%25BB%25E8%25B7%25AF%25E5%25BE%2584" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E8%BF%81%E7%A7%BB%E8%B7%AF%E5%BE%84" ref="nofollow noopener noreferrer"/></p>
<p>你可以选择渐进式的采用。下次构建具有复杂异步状态的功能时，可以尝试用 Transition 代替另一个 <code>isLoading</code> 标识。在即时反馈重要的地方添加乐观 UI。这些工具与现有代码共存，因此你可以逐个功能地采用它们。</p>
<h2 data-id="heading-20">结论：向声明式异步的转变</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E7%25BB%2593%25E8%25AE%25BA%25E5%2590%2591%25E5%25A3%25B0%25E6%2598%258E%25E5%25BC%258F%25E5%25BC%2582%25E6%25AD%25A5%25E7%259A%2584%25E8%25BD%25AC%25E5%258F%2598" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E7%BB%93%E8%AE%BA%E5%90%91%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%BC%82%E6%AD%A5%E7%9A%84%E8%BD%AC%E5%8F%98" ref="nofollow noopener noreferrer"/></p>
<p>异步 React（Async React）是并发渲染和协调原语的结合，形成了一个用于处理异步工作的完整系统，而这在过去需要手动编排。</p>
<p>随着这些原语在整个生态系统中被采用，这种转变变得切实可行。在 React Conf 2025 上宣布的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freactwg%2Fasync-react%2Fdiscussions" target="_blank" title="https://github.com/reactwg/async-react/discussions" ref="nofollow noopener noreferrer">Async React 工作组</a> 正在积极致力于在路由器、数据获取库和设计组件中标准化这些模式。</p>
<p>我们已经看到它的实际应用：</p>
<ul>
<li><strong>路由器</strong>（如 Next.js）默认将导航包装在 Transitions 中。</li>
<li><strong>数据库</strong>（如 TanStack Query 和 SWR）深度集成了对 Suspense 的支持。</li>
<li><strong>设计系统</strong>预计将跟进，暴露 Action 属性以在内部处理待处理状态和乐观更新。</li>
</ul>
<p>最终，这将异步处理的复杂性从应用代码转移到了框架。你描述 <em>应该发生什么</em>（Action、状态变更、导航），而 React 协调 <em>它如何发生</em>（待处理状态、乐观更新、加载边界）。React 的下一个时代不仅是关于新功能；更是关于让无缝的异步协调成为应用功能的默认方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[这样做的幂等也太全了吧]]></title>    <link>https://juejin.cn/post/7586879894207807551</link>    <guid>https://juejin.cn/post/7586879894207807551</guid>    <pubDate>2025-12-23T08:59:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586879894207807551" data-draft-id="7586889698242428991" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="这样做的幂等也太全了吧"/> <meta itemprop="keywords" content="后端,Spring,Java"/> <meta itemprop="datePublished" content="2025-12-23T08:59:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员飞哥"/> <meta itemprop="url" content="https://juejin.cn/user/2277843821145847"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            这样做的幂等也太全了吧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843821145847/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员飞哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T08:59:59.000Z" title="Tue Dec 23 2025 08:59:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在做票务下单的时候，肯定要做幂等和放重复的，防止用户操作出现重复的订单和重复支付等问题，于是有了本篇文章。幂等设计需<strong>分层防护</strong>，从接口层到数据层形成完整防线。推荐以下方案：</p>
<hr/>
<h3 data-id="heading-0">1. 接口层：幂等Token机制（防前端重复提交）</h3>
<p><strong>流程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 进入下单页时，后端生成唯一token并返回</span>
<span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
redis.setex(<span class="hljs-string">"order:token:"</span> + token, <span class="hljs-number">600</span>, userId); <span class="hljs-comment">// 10分钟有效期</span>

<span class="hljs-comment">// 2. 下单请求必须携带此token，后端首次处理后立即删除</span>
<span class="hljs-comment">// 3. 重复请求因token不存在而拒绝</span>
</code></pre>
<p><strong>Lua原子校验脚本</strong>：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-keyword">local</span> tokenKey = KEYS[<span class="hljs-number">1</span>]
<span class="hljs-keyword">local</span> userId = ARGV[<span class="hljs-number">1</span>]

<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">"GET"</span>, tokenKey) == userId <span class="hljs-keyword">then</span>
    redis.call(<span class="hljs-string">"DEL"</span>, tokenKey)  <span class="hljs-comment">-- 消费后删除</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">end</span>
<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>  <span class="hljs-comment">-- token不存在或已使用</span>
</code></pre>
<p><strong>优点</strong>：简单高效，防止用户<strong>误操作重复点击</strong>
<strong>缺点</strong>：无法防网络重试、恶意调用</p>
<hr/>
<h3 data-id="heading-1">2. 业务层：唯一业务标识（防网络重试、并发）</h3>
<p><strong>设计核心</strong>：用<strong>业务唯一键</strong>做幂等，而非依赖token，比如同一个用户5秒内只能提交一次同一个演出场次的购买请求。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Redis SETNX实现分布式锁（用户维度）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order:lock:"</span> + userId + <span class="hljs-string">":"</span> + sessionId;
<span class="hljs-type">Boolean</span> <span class="hljs-variable">locked</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(lockKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">5</span>, TimeUnit.SECONDS);
<span class="hljs-keyword">if</span> (!locked) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizException</span>(<span class="hljs-string">"正在下单中，请勿重复提交"</span>);
}

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 执行下单逻辑</span>
} <span class="hljs-keyword">finally</span> {
    redis.delete(lockKey);
}
</code></pre>
<hr/>
<h3 data-id="heading-2">3. 数据层：数据库唯一索引（最终兜底）</h3>
<p><strong>订单表设计</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">order</span>` (
  `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
  `order_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,  <span class="hljs-comment">-- 订单号唯一索引</span>
  `user_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `request_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,  <span class="hljs-comment">-- 客户端请求ID</span>
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_request_id` (`user_id`, `request_id`)  <span class="hljs-comment">-- 核心幂等约束</span>
);
</code></pre>
<p><strong>幂等插入逻辑</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 即使重复消费MQ，数据库层也会拒绝</span>
<span class="hljs-keyword">try</span> {
    orderMapper.insert(order);
} <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
    log.warn(<span class="hljs-string">"重复请求，直接返回已有订单"</span>);
    <span class="hljs-keyword">return</span> getOrderByRequestId(userId, requestId); <span class="hljs-comment">// 查询已有订单返回</span>
}
</code></pre>
<p><strong>关键</strong>：<code>request_id</code>由客户端生成，每次下单请求唯一，重试时保持不变</p>
<hr/>
<h3 data-id="heading-3">4. MQ消费层：消息去重（防重复消费）</h3>
<p><strong>RocketMQ场景</strong>：消息可能因重试、Broker故障被重复投递</p>
<p><strong>实现方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RocketMQMessageListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrderMessage</span><span class="hljs-params">(MessageExt message)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">msgId</span> <span class="hljs-operator">=</span> message.getKeys(); <span class="hljs-comment">// 业务唯一messageKey</span>
    
    <span class="hljs-comment">// 1. Redis记录已消费消息（幂等表）</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">consumedKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"mq:consumed:"</span> + msgId;
    <span class="hljs-type">Boolean</span> <span class="hljs-variable">isNew</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(consumedKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">24</span>, TimeUnit.HOURS);
    
    <span class="hljs-keyword">if</span> (!isNew) {
        log.warn(<span class="hljs-string">"消息已消费，跳过处理: {}"</span>, msgId);
        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 幂等返回</span>
    }
    
    <span class="hljs-comment">// 2. 执行业务逻辑（带数据库唯一索引兜底）</span>
    <span class="hljs-keyword">try</span> {
        createOrder(message.getBody());
    } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
        log.warn(<span class="hljs-string">"数据库幂等拦截: {}"</span>, msgId);
        <span class="hljs-comment">// 已存在订单，无需回滚Redis标记</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-4">5. 状态机幂等（防订单状态重复变更）</h3>
<p><strong>状态流转必须满足单调性</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 只允许正向流转：CREATED → PAID → SUCCESS，不可逆向</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">updateStatus</span><span class="hljs-params">(Long orderId, String oldStatus, String newStatus)</span> {
    <span class="hljs-comment">// WHERE条件带上原状态，利用乐观锁保证幂等</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">updated</span> <span class="hljs-operator">=</span> orderMapper.updateStatus(orderId, oldStatus, newStatus);
    <span class="hljs-keyword">return</span> updated &gt; <span class="hljs-number">0</span>; <span class="hljs-comment">// 返回true才处理后续逻辑</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-5"><strong>完整幂等防护体系</strong></h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[前端层: 禁用按钮 + Token] --&gt; B[网关层: 限流 + 防刷]
    B --&gt; C[接口层: 校验Token + 分布式锁]
    C --&gt; D[业务层: 唯一业务标识校验]
    D --&gt; E[数据层: 唯一索引兜底]
    E --&gt; F[MQ层: 消息去重表]
    F --&gt; G[状态机: 乐观锁幂等]
    
    style E fill:#f9f,stroke:#333,stroke-width:2px
</code></pre>
<hr/>
<h3 data-id="heading-6">关键总结</h3>









































<table><thead><tr><th>防护层级</th><th>防什么</th><th>实现方式</th><th>Redis/MQ应用</th></tr></thead><tbody><tr><td><strong>接口层</strong></td><td>重复点击</td><td>幂等Token</td><td>Redis存储并原子删除</td></tr><tr><td><strong>业务层</strong></td><td>并发重复请求</td><td>分布式锁/唯一键校验</td><td>Redis SETNX</td></tr><tr><td><strong>数据层</strong></td><td>一切重复写入</td><td>唯一索引+捕获异常</td><td>最终兜底</td></tr><tr><td><strong>MQ层</strong></td><td>消息重复消费</td><td>消息去重表</td><td>Redis记录已消费msgId</td></tr><tr><td><strong>状态机</strong></td><td>状态重复变更</td><td>WHERE原状态+乐观锁</td><td>无需Redis</td></tr></tbody></table>
<p><strong>最佳实践</strong>：<strong>数据库唯一索引是最终底线</strong>，其他层是优化体验与性能。在已有Redis+MQ架构下，<strong>优先实现数据层+MQ层</strong>幂等，再根据前端体验补充Token机制。</p>
<h2 data-id="heading-7">那么在高并发下做这么多幂等操作，是否会影响性能呢？</h2>
<p>分层幂等设计确实会带来性能开销，但通过架构优化可将影响控制在5%以内，且<strong>收益远大于成本</strong>。</p>
<hr/>
<h3 data-id="heading-8">各层性能损耗分析</h3>








































<table><thead><tr><th>幂等层级</th><th>RT增加</th><th>QPS损耗</th><th>资源消耗</th><th>优化手段</th></tr></thead><tbody><tr><td><strong>接口Token层</strong></td><td><strong>1-2ms</strong>（Redis SETEX）</td><td>&lt;1%</td><td>极小</td><td>Pipeline批量预热Token</td></tr><tr><td><strong>Redis分布式锁</strong></td><td><strong>2-3ms</strong>（SETNX+Lua）</td><td>2-3%</td><td>网络RTT</td><td>锁粒度细化+过期时间缩短</td></tr><tr><td><strong>数据库唯一索引</strong></td><td><strong>0ms</strong>（写入时校验）</td><td><strong>0%</strong></td><td>磁盘I/O可忽略</td><td>无需优化，天然幂等</td></tr><tr><td><strong>MQ消息去重</strong></td><td><strong>1ms</strong>（Redis SETNX）</td><td>&lt;1%</td><td>内存占用极低</td><td>异步标记，不阻塞主流程</td></tr></tbody></table>
<p><strong>总性能影响</strong>：在10,000QPS压力下，整体RT增加 <strong>&lt;5ms</strong> ，QPS下降约 <strong>3-5%</strong> 。</p>
<hr/>
<h3 data-id="heading-9">高并发优化关键策略</h3>
<h4 data-id="heading-10">1. Redis操作批量化与Pipeline</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 批量预生成Token</span>
List&lt;String&gt; tokenList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-number">10000</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
       tokenList.add(UUID.randomUUID().toString());
 }
List&lt;Object&gt; results = redisTemplate.executePipelined((RedisCallback&lt;?&gt;) connection -&gt; {
    <span class="hljs-keyword">for</span> (String token : tokens) {
         <span class="hljs-comment">// 每个Token有效期10分钟</span>
         connection.setEx(key.getBytes(), <span class="hljs-number">600</span>, <span class="hljs-string">"AVAILABLE"</span>.getBytes());
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
});
</code></pre>
<h4 data-id="heading-11">2. MQ去重异步化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 消费主流程不等待去重标记，先查缓存再决定是否需要标记</span>
<span class="hljs-keyword">if</span> (!isConsumedCache.getIfPresent(msgId)) { <span class="hljs-comment">// Caffeine本地缓存</span>
    <span class="hljs-comment">// 异步提交Redis去重标记，不阻塞业务</span>
    threadPool.execute(() -&gt; markConsumed(msgId)); 
}
</code></pre>
<h4 data-id="heading-12">3. 降级熔断（极端场景）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SentinelResource(value = "createOrder", fallback = "createOrderFallback")</span>
<span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Request request)</span> {
    <span class="hljs-comment">// 正常流程：完整幂等校验</span>
}

<span class="hljs-comment">// 降级后：仅保留数据库唯一索引兜底（性能最优）</span>
<span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrderFallback</span><span class="hljs-params">(Request request)</span> {
    <span class="hljs-keyword">return</span> createOrderWithDBOnly(request);
}
</code></pre>
<hr/>
<h3 data-id="heading-13">不做幂等的性能代价对比</h3>





























<table><thead><tr><th>场景</th><th>有幂等（成本）</th><th>无幂等（代价）</th><th>业务影响</th></tr></thead><tbody><tr><td><strong>重复支付</strong></td><td>Redis 1ms</td><td>退款流程10min+数据库回滚</td><td>资损+客诉</td></tr><tr><td><strong>超卖</strong></td><td>Lua锁3ms</td><td>数据库锁竞争100ms+事务回滚</td><td>库存数据混乱</td></tr><tr><td><strong>MQ重复消费</strong></td><td>SETNX 1ms</td><td>重复创建订单+人工对账</td><td>运维成本翻倍</td></tr></tbody></table>
<p><strong>结论</strong>：幂等校验的<strong>5ms成本</strong> vs 资损/客诉/运维的<strong>小时级代价</strong>，前者可接受度<strong>100%</strong>。</p>
<hr/>
<h3 data-id="heading-14">压测数据验证</h3>
<p>在某剧院1000座位秒杀场景实测：</p>
<ul>
<li><strong>带完整幂等</strong>：峰值QPS <strong>5200</strong>，平均RT <strong>38ms</strong>，错误率 <strong>0%</strong></li>
<li><strong>仅DB唯一索引</strong>：峰值QPS <strong>5400</strong>，平均RT <strong>35ms</strong>，错误率 <strong>0.3%</strong>（用户重试体验差）</li>
</ul>
<p><strong>建议</strong>：在高并发场景下，<strong>保留核心幂等（Redis锁+DB唯一索引）</strong>，MQ去重层在极端压测时可临时降级，平时开启保障一致性。</p>
<blockquote>
<p>如果觉得有启发，不妨关注下我的公众号《码上实战》。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 已经改变了，你的 Hooks 也应该改变]]></title>    <link>https://juejin.cn/post/7586178555776843782</link>    <guid>https://juejin.cn/post/7586178555776843782</guid>    <pubDate>2025-12-22T06:16:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586178555776843782" data-draft-id="7585928504949899300" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 已经改变了，你的 Hooks 也应该改变"/> <meta itemprop="keywords" content="前端,Vue.js,GitHub"/> <meta itemprop="datePublished" content="2025-12-22T06:16:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 已经改变了，你的 Hooks 也应该改变
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:16:15.000Z" title="Mon Dec 22 2025 06:16:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文： <a href="https://link.juejin.cn?target=https%3A%2F%2Fallthingssmitty.com%2F2025%2F12%2F01%2Freact-has-changed-your-hooks-should-too%2F" target="_blank" title="https://allthingssmitty.com/2025/12/01/react-has-changed-your-hooks-should-too/" ref="nofollow noopener noreferrer">React has changed, your Hooks should too</a></p>
<p>翻译： <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.heyfe.org%2Fblog" target="_blank" title="https://blog.heyfe.org/blog" ref="nofollow noopener noreferrer">嘿嘿</a></p>
<p>来源：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank">前端周刊</a></p>
</blockquote>
<p>React Hooks 已经问世多年，但大多数代码库仍然以同样的方式使用它们：用点 <code>useState</code>，过度使用 <code>useEffect</code>，以及大量不经思考就复制粘贴的模式。我们都经历过。</p>
<p>但 Hooks 从来就不是生命周期方法的简单重写。它们是用于构建更具表现力、更模块化架构的设计系统。</p>
<p>随着并发式 React（React 18/19 时代）的到来，React 处理数据（尤其是<strong>异步数据</strong>）的方式已经改变。我们现在有了服务器组件、<code>use()</code>、服务器操作、基于框架的数据加载……甚至根据你的设置，在客户端组件中也具备了一些异步能力。</p>
<p>那么，让我们来看看现代 Hook 模式如今是什么样子，React 在引导开发者走向何方，以及生态系统不断陷入的陷阱。</p>
<h2 data-id="heading-0"><code>useEffect</code> 陷阱：做得太多、太频繁</h2>
<p><code>useEffect</code> 仍然是最常被滥用的 Hook。它常常成为堆放不应属于那里的逻辑的“垃圾场”，例如数据获取、衍生值，甚至简单的状态转换。这通常就是组件开始感觉“诡异”的时候：它们在不恰当的时间重新运行，或者运行得过于频繁。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 每次查询变化时都会重新运行，即使新值实际上相同</span>
  <span class="hljs-title function_">fetchData</span>();
}, [query]);

</code></pre>
<p>这种痛苦大部分源于将<strong>衍生状态</strong>和<strong>副作用</strong>混在一起，而 React 对这两者的处理方式截然不同。</p>
<h3 data-id="heading-1">以 React 预期的方式使用副作用</h3>
<p>React 在这里的规则出奇地简单：</p>
<blockquote>
<p>只在真正有必要时才使用副作用。</p>
</blockquote>
<p>其他一切都应该在渲染过程中衍生出来。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> filteredData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-title function_">includes</span>(query));
}, [data, query]);

</code></pre>
<p>当你确实需要一个副作用时，React 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseEffectEvent" target="_blank" title="https://react.dev/reference/react/useEffectEvent" ref="nofollow noopener noreferrer">useEffectEvent</a> 会是你的好帮手。它让你能在副作用内部访问最新的 props/状态，而<strong>不必</strong>扰乱你的依赖数组。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> handleSave = <span class="hljs-title function_">useEffectEvent</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">saveToServer</span>(formData);
});

</code></pre>
<p>在使用 <code>useEffect</code> 之前，先问问自己：</p>
<ul>
<li>这是由外部因素（网络、DOM、订阅）驱动的吗？</li>
<li>还是我可以在渲染过程中计算这个？</li>
</ul>
<p>如果是后者，像 <code>useMemo</code>、<code>useCallback</code> 或框架提供的基础构建块这样的工具，会让你的组件健壮得多。</p>
<blockquote>
<p>🙋🏻‍♂️ 小贴士</p>
<p>不要把 useEffectEvent 当作一种用来逃避编写依赖数组（dependency arrays）的‘作弊码’。它是专门针对 Effect 内部的操作逻辑进行优化的。”</p>
</blockquote>
<h2 data-id="heading-2">自定义 Hooks：不仅仅是复用，更是真正的封装</h2>
<p>自定义 Hooks 不仅仅是为了减少重复代码。它们关乎将领域逻辑从组件中抽离出来，让你的 UI 专注于……嗯，UI。</p>
<p>例如，与其用这样的设置代码来污染组件：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">listener</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setWidth</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, listener);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, listener);
}, []);

</code></pre>
<p>不如将其移入一个 Hook：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useWindowWidth</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [width, setWidth] = <span class="hljs-title function_">useState</span>(
    <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> ? <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> : <span class="hljs-number">0</span>
  );

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">listener</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setWidth</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, listener);
    <span class="hljs-comment">// 注意：原文为 'change'，但通常 resize 事件应配对 'resize'，这里保持原文但应该是笔误</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'change'</span>, listener);
  }, []);

  <span class="hljs-keyword">return</span> width;
}

</code></pre>
<p>这样就干净多了。也更容易测试。你的组件不再泄露实现细节。</p>
<blockquote>
<p>SSR 小提示</p>
<p>总是从确定的回退值开始，以避免水合不匹配报错。</p>
</blockquote>
<h2 data-id="heading-3">基于订阅的状态与 <code>useSyncExternalStore</code></h2>
<p>React 18 引入了 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseSyncExternalStore" target="_blank" title="https://react.dev/reference/react/useSyncExternalStore" ref="nofollow noopener noreferrer">useSyncExternalStore</a>，它悄无声息地解决了一大类与订阅、撕裂效应和高频更新相关的 Bug。</p>
<p>如果你曾经与 <code>matchMedia</code>、滚动位置或跨渲染行为不一致的第三方存储库斗争过，这就是 React 希望你使用的 API。</p>
<p>它适用于：</p>
<ul>
<li>浏览器 API（<code>matchMedia</code>、页面可见性、滚动位置）</li>
<li>外部存储（Redux、Zustand、自定义订阅系统）</li>
<li>任何对性能敏感或事件驱动的事物</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useMediaQuery</span>(<span class="hljs-params">query</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useSyncExternalStore</span>(
    <span class="hljs-function">(<span class="hljs-params">callback</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> mql = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(query);
      mql.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, callback);
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> mql.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'change'</span>, callback);
    },
    <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(query).<span class="hljs-property">matches</span>,
    <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">false</span> <span class="hljs-comment">// SSR 回退值</span>
  );
}

</code></pre>
<h2 data-id="heading-4">使用过渡和延迟值实现更流畅的 UI</h2>
<p>如果你的应用在用户输入或筛选时感觉卡顿，React 的并发工具可以提供帮助。这些并非魔法，但它们能帮助 React 将紧急更新置于高开销更新之前。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-section">[searchTerm, setSearchTerm]</span> = useState('')<span class="hljs-comment">;</span>
const <span class="hljs-attr">deferredSearchTerm</span> = useDeferredValue(searchTerm)<span class="hljs-comment">;</span>

const <span class="hljs-attr">filtered</span> = useMemo(() =&gt; {
  return data.filter(<span class="hljs-attr">item</span> =&gt; item.includes(deferredSearchTerm))<span class="hljs-comment">;</span>
}, <span class="hljs-section">[data, deferredSearchTerm]</span>)<span class="hljs-comment">;</span>

</code></pre>
<p>输入保持响应，而繁重的筛选工作被延后处理。</p>
<p>快速心智模型：</p>
<ul>
<li><code>startTransition(() =&gt; setState())</code> → 延迟<strong>状态更新</strong></li>
<li><code>useDeferredValue(value)</code> → 延迟<strong>衍生值</strong></li>
</ul>
<p>需要时可以一起使用，但不要过度使用。它们不适用于琐碎的计算。</p>
<h2 data-id="heading-5">可测试和可调试的 Hooks</h2>
<p>现代 React DevTools 让检查自定义 Hooks 变得极其简单。如果你能良好地组织你的 Hooks，大部分逻辑无需渲染实际组件就能测试。</p>
<ul>
<li>将领域逻辑与 UI 分离</li>
<li>尽可能直接测试 Hooks</li>
<li>为了清晰，将提供者逻辑提取到其自身的 Hook 中</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useAuthProvider</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">login</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">credentials</span>) =&gt; { <span class="hljs-comment">/* ... */</span> };
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; { <span class="hljs-comment">/* ... */</span> };
  <span class="hljs-keyword">return</span> { user, login, logout };
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">AuthContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AuthProvider</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">useAuthProvider</span>();
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AuthContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">AuthContext.Provider</span>&gt;</span></span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useAuth</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">AuthContext</span>);
}

</code></pre>
<p>下次调试时，你会感谢自己这么做。</p>
<h2 data-id="heading-6">超越 Hooks：迈向数据优先的 React 应用</h2>
<p>React 正朝着<strong>数据优先的渲染流程</strong>转变，特别是现在服务器组件和基于操作的模式正在成熟。它并非追求像 Solid.js 那样的细粒度响应式，但 React 正大力投入异步数据和服务器驱动的 UI。</p>
<p>值得了解的 API：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2Fuse" target="_blank" title="https://react.dev/reference/react/use" ref="nofollow noopener noreferrer">use()</a> 用于在渲染期间处理异步资源（主要用于服务器组件；通过服务器操作在客户端组件中支持有限）</li>
<li><code>useEffectEvent</code> 用于稳定的副作用回调</li>
<li><code>useActionState</code> 用于类似工作流的异步状态</li>
<li>框架级别的缓存和数据原语</li>
<li>更好的并发渲染工具和 DevTools</li>
</ul>
<p>方向很明确：React 希望我们减少对“瑞士军刀”式 <code>useEffect</code> 的依赖，更多地依赖简洁、由渲染驱动的数据流。</p>
<p>围绕衍生状态和服务器/客户端边界来设计你的 Hooks，能让你的应用天然地面向未来。</p>
<h2 data-id="heading-7">Hooks 即架构，而非语法</h2>
<p>Hooks 不仅仅是比类组件更友好的 API，它们是一种架构模式。</p>
<ul>
<li>将衍生状态放在渲染过程中</li>
<li>只将副作用用于真正的副作用</li>
<li>通过小而专注的 Hooks 组合逻辑</li>
<li>让并发工具平滑处理异步流程</li>
<li>同时考虑客户端<strong>和</strong>服务器边界</li>
</ul>
<p>React 在进化，我们的 Hooks 也应随之进化。</p>
<p>如果你仍然在用 2020 年的方式写 Hooks，那也没关系。我们大多数人都是如此。但 React 18+ 给了我们一个强大得多的工具箱，熟悉这些模式会很快带来回报。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端大数字精度解决：big.js的教程和原理解析]]></title>    <link>https://juejin.cn/post/7585751355592949779</link>    <guid>https://juejin.cn/post/7585751355592949779</guid>    <pubDate>2025-12-22T00:08:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355592949779" data-draft-id="7576483553879441434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端大数字精度解决：big.js的教程和原理解析"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-12-22T00:08:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端大数字精度解决：big.js的教程和原理解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:08:33.000Z" title="Mon Dec 22 2025 00:08:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>在前端开发中，处理金融、电商等领域的数字计算时，JavaScript 原生的 Number 类型因采用 64 位双精度浮点数存储，极易出现精度丢失问题（如 <code>0.1 + 0.2 !== 0.3</code>）。big.js 作为轻量级的大数处理库，以简洁的 API 和清晰的源码逻辑，成为解决该问题的主流选择。本文将从 API 用法和源码原理两方面，全面解析 big.js 的核心价值。</p>
<h2 data-id="heading-0">1. 核心特性</h2>
<p>big.js 专为高精度十进制计算设计，核心特点：</p>
<ul>
<li>轻量（仅 ~6KB 无依赖）；</li>
<li>不可变设计（所有操作返回新实例）；</li>
<li>可配置精度、舍入模式；</li>
<li>兼容所有主流浏览器和 Node.js。</li>
</ul>
<h2 data-id="heading-1">2. 常用和特殊API详解</h2>
<h3 data-id="heading-2">2.1. 基础初始化 API</h3>
<p>big.js 的核心是 <code>Big</code> 构造函数，用于创建大数实例，支持多种入参类型：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Big</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'big.js'</span>;

<span class="hljs-comment">// 1. 基础初始化（支持数字、字符串、Big 实例）</span>
<span class="hljs-keyword">const</span> num1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">123</span>); <span class="hljs-comment">// 数字</span>
<span class="hljs-keyword">const</span> num2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'123.4567890123456789'</span>); <span class="hljs-comment">// 字符串（推荐，避免精度丢失）</span>
<span class="hljs-keyword">const</span> num3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(num2); <span class="hljs-comment">// 基于已有 Big 实例创建</span>

<span class="hljs-comment">// 2. 特殊值初始化</span>
<span class="hljs-keyword">const</span> zero = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 0</span>
<span class="hljs-keyword">const</span> negative = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'-987654321.987654321'</span>); <span class="hljs-comment">// 负数</span>
<span class="hljs-keyword">const</span> scientific = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'1.23e+5'</span>); <span class="hljs-comment">// 科学计数法</span>
</code></pre>
<blockquote>
<p>注意：初始化时优先使用<strong>字符串入参</strong>，避免数字本身已因浮点数存储丢失精度。</p>
</blockquote>
<h3 data-id="heading-3">2.2. 常用计算 API</h3>
<p>big.js 提供了完整的算术运算方法，所有方法均返回新的 Big 实例（原实例不变）：</p>








































<table><thead><tr><th>API 方法</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>plus(n)</code></td><td>加法</td><td><code>new Big(0.1).plus(0.2).toString()</code> → "0.3"</td></tr><tr><td><code>minus(n)</code></td><td>减法</td><td><code>new Big(1).minus(0.9).toString()</code> → "0.1"</td></tr><tr><td><code>times(n)</code></td><td>乘法</td><td><code>new Big(2).times(0.1).toString()</code> → "0.2"</td></tr><tr><td><code>div(n)</code></td><td>除法</td><td><code>new Big(1).div(3).toString()</code> → "0.3333333333"</td></tr><tr><td><code>mod(n)</code></td><td>取模</td><td><code>new Big(5).mod(2).toString()</code> → "1"</td></tr><tr><td><code>pow(n)</code></td><td>幂运算</td><td><code>new Big(10).pow(3).toString()</code> → "1000"</td></tr></tbody></table>
<p>示例代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 高精度加法</span>
<span class="hljs-keyword">const</span> a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'0.1'</span>);
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'0.2'</span>);
<span class="hljs-keyword">const</span> sum = a.<span class="hljs-title function_">plus</span>(b);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sum.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// "0.3"</span>

<span class="hljs-comment">// 高精度除法（默认精度 10 位）</span>
<span class="hljs-keyword">const</span> c = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'1'</span>);
<span class="hljs-keyword">const</span> d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'3'</span>);
<span class="hljs-keyword">const</span> div = c.<span class="hljs-title function_">div</span>(d);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(div.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// "0.3333333333"</span>
</code></pre>
<h3 data-id="heading-4">2.3. 特殊配置 &amp; 工具 API</h3>
<h4 data-id="heading-5">2.3.1. 全局配置 API</h4>
<p>big.js 支持全局配置精度和舍入模式，核心配置项：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 设置全局精度（小数点后位数），默认 20</span>
<span class="hljs-title class_">Big</span>.<span class="hljs-property">DP</span> = <span class="hljs-number">15</span>; 

<span class="hljs-comment">// 2. 设置舍入模式，默认 ROUND_HALF_UP（四舍五入）</span>
<span class="hljs-title class_">Big</span>.<span class="hljs-property">RM</span> = <span class="hljs-title class_">Big</span>.<span class="hljs-property">roundHalfUp</span>; 

<span class="hljs-comment">// 舍入模式枚举（常用）：</span>
<span class="hljs-comment">// Big.roundUp: 向上取整</span>
<span class="hljs-comment">// Big.roundDown: 向下取整</span>
<span class="hljs-comment">// Big.roundHalfEven: 银行家舍入（四舍六入五取偶）</span>
</code></pre>
<h4 data-id="heading-6">2.3.2. 实例工具 API</h4>


















































<table><thead><tr><th>API 方法</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>toString()</code></td><td>转为字符串</td><td><code>new Big(123.45).toString()</code> → "123.45"</td></tr><tr><td><code>toFixed(dp)</code></td><td>固定小数位数</td><td><code>new Big(1.234).toFixed(2)</code> → "1.23"</td></tr><tr><td><code>toPrecision(pre)</code></td><td>固定有效数字</td><td><code>new Big(123.45).toPrecision(3)</code> → "123"</td></tr><tr><td><code>cmp(n)</code></td><td>比较大小（-1/0/1）</td><td><code>new Big(5).cmp(3)</code> → 1</td></tr><tr><td><code>abs()</code></td><td>绝对值</td><td><code>new Big(-123).abs()</code> → Big { s: 1, e: 2, c: [1,2,3] }</td></tr><tr><td><code>neg()</code></td><td>取反</td><td><code>new Big(123).neg()</code> → Big { s: -1, e: 2, c: [1,2,3] }</td></tr><tr><td><code>isZero()</code></td><td>判断是否为 0</td><td><code>new Big(0).isZero()</code> → true</td></tr><tr><td><code>isNegative()</code></td><td>判断是否为负数</td><td><code>new Big(-1).isNegative()</code> → true</td></tr></tbody></table>
<p>示例代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 配置精度和舍入模式</span>
<span class="hljs-title class_">Big</span>.<span class="hljs-property">DP</span> = <span class="hljs-number">2</span>;
<span class="hljs-title class_">Big</span>.<span class="hljs-property">RM</span> = <span class="hljs-title class_">Big</span>.<span class="hljs-property">roundUp</span>;

<span class="hljs-comment">// 向上取整的除法</span>
<span class="hljs-keyword">const</span> num = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'1'</span>).<span class="hljs-title function_">div</span>(<span class="hljs-string">'3'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// "0.34"</span>

<span class="hljs-comment">// 比较大小</span>
<span class="hljs-keyword">const</span> x = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">10</span>);
<span class="hljs-keyword">const</span> y = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">5</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x.<span class="hljs-title function_">cmp</span>(y)); <span class="hljs-comment">// 1（x &gt; y）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x.<span class="hljs-title function_">cmp</span>(x)); <span class="hljs-comment">// 0（相等）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(y.<span class="hljs-title function_">cmp</span>(x)); <span class="hljs-comment">// -1（y &lt; x）</span>
</code></pre>
<h2 data-id="heading-7">3. 源码解析</h2>
<p>big.js 解决精度问题的核心思路是：<strong>将数字转为字符串拆分存储，通过模拟手工计算的方式实现算术运算</strong>，而非依赖 JavaScript 原生的浮点数运算。</p>
<h3 data-id="heading-8">3.1. 核心数据结构</h3>
<p>Big 实例的内部存储结构（核心属性）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 以 new Big('123.456') 为例</span>
{
  <span class="hljs-attr">s</span>: <span class="hljs-number">1</span>,        <span class="hljs-comment">// 符号位：1 正数，-1 负数</span>
  <span class="hljs-attr">e</span>: <span class="hljs-number">2</span>,        <span class="hljs-comment">// 指数：小数点偏移量（整数部分的位数 - 1），123.456 的整数部分是 123（3 位），故 e = 3-1 = 2</span>
  <span class="hljs-attr">c</span>: [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>] <span class="hljs-comment">// 系数数组：存储数字的每一位（无小数点，通过 e 定位）</span>
}
</code></pre>
<ul>
<li>符号位 <code>s</code>：分离正负，避免运算时处理符号干扰；</li>
<li>指数 <code>e</code>：记录小数点位置，将小数转为“整数 + 指数”的形式；</li>
<li>系数数组 <code>c</code>：以数组存储每一位数字，彻底规避浮点数的二进制存储精度丢失。</li>
</ul>
<h3 data-id="heading-9">3.2. 核心原理：从“二进制浮点”到“十进制手工计算”</h3>
<p>JavaScript 原生精度丢失的根源是：<strong>十进制小数无法被二进制浮点数精确表示</strong>（如 0.1 的二进制是无限循环小数）。big.js 则回归“手工计算逻辑”，步骤如下：</p>
<h4 data-id="heading-10">步骤 1：初始化时的字符串解析</h4>
<p>当传入数字/字符串时，big.js 会先将其转为字符串，逐字符解析为 <code>s</code>/<code>e</code>/<code>c</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 源码核心解析逻辑（简化版）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">str</span>) {
  <span class="hljs-keyword">let</span> s = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">let</span> e = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> c = [];

  <span class="hljs-comment">// 1. 处理符号</span>
  <span class="hljs-keyword">if</span> (str[<span class="hljs-number">0</span>] === <span class="hljs-string">'-'</span>) {
    s = -<span class="hljs-number">1</span>;
    str = str.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
  }

  <span class="hljs-comment">// 2. 处理小数点</span>
  <span class="hljs-keyword">const</span> dotIndex = str.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'.'</span>);
  <span class="hljs-keyword">if</span> (dotIndex !== -<span class="hljs-number">1</span>) {
    e = dotIndex - (str.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>); <span class="hljs-comment">// 计算指数偏移</span>
    str = str.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'.'</span>, <span class="hljs-string">''</span>); <span class="hljs-comment">// 移除小数点</span>
  }

  <span class="hljs-comment">// 3. 解析每一位到系数数组</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; str.<span class="hljs-property">length</span>; i++) {
    c.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Number</span>(str[i]));
  }

  <span class="hljs-comment">// 4. 去除前导零、调整指数</span>
  <span class="hljs-comment">// ...（源码中会处理前导零、末尾零等边界情况）</span>

  <span class="hljs-keyword">return</span> { s, e, c };
}
</code></pre>
<h4 data-id="heading-11">步骤 2：算术运算的“手工模拟”</h4>
<p>以加法为例，big.js 模拟人类手工加法的“对齐小数点 → 逐位相加 → 处理进位”逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 加法核心逻辑（简化版）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-comment">// 1. 对齐小数点（统一指数 e）</span>
  <span class="hljs-keyword">let</span> [x, y] = <span class="hljs-title function_">alignExponent</span>(a, b); <span class="hljs-comment">// 对齐后，x.e === y.e</span>

  <span class="hljs-comment">// 2. 逐位相加（从后往前）</span>
  <span class="hljs-keyword">let</span> carry = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> c = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = x.<span class="hljs-property">c</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
    <span class="hljs-keyword">const</span> sum = x.<span class="hljs-property">c</span>[i] + y.<span class="hljs-property">c</span>[i] + carry;
    c.<span class="hljs-title function_">unshift</span>(sum % <span class="hljs-number">10</span>); <span class="hljs-comment">// 当前位</span>
    carry = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(sum / <span class="hljs-number">10</span>); <span class="hljs-comment">// 进位</span>
  }

  <span class="hljs-comment">// 3. 处理最后一位进位</span>
  <span class="hljs-keyword">if</span> (carry) c.<span class="hljs-title function_">unshift</span>(carry);

  <span class="hljs-comment">// 4. 构建新的 Big 实例</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>({ <span class="hljs-attr">s</span>: a.<span class="hljs-property">s</span>, <span class="hljs-attr">e</span>: x.<span class="hljs-property">e</span>, c });
}

<span class="hljs-comment">// 对齐指数的辅助函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">alignExponent</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">const</span> diff = a.<span class="hljs-property">e</span> - b.<span class="hljs-property">e</span>;
  <span class="hljs-keyword">if</span> (diff &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// a 的指数更大，给 b 的系数数组补零（相当于小数点右移）</span>
    b.<span class="hljs-property">c</span> = b.<span class="hljs-property">c</span>.<span class="hljs-title function_">concat</span>(<span class="hljs-title class_">Array</span>(diff).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));
    b.<span class="hljs-property">e</span> = a.<span class="hljs-property">e</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// b 的指数更大，给 a 的系数数组补零</span>
    a.<span class="hljs-property">c</span> = a.<span class="hljs-property">c</span>.<span class="hljs-title function_">concat</span>(<span class="hljs-title class_">Array</span>(-diff).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));
    a.<span class="hljs-property">e</span> = b.<span class="hljs-property">e</span>;
  }
  <span class="hljs-keyword">return</span> [a, b];
}
</code></pre>
<p>乘法、除法等运算的核心逻辑同理：</p>
<ul>
<li><strong>乘法</strong>：模拟“逐位相乘 → 错位相加 → 处理进位”；</li>
<li><strong>除法</strong>：模拟“试商 → 求余 → 补零继续除”，直到达到配置的精度（DP）；</li>
<li>所有运算均基于<strong>十进制数字数组</strong>，而非二进制浮点数，从根源避免精度丢失。</li>
</ul>
<h4 data-id="heading-12">步骤 3：舍入逻辑的精准控制</h4>
<p>big.js 提供多种舍入模式，核心是通过判断“舍弃位的数字”决定是否进位，例如四舍五入（ROUND_HALF_UP）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 舍入核心逻辑（简化版）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">round</span>(<span class="hljs-params">c, dp, rm</span>) {
  <span class="hljs-keyword">const</span> cutIndex = dp; <span class="hljs-comment">// 保留位数的索引</span>
  <span class="hljs-keyword">const</span> discard = c[cutIndex]; <span class="hljs-comment">// 舍弃位的数字</span>

  <span class="hljs-keyword">if</span> (rm === <span class="hljs-title class_">Big</span>.<span class="hljs-property">roundHalfUp</span>) {
    <span class="hljs-comment">// 四舍五入：舍弃位 &gt;=5 则进位</span>
    <span class="hljs-keyword">if</span> (discard &gt;= <span class="hljs-number">5</span>) {
      <span class="hljs-title function_">carry</span>(c, cutIndex - <span class="hljs-number">1</span>); <span class="hljs-comment">// 向前一位进位</span>
    }
    c.<span class="hljs-title function_">splice</span>(cutIndex); <span class="hljs-comment">// 截断舍弃位</span>
  }
  <span class="hljs-keyword">return</span> c;
}
</code></pre>
<h3 data-id="heading-13">3.3. 源码核心亮点</h3>
<ol>
<li><strong>不可变设计</strong>：所有运算返回新实例，原实例不修改，避免副作用；</li>
<li><strong>最小化计算</strong>：仅处理必要的数字位，去除前导零、末尾零，提升性能；</li>
<li><strong>可配置化</strong>：通过 DP（精度）、RM（舍入模式）适配不同业务场景；</li>
<li><strong>轻量无依赖</strong>：核心代码仅千行左右，无外部依赖，易于集成。</li>
</ol>
<h2 data-id="heading-14">4. 适用场景 &amp; 注意事项</h2>
<h3 data-id="heading-15">适用场景</h3>
<ul>
<li>金融计算（金额、税率、利息）；</li>
<li>电商价格计算（优惠券、折扣、满减）；</li>
<li>高精度数据展示（科学计算、统计报表）。</li>
</ul>
<h3 data-id="heading-16">注意事项</h3>
<ol>
<li>初始化优先使用<strong>字符串</strong>，避免数字入参提前丢失精度；</li>
<li>避免频繁创建 Big 实例，可复用实例提升性能；</li>
<li>与原生 Number 互转时，需通过 <code>toString()</code> 或 <code>toNumber()</code> 方法，避免直接强制转换；</li>
<li>big.js 仅处理十进制大数，如需处理大整数（如 ID、雪花算法），可选择 <code>bigint</code> 或 <code>bn.js</code>。</li>
</ol>
<h2 data-id="heading-17">5. 总结</h2>
<p>big.js 作为前端大数精度处理的经典库，核心价值在于：</p>
<ol>
<li>以<strong>字符串解析 + 十进制数组存储</strong>的方式，规避了 JavaScript 浮点数的二进制存储缺陷；</li>
<li>通过<strong>模拟手工计算</strong>的算术逻辑，实现高精度的加减乘除等运算；</li>
<li>提供简洁的 API 和可配置项，适配不同业务场景的精度需求。</li>
</ol>
<p>在处理前端数字精度问题时，big.js 以轻量、易用、可靠的特性，成为开发者的首选方案。理解其 API 用法和源码原理，不仅能解决实际业务问题，也能深入理解 JavaScript 数字存储的底层逻辑。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7568192652286754870" target="_blank" title="https://juejin.cn/post/7568192652286754870">纯前端提取图片颜色插件Color-Thief教学+实战完整指南</a></li>
<li><a href="https://juejin.cn/post/7565737512816771135" target="_blank" title="https://juejin.cn/post/7565737512816771135">react-konva实战指南：Canvas高性能+易维护的组件化图形开发实现教程</a></li>
<li><a href="https://juejin.cn/post/7560905838074462271" target="_blank" title="https://juejin.cn/post/7560905838074462271">React无限滚动插件react-infinite-scroll-component的配置+优化+避坑指南</a></li>
<li><a href="https://juejin.cn/post/7560542615484137491" target="_blank" title="https://juejin.cn/post/7560542615484137491">前端音频兼容解决：音频神器howler.js从基础到进阶完整使用指南</a></li>
<li><a href="https://juejin.cn/post/7559871680015024169" target="_blank" title="https://juejin.cn/post/7559871680015024169">使用React-OAuth进行Google/GitHub登录的教程和案例</a></li>
<li><a href="https://juejin.cn/post/7550585427834404927" target="_blank" title="https://juejin.cn/post/7550585427834404927">纯前端人脸识别利器：face-api.js手把手深入解析教学</a></li>
<li><a href="https://juejin.cn/post/7553865490732433462" target="_blank" title="https://juejin.cn/post/7553865490732433462">关于React父组件调用子组件方法forwardRef的详解和案例</a></li>
<li><a href="https://juejin.cn/post/7553484874609410074" target="_blank" title="https://juejin.cn/post/7553484874609410074">React跨组件数据共享useContext详解和案例</a></li>
<li><a href="https://juejin.cn/post/7545087762837815334" target="_blank" title="https://juejin.cn/post/7545087762837815334">Web图像编辑神器tui.image-editor从基础到进阶的实战指南</a></li>
<li><a href="https://juejin.cn/post/7544323659788288046" target="_blank" title="https://juejin.cn/post/7544323659788288046">开发个人微信小程序类目选择/盈利方式/成本控制与服务器接入指南</a></li>
<li><a href="https://juejin.cn/post/7541741121400864778" target="_blank" title="https://juejin.cn/post/7541741121400864778">前端图片裁剪Cropper.js核心功能与实战技巧详解</a></li>
<li><a href="https://juejin.cn/post/7536530451461472265" target="_blank" title="https://juejin.cn/post/7536530451461472265">编辑器也有邪修？盘点VS Code邪门/有趣的扩展</a></li>
<li><a href="https://juejin.cn/post/7535005018257981466" target="_blank" title="https://juejin.cn/post/7535005018257981466">js使用IntersectionObserver实现目标元素可见度的交互</a></li>
<li><a href="https://juejin.cn/post/7534547200330121225" target="_blank" title="https://juejin.cn/post/7534547200330121225">Web前端页面开发阿拉伯语种适配指南</a></li>
<li><a href="https://juejin.cn/post/7516122409948020736" target="_blank" title="https://juejin.cn/post/7516122409948020736">让网页拥有App体验？PWA 将网页变为桌面应用的保姆级教程PWA</a></li>
<li><a href="https://juejin.cn/post/6953803916484018206" target="_blank" title="https://juejin.cn/post/6953803916484018206">使用nvm管理node.js版本以及更换npm淘宝镜像源</a></li>
<li><a href="https://juejin.cn/post/7140443283209060383" target="_blank" title="https://juejin.cn/post/7140443283209060383">手把手教你搭建规范的团队vue项目，包含commitlint，eslint，prettier，husky，commitizen等等</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第十五章(Image)]]></title>    <link>https://juejin.cn/post/7585897699602923546</link>    <guid>https://juejin.cn/post/7585897699602923546</guid>    <pubDate>2025-12-22T02:17:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699602923546" data-draft-id="7585808181239873587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第十五章(Image)"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-12-22T02:17:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第十五章(Image)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:17:09.000Z" title="Mon Dec 22 2025 02:17:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Image组件</h2>
<p>该组件是Next.js内置的图片组件，是基于原生<code>img</code>标签进行扩展，并不代表原生<code>img</code>标签不能使用。</p>
<ul>
<li>尺寸优化：支持使用现代化图片格式，如<code>webp</code>，<code>avif</code>，<code>apng</code>等,并自动根据设备提供正确的尺寸。</li>
<li>视觉稳定性：防止图片加载时发生布局偏移，具体参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Farticles%2Fcls%3Fhl%3Dzh-cn" target="_blank" title="https://web.dev/articles/cls?hl=zh-cn" ref="nofollow noopener noreferrer">CLS</a></li>
<li>懒加载：在图片进入视口才会加载，使用浏览器原生懒加载，并可选择添加模糊显示占位符。</li>
<li>灵活性：可按需调整图像大小，即使是存储在远程服务器上的图像也可以调整。</li>
</ul>
<h4 data-id="heading-1">图片引入</h4>
<h5 data-id="heading-2">1. src本地图片引入</h5>
<p>Next.js建议我们把图片放在根目录下的<code>public</code>文件夹中，然后使用<code>/</code>开头访问。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a73a9cf6e7c4be8b3f3b61e531a778f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974628&amp;x-signature=GFjfFcsoNvoSwKUNnkb9VH%2F68kc%3D" alt="public.png" loading="lazy"/></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                <span class="hljs-attr">src</span>=<span class="hljs-string">"/1.png"</span>
                <span class="hljs-attr">width</span>=<span class="hljs-string">{100}</span>
                <span class="hljs-attr">height</span>=<span class="hljs-string">{100}</span>
                <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
            /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-3">2. import静态引入</h5>
<p>使用<code>import</code>引入图片，是不需要填写宽度和高度，Next.js会自动确定图片的尺寸。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"@/public/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./public/*"</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 新增这一行代码，配置图片路径。</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>使用静态<code>import</code>引入图片，你会发现无需填写宽度和高度，Next.js会自动确定图片的尺寸。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">import</span> test <span class="hljs-keyword">from</span> <span class="hljs-string">'@/public/1.png'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                <span class="hljs-attr">src</span>=<span class="hljs-string">{test}</span>
                <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
            /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-4">3. 远程图片引入</h5>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>;
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>当我们直接使用远程图片引入的时候Next.js会报错，因为Next.js默认只允许加载本地图片，如果需要加载远程图片，需要配置<code>next.config.js</code>文件。</p>
<p>image-loader.ts:86 Uncaught Error: Invalid src prop (<a href="https://link.juejin.cn?target=https%3A%2F%2Feo-img.521799.xyz%2Fi%2Fpc%2Fimg1.webp" target="_blank" title="https://eo-img.521799.xyz/i/pc/img1.webp" ref="nofollow noopener noreferrer">eo-img.521799.xyz/i/pc/img1.w…</a>) on <code>next/image</code>, hostname "eo-img.521799.xyz" is not configured under images in your <code>next.config.js</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">remotePatterns</span>: [
      {
        <span class="hljs-attr">protocol</span>: <span class="hljs-string">'https'</span>, <span class="hljs-comment">// 协议</span>
        <span class="hljs-attr">hostname</span>: <span class="hljs-string">'eo-img.521799.xyz'</span>, <span class="hljs-comment">// 主机名</span>
        <span class="hljs-attr">pathname</span>: <span class="hljs-string">'/i/pc/**'</span>, <span class="hljs-comment">// 路径</span>
        <span class="hljs-attr">port</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// 端口</span>
      },
    ],
  },
};
</code></pre>
<h5 data-id="heading-5">4. LCP警告</h5>
<p>如果图片是首屏或者LCP图片，需要添加<code>loading="eager"</code>属性，否则会触发LCP警告,因为Image组件默认是懒加载的。</p>
<ul>
<li>lazy: 懒加载，默认值，在图片进入视口才会加载。</li>
<li>eager: 立即加载，在图片进入视口就会加载。</li>
</ul>
<p>Image with src "<a href="https://link.juejin.cn?target=https%3A%2F%2Feo-img.521799.xyz%2Fi%2Fpc%2Fimg1.webp" target="_blank" title="https://eo-img.521799.xyz/i/pc/img1.webp" ref="nofollow noopener noreferrer">eo-img.521799.xyz/i/pc/img1.w…</a>" was detected as the Largest Contentful Paint (LCP). Please add the <code>loading="eager"</code> property if this image is above the fold.
Read more: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fapi-reference%2Fcomponents%2Fimage%23loading" target="_blank" title="https://nextjs.org/docs/app/api-reference/components/image#loading" ref="nofollow noopener noreferrer">nextjs.org/docs/app/ap…</a></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                    <span class="hljs-attr">loading</span>=<span class="hljs-string">"eager"</span> // <span class="hljs-attr">立即加载</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>第二种解决方案使用<code>preload</code>属性加载图片，表示提前预加载图片，不过Next.js还是更加推荐使用<code>loading="eager"</code>属性加载图片。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                    <span class="hljs-attr">preload</span>=<span class="hljs-string">{index</span> &lt; <span class="hljs-attr">10</span>} // <span class="hljs-attr">优先加载策略</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-6">5. 图片格式优化</h5>
<p>Next.js 会通过请求Accept头自动检测浏览器支持的图像格式，以确定最佳输出格式</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title class_">Accept</span>:image/avif,image/webp,image/apng,image/svg+xml,image<span class="hljs-comment">/*,*/</span>*;q=<span class="hljs-number">0.8</span>
</code></pre>
<p>我们可以同时启用 AVIF 和 WebP 格式。对于支持 AVIF 的浏览器，系统将优先使用 AVIF 格式，WebP 格式作为备选方案。目前AVIF格式最优。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">formats</span>: [<span class="hljs-string">'image/avif'</span>, <span class="hljs-string">'image/webp'</span>], <span class="hljs-comment">//默认是 ['image/webp']</span>
  },
};
</code></pre>
<h5 data-id="heading-7">6. 设备适配</h5>
<p>如果你的老板告诉你要兼容哪些设备，你可以使用<code>deviceSizes</code>和<code>imageSizes</code>属性来配置。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">deviceSizes</span>: [<span class="hljs-number">640</span>, <span class="hljs-number">750</span>, <span class="hljs-number">828</span>, <span class="hljs-number">1080</span>, <span class="hljs-number">1200</span>, <span class="hljs-number">1920</span>, <span class="hljs-number">2048</span>, <span class="hljs-number">3840</span>], <span class="hljs-comment">// 设备尺寸</span>
    <span class="hljs-attr">imageSizes</span>: [<span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">48</span>, <span class="hljs-number">64</span>, <span class="hljs-number">96</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>, <span class="hljs-number">384</span>], <span class="hljs-comment">// 图片尺寸</span>
  },
};
</code></pre>
<p>这两个属性结合会最终生成一个<code>srcset</code>属性，用于浏览器选择最佳图片。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bed6fc34c0a414484df71bcf1dbe922~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974628&amp;x-signature=vOdeCraZzznSMXE%2FFPdALioNi2Y%3D" alt="srcset.png" loading="lazy"/></p>
<p>那为什么需要两个数组去实现呢？</p>
<p>我们观察上图可以发现，<code>imageSizes</code>用于生成小图片尺寸例如(缩略图，头像等)，而<code>deviceSizes</code>用于生成大图片尺寸例如(横幅图、背景图、全屏展示图)。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>

<span class="hljs-comment">// 头像 - 固定 64px</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Avatar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/avatar.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{64}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{64}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"用户头像"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"64px"</span>  // ← <span class="hljs-attr">告诉浏览器这张图只需要</span> <span class="hljs-attr">64px</span>
    /&gt;</span></span>
  )
}

<span class="hljs-comment">// 横幅图 - 响应式全宽</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Banner</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/banner.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{1920}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{600}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"横幅"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"100vw"</span>  // ← <span class="hljs-attr">占满整个视口宽度</span>，<span class="hljs-attr">使用</span> <span class="hljs-attr">deviceSizes</span>
    /&gt;</span></span>
  )
}

<span class="hljs-comment">// 响应式内容图</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ContentImage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/content.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{1200}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{800}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"内容图"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 1200px"</span>
      // ↑ <span class="hljs-attr">手机上</span> <span class="hljs-attr">100</span>% <span class="hljs-attr">宽度</span>，<span class="hljs-attr">平板上</span> <span class="hljs-attr">50</span>%，<span class="hljs-attr">桌面最大</span> <span class="hljs-attr">1200px</span>
    /&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-8">Props</h4>
<p>以下是 Image 组件可用的属性：</p>
<h5 data-id="heading-9">必需属性</h5>























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>src</td><td>String</td><td><code>src="/profile.png"</code></td><td>图片源路径，支持本地路径或远程 URL</td></tr><tr><td>alt</td><td>String</td><td><code>alt="Picture of the author"</code></td><td>图片替代文本，用于无障碍访问和 SEO</td></tr></tbody></table>
<h5 data-id="heading-10">尺寸相关</h5>



































<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>width</td><td>Integer (px)</td><td><code>width={500}</code></td><td>图片宽度，静态导入时可选</td></tr><tr><td>height</td><td>Integer (px)</td><td><code>height={500}</code></td><td>图片高度，静态导入时可选</td></tr><tr><td>fill</td><td>Boolean</td><td><code>fill={true}</code></td><td>填充父容器，替代 width 和 height</td></tr><tr><td>sizes</td><td>String</td><td><code>sizes="(max-width: 768px) 100vw"</code></td><td>响应式图片尺寸</td></tr></tbody></table>
<h5 data-id="heading-11">优化相关</h5>





























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>quality</td><td>Integer (1-100)</td><td><code>quality={80}</code></td><td>图片压缩质量，默认为 75</td></tr><tr><td>loader</td><td>Function</td><td><code>loader={imageLoader}</code></td><td>自定义图片加载器函数</td></tr><tr><td>unoptimized</td><td>Boolean</td><td><code>unoptimized={true}</code></td><td>禁用图片优化，使用原图</td></tr></tbody></table>
<h5 data-id="heading-12">加载相关</h5>



































<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>loading</td><td>String</td><td><code>loading="lazy"</code></td><td>加载策略，"lazy" 或 "eager"</td></tr><tr><td>preload</td><td>Boolean</td><td><code>preload={true}</code></td><td>是否预加载，用于 LCP 元素</td></tr><tr><td>placeholder</td><td>String</td><td><code>placeholder="blur"</code></td><td>占位符类型，"blur" 或 "empty"</td></tr><tr><td>blurDataURL</td><td>String</td><td><code>blurDataURL="data:image/jpeg..."</code></td><td>模糊占位符的 Data URL</td></tr></tbody></table>
<h5 data-id="heading-13">事件回调</h5>























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>onLoad</td><td>Function</td><td><code>onLoad={e =&gt; done()}</code></td><td>图片加载完成时的回调</td></tr><tr><td>onError</td><td>Function</td><td><code>onError={e =&gt; fail()}</code></td><td>图片加载失败时的回调</td></tr></tbody></table>
<h5 data-id="heading-14">其他属性</h5>





























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>style</td><td>Object</td><td><code>style={{objectFit: "contain"}}</code></td><td>内联样式对象</td></tr><tr><td>overrideSrc</td><td>String</td><td><code>overrideSrc="/seo.png"</code></td><td>覆盖 src，用于 SEO 优化</td></tr><tr><td>decoding</td><td>String</td><td><code>decoding="async"</code></td><td>解码方式，"async"/"sync"/"auto"</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java大厂面试：携程三轮面试]]></title>    <link>https://juejin.cn/post/7586851351469228072</link>    <guid>https://juejin.cn/post/7586851351469228072</guid>    <pubDate>2025-12-23T09:01:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586851351469228072" data-draft-id="7586851351469129768" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java大厂面试：携程三轮面试"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T09:01:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java大厂面试：携程三轮面试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:01:11.000Z" title="Tue Dec 23 2025 09:01:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0592d87bad8449d887213d18f83b0b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTmqZjlrZDnmq4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767085270&amp;x-signature=DiaBpgIvZ0ijdD89UHOZHqhmvsk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-0"><strong>一、携程一面</strong>​</h3>
<h4 data-id="heading-1">1. 项目，解决问题，优化方案</h4>
<p><strong>回答思路</strong>：围绕“业务价值+技术问题+落地手段”展开，突出<strong>问题分析→方案选型→效果验证</strong>的闭环。</p>
<ul>
<li>
<p>示例（以电商订单系统为例）：</p>
<ul>
<li>
<p>业务背景：订单量峰值10万+/日，并发下库存超卖、接口响应超时（平均2s+）。</p>
</li>
<li>
<p>核心问题：高并发库存一致性、接口性能瓶颈。</p>
</li>
<li>
<p>优化方案：</p>
<ul>
<li>库存防超卖：Redis预减库存（秒杀场景）+ MySQL最终扣减（事务保证），结合乐观锁（<code>version</code>字段）防止并发冲突；</li>
<li>接口性能：分库分表（订单表按用户ID哈希拆分）、SQL索引优化（覆盖索引减少回表）、异步化（非核心流程如短信通知走MQ）；</li>
<li>效果：库存超卖率从5%降至0，核心接口响应时间优化至200ms内。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-2">2. Redis分布式锁（很多问题）</h4>
<p><strong>核心考点</strong>：分布式锁的原理、常见问题（锁超时、误删、集群脑裂）及解决方案。</p>
<ul>
<li>
<p>原理：利用Redis的<code>SET key value NX PX timeout</code>原子性命令，实现多进程/服务的互斥访问。</p>
</li>
<li>
<p>常见问题与解决方案：</p>
<ul>
<li><strong>锁超时</strong>（业务未执行完，锁过期）：Redisson的<strong>Watchdog机制</strong>（自动续期，默认30s内每10s续一次）；</li>
<li><strong>锁误删</strong>（其他线程删除自己的锁）：给锁加<strong>唯一标识（UUID）</strong> ，删除前校验<code>value</code>是否为自身生成的UUID；</li>
<li><strong>集群脑裂</strong>（主从切换导致锁失效）：采用<strong>Redlock算法</strong>（多主节点投票，需至少N/2+1节点成功），但需权衡性能（一般中小厂用单主+重试兜底）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">3. 算法：最大子数组和</h4>
<p><strong>考点</strong>：动态规划（Kadane算法），考察代码简洁性与时间复杂度优化。</p>
<ul>
<li>
<p>思路：遍历数组，维护<code>currentSum</code>（当前子数组和）和<code>maxSum</code>（全局最大和）。若<code>currentSum &lt; 0</code>，则重置为当前元素（负数累加无意义）；否则继续累加。</p>
</li>
<li>
<p>代码示例：</p>
<pre><code class="hljs language-ini" lang="ini">public int maxSubArray(int<span class="hljs-section">[]</span> nums) {
    int <span class="hljs-attr">max</span> = nums[<span class="hljs-number">0</span>], current = nums[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">1</span><span class="hljs-comment">; i &lt; nums.length; i++) {</span>
        <span class="hljs-attr">current</span> = Math.max(current + nums[i], nums[i])<span class="hljs-comment">;</span>
        <span class="hljs-attr">max</span> = Math.max(max, current)<span class="hljs-comment">;</span>
    }
    return max<span class="hljs-comment">;</span>
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-4"><strong>二、携程二面</strong>​</h3>
<h4 data-id="heading-5">1. 自我介绍以及项目难点，自己参与度高的案例</h4>
<p><strong>回答模板</strong>：</p>
<blockquote>
<p>【自我介绍】我是XX，专注后端开发X年，擅长分布式/高并发领域，主导过XX项目（如亿级流量秒杀系统）。</p>
<p>【项目难点】在XX项目中，需解决<strong>高并发库存超卖+接口性能</strong>问题。原有方案是DB悲观锁，导致TPS仅50，超卖率10%。</p>
<p>【参与度】主导技术方案：① 引入Redis预减库存（原子操作）+ MySQL乐观锁（<code>version</code>校验）保证一致性；② 分库分表（订单表按用户ID哈希）拆分单表压力；③ 非核心流程异步化（MQ解耦）。上线后TPS提升至2000+，超卖率0，接口耗时从2s→200ms。</p>
</blockquote>
<h4 data-id="heading-6">2. 大批量数据导出文件如何优化？</h4>
<p><strong>核心思路</strong>：<strong>异步+分治+流式IO+压缩</strong>，避免内存溢出与请求超时。</p>
<ul>
<li>
<p>步骤：</p>
<ol>
<li><strong>异步触发</strong>：前端发起导出请求，后端写入MQ，立即返回“任务创建中”，前端轮询/WS查询状态；</li>
<li><strong>分批查询</strong>：DB分页（<code>LIMIT offset, size</code>），避免全量数据加载到内存；</li>
<li><strong>流式写入</strong>：用POI的<code>SXSSFWorkbook</code>（流式Excel，仅保留内存中指定行数）或<code>EasyExcel</code>（基于事件模型）写文件；CSV直接通过<code>FileOutputStream</code>逐行输出；</li>
<li><strong>压缩打包</strong>：导出完成后，用ZIP压缩（减少传输体积），支持断点续传；</li>
<li><strong>异常重试</strong>：MQ消费失败时，重试+死信队列兜底，保证数据不丢失。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-7">3. 分布式事务相关（本地消息表 + 消息队列）</h4>
<p><strong>考点</strong>：可靠消息最终一致性方案，考察落地细节（异常处理、幂等）。</p>
<ul>
<li>
<p>流程：</p>
<ol>
<li><strong>本地事务</strong>：业务操作（如扣库存）与<strong>插入本地消息表</strong>（记录消息状态<code>待发送</code>）在同一DB事务中完成；</li>
<li><strong>消息投递</strong>：定时任务扫描本地消息表，将<code>待发送</code>消息发往MQ，成功后更新消息状态为<code>已发送</code>；</li>
<li><strong>消费端处理</strong>：消费者订阅MQ，执行业务逻辑（如创建订单），成功后回调通知生产者更新消息状态为<code>已完成</code>；</li>
</ol>
</li>
<li>
<p>异常处理：</p>
<ul>
<li>消息发送失败：定时任务重试（需保证幂等，如消息ID去重）；</li>
<li>消费失败：MQ重试（设置重试次数）+ 死信队列人工介入；</li>
<li>补偿机制：定时对账（如检查DB与MQ消息状态一致性）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-8">4. 设计模式优化代码</h4>
<p><strong>回答策略</strong>：结合场景讲设计模式，突出<strong>解耦、扩展性、可读性</strong>。</p>
<ul>
<li>
<p>示例（以促销活动为例）：</p>
<ul>
<li>问题：原代码用<code>if-else</code>区分满减、折扣、赠品，新增活动需修改主逻辑，维护性差。</li>
<li>方案：<strong>策略模式</strong>。定义<code>PromotionStrategy</code>接口（<code>calculate()</code>方法），实现类<code>ManjianStrategy</code>（满减）、<code>ZhekouStrategy</code>（折扣）等。上下文类<code>PromotionContext</code>持有策略引用，运行时根据活动类型切换策略。</li>
<li>效果：新增活动只需加实现类，无需修改原有代码；逻辑分散到各策略类，可读性提升。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">5. 面试官发来一段代码，讲讲有没有可以改进的地方</h4>
<p><strong>通用思路</strong>：从<strong>可读性、性能、健壮性、设计原则</strong>四维度切入。</p>
<ul>
<li>
<p>示例（假设代码是“统计用户订单数”）：</p>
<ul>
<li>命名：变量<code>a</code>→<code>userOrderCount</code>，方法<code>count()</code>→<code>statUserOrderNum()</code>；</li>
<li>性能：循环内重复查询DB→批量查询+缓存；字符串拼接用<code>StringBuilder</code>；</li>
<li>健壮性：参数为空判断（如<code>userId == null</code>抛异常）、try-catch细化（不笼统<code>catch Exception</code>）；</li>
<li>设计：若有多类统计（订单、退款、积分），提取<code>StatsService</code>抽象类，实现类继承（开闭原则）；</li>
<li>并发：若统计全局数据，<code>AtomicLong</code>代替<code>long</code>，或Redis原子计数。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10"><strong>三、携程三面（资深/Leader面）</strong> ​</h3>
<h4 data-id="heading-11">1. 自我介绍以及项目</h4>
<p><strong>重点</strong>：突出<strong>技术深度、架构设计、业务影响力</strong>。</p>
<ul>
<li>
<p>示例：</p>
<blockquote>
<p>我是XX，负责电商中台交易域，主导过“亿级订单履约系统”从0到1建设。核心挑战是<strong>高并发订单创建+分布式事务+全链路监控</strong>。</p>
<p>技术亮点：采用Spring Cloud Alibaba微服务架构，订单服务+库存+支付+物流解耦；Redis预减库存+MySQL乐观锁防超卖；Canal订阅Binlog异步更新缓存；Prometheus+Grafana监控QPS/响应时间/错误率。</p>
<p>成果：支撑双11峰值10万订单/分钟，系统可用性99.99%。</p>
</blockquote>
</li>
</ul>
<h4 data-id="heading-12">2. 用的啥技术栈？</h4>
<p><strong>分层梳理</strong>：后端→中间件→前端→工具链。</p>
<ul>
<li>后端：Spring Boot/Spring Cloud（Nacos注册中心、Sentinel限流）、MyBatis-Plus（ORM）、Redis（缓存/分布式锁）、RocketMQ（异步/解耦）、MySQL（分库分表）；</li>
<li>中间件：Elasticsearch（搜索）、MinIO（文件存储）、SkyWalking（链路追踪）；</li>
<li>前端：Vue3 + Element Plus（若有前端协同）；</li>
<li>工具链：Git（代码管理）、Maven（依赖）、Docker（容器化）、K8s（集群部署）、Jenkins（CI/CD）。</li>
</ul>
<h4 data-id="heading-13">3. 引入这些中间件带来的优化是什么？</h4>
<p><strong>按中间件分类，讲核心价值</strong>：</p>
<ul>
<li>Redis：缓存热点数据（如首页推荐、用户会话），降低DB QPS 80%；分布式锁保证并发场景下的库存/订单一致性；</li>
<li>RocketMQ：削峰填谷（如秒杀订单异步处理，下游服务按吞吐量消费）；解耦系统（订单创建后发消息，物流/积分系统订阅，新增系统无需修改订单逻辑）；</li>
<li>MySQL：分库分表（订单表按用户ID哈希，单表数据从千万级→百万级）；读写分离（主库写，从库读，降低主库压力30%）；</li>
<li>Elasticsearch：复杂查询（如商品多条件搜索）响应时间从2s→200ms；支持分词、聚合（如销量统计）；</li>
<li>监控系统（Prometheus+Grafana）：实时感知系统瓶颈（如某接口响应突增），5分钟内定位故障（如Redis连接池耗尽）。</li>
</ul>
<h4 data-id="heading-14">4. 项目的运转/数据流程</h4>
<p><strong>以“用户下单→履约”为例，梳理全链路</strong>：</p>
<ol>
<li>用户提交订单→网关（鉴权/限流）→订单服务（创建订单，Redis预减库存→锁定库存）；</li>
<li>订单服务调用库存服务（MySQL最终扣减库存，失败则回滚Redis）；</li>
<li>订单服务发送MQ（订单创建事件）→物流服务创建运单、积分服务增加积分；</li>
<li>支付服务回调订单服务（标记订单已支付）→订单服务发MQ通知物流履约；</li>
<li>全链路数据流向：DB（订单、库存）→Redis（库存缓存、分布式锁）→MQ（事件驱动）→ES（订单搜索）。</li>
</ol>
<h4 data-id="heading-15">5. 消息队列应用</h4>
<p><strong>场景+落地+避坑</strong>：</p>
<ul>
<li>
<p>场景：解耦（订单与物流系统）、异步（短信/积分通知）、削峰（秒杀流量缓冲）；</p>
</li>
<li>
<p>落地：Spring Cloud Stream封装生产者/消费者，注解<code>@SendTo</code>发消息，<code>@StreamListener</code>消费；</p>
</li>
<li>
<p>避坑：</p>
<ul>
<li>幂等性：消息携带唯一ID（如订单号），消费前查Redis去重；</li>
<li>顺序性：RocketMQ的MessageQueue选择器，保证同一订单消息发往同一队列；</li>
<li>重试机制：消费失败后，MQ自动重试3次，仍失败则发往死信队列。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-16">6. MySQL慢查询如何优化？</h4>
<p><strong>五步法</strong>：定位→分析→索引→SQL→架构。</p>
<ol>
<li><strong>定位慢SQL</strong>：开启慢查询日志（<code>slow_query_log=ON</code>，<code>long_query_time=1</code>），抓取执行时间&gt;1s的SQL；</li>
<li><strong>分析执行计划</strong>：<code>EXPLAIN</code>看<code>type</code>（是否全表扫）、<code>key</code>（是否命中索引）、<code>rows</code>（扫描行数）；</li>
<li><strong>优化索引</strong>：添加联合索引（遵循最左匹配）、覆盖索引（查询字段全在索引中，避免回表）；</li>
<li><strong>SQL改写</strong>：避免<code>SELECT *</code>、减少JOIN表数、分页优化（大数据量用延迟关联，如<code>SELECT t1.* FROM t1 JOIN (SELECT id FROM t1 LIMIT 100000, 10) t2 ON t1.id=t2.id</code>）；</li>
<li><strong>架构兜底</strong>：读写分离（MyCat/ShardingSphere）、分库分表（ShardingSphere）。</li>
</ol>
<h4 data-id="heading-17">7. Redis的应用</h4>
<p><strong>高频场景+代码示例</strong>：</p>
<ul>
<li>缓存：热点数据（如商品详情）缓存，设置过期时间（<code>EXPIRE key 3600</code>）+ 淘汰策略（LRU）；</li>
<li>分布式锁：Redisson的<code>RLock</code>（<code>lock.lock(leaseTime, unit)</code>自动续期）；</li>
<li>计数器：点赞数（<code>INCR post:100:like</code>），原子性保证数据一致；</li>
<li>限流：令牌桶算法（Redis + Lua脚本，每秒生成10个令牌，请求时<code>DECR token</code>，值为负则拒绝）；</li>
<li>延迟队列：ZSET实现（<code>score</code>为执行时间戳，定时任务扫<code>ZRANGEBYSCORE</code>获取到期任务）。</li>
</ul>
<h4 data-id="heading-18">8. 缓存/DB 一致性如何保证？</h4>
<p><strong>核心方案</strong>：Cache-Aside + 重试兜底，接受“最终一致”。</p>
<ul>
<li>更新逻辑：先更DB，再删缓存（避免“先删缓存→更DB失败→读DB旧数据”）；</li>
<li>异常处理：删缓存失败时，发MQ到重试队列，消费端循环删缓存（需限制重试次数，避免死循环）；</li>
<li>补充：订阅Binlog（如Canal），异步更新缓存（适合读多写少场景，保证最终一致）。</li>
</ul>
<h4 data-id="heading-19">9. 设计一下 用Redis做社交软件点赞；Redis集群下的数据排序</h4>
<p><strong>点赞设计</strong>：</p>
<ul>
<li>
<p>数据结构：</p>
<ul>
<li>点赞关系：<code>Set&lt;user:like:{postId}&gt;</code>存储点赞用户ID（去重）；</li>
<li>点赞数：<code>String&lt;like:count:{postId}&gt;</code>记录总数（<code>INCR/DECR</code>原子操作）；</li>
</ul>
</li>
<li>
<p>功能：点赞（<code>SADD + INCR</code>）、取消点赞（<code>SREM + DECR</code>）、查询是否点赞（<code>SISMEMBER</code>）、获取点赞列表（<code>SMEMBERS</code>）、点赞数（<code>GET</code>）。</p>
</li>
</ul>
<p><strong>集群下的数据排序</strong>（如按点赞数排热门帖）：</p>
<ul>
<li>
<p>问题：Redis集群分片（CRC16算法），不同Key可能在不同Slot，无法跨Slot排序；</p>
</li>
<li>
<p>方案：</p>
<ol>
<li><strong>哈希标签</strong>：Key设计为<code>{hot}:post:{postId}</code>，<code>{hot}</code>作为哈希标签，强制同一Tag的Key在同一Slot；</li>
<li><strong>本地聚合+定时同步</strong>：每个节点维护本地TopN列表，定时（如每小时）汇总到中心节点生成全局TopN；</li>
<li><strong>异步计算</strong>：点赞事件发MQ，后台服务消费后维护全局ZSET（<code>ZADD hot_posts 100 postId</code>），定期更新排序。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-20">10. 项目的开发测试流程</h4>
<p><strong>敏捷+DevOps闭环</strong>：</p>
<ul>
<li>需求阶段：产品PRD评审，技术团队拆分用户故事，评估工时；</li>
<li>开发阶段：分支管理（Feature分支）、Code Review（SonarLint代码扫描）、单元测试（JUnit+Mockito）；</li>
<li>测试阶段：测试环境Docker化部署（Compose），QA执行功能测试（Postman）、性能测试（JMeter）、安全测试（OWASP ZAP）；</li>
<li>发布阶段：灰度发布（Nginx权重路由，5%流量试点），监控告警（Prometheus+Alertmanager），无问题则全量发布（K8s滚动更新）；</li>
<li>迭代阶段：收集用户反馈，复盘技术债务，规划下一迭代。</li>
</ul>
<p>以上答案结合<strong>技术深度+实战场景+架构思维</strong>，既覆盖知识点，又体现解决问题的能力，适合大厂面试应答~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ollmam+langchain.js实现本地大模型简单记忆对话-PostgreSQL版]]></title>    <link>https://juejin.cn/post/7586597780641415178</link>    <guid>https://juejin.cn/post/7586597780641415178</guid>    <pubDate>2025-12-23T06:24:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586597780641415178" data-draft-id="7586657335880957979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ollmam+langchain.js实现本地大模型简单记忆对话-PostgreSQL版"/> <meta itemprop="keywords" content="前端,AIGC,LangChain"/> <meta itemprop="datePublished" content="2025-12-23T06:24:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="樊小肆"/> <meta itemprop="url" content="https://juejin.cn/user/1257497033719320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ollmam+langchain.js实现本地大模型简单记忆对话-PostgreSQL版
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497033719320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    樊小肆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:24:22.000Z" title="Tue Dec 23 2025 06:24:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文基于之前的本地大模型对话Demo进行优化，重点介绍如何将内存存储升级为PostgreSQL持久化存储，并增强对话安全性与检索准确性。仍需在Node.js 18+环境下运行，核心依赖工具（Ollama、PostgreSQL）的安装请参考官方文档。</p>
<h3 data-id="heading-1">为何升级为PostgreSQL存储？</h3>
<p>内存存储虽适合快速原型验证，但存在重启后数据丢失的问题，无法满足实际应用场景。PostgreSQL作为成熟的关系型数据库，不仅能持久化存储对话记录，配合pgvector插件还能高效管理向量数据，为生产环境提供可靠支撑。</p>
<h2 data-id="heading-2">代码实现：从内存存储到PostgreSQL持久化</h2>
<h3 data-id="heading-3">1. 数据库配置与实例初始化</h3>
<p>修改内容：新增PostgreSQL配置，替代原内存存储的sessionStores设计</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 替代原内存存储的全局配置</span>
<span class="hljs-type">const</span> pgConfig = {
    host: <span class="hljs-string">"127.0.0.1"</span>,
    port: <span class="hljs-number">5432</span>,
    user: <span class="hljs-string">"fanxiaosi"</span>,
    password: <span class="hljs-string">"f15130026310."</span>,
    database: <span class="hljs-string">"One-AI-DB"</span>,
};
</code></pre>
<p>修改原因：内存存储无法持久化数据，服务重启后对话历史会丢失。</p>
<p>改进好处：使用PostgreSQL实现对话记录的永久存储，支持多实例共享数据，为分布式部署奠定基础。</p>
<h3 data-id="heading-4">2. 语言模型配置优化</h3>
<p>修改内容：在原有基础上增加防复读配置</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ChatOllama</span>({
    model: <span class="hljs-string">'deepseek-r1:1.5b'</span>,
    baseUrl: <span class="hljs-string">"http://127.0.0.1:11434"</span>,
    topP: <span class="hljs-number">0.9</span>,  <span class="hljs-comment">// 从1.0调整为0.9</span>
    topK: <span class="hljs-number">40</span>,   <span class="hljs-comment">// 从20调整为40</span>
    streaming: <span class="hljs-literal">true</span>,
    temperature: <span class="hljs-number">0</span>,  <span class="hljs-comment">// 新增：固定输出温度，保证结果稳定性</span>
    repeatPenalty: <span class="hljs-number">1.2</span>,  <span class="hljs-comment">// 新增：防止多轮对话后复读系统指令</span>
})
</code></pre>
<p>修改原因：原配置可能导致输出多样性不足或出现重复内容。</p>
<p>改进好处：通过repeatPenalty减少复读现象，调整topP/topK平衡输出多样性与相关性，固定temperature确保回复稳定性。</p>
<h3 data-id="heading-5">3. 提示词模板增强</h3>
<p>修改内容：优化提示词模板结构，增加背景信息注入点</p>
<pre><code class="hljs language-css" lang="css">const textPrompt = ChatPromptTemplate<span class="hljs-selector-class">.fromMessages</span>(<span class="hljs-selector-attr">[    [<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个专业的知识助手。只需回答用户问题，不要重复系统指令。如果无法从背景信息中找到答案，请基于已知对话回复。"</span>]</span>,
    <span class="hljs-selector-attr">[<span class="hljs-string">"placeholder"</span>, <span class="hljs-string">"{chat_history}"</span>]</span>,
    <span class="hljs-selector-attr">[<span class="hljs-string">"human"</span>, <span class="hljs-string">"背景信息：{relevant_history}\n\n当前问题：{user_input}"</span>]</span>  // 新增背景信息字段
]);
</code></pre>
<p>修改原因：原模板仅依赖完整历史对话，长对话场景下可能超出模型上下文窗口。</p>
<p>改进好处：通过{relevant_history}注入检索到的相关片段，既保证上下文相关性，又避免全量历史导致的窗口溢出问题。</p>
<h3 data-id="heading-6">4. 敏感词检查机制强化</h3>
<p>修改内容：完善敏感词检查的错误处理流程</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">profanityChecker</span> = (input: { user_input: string }) =&gt; {
    const <span class="hljs-attr">sensitiveWords</span> = [<span class="hljs-string">"傻瓜"</span>, <span class="hljs-string">"白痴"</span>, <span class="hljs-string">"不良内容"</span>]<span class="hljs-comment">;</span>
    const <span class="hljs-attr">userInput</span> = input.user_input<span class="hljs-comment">;</span>

    if (sensitiveWords.some(<span class="hljs-attr">word</span> =&gt; userInput.includes(word))) {
        throw new Error("检测到敏感内容。请使用文明用语。")<span class="hljs-comment">;  // 明确的错误提示</span>
    }

    return input<span class="hljs-comment">;  // 检查通过则透传输入</span>
}<span class="hljs-comment">;</span>
const <span class="hljs-attr">customCheckStep</span> = RunnableLambda.from(profanityChecker)<span class="hljs-comment">;</span>
</code></pre>
<p>修改原因：原实现未明确错误处理机制，可能导致异常传播不规范。</p>
<p>改进好处：通过抛出结构化错误，使前端能清晰捕获敏感词提示，同时中断后续处理流程，提升系统安全性。</p>
<h3 data-id="heading-7">5. 向量存储重构：单例模式+PGVector</h3>
<p>修改内容：用单例模式管理PGVectorStore，替代原内存向量库</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 替代原MemoryVectorStore的实现</span>
let globalVectorStore: PGVectorStore | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

export <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">getVectorStore</span> = <span class="hljs-title function_ invoke__">async</span> (): Promise&lt;PGVectorStore&gt; =&gt; {
    <span class="hljs-keyword">if</span> (!globalVectorStore) {
        globalVectorStore = await PGVectorStore.<span class="hljs-title function_ invoke__">initialize</span>(embeddingModel, {
            <span class="hljs-attr">postgresConnectionOptions</span>: pgConfig,
            <span class="hljs-attr">tableName</span>: <span class="hljs-string">"test_langchain_embeddings"</span>,
            <span class="hljs-attr">columns</span>: {
                <span class="hljs-attr">idColumnName</span>: <span class="hljs-string">"id"</span>,
                <span class="hljs-attr">vectorColumnName</span>: <span class="hljs-string">"embedding"</span>,
                <span class="hljs-attr">contentColumnName</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-attr">metadataColumnName</span>: <span class="hljs-string">"metadata"</span>,
            },
        });
    }
    <span class="hljs-keyword">return</span> globalVectorStore;
};
</code></pre>
<p>修改原因：原内存向量库存在数据易失性和多实例同步问题。</p>
<p>改进好处：</p>
<ol>
<li>单例模式避免重复创建数据库连接池，减少资源消耗</li>
<li>PGVectorStore支持向量数据的持久化存储和高效检索</li>
<li>结构化的表设计便于后期数据维护和分析</li>
</ol>
<h3 data-id="heading-8">6. 对话历史存储优化</h3>
<p>修改内容：新增对话内容清洗逻辑，增强检索准确性</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">addMessageToVectorStore</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
    sessionId: <span class="hljs-built_in">string</span>,
    humanInput: <span class="hljs-built_in">string</span>,
    aiResponse?: <span class="hljs-built_in">string</span>
</span>) =&gt; {
    <span class="hljs-comment">// 新增：清洗AI回复中的特殊标签</span>
    <span class="hljs-keyword">const</span> cleanAIResponse = aiResponse?.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[\s\S]*?&lt;/</span>think&gt;/g, <span class="hljs-string">""</span>).<span class="hljs-title function_">trim</span>();

    <span class="hljs-keyword">const</span> vectorStore = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getVectorStore</span>();

    <span class="hljs-keyword">const</span> messageText = cleanAIResponse
        ? <span class="hljs-string">`用户：<span class="hljs-subst">${humanInput}</span>\n助手：<span class="hljs-subst">${cleanAIResponse}</span>`</span>
        : <span class="hljs-string">`用户：<span class="hljs-subst">${humanInput}</span>`</span>;

    <span class="hljs-keyword">await</span> vectorStore.<span class="hljs-title function_">addDocuments</span>([{
        <span class="hljs-attr">pageContent</span>: messageText,
        <span class="hljs-attr">metadata</span>: {
            sessionId,
            <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
            <span class="hljs-attr">type</span>: aiResponse ? <span class="hljs-string">"qa_pair"</span> : <span class="hljs-string">"user_query"</span>  <span class="hljs-comment">// 新增类型标识</span>
        }
    }]);
};
</code></pre>
<p>修改原因：原实现可能存储未经处理的模型输出（含思考过程标签），影响检索精度。</p>
<p>改进好处：</p>
<ol>
<li>移除特殊标签确保存储内容纯净度</li>
<li>增加type字段区分消息类型，便于后续检索过滤</li>
<li>标准化存储格式提升语义匹配准确性</li>
</ol>
<h3 data-id="heading-9">7. 检索逻辑优化</h3>
<p>修改内容：增强检索器的会话隔离和结果去重能力</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">retrieveRelevantHistory</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
    userInput: <span class="hljs-built_in">string</span>,
    sessionId: <span class="hljs-built_in">string</span>
</span>) =&gt; {
    <span class="hljs-keyword">const</span> vectorStore = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getVectorStore</span>();

    <span class="hljs-keyword">const</span> retriever = vectorStore.<span class="hljs-title function_">asRetriever</span>({
        <span class="hljs-attr">searchType</span>: <span class="hljs-string">"mmr"</span>,
        <span class="hljs-attr">searchKwargs</span>: {
            <span class="hljs-attr">fetchK</span>: <span class="hljs-number">20</span>,  <span class="hljs-comment">// 扩大候选集</span>
            <span class="hljs-attr">lambda</span>: <span class="hljs-number">0.7</span>,  <span class="hljs-comment">// 平衡相关性和多样性</span>
        },
        <span class="hljs-attr">k</span>: <span class="hljs-number">3</span>,  <span class="hljs-comment">// 小模型适配的最优返回数量</span>
        <span class="hljs-attr">filter</span>: { sessionId },  <span class="hljs-comment">// 严格的会话隔离</span>
    });

    <span class="hljs-keyword">const</span> relevantDocs = <span class="hljs-keyword">await</span> retriever.<span class="hljs-title function_">invoke</span>(userInput);
    <span class="hljs-keyword">return</span> relevantDocs.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>
        ? relevantDocs.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">doc</span> =&gt;</span> doc.<span class="hljs-property">pageContent</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n\n"</span>)
        : <span class="hljs-string">""</span>;  <span class="hljs-comment">// 空字符串替代原"无相关背景知识"</span>
};
</code></pre>
<p>修改原因：原检索逻辑未严格隔离会话，且返回无关提示可能干扰模型。</p>
<p>改进好处：</p>
<ol>
<li>通过filter确保只检索当前会话历史，避免跨会话信息泄露</li>
<li>调整k值适配1.5B小模型的上下文处理能力</li>
<li>返回空字符串替代提示文本，防止干扰模型判断</li>
</ol>
<h3 data-id="heading-10">8. 链式调用流程重构</h3>
<p>修改内容：优化调用链的参数传递逻辑</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> ragChain = <span class="hljs-title class_">RunnableSequence</span>.<span class="hljs-title function_">from</span>([
    customCheckStep,  <span class="hljs-comment">// 优先执行敏感词检查</span>
    {
        <span class="hljs-attr">user_input</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">user_input</span>,
        <span class="hljs-attr">sessionId</span>: <span class="hljs-function">(<span class="hljs-params">_input, config</span>) =&gt;</span> config.<span class="hljs-property">configurable</span>?.<span class="hljs-property">sessionId</span>,
        <span class="hljs-attr">chat_history</span>: <span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> input.<span class="hljs-property">chat_history</span>,
    },
    <span class="hljs-title class_">RunnablePassthrough</span>.<span class="hljs-title function_">assign</span>({
        <span class="hljs-attr">relevant_history</span>: retrieveStep,  <span class="hljs-comment">// 注入检索结果</span>
    }),
    textPrompt,
    llm,
]);
</code></pre>
<p>修改原因：原链式调用参数传递不够清晰，可能导致上下文丢失。</p>
<p>改进好处：</p>
<ol>
<li>明确参数映射关系，提升代码可读性</li>
<li>将敏感词检查置于流程最前端，提前拦截不良内容</li>
<li>分离参数提取与检索逻辑，便于单独调试</li>
</ol>
<h3 data-id="heading-11">9. 会话历史管理升级</h3>
<p>修改内容：使用PostgresChatMessageHistory替代内存存储</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> textChainWithHistory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnableWithMessageHistory</span>&lt;<span class="hljs-built_in">any</span>, <span class="hljs-built_in">any</span>&gt;({
    <span class="hljs-attr">runnable</span>: ragChain,
    <span class="hljs-attr">getMessageHistory</span>: <span class="hljs-function">(<span class="hljs-params">sessionId: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PostgresChatMessageHistory</span>({
            <span class="hljs-attr">tableName</span>: <span class="hljs-string">"chat_messages"</span>,
            sessionId,
            <span class="hljs-attr">poolConfig</span>: pgConfig,
        });
    },
    <span class="hljs-attr">inputMessagesKey</span>: <span class="hljs-string">"user_input"</span>,
    <span class="hljs-attr">historyMessagesKey</span>: <span class="hljs-string">"chat_history"</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>);
</code></pre>
<p>修改原因：原InMemoryChatMessageHistory无法持久化存储对话记录。</p>
<p>改进好处：</p>
<ol>
<li>实现对话历史的持久化存储，服务重启后不丢失</li>
<li>与PostgreSQL向量库形成数据联动，便于数据备份与迁移</li>
<li>支持跨进程共享会话历史，为集群部署提供可能</li>
</ol>
<h3 data-id="heading-12">10. 服务器与请求处理增强</h3>
<p>修改内容：完善HTTP服务器的错误处理和跨域支持</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> app = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-comment">// 新增：过滤浏览器图标请求</span>
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span> === <span class="hljs-string">"/favicon.ico"</span>) {
        res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">404</span>);
        res.<span class="hljs-title function_">end</span>();
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 增强跨域处理</span>
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> === <span class="hljs-string">"OPTIONS"</span>) {
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Access-Control-Allow-Methods"</span>, <span class="hljs-string">"GET, POST, OPTIONS"</span>);
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"Content-Type"</span>);
        res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">204</span>);
        res.<span class="hljs-title function_">end</span>();
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 统一参数解析逻辑</span>
        <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">await</span> <span class="hljs-title function_">parseRequestParams</span>(req);
        <span class="hljs-keyword">const</span> sessionId = params.<span class="hljs-property">sessionId</span> || <span class="hljs-string">"default-session-id"</span>;
        <span class="hljs-keyword">const</span> user_input = params.<span class="hljs-property">user_input</span>;
        
        <span class="hljs-comment">// 输入验证</span>
        <span class="hljs-keyword">if</span> (!user_input) {
            res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">end</span>(<span class="hljs-string">"Missing user_input"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 流式响应处理</span>
        res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, {
            <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/event-stream; charset=utf-8"</span>,
            <span class="hljs-string">"Cache-Control"</span>: <span class="hljs-string">"no-cache"</span>,
            <span class="hljs-string">"Connection"</span>: <span class="hljs-string">"keep-alive"</span>,
        });

        <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> textChainWithHistory.<span class="hljs-title function_">stream</span>(
            { user_input },
            { <span class="hljs-attr">configurable</span>: { sessionId } }
        );
        
        <span class="hljs-keyword">let</span> fullSummary = <span class="hljs-string">""</span>;
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
            <span class="hljs-keyword">const</span> content = chunk.<span class="hljs-property">content</span> || <span class="hljs-string">""</span>;
            fullSummary += content;
            res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ content })}</span>\n\n`</span>);
        }

        <span class="hljs-comment">// 新增：回复完成后存入向量库</span>
        <span class="hljs-keyword">if</span> (fullSummary) {
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">addMessageToVectorStore</span>(sessionId, user_input, fullSummary);
        }
        
        res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ done: <span class="hljs-literal">true</span> })}</span>\n\n`</span>);
        res.<span class="hljs-title function_">end</span>();
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
        <span class="hljs-comment">// 错误信息通过SSE传递</span>
        res.<span class="hljs-title function_">write</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ error: error.message })}</span>\n\n`</span>);
    }
})
</code></pre>
<p>修改原因：原服务器实现缺乏完整的错误处理和请求过滤机制。</p>
<p>改进好处：</p>
<ol>
<li>增加图标请求过滤，减少无效处理</li>
<li>完善的错误捕获与前端通知机制</li>
<li>标准化SSE响应格式，便于前端处理</li>
<li>确保AI回复在生成完成后才存入向量库，避免部分内容存储</li>
</ol>
<h2 data-id="heading-13">结语</h2>
<p>本次优化通过PostgreSQL实现了对话数据的持久化存储，增强了系统的稳定性和安全性，同时优化了检索精度和模型输出质量。相比内存存储方案，新版Demo更接近生产环境需求，可作为企业级本地大模型应用的基础框架。建议结合实际业务场景进一步扩展用户认证、权限控制等功能。</p>
<h3 data-id="heading-14">总结</h3>
<ol>
<li>核心升级方向：内存存储→PostgreSQL持久化，解决数据易失问题，适配生产场景；</li>
<li>关键优化点：敏感词前置检查、检索会话隔离、模型防复读配置，提升安全性与回复质量；</li>
<li>体验增强：标准化SSE流式响应、完善的错误处理，降低前端对接成本。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI大模型爆火的SSE技术到底是什么？万字长文，一篇读懂SSE！]]></title>    <link>https://juejin.cn/post/7586587644824731682</link>    <guid>https://juejin.cn/post/7586587644824731682</guid>    <pubDate>2025-12-23T07:34:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586587644824731682" data-draft-id="7586587644823650338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI大模型爆火的SSE技术到底是什么？万字长文，一篇读懂SSE！"/> <meta itemprop="keywords" content="WebSocket,前端"/> <meta itemprop="datePublished" content="2025-12-23T07:34:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JackJiang"/> <meta itemprop="url" content="https://juejin.cn/user/3104676566799399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI大模型爆火的SSE技术到底是什么？万字长文，一篇读懂SSE！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3104676566799399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JackJiang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:34:36.000Z" title="Tue Dec 23 2025 07:34:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文由45岁老架构师尼恩分享，感谢作者，有修订和重新排版。</p>
<h2 data-id="heading-0">1、引言</h2>
<p>你有没有想过，为什么 ChatGPT 的回答能逐字逐句地“流”出来？这一切的背后，都离不开一项关键技术——SSE（Server-Sent Events）！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6602a3fb6337470aa07567207adea124~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=D4o5FoRb7feZp%2BVChjet5Y0yd8c%3D" alt="" loading="lazy"/></p>
<p><strong>本文从SSE（<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource" ref="nofollow noopener noreferrer">Server-Sent Events</a>）技术的原理到示例代码，为你通俗易懂的讲解SSE技术的方方面面。</strong></p>
<h2 data-id="heading-1">2、AI大模型实时通信技术专题</h2>
<p>技术专题系列文章目录如下，本文是第 <strong><em>4</em></strong> 篇：</p>
<ol>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4797-1-1.html" target="_blank" title="http://www.52im.net/thread-4797-1-1.html" ref="nofollow noopener noreferrer">全民AI时代，大模型客户端和服务端的实时通信到底用什么协议？</a>》</li>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4831-1-1.html" target="_blank" title="http://www.52im.net/thread-4831-1-1.html" ref="nofollow noopener noreferrer">大模型时代多模型AI网关的架构设计与实现</a>》</li>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4856-1-1.html" target="_blank" title="http://www.52im.net/thread-4856-1-1.html" ref="nofollow noopener noreferrer">通俗易懂：AI大模型基于SSE的实时流式响应技术原理和实践示例</a>》</li>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4872-1-1.html" target="_blank" title="http://www.52im.net/thread-4872-1-1.html" ref="nofollow noopener noreferrer">ChatGPT如何实现聊天一样的实时交互？快速读懂SSE实时“推”技术</a> 》</li>
<li>《<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4885-1-1.html" target="_blank" title="http://www.52im.net/thread-4885-1-1.html" ref="nofollow noopener noreferrer">AI大模型爆火的SSE技术到底是什么？万字长文，一篇读懂SSE！</a> 》（☜ 本文）</li>
</ol>
<h2 data-id="heading-2">3、初识SSE</h2>
<p>SSE（Server-Sent Events）是一种基于 HTTP 协议的服务器推送技术，允许服务端主动向客户端发送数据流。</p>
<p>SSE 可以被理解为 HTTP 的一个扩展或一种特定用法。它不是一个全新的、独立的协议，而是构建在标准 HTTP/1.1 协议之上的技术。</p>
<p>SSE 就像是服务器打开了一个“单向数据管道”，服务器通过HTTP 扩展 可以持续不断地流向浏览器，无需客户端反复发起请求。其实很简单的： SSE = HTTP 扩展字段 + Keepalive 长连接。</p>
<p>SSE 提供了一种简单、可靠的方式来实现服务器向客户端的实时数据推送。它非常适合通知、实时数据更新、日志流和类似 ChatGPT 的逐字输出场景。如果你只需要单向通信，SSE 往往是比 WebSocket 更简单、更轻量的选择。</p>
<p>SSE 适用于服务器主动向客户端推送数据的场景，如实时通知、动态更新等。</p>
<p>所以，目前 几乎所有主流浏览器都原生支持SSE。</p>
<p><strong>PS：</strong> <strong>更详细的SSE技术资料，可以进一步阅读以下几篇：</strong></p>
<ol>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-336-1-1.html" target="_blank" title="http://www.52im.net/thread-336-1-1.html" ref="nofollow noopener noreferrer">Web端即时通讯技术盘点：短轮询、Comet、Websocket、SSE</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-335-1-1.html" target="_blank" title="http://www.52im.net/thread-335-1-1.html" ref="nofollow noopener noreferrer">SSE技术详解：一种全新的HTML5服务器推送事件技术</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-1038-1-1.html" target="_blank" title="http://www.52im.net/thread-1038-1-1.html" ref="nofollow noopener noreferrer">详解Web端通信方式的演进：从Ajax、JSONP 到 SSE、Websocket</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2719-1-1.html" target="_blank" title="http://www.52im.net/thread-2719-1-1.html" ref="nofollow noopener noreferrer">一文读懂前端技术演进：盘点Web前端20年的技术变迁史</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3555-1-1.html" target="_blank" title="http://www.52im.net/thread-3555-1-1.html" ref="nofollow noopener noreferrer">网页端IM通信技术快速入门：短轮询、长轮询、SSE、WebSocket</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3695-1-1.html" target="_blank" title="http://www.52im.net/thread-3695-1-1.html" ref="nofollow noopener noreferrer">搞懂现代Web端即时通讯技术一文就够：WebSocket、socket.io、SSE</a></li>
</ol>
<h2 data-id="heading-3">4、SSE的诞生背景</h2>
<h5 data-id="heading-4">4.1  短轮询、长轮询、Flash 、 WebSocket</h5>
<p>在 SSE 技术出现之前，Web 应用要实现服务器向客户端的实时数据推送，主要依赖以下几种技术，但它们都存在明显的缺陷。</p>
<p><strong>4.1.1） 短轮询 (Polling)：</strong></p>
<p><strong>原理：</strong> 用短连接请求数据。客户端以固定的时间间隔（例如每秒一次）频繁地向服务器发送请求，询问是否有新数据。</p>
<p><strong>缺点：</strong> 大量请求可能是无效的（无新数据），浪费服务器和带宽资源，实时性差。</p>
<p><strong>短轮询的技术流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/670174c6dd834ca6b6a129a9ccefd55a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=2Rd2zgu8rXItrJHcZRQ6Who0KYE%3D" alt="" loading="lazy"/></p>
<p>**</p>
<p>4.1.2）长轮询 (Long Polling)：</p>
<p>**</p>
<p>原理：使用长连接请求数据。 客户端发送一个请求，服务器会保持这个连接打开（长连接），直到有新数据可用或超时。一旦客户端收到响应，会立即发起下一个请求。</p>
<p>缺点：虽然减少了无效请求，但每个连接仍然需要客户端发起，服务器需要维护大量挂起的连接，实现复杂。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f50b7a9f1d54fd5b418542b385e53eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=xvgrnctIubinLBqL5RYJotnGe7Q%3D" alt="" loading="lazy"/></p>
<p>长轮询 (Long Polling) 的技术突破：减少无效请求，但服务器需维护挂起连接</p>
<p><strong>4.1.3）基于 Flash 的解决方案：</strong></p>
<p>原理：利用 Adobe Flash 插件提供的 Socket 功能实现全双工通信。</p>
<p>缺点：依赖浏览器插件，在移动端（如 iPhone）不受支持，且随着技术的发展（Flash 被淘汰）已走向消亡。基于 Flash 方法都非原生支持，效率低下或依赖外部插件。</p>
<p><strong>4.1.4）基于 WebSocket的解决方案：</strong></p>
<p>原理：在客户端与服务器之间建立一条全双工的 TCP 长连接，双方可随时互相推送数据。</p>
<p><strong>缺点：</strong></p>
<ul>
<li>
<p>1）需要一次额外的协议升级握手（Upgrade: websocket），对 CDN、防火墙、代理服务器的兼容性不如普通 HTTP；</p>
</li>
<li>
<p>2）双向通信能力在“服务器→客户端单向推送”场景下显得过度设计，增加心跳、重连、帧解析等复杂度；</p>
</li>
<li>
<p>3）早期浏览器支持不一（IE ≤ 9 无原生实现），需要 Polyfill 或 Flash 降级方案。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e6bdfb928c14ca1a3ac98f3e09b81d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=Wc83W4XnhtsQ1pZC5sEvbu9QdGU%3D" alt="" loading="lazy"/></p>
<p>WebSocket全双工通道的革命性：摆脱HTTP束缚，实现真正的实时交互（</p>
<p>PS:</p>
<p>WebSocket 并不仅是 Web 领域的通讯协议，它属于复杂度较高的二进制通讯协议）。</p>
<h5 data-id="heading-5">4.2 SSE 诞生的核心背景</h5>
<p>因此，Web 领域迫切需要一种标准化的、高效的、由浏览器原生支持的服务器到客户端的单向通信机制。这就是 SSE 诞生的核心背景。</p>
<p><strong>核心需求：</strong></p>
<ul>
<li>
<p>1）简单：易于服务器和客户端实现；</p>
</li>
<li>
<p>2）高效：基于 HTTP/HTTPS，避免不必要的请求开销；</p>
</li>
<li>
<p>3）标准：成为 W3C 标准，得到浏览器原生支持；</p>
</li>
<li>
<p>4）自动重连：内置连接失败后自动重试的机制。</p>
</li>
</ul>
<p><strong>SSE——真正的服务器推送：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da9a8683493645939461312a1829115b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=Qc0Y%2B9TifBuvTkuPvUnMQw5vLJg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">5、SSE的前世今生</h2>
<p>SSE 的发展是 Web 标准化进程和实时通信需求共同推动的结果。</p>
<p><strong>下图概述了其关键发展节点：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e09f28733fb480e9f316b9cb8b1e1d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=3wNcFZ4vMyKwc%2BCvGjxO1a44lqk%3D" alt="" loading="lazy"/></p>
<p>让我们对图中的关键阶段进行详细解读。</p>
<p><strong>1）诞生背景（2006 年以前）：</strong></p>
<p>Web 早期只有“请求-响应”范式，实时需求（股票、IM、行情）只能靠轮询或长轮询，延迟高、浪费资源。Comet（长连接 iframe、jsonp、xhr-streaming 等 Hack 方案）出现，但实现复杂、浏览器兼容性差、占用连接数高。</p>
<p>业界急需一种“浏览器原生、基于 HTTP、单向服务器推送”的轻量机制。</p>
<p><strong>2）概念提出与标准化 (约 2006-2009年)：</strong></p>
<p>SSE 的概念最初作为 HTML5 标准的一部分被提出，由 WHATWG (Web Hypertext Application Technology Working Group) 和 W3C (World Wide Web Consortium) 共同推动。</p>
<p>其设计思想是定义一个简单的、基于 HTTP 的协议，允许服务器通过一个长连接持续地向客户端发送文本流。</p>
<p>2006 年，Opera 9 在浏览器里率先实现名为 Server-Sent Events 的实验 API，用 DOM 事件把服务器推送的文本块喂给页面。</p>
<p>同期 WHATWG HTML5 草案开始收录相关章节，定义了 text/event-stream MIME 类型及“event: / data:”行协议。</p>
<p>后来，它从庞大的 HTML5 规范中分离出来，成为了一个独立的 W3C 标准文档。</p>
<p>2008 年，SSE 被正式写入 HTML5 草案，随后进入 W3C 标准流程。</p>
<p><strong>3）浏览器支持与推广 (约 2010-2015年)：</strong></p>
<p>2011年左右，主流浏览器（如 Firefox、Chrome、Safari、Opera）开始陆续支持 SSE API。 Firefox 6、Chrome 6、Safari 5、Opera 11.5 陆续完成原生实现；IE 系列缺席（直到 Edge 79 才补票）。</p>
<p>关键的障碍：Internet Explorer (包括 IE 11) 始终没有支持 SSE API。这在一定程度上限制了其早期的广泛应用，开发者通常需要为此准备降级方案（如回落到长轮询）。</p>
<p>随着 Chrome、Firefox 等现代浏览器的市场份额不断上升，以及移动端浏览器对 SSE 的良好支持，SSE 逐渐成为开发实时 Web 应用的可信选择。</p>
<p>2014 年 10 月：HTML5 成为 W3C Recommendation，SSE 作为官方子模块锁定最终语法，浏览器阵营格局定型。</p>
<p><strong>4）正式推荐与成熟 (2015年至2022 )：</strong></p>
<p>2015-2020 年，WebSocket 与 WebRTC 占据实时通信话题中心，SSE 主要在企业内部仪表盘、日志 tail 等低频场景默默使用。</p>
<p>SSE 由于有 “单向文本流 + 自动重连 + 轻量” 特性，所以没有被WebSocket 与 WebRTC 踩死， 使其在 IoT 设备、移动端 WebView 中仍保有一席之地。</p>
<p>2015年，W3C 发布了 Server-Sent Events 的正式推荐标准，标志着该技术的成熟和稳定。在此期间，前端生态框架（如 React、Vue.js）和后端语言（如 Node.js、Python、Java）都提供了对 SSE 的良好支持，出现了大量易用的库和示例。</p>
<p><strong>5） 大模型时代的爆发（2022 至今）：</strong></p>
<p>虽然 WebSocket 提供了全双工通信能力，但 SSE 因其简单的 API、基于 HTTP 带来的良好兼容性（如无需担心代理或防火墙问题）、以及自动重连等特性，在只需要服务器向客户端推送数据的场景中（如新闻推送、实时行情、状态更新、AI 处理进度流式输出等）成为了更简单、更合适的选择。</p>
<p><strong>ChatGPT、Claude 等生成式 AI 需要“打字机”式逐 token 输出，SSE 天然契合：</strong></p>
<ul>
<li>
<p>1）基于 HTTP/1.1 无需升级协议，CDN 缓存友好；</p>
</li>
<li>
<p>2）浏览器 EventSource API 一行代码即可接入；</p>
</li>
<li>
<p>3）文本流可直接承载 JSON Lines 或 markdown 片段。</p>
</li>
</ul>
<p>2022 年底起：OpenAI、Anthropic、Google Bard 均把 text/event-stream 作为官方流式回答协议，社区库（FastAPI SSE-Star、Spring WebFlux、Node sse.js、Go gin-sse）迎来二次繁荣。</p>
<h2 data-id="heading-7">6、SSE的技术特征</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08a184670c054aacb1e067dea5b0d309~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=P8Q7qlKyYsAdYWkdACiAiwrhRFY%3D" alt="" loading="lazy"/></p>
<p><strong>SSE和WebSocket 都能建立浏览器与服务器的长期通信，但区别很明显：</strong></p>
<ul>
<li>
<p>1）</p>
<p>SSE 是单向推送 不是双向推送， 而且是http协议的一个扩展协议， 使用简单、自动重连，适合文本类实时推送；</p>
</li>
<li>
<p>2）</p>
<p>WebSocket 是双向通信，不是 http协议的一个扩展协议，WebSocket 更灵活，但实现相对复杂。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/322662fc82644c5296c9cd8f43def280~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=%2FccAZKNAK%2BcpdgQfshOhf795bik%3D" alt="" loading="lazy"/></p>
<p><strong>流程解读：</strong></p>
<ul>
<li>
<p>1）连接初始化：客户端使用特定的 Content-Type: text/event-stream 向服务器发起一个普通的 HTTP GET 请求。服务器确认并保持连接开放。</p>
</li>
<li>
<p>2）数据推送：服务器通过保持打开的连接，以纯文本格式（遵循 data: ...、event: ... 等规范）持续发送数据块。每个消息以两个换行符 \n\n 结束。</p>
</li>
<li>
<p>3）连接容错：如果连接因网络问题中断，SSE 客户端内置的机制会自动尝试重新建立连接，极大地提高了应用的鲁棒性。</p>
</li>
<li>
<p>4）客户端处理：浏览器端的 EventSource API 会解析收到的数据流，触发相应的事件（如 onmessage 或自定义事件），让开发者能够处理推送来的数据。</p>
</li>
</ul>
<p>SSE 的诞生是 Web 开发对简单、高效、标准化的服务器推送技术需求的直接结果。它有效地替代了笨拙的轮询技术，在与 WebSocket 的竞争中，找到了自身在单向数据流场景下的独特定位。</p>
<p>其发展历程经历了从概念提出、浏览器支持到成为正式标准的完整路径。尽管曾受限于 IE，但在现代浏览器中已成为一项稳定、可靠且被广泛采用的技术。如今，在实时通知、金融仪表盘、实时日志跟踪和大型语言模型（LLM）的流式响应输出等场景中，SSE 都是首选的解决方案。</p>
<h2 data-id="heading-8">7、默默无闻的SSE为何在AI大模型时代一夜爆火？</h2>
<p>SSE 最近站到聚光灯下，几乎可以说最大的推手就是当前 AI 应用（尤其是 ChatGPT 等大型语言模型）的爆发式增长。SSE 之所以成为 AI 应用的“标配”，是因为 SSE 与 AI 所需的“打字机” 输出模式 是 天作之合。</p>
<h5 data-id="heading-9">7.1 什么是AI大模型“打字机” 式的逐token输出？</h5>
<p>“打字机”式 逐 token 输出是一种流式传输方式，它模拟了人类打字或思考的过程。</p>
<p>服务器不是等待 LLM 生成整个答案 后一次性发送给 用户，而是 流式输出， 每生成一个“词元”（token，可以粗略理解为一个词或一个字），就立刻发送这个“词元”。</p>
<p>下面举一个例子，对比 一下 传统方式（非流式）和 “打字机” （流式）式 的过程。</p>
<p><strong>传统方式（非流式）过程如下：</strong></p>
<ul>
<li>
<p>1）你提问：“请写一首关于春天的诗”。</p>
</li>
<li>
<p>2）服务器端的 AI 开始思考、生成，整个过程你需要等待（可能好几秒甚至更久）。</p>
</li>
<li>
<p>3）AI 生成完整的诗歌：“春风拂面绿意浓，百花争艳映晴空...”。</p>
</li>
<li>
<p>4）服务器将整首诗作为一个完整的 JSON 对象 { "content": "春风拂面绿意浓，百花争艳映晴空..." } 发送给客户端。</p>
</li>
<li>
<p>5）客户端一次性收到全部内容并渲染出来。</p>
</li>
</ul>
<p><strong>“打字机”（流式）过程如下：</strong></p>
<ul>
<li>
<p>1）你提问：“请写一首关于春天的诗”。</p>
</li>
<li>
<p>2）服务器端的 AI 生成第一个 token “春”，立刻通过 SSE 发送 data: “春”。</p>
</li>
<li>
<p>3）客户端收到“春”并显示出来。</p>
</li>
<li>
<p>4）AI 生成第二个 token “风”，立刻发送 data: “风”。</p>
</li>
<li>
<p>5）客户端在“春”后面追加“风”，形成“春风”。</p>
</li>
<li>
<p>6）后续 token “拂”、“面”、“绿”、“意”、“浓”... 依次迅速发送和追加。</p>
</li>
<li>
<p>7）你看到的效果就是文字一个接一个地“打”在屏幕上，就像有人在远端为你实时打字一样。</p>
</li>
</ul>
<p><strong>“打字机”（流式） 模式的巨大优势：</strong></p>
<ul>
<li>
<p>1）极低的感知延迟：用户几乎在提问后瞬间就能看到第一个字开始输出，无需经历漫长的等待白屏期，体验流畅自然。</p>
</li>
<li>
<p>2）提供了“正在进行”的反馈：看着文字逐个出现，给人一种模型正在为你“思考”和“创作”的生动感，而不是在“沉默中宕机”。</p>
</li>
<li>
<p>3）更高效地利用时间：用户可以在前半句还在输出时，就开始阅读和理解，节省了总体的认知时间。</p>
</li>
</ul>
<h5 data-id="heading-10">7.2 为什么SSE跟AI大模型是“天作之合”？</h5>
<p>这正是 SSE 的设计初衷和核心优势所在，它与 AI 流式输出的需求完美匹配。</p>
<p><strong>1）单向通信的完美匹配：</strong></p>
<p>AI 的文本生成过程本质上是服务器到客户端的单向数据推送。客户端只需要接收，不需要在生成过程中频繁地发送请求。SSE 的“服务器推送”模型正是为此而生，而 WebSocket 的双向能力在这里是多余的。</p>
<p><strong>2）基于 HTTP/HTTPS，简单且兼容：</strong></p>
<p>SSE 使用标准的 HTTP 协议，这意味着 SSE 易于实现和调试：任何后端框架和前端语言都能轻松处理。在浏览器中调试时，你可以在“网络”选项卡中直接看到以文本流形式传输的事件，非常直观。</p>
<p>SSE 使用标准的 HTTP 协议，这还意味着 容易绕过网络障碍：公司防火墙和代理通常对 HTTP/HTTPS 放行，而可能会阻拦陌生的 WebSocket 协议。这使得 SSE 的部署兼容性极好。</p>
<p><strong>3）内置的自动重连机制：</strong></p>
<p>网络连接并不完全可靠。如果用户在接收很长的回答时网络波动，连接中断，SSE 客户端会自动尝试重新连接。这对于长时间流的应用至关重要，提供了天然的鲁棒性。</p>
<p><strong>4）轻量级的文本协议：</strong></p>
<p>AI 流式输出传输的就是文本（UTF-8编码）。SSE 的协议 data: ...\n\n 就是为传输文本片段而设计的，极其高效和简单。WebSocket 虽然也能传文本，但其协议设计还考虑了二进制帧、掩码等更复杂的情况，对于纯文本流来说显得有些“重”。</p>
<p><strong>5）原生浏览器 API：</strong></p>
<p>现代浏览器都原生支持 EventSource API，开发者无需引入额外的第三方库，即可轻松实现接收流式数据，减少了依赖和打包体积。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9fb4c3478254ea2918a4a690e978521~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=gF4JHFrlJCQuzzQdmSUk6G0gq70%3D" alt="" loading="lazy"/></p>
<p><strong>所以，SSE 站到聚光灯下的原因正是：</strong></p>
<blockquote>
<p>AI 应用需要“打字机”式的逐 token 输出体验，而 SSE 作为一种基于 HTTP 的、简单的、单向的服务器推送技术，是实现这种体验最自然、最高效、最可靠的技术选择。</p>
</blockquote>
<p>它就像是为这个场景量身定做的工具，没有多余的功能，只有恰到好处的设计。因此，当 ChatGPT 等应用席卷全球时，其背后默默无闻的 SSE 技术也终于从幕后走到了台前，被广大开发者所重新认识和重视。</p>
<h2 data-id="heading-11">8、SSE的技术原理详解</h2>
<h5 data-id="heading-12">8.1 工作机制的流程图</h5>
<p>SSE 通过一个持久的 HTTP 连接实现服务器到客户端的单向数据流。</p>
<p><strong>以下是其工作机制的流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0633f5bf47f4d70b9abc82a91d177b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=S1k%2BMGRg2MmJpBSPfwDDrj%2BtMaQ%3D" alt="" loading="lazy"/></p>
<p>以下是关键步骤解析。</p>
<p>**1）**<strong>浏览器发起一个 HTTP 请求，Header 中包含：</strong></p>
<p>1Accept: text/event-stream</p>
<p>**2）**<strong>服务器响应类型必须为：</strong></p>
<blockquote>
<p>Content-Type: text/event-stream</p>
<p>Cache-Control: no-cache</p>
<p>Connection: keep-alive</p>
</blockquote>
<p>**3）**<strong>服务器发送事件格式（每个事件以两个换行符结束）：</strong></p>
<blockquote>
<p>event: message</p>
<p>data: {"time": "2023-10-05T12:00:00", "value": "New update!"}</p>
<p>id: 12345</p>
<p>retry: 5000</p>
<p>\n\n</p>
</blockquote>
<p><strong>4）</strong> 浏览器通过 EventSourceAPI 接收并处理事件。</p>
<p><strong>5）</strong> 服务器发送 一个特殊“结束”事件，可以结束传输。比如，服务器发送一个如 event: end 的消息，可以结束传输。客户端预先监听这个自定义的 end 事件，一旦收到，就知道传输结束，并可以选择主动关闭 EventSource 连接。</p>
<p><strong>6）</strong> 若连接中断，浏览器会根据 retry字段自动重连。如果没有收到 特殊“结束”事件， 浏览器 可以自动重连。</p>
<h5 data-id="heading-13">8.2 SSE与其他通信方式对比</h5>
<p><strong>不同通信技术各有适用场景，我们用表格清晰对比：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c4d51ceadd64d1f8cd4814b6cb1ad4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=QbjwNfoOX7zGjEpfYMELfIoRPgk%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-14">8.3 SSE的适用场景</h5>
<p><strong>1）</strong> <strong>ChatGPT 式逐字输出( “打字机” 式逐 词元 token输出)：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2e80541e715465cb9280c98fad41ab1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=y6Q7vikSKWsvBFkqleScGU0Y89Y%3D" alt="" loading="lazy"/></p>
<p><strong>2）</strong> <strong>实时通知系统：</strong></p>
<ul>
<li>a. 新订单提醒；</li>
<li>b. 用户消息推送；</li>
<li>c. 审核状态更新。</li>
</ul>
<p><strong>3）</strong> <strong>实时数据看板：</strong></p>
<ul>
<li>a. 股票行情；</li>
<li>b. 设备监控数据；</li>
<li>c. 实时日志流。</li>
</ul>
<h2 data-id="heading-15">9、SSE客户端API详解</h2>
<p>SSE的客户端实现非常简单，浏览器原生提供了<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource" ref="nofollow noopener noreferrer">EventSource</a>对象来处理与服务器的SSE连接。下面我们详细介绍它的使用方法和核心特性。</p>
<h5 data-id="heading-16">9.1 认识浏览器端EventSource对象</h5>
<p><strong>浏览器兼容性检测：</strong></p>
<p>在使用SSE前，首先需要确认当前浏览器是否支持EventSource（除IE/Edge外，几乎所有现代浏览器都支持）。</p>
<p><strong>检测方法如下：</strong></p>
<blockquote>
<p>// 检查浏览器是否支持SSE</p>
<p>if ('EventSource' in window) {</p>
<p>// 支持SSE，可正常使用</p>
<p>console.log('浏览器支持SSE');</p>
<p>} else {</p>
<p>// 不支持SSE，需降级处理</p>
<p>console.log('浏览器不支持SSE');</p>
<p>}</p>
</blockquote>
<p><strong>创建连接：</strong></p>
<p>使用EventSource创建与服务器的连接非常简单，只需传入服务器的SSE接口地址：</p>
<blockquote>
<p>// 建立与服务器的SSE连接</p>
<p>// url为服务器提供的SSE接口地址（可同域或跨域）</p>
<p>var source = new EventSource(url);</p>
</blockquote>
<p>如果需要跨域请求并携带Cookie，可通过第二个参数配置：</p>
<blockquote>
<p>// 跨域请求时，允许携带Cookie</p>
<p>var source = new EventSource(url, {</p>
<p>withCredentials: true // 默认为false，设为true表示跨域请求携带Cookie</p>
<p>});</p>
</blockquote>
<p><strong>连接状态（readyState）：</strong></p>
<p>EventSource实例的readyState属性用于表示当前连接状态，只读且有三个可能值：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0665e4e35db44802a6bdab42b88fdb92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=GGVUTCrxORXgwSn4HaiSLxX8KNo%3D" alt="" loading="lazy"/></p>
<p>可以通过该属性判断当前连接状态，例如：</p>
<blockquote>
<p>if (source.readyState === EventSource.OPEN) {</p>
<p>console.log('SSE连接已正常建立');</p>
<p>}</p>
</blockquote>
<h5 data-id="heading-17">9.2 基本使用方法</h5>
<p>EventSource通过事件机制处理连接过程中的各种状态和接收的数据，核心事件包括<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource%2Fopen_event" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource/open_event" ref="nofollow noopener noreferrer">open</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource%2Fmessage_event" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource/message_event" ref="nofollow noopener noreferrer">message</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource%2Ferror_event" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource/error_event" ref="nofollow noopener noreferrer">error</a>。</p>
<p><strong>下面用流程图展示SSE客户端的完整使用流程：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a8616ce2940454ba932eb546b438900~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=rGqyyt87%2FHisMPT2FfmadEt8zIs%3D" alt="" loading="lazy"/></p>
<p><strong>连接建立：open事件</strong></p>
<p>当客户端与服务器成功建立SSE连接时，会触发open事件：</p>
<blockquote>
<p>// 方式1：使用onopen属性</p>
<p>source.onopen = function (event) {</p>
<p>console.log('SSE连接已建立');</p>
<p>// 可在此处做连接成功后的初始化操作，如更新UI状态</p>
<p>};</p>
<p>// 方式2：使用addEventListener（推荐，可添加多个回调）</p>
<p>source.addEventListener('open', function (event) {</p>
<p>console.log('SSE连接已建立（监听方式）');</p>
<p>}, false);</p>
</blockquote>
<p><strong>接收数据：message事件</strong></p>
<p>当客户端收到服务器推送的数据时，会触发message事件（默认事件，处理未指定类型的消息）：</p>
<blockquote>
<p>// 方式1：使用onmessage属性</p>
<p>source.onmessage = function (event) {</p>
<p>// event.data为服务器推送的文本数据</p>
<p>var data = event.data;</p>
<p>console.log('收到数据：', data);</p>
<p>// 可在此处处理数据，如更新页面内容</p>
<p>};</p>
<p>// 方式2：使用addEventListener</p>
<p>source.addEventListener('message', function (event) {</p>
<p>var data = event.data;</p>
<p>console.log('收到数据（监听方式）：', data);</p>
<p>}, false);</p>
</blockquote>
<p>注意：event.data始终是字符串类型，如果服务器发送的是JSON数据，需要用JSON.parse(data)转换。</p>
<p><strong>连接错误：error事件</strong></p>
<p>当连接发生错误（如网络中断、服务器出错）时，会触发error事件：</p>
<blockquote>
<p>// 方式1：使用onerror属性</p>
<p>source.onerror = function (event) {</p>
<p>// 可根据readyState判断错误类型</p>
<p>if (source.readyState === EventSource.CONNECTING) {</p>
<p>console.log('连接出错，正在尝试重连...');</p>
<p>} else {</p>
<p>console.log('连接已关闭，无法重连');</p>
<p>}</p>
<p>};</p>
<p>// 方式2：使用addEventListener</p>
<p>source.addEventListener('error', function (event) {</p>
<p>// 错误处理逻辑</p>
<p>}, false);</p>
</blockquote>
<p><strong>关闭连接：close()方法</strong></p>
<p>如果需要主动关闭SSE连接（关闭后不会自动重连），可调用close()方法：</p>
<blockquote>
<p>// 主动关闭SSE连接</p>
<p>source.close();</p>
<p>console.log('SSE连接已手动关闭');</p>
</blockquote>
<h5 data-id="heading-18">9.3 自定义事件</h5>
<p>默认情况下，服务器推送的消息会触发message事件。但实际开发中，我们可能需要区分不同类型的消息（如"新订单通知"和"系统公告"），这时就可以使用自定义事件。</p>
<p>客户端通过addEventListener监听自定义事件名，例如监听order事件：</p>
<blockquote>
<p>// 监听名为"order"的自定义事件</p>
<p>source.addEventListener('order', function (event) {</p>
<p>var orderData = event.data;</p>
<p>console.log('收到新订单：', orderData);</p>
<p>// 处理订单相关逻辑</p>
<p>}, false);</p>
<p>// 再监听一个名为"notice"的自定义事件</p>
<p>source.addEventListener('notice', function (event) {</p>
<p>var noticeData = event.data;</p>
<p>console.log('收到系统公告：', noticeData);</p>
<p>// 处理公告相关逻辑</p>
<p>}, false);</p>
</blockquote>
<p>注意：自定义事件不会触发message事件，只会被对应的addEventListener捕获。</p>
<p>上面代码中，浏览器对 SSE 的foo``notice事件进行监听。如何实现服务器发送foo``notice事件，请看下文。</p>
<h2 data-id="heading-19">10、SSE服务器端技术详解</h2>
<p>服务器要实现SSE，核心是按照特定格式向客户端发送数据。下面详细介绍服务器端的实现规范。</p>
<h5 data-id="heading-20">10.1 HTTP 头信息要求</h5>
<p>服务器向客户端发送SSE数据时，必须设置以下HTTP响应头，否则客户端无法正确识别为事件流：</p>
<blockquote>
<p>Content-Type: text/event-stream // 必须，指定为事件流类型</p>
<p>Cache-Control: no-cache // 必须，禁止缓存，确保数据实时性</p>
<p>Connection: keep-alive // 必须，保持长连接</p>
</blockquote>
<p>这三个头信息是SSE的基础，缺少任何一个都可能导致连接失败或数据异常。</p>
<h5 data-id="heading-21">10.2 数据传输格式</h5>
<p>服务器发送的每条消息（message）由多行组成，每行格式为[字段]: 值\n（字段名后必须跟冒号和空格，结尾用换行符\n）。多条消息之间用\n\n（两个换行符）分隔。</p>
<p>此外，以 : 开头的行是注释（服务器可定期发送注释保持连接）。</p>
<p>基本格式示例：</p>
<blockquote>
<p>: 这是一条注释（客户端会忽略）\n</p>
<p>data: 这是第一条消息\n\n</p>
<p>data: 这是第二条消息的第一行\n</p>
<p>data: 这是第二条消息的第二行\n\n</p>
</blockquote>
<p>注意：换行符必须是\n（Unix格式），\r\n可能导致客户端解析错误。</p>
<h5 data-id="heading-22">10.3 核心字段说明</h5>
<p>SSE消息支持四个核心字段，分别用于不同场景。</p>
<p><strong>1）data字段：消息内容：</strong></p>
<p>data字段用于携带实际的消息内容，是最常用的字段。</p>
<p>单行数据：</p>
<blockquote>
<p>data: Hello, SSE!\n\n // 单行数据，以\n\n结束</p>
</blockquote>
<p><strong>多行数据（适合JSON等复杂结构）：</strong></p>
<blockquote>
<p>data: {\n // 第一行以\n结束</p>
<p>data: "name": "张三",\n // 第二行以\n结束</p>
<p>data: "age": 20\n // 第三行以\n结束</p>
<p>data: }\n\n // 最后一行以\n\n结束</p>
</blockquote>
<p>客户端接收后，event.data会自动拼接为完整字符串：{"name": "张三","age": 20}</p>
<p><strong>2）event字段：指定事件类型：</strong></p>
<p>event字段用于指定消息的事件类型，客户端可通过对应事件名监听（即<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4885-1-1.html%2319" target="_blank" title="http://www.52im.net/thread-4885-1-1.html#19" ref="nofollow noopener noreferrer">9.3节的自定义事件</a>）。</p>
<p>服务器发送：</p>
<blockquote>
<p>event: order\n // 指定事件类型为order</p>
<p>data: 新订单ID：12345\n // 消息内容</p>
<p>\n // 消息结束（\n\n简化为单独一行）</p>
</blockquote>
<p><strong>客户端监听：</strong></p>
<blockquote>
<p>source.addEventListener('order', function(event) {</p>
<p>console.log(event.data); // 输出：新订单ID：12345</p>
<p>});</p>
</blockquote>
<p><strong>3）id字段：消息标识：</strong></p>
<p>id字段用于给消息设置唯一标识，客户端会自动记录最后一条消息的id（存于source.lastEventId）。</p>
<p>核心作用：当连接断线重连时，客户端会在请求头中携带Last-Event-ID: [最后收到的id]，服务器可根据该ID恢复数据传输（避免重复或丢失）。</p>
<p>服务器发送：</p>
<blockquote>
<p>id: msg1001\n // 消息标识</p>
<p>data: 这是第1001条消息\n</p>
<p>\n</p>
</blockquote>
<p>客户端重连时的请求头：</p>
<blockquote>
<p>Last-Event-ID: msg1001 // 自动携带最后收到的id</p>
</blockquote>
<p><strong>4）retry字段：重连间隔：</strong></p>
<p>retry字段用于指定客户端断线后的重连间隔（单位：毫秒），默认重连间隔约为3秒。</p>
<p>服务器发送：</p>
<blockquote>
<p>retry: 5000\n // 告诉客户端，断线后5秒再重连</p>
<p>data: 重连间隔已设置为5秒\n</p>
<p>\n</p>
</blockquote>
<p><strong>5）服务器保持连接示例：</strong></p>
<p>服务器可以定期发送注释行，保持连接活跃：</p>
<blockquote>
<p>: 这是保持连接活动的注释行\n</p>
<p>: 服务器时间 2023-10-05T12:00:00\n</p>
</blockquote>
<h5 data-id="heading-23">10.4 服务器发送流程</h5>
<p><strong>服务器发送SSE数据的完整流程如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4e2666d0d2d4be39601aabcb3d769cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=s0CuuwUqRPeakIwtpoXHeGx83ak%3D" alt="" loading="lazy"/></p>
<p><strong>下面是一个包含多种字段的服务器发送示例，模拟一个实时通知系统：</strong></p>
<blockquote>
<p>: 服务器开始发送消息（注释）\n</p>
<p>id: 1001\n</p>
<p>event: notice\n</p>
<p>data: 系统将在10分钟后维护\n\n</p>
<p>id: 1002\n</p>
<p>event: order\n</p>
<p>data: {"orderId": "20230501", "status": "paid"}\n\n</p>
<p>retry: 10000\n</p>
<p>id: 1003\n</p>
<p>data: 重连间隔已调整为10秒\n\n</p>
<p>: 这是保持连接活动的注释行\n</p>
<p>: 服务器时间 2023-10-05T12:00:00\n</p>
</blockquote>
<p><strong>客户端接收后：</strong></p>
<ul>
<li>
<p>1）notice事件会捕获到"系统将在10分钟后维护"</p>
</li>
<li>
<p>2）order事件会捕获到订单JSON数据</p>
</li>
<li>
<p>3）重连间隔被设置为10秒</p>
</li>
<li>
<p>4）最后收到的消息ID是1003（断线重连时会携带）</p>
</li>
</ul>
<p>通过以上规范，服务器就能轻松实现SSE功能，向客户端实时推送数据。相比WebSocket，SSE的服务器实现更简单，无需处理复杂的协议握手，只需按格式发送文本数据即可。</p>
<h2 data-id="heading-24">11、SSE实战代码示例（基于Spring Boot的实时通信）</h2>
<p>接下来， 通过一个完整案例 手把手教你用Spring Boot实现SSE功能。这个案例包含服务端（后端）和客户端（前端）代码， 可以直接运行体验服务器主动推送数据的效果。</p>
<h5 data-id="heading-25">11.1 案例整体架构</h5>
<p><strong>我们要实现的系统包含三个核心部分：</strong></p>
<ul>
<li>
<p>1）后端服务：基于Spring Boot，提供SSE连接接口、消息广播接口和任务进度推送接口；</p>
</li>
<li>
<p>2）前端页面：一个简单的HTML页面，通过EventSource与后端建立SSE连接；</p>
</li>
<li>
<p>3）交互流程：客户端连接后，可接收服务器主动推送的连接状态、广播消息和任务进度。</p>
</li>
</ul>
<p><strong>整体架构流程图：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15a1251ea50746e7b078d4efa0436ff8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=cQlKKS8y6JJ1CH5hd8wq1zvtSkA%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-26">11.2 服务端实现</h5>
<p><strong>11.2.1）准备依赖：</strong></p>
<p>首先创建Spring Boot项目，在pom.xml中添加以下依赖（用于web开发和页面渲染）：</p>
<blockquote>



<p>org.springframework.boot</p>
<p>spring-boot-starter-web</p>



<p>org.springframework.boot</p>
<p>spring-boot-starter-thymeleaf</p>


</blockquote>
<p>这些依赖是基础：spring-boot-starter-web提供了SSE核心类SseEmitter，spring-boot-starter-thymeleaf用于将HTML页面返回给浏览器。</p>
<p><strong>11.2.2）编写SSE核心控制器：</strong></p>
<p>创建SseController，这是服务端处理SSE连接和消息推送的核心类：</p>
<blockquote>
<p>package com.example.sse.controller;</p>
<p>import org.springframework.http.MediaType;</p>
<p>import org.springframework.web.bind.annotation.GetMapping;</p>
<p>import org.springframework.web.bind.annotation.RequestParam;</p>
<p>import org.springframework.web.bind.annotation.RestController;</p>
<p>import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;</p>
<p>import java.io.IOException;</p>
<p>import java.util.concurrent.CopyOnWriteArrayList;</p>
<p>import java.util.concurrent.ExecutorService;</p>
<p>import java.util.concurrent.Executors;</p>
<p>@RestController</p>
<p>public class SseController {</p>
<p>// 存储所有活跃的SSE连接（线程安全的列表）</p>
<p>// CopyOnWriteArrayList适合读多写少场景，避免并发问题</p>
<p>private final CopyOnWriteArrayList emitters = new CopyOnWriteArrayList&lt;&gt;();</p>
<p>// 线程池：用于异步发送事件，避免阻塞主线程</p>
<p>private final ExecutorService executor = Executors.newCachedThreadPool();</p>
<p>/</p>
<p>* 客户端订阅SSE的接口</p>
<p>* 客户端通过访问该接口建立长连接，接收服务器推送的事件</p>
<p>*/</p>
<p>@GetMapping(value = "/sse/subscribe", produces = MediaType.TEXT_EVENT_STREAM_VALUE)</p>
<p>public SseEmitter subscribe() {</p>
<p>// 创建SseEmitter实例，设置超时时间为无限（默认30秒会超时，这里设为Long.MAX_VALUE避免自动断开）</p>
<p>SseEmitter emitter = new SseEmitter(Long.MAX_VALUE);</p>
<p>// 将新连接加入活跃列表（后续推送消息时会遍历这个列表）</p>
<p>emitters.add(emitter);</p>
<p>// 设置连接完成/超时的回调：从活跃列表中移除该连接，释放资源</p>
<p>emitter.onCompletion(() -&gt; emitters.remove(emitter)); // 连接正常关闭时</p>
<p>emitter.onTimeout(() -&gt; emitters.remove(emitter)); // 连接超时关闭时</p>
<p>// 发送初始连接成功消息（给客户端的"欢迎消息"）</p>
<p>try {</p>
<p>emitter.send(SseEmitter.event()</p>
<p>.name("CONNECTED") // 事件名称：客户端可通过"CONNECTED"事件监听</p>
<p>.data("You are successfully connected to SSE server!") // 消息内容</p>
<p>.reconnectTime(5000)); // 告诉客户端：如果断开连接，5秒后重连</p>
<p>} catch (IOException e) {</p>
<p>// 发送失败时，标记连接异常结束</p>
<p>emitter.completeWithError(e);</p>
<p>}</p>
<p>return emitter; // 将emitter返回给客户端，保持连接</p>
<p>}</p>
<p>/</p>
<p>* 广播消息接口：向所有已连接的客户端推送消息</p>
<p>* 可通过浏览器访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Fsse%2Fbroadcast%3Fmessage%3Dxxx" target="_blank" title="http://localhost:8080/sse/broadcast?message=xxx" ref="nofollow noopener noreferrer">http://localhost:8080/sse/broadcast?message=xxx</a> 触发</p>
<p>/</p>
<p>@GetMapping("/sse/broadcast")</p>
<p>public String broadcastMessage(@RequestParam String message) {</p>
<p>// 用线程池异步执行广播，避免阻塞当前请求</p>
<p>executor.execute(() -&gt; {</p>
<p>// 遍历所有活跃连接，逐个发送消息</p>
<p>for (SseEmitter emitter : emitters) {</p>
<p>try {</p>
<p>emitter.send(SseEmitter.event()</p>
<p>.name("BROADCAST") // 事件名称：客户端监听"BROADCAST"事件</p>
<p>.data(message) // 广播的消息内容</p>
<p>.id(String.valueOf(System.currentTimeMillis()))); // 消息ID（用于重连时定位）</p>
<p>} catch (IOException e) {</p>
<p>// 发送失败（可能客户端已断开），从列表中移除并标记连接结束</p>
<p>emitters.remove(emitter);</p>
<p>emitter.completeWithError(e);</p>
<p>}</p>
<p>}</p>
<p>});</p>
<p>return "Broadcast message: " + message; // 给调用者的响应</p>
<p>}</p>
<p>/</p>
<p>* 模拟长时间任务：向客户端推送实时进度</p>
<p>* 适合文件上传、数据处理等需要实时反馈进度的场景</p>
<p>/</p>
<p>@GetMapping("/sse/start-task")</p>
<p>public String startTask() {</p>
<p>// 异步执行任务，避免阻塞当前请求</p>
<p>executor.execute(() -&gt; {</p>
<p>try {</p>
<p>// 模拟任务进度：从0%到100%，每次增加10%</p>
<p>for (int i = 0; i &lt;= 100; i += 10) {</p>
<p>Thread.sleep(1000); // 休眠1秒，模拟处理耗时</p>
<p>// 向所有客户端推送当前进度</p>
<p>for (SseEmitter emitter : emitters) {</p>
<p>try {</p>
<p>emitter.send(SseEmitter.event()</p>
<p>.name("PROGRESS") // 事件名称：客户端监听"PROGRESS"事件</p>
<p>.data(i + "% completed") // 进度数据</p>
<p>.id("task-progress")); // 固定ID，标识这是任务进度消息</p>
<p>} catch (IOException e) {</p>
<p>// 发送失败，移除连接</p>
<p>emitters.remove(emitter);</p>
<p>}</p>
<p>}</p>
<p>// 任务完成时，发送结束消息</p>
<p>if (i == 100) {</p>
<p>for (SseEmitter emitter : emitters) {</p>
<p>try {</p>
<p>emitter.send(SseEmitter.event()</p>
<p>.name("COMPLETE") // 事件名称：客户端监听"COMPLETE"事件</p>
<p>.data("Task completed successfully!"));</p>
<p>} catch (IOException e) {</p>
<p>emitters.remove(emitter);</p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>} catch (InterruptedException e) {</p>
<p>// 任务被中断时，恢复线程中断状态并退出</p>
<p>Thread.currentThread().interrupt();</p>
<p>break;</p>
<p>}</p>
<p>});</p>
<p>return "Task started!"; // 告诉调用者任务已启动</p>
<p>}</p>
<p>}</p>
</blockquote>
<p>核心代码说明：</p>
<ul>
<li>
<p>1）SseEmitter：Spring提供的SSE核心类，每个实例对应一个客户端连接；</p>
</li>
<li>
<p>2）emitters列表：管理所有活跃连接，方便广播消息（类似"客户端注册表"）；</p>
</li>
<li>
<p>3）executor线程池：异步处理消息发送，避免阻塞主线程（如果同步发送，一个客户端卡住会影响所有用户）。</p>
</li>
</ul>
<p>事件发送：通过</p>
<p>emitter.send(SseEmitter.event())</p>
<p>构建消息，可指定事件名、数据、ID和重连时间。</p>
<p><strong>11.2.3）编写页面控制器：</strong></p>
<p>创建PageController，用于将前端页面返回给浏览器：</p>
<blockquote>
<p>package com.example.sse.controller;</p>
<p>import org.springframework.stereotype.Controller;</p>
<p>import org.springframework.web.bind.annotation.GetMapping;</p>
<p>@Controller // 注意这里用@Controller而非@RestController，用于返回页面</p>
<p>public class PageController {</p>
<p>/*</p>
<p>* 访问根路径时，返回SSE客户端页面</p>
<p>/</p>
<p>@GetMapping("/")</p>
<p>public String index() {</p>
<p>// 返回src/main/resources/templates目录下的sse-client.html</p>
<p>return "sse-client";</p>
<p>}</p>
<p>}</p>
</blockquote>
<h5 data-id="heading-27">11.3 客户端实现（HTML页面）</h5>
<p>在</p>
<p>src/main/resources/templates</p>
<p>目录下创建</p>
<p>sse-client.html</p>
<p>，这是用户交互的前端页面：</p>
<blockquote>
<p>Server-Sent Events (SSE) Client Connect to SSE Disconnect Send Broadcast Start Task Messages:</p>
</blockquote>
<p>客户端核心逻辑：</p>
<ul>
<li>
<p>1）eventSource：EventSource实例，是客户端与服务端SSE连接的"桥梁"；</p>
</li>
<li>
<p>2）事件监听：通过addEventListener监听服务端定义的事件（CONNECTED/BROADCAST等）；</p>
</li>
<li>
<p>3）自动重连：当连接断开时，EventSource会自动重试（无需手动写重连逻辑）；</p>
</li>
<li>
<p>4）交互函数：connectSSE/disconnectSSE等函数对应页面按钮，实现用户操作。</p>
</li>
</ul>
<h5 data-id="heading-28">11.4 运行与测试</h5>
<p>启动步骤：</p>
<ul>
<li>
<p>1）确保Spring Boot项目配置正确（默认端口8080，无需额外配置）；</p>
</li>
<li>
<p>2）启动Spring Boot应用（运行带有main方法的启动类）；</p>
</li>
<li>
<p>3）打开浏览器，访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2F%25EF%25BC%258C%25E7%259C%258B%25E5%2588%25B0%25E5%25AE%25A2%25E6%2588%25B7%25E7%25AB%25AF%25E9%25A1%25B5%25E9%259D%25A2%25E3%2580%2582" target="_blank" title="http://localhost:8080/%EF%BC%8C%E7%9C%8B%E5%88%B0%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%A1%B5%E9%9D%A2%E3%80%82" ref="nofollow noopener noreferrer">http://localhost:8080/，看到客户端页面。</a></p>
</li>
</ul>
<p>功能测试：</p>
<ul>
<li>
<p>1）建立连接：点击"Connect to SSE"按钮，页面会显示"连接成功"的消息（服务端通过CONNECTED事件推送）</p>
</li>
<li>
<p>2）发送广播：点击"Send Broadcast"按钮，输入任意消息（如"Hello SSE"），页面会显示广播消息（服务端向所有连接的客户端推送）</p>
</li>
<li>
<p>3）启动任务：点击"Start Task"按钮，页面会每秒收到一条进度消息（从0%到100%），最后显示"任务完成"</p>
</li>
<li>
<p>4）断开连接：点击"Disconnect"按钮，连接关闭，不再接收消息。</p>
</li>
</ul>
<p>测试流程图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb6bb445b3ea4f69b8b9f8fe29820d79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=ZoLX8oLsfdVda7NTuAMb3DGdzgY%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-29">11.5 服务端的关键技术点</h5>
<p>1）SseEmitter的作用：Spring封装的SSE工具类，简化了"保持连接+发送事件"的实现，无需手动处理HTTP流格式。</p>
<p>2）连接管理：用CopyOnWriteArrayList存储活跃连接，确保线程安全；通过onCompletion/onTimeout回调清理无效连接，避免内存泄漏。</p>
<p>3）异步处理：必须用线程池（ExecutorService）异步发送消息，否则会阻塞主线程，导致新请求无法处理。</p>
<p>4）事件设计：通过name区分不同类型的事件（如PROGRESS/BROADCAST），客户端按需监听，逻辑更清晰。</p>
<p>5）自动重连：SSE客户端（EventSource）内置重连机制，网络恢复后会自动重新连接，无需额外代码。</p>
<p>通过这个案例，你可以清晰看到SSE的优势：实现简单（几行代码就能建立实时连接）、无需额外协议（基于HTTP）、自带重连机制。如果你的场景只需要服务器单向推送数据（如实时通知、进度更新），SSE会是比WebSocket更轻量的选择。</p>
<h2 data-id="heading-30">12、选SSE还是选WebSocket？</h2>
<h5 data-id="heading-31">12.1 SSE与WebSocket全面对比</h5>
<p>来对 Server-Sent Events (SSE) 和 WebSocket 进行一场全面、深入的对比。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6aaebc4c98a043faa9175d85e4e5b65a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=DMePC%2BYwZs%2BruJ4QjQTwsX3O7a0%3D" alt="" loading="lazy"/></p>
<p>为了更直观地理解两者的工作模式差异，请看下面的序列图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/438907c5f6d244a0ab1a0aa47fa198a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=qHrXbnWmuFp7VgX4bdHMB89jwb0%3D" alt="" loading="lazy"/></p>
<p><strong>1）协议与连接建立：</strong></p>
<p>SSE 协议与连接建立：</p>
<ul>
<li>a. 基于纯粹的 HTTP。客户端发起一个普通的 HTTP GET 请求，并携带特殊的头 Accept: text/event-stream。</li>
<li>b. 服务器响应后，保持这个 TCP 连接打开，并开始发送数据流 ，直到遇到结束标记。</li>
<li>c. 这是一种长连接的 HTTP 用法。</li>
</ul>
<p>WebSocket 协议与连接建立：</p>
<ul>
<li>a. 基于独立的 WebSocket 协议。连接始于一个特殊的 HTTP 请求，即 “协议升级”请求（Connection: Upgrade, Upgrade: websocket）。</li>
<li>b. 服务器响应 HTTP 101 Switching Protocols 后，最初的 HTTP 连接被替换为 WebSocket 连接，此后通信不再遵循 HTTP 协议，而是在其之上建立一个全双工的通道。</li>
</ul>
<p><strong>2）数据流与通信模式：</strong></p>
<p>SSE：单向通信。设计初衷就是让服务器能够主动、高效地向客户端推送数据。•数据是文本流，格式简单且可读性强。每条消息可以附带一个事件类型（event:）和一个ID（id:）。•客户端使用 EventSource API 监听来自服务器的事件。</p>
<p>WebSocket：全双工通信。在连接建立后，客户端和服务器处于完全平等的地位，可以随时、任意地相互发送消息。 另外，WS协议 支持文本和二进制数据，灵活性极高，非常适合需要频繁双向交互的场景（如游戏、协作编辑）。</p>
<p><strong>3）能力与特性：</strong></p>
<p>SSE：内置自动重连机制。如果连接断开，EventSource 对象会自动尝试重新连接，并在重连后自动发送上一个收到的事件ID，服务器据此可判断错过了哪些消息，实现数据恢复。SSE有出色的浏览器支持。所有现代浏览器（Chrome, Firefox, Safari, Edge）都原生支持，Internet Explorer （古代浏览器）完全不支持（通常需要 polyfill 或降级方案）。</p>
<p>WebSocket：无自动重连。连接断开后，需要开发者手动编写重连逻辑和状态恢复逻辑。WS协议比SSE协议有更广泛的浏览器支持，包括 Internet Explorer 10+。</p>
<p><strong>4）开发与集成：</strong></p>
<p>SSE：开发与集成 非常简单。服务器端几乎不需要特殊的库，任何能输出 HTTP 流的后端语言都可以实现。客户端 API 也非常直观。与现有 HTTP 认证、CORS 机制完全兼容，处理方式与普通 HTTP 请求一致。</p>
<p>WebSocket：开发与集成 相对复杂。服务器端需要支持 WebSocket 协议的库（如 ws for Node.js, Socket.IO 等）。客户端需要处理连接状态、心跳包等。 虽然升级握手是 HTTP，但后续通信是独立协议，因此一些复杂的网络环境（如某些代理服务器）可能会带来问题。</p>
<h5 data-id="heading-32">12.2 SSE与WebSocket到底该如何选择？</h5>
<p>选择的关键在于应用场景和核心需求。</p>
<p><strong>* 选择 SSE 的场景：</strong></p>
<p>选择 SSE 的场景包括：</p>
<ul>
<li>
<p>1）服务器到客户端的单向数据流。</p>
</li>
<li>
<p>2）简单和快速实现是关键因素。</p>
</li>
<li>
<p>3）需要自动错误恢复（重连）。</p>
</li>
<li>
<p>4）数据传输格式是文本（如 JSON），且不需要二进制。</p>
</li>
</ul>
<p>SSE 典型的应用场景包括：</p>
<ul>
<li>
<p>1）实时新闻推送、体育比分更新。</p>
</li>
<li>
<p>2）金融报价行情（如股票价格变动）。</p>
</li>
<li>
<p>3）社交媒体动态更新（如 Twitter 时间线）。</p>
</li>
<li>
<p>4）服务器日志流监控。</p>
</li>
<li>
<p>5）AI 处理进度或结果的流式输出。</p>
</li>
</ul>
<p><strong>* 选择 WebSocket 场景：</strong></p>
<p>选择 WebSocket 的场景包括：</p>
<ul>
<li>
<p>1）真正的实时双向通信，客户端和服务器都需要频繁地发送消息。</p>
</li>
<li>
<p>2）需要传输二进制数据（如视频、音频、图像碎片）。</p>
</li>
<li>
<p>3）构建交互性极强的应用，其中低延迟至关重要。</p>
</li>
</ul>
<p>WebSocket 典型的应用场景包括：</p>
<ul>
<li>
<p>1）实时在线聊天应用（如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fslack.com%2F" target="_blank" title="https://slack.com/" ref="nofollow noopener noreferrer">Slack</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fmusclegrowth.net%2Fdiscord%2F" target="_blank" title="https://musclegrowth.net/discord/" ref="nofollow noopener noreferrer">Discord</a>、<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2470-1-1.html" target="_blank" title="http://www.52im.net/thread-2470-1-1.html" ref="nofollow noopener noreferrer">RainbowChat-Web</a>）。</p>
</li>
<li>
<p>2）多人在线游戏。</p>
</li>
<li>
<p>3）协同编辑工具（如 Google Docs）。</p>
</li>
<li>
<p>4）实时仪表盘和控制面板（需要双向控制）。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccbb02df35914642b1af8b1ae92e580f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=d33l0IdL4Gmaepr82YE11B4vdV0%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-33">12.3 WebSocket+SSE 混合架构</h5>
<p>一般来说大型应用场景，强网用 WebSocket、弱网适合使用SSE ，这就是WebSocket+SSE 混合架构。强网用 WebSocket、弱网自动降级到 SSE 的混合架构， 核心在于网络质量动态评估和双通道无缝切换。</p>
<p><strong>WebSocket+SSE 混合架构 具体实现方案如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c069ed9bfa5444b8bcb36247cb488dfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=Y3ueSABULQ%2FNO8kUKux683cJn4U%3D" alt="" loading="lazy"/></p>
<p>核心模块：网络质量探针（客户端） 实现</p>
<blockquote>
<p>class NetworkProbe {</p>
<p>// 关键指标</p>
<p>static RTT_THRESHOLD = 300 // RTT超过300ms视为弱网</p>
<p>static PACKET_LOSS_THRESHOLD = 0.2 // 丢包率&gt;20%触发降级</p>
<p>// 网络状态检测</p>
<p>async check() {</p>
<p>const { rtt, packetLoss } = await this._measure()</p>
<p>return {</p>
<p>isWeak: rtt &gt; NetworkProbe.RTT_THRESHOLD ||</p>
<p>packetLoss &gt; NetworkProbe.PACKET_LOSS_THRESHOLD</p>
<p>}</p>
<p>}</p>
<p>// 实际测量方法</p>
<p>_measure() {</p>
<p>return new Promise(resolve =&gt; {</p>
<p>const start = Date.now()</p>
<p>fetch('/ping', { cache: 'no-store' })</p>
<p>.then(() =&gt; {</p>
<p>const rtt = Date.now() - start</p>
<p>resolve({ rtt, packetLoss: 0 })</p>
<p>})</p>
<p>.catch(() =&gt; resolve({ rtt: Infinity, packetLoss: 1 }))</p>
<p>})</p>
<p>}</p>
<p>}</p>
</blockquote>
<p>核心模块：双协议连接管理器（客户端）</p>
<blockquote>
<p>class HybridConnection {</p>
<p>constructor() {</p>
<p>this.currentProtocol = null</p>
<p>this.ws = null</p>
<p>this.sse = null</p>
<p>this.messageQueue = [] // 消息缓冲队列</p>
<p>}</p>
<p>// 智能连接初始化</p>
<p>async connect() {</p>
<p>const { isWeak } = await new NetworkProbe().check()</p>
<p>this.currentProtocol = isWeak ? 'sse' : 'ws'</p>
<p>if (this.currentProtocol === 'ws') {</p>
<p>this._initWebSocket()</p>
<p>} else {</p>
<p>this._initSSE()</p>
<p>}</p>
<p>}</p>
<p>// WebSocket初始化</p>
<p>_initWebSocket() {</p>
<p>this.ws = new WebSocket('wss://api.example.com')</p>
<p>this.ws.onmessage = this._handleMessage</p>
<p>// 发送缓冲队列消息</p>
<p>this.messageQueue.forEach(msg =&gt; this.ws.send(msg))</p>
<p>this.messageQueue = []</p>
<p>}</p>
<p>// SSE初始化</p>
<p>_initSSE() {</p>
<p>this.sse = new EventSource('<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.example.com%2Fsse" target="_blank" title="https://api.example.com/sse" ref="nofollow noopener noreferrer">api.example.com/sse</a>')</p>
<p>this.sse.onmessage = this._handleMessage</p>
<p>}</p>
<p>// 统一消息处理</p>
<p>_handleMessage = (event) =&gt; {</p>
<p>const data = event.data || event</p>
<p>// 业务逻辑处理...</p>
<p>}</p>
<p>// 发送消息（自动选择协议）</p>
<p>send(data) {</p>
<p>if (this.currentProtocol === 'ws' &amp;&amp; this.ws?.readyState === 1) {</p>
<p>this.ws.send(JSON.stringify(data))</p>
<p>} else if (this.currentProtocol === 'sse') {</p>
<p>// SSE需通过独立HTTP请求发送</p>
<p>fetch('/send', { method: 'POST', body: JSON.stringify(data) })</p>
<p>} else {</p>
<p>// 协议切换中暂存消息</p>
<p>this.messageQueue.push(JSON.stringify(data))</p>
<p>}</p>
<p>}</p>
<p>// 协议切换（核心！）</p>
<p>async switchProtocol() {</p>
<p>const { isWeak } = await new NetworkProbe().check()</p>
<p>// 无需切换</p>
<p>if (isWeak &amp;&amp; this.currentProtocol === 'sse') return</p>
<p>if (!isWeak &amp;&amp; this.currentProtocol === 'ws') return</p>
<p>// 执行切换</p>
<p>if (isWeak) {</p>
<p>this.ws?.close()</p>
<p>this._initSSE()</p>
<p>this.currentProtocol = 'sse'</p>
<p>} else {</p>
<p>this.sse?.close()</p>
<p>this._initWebSocket()</p>
<p>this.currentProtocol = 'ws'</p>
<p>}</p>
<p>}</p>
<p>}</p>
</blockquote>
<h5 data-id="heading-34">12.4 AI大模型中该选择SSE协议还是WebSocket？</h5>
<p>直接答案：对于绝大多数 chat2ai 应用 优先选择 SSE (Server-Sent Events)。复杂的 chat2ai 应用 优先选择WebSocket。</p>
<p>但这并非绝对，我们需要根据具体的功能需求来决定。下面我将为你进行详细的分析和推理。</p>
<p><strong>12.4.1）核心决策分析：</strong></p>
<p>AI聊天应用的核心交互是：</p>
<ul>
<li>
<p>1）</p>
<p>客户端发送一条消息（一个问题）。</p>
</li>
<li>
<p>2）</p>
<p>服务器接收后，调用大语言模型（LLM）API。</p>
</li>
<li>
<p>3）</p>
<p>服务器将模型流式返回的答案（逐词或逐句）实时推送给客户端。</p>
</li>
<li>
<p>4）</p>
<p>客户端实时渲染这个流式的答案，营造出“打字机”效果。</p>
</li>
</ul>
<p>这个过程的关键在于第3步，即服务器向客户端的单向数据推送。这正是 SSE 的绝对主场。</p>
<p><strong>12.4.2）为什么 SSE 是更优的选择？</strong></p>
<p>以下流程图清晰地展示了基于不同技术方案的聊天交互过程，其中突出了SSE方案的巨大优势：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf8e057bbe924ce19a235f05af351f54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=KPobLykKPNjUCWRdG0lcrdAsONY%3D" alt="" loading="lazy"/></p>
<p>正如上图所示：SSE 方案在实现上更加直接和高效，因为它基于 HTTP，并且专门为服务器到客户端的单向数据流设计。</p>
<p>此外，SSE 还带来了以下巨大优势：</p>
<p><strong>1）</strong> <strong>开发复杂度极低：</strong></p>
<ul>
<li>a. 后端：你不需要引入任何复杂的 WebSocket 库（如 ws, Socket.IO）。你只需要建立一个普通的 HTTP 路由（如 POST /chat 用于发送消息，GET /chat/stream 用于接收流），并在控制器中输出 text/event-stream 格式的响应流。</li>
<li>b. 前端：使用浏览器原生的 EventSource API 即可轻松监听数据流，几行代码就能实现。无需实例化和管理 WebSocket 连接对象。</li>
</ul>
<p><strong>2）</strong> <strong>出色的兼容性与可维护性：</strong></p>
<ul>
<li>a. SSE 基于 HTTP，这意味着它更容易通过公司防火墙、代理，与现有的认证系统（如 Cookie、JWT）、CORS 策略协同工作，几乎不会遇到奇怪的网络问题。</li>
<li>b. 在浏览器“网络”选项卡中，SSE 的流清晰可见，易于调试。每个消息都是可读的文本，调试体验非常好。</li>
</ul>
<p><strong>3）</strong> <strong>内置的自动重连与断点续传机制：</strong></p>
<ul>
<li>a. 这是 SSE 的“杀手级特性”。网络连接不稳定是移动端的常见问题。如果用户在接收一个很长答案的过程中网络中断，SSE 会在网络恢复后自动重新连接。</li>
<li>b. 更强大的是，SSE 协议支持发送最后一个消息的 ID。服务器可以识别出这个 ID，并判断客户端错过了哪些数据，从而从断点处继续发送，而不是重新开始生成整个回答。这既节省了昂贵的 API 调用费用，也提升了用户体验。这在 WebSocket 中需要手动实现所有逻辑，非常复杂。</li>
</ul>
<p><strong>12.4.3）WebSocket 的适用场景：</strong></p>
<p>虽然 SSE 是主流选择，但在 chat2ai 应用变得非常复杂时，WebSocket 可能会成为更好的选择。</p>
<p>在以下情况下， 应该考虑使用 WebSocket：</p>
<p><strong>1）</strong> 需要极高频的双向通信：不仅仅是用户提问-&gt;AI回答。例如：</p>
<ul>
<li>a. 实时协作编辑：多个用户同时编辑一份由 AI 生成的文档，每个人的输入都需要实时同步给其他所有人。</li>
<li>b. AI多人游戏：基于 AI 生成剧情和环境的实时互动游戏，玩家的每一个动作都需要实时影响虚拟世界。</li>
</ul>
<p><strong>2）</strong> 当需要传输二进制数据的时候：有的聊天应用不仅支持文本，还支持实时语音对话（客户端录音发送二进制音频流，服务器返回 AI 语音二进制流）。WebSocket 对二进制数据的支持是天生的。</p>
<p><strong>3）</strong> 你需要非常精确的控制心跳和连接状态： - WebSocket 允许 手动发送 Ping/Pong 帧来检测连接活性，虽然复杂，但给了开发人员最大的控制权。</p>
<h5 data-id="heading-35">12.4.4）传输协议选型 结论与建议：</h5>
<p>1）起步和绝大多数情况：从 SSE 开始。这是最直接、最高效、最能给你带来稳定体验的选择。使用sse 遇到的技术挑战会更少，开发速度更快。ChatGPT、Claude 等绝大多数顶级应用都使用 SSE 不是没有道理的。</p>
<p>2）未来如果需要扩展：采用混合架构。如果应用未来需要加入上述 WebSocket 的适用功能（如实时语音），完全可以同时使用两种协议：使用 SSE 专门处理 AI 文本答案的流式推送。使用 WebSocket 专门处理 实时语音、实时协作等真正的双向通信功能。或者 强弱结合，自动切换。</p>
<p>因此，对于 chat2ai 的传输协议选型答案是：优先选择 SSE。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/484ea894f46647a2a980d06fe567a49d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFja0ppYW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080075&amp;x-signature=kFA89ymF3MXJCMN9K%2FR9e6%2FjFvY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-36">13、参考资料</h2>
<p>[0] <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FEventSource" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource" ref="nofollow noopener noreferrer">EventSource API Docs</a></p>
<p>[1] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-336-1-1.html" target="_blank" title="http://www.52im.net/thread-336-1-1.html" ref="nofollow noopener noreferrer">Web端即时通讯技术盘点：短轮询、Comet、Websocket、SSE</a></p>
<p>[2] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-335-1-1.html" target="_blank" title="http://www.52im.net/thread-335-1-1.html" ref="nofollow noopener noreferrer">SSE技术详解：一种全新的HTML5服务器推送事件技术</a></p>
<p>[3] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-907-1-1.html" target="_blank" title="http://www.52im.net/thread-907-1-1.html" ref="nofollow noopener noreferrer">使用WebSocket和SSE技术实现Web端消息推送</a></p>
<p>[4] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-1038-1-1.html" target="_blank" title="http://www.52im.net/thread-1038-1-1.html" ref="nofollow noopener noreferrer">详解Web端通信方式的演进：从Ajax、JSONP 到 SSE、Websocket</a></p>
<p>[5] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-907-1-1.html" target="_blank" title="http://www.52im.net/thread-907-1-1.html" ref="nofollow noopener noreferrer">使用WebSocket和SSE技术实现Web端消息推送</a></p>
<p>[6] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2719-1-1.html" target="_blank" title="http://www.52im.net/thread-2719-1-1.html" ref="nofollow noopener noreferrer">一文读懂前端技术演进：盘点Web前端20年的技术变迁史</a></p>
<p>[7] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3134-1-1.html" target="_blank" title="http://www.52im.net/thread-3134-1-1.html" ref="nofollow noopener noreferrer">WebSocket从入门到精通，半小时就够！</a></p>
<p>[8] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3555-1-1.html" target="_blank" title="http://www.52im.net/thread-3555-1-1.html" ref="nofollow noopener noreferrer">网页端IM通信技术快速入门：短轮询、长轮询、SSE、WebSocket</a></p>
<p>[9] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3695-1-1.html" target="_blank" title="http://www.52im.net/thread-3695-1-1.html" ref="nofollow noopener noreferrer">搞懂现代Web端即时通讯技术一文就够：WebSocket、socket.io、SSE</a></p>
<p>[10] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4831-1-1.html" target="_blank" title="http://www.52im.net/thread-4831-1-1.html" ref="nofollow noopener noreferrer">大模型时代多模型AI网关的架构设计与实现</a></p>
<p>[11] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4797-1-1.html" target="_blank" title="http://www.52im.net/thread-4797-1-1.html" ref="nofollow noopener noreferrer">全民AI时代，大模型客户端和服务端的实时通信到底用什么协议？</a></p>
<p>[12] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4856-1-1.html" target="_blank" title="http://www.52im.net/thread-4856-1-1.html" ref="nofollow noopener noreferrer">通俗易懂：AI大模型基于SSE的实时流式响应技术原理和实践示例</a></p>
<p>[13] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4832-1-1.html" target="_blank" title="http://www.52im.net/thread-4832-1-1.html" ref="nofollow noopener noreferrer">Web端实时通信技术SSE在携程机票业务中的实践应用</a></p>
<p>[14] <a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4872-1-1.html" target="_blank" title="http://www.52im.net/thread-4872-1-1.html" ref="nofollow noopener noreferrer">ChatGPT如何实现聊天一样的实时交互？快速读懂SSE实时“推”技术</a></p>
<p>（本文已同步发布于：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4885-1-1.html" target="_blank" title="http://www.52im.net/thread-4885-1-1.html" ref="nofollow noopener noreferrer">www.52im.net/thread-4885…</a>）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java线程协作工具：CountDownLatch 、CyclicBarrier、Phaser、Semaphore 、Exchanger]]></title>    <link>https://juejin.cn/post/7586687526866714639</link>    <guid>https://juejin.cn/post/7586687526866714639</guid>    <pubDate>2025-12-23T07:48:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586687526866714639" data-draft-id="7586687526866698255" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java线程协作工具：CountDownLatch 、CyclicBarrier、Phaser、Semaphore 、Exchanger"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T07:48:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="马卡巴卡"/> <meta itemprop="url" content="https://juejin.cn/user/1892677617451163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java线程协作工具：CountDownLatch 、CyclicBarrier、Phaser、Semaphore 、Exchanger
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1892677617451163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    马卡巴卡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:48:27.000Z" title="Tue Dec 23 2025 07:48:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在高并发系统中，多个线程之间的协作是不可避免的。Java 从 JDK 1.5 开始引入了 <code>java.util.concurrent</code>（JUC）包，其中包含了一系列强大的线程协作工具类，极大简化了并发编程的复杂性。</p>
<h2 data-id="heading-0">CountDownLatch（JDK 5+）：倒计时门闩</h2>
<h3 data-id="heading-1">使用场景</h3>
<p><code>CountDownLatch</code> 常用于“一个或多个线程等待其他线程完成任务后再继续执行”的场景，例如：</p>
<ul>
<li>主线程等待所有子线程初始化完毕再启动服务。</li>
<li>并发测试中模拟 N 个请求同时发出后统计总耗时。</li>
<li>资源加载完成后统一触发后续逻辑。</li>
</ul>
<h3 data-id="heading-2">核心 API</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CountDownLatch</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> count</span>)</span>;        <span class="hljs-comment">// 初始化计数器</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">await</span>() throws InterruptedException</span>;          <span class="hljs-comment">// 阻塞等待计数归零</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> boolean <span class="hljs-title">await</span>(<span class="hljs-params"><span class="hljs-built_in">long</span> timeout, TimeUnit unit</span>)</span>;       <span class="hljs-comment">// 带超时的等待</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">countDown</span>()</span>;                                 <span class="hljs-comment">// 计数减一</span>
</code></pre>
<h3 data-id="heading-3">使用示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CountDownLatchExample</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>) throws InterruptedException</span> {
        <span class="hljs-built_in">int</span> threadCount = <span class="hljs-number">5</span>;
        CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(threadCount);

        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; threadCount; i++) {
            <span class="hljs-keyword">new</span> Thread(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    System.<span class="hljs-keyword">out</span>.println(Thread.currentThread().getName() + <span class="hljs-string">" 正在执行任务..."</span>);
                    Thread.sleep(<span class="hljs-number">1000</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                } <span class="hljs-keyword">finally</span> {
                    latch.countDown(); <span class="hljs-comment">// 任务完成，计数减一</span>
                }
            }).start();
        }

        latch.<span class="hljs-keyword">await</span>(); <span class="hljs-comment">// 主线程等待所有任务完成</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"所有任务已完成，主线程继续执行！"</span>);
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-erlang" lang="erlang">Thread-<span class="hljs-number">0</span> 正在执行任务...
Thread-<span class="hljs-number">1</span> 正在执行任务...
Thread-<span class="hljs-number">3</span> 正在执行任务...
Thread-<span class="hljs-number">2</span> 正在执行任务...
Thread-<span class="hljs-number">4</span> 正在执行任务...
所有任务已完成，主线程继续执行！
</code></pre>
<h3 data-id="heading-4">应用场景示例</h3>
<p><strong>服务启动检查：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 等待数据库、缓存、消息队列初始化完成</span>
CountDownLatch startupLatch = new <span class="hljs-built_in">CountDownLatch</span>(<span class="hljs-number">3</span>);
<span class="hljs-built_in">initDB</span>(startupLatch);
<span class="hljs-built_in">initCache</span>(startupLatch);
<span class="hljs-built_in">initMQ</span>(startupLatch);
startupLatch<span class="hljs-selector-class">.await</span>();
<span class="hljs-built_in">startHttpServer</span>();
</code></pre>
<h3 data-id="heading-5">使用注意点</h3>
<ul>
<li><strong>不可重用</strong>：一旦计数归零，无法再次使用（除非新建实例）。需要重复使用的场景应考虑 <code>CyclicBarrier</code>，</li>
<li>若某个线程未调用 <code>countDown()</code>，会导致主线程永久阻塞， 导致死锁，所以务必在 finally 块中调用。</li>
<li><code>await()</code> 可被中断，需处理 <code>InterruptedException</code>。</li>
</ul>
<h3 data-id="heading-6">底层原理</h3>
<p><code>CountDownLatch</code> 基于 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D267767541%26content_type%3DArticle%26match_order%3D1%26q%3DAQS%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=267767541&amp;content_type=Article&amp;match_order=1&amp;q=AQS&amp;zhida_source=entity" ref="nofollow noopener noreferrer">AQS</a>（AbstractQueuedSynchronizer）</strong>  实现：（AQS 原理详见<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fmp.weixin.qq.com%2Fs%2FYl1jxnE562TuUqq48rag4g" target="_blank" title="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/Yl1jxnE562TuUqq48rag4g" ref="nofollow noopener noreferrer">Java并发编程：Lock原理详解</a>）</p>
<ul>
<li>内部状态 <code>state</code> 表示剩余计数值。</li>
<li><code>await()</code> 对应 AQS 的 <code>acquireSharedInterruptibly(1)</code>，尝试获取共享锁，若 <code>state != 0</code> 则入队阻塞。</li>
<li><code>countDown()</code> 调用 <code>releaseShared(1)</code>，将 <code>state</code> 减 1，当 <code>state == 0</code> 时唤醒所有等待线程。</li>
</ul>
<h2 data-id="heading-7">CyclicBarrier（JDK 5+）：循环屏障</h2>
<h3 data-id="heading-8">使用场景</h3>
<p><code>CyclicBarrier</code> 适用于“多个线程互相等待，全部到达某一点后才能继续”的场景，例如：</p>
<ul>
<li>多线程分阶段计算（每阶段结束后汇总结果）。</li>
<li>游戏开发中等待所有玩家准备就绪。</li>
<li>并行算法中的同步点。</li>
</ul>
<h3 data-id="heading-9">核心 API</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CyclicBarrier</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> parties</span>)</span>; 
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CyclicBarrier</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> parties, Runnable barrierAction</span>)</span>; <span class="hljs-comment">// 所有线程到达后执行的动作</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">await</span>() throws InterruptedException, BrokenBarrierException</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">await</span>(<span class="hljs-params"><span class="hljs-built_in">long</span> timeout, TimeUnit unit</span>) throws ...</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reset</span>()</span>; <span class="hljs-comment">// 重置屏障（可能中断当前等待）</span>
</code></pre>
<h3 data-id="heading-10">使用示例</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CyclicBarrierExample</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        CyclicBarrier barrier = <span class="hljs-keyword">new</span> CyclicBarrier(<span class="hljs-number">3</span>, () -&gt; {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"所有线程已到达屏障，执行汇总操作！"</span>);
        });

        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
            <span class="hljs-keyword">new</span> Thread(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    System.<span class="hljs-keyword">out</span>.println(Thread.currentThread().getName() + <span class="hljs-string">" 第一阶段完成"</span>);
                    barrier.<span class="hljs-keyword">await</span>(); <span class="hljs-comment">// 等待其他线程</span>

                    System.<span class="hljs-keyword">out</span>.println(Thread.currentThread().getName() + <span class="hljs-string">" 第二阶段开始"</span>);
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    e.printStackTrace();
                }
            }).start();
        }
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs">Thread-1 第一阶段完成
Thread-2 第一阶段完成
Thread-0 第一阶段完成
所有线程已到达屏障，执行汇总操作！
Thread-0 第二阶段开始
Thread-1 第二阶段开始
Thread-2 第二阶段开始
</code></pre>
<h3 data-id="heading-11">应用场景示例</h3>
<p><strong>多轮并行计算：</strong></p>
<pre><code class="hljs language-ini" lang="ini">CyclicBarrier <span class="hljs-attr">barrier</span> = new CyclicBarrier(<span class="hljs-number">4</span>, this::aggregateResults)<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 4; i++) {</span>
    executor.submit(() -&gt; {
        while (round &lt; MAX_ROUNDS) {
            computePartialResult()<span class="hljs-comment">;</span>
            barrier.await()<span class="hljs-comment">; // 同步进入下一轮</span>
            round++<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-12">底层原理</h3>
<p><code>CyclicBarrier</code> 不基于 AQS，而是使用 <code>ReentrantLock</code> + <code>Condition</code> 实现：（Condition 原理详见<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fmp.weixin.qq.com%2Fs%2FYl1jxnE562TuUqq48rag4g" target="_blank" title="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/Yl1jxnE562TuUqq48rag4g" ref="nofollow noopener noreferrer">Java并发编程：Lock原理详解</a>）</p>
<ul>
<li>每次调用 <code>await()</code>，线程进入条件队列等待。</li>
<li>当最后一个线程到达时，唤醒所有等待线程，并执行 <code>barrierAction</code>（如有）。</li>
<li>完成后自动重置计数器，<strong>支持重复使用</strong>。</li>
</ul>
<p>若某个线程在等待期间被中断或超时，屏障将进入“损坏”（broken）状态，后续调用会抛出 <code>BrokenBarrierException</code>。</p>
<h3 data-id="heading-13">CyclicBarrier 与 CountDownLatch 的区别</h3>






























<table><thead><tr><th>特性</th><th>CountDownLatch</th><th>CyclicBarrier</th></tr></thead><tbody><tr><td>控制方向</td><td>一方等待多方</td><td>所有线程互相等待</td></tr><tr><td>是否可重用</td><td>❌</td><td>✅</td></tr><tr><td>是否支持回调</td><td>❌</td><td>✅（barrierAction）</td></tr><tr><td>底层实现</td><td>AQS</td><td>ReentrantLock + Condition</td></tr></tbody></table>
<h2 data-id="heading-14">Phaser（JDK 7+）：灵活的阶段同步器</h2>
<p><code>Phaser</code> 新增于 JDK 7，是对 <code>CyclicBarrier</code> 和 <code>CountDownLatch</code> 的强大扩展，支持动态注册参与者、多阶段同步和分层结构，适用于更复杂的并发协调场景。</p>
<h3 data-id="heading-15">使用场景</h3>
<ul>
<li>多阶段并行任务（如 Map-Reduce 的 map → shuffle → reduce）。</li>
<li>动态增减工作线程（例如任务中途加入新 worker）。</li>
<li>大规模并行计算中需要分组同步（通过分层 Phaser 实现）。</li>
<li>替代多个 <code>CyclicBarrier</code> 或 <code>CountDownLatch</code> 的组合逻辑。</li>
</ul>
<h3 data-id="heading-16">核心 API</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 构造方法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Phaser</span>()</span>;                     <span class="hljs-comment">// 无初始参与者</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Phaser</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> parties</span>)</span>;          <span class="hljs-comment">// 指定初始参与者数量</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Phaser</span>(<span class="hljs-params">Phaser parent</span>)</span>;        <span class="hljs-comment">// 构建父子分层结构</span>

<span class="hljs-comment">// 核心方法</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">register</span>()</span>;               <span class="hljs-comment">// 注册一个新参与者，返回当前阶段号</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">arrive</span>()</span>;                 <span class="hljs-comment">// 到达屏障，不等待</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">arriveAndAwaitAdvance</span>()</span>;  <span class="hljs-comment">// 到达并等待其他参与者</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">arriveAndDeregister</span>()</span>;    <span class="hljs-comment">// 到达并注销自己（退出后续阶段）</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> boolean <span class="hljs-title">isTerminated</span>()</span>;       <span class="hljs-comment">// 是否已终止（当参与者数为0时终止）</span>
</code></pre>
<h3 data-id="heading-17">使用示例</h3>
<p><strong>动态多阶段任务：</strong></p>
<pre><code class="hljs language-scss" lang="scss">public class PhaserExample {
    public static void <span class="hljs-selector-tag">main</span>(String[] args) {
        Phaser phaser = new <span class="hljs-built_in">Phaser</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 初始无参与者</span>

        <span class="hljs-comment">// 启动3个任务线程</span>
        for (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
            phaser<span class="hljs-selector-class">.register</span>(); <span class="hljs-comment">// 注册参与者</span>
            new <span class="hljs-built_in">Thread</span>(() -&gt; {
                try {
                    for (int phase = <span class="hljs-number">0</span>; phase &lt; <span class="hljs-number">3</span>; phase++) {
                        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(Thread.currentThread()<span class="hljs-selector-class">.getName</span>() 
                            + " 完成阶段 " + phase);
                        <span class="hljs-comment">// 到达屏障并等待其他线程</span>
                        phaser<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>();
                    }
                    <span class="hljs-comment">// 任务结束，注销自己</span>
                    phaser<span class="hljs-selector-class">.arriveAndDeregister</span>();
                } catch (Exception e) {
                    e<span class="hljs-selector-class">.printStackTrace</span>();
                }
            })<span class="hljs-selector-class">.start</span>();
        }

        <span class="hljs-comment">// 主线程等待所有阶段完成</span>
        while (!phaser.isTerminated()) {
            Thread<span class="hljs-selector-class">.yield</span>();
        }
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("所有阶段已完成！");
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs">Thread-1 完成阶段 0
Thread-2 完成阶段 0
Thread-0 完成阶段 0
Thread-0 完成阶段 1
Thread-2 完成阶段 1
Thread-1 完成阶段 1
Thread-2 完成阶段 2
Thread-1 完成阶段 2
Thread-0 完成阶段 2
所有阶段已完成！
</code></pre>
<h3 data-id="heading-18">高级特性：分层 Phaser</h3>
<p>当参与者数量极大（如数千线程）时，单一 <code>Phaser</code> 的同步开销会很高。此时可构建<strong>树状分层结构</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">Phaser root = new <span class="hljs-built_in">Phaser</span>();
Phaser group1 = new <span class="hljs-built_in">Phaser</span>(root); <span class="hljs-comment">// 子 Phaser，父为 root</span>
Phaser group2 = new <span class="hljs-built_in">Phaser</span>(root);

<span class="hljs-comment">// group1 内部线程只与同组同步，最终由 root 汇总</span>
group1<span class="hljs-selector-class">.register</span>();
new <span class="hljs-built_in">Thread</span>(() -&gt; {
    group1<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>(); <span class="hljs-comment">// 仅与 group1 同步</span>
})<span class="hljs-selector-class">.start</span>();
</code></pre>
<p>这种结构能显著减少锁竞争，提升大规模并发性能。、</p>
<h3 data-id="heading-19">应用场景示例</h3>
<p><strong>分阶段并行处理：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 模拟三阶段数据处理：加载 → 转换 → 输出</span>
Phaser phaser = new <span class="hljs-built_in">Phaser</span>(<span class="hljs-number">0</span>);

List&lt;Thread&gt; workers = IntStream<span class="hljs-selector-class">.range</span>(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>)
    <span class="hljs-selector-class">.mapToObj</span>(i -&gt; {
        phaser.register();
        return new <span class="hljs-built_in">Thread</span>(() -&gt; {
            <span class="hljs-built_in">load</span>();   phaser<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>();
            <span class="hljs-attribute">transform</span>(); phaser<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>();
            <span class="hljs-built_in">output</span>(); phaser<span class="hljs-selector-class">.arriveAndAwaitAdvance</span>();
            phaser<span class="hljs-selector-class">.arriveAndDeregister</span>();
        });
    })
    <span class="hljs-selector-class">.peek</span>(Thread::start)
    <span class="hljs-selector-class">.collect</span>(Collectors.toList());

<span class="hljs-comment">// 等待全部完成</span>
while (!phaser.isTerminated()) {
    Thread<span class="hljs-selector-class">.yield</span>();
}
</code></pre>
<h3 data-id="heading-20">底层原理</h3>
<p>不同于 <code>CountDownLatch</code> 和 <code>Semaphore</code>，<code>Phaser</code> <strong>未基于 AQS</strong>，而是自行实现同步机制，它的实现融合了 <strong>自旋锁 + 队列管理</strong>：</p>
<ul>
<li><strong>状态字段</strong>：使用一个 <code>long</code> 类型的 <code>state</code> 字段，高位存阶段号（phase），低位存参与者数量（parties）。</li>
<li><strong>自适应等待策略</strong>：</li>
<li>
<ul>
<li>参与者少时使用 <strong>自旋等待</strong>（低延迟）。</li>
<li>参与者多或等待时间长时，自动切换到 <strong>阻塞队列</strong>（节省 CPU）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-21">Phaser 与 CyclicBarrier 的对比</h3>













































<table><thead><tr><th>特性</th><th>CyclicBarrier</th><th>Phaser</th></tr></thead><tbody><tr><td>引入版本</td><td>JDK 1.5</td><td>JDK 1.7</td></tr><tr><td>是否可重用</td><td>✅（自动重置）</td><td>✅（阶段递增）</td></tr><tr><td>动态增减参与者</td><td>❌</td><td>✅（register() / arriveAndDeregister()）</td></tr><tr><td>分层支持</td><td>❌</td><td>✅（父子结构）</td></tr><tr><td>阶段号追踪</td><td>❌</td><td>✅（getPhase()）</td></tr><tr><td>终止机制</td><td>损坏即不可用</td><td>参与者归零后优雅终止</td></tr><tr><td>性能（大规模）</td><td>较差（全局锁）</td><td>更优（分层 + 自适应等待）</td></tr></tbody></table>
<p><strong>使用建议：</strong></p>
<ul>
<li>若参与者数量固定且较少，用 <code>CyclicBarrier</code> 即可。</li>
<li>若需动态调整、多阶段、大规模，则优先选择 <code>Phaser</code>。</li>
</ul>
<h2 data-id="heading-22">Semaphore（JDK 5+）：信号量</h2>
<h3 data-id="heading-23">使用场景</h3>
<p><code>Semaphore</code> 用于控制<strong>同时访问特定资源的线程数量</strong>，比如：</p>
<ul>
<li>数据库连接池（最多 N 个连接）。</li>
<li>接口限流（如每秒最多处理 100 个请求）。</li>
<li>模拟有限资源的分配（如停车场车位）。</li>
<li><code>new Semaphore(1)</code> 实际上等价于 <code>synchronized</code> 或 <code>ReentrantLock</code>。</li>
</ul>
<h3 data-id="heading-24">核心 API</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Semaphore</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>)</span>;
<span class="hljs-keyword">public</span> <span class="hljs-title function_">Semaphore</span><span class="hljs-params">(<span class="hljs-type">int</span> <span class="hljs-keyword">permits</span>, <span class="hljs-type">boolean</span> fair)</span>; <span class="hljs-comment">// 公平/非公平模式</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">()</span>;
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span>; <span class="hljs-comment">// 非阻塞尝试获取</span>
</code></pre>
<h3 data-id="heading-25">使用示例</h3>
<pre><code class="hljs language-scss" lang="scss">public class SemaphoreExample {
    private static final Semaphore semaphore = new <span class="hljs-built_in">Semaphore</span>(<span class="hljs-number">2</span>); <span class="hljs-comment">// 最多2个线程并发</span>

    public static void <span class="hljs-selector-tag">main</span>(String[] args) {
        for (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            new <span class="hljs-built_in">Thread</span>(() -&gt; {
                try {
                    semaphore<span class="hljs-selector-class">.acquire</span>();
                    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(Thread.currentThread()<span class="hljs-selector-class">.getName</span>() + " 获取许可，正在执行...");
                    Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">2000</span>);
                } catch (InterruptedException e) {
                    Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.interrupt</span>();
                } finally {
                    semaphore<span class="hljs-selector-class">.release</span>();
                    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(Thread.currentThread()<span class="hljs-selector-class">.getName</span>() + " 释放许可");
                }
            })<span class="hljs-selector-class">.start</span>();
        }
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-erlang" lang="erlang">Thread-<span class="hljs-number">0</span> 获取许可，正在执行...
Thread-<span class="hljs-number">1</span> 获取许可，正在执行...
Thread-<span class="hljs-number">0</span> 释放许可
Thread-<span class="hljs-number">2</span> 获取许可，正在执行...
Thread-<span class="hljs-number">1</span> 释放许可
Thread-<span class="hljs-number">3</span> 获取许可，正在执行...
Thread-<span class="hljs-number">2</span> 释放许可
Thread-<span class="hljs-number">3</span> 释放许可
Thread-<span class="hljs-number">4</span> 获取许可，正在执行...
Thread-<span class="hljs-number">4</span> 释放许可
</code></pre>
<h3 data-id="heading-26">应用场景示例</h3>
<p><strong>API 限流：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Semaphore</span> <span class="hljs-variable">rateLimiter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">100</span>); <span class="hljs-comment">// 每秒最多100请求</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (rateLimiter.tryAcquire()) {
        <span class="hljs-keyword">try</span> {
            process();
        } <span class="hljs-keyword">finally</span> {
            rateLimiter.release();
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"请求过于频繁"</span>);
    }
}
</code></pre>
<h3 data-id="heading-27">底层原理</h3>
<p>同样基于 <strong>AQS</strong>：（AQS 原理详见<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fmp.weixin.qq.com%2Fs%2FYl1jxnE562TuUqq48rag4g" target="_blank" title="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/Yl1jxnE562TuUqq48rag4g" ref="nofollow noopener noreferrer">Java并发编程：Lock原理详解</a>）</p>
<ul>
<li><code>state</code> 表示可用许可数量。</li>
<li><code>acquire()</code> 尝试减少 <code>state</code>，若不足则入队等待。</li>
<li><code>release()</code> 增加 <code>state</code> 并唤醒等待线程。</li>
<li>支持公平模式（按请求顺序分配许可）。</li>
</ul>
<h2 data-id="heading-28">Exchanger（JDK 5+）：数据交换器</h2>
<h3 data-id="heading-29">使用场景</h3>
<p><code>Exchanger</code> 专为<strong>两个线程之间交换数据</strong>而设计，典型场景如：</p>
<ul>
<li>双缓冲机制（一个线程写入缓冲区 A，另一个写入 B，满后交换）。</li>
<li>生产者与消费者高效传递中间结果。</li>
<li>日志收集器中交换日志缓冲区。</li>
</ul>
<h3 data-id="heading-30">核心 API</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">exchange</span><span class="hljs-params">(V x)</span> <span class="hljs-keyword">throws</span> InterruptedException;
<span class="hljs-keyword">public</span> V <span class="hljs-title function_">exchange</span><span class="hljs-params">(V x, <span class="hljs-type">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> ...;
</code></pre>
<h3 data-id="heading-31">示例代码</h3>
<pre><code class="hljs language-ini" lang="ini">public class ExchangerExample {
    public static void main(String<span class="hljs-section">[]</span> args) {
        Exchanger&lt;String&gt; <span class="hljs-attr">exchanger</span> = new Exchanger&lt;&gt;()<span class="hljs-comment">;</span>

        new Thread(() -&gt; {
            try {
                String <span class="hljs-attr">data</span> = <span class="hljs-string">"Thread-A 的数据"</span><span class="hljs-comment">;</span>
                System.out.println("A 准备交换: " + data)<span class="hljs-comment">;</span>
                String <span class="hljs-attr">received</span> = exchanger.exchange(data)<span class="hljs-comment">;</span>
                System.out.println("A 收到: " + received)<span class="hljs-comment">;</span>
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt()<span class="hljs-comment">;</span>
            }
        }).start()<span class="hljs-comment">;</span>

        new Thread(() -&gt; {
            try {
                Thread.sleep(1000)<span class="hljs-comment">; // 模拟延迟</span>
                String <span class="hljs-attr">data</span> = <span class="hljs-string">"Thread-B 的数据"</span><span class="hljs-comment">;</span>
                System.out.println("B 准备交换: " + data)<span class="hljs-comment">;</span>
                String <span class="hljs-attr">received</span> = exchanger.exchange(data)<span class="hljs-comment">;</span>
                System.out.println("B 收到: " + received)<span class="hljs-comment">;</span>
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt()<span class="hljs-comment">;</span>
            }
        }).start()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">A</span> 准备交换: <span class="hljs-selector-tag">Thread-A</span> 的数据
<span class="hljs-selector-tag">B</span> 准备交换: <span class="hljs-selector-tag">Thread-B</span> 的数据
<span class="hljs-selector-tag">B</span> 收到: <span class="hljs-selector-tag">Thread-A</span> 的数据
<span class="hljs-selector-tag">A</span> 收到: <span class="hljs-selector-tag">Thread-B</span> 的数据
</code></pre>
<h3 data-id="heading-32">应用场景示例</h3>
<p><strong>双缓冲日志：</strong></p>
<pre><code class="hljs language-ini" lang="ini">Exchanger&lt;List&lt;LogEntry&gt;&gt; <span class="hljs-attr">exchanger</span> = new Exchanger&lt;&gt;()<span class="hljs-comment">;</span>
List&lt;LogEntry&gt; <span class="hljs-attr">bufferA</span> = new ArrayList&lt;&gt;(<span class="hljs-number">1000</span>)<span class="hljs-comment">;</span>
List&lt;LogEntry&gt; <span class="hljs-attr">bufferB</span> = new ArrayList&lt;&gt;(<span class="hljs-number">1000</span>)<span class="hljs-comment">;</span>

// 写线程不断填充 bufferA
// 写满后与读线程交换，读线程异步刷盘
</code></pre>
<h3 data-id="heading-33">底层原理</h3>
<p><code>Exchanger</code> 内部使用 <strong>Slot 或 Node 结构</strong>暂存数据，通过 <strong>CAS + 自旋</strong> 实现高效交换：</p>
<ul>
<li>第一个调用 <code>exchange()</code> 的线程将数据放入槽位并等待。</li>
<li>第二个线程到来后，取出对方数据，放入自己的数据，完成交换。</li>
<li>若超时或中断，会清理槽位并抛出异常。</li>
</ul>
<p><strong>注意</strong>：仅支持<strong>两个线程配对交换</strong>，第三个线程调用 <code>exchange()</code> 会一直阻塞直到有新的配对。</p>
<h2 data-id="heading-34">工具类对比总结</h2>





































































<table><thead><tr><th>特性</th><th>CountDownLatch</th><th>CyclicBarrier</th><th>Phaser</th><th>Semaphore</th><th>Exchanger</th></tr></thead><tbody><tr><td>引入版本</td><td>1.5</td><td>1.5</td><td>1.7</td><td>1.5</td><td>1.5</td></tr><tr><td>是否可重用</td><td>❌</td><td>✅</td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td>协作模式</td><td>一方等多方</td><td>所有互相等</td><td>多阶段动态同步</td><td>控制并发数</td><td>两线程交换</td></tr><tr><td>动态参与者</td><td>❌</td><td>❌</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td>分层支持</td><td>❌</td><td>❌</td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td>底层机制</td><td>AQS</td><td>ReentrantLock+Condition</td><td>自定义同步（CAS+自旋+队列）</td><td>AQS</td><td>CAS+自旋</td></tr><tr><td>典型用途</td><td>初始化等待</td><td>分阶段计算</td><td>复杂并行任务协调</td><td>限流</td><td>数据交换</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端崩溃监控：给网页戴上“生命体征监测仪”]]></title>    <link>https://juejin.cn/post/7586684925106389035</link>    <guid>https://juejin.cn/post/7586684925106389035</guid>    <pubDate>2025-12-23T06:28:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586684925106389035" data-draft-id="7586684925106372651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端崩溃监控：给网页戴上“生命体征监测仪”"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T06:28:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JS_Likers"/> <meta itemprop="url" content="https://juejin.cn/user/1377017277975032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端崩溃监控：给网页戴上“生命体征监测仪”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1377017277975032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JS_Likers
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:28:30.000Z" title="Tue Dec 23 2025 06:28:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎使用我的小程序👇👇👇👇</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d25c4001b1b4e6e902dc1f8863bcef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSlNfTGlrZXJz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767076110&amp;x-signature=2tlmxVM2u5XfV2g2%2BioDUySoe%2BI%3D" alt="small.png" loading="lazy"/></p>
<hr/>
<blockquote>
<p>想象一下：你开发的网页突然“晕倒”了，而你还蒙在鼓里——直到用户流失报表像病危通知书一样摆在你面前。别怕！今天我们来给每个网页安装一套“ICU监护系统”。</p>
</blockquote>
<h2 data-id="heading-0">一、开场白：当网页突然“不省人事”</h2>
<p>上周，我朋友小张的公司遇到了一个诡异问题：他们的电商平台在iPhone上总会在用户下单时“卡死”。用户抱怨，客服崩溃，而开发团队却一脸茫然——<strong>监控系统什么都没抓到</strong>。</p>
<p>“就像病人突然休克，但心电图却显示一切正常。”小张苦笑着说。</p>
<p>这就是大多数前端开发者的困境：<strong>JavaScript错误能监控，但页面崩溃却像幽灵一样无影无踪</strong>。今天，我就来揭秘如何给网页安装一套全方位的“生命体征监测系统”。</p>
<h2 data-id="heading-1">二、崩溃的“临床表现”与诊断难点</h2>
<h3 data-id="heading-2">2.1 页面崩溃的四种“病症”</h3>
<p>先来看几个典型病例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 病例1：内存泄漏型“慢性病”</span>
<span class="hljs-keyword">let</span> memoryLeak = [];
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  memoryLeak.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>)); <span class="hljs-comment">// 每秒吃掉10MB内存</span>
}, <span class="hljs-number">1000</span>);
<span class="hljs-comment">// 症状：页面越来越慢，最后彻底卡死</span>

<span class="hljs-comment">// 病例2：死循环型“急性心梗”</span>
<span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
  <span class="hljs-comment">// 无限循环，主线程完全阻塞</span>
}
<span class="hljs-comment">// 症状：页面瞬间冻结，点击无反应</span>

<span class="hljs-comment">// 病例3：渲染层“脑梗”</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>; <span class="hljs-comment">// 清空DOM</span>
<span class="hljs-title function_">complex3DAnimation</span>(); <span class="hljs-comment">// 但GPU还在拼命渲染不存在的元素</span>
<span class="hljs-comment">// 症状：页面白屏，但控制台没报错</span>

<span class="hljs-comment">// 病例4：网络层“呼吸衰竭”</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 永远等不到响应...</span>
});
<span class="hljs-comment">// 症状：loading转圈到天荒地老</span>
</code></pre>
<h3 data-id="heading-3">2.2 传统监控的“诊断盲区”</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[页面崩溃发生] --&gt; B{传统错误监控}
    B --&gt;|能捕获| C[JavaScript执行错误]
    B --&gt;|能捕获| D[资源加载失败]
    B --&gt;|无法捕获| E[内存泄漏崩溃]
    B --&gt;|无法捕获| F[死循环卡死]
    B --&gt;|无法捕获| G[渲染层崩溃]
    
    style E fill:#f96
    style F fill:#f96
    style G fill:#f96
</code></pre>
<p>传统错误监控就像是<strong>只查血常规，不做心电图</strong>——很多致命问题根本检测不到。</p>
<h2 data-id="heading-4">三、我们的“ICU监控系统”架构</h2>
<p>经过多年“临床实践”，我设计了一套<strong>四层监控体系</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph “监控体系架构”
        A[第一层: 实时心跳监测] --&gt; B[第二层: 多维度异常捕捉]
        B --&gt; C[第三层: 崩溃现场快照]
        C --&gt; D[第四层: 智能上报分析]
    end
    
    subgraph “技术实现”
        E[Service Worker&lt;br/&gt;独立心跳] --&gt; F[LocalStorage&lt;br/&gt;心跳备份]
        F --&gt; G[Performance API&lt;br/&gt;性能监控]
        G --&gt; H[Error Boundaries&lt;br/&gt;错误边界]
    end
    
    A -.-&gt; E
    B -.-&gt; G
    B -.-&gt; H
    C -.-&gt; F
</code></pre>
<h3 data-id="heading-5">3.1 第一层：Service Worker心跳监测（独立“起搏器”）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 想象一下：即使病人（主页面）昏迷了，</span>
<span class="hljs-comment">// 他的智能手表（Service Worker）还能继续发送生命信号</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HeartbeatMonitor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">heartbeatInterval</span> = <span class="hljs-number">5000</span>; <span class="hljs-comment">// 5秒一次心跳</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">crashThreshold</span> = <span class="hljs-number">15000</span>;   <span class="hljs-comment">// 15秒无心跳算“休克”</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateSessionId</span>();
  }
  
  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 注册Service Worker“护士”</span>
    navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/nurse.js'</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🏥 私人护士已上岗，开始监测心跳'</span>);
        
        <span class="hljs-comment">// 定期发送“我还活着”信号</span>
        <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendHeartbeat</span>();
        }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">heartbeatInterval</span>);
      });
  }
  
  <span class="hljs-title function_">sendHeartbeat</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 发送当前生命体征</span>
    <span class="hljs-keyword">const</span> vitalSigns = {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'HEARTBEAT'</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">patientId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>,
      <span class="hljs-attr">bloodPressure</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getMemoryPressure</span>(), <span class="hljs-comment">// 内存“血压”</span>
      <span class="hljs-attr">heartRate</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getEventLoopHealth</span>()     <span class="hljs-comment">// 事件循环“心率”</span>
    };
    
    <span class="hljs-comment">// 告诉护士当前状态</span>
    navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">controller</span>?.<span class="hljs-title function_">postMessage</span>(vitalSigns);
  }
}
</code></pre>
<p><strong>工作原理</strong>：</p>
<ul>
<li>Service Worker独立于主线程运行</li>
<li>即使主页面崩溃，Service Worker仍存活</li>
<li>15秒收不到心跳 → 判断页面“可能已崩溃”</li>
</ul>
<h3 data-id="heading-6">3.2 第二层：LocalStorage备份心跳（“病历本”方案）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这是给没有Service Worker的“低配版病人”准备的</span>
<span class="hljs-comment">// 原理：让页面定期在“病历本”上签字</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BackupMonitor</span> {
  <span class="hljs-title function_">checkPreviousSession</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 就诊时先看上次的“病历记录”</span>
    <span class="hljs-keyword">const</span> lastCheckup = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'last_heartbeat'</span>);
    
    <span class="hljs-keyword">if</span> (lastCheckup) {
      <span class="hljs-keyword">const</span> { timestamp, sessionId } = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(lastCheckup);
      <span class="hljs-keyword">const</span> timeSinceLastBeat = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - timestamp;
      
      <span class="hljs-keyword">if</span> (timeSinceLastBeat &gt; <span class="hljs-number">10000</span>) {
        <span class="hljs-comment">// 发现异常：上次就诊后没按时复查</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportSuspectedCrash</span>({
          <span class="hljs-attr">patientId</span>: sessionId,
          <span class="hljs-attr">missingDuration</span>: timeSinceLastBeat,
          <span class="hljs-attr">symptoms</span>: <span class="hljs-string">'未按时复查心跳'</span>
        });
      }
    }
    
    <span class="hljs-comment">// 开始新的诊疗记录</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startNewSession</span>();
  }
  
  <span class="hljs-title function_">startNewSession</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 每3秒在病历本上签一次到</span>
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'last_heartbeat'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">sessionId</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionId</span>,
        <span class="hljs-attr">url</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>
      }));
    }, <span class="hljs-number">3000</span>);
  }
}
</code></pre>
<h2 data-id="heading-7">四、实战：多维度“体检项目”</h2>
<p>光有心跳还不够，我们还需要全面的体检：</p>
<h3 data-id="heading-8">4.1 内存“血常规”检查</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BloodTest</span> {
  <span class="hljs-title function_">checkBloodRoutine</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!performance.<span class="hljs-property">memory</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> bloodReport = {
        <span class="hljs-comment">// 红细胞（已用内存）</span>
        <span class="hljs-attr">RBC</span>: performance.<span class="hljs-property">memory</span>.<span class="hljs-property">usedJSHeapSize</span>,
        <span class="hljs-comment">// 白细胞（总内存）</span>
        <span class="hljs-attr">WBC</span>: performance.<span class="hljs-property">memory</span>.<span class="hljs-property">totalJSHeapSize</span>,
        <span class="hljs-comment">// 血小板（内存限制）</span>
        <span class="hljs-attr">PLT</span>: performance.<span class="hljs-property">memory</span>.<span class="hljs-property">jsHeapSizeLimit</span>,
        <span class="hljs-comment">// 血红蛋白（使用率）</span>
        <span class="hljs-attr">HGB</span>: (performance.<span class="hljs-property">memory</span>.<span class="hljs-property">usedJSHeapSize</span> / 
              performance.<span class="hljs-property">memory</span>.<span class="hljs-property">totalJSHeapSize</span>) * <span class="hljs-number">100</span>
      };
      
      <span class="hljs-comment">// 诊断标准</span>
      <span class="hljs-keyword">if</span> (bloodReport.<span class="hljs-property">HGB</span> &gt; <span class="hljs-number">90</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'⚠️ 危！病人严重贫血（内存不足）！'</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emergencyTransfusion</span>(); <span class="hljs-comment">// 紧急输血（清理内存）</span>
      }
    }, <span class="hljs-number">10000</span>);
  }
  
  <span class="hljs-title function_">emergencyTransfusion</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 尝试触发垃圾回收</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">gc</span>) {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">gc</span>(); <span class="hljs-comment">// Chrome DevTools才有的“特效药”</span>
    }
    
    <span class="hljs-comment">// 清理缓存</span>
    caches.<span class="hljs-title function_">delete</span>(<span class="hljs-string">'my-cache'</span>);
    
    <span class="hljs-comment">// 卸载不必要组件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unloadUnusedComponents</span>();
  }
}
</code></pre>
<h3 data-id="heading-9">4.2 事件循环“心电图”监测</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ECGMonitor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastBeatTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxInterval</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// 正常“心跳”间隔应小于100ms</span>
  }
  
  <span class="hljs-title function_">startMonitoring</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 用requestAnimationFrame检测“心律”</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkHeartRhythm</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">const</span> interval = now - <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastBeatTime</span>;
      
      <span class="hljs-keyword">if</span> (interval &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxInterval</span> * <span class="hljs-number">2</span>) {
        <span class="hljs-comment">// 检测到“心律不齐”</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportArrhythmia</span>({
          <span class="hljs-attr">interval</span>: interval,
          <span class="hljs-attr">timestamp</span>: now,
          <span class="hljs-attr">severity</span>: interval &gt; <span class="hljs-number">1000</span> ? <span class="hljs-string">'CRITICAL'</span> : <span class="hljs-string">'WARNING'</span>
        });
      }
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastBeatTime</span> = now;
      <span class="hljs-title function_">requestAnimationFrame</span>(checkHeartRhythm);
    };
    
    <span class="hljs-title function_">checkHeartRhythm</span>();
  }
}
</code></pre>
<h3 data-id="heading-10">4.3 渲染性能“CT扫描”</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CTScanner</span> {
  <span class="hljs-title function_">setupRenderMonitoring</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 监控布局偏移（突然的“头晕目眩”）</span>
    <span class="hljs-keyword">const</span> layoutShiftObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
      list.<span class="hljs-title function_">getEntries</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">value</span> &gt; <span class="hljs-number">0.1</span>) { <span class="hljs-comment">// 偏移超过10%</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportVertigo</span>({
            <span class="hljs-attr">shiftValue</span>: entry.<span class="hljs-property">value</span>,
            <span class="hljs-attr">hadRecentInput</span>: entry.<span class="hljs-property">hadRecentInput</span>,
            <span class="hljs-attr">cause</span>: <span class="hljs-string">'布局突然变化'</span>
          });
        }
      });
    });
    
    layoutShiftObserver.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'layout-shift'</span>] });
    
    <span class="hljs-comment">// 监控长任务（“大脑宕机”时刻）</span>
    <span class="hljs-keyword">const</span> longTaskObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
      list.<span class="hljs-title function_">getEntries</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">duration</span> &gt; <span class="hljs-number">50</span>) { <span class="hljs-comment">// 超过50ms的任务</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportBrainFreeze</span>({
            <span class="hljs-attr">duration</span>: entry.<span class="hljs-property">duration</span>,
            <span class="hljs-attr">culprit</span>: entry.<span class="hljs-property">attribution</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">name</span> || <span class="hljs-string">'未知'</span>,
            <span class="hljs-attr">timestamp</span>: entry.<span class="hljs-property">startTime</span>
          });
        }
      });
    });
    
    longTaskObserver.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'longtask'</span>] });
  }
}
</code></pre>
<h2 data-id="heading-11">五、崩溃“尸检报告”：收集现场证据</h2>
<p>当崩溃发生时，我们需要一份详细的“尸检报告”：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AutopsyReport</span> {
  <span class="hljs-title function_">collectEvidence</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 基础身份信息</span>
      <span class="hljs-attr">patientInfo</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span>,
        <span class="hljs-attr">id</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
        <span class="hljs-attr">age</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - performance.<span class="hljs-property">timing</span>.<span class="hljs-property">navigationStart</span>
      },
      
      <span class="hljs-comment">// 最后的活动记录</span>
      <span class="hljs-attr">lastMovements</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUserActions</span>(),
      
      <span class="hljs-comment">// 生命体征最后读数</span>
      <span class="hljs-attr">lastVitals</span>: {
        <span class="hljs-attr">memory</span>: performance.<span class="hljs-property">memory</span>?.<span class="hljs-property">usedJSHeapSize</span> || <span class="hljs-string">'N/A'</span>,
        <span class="hljs-attr">fps</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateFPS</span>(),
        <span class="hljs-attr">network</span>: navigator.<span class="hljs-property">connection</span>?.<span class="hljs-property">effectiveType</span> || <span class="hljs-string">'unknown'</span>
      },
      
      <span class="hljs-comment">// 现场照片（屏幕截图替代方案）</span>
      <span class="hljs-attr">crimeScene</span>: {
        <span class="hljs-attr">viewport</span>: <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.innerWidth}</span>x<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.innerHeight}</span>`</span>,
        <span class="hljs-attr">scrollPosition</span>: {
          <span class="hljs-attr">x</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollX</span>,
          <span class="hljs-attr">y</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>
        },
        <span class="hljs-attr">visibleElements</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getVisibleElements</span>()
      },
      
      <span class="hljs-comment">// 时间线重建</span>
      <span class="hljs-attr">timeline</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reconstructTimeline</span>(),
      
      <span class="hljs-comment">// 可能的死因分析</span>
      <span class="hljs-attr">probableCause</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">analyzeProbableCause</span>()
    };
  }
  
  <span class="hljs-title function_">getUserActions</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 收集用户最后10次操作</span>
    <span class="hljs-keyword">return</span> userActionLog.<span class="hljs-title function_">slice</span>(-<span class="hljs-number">10</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> ({
      <span class="hljs-attr">type</span>: action.<span class="hljs-property">type</span>,
      <span class="hljs-attr">target</span>: action.<span class="hljs-property">target</span>,
      <span class="hljs-attr">timestamp</span>: action.<span class="hljs-property">timestamp</span>,
      <span class="hljs-attr">pageX</span>: action.<span class="hljs-property">pageX</span>,
      <span class="hljs-attr">pageY</span>: action.<span class="hljs-property">pageY</span>
    }));
  }
  
  <span class="hljs-title function_">analyzeProbableCause</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 基于收集的证据分析可能死因</span>
    <span class="hljs-keyword">const</span> evidence = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collectEvidence</span>();
    
    <span class="hljs-keyword">if</span> (evidence.<span class="hljs-property">lastVitals</span>.<span class="hljs-property">memory</span> &gt; <span class="hljs-number">500000000</span>) { <span class="hljs-comment">// 500MB</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">'MEMORY_OVERLOAD'</span>;
    }
    
    <span class="hljs-keyword">if</span> (evidence.<span class="hljs-property">timeline</span>.<span class="hljs-property">longTasks</span> &gt; <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'MAIN_THREAD_BLOCKED'</span>;
    }
    
    <span class="hljs-keyword">if</span> (evidence.<span class="hljs-property">lastMovements</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.<span class="hljs-property">type</span> === <span class="hljs-string">'fetch'</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'NETWORK_REQUEST_HANG'</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">'UNKNOWN'</span>;
  }
}
</code></pre>
<h2 data-id="heading-12">六、智能上报：不打扰的“远程监护”</h2>
<p>监控数据上报要像<strong>智能手表的健康同步</strong>——安静、及时、省电：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartReporter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reportQueue</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reportStrategies</span> = {
      <span class="hljs-comment">// 急诊级：立即上报</span>
      <span class="hljs-attr">EMERGENCY</span>: {
        <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">methods</span>: [<span class="hljs-string">'beacon'</span>, <span class="hljs-string">'fetch'</span>],
        <span class="hljs-attr">retry</span>: <span class="hljs-number">3</span>
      },
      
      <span class="hljs-comment">// 门诊级：批量上报</span>
      <span class="hljs-attr">OUTPATIENT</span>: {
        <span class="hljs-attr">immediate</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">batchSize</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">interval</span>: <span class="hljs-number">30000</span>
      },
      
      <span class="hljs-comment">// 体检级：抽样上报</span>
      <span class="hljs-attr">CHECKUP</span>: {
        <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">0.1</span>, <span class="hljs-comment">// 10%抽样</span>
        <span class="hljs-attr">interval</span>: <span class="hljs-number">60000</span>
      }
    };
  }
  
  <span class="hljs-comment">// 智能判断上报策略</span>
  <span class="hljs-title function_">smartReport</span>(<span class="hljs-params">data, severity</span>) {
    <span class="hljs-keyword">const</span> strategy = <span class="hljs-variable language_">this</span>.<span class="hljs-property">reportStrategies</span>[severity];
    
    <span class="hljs-keyword">if</span> (strategy.<span class="hljs-property">immediate</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emergencyReport</span>(data);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">queueReport</span>(data, strategy);
    }
  }
  
  <span class="hljs-comment">// 急诊上报：用sendBeacon确保送达</span>
  <span class="hljs-title function_">emergencyReport</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">'/api/emergency'</span>;
    <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)], {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'application/json'</span>
    });
    
    <span class="hljs-comment">// sendBeacon：即使页面关闭也保证发送</span>
    <span class="hljs-keyword">if</span> (navigator.<span class="hljs-title function_">sendBeacon</span>(url, blob)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🚑 急诊报告已送出'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 备用方案</span>
      <span class="hljs-title function_">fetch</span>(url, {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
        <span class="hljs-attr">body</span>: blob,
        <span class="hljs-attr">keepalive</span>: <span class="hljs-literal">true</span>
      });
    }
  }
  
  <span class="hljs-comment">// 智能节流：避免频繁上报</span>
  <span class="hljs-title function_">queueReport</span>(<span class="hljs-params">data, strategy</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reportQueue</span>.<span class="hljs-title function_">push</span>({
      data,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      strategy
    });
    
    <span class="hljs-comment">// 达到批量大小或时间间隔时上报</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reportQueue</span>.<span class="hljs-property">length</span> &gt;= strategy.<span class="hljs-property">batchSize</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flushQueue</span>();
    }
  }
}
</code></pre>
<h2 data-id="heading-13">七、真实病例：电商网站崩溃之谜</h2>
<p>让我分享一个真实案例，看看这套系统如何“破案”：</p>
<h3 data-id="heading-14">7.1 案件背景</h3>
<p>某电商大促期间，iPhone用户频繁反馈“加入购物车后页面卡死”。</p>
<h3 data-id="heading-15">7.2 监控发现</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[用户点击加入购物车] --&gt; B{监控系统记录}
    B --&gt; C[内存从150MB飙升至850MB]
    B --&gt; D[主线程阻塞3.2秒]
    B --&gt; E[Service Worker心跳中断]
    C --&gt; F[诊断: 内存泄漏]
    D --&gt; G[诊断: 同步DOM操作]
    E --&gt; H[诊断: 页面崩溃]
    
    style F fill:#f96
    style G fill:#f96
    style H fill:#f96
</code></pre>
<h3 data-id="heading-16">7.3 根本原因</h3>
<p>通过“尸检报告”发现罪魁祸首：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 问题代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addToCart</span>(<span class="hljs-params">product</span>) {
  <span class="hljs-comment">// 每次点击都创建新的观察者，从未清理！</span>
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 监控商品可见性</span>
  }).<span class="hljs-title function_">observe</span>(productElement);
  
  <span class="hljs-comment">// 同步更新大量DOM</span>
  <span class="hljs-title function_">updateCartUI</span>(); <span class="hljs-comment">// 重绘整个购物车</span>
  <span class="hljs-title function_">updateRecommendations</span>(); <span class="hljs-comment">// 更新推荐列表</span>
  <span class="hljs-title function_">updateStockCount</span>(); <span class="hljs-comment">// 更新库存显示</span>
  
  <span class="hljs-comment">// 保存到LocalStorage（阻塞主线程）</span>
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'cart'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(cartData)); <span class="hljs-comment">// 数据越来越大！</span>
}
</code></pre>
<h3 data-id="heading-17">7.4 解决方案</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 修复后</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CartManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 单例观察者</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateQueue</span> = []; <span class="hljs-comment">// 更新队列</span>
  }
  
  <span class="hljs-title function_">addToCart</span>(<span class="hljs-params">product</span>) {
    <span class="hljs-comment">// 1. 防抖更新</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">debouncedUpdate</span>();
    
    <span class="hljs-comment">// 2. 使用IndexedDB代替LocalStorage</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveToIndexedDB</span>(cartData);
    
    <span class="hljs-comment">// 3. 虚拟化DOM更新</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">virtualUpdate</span>();
    
    <span class="hljs-comment">// 4. 内存监控</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getMemoryUsage</span>() &gt; <span class="hljs-number">70</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanupOldObservers</span>();
    }
  }
}
</code></pre>
<h3 data-id="heading-18">7.5 治疗效果</h3>
<ul>
<li><strong>崩溃率</strong>：从15.3%降至0.2%</li>
<li><strong>内存使用</strong>：峰值从850MB降至280MB</li>
<li><strong>用户满意度</strong>：提升42%</li>
</ul>
<h2 data-id="heading-19">八、监控面板：医生的“仪表盘”</h2>
<p>一个优秀的监控系统需要直观的展示：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实时健康仪表盘</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HealthDashboard</span> {
  <span class="hljs-title function_">renderDashboard</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`
      &lt;div class="health-monitor"&gt;
        &lt;div class="patient-card"&gt;
          &lt;h3&gt;🏥 页面健康状态&lt;/h3&gt;
          
          &lt;!-- 心跳指示器 --&gt;
          &lt;div class="heartbeat-indicator <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getHeartbeatStatus()}</span>"&gt;
            心跳: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getHeartbeatRate()}</span> BPM
          &lt;/div&gt;
          
          &lt;!-- 内存仪表 --&gt;
          &lt;div class="memory-gauge"&gt;
            内存使用: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getMemoryPercentage()}</span>%
            &lt;div class="gauge-bar"&gt;
              &lt;div class="gauge-fill" style="width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getMemoryPercentage()}</span>%"&gt;&lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
          
          &lt;!-- 事件循环健康度 --&gt;
          &lt;div class="event-loop-health"&gt;
            主线程响应: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getEventLoopHealth()}</span>ms
          &lt;/div&gt;
          
          &lt;!-- 今日诊断 --&gt;
          &lt;div class="diagnosis"&gt;
            &lt;h4&gt;📋 今日诊断报告&lt;/h4&gt;
            &lt;ul&gt;
              <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getDailyDiagnosis().map(d =&gt; 
                <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${d.time}</span> - <span class="hljs-subst">${d.type}</span>: <span class="hljs-subst">${d.message}</span>&lt;/li&gt;`</span>
              ).join(<span class="hljs-string">''</span>)}</span>
            &lt;/ul&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    `</span>;
  }
}
</code></pre>
<h2 data-id="heading-20">九、最佳实践清单</h2>
<h3 data-id="heading-21">9.1 必须做的 ✅</h3>
<ol>
<li><strong>多层监控</strong>：不要单点依赖</li>
<li><strong>用户无感</strong>：监控本身消耗 &lt; 1% CPU</li>
<li><strong>智能采样</strong>：高频数据按需采样</li>
<li><strong>隐私保护</strong>：匿名化用户数据</li>
</ol>
<h3 data-id="heading-22">9.2 避免做的 ❌</h3>
<ol>
<li><strong>不要</strong>在监控中抛出新错误</li>
<li><strong>不要</strong>收集敏感信息（密码、支付信息）</li>
<li><strong>不要</strong>影响正常业务逻辑</li>
<li><strong>不要</strong>忽略低端设备性能</li>
</ol>
<h3 data-id="heading-23">9.3 进阶技巧 🚀</h3>
<ol>
<li><strong>预测性监控</strong>：在崩溃前预警</li>
<li><strong>A/B测试监控</strong>：对比不同版本的稳定性</li>
<li><strong>地理监控</strong>：不同地区的表现差异</li>
<li><strong>设备指纹</strong>：特定设备的兼容性问题</li>
</ol>
<h2 data-id="heading-24">十、总结：从“救火”到“防火”</h2>
<p>实施完整的崩溃监控后，你的开发工作流将发生质变：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">timeline
    title 监控前后的变化
    section 监控前
        用户抱怨崩溃 : 开发团队茫然
        紧急修复bug : 不知如何重现
        用户持续流失 : 业务指标下降
    section 监控后
        实时警报 : 自动收集证据
        精准定位 : 快速修复问题
        预防预警 : 崩溃率下降90%
</code></pre>
<h3 data-id="heading-25">最后的思考</h3>
<p>网页崩溃监控不是奢侈品，而是<strong>必需品</strong>。它就像：</p>
<ul>
<li><strong>行车记录仪</strong>：事故发生时知道原因</li>
<li><strong>智能手环</strong>：实时监测健康状况</li>
<li><strong>飞机黑匣子</strong>：即使坠毁也能找到原因</li>
</ul>
<p>最重要的是，<strong>好的监控系统让你从被动的“救火队员”变成主动的“预防专家”</strong>。</p>
<h3 data-id="heading-26">行动起来！</h3>
<p>明天就开始为你的网站实施崩溃监控吧！从最简单的LocalStorage心跳开始，逐步完善。记住：</p>
<blockquote>
<p>每一个你今天监控到的崩溃，都是一个明天不会流失的用户。</p>
</blockquote>
<hr/>
<p><strong>彩蛋</strong>：想立即尝试？这里有一个<strong>五分钟快速上手</strong>方案：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建monitor.js文件</span>
<span class="hljs-comment">// 2. 复制下面的代码</span>
<span class="hljs-comment">// 3. 在页面中引入</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">QuickMonitor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'last_alive'</span>, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());
    }, <span class="hljs-number">5000</span>);
    
    <span class="hljs-keyword">const</span> lastAlive = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'last_alive'</span>);
    <span class="hljs-keyword">if</span> (lastAlive &amp;&amp; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - lastAlive &gt; <span class="hljs-number">10000</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'检测到上次可能崩溃了！'</span>);
    }
  }
}

<span class="hljs-keyword">new</span> <span class="hljs-title class_">QuickMonitor</span>();
</code></pre>
<p><strong>讨论时间</strong>：你的项目中遇到过最诡异的崩溃是什么？欢迎在评论区分享你的“破案”经历！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 全栈--reactjs 基础总结]]></title>    <link>https://juejin.cn/post/7586686861390479411</link>    <guid>https://juejin.cn/post/7586686861390479411</guid>    <pubDate>2025-12-23T07:08:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586686861390479411" data-draft-id="7586597780641366026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 全栈--reactjs 基础总结"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:08:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心在飞扬AI"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194366823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 全栈--reactjs 基础总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194366823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心在飞扬AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:08:26.000Z" title="Tue Dec 23 2025 07:08:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目前使用AI开发，生成代码比较成熟的全栈组合前端是reactjs，所以这里整理一些reactjs 基础知识，方便生成reactjs 的时候，可以快速修改里面的代码。</h2>
<blockquote>
<p>本文档结合 React 官方文档编写，覆盖你日常开发中 80% 会用到的 React 概念。</p>
</blockquote>
<h2 data-id="heading-1">你将学会</h2>
<ul>
<li>如何创建和嵌套组件</li>
<li>如何添加标记和样式</li>
<li>如何显示数据</li>
<li>如何渲染条件判断和列表</li>
<li>如何响应事件和更新界面</li>
<li>如何在组件间共享数据</li>
<li>React 核心原理与最佳实践</li>
</ul>
<hr/>
<h2 data-id="heading-2">一、React 渲染原理</h2>
<h3 data-id="heading-3">虚拟 DOM 的创建</h3>
<p>React 使用 <code>React.createElement</code> 创建虚拟 DOM，返回值是 React 元素（虚拟 DOM）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> element = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(
  <span class="hljs-string">'div'</span>,           <span class="hljs-comment">// DOM 类型</span>
  {               <span class="hljs-comment">// DOM 属性</span>
    <span class="hljs-attr">style</span>: {<span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span>},
    <span class="hljs-attr">className</span>: <span class="hljs-string">'container'</span>
  },
  <span class="hljs-string">'hello'</span>,        <span class="hljs-comment">// 子节点</span>
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"span"</span>, {<span class="hljs-attr">style</span>: {<span class="hljs-attr">color</span>: <span class="hljs-string">'blue'</span>}}, <span class="hljs-string">'world'</span>)
);
</code></pre>
<h3 data-id="heading-4">JSX 语法</h3>
<p>JSX 是 JavaScript 的语法扩展，最终会被 Babel 编译成 <code>React.createElement</code> 调用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> jsxElement = (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{color:</span>'<span class="hljs-attr">red</span>'}} <span class="hljs-attr">className</span>=<span class="hljs-string">'container'</span>&gt;</span>
    hello
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{color:</span>'<span class="hljs-attr">blue</span>'}}&gt;</span>world<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
)
</code></pre>
<h3 data-id="heading-5">渲染方式</h3>
<p>React 18 使用 <code>createRoot</code> API：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>));
root.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);
</code></pre>
<hr/>
<h2 data-id="heading-6">二、创建和嵌套组件</h2>
<p>React 应用由<strong>组件</strong>构成。组件是 UI 的一部分，拥有自己的逻辑和外观。React 组件是返回标记的 JavaScript 函数。</p>
<h3 data-id="heading-7">函数组件（推荐）</h3>
<p>函数组件是一个返回虚拟 DOM 的函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>我是一个按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 在其他组件中使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎来到我的应用<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：React 组件名必须以大写字母开头，HTML 标签必须小写。</p>
</blockquote>
<h3 data-id="heading-8">类组件（了解即可）</h3>
<p>类组件继承自 <code>React.Component</code>，必须实现 <code>render</code> 方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">super</span>(props);  <span class="hljs-comment">// 调用父类构造函数，this.props = props</span>
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>hello {this.props.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
}
</code></pre>
<blockquote>
<p>现代 React 开推荐使用函数组件 + Hooks，类组件主要用于维护老项目。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">三、JSX 语法</h2>
<p>JSX 是 JavaScript 的扩展语法，让在 JS 中写 HTML 变得更容易。</p>
<h3 data-id="heading-10">JSX 规则</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 必须关闭所有标签</span>
&lt;br /&gt;

<span class="hljs-comment">// 2. 必须有一个父元素包裹</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">AboutPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello there.<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>How do you do?<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}

<span class="hljs-comment">// 3. 使用 className 而不是 class</span>
&lt;img className=<span class="hljs-string">"avatar"</span> /&gt;
</code></pre>
<h3 data-id="heading-11">在 JSX 中使用 JavaScript</h3>
<p>使用花括号 <code>{}</code> 可以在 JSX 中嵌入 JavaScript 表达式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Hedy Lamarr'</span>, <span class="hljs-attr">imageUrl</span>: <span class="hljs-string">'https://i.imgur.com/yXOvdOSs.jpg'</span>, <span class="hljs-attr">imageSize</span>: <span class="hljs-number">90</span> };

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"avatar"</span>
        <span class="hljs-attr">src</span>=<span class="hljs-string">{user.imageUrl}</span>
        <span class="hljs-attr">alt</span>=<span class="hljs-string">{</span>'<span class="hljs-attr">Photo</span> <span class="hljs-attr">of</span> ' + <span class="hljs-attr">user.name</span>}
        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">width:</span> <span class="hljs-attr">user.imageSize</span>,
          <span class="hljs-attr">height:</span> <span class="hljs-attr">user.imageSize</span>
        }}
      /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<blockquote>
<p><strong>提示</strong>：<code>style={{}}</code> 不是特殊语法，而是 JSX 花括号内的一个普通对象。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">四、添加样式</h2>
<h3 data-id="heading-13">使用 className</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;img className=<span class="hljs-string">"avatar"</span> /&gt;
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* CSS 文件 */</span>
<span class="hljs-selector-class">.avatar</span> {
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
}
</code></pre>
<h3 data-id="heading-14">使用内联样式</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;div style={{ <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span>, <span class="hljs-attr">fontSize</span>: <span class="hljs-string">'16px'</span> }}&gt;
  红色文字
&lt;/div&gt;
</code></pre>
<hr/>
<h2 data-id="heading-15">五、条件渲染</h2>
<p>React 没有特殊的条件语法，使用普通的 JavaScript 条件语句。</p>
<h3 data-id="heading-16">方式一：if 语句</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> content;
<span class="hljs-keyword">if</span> (isLoggedIn) {
  content = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span>;
} <span class="hljs-keyword">else</span> {
  content = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LoginForm</span> /&gt;</span></span>;
}

<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{content}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
</code></pre>
<h3 data-id="heading-17">方式二：三元运算符（推荐）</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;div&gt;
  {isLoggedIn ? <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span> : <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LoginForm</span> /&gt;</span></span>}
&lt;/div&gt;
</code></pre>
<h3 data-id="heading-18">方式三：逻辑与 &amp;&amp;（无 else 分支时）</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;div&gt;
  {isLoggedIn &amp;&amp; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span>}
&lt;/div&gt;
</code></pre>
<hr/>
<h2 data-id="heading-19">六、列表渲染</h2>
<p>使用 JavaScript 的 <code>map()</code> 函数渲染列表：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> products = [
  { <span class="hljs-attr">title</span>: <span class="hljs-string">'卷心菜'</span>, <span class="hljs-attr">isFruit</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> },
  { <span class="hljs-attr">title</span>: <span class="hljs-string">'大蒜'</span>, <span class="hljs-attr">isFruit</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">2</span> },
  { <span class="hljs-attr">title</span>: <span class="hljs-string">'苹果'</span>, <span class="hljs-attr">isFruit</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">3</span> },
];

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ShoppingList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> listItems = products.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>
      <span class="hljs-attr">key</span>=<span class="hljs-string">{product.id}</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">color:</span> <span class="hljs-attr">product.isFruit</span> ? '<span class="hljs-attr">magenta</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">darkgreen</span>'
      }}
    &gt;</span>
      {product.title}
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
  );

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{listItems}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>;
}
</code></pre>
<blockquote>
<p><strong>重要</strong>：每个列表项都需要唯一的 <code>key</code> 属性，帮助 React 识别哪些项目发生了变化。</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">七、响应事件</h2>
<p>在组件内部声明<strong>事件处理函数</strong>来响应事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'你点击了我！'</span>);
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>
      点击我
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：<code>onClick={handleClick}</code> 末尾没有括号！只传递函数引用，而不是调用它。React 会在用户点击时调用你的事件处理函数。</p>
</blockquote>
<h3 data-id="heading-21">事件绑定方式</h3>
<ul>
<li><strong>冒泡阶段</strong>：<code>onClick</code></li>
<li><strong>捕获阶段</strong>：<code>onClickCapture</code></li>
</ul>
<h3 data-id="heading-22">事件方法</h3>
<ul>
<li><code>event.stopPropagation()</code> - 阻止事件传播</li>
<li><code>event.preventDefault()</code> - 阻止默认行为（如 a 标签跳转）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EventDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">childBubble</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子节点冒泡'</span>);
    event.<span class="hljs-title function_">stopPropagation</span>();
  }

  clickLink = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    event.<span class="hljs-title function_">preventDefault</span>();
  }
}
</code></pre>
<h3 data-id="heading-23">事件执行顺序</h3>
<p>React 事件系统和原生事件系统是独立的，执行顺序：</p>
<ol>
<li>React 捕获阶段</li>
<li>React 冒泡阶段</li>
<li>原生捕获阶段</li>
<li>原生冒泡阶段</li>
</ol>
<hr/>
<h2 data-id="heading-24">八、状态管理</h2>
<p>组件使用**状态（State）**来"记忆"信息并显示它。</p>
<h3 data-id="heading-25">类组件状态</h3>
<h4 data-id="heading-26">初始化状态</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方式1：在构造函数中</span>
<span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-variable language_">super</span>(props);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { <span class="hljs-attr">number</span>: <span class="hljs-number">0</span> };
}

<span class="hljs-comment">// 方式2：类属性（推荐）</span>
state = { <span class="hljs-attr">number</span>: <span class="hljs-number">0</span> };
</code></pre>
<h4 data-id="heading-27">setState 更新状态</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 对象方式</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">number</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> });

<span class="hljs-comment">// 函数方式（推荐，可基于旧状态计算新状态）</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(<span class="hljs-function">(<span class="hljs-params">prevState</span>) =&gt;</span> ({ <span class="hljs-attr">number</span>: prevState.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> }));

<span class="hljs-comment">// 带回调的 setState</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(
  <span class="hljs-function">(<span class="hljs-params">prevState</span>) =&gt;</span> ({ <span class="hljs-attr">number</span>: prevState.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> }),
  <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"State updated!"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span>);
  }
);
</code></pre>
<h3 data-id="heading-28">useState Hook</h3>
<p>在函数组件中添加状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>
      点击了 {count} 次
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li><code>count</code>：当前状态值</li>
<li><code>setCount</code>：更新状态的函数</li>
<li><code>useState(0)</code>：初始值为 0</li>
</ul>
<h3 data-id="heading-29">函数式更新（推荐）</h3>
<p>当新状态依赖于旧状态时，使用函数式更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-30">setState 的异步与批量更新</h3>
<h4 data-id="heading-31">React 17</h4>
<ul>
<li><strong>异步批量更新</strong>：在事件处理器、生命周期函数中，多个 <code>setState</code> 会被合并</li>
<li><strong>同步更新</strong>：在 setTimeout、Promise 等无法管理的场景中是同步的</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">handleClick = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">number</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> });  <span class="hljs-comment">// 批量合并</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);  <span class="hljs-comment">// 未更新</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">number</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> });  <span class="hljs-comment">// 批量合并</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);  <span class="hljs-comment">// 未更新</span>

  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">number</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">number</span> + <span class="hljs-number">1</span> });  <span class="hljs-comment">// 同步更新</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);  <span class="hljs-comment">// 已更新</span>
  });
}
</code></pre>
<h4 data-id="heading-32">React 18</h4>
<p>无论在什么场景，<code>setState</code> 都是批量的</p>
<hr/>
<h2 data-id="heading-33">九、Hooks 规则</h2>
<ul>
<li><strong>只在顶层调用</strong>：不要在循环、条件或嵌套函数中调用 Hooks</li>
<li><strong>只在 React 函数中调用</strong>：在 React 函数组件或自定义 Hook 中调用</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// ❌ 错误</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (condition) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 不要这样做</span>
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-34">十、组件间共享数据</h2>
<h3 data-id="heading-35">问题：各自独立的状态</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 每个按钮有自己独立的 count</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-36">解决：提升状态</h3>
<p>将状态提升到最近的共同父组件，通过 props 传递：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>计数器一起更新<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{count}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">MyButton</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{count}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params">{ count, onClick }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span>&gt;</span>
      点击了 {count} 次
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<p>这就是"提升状态（Lifting State Up）"的概念。</p>
<hr/>
<h2 data-id="heading-37">十一、常用 Hooks 详解</h2>
<h3 data-id="heading-38">useState - 状态管理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

<span class="hljs-comment">// 函数式更新</span>
<span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>);
</code></pre>
<h3 data-id="heading-39">useReducer - 复杂状态管理</h3>
<p>复杂状态管理，类似 Redux：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> initialState = { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> };

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reducer</span>(<span class="hljs-params">state, action</span>) {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'ADD'</span>:
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> };
    <span class="hljs-keyword">case</span> <span class="hljs-string">'MINUS'</span>:
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - <span class="hljs-number">1</span> };
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
}

<span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, initialState);
<span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'ADD'</span> });
</code></pre>
<h3 data-id="heading-40">useEffect - 副作用处理</h3>
<p>处理副作用，替代类组件的生命周期：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 相当于 componentDidMount</span>
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> count + <span class="hljs-number">1</span>);
  }, <span class="hljs-number">1000</span>);

  <span class="hljs-comment">// 返回清理函数，相当于 componentWillUnmount</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">clearInterval</span>(timer);
  };
}, []); <span class="hljs-comment">// 空依赖数组 = 只执行一次</span>

<span class="hljs-comment">// 带依赖的 effect</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 当 count 变化时执行</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Count changed:'</span>, count);
}, [count]);
</code></pre>
<h3 data-id="heading-41">useContext - 跨组件共享数据</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-string">'defaultValue'</span>);

<span class="hljs-comment">// 提供数据</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">MyContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"hello"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">MyContext.Provider</span>&gt;</span></span>

<span class="hljs-comment">// 消费数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">MyContext</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-42">useMemo - 缓存计算结果</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> displayData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({ count }), [count]);
</code></pre>
<h3 data-id="heading-43">useCallback - 缓存回调函数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> incrementCount = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> count + <span class="hljs-number">1</span>);
}, [count]);
</code></pre>
<h3 data-id="heading-44">useRef - 引用 DOM</h3>
<p>在函数组件中创建 ref：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);  <span class="hljs-comment">// {current: null}</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">focusInput</span>(<span class="hljs-params"/>) {
  inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();
}

&lt;input ref={inputRef} /&gt;
</code></pre>
<h3 data-id="heading-45">useImperativeHandle - 自定义 ref 暴露</h3>
<p>自定义 ref 暴露给父组件的实例值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FancyInput</span>(<span class="hljs-params">props, ref</span>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>();

  <span class="hljs-title function_">useImperativeHandle</span>(ref, <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-title function_">focus</span>(<span class="hljs-params"/>) {
      inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();
    }
  }));

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span> /&gt;</span></span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ForwardFancyInput</span> = <span class="hljs-title function_">forwardRef</span>(<span class="hljs-title class_">FancyInput</span>);
</code></pre>
<h3 data-id="heading-46">useLayoutEffect - 同步副作用</h3>
<p>同步执行副作用，在 DOM 变更后同步调用（阻塞浏览器绘制）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在浏览器绘制之前执行</span>
  ref.<span class="hljs-property">current</span>.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translate(500px)`</span>;
}, []);
</code></pre>
<hr/>
<h2 data-id="heading-47">十二、Ref 引用</h2>
<h3 data-id="heading-48">createRef（类组件）</h3>
<p>用于访问 DOM 元素或类组件实例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RefComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  inputRef = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createRef</span>(); <span class="hljs-comment">// {current: null}</span>

  handleButtonClick = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputRef</span>.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();  <span class="hljs-comment">// 访问真实 DOM</span>
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.inputRef}</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.handleButtonClick}</span>&gt;</span>获得焦点<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
  }
}
</code></pre>
<h3 data-id="heading-49">访问类组件实例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ParentComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  childRef = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createRef</span>();

  handleClick = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">childRef</span>.<span class="hljs-property">current</span>.<span class="hljs-title function_">alertMessage</span>();  <span class="hljs-comment">// 调用子组件方法</span>
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.childRef}/</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
  }
}
</code></pre>
<h3 data-id="heading-50">forwardRef（转发 ref）</h3>
<p>函数组件默认不能接收 ref，需要使用 <code>forwardRef</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChildComponent</span>(<span class="hljs-params">props, forwardRef</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{forwardRef}/</span>&gt;</span></span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ForwardChildComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">forwardRef</span>(<span class="hljs-title class_">ChildComponent</span>);
</code></pre>
<hr/>
<h2 data-id="heading-51">十三、Context 上下文</h2>
<p>用于跨组件层级共享数据，避免层层传递 props</p>
<h3 data-id="heading-52">创建 Context</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-string">'defaultValue'</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">Provider</span>, <span class="hljs-title class_">Consumer</span> } = <span class="hljs-title class_">MyContext</span>;
</code></pre>
<h3 data-id="heading-53">使用 Context</h3>
<h4 data-id="heading-54">Provider 提供数据</h4>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Provider</span> value={contextValue}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span>/&gt;</span></span>
&lt;/<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Provider</span>&gt;
</code></pre>
<h4 data-id="heading-55">Consumer 消费数据（函数组件）</h4>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Consumer</span>&gt;
  {<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>}
&lt;/<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Consumer</span>&gt;
</code></pre>
<h4 data-id="heading-56">类组件使用 contextType</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClassComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-keyword">static</span> contextType = <span class="hljs-title class_">MyContext</span>;
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{this.context}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
}
</code></pre>
<h3 data-id="heading-57">多个 Context</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">BorderProvider</span> value={borderValue}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ColorProvider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{colorValue}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ColorProvider</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">BorderProvider</span>&gt;
</code></pre>
<h3 data-id="heading-58">Context 嵌套规则</h3>
<p>Consumer 会读取最近的 Provider 的值</p>
<hr/>
<h2 data-id="heading-59">十四、性能优化</h2>
<h3 data-id="heading-60">shouldComponentUpdate</h3>
<p>通过返回布尔值控制组件是否更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">shouldComponentUpdate</span>(<span class="hljs-params">nextProps, nextState</span>) {
  <span class="hljs-keyword">return</span> nextState.<span class="hljs-property">number</span> % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>; <span class="hljs-comment">// 偶数才更新</span>
}
</code></pre>
<h3 data-id="heading-61">PureComponent</h3>
<p>自动进行浅比较，避免不必要的渲染：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PureComp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.PureComponent</span> {
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{this.props.value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
}
</code></pre>
<h3 data-id="heading-62">React.memo</h3>
<p>用于函数组件的记忆化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MemoCounter</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-title class_">Counter</span>);

<span class="hljs-comment">// 自定义比较函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MemoComp</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-title class_">Comp</span>, <span class="hljs-function">(<span class="hljs-params">prevProps, nextProps</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> prevProps.<span class="hljs-property">value</span> === nextProps.<span class="hljs-property">value</span>;
});
</code></pre>
<h3 data-id="heading-63">性能优化最佳实践</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [username, setUsername] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'zhufeng'</span>);
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 缓存对象</span>
  <span class="hljs-keyword">const</span> displayData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({ count }), [count]);

  <span class="hljs-comment">// 缓存回调函数</span>
  <span class="hljs-keyword">const</span> incrementCount = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> count + <span class="hljs-number">1</span>);
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{username}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setUsername(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">MemoChildButton</span> <span class="hljs-attr">displayData</span>=<span class="hljs-string">{displayData}</span> <span class="hljs-attr">incrementCount</span>=<span class="hljs-string">{incrementCount}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h2 data-id="heading-64">十五、生命周期（类组件）</h2>
<h3 data-id="heading-65">挂载阶段 (Mounting)</h3>
<ol>
<li><strong>constructor</strong> - 初始化状态</li>
<li><strong>componentWillMount</strong> (已废弃) - 组件将要挂载</li>
<li><strong>render</strong> - 计算虚拟 DOM（纯函数，不能有副作用）</li>
<li><strong>componentDidMount</strong> - 挂载完成，可发起网络请求</li>
</ol>
<h3 data-id="heading-66">更新阶段 (Updating)</h3>
<ol>
<li><strong>componentWillReceiveProps</strong> - 收到新属性（已废弃）</li>
<li><strong>getDerivedStateFromProps</strong> - 从属性派生状态（静态方法）</li>
<li><strong>shouldComponentUpdate</strong> - 决定是否更新（性能优化关键点）</li>
<li><strong>getSnapshotBeforeUpdate</strong> - 获取 DOM 更新前的快照</li>
<li><strong>componentWillUpdate</strong> - 将要更新（已废弃）</li>
<li><strong>render</strong> - 重新计算虚拟 DOM</li>
<li><strong>componentDidUpdate</strong> - 更新完成</li>
</ol>
<h3 data-id="heading-67">卸载阶段 (Unmounting)</h3>
<ul>
<li><strong>componentWillUnmount</strong> - 清理操作（清除定时器、取消网络请求）</li>
</ul>
<h3 data-id="heading-68">新生命周期方法示例</h3>
<h4 data-id="heading-69">getDerivedStateFromProps</h4>
<p>从 props 派生 state：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromProps</span>(<span class="hljs-params">nextProps, prevState</span>) {
  <span class="hljs-keyword">if</span> (nextProps.<span class="hljs-property">itemCount</span> !== prevState.<span class="hljs-property">itemCount</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">itemCount</span>: nextProps.<span class="hljs-property">itemCount</span> };
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 不更新状态</span>
}
</code></pre>
<h4 data-id="heading-70">getSnapshotBeforeUpdate</h4>
<p>获取 DOM 更新前的快照：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">getSnapshotBeforeUpdate</span>(<span class="hljs-params">prevProps, prevState</span>) {
  <span class="hljs-keyword">const</span> list = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listRef</span>.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">return</span> list.<span class="hljs-property">scrollHeight</span>;  <span class="hljs-comment">// 返回更新前的高度</span>
}

<span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params">prevProps, prevState, snapshot</span>) {
  <span class="hljs-keyword">const</span> list = <span class="hljs-variable language_">this</span>.<span class="hljs-property">listRef</span>.<span class="hljs-property">current</span>;
  <span class="hljs-comment">// 使用快照计算新的滚动位置</span>
  list.<span class="hljs-property">scrollTop</span> = list.<span class="hljs-property">scrollTop</span> + (list.<span class="hljs-property">scrollHeight</span> - snapshot);
}
</code></pre>
<hr/>
<h2 data-id="heading-71">十六、重要概念</h2>
<h3 data-id="heading-72">合成事件 (SyntheticEvent)</h3>
<p>React 实现的事件系统，与原生事件隔离，跨浏览器兼容。</p>
<h3 data-id="heading-73">批量更新 (Batching)</h3>
<p>React 会将多个状态更新合并为一次渲染，提高性能。</p>
<h3 data-id="heading-74">受控组件与非受控组件</h3>
<ul>
<li><strong>受控组件</strong>：表单元素的值由 React state 控制</li>
<li><strong>非受控组件</strong>：表单元素的值由 DOM 自身控制</li>
</ul>
<h3 data-id="heading-75">组件通信方式</h3>
<ol>
<li><strong>Props</strong> - 父子组件通信</li>
<li><strong>Callback</strong> - 子父组件通信</li>
<li><strong>Context</strong> - 跨层级通信</li>
<li><strong>Redux/Zustand</strong> - 全局状态管理</li>
<li><strong>Event Bus</strong> - 兄弟组件通信</li>
<li><strong>Ref</strong> - 直接访问子组件实例</li>
</ol>
<hr/>
<h2 data-id="heading-76">学习路径建议</h2>
<h3 data-id="heading-77">第一步：掌握基础</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 组件与 JSX</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> Props 传递</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 事件处理</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> useState Hook</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 条件渲染和列表</li>
</ul>
<h3 data-id="heading-78">第二步：深入理解</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> useEffect 副作用处理</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 组件间通信</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> Context 使用</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> useRef 引用</li>
</ul>
<h3 data-id="heading-79">第三步：进阶技能</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 性能优化</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 自定义 Hooks</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 状态管理（useReducer）</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 表单处理</li>
</ul>
<h3 data-id="heading-80">第四步：实战项目</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> React Router 路由</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Redux Toolkit / Zustand</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> React Query 数据请求</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> UI 组件库（Ant Design / Material-UI）</li>
</ul>
<h2 data-id="heading-81">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn" target="_blank" title="https://react.dev/learn" ref="nofollow noopener noreferrer">React 官方文档 - Quick Start</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Fcreating-a-react-app" target="_blank" title="https://react.dev/learn/creating-a-react-app" ref="nofollow noopener noreferrer">React 官方文档 - 创建应用</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Fdescribing-the-ui" target="_blank" title="https://react.dev/learn/describing-the-ui" ref="nofollow noopener noreferrer">React 官方文档 - 描述 UI</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Flearn%2Fadding-interactivity" target="_blank" title="https://react.dev/learn/adding-interactivity" ref="nofollow noopener noreferrer">React 官方文档 - 添加交互</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FLearn_web_development%2FCore%2FFrameworks_libraries%2FReact_getting_started" target="_blank" title="https://developer.mozilla.org/en-US/docs/Learn_web_development/Core/Frameworks_libraries/React_getting_started" ref="nofollow noopener noreferrer">MDN - React 入门</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从怀疑到离不开：我第一个由 AI 深度参与完成的真实项目复盘]]></title>    <link>https://juejin.cn/post/7586622708998996008</link>    <guid>https://juejin.cn/post/7586622708998996008</guid>    <pubDate>2025-12-23T06:44:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586622708998996008" data-draft-id="7586622708998897704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从怀疑到离不开：我第一个由 AI 深度参与完成的真实项目复盘"/> <meta itemprop="keywords" content="OpenAI,前端"/> <meta itemprop="datePublished" content="2025-12-23T06:44:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="命中水"/> <meta itemprop="url" content="https://juejin.cn/user/3614849961851966"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从怀疑到离不开：我第一个由 AI 深度参与完成的真实项目复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3614849961851966/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    命中水
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:44:26.000Z" title="Tue Dec 23 2025 06:44:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>首先说明，我不是专业的前端工程师。</p>
<p>但这次，我一个人完成了一个包含<strong>聊天窗口、WebSocket 实时推送、多语言翻译、复杂 UI 状态管理</strong>的前端项目。</p>
<p>说实话，如果没有 AI，这个项目我大概率会延期，甚至放弃一些体验上的细节。</p>
<p>这是我第一次，在一个<strong>真实、长期维护、并且已经上线使用的项目</strong>中，深度引入 AI 参与开发。 不是 Demo，不是练手，而是一个我必须为稳定性、性能和可维护性负责的系统。</p>
</blockquote>
<h2 data-id="heading-0">一、前言</h2>
<p>前端时间接了一个前端聊天+后端管理后台的项目，两个项目都是我自己一个人完成。</p>
<p>说起来后端还好，但是前端html+css那套我最开始入行的时候学了一点，但是后面正式工作后主要还是围绕后端语言来展开，前端的那套样式语法就渐渐地放下了；</p>
<p>但这次是一个全新的机会，也是一个新的挑战，需要自己写前端。那如何快速写前端项目，并快速交付呢？于是我想到了AI这个帮手，之前总拿它来排查问题，但是写一个项目行不行呢？ 我抱着怀疑的态度开始了这项“挑战”，并最终“有惊无险”的落地完成，顺利完成交付；</p>
<p>本篇文章，我想详细的复盘下这次经历：如何与AI沟通？ 如何合理利用AI完成代码的实现？以及举例一些聊天系统中实现的业务关键点！</p>
<p>在使用前，先想一下：</p>
<p><strong>AI 到底能帮我们做到什么？我们又该如何与 AI 协作，才能真的提高生产力，而不是制造技术债？</strong></p>
<h2 data-id="heading-1">二、与AI对话</h2>
<h3 data-id="heading-2">2.1 为什么我会把 AI 真正引入一个“正经项目”？</h3>
<p>先说结论： <strong>不是因为“新技术”，而是因为“现实问题”。</strong></p>
<p>我的真实情况</p>
<p>这个项目是一个 <strong>客服聊天系统</strong>，核心特点包括：</p>
<ul>
<li>Laravel 后端处理接口数据</li>
<li>jQuery + Bootstrap 前端（我比较熟悉的是这套组合拳）</li>
<li>多账号、多好友</li>
<li>WebSocket 实时推送</li>
<li>消息类型复杂（文本 / 图片 / 视频 / 语音）</li>
<li>SaaS 场景（多租户）</li>
</ul>
<p>我面临的真实问题是：</p>
<ul>
<li>后端我非常熟</li>
<li>但前端交互复杂、状态多、样式细</li>
<li>每一个“小交互”都很耗时间</li>
<li>而项目又在持续迭代，<strong>不能停下来重构</strong></li>
</ul>
<p>👉 这时，AI 不再是“锦上添花”，而是<strong>降低边际成本的工具</strong>。</p>
<hr/>
<h3 data-id="heading-3">2.2 AI 开发入门：不要幻想“全自动”，要追求“人机协作”</h3>
<h4 data-id="heading-4">2.2.1 AI 最适合做什么？</h4>
<p>在这次项目中，我给 AI 的定位非常清晰：</p>
<blockquote>
<p><strong>AI = 前端协作工程师</strong></p>
</blockquote>
<p>基于我当时的情况，我给它的定时是，辅助帮我写前端代码，包括但不限于以下：</p>
<ul>
<li>UI 结构拆解</li>
<li>JS 事件逻辑补全</li>
<li>CSS 微调与重构</li>
<li>复杂 DOM 操作的示例实现</li>
<li>重复性、模式化代码生成</li>
</ul>
<p>结合我使用之后的感觉，我认为他可能<strong>不太适合</strong>：</p>
<ul>
<li>定业务边界</li>
<li>定核心数据结构</li>
<li>决定架构选型</li>
<li>性能极限设计</li>
</ul>
<p><strong>这些必须由人来做。</strong></p>
<h4 data-id="heading-5">2.2.2 心态非常重要：你不是“用 AI”，而是在“带 AI”</h4>
<p>如果你把 AI 当成：</p>
<ul>
<li>“自动写代码工具”</li>
<li>“一句话生成系统”</li>
</ul>
<p>那你一定会失望。</p>
<p>但如果你把 AI 当成：</p>
<ul>
<li>一个不抱怨的工程师</li>
<li>一个愿意反复改的搭子</li>
<li>一个可以随时请教的助手</li>
</ul>
<p>你会发现它<strong>非常好用</strong>。</p>
<hr/>
<h3 data-id="heading-6">2.3 如何与 AI 沟通，才能真的把前端项目做出来？</h3>
<p>这一节，是我整篇文章里最想聊的部分。</p>
<h4 data-id="heading-7">2.3.1 关键原则一：给 AI “现有代码”，而不是“空需求”</h4>
<p>❌ 错误方式：</p>
<blockquote>
<p>帮我写一个聊天窗口</p>
</blockquote>
<p>✅ 正确方式：</p>
<blockquote>
<p>这是我现有的 HTML 结构 这是我的 JS 方法 这是我的业务规则 请在不破坏现有结构的前提下，实现功能 X</p>
</blockquote>
<p>AI 的代码质量，<strong>严重依赖上下文完整度</strong>。</p>
<p><strong>PS：如果你是从0开始让AI帮你完成项目，那最好在同一个人聊天窗口下，如果切换了聊天窗口，那可能会导致以前的消息可能无法产生关联；如果要优化，最好贴上之前的代码！</strong></p>
<hr/>
<h4 data-id="heading-8">2.3.2 关键原则二：需求要“具象”，不要“抽象”</h4>
<p>比如我会这样描述 UI：</p>
<blockquote>
<p>聊天窗口顶部： 左侧是头像 + 昵称 右侧是三个点按钮 点击后，从“聊天窗口右侧”滑出信息面板 而不是整个页面</p>
</blockquote>
<p>你会发现：<strong>我描述的是“画面”，不是“功能名词”。</strong></p>
<h4 data-id="heading-9">2.3.3 关键原则三：有问题就“精准反馈”，不要一句否定</h4>
<p>我在项目中经常这样和 AI 互动：</p>
<ul>
<li>“三个点按钮没有靠右”</li>
<li>“事件绑定不到，因为是动态元素”</li>
<li>“滑出层相对于 body 了，不是 chat-panel”</li>
</ul>
<p>这种反馈，会让 AI <strong>快速修正，而不是推倒重来</strong>。</p>
<h4 data-id="heading-10">2.3.4 一个我踩过的坑：AI 会“自信地写错”</h4>
<p>AI不是万能的，它也有可能出错，你的描述词不清晰，代码未提供完整，就可能导致：</p>
<ul>
<li>CSS 看起来对，但层级错了</li>
<li>JS 逻辑跑得通，但状态没覆盖</li>
<li>WebSocket 示例是 Demo 级，不是生产级</li>
</ul>
<p>所以我后来形成了一个习惯：<strong>AI负责“给方案”，我负责“兜底校验”！</strong></p>
<h2 data-id="heading-11">三、项目功能关键点拆解示例</h2>
<h3 data-id="heading-12">3.1 关键功能点一：前后端聊天消息推送</h3>
<h4 data-id="heading-13">3.1.1 后端整体设计思路</h4>
<p>我采用的是：</p>
<ul>
<li><strong>Workerman / GatewayWorker</strong></li>
<li>后端消息统一入库</li>
<li>再推送 WebSocket 给前端</li>
</ul>
<p>核心原则是：</p>
<blockquote>
<p><strong>消息以“后端为准”，前端只是展示层</strong></p>
</blockquote>
<hr/>
<p>我设计的流程是，后端采用脚本监听第三方消息服务，监听到有消息之后推送到job，job中处理消息，代码如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
​
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Jobs</span>;
​
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">YkAccountFriendChatRecordRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">YkAccountFriendRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">YkAccountRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">GatewayService</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">InstagramMessageService</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span>\<span class="hljs-title">TranslateService</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Bus</span>\<span class="hljs-title">Queueable</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">ShouldQueue</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Bus</span>\<span class="hljs-title">Dispatchable</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">InteractsWithQueue</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Queue</span>\<span class="hljs-title">SerializesModels</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">DB</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Log</span>;
​
<span class="hljs-comment">/**
 * 处理mqtt消息
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProcessIncomingMqttMessage</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ShouldQueue</span>
</span>{
    <span class="hljs-keyword">use</span> <span class="hljs-title">Dispatchable</span>, <span class="hljs-title">InteractsWithQueue</span>, <span class="hljs-title">Queueable</span>, <span class="hljs-title">SerializesModels</span>;
​
    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$payload</span>;
​
    <span class="hljs-comment">/**
     * Create a new job instance.
     *
     * <span class="hljs-doctag">@return</span> void
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$payload</span></span>)
    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;payload = <span class="hljs-variable">$payload</span>;
    }
​
    <span class="hljs-comment">/**
     * Execute the job.
     *
     * <span class="hljs-doctag">@return</span> void
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"/>)
    </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;payload[<span class="hljs-string">'PK'</span>]) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">'缺少PK！'</span>);
            }
            <span class="hljs-variable">$accountKey</span> = <span class="hljs-variable language_">$this</span>-&gt;payload[<span class="hljs-string">'PK'</span>];
            <span class="hljs-variable">$account</span> = <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">firstWhere</span>([<span class="hljs-string">'account_key'</span> =&gt; <span class="hljs-variable">$accountKey</span>, <span class="hljs-string">'status'</span> =&gt; <span class="hljs-title class_">YkAccountRepository</span>::<span class="hljs-variable constant_">STATUS_ENABLE</span>]);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$account</span>)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">"account_key：<span class="hljs-subst">{$accountKey}</span>对应的account数据不存在"</span>);
            }
​
            <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$this</span>-&gt;payload[<span class="hljs-string">'Payload'</span>]) || !<span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$this</span>-&gt;payload[<span class="hljs-string">'Payload'</span>])) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Exception</span>(<span class="hljs-string">'payload数据异常！'</span>);
            }
            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;payload[<span class="hljs-string">'Payload'</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$value</span>) {
                <span class="hljs-comment">/**
                 * UserId 发送方id
                 * RealTimeOp 类型
                 * Text 文本类型是内容字段
                 * Media 媒体类型时字段
                 */</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">'UserId'</span>])) {
                    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'payload中没有UserId：'</span>  . <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$value</span>));
                    <span class="hljs-keyword">continue</span>;
                }
​
                <span class="hljs-variable">$friend</span> = <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">firstWhere</span>([<span class="hljs-string">'pks'</span> =&gt; <span class="hljs-variable">$value</span>[<span class="hljs-string">'UserId'</span>], <span class="hljs-string">'account_id'</span> =&gt; <span class="hljs-variable">$account</span>[<span class="hljs-string">'id'</span>]]);
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$friend</span>)) {
                    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">"pks：<span class="hljs-subst">{$value['UserId']}</span>在好友表中不存在！"</span>);
                    <span class="hljs-keyword">continue</span>;
                }
​
                <span class="hljs-variable">$contentType</span> = <span class="hljs-title class_">InstagramMessageService</span>::<span class="hljs-title function_ invoke__">transContentType</span>(<span class="hljs-variable">$value</span>);
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$contentType</span>)) {
                    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">warning</span>(<span class="hljs-string">'ProcessIncomingMqttMessage - handle 未知的消息类型'</span> . <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$value</span>));
                    <span class="hljs-keyword">continue</span>;
                }
​
                <span class="hljs-variable">$sendTime</span> = <span class="hljs-title function_ invoke__">transMicrosecondTimestamp</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">'TimeStampUnix'</span>]);
​
                <span class="hljs-variable">$data</span> = [
                    <span class="hljs-string">'customer_id'</span>       =&gt; <span class="hljs-variable">$account</span>[<span class="hljs-string">'belong_customer_id'</span>],
                    <span class="hljs-string">'account_id'</span>        =&gt; <span class="hljs-variable">$account</span>[<span class="hljs-string">'id'</span>],
                    <span class="hljs-string">'friend_id'</span>         =&gt; <span class="hljs-variable">$friend</span>[<span class="hljs-string">'id'</span>],
                    <span class="hljs-string">'content'</span>           =&gt; <span class="hljs-variable">$value</span>[<span class="hljs-string">'Text'</span>] ?? <span class="hljs-literal">null</span>,
                    <span class="hljs-string">'content_type'</span>      =&gt; <span class="hljs-variable">$contentType</span>,
                    <span class="hljs-string">'attachment'</span>        =&gt; <span class="hljs-title class_">InstagramMessageService</span>::<span class="hljs-title function_ invoke__">getAttachment</span>(<span class="hljs-variable">$contentType</span>, <span class="hljs-variable">$value</span>),
                    <span class="hljs-string">'item_id'</span>           =&gt; <span class="hljs-variable">$value</span>[<span class="hljs-string">'ItemId'</span>],
                    <span class="hljs-string">'send_time'</span>         =&gt; <span class="hljs-title function_ invoke__">transMicrosecondTimestamp</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">'TimeStampUnix'</span>]),
                    <span class="hljs-string">'send_status'</span>       =&gt; <span class="hljs-title class_">YkAccountFriendChatRecordRepository</span>::<span class="hljs-variable constant_">STATUS_SUCCESS</span>
                ];
                
                <span class="hljs-comment">// 如果是文本类型 获取翻译之后的数据</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$contentType</span> == <span class="hljs-title class_">YkAccountFriendChatRecordRepository</span>::<span class="hljs-variable constant_">CONTENT_TYPE_TEXT</span>) {
                    <span class="hljs-variable">$transContent</span> = <span class="hljs-title class_">TranslateService</span>::<span class="hljs-title function_ invoke__">getChatMessageTranslate</span>(<span class="hljs-variable">$account</span>[<span class="hljs-string">'belong_customer_id'</span>], <span class="hljs-variable">$value</span>[<span class="hljs-string">'Text'</span>]);
                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$transContent</span> &amp;&amp; (<span class="hljs-variable">$transContent</span> != <span class="hljs-variable">$value</span>[<span class="hljs-string">'Text'</span>])) {
                        <span class="hljs-variable">$data</span>[<span class="hljs-string">'is_translate'</span>] = <span class="hljs-title class_">YkAccountFriendChatRecordRepository</span>::<span class="hljs-variable constant_">CONTENT_TRANSLATE</span>;
                        <span class="hljs-variable">$data</span>[<span class="hljs-string">'content_translate'</span>] = <span class="hljs-variable">$transContent</span>;
                    }
                }
​
                DB::<span class="hljs-title function_ invoke__">beginTransaction</span>();
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-variable">$record</span> = <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountFriendChatRecordRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">updateOrCreate</span>([<span class="hljs-string">'item_id'</span> =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'item_id'</span>]], <span class="hljs-variable">$data</span>);
                    <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">updateLastChatTime</span>(<span class="hljs-variable">$friend</span>[<span class="hljs-string">'id'</span>], <span class="hljs-variable">$sendTime</span>);
                    <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">updateLastChatTime</span>(<span class="hljs-variable">$account</span>[<span class="hljs-string">'id'</span>], <span class="hljs-variable">$sendTime</span>);
                    DB::<span class="hljs-title function_ invoke__">commit</span>();
                } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) {
                    DB::<span class="hljs-title function_ invoke__">rollBack</span>();
                    <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'ProcessIncomingMqttMessage handle 落库失败，异常原因：'</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>());
                    <span class="hljs-keyword">continue</span>;
                }
                <span class="hljs-variable">$data</span>[<span class="hljs-string">'message_id'</span>] = <span class="hljs-variable">$record</span>-&gt;id;
​
                <span class="hljs-title class_">GatewayService</span>::<span class="hljs-title function_ invoke__">pushMessageToClient</span>(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$friend</span>);
                <span class="hljs-comment">// 自动回复消息</span>
                <span class="hljs-title function_ invoke__">dispatch</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SendAutoReplyMessageJob</span>(<span class="hljs-variable">$record</span>-&gt;id))-&gt;<span class="hljs-title function_ invoke__">onConnection</span>(<span class="hljs-string">'redis'</span>)-&gt;<span class="hljs-title function_ invoke__">onQueue</span>(<span class="hljs-string">'SendAutoReplyMessageSqs'</span>);
            }
        } <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) {
            <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-string">'ProcessIncomingMqttMessage fail line:'</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getLine</span>() . <span class="hljs-string">' 报错信息：'</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>(), [<span class="hljs-string">'payload'</span> =&gt; <span class="hljs-variable">$this</span>-&gt;payload]);
        }
    }
}
</code></pre>
<p><code>GatewayService</code>类的<code>pushMessageToClient</code>方法代码如下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pushMessageToClient</span>(<span class="hljs-params"><span class="hljs-variable">$data</span>, <span class="hljs-variable">$friend</span></span>)
</span>{
    <span class="hljs-variable">$gatewayHost</span> = <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'services.gateway.host'</span>, <span class="hljs-string">'127.0.0.1'</span>);
    <span class="hljs-variable">$gatewayPort</span> = <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'services.gateway.port'</span>, <span class="hljs-string">'1238'</span>);
​
    <span class="hljs-title class_">Gateway</span>::<span class="hljs-variable">$registerAddress</span> = <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">'%s:%s'</span>, <span class="hljs-variable">$gatewayHost</span>, <span class="hljs-variable">$gatewayPort</span>);
​
    <span class="hljs-variable">$sendData</span> = [
        <span class="hljs-string">'account_id'</span>    =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'account_id'</span>],
        <span class="hljs-string">'friend_id'</span>     =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'friend_id'</span>],
        <span class="hljs-string">'friend_name'</span>   =&gt; <span class="hljs-variable">$friend</span>[<span class="hljs-string">'username'</span>],
        <span class="hljs-string">'friend_avatar'</span> =&gt; <span class="hljs-variable">$friend</span>[<span class="hljs-string">'avatar'</span>],
        <span class="hljs-string">'send_time'</span>     =&gt; <span class="hljs-title function_ invoke__">format_time</span>(<span class="hljs-variable">$data</span>[<span class="hljs-string">'send_time'</span>]),
        <span class="hljs-string">'timestamp'</span>     =&gt; <span class="hljs-title function_ invoke__">format_time</span>(<span class="hljs-literal">null</span>),
        <span class="hljs-string">'content'</span>       =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'content'</span>],
        <span class="hljs-string">'attachment'</span>    =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'attachment'</span>],
        <span class="hljs-string">'content_type'</span>  =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'content_type'</span>],
        <span class="hljs-string">'message_id'</span>    =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'message_id'</span>],
        <span class="hljs-string">'is_me'</span>         =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'is_me'</span>] ?? <span class="hljs-literal">false</span>,
        <span class="hljs-string">'is_auto_reply'</span> =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'is_auto_reply'</span>] ?? <span class="hljs-literal">false</span>,
    ];
​
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$sendData</span>[<span class="hljs-string">'is_me'</span>]) {
        <span class="hljs-comment">// 不管客服有没有在线 先标记账号和好友 有未读数据（从前端去处理已读）</span>
        <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">update</span>([<span class="hljs-string">'is_have_un_read_msg'</span> =&gt; <span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable constant_">HAVE_UN_READ_MSG</span>], <span class="hljs-variable">$friend</span>[<span class="hljs-string">'id'</span>]);
        <span class="hljs-title function_ invoke__">app</span>(<span class="hljs-title class_">YkAccountRepository</span>::<span class="hljs-variable language_">class</span>)-&gt;<span class="hljs-title function_ invoke__">update</span>([<span class="hljs-string">'is_have_un_read_msg'</span> =&gt; <span class="hljs-title class_">YkAccountFriendRepository</span>::<span class="hljs-variable constant_">HAVE_UN_READ_MSG</span>], <span class="hljs-variable">$data</span>[<span class="hljs-string">'account_id'</span>]);
    }
​
    <span class="hljs-comment">// 判断当前客服是否在线</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Gateway</span>::<span class="hljs-title function_ invoke__">isUidOnline</span>(<span class="hljs-variable">$data</span>[<span class="hljs-string">'customer_id'</span>])) {
        <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'推送到客户端信息'</span>, [<span class="hljs-string">'customer_id'</span> =&gt; <span class="hljs-variable">$data</span>[<span class="hljs-string">'customer_id'</span>], <span class="hljs-string">'data'</span> =&gt; <span class="hljs-title function_ invoke__">json_encode</span>([
            <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'new_message'</span>,
            <span class="hljs-string">'data'</span> =&gt; <span class="hljs-variable">$sendData</span>
        ])]);
        <span class="hljs-comment">// 发送消息给客服</span>
        <span class="hljs-title class_">Gateway</span>::<span class="hljs-title function_ invoke__">sendToUid</span>(<span class="hljs-variable">$data</span>[<span class="hljs-string">'customer_id'</span>], <span class="hljs-title function_ invoke__">json_encode</span>([
            <span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'new_message'</span>,
            <span class="hljs-string">'data'</span> =&gt; <span class="hljs-variable">$sendData</span>
        ]));
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-title class_">Log</span>::<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">"客服id：<span class="hljs-subst">{$data['customer_id']}</span>，未在线~"</span>, [<span class="hljs-string">'send_data'</span> =&gt; <span class="hljs-variable">$sendData</span>]);
    }
}
</code></pre>
<p>这个方法多个地方都可以调用，比如：</p>
<ul>
<li>接收到消息推送到前端</li>
<li>前端发送消息，后端推送到第三方成功，发送到前端回显</li>
<li>自动回复消息成功，发送到前端回显</li>
<li>...</li>
</ul>
<h4 data-id="heading-14">3.1.2 后端推送的数据结构</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"account_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">123456</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"friend_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">789012</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"friend_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"friend_avatar"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://example.com/avatar.jpg"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"send_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2023-10-15 14:30:25"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2023-10-15 16:45:10"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你好，最近怎么样？"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"attachment"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image_001.jpg"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"content_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"message_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"msg_20231015143025_123456"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"is_me"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"is_auto_reply"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-15">3.1.3 前端接收消息</h4>
<p>绑定并监听websocket</p>
<pre><code class="hljs language-ini" lang="ini">// 绑定 WebSocket
function connectWebSocket() {
    if (!CUSTOMER_ID) {
        console.error('未设置客服ID，无法连接WebSocket')<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }
    // 清除之前的重连定时器
    if (reconnectTimer) {
        clearTimeout(reconnectTimer)<span class="hljs-comment">;</span>
        <span class="hljs-attr">reconnectTimer</span> = null<span class="hljs-comment">;</span>
    }
​
    <span class="hljs-attr">ws</span> = new WebSocket(window.WEBSECKET_HOST)<span class="hljs-comment">; // 改成你的服务地址</span>
​
    <span class="hljs-attr">ws.onopen</span> = function () {
        console.log('WebSocket 已连接')<span class="hljs-comment">;</span>
        <span class="hljs-attr">lastPongTime</span> = Date.now()<span class="hljs-comment">; // 连接建立时重置时间</span>
        <span class="hljs-attr">reconnectAttempts</span> = <span class="hljs-number">0</span><span class="hljs-comment">; // 重置计数器</span>
​
        // 绑定客服登录用户ID
        ws.send(JSON.stringify({
            type: 'bind',
            uid: CUSTOMER_ID
        }))<span class="hljs-comment">;</span>
        // 启动心跳检测
        startHeartbeatCheck()<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
​
    <span class="hljs-attr">ws.onmessage</span> = function (event) {
        console.log('收到消息：', event.data)<span class="hljs-comment">;</span>
        let <span class="hljs-attr">msg</span> = {}<span class="hljs-comment">;</span>
        try {
            <span class="hljs-attr">msg</span> = JSON.parse(event.data)<span class="hljs-comment">;</span>
        } catch (e) {
            console.warn('收到非法消息', event.data)<span class="hljs-comment">;</span>
            return<span class="hljs-comment">;</span>
        }
​
        if (<span class="hljs-attr">msg.type</span> === <span class="hljs-string">'ping'</span>) {
            // 服务器心跳包，更新最后活跃时间并回复pong
            <span class="hljs-attr">lastPongTime</span> = Date.now()<span class="hljs-comment">;</span>
            // 服务器心跳包，回复pong
            ws.send(JSON.stringify({type: 'pong'}))<span class="hljs-comment">;</span>
            return<span class="hljs-comment">;</span>
        }
​
        if (<span class="hljs-attr">msg.type</span> === <span class="hljs-string">'new_message'</span>) {
            console.log('收到new_message消息：', msg.data)<span class="hljs-comment">;</span>
            handleIncomingMessage(msg.data)<span class="hljs-comment">;</span>
        }
​
        if (<span class="hljs-attr">msg.type</span> === <span class="hljs-string">'account_online_status'</span>) {
            const <span class="hljs-attr">data</span> = msg.data<span class="hljs-comment">;</span>
            console.log('收到account_online_status消息：', msg.data)<span class="hljs-comment">;</span>
            updateAccountOnlineStatus(data)<span class="hljs-comment">;</span>
        }
​
        if (<span class="hljs-attr">msg.type</span> === <span class="hljs-string">'send_message_status'</span>) {
            console.log('收到send_message_status消息：', msg.data)<span class="hljs-comment">;</span>
            const <span class="hljs-attr">data</span> = msg.data<span class="hljs-comment">;</span>
            // updateFriendOnlineStatus(data)<span class="hljs-comment">;</span>
​
            updateMessageSendStatus(data)
        }
    }<span class="hljs-comment">;</span>
​
    <span class="hljs-attr">ws.onclose</span> = function () {
        reconnectAttempts++<span class="hljs-comment">;</span>
​
        // 渐进式重连：前3次快速重连，后续采用退避策略
        const <span class="hljs-attr">delay</span> = reconnectAttempts &lt;= <span class="hljs-number">3</span> ?
            BASE_DELAY :
            Math.min(BASE_DELAY * Math.pow(1.5, reconnectAttempts - 3), MAX_DELAY)<span class="hljs-comment">;</span>
​
        console.warn(`<span class="hljs-section">[第${reconnectAttempts}次重连]</span> ${delay}ms后尝试...`)<span class="hljs-comment">;</span>
        setTimeout(connectWebSocket, delay)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
​
    <span class="hljs-attr">ws.onerror</span> = function (e) {
        console.error('WebSocket 发生错误')<span class="hljs-comment">;</span>
        console.error('WS错误代码:', e.code)<span class="hljs-comment">;</span>
        console.error('WS错误原因:', e.reason)<span class="hljs-comment">;</span>
        ws.close()<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
}
​
/**
 * 新消息处理
 * @param msg
 */
function handleIncomingMessage(msg) {
    console.log('handleIncomingMessage', msg)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">currentAccountId</span> = state.currentAccountId<span class="hljs-comment">;</span>
    const <span class="hljs-attr">currentFriendId</span> = state.currentFriendId<span class="hljs-comment">;</span>
​
    if (<span class="hljs-attr">msg.account_id</span> === currentAccountId) {
        if (<span class="hljs-attr">msg.friend_id</span> === currentFriendId) {
            // 当前聊天窗口好友，追加消息
            appendMessage({
                me: msg.is_me || false,
                auto_reply: msg.is_auto_reply || false,
                name: msg.friend_name,
                avatar: msg.friend_avatar,
                timestamp: msg.timestamp,
                send_time: msg.send_time,
                content: msg.content,
                attachment: msg.attachment,
                id: msg.message_id,
                type: getContentType(msg.content_type)
            })<span class="hljs-comment">;</span>
            // 如果当前消息是当前聊天好友的，标记好友状态为已读
            setFriendUnReadStatus(msg.friend_id, 0)<span class="hljs-comment">;</span>
            translateVisibleMessages($('select<span class="hljs-section">[name="input_target_lang"]</span>').val(), 'left')<span class="hljs-comment">;</span>
        } else {
            // 当前账号的其他好友，标红点
            markFriendUnreadDot(msg.friend_id, msg.account_id)<span class="hljs-comment">;</span>
        }
    } else {
        // 非当前账号，账号头像标红点
        markAccountUnreadDot(msg.account_id)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>这个这段逻辑主要包括：</p>
<ul>
<li>当前聊天窗口实时追加消息</li>
<li>非当前好友 → 好友红点</li>
<li>非当前账号 → 账号红点</li>
</ul>
<p>这里之所以要在前端判断account_id /friend_id，而不是后端分多钟类型推是因为：</p>
<ul>
<li>降低后端推送负责度，而且我觉得在前端判断会更好</li>
<li>保证前端状态一致性</li>
<li>方便后续扩展更多UI状态</li>
</ul>
<hr/>
<h3 data-id="heading-16">3.2 关键功能点二：中英文切换与“批量翻译”的实现思路</h3>
<p>这是一个让我非常满意、也非常适合 AI 协作的功能。</p>
<h4 data-id="heading-17">3.2.1 我的需求不是“翻译一条消息”</h4>
<p>而是：</p>
<ul>
<li>聊天窗口已有历史消息</li>
<li>切换语言后</li>
<li><strong>原文不变</strong></li>
<li>原文下方显示译文</li>
<li>支持再次切换目标语言</li>
</ul>
<hr/>
<h4 data-id="heading-18">3.2.2 前端结构设计（AI 协助）</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"chat-message-bubble"</span>&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"original-text"</span>&gt;Hello&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"translated-text text-muted small"</span>&gt;你好&lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>AI 在这里给了我一个很重要的建议：</p>
<blockquote>
<p>翻译内容不要覆盖原文，而是“附加”</p>
</blockquote>
<p>如果一开始就让 AI 覆盖原文，后期做多语言切换、撤销翻译、重新翻译，都会非常痛苦。这让体验和可维护性都好很多。</p>
<h4 data-id="heading-19">3.2.3 切换语言时的 JS 逻辑</h4>
<pre><code class="hljs language-ini" lang="ini">// Tab 切换事件
$("<span class="hljs-comment">#collapseTranslate").on('change', '.translate-select', function () {</span>
    let <span class="hljs-attr">name</span> = $(this).attr(<span class="hljs-string">'name'</span>)<span class="hljs-comment">;</span>
    let value<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">name</span> === <span class="hljs-string">'chat_message_auto_translate'</span> || name === <span class="hljs-string">'input_auto_translate'</span>) {
        const <span class="hljs-attr">isChecked</span> = $(this).is(<span class="hljs-string">':checked'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">value</span> = isChecked ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    } else {
        <span class="hljs-attr">value</span> = $(this).val()<span class="hljs-comment">;</span>
    }
​
    if (<span class="hljs-attr">name</span> === <span class="hljs-string">'input_target_lang'</span>) {
        translateVisibleMessages(value)<span class="hljs-comment">;</span>
    }
​
    if (<span class="hljs-attr">name</span> === <span class="hljs-string">'chat_message_target_lang'</span>) {
        translateVisibleMessages(value, 'left')<span class="hljs-comment">;</span>
    }
​
    $.post('/chat/change_translate_config', {
        name: name,
        value: value
    }, function (res) {
        if (res.code !== 0) {
            layer.msg(res.msg)
        }
    })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
​
/**
 * 聊天框内容翻译
 * @param targetLang
 * @param trans_message_type
 */
function translateVisibleMessages(<span class="hljs-attr">targetLang</span> = <span class="hljs-string">'en'</span>, trans_message_type = <span class="hljs-string">'right'</span>) {
    const <span class="hljs-attr">messagesToTranslate</span> = []<span class="hljs-comment">;</span>
    const <span class="hljs-attr">selector</span> = <span class="hljs-string">'.chat-message-wrapper.chat-message-'</span> + trans_message_type<span class="hljs-comment">;</span>
    console.log('selector', selector)<span class="hljs-comment">; // 输出拼接的选择器</span>
    console.log('匹配到元素数量:', $(selector).length)<span class="hljs-comment">;</span>
    $(selector).each(function () {
        const $<span class="hljs-attr">wrapper</span> = $(this)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">messageId</span> = <span class="hljs-variable">$wrapper</span>.data(<span class="hljs-string">'id'</span>)<span class="hljs-comment">;</span>
​
        const $<span class="hljs-attr">bubble</span> = <span class="hljs-variable">$wrapper</span>.find(<span class="hljs-string">'.chat-message-bubble'</span>)<span class="hljs-comment">;</span>
        const <span class="hljs-attr">content</span> = <span class="hljs-variable">$wrapper</span>.find(<span class="hljs-string">'.chat-message-bubble .original-text'</span>).text().trim()<span class="hljs-comment">;</span>
        const <span class="hljs-attr">cacheKey</span> = `<span class="hljs-variable">${messageId}</span>_<span class="hljs-variable">${targetLang}</span>`<span class="hljs-comment">;</span>
​
        if (!messageId || !content) return<span class="hljs-comment">;</span>
​
        // 若已缓存则直接渲染
        if (translationCache<span class="hljs-section">[cacheKey]</span>) {
            applyTranslatedMessage(messageId, translationCache<span class="hljs-section">[cacheKey]</span>)<span class="hljs-comment">;</span>
        } else {
            // 显示 loading 占位
            insertLoadingPlaceholder($bubble)<span class="hljs-comment">;</span>
​
            // 准备发送的内容
            messagesToTranslate.push({ message_id: messageId, content })<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
​
    console.log('messagesToTranslate', messagesToTranslate)<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">messagesToTranslate.length</span> === <span class="hljs-number">0</span>) return<span class="hljs-comment">;</span>
​
    $.ajax({
        url: '/chat/translate/batch',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            messages: messagesToTranslate,
            target_lang: targetLang
        }),
        success: function (res) {
            if (<span class="hljs-attr">res.code</span> === <span class="hljs-number">0</span> &amp;&amp; Array.isArray(res.data)) {
                res.data.forEach(<span class="hljs-attr">item</span> =&gt; {
                    const <span class="hljs-attr">cacheKey</span> = `<span class="hljs-variable">${item.message_id}</span>_<span class="hljs-variable">${targetLang}</span>`<span class="hljs-comment">;</span>
                    translationCache<span class="hljs-section">[cacheKey]</span> = item.translate<span class="hljs-comment">;</span>
                    applyTranslatedMessage(item.message_id, item.translate)<span class="hljs-comment">;</span>
                })<span class="hljs-comment">;</span>
            }
        }
    })<span class="hljs-comment">;</span>
}
​
/**
 * 翻译内容显示
 * @param messageId
 * @param translation
 */
function applyTranslatedMessage(messageId, translation) {
    const $<span class="hljs-attr">wrapper</span> = $(`.chat-message-wrapper[data-id=<span class="hljs-string">"${messageId}"</span>]`)<span class="hljs-comment">;</span>
    const $<span class="hljs-attr">bubble</span> = <span class="hljs-variable">$wrapper</span>.find(<span class="hljs-string">'.chat-message-bubble'</span>)<span class="hljs-comment">;</span>
​
    const $<span class="hljs-attr">translated</span> = <span class="hljs-variable">$bubble</span>.find(<span class="hljs-string">'.translated-text'</span>)<span class="hljs-comment">;</span>
    if ($translated.length) {
        $translated.text(translation)<span class="hljs-comment">;</span>
    } else {
        $bubble.append(`
            &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"divider"</span>&gt;&lt;/div&gt;
            &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"translated-text text-muted small"</span>&gt;<span class="hljs-variable">${translation}</span>&lt;/div&gt;
        `)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>这段代码是 AI 在我给出 DOM 结构后帮我补全的。</p>
<hr/>
<h3 data-id="heading-20">3.3 关键功能点三：复杂 UI 交互（微信式体验）如何落地？</h3>
<p>比如：</p>
<ul>
<li>消息气泡宽度</li>
<li>时间显示位置</li>
<li>自己 / 对方对齐方式</li>
<li>动态按钮事件绑定</li>
</ul>
<h4 data-id="heading-21">3.3.1 动态元素事件绑定问题</h4>
<p>我一开始写的是：</p>
<pre><code class="hljs language-csharp" lang="csharp">$(<span class="hljs-string">'#toggle-friend-info'</span>).<span class="hljs-keyword">on</span>(<span class="hljs-string">'click'</span>, ...)
</code></pre>
<p>AI 很快指出问题：</p>
<blockquote>
<p><strong>这是动态生成的 DOM，需要事件委托</strong></p>
</blockquote>
<p>修正后：</p>
<pre><code class="hljs language-javascript" lang="javascript">$(<span class="hljs-variable language_">document</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">'click'</span>, <span class="hljs-string">'#toggle-friend-info'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    $(<span class="hljs-string">'#friend-info-panel'</span>).<span class="hljs-title function_">toggleClass</span>(<span class="hljs-string">'show'</span>);
});
</code></pre>
<p>这是一个<strong>非常典型的“AI 帮你查漏补缺”场景</strong>。</p>
<hr/>
<h4 data-id="heading-22">3.3.2 滑出面板相对聊天窗口，而不是页面</h4>
<p>AI 在我反馈问题后，帮我调整为：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.chat-panel</span> {
    <span class="hljs-attribute">position</span>: relative;
    <span class="hljs-attribute">overflow</span>: hidden;
}
<span class="hljs-selector-class">.friend-info-panel</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">right</span>: -<span class="hljs-number">260px</span>;
    <span class="hljs-attribute">transition</span>: right .<span class="hljs-number">3s</span>;
}
<span class="hljs-selector-class">.friend-info-panel</span><span class="hljs-selector-class">.show</span> {
    <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-23">3.3.3 发送消息、接收消息左右分隔</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.chat-message-wrapper</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: flex-start;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
}
​
<span class="hljs-selector-class">.chat-message-left</span> {
    <span class="hljs-attribute">flex-direction</span>: row;
}
​
<span class="hljs-selector-class">.chat-message-right</span> {
    <span class="hljs-attribute">flex-direction</span>: row-reverse;
}
​
<span class="hljs-selector-class">.message-block</span> {
    <span class="hljs-attribute">display</span>: inline-flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">max-width</span>: <span class="hljs-number">75%</span>;   <span class="hljs-comment">/* 让消息区最大占75%宽 */</span>
    <span class="hljs-attribute">word-wrap</span>: break-word;
}
​
<span class="hljs-comment">/* 自己发的消息（右侧） */</span>
<span class="hljs-selector-class">.chat-message-right</span> <span class="hljs-selector-class">.message-block</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">align-items</span>: flex-end; <span class="hljs-comment">/* 时间右对齐 */</span>
}
​
<span class="hljs-comment">/* 对方的消息（左侧） */</span>
<span class="hljs-selector-class">.chat-message-left</span> <span class="hljs-selector-class">.message-block</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">align-items</span>: flex-start; <span class="hljs-comment">/* 时间左对齐 */</span>
}
​
<span class="hljs-selector-class">.chat-message-bubble</span> {
    <span class="hljs-attribute">max-width</span>: <span class="hljs-number">95%</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">word-wrap</span>: break-word;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-number">2px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.05</span>);
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.5</span>;
}
</code></pre>
<p>以上这些，基本上都是AI帮我完成调优的。</p>
<hr/>
<p><strong>除了以上几个功能点之外，我还实现了</strong></p>
<ol>
<li>退出登录聊天窗记忆功能：退出登录，记录上次聊天的对象，再次登录后自动打开最后一次聊天对象所在的分组、tab、聊天窗口、聊天记录</li>
<li>多语言切换：通过配置切换当前要展示的语言</li>
<li>快捷回复：添加（文本、图片、视频、语音）、删除、快捷发送</li>
<li>自动回复：接收到消息自动回复</li>
<li>翻译配置：支持发送出去的消息和接收到的消息，可以分别配置源语言、翻译为目标语言。比如发出去的是中文，实际对方接收到的是英文；接收到的是英文、韩文，聊天窗显示中文</li>
<li>未读分组、tab、好友红点标记等</li>
</ol>
<p>太多了，具体细节就不一一介绍了，光聊天一个窗口交互就复杂的一批（感觉要钱要少了，orz...</p>
<h2 data-id="heading-24">四、效果展示</h2>
<p>登录</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98418a379ea34304a86f864f628e9739~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZG95Lit5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077843&amp;x-signature=xmIuK%2FZS4Te%2Ba2GMEZ99sV68eow%3D" alt="image-20251223114030780.png" loading="lazy"/></p>
<p>聊天首页</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/557540fcbd98499db712129df3782e78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZG95Lit5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077843&amp;x-signature=tpq652ajSRqbLN8JccuhVSLtdeA%3D" alt="image-20251223114119055.png" loading="lazy"/></p>
<p>翻译配置</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80c818f0b1b6401da88207840bac5598~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZG95Lit5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077843&amp;x-signature=zol8YF6s9n95wY3SNw9QOexykc4%3D" alt="image-20251223114155843.png" loading="lazy"/></p>
<p>自动回复配置</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4016d60d51fe486584110a58d79f9bf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZG95Lit5rC0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077843&amp;x-signature=b2VJDFXtuabFfHiT7ZXmH5lTUcg%3D" alt="image-20251223114232951.png" loading="lazy"/></p>
<h2 data-id="heading-25">五、总结</h2>
<h3 data-id="heading-26">5.1 AI写代码的优缺点</h3>
<p>基于我这次和AI对话的实战来看，优点是非常明显的</p>
<ul>
<li>前端效率提升巨大</li>
<li>UI 微调不再痛苦</li>
<li>可以快速试错</li>
<li>非前端工程师也能做出“像样界面”</li>
</ul>
<p>但是<strong>缺点也很明显</strong>：</p>
<ul>
<li>不会主动考虑性能极限</li>
<li>容易“写得能用，但不够优雅”</li>
<li>架构必须你来定</li>
<li>需要你具备基本判断能力</li>
</ul>
<h3 data-id="heading-27">5.2 其他</h3>
<p>AI的使用远不限于此，如果你愿意学习如何使用：</p>
<ul>
<li>描述需求</li>
<li>提供上下文</li>
<li>精准反馈</li>
<li>与 AI 协作</li>
</ul>
<p>你会发现：<strong>一个人，可以完成过去一个小团队才能完成的事情。</strong></p>
<h2 data-id="heading-28">六、写到最后</h2>
<p>对我来说，AI 并不是让我“变成前端工程师”，而是让我在有限时间内，把一个本来可能妥协的项目，<strong>做到自己满意为止</strong>。</p>
<p>从某些方面来说，AI让我变的更高效，从之前排查问题靠百度、靠在社区提问，到现在有问题问AI，AI的准确率还不错；从之前靠自己经验写出一段逻辑代码，到现在请AI帮我优化，大大提高了我代码的质量；AI是个好东西，咱们程序员还是要擅于利用它，这样才有更多的时间“摸鱼"（提高自己）啊</p>
<blockquote>
<p>你有没有用 AI 真正写过项目呢？欢迎评论聊聊。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个基于 Vue 的 GitHub 用户搜索案例]]></title>    <link>https://juejin.cn/post/7586663700900839433</link>    <guid>https://juejin.cn/post/7586663700900839433</guid>    <pubDate>2025-12-23T07:45:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586663700900839433" data-draft-id="7586663700900790281" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个基于 Vue 的 GitHub 用户搜索案例"/> <meta itemprop="keywords" content="前端,Vue.js,前端框架"/> <meta itemprop="datePublished" content="2025-12-23T07:45:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="进击的野人"/> <meta itemprop="url" content="https://juejin.cn/user/1458425238667008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个基于 Vue 的 GitHub 用户搜索案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1458425238667008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    进击的野人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:45:55.000Z" title="Tue Dec 23 2025 07:45:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在学习 Vue 组件化开发的过程中，我通过一个 GitHub 用户搜索的小案例，将<strong>组件拆分、事件通信、条件渲染以及异步请求</strong>等核心知识点串联了起来。虽然功能不复杂，但非常适合作为理解 Vue 应用结构的练习。</p>
<p>整个项目由三个组件组成：<code>App.vue</code>、<code>MySearch.vue</code> 和 <code>MyList.vue</code>，采用了典型的“父容器 + 功能组件”的结构设计。</p>
<hr/>
<h2 data-id="heading-0">一、根组件 App.vue：只负责组合，不写业务</h2>
<p>先看根组件 <code>App.vue</code>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">MySearch</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">MyList</span>/&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MySearch</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/MySearch.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/MyList.vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'App'</span>,
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">MySearch</span>,
    <span class="hljs-title class_">MyList</span>
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>可以看到，<code>App.vue</code> <strong>没有任何业务逻辑</strong>，只做了三件事：</p>
<ol>
<li>引入子组件</li>
<li>注册子组件</li>
<li>在模板中组合页面结构</li>
</ol>
<p>这种写法非常符合 Vue 的设计思想：</p>
<blockquote>
<p>根组件只负责“搭架子”，具体功能全部下沉到子组件中。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、MySearch.vue：搜索逻辑与请求发起者</h2>
<h3 data-id="heading-2">1. 模板结构：输入 + 触发搜索</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;input
  <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
  <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"enter the name you search"</span>
  <span class="hljs-attr">v-model.trim</span>=<span class="hljs-string">"keyWord"</span>
  @<span class="hljs-attr">keyup.enter</span>=<span class="hljs-string">"searchUsers"</span>
/&gt;
&lt;button @<span class="hljs-attr">click</span>=<span class="hljs-string">"searchUsers"</span>&gt;Search&lt;/button&gt;
</code></pre>
<p>这里用到了几个非常关键的点：</p>
<ul>
<li><code>v-model.trim</code>：<br/>
自动去掉用户输入的首尾空格，避免无效请求</li>
<li><code>@keyup.enter</code>：<br/>
支持回车搜索，提升用户体验</li>
<li>按钮点击和回车复用同一个方法</li>
</ul>
<hr/>
<h3 data-id="heading-3">2. data 定义：只存搜索关键词</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">keyWord</span>: <span class="hljs-string">''</span>
  }
}
</code></pre>
<p>搜索组件的职责非常单一：<br/>
👉 <strong>只关心“搜什么”与“怎么搜”</strong></p>
<hr/>
<h3 data-id="heading-4">3. 核心方法：searchUsers</h3>
<pre><code class="hljs language-bash" lang="bash">methods: {
  <span class="hljs-function"><span class="hljs-title">searchUsers</span></span>() {
    // 搜索前，通知列表进入 loading 状态
    this.<span class="hljs-variable">$bus</span>.<span class="hljs-variable">$emit</span>(<span class="hljs-string">'getSearchData'</span>, {
      isFirst: <span class="hljs-literal">false</span>,
      isLoading: <span class="hljs-literal">true</span>,
      errMsg: <span class="hljs-string">''</span>,
      <span class="hljs-built_in">users</span>: []
    })

    axios.get(`https://api.github.com/search/users?q=<span class="hljs-variable">${this.keyWord}</span>`).<span class="hljs-keyword">then</span>(
      response =&gt; {
        this.<span class="hljs-variable">$bus</span>.<span class="hljs-variable">$emit</span>(<span class="hljs-string">'getSearchData'</span>, {
          isLoading: <span class="hljs-literal">false</span>,
          <span class="hljs-built_in">users</span>: response.data.items
        })
      },
      error =&gt; {
        this.<span class="hljs-variable">$bus</span>.<span class="hljs-variable">$emit</span>(<span class="hljs-string">'getSearchData'</span>, {
          isLoading: <span class="hljs-literal">false</span>,
          errMsg: error.message,
          <span class="hljs-built_in">users</span>: []
        })
      }
    )
  }
}
</code></pre>
<p>这一段代码是整个项目的<strong>逻辑核心</strong>，可以总结为三步：</p>
<ol>
<li>
<p><strong>请求开始前</strong></p>
<ul>
<li>
<p>通知列表组件：</p>
<ul>
<li>不再是首次进入</li>
<li>正在加载中</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>请求成功</strong></p>
<ul>
<li>将 GitHub 返回的用户数据发送给列表组件</li>
</ul>
</li>
<li>
<p><strong>请求失败</strong></p>
<ul>
<li>将错误信息传递给列表组件展示</li>
</ul>
</li>
</ol>
<blockquote>
<p>注意：<br/>
搜索组件<strong>不直接修改列表组件的数据</strong>，而是通过事件总线“通知结果”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">三、MyList.vue：统一管理页面展示状态</h2>
<h3 data-id="heading-6">1. 状态集中管理</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">data()</span> {
  <span class="hljs-string">return</span> {
    <span class="hljs-attr">info:</span> {
      <span class="hljs-attr">isFirst:</span> <span class="hljs-literal">true</span>,
      <span class="hljs-attr">isLoading:</span> <span class="hljs-literal">false</span>,
      <span class="hljs-attr">errMsg:</span> <span class="hljs-string">''</span>,
      <span class="hljs-attr">users:</span> []
    }
  }
}
</code></pre>
<p>这里用一个 <code>info</code> 对象统一管理所有 UI 状态，非常关键：</p>
<ul>
<li>是否首次进入</li>
<li>是否正在加载</li>
<li>是否有错误</li>
<li>是否有数据</li>
</ul>
<p>👉 <strong>状态集中，模板判断才会清晰</strong></p>
<hr/>
<h3 data-id="heading-7">2. 模板中的条件渲染</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 用户列表 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>
  <span class="hljs-attr">v-show</span>=<span class="hljs-string">"info.users.length"</span>
  <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in info.users"</span>
  <span class="hljs-attr">:key</span>=<span class="hljs-string">"user.login"</span>
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">:href</span>=<span class="hljs-string">"user.html_url"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"user.avatar_url"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100px;"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-text"</span>&gt;</span>{{ user.login }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"info.isFirst"</span>&gt;</span>欢迎！！！<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"info.isLoading"</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"info.errMsg"</span>&gt;</span>{{ info.errMsg }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
</code></pre>
<p>通过 <code>v-show</code> 控制不同状态下的界面展示：</p>
<ul>
<li>初始 → 欢迎提示</li>
<li>搜索中 → 加载中</li>
<li>成功 → 用户列表</li>
<li>失败 → 错误信息</li>
</ul>
<p>这正是<strong>真实业务中最常见的 UI 状态切换场景</strong>。</p>
<hr/>
<h3 data-id="heading-8">3. 接收搜索组件的数据（事件总线）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">$bus</span>.$on(<span class="hljs-string">'getSearchData'</span>, <span class="hljs-function"><span class="hljs-params">datas</span> =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span> = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span>, ...datas }
  })
}
</code></pre>
<p>这里的写法非常值得学习：</p>
<ul>
<li>使用展开运算符合并状态</li>
<li>只更新传过来的字段</li>
<li>保留原有未修改状态</li>
</ul>
<p>👉 这是一个<strong>低耦合、可维护性很强</strong>的写法。</p>
<hr/>
<h2 data-id="heading-9">四、为什么要用事件总线？</h2>
<p>在这个项目中：</p>
<ul>
<li><code>MySearch</code> 和 <code>MyList</code> 是<strong>兄弟组件</strong></li>
<li>它们之间没有直接的父子 props 关系</li>
</ul>
<p>使用事件总线的好处是：</p>
<ul>
<li>不需要层层传 props</li>
<li>组件之间完全解耦</li>
<li>非常适合小型项目和学习阶段</li>
</ul>
<p>虽然在大型项目中会使用 Vuex / Pinia，但在这里，<strong>事件总线是一个非常合适的选择</strong>。</p>
<hr/>
<h2 data-id="heading-10">五、总结</h2>
<p>通过这个 GitHub 用户搜索案例，我对 Vue 的理解不再停留在指令和语法层面，而是开始关注：</p>
<ul>
<li>组件应该如何拆分</li>
<li>数据应该由谁维护</li>
<li>不同状态下页面如何变化</li>
<li>组件之间如何通信才合理</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我是怎么把模型回复用tts播放的更自然的]]></title>    <link>https://juejin.cn/post/7586663700900921353</link>    <guid>https://juejin.cn/post/7586663700900921353</guid>    <pubDate>2025-12-23T07:50:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586663700900921353" data-draft-id="7586657335881596955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我是怎么把模型回复用tts播放的更自然的"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:50:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我是怎么把模型回复用tts播放的更自然的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:50:30.000Z" title="Tue Dec 23 2025 07:50:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">场景与痛点</h2>
<p>接 TTS（语音合成）服务的时候，经常碰到一个硬性限制：<strong>单次请求最多处理 50 个字符</strong>（或者是其他的长度限制）。</p>
<p>但现在的 AI 回复动不动就几百上千字，肯定得拆。</p>
<p>最开始的做法很简单粗暴：<strong>每 50 个字符切一刀，分批调接口。</strong></p>
<p>结果合成出来的语音听着像结巴：</p>
<blockquote>
<p>"今天我们去商场买了衣..." （停顿 1 秒）"...服，之后去吃了晚餐。"</p>
</blockquote>
<p>这就很难受了，"衣服"这个词被硬生生劈开，用户体验极差。</p>
<p>怎么解决？核心思路其实就一句话：<strong>让机器模拟人的自然换气。</strong></p>
<h2 data-id="heading-1">核心矛盾</h2>
<p>这其实是一个"规则冲突"问题：</p>
<ul>
<li><strong>TTS 的规则</strong>：长度必须 &lt; 50。</li>
<li><strong>语言的规则</strong>：停顿必须在"语义边界"（标点、词组空隙）。</li>
</ul>
<p>我们的目标是：<strong>在满足 TTS 硬性限制的前提下，尽量贴合语言的自然停顿。</strong></p>
<h2 data-id="heading-2">优化策略</h2>
<p>我们验证下来，这三个策略组合使用效果最好：</p>
<h3 data-id="heading-3">1. 标点边界优先（Priority Split）</h3>
<p>思路：<strong>宁可少切，不能乱切。</strong></p>
<p>只要没超长，就一直往后找，直到遇到句号、逗号、问号这些<strong>天然停顿点</strong>再切。</p>
<p>比如这段话：</p>
<blockquote>
<p>"今天天气很好，我们决定去公园散步，顺便买点水果回来。"</p>
</blockquote>
<ul>
<li><strong>硬切模式</strong>：切在"水果"中间。</li>
<li><strong>标点优先模式</strong>：
<pre><code class="hljs language-text" lang="text">片段1: "今天天气很好，我们决定去公园散步，" (20字符)
片段2: "顺便买点水果回来。" (10字符)
</code></pre>
</li>
</ul>
<p>虽然每个片段都远没到 50 字符，但保证了语义完整。</p>
<h3 data-id="heading-4">2. 缓冲回退（Buffer Backtrack）</h3>
<p>如果一句话特别长，中间完全没有标点，或者标点在 50 字符之外，怎么办？</p>
<p><strong>不要在第 50 个字符硬切，而是往回退。</strong></p>
<p>比如累积到 50 字了，发现卡在单词中间。这时候往回退 5-10 个字符，看看有没有空格、逗号或者其他稍微适合停顿的地方。</p>
<p>流程如下：</p>
<pre><code class="hljs language-text" lang="text">累积到上限 → 能切吗？(是标点/空格)
                  ↓
       不能 → 往回倒车 10 步 → 找到标点了吗？
                  ↓                  ↓
              没找到 (认命硬切)     找到了 (切分)
</code></pre>
<h3 data-id="heading-5">3. 短片段合并（Merge Short）</h3>
<p>切分过细会带来另一个问题：<strong>请求太碎，网络开销大，且声音断断续续。</strong></p>
<p>比如切成了：<code>"好的。"</code>、<code>"没问题。"</code>。
这两个完全可以合并成 <code>"好的。没问题。"</code> 一起发过去，只要合并后不超过 50 字符。</p>
<h2 data-id="heading-6">方案实现</h2>
<h3 data-id="heading-7">处理流程图</h3>
<p>这个逻辑用状态图描述最清晰：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[输入长文本] --&gt; B[逐字符累积]
    B --&gt; C{快到限制了?}
    C --&gt;|否| B
    C --&gt;|是| D[回退搜索标点]
    D --&gt; E{缓冲区内找到标点?}
    E --&gt;|是| F[在标点处切分]
    E --&gt;|否| G[没办法，强制切分]
    F --&gt; H[保存片段]
    G --&gt; H
    H --&gt; I{还有剩余文本?}
    I --&gt;|是| B
    I --&gt;|否| J[合并过短片段]
    J --&gt; K[输出最终列表]

    classDef process fill:#cce5ff,stroke:#0d6efd,color:#004085
    classDef decision fill:#fff3cd,stroke:#ffc107,color:#856404
    classDef endpoint fill:#d4edda,stroke:#28a745,color:#155724

    class A,K endpoint
    class C,E,I decision
    class B,D,F,G,H,J process
</code></pre>
<h3 data-id="heading-8">关键代码 (Python)</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">split_for_tts</span>(<span class="hljs-params">text, max_len=<span class="hljs-number">50</span>, buffer_size=<span class="hljs-number">10</span></span>):
    <span class="hljs-string">"""
    智能切分文本，优先保持语义完整
    """</span>
    <span class="hljs-comment"># 定义标点优先级：句子结束符 &gt; 短句分隔符</span>
    <span class="hljs-comment"># 实际场景中可以配置权重</span>
    stops = <span class="hljs-built_in">set</span>(<span class="hljs-string">'。，！？；：、.!?,;:'</span>)
    
    segments = []
    current_idx = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">while</span> current_idx &lt; <span class="hljs-built_in">len</span>(text):
        <span class="hljs-comment"># 剩余部分直接打包</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(text) - current_idx &lt;= max_len:
            segments.append(text[current_idx:])
            <span class="hljs-keyword">break</span>
            
        <span class="hljs-comment"># 预设切分点为最大长度处</span>
        cut_pos = current_idx + max_len
        found_stop = <span class="hljs-literal">False</span>
        
        <span class="hljs-comment"># 1. 策略：缓冲回退</span>
        <span class="hljs-comment"># 从 max_len 处往回找 buffer_size 个字符</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(cut_pos, cut_pos - buffer_size, -<span class="hljs-number">1</span>):
            <span class="hljs-keyword">if</span> i &lt; <span class="hljs-built_in">len</span>(text) <span class="hljs-keyword">and</span> text[i] <span class="hljs-keyword">in</span> stops:
                cut_pos = i + <span class="hljs-number">1</span> <span class="hljs-comment"># 包含标点</span>
                found_stop = <span class="hljs-literal">True</span>
                <span class="hljs-keyword">break</span>
        
        <span class="hljs-comment"># 2. 策略：兜底</span>
        <span class="hljs-comment"># 如果缓冲区没找到标点，就只能硬切了</span>
        <span class="hljs-comment"># (实际生产中这里可以再优化，比如尝试找空格)</span>
        
        segments.append(text[current_idx:cut_pos])
        current_idx = cut_pos

    <span class="hljs-keyword">return</span> merge_short_segments(segments, max_len)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">merge_short_segments</span>(<span class="hljs-params">segments, max_len, min_len=<span class="hljs-number">10</span></span>):
    <span class="hljs-string">"""
    合并碎片段，减少请求次数
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> segments: <span class="hljs-keyword">return</span> []
    
    merged = [segments[<span class="hljs-number">0</span>]]
    <span class="hljs-keyword">for</span> seg <span class="hljs-keyword">in</span> segments[<span class="hljs-number">1</span>:]:
        last = merged[-<span class="hljs-number">1</span>]
        <span class="hljs-comment"># 如果合并后不超长，且前一个太短，就合并</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(last) + <span class="hljs-built_in">len</span>(seg) &lt;= max_len <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(last) &lt; min_len:
            merged[-<span class="hljs-number">1</span>] += seg
        <span class="hljs-keyword">else</span>:
            merged.append(seg)
            
    <span class="hljs-keyword">return</span> merged
</code></pre>
<h2 data-id="heading-9">避坑指南</h2>
<p>在实际上线过程中，还踩过几个坑，提个醒：</p>
<ol>
<li><strong>保护语义实体</strong>：虽然发给 TTS 的通常是清洗后的纯文本，但文本里常有<strong>金额</strong>（<code>1,000</code>）、<strong>书名号</strong>（<code>《...》</code>）或<strong>特定短语</strong>。如果你在逗号处把 <code>1,000</code> 切开了，TTS 可能会把 <code>1,</code> 读成"一，"，剩下的 <code>000</code> 读成"零零零"。建议对这类实体做正则识别，确保它们完整地留在同一个片段里。</li>
<li><strong>英文单词边界</strong>：中文按字算，英文按词算。切分的时候一定要判断 <code>text[cut_pos]</code> 是不是字母，如果是，千万别切，继续往回退找空格。</li>
<li><strong>表情包过滤</strong>：很多 TTS 模型不支持 emoji，直接把 <code>😂</code> 这种符号喂进去可能会报错或者读出乱码，建议预处理直接干掉。</li>
</ol>
<h2 data-id="heading-10">总结</h2>
<p>TTS 优化的本质不是算法问题，而是<strong>体验问题</strong>。</p>
<p>不需要多高深的 NLP 模型，只需要几行简单的规则代码：<strong>多找标点，少硬切，适度合并</strong>。就能把"机器味"去掉一大半。</p>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《2025 AI 自动化新高度：一套代码搞定 iOS、Android 双端，全平台 AutoGLM 部署实战》]]></title>    <link>https://juejin.cn/post/7586861592710004772</link>    <guid>https://juejin.cn/post/7586861592710004772</guid>    <pubDate>2025-12-23T07:27:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586861592710004772" data-draft-id="7586684925106044971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《2025 AI 自动化新高度：一套代码搞定 iOS、Android 双端，全平台 AutoGLM 部署实战》"/> <meta itemprop="keywords" content="前端,全栈,人工智能"/> <meta itemprop="datePublished" content="2025-12-23T07:27:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ZsTs119"/> <meta itemprop="url" content="https://juejin.cn/user/3725615485435022"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《2025 AI 自动化新高度：一套代码搞定 iOS、Android 双端，全平台 AutoGLM 部署实战》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3725615485435022/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ZsTs119
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:27:12.000Z" title="Tue Dec 23 2025 07:27:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>还在为了在电脑上操控手机去翻遍碎片的教程？Android 连不上、iOS 搞不定、命令行太枯燥？</p>
<p>刷短视频、发微信、甚至抢票，能不能让 AI 替我操作手机？AutoGLM 虽然强大，但环境搭建总是卡在 “ADB 连不上” 或 “WDA 签名失败”？</p>
<p>本文是目前市面上最全的 <strong>AutoGLM 终极全能手册</strong>。我们不谈虚的理论，直接深度集成 <strong>iOS/Android 双端适配</strong>、<strong>Windows/macOS/Linux 三系统支持</strong>以及 <strong>GUI 可视化操作界面</strong>。不仅提供完整的下载链接，更包含从底层驱动到高层 AI 逻辑的保姆级实战拆解。</p>
</blockquote>
<h2 data-id="heading-1">开始</h2>
<p>本手册围绕以下 7 个核心模块展开，带你一站式打通 AI 手机自动化：</p>





















































<table><thead><tr><th><strong>序号</strong></th><th><strong>模块名称</strong></th><th><strong>模块核心内容</strong></th><th><strong>你能获得的核心价值</strong></th></tr></thead><tbody><tr><td>1</td><td><strong>全平台环境地基</strong></td><td>Python、Git 环境配置与三端路径挂载</td><td>确保所有工具在各系统下运行逻辑一致</td></tr><tr><td>2</td><td><strong>Android 驱动：ADB 深度配置</strong></td><td>SDK 下载、Path 配置、<strong>Linux 权限一键通</strong></td><td>打通 Android 端的指令传输链路</td></tr><tr><td>3</td><td><strong>iOS 驱动：WDA 与 Tidevice</strong></td><td><strong>Windows 签名 WDA</strong>、Tidevice 部署、跨端连接</td><td>突破苹果生态限制，实现 iOS 自动化</td></tr><tr><td>4</td><td><strong>AutoGLM 核心安装</strong></td><td>源码部署、依赖库安装、<strong>输入法优化</strong></td><td>部署 AI 智能体的核心算法与逻辑</td></tr><tr><td>5</td><td><strong>GUI 可视化界面部署</strong></td><td>GUI 安装、<strong>内核路径关联</strong>、Web 控制台配置</td><td>告别黑窗口，实现直观的图形化操控</td></tr><tr><td>6</td><td><strong>API 服务接入与测试</strong></td><td>智谱 AI 密钥配置、模型访问权限获取</td><td>为系统接入大模型“大脑”</td></tr><tr><td>7</td><td><strong>全场景实战与避坑</strong></td><td>双端微信实测、<strong>404/连接错误终极排查</strong></td><td>验证完整链路，提供企业级排查手册</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">（一）全平台环境地基</h2>
<blockquote>
<p><strong>顶层结论</strong>：统一开发环境是跨平台操作的前提。建议务必统一 Python 版本到 <strong>3.8 - 3.12</strong>，并确保环境变量配置正确，否则后续 GUI 关联内核时会频繁报错。</p>
</blockquote>
<h3 data-id="heading-3">1. 软件下载与验证</h3>
<ul>
<li>
<p><strong>Python (3.8 - 3.12)</strong> :</p>
<ul>
<li><strong>下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.python.org%2Fdownloads%2F" target="_blank" title="https://www.python.org/downloads/" ref="nofollow noopener noreferrer">python.org/downloads</a></li>
<li><strong>Windows</strong>: 安装时必须勾选 <code>Add Python to PATH</code>。</li>
<li><strong>macOS/Linux</strong>: <code>brew install python</code> 或 <code>sudo apt install python3</code>。</li>
</ul>
</li>
<li>
<p><strong>Git</strong>:</p>
<ul>
<li><strong>下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3Dhttps%3A%2F%2Fgit-scm.com%2Fdownloads" target="_blank" title="https://www.google.com/search?q=https://git-scm.com/downloads" ref="nofollow noopener noreferrer">git-scm.com</a></li>
<li><strong>验证</strong>: 终端输入 <code>git --version</code> 确认。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-4">（二）Android 驱动：ADB 深度配置</h2>
<blockquote>
<p><strong>顶层结论</strong>：ADB (Android Debug Bridge) 是 Android 端的命脉。不仅要配好 Path 路径，针对 Linux 用户和小米手机用户，还有特定的“权限门槛”需要跨越。</p>
</blockquote>
<h3 data-id="heading-5">1. 下载与环境变量</h3>
<ul>
<li>
<p><strong>官方 SDK Platform-Tools 下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fstudio%2Freleases%2Fplatform-tools" target="_blank" title="https://developer.android.com/studio/releases/platform-tools" ref="nofollow noopener noreferrer">Android 官方开发者工具</a></p>
</li>
<li>
<p><strong>Windows 配置</strong>:</p>
<ol>
<li>解压至 <code>C:\platform-tools</code>。</li>
<li>环境变量 -&gt; 系统变量 <code>Path</code> -&gt; 新建 <code>C:\platform-tools</code>。</li>
</ol>
</li>
<li>
<p><strong>macOS / Linux 安装</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">brew install --cask android-platform-tools  <span class="hljs-comment"># Mac</span>
sudo apt install android-tools-adb           <span class="hljs-comment"># Linux (Ubuntu)</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-6">2. Linux 权限一键通</h3>
<p>如果你是 Linux 用户，遇到 <code>adb devices</code> 显示 <code>no permissions</code>，请执行：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 自动生成 udev 规则</span>
echo '<span class="hljs-attr">SUBSYSTEM</span>==<span class="hljs-string">"usb"</span>, ATTR{idVendor}==<span class="hljs-string">"2836"</span>, MODE=<span class="hljs-string">"0666"</span>, GROUP=<span class="hljs-string">"plugdev"</span><span class="hljs-string">' | sudo tee /etc/udev/rules.d/51-android.rules
sudo udevadm control --reload-rules
sudo service udev restart
</span></code></pre>
<h3 data-id="heading-7">3. 小米设备（Android）调试必开项</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2b8e66fddd14db29276363c64d2062f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=rAeZDqh2khnYu14biLi3H1Jd2WM%3D" alt="screenshot-20251209-181423.png" loading="lazy"/></p>
<p>在“开发者选项”中，这三项<strong>缺一不可</strong>：</p>
<ul>
<li>✅ <strong>USB 调试</strong></li>
<li>✅ <strong>USB 调试（安全设置）</strong> ：不开启此项 AI 无法模拟点击！</li>
<li>✅ <strong>允许通过 USB 安装应用</strong>
这是手册的第二部分，重点攻克 <strong>iOS 的驱动签名难题</strong> 以及 <strong>AutoGLM 核心引擎的安装</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-8">（三）iOS 驱动：WDA 与 Tidevice 深度配置</h2>
<blockquote>
<p><strong>顶层结论</strong>：iOS 自动化的核心在于 WebDriverAgent (WDA)。虽然苹果生态闭源，但通过 PR 156 引入的 <code>tidevice</code>，我们可以在 Windows/Linux 上绕过 Xcode 操控 iPhone，关键在于 <strong>“如何正确给 WDA 签名”</strong> 。</p>
</blockquote>
<h3 data-id="heading-9">1. 核心工具下载</h3>
<ul>
<li>
<p><strong>Tidevice (PC端驱动)</strong> : 用于跨平台启动 iOS 自动化。</p>
<pre><code class="hljs">pip install tidevice
</code></pre>
</li>
<li>
<p><strong>Sideloadly (Windows 签名工具)</strong> : <a href="https://link.juejin.cn?target=https%3A%2F%2Fsideloadly.io%2F" target="_blank" title="https://sideloadly.io/" ref="nofollow noopener noreferrer">下载地址</a></p>
</li>
<li>
<p><strong>WebDriverAgent.ipa</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Fsearch%3Fq%3Dhttps%3A%2F%2Fgithub.com%2Fappium%2FWebDriverAgent%2Freleases" target="_blank" title="https://www.google.com/search?q=https://github.com/appium/WebDriverAgent/releases" ref="nofollow noopener noreferrer">官方编译包下载</a></p>
</li>
</ul>
<h3 data-id="heading-10">2. Windows 用户无 Mac 签名攻略</h3>
<ol>
<li>
<p><strong>准备 IPA</strong>: 下载上述 <code>WebDriverAgent.ipa</code>。</p>
</li>
<li>
<p><strong>连接设备</strong>: 用数据线连接 iPhone，打开 Sideloadly。</p>
</li>
<li>
<p><strong>配置签名</strong>:</p>
<ul>
<li>在 <code>iDevice</code> 处确认识别到你的 iPhone。</li>
<li>在 <code>Apple account</code> 处输入你的 Apple ID。</li>
<li>将下载好的 <code>IPA</code> 文件拖入 Sideloadly 左侧框。</li>
</ul>
</li>
<li>
<p><strong>开始安装</strong>: 点击 <code>Start</code>。安装成功后，iPhone 桌面会出现 <code>WebDriverAgent</code> 图标。</p>
</li>
<li>
<p><strong>手机授权</strong>:</p>
<ul>
<li>进入：<code>设置 -&gt; 通用 -&gt; 描述文件与设备管理</code>。</li>
<li>找到你的 Apple ID 证书，点击 <strong>“信任”</strong> 。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">3. 映射与启动</h3>
<p>在终端执行以下命令，启动 iOS 端的服务映射：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 1. 启动 WDA 服务</span>
<span class="hljs-string">tidevice</span> <span class="hljs-string">xctest</span> <span class="hljs-string">-B</span> <span class="hljs-string">com.facebook.WebDriverAgentRunner.xctrunner</span>

<span class="hljs-comment"># 2. 另开一个窗口进行端口转发 (默认端口 8100)</span>
<span class="hljs-string">tidevice</span> <span class="hljs-string">relay</span> <span class="hljs-number">8100 </span><span class="hljs-number">8100</span>
</code></pre>
<p><strong>验证</strong>: 访问 <code>http://localhost:8100/status</code>，若看到 JSON 格式的返回信息，说明 iOS 驱动已完全打通。</p>
<hr/>
<h2 data-id="heading-12">（四）AutoGLM 核心引擎安装</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee9358b92acb4a1889cddecacdd11399~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=HAS7VxXWMR5jLrXLfD5GdyxR3D0%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p><strong>顶层结论</strong>：核心引擎（Open-AutoGLM）是处理 AI 逻辑的“大脑”。安装时除了基础依赖，最容易被忽视的是 <strong>“输入法插件”</strong> ，不安装它，AI 无法在搜索框正确键入中文。</p>
</blockquote>
<h3 data-id="heading-13">1. 源码部署与依赖</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆主仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/zai-org/Open-AutoGLM.git
<span class="hljs-built_in">cd</span> Open-AutoGLM

<span class="hljs-comment"># 2. 安装依赖库</span>
pip install -r requirements.txt

<span class="hljs-comment"># 3. 以可编辑模式安装当前包</span>
pip install -e .
</code></pre>
<h3 data-id="heading-14">2. ADB Keyboard 安装（仅 Android）</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d0ee535012342ef905be344e39d18da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=YARTkBks%2BZzAkJmdYF6aADaVm30%3D" alt="image.png" loading="lazy"/></p>
<p>AI 操作时，手机原生输入法经常会弹出“候选词”遮挡屏幕。安装 ADB Keyboard 可以实现后台静默输入。</p>
<ul>
<li>
<p><strong>APK 下载</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsenzhk%2FADBKeyBoard%2Fraw%2Fmaster%2FADBKeyboard.apk" target="_blank" title="https://github.com/senzhk/ADBKeyBoard/raw/master/ADBKeyboard.apk" ref="nofollow noopener noreferrer">ADBKeyboard 下载链接</a></p>
</li>
<li>
<p><strong>安装命令</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确保手机已连上电脑</span>
adb install ADBKeyboard.apk
</code></pre>
</li>
<li>
<p><strong>激活设置</strong>:</p>
<ul>
<li>手机设置 -&gt; 语言和输入法 -&gt; 管理键盘。</li>
<li>开启 <strong>ADB Keyboard</strong>，并将其设为当前默认输入法。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-15">3. 环境变量预设</h3>
<p>为了让 GUI 能顺利调用核心代码，建议将项目路径写入系统环境变量。</p>
<ul>
<li>
<p><strong>Windows (PowerShell)</strong> :</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[Environment]</span>::<span class="hljs-built_in">SetEnvironmentVariable</span>(<span class="hljs-string">"AUTOGLM_CORE_PATH"</span>, <span class="hljs-string">"C:\AutoGLM\Open-AutoGLM"</span>, <span class="hljs-string">"User"</span>)
</code></pre>
</li>
<li>
<p><strong>Mac/Linux (bash/zsh)</strong> :</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">'export AUTOGLM_CORE_PATH="/your/path/Open-AutoGLM"'</span> &gt;&gt; ~/.zshrc
<span class="hljs-built_in">source</span> ~/.zshrc
</code></pre>
</li>
</ul>
<p>这是手册的最后一部分，我们将打通 <strong>GUI 可视化操作界面</strong>，接入 <strong>AI 核心服务</strong>，并提供全平台的<strong>避坑排查手册</strong>。</p>
<hr/>
<h2 data-id="heading-16">（五）GUI 可视化界面部署</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77a62e17169545fd9196e91b08f55243~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=iCdcbRrECFMILgRzY7e8AO8OyQg%3D" alt="524711939-b8cb6fbc-ca5b-452c-bcf4-7d5863d4577a.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5929a82165064585ab8b679db2373720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWnNUczExOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767079631&amp;x-signature=UxmskvJ9Vrah99GF7NgyclfTsQo%3D" alt="524712065-b32f2e46-5340-42f5-a0db-0033729e1605.png" loading="lazy"/></p>
<blockquote>
<p><strong>顶层结论</strong>：<code>AutoGLM-GUI</code> 提供了基于 Web 的直观控制台，不仅能实时投屏预览，还能记录 AI 的思考逻辑。关键点在于将 GUI 程序与前文安装的 <code>Open-AutoGLM</code> 内核进行路径关联。</p>
</blockquote>
<h3 data-id="heading-17">1. GUI 安装与路径关联</h3>
<p>建议从源码安装以方便后续调整配置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆 GUI 仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/suyiiyii/AutoGLM-GUI.git
<span class="hljs-built_in">cd</span> AutoGLM-GUI

<span class="hljs-comment"># 2. 安装界面依赖</span>
pip install -r requirements.txt
pip install -e .
</code></pre>
<h3 data-id="heading-18">2.内核路径配置文件</h3>
<p>如果 GUI 启动后提示“找不到内核”，请在 <code>AutoGLM-GUI</code> 根目录下手动创建或修改 <code>config.json</code>（或 <code>.env</code>）文件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"api"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"base_url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://open.bigmodel.cn/api/paas/v4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"autoglm-phone"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"core"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"C:/AutoGLM/Open-AutoGLM"</span>  <span class="hljs-comment">// 此处指向你模块（四）的安装路径</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8080</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-19">3. 启动控制台</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 执行启动命令</span>
<span class="hljs-string">autoglm-gui</span> <span class="hljs-string">--port</span> <span class="hljs-number">8080</span>
</code></pre>
<p>启动成功后，浏览器会自动打开 <code>http://localhost:8080</code>。你将看到集成的设备画面预览、实时日志输出以及任务输入框。</p>
<hr/>
<h2 data-id="heading-20">（六）API 服务接入：注入 AI 大脑</h2>
<blockquote>
<p><strong>顶层结论</strong>：AutoGLM 的操作逻辑由云端大模型驱动。目前最成熟的方案是使用智谱 AI 的 <code>autoglm-phone</code> 模型。</p>
</blockquote>
<h3 data-id="heading-21">1. 密钥申请步骤</h3>
<ol>
<li><strong>注册账号</strong>：访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.bigmodel.cn%2F" target="_blank" title="https://open.bigmodel.cn/" ref="nofollow noopener noreferrer">智谱 AI 开放平台</a>。</li>
<li><strong>获取 API Key</strong>：在控制台左侧“API Keys”页面点击创建。</li>
<li><strong>模型权限</strong>：确保账户余额充足（新手通常有免费额度）并拥有 <code>autoglm-phone</code> 访问权限。</li>
</ol>
<h3 data-id="heading-22">2. 环境变量一键配置</h3>
<p>为了避免每次运行都输入长字符串，建议配置全局环境变量：</p>
<ul>
<li><strong>Windows (PowerShell)</strong> : <code>$env:AUTOGLM_API_KEY="你的密钥"</code></li>
<li><strong>Mac/Linux (Terminal)</strong> : <code>export AUTOGLM_API_KEY="你的密钥"</code></li>
</ul>
<hr/>
<h2 data-id="heading-23">（七）全场景实战与终极避坑</h2>
<blockquote>
<p><strong>顶层结论</strong>：实战是检验配置的唯一标准。本模块提供双端测试命令及针对“三合一”集成后最常见问题的解决方案。</p>
</blockquote>
<h3 data-id="heading-24">1. 命令行测试（全平台命令对比）</h3>





















<table><thead><tr><th><strong>系统</strong></th><th><strong>运行命令示例</strong></th></tr></thead><tbody><tr><td><strong>Windows (PS)</strong></td><td><code>python main.py --model "autoglm-phone" --apikey "xxx" "打开微信发测试消息"</code></td></tr><tr><td><strong>macOS (Zsh)</strong></td><td><code>python3 main.py --model "autoglm-phone" --apikey "xxx" "打开微信发测试消息"</code></td></tr><tr><td><strong>Linux (Bash)</strong></td><td><code>python3 main.py --model "autoglm-phone" --apikey "xxx" "打开微信发测试消息"</code></td></tr></tbody></table>
<h3 data-id="heading-25">2. 终极报错排查手册</h3>



































<table><thead><tr><th><strong>错误代码 / 现象</strong></th><th><strong>可能原因</strong></th><th><strong>终极解决方案</strong></th></tr></thead><tbody><tr><td><strong>404 Not Found</strong></td><td>API URL 错误或模型名拼错</td><td>检查 base-url 结尾是否包含 <code>/v4</code>，确保 model 准确为 <code>autoglm-phone</code>。</td></tr><tr><td><strong>ADB Offline / Unauthorized</strong></td><td>手机端授权过期</td><td>拔插数据线，点击手机弹窗中的“始终允许此电脑调试”。</td></tr><tr><td><strong>GUI 启动提示端口占用</strong></td><td>8080 端口被其他服务占用</td><td>使用 <code>autoglm-gui --port 8081</code> 切换到空闲端口。</td></tr><tr><td><strong>iOS WDA 无法连接</strong></td><td>签名证书过期或端口未转发</td><td>重新运行 <code>tidevice relay 8100 8100</code> 确保通道畅通。</td></tr><tr><td><strong>Android 无法模拟点击</strong></td><td>小米手机“安全设置”未开</td><td>检查开发者选项，必须开启“USB 调试（安全设置）”。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-26">最后</h2>
<blockquote>
<p>恭喜你！通过这篇“三合一”全能手册，你已经打通了从底层硬件驱动（ADB/WDA）到高层 AI 可视化操控（GUI）的完整链路。AutoGLM 已经可以在你的指令下，在 Windows、Mac、Linux 三大系统上自如操控 iOS 与 Android 设备。</p>
</blockquote>
<blockquote>
<p><strong>如果你在安装过程中遇到任何奇怪的报错，欢迎在评论区贴出你的 Traceback 日志，我会第一时间为你诊断！</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-27">更多</h2>
<p>💻 Vue3 多端统一开发框架：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZsTs119%2Fvue3-multi-platform" target="_blank" title="https://github.com/ZsTs119/vue3-multi-platform" ref="nofollow noopener noreferrer">vue3-multi-platform</a></p>
<p>📊 HuggingFaceAI 论文智能分析系统：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZsTs119%2Fai-paper-analyzer" target="_blank" title="https://github.com/ZsTs119/ai-paper-analyzer" ref="nofollow noopener noreferrer">ai-paper-analyzer</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据可视化大屏模板：前端开发的效率革命与架构艺术]]></title>    <link>https://juejin.cn/post/7586889698241445951</link>    <guid>https://juejin.cn/post/7586889698241445951</guid>    <pubDate>2025-12-23T07:47:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586889698241445951" data-draft-id="7586902693856542762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据可视化大屏模板：前端开发的效率革命与架构艺术"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:47:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_chiu"/> <meta itemprop="url" content="https://juejin.cn/user/1644525124592974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据可视化大屏模板：前端开发的效率革命与架构艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1644525124592974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_chiu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:47:31.000Z" title="Tue Dec 23 2025 07:47:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深夜，资深前端工程师李峰面对第7个类似的可视化大屏需求陷入了沉思——同样的ECharts配置，同样的布局调整，同样繁琐的数据对接。而隔壁组的新人王明却已经通过一套模板系统，在3小时内交付了一个省级智慧城市的数据大屏。</p>
</blockquote>
<p>在2024年Stack Overflow开发者调查中，<strong>76%的前端开发者</strong>表示曾参与过数据可视化项目，而其中<strong>超过60%</strong> 抱怨“重复开发类似界面”是最大的痛点。与此同时，GitHub上标有“dashboard-template”的仓库星标数在过去一年增长了217%，揭示了模板化开发正在成为前端可视化领域的新趋势。</p>
<h2 data-id="heading-0">01 为何需要大屏模板：从重复劳动到高效开发</h2>
<p>每个前端开发者都经历过这样的场景：接到一个新的数据可视化需求，打开上次项目的代码，开始“借鉴”图表配置、布局CSS和数据处理逻辑。这种模式存在几个根本问题：</p>
<p><strong>技术债务累积</strong>：每次“复制-修改”都会带入特定业务的耦合代码，随着时间推移，项目变得难以维护。</p>
<p><strong>设计不一致</strong>：不同开发者甚至同一开发者在不同时间创建的可视化组件，在交互逻辑、颜色主题和响应方式上存在差异。</p>
<p><strong>开发效率低下</strong>：据统计，一个中等复杂度的数据大屏（包含10-15个图表组件）从零开发平均需要80-120小时，而基于高质量模板可将时间缩短至20-30小时。</p>
<p>模板化开发的本质是将通用解决方案产品化。一个好的大屏模板不仅是UI组件的集合，更是一套包含<strong>数据流管理、主题配置、响应式规则和性能优化</strong>的完整架构。</p>
<h2 data-id="heading-1">02 主流大屏模板架构解析</h2>
<p>现代数据可视化大屏模板通常采用分层架构设计，以下是一个典型的技术栈构成：</p>
<p><strong>可视化层</strong>：基于ECharts、AntV或D3.js的图表组件库，提供柱状图、折线图、饼图、地图等基础可视化元素。</p>
<p><strong>布局层</strong>：采用网格布局系统（如Grid Layout）或自由布局引擎，支持拖拽调整和响应式适配。</p>
<p><strong>数据层</strong>：统一的数据获取、转换和状态管理机制，常基于Redux、Mobx或Vuex实现。</p>
<p><strong>主题层</strong>：可配置的颜色、字体、间距系统，支持亮色/暗色模式切换。</p>
<p><strong>工具层</strong>：包含开发调试工具、性能监控和构建配置。</p>
<p>以阿里DataV为例，其模板系统采用了基于JSON Schema的配置驱动架构：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简化的模板配置示例</span>
{
  <span class="hljs-string">"templateMeta"</span>: {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"智慧城市监控模板"</span>,
    <span class="hljs-string">"version"</span>: <span class="hljs-string">"2.1.0"</span>,
    <span class="hljs-string">"author"</span>: <span class="hljs-string">"DataV Team"</span>
  },
  <span class="hljs-string">"layout"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"responsive-grid"</span>,
    <span class="hljs-string">"breakpoints"</span>: [<span class="hljs-number">1920</span>, <span class="hljs-number">1440</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">768</span>],
    <span class="hljs-string">"columns"</span>: <span class="hljs-number">24</span>
  },
  <span class="hljs-string">"widgets"</span>: [
    {
      <span class="hljs-string">"id"</span>: <span class="hljs-string">"real-time-flow"</span>,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"echarts-line"</span>,
      <span class="hljs-string">"position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"w"</span>: <span class="hljs-number">8</span>, <span class="hljs-string">"h"</span>: <span class="hljs-number">6</span> },
      <span class="hljs-string">"dataConfig"</span>: {
        <span class="hljs-string">"source"</span>: <span class="hljs-string">"api://realtime/flow"</span>,
        <span class="hljs-string">"refreshInterval"</span>: <span class="hljs-number">5000</span>
      },
      <span class="hljs-string">"styleConfig"</span>: {
        <span class="hljs-string">"theme"</span>: <span class="hljs-string">"auto"</span>,
        <span class="hljs-string">"colors"</span>: [<span class="hljs-string">"#5470c6"</span>, <span class="hljs-string">"#91cc75"</span>]
      }
    }
  ],
  <span class="hljs-string">"dataSources"</span>: {
    <span class="hljs-string">"defaultAdapter"</span>: <span class="hljs-string">"axios"</span>,
    <span class="hljs-string">"interceptors"</span>: [<span class="hljs-string">"auth"</span>, <span class="hljs-string">"error-handler"</span>]
  }
}
</code></pre>
<p>这种配置驱动的设计使得非技术人员也能通过修改JSON配置来调整大屏布局和内容，大幅降低了使用门槛。</p>
<h2 data-id="heading-2">03 实战：基于Vue3+ECharts的模块化大屏模板</h2>
<p>下面我们以Vue3技术栈为例，构建一个企业级大屏模板的核心部分：</p>
<h3 data-id="heading-3">可复用的图表组件设计</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- BaseChart.vue - 基础图表组件 --&gt;
&lt;template&gt;
  &lt;div class="chart-container" :style="containerStyle"&gt;
    &lt;div v-if="loading" class="chart-loading"&gt;
      &lt;LoadingSpinner /&gt;
    &lt;/div&gt;
    &lt;div v-else-if="error" class="chart-error"&gt;
      &lt;ErrorDisplay :message="error.message" /&gt;
    &lt;/div&gt;
    &lt;div v-else ref="chartEl" class="chart-canvas"&gt;&lt;/div&gt;
    
    &lt;!-- 工具栏 --&gt;
    &lt;ChartToolbar 
      v-if="showToolbar"
      @download="handleDownload"
      @fullscreen="handleFullscreen"
      @refresh="handleRefresh"
    /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted, onUnmounted, watch } from 'vue'
import * as echarts from 'echarts'
import { useResizeObserver } from '@vueuse/core'
import { debounce } from 'lodash-es'

const props = defineProps({
  options: { type: Object, required: true },
  autoResize: { type: Boolean, default: true },
  theme: { type: String, default: 'light' },
  loading: { type: Boolean, default: false },
  error: { type: Object, default: null }
})

const chartEl = ref(null)
let chartInstance = null

// 初始化图表
const initChart = () =&gt; {
  if (!chartEl.value) return
  
  chartInstance = echarts.init(chartEl.value, props.theme)
  chartInstance.setOption(props.options)
  
  // 添加响应式支持
  if (props.autoResize) {
    const { stop } = useResizeObserver(chartEl, debounce(() =&gt; {
      chartInstance?.resize()
    }, 300))
    
    onUnmounted(stop)
  }
}

// 监听选项变化
watch(() =&gt; props.options, (newOptions) =&gt; {
  if (chartInstance) {
    chartInstance.setOption(newOptions, true)
  }
}, { deep: true })

onMounted(initChart)
onUnmounted(() =&gt; {
  chartInstance?.dispose()
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-4">数据源抽象层</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// datasource/adapters/index.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAdapter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = config
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subscribers</span> = []
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">dataConfig</span>) {
    <span class="hljs-keyword">const</span> cacheKey = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateCacheKey</span>(dataConfig)
    
    <span class="hljs-comment">// 检查缓存</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">has</span>(cacheKey) &amp;&amp; !dataConfig.<span class="hljs-property">forceUpdate</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">get</span>(cacheKey)
    }
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeFetch</span>(dataConfig)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">set</span>(cacheKey, data)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifySubscribers</span>(dataConfig, data)
      <span class="hljs-keyword">return</span> data
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleError</span>(error, dataConfig)
      <span class="hljs-keyword">throw</span> error
    }
  }
  
  <span class="hljs-comment">// 抽象方法，由具体适配器实现</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">executeFetch</span>(<span class="hljs-params">dataConfig</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'executeFetch must be implemented'</span>)
  }
}

<span class="hljs-comment">// API数据源适配器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">DataSourceAdapter</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">executeFetch</span>(<span class="hljs-params">dataConfig</span>) {
    <span class="hljs-keyword">const</span> { url, method = <span class="hljs-string">'GET'</span>, params, headers } = dataConfig
    
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, {
      method,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
        ...headers
      },
      <span class="hljs-attr">body</span>: method !== <span class="hljs-string">'GET'</span> ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params) : <span class="hljs-literal">undefined</span>
    })
    
    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP <span class="hljs-subst">${response.status}</span>: <span class="hljs-subst">${response.statusText}</span>`</span>)
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
  }
}

<span class="hljs-comment">// WebSocket实时数据适配器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">DataSourceAdapter</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-variable language_">super</span>(config)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-literal">null</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reconnectAttempts</span> = <span class="hljs-number">0</span>
  }
  
  <span class="hljs-title function_">connect</span>(<span class="hljs-params">dataConfig</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>) <span class="hljs-keyword">return</span>
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(dataConfig.<span class="hljs-property">url</span>)
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifySubscribers</span>(dataConfig, data)
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleReconnection</span>(dataConfig)
    }
  }
}
</code></pre>
<h3 data-id="heading-5">布局管理系统</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// layout/LayoutEngine.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LayoutEngine</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">container, config</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = container
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = config
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">widgets</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">breakpoints</span> = [<span class="hljs-number">1920</span>, <span class="hljs-number">1440</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">768</span>, <span class="hljs-number">480</span>]
  }
  
  <span class="hljs-comment">// 响应式布局计算</span>
  <span class="hljs-title function_">calculateLayout</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> width = <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">clientWidth</span>
    <span class="hljs-keyword">const</span> currentBreakpoint = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getCurrentBreakpoint</span>(width)
    
    <span class="hljs-comment">// 基于断点的布局规则</span>
    <span class="hljs-keyword">const</span> layoutRules = {
      <span class="hljs-number">1920</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">24</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">24</span> },
      <span class="hljs-number">1440</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">20</span> },
      <span class="hljs-number">1024</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">16</span> },
      <span class="hljs-number">768</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">12</span> },
      <span class="hljs-number">480</span>: { <span class="hljs-attr">columns</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">gutter</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">margin</span>: <span class="hljs-number">8</span> }
    }
    
    <span class="hljs-keyword">return</span> layoutRules[currentBreakpoint]
  }
  
  <span class="hljs-comment">// 网格位置计算</span>
  <span class="hljs-title function_">computeWidgetPosition</span>(<span class="hljs-params">widgetConfig</span>) {
    <span class="hljs-keyword">const</span> layout = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateLayout</span>()
    <span class="hljs-keyword">const</span> { x, y, w, h } = widgetConfig.<span class="hljs-property">position</span>
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">left</span>: (x / layout.<span class="hljs-property">columns</span>) * <span class="hljs-number">100</span> + <span class="hljs-string">'%'</span>,
      <span class="hljs-attr">top</span>: (y * (layout.<span class="hljs-property">rowHeight</span> || <span class="hljs-number">50</span>)) + <span class="hljs-string">'px'</span>,
      <span class="hljs-attr">width</span>: <span class="hljs-string">`calc(<span class="hljs-subst">${(w / layout.columns) * <span class="hljs-number">100</span>}</span>% - <span class="hljs-subst">${layout.gutter}</span>px)`</span>,
      <span class="hljs-attr">height</span>: (h * (layout.<span class="hljs-property">rowHeight</span> || <span class="hljs-number">50</span>)) + <span class="hljs-string">'px'</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-6">04 模板性能优化策略</h2>
<p>大屏模板需要处理大量数据和高频率更新，性能优化至关重要：</p>
<p><strong>图表实例池管理</strong>：避免频繁创建销毁ECharts实例</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChartPool</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">maxSize = <span class="hljs-number">10</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span> = maxSize
  }
  
  <span class="hljs-title function_">getInstance</span>(<span class="hljs-params">key, initFn</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">has</span>(key)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">get</span>(key)
    }
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-property">size</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSize</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">evictOldest</span>()
    }
    
    <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">initFn</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">set</span>(key, instance)
    <span class="hljs-keyword">return</span> instance
  }
  
  <span class="hljs-title function_">evictOldest</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> oldestKey = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>
    <span class="hljs-keyword">const</span> instance = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">get</span>(oldestKey)
    instance.<span class="hljs-title function_">dispose</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">delete</span>(oldestKey)
  }
}
</code></pre>
<p><strong>数据更新批处理</strong>：避免频繁重绘</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createBatchUpdater</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> updateQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
  <span class="hljs-keyword">let</span> isUpdating = <span class="hljs-literal">false</span>
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">scheduleUpdate</span>(<span class="hljs-params">widgetId, updateFn</span>) {
      updateQueue.<span class="hljs-title function_">set</span>(widgetId, updateFn)
      
      <span class="hljs-keyword">if</span> (!isUpdating) {
        isUpdating = <span class="hljs-literal">true</span>
        <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flushUpdates</span>()
        })
      }
    },
    
    <span class="hljs-title function_">flushUpdates</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> updates = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(updateQueue.<span class="hljs-title function_">entries</span>())
      updateQueue.<span class="hljs-title function_">clear</span>()
      
      <span class="hljs-comment">// 批量执行更新</span>
      updates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[id, updateFn]</span>) =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-title function_">updateFn</span>()
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Update failed for widget <span class="hljs-subst">${id}</span>:`</span>, error)
        }
      })
      
      isUpdating = <span class="hljs-literal">false</span>
    }
  }
}
</code></pre>
<p><strong>虚拟滚动长列表</strong>：处理大数据集展示</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- VirtualScrollChart.vue --&gt;
&lt;template&gt;
  &lt;div class="virtual-scroll-container" @scroll="handleScroll"&gt;
    &lt;div class="scroll-content" :style="{ height: totalHeight + 'px' }"&gt;
      &lt;div 
        v-for="item in visibleItems" 
        :key="item.id"
        class="scroll-item"
        :style="{ transform: `translateY(${item.offset}px)` }"
      &gt;
        &lt;slot name="item" :item="item.data"&gt;&lt;/slot&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-7">05 模板定制与扩展机制</h2>
<p>优秀的大屏模板需要提供灵活的定制能力：</p>
<p><strong>主题系统</strong>：支持动态主题切换</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// themes/_variables.scss</span>
<span class="hljs-variable">$themes</span>: (
  light: (
    primary-bg: <span class="hljs-number">#ffffff</span>,
    chart-grid: <span class="hljs-number">#f0f0f0</span>,
    text-primary: <span class="hljs-number">#333333</span>,
  ),
  dark: (
    primary-bg: <span class="hljs-number">#1a1a1a</span>,
    chart-grid: <span class="hljs-number">#2a2a2a</span>,
    text-primary: <span class="hljs-number">#e0e0e0</span>,
  ),
  blue: (
    primary-bg: <span class="hljs-number">#f0f8ff</span>,
    chart-grid: <span class="hljs-number">#d9e7ff</span>,
    text-primary: <span class="hljs-number">#003366</span>,
  )
);

<span class="hljs-comment">// 混合器应用主题</span>
<span class="hljs-keyword">@mixin</span> theme(<span class="hljs-variable">$property</span>, <span class="hljs-variable">$key</span>, <span class="hljs-variable">$theme</span>: <span class="hljs-string">'light'</span>) {
  #{<span class="hljs-variable">$property</span>}: <span class="hljs-built_in">map-get</span>(<span class="hljs-built_in">map-get</span>(<span class="hljs-variable">$themes</span>, <span class="hljs-variable">$theme</span>), <span class="hljs-variable">$key</span>);
}
</code></pre>
<p><strong>插件系统</strong>：允许功能扩展</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplatePluginSystem</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">plugins</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span> = {
      <span class="hljs-string">'before-data-fetch'</span>: [],
      <span class="hljs-string">'after-chart-init'</span>: [],
      <span class="hljs-string">'layout-calculated'</span>: []
    }
  }
  
  <span class="hljs-title function_">registerPlugin</span>(<span class="hljs-params">name, plugin</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">plugins</span>.<span class="hljs-title function_">set</span>(name, plugin)
    
    <span class="hljs-comment">// 注册插件钩子</span>
    <span class="hljs-keyword">if</span> (plugin.<span class="hljs-property">hooks</span>) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(plugin.<span class="hljs-property">hooks</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">hookName</span> =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerHook</span>(hookName, plugin.<span class="hljs-property">hooks</span>[hookName])
      })
    }
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">triggerHook</span>(<span class="hljs-params">hookName, context</span>) {
    <span class="hljs-keyword">const</span> hooks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>[hookName] || []
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> hook <span class="hljs-keyword">of</span> hooks) {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">hook</span>(context)
    }
  }
}
</code></pre>
<h2 data-id="heading-8">06 开源大屏模板资源评测</h2>















































<table><thead><tr><th>模板名称</th><th>技术栈</th><th>特色功能</th><th>学习曲线</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>VueDataV</strong></td><td>Vue3 + ECharts</td><td>3D地球、飞线图、拖拽布局</td><td>中等</td><td>政府/企业大屏</td></tr><tr><td><strong>Ant Design Charts</strong></td><td>React + AntV</td><td>企业级设计系统、丰富图表</td><td>较低</td><td>中后台系统</td></tr><tr><td><strong>D3.js Dashboard</strong></td><td>D3.js + React</td><td>高度自定义、复杂可视化</td><td>高</td><td>数据密集型分析</td></tr><tr><td><strong>Apache Superset</strong></td><td>React + 多种引擎</td><td>完整BI解决方案、SQL编辑</td><td>中等</td><td>商业智能平台</td></tr><tr><td><strong>Grafana</strong></td><td>React + Flot</td><td>监控专用、警报系统</td><td>中等</td><td>运维监控大屏</td></tr></tbody></table>
<h2 data-id="heading-9">07 从使用模板到贡献模板</h2>
<p>作为前端开发者，使用模板只是起点，真正的成长在于理解模板背后的设计思想并做出贡献：</p>
<ol>
<li><strong>源码学习</strong>：选择1-2个高质量开源模板，深入研究其架构设计</li>
<li><strong>定制开发</strong>：基于业务需求对模板进行二次开发</li>
<li><strong>抽象封装</strong>：将通用功能提取为可复用组件或插件</li>
<li><strong>开源贡献</strong>：修复bug、添加功能或完善文档</li>
</ol>
<p>大屏模板的真正价值不在于减少编码量，而在于<strong>标准化开发流程、提升代码质量、统一设计语言</strong>。当你的团队拥有自己的模板库时，新项目启动时间可以从数周缩短到数小时，而且能保持所有项目的一致性和可维护性。</p>
<hr/>
<p>深圳某智慧城市项目指挥中心，三块4K大屏实时展示着城市运行的800多项指标。年轻的开发者张涛在屏幕前调试着新的交通流量预测模块——基于团队自研的大屏模板，他仅用两天就集成了这个原本需要两周的功能。</p>
<p>在他身后，模板配置平台显示着<strong>187个</strong>正在运行的定制化大屏实例，而核心模板库的更新记录显示，最新一次优化将大屏的首屏加载时间从<strong>3.2秒降低到1.4秒</strong>。这不仅是技术的进步，更是前端开发范式的转变——从手工作坊到标准化生产的进化之路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【TS】虚拟列表无渲染逻辑内核]]></title>    <link>https://juejin.cn/post/7586890269698621494</link>    <guid>https://juejin.cn/post/7586890269698621494</guid>    <pubDate>2025-12-23T07:51:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586890269698621494" data-draft-id="7586879894206939199" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【TS】虚拟列表无渲染逻辑内核"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:51:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="七月十二"/> <meta itemprop="url" content="https://juejin.cn/user/145549432455998"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【TS】虚拟列表无渲染逻辑内核
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/145549432455998/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    七月十二
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:51:17.000Z" title="Tue Dec 23 2025 07:51:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">VirtualCore</h2>
<p>虚拟列表无渲染逻辑内核，专注于位置计算与状态管理，不绑定任何 UI 框架。</p>
<h3 data-id="heading-1">特性</h3>
<ul>
<li><strong>框架无关</strong>：纯 TypeScript 实现，可配合 Vue、React、原生 JS 等任意框架使用</li>
<li><strong>动态高度</strong>：支持每行不同高度，实测后自动更新位置信息</li>
<li><strong>滚动锚定</strong>：高度变化时自动计算滚动补偿，避免内容跳动</li>
<li><strong>精确跳转</strong>：迭代收敛式跳转算法，确保准确定位到目标行</li>
<li><strong>动态数据</strong>：支持运行时增减列表总数</li>
</ul>
<h3 data-id="heading-2">快速开始</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">VirtualCore</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./VirtualCore'</span>

<span class="hljs-comment">// 1. 创建实例</span>
<span class="hljs-keyword">const</span> core = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VirtualCore</span>({
  <span class="hljs-attr">total</span>: <span class="hljs-number">1000</span>,           <span class="hljs-comment">// 列表总数</span>
  <span class="hljs-attr">defaultHeight</span>: <span class="hljs-number">50</span>,     <span class="hljs-comment">// 预估行高</span>
  <span class="hljs-attr">buffer</span>: <span class="hljs-number">5</span>,             <span class="hljs-comment">// 上下缓冲行数（可选，默认 5）</span>
  <span class="hljs-attr">onTotalHeightChange</span>: <span class="hljs-function">(<span class="hljs-params">height</span>) =&gt;</span> {
    <span class="hljs-comment">// 更新容器总高度</span>
    container.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${height}</span>px`</span>
  }
})

<span class="hljs-comment">// 2. 滚动时获取渲染范围</span>
container.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> { startIndex, endIndex, offset } = core.<span class="hljs-title function_">getRenderRange</span>(
    container.<span class="hljs-property">scrollTop</span>,
    container.<span class="hljs-property">clientHeight</span>
  )
  
  <span class="hljs-comment">// 渲染 startIndex ~ endIndex 范围的数据</span>
  <span class="hljs-comment">// offset 是列表容器的 translateY 偏移量</span>
})

<span class="hljs-comment">// 3. 元素渲染后更新真实高度</span>
<span class="hljs-keyword">const</span> updates = renderedItems.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
  <span class="hljs-attr">index</span>: item.<span class="hljs-property">index</span>,
  <span class="hljs-attr">height</span>: item.<span class="hljs-property">element</span>.<span class="hljs-property">offsetHeight</span>
}))

<span class="hljs-keyword">const</span> { scrollCorrection } = core.<span class="hljs-title function_">updateHeights</span>(updates, container.<span class="hljs-property">scrollTop</span>)

<span class="hljs-comment">// 应用滚动补偿，防止内容跳动</span>
<span class="hljs-keyword">if</span> (scrollCorrection !== <span class="hljs-number">0</span>) {
  container.<span class="hljs-property">scrollTop</span> += scrollCorrection
}
</code></pre>
<h3 data-id="heading-3">API</h3>
<h4 data-id="heading-4">构造函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">VirtualCore</span>(<span class="hljs-attr">config</span>: <span class="hljs-title class_">VirtualCoreConfig</span>)
</code></pre>








































<table><thead><tr><th>参数</th><th>类型</th><th>必填</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>total</code></td><td><code>number</code></td><td>是</td><td>-</td><td>列表总行数</td></tr><tr><td><code>defaultHeight</code></td><td><code>number</code></td><td>是</td><td>-</td><td>预估默认行高</td></tr><tr><td><code>buffer</code></td><td><code>number</code></td><td>否</td><td><code>5</code></td><td>可视区域外的缓冲行数</td></tr><tr><td><code>onTotalHeightChange</code></td><td><code>(height: number) =&gt; void</code></td><td>否</td><td>-</td><td>总高度变化回调</td></tr></tbody></table>
<h4 data-id="heading-5">核心方法</h4>
<h5 data-id="heading-6"><code>getRenderRange(scrollTop, viewHeight): RenderRange</code></h5>
<p>根据滚动位置计算需要渲染的行范围。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> range = core.<span class="hljs-title function_">getRenderRange</span>(scrollTop, viewHeight)

<span class="hljs-comment">// 返回值</span>
{
  <span class="hljs-attr">startIndex</span>: <span class="hljs-built_in">number</span>   <span class="hljs-comment">// 渲染起始索引</span>
  <span class="hljs-attr">endIndex</span>: <span class="hljs-built_in">number</span>     <span class="hljs-comment">// 渲染结束索引</span>
  <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span>       <span class="hljs-comment">// 列表容器的 Y 轴偏移量</span>
  <span class="hljs-attr">anchorIndex</span>: <span class="hljs-built_in">number</span>  <span class="hljs-comment">// 锚点索引（可视区域第一行）</span>
}
</code></pre>
<h5 data-id="heading-7"><code>updateHeights(updates, currentScrollTop): UpdateCorrection</code></h5>
<p>批量更新行高，返回滚动补偿值。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> { scrollCorrection } = core.<span class="hljs-title function_">updateHeights</span>([
  { <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">80</span> },
  { <span class="hljs-attr">index</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">60</span> }
], container.<span class="hljs-property">scrollTop</span>)

<span class="hljs-comment">// 应用补偿</span>
container.<span class="hljs-property">scrollTop</span> += scrollCorrection
</code></pre>
<h5 data-id="heading-8"><code>scrollToIndex(index, callbacks, options?)</code></h5>
<p>迭代收敛式精确跳转到指定行。</p>
<pre><code class="hljs language-typescript" lang="typescript">core.<span class="hljs-title function_">scrollToIndex</span>(<span class="hljs-number">100</span>, {
  <span class="hljs-attr">onScroll</span>: <span class="hljs-function">(<span class="hljs-params">targetTop</span>) =&gt;</span> {
    <span class="hljs-comment">// 执行滚动，可返回 Promise</span>
    container.<span class="hljs-title function_">scrollTo</span>({ <span class="hljs-attr">top</span>: targetTop, <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> })
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">300</span>) <span class="hljs-comment">// 等待动画完成</span>
    })
  },
  <span class="hljs-attr">onComplete</span>: <span class="hljs-function">(<span class="hljs-params">finalTop, iterations</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`跳转完成，经过 <span class="hljs-subst">${iterations}</span> 次迭代`</span>)
  },
  <span class="hljs-attr">onAbort</span>: <span class="hljs-function">(<span class="hljs-params">reason</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`跳转中断: <span class="hljs-subst">${reason}</span>`</span>)
  }
}, {
  <span class="hljs-attr">threshold</span>: <span class="hljs-number">10</span>,      <span class="hljs-comment">// 收敛阈值（可选）</span>
  <span class="hljs-attr">maxIterations</span>: <span class="hljs-number">10</span>   <span class="hljs-comment">// 最大迭代次数（可选）</span>
})
</code></pre>
<h4 data-id="heading-9">辅助方法</h4>









































<table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>getTotalHeight()</code></td><td>获取列表总高度</td></tr><tr><td><code>getTopByIndex(index)</code></td><td>获取指定行的 top 值</td></tr><tr><td><code>getItemPosition(index)</code></td><td>获取指定行的完整位置信息</td></tr><tr><td><code>setTotal(newTotal)</code></td><td>动态设置列表总数</td></tr><tr><td><code>getTotal()</code></td><td>获取当前列表总数</td></tr><tr><td><code>reset(newTotal?)</code></td><td>重置所有位置信息</td></tr><tr><td><code>abortScrollTo()</code></td><td>手动中断跳转</td></tr><tr><td><code>isScrolling()</code></td><td>检查是否正在跳转中</td></tr></tbody></table>
<h3 data-id="heading-10">使用示例</h3>
<h4 data-id="heading-11">Vue 3 组合式 API</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { ref, onMounted, computed } from 'vue'
import VirtualCore from './VirtualCore'

const props = defineProps&lt;{ items: any[] }&gt;()

const containerRef = ref&lt;HTMLElement&gt;()
const scrollTop = ref(0)
const totalHeight = ref(0)

const core = new VirtualCore({
  total: props.items.length,
  defaultHeight: 50,
  onTotalHeightChange: (h) =&gt; { totalHeight.value = h }
})

const renderRange = computed(() =&gt; 
  core.getRenderRange(scrollTop.value, containerRef.value?.clientHeight || 0)
)

const visibleItems = computed(() =&gt; {
  const { startIndex, endIndex } = renderRange.value
  return props.items.slice(startIndex, endIndex + 1).map((item, i) =&gt; ({
    ...item,
    _index: startIndex + i
  }))
})

function onScroll(e: Event) {
  scrollTop.value = (e.target as HTMLElement).scrollTop
}

// 渲染后更新高度
function updateItemHeights(elements: HTMLElement[]) {
  const updates = elements.map((el, i) =&gt; ({
    index: renderRange.value.startIndex + i,
    height: el.offsetHeight
  }))
  
  const { scrollCorrection } = core.updateHeights(updates, scrollTop.value)
  if (scrollCorrection &amp;&amp; containerRef.value) {
    containerRef.value.scrollTop += scrollCorrection
  }
}
&lt;/script&gt;

&lt;template&gt;
  &lt;div ref="containerRef" class="virtual-container" @scroll="onScroll"&gt;
    &lt;div :style="{ height: totalHeight + 'px' }"&gt;
      &lt;div :style="{ transform: `translateY(${renderRange.offset}px)` }"&gt;
        &lt;div v-for="item in visibleItems" :key="item._index"&gt;
          &lt;!-- 渲染内容 --&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-12">跳转到指定行</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">scrollToRow</span>(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) {
  core.<span class="hljs-title function_">scrollToIndex</span>(index, {
    <span class="hljs-attr">onScroll</span>: <span class="hljs-function">(<span class="hljs-params">top</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
        containerRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">scrollTo</span>({ top, <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> })
        <span class="hljs-comment">// 等待滚动动画</span>
        <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">300</span>)
      })
    },
    <span class="hljs-attr">onComplete</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'跳转完成'</span>)
    }
  })
}
</code></pre>
<h3 data-id="heading-13">注意事项</h3>
<h4 data-id="heading-14">性能相关</h4>
<ul>
<li><strong>超大列表</strong>：超过 10 万行时，频繁的高度更新可能有性能影响</li>
<li><strong>批量更新</strong>：尽量合并多次 <code>updateHeights</code> 调用为一次批量更新</li>
<li><strong>预估高度</strong>：<code>defaultHeight</code> 越接近真实高度，初次渲染的跳动越小</li>
</ul>
<h4 data-id="heading-15">回调限制</h4>
<ul>
<li><code>onTotalHeightChange</code> 回调中<strong>不要</strong>调用 VirtualCore 的任何修改方法，避免重入问题</li>
</ul>
<h4 data-id="heading-16">跳转行为</h4>
<ul>
<li>跳转采用迭代收敛算法，目标行之前的元素高度确定后才能精确定位</li>
<li>如果目标行很远且中间元素高度差异大，可能需要多次迭代</li>
<li>可通过 <code>maxIterations</code> 限制最大迭代次数，避免极端情况</li>
</ul>
<h4 data-id="heading-17">滚动锚定</h4>
<ul>
<li>只有<strong>完全在视口上方</strong>的元素高度变化才会触发滚动补偿</li>
<li>跨越视口边界或在视口内的元素高度变化不补偿，避免干扰用户操作</li>
</ul>
<h3 data-id="heading-18">类型定义</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ItemPosition</span> {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">top</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">bottom</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HeightUpdate</span> {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">RenderRange</span> {
  <span class="hljs-attr">startIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">endIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">anchorIndex</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UpdateCorrection</span> {
  <span class="hljs-attr">scrollCorrection</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToCallbacks</span> {
  <span class="hljs-attr">onScroll</span>: <span class="hljs-function">(<span class="hljs-params">targetTop: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;
  onComplete?: <span class="hljs-function">(<span class="hljs-params">finalTop: <span class="hljs-built_in">number</span>, iterations: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
  onAbort?: <span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToOptions</span> {
  threshold?: <span class="hljs-built_in">number</span>
  maxIterations?: <span class="hljs-built_in">number</span>
}
</code></pre>
<h2 data-id="heading-19">源码</h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 每一行位置信息的接口定义
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ItemPosition</span> {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">top</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">bottom</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 更新行高请求的接口定义
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HeightUpdate</span> {
  <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 渲染范围的接口定义
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">RenderRange</span> {
  <span class="hljs-attr">startIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">endIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">anchorIndex</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 高度更新返回的修正值接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UpdateCorrection</span> {
  <span class="hljs-attr">scrollCorrection</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 初始化配置接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">VirtualCoreConfig</span> {
  <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">defaultHeight</span>: <span class="hljs-built_in">number</span>
  buffer?: <span class="hljs-built_in">number</span>
  onTotalHeightChange?: <span class="hljs-function">(<span class="hljs-params">totalHeight: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-comment">/**
 * 跳转回调接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToCallbacks</span> {
  <span class="hljs-comment">/** 需要滚动到新位置时调用，返回 Promise 表示滚动动画完成 */</span>
  <span class="hljs-attr">onScroll</span>: <span class="hljs-function">(<span class="hljs-params">targetTop: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;
  <span class="hljs-comment">/** 跳转完成时调用 */</span>
  onComplete?: <span class="hljs-function">(<span class="hljs-params">finalTop: <span class="hljs-built_in">number</span>, iterations: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-comment">/** 跳转被中断或失败时调用 */</span>
  onAbort?: <span class="hljs-function">(<span class="hljs-params">reason: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
}

<span class="hljs-comment">/**
 * 跳转配置
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToOptions</span> {
  <span class="hljs-comment">/** 收敛阈值，位置差小于此值认为完成（默认为 defaultHeight） */</span>
  threshold?: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 最大迭代次数（默认 10） */</span>
  maxIterations?: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">/**
 * 跳转状态
 * - idle: 空闲
 * - scrolling: 正在执行滚动动画
 * - waiting: 滚动完成，等待高度更新
 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ScrollToStatus</span> = <span class="hljs-string">'idle'</span> | <span class="hljs-string">'scrolling'</span> | <span class="hljs-string">'waiting'</span>

<span class="hljs-comment">/**
 * 跳转上下文（内部使用）
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ScrollToContext</span> {
  <span class="hljs-attr">targetIndex</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 上一次迭代时目标索引的 top 值 */</span>
  <span class="hljs-attr">lastTop</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-comment">/** 当前迭代次数 */</span>
  <span class="hljs-attr">iterations</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">maxIterations</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">threshold</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">callbacks</span>: <span class="hljs-title class_">ScrollToCallbacks</span>
  <span class="hljs-attr">status</span>: <span class="hljs-title class_">ScrollToStatus</span>
  <span class="hljs-comment">/** 在 scrolling 状态期间是否收到了高度更新 */</span>
  <span class="hljs-attr">pendingHeightUpdate</span>: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-comment">/**
 * VirtualCore: 虚拟列表无渲染逻辑内核 (TypeScript 版)
 *
 * 功能：
 * 1. 维护每一行的位置信息 (top, bottom, height)
 * 2. 根据滚动位置计算需要渲染的行范围
 * 3. 支持动态高度更新，并提供滚动锚定
 * 4. 支持动态调整列表总数
 * 5. 迭代收敛式精确跳转
 *
 * 注意事项：
 * - onTotalHeightChange 回调中不应该调用 VirtualCore 的任何修改方法，避免重入问题
 * - 对于超大列表（&gt; 10万行），频繁的高度更新可能会有性能影响
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualCore</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">defaultHeight</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">buffer</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-keyword">private</span> onTotalHeightChange?: <span class="hljs-function">(<span class="hljs-params">totalHeight: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>

  <span class="hljs-keyword">private</span> <span class="hljs-attr">positions</span>: <span class="hljs-title class_">ItemPosition</span>[] = []

  <span class="hljs-comment">/** 跳转上下文 */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">scrollToCtx</span>: <span class="hljs-title class_">ScrollToContext</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config: VirtualCoreConfig</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> = config.<span class="hljs-property">total</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span> = config.<span class="hljs-property">defaultHeight</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span> = config.<span class="hljs-property">buffer</span> ?? <span class="hljs-number">5</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onTotalHeightChange</span> = config.<span class="hljs-property">onTotalHeightChange</span>

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_initPositions</span>()
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 基础方法</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 初始化位置表，预估初始高度
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_initPositions</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span> = []
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>; i++) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i] = {
        <span class="hljs-attr">index</span>: i,
        <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>,
        <span class="hljs-attr">top</span>: i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>,
        <span class="hljs-attr">bottom</span>: (i + <span class="hljs-number">1</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>
      }
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_notifyHeightChange</span>()
  }

  <span class="hljs-comment">/**
   * 获取当前总高度
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getTotalHeight</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> === <span class="hljs-number">0</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    }
    <span class="hljs-keyword">const</span> lastIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> - <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> (lastIndex &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[lastIndex].<span class="hljs-property">bottom</span>
  }

  <span class="hljs-comment">/**
   * 获取渲染区间及偏移量 (核心用于 UI 渲染)
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getRenderRange</span>(<span class="hljs-attr">scrollTop</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">viewHeight</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">RenderRange</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">startIndex</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">endIndex</span>: -<span class="hljs-number">1</span>,
        <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">anchorIndex</span>: <span class="hljs-number">0</span>
      }
    }

    <span class="hljs-keyword">const</span> anchorIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_findStartIndex</span>(scrollTop), <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> - <span class="hljs-number">1</span>)
    <span class="hljs-keyword">const</span> startIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, anchorIndex - <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>)

    <span class="hljs-keyword">const</span> endAnchor = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_findStartIndex</span>(scrollTop + viewHeight)
    <span class="hljs-keyword">const</span> endIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> - <span class="hljs-number">1</span>, endAnchor + <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>)

    <span class="hljs-keyword">const</span> offset = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[startIndex].<span class="hljs-property">top</span>

    <span class="hljs-keyword">return</span> {
      startIndex,
      endIndex,
      offset,
      anchorIndex
    }
  }

  <span class="hljs-comment">/**
   * 获取指定索引的 top 值（仅查询，不触发跳转）
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getTopByIndex</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTotalHeight</span>()
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[index].<span class="hljs-property">top</span>
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 高度更新</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 更新行高并返回修正值
   *
   * <span class="hljs-doctag">@param</span> updates 实测到的真实高度数据集合
   * <span class="hljs-doctag">@param</span> currentScrollTop 容器当前的滚动位置
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">updateHeights</span>(<span class="hljs-attr">updates</span>: <span class="hljs-title class_">HeightUpdate</span>[], <span class="hljs-attr">currentScrollTop</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">UpdateCorrection</span> {
    <span class="hljs-keyword">if</span> (updates.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">scrollCorrection</span>: <span class="hljs-number">0</span> }
    }

    <span class="hljs-keyword">const</span> validUpdates = updates.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">{ index }</span>) =&gt;</span> index &gt;= <span class="hljs-number">0</span> &amp;&amp; index &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>)

    <span class="hljs-keyword">if</span> (validUpdates.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">scrollCorrection</span>: <span class="hljs-number">0</span> }
    }

    validUpdates.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">index</span> - b.<span class="hljs-property">index</span>)

    <span class="hljs-keyword">let</span> scrollCorrection = <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> hasHeightChanged = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">let</span> firstChangedIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>

    validUpdates.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">{ index, height }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[index]
      <span class="hljs-keyword">const</span> oldHeight = item.<span class="hljs-property">height</span>
      <span class="hljs-keyword">const</span> diff = height - oldHeight

      <span class="hljs-keyword">if</span> (diff !== <span class="hljs-number">0</span>) {
        hasHeightChanged = <span class="hljs-literal">true</span>

        <span class="hljs-keyword">if</span> (index &lt; firstChangedIndex) {
          firstChangedIndex = index
        }

        <span class="hljs-comment">// 改进的滚动锚定逻辑</span>
        <span class="hljs-comment">// 只有当元素完全在视口上方时才进行补偿</span>
        <span class="hljs-keyword">const</span> itemTop = item.<span class="hljs-property">top</span>
        <span class="hljs-keyword">if</span> (itemTop + oldHeight &lt;= currentScrollTop) {
          <span class="hljs-comment">// 元素完全在视口上方</span>
          scrollCorrection += diff
        }
        <span class="hljs-comment">// 元素跨越视口边界或在视口内/下方，不补偿</span>

        item.<span class="hljs-property">height</span> = height
      }
    })

    <span class="hljs-keyword">if</span> (hasHeightChanged) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_recalculatePositions</span>(firstChangedIndex)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_notifyHeightChange</span>()

      <span class="hljs-comment">// 标记有高度更新待处理</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'scrolling'</span>) {
          <span class="hljs-comment">// 滚动进行中收到高度更新，标记待处理</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">pendingHeightUpdate</span> = <span class="hljs-literal">true</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'waiting'</span>) {
          <span class="hljs-comment">// 已经在等待状态，直接检查收敛</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_checkScrollToConvergence</span>()
        }
      }
    }

    <span class="hljs-keyword">return</span> { scrollCorrection }
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 迭代收敛式跳转</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 开始跳转到指定索引（迭代收敛式）
   *
   * <span class="hljs-doctag">@param</span> index 目标行索引
   * <span class="hljs-doctag">@param</span> callbacks 回调函数
   * <span class="hljs-doctag">@param</span> options 配置选项
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">scrollToIndex</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">callbacks</span>: <span class="hljs-title class_">ScrollToCallbacks</span>, options?: <span class="hljs-title class_">ScrollToOptions</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 边界处理</span>
    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) index = <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) index = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> - <span class="hljs-number">1</span>)

    <span class="hljs-comment">// 如果列表为空，直接完成</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> === <span class="hljs-number">0</span>) {
      callbacks.<span class="hljs-property">onComplete</span>?.(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 如果已有跳转进行中，先中断</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'new scroll requested'</span>)
    }

    <span class="hljs-keyword">const</span> threshold = options?.<span class="hljs-property">threshold</span> ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>
    <span class="hljs-keyword">const</span> maxIterations = options?.<span class="hljs-property">maxIterations</span> ?? <span class="hljs-number">10</span>
    <span class="hljs-keyword">const</span> targetTop = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[index].<span class="hljs-property">top</span>

    <span class="hljs-comment">// 初始化跳转上下文</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> = {
      <span class="hljs-attr">targetIndex</span>: index,
      <span class="hljs-attr">lastTop</span>: targetTop, <span class="hljs-comment">// 记录初始目标位置</span>
      <span class="hljs-attr">iterations</span>: <span class="hljs-number">0</span>,
      maxIterations,
      threshold,
      callbacks,
      <span class="hljs-attr">status</span>: <span class="hljs-string">'idle'</span>,
      <span class="hljs-attr">pendingHeightUpdate</span>: <span class="hljs-literal">false</span>
    }

    <span class="hljs-comment">// 触发第一次滚动</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_doScroll</span>(targetTop)
  }

  <span class="hljs-comment">/**
   * 手动中断当前跳转
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">abortScrollTo</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'manually aborted'</span>)
  }

  <span class="hljs-comment">/**
   * 检查是否正在跳转中
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">isScrolling</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> !== <span class="hljs-literal">null</span>
  }

  <span class="hljs-comment">/**
   * 通知滚动动画完成（外部调用）
   *
   * 当外部滚动动画完成后，应调用此方法通知 VirtualCore
   * 这样可以在下一次 updateHeights 时检查收敛
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">notifyScrollComplete</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'scrolling'</span>) {
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 处理竞态：检查是否有待处理的高度更新</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">pendingHeightUpdate</span> = <span class="hljs-literal">false</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'waiting'</span>

    <span class="hljs-comment">// [修复1] 每次滚动完成后都检查收敛</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_checkScrollToConvergence</span>()
  }

  <span class="hljs-comment">/**
   * 执行滚动
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_doScroll</span>(<span class="hljs-attr">targetTop</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'scrolling'</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">iterations</span>++
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">pendingHeightUpdate</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 重置待处理标记</span>

    <span class="hljs-comment">// 保存当前上下文引用，用于在回调中判断上下文是否已变化</span>
    <span class="hljs-keyword">const</span> currentCtx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>

    <span class="hljs-keyword">const</span> result = currentCtx.<span class="hljs-property">callbacks</span>.<span class="hljs-title function_">onScroll</span>(targetTop)

    <span class="hljs-comment">// 统一处理同步和异步情况</span>
    <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) {
      <span class="hljs-comment">// 异步情况：等待 Promise 完成后通知</span>
      result
        .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-comment">// 只有上下文未变化时才处理，防止误操作新的跳转</span>
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> === currentCtx) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyScrollComplete</span>()
          }
        })
        .<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-comment">// 同样检查上下文</span>
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> === currentCtx) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'scroll failed'</span>)
          }
        })
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 同步情况：使用 microtask 延迟通知</span>
      <span class="hljs-title function_">queueMicrotask</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 检查上下文是否仍然是同一个，且状态仍为 scrolling</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> === currentCtx &amp;&amp; currentCtx.<span class="hljs-property">status</span> === <span class="hljs-string">'scrolling'</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notifyScrollComplete</span>()
        }
      })
    }
  }

  <span class="hljs-comment">/**
   * 检查跳转是否收敛
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_checkScrollToConvergence</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> ctx = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>
    <span class="hljs-keyword">if</span> (!ctx || ctx.<span class="hljs-property">status</span> !== <span class="hljs-string">'waiting'</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">const</span> currentTop = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[ctx.<span class="hljs-property">targetIndex</span>].<span class="hljs-property">top</span>
    <span class="hljs-keyword">const</span> diff = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(currentTop - ctx.<span class="hljs-property">lastTop</span>)

    <span class="hljs-comment">// 检查是否收敛：位置变化小于阈值</span>
    <span class="hljs-keyword">if</span> (diff &lt;= ctx.<span class="hljs-property">threshold</span>) {
      <span class="hljs-comment">// 收敛完成</span>
      <span class="hljs-keyword">const</span> finalTop = currentTop
      <span class="hljs-keyword">const</span> iterations = ctx.<span class="hljs-property">iterations</span>
      <span class="hljs-keyword">const</span> callbacks = ctx.<span class="hljs-property">callbacks</span>

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> = <span class="hljs-literal">null</span>
      callbacks.<span class="hljs-property">onComplete</span>?.(finalTop, iterations)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 检查是否超过最大迭代次数</span>
    <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">iterations</span> &gt;= ctx.<span class="hljs-property">maxIterations</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">`max iterations (<span class="hljs-subst">${ctx.maxIterations}</span>) reached`</span>)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 继续迭代：更新 lastTop 并再次滚动</span>
    ctx.<span class="hljs-property">lastTop</span> = currentTop
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_doScroll</span>(currentTop)
  }

  <span class="hljs-comment">/**
   * 中断跳转
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-attr">reason</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">const</span> callbacks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">callbacks</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> = <span class="hljs-literal">null</span>
    callbacks.<span class="hljs-property">onAbort</span>?.(reason)
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 列表管理</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 动态设置列表总数
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setTotal</span>(<span class="hljs-attr">newTotal</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (newTotal &lt; <span class="hljs-number">0</span>) {
      newTotal = <span class="hljs-number">0</span>
    }

    <span class="hljs-keyword">if</span> (newTotal === <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-comment">// 如果正在跳转，检查目标是否还有效</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>.<span class="hljs-property">targetIndex</span> &gt;= newTotal) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'target index out of range after setTotal'</span>)
    }

    <span class="hljs-keyword">if</span> (newTotal &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) {
      <span class="hljs-keyword">const</span> oldTotal = <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>
      <span class="hljs-keyword">const</span> lastBottom = oldTotal &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[oldTotal - <span class="hljs-number">1</span>].<span class="hljs-property">bottom</span> : <span class="hljs-number">0</span>

      <span class="hljs-comment">// 预先扩展数组长度</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> = newTotal

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = oldTotal; i &lt; newTotal; i++) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i] = {
          <span class="hljs-attr">index</span>: i,
          <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>,
          <span class="hljs-attr">top</span>: lastBottom + (i - oldTotal) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>,
          <span class="hljs-attr">bottom</span>: lastBottom + (i - oldTotal + <span class="hljs-number">1</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>
        }
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> = newTotal
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> = newTotal
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_notifyHeightChange</span>()
  }

  <span class="hljs-comment">/**
   * 获取当前列表总数
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getTotal</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>
  }

  <span class="hljs-comment">/**
   * 获取指定索引的位置信息
   * 返回深拷贝，防止外部修改内部状态
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getItemPosition</span>(<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">ItemPosition</span> | <span class="hljs-literal">null</span> {
    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    <span class="hljs-keyword">return</span> { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[index] }
  }

  <span class="hljs-comment">/**
   * 重置所有位置信息
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">reset</span>(newTotal?: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 中断进行中的跳转</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollToCtx</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_abortScrollTo</span>(<span class="hljs-string">'reset called'</span>)
    }

    <span class="hljs-keyword">if</span> (newTotal !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span> = newTotal &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : newTotal
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_initPositions</span>()
  }

  <span class="hljs-comment">/**
   * 获取当前默认行高
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getDefaultHeight</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultHeight</span>
  }

  <span class="hljs-comment">// ========================</span>
  <span class="hljs-comment">// 私有工具方法</span>
  <span class="hljs-comment">// ========================</span>

  <span class="hljs-comment">/**
   * 从指定索引开始，重新计算所有后续行的 top 和 bottom
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_recalculatePositions</span>(<span class="hljs-attr">fromIndex</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = fromIndex; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>; i++) {
      <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">top</span> = <span class="hljs-number">0</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">top</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i - <span class="hljs-number">1</span>].<span class="hljs-property">bottom</span>
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">bottom</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">top</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[i].<span class="hljs-property">height</span>
    }
  }

  <span class="hljs-comment">/**
   * 二分查找：找到第一个 bottom &gt; scrollTop 的索引
   * 当 scrollTop 超出范围时返回 this.total
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_findStartIndex</span>(<span class="hljs-attr">scrollTop</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

    <span class="hljs-keyword">const</span> lastIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>

    <span class="hljs-keyword">if</span> (scrollTop &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

    <span class="hljs-keyword">if</span> (scrollTop &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[lastIndex].<span class="hljs-property">bottom</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">total</span>
    }

    <span class="hljs-keyword">let</span> low = <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> high = lastIndex

    <span class="hljs-keyword">while</span> (low &lt;= high) {
      <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((low + high) / <span class="hljs-number">2</span>)
      <span class="hljs-keyword">const</span> midBottom = <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[mid].<span class="hljs-property">bottom</span>

      <span class="hljs-keyword">if</span> (midBottom &gt; scrollTop) {
        <span class="hljs-keyword">if</span> (mid === <span class="hljs-number">0</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">positions</span>[mid - <span class="hljs-number">1</span>].<span class="hljs-property">bottom</span> &lt;= scrollTop) {
          <span class="hljs-keyword">return</span> mid
        }
        high = mid - <span class="hljs-number">1</span>
      } <span class="hljs-keyword">else</span> {
        low = mid + <span class="hljs-number">1</span>
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
  }

  <span class="hljs-comment">/**
   * 通知外部总高度发生变化
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">_notifyHeightChange</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onTotalHeightChange</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onTotalHeightChange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTotalHeight</span>())
    }
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">VirtualCore</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ItemPosition</span>, <span class="hljs-title class_">HeightUpdate</span>, <span class="hljs-title class_">RenderRange</span>, <span class="hljs-title class_">UpdateCorrection</span>, <span class="hljs-title class_">VirtualCoreConfig</span>, <span class="hljs-title class_">ScrollToCallbacks</span>, <span class="hljs-title class_">ScrollToOptions</span> }
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android system_server进程介绍]]></title>    <link>https://juejin.cn/post/7586680977855742015</link>    <guid>https://juejin.cn/post/7586680977855742015</guid>    <pubDate>2025-12-23T06:59:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586680977855742015" data-draft-id="7586861592709529636" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android system_server进程介绍"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T06:59:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android system_server进程介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:59:16.000Z" title="Tue Dec 23 2025 06:59:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题：</h2>
<p>请详细介绍 Android 中 <code>system_server</code> 进程的作用、启动流程和核心功能，包括：</p>
<ol>
<li><strong>进程概述</strong>：说明该进程的定位、在系统中的角色以及启动时机。</li>
<li><strong>启动流程</strong>：从 Zygote 启动到 <code>system_server</code> 运行的步骤。</li>
<li><strong>主要服务</strong>：列出并简述该进程中运行的关键系统服务（如 ActivityManagerService、PackageManagerService 等）。</li>
<li><strong>与其他进程的关系</strong>：说明它与 framework、应用进程、底层 native 进程的通信方式。</li>
<li><strong>稳定性与安全性</strong>：分析 system_server 崩溃或卡死对系统的影响，以及常见的保护机制。</li>
<li><strong>调试与分析方法</strong>：介绍查看日志、trace 文件及源码的方法。</li>
</ol>
<hr/>
<h2 data-id="heading-1">1. <strong>进程概述：定位、角色与启动时机</strong></h2>
<h3 data-id="heading-2"><strong>1.1 定位与角色</strong></h3>
<p><code>system_server</code> 是 Android 中 <strong>最关键的 Java 进程之一</strong>，主要特征：</p>
<ul>
<li>
<p><strong>承载绝大部分 Java Framework 系统服务</strong> 如：<strong>ActivityManagerService (AMS)</strong> 、<strong>PackageManagerService (PMS)</strong> 、<strong>WindowManagerService (WMS)</strong> 、<strong>PowerManagerService (PMS)</strong> 等，几乎所有应用能感知到的系统能力，都要通过这些服务转一圈。</p>
</li>
<li>
<p><strong>系统“中枢调度中心”</strong> 负责：</p>
<ul>
<li>进程和四大组件生命周期控制</li>
<li>任务栈与界面管理</li>
<li>包和权限管理</li>
<li>电源、输入、传感器、网络等的大量策略层逻辑</li>
</ul>
</li>
<li>
<p><strong>单点故障（Single Point of Failure）</strong> 一旦 <code>system_server</code> 崩溃，<strong>Android 整个 Framework 失效</strong>，通常会触发 <strong>framework 重启</strong>（看起来像“桌面重启”或“手机黑一下再亮”）。</p>
</li>
</ul>
<h3 data-id="heading-3"><strong>1.2 启动时机</strong></h3>
<p>整体时序（高层）：</p>
<ol>
<li><strong>内核启动完成</strong> → 启动 <code>init</code> 进程。</li>
<li><code>init</code> 解析 <code>init.rc</code> 等配置，启动 <strong>Zygote 进程</strong>。</li>
<li><strong>Zygote 启动后立刻 fork 出</strong> <strong><code>system_server</code></strong>。</li>
<li><code>system_server</code> 内部启动各种系统服务，framework 才真正“活起来”。</li>
</ol>
<p>所以：<strong><code>system_server</code></strong> <strong>在整个系统引导阶段非常靠前</strong>，比所有应用进程要早得多，是后续所有应用的“上帝视角”调度者。</p>
<h2 data-id="heading-4">2. <strong>启动流程：从 Zygote 到 system_server</strong></h2>
<p>以典型 AOSP 启动链为例，简化步骤如下：</p>
<h3 data-id="heading-5"><strong>2.1 内核与 init 阶段</strong></h3>
<ol>
<li><strong>Linux 内核启动</strong> 加载驱动、挂载文件系统，最终启动第一个用户空间进程：<code>/init</code>。</li>
<li><strong>init 解析 rc 脚本</strong> 如 <code>init.rc</code>、<code>init.&lt;hardware&gt;.rc</code>，定义各种 service。 其中一项是启动 Zygote，例如（简化示意）：</li>
</ol>
<pre><code class="hljs language-perl" lang="perl">service zygote /<span class="hljs-keyword">system</span>/bin/app_process -Xzygote ...
    class main
    <span class="hljs-keyword">socket</span> zygote stream <span class="hljs-number">660</span> root <span class="hljs-keyword">system</span>
    onrestart <span class="hljs-keyword">write</span> /sys/android_power/request_state wake
</code></pre>
<h3 data-id="heading-6"><strong>2.2 Zygote 进程启动</strong></h3>
<p><code>app_process</code> 最终进入 <code>com.android.internal.os.ZygoteInit.main()</code>，主要做：</p>
<ol>
<li>
<p><strong>预加载类和资源</strong>（<code>preload()</code>）</p>
<ol>
<li>预加载 framework 常用的 Java 类、资源等，提高后续 fork 子进程的速度（写时复制）。</li>
</ol>
</li>
<li>
<p><strong>创建 zygote socket</strong></p>
<ol>
<li>用于接收 AMS 发来的“fork 新应用进程”的请求。</li>
</ol>
</li>
<li>
<p><strong>调用</strong> <strong><code>startSystemServer()</code></strong> <strong>启动 system_server</strong>。</p>
</li>
</ol>
<h3 data-id="heading-7"><strong>2.3 Zygote 中的 startSystemServer</strong></h3>
<p>在 <code>ZygoteInit</code> 中，核心逻辑大致是：</p>
<pre><code class="hljs language-scss" lang="scss">private static boolean <span class="hljs-built_in">startSystemServer</span>(...) {
    <span class="hljs-comment">// 1. 组装 system_server 的启动参数：uid/gid、进程名、classPath 等</span>
    String args<span class="hljs-selector-attr">[]</span> = {
        "<span class="hljs-attr">--setuid</span>=<span class="hljs-number">1000</span>",              <span class="hljs-comment">// system UID</span>
        "<span class="hljs-attr">--setgid</span>=<span class="hljs-number">1000</span>",
        "<span class="hljs-attr">--runtime-args</span>",
        "<span class="hljs-attr">--nice-name</span>=system_server",
        "com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.server</span><span class="hljs-selector-class">.SystemServer</span>"
    };
    
    <span class="hljs-comment">// 2. 调用 forkSystemServer，使用 Zygote fork 出子进程</span>
    ZygoteProcess<span class="hljs-selector-class">.ProcessResult</span> result = Zygote<span class="hljs-selector-class">.forkSystemServer</span>(..., args, ...);

    <span class="hljs-comment">// 3. 在子进程中，执行 handleSystemServerProcess，进入 Java 世界</span>
    if (result.pid == <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">handleSystemServerProcess</span>(...); <span class="hljs-comment">// 子进程路径</span>
    }
}
</code></pre>
<p>关键点：</p>
<ul>
<li><code>system_server</code> <strong>是 Zygote fork 出的第一个重要子进程</strong>；</li>
<li>使用固定的 UID/GID（一般为 <strong>system 用户</strong>），权限极高；</li>
<li>指定入口类为 <strong><code>com.android.server.SystemServer</code></strong>。</li>
</ul>
<h3 data-id="heading-8"><strong>2.4 system_server 进程内部：SystemServer.main()</strong></h3>
<p><code>SystemServer</code> 类的主入口（简化）：</p>
<pre><code class="hljs language-scss" lang="scss">public static void <span class="hljs-selector-tag">main</span>(String[] args) {
    new <span class="hljs-built_in">SystemServer</span>()<span class="hljs-selector-class">.run</span>();
}

private void <span class="hljs-built_in">run</span>() {
    <span class="hljs-comment">// 1. 设置优先级 / 线程策略 / 权限检查</span>

    <span class="hljs-comment">// 2. 启动各类系统服务</span>
    <span class="hljs-built_in">startBootstrapServices</span>();  <span class="hljs-comment">// 启动最基础的服务</span>
    <span class="hljs-built_in">startCoreServices</span>();       <span class="hljs-comment">// 启动框架核心服务</span>
    <span class="hljs-built_in">startOtherServices</span>();      <span class="hljs-comment">// 启动其他大量服务</span>

    <span class="hljs-comment">// 3. 进入 Looper.loop()，进入消息循环</span>
}
</code></pre>
<p><code>startBootstrapServices()</code> 中一般会启动：</p>
<ul>
<li>Installer、ActivityManagerService、PowerManagerService、PackageManagerService 等；</li>
<li>这些服务准备好后，framework 才具备基本的调度能力。</li>
</ul>
<p>至此，<strong><code>system_server</code></strong> <strong>正式进入主循环，Android Framework 启动完成</strong>，可以接收应用启动请求，去 fork app 进程。</p>
<h2 data-id="heading-9">3. <strong>主要服务：system_server 内的关键系统服务</strong></h2>
<p><code>system_server</code> 是一个“<strong>服务容器进程</strong>”，里面运行着大量 Java 系统服务（有的还桥接 native）。下面列一些典型且对应用最核心的服务及职责（非完整列表）：</p>









































































<table><thead><tr><th>服务名（Java 类）</th><th>主要职责</th></tr></thead><tbody><tr><td>ActivityManagerService (AMS)</td><td>进程/Activity/Service/Broadcast 的生命周期、任务栈管理、ANR 监控、进程优先级管理等。几乎所有应用组件的启动/停止都要经过它。</td></tr><tr><td>PackageManagerService (PMS)</td><td>APK 安装/卸载、包信息（version、签名、组件）、权限授予与校验、隐式Intent解析、Dex 优化等。</td></tr><tr><td>WindowManagerService (WMS)</td><td>窗口管理、窗口层级/动画、显示内容布局，与 SurfaceFlinger 协同完成渲染；管理状态栏、导航栏等系统窗口。</td></tr><tr><td>DisplayManagerService (DMS)</td><td>显示设备（屏幕、外接显示器）、分辨率、刷新率、显示切换等管理。</td></tr><tr><td>PowerManagerService (PMS)</td><td>电源策略、休眠/唤醒（wake lock）、亮灭屏逻辑、电池相关策略等。</td></tr><tr><td>InputManagerService (IMS)</td><td>输入事件（触摸、按键）的分发与调度，和 native inputflinger 协作，将 input 分发给 WMS/应用。</td></tr><tr><td>SensorManagerService</td><td>传感器（加速度、陀螺仪、距离等）管理及事件分发。</td></tr><tr><td>LocationManagerService</td><td>定位相关服务管理（GPS、网络定位、融合算法等）。</td></tr><tr><td>AudioService</td><td>音量控制、音频路由、音频焦点（audio focus）等。</td></tr><tr><td>NotificationManagerService</td><td>通知栏消息管理、通知渠道、优先级、do-not-disturb 策略。</td></tr><tr><td>VibratorService</td><td>马达震动控制。</td></tr><tr><td>AlarmManagerService</td><td>定时任务/闹钟管理（RTC/ELAPSED_REALTIME 等），唤醒策略。</td></tr><tr><td>ConnectivityService</td><td>网络连接状态、流量管理、代理、VPN 等。</td></tr><tr><td>UserManagerService</td><td>多用户/工作资料（Work Profile）等用户管理。</td></tr><tr><td>ContentService</td><td>ContentProvider 的注册与调度。</td></tr><tr><td>ActivityTaskManagerService (ATMS)</td><td>新版本拆分出的任务/栈管理服务，与 AMS 协作。</td></tr></tbody></table>
<p>这些服务通常在 <code>SystemServer.startBootstrapServices()</code> / <code>startCoreServices()</code> / <code>startOtherServices()</code> 中依次创建并通过 <strong>ServiceManager</strong> 注册为 Binder 服务。应用通过 Binder 调用这些服务的接口，从而实现各种系统功能。</p>
<h2 data-id="heading-10">4. <strong>与其他进程的关系与通信方式</strong></h2>
<h3 data-id="heading-11"><strong>4.1 与 Framework（Java 层）的关系</strong></h3>
<ul>
<li><code>system_server</code> 本身就是 <strong>Framework Java 层服务端实现</strong>所在的进程。</li>
<li>应用侧通过 <code>Context.getSystemService()</code> 获取的是<strong>代理对象（Proxy/Stub）</strong> ，其底层通过 <strong>Binder</strong> 与 <code>system_server</code> 中的真实服务通信。</li>
<li>例如：<code>ActivityManager</code> → <code>IActivityManager</code> Binder stub/proxy → <code>ActivityManagerService</code>（system_server 内）</li>
</ul>
<h3 data-id="heading-12"><strong>4.2 与应用进程的关系</strong></h3>
<ol>
<li>
<p><strong>进程创建关系</strong></p>
<ol>
<li>应用进程（app）是由 <strong>Zygote</strong> fork 出的；</li>
<li>AMS 通过 Zygote socket 请求 fork app，app 启动后再与 AMS 建立 Binder 通道；</li>
<li><code>system_server</code> 负责维护所有 app 进程的生命周期和优先级。</li>
</ol>
</li>
<li>
<p><strong>通信方式</strong></p>
<ol>
<li>
<p><strong>主方式：Binder IPC</strong></p>
<ul>
<li>app 调用系统 API → 通过 Binder 调到 system_server 对应服务；</li>
<li>system_server 反过来通过 Binder 回调应用（如 scheduleLaunchActivity、scheduleReceiver 等）。</li>
</ul>
</li>
<li>
<p><strong>少量共有内存 / 文件描述符传递</strong></p>
<ul>
<li>如图形缓冲区（GraphicBuffer）、匿名共享内存（ashmem）等，通常由 native 组件协同（SurfaceFlinger、HWComposer 等）。</li>
</ul>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-13"><strong>4.3 与底层 native 进程的关系</strong></h3>
<p>system_server 与一些关键 native 进程（如 <strong>SurfaceFlinger、MediaServer、InputFlinger</strong> 等）之间关系：</p>
<ul>
<li>
<p><strong>通信方式</strong>：</p>
<ul>
<li>Binder（很多 native 服务也注册为 Binder 服务）；</li>
<li>socket（如 media 相关）、shared memory 等。</li>
</ul>
</li>
<li>
<p><strong>职责分工</strong>：</p>
<ul>
<li><code>system_server</code>：<strong>策略 &amp; 管理层</strong>（何时显示、谁在前台、谁有音频焦点）；</li>
<li>native 进程：<strong>高性能数据处理</strong>（渲染、音视频编解码、硬件驱动交互）。</li>
</ul>
</li>
</ul>
<p>示例：</p>
<ul>
<li>WMS（system_server 内） → 控制窗口层级、可见性；</li>
<li>SurfaceFlinger（native） → 根据 WMS 提供的 layer 信息合成最终帧并送到显示设备。</li>
</ul>
<h2 data-id="heading-14">5. <strong>稳定性与安全性</strong></h2>
<h3 data-id="heading-15"><strong>5.1 system_server 崩溃或卡死的影响</strong></h3>
<p><strong>1）崩溃（Crash）</strong></p>
<ul>
<li>
<p>一旦 <code>system_server</code> 发生未捕获异常（如 NPE、RuntimeException），会导致进程立即退出；</p>
</li>
<li>
<p>Android 通常会：</p>
<ul>
<li>记录 tombstone（/data/tombstones/…）；</li>
<li>触发 <strong>framework 重启</strong>（重启 system_server、某些 native 服务，重新拉起桌面等）；</li>
</ul>
</li>
<li>
<p>对用户表现：</p>
<ul>
<li>短暂黑屏/卡顿；</li>
<li>桌面重新加载，当前前台应用大概率被杀重启。</li>
</ul>
</li>
</ul>
<p><strong>2）卡死（ANR / 死锁 / Watchdog）</strong></p>
<ul>
<li>
<p><code>system_server</code> 有一个 <strong>Watchdog 机制</strong>： 定时检测关键线程（尤其是主线程）的响应，如果超过一定时间没有响应，会认为 system_server 卡死。</p>
</li>
<li>
<p>Watchdog 会：</p>
<ul>
<li>打印详细日志和线程堆栈；</li>
<li>通常最终也会选择 <strong>杀死 system_server 以恢复系统</strong>（宁可重启框架，也不能长期卡死）。</li>
</ul>
</li>
</ul>
<p><strong>3）对应用的具体影响</strong></p>
<ul>
<li>
<p>任何依赖 system_server 的 Binder 调用会失败，可能抛：</p>
<ul>
<li><strong><code>DeadSystemException</code></strong> <strong>/</strong> <strong><code>DeadSystemRuntimeException</code></strong>（你前一个 crash 日志中看到的那个）；</li>
</ul>
</li>
<li>
<p>大量应用被动“闪退”或被系统重启。</p>
</li>
</ul>
<h3 data-id="heading-16"><strong>5.2 稳定性保护机制（核心）</strong></h3>
<ol>
<li>
<p><strong>Watchdog -- 独立的监控机制</strong></p>
<ol>
<li>定期检测 AMS、PMS、WMS 等关键服务的响应；</li>
<li>防止 system_server 因死锁或耗时操作“挂住”。</li>
</ol>
</li>
<li>
<p><strong>严格线程/耗时策略</strong></p>
<ol>
<li>对主线程和关键 Binder 线程在代码层面有大量 <code>StrictMode</code>、超时检测；</li>
<li>大部分耗时操作必须放入后台线程。</li>
</ol>
</li>
<li>
<p><strong>OOM / 内存回收策略</strong></p>
<ol>
<li>为 system_server 预留较高的内存优先级；</li>
<li>通过 LMK / lmkd、优先级回收尽量腾出内存给 system_server 和前台 app。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-17"><strong>5.3 安全性</strong></h3>
<p><code>system_server</code> 权限极高，因此安全策略非常严格：</p>
<ol>
<li>
<p><strong>system UID + SELinux 策略</strong></p>
<ol>
<li>运行在 system UID；</li>
<li>SELinux 策略限制其访问范围，避免“全能无管控”。</li>
</ol>
</li>
<li>
<p><strong>权限校验中心</strong></p>
<ol>
<li>大多数权限检查在 system_server 内进行： 例如 <code>Context.checkPermission</code> 最终调用到 AMS/PMS 等服务进行判断。</li>
</ol>
</li>
<li>
<p><strong>签名/包完整性校验</strong></p>
<ol>
<li>应用安装、更新、卸载的签名校验、版本验证、权限变更审核都由 PMS 等服务执行。</li>
</ol>
</li>
<li>
<p><strong>跨进程安全边界</strong></p>
<ol>
<li>通过 Binder 的 caller UID/包名、权限，严格限制 app 能调用的系统操作。</li>
</ol>
</li>
</ol>

<h2 data-id="heading-18">6. <strong>调试与分析 system_server 的方法</strong></h2>
<h3 data-id="heading-19"><strong>6.1 日志与 trace /</strong> <strong>tombstone</strong></h3>
<ol>
<li><strong>logcat 日志</strong></li>
</ol>
<p>常用 tag：</p>
<ul>
<li><strong>ActivityManager</strong>：AMS、进程/Activity 启停、ANR 相关；</li>
<li><strong>SystemServer</strong>：系统服务启动阶段、异常；</li>
<li><strong>Watchdog</strong>：监控到卡死时输出；</li>
<li>各具体服务的 log（WindowManager、PackageManager 等）。</li>
</ul>
<p>常用命令示例：</p>
<pre><code class="hljs language-ruby" lang="ruby">adb logcat -b system -b main -v threadtime <span class="hljs-title class_">ActivityManager</span><span class="hljs-symbol">:System</span> <span class="hljs-title class_">SystemServer</span><span class="hljs-symbol">:System</span> <span class="hljs-title class_">Watchdog</span><span class="hljs-symbol">:System</span> *<span class="hljs-symbol">:S</span>
</code></pre>
<ol start="2">
<li><strong>system_server</strong> <strong>tombstone</strong></li>
</ol>
<ul>
<li>位置：<code>/data/tombstones/tombstone_XX</code></li>
<li>当 <code>system_server</code> 发生 native crash 或被 Watchdog 触发 kill，会在此处留下一份 dump。</li>
<li>可通过：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">adb root
adb pull /data/tombstones/tombstone_XX
</code></pre>
<p>进行分析。里面包含：</p>
<ul>
<li>各线程栈信息；</li>
<li>寄存器、内存快照；</li>
<li>出错信号、地址等。</li>
</ul>
<ol start="3">
<li><strong>ANR traces</strong></li>
</ol>
<ul>
<li>位置：<code>/data/anr/traces.txt</code>（以及可能的分片文件）；</li>
<li>当 system_server 或某应用进程 ANR 时，会在此文件中写入对应时刻所有线程的 stack。</li>
</ul>
<p>常用命令：</p>
<pre><code class="hljs language-bash" lang="bash">adb shell <span class="hljs-built_in">cat</span> /data/anr/traces.txt | grep -n <span class="hljs-string">"system_server"</span> -n
</code></pre>
<h3 data-id="heading-20"><strong>6.2 源码定位与阅读路径</strong></h3>
<p>主要 Java 源码路径（以 AOSP 为例）：</p>
<ul>
<li>
<p><code>frameworks/base/services/java/com/android/server/SystemServer.java</code> → system_server 进程入口、服务启动逻辑（<code>startBootstrapServices/startCoreServices</code>）。</p>
</li>
<li>
<p><code>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</code> → Zygote 主入口，<code>startSystemServer()</code> 逻辑。</p>
</li>
<li>
<p>各服务源码举例：</p>
<ul>
<li>AMS：<code>frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</code></li>
<li>PMS：<code>frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</code></li>
<li>WMS：<code>frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java</code></li>
<li>PowerManagerService：<code>frameworks/base/services/core/java/com/android/server/power/PowerManagerService.java</code></li>
</ul>
</li>
</ul>
<p>阅读顺序建议：</p>
<ol>
<li>从 <code>ZygoteInit.main()</code> → <code>startSystemServer()</code>；</li>
<li>看 <code>SystemServer.run()</code> → <code>startBootstrapServices()</code>；</li>
<li>根据需要深入具体 service（如 AMS / PMS）。</li>
</ol>
<h3 data-id="heading-21"><strong>6.3 性能与</strong> <strong>行为分析工具</strong></h3>
<ul>
<li><strong>systrace / Perfetto / System Tracing</strong> 用于查看 system_server 在一段时间内的调度、CPU 使用、Binder 调用等。</li>
<li><strong>binder 调用统计</strong>（部分厂商增强） 可以看到哪些进程在频繁调用 system_server、binder 队列堆积情况（你 crash 日志中的 binder buffer info 就是类似信息）。</li>
<li><strong>Debug / StrictMode</strong> 在开发版系统中开启更多调试开关，检测 system_server 内线程的耗时行为。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文读懂 Chrome CRX📦：你需要了解的核心知识点]]></title>    <link>https://juejin.cn/post/7586686861390839859</link>    <guid>https://juejin.cn/post/7586686861390839859</guid>    <pubDate>2025-12-23T07:51:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586686861390839859" data-draft-id="7586584105742090290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文读懂 Chrome CRX📦：你需要了解的核心知识点"/> <meta itemprop="keywords" content="前端,前端工程化"/> <meta itemprop="datePublished" content="2025-12-23T07:51:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Maxkim"/> <meta itemprop="url" content="https://juejin.cn/user/2768993424260451"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文读懂 Chrome CRX📦：你需要了解的核心知识点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2768993424260451/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Maxkim
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:51:47.000Z" title="Tue Dec 23 2025 07:51:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><blockquote>
<p>大家好!欢迎来到<strong>Maxkim</strong>的技术博客，插件显而易见,像"篡改猴",“Vue Devtools”无处不在，那么如何进行<strong>插件编写</strong>到编写的插件怎么<strong>分发打包</strong>就成了工程化的必学之课，关于插件可以看JustHappy的开源项目，<strong>源码简单，上手难度小</strong> (<a href="https://juejin.cn/post/7585406229167865906" target="_blank" title="https://juejin.cn/post/7585406229167865906">「chrome extensions🛠️」超级简单的浏览器插件Vue开发模板用Vue + JS去开发</a>) ,这里为大家讲解<strong>Crx打包</strong>内容。总结一句话打包就是 <strong>输入-&gt;输出--依靠脚本</strong></p>
</blockquote>
<h2 data-id="heading-0">什么是Chrome下的Crx</h2>
<p>CRX（Chrome Extension）是<strong>Chrome 浏览器扩展程序的官方打包格式</strong>，本质上是一个经过<strong>数字签名</strong>的 ZIP 压缩包，文件后缀为<code>.crx</code>。它包含了实现扩展功能的所有资源：<code>manifest.json</code>配置文件、JavaScript 脚本、CSS 样式、HTML 页面、图片图标等。</p>
<p>基于 Chromium 内核的浏览器均兼容 CRX 格式，这让 CRX 成为跨 Chromium 浏览器扩展开发的主流选择。其核心价值在于<strong>突破网页沙箱限制</strong>，让开发者能调用浏览器底层 API（如标签页管理、网络请求拦截、本地存储操作等），实现普通网页无法完成的功能，比如广告拦截、网页翻译、开发者调试工具等。</p>
<p>目前 CRX 的主流版本是<strong>V3</strong>（Manifest V3），相比 V2 版本，它采用 Service Worker 替代持久化背景脚本、使用声明式网络请求拦截、强化内容安全策略（CSP），在安全性和性能上有显著提升，也是我们开发和打包的重点。</p>
<h2 data-id="heading-1">为什么要Crx打包，直接用不行吗</h2>
<p>直接用，对普通用户门槛高，需要手动开启 <strong>开发者模式</strong>进行导入，其次 <strong>不安全</strong>  ，然后就是 <strong>版本管理难</strong>等问题 于是将开发的插件打包成Crx，就显得<strong>必须且必要</strong>了！</p>
<h2 data-id="heading-2">打包三步骤</h2>
<h3 data-id="heading-3">输入</h3>
<p>首先它是<strong>符合 Chrome 扩展规范的源码目录</strong>（通常命名为<code>src</code>），其核心是围绕<code>manifest.json</code>构建清晰的模块结构，避免直接使用解压目录时的 “文件堆砌” 问题。如下图例子所示</p>
<pre><code class="hljs language-bash" lang="bash">├── assets/           <span class="hljs-comment"># 静态资源输入</span>
│   └── icons/        <span class="hljs-comment"># 扩展图标（严格匹配manifest声明的尺寸）</span>
├── background/       <span class="hljs-comment"># 背景脚本输入（Service Worker）</span>
│   └── index.js      <span class="hljs-comment"># 单一入口，避免多脚本零散分布</span>
├── content/          <span class="hljs-comment"># 内容脚本输入（按功能拆分模块）</span>
│   ├── inject.js     <span class="hljs-comment"># 注入网页的核心逻辑</span>
...
├── popup/            <span class="hljs-comment"># 弹窗页面输入（前端页面资源）</span>
...
└── manifest.json     <span class="hljs-comment"># 核心配置（V3版本，声明所有资源路径）</span>
</code></pre>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/147ad6d69f6b4d3caa09488c5ada7bc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081106&amp;x-signature=RABW2pwAo0agALlFIFtjOvj3zFY%3D" alt="image.png" loading="lazy"/></p>
--------------------------------------------------------------
<h3 data-id="heading-4">输出</h3>
<p>CRX 的输出<strong>并非单一的.crx文件</strong>，而是通过工程化流程生成<strong>分层的产物</strong>，解决直接用解压目录时 “一份文件既调试又分发” 的矛盾。</p>





























<table><thead><tr><th>输出产物</th><th>生成方式</th><th>用途</th><th>对比直接用解压目录的优势</th></tr></thead><tbody><tr><td><code>dist/unpacked/</code></td><td>复制 / 编译源码后的解压目录</td><td>开发调试</td><td>自动清理冗余文件，保留纯净的可运行代码</td></tr><tr><td><code>dist/crx/</code></td><td>签名后的<code>.crx</code>文件</td><td>生产分发</td><td>标准化压缩包，带数字签名，支持安全分发</td></tr><tr><td><code>dist/zip/</code></td><td>应用店上传的 ZIP 包</td><td>官方发布</td><td>符合 Chrome 应用店规范，无需手动整理文件</td></tr></tbody></table>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90ba4adeb7064ab6a591af070f8ecb7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081106&amp;x-signature=ilT9z8GSWzAdXuMBLx9NZLD6xwE%3D" alt="image.png" loading="lazy"/></p>
<p>三大优势:
1.<strong>环境隔离</strong>
2.<strong>资源优化</strong>
3.<strong>版本可控</strong></p>
<hr/>
<h3 data-id="heading-5">NPM自定义脚本: 纯原生 CRX 的自动化打包</h3>
<p>纯原生 CRX 指不使用 Webpack、Vite 等构建工具，仅用原生 HTML/CSS/JS 开发的扩展。这类 CRX 的 NPM 脚本核心是实现<strong>资源复制、清理、密钥生成、签名打包</strong>的自动化，其中<strong>密钥</strong>是<code>.crx</code>文件的安全核心，也是替代直接用解压目录的关键。</p>
<h4 data-id="heading-6">1. 先搞懂：CRX 打包中的密钥（<code>key.pem</code>）是什么？</h4>
<p>在 CRX 打包中，<code>key.pem</code>是<strong>RSA 私钥文件</strong>，是 Chrome 扩展签名的核心凭证，其作用和特性如下：</p>
<ul>
<li><strong>数字签名的核心</strong>：<code>crx3</code>工具会通过<code>key.pem</code>对 CRX 包进行加密签名，Chrome 浏览器安装时会验证签名的合法性，若签名失效（如代码被篡改）则拒绝安装。</li>
<li><strong>开发者身份标识</strong>：<code>key.pem</code>是开发者 / 团队的唯一标识，发布到 Chrome 应用店的扩展，后续更新必须使用同一私钥，否则会被视为 “新扩展”。</li>
<li><strong>自动生成与手动管理</strong>：首次执行<code>build:crx</code>脚本时，若项目根目录无<code>key.pem</code>，<code>crx3</code>会自动生成；若已存在，则复用该密钥进行签名。</li>
<li><strong>安全重要性</strong>：丢失<code>key.pem</code>将无法更新已发布的扩展，且无法证明扩展的原始开发者身份，需妥善备份。</li>
</ul>
<h4 data-id="heading-7">2. 纯原生 CRX 的依赖安装</h4>
<p>首先初始化项目并安装打包所需的轻量工具，无需复杂的构建工具：</p>
<pre><code class="hljs language-js" lang="js"># 初始化package.<span class="hljs-property">json</span>（若未初始化）
npm init -y

# 安装核心依赖
# crx3：生成<span class="hljs-variable constant_">V3</span>版本签名的.<span class="hljs-property">crx</span>文件（含密钥生成逻辑）
# copyfiles：自动化复制静态资源
# rimraf：跨平台清理文件/目录（替代rm -rf，兼容<span class="hljs-title class_">Windows</span>）
npm install crx3 copyfiles rimraf --save-dev
</code></pre>
<h4 data-id="heading-8">3. 纯原生 CRX 的 NPM 脚本配置（完善密钥相关逻辑）</h4>
<p>在<code>package.json</code>中定义脚本，新增<strong>密钥备份提示</strong>和<strong>无密钥强制生成</strong>的逻辑，同时保留自动化打包流程：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pure-native-crx"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rimraf dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 跨平台清理dist目录，替代手动删除</span>
    <span class="hljs-attr">"copy:static"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copyfiles -u 1 src/**/* dist/unpacked"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 复制src资源到调试目录</span>
    <span class="hljs-attr">"build:unpacked"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run clean &amp;&amp; npm run copy:static"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 生成调试用解压目录</span>
    <span class="hljs-attr">"build:crx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/crx/pure-native-crx-v$npm_package_version.crx -p key.pem &amp;&amp; echo '密钥文件为key.pem，请注意备份！'"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 生成签名.crx并提示备份密钥</span>
    <span class="hljs-attr">"build:crx:newkey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/crx/pure-native-crx-v$npm_package_version.crx -p new-key.pem"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 生成新密钥的.crx（用于测试）</span>
    <span class="hljs-attr">"build:zip"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/zip/pure-native-crx-v$npm_package_version.zip --zip"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 生成应用店ZIP包</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build:unpacked &amp;&amp; npm run build:crx &amp;&amp; npm run build:zip"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 一键生成所有产物</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copyfiles -u 1 src/**/* dist/unpacked --watch"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 开发热更：监听src变化自动同步到调试目录</span>
    <span class="hljs-attr">"backup:key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copy key.pem backups/key-v$npm_package_version.pem &amp;&amp; echo '密钥已备份到backups/目录！'"</span> <span class="hljs-comment">// 密钥备份脚本</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-9">4. 纯原生脚本的使用说明（含密钥操作）</h4>


















































<table><thead><tr><th>脚本命令</th><th>功能说明</th><th>密钥相关细节</th></tr></thead><tbody><tr><td><code>npm run clean</code></td><td>清空 dist 目录，避免旧产物干扰</td><td>不涉及密钥</td></tr><tr><td><code>npm run build:unpacked</code></td><td>生成纯净的调试用解压目录<code>dist/unpacked/</code>，可直接导入 Chrome 开发者模式</td><td>不涉及密钥</td></tr><tr><td><code>npm run build:crx</code></td><td>基于调试目录生成带数字签名的<code>.crx</code>文件，存放在<code>dist/crx/</code></td><td>首次执行自动生成<code>key.pem</code>；后续执行复用该密钥，保证签名一致性</td></tr><tr><td><code>npm run build:crx:newkey</code></td><td>生成使用新密钥<code>new-key.pem</code>的<code>.crx</code>文件（仅用于测试）</td><td>生成新的<code>new-key.pem</code>，与原<code>key.pem</code>无关联，不可用于正式扩展更新</td></tr><tr><td><code>npm run build:zip</code></td><td>生成符合 Chrome 应用店要求的 ZIP 包，存放在<code>dist/zip/</code></td><td>基于<code>key.pem</code>的签名逻辑生成，但 ZIP 包本身无签名（应用店会重新签名）</td></tr><tr><td><code>npm run build</code></td><td>一键执行 “清理→复制资源→生成调试目录→签名打包.crx→生成应用店 ZIP” 全流程</td><td>核心流程中自动处理密钥生成 / 复用，同时提示备份</td></tr><tr><td><code>npm run dev</code></td><td>监听 src 目录文件变化，自动同步到调试目录，修改代码后无需手动重新导入扩展</td><td>不涉及密钥</td></tr><tr><td><code>npm run backup:key</code></td><td>将<code>key.pem</code>备份到<code>backups/</code>目录并按版本号命名</td><td>避免密钥丢失，保障扩展后续更新的合法性</td></tr></tbody></table>
<h4 data-id="heading-10">5. 密钥的生成与管理实操</h4>
<h5 data-id="heading-11">（1）首次生成密钥</h5>
<p>执行<code>npm run build:crx</code>后，控制台会输出类似日志：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">Generated <span class="hljs-keyword">private</span> <span class="hljs-keyword">key</span>: <span class="hljs-keyword">key</span>.pem
Packed dist/unpacked <span class="hljs-keyword">to</span> dist/crx/pure-native-crx-v1.<span class="hljs-number">2.0</span>.crx
密钥文件为<span class="hljs-keyword">key</span>.pem，请注意备份！
</code></pre>
<p>此时项目根目录会出现<code>key.pem</code>文件，这是该扩展的唯一私钥，需立即执行<code>npm run backup:key</code>备份到<code>backups/</code>目录。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0530c600748c4fa7977a7cffd4a11887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081106&amp;x-signature=ttGHCe94kVIBfxJ01SHH5kgEQR4%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-12">（2）复用密钥打包</h5>
<p>后续再次执行<code>npm run build:crx</code>时，<code>crx3</code>会自动读取项目根目录的<code>key.pem</code>，用同一密钥签名新版本的<code>.crx</code>文件，保证 Chrome 识别为 “同一扩展的更新”。</p>
<h5 data-id="heading-13">（3）密钥丢失的影响</h5>
<p>若<code>key.pem</code>丢失，再次执行<code>build:crx</code>会生成新的<code>key.pem</code>，此时：</p>
<ul>
<li>旧版本扩展无法通过新<code>.crx</code>更新，用户需手动卸载旧版本再安装新版本；</li>
<li>若扩展已发布到 Chrome 应用店，将无法用新密钥提交更新，只能重新发布为新扩展。</li>
</ul>
<h4 data-id="heading-14">6. 纯原生脚本的核心价值</h4>
<ul>
<li><strong>跨平台兼容</strong>：使用<code>rimraf</code>替代<code>rm -rf</code>，<code>copyfiles</code>替代手动复制，解决 Windows 与 Mac/Linux 的命令行差异问题。</li>
<li><strong>零构建工具依赖</strong>：仅用轻量工具实现自动化，适合纯原生 CRX 的简单开发场景，避免引入 Webpack 带来的配置复杂度。</li>
<li><strong>版本自动关联</strong>：通过<code>$npm_package_version</code>将<code>package.json</code>中的版本号自动写入<code>.crx</code>文件名，替代直接用解压目录时的手动命名。</li>
<li><strong>密钥自动化管理</strong>：首次打包自动生成密钥，新增备份脚本，解决直接用解压目录的安全与更新问题。</li>
<li><strong>开发提效</strong>：<code>npm run dev</code>实现源码热更新，修改代码后 Chrome 会自动检测扩展变化并重新加载，无需手动点击 “刷新扩展”。</li>
</ul>
<h3 data-id="heading-15">结合 Webpack 的 NPM 脚本（复杂 CRX 场景）</h3>
<p><em>小小Maxkim对Webpack理解有限，这里只是一些理论上可行的方案</em></p>
<p>对于引入 Vue/React、包含大量第三方库的复杂 CRX，需结合 Webpack 实现代码编译、压缩优化，其 NPM 脚本在纯原生基础上增加构建环节，<strong>密钥的使用逻辑与纯原生一致</strong>（复用<code>key.pem</code>签名）：</p>
<h4 data-id="heading-16">1. 安装 Webpack 相关依赖</h4>
<pre><code class="hljs language-js" lang="js"># 安装<span class="hljs-title class_">Webpack</span>及优化插件
npm install webpack webpack-cli clean-webpack-plugin terser-webpack-plugin css-minimizer-webpack-plugin --save-dev
</code></pre>
<h4 data-id="heading-17">2. 混合开发的 NPM 脚本配置</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack-crx"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rimraf dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:compile"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack --config webpack.config.js"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Webpack编译/优化源码</span>
    <span class="hljs-attr">"copy:static"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copyfiles -u 1 src/manifest.json src/assets/**/* dist/unpacked"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 复制非编译资源</span>
    <span class="hljs-attr">"build:unpacked"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run clean &amp;&amp; npm run build:compile &amp;&amp; npm run copy:static"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:crx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/crx/webpack-crx-v$npm_package_version.crx -p key.pem &amp;&amp; echo '密钥文件为key.pem，请注意备份！'"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build:zip"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"crx3 pack dist/unpacked -o dist/zip/webpack-crx-v$npm_package_version.zip --zip"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run build:unpacked &amp;&amp; npm run build:crx &amp;&amp; npm run build:zip"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webpack --watch --config webpack.config.js &amp; copyfiles -u 1 src/**/* dist/unpacked --watch"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"backup:key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"copy key.pem backups/key-v$npm_package_version.pem &amp;&amp; echo '密钥已备份到backups/目录！'"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-18">基于输入输出的性能优化：从体积到性能</h3>
<p>直接使用解压目录时，源码中的冗余代码、未压缩的资源会导致 CRX 体积大、加载慢，而通过工程化流程，可在<strong>输入处理</strong>和<strong>输出构建</strong>阶段做针对性优化。</p>
<h4 data-id="heading-19">1. 输入阶段：源码层面的轻量化优化（纯原生 / 工程化通用）</h4>
<p>在标准化输入目录的基础上，从源码源头减少冗余：</p>
<ul>
<li><strong>按需拆分模块</strong>：将 content 脚本按功能拆分为多个子模块，仅在需要时注入（如<code>chrome.scripting.executeScript</code>动态注入），而非一次性加载所有代码。</li>
<li><strong>剔除冗余资源</strong>：输入目录中仅保留必要的静态资源（如只保留 16/48/128px 的图标），删除开发日志、测试文件等无关内容。</li>
<li><strong>使用原生 API 替代第三方库</strong>：纯原生 CRX 中，用原生<code>fetch</code>替代<code>axios</code>，用原生数组方法替代<code>lodash</code>，减少第三方库的体积引入。</li>
</ul>
<h4 data-id="heading-20">2. 输出阶段：纯原生 CRX 的轻量优化</h4>
<p>纯原生 CRX 无需编译，可通过简单手段优化输出产物，同时不影响密钥签名逻辑：</p>
<ul>
<li><strong>手动压缩静态资源</strong>：使用在线工具压缩图片（如 TinyPNG）、CSS/JS（如 Terser 在线版），将压缩后的文件放入<code>dist/unpacked/</code>，再执行<code>build:crx</code>签名，体积优化后不影响签名合法性。</li>
<li><strong>删除注释与空白</strong>：手动剔除 JS/CSS 中的注释、多余空白，减少文件体积（小型 CRX 效果显著）。</li>
<li><strong>资源内联</strong>：将小图标转为 Base64 编码，直接写入 CSS/HTML 中，减少 CRX 的文件数量，避免注入时的资源请求。</li>
</ul>
<h4 data-id="heading-21">3. 输出阶段：工程化 CRX 的深度优化（Webpack）</h4>
<p>通过 Webpack 配置实现自动化优化，解决纯原生手动优化的低效问题，且优化后的产物仍可通过<code>key.pem</code>正常签名：这里就不过多阐述啦，感兴趣的可以沿着以下三个方向去查阅相关资料。</p>
<h5 data-id="heading-22">（1）代码压缩与混淆</h5>
<h5 data-id="heading-23">（2）Tree Shaking 剔除无用代码</h5>
<h5 data-id="heading-24">（3）静态资源优化</h5>
<h3 data-id="heading-25">对比直接用解压目录：工程化流程的核心优势（含密钥安全维度）</h3>















































<table><thead><tr><th>维度</th><th>直接使用解压目录</th><th>纯原生 CRX 工程化（NPM 脚本 + 密钥）</th><th>工程化 CRX（Webpack+NPM + 密钥）</th></tr></thead><tbody><tr><td><strong>资源管理</strong></td><td>文件结构混乱，路径易出错</td><td>标准化输入输出，路径可控</td><td>模块化设计，解耦性强</td></tr><tr><td><strong>操作效率</strong></td><td>手动复制 / 修改 / 签名，效率极低</td><td>一键自动化，跨平台兼容</td><td>编译 + 打包 + 签名一键完成</td></tr><tr><td><strong>版本管理</strong></td><td>无版本标识，易混淆</td><td>版本号自动关联产物名</td><td>版本追溯清晰，可集成 CI/CD</td></tr><tr><td><strong>性能表现</strong></td><td>源码未优化，体积大、加载慢</td><td>轻量手动优化，体积小幅缩减</td><td>代码压缩 + Tree Shaking，性能优异</td></tr><tr><td><strong>安全与分发</strong></td><td>源码暴露，易被篡改，无更新保障</td><td>带签名的.crx，防篡改，密钥保障更新</td><td>代码混淆 + 签名，安全级别更高</td></tr><tr><td><strong>密钥管理</strong></td><td>无密钥概念，无法证明开发者身份</td><td>自动生成 + 备份脚本，管理规范</td><td>复用密钥，支持规模化发布</td></tr></tbody></table>
<h3 data-id="heading-26">总结</h3>
<p>直接使用解压目录仅能满足 CRX 的调试需求，而通过<strong>标准化输入输出</strong>规范资源结构，<strong>NPM 自定义脚本</strong>实现纯原生 / 工程化的自动化打包（含密钥的生成、复用与备份），再结合性能优化手段，才能让 CRX 成为可分发、高性能且安全的产品。</p>
<p>其中，<strong>密钥（<code>key.pem</code>）</strong> 是 CRX 从 “调试原型” 走向 “生产分发” 的安全核心，解决了直接用解压目录的篡改与更新问题；而<strong>NPM脚本</strong>则将密钥管理、资源复制、签名打包等流程<strong>自动化</strong>，大幅提升开发效率。对于简单的纯原生 CRX，轻量的 NPM 脚本 + 密钥管理即可满足需求；对于复杂 CRX，结合 Webpack 的工程化流程则能实现深度的性能优化，且全程复用密钥保障扩展的合法性。
总而言之，打包就是要明白<strong>输入</strong>是什么， <strong>输出</strong>有什么，<strong>输入到输出</strong>发生了什么！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Context 的 “上下文”]]></title>    <link>https://juejin.cn/post/7586684925107060779</link>    <guid>https://juejin.cn/post/7586684925107060779</guid>    <pubDate>2025-12-23T07:02:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586684925107060779" data-draft-id="7586684925106978859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Context 的 “上下文”"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T07:02:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="StarShip"/> <meta itemprop="url" content="https://juejin.cn/user/3790771820172391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Context 的 “上下文”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771820172391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    StarShip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:02:19.000Z" title="Tue Dec 23 2025 07:02:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题：</h2>
<p>请系统讲解 Android 中 <code>Context</code> 及其相关类的设计与应用，内容需涵盖以下方面：</p>
<ol>
<li>
<p><strong>类的体系结构与关系</strong></p>
<ol>
<li>说明 <code>Context</code> 抽象类的作用及核心接口</li>
<li>介绍 <code>ContextImpl</code>、<code>Application</code>、<code>Activity</code>、<code>Service</code>、<code>BroadcastReceiver</code> 等与 <code>Context</code> 关联的类，以及它们之间的继承与实现关系</li>
<li>对这些类的职责与使用场景进行对比说明</li>
</ol>
</li>
<li>
<p><strong>设计原理与机制</strong></p>
<ol>
<li>解释 <code>Context</code> 在 Android 框架中作为全局访问点的设计思想</li>
<li>描述其在资源访问、组件启动、系统服务获取中的作用</li>
<li>阐述为何设计成接口/抽象类，及背后的解耦和可扩展性考虑</li>
</ol>
</li>
<li>
<p><strong>主题与样式支持</strong></p>
<ol>
<li>分析 <code>Context</code> 如何支持 <code>Theme</code>、<code>Style</code> 的加载与应用</li>
<li>说明 <code>setTheme()</code>、<code>getTheme()</code> 的工作原理</li>
<li>举例 Activity 与 Application 中主题的继承与覆盖机制</li>
</ol>
</li>
<li>
<p><strong>使用建议与最佳实践</strong></p>
<ol>
<li>说明在不同场景中选择合适类型的 Context（如 Application Context vs Activity Context）</li>
<li>讨论避免内存泄漏的常见方法</li>
</ol>
</li>
<li>
<p><strong>结构化输出要求</strong></p>
<ol>
<li>使用分标题、层级列表或表格</li>
<li>必要时配合简单流程图或示意图</li>
<li>结合代码片段进行说明（Java/Kotlin 皆可）</li>
</ol>
</li>
</ol>
<p>目标：帮助理解 <code>Context</code> 的类关系脉络、设计理念以及在主题支持上的实现细节，既有理论深度，也有实用指导。</p>
<hr/>
<p>下面的内容按“结构 → 原理 → 主题 → 实战与最佳实践”的顺序展开，你可以当成一份系统的 <code>Context</code> 速查+原理笔记。</p>
<hr/>
<h2 data-id="heading-1"><strong>一、</strong> <strong><code>Context</code></strong> <strong>体系结构与类关系</strong></h2>
<h3 data-id="heading-2"><strong>1.1</strong> <strong><code>Context</code></strong> <strong>抽象类的角色与核心能力</strong></h3>
<p><strong><code>Context</code></strong> <strong>= 当前应用运行环境的“句柄”</strong> ，它把“我是谁、在哪个包、用什么资源与配置、能访问哪些系统能力”这类信息封装起来，并提供统一 API。</p>
<p>它是一个 <strong>抽象类</strong>，不直接被实例化，主要能力可以分几类：</p>
<ol>
<li>
<p><strong>资源与配置访问</strong></p>
<ol>
<li><code>getResources()</code>：访问 <code>res/</code> 里的所有资源</li>
<li><code>getAssets()</code>：访问打包进 APK 的资源文件</li>
<li><code>getPackageName()</code>、<code>getApplicationInfo()</code>、<code>getPackageManager()</code> 等</li>
</ol>
</li>
<li>
<p><strong>组件管理 / 应用<strong><strong>生命周期</strong></strong>相关</strong></p>
<ol>
<li><code>startActivity()</code>, <code>startService()</code>, <code>bindService()</code>, <code>sendBroadcast()</code> …</li>
<li><code>registerReceiver()</code>, <code>unregisterReceiver()</code></li>
</ol>
</li>
<li>
<p><strong>系统服务****获取</strong></p>
</li>
</ol>
<ul>
<li><code>getSystemService(String name)</code></li>
</ul>
<pre><code class="hljs language-ini" lang="ini">LayoutInflater <span class="hljs-attr">inflater</span> = (LayoutInflater)
        context.getSystemService(Context.LAYOUT_INFLATER_SERVICE)<span class="hljs-comment">;</span>
PowerManager <span class="hljs-attr">pm</span> = (PowerManager)
        context.getSystemService(Context.POWER_SERVICE)<span class="hljs-comment">;</span>
</code></pre>
<ol start="4">
<li>
<p><strong>存储与数据</strong></p>
<ol>
<li><code>openFileInput()</code>, <code>openFileOutput()</code>（内部文件）</li>
<li><code>getSharedPreferences()</code></li>
<li><code>getDatabasePath()</code>, <code>openOrCreateDatabase()</code></li>
</ol>
</li>
<li>
<p><strong>UI /</strong> <strong>主题****相关（由支持主题的子类实现）</strong></p>
<ol>
<li><code>setTheme(int resId)</code></li>
<li><code>getTheme()</code></li>
<li><code>getResources().getDrawable()</code> 等主题敏感资源</li>
</ol>
</li>
</ol>
<p><strong>设计要点：</strong> 对开发者来说，<strong>不关心到底是哪个具体子类</strong>（<code>Activity</code>、<code>Application</code> 等），只要拿到一个 <code>Context</code> 引用，就能在“一致的 API”下工作。</p>
<h3 data-id="heading-3"><strong>1.2 核心类的继承与关系示意图</strong></h3>
<p>简化版类图（忽略一些细枝末节）：</p>
<pre><code class="hljs language-lua" lang="lua">          (抽象)
        +<span class="hljs-comment">-----------+</span>
        |  Context  |
        +<span class="hljs-comment">-----------+</span>
             ^
             |
      +<span class="hljs-comment">-------------+</span>
      | ContextImpl |  ← 真正的实现类（framework 内部）
      +<span class="hljs-comment">-------------+</span>

             ^
             | (组合/委托：mBase)
      +<span class="hljs-comment">------------------+</span>
      |  ContextWrapper  |
      +<span class="hljs-comment">------------------+</span>
             ^
             |
   +<span class="hljs-comment">----------------------+</span>
   |  ContextThemeWrapper |  ← 支持 Theme 的包装
   +<span class="hljs-comment">----------------------+</span>
      ^              ^
      |              |
+<span class="hljs-comment">------------+   +--------+</span>
|  Activity  |   |  ...   |
+<span class="hljs-comment">------------+</span>

+<span class="hljs-comment">--------------+</span>
| Application  |  ← 继承 ContextWrapper（不带 UI Theme）
+<span class="hljs-comment">--------------+</span>

+<span class="hljs-comment">------------+</span>
|  Service   |  ← 继承 ContextWrapper（不带 UI Theme）
+<span class="hljs-comment">------------+</span>
</code></pre>
<p><strong><code>BroadcastReceiver</code></strong> <strong>没有继承</strong> <code>Context</code>，它只是：</p>
<p>void onReceive(Context context, Intent intent)</p>
<p>通过参数暂时拿到一个 <code>Context</code>。</p>
<h3 data-id="heading-4"><strong>1.3 关键类逐个看：</strong></h3>
<h4 data-id="heading-5"><strong>1）</strong> <strong><code>ContextImpl</code></strong> <strong>（内部实现）</strong></h4>
<ul>
<li>
<p>位于 framework 内部，是 <strong><code>Context</code></strong> <strong>的具体实现类</strong>。（不对外暴露）</p>
</li>
<li>
<p>持有：</p>
<ul>
<li><code>LoadedApk</code> / <code>Resources</code> / <code>AssetManager</code> / <code>PackageInfo</code></li>
<li><code>IBinder</code> 到 AMS 等系统服务的引用</li>
</ul>
</li>
<li>
<p><strong>应用进程****中真正干活的对象</strong>，其他对外暴露的 <code>Context</code> 大多是对 <code>ContextImpl</code> 的包装。</p>
</li>
</ul>
<h4 data-id="heading-6"><strong>2）</strong> <strong><code>ContextWrapper</code></strong></h4>
<ul>
<li>继承 <code>Context</code>，内部有一个：protected Context mBase;</li>
<li>所有方法基本都是：</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">Resources</span> <span class="hljs-title function_">getResources</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> mBase.<span class="hljs-title function_">getResources</span>();
}
</code></pre>
<ul>
<li>作用：<strong>利用委托模式包装一个</strong> <strong><code>Context</code></strong> <strong>实现（通常是</strong> <strong><code>ContextImpl</code></strong> <strong>），并允许子类按需重写部分行为。</strong></li>
</ul>
<h4 data-id="heading-7"><strong>3）</strong> <strong><code>ContextThemeWrapper</code></strong></h4>
<ul>
<li>
<p>继承 <code>ContextWrapper</code>，<strong>引入主题（</strong> <strong><code>Theme</code></strong> <strong>）的概念</strong>。</p>
</li>
<li>
<p>维护：</p>
<ul>
<li><code>Resources.Theme mTheme</code></li>
<li><code>int mThemeResource</code></li>
</ul>
</li>
<li>
<p>为 UI 组件（主要是 <code>Activity</code>、<code>Dialog</code> 等）提供：</p>
<ul>
<li><code>setTheme(int resId)</code></li>
<li><code>getTheme()</code></li>
</ul>
</li>
<li>
<p><strong>只有基于</strong> <strong><code>ContextThemeWrapper</code></strong> <strong>的 Context 才真正支持 UI 主题。</strong></p>
</li>
</ul>
<h4 data-id="heading-8"><strong>4）</strong> <strong><code>Application</code></strong></h4>
<ul>
<li>
<p>继承 <code>ContextWrapper</code>，<strong>全应用级别的 Context</strong>。</p>
</li>
<li>
<p>生命周期：<code>onCreate()</code> 在整个应用进程创建时调用一次。</p>
</li>
<li>
<p>主要职责：</p>
<ul>
<li>初始化应用级别的组件（例如：网络库、日志系统、依赖注入容器等）</li>
<li>提供 <strong>Application Context</strong>（<code>getApplicationContext()</code>）</li>
</ul>
</li>
<li>
<p>不直接参与 UI 绘制，对主题支持有限（不用于 View inflation 的 UI Theme）。</p>
</li>
</ul>
<h4 data-id="heading-9"><strong>5）</strong> <strong><code>Activity</code></strong></h4>
<ul>
<li>
<p>继承 <code>ContextThemeWrapper</code>，因此：</p>
<ul>
<li>既是一个 <code>Context</code>，</li>
<li>又是一个 <strong>支持主题的 UI 宿主组件</strong>。</li>
</ul>
</li>
<li>
<p>职责：</p>
<ul>
<li>
<p>管理界面（布局、交互）</p>
</li>
<li>
<p>管理生命周期（<code>onCreate</code>/<code>onStart</code>/<code>onResume</code>…）</p>
</li>
<li>
<p>承担一个“UI 级 Context”：用于</p>
<ul>
<li><code>LayoutInflater</code></li>
<li>Dialog、Popup、Menu 的创建</li>
<li>主题化资源加载（<code>?attr/colorPrimary</code> 等）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-10"><strong>6）</strong> <strong><code>Service</code></strong></h4>
<ul>
<li>
<p>继承 <code>ContextWrapper</code>，<strong>不支持 UI 主题</strong>。</p>
</li>
<li>
<p>职责：</p>
<ul>
<li>在后台执行长时间任务（播放音乐、网络下载等）</li>
<li>支持与其他组件绑定/通信（<code>bindService</code>）</li>
</ul>
</li>
<li>
<p>由于不处理 UI，<strong>不能直接显示窗口、Dialog</strong>（需要借助 <code>Activity</code> 或特殊系统权限）。</p>
</li>
</ul>
<h4 data-id="heading-11"><strong>7）</strong> <strong><code>BroadcastReceiver</code></strong></h4>
<ul>
<li>
<p>不是 <code>Context</code>，但 <code>onReceive()</code> 会给你一个临时的 <code>Context</code>。</p>
</li>
<li>
<p>这个 <code>Context</code> 通常是一个 <strong>短生命周期的</strong> <strong><code>ContextImpl</code></strong> <strong>包装</strong>，主要用于：</p>
<ul>
<li>简单操作：<code>startService()</code>、<code>goAsync()</code> 等</li>
<li>不推荐做耗时操作（<code>onReceive</code> 要尽快返回）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-12"><strong>1.4 类职责对比（简表）</strong></h3>



























































<table><thead><tr><th>类/角色</th><th>是否继承 Context</th><th>是否支持 Theme</th><th>典型使用场景</th></tr></thead><tbody><tr><td>Context（抽象）</td><td>是</td><td>取决于子类</td><td>框架统一接口，不直接使用</td></tr><tr><td>ContextImpl</td><td>是（内部）</td><td>视类型而定</td><td>真正实现所有 Context 功能</td></tr><tr><td>ContextWrapper</td><td>是</td><td>否</td><td>对 ContextImpl 的通用包装</td></tr><tr><td>ContextThemeWrapper</td><td>是</td><td>是</td><td>提供 UI 主题能力（Activity、Dialog 等）</td></tr><tr><td>Application</td><td>是</td><td>有方法，但不用于 UI</td><td>全局初始化、单例、Application Context</td></tr><tr><td>Activity</td><td>是</td><td>是</td><td>界面、View、用户交互</td></tr><tr><td>Service</td><td>是</td><td>否</td><td>后台任务、长期运行逻辑</td></tr><tr><td>BroadcastReceiver</td><td>否</td><td>否</td><td>被动响应广播，通过参数获取 Context</td></tr></tbody></table>
<h2 data-id="heading-13"><strong>二、设计原理与机制</strong></h2>
<h3 data-id="heading-14"><strong>2.1 Context 作为“全局访问点”的设计思想</strong></h3>
<p>Android 不鼓励你使用大量的 <code>static</code> 全局变量来到处传递状态，而是通过 <strong><code>Context</code></strong> <strong>作为</strong> <strong>“应用环境的访问门面（facade）</strong> <strong>”</strong> ，提供：</p>
<ul>
<li>
<p><strong>统一的访问入口</strong>：资源、系统服务、组件启动都从这里拿。</p>
</li>
<li>
<p><strong>隐藏实现细节</strong>：你不需要知道 <code>ActivityManager</code> 在哪一进程，只管 <code>startActivity()</code>。</p>
</li>
<li>
<p><strong>分级的“全局”</strong> ：</p>
<ul>
<li>Application 级：<code>Application</code> / <code>getApplicationContext()</code></li>
<li>Activity 级：带 UI 的 <code>Context</code></li>
<li>Service 级、Receiver 级：非 UI Context</li>
</ul>
</li>
</ul>
<p>这有点类似 <strong>Service Locator</strong> 或 <strong>Facade</strong> 模式：<strong>让上层代码依赖稳定接口，而不依赖具体实现</strong></p>
<h3 data-id="heading-15"><strong>2.2 资源访问机制（Resources / Assets）</strong></h3>
<p>当你调用：</p>
<pre><code class="hljs language-ini" lang="ini">Resources <span class="hljs-attr">res</span> = context.getResources()<span class="hljs-comment">;</span>
Drawable <span class="hljs-attr">d</span> = res.getDrawable(R.drawable.xxx, context.getTheme())<span class="hljs-comment">;</span>
</code></pre>
<p>内部大致流程：</p>
<ol>
<li>
<p><code>context</code>（可能是 Activity / Application）最终委托到 <code>ContextImpl</code>。</p>
</li>
<li>
<p><code>ContextImpl</code> 内部持有一个 <code>Resources</code> 实例，关联当前</p>
<ol>
<li>包名 / APK</li>
<li><code>Configuration</code>（语言、方向、dpi 等）</li>
<li><code>AssetManager</code></li>
</ol>
</li>
<li>
<p><code>Resources</code> 根据当前 <strong><code>Configuration + Theme</code></strong> 选择合适的资源版本（如 <code>values-en</code>、<code>values-night</code> 等）。</p>
</li>
</ol>
<p><strong>关键点：</strong></p>
<ul>
<li><code>ContextImpl</code> 决定“去哪儿找资源”</li>
<li><strong>Theme 会影响资源最终表现</strong>（例如：<code>?attr/colorPrimary</code>）</li>
</ul>
<h3 data-id="heading-16"><strong>2.3 组件启动机制（以</strong> <strong><code>startActivity</code></strong> <strong>为例）</strong></h3>
<pre><code class="hljs language-arduino" lang="arduino">context.<span class="hljs-built_in">startActivity</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Intent</span>(context, DetailActivity.<span class="hljs-keyword">class</span>));
</code></pre>
<p>简化理解：</p>
<ol>
<li><code>Activity</code> / <code>Application</code> → <code>ContextImpl.startActivity()</code></li>
<li>内部通过 <code>Instrumentation</code> / <code>ActivityTaskManager</code> / <code>ActivityManagerService</code> 与系统进程通信（Binder）</li>
<li>系统进程根据 Intent / Manifest 信息，在合适的进程启动/复用 <code>Activity</code> 实例。</li>
<li>新 <code>Activity</code> 创建时，被注入一个 <strong><code>ContextImpl + ContextWrapper</code></strong> <strong>组合的 Context</strong>，并在 <code>attach()</code> 时绑定。</li>
</ol>
<p><strong>好处：</strong> 你的代码只需调用 <code>Context</code> 的 API，不需要直接依赖任何 system_server 内部类。</p>
<h3 data-id="heading-17"><strong>2.4 系统服务获取机制：</strong> <strong><code>getSystemService()</code></strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Object</span> <span class="hljs-title function_">getSystemService</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name</span>) {
    <span class="hljs-comment">// 1. 先查看当前 Context 的本地缓存（Map）</span>
    <span class="hljs-comment">// 2. 如果是“真·系统服务”：</span>
    <span class="hljs-comment">//    - 通过 ServiceManager 拿 Binder（一次）</span>
    <span class="hljs-comment">//    - 转成对应的 Manager 类（如 LocationManager）</span>
    <span class="hljs-comment">//    - 缓存起来</span>
    <span class="hljs-comment">// 3. 如果是本地工具类：</span>
    <span class="hljs-comment">//    - 直接 new（如 LayoutInflater）</span>
    <span class="hljs-comment">//    - 缓存起来</span>
}
</code></pre>
<p><strong>区别：</strong></p>
<ul>
<li>
<p><strong>例如</strong> <strong><code>LocationManager</code></strong> <strong>、</strong> <strong><code>PowerManager</code></strong>：</p>
<ul>
<li>内部持有 Binder 代理 → 调用时可能产生 IPC。</li>
</ul>
</li>
<li>
<p><strong>例如</strong> <strong><code>LayoutInflater</code></strong>：</p>
<ul>
<li>是当前进程内的纯 Java 对象 → 不产生 IPC。</li>
</ul>
</li>
</ul>
<p><strong>Context 的意义</strong>：你不用区分“这个服务是远程的还是本地的”，统一通过 <code>getSystemService()</code> 拿就行。</p>
<h3 data-id="heading-18"><strong>2.5 为什么设计成抽象类 + Wrapper，而不是一个单例？</strong></h3>
<p><strong>原因主要是几个维度的解耦与可扩展性：</strong></p>
<ol>
<li>
<p><strong>不同组件需要“不一样”的 Context 行为</strong></p>
<ol>
<li>Activity 需要 Theme、Window、<code>startActivityForResult</code> 等</li>
<li>Service 不需要 Theme，也不能直接弹 UI</li>
<li>Application 需要“全局但不依赖任何具体 UI”的 Context</li>
</ol>
</li>
</ol>
<p>用 <strong><code>ContextWrapper</code></strong> <strong>/</strong> <strong><code>ContextThemeWrapper</code></strong> 即可在保持统一接口的同时，添加/修改特定行为。</p>
<blockquote>
<p>装饰者设计模式</p>
</blockquote>
<ol start="2">
<li>
<p><strong>内部实现可以替换</strong></p>
<ol>
<li>对外只暴露 <code>Context</code> 抽象类和 <code>getSystemService()</code> 这类稳定接口</li>
<li>内部 <code>ContextImpl</code> 的实现可以随着版本演进自由修改</li>
</ol>
</li>
<li>
<p><strong>方便测试 / Mock</strong></p>
<ol>
<li>在单元测试中可以实现一个自定义 <code>Context</code> 或基于 <code>ContextWrapper</code> 的 mock，不需要运行真实的 Android 系统。</li>
</ol>
</li>
</ol>
<h2 data-id="heading-19"><strong>三、主题（Theme）与样式（Style）支持</strong></h2>
<h3 data-id="heading-20"><strong>3.1 Context 与 Theme 的关系</strong></h3>
<p><strong>只有基于</strong> <strong><code>ContextThemeWrapper</code></strong> <strong>的 Context 才真正具备“UI 主题上下文”的语义</strong>，核心数据结构：</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContextThemeWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ContextWrapper</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-type">Resources</span>.<span class="hljs-type">Theme</span> mTheme;
    <span class="hljs-keyword">private</span> int mThemeResource;
}
</code></pre>
<p><strong>Activity = ContextThemeWrapper + UI 能力</strong>，因此：</p>
<ul>
<li>
<p><code>Activity</code> 的 <code>Theme</code> 决定：</p>
<ul>
<li><code>setContentView()</code> 时 View 默认使用怎样的样式</li>
<li><code>?attr/colorPrimary</code>, <code>?attr/textColorPrimary</code> 等主题属性的解析结果</li>
</ul>
</li>
</ul>
<p>而 <strong>Application / Service 的 Context 即使有</strong> <strong><code>setTheme()</code></strong> <strong>方法，也通常不用于 View 的主题化</strong>（因为不会直接 inflate 界面）。</p>
<h3 data-id="heading-21"><strong>3.2</strong> <strong><code>setTheme()</code></strong> <strong>/</strong> <strong><code>getTheme()</code></strong> <strong>工作原理（简化）</strong></h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
public void setTheme(int resid) {
    mThemeResource = resid;
    <span class="hljs-built_in">initializeTheme</span>();
}

private void <span class="hljs-built_in">initializeTheme</span>() {
    final boolean first = (mTheme == null);
    if (first) {
        <span class="hljs-comment">// 1. 创建一个新的 Theme</span>
        mTheme = <span class="hljs-built_in">getResources</span>()<span class="hljs-selector-class">.newTheme</span>();
    }

    <span class="hljs-comment">// 2. 先根据父 Context（或 Application）继承一份基础 Theme</span>
    final Theme parent = <span class="hljs-built_in">getBaseContext</span>()<span class="hljs-selector-class">.getTheme</span>();
    if (parent != null) {
        mTheme<span class="hljs-selector-class">.setTo</span>(parent);
    }

    <span class="hljs-comment">// 3. 再把当前资源 id 对应的 style 叠加上去</span>
    mTheme<span class="hljs-selector-class">.applyStyle</span>(mThemeResource, true);
}

<span class="hljs-keyword">@Override</span>
public Resources.Theme getTheme() {
    if (mTheme == null) {
        <span class="hljs-comment">// 如果还没 setTheme，就根据默认 theme 初始化</span>
        mThemeResource = <span class="hljs-built_in">getApplicationInfo</span>()<span class="hljs-selector-class">.theme</span>; <span class="hljs-comment">// Manifest 里配置的</span>
        <span class="hljs-built_in">initializeTheme</span>();
    }
    return mTheme;
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><code>Theme</code> 是对 <code>Resources</code> 中 <code>&lt;style&gt;</code> 的运行时组合/叠加结果。</li>
<li><code>applyStyle()</code> 可以多次调用，后面的 style 能覆盖前面的属性。</li>
<li><code>Activity</code> 的 Theme 在 <code>onCreate()</code> 前就已准备好，<code>setContentView()</code> 时就会用这个 Theme 去解析布局里的 <code>?attr/xxx</code>。</li>
</ul>
<h3 data-id="heading-22"><strong>3.3 Activity 与 Application 主题的继承与覆盖</strong></h3>
<p>Manifest 中常见配置：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;application
    android:<span class="hljs-attr">name</span>=<span class="hljs-string">".MyApp"</span>
    android:<span class="hljs-attr">theme</span>=<span class="hljs-string">"@style/AppTheme"</span>&gt;

    &lt;activity
        android:<span class="hljs-attr">name</span>=<span class="hljs-string">".MainActivity"</span>
        android:<span class="hljs-attr">theme</span>=<span class="hljs-string">"@style/AppTheme.Main"</span>/&gt;
&lt;/application&gt;
</code></pre>
<p><strong>继承链：</strong></p>
<ol>
<li>
<p>Application 设置 <code>android:theme="@style/AppTheme"</code>：</p>
<ol>
<li>作为 <strong>应用内 Activity 的默认主题</strong>（除非 Activity 自己覆盖）</li>
</ol>
</li>
<li>
<p>Activity 设置 <code>android:theme="@style/AppTheme.Main"</code>：</p>
<ol>
<li>其 <code>Theme</code> = 以 Application 的 Theme 为基础，再叠加 <code>AppTheme.Main</code> 的效果（具体取决于 style 的父子关系）。</li>
</ol>
</li>
<li>
<p>如果某个 Activity 未显式声明 <code>android:theme</code>：</p>
<ol>
<li>使用 Application 的 theme 作为其 Theme。</li>
</ol>
</li>
</ol>
<p><strong>运行时覆盖：</strong></p>
<p>在 Activity 中可以：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
protected void onCreate(Bundle savedInstanceState) {
    <span class="hljs-built_in">setTheme</span>(R.style.AppTheme_Dark); <span class="hljs-comment">// 必须在 super.onCreate() 之前调用更稳妥</span>
    super<span class="hljs-selector-class">.onCreate</span>(savedInstanceState);
    <span class="hljs-built_in">setContentView</span>(R.layout.activity_main);
}
</code></pre>
<p>也可以为某个局部 UI 创建一个带特定 Theme 的 Context：</p>
<pre><code class="hljs language-ini" lang="ini">Context <span class="hljs-attr">themedContext</span> =
        new ContextThemeWrapper(this, R.style.MyDialogTheme)<span class="hljs-comment">;</span>
AlertDialog <span class="hljs-attr">dialog</span> = new AlertDialog.Builder(themedContext)
        .setTitle("Title")
        .setMessage("Hello")
        .create()<span class="hljs-comment">;</span>
dialog.show()<span class="hljs-comment">;</span>
</code></pre>
<p><strong>这个</strong> <strong><code>ContextThemeWrapper</code></strong> <strong>就是一个局部“主题化 Context”</strong> ，很常用于 Dialog、PopupMenu、RecyclerView item 的样式等。</p>
<h2 data-id="heading-23"><strong>四、使用建议与最佳实践</strong></h2>
<h3 data-id="heading-24"><strong>4.1 如何选择合适的 Context？</strong></h3>


















































<table><thead><tr><th>场景/需求</th><th>推荐 Context 类型</th><th>原因说明</th></tr></thead><tbody><tr><td>加载/绘制界面（setContentView、inflate View）</td><td>Activity Context (this)</td><td>需要使用 Activity 的 Theme、Window，支持 UI 属性解析</td></tr><tr><td>创建 Dialog、PopupWindow、Menu</td><td>Activity Context / 主题化 ContextThemeWrapper</td><td>需要依附 Window、Theme，Application Context 无法正常工作</td></tr><tr><td>启动新的 Activity</td><td>一般用 Activity Context</td><td>与当前 Activity 的任务栈、动画等直接相关</td></tr><tr><td>启动或绑定 Service</td><td>任意合法 Context（注：有时需要非 Activity）</td><td>通常用 Application 或 Activity，都可以，与 UI 无强绑定</td></tr><tr><td>注册全局单例、工具类初始化</td><td>Application Context</td><td>生命周期 = 应用进程，不易造成 Activity 泄漏</td></tr><tr><td>访问系统服务（不依赖 UI，例如 Vibrator、Connectivity）</td><td>Application Context</td><td>仅需系统服务，不需要 Theme/Window</td></tr><tr><td>BroadcastReceiver 中进行短时操作</td><td>onReceive 里的 Context 参数</td><td>系统给你的就是合适的 Context，短时间用完即可</td></tr><tr><td>长时间缓存 Context 引用</td><td>Application Context</td><td>Activity Context 可能被销毁，缓存会导致内存泄漏</td></tr></tbody></table>
<p><strong>经验总结：</strong></p>
<ul>
<li><strong>涉及 UI / Theme / View 的，一律优先用 Activity Context</strong></li>
<li><strong>要放进单例、静态变量、长生命周期对象，则用 Application Context</strong></li>
</ul>
<h3 data-id="heading-25"><strong>4.2 避免内存泄漏的常见方法</strong></h3>
<ol>
<li><strong>不要把 Activity Context 存入静态变量 / 单例</strong></li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ImageLoader</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ImageLoader sInstance;
    <span class="hljs-keyword">private</span> Context mContext;

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">ImageLoader</span>(<span class="hljs-params">Context context</span>)</span> {
        mContext = context; <span class="hljs-comment">// 若传入 Activity，则可能泄漏</span>
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ImageLoader <span class="hljs-title">getInstance</span>(<span class="hljs-params">Context context</span>)</span> {
        <span class="hljs-keyword">if</span> (sInstance == <span class="hljs-literal">null</span>) {
            sInstance = <span class="hljs-keyword">new</span> ImageLoader(context);
        }
        <span class="hljs-keyword">return</span> sInstance;
    }
}
</code></pre>
<p>正确做法：改用 Application Context</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">mContext</span> = context.getApplicationContext()<span class="hljs-comment">;</span>
</code></pre>
<ol start="2">
<li><strong>避免 Handler / Thread 等隐式持有 Activity</strong></li>
</ol>
<ul>
<li>非静态内部类会默认持有外部类（Activity）的引用。</li>
<li>可以使用 <strong>静态内部类 +</strong> <strong><code>WeakReference&lt;Activity&gt;</code></strong> ：</li>
</ul>
<pre><code class="hljs language-scala" lang="scala">static <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Handler</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">WeakReference</span>&lt;<span class="hljs-type">Activity</span>&gt; activityRef;

    <span class="hljs-type">MyHandler</span>(<span class="hljs-type">Activity</span> activity) {
        activityRef = <span class="hljs-keyword">new</span> <span class="hljs-type">WeakReference</span>&lt;&gt;(activity);
    }

    <span class="hljs-meta">@Override</span>
    public void handleMessage(<span class="hljs-type">Message</span> msg) {
        <span class="hljs-type">Activity</span> activity = activityRef.get();
        <span class="hljs-keyword">if</span> (activity == <span class="hljs-literal">null</span> || activity.isFinishing()) <span class="hljs-keyword">return</span>;
        <span class="hljs-comment">// 安全使用 activity</span>
    }
}
</code></pre>
<ol start="3">
<li><strong>注意 View 持有 Context</strong></li>
</ol>
<ul>
<li>所有 <code>View</code> 的构造函数都会传入一个 Context，通常是 Activity。</li>
<li>如果你把一个 View（或包含它的对象）缓存到单例里，相当于间接缓存 Activity Context → 泄漏。</li>
<li><strong>规则：不要把 View 放到长生命周期的静态集合或单例中。</strong></li>
</ul>
<ol start="4">
<li><strong>使用生命周期感知组件（Lifecycle-Aware）</strong></li>
</ol>
<ul>
<li>使用 Jetpack 的 <code>ViewModel</code>、<code>LiveData</code>、<code>LifecycleOwner</code> 等，让框架帮助你在适当时机清理引用。</li>
<li><code>ViewModel</code> 中一般只用 Application Context（通过 <code>AndroidViewModel</code>），不要持有 Activity Context。</li>
</ul>
<h2 data-id="heading-26"><strong>五、整体小结</strong></h2>
<ul>
<li>
<p><strong><code>Context</code></strong> <strong>是 Android 应用环境的“门面”，统一对外提供资源访问、组件启动、系统服务获取等能力。</strong></p>
</li>
<li>
<p>通过 <strong><code>ContextImpl + ContextWrapper + ContextThemeWrapper</code></strong> <strong>的分层设计</strong>：</p>
<ul>
<li>把复杂、易变的内部实现封装在 <code>ContextImpl</code> 中；</li>
<li>通过不同包装类（Application、Activity、Service）组合出不同语义的 Context；</li>
<li>同时支持 UI 主题（Theme）、非 UI 背景服务、多进程等场景。</li>
</ul>
</li>
<li>
<p><strong>Theme/Style 与 Context 强绑定</strong>：只有基于 <code>ContextThemeWrapper</code> 的 Context 才具备完整的 UI 主题语义；Activity 通过 Manifest 与 <code>setTheme()</code> 决定自己的外观。</p>
</li>
<li>
<p>实战中最关键的两点：</p>
<ul>
<li><strong>搞清楚当前手上的 Context 属于哪一类（Activity / Application / Service 等），能做什么、不能做什么。</strong></li>
<li><strong>长生命周期用 Application Context，短生命周期/UI 相关用 Activity Context，避免“误用 Context”导致的内存泄漏和 UI 问题。</strong></li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2-6-1 快速掌握Kotlin-语言的接口定义]]></title>    <link>https://juejin.cn/post/7586688485728403462</link>    <guid>https://juejin.cn/post/7586688485728403462</guid>    <pubDate>2025-12-23T07:35:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586688485728403462" data-draft-id="7586680977856397375" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2-6-1 快速掌握Kotlin-语言的接口定义"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T07:35:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="成都大菠萝"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2-6-1 快速掌握Kotlin-语言的接口定义
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    成都大菠萝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:35:32.000Z" title="Tue Dec 23 2025 07:35:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kotlin 接口定义</h2>
<p>Kotlin 接口是一种强大的抽象机制，它允许定义方法、属性、默认实现，并且支持多继承。以下是 Kotlin 接口的完整指南：</p>
<h3 data-id="heading-1">1. <strong>基本接口定义</strong></h3>
<h4 data-id="heading-2">简单接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Drawable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">draw</span><span class="hljs-params">()</span></span>  <span class="hljs-comment">// 抽象方法</span>
}

<span class="hljs-comment">// 实现接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> : <span class="hljs-type">Drawable</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">draw</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"绘制圆形"</span>)
    }
}
</code></pre>
<h4 data-id="heading-3">带属性的接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Shape</span> {
    <span class="hljs-keyword">val</span> name: String  <span class="hljs-comment">// 抽象属性</span>
    
    <span class="hljs-keyword">val</span> description: String
        <span class="hljs-keyword">get</span>() = <span class="hljs-string">"这是一个形状"</span>  <span class="hljs-comment">// 带 getter 的属性</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span> : <span class="hljs-type">Shape</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> name: String = <span class="hljs-string">"正方形"</span>
    
    <span class="hljs-comment">// 可以重写 description 属性</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> description: String
        <span class="hljs-keyword">get</span>() = <span class="hljs-string">"这是一个四边相等的形状"</span>
}
</code></pre>
<h3 data-id="heading-4">2. <strong>接口中的方法</strong></h3>
<h4 data-id="heading-5">抽象方法和默认实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Vehicle</span> {
    <span class="hljs-comment">// 抽象方法（必须被实现）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">start</span><span class="hljs-params">()</span></span>
    
    <span class="hljs-comment">// 带默认实现的方法（可选重写）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"车辆停止"</span>)
    }
    
    <span class="hljs-comment">// 也可以有具体实现的方法体</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">honk</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"嘟嘟！"</span>)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span> : <span class="hljs-type">Vehicle</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">start</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"汽车启动"</span>)
    }
    
    <span class="hljs-comment">// 可以选择重写 stop()，也可以使用默认实现</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"汽车紧急制动"</span>)
    }
    
    <span class="hljs-comment">// 不重写 honk()，使用接口中的默认实现</span>
}
</code></pre>
<h4 data-id="heading-6">私有方法（Kotlin 1.7+）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">DatabaseAccess</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">save</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span> {
        validate(<span class="hljs-keyword">data</span>)
        println(<span class="hljs-string">"保存数据: <span class="hljs-variable">$data</span>"</span>)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">validate</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span> {  <span class="hljs-comment">// 接口中的私有方法</span>
        require(<span class="hljs-keyword">data</span>.isNotBlank()) { <span class="hljs-string">"数据不能为空"</span> }
    }
}
</code></pre>
<h3 data-id="heading-7">3. <strong>接口中的属性</strong></h3>
<h4 data-id="heading-8">各种属性类型</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-comment">// 抽象属性（必须被实现）</span>
    <span class="hljs-keyword">val</span> username: String
    
    <span class="hljs-comment">// 带 getter 的属性</span>
    <span class="hljs-keyword">val</span> displayName: String
        <span class="hljs-keyword">get</span>() = username.uppercase()
    
    <span class="hljs-comment">// 可变属性</span>
    <span class="hljs-keyword">var</span> email: String
    
    <span class="hljs-comment">// 常量（使用伴生对象）</span>
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MIN_USERNAME_LENGTH = <span class="hljs-number">3</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RegularUser</span>(<span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> username: String) : User {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> email: String = <span class="hljs-string">""</span>
    
    <span class="hljs-comment">// 可以重写 displayName</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> displayName: String
        <span class="hljs-keyword">get</span>() = <span class="hljs-string">"用户: <span class="hljs-subst">${username.lowercase()}</span>"</span>
}
</code></pre>
<h3 data-id="heading-9">4. <strong>接口继承</strong></h3>
<h4 data-id="heading-10">接口继承接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Clickable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">click</span><span class="hljs-params">()</span></span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Focusable</span> : <span class="hljs-type">Clickable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">focus</span><span class="hljs-params">()</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showOff</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"我是可聚焦的!"</span>)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Button</span> : <span class="hljs-type">Focusable</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">click</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"按钮被点击"</span>)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">focus</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"按钮获得焦点"</span>)
    }
    
    <span class="hljs-comment">// 可以选择重写 showOff() 或不重写</span>
}
</code></pre>
<h4 data-id="heading-11">多接口继承</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">A</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"A.foo"</span>)
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">B</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"B.foo"</span>)
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bar</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"B.bar"</span>)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> : <span class="hljs-type">A</span>, <span class="hljs-type">B</span> {
    <span class="hljs-comment">// 必须重写 foo() 来解决冲突</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foo</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 调用特定父接口的实现</span>
        <span class="hljs-keyword">super</span>&lt;A&gt;.foo()
        <span class="hljs-keyword">super</span>&lt;B&gt;.foo()
        println(<span class="hljs-string">"C.foo"</span>)
    }
    
    <span class="hljs-comment">// 不需要重写 bar()，因为只有一个实现</span>
}
</code></pre>
<h3 data-id="heading-12">5. <strong>函数式接口（SAM接口）</strong></h3>
<h4 data-id="heading-13">单抽象方法接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 fun interface 声明（Kotlin 1.4+）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-keyword">interface</span> StringProcessor {</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">process</span><span class="hljs-params">(input: <span class="hljs-type">String</span>)</span></span>: String
}

<span class="hljs-comment">// 传统方式</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">OnClickListener</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span>
}

<span class="hljs-comment">// 使用 lambda 表达式实现</span>
<span class="hljs-keyword">val</span> processor = StringProcessor { it.uppercase() }
<span class="hljs-keyword">val</span> listener = OnClickListener { println(<span class="hljs-string">"点击了 <span class="hljs-variable">$it</span>"</span>) }

<span class="hljs-comment">// 在函数参数中使用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setOnClickListener</span><span class="hljs-params">(listener: <span class="hljs-type">OnClickListener</span>)</span></span> {
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 调用时可以传递 lambda</span>
setOnClickListener { view -&gt; println(<span class="hljs-string">"点击"</span>) }
</code></pre>
<h4 data-id="heading-14">Java 函数式接口互操作</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Java 中的函数式接口</span>
<span class="hljs-comment">// @FunctionalInterface</span>
<span class="hljs-comment">// public interface Runnable { void run(); }</span>

<span class="hljs-keyword">val</span> runnable = Runnable { println(<span class="hljs-string">"在后台运行"</span>) }
Thread(runnable).start()

<span class="hljs-comment">// 或者直接使用</span>
Thread { println(<span class="hljs-string">"简洁写法"</span>) }.start()
</code></pre>
<h3 data-id="heading-15">6. <strong>接口与抽象类的比较</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">AnimalInterface</span> {
    <span class="hljs-keyword">val</span> name: String
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeSound</span><span class="hljs-params">()</span></span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span> {  <span class="hljs-comment">// 可以有默认实现</span>
        println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 正在进食"</span>)
    }
}

<span class="hljs-comment">// 抽象类</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimalAbstract</span> {
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> name: String
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeSound</span><span class="hljs-params">()</span></span>
    
    <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span> {  <span class="hljs-comment">// 需要 open 关键字</span>
        println(<span class="hljs-string">"<span class="hljs-variable">$name</span> 正在进食"</span>)
    }
    
    <span class="hljs-comment">// 抽象类可以有状态</span>
    <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 可以有构造函数</span>
    <span class="hljs-keyword">constructor</span>(name: String)
}

<span class="hljs-comment">// 实现差异</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DogInterface</span> : <span class="hljs-type">AnimalInterface</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> name: String = <span class="hljs-string">"狗狗"</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeSound</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"汪汪！"</span>)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DogAbstract</span> : <span class="hljs-type">AnimalAbstract</span>(<span class="hljs-string">"狗狗"</span>) {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> name: String = <span class="hljs-string">"狗狗"</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeSound</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"汪汪！"</span>)
}
</code></pre>
<h3 data-id="heading-16">7. <strong>接口委托</strong></h3>
<h4 data-id="heading-17">使用 <code>by</code> 关键字委托实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Repository</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">save</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: String?
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseRepository</span> : <span class="hljs-type">Repository</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">save</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>)</span></span> {
        println(<span class="hljs-string">"保存到数据库: <span class="hljs-variable">$data</span>"</span>)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: String? {
        println(<span class="hljs-string">"从数据库加载: <span class="hljs-variable">$id</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">"数据"</span>
    }
}

<span class="hljs-comment">// 委托给 DatabaseRepository</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedRepository</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> repository: Repository) : Repository <span class="hljs-keyword">by</span> repository {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cache = mutableMapOf&lt;String, String&gt;()
    
    <span class="hljs-comment">// 只重写需要定制的方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: String? {
        <span class="hljs-keyword">return</span> cache[id] ?: repository.load(id)?.also {
            cache[id] = it
        }
    }
    
    <span class="hljs-comment">// 新增方法</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearCache</span><span class="hljs-params">()</span></span> {
        cache.clear()
    }
}
</code></pre>
<h4 data-id="heading-18">属性委托到接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Logger</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">log</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsoleLogger</span> : <span class="hljs-type">Logger</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">log</span><span class="hljs-params">(message: <span class="hljs-type">String</span>)</span></span> {
        println(<span class="hljs-string">"控制台日志: <span class="hljs-variable">$message</span>"</span>)
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Service</span>(logger: Logger) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> logger: Logger <span class="hljs-keyword">by</span> lazy { logger }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doWork</span><span class="hljs-params">()</span></span> {
        logger.log(<span class="hljs-string">"开始工作"</span>)
        <span class="hljs-comment">// 工作逻辑</span>
        logger.log(<span class="hljs-string">"工作完成"</span>)
    }
}
</code></pre>
<h3 data-id="heading-19">8. <strong>接口中的内联方法</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">JsonSerializable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toJson</span><span class="hljs-params">()</span></span>: String
    
    <span class="hljs-comment">// 内联方法</span>
    <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printJson</span><span class="hljs-params">()</span></span> {
        println(toJson())
    }
}

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>) : JsonSerializable {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toJson</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"""{"name": "<span class="hljs-variable">$name</span>", "age": <span class="hljs-variable">$age</span>}"""</span>
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> person = Person(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">30</span>)
person.printJson()  <span class="hljs-comment">// 内联展开</span>
</code></pre>
<h3 data-id="heading-20">9. <strong>接口中的扩展函数</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Sortable</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">compare</span><span class="hljs-params">(other: <span class="hljs-type">T</span>)</span></span>: <span class="hljs-built_in">Int</span>
}

<span class="hljs-comment">// 为接口定义扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Sortable&lt;T&gt;</span>&gt; List<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">sorted</span><span class="hljs-params">()</span></span>: List&lt;T&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sortedWith { a, b -&gt; a.compare(b) }
}

<span class="hljs-comment">// 为接口定义扩展属性</span>
<span class="hljs-keyword">val</span> Sortable&lt;*&gt;.hash: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">get</span>() = hashCode()

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span>(<span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> price: <span class="hljs-built_in">Double</span>) : Sortable&lt;Product&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">compare</span><span class="hljs-params">(other: <span class="hljs-type">Product</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> price.compareTo(other.price)
    }
}

<span class="hljs-keyword">val</span> products = listOf(
    Product(<span class="hljs-string">"A"</span>, <span class="hljs-number">100.0</span>),
    Product(<span class="hljs-string">"B"</span>, <span class="hljs-number">50.0</span>),
    Product(<span class="hljs-string">"C"</span>, <span class="hljs-number">75.0</span>)
)

<span class="hljs-keyword">val</span> sorted = products.sorted()  <span class="hljs-comment">// 使用扩展函数</span>
</code></pre>
<h3 data-id="heading-21">10. <strong>接口的实用模式</strong></h3>
<h4 data-id="heading-22">标记接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 标记接口（没有任何方法）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Serializable</span>

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Document</span>(<span class="hljs-keyword">val</span> content: String) : Serializable

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">saveIfSerializable</span><span class="hljs-params">(obj: <span class="hljs-type">Any</span>)</span></span> {
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> Serializable) {
        println(<span class="hljs-string">"保存对象: <span class="hljs-variable">$obj</span>"</span>)
    }
}
</code></pre>
<h4 data-id="heading-23">构建器模式接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Builder</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: T
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CarBuilder</span> : <span class="hljs-type">Builder</span>&lt;<span class="hljs-type">Car</span>&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> color = <span class="hljs-string">"红色"</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> wheels = <span class="hljs-number">4</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setColor</span><span class="hljs-params">(color: <span class="hljs-type">String</span>)</span></span> = apply { <span class="hljs-keyword">this</span>.color = color }
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setWheels</span><span class="hljs-params">(wheels: <span class="hljs-type">Int</span>)</span></span> = apply { <span class="hljs-keyword">this</span>.wheels = wheels }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">build</span><span class="hljs-params">()</span></span>: Car {
        <span class="hljs-keyword">return</span> Car(color, wheels)
    }
}

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span>(<span class="hljs-keyword">val</span> color: String, <span class="hljs-keyword">val</span> wheels: <span class="hljs-built_in">Int</span>)

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> car = CarBuilder()
    .setColor(<span class="hljs-string">"蓝色"</span>)
    .setWheels(<span class="hljs-number">4</span>)
    .build()
</code></pre>
<h4 data-id="heading-24">策略模式接口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentStrategy</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">pay</span><span class="hljs-params">(amount: <span class="hljs-type">Double</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CreditCardPayment</span> : <span class="hljs-type">PaymentStrategy</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">pay</span><span class="hljs-params">(amount: <span class="hljs-type">Double</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        println(<span class="hljs-string">"信用卡支付: $<span class="hljs-variable">$amount</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PayPalPayment</span> : <span class="hljs-type">PaymentStrategy</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">pay</span><span class="hljs-params">(amount: <span class="hljs-type">Double</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        println(<span class="hljs-string">"PayPal支付: $<span class="hljs-variable">$amount</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ShoppingCart</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> paymentStrategy: PaymentStrategy) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkout</span><span class="hljs-params">(amount: <span class="hljs-type">Double</span>)</span></span> {
        paymentStrategy.pay(amount)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">changeStrategy</span><span class="hljs-params">(strategy: <span class="hljs-type">PaymentStrategy</span>)</span></span> {
        paymentStrategy = strategy
    }
}
</code></pre>
<h3 data-id="heading-25">11. <strong>接口的协变和逆变</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 协变接口（out 关键字）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Producer</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span></span>: T
}

<span class="hljs-comment">// 逆变接口（in 关键字）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Consumer</span>&lt;<span class="hljs-type">in T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">consume</span><span class="hljs-params">(item: <span class="hljs-type">T</span>)</span></span>
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FruitProducer</span> : <span class="hljs-type">Producer</span>&lt;<span class="hljs-type">Fruit</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span></span>: Fruit = Fruit()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppleProducer</span> : <span class="hljs-type">Producer</span>&lt;<span class="hljs-type">Apple</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">produce</span><span class="hljs-params">()</span></span>: Apple = Apple()
}

<span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Fruit</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Apple</span> : <span class="hljs-type">Fruit</span>()

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">useProducer</span><span class="hljs-params">(producer: <span class="hljs-type">Producer</span>&lt;<span class="hljs-type">Fruit</span>&gt;)</span></span> {
    <span class="hljs-keyword">val</span> fruit: Fruit = producer.produce()
}

<span class="hljs-comment">// 协变允许 Producer&lt;Apple&gt; 赋值给 Producer&lt;Fruit&gt;</span>
<span class="hljs-keyword">val</span> fruitProducer: Producer&lt;Fruit&gt; = AppleProducer()
</code></pre>
<h3 data-id="heading-26">12. <strong>接口的最佳实践</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 单一职责原则</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Savable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">save</span><span class="hljs-params">()</span></span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Loadable</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">()</span></span>
}

<span class="hljs-comment">// 2. 接口隔离原则（不要强迫客户端依赖它们不用的方法）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Printer</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Scanner</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">scan</span><span class="hljs-params">()</span></span>
}

<span class="hljs-comment">// 3. 使用默认实现减少样板代码</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Repository</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">save</span><span class="hljs-params">(item: <span class="hljs-type">T</span>)</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findById</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: T?
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findAll</span><span class="hljs-params">()</span></span>: List&lt;T&gt;
    
    <span class="hljs-comment">// 默认实现</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">existsById</span><span class="hljs-params">(id: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> findById(id) != <span class="hljs-literal">null</span>
    }
}

<span class="hljs-comment">// 4. 使用函数式接口简化回调</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-keyword">interface</span> OnSuccess<span class="hljs-type">&lt;T&gt;</span> {</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSuccess</span><span class="hljs-params">(result: <span class="hljs-type">T</span>)</span></span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">doAsync</span><span class="hljs-params">(
    operation: () -&gt; <span class="hljs-type">T</span>,
    onSuccess: <span class="hljs-type">OnSuccess</span>&lt;<span class="hljs-type">T</span>&gt;
)</span></span> {
    <span class="hljs-keyword">val</span> result = operation()
    onSuccess.onSuccess(result)
}

<span class="hljs-comment">// 使用</span>
doAsync(
    operation = { <span class="hljs-string">"结果"</span> },
    onSuccess = { println(<span class="hljs-string">"成功: <span class="hljs-variable">$it</span>"</span>) }
)
</code></pre>
<h3 data-id="heading-27">总结</h3>
<p>Kotlin 接口提供了比 Java 接口更强大的功能：</p>
<ul>
<li><strong>默认方法实现</strong>：减少实现类的样板代码</li>
<li><strong>属性支持</strong>：可以定义抽象属性和带 getter/setter 的属性</li>
<li><strong>多继承</strong>：一个类可以实现多个接口</li>
<li><strong>函数式接口</strong>：支持 SAM 转换，简化回调</li>
<li><strong>私有方法</strong>：Kotlin 1.7+ 支持接口中的私有方法</li>
<li><strong>委托模式</strong>：使用 <code>by</code> 关键字委托接口实现</li>
</ul>
<p>接口在 Kotlin 中是实现抽象、多态和解耦代码的重要工具。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始学LangChain（二）：LangChain的核心组件 - Agents]]></title>    <link>https://juejin.cn/post/7586610067568394240</link>    <guid>https://juejin.cn/post/7586610067568394240</guid>    <pubDate>2025-12-23T06:47:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586610067568394240" data-draft-id="7586587644824256546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始学LangChain（二）：LangChain的核心组件 - Agents"/> <meta itemprop="keywords" content="人工智能,Python"/> <meta itemprop="datePublished" content="2025-12-23T06:47:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="锐学AI"/> <meta itemprop="url" content="https://juejin.cn/user/1165926981220583"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始学LangChain（二）：LangChain的核心组件 - Agents
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1165926981220583/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    锐学AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:47:37.000Z" title="Tue Dec 23 2025 06:47:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>欢迎加入我的【ima知识库】<a href="https://link.juejin.cn?target=https%3A%2F%2Fima.qq.com%2Fwiki%2F%3FshareId%3D4a37197cd81c4a33a2eac74f1e3c2931013b3a28f8ebba113ea59e454af9f803" target="_blank" title="https://ima.qq.com/wiki/?shareId=4a37197cd81c4a33a2eac74f1e3c2931013b3a28f8ebba113ea59e454af9f803" ref="nofollow noopener noreferrer">从零开始学LangChain</a>，第一时间收到更新！</p>
</blockquote>
<p>Agents将大模型与工具结合起来，创建能够进行任务推理、决定使用哪种工具并迭代解决方案的系统。</p>
<p><code>create_agent</code> 提供了一种适用于生产的Agent的实现方式。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsimonwillison.net%2F2025%2FSep%2F18%2Fagents%2F" target="_blank" title="https://simonwillison.net/2025/Sep/18/agents/" ref="nofollow noopener noreferrer">在模型发出最终输出或达到迭代限制前，Agent会一直运行。</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a10d82efdb54b9383e8ee1214f25644~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZSQ5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767077257&amp;x-signature=dlqlbaUh3SUby9pNLZCAZdmi6A0%3D" alt="1765537636588.png" loading="lazy"/></p>
<h2 data-id="heading-0">Core components（核心组件）</h2>
<h3 data-id="heading-1">Model（模型）</h3>
<p>模型是Agent的推理引擎。可以通过多种方式指定，支持静态和动态模型选择。</p>
<h4 data-id="heading-2">Static model（静态模型）</h4>
<p>静态模型在创建代理时配置一次，并在整个执行过程中保持不变。这是最常见和最直接的方法。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent

agent = create_agent(
    <span class="hljs-string">"gpt-5"</span>,
    tools=tools
)
</code></pre>
<blockquote>
<p>模型标识符字符串支持自动推理（例如，“gpt-5”将被推断为“openai:gpt-5”）。<a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fmodels%2F%23langchain.chat_models.init_chat_model(model)" target="_blank" title="https://reference.langchain.com/python/langchain/models/#langchain.chat_models.init_chat_model(model)" ref="nofollow noopener noreferrer">参考</a>查看模型标识符字符串映射的完整列表。</p>
</blockquote>
<p>要对模型配置进行更多的控制，请使用供应商提供的工具包进行初始化模型实例。本次以 <code>ChatDeepSeek</code> 为例进行演示。其他可用的聊天模型，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Fintegrations%2Fchat" target="_blank" title="https://docs.langchain.com/oss/python/integrations/chat" ref="nofollow noopener noreferrer">聊天模型</a>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

model = ChatDeepSeek(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    api_base=<span class="hljs-string">"https://api.deepseek.com/v1"</span>,
    temperature=<span class="hljs-number">0.1</span>,
    max_tokens=<span class="hljs-number">1000</span>,
    timeout=<span class="hljs-number">30</span>
    <span class="hljs-comment"># ... (other params)</span>
)
agent = create_agent(model)
</code></pre>
<blockquote>
<p>在使用ChatDeepSeek时，需使用api_base参数（而非api_url）</p>
</blockquote>
<p>模型实例使你能够完全控制配置。当你需要设置特定的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmodels%23parameters" target="_blank" title="https://docs.langchain.com/oss/python/langchain/models#parameters" ref="nofollow noopener noreferrer">参数</a>时，比如 <code>temperature</code>，<code>max_tokens</code>，<code>timeouts</code>，<code>base_url</code> 和其他特定于提供程序的设置。请<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Fintegrations%2Fproviders%2Fall_providers" target="_blank" title="https://docs.langchain.com/oss/python/integrations/providers/all_providers" ref="nofollow noopener noreferrer">参考</a>查看模型上可用的参数和方法。</p>
<h4 data-id="heading-3">Dynamic model（动态模型）</h4>
<p>动态模型是在运行时根据当前状态和上下文选择的。这样能够适配复杂的路由逻辑，还能优化成本。</p>
<p>要使用动态模型，请使用 <code>@wrap_model_call</code> 装饰器，在发起请求的过程中修改模型参数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> wrap_model_call, ModelRequest, ModelResponse
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

basic_model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>)
advanced_model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-reasoner"</span>)

<span class="hljs-meta">@wrap_model_call</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">dynamic_model_selection</span>(<span class="hljs-params">request: ModelRequest, handler</span>) -&gt; ModelResponse:
    <span class="hljs-string">"""根据对话的复杂度选择模型"""</span>
    message_count = <span class="hljs-built_in">len</span>(request.state[<span class="hljs-string">"messages"</span>])

    <span class="hljs-keyword">if</span> message_count &gt; <span class="hljs-number">5</span>:
        <span class="hljs-comment"># 在长对话的时候使用高级模型</span>
        model = advanced_model
    <span class="hljs-keyword">else</span>:
        model = basic_model

    <span class="hljs-keyword">return</span> handler(request.override(model=model))

agent = create_agent(
    model=basic_model,  <span class="hljs-comment"># 默认使用基础模型</span>
    middleware=[dynamic_model_selection]
)
result1 = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你叫什么名字？"</span>}]
})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅: <span class="hljs-subst">{result1[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
result2 = agent.invoke({
    <span class="hljs-string">"messages"</span>: [
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n1+1等于多少？"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n1+2等于多少？"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n1+3等于多少？"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n1+4等于多少？"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n1+5等于多少？"</span>},
        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"\n1+6等于多少？"</span>}
    ]
})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅: <span class="hljs-subst">{result2[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
</code></pre>
<blockquote>
<p>⚠️ 使用结构化输出时不支持预绑定模型(通过<a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain_core%2Flanguage_models%2F%23langchain_core.language_models.chat_models.BaseChatModel.bind_tools" target="_blank" title="https://reference.langchain.com/python/langchain_core/language_models/#langchain_core.language_models.chat_models.BaseChatModel.bind_tools" ref="nofollow noopener noreferrer">bind_tools</a>进行绑定的模型)。如果您需要具有结构化输出的动态模型选择，请确保传递给中间件的模型没有预绑定。</p>
</blockquote>
<blockquote>
<p>💡 更多模型配置的详细信息，参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmodels" target="_blank" title="https://docs.langchain.com/oss/python/langchain/models" ref="nofollow noopener noreferrer">Models</a>。关于动态模型选择，参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmiddleware%2Foverview%23dynamic-model" target="_blank" title="https://docs.langchain.com/oss/python/langchain/middleware/overview#dynamic-model" ref="nofollow noopener noreferrer">Dynamic model in middleware</a>，。</p>
</blockquote>
<h3 data-id="heading-4">Tools（工具）</h3>
<p>工具赋予agents采取行动的能力。agents通过以下方式超越了简单的纯模型工具绑定：</p>
<ul>
<li>有次序地调用多个工具（通过prompt触发）</li>
<li>在适当的时候异步调用工具</li>
<li>基于之前的结果的进行动态工具选择</li>
<li>加入工具调用的重试逻辑和异常处理</li>
<li>在跨工具调用时保持Agent状态的持久性</li>
</ul>
<p>想要了解更多关于工具的信息，请查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Ftools" target="_blank" title="https://docs.langchain.com/oss/python/langchain/tools" ref="nofollow noopener noreferrer">工具</a></p>
<h4 data-id="heading-5">Defining Tools（定义工具）</h4>
<p>将工具列表传递给Agent。</p>
<blockquote>
<p>💡 工具可以被指定为普通的Python函数或协程。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Ftools%23create-tools" target="_blank" title="https://docs.langchain.com/oss/python/langchain/tools#create-tools" ref="nofollow noopener noreferrer">tool decorator</a>可用来自定义工具名称、描述、参数模型和其他属性。</p>
</blockquote>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>)

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""查询信息"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Results for: <span class="hljs-subst">{query}</span>"</span>

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">location: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""根据地点查询天气"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{location}</span>天气: 晴, 25℃"</span>

agent = create_agent(model, tools=[search, get_weather])
result = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"武汉的天气怎么样？"</span>}]
})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅: <span class="hljs-subst">{result[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
</code></pre>
<p>如果提供了一个空的工具列表，代理将由一个没有工具调用能力的LLM节点组成。</p>
<h4 data-id="heading-6">Tool error handling（工具的异常处理）</h4>
<p>如果要自定义工具的异常处理，请使用<a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fmiddleware%2F%23langchain.agents.middleware.wrap_tool_call" target="_blank" title="https://reference.langchain.com/python/langchain/middleware/#langchain.agents.middleware.wrap_tool_call" ref="nofollow noopener noreferrer">@wrap_tool_call</a>装饰器来创建中间件：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> wrap_tool_call
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> ToolMessage
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>, max_retries=<span class="hljs-number">0</span>)

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">query_airindex</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""计算空气指数"""</span>
    pm25 = <span class="hljs-number">1000</span>
    airindex = pm25 / <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> airindex

<span class="hljs-meta">@wrap_tool_call</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_tool_errors</span>(<span class="hljs-params">request, handler</span>):
    <span class="hljs-string">"""自定义工具执行过程中的异常消息"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">return</span> handler(request)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">return</span> ToolMessage(
            content=<span class="hljs-string">f"Tool error: 请检查输入并重试。 (<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>)"</span>,
            tool_call_id=request.tool_call[<span class="hljs-string">"id"</span>]
        )

agent = create_agent(
    model=model,
    tools = [query_airindex],
    middleware=[handle_tool_errors]
)
result = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"查询一下武汉的空气指数"</span>}]
})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅: <span class="hljs-subst">{result[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">2</span>].content}</span>"</span>)
</code></pre>
<p>当工具执行失败时，Agent将返回带有自定义异常消息的<a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fmessages%2F%23langchain.messages.ToolMessage" target="_blank" title="https://reference.langchain.com/python/langchain/messages/#langchain.messages.ToolMessage" ref="nofollow noopener noreferrer">ToolMessage</a>：</p>
<pre><code class="hljs language-python" lang="python">[
    ...
    ToolMessage(
        content=<span class="hljs-string">"Tool error: 请检查输入并重试。 (division by zero)"</span>,
        tool_call_id=<span class="hljs-string">"..."</span>
    ),
    ...
]
</code></pre>
<h4 data-id="heading-7">Tool use in the ReAct loop</h4>
<p>Agent遵循ReAct（“ Reasoning（推理）+ Acting（执行）”）规则，在简短的推理步骤与目标工具调用之间交替进行，并将结果观察结果提供给后续决策，直到它们能够提供最终答案。</p>
<h5 data-id="heading-8">ReaAct loop示例：</h5>
<p><strong>Prompt：</strong> 找到当前最流行的无线耳机并验证可用性。</p>
<pre><code class="hljs language-ini" lang="ini">================================ Human <span class="hljs-attr">Message</span> =================================

找到现在最流行的无线耳机，看看是否有货
</code></pre>
<ul>
<li><strong>Reasoning（推理）：</strong>“流行度是时间敏感的，我需要使用已经提供的搜索工具。”</li>
<li><strong>Acting（执行）：</strong> 调用 <code>search_products("无线耳机")</code></li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">==================================</span> <span class="hljs-string">Ai</span> <span class="hljs-string">Message</span> <span class="hljs-string">==================================</span>
<span class="hljs-attr">Tool Calls:</span>
  <span class="hljs-string">search_products</span> <span class="hljs-string">(call_abc123)</span>
 <span class="hljs-attr">Call ID:</span> <span class="hljs-string">call_abc123</span>
  <span class="hljs-attr">Args:</span>
    <span class="hljs-attr">query:</span> <span class="hljs-string">wireless</span> <span class="hljs-string">headphones</span>
</code></pre>

<pre><code class="hljs language-ini" lang="ini">================================= Tool <span class="hljs-attr">Message</span> =================================

Found 5 products matching "wireless headphones". Top 5 results: WH-1000XM5, ...
</code></pre>
<p>后面还会继续重复上述Reasoning和Acting步骤，直到Agent得到最终答案（这里不继续演示）。</p>
<blockquote>
<p>💡 更多关于工具信息，请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Ftools" target="_blank" title="https://docs.langchain.com/oss/python/langchain/tools" ref="nofollow noopener noreferrer">Tools</a></p>
</blockquote>
<h3 data-id="heading-9">System prompt（系统提示词）</h3>
<p>你可以通过提供提示词来塑造Agent处理任务的方式。系统提示词通常是以字符串的形式提供：</p>
<pre><code class="hljs language-python" lang="python">agent = create_agent(
    model,
    tools,
    system_prompt=<span class="hljs-string">"你是一个有用的助手。回答要简洁准确。"</span>
)
</code></pre>
<p>如果没有提供系统提示词，Agent将直接从消息中推断其任务。</p>
<p>系统提示词参数可以是 <code>str</code> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fmessages%2F%23langchain.messages.SystemMessage" target="_blank" title="https://reference.langchain.com/python/langchain/messages/#langchain.messages.SystemMessage" ref="nofollow noopener noreferrer"><code>SystemMessage</code></a>。使用 <code>SystemMessage</code> 可以让你更好地控制提示词的结构，这对于特定大模型供应商的功能很有用，比如Anthropic的提示词缓存：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> SystemMessage, HumanMessage

literary_agent = create_agent(
    model=<span class="hljs-string">"anthropic:claude-sonnet-4-5"</span>,
    system_prompt=SystemMessage(
        content=[
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">"You are an AI assistant tasked with analyzing literary works."</span>,
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">"&lt;the entire contents of 'Pride and Prejudice'&gt;"</span>,
                <span class="hljs-string">"cache_control"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"ephemeral"</span>}
            }
        ]
    )
)

result = literary_agent.invoke(
    {<span class="hljs-string">"messages"</span>: [HumanMessage(<span class="hljs-string">"Analyze the major themes in 'Pride and Prejudice'."</span>)]}
)
</code></pre>
<p><code>cache_control</code> 字段的 <code>{"type": "ephemeral"}</code> 告诉Anthropic缓存内容块，减少重复使用相同系统提示词的请求的延迟和成本。</p>
<h4 data-id="heading-10">Dynamic system prompt（动态系统提示词）</h4>
<p>对于需要根据运行时上下文或Agent状态修改系统提示词这种更高级的用法，可以使用middleware（中间件）。</p>
<p>通过 <code>@dynamic_prompt</code> 装饰器创建中间件，实现根据模型请求生成系统提示词：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict

<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> dynamic_prompt, ModelRequest

<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    user_role: <span class="hljs-built_in">str</span>

<span class="hljs-meta">@dynamic_prompt</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">user_role_prompt</span>(<span class="hljs-params">request: ModelRequest</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""根据用户角色来生成系统提示词"""</span>
    user_role = request.runtime.context.get(<span class="hljs-string">"user_role"</span>, <span class="hljs-string">"user"</span>)
    base_prompt = <span class="hljs-string">"你是一个有用的助手。"</span>

    <span class="hljs-keyword">if</span> user_role == <span class="hljs-string">"专家"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{base_prompt}</span> 给出详细的专业解释。"</span>
    <span class="hljs-keyword">elif</span> user_role == <span class="hljs-string">"小白"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{base_prompt}</span> 简单地解释概念，避免术语。"</span>

    <span class="hljs-keyword">return</span> base_prompt

model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>)

agent = create_agent(
    model=model,
    middleware=[user_role_prompt],
    context_schema=Context
)

<span class="hljs-comment"># 系统提示词会根据上下文动态产生</span>
result1 = agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"解释一下机器学习"</span>}]},
    context={<span class="hljs-string">"user_role"</span>: <span class="hljs-string">"专家"</span>}
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 专家: <span class="hljs-subst">{result1[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
result2 = agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"解释一下机器学习"</span>}]},
    context={<span class="hljs-string">"user_role"</span>: <span class="hljs-string">"小白"</span>}
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 小白: <span class="hljs-subst">{result2[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
</code></pre>
<h2 data-id="heading-11">Invocation（调用）</h2>
<p>您可以通过更新Agent的 <code>State</code> 状态来调用它。所有agents在其状态中都包含一个 <code>sequence of messages</code> （消息序列），发送一条消息来调用Agent：</p>
<pre><code class="hljs language-python" lang="python">result = agent.invoke(
    {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"武汉的天气怎么样？"</span>}]}
)
</code></pre>
<p>有关Agent的streaming steps或tokens，请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fagents%2Fstreaming" target="_blank" title="https://docs.langchain.com/oss/python/langchain/agents/streaming" ref="nofollow noopener noreferrer">streaming</a></p>
<p>另外，Agent遵循LangGraph <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flanggraph%2Fuse-graph-api" target="_blank" title="https://docs.langchain.com/oss/python/langgraph/use-graph-api" ref="nofollow noopener noreferrer">Graph API</a>，并支持所有相关的方法，如 <code>stream</code> 和 <code>invoke</code> 。</p>
<h2 data-id="heading-12">Advanced concepts（高级概念）</h2>
<h3 data-id="heading-13">Structured output（结构化输出）</h3>
<p>在某些情况下，你可能希望Agent以特定格式返回输出。LangChain通过 <code>response_format</code> （响应格式）提供了结构化输出的策略。</p>
<h4 data-id="heading-14">ToolStrategy（工具策略）</h4>
<p><code>ToolStrategy</code> 使用人为调用工具来生成结构化的输出。这适用于任何支持工具调用的模型：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.agents.structured_output <span class="hljs-keyword">import</span> ToolStrategy
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

<span class="hljs-comment"># 结构化输出模型（必须定义）：</span>
<span class="hljs-comment"># 方法1：Pydantic BaseModel - 官方推荐</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContactInfo</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span>
    email: <span class="hljs-built_in">str</span>
    phone: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># 方法2：dataclass - 极致性能，简单场景</span>
<span class="hljs-comment"># from dataclasses import dataclass</span>
<span class="hljs-comment"># @dataclass</span>
<span class="hljs-comment"># class ContactInfo:</span>
<span class="hljs-comment">#     name: str</span>
<span class="hljs-comment">#     email: str</span>
<span class="hljs-comment">#     phone: str | None = None</span>

<span class="hljs-comment"># 方法3：TypedDict - 纯字典场景，无验证需求</span>
<span class="hljs-comment"># from typing import TypedDict, NotRequired</span>
<span class="hljs-comment"># class ContactInfo(TypedDict):</span>
<span class="hljs-comment">#     name: str</span>
<span class="hljs-comment">#     email: str</span>
<span class="hljs-comment">#     phone: NotRequired[str]</span>

model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>)

agent = create_agent(
    model=model,
    response_format=ToolStrategy(ContactInfo)
)

result = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"提取联系人信息: John Doe, john@example.com, (555) 123-4567"</span>}]
})

<span class="hljs-built_in">print</span>(result[<span class="hljs-string">"structured_response"</span>])
<span class="hljs-comment"># ContactInfo(name='John Doe', email='john@example.com', phone='(555) 123-4567')</span>
</code></pre>
<h4 data-id="heading-15">ProviderStrategy（供应商策略）</h4>
<p><code>ProviderStrategy</code> 使用模型供应商提供的native（原生）结构化输出。这更可靠，但只适用于支持原生结构化输出的供应商（例如：OpenAI，<strong>DeepSeek等国内大模型暂时不支持ProviderStrategy</strong>）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.agents.structured_output <span class="hljs-keyword">import</span> ProviderStrategy
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

<span class="hljs-comment"># 结构化输出模型（必须定义）：</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContactInfo</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span>
    email: <span class="hljs-built_in">str</span>
    phone: <span class="hljs-built_in">str</span>

model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>)

<span class="hljs-keyword">try</span>:
    agent = create_agent(
        model=model,
        response_format=ProviderStrategy(ContactInfo)
    )
    result = agent.invoke({
        <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"提取联系人信息: John Doe, john@example.com, (555) 123-4567"</span>}]
    })
    <span class="hljs-built_in">print</span>(result[<span class="hljs-string">"structured_response"</span>])
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   ❌ ProviderStrategy 失败: <span class="hljs-subst">{<span class="hljs-built_in">type</span>(e).__name__}</span>: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">100</span>]}</span>..."</span>)
<span class="hljs-comment"># ❌ ProviderStrategy 失败: BadRequestError: Error code: 400</span>
</code></pre>
<blockquote>
<p>🚨 从 <code>langchain 1.0</code> 开始，必须显式地使用 <code>ToolStrategy</code> 或 <code>ProviderStrategy</code> 。</p>
</blockquote>
<h3 data-id="heading-16">Memory</h3>
<p>Agents通过消息state（状态）自动维护会话历史。还可以对agent进行配置，使用自定义状态模型，以便在会话期间记住额外的信息。</p>
<p>存储在状态中的信息可以看作是agent的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fshort-term-memory" target="_blank" title="https://docs.langchain.com/oss/python/langchain/short-term-memory" ref="nofollow noopener noreferrer"><code>short-term memory</code></a> 短期记忆：</p>
<p>自定义state（状态）模型必须将 <a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fagents%2F%23langchain.agents.AgentState" target="_blank" title="https://reference.langchain.com/python/langchain/agents/#langchain.agents.AgentState" ref="nofollow noopener noreferrer"><code>AgentState</code></a> 扩展为 <code>TypedDict</code>。</p>
<p>自定义state（状态）的方式有两种：</p>
<ol>
<li>通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmiddleware" target="_blank" title="https://docs.langchain.com/oss/python/langchain/middleware" ref="nofollow noopener noreferrer"><code>middleware</code></a> （首选）</li>
<li>通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fmiddleware%2F%23langchain.agents.middleware.AgentMiddleware.state_schema" target="_blank" title="https://reference.langchain.com/python/langchain/middleware/#langchain.agents.middleware.AgentMiddleware.state_schema" ref="nofollow noopener noreferrer"><code>state_schema</code></a> on <a href="https://link.juejin.cn?target=https%3A%2F%2Freference.langchain.com%2Fpython%2Flangchain%2Fagents%2F%23langchain.agents.create_agent" target="_blank" title="https://reference.langchain.com/python/langchain/agents/#langchain.agents.create_agent" ref="nofollow noopener noreferrer"><code>create_agent</code></a></li>
</ol>
<h4 data-id="heading-17">Defining state via middleware（通过中间件定义状态）</h4>
<p>当你的自定义state（状态）需要被特定的中间件hooks（钩子）和附加到该中间件上的tools（工具）访问时，使用中间件来定义自定义state（状态）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentState
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> AgentMiddleware
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> langchain_deepseek <span class="hljs-keyword">import</span> ChatDeepSeek
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

model = ChatDeepSeek(model=<span class="hljs-string">"deepseek-chat"</span>)

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定城市的天气信息"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{city}</span> 当前天气：晴天，25°C"</span>
  
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomState</span>(<span class="hljs-title class_ inherited__">AgentState</span>):
    <span class="hljs-string">"""支持用户偏好的自定义状态"""</span>
    user_preferences: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomMiddleware</span>(<span class="hljs-title class_ inherited__">AgentMiddleware</span>):
    <span class="hljs-string">"""根据用户偏好动态调整提示词和工具访问的自定义中间件"""</span>
    state_schema = CustomState

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">before_model</span>(<span class="hljs-params">self, state: CustomState, runtime</span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"============= before_model =================="</span>)
        <span class="hljs-built_in">print</span>(state.get(<span class="hljs-string">"user_preferences"</span>))
        
agent = create_agent(
    model=model,
    tools=[get_weather],
    middleware=[CustomMiddleware()]
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"======== 🤖 开始调用... =================="</span>)
result = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"武汉的天气怎么样，有哪些地方值得游玩？"</span>}],
    <span class="hljs-string">"user_preferences"</span>: {<span class="hljs-string">"style"</span>: <span class="hljs-string">"technical"</span>, <span class="hljs-string">"verbosity"</span>: <span class="hljs-string">"detailed"</span>},
})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 回答: <span class="hljs-subst">{result[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
</code></pre>
<h4 data-id="heading-18">Defining state via <code>state_schema</code> （通过 <code>state_schema</code> 定义状态）</h4>
<p>使用 <code>state_schema</code> 这个参数作为定义状态的快捷键，这种方式<strong>只有</strong>在使用的tools（工具）的时候才能使用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentState
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定城市的天气信息"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{city}</span> 当前天气：晴天，25°C"</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomState</span>(<span class="hljs-title class_ inherited__">AgentState</span>):
    user_preferences: <span class="hljs-built_in">dict</span>

agent = create_agent(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    tools=[get_weather],
    state_schema=CustomState
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"======== 🤖 开始调用... =================="</span>)
result = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"武汉的天气怎么样，有哪些地方值得游玩？"</span>}],
    <span class="hljs-string">"user_preferences"</span>: {<span class="hljs-string">"style"</span>: <span class="hljs-string">"technical"</span>, <span class="hljs-string">"verbosity"</span>: <span class="hljs-string">"detailed"</span>},
})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 回答: <span class="hljs-subst">{result[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content}</span>"</span>)
</code></pre>
<blockquote>
<p>⚠️ 从 <code>langchain 1.0</code> 开始，自定义状态模式模型是 <code>TypedDict</code> 类型。不再支持Pydantic models和dataclasses。详情请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Fmigrate%2Flangchain-v1%23state-type-restrictions" target="_blank" title="https://docs.langchain.com/oss/python/migrate/langchain-v1#state-type-restrictions" ref="nofollow noopener noreferrer">v1 migration guide</a></p>
</blockquote>
<blockquote>
<p>⚠️ 定义自定义state（状态），使用 <code>middleware</code> 优于 <code>state_schema</code> ，这让你在概念上将状态扩展限定在相关中间件和工具的范围内。</p>
<p><code>state_schema</code> 在 <code>create_agent</code> 时仍然向后兼容。</p>
</blockquote>
<blockquote>
<p>💡 更多关于memory的信息，参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Fconcepts%2Fmemory" target="_blank" title="https://docs.langchain.com/oss/python/concepts/memory" ref="nofollow noopener noreferrer">Memory</a> 。关于实现跨会话long-term memory的信息，参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Flong-term-memory" target="_blank" title="https://docs.langchain.com/oss/python/langchain/long-term-memory" ref="nofollow noopener noreferrer">Long-term memory</a> 。</p>
</blockquote>
<h3 data-id="heading-19">Streaming（流）</h3>
<p>我们已经看到了如何使用 <code>invoke</code> 调用Agent得到最终响应。如果Agent执行多个步骤，这可能需要一段时间。为了显示中间进程，我们可以在消息生成时将其流化。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

load_dotenv()

<span class="hljs-meta">@tool</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定城市的天气信息"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{city}</span> 当前天气：晴天，25°C"</span>

agent = create_agent(model=<span class="hljs-string">"deepseek-chat"</span>, tools=[get_weather])
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> agent.stream({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"武汉的天气怎么样，给我一个穿衣建议"</span>}]
}, stream_mode=<span class="hljs-string">"values"</span>):
    <span class="hljs-comment"># Each chunk contains the full state at that point</span>
    latest_message = chunk[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> latest_message.content:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Agent: <span class="hljs-subst">{latest_message.content}</span>"</span>)
    <span class="hljs-keyword">elif</span> latest_message.tool_calls:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Calling tools: <span class="hljs-subst">{[tc[<span class="hljs-string">'name'</span>] <span class="hljs-keyword">for</span> tc <span class="hljs-keyword">in</span> latest_message.tool_calls]}</span>"</span>)
</code></pre>
<blockquote>
<p>💡 更多关于streaming的细节，参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fstreaming" target="_blank" title="https://docs.langchain.com/oss/python/langchain/streaming" ref="nofollow noopener noreferrer">Streaming</a>。</p>
</blockquote>
<h3 data-id="heading-20">Middleware（中间件）</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmiddleware" target="_blank" title="https://docs.langchain.com/oss/python/langchain/middleware" ref="nofollow noopener noreferrer">Middleware</a> 中间件为在不同的执行阶段定制Agent的行为提供了强大的扩展能力。你可以这样使用中间件：</p>
<ul>
<li>调用模型之前的处理Agent的状态。（例如：message trimming,context injection）</li>
<li>修改或验证模型的响应（例如：guardrails，content filtering）</li>
<li>使用自定义逻辑处理工具执行产生的异常</li>
<li>实现基于状态或上下文的动态模型选择</li>
<li>添加自定义日志、监控或分析</li>
</ul>
<p>中间件无缝地集成到Agent的执行中，你可以在关键节点拦截和修改数据流，而无需更改核心Agent逻辑。</p>
<blockquote>
<p>💡 关于中间件的完整文档（包括 <code>@before_model</code> , <code>@after_model</code> , <code>@wrap_tool_call</code>），请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Fmiddleware" target="_blank" title="https://docs.langchain.com/oss/python/langchain/middleware" ref="nofollow noopener noreferrer">Middleware</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重读经典：Karpathy 的《循环神经网络不可思议的有效性》与代码实战]]></title>    <link>https://juejin.cn/post/7586675587148578852</link>    <guid>https://juejin.cn/post/7586675587148578852</guid>    <pubDate>2025-12-23T07:09:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586675587148578852" data-draft-id="7586680977855987775" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重读经典：Karpathy 的《循环神经网络不可思议的有效性》与代码实战"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T07:09:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拖拖765"/> <meta itemprop="url" content="https://juejin.cn/user/3727811066212480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重读经典：Karpathy 的《循环神经网络不可思议的有效性》与代码实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3727811066212480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拖拖765
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:09:02.000Z" title="Tue Dec 23 2025 07:09:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 GPT-4 和各种大模型横行的今天，我们很容易忘记深度学习领域的“史前时代”。但在 2015 年，Andrej Karpathy（OpenAI 创始成员、前 Tesla AI 总监）发表了一篇极具影响力的博文——<a href="https://link.juejin.cn?target=https%3A%2F%2Fkarpathy.github.io%2F2015%2F05%2F21%2Frnn-effectiveness%2F" target="_blank" title="https://karpathy.github.io/2015/05/21/rnn-effectiveness/" ref="nofollow noopener noreferrer">《The Unreasonable Effectiveness of Recurrent Neural Networks》</a>。</p>
<p>这篇文章不仅是无数开发者的 RNN 启蒙读物，更第一次向大众展示了：<strong>一个简单的算法，只要有足够的数据，竟然能自学成才，写诗、写代码甚至写论文。</strong></p>
<p>今天，我们来重读这篇经典，梳理其核心技术，并用 PyTorch 复现一个最小版本的 Demo。</p>
<hr/>
<h2 data-id="heading-0">1. 核心内容：序列的魔法</h2>
<p>传统的神经网络（如全连接网络或 CNN）通常受到 API 的限制：它们接受固定大小的向量作为输入（例如一张图像），并产生固定大小的向量作为输出（例如不同类别的概率）。</p>
<p>Karpathy 在文中指出，RNN（循环神经网络）的魔力在于它打破了这种限制。它处理的是<strong>序列（Sequences）</strong> 。</p>
<ul>
<li>输入可以是序列（如一段文本）。</li>
<li>输出可以是序列（如生成的翻译）。</li>
<li>最重要的是，它拥有<strong>内部状态（Hidden State）</strong> 。这意味着在处理当前的输入时，它还“记得”刚才看到的内容。</li>
</ul>
<p>文章中最著名的实验是<strong>字符级语言模型（Character-Level Language Model）</strong> 。不同于通常基于“单词”的 NLP 模型，Karpathy 让 RNN 一个字符一个字符地阅读文本。</p>
<blockquote>
<p>输入：h -&gt; e -&gt; l -&gt; l</p>
<p>预测：e -&gt; l -&gt; l -&gt; o</p>
</blockquote>
<p>模型不需要预先知道什么是“单词”，什么是“语法”。它必须从零开始学会：<code>h</code> 后面跟着 <code>e</code> 的概率更高；左括号 <code>(</code> 出现后，未来某个时刻必须出现右括号 <code>)</code>。</p>
<hr/>
<h2 data-id="heading-1">2. 关键技术与创新点</h2>
<p>虽然 RNN 和 LSTM 的数学原理在文章发表前就已经存在，但 Karpathy 的这篇文章通过极具创意的实验，挖掘出了几个关键的技术洞见：</p>
<h3 data-id="heading-2">2.1 LSTM 的长距离记忆</h3>
<p>文章明确展示了 <strong>LSTM (Long Short-Term Memory)</strong> 相比普通 RNN 的优越性。普通 RNN 只有短时记忆，难以处理长文本。而 LSTM 通过精巧的门控机制（遗忘门、输入门、输出门），能够“记住”很久之前的信息。例如，在生成 C 语言代码时，LSTM 能够记得几百个字符前打开的大括号 <code>{</code>，并在合适的时机生成关闭的大括号 <code>}</code>。</p>
<h3 data-id="heading-3">2.2 可解释性：神经元可视化</h3>
<p>这是文章最精彩的部分。Karpathy 没有把网络当成黑盒，而是可视化了 LSTM 内部特定单元（Cell）的激活状态。他惊讶地发现了一些功能明确的“神经元”：</p>
<ul>
<li><strong>引号检测单元</strong>：当遇到开引号时激活，直到遇到闭引号才关闭。</li>
<li><strong>行长计数单元</strong>：随着一行字符的增加，激活值逐渐升高，仿佛在计算何时该换行。</li>
<li><strong>缩进层级单元</strong>：在生成代码时，有单元专门负责跟踪 <code>if/else</code> 的嵌套层级。</li>
</ul>
<h3 data-id="heading-4">2.3 Softmax 温度 (Temperature)</h3>
<p>文章介绍了一个至今仍在使用的技巧：在生成文本时引入“温度”参数。</p>
<ul>
<li><strong>高温度 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">T &gt; 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>)</strong> ：模型更疯狂，创造力更强，但也更容易出错。</li>
<li><strong>低温度 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi><mo>&lt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">T &lt; 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>)</strong> ：模型更保守，倾向于重复高概率的字符（有时会陷入死循环）。</li>
</ul>
<hr/>
<h2 data-id="heading-5">3. 实际应用场景</h2>
<p>虽然现在的 NLP 领域已经被 Transformer (GPT) 统治，但 Karpathy 文中提到的 RNN 应用模式，构成了后来无数 AI 产品的基础：</p>
<ol>
<li><strong>代码辅助 (Code Copilot 前身)</strong> ：文中展示了 RNN 学习 Linux 内核源码后，能生成以假乱真的 C 代码。这正是后来 GitHub Copilot 等工具的雏形——通过学习海量代码库来预测下一行代码。</li>
<li><strong>机器翻译 (Seq2Seq)</strong> ：利用 RNN 的“编码器-解码器”结构，将一种语言的序列映射为另一种语言的序列。</li>
<li><strong>图像描述 (Image Captioning)</strong> ：结合 CNN 提取图片特征，再用 RNN 生成描述文字（如“一只猫坐在草地上”）。这是 Karpathy 的成名研究方向。</li>
<li><strong>文本生成与风格迁移</strong>：从生成莎士比亚剧本到生成假 Wikipedia 条目，证明了模型可以捕捉并模仿特定的文风。</li>
</ol>
<hr/>
<h2 data-id="heading-6">4. 动手实战：最小可运行 Demo (PyTorch)</h2>
<p>Karpathy 当年用 NumPy 手写了一个 100 行的代码。为了方便现代开发者理解，我将其重构为 <strong>PyTorch</strong> 版本。</p>
<p>这段代码实现了一个核心逻辑：给它一段文本，它学会这段文本的风格，并能无限生成下去。</p>
<h3 data-id="heading-7">环境准备</h3>
<p>你需要安装 PyTorch：<code>pip install torch</code></p>
<h3 data-id="heading-8">完整代码 (<code>min_rnn.py</code>)</h3>
<p>Python</p>
<pre><code class="hljs language-ini" lang="ini">import torch
import torch.nn as nn
import torch.optim as optim
import sys

<span class="hljs-comment"># --- 1. 数据准备 ---</span>
<span class="hljs-comment"># 这里我们可以用一段简单的文本，或者你可以替换成任何你喜欢的 txt 文件内容</span>
<span class="hljs-attr">text</span> = <span class="hljs-string">"""
The quick brown fox jumps over the lazy dog.
Typically, RNNs process data sequentially.
Deep learning is amazing and recursive.
"""</span> * <span class="hljs-number">100</span> <span class="hljs-comment"># 重复多次以增加训练数据量</span>

<span class="hljs-comment"># 构建字符表</span>
<span class="hljs-attr">chars</span> = sorted(list(set(text)))
<span class="hljs-attr">char_to_int</span> = {c: i for i, c in enumerate(chars)}
<span class="hljs-attr">int_to_char</span> = {i: c for i, c in enumerate(chars)}

<span class="hljs-comment"># 超参数</span>
<span class="hljs-attr">input_size</span> = len(chars)
<span class="hljs-attr">hidden_size</span> = <span class="hljs-number">128</span>    <span class="hljs-comment"># 记忆容量</span>
<span class="hljs-attr">output_size</span> = len(chars)
<span class="hljs-attr">seq_length</span> = <span class="hljs-number">20</span>      <span class="hljs-comment"># 每次训练截取的序列长度</span>
<span class="hljs-attr">learning_rate</span> = <span class="hljs-number">0.005</span>

<span class="hljs-comment"># --- 2. 模型定义 (基于 LSTM) ---</span>
class CharLSTM(nn.Module):
    def __init__(self):
        super(CharLSTM, self).__init__()
        <span class="hljs-comment"># Embedding: 将字符索引转为向量</span>
        <span class="hljs-attr">self.embedding</span> = nn.Embedding(input_size, <span class="hljs-number">32</span>)
        <span class="hljs-comment"># LSTM: 核心循环层</span>
        <span class="hljs-attr">self.lstm</span> = nn.LSTM(<span class="hljs-number">32</span>, hidden_size, batch_first=<span class="hljs-literal">True</span>)
        <span class="hljs-comment"># Linear: 输出层，预测下一个字符的概率</span>
        <span class="hljs-attr">self.fc</span> = nn.Linear(hidden_size, output_size)
    
    def forward(self, x, hidden):
        <span class="hljs-attr">x</span> = self.embedding(x)
        out, <span class="hljs-attr">hidden</span> = self.lstm(x, hidden)
        <span class="hljs-comment"># 我们只关心序列最后一个时间步的输出</span>
        <span class="hljs-attr">out</span> = out[:, -<span class="hljs-number">1</span>, :]
        <span class="hljs-attr">out</span> = self.fc(out)
        return out, hidden

<span class="hljs-attr">model</span> = CharLSTM()
<span class="hljs-attr">criterion</span> = nn.CrossEntropyLoss()
<span class="hljs-attr">optimizer</span> = optim.Adam(model.parameters(), lr=learning_rate)

<span class="hljs-comment"># --- 3. 辅助函数：生成文本 ---</span>
def sample(model, <span class="hljs-attr">start_str</span>=<span class="hljs-string">"The"</span>, length=<span class="hljs-number">50</span>):
    model.eval()
    <span class="hljs-attr">hidden</span> = None
    <span class="hljs-attr">input_seq</span> = [char_to_int[c] for c in start_str]
    <span class="hljs-attr">input_tensor</span> = torch.tensor(input_seq, dtype=torch.long).unsqueeze(<span class="hljs-number">0</span>)
    
    <span class="hljs-attr">generated_text</span> = start_str
    
    with torch.no_grad():
        <span class="hljs-comment"># 先预热 hidden state</span>
        _, <span class="hljs-attr">hidden</span> = model.lstm(model.embedding(input_tensor[:, :-<span class="hljs-number">1</span>]), hidden)
        
        <span class="hljs-comment"># 开始逐字生成</span>
        <span class="hljs-attr">curr_input</span> = input_tensor[:, -<span class="hljs-number">1</span>:]
        for _ in range(length):
            out, <span class="hljs-attr">hidden</span> = model.lstm(model.embedding(curr_input), hidden)
            <span class="hljs-attr">out</span> = model.fc(out[:, -<span class="hljs-number">1</span>, :])
            
            <span class="hljs-comment"># 简单的贪婪采样 (取概率最大的)</span>
            _, <span class="hljs-attr">predicted_idx</span> = torch.max(out, <span class="hljs-number">1</span>)
            
            <span class="hljs-attr">next_char</span> = int_to_char[predicted_idx.item()]
            generated_text += next_char
            
            <span class="hljs-comment"># 更新输入</span>
            <span class="hljs-attr">curr_input</span> = torch.tensor([[predicted_idx.item()]], dtype=torch.long)
            
    return generated_text

<span class="hljs-comment"># --- 4. 训练循环 ---</span>
print(f"Training on {len(text)} characters. Vocabulary size: {len(chars)}")
<span class="hljs-attr">data_indices</span> = [char_to_int[c] for c in text]
<span class="hljs-attr">data_tensor</span> = torch.tensor(data_indices, dtype=torch.long)

for epoch in range(2001):
    <span class="hljs-comment"># 随机截取一段文本进行训练</span>
    <span class="hljs-attr">start_idx</span> = torch.randint(<span class="hljs-number">0</span>, len(text) - seq_length - <span class="hljs-number">1</span>, (<span class="hljs-number">1</span>,)).item()
    <span class="hljs-attr">end_idx</span> = start_idx + seq_length + <span class="hljs-number">1</span>
    
    <span class="hljs-comment"># 输入: hello, 目标: ello</span>
    <span class="hljs-attr">x_batch</span> = data_tensor[start_idx : end_idx-<span class="hljs-number">1</span>].unsqueeze(<span class="hljs-number">0</span>) <span class="hljs-comment"># [1, seq_len]</span>
    <span class="hljs-attr">y_batch</span> = data_tensor[start_idx+<span class="hljs-number">1</span> : end_idx]      <span class="hljs-comment"># [seq_len] (但在本简化demo中只预测最后一个字)</span>
    <span class="hljs-attr">y_target</span> = y_batch[-<span class="hljs-number">1</span>].unsqueeze(<span class="hljs-number">0</span>)               <span class="hljs-comment"># 只取最后一个字做目标，简化训练逻辑</span>
    
    optimizer.zero_grad()
    output, <span class="hljs-attr">_</span> = model(x_batch, None) <span class="hljs-comment"># Hidden 自动初始化</span>
    <span class="hljs-attr">loss</span> = criterion(output, y_target)
    loss.backward()
    optimizer.step()
    
    if epoch % <span class="hljs-attr">200</span> == <span class="hljs-number">0</span>:
        print(f"Epoch {epoch} | Loss: {loss.item():.4f}")
        print(f"Sample: {sample(model, <span class="hljs-attr">start_str</span>=<span class="hljs-string">'The'</span>, length=<span class="hljs-number">30</span>)}<span class="hljs-string">")
        print("</span>-<span class="hljs-string">" * 30)
</span></code></pre>
<h3 data-id="heading-9">运行结果预期</h3>
<p>刚开始模型会输出乱码。随着 Epoch 增加，你会看到 Loss 下降，生成的文本开始变得有意义（例如学会拼写 "deep", "learning" 等单词）。</p>
<h2 data-id="heading-10">结语</h2>
<p>虽然 LSTM 已经被 Transformer 取代，但 Karpathy 的这篇文章依然值得一读。它提醒我们：<strong>智能往往涌现于简单的结构与大规模数据的结合之中</strong>。这种“Unreasonable Effectiveness”（不可思议的有效性）正是深度学习最迷人的地方。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最大似然估计，香农熵，交叉熵与KL散度的详细解读与实现]]></title>    <link>https://juejin.cn/post/7586610067568689152</link>    <guid>https://juejin.cn/post/7586610067568689152</guid>    <pubDate>2025-12-23T07:45:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586610067568689152" data-draft-id="7586617459488243764" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最大似然估计，香农熵，交叉熵与KL散度的详细解读与实现"/> <meta itemprop="keywords" content="机器学习,人工智能"/> <meta itemprop="datePublished" content="2025-12-23T07:45:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Narrastory"/> <meta itemprop="url" content="https://juejin.cn/user/4355593566170010"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最大似然估计，香农熵，交叉熵与KL散度的详细解读与实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4355593566170010/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Narrastory
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:45:03.000Z" title="Tue Dec 23 2025 07:45:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">最大似然估计，香农熵，交叉熵与KL散度的详细解读与实现</h2>
<p><code>Ming | 2025.12</code></p>
<hr/>
<div align="center">
  <img align="center" src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25b5f8851b6b445ebfaf52c293d3de19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767080702&amp;x-signature=yeBE9AXk%2F1vj3k8W9G6sxIheAYU%3D" alt="AI Generated Art" width="90%" loading="lazy"/>
</div>
<p>这篇文章将会依次讲解最大似然估计、香农熵、交叉熵与 KL 散度。它们之间逻辑紧密、层层递进，共同构成了现代机器学习与信息论中关于概率建模、信息度量与分布比较的核心基础。</p>
<h3 data-id="heading-1">1. 最大似然估计</h3>
<p>什么是最/极大似然估计？它是用来解决什么问题的？</p>
<p>我们暂时抛开严谨的数学定义，从一个简单的例子入手。</p>
<p>假设我们面对这样一个问题：
有一个神秘袋子，里面装有红、绿、蓝三种颜色的球，但我们不知道每种颜色的球所占的比例。我们仅知道颜色的概率分布具有以下结构（其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> 是未知参数）：</p>

















<table><thead><tr><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：红</th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：绿</th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：蓝</th></tr></thead><tbody><tr><td>概率</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mfrac><mrow><mn>3</mn><mi>θ</mi></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">1- \frac{3\theta}{2} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>θ</mi><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{\theta}{2} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></td></tr></tbody></table>
<p>也就是说，抽到红球的概率是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span>，抽到蓝球的概率是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>θ</mi><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{\theta}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span>，抽到绿球的概率则是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mfrac><mrow><mn>3</mn><mi>θ</mi></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">1-\frac{3\theta}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span>。</p>
<p>现在我们唯一能做的，就是有放回地从袋中随机抽取若干次，观察颜色。除此之外，我们无法打开袋子查看内部情况。那么，如何根据有限的观测结果来估计参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> 的值呢？</p>
<p>你可能会想到：只要抽取次数足够多，统计各颜色出现的频率，就能近似真实概率，从而推算出 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span>。这确实是不错的做法。但在实际问题中，我们往往只能获得有限的样本，甚至样本数很少；或者变量维度很高（比如有 1000 种颜色，未知数也不在是一个<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span>，而是非常多的未知变量），直接统计频率可能不稳定或不可行。这时，就需要借助<strong>最大似然估计</strong>这一强大的思想。</p>
<p>还是以上面的问题为例：</p>
<p>假设我们抽取了 6 次，得到颜色序列为：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{1},x_{2},x_{2},x_{3},x_{2},x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，记该观测事件为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span>。根据上述分布，事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 发生的概率（在给定 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> 下）为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mi>θ</mi><mo>⋅</mo><mo stretchy="false">(</mo><mfrac><mi>θ</mi><mn>2</mn></mfrac><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>⋅</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mfrac><mrow><mn>3</mn><mi>θ</mi></mrow><mn>2</mn></mfrac><msup><mo stretchy="false">)</mo><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">L(\theta ) = \theta \cdot (\frac{\theta}{2})^{2} \cdot (1-\frac{3\theta}{2} )^{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span></span></div>
<p>这里用到了独立事件的概率乘法公式：每次抽取相互独立，因此整个序列的概率等于各次抽取概率的乘积。</p>
<p>现在，关键的思想来了：<strong>这个观测结果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 是已经发生的既定事实。既然它发生了，我们就有理由认为，这个事件发生的概率应当是比较大的</strong>。既然如此，我们现在的任务就是找到一个<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span>，使得<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span>的值最大。这就是<strong>极大似然估计</strong>的核心直觉——寻找最能让观测数据“看起来合理”的参数。</p>
<p>在数学中，直接求<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L(\theta )</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span>的最小值可能不是很方便，因为它是多个概率的乘积，可能非常小，且容易导致数值下溢。为了便于计算与分析，我们通常对其取自然对数，得到<strong>对数似然函数</strong>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>ln</mtext><mo stretchy="false">(</mo><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><mtext>ln</mtext><mi>θ</mi><mo>+</mo><mn>3</mn><mtext>ln</mtext><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mfrac><mrow><mn>3</mn><mi>θ</mi></mrow><mn>2</mn></mfrac><mo stretchy="false">)</mo><mo>+</mo><mn>2</mn><mtext>ln</mtext><mo stretchy="false">(</mo><mfrac><mi>θ</mi><mn>2</mn></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\ell(\theta) = \text{ln}(L(\theta)) = \text{ln}\theta + 3 \text{ln}(1-\frac{3\theta}{2}) + 2\text{ln}(\frac{\theta}{2})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">ℓ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">ln</span></span><span class="mopen">(</span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord text"><span class="mord">ln</span></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">3</span><span class="mord text"><span class="mord">ln</span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mord">2</span><span class="mord text"><span class="mord">ln</span></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span></span></span></span></span></div>
<p>由于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ln</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\ln</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mop">ln</span></span></span></span></span> 是单调递增函数，最大化 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span> 等价于最大化 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\ell(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">ℓ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span>。对数转换能将连乘转为求和，既简化求导运算，也提升数值稳定性。</p>
<p>现在我们把最大似然估计的概念放到机器学习语境中去，那么上面那个分布表，就是我们定义的模型，我们有放回的抽样获得的数据，就是训练集；<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L(\theta ) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span>就是损失函数，要求其极小值。用更加专业一点的说法就是：在机器学习中，我们经常将训练数据视为从某个真实分布中采样得到的观测。我们定义一个参数化模型 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_{\theta}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>，希望用它来逼近真实分布。此时，似然函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span> 就度量了在该模型下观测到训练数据的“合理程度”。最大化似然函数等价于最小化负对数似然。而这正是许多监督学习模型（如逻辑回归、神经网络分类器）中使用的损失函数——交叉熵损失的理论来源。</p>
<h3 data-id="heading-2">2. 香农熵</h3>
<p>在探讨香农熵之前，我们首先需要理解什么是“信息量”。信息量直观来说，是一个事件发生时所携带的信息的多少。我们可以通过一个简单的例子来体会：小明是一名优等生，每次考试都能进入年级前几名。因此，下一次考试他再次进入年级前几名的概率非常高。假设他真的做到了，这个事件所包含的信息量其实很少，因为大家早已预料到这一结果——小明成绩优秀是常态。相反，如果小明下一次考试成绩大幅下滑，排名跌至年级下游，那么这个事件所包含的信息量就会非常大，会引发各种猜测与关注：小明是不是生病了？是不是最近遇到了什么困难？或是家庭出现了什么变故？这种“意外”所携带的信息，远远超过符合预期的结果。</p>
<p>从这一点我们可以总结：<strong>一个事件发生的概率越大，它所包含的信息量就越小</strong>；反之，概率越小，信息量就越大。换句话说，信息量与事件发生的概率成反比。</p>
<p>对于事件<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span>，其发生的概率为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>，则它的信息量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>p</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">I_{p}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>计算方式如下</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>I</mi><mi>p</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mrow><mo stretchy="false">(</mo><mfrac><mn>1</mn><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac><mo stretchy="false">)</mo></mrow><mo>=</mo><mo>−</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">I_{p}(x) = \log_{2}{(\frac{1}{p(x)} )} = -\log_{2}{p(x)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.2574em;vertical-align:-0.936em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></span></div>
<p>为了更具体地理解这个公式，我们来看一个离散概率分布<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>的示例：</p>

















<table><thead><tr><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th></tr></thead><tbody><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></td><td>0.05</td><td>0.3</td><td>0.65</td></tr></tbody></table>
<p>根据公式计算每个事件的信息量就能得到</p>

















<table><thead><tr><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th><th><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></th></tr></thead><tbody><tr><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>p</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">I_{p}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></td><td>4.3219</td><td>1.7369</td><td>0.6214</td></tr></tbody></table>
<p>可以看出，概率极小的事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 信息量很大，而概率很大的事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 信息量则很小。这正是我们直觉的数学体现。</p>
<p>接下来，我们引入<strong>香农熵</strong>的概念。如果我们不仅关心单个事件的信息量，而是希望衡量整个概率分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 的“平均不确定性”或“平均信息量”，就需要计算信息量的期望值，即香农熵：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mi>I</mi><mi>p</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(P)= \sum_{i=1}^n P(x_{i})I_{p}(x_i) =-\sum_{i=1}^n P(x_{i})\log_2P(x_{i})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<p>香农熵描述的是：在概率分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 下，随机变量所携带的平均信息量。熵越大，表示分布的不确定性越高，平均信息量也越大；熵越小，则表示分布越集中，不确定性越低。</p>
<p>举个例子，如果某个分布中一个事件几乎必然发生（概率接近 1），那么熵会接近 0，因为几乎不需要额外信息来描述结果。相反，如果所有事件概率均等（如掷一枚均匀的骰子），熵就会达到最大值，因为每个结果都同样“意外”，描述结果所需的信息最多。</p>
<p>相信看了下面的代码你就会更加理解香农熵这个概念</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 三个不同的概率分布</span>
p_1 = np.array([<span class="hljs-number">0.01</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.98</span>,<span class="hljs-number">0.01</span>])
p_2 = np.array([<span class="hljs-number">0.25</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">0.25</span>,<span class="hljs-number">0.25</span>])
p_3 = np.array([<span class="hljs-number">0.3</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.1</span>,<span class="hljs-number">0.4</span>])

<span class="hljs-keyword">def</span> <span class="hljs-title function_">shannonEntropy</span>(<span class="hljs-params">p: np.ndarray</span>):	<span class="hljs-comment"># 计算香农熵的函数</span>
    <span class="hljs-keyword">return</span> -np.<span class="hljs-built_in">sum</span>(p * np.log2(p + <span class="hljs-number">1e-12</span>))    <span class="hljs-comment"># 加一个1e-12防止出现log(0)的情况</span>

<span class="hljs-built_in">print</span>(shannonEntropy(p_1))
<span class="hljs-built_in">print</span>(shannonEntropy(p_2))
<span class="hljs-built_in">print</span>(shannonEntropy(p_3))

<span class="hljs-comment"># 输出</span>
<span class="hljs-number">0.16144054253749263</span>
<span class="hljs-number">1.9999999999942293</span>
<span class="hljs-number">1.8464393446652445</span>
</code></pre>
<h3 data-id="heading-3">3. 交叉熵</h3>
<p>交叉熵在机器学习，尤其是分类任务中无处不在。简单来说，交叉熵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(P,Q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span></span></span></span></span>直接刻画了两个概率分布<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>之间的差异程度：<strong>两个分布越相似，交叉熵越小；两个分布差异越大，交叉熵越大</strong>。</p>
<p>交叉熵计算公式如下:</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mi>I</mi><mi>q</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(P,Q)= \sum_{i=1}^n P(x_i)I_{q}(x_i) =-\sum_{i=1}^n P(x_i)\log_2Q(x_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<p>为了直观理解，来看两组例子。</p>
<p>假设在一个三分类任务中，某样本的真实标签分布和模型的预测分布如下：</p>























<table><thead><tr><th align="left">事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span></th><th align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (猫)</th><th align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (狗)</th><th align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (鸟)</th></tr></thead><tbody><tr><td align="left">真实分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_1(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></td><td align="left">0.00</td><td align="left">1.00</td><td align="left">0.00</td></tr><tr><td align="left">预测分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q_1(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></td><td align="left">0.05</td><td align="left">0.90</td><td align="left">0.05</td></tr></tbody></table>
<p>这里，真实分布表示样本是“狗”（概率为1）。模型的预测也高度集中在“狗”上，只是给其他类别分配了很小的概率。计算其交叉熵：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>H</mi><mo stretchy="false">(</mo><msub><mi>P</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></munderover><msub><mi>P</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><mrow><mo fence="true">[</mo><msub><mi>P</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>+</mo><msub><mi>P</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>+</mo><msub><mi>P</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>3</mn></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>1</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>3</mn></msub><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><mrow><mo fence="true">[</mo><mn>0</mn><mo>×</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.05</mn><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn><mo>×</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.90</mn><mo stretchy="false">)</mo><mo>+</mo><mn>0</mn><mo>×</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.05</mn><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.90</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>≈</mo><mn>0.152</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
H(P_1, Q_1) &amp;= -\sum_{i=1}^{3} P_1(x_i) \log_2 Q_1(x_i) \\
&amp;= -\left[P_1(x_1) \log_2 Q_1(x_1) + P_1(x_2) \log_2 Q_1(x_2) + P_1(x_3) \log_2 Q_1(x_3)\right] \\
&amp;= -\left[0 \times \log_2(0.05) + 1 \times \log_2(0.90) + 0 \times \log_2(0.05)\right] \\
&amp;= -\log_2(0.90) \\
&amp;\approx 0.152
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:9.3788em;vertical-align:-4.4394em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.9394em;"><span style="top:-6.9394em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-4.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span><span style="top:-3.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span><span style="top:-1.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span><span style="top:-0.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.4394em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.9394em;"><span style="top:-6.9394em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8011em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-4.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span><span style="top:-3.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.05</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.90</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.05</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span><span style="top:-1.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.90</span><span class="mclose">)</span></span></span><span style="top:-0.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">0.152</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.4394em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>这个值非常小，说明两者高度相似。</p>
<p>现在考虑另一种情况，模型做出了完全错误的预测：</p>























<table><thead><tr><th align="left">事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span></th><th align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (猫)</th><th align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (狗)</th><th align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (鸟)</th></tr></thead><tbody><tr><td align="left">真实分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_2(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></td><td align="left">0.00</td><td align="left">1.00</td><td align="left">0.00</td></tr><tr><td align="left">预测分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q_2(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></td><td align="left">0.70</td><td align="left">0.15</td><td align="left">0.15</td></tr></tbody></table>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>H</mi><mo stretchy="false">(</mo><msub><mi>P</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></munderover><msub><mi>P</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><mrow><mo fence="true">[</mo><msub><mi>P</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo>+</mo><msub><mi>P</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mo>+</mo><msub><mi>P</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>3</mn></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><msub><mi>Q</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mn>3</mn></msub><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><mrow><mo fence="true">[</mo><mn>0</mn><mo>×</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.70</mn><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn><mo>×</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.15</mn><mo stretchy="false">)</mo><mo>+</mo><mn>0</mn><mo>×</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.15</mn><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo>−</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0.15</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>≈</mo><mn>2.737</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
H(P_2, Q_2) &amp;= -\sum_{i=1}^{3} P_2(x_i) \log_2 Q_2(x_i) \\
&amp;= -\left[P_2(x_1) \log_2 Q_2(x_1) + P_2(x_2) \log_2 Q_2(x_2) + P_2(x_3) \log_2 Q_2(x_3)\right] \\
&amp;= -\left[0 \times \log_2(0.70) + 1 \times \log_2(0.15) + 0 \times \log_2(0.15)\right] \\
&amp;= -\log_2(0.15) \\
&amp;\approx 2.737
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:9.3788em;vertical-align:-4.4394em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.9394em;"><span style="top:-6.9394em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-4.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span><span style="top:-3.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span><span style="top:-1.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span><span style="top:-0.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.4394em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.9394em;"><span style="top:-6.9394em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8011em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-4.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span><span style="top:-3.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.70</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.15</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.15</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span><span style="top:-1.5217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0.15</span><span class="mclose">)</span></span></span><span style="top:-0.0217em;"><span class="pstrut" style="height:3.8011em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">2.737</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:4.4394em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>交叉熵值显著增大，清晰地反映了两个分布之间的巨大差异。</p>
<p>因此，交叉熵的本质是：<strong>以真实分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 为权重，对“用分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>  定义的信息量”求期望</strong>。它衡量的是，基于错误的估计 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span> ，描述真实事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>  所需要的平均比特数。</p>
<p>或者换个更直白的比喻：</p>
<blockquote>
<p>假设你要用英语（Q）向外国人（P）传达信息。</p>
<ul>
<li>如果你的英语很好（Q接近P），你不需要说很多话就能让对方理解</li>
<li>如果你的英语水平不高（Q远离P），你需要说很多废话、打很多手势才能沟通</li>
</ul>
<p>交叉熵衡量的是：用英语向外国人传达信息时，<strong>平均每句要多说多少废话</strong></p>
</blockquote>
<p>可以通过简单的代码来验证和感受交叉熵的计算：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">def</span> <span class="hljs-title function_">cross_entropy</span>(<span class="hljs-params">p: np.ndarray, q: np.ndarray</span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""
    计算离散概率分布 P 和 Q 之间的交叉熵 H(P, Q)。
    """</span>
    <span class="hljs-keyword">return</span> -np.<span class="hljs-built_in">sum</span>(p * np.log2(q + <span class="hljs-number">1e-12</span>))

<span class="hljs-comment"># 示例计算</span>
p = np.array([<span class="hljs-number">0.3</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.4</span>])
q = np.array([<span class="hljs-number">0.25</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">0.5</span>])
<span class="hljs-built_in">print</span>(cross_entropy(p, q))  <span class="hljs-comment"># 输出: 1.599...</span>
</code></pre>
<h3 data-id="heading-4">4. KL散度</h3>
<p>KL散度和交叉熵的功能相同，都是来衡量两个不同的概率分布之间的相似性的。同样的，<strong>两个分布越相似，KL散度值越小；两个分布差异越大，KL散度值越大</strong>。</p>
<p>你可能会问：既然交叉熵也可以衡量分布之间的差异，为什么还需要KL散度？要理解这一点，我们可以直接观察KL散度的计算公式：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>P</mi><mo>∥</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>=</mo><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>−</mo><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msub><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msub><mfrac><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><mrow><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">D_{KL}(P \parallel Q)= H(P,Q)-H(P) =  \sum_{i=1}^{n}P(x_i)\log_{2}{\frac{P(x_i)}{Q(x_i)} }</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.207em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2441em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></span></div>
<p>你会惊奇的发现概率分布<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>的KL散度竟然只是其交叉熵减去<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>的香农熵这么简单！对，KL散度就是<strong>交叉熵与真实分布熵的差值</strong>。这意味着，KL散度在交叉熵的基础上，减去了真实分布自身的不确定性，从而更纯粹地反映了“近似分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span> 与真实分布 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 之间的差异”。换句话说，交叉熵同时包含了“真实分布的熵”与“两个分布之间的差异”，而KL散度则只提取了后者。</p>
<p>注意，从公式中还可以看出，KL散度具有以下重要数学性质：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>p</mi><mo>∥</mo><mi>q</mi><mo stretchy="false">)</mo><mo>≥</mo><mn>0</mn><mtext> 并且 </mtext><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>p</mi><mo>∥</mo><mi>q</mi><mo stretchy="false">)</mo><mo mathvariant="normal">≠</mo><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>q</mi><mo>∥</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{KL}(p \parallel q) \ge 0 \text{ 并且 }D_{KL}(p \parallel q) \ne D_{KL}(q \parallel p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0</span><span class="mord text"><span class="mord"> </span><span class="mord cjk_fallback">并且</span><span class="mord"> </span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"/></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span></span></div>
<p>任何两个概率分布的KL散度一定是大于等于0的，如果未来某一天你在计算KL散度的时候发现计算结果小于0，那你就要注意了，很可能意味着代码实现有误，或者概率值未正确归一化。另外，KL散度是不对称的，这一点仅从公式上就能看出来了，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>P</mi><mo>∥</mo><mi>Q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{KL}(P \parallel Q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span></span></span></span></span>表示目标分布是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>，它的值为预测分布<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>与目标<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>的差异，而<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>Q</mi><mo>∥</mo><mi>P</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{KL}(Q \parallel P)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span></span></span></span></span>则相反。</p>
<p>我们可以通过下面的这份代码来更加深入的理解交叉熵，KL散度之间的关系：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">kl_divergence</span>(<span class="hljs-params">p, q</span>):
    <span class="hljs-string">"""
    计算离散分布P和Q之间的KL散度 D_KL(P || Q)
    """</span>
    <span class="hljs-comment"># 添加一个小值避免log(0)</span>
    p = np.clip(p, <span class="hljs-number">1e-12</span>, <span class="hljs-number">1</span>)
    q = np.clip(q, <span class="hljs-number">1e-12</span>, <span class="hljs-number">1</span>)
    <span class="hljs-comment"># 归一化确保是概率分布</span>
    p = p / np.<span class="hljs-built_in">sum</span>(p)
    q = q / np.<span class="hljs-built_in">sum</span>(q)

    <span class="hljs-keyword">return</span> np.<span class="hljs-built_in">sum</span>(p * np.log(p / q))
</code></pre>
<pre><code class="hljs language-python" lang="python">p = np.array([<span class="hljs-number">0.02</span>, <span class="hljs-number">0.08</span>, <span class="hljs-number">0.9</span>])
q = np.array([<span class="hljs-number">0.1</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.8</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">"H(p) = "</span> + <span class="hljs-built_in">str</span>(shannonEntropy(p)))		<span class="hljs-comment">#计算p的香农熵</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"H(q) = "</span> + <span class="hljs-built_in">str</span>(shannonEntropy(q)))		<span class="hljs-comment">#计算q的香农熵</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"H(p,q) = "</span> + <span class="hljs-built_in">str</span>(cross_entropy(p, q)))	<span class="hljs-comment">#计算p与q之间的交叉熵</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"H(q,p) = "</span> + <span class="hljs-built_in">str</span>(cross_entropy(q, p)))	<span class="hljs-comment">#计算q与p之间的交叉熵</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"D_kl(p|q) = "</span> + <span class="hljs-built_in">str</span>(kl_divergence(p, q)))<span class="hljs-comment">#计算p与q之间的KL散度</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"D_kl(q|p) = "</span> + <span class="hljs-built_in">str</span>(kl_divergence(q, p)))<span class="hljs-comment">#计算q与p之间的KL散度</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 输出</span>
H(p) = <span class="hljs-number">0.5411884030736893</span>
H(q) = <span class="hljs-number">0.9219280948830342</span>
H(p,q) = <span class="hljs-number">0.6219280948842965</span>
H(q,p) = <span class="hljs-number">1.0503737127006858</span>
D_kl(p|q) = <span class="hljs-number">0.05596448973692631</span>
D_kl(q|p) = <span class="hljs-number">0.0890317178497243</span>
</code></pre>
<p>上面说到：交叉熵同时包含了“真实分布的熵”与“两个分布之间的差异”，而KL散度则只提取了后者。因此KL散度更能很好的体现出两个概率分布之间的差异性，KL散度要比交叉熵更加的“干净，纯粹”。</p>
<pre><code class="hljs language-python" lang="python">p = np.array([<span class="hljs-number">0.02</span>, <span class="hljs-number">0.08</span>, <span class="hljs-number">0.9</span>])
q = np.array([<span class="hljs-number">0.1</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.8</span>])
k = np.array([<span class="hljs-number">0.5</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.1</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">"H(p,q) = "</span> + <span class="hljs-built_in">str</span>(cross_entropy(p, q)))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"H(p,k) = "</span> + <span class="hljs-built_in">str</span>(cross_entropy(p, k)))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"D_kl(p|q) = "</span> + <span class="hljs-built_in">str</span>(kl_divergence(p, q)))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"D_kl(p|k) = "</span> + <span class="hljs-built_in">str</span>(kl_divergence(p, k)))
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 输出</span>
H(p,q) = <span class="hljs-number">0.6219280948842965</span>
H(p,k) = <span class="hljs-number">3.1154895329762846</span>
D_kl(p|q) = <span class="hljs-number">0.05596448973692631</span>
D_kl(p|k) = <span class="hljs-number">1.7843695701105056</span>	<span class="hljs-comment"># 可以看到KL散度明显比交叉熵要小很多，因为它只包含差异信息，不包含额外的目标概率分布的熵的信息</span>
</code></pre>
<p>既然这样，为什么在机器学习中经常使用交叉熵做损失函数，而很少听到KL散度呢？</p>
<p>其实在机器学习中，一直用的都是KL散度来做损失函数，只不过机器学习的训练数据的标签<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>是固定的，因此<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(P)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span></span></span></span></span>是一个常数，根据公式</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>P</mi><mo>∥</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>=</mo><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>−</mo><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{KL}(P \parallel Q)= H(P,Q)-H(P)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mclose">)</span></span></span></span></span></div>
<p>要求<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><mi>P</mi><mo>∥</mo><mi>Q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">D_{KL}(P \parallel Q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span></span></span></span></span>的最小值，其实就是求<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(P,Q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span></span></span></span></span>的最小值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# Vue3 图片标注插件 AILabel]]></title>    <link>https://juejin.cn/post/7586615716907073536</link>    <guid>https://juejin.cn/post/7586615716907073536</guid>    <pubDate>2025-12-23T07:58:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586615716907073536" data-draft-id="7586610067568820224" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# Vue3 图片标注插件 AILabel"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:58:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叫我AddV"/> <meta itemprop="url" content="https://juejin.cn/user/4860749051150"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # Vue3 图片标注插件 AILabel
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4860749051150/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叫我AddV
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:58:40.000Z" title="Tue Dec 23 2025 07:58:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue3 图片标注插件 AILabel</h2>
<blockquote>
<p>近期在做一个图片标注的项目，就是展示一张图片，然后在图片上拖拖拽拽绘制一个一个的框框，然后把框框的位置数据保存起来。</p>
</blockquote>
<h3 data-id="heading-1">插件 AILabel</h3>
<p>NPM：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Failabel%3FactiveTab%3Dreadme" target="_blank" title="https://www.npmjs.com/package/ailabel?activeTab=readme" ref="nofollow noopener noreferrer">www.npmjs.com/package/ail…</a>
GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjlifeng%2Failabel" target="_blank" title="https://github.com/jlifeng/ailabel" ref="nofollow noopener noreferrer">github.com/jlifeng/ail…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ce4e65032a648a2b3f94f24018d3712~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081520&amp;x-signature=BptN%2FDjEmIcO5FggX0D6TSUbqCE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>但是有一个问题啊，就是这个 github 上面或者是 npm 上面的链接都是失效的了，文档都找不到，下面贴一个我弄到的文档，起码我发文的时候还是可以查看的，不知道后期还能不能保住！</p>
<p>文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fluchuanqi.github.io%2FAILabel%2Fdoc%2Fpreview%2F%231" target="_blank" title="https://luchuanqi.github.io/AILabel/doc/preview/#1" ref="nofollow noopener noreferrer">luchuanqi.github.io/AILabel/doc…</a></p>
<h3 data-id="heading-2">安装 AILabel 插件</h3>
<p>安装插件很简单哈，一行命令完事儿了。</p>
<pre><code class="hljs language-bash" lang="bash">npm i ailabel
</code></pre>
<p>静待安装完成就可以了。</p>
<h3 data-id="heading-3">使用（关键代码）</h3>
<p><code>AILabel</code> 使用类似于<code>openlayer</code>，也是那种一个一个的图层往上加，下面简单来个案例哈！</p>
<h4 data-id="heading-4">1. 获取图片，获取原始图片的宽高</h4>
<p>比如我有一张图片，我需要获取这个图片的<code>宽高</code>是多少，因为我必须于原始图片大小一样，不然的话我标注出来的位置就是不准的，因此需要先获取原始图片宽高。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> url = <span class="hljs-title function_">ref</span>(<span class="hljs-string">"http://192.168.78.17:5173/static/images/1.jpg"</span>)  <span class="hljs-comment">// 图片地址</span>

<span class="hljs-comment">// 加载图片 获取图片宽高</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadImage</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>()
  img.<span class="hljs-property">src</span> = url.<span class="hljs-property">value</span>
  img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
    imageWidth.<span class="hljs-property">value</span> = img.<span class="hljs-property">width</span>  <span class="hljs-comment">// 图片宽度</span>
    imageHeight.<span class="hljs-property">value</span> = img.<span class="hljs-property">height</span>   <span class="hljs-comment">// 图片高度</span>
  }
}
</code></pre>
<h4 data-id="heading-5">2. 初始化 AILabel</h4>
<p>初始化标注就是使用 AILabel，然后把图片作为图层中添加到 AILabel 中，同时需要在 AILabel 中添加一个标注图层。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 初始化标注</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initAnno</span> = (<span class="hljs-params"/>) =&gt; {
  gMap.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-title class_">Map</span>(<span class="hljs-string">'ed-video-mask'</span>, {
    <span class="hljs-attr">center</span>: { <span class="hljs-attr">x</span>: imageWidth.<span class="hljs-property">value</span> / <span class="hljs-number">2</span>, <span class="hljs-attr">y</span>: imageHeight.<span class="hljs-property">value</span> / <span class="hljs-number">2</span> },  <span class="hljs-comment">// 设置一下中心点位置</span>
    <span class="hljs-attr">zoom</span>: imageWidth.<span class="hljs-property">value</span>,  <span class="hljs-comment">// zoom下面单独说，很重要</span>
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'PAN'</span>,   <span class="hljs-comment">// 设置类型为平移（可以设置绘制矩形、多边形、圆形等等，默认拖拽就行了）</span>
    <span class="hljs-attr">refreshDelayWhenZooming</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 这些在文档里面看就行</span>
    <span class="hljs-attr">zoomWhenDrawing</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">panWhenDrawing</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">withHotKeys</span>: <span class="hljs-literal">false</span>
  })

  <span class="hljs-comment">// 图片图层 （用于展示图片）</span>
  gImageLayer.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Layer</span>.<span class="hljs-title class_">Image</span>(<span class="hljs-string">'image-layer'</span>, {
    <span class="hljs-attr">src</span>: url.<span class="hljs-property">value</span>,  <span class="hljs-comment">// 图片地址url （比如：https://xxx.com/1.png）</span>
    <span class="hljs-attr">width</span>: imageWidth.<span class="hljs-property">value</span>,  <span class="hljs-comment">// 图片实际宽度</span>
    <span class="hljs-attr">height</span>: imageHeight.<span class="hljs-property">value</span>,   <span class="hljs-comment">// 图片实际高度</span>
    <span class="hljs-attr">crossOrigin</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">position</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> }  <span class="hljs-comment">// 初始位置</span>
  },
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'图片图层'</span> },
    { <span class="hljs-attr">zIndex</span>: <span class="hljs-number">1</span> })

  gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">addLayer</span>(gImageLayer.<span class="hljs-property">value</span>)  <span class="hljs-comment">// 图片图层添加到 AILabel</span>

  <span class="hljs-comment">// 标注图层 （绘制的框框在这个图层上）</span>
  gFeatureLayer.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Layer</span>.<span class="hljs-title class_">Feature</span>(
    <span class="hljs-string">'feature-layer'</span>,
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'标注图层'</span> },
    { <span class="hljs-attr">zIndex</span>: <span class="hljs-number">2</span> }
  )
  gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">addLayer</span>(gFeatureLayer.<span class="hljs-property">value</span>)   <span class="hljs-comment">// 标注图层添加到 AILabel</span>
}
</code></pre>
<p>这样就可以了。</p>
<p>那个 zoom 是啥意思哈，很重要，比如我的图片原始分辨率尺寸是 <code>3000 * 2000</code>，但是我们标注给的可是区域不一定这么大啊，也许只有1000* 500，那么我们直接标注的话可能就有问题，标注出来的框框位置可能和实际照片的位置不匹配，这个zoom就是来解决这个问题的。</p>
<p>这个 <code>zoom 就是图片宽度的实际大小</code>。</p>
<p>比如，我的标注可视区域可能只有1000px，但是图片实际宽度是3000px，图片为了在可视区域放得下，会自动把图片缩小，让图片可以在可视区域完整得放下。这时候其实图片是被缩小的，但是我们标注出来的位置和大小就和原尺寸的对应不上了，这时候我们设置 <code>zoom 为 3000</code>，那么就对应上了，所以，<code>zoom 设置为原始图片宽度就可以</code>！切记切记！不然标注出来的位置是错的！！！</p>
<h4 data-id="heading-6">3. 修改 AILabel 的模式</h4>
<p>上面默认设置了 <code>PAN</code>，就是平移，这个时候是可以拖拽图片位置，滚轮实现图片缩放的。</p>
<p>当需要鼠标拖拽绘制的时候，需要改为其他的模式，修改方式为：</p>
<pre><code class="hljs language-javascript" lang="javascript">gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">setMode</span>(mode)
</code></pre>
<p>其中 mode 的值可以是：<code>RECT</code>、<code>CIRCLE</code>、<code>POLYGON</code>、<code>POINT</code>、<code>LINE</code>。</p>

































<table><thead><tr><th>值</th><th>含义</th></tr></thead><tbody><tr><td>RECT</td><td>矩形</td></tr><tr><td>CIRCLE</td><td>圆形</td></tr><tr><td>POLYGON</td><td>多边形</td></tr><tr><td>POINT</td><td>点</td></tr><tr><td>LINE</td><td>线段</td></tr><tr><td>PAN</td><td>平移</td></tr></tbody></table>
<h4 data-id="heading-7">4. 设置拖拽样式</h4>
<p>在我们设置了 <code>gMap.value.setMode('RECT')</code>  绘制矩形的时候，我们按下鼠标左键拖拽的时候会有一个默认样式，当然这是可以设置的，设置起来很简单：</p>
<pre><code class="hljs language-javascript" lang="javascript">gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">setDrawingStyle</span>({
	<span class="hljs-attr">strokeStyle</span>: <span class="hljs-string">'#409EFF'</span>,  <span class="hljs-comment">// 设置边框颜色</span>
  <span class="hljs-attr">lineWidth</span>: <span class="hljs-number">2</span>,   <span class="hljs-comment">// 设置边框宽度</span>
  <span class="hljs-attr">fillStyle</span>: <span class="hljs-string">'#409EFF44'</span>,   <span class="hljs-comment">// 设置填充颜色</span>
  <span class="hljs-attr">fill</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 启用填充</span>
  <span class="hljs-attr">stroke</span>: <span class="hljs-literal">true</span>   <span class="hljs-comment">// 启用边框</span>
})
</code></pre>
<h4 data-id="heading-8">5. 事件</h4>
<p>事件是啥呢，比如，我绘制完会走哪个函数，选中会走那个函数，修改之后会走哪个函数等等。</p>
<p>我们可以写一个函数绑定这些事件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 绑定事件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">bindEvents</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 绘制完成回调监听</span>
  gMap.<span class="hljs-property">value</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'drawDone'</span>, <span class="hljs-function">(<span class="hljs-params">type, data</span>) =&gt;</span> {
    <span class="hljs-title function_">createAnnotation</span>(type, data)  <span class="hljs-comment">// 走了一个函数</span>
  })
  <span class="hljs-comment">// 要素选中回调监听(非PAN模式下双击选中)</span>
  gMap.<span class="hljs-property">value</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'featureSelected'</span>, <span class="hljs-function">(<span class="hljs-params">feature</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (feature) { gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">setActiveFeature</span>(feature) }
  })
  <span class="hljs-comment">// 要素取消选中回调监听(选中后点击其他位置取消选中)</span>
  gMap.<span class="hljs-property">value</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'featureUnselected'</span>, <span class="hljs-function">() =&gt;</span> {
    gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">setActiveFeature</span>(<span class="hljs-literal">null</span>)
  })
  <span class="hljs-comment">// 要素更新回调监听(选中后编辑完成回调)</span>
  gMap.<span class="hljs-property">value</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'featureUpdated'</span>, <span class="hljs-function">(<span class="hljs-params">feature, shape</span>) =&gt;</span> {
    feature.<span class="hljs-title function_">updateShape</span>(shape)
  })
}
</code></pre>
<p>我们开启绘制之后，绘制完一松手发现框框没了，因为我们没有绘制上去，所以我们在绘制完成之后的回调里面，获得了绘制的数据，然后把这个数据自己手写一个框框放到图层上面去：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加要素</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createAnnotation</span> = (<span class="hljs-params">type, shape</span>) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-string">`<span class="hljs-subst">${type}</span>_<span class="hljs-subst">${uuid4()}</span>`</span>  <span class="hljs-comment">// 随机ID</span>
  <span class="hljs-keyword">let</span> feature = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">let</span> style = {
    <span class="hljs-attr">strokeStyle</span>: <span class="hljs-string">'#409EFF'</span>,  <span class="hljs-comment">// 设置边框颜色</span>
 		<span class="hljs-attr">lineWidth</span>: <span class="hljs-number">2</span>,   <span class="hljs-comment">// 设置边框宽度</span>
    <span class="hljs-attr">fillStyle</span>: <span class="hljs-string">'#409EFF44'</span>,   <span class="hljs-comment">// 设置填充颜色</span>
    <span class="hljs-attr">fill</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 启用填充</span>
    <span class="hljs-attr">stroke</span>: <span class="hljs-literal">true</span>   <span class="hljs-comment">// 启用边框</span>
  }
  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'RECT'</span>) {   <span class="hljs-comment">// 绘制矩形</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Rect</span>(id, shape, <span class="hljs-literal">null</span>, style)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'CIRCLE'</span>) {  <span class="hljs-comment">// 绘制圆形</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Circle</span>(id, shape, <span class="hljs-literal">null</span>, style)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'POLYGON'</span>) {  <span class="hljs-comment">// 绘制多边形</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Polygon</span>(id, { <span class="hljs-attr">points</span>: shape }, <span class="hljs-literal">null</span>, style)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'POINT'</span>) {  <span class="hljs-comment">// 绘制点</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Point</span>(id, shape, <span class="hljs-literal">null</span>, style)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'LINE'</span>) {   <span class="hljs-comment">// 绘制线</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Line</span>(id, shape, <span class="hljs-literal">null</span>, style)
  }
  gFeatureLayer.<span class="hljs-property">value</span>.<span class="hljs-title function_">addFeature</span>(feature)
  <span class="hljs-keyword">return</span> feature;
}
</code></pre>
<p>然后就可以了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acd4b27437f4493e8fb6f0711774ae71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081520&amp;x-signature=KWeIW3cwZWib8UY%2BfcG%2BwOdXgHA%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 编码技巧篇（内部分享）]]></title>    <link>https://juejin.cn/post/7586663700901019657</link>    <guid>https://juejin.cn/post/7586663700901019657</guid>    <pubDate>2025-12-23T07:56:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586663700901019657" data-draft-id="7586663700900773897" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 编码技巧篇（内部分享）"/> <meta itemprop="keywords" content="AI编程,前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-23T07:56:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="俊劫"/> <meta itemprop="url" content="https://juejin.cn/user/3386151545609837"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 编码技巧篇（内部分享）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3386151545609837/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    俊劫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:56:58.000Z" title="Tue Dec 23 2025 07:56:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>演讲 PPT 也是 AI 生成的</p>
<p>还有个manus在线版：<a href="https://link.juejin.cn?target=https%3A%2F%2Faicoding-ee5dej8g.manus.space" target="_blank" title="https://aicoding-ee5dej8g.manus.space" ref="nofollow noopener noreferrer">aicoding-ee5dej8g.manus.space</a></p>
<p>很久没发文章了，不知道还有没有人看</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba98db3f9025414c9521306aba33c49c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-K5Yqr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081418&amp;x-signature=XRtA4WVAj2XV0qmPtXqgnAoI9WQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0898c41397ac4596aa68a2faa4d40254~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-K5Yqr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081418&amp;x-signature=GDELGVwDbHb2sq48mZsVLuLPq6o%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">1. AI发展</h2>
<p>AI 人工智能（artificial intelligence）</p>
<h3 data-id="heading-1">1.1. Transformer 架构</h3>
<pre><code class="hljs language-text" lang="text">输入: "LLM是什么"
    ↓
[Tokenization] → 切分成词元: ["LLM", "是", "什么"]
    ↓
[Embedding] → 转换为数字向量
    ↓
[Self-Attention] → 理解词与词之间的关系（关键！）
    ↓
[前馈网络] → 多层处理
    ↓
[输出层] → 预测下一个词的概率分布
    ↓
输出: "LLM是大语言模型..."

</code></pre>
<h3 data-id="heading-2">1.2. 5 大阶段</h3>
<p>L1：聊天机器人，具有对话能力的AI，ChatGPT。</p>
<p>L2：推理者，像人类一样能够解决问题的AI，深度思考，DeepSeek。</p>
<p>L3：智能体，不仅能思考，还可以采取行动的AI系统，Agent。</p>
<p>L4：创新者，能够协助发明创造的AI。 AI医药发明</p>
<p>L5：组织者，可以完成组织工作的AI。钢铁侠贾维斯</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b19a6298c82a4e6bafb665dbf3e244e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-K5Yqr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081418&amp;x-signature=p1Ol1DPEC46q6XYPopP2H2L45Kg%3D" alt="" loading="lazy"/></p>
<p>对于我们开发者来说，目前主要接触的是 L1-L3 阶段。L1 就是日常问答，L2 是代码推理和debug，L3 就是 Cursor Agent、Warp Agent 这类能直接改代码跑命令的工具。</p>
<h2 data-id="heading-3">2. Prompt</h2>
<h3 data-id="heading-4">2.1. 需不需要学习？</h3>
<blockquote>
<p>AI 提示词需要学习吗？总是说AI prompt很重要，然后要教学怎么写，我用ai的话，我直接问你需要哪些信息不就行了，为什么要专门去学这些，而且效果还不一定好</p>
</blockquote>
<p><strong>直接问 vs 主动学习的区别</strong></p>
<blockquote>
<p>1、被动 vs 主动的效率差异</p>
</blockquote>
<blockquote>
<p>◦ 你每次都需要我来引导你补充信息，这增加了交互轮次</p>
</blockquote>
<blockquote>
<p>◦ 如果你懂基本原理，可以一次把关键信息都给我，减少往返</p>
</blockquote>
<blockquote>
<p>2、质量差异</p>
</blockquote>
<blockquote>
<p>◦ 一个好 prompt 能让我理解你的真实需求，而不是表面需求</p>
</blockquote>
<blockquote>
<p>◦ 比如你说"帮我优化代码"，我可能问半天——但如果你说"我的 API 响应时间 800ms，希望降到 200ms，瓶颈在数据库查询"，我直接能给出有针对性的方案</p>
</blockquote>
<blockquote>
<p>3、你能做 AI 做不了的</p>
</blockquote>
<blockquote>
<p>◦ AI 可以回答问题，但只有你知道你真正的约束条件（时间、成本、技术栈限制等）</p>
</blockquote>
<blockquote>
<p>◦ 如果你能清楚地表达这些，结果会好得多</p>
</blockquote>
<h3 data-id="heading-5">2.2. 套路实践</h3>
<ul>
<li>
<p>我是谁，什么身份</p>
</li>
<li>
<p>我要做什么，现状是什么</p>
</li>
<li>
<p>我问题的相关上下文有哪些</p>
</li>
<li>
<p>我希望能做到什么效果</p>
</li>
<li>
<p>需求确认</p>
</li>
</ul>
<p>eg：</p>
<p>我是一名前端开发，我现在要通过图片生成前端页面，现在只有一个模板页面。我的需求都写在当前目录的 prd.md中，我希望你能尽可能高的还原我的需求+图片设计。</p>
<p>评估下还有什么需要我补充的信息吗？如果没有，请直接开始</p>
<pre><code class="hljs language-line" lang="line">prd.md

结合现有系统的规范和当前目录下的图片，实现如下需求

通用要求：
- UI 不用按照图片的，参考departureTask/index.tsx的实现
- 规范参考当前子应用的apps/stationSystem/CLAUDE.md
- 接口先本地 mock，后续和后端进行接口联调
- 不需要写项目说明，直接实现即可

评估下还有什么需要我补充的信息吗？如果没有，请直接开始

[列表页]
- 使用系统组件：GeneralPage，导出、新建按钮等

[删除]
- 需要二次确认弹窗

</code></pre>
<h4 data-id="heading-6">2.2.1. 我是谁</h4>
<blockquote>
<p>我是一名前端开发，我是一名资深前端开发，我是一名前端架构师</p>
</blockquote>
<p><strong>举个例子</strong></p>
<pre><code class="hljs language-line" lang="line">任务：实现一个用户列表

•  "前端开发" → 我给你一个完整的组件 + 详细注释
•  "资深前端开发" → 我给你代码 + 简单说明，假设你知道怎么集成
•  "前端架构师" → 我会先问你：
	◦  这个列表未来会复用吗？
	◦  数据层怎么设计？
	◦  要不要做虚拟滚动？
	◦  然后给你一个分层清晰的方案


</code></pre>
<h4 data-id="heading-7">2.2.2. 我要做什么</h4>
<p>我现在要通过图片生成前端页面，现在只有一个模板页面。我的需求都写在当前目录的 prd.md中，我希望你能尽可能高的还原我的需求+图片设计。</p>
<p>优化后</p>
<blockquote>
<p>我现在要根据设计图（./design.png）和需求文档（./prd.md）生成前端页面，实现模板参考（./departureTask/index.tsx）。我希望你能尽可能高的还原需求</p>
</blockquote>
<h4 data-id="heading-8">2.2.3. 需求确认</h4>
<blockquote>
<p>评估下还有什么需要我补充的信息吗？如果没有，请直接开始</p>
</blockquote>
<p><strong>优化后</strong></p>
<blockquote>
<p>版本 1：平衡型（推荐）</p>
</blockquote>
<blockquote>
<blockquote>
<p>有缺少的关键信息吗？如果有请直接问，如果没有就开始吧。</p>
</blockquote>
</blockquote>
<blockquote>
<p>• 更简洁</p>
</blockquote>
<blockquote>
<p>• "关键"二字暗示：别问可有可无的细节</p>
</blockquote>
<blockquote>
<p>• 语气更直接</p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>版本 2：强制检查型</p>
</blockquote>
<blockquote>
<blockquote>
<p>开始前确认：有什么信息缺失会影响实现？</p>
</blockquote>
</blockquote>
<blockquote>
<p>• 强迫 AI 思考"会影响实现"的信息，威胁 AI，说一些严重的后果</p>
</blockquote>
<blockquote>
<p>• 适合复杂任务</p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>版本 3：极简型</p>
</blockquote>
<blockquote>
<blockquote>
<p>开始前确认：有什么信息缺失会影响实现？</p>
</blockquote>
</blockquote>
<blockquote>
<p>• 最干脆，适合你已经很清楚自己提供的信息够不够的时候</p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>版本 4：去掉小尾巴</p>
</blockquote>
<blockquote>
<p>直接不加，让 AI 自己判断问还是做</p>
</blockquote>
<blockquote>
<p>• 如果你的 prompt 已经很完整，AI 会直接开始</p>
</blockquote>
<blockquote>
<p>• 如果真的缺信息，AI 自然会问</p>
</blockquote>
<blockquote>
<p>• 风险：可能多一轮对话</p>
</blockquote>
<h2 data-id="heading-9">3. Cost</h2>
<p>用AI写代码最肉疼的就是token消耗，尤其是用 Claude 这类贵的模型。分享几个省钱的套路：</p>
<h4 data-id="heading-10">3.1. 分层策略</h4>
<p>别什么问题都用最贵的模型。我的习惯是：</p>
<ul>
<li>
<p><strong>简单问答、格式转换、写注释</strong>：用便宜的模型，DeepSeek、GPT-4o-mini、Claude Haiku 都行，各种 IDE 都有 Auto 模式</p>
</li>
<li>
<p><strong>复杂逻辑、架构设计、疑难debug</strong>：Claude Sonnet 4.5、Gemini 3 Pro</p>
</li>
<li>
<p><strong>特别复杂的问题</strong>：Claude Opus 4.5、Gpt 5.2、Gemini 3 Pro （thinking）</p>
</li>
</ul>
<h4 data-id="heading-11">3.2. 减少上下文</h4>
<p>上下文越长，消耗越大。几个技巧：</p>
<ul>
<li>
<p>新开会话处理新问题，别在一个对话里聊八百件事</p>
</li>
<li>
<p>只贴相关代码，别把整个文件扔进去</p>
</li>
<li>
<p>用 <code>@</code> 符号精确引用文件（Cursor里），而不是手动复制粘贴</p>
</li>
<li>
<p>定期总结对话，让AI记住关键点后清理历史</p>
</li>
<li>
<p>多次提交代码，避免幻觉混乱返工</p>
</li>
</ul>
<h4 data-id="heading-12">3.3. 多种 IDE 结合</h4>
<ul>
<li>
<p>warp 目前用户较少，激活器模式无限 Token</p>
</li>
<li>
<p>国际：Cursor、Windsurf、Antigravity、Kiro</p>
</li>
<li>
<p>国内：Trae、Qoder</p>
</li>
</ul>
<h2 data-id="heading-13">4. 模型</h2>
<h3 data-id="heading-14">4.1. 代码场景推荐</h3>
<h4 data-id="heading-15">4.1.1. 国际模型</h4>



































<table><thead><tr><th>场景</th><th>推荐模型</th><th>原因</th></tr></thead><tbody><tr><td>高精度代码生成 / 疑难杂症</td><td>Opus 4.5</td><td>在 SWE-Bench 等代码基准上表现顶尖</td></tr><tr><td>分析大量设计文档 + 代码 + 图像原型</td><td>Gemini 3 Pro</td><td>超大上下文 + 多模态</td></tr><tr><td>持续 agent 工作流 / 长任务</td><td>Sonnet 4.5</td><td>连贯性、稳定推理</td></tr><tr><td>万能通用助手 / 成本敏感</td><td>GPT-5.x</td><td>性能与价格最优均衡</td></tr><tr><td>简单客服 / FAQ / 内容生成</td><td>较小模型足够</td><td>不需要用旗舰</td></tr></tbody></table>
<h4 data-id="heading-16">4.1.2. 国内模型</h4>
<ul>
<li>
<p><strong>DeepSeek</strong>：性价比之王，API价格是 OpenAI 的几十分之一，代码能力在线</p>
</li>
<li>
<p><strong>通义千问(Qwen)</strong>：阿里出的，开源模型质量高，可以本地跑</p>
</li>
<li>
<p><strong>Kimi</strong>：长上下文做得好，适合分析长文档</p>
</li>
<li>
<p><strong>豆包</strong>：便宜，日常够用</p>
</li>
</ul>
<h4 data-id="heading-17">4.1.3. 结论</h4>
<blockquote>
<p>D 档走天下，Auto 超省心</p>
</blockquote>
<ul>
<li>
<p>别迷信benchmark，实际用起来差别没那么大</p>
</li>
<li>
<p>不同模型有不同的"性格"，Claude 比较谨慎，GPT 比较敢写</p>
</li>
<li>
<p>复杂项目建议固定一个模型，它会更好地理解你的代码风格</p>
</li>
<li>
<p>遇到某个模型死活搞不定的问题，换一个模型试试 or 换一种 prompt，不要在幻觉中找方案</p>
</li>
</ul>
<h2 data-id="heading-18">5. 项目开发技巧</h2>
<h4 data-id="heading-19">5.1. 给AI建立项目上下文</h4>
<p>在项目根目录创建 <code>CLAUDE.md</code> 或 <code>README.md</code>或 <code>.cursorrules</code></p>
<pre><code class="hljs language-line" lang="line"># 项目规范

## 技术栈
- React 18 + TypeScript
- Ant Design 5.x

## 代码规范
- 组件用函数式，不用 class
- 样式用 CSS Modules
- 接口类型定义放 types/ 目录

## 项目结构
- src/components 通用组件
- src/pages 页面
- src/services API 调用


</code></pre>
<p>有了这个文件，AI 生成的代码会更符合项目规范，省得每次都要说一遍。</p>
<h4 data-id="heading-20">5.2. 增量开发而不是一次性生成</h4>
<p>别想着一句话让AI把整个功能写完。更好的方式：</p>
<ol>
<li>
<p>先让AI写个骨架/伪代码</p>
</li>
<li>
<p>review一下思路对不对</p>
</li>
<li>
<p>逐步填充具体实现</p>
</li>
<li>
<p>每一步都跑一下看看有没有问题</p>
</li>
</ol>
<p>这样出问题容易定位，也不容易跑偏。</p>
<h4 data-id="heading-21">5.3. 善用报错信息</h4>
<p>遇到报错，直接把完整的错误信息贴给AI，比你自己描述"它报错了"有用100倍。包括：</p>
<ul>
<li>完整的 error stack</li>
<li>相关的代码片段</li>
<li>你做了什么操作触发的</li>
</ul>
<h4 data-id="heading-22">5.4. Code Review 让AI来</h4>
<p>写完代码可以让AI帮忙 review：</p>
<pre><code class="hljs language-line" lang="line">帮我review一下这段代码，重点看：
1. 有没有潜在的bug
2. 性能有没有问题
3. 有没有更简洁的写法
4. 可维护性怎么样
5. 和其他模块通用部分抽离了没等等

</code></pre>
<h4 data-id="heading-23">5.5. 调试</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2a1f3952e064751b8a39d0a80b3fa87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-K5Yqr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081418&amp;x-signature=wE6BtP4RE1n3z%2BE%2BiFd7YKogjY0%3D" alt="" loading="lazy"/></p>
<p>与其问"为什么不工作"，不如：</p>
<ul>
<li>
<p>描述期望的行为</p>
</li>
<li>
<p>描述实际的行为</p>
</li>
<li>
<p>贴上相关代码和报错</p>
</li>
</ul>
<pre><code class="hljs language-line" lang="line">期望：点击按钮后弹窗关闭
实际：弹窗没有关闭，控制台没有报错
代码：[贴代码]
我已经确认 handleClose 函数被调用了（加了console.log）

</code></pre>
<h2 data-id="heading-24">6. 各种 好玩的AI</h2>
<ul>
<li>
<p>comfyUI - 图像生成工作流，比直接用 SD 灵活</p>
</li>
<li>
<p>nano banana pro - 基于 Gemini 3 Pro 的图像生成</p>
</li>
<li>
<p>AI 医药</p>
</li>
<li>
<p>AI 显卡</p>
</li>
<li>
<p>AI 储能</p>
<ul>
<li>核能</li>
<li>AI 数据中心送上天，太阳能</li>
</ul>
</li>
<li>
<p>AI 自动驾驶</p>
</li>
<li>
<p>Manus现状</p>
<ul>
<li>2025年3月，Manus一码难求；2025年7月，Manus在中国归于沉寂</li>
</ul>
</li>
<li>
<p>豆包手机</p>
<ul>
<li>首发搭载于努比亚M153工程样机,售价3499元</li>
<li>微信封杀</li>
<li>罗永浩力挺</li>
</ul>
</li>
<li>
<p>AotuGLM</p>
<ul>
<li>开源，可以自己部署一个全自动化手机</li>
</ul>
</li>
<li>
<p>AI 电影</p>
<ul>
<li>升级</li>
<li>黑客帝国（1～3）</li>
<li>我，机器人</li>
<li>攻壳机动队</li>
</ul>
</li>
<li>
<p>本地大模型 / 推理框架（离线、隐私、可控）</p>
<ul>
<li>Ollama - 一键拉取 + 本地运行模型</li>
<li>LM Studio - 本地模型 GUI + OpenAI 兼容接口</li>
<li>llama.cpp - 量化部署（CPU/GPU 都能跑）</li>
<li>vLLM - 高吞吐推理服务（适合自建 API）</li>
</ul>
</li>
<li>
<p>RAG / 知识库（让 AI “查资料再回答”）</p>
<ul>
<li>LangChain / LlamaIndex - 快速搭建检索增强应用</li>
<li>向量数据库：Milvus / Qdrant / Weaviate</li>
<li>Reranker：bge-reranker 等（提升检索排序质量）</li>
</ul>
</li>
<li>
<p>Agent / 自动化（让 AI 真的去做事）</p>
<ul>
<li>OpenHands / Aider - 让 AI 在仓库里改代码、跑命令、修 bug</li>
<li>Playwright + LLM - 自动化浏览器回归测试、抓取、脚本任务</li>
<li>Atlas 浏览器</li>
</ul>
</li>
<li>
<p>视频 / 音频（内容生产力工具链）</p>
<ul>
<li>视频生成：Runway / Pika / Luma / 可灵（Kling）</li>
<li>语音转文字：Whisper / FunASR</li>
<li>语音合成：TTS 工具（配合播客、旁白、客服）</li>
</ul>
</li>
<li>
<p>Claude SKILLS</p>
</li>
<li>
<p>Vibe Coding</p>
</li>
<li>
<p>Gemini Opal gems</p>
</li>
<li>
<p>Trae Solo Dev</p>
</li>
<li>
<p>Qoder Quest</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-25">7. 最后</h2>
<p>工具再好也只是工具。AI 能帮你提效，但不能替你思考架构、理解业务。最值得投入的还是自己的基本功：对语言特性的理解、对设计模式的掌握、对业务的熟悉程度。</p>
<p>AI 是放大器，你本身的能力决定了放大后的上限。</p>
<blockquote>
<p>有问题欢迎交流</p>
<p>爱你的俊劫</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux进程排查实战：strace和lsof救命指南]]></title>    <link>https://juejin.cn/post/7586615716906418176</link>    <guid>https://juejin.cn/post/7586615716906418176</guid>    <pubDate>2025-12-23T06:01:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586615716906418176" data-draft-id="7586615716906385408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux进程排查实战：strace和lsof救命指南"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2025-12-23T06:01:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="嘻哈baby"/> <meta itemprop="url" content="https://juejin.cn/user/485305583405066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux进程排查实战：strace和lsof救命指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/485305583405066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    嘻哈baby
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:01:07.000Z" title="Tue Dec 23 2025 06:01:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>服务起不来，日志没报错。进程在跑，但就是不干活。</p>
<p>这种问题最恶心，看日志看不出问题，看监控也没异常。</p>
<p>这时候就需要strace和lsof这两个神器了。</p>
<h2 data-id="heading-0">strace：跟踪系统调用</h2>
<p>strace能看到进程在做什么系统调用，相当于给进程装了个监控摄像头。</p>
<h3 data-id="heading-1">基本用法</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 跟踪一个命令</span>
strace <span class="hljs-built_in">ls</span>

<span class="hljs-comment"># 跟踪正在运行的进程</span>
strace -p &lt;pid&gt;

<span class="hljs-comment"># 跟踪子进程</span>
strace -f -p &lt;pid&gt;
</code></pre>
<h3 data-id="heading-2">案例一：服务启动卡住</h3>
<p>现象：Java服务启动后卡住，不打印任何日志。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 找到进程号</span>
ps aux | grep java
<span class="hljs-comment"># 假设是12345</span>

<span class="hljs-comment"># strace跟踪</span>
strace -p 12345
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">futex</span>(<span class="hljs-number">0x7f8a8c000000</span>, FUTEX_WAIT_PRIVATE, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>
</code></pre>
<p>卡在futex，说明在等锁。</p>
<p>进一步看是什么锁：</p>
<pre><code class="hljs language-bash" lang="bash">strace -p 12345 -e trace=futex -T
</code></pre>
<p>结合jstack看线程栈：</p>
<pre><code class="hljs language-bash" lang="bash">jstack 12345 &gt; thread.dump
grep -A 20 <span class="hljs-string">"BLOCKED"</span> thread.dump
</code></pre>
<p>发现是启动时连接数据库，数据库连不上，超时时间设太长了。</p>
<h3 data-id="heading-3">案例二：文件读写问题</h3>
<p>现象：服务很慢，但CPU和内存都不高。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 只看文件相关的调用</span>
strace -p 12345 -e trace=file

<span class="hljs-comment"># 或者看所有IO</span>
strace -p 12345 -e trace=<span class="hljs-built_in">read</span>,write,open,close
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">open</span>("/data/logs/app.log", O_WRONLY|O_APPEND) = <span class="hljs-number">3</span>
<span class="hljs-built_in">write</span>(<span class="hljs-number">3</span>, "<span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">23</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> INFO...", <span class="hljs-number">1024</span>) = <span class="hljs-number">1024</span>
<span class="hljs-built_in">close</span>(<span class="hljs-number">3</span>) = <span class="hljs-number">0</span>
<span class="hljs-built_in">open</span>("/data/logs/app.log", O_WRONLY|O_APPEND) = <span class="hljs-number">3</span>
<span class="hljs-built_in">write</span>(<span class="hljs-number">3</span>, "<span class="hljs-number">2024</span>-<span class="hljs-number">12</span>-<span class="hljs-number">23</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> INFO...", <span class="hljs-number">1024</span>) = <span class="hljs-number">1024</span>
<span class="hljs-built_in">close</span>(<span class="hljs-number">3</span>) = <span class="hljs-number">0</span>
...
</code></pre>
<p>每次写日志都open-write-close，频繁的文件操作导致性能差。</p>
<p>改成保持文件句柄打开，或者用异步日志。</p>
<h3 data-id="heading-4">案例三：网络问题</h3>
<p>现象：服务偶尔超时。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 只看网络相关</span>
strace -p 12345 -e trace=network -T
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">connect</span>(<span class="hljs-number">5</span>, {sa_family=AF_INET, sin_port=htons(<span class="hljs-number">3306</span>), sin_addr=<span class="hljs-built_in">inet_addr</span>("<span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span>")}, <span class="hljs-number">16</span>) = -<span class="hljs-number">1</span> ETIMEDOUT (Connection timed out) &lt;<span class="hljs-number">30.001234</span>&gt;
</code></pre>
<p>连接数据库超时30秒，问题找到了。</p>
<h3 data-id="heading-5">常用参数</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># -f：跟踪子进程</span>
strace -f -p 12345

<span class="hljs-comment"># -T：显示每个调用耗时</span>
strace -T -p 12345

<span class="hljs-comment"># -t：显示时间戳</span>
strace -t -p 12345

<span class="hljs-comment"># -c：统计系统调用次数和耗时</span>
strace -c -p 12345

<span class="hljs-comment"># -o：输出到文件</span>
strace -o trace.log -p 12345

<span class="hljs-comment"># 组合使用</span>
strace -f -T -t -o trace.log -p 12345
</code></pre>
<h3 data-id="heading-6">统计分析</h3>
<pre><code class="hljs language-bash" lang="bash">strace -c -p 12345
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-lua" lang="lua">% <span class="hljs-built_in">time</span>     seconds  usecs/call     calls    errors syscall
<span class="hljs-comment">------ ----------- ----------- --------- --------- ----------------</span>
 <span class="hljs-number">45.23</span>    <span class="hljs-number">2.345678</span>         <span class="hljs-number">234</span>     <span class="hljs-number">10000</span>           <span class="hljs-built_in">write</span>
 <span class="hljs-number">30.12</span>    <span class="hljs-number">1.234567</span>        <span class="hljs-number">1234</span>      <span class="hljs-number">1000</span>           <span class="hljs-built_in">read</span>
 <span class="hljs-number">20.11</span>    <span class="hljs-number">0.987654</span>          <span class="hljs-number">98</span>     <span class="hljs-number">10000</span>           futex
  <span class="hljs-number">4.54</span>    <span class="hljs-number">0.234567</span>          <span class="hljs-number">23</span>     <span class="hljs-number">10000</span>           clock_gettime
<span class="hljs-comment">------ ----------- ----------- --------- --------- ----------------</span>
<span class="hljs-number">100.00</span>    <span class="hljs-number">4.802466</span>                 <span class="hljs-number">31000</span>           total
</code></pre>
<p>一眼就能看出时间花在哪了。</p>
<h2 data-id="heading-7">lsof：列出打开的文件</h2>
<p>Linux里一切皆文件，lsof能看到进程打开了什么文件、网络连接、设备等。</p>
<h3 data-id="heading-8">基本用法</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看进程打开的所有文件</span>
lsof -p &lt;pid&gt;

<span class="hljs-comment"># 查看某个文件被谁打开</span>
lsof /var/log/app.log

<span class="hljs-comment"># 查看某个端口</span>
lsof -i :8080

<span class="hljs-comment"># 查看某个用户的所有打开文件</span>
lsof -u root
</code></pre>
<h3 data-id="heading-9">案例一：端口被占用</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 谁占用了8080端口</span>
lsof -i :8080
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-sql" lang="sql">COMMAND   PID <span class="hljs-keyword">USER</span>   FD   TYPE DEVICE SIZE<span class="hljs-operator">/</span>OFF NODE NAME
java    <span class="hljs-number">12345</span> root  <span class="hljs-number">123</span>u  IPv6 <span class="hljs-number">123456</span>      <span class="hljs-number">0</span>t0  TCP <span class="hljs-operator">*</span>:<span class="hljs-number">8080</span> (LISTEN)
</code></pre>
<p>进程12345占用了8080端口。</p>
<h3 data-id="heading-10">案例二：文件句柄泄漏</h3>
<p>现象：服务运行一段时间后报"Too many open files"。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看进程打开的文件数</span>
lsof -p 12345 | <span class="hljs-built_in">wc</span> -l

<span class="hljs-comment"># 按文件类型分组统计</span>
lsof -p 12345 | awk <span class="hljs-string">'{print $5}'</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -rn
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">5000 </span><span class="hljs-string">IPv4</span>
   <span class="hljs-number">3000 </span><span class="hljs-string">REG</span>
   <span class="hljs-number">1000 </span><span class="hljs-string">DIR</span>
</code></pre>
<p>5000个网络连接？明显有连接泄漏。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 看看都连了谁</span>
lsof -p 12345 -i | <span class="hljs-built_in">head</span> -20
</code></pre>
<pre><code class="hljs language-rust" lang="rust">COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
java    <span class="hljs-number">12345</span> root  <span class="hljs-number">123</span>u  IPv4 <span class="hljs-number">123456</span>      <span class="hljs-number">0</span>t0  TCP <span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">54321</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">10.0</span>.<span class="hljs-number">0.2</span>:<span class="hljs-number">3306</span> (ESTABLISHED)
java    <span class="hljs-number">12345</span> root  <span class="hljs-number">124</span>u  IPv4 <span class="hljs-number">123457</span>      <span class="hljs-number">0</span>t0  TCP <span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">54322</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">10.0</span>.<span class="hljs-number">0.2</span>:<span class="hljs-number">3306</span> (ESTABLISHED)
java    <span class="hljs-number">12345</span> root  <span class="hljs-number">125</span>u  IPv4 <span class="hljs-number">123458</span>      <span class="hljs-number">0</span>t0  TCP <span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">54323</span><span class="hljs-punctuation">-&gt;</span><span class="hljs-number">10.0</span>.<span class="hljs-number">0.2</span>:<span class="hljs-number">3306</span> (ESTABLISHED)
...
</code></pre>
<p>全是连数据库的，连接池用完没归还。</p>
<h3 data-id="heading-11">案例三：删除的文件还在占用空间</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看已删除但仍被引用的文件</span>
lsof +L1
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-c" lang="c">COMMAND   PID USER   FD   TYPE DEVICE    SIZE/OFF NLINK  NODE NAME
java    <span class="hljs-number">12345</span> root   <span class="hljs-number">10</span>w   REG  <span class="hljs-number">253</span>,<span class="hljs-number">1</span> <span class="hljs-number">10737418240</span>     <span class="hljs-number">0</span> <span class="hljs-number">12345</span> /var/<span class="hljs-built_in">log</span>/app.<span class="hljs-built_in">log</span> (deleted)
</code></pre>
<p>日志文件被删了，但进程还引用着，10G空间释放不掉。</p>
<p>解决：重启服务，或者truncate文件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 找到文件描述符路径</span>
<span class="hljs-built_in">ls</span> -l /proc/12345/fd/10
<span class="hljs-comment"># 清空内容但不关闭句柄</span>
: &gt; /proc/12345/fd/10
</code></pre>
<h3 data-id="heading-12">案例四：网络连接分析</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看所有网络连接</span>
lsof -i

<span class="hljs-comment"># 只看TCP</span>
lsof -i tcp

<span class="hljs-comment"># 只看某个状态</span>
lsof -i | grep ESTABLISHED

<span class="hljs-comment"># 统计连接数</span>
lsof -i | grep ESTABLISHED | <span class="hljs-built_in">wc</span> -l

<span class="hljs-comment"># 按目标地址分组</span>
lsof -i | grep ESTABLISHED | awk <span class="hljs-string">'{print $9}'</span> | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">'&gt;'</span> -f2 | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">':'</span> -f1 | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c | <span class="hljs-built_in">sort</span> -rn
</code></pre>
<h2 data-id="heading-13">组合使用</h2>
<h3 data-id="heading-14">排查思路</h3>
<ol>
<li><strong>先用top/htop看整体</strong></li>
<li><strong>用ps看进程状态</strong></li>
<li><strong>用lsof看打开了什么</strong></li>
<li><strong>用strace看在做什么</strong></li>
</ol>
<h3 data-id="heading-15">实战：服务假死排查</h3>
<p>现象：服务进程在，但不响应请求。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 看进程状态</span>
ps aux | grep java
<span class="hljs-comment"># 状态是Sl，正常</span>

<span class="hljs-comment"># 2. 看打开的文件和连接</span>
lsof -p 12345 | <span class="hljs-built_in">wc</span> -l
<span class="hljs-comment"># 8000+，有点多</span>

<span class="hljs-comment"># 3. 看网络连接</span>
lsof -p 12345 -i | grep -c ESTABLISHED
<span class="hljs-comment"># 5000+，太多了</span>

<span class="hljs-comment"># 4. 看连接状态分布</span>
ss -tnp | grep 12345 | awk <span class="hljs-string">'{print $4}'</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c
<span class="hljs-comment"># 大量CLOSE_WAIT</span>

<span class="hljs-comment"># 5. strace看在做什么</span>
strace -p 12345 -e trace=network
<span class="hljs-comment"># 卡在accept上，但新连接进不来</span>
</code></pre>
<p>根因：连接池满了，CLOSE_WAIT状态的连接没有正确关闭。</p>
<h3 data-id="heading-16">实战：CPU 100%排查</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. top找到占用CPU的进程</span>
top -c
<span class="hljs-comment"># PID 12345 CPU 99%</span>

<span class="hljs-comment"># 2. 看线程CPU使用</span>
top -H -p 12345
<span class="hljs-comment"># TID 12346 CPU 99%</span>

<span class="hljs-comment"># 3. 把线程ID转成16进制</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">"%x\n"</span> 12346
<span class="hljs-comment"># 303a</span>

<span class="hljs-comment"># 4. jstack看线程栈（Java）</span>
jstack 12345 | grep -A 30 <span class="hljs-string">"0x303a"</span>

<span class="hljs-comment"># 5. 或者用strace看系统调用</span>
strace -p 12346 -c
</code></pre>
<h2 data-id="heading-17">远程排查</h2>
<p>有时候问题机器在远程，需要登录排查。</p>
<p>我们有几台服务器在不同机房，之前用跳板机一层层跳很麻烦。现在用星空组网把所有机器组到一起，直接SSH过去就能用strace、lsof排查，效率高多了。</p>
<h2 data-id="heading-18">常用命令速查</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># strace速查</span>
strace -p &lt;pid&gt;                    <span class="hljs-comment"># 跟踪进程</span>
strace -f -p &lt;pid&gt;                 <span class="hljs-comment"># 跟踪包括子进程</span>
strace -e trace=network -p &lt;pid&gt;   <span class="hljs-comment"># 只看网络</span>
strace -e trace=file -p &lt;pid&gt;      <span class="hljs-comment"># 只看文件</span>
strace -c -p &lt;pid&gt;                 <span class="hljs-comment"># 统计</span>
strace -T -p &lt;pid&gt;                 <span class="hljs-comment"># 显示耗时</span>

<span class="hljs-comment"># lsof速查</span>
lsof -p &lt;pid&gt;                      <span class="hljs-comment"># 进程打开的文件</span>
lsof -i :&lt;port&gt;                    <span class="hljs-comment"># 谁占用端口</span>
lsof -i tcp                        <span class="hljs-comment"># 所有TCP连接</span>
lsof +L1                           <span class="hljs-comment"># 已删除但仍占用的文件</span>
lsof -u &lt;user&gt;                     <span class="hljs-comment"># 用户打开的文件</span>
</code></pre>
<h2 data-id="heading-19">总结</h2>




















<table><thead><tr><th>工具</th><th>用途</th><th>典型场景</th></tr></thead><tbody><tr><td>strace</td><td>跟踪系统调用</td><td>卡死、慢、报错看不出原因</td></tr><tr><td>lsof</td><td>看打开的文件/连接</td><td>端口占用、文件泄漏、连接泄漏</td></tr></tbody></table>
<p>排查原则：</p>
<ol>
<li>从宏观到微观</li>
<li>从现象到根因</li>
<li>不确定就多看几遍</li>
</ol>
<p>这两个工具用熟了，大部分疑难杂症都能查出来。</p>
<hr/>
<p>有排查经验欢迎评论区分享~</p>
<pre><code class="hljs"/></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Dubbo跨机房调用实战：从原理到架构的完美解决方案]]></title>    <link>https://juejin.cn/post/7586617459487522868</link>    <guid>https://juejin.cn/post/7586617459487522868</guid>    <pubDate>2025-12-23T06:01:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586617459487522868" data-draft-id="7586622708998733864" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Dubbo跨机房调用实战：从原理到架构的完美解决方案"/> <meta itemprop="keywords" content="后端,Dubbo"/> <meta itemprop="datePublished" content="2025-12-23T06:01:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Dubbo跨机房调用实战：从原理到架构的完美解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:01:00.000Z" title="Tue Dec 23 2025 06:01:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、跨机房调用的核心挑战</h3>
<h4 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.1 [网络延迟]问题</h4>
<p>跨机房调用最直接的影响就是<strong>网络延迟</strong>。同一个机房内网络延迟通常在1ms以内，而跨机房延迟可能达到10-50ms，甚至更高！</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 模拟跨机房调用延迟对比</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NetworkLatencyDemo</span> {
    
    <span class="hljs-comment">// 同机房调用 - 延迟 &lt; 1ms</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sameIdcCall</span>()</span> {
        <span class="hljs-built_in">long</span> start = System.currentTimeMillis();
        <span class="hljs-comment">// 服务调用逻辑</span>
        doServiceCall();
        <span class="hljs-built_in">long</span> end = System.currentTimeMillis();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"同机房调用耗时: "</span> + (end - start) + <span class="hljs-string">"ms"</span>);
    }
    
    <span class="hljs-comment">// 跨机房调用 - 延迟 10-50ms</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">crossIdcCall</span>()</span> {
        <span class="hljs-built_in">long</span> start = System.currentTimeMillis();
        <span class="hljs-comment">// 跨机房网络传输</span>
        simulateNetworkLatency(<span class="hljs-number">20</span>);
        <span class="hljs-comment">// 服务调用逻辑</span>
        doServiceCall();
        <span class="hljs-built_in">long</span> end = System.currentTimeMillis();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"跨机房调用耗时: "</span> + (end - start) + <span class="hljs-string">"ms"</span>);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">simulateNetworkLatency</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> ms</span>)</span> {
        <span class="hljs-keyword">try</span> {
            Thread.sleep(ms);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doServiceCall</span>()</span> {
        <span class="hljs-comment">// 模拟业务处理</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">5</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}

AI写代码java
运行
<span class="hljs-number">12345678910111213141516171819202122232425262728293031323334353637383940</span>
</code></pre>
<h4 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2 数据一致性问题</h4>
<p>在分布式系统中，保证跨机房的数据一致性是一个重大挑战。我们需要考虑<strong>CAP理论</strong>中的权衡：</p>

























<table><thead><tr><th>特性</th><th>描述</th><th>跨机房影响</th></tr></thead><tbody><tr><td><strong>一致性(Consistency)</strong></td><td>所有节点看到的数据相同</td><td>跨机房网络分区时难以保证</td></tr><tr><td><strong>可用性(Availability)</strong></td><td>每个请求都能获得响应</td><td>机房故障时可能受影响</td></tr><tr><td><strong>分区容错性(Partition Tolerance)</strong></td><td>系统在网络分区时继续工作</td><td>跨机房场景必须保证</td></tr></tbody></table>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.3 容错与故障转移</h4>
<p>单个机房故障不应该影响整个系统。Dubbo提供了多种容错机制：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/485541b3b8124301973ace5da4e7a60e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074460&amp;x-signature=k9Zp3oJaJyJchMs5j5zrjBJktRc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二、Dubbo跨机房架构设计</h3>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.1 注册中心架构</h4>
<p>在跨机房场景下，注册中心的部署方式至关重要。推荐使用<strong>分区注册中心</strong>架构：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Dubbo注册中心配置示例</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegistryConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RegistryConfig</span> <span class="hljs-title function_">beijingRegistry</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">RegistryConfig</span> registry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegistryConfig</span>();
        registry.<span class="hljs-title function_">setId</span>(<span class="hljs-string">"beijing-registry"</span>);
        registry.<span class="hljs-title function_">setAddress</span>(<span class="hljs-string">"zookeeper://192.168.1.10:2181"</span>);
        registry.<span class="hljs-title function_">setParameters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt;() {{
            <span class="hljs-title function_">put</span>(<span class="hljs-string">"cluster"</span>, <span class="hljs-string">"beijing"</span>);
            <span class="hljs-title function_">put</span>(<span class="hljs-string">"zone"</span>, <span class="hljs-string">"north-china"</span>);
        }});
        <span class="hljs-keyword">return</span> registry;
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RegistryConfig</span> <span class="hljs-title function_">shanghaiRegistry</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">RegistryConfig</span> registry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegistryConfig</span>();
        registry.<span class="hljs-title function_">setId</span>(<span class="hljs-string">"shanghai-registry"</span>);
        registry.<span class="hljs-title function_">setAddress</span>(<span class="hljs-string">"zookeeper://192.168.2.10:2181"</span>);
        registry.<span class="hljs-title function_">setParameters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt;() {{
            <span class="hljs-title function_">put</span>(<span class="hljs-string">"cluster"</span>, <span class="hljs-string">"shanghai"</span>);
            <span class="hljs-title function_">put</span>(<span class="hljs-string">"zone"</span>, <span class="hljs-string">"east-china"</span>);
        }});
        <span class="hljs-keyword">return</span> registry;
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Service</span>(registry = {<span class="hljs-string">"beijing-registry"</span>, <span class="hljs-string">"shanghai-registry"</span>})
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">UserService</span> <span class="hljs-title function_">userService</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
    }
}

<span class="hljs-variable constant_">AI</span>写代码java
运行
<span class="hljs-number">12345678910111213141516171819202122232425262728293031323334</span>
</code></pre>
<h4 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.2 路由策略设计</h4>
<p>Dubbo提供了强大的路由能力，我们可以基于机房信息进行智能路由：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df0ae6ffe3904435b9fe118423018b89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074460&amp;x-signature=pcuaXnvpBcxfkV2aOZMIuxbtzPs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.3 服务治理策略</h4>
<p>跨机房环境下的服务治理需要特别关注：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 跨机房服务治理配置</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CrossIdcGovernance</span> </span>{
    
    <span class="hljs-comment">// 1. 负载均衡策略 - 优先本地机房</span>
    <span class="hljs-meta">@Reference</span>(loadbalance = <span class="hljs-string">"preferredIdcLoadBalance"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-type">OrderService</span> orderService;
    
    <span class="hljs-comment">// 2. 超时配置 - 跨机房调用需要更长的超时时间</span>
    <span class="hljs-meta">@Reference</span>(timeout = <span class="hljs-number">5000</span>, retries = <span class="hljs-number">2</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-type">PaymentService</span> paymentService;
    
    <span class="hljs-comment">// 3. 集群容错策略</span>
    <span class="hljs-meta">@Reference</span>(cluster = <span class="hljs-string">"failover"</span>, 
               parameters = {<span class="hljs-string">"crossIdc.failover"</span>, <span class="hljs-string">"true"</span>})
    <span class="hljs-keyword">private</span> <span class="hljs-type">InventoryService</span> inventoryService;
}

<span class="hljs-comment">// 自定义跨机房负载均衡器</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PreferredIdcLoadBalance</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractLoadBalance</span> </span>{
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> localIdc = <span class="hljs-type">System</span>.getProperty(<span class="hljs-string">"idc"</span>, <span class="hljs-string">"beijing"</span>);
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> &lt;<span class="hljs-type">T</span>&gt; <span class="hljs-type">Invoker</span>&lt;<span class="hljs-type">T</span>&gt; doSelect(<span class="hljs-type">List</span>&lt;<span class="hljs-type">Invoker</span>&lt;<span class="hljs-type">T</span>&gt;&gt; invokers, 
                                     <span class="hljs-type">URL</span> url, 
                                     <span class="hljs-type">Invocation</span> invocation) {
        <span class="hljs-comment">// 优先选择同机房服务</span>
        <span class="hljs-type">List</span>&lt;<span class="hljs-type">Invoker</span>&lt;<span class="hljs-type">T</span>&gt;&gt; localIdcInvokers = invokers.stream()
            .filter(invoker -&gt; localIdc.equals(invoker.getUrl().getParameter(<span class="hljs-string">"idc"</span>)))
            .collect(<span class="hljs-type">Collectors</span>.toList());
            
        <span class="hljs-keyword">if</span> (!localIdcInvokers.isEmpty()) {
            <span class="hljs-comment">// 同机房内使用随机负载均衡</span>
            <span class="hljs-keyword">return</span> randomSelect(localIdcInvokers);
        }
        
        <span class="hljs-comment">// 没有同机房服务，选择其他机房</span>
        <span class="hljs-keyword">return</span> randomSelect(invokers);
    }
}

<span class="hljs-type">AI</span>写代码java
运行
<span class="hljs-number">12345678910111213141516171819202122232425262728293031323334353637383940</span>
</code></pre>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>三、实战：Dubbo跨机房配置</h3>
<h4 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.1 环境准备与配置</h4>
<p>让我们通过一个完整的示例来配置Dubbo跨机房调用：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- dubbo-provider.xml 服务提供者配置 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hljs-attr">xmlns:dubbo</span>=<span class="hljs-string">"http://dubbo.apache.org/schema/dubbo"</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://dubbo.apache.org/schema/dubbo
       http://dubbo.apache.org/schema/dubbo/dubbo.xsd"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 北京机房应用配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"order-service"</span> <span class="hljs-attr">owner</span>=<span class="hljs-string">"team-bj"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:parameter</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"idc"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"beijing"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:parameter</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"region"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"north-china"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dubbo:application</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 多注册中心配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"beijing-registry"</span> 
                    <span class="hljs-attr">address</span>=<span class="hljs-string">"zookeeper://zk-bj1:2181?cluster=bj"</span>
                    <span class="hljs-attr">default</span>=<span class="hljs-string">"false"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"shanghai-registry"</span> 
                    <span class="hljs-attr">address</span>=<span class="hljs-string">"zookeeper://zk-sh1:2181?cluster=sh"</span>
                    <span class="hljs-attr">default</span>=<span class="hljs-string">"false"</span>/&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 协议配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:protocol</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dubbo"</span> <span class="hljs-attr">port</span>=<span class="hljs-string">"20880"</span> 
                    <span class="hljs-attr">server</span>=<span class="hljs-string">"netty"</span> <span class="hljs-attr">client</span>=<span class="hljs-string">"netty"</span>/&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 服务提供者配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:service</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">"com.example.OrderService"</span>
                   <span class="hljs-attr">ref</span>=<span class="hljs-string">"orderService"</span>
                   <span class="hljs-attr">registry</span>=<span class="hljs-string">"beijing-registry,shanghai-registry"</span>
                   <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0.0"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"createOrder"</span> <span class="hljs-attr">timeout</span>=<span class="hljs-string">"3000"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"queryOrder"</span> <span class="hljs-attr">timeout</span>=<span class="hljs-string">"1000"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dubbo:service</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"orderService"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.OrderServiceImpl"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>

AI写代码xml
1234567891011121314151617181920212223242526272829303132333435363738
</code></pre>
<h4 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.2 路由规则配置</h4>
<p>通过Dubbo的路由规则实现智能路由：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 动态路由规则配置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoutingRuleManager</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> void setupIdcRoutingRules() {
        <span class="hljs-comment">// 条件路由规则：优先调用同机房服务</span>
        <span class="hljs-type">String</span> conditionRule <span class="hljs-operator">=</span> 
            <span class="hljs-string">"{<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  "</span>scope<span class="hljs-string">": "</span>application<span class="hljs-string">",<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  "</span>key<span class="hljs-string">": "</span>order<span class="hljs-operator">-</span>service<span class="hljs-string">",<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  "</span>conditions<span class="hljs-string">": [<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"    "</span><span class="hljs-operator">=&gt;</span> \n<span class="hljs-string">" +
            "</span>    $[idc] <span class="hljs-operator">=</span> $[consumer.idc] <span class="hljs-operator">?</span> <span class="hljs-operator">*</span> \n<span class="hljs-string">" +
            "</span>    : $[idc] <span class="hljs-operator">=</span> 'beijing' <span class="hljs-operator">&amp;&amp;</span> $[consumer.region] <span class="hljs-operator">=</span> 'north<span class="hljs-operator">-</span>china' <span class="hljs-operator">?</span> <span class="hljs-operator">*</span> \n<span class="hljs-string">" +
            "</span>    : $[idc] <span class="hljs-operator">=</span> 'shanghai' <span class="hljs-operator">&amp;&amp;</span> $[consumer.region] <span class="hljs-operator">=</span> 'east<span class="hljs-operator">-</span>china' <span class="hljs-operator">?</span> <span class="hljs-operator">*</span> \n<span class="hljs-string">" +
            "</span>    : null<span class="hljs-string">"<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  ]<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"}"</span>;
        
        <span class="hljs-comment">// 标签路由规则：明确指定服务分组</span>
        <span class="hljs-type">String</span> tagRule <span class="hljs-operator">=</span> 
            <span class="hljs-string">"{<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  "</span>force<span class="hljs-string">": false,<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  "</span>rules<span class="hljs-string">": [<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"    {<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"      "</span>dubbo<span class="hljs-string">": "</span>com.example.<span class="hljs-type">OrderService</span><span class="hljs-string">",<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"      "</span>tags<span class="hljs-string">": [<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"        {<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"          "</span>name<span class="hljs-string">": "</span>beijing<span class="hljs-string">",<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"          "</span>addresses<span class="hljs-string">": ["</span><span class="hljs-number">192.168</span>.<span class="hljs-number">1</span><span class="hljs-operator">.*</span><span class="hljs-string">"]<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"        },<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"        {<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"          "</span>name<span class="hljs-string">": "</span>shanghai<span class="hljs-string">", <span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"          "</span>addresses<span class="hljs-string">": ["</span><span class="hljs-number">192.168</span>.<span class="hljs-number">2</span><span class="hljs-operator">.*</span><span class="hljs-string">"]<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"        }<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"      ]<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"    }<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"  ]<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
            <span class="hljs-string">"}"</span>;
        
        <span class="hljs-comment">// 将规则发布到注册中心</span>
        publishRoutingRules(conditionRule, tagRule);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> void publishRoutingRules(<span class="hljs-type">String</span> conditionRule, <span class="hljs-type">String</span> tagRule) {
        <span class="hljs-comment">// 实际项目中通过Dubbo Admin或直接调用注册中心API发布规则</span>
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"发布路由规则完成"</span>);
    }
}

<span class="hljs-type">AI写代码java</span>
运行
<span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748</span>
</code></pre>
<h4 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.3 监控与调优</h4>
<p>跨机房调用的监控至关重要，下面是一个监控配置示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 跨机房调用监控</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CrossIdcMonitor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MeterRegistry</span> <span class="hljs-variable">meterRegistry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMeterRegistry</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Counter</span> <span class="hljs-variable">crossIdcCounter</span> <span class="hljs-operator">=</span> Counter
        .builder(<span class="hljs-string">"dubbo.crossidc.calls"</span>)
        .description(<span class="hljs-string">"跨机房调用统计"</span>)
        .register(meterRegistry);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Timer</span> <span class="hljs-variable">crossIdcTimer</span> <span class="hljs-operator">=</span> Timer
        .builder(<span class="hljs-string">"dubbo.crossidc.latency"</span>)
        .description(<span class="hljs-string">"跨机房调用延迟"</span>)
        .register(meterRegistry);
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">invoke</span><span class="hljs-params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="hljs-keyword">throws</span> RpcException {
        <span class="hljs-type">String</span> <span class="hljs-variable">consumerIdc</span> <span class="hljs-operator">=</span> RpcContext.getContext().getAttachment(<span class="hljs-string">"idc"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">providerIdc</span> <span class="hljs-operator">=</span> invoker.getUrl().getParameter(<span class="hljs-string">"idc"</span>);
        
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isCrossIdc</span> <span class="hljs-operator">=</span> !Objects.equals(consumerIdc, providerIdc);
        
        <span class="hljs-keyword">if</span> (isCrossIdc) {
            crossIdcCounter.increment();
            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> invoker.invoke(invocation);
                <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;
                crossIdcTimer.record(duration, TimeUnit.MILLISECONDS);
                
                <span class="hljs-comment">// 记录监控日志</span>
                logCrossIdcCall(consumerIdc, providerIdc, duration, 
                               invocation.getMethodName(), <span class="hljs-literal">true</span>);
                <span class="hljs-keyword">return</span> result;
            } <span class="hljs-keyword">catch</span> (RpcException e) {
                logCrossIdcCall(consumerIdc, providerIdc, <span class="hljs-number">0L</span>, 
                               invocation.getMethodName(), <span class="hljs-literal">false</span>);
                <span class="hljs-keyword">throw</span> e;
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> invoker.invoke(invocation);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logCrossIdcCall</span><span class="hljs-params">(String fromIdc, String toIdc, <span class="hljs-type">long</span> latency, 
                                String method, <span class="hljs-type">boolean</span> success)</span> {
        System.out.printf(<span class="hljs-string">"跨机房调用: %s -&gt; %s, 方法: %s, 延迟: %dms, 状态: %s%n"</span>,
                         fromIdc, toIdc, method, latency, success ? <span class="hljs-string">"成功"</span> : <span class="hljs-string">"失败"</span>);
    }
}

AI写代码java
运行
<span class="hljs-number">1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950</span>
</code></pre>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>四、高级特性与最佳实践</h3>
<h4 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.1 动态路由策略</h4>
<p>基于实时监控数据的动态路由策略：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 基于实时指标的路由决策</span>
@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicRoutingStrategy</span> {
    
    @Autowired
    <span class="hljs-keyword">private</span> MetricsCollector metricsCollector;
    
    <span class="hljs-comment">/**
     * 根据实时网络状况选择最优机房
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">selectOptimalIdc</span><span class="hljs-params">(<span class="hljs-type">String</span> serviceName, <span class="hljs-type">String</span> currentIdc)</span> </span>{
        Map&lt;<span class="hljs-type">String</span>, IdcMetrics&gt; idcMetrics = metricsCollector.<span class="hljs-built_in">getIdcMetrics</span>(serviceName);
        
        <span class="hljs-keyword">return</span> idcMetrics.<span class="hljs-built_in">entrySet</span>().<span class="hljs-built_in">stream</span>()
            .<span class="hljs-built_in">filter</span>(entry -&gt; <span class="hljs-built_in">isIdcHealthy</span>(entry.<span class="hljs-built_in">getValue</span>()))
            .<span class="hljs-built_in">min</span>(Comparator.<span class="hljs-built_in">comparing</span>(entry -&gt; <span class="hljs-built_in">calculateScore</span>(entry.<span class="hljs-built_in">getValue</span>(), currentIdc)))
            .<span class="hljs-built_in">map</span>(Map.Entry::getKey)
            .<span class="hljs-built_in">orElse</span>(currentIdc); <span class="hljs-comment">// 默认返回当前机房</span>
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title">isIdcHealthy</span><span class="hljs-params">(IdcMetrics metrics)</span> </span>{
        <span class="hljs-comment">// 判断机房健康状况</span>
        <span class="hljs-keyword">return</span> metrics.<span class="hljs-built_in">getSuccessRate</span>() &gt; <span class="hljs-number">0.95</span> &amp;&amp; 
               metrics.<span class="hljs-built_in">getAvgLatency</span>() &lt; <span class="hljs-number">100</span> &amp;&amp;
               metrics.<span class="hljs-built_in">getErrorRate</span>() &lt; <span class="hljs-number">0.05</span>;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title">calculateScore</span><span class="hljs-params">(IdcMetrics metrics, <span class="hljs-type">String</span> currentIdc)</span> </span>{
        <span class="hljs-type">double</span> latencyScore = metrics.<span class="hljs-built_in">getAvgLatency</span>() / <span class="hljs-number">50.0</span>; <span class="hljs-comment">// 标准化延迟</span>
        <span class="hljs-type">double</span> successScore = (<span class="hljs-number">1</span> - metrics.<span class="hljs-built_in">getSuccessRate</span>()) * <span class="hljs-number">10</span>; <span class="hljs-comment">// 失败率惩罚</span>
        
        <span class="hljs-comment">// 同机房优先：当前机房得分降低</span>
        <span class="hljs-type">double</span> sameIdcBonus = metrics.<span class="hljs-built_in">getIdc</span>().<span class="hljs-built_in">equals</span>(currentIdc) ? <span class="hljs-number">-0.5</span> : <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">return</span> latencyScore + successScore + sameIdcBonus;
    }
}

<span class="hljs-comment">// 机房指标数据类</span>
@Data
<span class="hljs-keyword">class</span> <span class="hljs-title class_">IdcMetrics</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> idc;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> avgLatency;    <span class="hljs-comment">// 平均延迟(ms)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> successRate;   <span class="hljs-comment">// 成功率</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> errorRate;     <span class="hljs-comment">// 错误率</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> activeConnections; <span class="hljs-comment">// 活跃连接数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> lastUpdateTime;  <span class="hljs-comment">// 最后更新时间</span>
}

AI写代码java
运行
<span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536373839404142434445464748</span>
</code></pre>
<h4 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.2 熔断与降级</h4>
<p>跨机房调用必须要有完善的熔断降级机制：</p>
<pre><code class="hljs language-ini" lang="ini">// 跨机房熔断器实现
@Component
public class CrossIdcCircuitBreaker {
    
    private final Map&lt;String, CircuitBreakerStats&gt; <span class="hljs-attr">statsMap</span> = new ConcurrentHashMap&lt;&gt;()<span class="hljs-comment">;</span>
    private final int <span class="hljs-attr">failureThreshold</span> = <span class="hljs-number">5</span><span class="hljs-comment">;</span>
    private final long <span class="hljs-attr">timeout</span> = <span class="hljs-number">30000</span>L<span class="hljs-comment">; // 30秒熔断时间</span>
    
    public boolean allowRequest(String serviceId, String targetIdc) {
        String <span class="hljs-attr">key</span> = serviceId + <span class="hljs-string">":"</span> + targetIdc<span class="hljs-comment">;</span>
        CircuitBreakerStats <span class="hljs-attr">stats</span> = statsMap.computeIfAbsent(key, 
            k -&gt; new CircuitBreakerStats())<span class="hljs-comment">;</span>
            
        if (<span class="hljs-attr">stats.state</span> == State.OPEN) {
            if (System.currentTimeMillis() - stats.lastFailureTime &gt; timeout) {
                // 超时后进入半开状态
                <span class="hljs-attr">stats.state</span> = State.HALF_OPEN<span class="hljs-comment">;</span>
                <span class="hljs-attr">stats.consecutiveFailures</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
                return true<span class="hljs-comment">;</span>
            }
            return false<span class="hljs-comment">;</span>
        }
        return true<span class="hljs-comment">;</span>
    }
    
    public void onSuccess(String serviceId, String targetIdc) {
        String <span class="hljs-attr">key</span> = serviceId + <span class="hljs-string">":"</span> + targetIdc<span class="hljs-comment">;</span>
        CircuitBreakerStats <span class="hljs-attr">stats</span> = statsMap.get(key)<span class="hljs-comment">;</span>
        if (stats != null) {
            if (<span class="hljs-attr">stats.state</span> == State.HALF_OPEN) {
                <span class="hljs-attr">stats.state</span> = State.CLOSED<span class="hljs-comment">;</span>
            }
            <span class="hljs-attr">stats.consecutiveFailures</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        }
    }
    
    public void onFailure(String serviceId, String targetIdc) {
        String <span class="hljs-attr">key</span> = serviceId + <span class="hljs-string">":"</span> + targetIdc<span class="hljs-comment">;</span>
        CircuitBreakerStats <span class="hljs-attr">stats</span> = statsMap.computeIfAbsent(key, 
            k -&gt; new CircuitBreakerStats())<span class="hljs-comment">;</span>
            
        stats.consecutiveFailures++<span class="hljs-comment">;</span>
        <span class="hljs-attr">stats.lastFailureTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        
        if (stats.consecutiveFailures &gt;= failureThreshold) {
            <span class="hljs-attr">stats.state</span> = State.OPEN<span class="hljs-comment">;</span>
        } else if (<span class="hljs-attr">stats.state</span> == State.HALF_OPEN) {
            <span class="hljs-attr">stats.state</span> = State.OPEN<span class="hljs-comment">; // 半开状态下失败立即熔断</span>
        }
    }
    
    enum State { OPEN, HALF_OPEN, CLOSED }
    
    static class CircuitBreakerStats {
        State <span class="hljs-attr">state</span> = State.CLOSED<span class="hljs-comment">;</span>
        int <span class="hljs-attr">consecutiveFailures</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        long <span class="hljs-attr">lastFailureTime</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    }
}

AI写代码java
运行
1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859
</code></pre>
<h4 data-id="heading-15"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.3 性能优化技巧</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 跨机房调用性能优化实践</span>
public class PerformanceOptimization {
    
    <span class="hljs-comment">// 1. 连接池优化</span>
    <span class="hljs-keyword">@Bean</span>
    public ProtocolConfig protocolConfig() {
        ProtocolConfig protocol = new <span class="hljs-built_in">ProtocolConfig</span>();
        protocol<span class="hljs-selector-class">.setName</span>("dubbo");
        protocol<span class="hljs-selector-class">.setPort</span>(<span class="hljs-number">20880</span>);
        protocol<span class="hljs-selector-class">.setThreads</span>(<span class="hljs-number">200</span>);
        protocol<span class="hljs-selector-class">.setIothreads</span>(<span class="hljs-number">4</span>);
        protocol<span class="hljs-selector-class">.setQueues</span>(<span class="hljs-number">0</span>);
        protocol<span class="hljs-selector-class">.setAccepts</span>(<span class="hljs-number">1000</span>);
        protocol<span class="hljs-selector-class">.setIdleTimeout</span>(<span class="hljs-number">600000</span>); <span class="hljs-comment">// 10分钟空闲超时</span>
        return protocol;
    }
    
    <span class="hljs-comment">// 2. 序列化优化 - 使用Kryo或Protobuf</span>
    <span class="hljs-keyword">@Bean</span> 
    public SerializationOptimizer serializationOptimizer() {
        return new <span class="hljs-built_in">SerializationOptimizer</span>() {
            <span class="hljs-keyword">@Override</span>
            public Collection&lt;Class&lt;?&gt;&gt; getSerializableClasses() {
                List&lt;Class&lt;?&gt;&gt; classes = new ArrayList&lt;&gt;();
                classes<span class="hljs-selector-class">.add</span>(OrderDTO.class);
                classes<span class="hljs-selector-class">.add</span>(UserDTO.class);
                classes<span class="hljs-selector-class">.add</span>(ProductDTO.class);
                return classes;
            }
        };
    }
    
    <span class="hljs-comment">// 3. 异步调用优化</span>
    public void <span class="hljs-built_in">asyncCrossIdcCall</span>() {
        <span class="hljs-comment">// 异步调用，避免阻塞</span>
        CompletableFuture&lt;OrderResult&gt; future = orderService<span class="hljs-selector-class">.createOrderAsync</span>(order);
        
        <span class="hljs-comment">// 可以继续处理其他逻辑</span>
        <span class="hljs-built_in">doOtherWork</span>();
        
        <span class="hljs-comment">// 需要结果时再获取</span>
        OrderResult result = future<span class="hljs-selector-class">.get</span>(<span class="hljs-number">3000</span>, TimeUnit.MILLISECONDS);
    }
    
    <span class="hljs-comment">// 4. 批量调用优化</span>
    public void <span class="hljs-built_in">batchCrossIdcCall</span>(List&lt;Order&gt; orders) {
        <span class="hljs-comment">// 合并多个调用，减少网络往返</span>
        BatchResult batchResult = orderService<span class="hljs-selector-class">.batchCreateOrders</span>(orders);
        
        <span class="hljs-comment">// 处理批量结果</span>
        <span class="hljs-built_in">processBatchResult</span>(batchResult);
    }
}

AI写代码java
运行
<span class="hljs-number">1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253</span>
</code></pre>
<h3 data-id="heading-16"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>五、总结与展望</h3>
<p>通过本文的详细讲解，我们可以看到Dubbo在跨机房服务调用方面提供了完整的解决方案。从基础的路由配置到高级的动态路由策略，从简单的容错到复杂的熔断降级，Dubbo都给出了很好的实践方案。</p>
<h4 data-id="heading-17"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>🎯 关键要点回顾</h4>
<ol>
<li><strong>架构设计</strong>：合理的注册中心部署和路由策略是基础</li>
<li><strong>性能优化</strong>：连接池、序列化、异步调用等多方面优化</li>
<li><strong>容错保障</strong>：完善的熔断、降级、故障转移机制</li>
<li><strong>监控运维</strong>：全面的监控体系和动态调整能力</li>
</ol>
<h4 data-id="heading-18"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>🚀 未来展望</h4>
<p>随着云原生技术的发展，Dubbo在跨机房调用方面还会有更多创新：</p>
<ul>
<li><strong>服务网格集成</strong>：与Istio等服务网格技术深度融合</li>
<li><strong>智能路由</strong>：基于AI的预测性路由决策</li>
<li><strong>多活架构</strong>：真正意义上的多机房多活部署</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS单位全解析：从像素到视口的响应式设计]]></title>    <link>https://juejin.cn/post/7586675587147399204</link>    <guid>https://juejin.cn/post/7586675587147399204</guid>    <pubDate>2025-12-23T05:50:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586675587147399204" data-draft-id="7586684925105946667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS单位全解析：从像素到视口的响应式设计"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T05:50:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户2226459894341"/> <meta itemprop="url" content="https://juejin.cn/user/2128263774470791"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS单位全解析：从像素到视口的响应式设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2128263774470791/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户2226459894341
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:50:05.000Z" title="Tue Dec 23 2025 05:50:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，CSS单位的选择直接影响着网页的布局灵活性和响应式效果。随着现代Web开发对多设备适配要求的提高，理解各种CSS单位的特性和适用场景变得至关重要。</p>
<h2 data-id="heading-0">绝对单位：精确但缺乏弹性</h2>
<p>绝对单位如<code>px</code>（像素）是最常见的单位，1px对应屏幕上的一个物理像素点。在固定尺寸设计中，像素单位提供了精确控制：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">960px</span>; <span class="hljs-comment">/* 传统固定布局 */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}
</code></pre>
<p>然而，在Retina等高密度显示屏上，像素单位的实际物理尺寸会变小，且无法根据上下文环境自适应变化，这在响应式设计中成为明显限制。</p>
<h2 data-id="heading-1">相对单位：灵活适配的基石</h2>
<h3 data-id="heading-2">em：基于上下文字号</h3>
<p><code>em</code>单位相对于当前元素的字体大小或父元素字体大小：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
}

<span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.5em</span>; <span class="hljs-comment">/* 24px (16 × 1.5) */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">2em</span>;     <span class="hljs-comment">/* 48px (24 × 2) */</span>
}
</code></pre>
<h3 data-id="heading-3">rem：根元素相对单位</h3>
<p><code>rem</code>始终相对于根元素(<code>html</code>)的字体大小，避免了em的多层嵌套计算问题：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">html</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>; <span class="hljs-comment">/* 基准值 */</span>
}

<span class="hljs-selector-class">.component</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1rem</span>;    <span class="hljs-comment">/* 16px */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">2rem</span>;      <span class="hljs-comment">/* 32px */</span>
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0.5rem</span>;     <span class="hljs-comment">/* 8px */</span>
}
</code></pre>
<p>通过调整根元素字体大小，可以轻松实现整体缩放效果，非常适合构建可访问性友好的界面。</p>
<h2 data-id="heading-4">视口单位：现代响应式利器</h2>
<h3 data-id="heading-5">vw/vh：视口尺寸百分比</h3>
<p><code>vw</code>（视口宽度百分比）和<code>vh</code>（视口高度百分比）实现了真正基于视口尺寸的响应：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.hero-section</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;      <span class="hljs-comment">/* 充满整个视口高度 */</span>
  <span class="hljs-attribute">width</span>: <span class="hljs-number">80vw</span>;        <span class="hljs-comment">/* 视口宽度的80% */</span>
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">5vw</span>;     <span class="hljs-comment">/* 字号随视口宽度变化 */</span>
}
</code></pre>
<h3 data-id="heading-6">vmin/vmax：自适应选择</h3>
<p><code>vmin</code>取视口宽高中较小的百分比，<code>vmax</code>取较大的百分比：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 在移动端横竖屏切换时特别有用 */</span>
<span class="hljs-selector-class">.responsive-square</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">50vmin</span>;  <span class="hljs-comment">/* 总是基于较小尺寸 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">50vmin</span>; <span class="hljs-comment">/* 保持正方形 */</span>
}
</code></pre>
<h2 data-id="heading-7">现代布局单位：CSS Grid与Flexbox的完美搭档</h2>
<h3 data-id="heading-8">fr：Grid布局的弹性单位</h3>
<p><code>fr</code>单位在CSS Grid布局中按比例分配可用空间：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.grid-container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">2</span>fr <span class="hljs-number">1</span>fr; <span class="hljs-comment">/* 中间列是两侧的两倍宽 */</span>
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">1rem</span>;
}
</code></pre>
<h3 data-id="heading-9">%：基于父容器的百分比</h3>
<p>百分比单位相对于父元素的对应维度：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;
}

<span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">50%</span>; <span class="hljs-comment">/* 400px */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">25%</span>; <span class="hljs-comment">/* 相对于父元素高度 */</span>
}
</code></pre>
<h2 data-id="heading-10">实用技巧与最佳实践</h2>
<h3 data-id="heading-11">1. 响应式字体系统</h3>
<p>结合rem和vw创建流畅的字体缩放：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">html</span> {
  <span class="hljs-comment">/* 最小16px，最大20px，在320px-1200px视口间平滑变化 */</span>
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">16px</span>, <span class="hljs-number">4vw</span> - <span class="hljs-number">0.5rem</span>, <span class="hljs-number">20px</span>);
}
</code></pre>
<h3 data-id="heading-12">2. 间距系统的一致性</h3>
<p>建立基于rem的间距系统：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--space-unit</span>: <span class="hljs-number">0.5rem</span>;
  <span class="hljs-attr">--space-xs</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--space-unit) * <span class="hljs-number">0.5</span>);
  <span class="hljs-attr">--space-sm</span>: <span class="hljs-built_in">var</span>(--space-unit);
  <span class="hljs-attr">--space-md</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--space-unit) * <span class="hljs-number">2</span>);
  <span class="hljs-attr">--space-lg</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--space-unit) * <span class="hljs-number">3</span>);
}
</code></pre>
<h3 data-id="heading-13">3. 容器查询单位（实验性）</h3>
<p>CSS容器查询引入了<code>cqw</code>、<code>cqh</code>等单位，允许基于容器而非视口进行响应：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.card</span> {
  container-type: inline-size;
}

<span class="hljs-keyword">@container</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">400px</span>) {
  <span class="hljs-selector-class">.card-title</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">1rem</span>, <span class="hljs-number">2</span>cqw, <span class="hljs-number">1.5rem</span>);
  }
}
</code></pre>
<h2 data-id="heading-14">单位选择策略</h2>
<ol>
<li><strong>布局与间距</strong>：优先使用rem，确保可访问性缩放</li>
<li><strong>字体大小</strong>：rem为主，结合clamp()函数限制极值</li>
<li><strong>全屏元素</strong>：使用vh/vw实现视口相关尺寸</li>
<li><strong>栅格系统</strong>：Grid布局中使用fr，Flexbox中使用百分比或flex属性</li>
<li><strong>媒体查询</strong>：始终使用em单位，确保基于用户字体偏好</li>
</ol>
<h2 data-id="heading-15">结语</h2>
<p>随着CSS标准的不断演进，单位系统也变得越来越丰富和强大。理解每种单位的内在逻辑和适用场景，能够帮助我们在不同场景下做出最佳选择。在实际项目中，往往需要组合使用多种单位，发挥各自优势，才能构建出既美观又实用的响应式界面。</p>
<p>记住，没有“绝对最佳”的单位，只有在特定上下文中的“最合适”选择。通过实践和实验，您将逐渐形成自己的单位使用策略，创建出更具弹性和可维护性的前端代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析 React 项目架构：从文件结构到核心 API 的全面拆解]]></title>    <link>https://juejin.cn/post/7586622708998701096</link>    <guid>https://juejin.cn/post/7586622708998701096</guid>    <pubDate>2025-12-23T05:51:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586622708998701096" data-draft-id="7585866811717599259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析 React 项目架构：从文件结构到核心 API 的全面拆解"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-12-23T05:51:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析 React 项目架构：从文件结构到核心 API 的全面拆解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:51:11.000Z" title="Tue Dec 23 2025 05:51:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"> 引言</h2>
<p>欢迎来到 <strong>React 项目架构的深度解密之旅</strong>！本文将基于实际项目目录结构，结合六个源码文件内容，为你呈现一个<strong>完整、清晰、生动且极尽详细的现代 React 项目架构分析</strong>。我们将以图示为蓝本，逐层剖析每个文件的作用、技术选型背后的逻辑、API 的使用场景与设计哲学，并揭示整个项目的工程化思想。</p>
<hr/>
<h3 data-id="heading-1">图解项目结构：<code>react-demo</code> 目录全景</h3>
<p>首先，让我们从整体视角审视这个项目的物理结构：</p>
<pre><code class="hljs language-csharp" lang="csharp">react-demo/
├── node_modules/           <span class="hljs-meta"># 第三方依赖包（自动安装）</span>
├── <span class="hljs-keyword">public</span>/                 <span class="hljs-meta"># 静态资源根目录</span>
│   └── assets/             <span class="hljs-meta"># 公共静态资源</span>
│       └── react.svg       <span class="hljs-meta"># SVG 图标文件</span>
├── src/                    <span class="hljs-meta"># 源码主目录</span>
│   ├── assets/             <span class="hljs-meta"># 应用级静态资源（可选）</span>
│   │   └── react.svg       <span class="hljs-meta"># 可复用图标</span>
│   ├── pages/              <span class="hljs-meta"># 页面组件集合</span>
│   │   ├── About.jsx       <span class="hljs-meta"># 关于页面组件</span>
│   │   └── Home.jsx        <span class="hljs-meta"># 首页组件（含 API 调用）</span>
│   ├── router/             <span class="hljs-meta"># 路由配置模块</span>
│   │   └── index.jsx       <span class="hljs-meta"># 路由配置中心</span>
│   ├── App.css             <span class="hljs-meta"># 根组件样式</span>
│   ├── App.jsx             <span class="hljs-meta"># 根组件（导航 + 路由容器）</span>
│   ├── index.css           <span class="hljs-meta"># 全局样式（CSS）</span>
│   ├── index.stylus        <span class="hljs-meta"># 全局样式（Stylus 预处理器）</span>
│   ├── main.jsx            <span class="hljs-meta"># 应用入口文件</span>
│   └── vite.config.js      <span class="hljs-meta"># Vite 构建配置</span>
├── .gitignore              <span class="hljs-meta"># Git 忽略规则</span>
├── eslint.config.js        <span class="hljs-meta"># ESLint 代码规范配置</span>
├── index.html              <span class="hljs-meta"># HTML 入口模板</span>
├── package-<span class="hljs-keyword">lock</span>.json       <span class="hljs-meta"># 依赖锁定文件</span>
├── package.json            <span class="hljs-meta"># 项目配置与依赖声明</span>
├── README.md               <span class="hljs-meta"># 项目文档（含搭建流程）</span>
└── vite.config.js          <span class="hljs-meta"># Vite 构建工具配置</span>
</code></pre>
<blockquote>
<p>小贴士：<code>src/</code> 是开发的核心区域，其余如 <code>public/</code>、<code>package.json</code> 等是构建和部署支撑系统。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">架构概览：现代 React 项目的“五脏六腑”</h3>
<p>我们可以把整个项目比作一个人体：</p>








































<table><thead><tr><th>组件</th><th>类比</th><th>功能</th></tr></thead><tbody><tr><td><code>main.jsx</code></td><td>心脏</td><td>启动应用，连接 React 与 DOM</td></tr><tr><td><code>App.jsx</code></td><td>大脑</td><td>控制全局 UI 结构与路由调度</td></tr><tr><td><code>router/index.jsx</code></td><td>神经系统</td><td>实现页面跳转与路径匹配</td></tr><tr><td><code>pages/*</code></td><td>肢体</td><td>承载具体业务逻辑与视图</td></tr><tr><td><code>index.stylus/css</code></td><td>衣服</td><td>提供视觉风格与样式统一</td></tr><tr><td><code>vite.config.js</code></td><td>呼吸系统</td><td>支持开发时编译、热更新等</td></tr></tbody></table>
<p>接下来，我们逐一深入每一个器官！</p>
<hr/>
<h3 data-id="heading-3">1. 应用入口：<code>main.jsx</code> —— 生命的起点</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 严格模式会执行两次，一次是执行，一次是测试 review</span>
<span class="hljs-comment">// import { StrictMode } from 'react'</span>

<span class="hljs-comment">// 导入createRoot，用于创建根节点</span>
<span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>

<span class="hljs-comment">// vite帮我们将stylus编译成css</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./index.stylus'</span> <span class="hljs-comment">// 全局样式 stylus</span>
<span class="hljs-comment">// 或者</span>
<span class="hljs-comment">// import './index.css' // 全局样式 css</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.jsx'</span> <span class="hljs-comment">// 引入了组件</span>

<span class="hljs-comment">// 创建根节点，将 App 组件渲染到 root 元素中</span>
<span class="hljs-comment">// 将 App 组件挂载到root 的元素上，渲染render</span>
<span class="hljs-comment">// 类似于Vue中的createApp(App).mount('#root')</span>
<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>)).<span class="hljs-title function_">render</span>(
  <span class="hljs-comment">// 函数组件的名字 类HTML标签 自定义组件</span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>
  <span class="hljs-comment">// jsx</span>
)
</code></pre>
<h4 data-id="heading-4">详细解析：</h4>
<h5 data-id="heading-5">✅ <code>createRoot()</code>：React 18 的并发渲染引擎</h5>
<ul>
<li>
<p>替代旧版 <code>ReactDOM.render()</code>。</p>
</li>
<li>
<p>支持 <strong>并发模式</strong>（Concurrent Mode）：允许 React 在渲染过程中中断并优先处理高优先级任务（如用户输入）。</p>
</li>
<li>
<p>使用方式：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">root</span> = createRoot(document.getElementById(<span class="hljs-string">'root'</span>))<span class="hljs-comment">;</span>
root.render(&lt;App /&gt;)<span class="hljs-comment">;</span>
</code></pre>
<p>这种方式支持后续的 <code>root.unmount()</code> 和 <code>root.render(...)</code> 更新。</p>
</li>
</ul>
<h5 data-id="heading-6">✅ <code>import './index.stylus'</code></h5>
<ul>
<li>
<p>Stylus 是一种 CSS 预处理器，语法更简洁（类似 Sass）。</p>
</li>
<li>
<p>Vite 内置对 Stylus 的支持，无需额外插件即可编译为标准 CSS。</p>
</li>
<li>
<p>示例：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span>
  <span class="hljs-attribute">font-family</span> sans-serif
  <span class="hljs-attribute">background</span> <span class="hljs-selector-id">#f0f0f0</span>
</code></pre>
<p>编译后 → <code>&lt;style&gt;body{font-family:sans-serif;background:#f0f0f0}&lt;/style&gt;</code></p>
</li>
</ul>
<h5 data-id="heading-7">✅ 注释中的“彩蛋”：对比 Vue</h5>
<blockquote>
<p>“类似于 Vue 中的 <code>createApp(App).mount('#root')</code>”<br/>
这表明作者希望帮助跨框架开发者快速理解 React 的挂载机制，体现了良好的教学意识。</p>
</blockquote>
<h5 data-id="heading-8">❌ <code>StrictMode</code> 被注释</h5>
<ul>
<li>若启用，React 会在开发环境下<strong>故意双渲染组件</strong>，用于检测潜在问题（如不安全的副作用）。</li>
<li>生产环境不会触发，仅限开发调试。</li>
</ul>
<blockquote>
<p>💡 建议：在开发阶段开启 <code>StrictMode</code>，有助于提前发现隐患！</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">2. 根组件：<code>App.jsx</code> —— 整个 UI 的中枢</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">'./App.css'</span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">BrowserRouter</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Router</span>,
  <span class="hljs-title class_">Link</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AppRoutes</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./router/index.jsx'</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Router</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">AppRoutes</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Router</span>&gt;</span></span>
  )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>
</code></pre>
<h4 data-id="heading-10">详细解析：</h4>
<h4 data-id="heading-11">React 与 Vue 结构对照表总结</h4>





















<table><thead><tr><th>Vue SFC 部分</th><th>React (App.jsx) 对应部分</th></tr></thead><tbody><tr><td><code>&lt;template&gt;</code></td><td><code>return (...)</code> 中的 JSX</td></tr><tr><td><code>&lt;script&gt;</code></td><td>函数组件内部逻辑（Hooks、方法等）</td></tr><tr><td><code>&lt;style&gt;</code></td><td><code>import './App.css'</code> 或内联样式</td></tr></tbody></table>
<h5 data-id="heading-12">✅ <code>import { BrowserRouter as Router, Link } from 'react-router-dom'</code></h5>
<ul>
<li><strong>模块来源</strong>：第三方包 <code>react-router-dom</code>（已通过 <code>npm i react-router-dom</code> 安装）</li>
<li><strong>作用分解</strong>：</li>
</ul>





















<table><thead><tr><th>导入项</th><th>作用</th></tr></thead><tbody><tr><td><code>BrowserRouter</code></td><td>提供基于 HTML5 History API 的路由上下文。必须包裹整个应用才能使用 <code>Link</code> 和 <code>Route</code>。</td></tr><tr><td><code>as Router</code></td><td>使用别名简化 JSX 中的标签名（写 <code>&lt;Router&gt;</code> 而非 <code>&lt;BrowserRouter&gt;</code>）。</td></tr><tr><td><code>Link</code></td><td>客户端导航组件，点击时不刷新页面，实现 SPA 跳转。</td></tr></tbody></table>
<ul>
<li><strong>为何需要 <code>react-router-dom</code>？</strong><br/>
React 本身不包含路由功能。<code>react-router-dom</code> 是官方推荐的 Web 端路由库，提供完整的前端路由解决方案。</li>
</ul>
<blockquote>
<p>🛠️ 技术细节：<code>BrowserRouter</code> 内部使用 <code>window.history</code> API 管理 URL，需服务器支持（Vite 开发服务器已内置）。</p>
</blockquote>
<h5 data-id="heading-13">✅ <code>BrowserRouter as Router</code></h5>
<ul>
<li>使用 HTML5 History API 实现 URL 路径，例如：<code>http://localhost:5173/about</code></li>
<li>不再需要 <code>#</code> 哈希片段（<code>#/about</code>），URL 更美观、SEO 更友好。</li>
<li>需要服务器支持（Vite 开发服务器已内置支持）。</li>
</ul>
<blockquote>
<p>为什么不用 <code>HashRouter</code>？因为哈希路由丑陋且不利于 SEO，只适合简单演示或旧浏览器兼容。</p>
</blockquote>
<h5 data-id="heading-14">✅ <code>Link</code> 组件 vs <code>&lt;a&gt;</code></h5>






























<table><thead><tr><th>特性</th><th><code>&lt;a&gt;</code></th><th><code>&lt;Link&gt;</code></th></tr></thead><tbody><tr><td>是否刷新页面</td><td>✅ 是</td><td>❌ 否</td></tr><tr><td>是否触发 SPA 导航</td><td>❌ 否</td><td>✅ 是</td></tr><tr><td>是否支持路由参数</td><td>❌ 否</td><td>✅ 是</td></tr><tr><td>是否能传递状态</td><td>❌ 否</td><td>✅ 是（通过 <code>state</code> 属性）</td></tr></tbody></table>
<blockquote>
<p><code>Link</code> 是 React Router 的“官方导航”，它内部使用 <code>history.pushState()</code> 完成客户端跳转，避免整页重载。</p>
</blockquote>
<h5 data-id="heading-15">✅ <code>AppRoutes</code>：路由子组件</h5>
<ul>
<li>从 <code>./router/index.jsx</code> 导入，实现“职责分离”。</li>
<li>让 <code>App.jsx</code> 专注于布局和导航，而不关心具体路由逻辑。</li>
</ul>
<h5 data-id="heading-16">✅ <code>&lt;nav&gt;</code> 导航栏设计</h5>
<ul>
<li>使用语义化标签 <code>&lt;nav&gt;</code> 和 <code>&lt;ul&gt;/&lt;li&gt;</code> 构建无障碍友好的导航菜单。</li>
<li>每个 <code>&lt;Link&gt;</code> 都对应一个页面路径。</li>
</ul>
<blockquote>
<p>设计理念：<strong>UI 与逻辑分离，组件扁平化管理</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-17">3. 路由中枢：<code>router/index.jsx</code> —— 页面切换的指挥官</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/Home.jsx'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/About.jsx'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AppRoutes</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/about"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">About</span> /&gt;</span>} /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-18">详细解析：</h4>
<h5 data-id="heading-19">✅ <code>Routes</code>：路由容器</h5>
<ul>
<li>包裹所有 <code>&lt;Route&gt;</code>，负责匹配当前 URL 并决定渲染哪个组件。</li>
<li>v6 中取代了旧版的 <code>Switch</code>，功能更强，支持嵌套路由。</li>
</ul>
<h5 data-id="heading-20">✅ <code>Route</code>：路由规则定义</h5>





















<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><code>path</code></td><td>匹配的 URL 路径（支持通配符 <code>/user/:id</code>）</td></tr><tr><td><code>element</code></td><td>渲染的 JSX 元素（注意：必须是 JSX，不能是组件引用）</td></tr><tr><td><code>children</code></td><td>嵌套路由（v6 新增）</td></tr></tbody></table>
<blockquote>
<p>⚠️ 注意：<code>element={&lt;Home /&gt;}</code> 是 JSX 表达式，不是 <code>element={Home}</code>！后者会导致错误。</p>
</blockquote>
<h5 data-id="heading-21">✅ 路径匹配规则</h5>





















<table><thead><tr><th>路径</th><th>匹配情况</th></tr></thead><tbody><tr><td><code>/</code></td><td>匹配首页</td></tr><tr><td><code>/about</code></td><td>匹配关于页</td></tr><tr><td><code>/home</code></td><td>不匹配（没有定义）</td></tr></tbody></table>
<blockquote>
<p>🔄 如果多个 <code>&lt;Route&gt;</code> 匹配同一路径，React Router 会按顺序选择第一个匹配项。</p>
</blockquote>
<h5 data-id="heading-22">✅ <code>import Home from '../pages/Home.jsx'</code></h5>
<ul>
<li>
<p><strong>模块来源</strong>：本地页面组件（相对路径）</p>
</li>
<li>
<p><strong>作用</strong>：</p>
<ul>
<li>引入首页组件。</li>
<li>作为 <code>/</code> 路径的渲染内容。</li>
</ul>
</li>
<li>
<p><strong>路径说明</strong>：<code>../pages/</code> 表示从 <code>router/</code> 目录向上一级，再进入 <code>pages/</code>。</p>
</li>
</ul>
<blockquote>
<p>📁 目录规范：<code>pages/</code> 是约定俗成的页面组件存放位置，便于识别“页面级” vs “通用组件”。</p>
</blockquote>
<hr/>
<h5 data-id="heading-23">✅ <code>import About from '../pages/About.jsx'</code></h5>
<ul>
<li>
<p><strong>模块来源</strong>：同上</p>
</li>
<li>
<p><strong>作用</strong>：</p>
<ul>
<li>引入关于页组件。</li>
<li>作为 <code>/about</code> 路径的渲染内容。</li>
</ul>
</li>
<li>
<p><strong>设计一致性</strong>：所有页面组件统一放在 <code>pages/</code> 下，结构清晰。</p>
</li>
</ul>
<blockquote>
<p>✅ 工程建议：大型项目可进一步按功能划分 <code>pages/user/</code>, <code>pages/admin/</code> 等子目录。</p>
</blockquote>
<hr/>
<h3 data-id="heading-24">4. 首页组件：<code>Home.jsx</code> —— 数据驱动的实战典范</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> {
  useState,
  useEffect
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [repos, setRepos] = <span class="hljs-title function_">useState</span>([])
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件初始化'</span>)
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件挂载后'</span>)
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.github.com/users/octocat/repos'</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-title function_">setRepos</span>(data)
      })
  }, [])
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      {
        repos.length ? (
          <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
            {
              repos.map(repo =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{repo.id}</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{repo.html_url}</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"noreferrer"</span>&gt;</span>
                    {repo.name}
                  <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
              ))
            }
          <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
        ) : (
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>暂无仓库<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        )
      }
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Home</span>
</code></pre>
<h4 data-id="heading-25">详细解析：</h4>
<h5 data-id="heading-26">✅ <code>useState</code>：响应式状态管理</h5>
<ul>
<li><code>const [repos, setRepos] = useState([])</code> 创建一个可变的状态变量。</li>
<li>当调用 <code>setRepos(data)</code> 时，React 会重新渲染组件。</li>
<li><strong>状态是局部的</strong>，不会影响其他组件。</li>
</ul>
<blockquote>
<p>🧠 类比：就像 Vue 的 <code>data()</code> 方法，但更轻量、更灵活。</p>
</blockquote>
<h5 data-id="heading-27">✅ <code>useEffect</code>：副作用钩子</h5>
<ul>
<li>用于处理异步操作、订阅、定时器等“非渲染”行为。</li>
<li>参数：<code>(callback, deps)</code>，其中 <code>deps</code> 是依赖数组。</li>
<li>当 <code>deps</code> 为空数组 <code>[]</code> 时，表示<strong>仅在组件挂载后执行一次</strong>，相当于 <code>componentDidMount</code>。</li>
</ul>
<blockquote>
<p>🚫 错误写法：</p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-built_in">fetch</span>('/api/data')<span class="hljs-selector-class">.then</span>(data =&gt; setRepos(data))
}, <span class="hljs-selector-attr">[]</span>) <span class="hljs-comment">// ✅ 正确</span>
</code></pre>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  <span class="hljs-built_in">fetch</span>('/api/data')<span class="hljs-selector-class">.then</span>(data =&gt; setRepos(data))
}) <span class="hljs-comment">// ❌ 会无限循环！因为没有依赖控制</span>
</code></pre>
<h5 data-id="heading-28">✅ GitHub API 请求详解</h5>
<ul>
<li>地址：<code>https://api.github.com/users/octocat/repos</code></li>
<li>返回：JSON 数组，包含用户的所有公开仓库。</li>
<li>示例数据结构：</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"id"</span>: 12345,    <span class="hljs-string">"name"</span>: <span class="hljs-string">"hello-world"</span>,    <span class="hljs-string">"html_url"</span>: <span class="hljs-string">"https://github.com/octocat/hello-world"</span>  }]</span>
</code></pre>
<h5 data-id="heading-29">✅ 条件渲染与列表映射</h5>
<ul>
<li>使用三元运算符判断是否有数据。</li>
<li>使用 <code>.map()</code> 遍历数组，生成 <code>&lt;li&gt;</code> 列表。</li>
<li><strong>关键点</strong>：<code>key={repo.id}</code> 是必需的，防止 React 无法追踪列表项变化导致的性能问题。</li>
</ul>
<blockquote>
<p>🔥 最佳实践：永远给列表项设置唯一 <code>key</code>！</p>
</blockquote>
<h5 data-id="heading-30">✅ 安全链接：<code>rel="noreferrer"</code></h5>
<ul>
<li>防止点击链接时泄露当前页面的 Referrer 信息。</li>
<li>避免被恶意网站利用进行攻击。</li>
<li>是现代 Web 安全的重要一环。</li>
</ul>
<hr/>
<h3 data-id="heading-31">5. 关于页面：<code>About.jsx</code> —— 极简主义的胜利</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">About</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">About</span>
</code></pre>
<h4 data-id="heading-32">详细解析：</h4>
<ul>
<li>
<p>虽然只有几行代码，但它展示了 React 的本质：</p>
<ul>
<li><strong>函数即组件</strong></li>
<li><strong>返回 JSX 即 UI</strong></li>
<li><strong>无需类、无需生命周期</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p>🎯 哲学：<strong>最小可用单元</strong>（Minimum Viable Component），先完成再优化。</p>
</blockquote>
<hr/>
<h3 data-id="heading-33">6. 项目说明书：<code>README.md</code> —— 工程化的指南针</h3>
<pre><code class="hljs language-rust" lang="rust"># React 项目架构
- npm init vite
  - 从GitHub 拉取一个项目模板
  - npm run dev 启动项目 dev即development
    vite 就是开发阶段的脚手架
    test 测试阶段
    production 上线阶段
    development 开发阶段
    dev <span class="hljs-punctuation">-&gt;</span> test <span class="hljs-punctuation">-&gt;</span> production <span class="hljs-punctuation">-&gt;</span>dev <span class="hljs-punctuation">-&gt;</span> test <span class="hljs-punctuation">-&gt;</span> production
    devDependencies 开发阶段依赖:vite,stylus 开发期间使用
    命令语句：npm i -D stylus
    dependencies 项目依赖  
  - react 基建也交给vite
    - esm 模块化，极致的冷启动
    - npm install -D stylus
      - 安装stylus插件，用于编译stylus文件  -D 表示在开发阶段依赖
      - 安装后在package.json中可以看到devDependencies中多了stylus

- 项目依赖
  vue <span class="hljs-number">3.5</span>.<span class="hljs-number">24</span>
  <span class="hljs-string">"react"</span>: <span class="hljs-string">"^19.2.0"</span>, 第一的现代前端开发框架 响应式、组件化、数据绑定...
  <span class="hljs-string">"react-dom"</span>: <span class="hljs-string">"^19.2.0"</span>
  vue = <span class="hljs-title function_ invoke__">react</span>(core) + react-<span class="hljs-title function_ invoke__">dom</span>(component render dom)
- 引入路由
  - 安装路由
    - npm i react-router-dom
      安装后在package.json中可以看到dependencies中多了react-router-dom
  - 路由的配置
    - 在src目录下创建一个router目录，用于存放路由相关的文件
    - 在router目录下创建一个index.js文件，用于配置路由
  - 引入路由组件，导航，页面级别组件
    - import { BrowserRouter <span class="hljs-keyword">as</span> Router, Routes, Route } from <span class="hljs-symbol">'react</span>-router-dom'
</code></pre>
<h4 data-id="heading-34">详细解析：</h4>
<h5 data-id="heading-35">✅ <code>npm init vite</code>：快速启动</h5>
<ul>
<li>Vite 是现代前端构建工具，基于 ES Modules，启动速度极快。</li>
<li>支持 HMR（Hot Module Replacement），修改代码即时生效。</li>
</ul>
<h5 data-id="heading-36">✅ <code>devDependencies</code> vs <code>dependencies</code></h5>




















<table><thead><tr><th>类型</th><th>用途</th><th>示例</th></tr></thead><tbody><tr><td><code>devDependencies</code></td><td>开发工具</td><td><code>vite</code>, <code>stylus</code>, <code>eslint</code></td></tr><tr><td><code>dependencies</code></td><td>生产依赖</td><td><code>react</code>, <code>react-router-dom</code></td></tr></tbody></table>
<blockquote>
<p>💡 规则：生产环境中不需要的包都放在 <code>devDependencies</code>，减少打包体积。</p>
</blockquote>
<h5 data-id="heading-37">✅ <code>npm i -D stylus</code>：预处理器安装</h5>
<ul>
<li><code>-D</code> 是 <code>--save-dev</code> 的缩写。</li>
<li>安装后会在 <code>package.json</code> 中自动添加：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"stylus"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.55.0"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-38">✅ 类比教学法：“vue = react + react-dom”</h5>
<ul>
<li>
<p>用 Vue 的概念解释 React 的分工：</p>
<ul>
<li><code>react</code>：核心库（响应式、虚拟 DOM）</li>
<li><code>react-dom</code>：DOM 渲染层（类似 Vue 的 <code>vue-runtime-dom</code>）</li>
</ul>
</li>
<li>
<p>有助于跨框架开发者快速理解 React 的分层架构。</p>
</li>
</ul>
<h5 data-id="heading-39">✅ 路由配置建议</h5>
<ul>
<li>创建 <code>src/router/</code> 目录，集中管理路由。</li>
<li>使用 <code>index.jsx</code> 作为路由入口，符合模块化命名规范。</li>
</ul>
<hr/>
<h3 data-id="heading-40">7. 其他重要文件详解</h3>
<h4 data-id="heading-41"><code>index.html</code>：HTML 模板</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"%PUBLIC_URL%/favicon.ico"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"theme-color"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"#000000"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"Web site created using create-react-app"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"apple-touch-icon"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"%PUBLIC_URL%/logo192.png"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"manifest"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"%PUBLIC_URL%/manifest.json"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>React App<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"root"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ul>
<li><code>%PUBLIC_URL%</code> 是 Vite 的占位符，指向 <code>public/</code> 目录。</li>
<li><code>id="root"</code> 是 React 的挂载点，<code>main.jsx</code> 会将其替换为 <code>&lt;App /&gt;</code>。</li>
</ul>
<h4 data-id="heading-42"><code>vite.config.js</code>：构建配置</h4>
<pre><code class="hljs language-php" lang="php">export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">5173</span>
  },
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">outDir</span>: <span class="hljs-string">'dist'</span>
  }
})
</code></pre>
<ul>
<li><code>server.port</code>: 开发服务器端口（默认 5173）</li>
<li><code>build.outDir</code>: 构建输出目录（默认 <code>dist</code>）</li>
</ul>
<blockquote>
<p>✅ Vite 优势：无需 webpack，直接使用原生 ES Modules，编译更快。</p>
</blockquote>
<hr/>
<h3 data-id="heading-43">总结：现代 React 项目架构的五大支柱</h3>



































<table><thead><tr><th>支柱</th><th>技术实现</th><th>作用</th></tr></thead><tbody><tr><td><strong>1. 构建工具</strong></td><td>Vite</td><td>快速启动、HMR、ESM 原生支持</td></tr><tr><td><strong>2. 路由系统</strong></td><td>React Router v6</td><td>SPA 导航、路径匹配、组件切换</td></tr><tr><td><strong>3. 状态管理</strong></td><td><code>useState</code> + <code>useEffect</code></td><td>响应式数据、副作用控制</td></tr><tr><td><strong>4. 模块化结构</strong></td><td>ESM + 文件夹划分</td><td>代码清晰、易于维护</td></tr><tr><td><strong>5. 工程化配置</strong></td><td><code>package.json</code>, <code>vite.config.js</code></td><td>依赖管理、构建流程自动化</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-44">结语：不只是代码，更是思维的跃迁</h3>
<p>这个看似简单的 React 项目，实则蕴含着现代前端开发的全部精髓：</p>
<ul>
<li><strong>组件化</strong>：每个页面都是独立的组件。</li>
<li><strong>响应式</strong>：状态改变自动触发 UI 更新。</li>
<li><strong>工程化</strong>：Vite 提供了高效的开发体验。</li>
<li><strong>可扩展</strong>：结构清晰，未来可轻松接入 Redux、TypeScript、SSR 等。</li>
</ul>
<blockquote>
<p>“真正的架构之美，不在于复杂，而在于简洁中的秩序。” —— 一位资深前端工程师</p>
</blockquote>
<p>现在，你不仅读懂了每一行代码，更理解了它们之间的关系。下一步，你可以：</p>
<ul>
<li>添加更多页面</li>
<li>使用 TypeScript 增强类型安全</li>
<li>引入 Redux 管理全局状态</li>
<li>配置 SSR 服务端渲染</li>
<li>发布到 GitHub Pages 或 Vercel</li>
</ul>
<p>愿你在 React 的世界里，越走越远，越飞越高！🚀</p>
<p>完整项目链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FgiaoZou%2Flesson_zp%2Ftree%2Fmaster%2Freact%2Freact-demo" title="https://gitee.com/giaoZou/lesson_zp/tree/master/react/react-demo" target="_blank" ref="nofollow noopener noreferrer">lesson_zp: AI + 全栈学习仓库</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析 React 组件化开发：从 Props 通信到样式管理的进阶指南]]></title>    <link>https://juejin.cn/post/7586688485727043590</link>    <guid>https://juejin.cn/post/7586688485727043590</guid>    <pubDate>2025-12-23T05:57:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586688485727043590" data-draft-id="7586585688005541929" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析 React 组件化开发：从 Props 通信到样式管理的进阶指南"/> <meta itemprop="keywords" content="React.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-23T05:57:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="San30"/> <meta itemprop="url" content="https://juejin.cn/user/1766294768060816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析 React 组件化开发：从 Props 通信到样式管理的进阶指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1766294768060816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    San30
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T05:57:06.000Z" title="Tue Dec 23 2025 05:57:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代前端开发的版图中，React 无疑是最具影响力的 UI 库之一。它引入的“组件化”思想，彻底改变了我们构建网页的方式。React 开发就像“拼积木”一样，通过将页面拆解为一个个独立、可复用的单元，极大地提升了开发效率与协作体验。</p>
<p>本文将结合具体的代码实例（如 <code>Greeting</code>、<code>Model</code>、<code>Card</code> 组件），深入探讨 React 入门阶段的核心知识点，包括 JSX 语法特性、Props 传值机制、组件复用模式以及多样化的样式管理方案。</p>
<h2 data-id="heading-1">一、 理解组件（Components）：构建 UI 的最小单元</h2>
<p>在 React 的世界里，<strong>一切皆组件</strong>。</p>
<h3 data-id="heading-2">1.1 组件的本质</h3>
<p>组件是开发任务的最小单元。正如我们在 <code>App.jsx</code> 中看到的，<code>App</code> 组件作为“老板”（根组件），负责调度和组合其他的“员工”组件（子组件）。</p>
<ul>
<li><strong>复用性</strong>：写好一个 <code>Card</code> 组件，可以在首页用，也可以在个人中心用。</li>
<li><strong>协作性</strong>：不同开发者可以并行开发不同的组件，最后组合在一起。</li>
<li><strong>嵌套结构</strong>：组件之间存在父子关系，形成了一棵庞大的组件树。</li>
</ul>
<h3 data-id="heading-3">1.2 函数式组件与解构赋值</h3>
<p>在<code>App.jsx</code>根组件中传递数据：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span>(
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"张三"</span> <span class="hljs-attr">message</span>=<span class="hljs-string">"欢迎学习React"</span> <span class="hljs-attr">showIcon</span> /&gt;</span></span>
    )
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<p>子组件获取接收数据的最现代的 React 组件写法：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ name, message = <span class="hljs-string">"Welcome!"</span>, showIcon }</span>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {showIcon &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>👋<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {name}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{message}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Greeting</span>;
</code></pre>
<p>这里使用了 <strong>ES6 对象的解构赋值</strong>。与其接收一个巨大的 <code>props</code> 对象，不如直接在参数位提取出 <code>name</code>、<code>message</code> 和 <code>showIcon</code>。这种写法不仅简洁，还允许我们直接为 <code>message</code> 设置默认值（Default Parameters）。</p>
<h2 data-id="heading-4">二、 核心通信机制：Props（属性）</h2>
<p>如果说组件是积木，那么 <strong>Props</strong> 就是连接积木的榫卯。</p>
<h3 data-id="heading-5">2.1 什么是 Props？</h3>
<p>Props 是 "Properties" 的缩写。它是父组件向子组件传递数据的主要方式。有两点至关重要：</p>
<ol>
<li><strong>State vs Props</strong>：State 是组件自有的、可变的数据；而 Props 是外部传入的、<strong>只读</strong>的数据。</li>
<li><strong>单向数据流</strong>：数据永远是从父组件流向子组件，子组件无权修改 Props。</li>
</ol>
<h3 data-id="heading-6">2.2 Props 的多种形态</h3>
<p>Props 的灵活性：</p>
<ul>
<li><strong>传递字符串</strong>：<code>&lt;Greeting name="张三" /&gt;</code></li>
<li><strong>传递布尔值</strong>：<code>&lt;Greeting showIcon /&gt;</code>（简写形式，等同于 <code>showIcon={true}</code>）</li>
<li><strong>传递表达式/数字</strong>：<code>&lt;Greeting name={123} /&gt;</code>（需使用花括号 <code>{}</code>）</li>
</ul>
<p>像上面这样，写在根组件中的子组件内的属性会成为<code>props</code>参数对象的属性，在之前的<code>react</code>开发中，在子组件我们可以在子组件中这样接收<code>props</code>参数对象：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {props.showIcon &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>👋<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {props.name}!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{props.message}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Greeting</span>;
</code></pre>
<h3 data-id="heading-7">2.3 Props 类型检查：PropTypes</h3>
<p>为了保证组件的健壮性，<code>Greeting.jsx</code> 使用了 <code>prop-types</code> 库：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title class_">Greeting</span>.<span class="hljs-property">propTypes</span> = {
    <span class="hljs-attr">name</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">string</span>.<span class="hljs-property">isRequired</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">string</span>,
    <span class="hljs-attr">showIcon</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">bool</span>,
}
</code></pre>
<p>这就像一份“合同”，规定了外部必须传入字符串类型的 <code>name</code>并且<code>name</code>要是必须传递的，因为加了<code>string</code>类型要求和<code>isRequired</code>必传属性，否则控制台会抛出相应的警告。这在大型团队协作中尤为重要。</p>
<h2 data-id="heading-8">三、 JSX 的魔法：JS in JSX 与 逻辑渲染</h2>
<p>JSX 允许我们在 JavaScript 中编写类似 HTML 的代码。但它本质上是 <code>React.createElement</code> 的语法糖。</p>
<h3 data-id="heading-9">3.1 变量插值与逻辑表达式</h3>
<ul>
<li><strong>内容插值</strong>：<code>{props.name}</code> 将 JS 变量渲染到 HTML 中。</li>
<li><strong>条件渲染</strong>：<code>{showIcon &amp;&amp; &lt;span&gt;👋&lt;/span&gt;}</code>。这是 JS “短路运算”的妙用，如果 <code>showIcon</code> 为真，则渲染图标。</li>
</ul>
<h3 data-id="heading-10">3.2 关键字避让</h3>
<p>由于 JSX 最终会编译成 JS，因此 HTML 属性名不能与 JS 关键字冲突。</p>
<ul>
<li><code>class</code> 必须写成 <code>className</code></li>
<li><code>for</code> 必须写成 <code>htmlFor</code>。</li>
</ul>
<h2 data-id="heading-11">四、 高级组件模式：Children 与插槽</h2>
<p>有时我们希望组件不仅能接收数据，还能接收“一段内容”。</p>
<h3 data-id="heading-12">4.1 props.children</h3>
<p>其中 <code>children</code> 的应用：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Card</span> = (<span class="hljs-params">{ className = <span class="hljs-string">''</span>, children }</span>) =&gt; {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">card</span> ${<span class="hljs-attr">className</span>}`}&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Card</span>;
</code></pre>
<p>当你在 <code>App.jsx</code> 中这样调用时：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">&lt;<span class="hljs-title class_">Card</span> className=<span class="hljs-string">"user-card"</span>&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>张三<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>高级前端工程师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Card</span>&gt;
</code></pre>
<p><code>&lt;h2&gt;</code> 和 <code>&lt;p&gt;</code> 标签会自动成为 <code>Card</code> 组件的<code>props</code>参数对象的 <code>children</code> 属性。这种模式极大增强了组件的<strong>通用性</strong>。</p>
<h3 data-id="heading-13">4.2 渲染属性（Render Props / Component Injection）</h3>
<p>更高阶的技巧：<strong>将组件作为 Props 传递</strong>。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Model</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">const</span> { <span class="hljs-title class_">HeaderComponent</span>, <span class="hljs-title class_">FooterComponent</span>, children } = props;
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.overlay}</span>&gt;</span>
            {HeaderComponent &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">HeaderComponent</span> /&gt;</span>}
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            {FooterComponent &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">FooterComponent</span> /&gt;</span>}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
<span class="hljs-keyword">const</span> styles = {
    <span class="hljs-attr">overlay</span>: {
        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.5)'</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'fixed'</span>,
        <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">right</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">bottom</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">display</span>: <span class="hljs-string">'flex'</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
    }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Model</span>;
</code></pre>
<p>在<code>App.jsx</code>中这样定义</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">MyHeader</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{margin:</span> <span class="hljs-attr">0</span>, <span class="hljs-attr">color:</span> '<span class="hljs-attr">lightblue</span>'}}&gt;</span> 自定义标题 <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>
  )
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">MyFooter</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{textAlign:</span> '<span class="hljs-attr">right</span>'}}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> alert('关闭弹窗')} style={{padding: '0.5rem 1rem'}}&gt;关闭弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
&lt;<span class="hljs-title class_">Model</span>
<span class="hljs-title class_">HeaderComponent</span>={<span class="hljs-title class_">MyHeader</span>}
<span class="hljs-title class_">FooterComponent</span>={<span class="hljs-title class_">MyFooter</span>}
&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>你可以在这里显示任何JSX<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Model</span>&gt; 
</code></pre>
<p>这种设计模式允许调用者完全自定义弹窗的头部（<code>HeaderComponent</code>）和底部（<code>FooterComponent</code>），而 <code>Model</code> 组件只负责布局逻辑和弹窗遮罩的展示。</p>
<h2 data-id="heading-14">五、 样式管理：多样化的 CSS 方案</h2>
<p>下面将展示两种主流的样式处理方式。</p>
<h3 data-id="heading-15">5.1 传统 CSS 与 Class 组合（<code>Card.css</code>）</h3>
<p>这是最符合传统开发习惯的方式。通过<strong>外部 CSS 文件</strong>定义样式，并利用 <code>className</code> 进行关联。</p>
<ul>
<li><strong>动态类名</strong>：在 <code>Card.jsx</code> 中，使用了模板字符串 <code>${className}</code>。这允许外部在使用 <code>Card</code> 时注入额外的类名（如 <code>user-card</code>），从而实现样式的覆盖和扩展。</li>
<li><strong>交互效果</strong>：<code>Card.css</code> 中利用 <code>.card:hover</code> 实现了浮动阴影效果，展示了传统 CSS 在处理伪类时的便捷。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'./Card.css'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Card</span> = (<span class="hljs-params">{ className = <span class="hljs-string">''</span>, children }</span>) =&gt; {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">card</span> ${<span class="hljs-attr">className</span>}`}&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Card</span>;
</code></pre>
<h3 data-id="heading-16">5.2 CSS in JS（<code>Model.jsx</code>）</h3>
<p>在 <code>Model.jsx</code> 中，样式是直接定义在 JS 对象里的：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> styles = {
    <span class="hljs-attr">overlay</span>: {
        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.5)'</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'fixed'</span>,
        <span class="hljs-comment">// ... 其他样式</span>
    }
}
</code></pre>
<p>如何调用？
<code>&lt;div style={styles.overlay}&gt;</code></p>
<p><strong>优点：</strong></p>
<ol>
<li><strong>逻辑绑定</strong>：样式与组件逻辑紧密结合，不担心类名冲突（局部作用域）。</li>
<li><strong>动态计算</strong>：可以根据 Props 轻松计算样式（例如：<code>color: props.isError ? 'red' : 'blue'</code>）。</li>
<li><strong>自包含</strong>：组件搬到哪里，样式就跟到哪里，无需额外引入 CSS 文件。</li>
</ol>
<h2 data-id="heading-17">六、 实战分析：构建一个可定制的 Card 系统</h2>
<p>通过分析这几个文件，我们可以梳理出构建高质量 React 组件的链路：</p>
<ol>
<li><strong>定义结构</strong>：使用 JSX 编写 HTML 骨架。</li>
<li><strong>提炼属性</strong>：确定哪些数据是变化的（name, message），将其设计为 Props。</li>
<li><strong>增强弹性</strong>：利用 <code>children</code> 允许外部注入内容，利用 <code>Component Props</code> 允许外部注入组件。</li>
<li><strong>规范约束</strong>：引入 <code>PropTypes</code> 进行类型校验。</li>
<li><strong>外观封装</strong>：结合 CSS 或 CSS in JS，并提供 <code>className</code> 接口供外部微调。</li>
</ol>
<h2 data-id="heading-18">七、 总结</h2>
<p>React 的学习曲线初看略陡，但只要掌握了 <strong>组件化</strong> 和 <strong>Props</strong> 这两个核心概念，剩下的就是对 JavaScript 基础的运用。</p>
<ul>
<li><strong>JSX</strong> 让我们拥有了在 UI 中自由运用 JS 逻辑的能力。</li>
<li><strong>Props</strong> 建立了组件间的契约，让数据流动变得清晰、可预测。</li>
<li><strong>Children 机制</strong> 则赋予了组件无限的扩展可能。</li>
</ul>
<p>无论是 <code>Greeting</code> 的简单传参，还是 <code>Model</code> 的组件注入，亦或是 <code>Card</code> 的样式混入，本质上都在解决同一个问题：<strong>如何在保持组件独立性的同时，最大化其复用性。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【实景三维】还再为渲染发愁？手把手教你大场景如何实现“精细”与“流畅”平衡！]]></title>    <link>https://juejin.cn/post/7586617459487588404</link>    <guid>https://juejin.cn/post/7586617459487588404</guid>    <pubDate>2025-12-23T06:08:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586617459487588404" data-draft-id="7586587644824092706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【实景三维】还再为渲染发愁？手把手教你大场景如何实现“精细”与“流畅”平衡！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T06:08:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【实景三维】还再为渲染发愁？手把手教你大场景如何实现“精细”与“流畅”平衡！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:08:25.000Z" title="Tue Dec 23 2025 06:08:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你需要搭建一个600平方公里的倾斜场景，要求近距离查看建筑细节时，墙面纹理、门窗结构清晰可辨；切换到大范围飞行漫游时，画面流畅不卡顿。那么，可以试试<strong>Mapmost</strong>，轻松实现**“近看精细、远飞流畅”**的效果。</p>
<p>当然，为了能让大家更好地应用<strong>Mapmost</strong>，我们今天来讲讲倾斜服务(3DTiles)渲染“背后”的故事。</p>
<p>首先，我们一起来了解一下两个基础概念——<strong>几何误差(GE)<strong>和</strong>屏幕空间误差(SSE)</strong>。</p>
<h2 data-id="heading-0">一、基础概念：GE与SSE到底是什么？</h2>
<p><strong>1. 几何误差(GE，Geometric Error)</strong></p>
<ul>
<li><strong>定义：<strong>GeometricError是3DTiles数据自带的属性，即在倾斜数据预处理(几何体简化或分块)过程中产生的数值，用来描述简化后</strong>几何体与原始几何体之间的偏差</strong>，简单说就是模型简化程度的量化值。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bc6687d932e44bc86115b32beffeb0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074905&amp;x-signature=MWtogx0MZmTYShUOxKIeYl2Nypo%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>作用：<strong>GeometricError</strong>越大</strong>，与原始几何体差距越大，<strong>细节损失越多</strong>；GeometricError<strong>越小</strong>，模型越贴近原始形态，<strong>细节越丰富</strong>。</li>
</ul>
<h3 data-id="heading-1">2. 屏幕空间误差(SSE，Screen-Space Error)</h3>
<ul>
<li><strong>定义：<strong>SSE是原始几何体与简化几何体映射到屏幕上的</strong>像素级偏差</strong>。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e96bf8c78f4a959adabaae8c337f18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074905&amp;x-signature=iATJ2Euk87esOqqecM0B%2Fg0hWOU%3D" alt="" loading="lazy"/></p>
<p>对3DTiles数据，可直接基于GeometricError以及相机与瓦片的距离、屏幕分辨率、视场角等实时参数动态计算得出SSE。</p>
<p>二者的转换关系示意图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42c45c4aa5b34392b12e5ed345960510~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074905&amp;x-signature=bH1NDHX%2B0P%2BUSU1vpm7KCHAnc1Q%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>据此，可根据相似三角形以及三角函数的相关公式推知：</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6893709b02c04aa28c87f04ea233a530~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074905&amp;x-signature=hmcUg3ho5qBmkZYl4Zh2jMVfrTY%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>其中es为屏幕空间误差，eg为几何误差，H为以像素为单位的渲染窗口的高度，d为相机到瓦片中心之间的距离，θf为视场角的大小。</p>
</li>
<li>
<p><strong>作用：<strong>前端通常会预设</strong>最大屏幕空间误差阈值</strong>，当计算出的瓦片SSE大于该阈值时，系统会判定当前瓦片细节不足，自动加载GeometricError更小的精细瓦片。</p>
</li>
</ul>
<h2 data-id="heading-2">二、Mapmost核心配置</h2>
<p>Mapmost基于3DTiles标准，开放了控制全局精度的核心参数maximumScreenSpaceError，该参数控制了视野中所有瓦片的清晰程度。</p>
<ul>
<li>**参数名：**maximumScreenSpaceError</li>
<li><strong>作用：<strong>定义SSE的最大阈值(值＞0)，值越小，允许的屏幕像素误差越小，模型越精细，但性能消耗越大。该参数有一个</strong>默认值16</strong>，即当瓦片SSE超过16时，系统就会加载下一级更精细的瓦片。</li>
<li>**取值原则：**中高端设备可设得低一点，低端或者移动设备可设得高一点。</li>
<li><strong>不同设置性能对比实测：</strong></li>
</ul>
<p>maximumScreenSpaceError取值</p>
<p>视口内瓦片数量（个）</p>
<p>首屏加载时间（秒）</p>
<p>32</p>
<p>61</p>
<p>3.25</p>
<p>8</p>
<p>450</p>
<p>8.10</p>
<h2 data-id="heading-3">三、进阶优化：动态瓦片清晰度调整</h2>
<p>除了通过maximumScreenSpaceError控制全局精度，<strong>Mapmost</strong>还提供了另外三个参数对倾斜视角场景进行了针对性优化。</p>
<p><strong><em>1. enableDynamicTileAdjust</em></strong></p>
<ul>
<li>**取值范围：**true/false</li>
<li><strong>作用：<strong>开启后，相机倾斜时，会自动降低远处瓦片的SSE，从而</strong>降低瓦片清晰度</strong>以提升性能。</li>
</ul>
<p><strong><em>2. dynamicTileAdjustRange</em></strong></p>
<ul>
<li><strong>取值范围：</strong>[0,1]</li>
<li>**作用：**可控制瓦片模糊范围控制，值越大，表示从远及近瓦片模糊范围越大；值为0时全屏采用原精度的瓦片。仅当enableDynamicTileAdjust为true时生效。</li>
</ul>
<p><strong><em>3.dynamicTileAdjustFactor</em></strong></p>
<ul>
<li><strong>取值范围：</strong>[0,+∞)</li>
<li>**作用：**可调节模糊强度，值越大，瓦片模糊程度越高；值为0时等同于关闭该优化。仅当enableDynamicTileAdjust为true时生效。</li>
</ul>
<p><strong><em>4. 适用场景</em></strong></p>
<p>适合<strong>大范围倾斜浏览、移动巡检、飞行漫游</strong>等场景，这类场景中远处瓦片占比大但无需精细显示，优化后可大幅缩短视野内倾斜瓦片的更新时间，如当在地图上平移或缩放时，倾斜模型的画面刷新时间可<strong>缩减30%以上</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c97621d96a9d4291bcaf315454f17d3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767074905&amp;x-signature=whkp12NDvvYuNEgGaSATG33%2FTvk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">四、结语</h2>
<p>几何误差(GE)作为3DTiles数据侧的<strong>简化基准</strong>，与屏幕空间误差(SSE)这一屏幕侧的视觉反馈，共同构成了<strong>可视化精度与性能平衡的核心逻辑</strong>。<strong>Mapmost</strong>精准把握二者关联，通过灵活的参数配置，让不同场景下的误差控制与性能优化更贴合实际需求，轻松实现**“清晰不卡顿、流畅不模糊”**的体验，是大规模三维地理空间数据可视化项目的可靠选择。</p>
<p>立即体验，开始三维开发之旅！<br/>
👉 点击访问官网免费试用：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mapmost.com%2F%23%2Flayout%2Fwebgl%2Fhome" target="_blank" title="https://www.mapmost.com/#/layout/webgl/home" ref="nofollow noopener noreferrer">Mapmost官网</a><br/>
👉 查看详细产品文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mapmost.com%2Fmapmost_docs%2Fwebgl%2Flatest%2Fdocs%2Fintro%2F" target="_blank" title="https://www.mapmost.com/mapmost_docs/webgl/latest/docs/intro/" ref="nofollow noopener noreferrer">产品概述 | Mapmost SDK for WebGL</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何用 Chrome DevTools 定位 Long Task：一份从零到实战的排查笔记]]></title>    <link>https://juejin.cn/post/7586684925106159659</link>    <guid>https://juejin.cn/post/7586684925106159659</guid>    <pubDate>2025-12-23T06:14:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586684925106159659" data-draft-id="7586688485727158278" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何用 Chrome DevTools 定位 Long Task：一份从零到实战的排查笔记"/> <meta itemprop="keywords" content="前端,性能优化"/> <meta itemprop="datePublished" content="2025-12-23T06:14:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sthenia"/> <meta itemprop="url" content="https://juejin.cn/user/4248168659951320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何用 Chrome DevTools 定位 Long Task：一份从零到实战的排查笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248168659951320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sthenia
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:14:51.000Z" title="Tue Dec 23 2025 06:14:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">如何用 Chrome DevTools 定位 Long Task：一份从零到实战的排查笔记</h2>
<p>在上篇我们已经介绍过如何记录和分析页面性能指标，但是只是发现网页卡顿现象还不够，我们还需要进一步定位卡顿的具体原因，才能有针对性地进行优化。</p>
<p>首先我们得了解为什么网页会卡顿。</p>
<p>网页卡顿通常是由于主线程被长时间占用，导致浏览器无法及时响应用户的交互操作。这些长时间影响主线程的运行任务，会被 Chrome DevTools 提供了 Performance 面板捕捉到，来帮助我们识别这些长任务（Long Tasks），从而找出性能瓶颈。</p>
<h3 data-id="heading-1">什么是 Long Task？</h3>
<p>Long Task 是指在主线程上执行时间超过 50 毫秒的任务。当主线程被长时间占用时，浏览器无法及时响应用户的交互操作，导致页面卡顿。通过识别和优化这些 Long Task，可以显著提升页面的响应速度和用户体验。</p>
<h3 data-id="heading-2">环境准备</h3>
<p>windows 10 + Chrome 143.0.7499.147</p>
<h3 data-id="heading-3">1. 搭一个可复现的 Long Task Demo</h3>
<p>为方便讲解，我们先实现了一个典型的卡顿页面：</p>
<ol>
<li>页面有一个 canvas 小球左右匀速运动，并实时显示 FPS。</li>
<li>提供“制造卡顿”按钮，点击后在主线程执行同步的重计算：
<ol>
<li>大数组 sort（O(n log n)）</li>
<li>加上 while 忙等 + 数值迭代循环，确保单次执行 300–700ms。</li>
</ol>
</li>
<li>连续执行 5 次，动画明显掉帧，点击响应也变慢。</li>
</ol>
<p>这个 demo 有两个关键点：</p>
<ol>
<li>可视化：肉眼能看到动画卡顿，方便和性能曲线一一对应。</li>
<li>可定位：核心耗时集中在一个明确函数 blockMainThread 里，便于在 DevTools 中识别。</li>
</ol>
<p>下面是一个简化版的 Demo 代码示例（完整代码可以参考项目中的 <code>page-long-task.html</code>）：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn-stutter"</span>&gt;</span>制造卡顿（5 次）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"c"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"400"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"200"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"c"</span>);
  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);
  <span class="hljs-keyword">let</span> x = <span class="hljs-number">20</span>,
    dir = <span class="hljs-number">1</span>;

  <span class="hljs-comment">// 简单小球动画，用来观察掉帧</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"/>) {
    ctx.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);
    ctx.<span class="hljs-title function_">beginPath</span>();
    ctx.<span class="hljs-title function_">arc</span>(x, canvas.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>, <span class="hljs-number">18</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
    ctx.<span class="hljs-title function_">fill</span>();
    x += dir * <span class="hljs-number">3</span>;
    <span class="hljs-keyword">if</span> (x &gt; canvas.<span class="hljs-property">width</span> - <span class="hljs-number">20</span>) dir = -<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">20</span>) dir = <span class="hljs-number">1</span>;
    <span class="hljs-title function_">requestAnimationFrame</span>(draw);
  }
  <span class="hljs-title function_">requestAnimationFrame</span>(draw);

  <span class="hljs-comment">// 核心：人为制造一个 300–600ms 的长任务</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">blockMainThread</span>(<span class="hljs-params">minMs = <span class="hljs-number">300</span>, maxMs = <span class="hljs-number">600</span></span>) {
    <span class="hljs-keyword">const</span> target = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * (maxMs - minMs + <span class="hljs-number">1</span>)) + minMs;
    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">12000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>());
    arr.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a - b);
    <span class="hljs-keyword">while</span> (performance.<span class="hljs-title function_">now</span>() - start &lt; target) {
      <span class="hljs-keyword">let</span> v = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3000</span>; i++) {
        v += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(i) % <span class="hljs-number">1.2345</span>;
      }
    }
  }

  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"btn-stutter"</span>).<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
      <span class="hljs-title function_">blockMainThread</span>(<span class="hljs-number">350</span>, <span class="hljs-number">650</span>);
    }
  };
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">2. 用 Performance 面板捕获长任务</h3>
<p>在 Chrome 打开 Performance 面板进行一次完整录制的标准步骤：</p>
<ol>
<li>打开 Performance 面板，点击 Record 开始录制。</li>
<li>回到页面，点击“制造卡顿”按钮。</li>
<li>等到动画恢复流畅后点击 Stop 停止录制。</li>
<li>观察几个关键轨道：
<ul>
<li>Frames：是否有红线和 FPS 明显下降。</li>
<li>Main：是否出现宽度大于 50 ms 的长紫/黄块（Long Task）。</li>
<li>Interactions：是否能对齐上用户的点击等交互事件。</li>
</ul>
</li>
</ol>
<p>任意单个主线程任务耗时 超过 ~50 ms，都会被视为 Long Task，它会阻塞渲染和输入事件。</p>
<p>我们看下我们 performance 录制的结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7f26f29dda8435bbf3e07241da7d4e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=1194KcQERenRMxasTU75b8IBPAY%3D" alt="" loading="lazy"/></p>
<p>上面结果中，我们可以在 Bottom-up 面板中，时间主要是消耗在 blockMainThread，并且指向代码位置</p>
<h3 data-id="heading-5">3. 解读 Bottom-up 面板</h3>
<p><strong>3.1 Bottom‑up 是什么</strong></p>
<ul>
<li>Bottom‑up 顾名思义，从高到低按“谁最耗时”聚合排序，从热点函数开始向上汇总。
对比：
<ul>
<li>Call tree：从入口（事件、任务）往下看调用顺序。</li>
<li>Bottom‑up：从最耗时的叶子函数往上看“被谁调用”。</li>
</ul>
</li>
</ul>
<p>它非常适合用来回答：“这一段时间里，CPU 主要花在了哪些函数上？”</p>
<p><strong>3.2 Self time vs Total time</strong></p>
<ul>
<li>Self time：函数“自身”执行的独占时间（不含子调用）。</li>
<li>Total time：函数自身 + 所有子调用的累计时间</li>
</ul>
<p>例如上面的例子，我们可以看到 blockMainThread 函数 Self Time 和 Total Time 占用了这次长任务的绝大部分时间。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fd90d2c51d246f6920665f595c56020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=NKR3VYUjYbe5rDhV8a%2FvqDPC7Cw%3D" alt="" loading="lazy"/></p>
<ul>
<li>长任务耗时：2614.4ms</li>
<li>blockMainThread 耗时： 2605ms</li>
</ul>
<p>blockMainThread 几乎和长任务时间一致了，是导致卡顿产生的主要原因。</p>
<p>在新版的 chrome 中，甚至可以看到每段代码的具体耗时，点击 blockMainThread 右侧的源码就可以看到：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1027a98c87f244dbac1a4f4beb07a0eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=ut2O32FbHc5HTn73ufXRsiw4mRo%3D" alt="" loading="lazy"/></p>
<p>耗时主要是消耗在了这段代码</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">while</span> (performance.<span class="hljs-title function_">now</span>() - start &lt; target) {
  <span class="hljs-keyword">let</span> v = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3000</span>; i++) {
    v += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(i) % <span class="hljs-number">1.2345</span>;
  }
}
</code></pre>
<p>小结:</p>
<ol>
<li>Self 高、Total≈Self
→ 重活都在函数本体里（如大循环、忙等、同步解析）。我们的 blockMainThread 就是这种情况。</li>
<li>Self 低、Total 高
→ 它是“调度/包装层”，真正热点在子函数里（例如一个封装函数里面调了排序、布局、GC 等）。</li>
</ol>
<p>在 Bottom‑up 中：</p>
<ol>
<li>先按 Total 或 Self 排序，看前几名热点函数。</li>
<li>若 Self≈Total，优先怀疑这个函数本体的实现。</li>
<li>若 Self 低而 Total 高，展开看子节点或切到 Call tree 继续追踪。</li>
</ol>
<h3 data-id="heading-6">4. 解读 Call tree 面板</h3>
<p><strong>Call tree 是什么</strong></p>
<p>以树形结构查看函数的子调用和耗时，面板展示信息基本和 Bottom-up 一致。也可以发现页面耗时在哪里发生，例如上面的截图我们通过一步步展开，查看 self time 耗时高的事件是什么</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44b999c9268f40a0b589379105608059~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=52wHlI2Q%2FYIM7yJVifnJKwHrz%2Fo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">实战</h3>
<p>上面我们用 demo 演示了如何调试和发现导致网页卡顿的基本操作，实际上项目会比 demo 要复杂一些，接下来我会以实际项目更近一步演示如何发现卡顿以及解决。</p>
<p><strong>背景</strong></p>
<p>公司有一个 SaaS 项目经常被用户吐槽很卡，在我们经过了一系列的埋点后，发现页面确实卡顿率高达 40%</p>
<p><strong>目标</strong></p>
<p>找出页面为什么引起卡顿的 long tasks，并且优化。</p>
<p><strong>环境介绍</strong></p>
<ul>
<li>windows 10</li>
<li>Chrome 143.0.7499.147</li>
<li>项目 react 16.9 + element-react 1.4.34</li>
</ul>
<p>这个项目使用的 element-react 组件库已经非常旧了，并且已经很久都不更新了，初步怀疑是 element-react 组件导致的卡顿</p>
<h4 data-id="heading-8">1. 利用 performance 进行收集数据</h4>
<p>根据上面 long-task 调试方法：</p>
<ol>
<li>打开 performance 面板，开始录制</li>
<li>打开目标页面</li>
<li>页面准备好，数据加载后，停止录制。</li>
</ol>
<p>在我的项目中可以看到页面 main time-line 中确实有非常多的 long-task</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9d62d8b9d1841b1af2075cccd41329f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=WbmC7ZQoFoqgAN7H7%2B8ybBCT3s4%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">2. 根据 performance 分析卡顿</h4>
<p>在 Bottom-up 面板中，选择一个较大 long task，我们可以发现其中耗时较大的事件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29fa6a8b3d7148f18745350018282e41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=oaO%2FyH0SbKOeFMryA4fvxJAXra0%3D" alt="" loading="lazy"/></p>
<p>其中 mask，measure 时间耗时非常高，long task 1458.6ms, mask 自己耗时占 730ms，measure 自己耗时 315ms，但是这个事件无法展开，也无法定位到源码，那怎么产生这两个事件呢？</p>
<p>经过查阅 chrome<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fdocs%2Fdevtools%2Fperformance%2Freference%3Fhl%3Dzh-cn" target="_blank" title="https://developer.chrome.com/docs/devtools/performance/reference?hl=zh-cn" ref="nofollow noopener noreferrer">文档</a>，才得知无法展开的事件属于浏览器内建（native）API，调用栈常被显示为“[unattributed]”或只到内建层，尤其在没有 SourceMap、被第三方库间接调用、或被 Ignore List/Blackbox 处理时，就看不到上层用户代码。</p>
<p>在 bottom-up 中，确实还有大量的其他内建 api 耗时，比如，Minor GC，appendChild。</p>
<p>上方截图中 mask，measure 是 performance api，怀疑是我们使用 performance 记录时，chrome 帮我们加的标记，所以先忽略继续看下一个耗时大的事件，而下一个 self time 耗时大的是 Recalculate style，并且是可以代码定位的，点击代码定位可以看到代码：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df97d4d9a7da4ceb9fd506186c21ef5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=nwNpCqIQredKrd%2BtHBdEzjuk31M%3D" alt="" loading="lazy"/></p>
<p>初步定位引起到卡顿的原因是 element-react -&gt; table 组件 -&gt; getScrollBarWidth 中计算 dom 宽度</p>
<h4 data-id="heading-10">真相大白</h4>
<p>虽然定位到 getScrollBarWidth 方法引起的，并且具体是计算 dom 宽度引起的卡顿，但是只是执行计算理应不会导致页面卡顿，是不是还是其他原因导致的卡顿？</p>
<p>继续分析，发现 getScrollBarWidth 方法是在 table 组件的 constructor 方法中调用的</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TableLayout</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span>&lt;
  <span class="hljs-title class_">TableLayoutProps</span>,
  <span class="hljs-title class_">TableLayoutState</span>
&gt; {
  <span class="hljs-keyword">static</span> childContextTypes = {
    <span class="hljs-attr">layout</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">any</span>,
  };

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props: TableLayoutProps</span>) {
    <span class="hljs-variable language_">super</span>(props);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {
      <span class="hljs-attr">height</span>: props.<span class="hljs-property">height</span> || props.<span class="hljs-property">maxHeight</span> || <span class="hljs-literal">null</span>, <span class="hljs-comment">// Table's height or maxHeight prop</span>
      <span class="hljs-attr">gutterWidth</span>: <span class="hljs-title function_">getScrollBarWidth</span>(), <span class="hljs-comment">// ar</span>
      <span class="hljs-comment">// ...</span>
    };

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">resizeListener</span> = <span class="hljs-title function_">throttle</span>(<span class="hljs-number">50</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">scheduleLayout</span>();
    });
  }
}
</code></pre>
<p>按道理来说，constructor 方法是在组件初始化时调用的，应该是调用了一次 getScrollBarWidth 而已，不会导致卡顿，那为什么还会卡顿呢？</p>
<p>会不会是因为在组件更新时，getScrollBarWidth 被多次调用导致的卡顿？</p>
<p>抱着试试看的心态，我们在 element-table 组件中加了日志，</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'%c [ componentDidMount ]-41'</span>, <span class="hljs-string">'font-size:13px; background:pink; color:#bf2c9f;'</span>)
}
<span class="hljs-title function_">componentWillUnmount</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'%c [ componentWillUnmount ]-86'</span>, <span class="hljs-string">'font-size:13px; background:pink; color:#bf2c9f;'</span>)
}
</code></pre>
<p>发现确实是在组件更新时被多次调用了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac82424461a4437cb87b876f345fc76d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU3RoZW5pYQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075291&amp;x-signature=yYdvKWfWzxwtySrfnSvdZ8tY8EY%3D" alt="" loading="lazy"/></p>
<p>被重载了200次...，相当于执行了200次 getScrollBarWidth中的计算节点宽度。</p>
<p>但是为什么会被重载200次呢？我继续分析 element-table 组件，既然是在constructor中调用到getScrollBarWidth方法，那应该是再往上追溯，应该是在调用elemenet-table组件时的业务逻辑导致重复渲染了多次，element-table 组件是无辜的，不要冤枉element。</p>
<p>然后我在业务代码中调用table组件时，代码是这样写的：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
 <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Table</span>
      // <span class="hljs-attr">....</span>
      <span class="hljs-attr">key</span>=<span class="hljs-string">{this.key++}</span>
      <span class="hljs-attr">colData</span>=<span class="hljs-string">{this.colData}</span>
      <span class="hljs-attr">datas</span>=<span class="hljs-string">{list}</span>
    /&gt;</span></span>
  );
}
</code></pre>
<p>问题很显然了，key 属性每次 render 时都会自增，导致 element-table 组件被重新渲染了 200 次，而 getScrollBarWidth 方法是在 constructor 中调用的。</p>
<p><strong>解决以及重新记录数据</strong></p>
<p>解决方法方法就很简单了，将 key 去掉。猜测以前加key应该是有些场景，table数据不更新导致table没有重新渲染，所以加了key来强制重新渲染，开发人员已经离职无从考证了，但是现在我们已经找到了问题的根源，就直接去掉 key 属性，重新运行项目。</p>
<p>重新执行 performance，发现已经没有Recalculate style了，long task 去掉mask 和 measure已经不算是long task了。</p>
<h3 data-id="heading-11">总结</h3>
<p>通过这次实战，我们成功定位并解决了页面卡顿的问题。主要步骤包括：</p>
<ol>
<li>使用 Chrome DevTools 的 Performance 面板捕获页面的长任务（Long Tasks）。</li>
<li>通过 Bottom-up 和 Call tree 面板分析长任务的具体原因，定位到耗时函数。</li>
<li>结合代码逻辑，找出导致函数多次调用的根本原因。</li>
<li>进行代码优化，重新测试确认问题解决。</li>
</ol>
<p>通过这种系统的方法，我们不仅解决了当前的性能问题，还为未来的性能优化提供了宝贵的经验。希望这篇文章能帮助大家更好地理解和应用 Chrome DevTools 来提升网页性能。</p>
<p>如果觉得有用的话麻烦“👍 赞”支持一下，谢谢！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react中useMemo和useCallback的使用场景]]></title>    <link>https://juejin.cn/post/7586584105742204978</link>    <guid>https://juejin.cn/post/7586584105742204978</guid>    <pubDate>2025-12-23T06:25:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586584105742204978" data-draft-id="7586663700900249609" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react中useMemo和useCallback的使用场景"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T06:25:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="user7142265964578"/> <meta itemprop="url" content="https://juejin.cn/user/2824011125884926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react中useMemo和useCallback的使用场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824011125884926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    user7142265964578
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:25:23.000Z" title="Tue Dec 23 2025 06:25:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">先说结论</h3>
<ol>
<li><strong>为了计算性能</strong>：遇到<strong>大数组遍历</strong>、<strong>复杂算法</strong> -&gt; 用 <code>useMemo</code>。</li>
<li><strong>为了引用稳定</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>要传给 <code>React.memo</code> 包裹的子组件的<strong>对象/数组</strong> -&gt; 用 <code>useMemo</code>。</li>
<li>要传给 <code>React.memo</code> 包裹的子组件的<strong>函数</strong> -&gt; 用 <code>useCallback</code>。</li>
<li>函数或对象要放进 <code>useEffect</code> <strong>的依赖数组</strong>里 -&gt; 用 <code>useMemo</code> <strong>/</strong> <code>useCallback</code>。</li>
</ul>
</li>
</ul>
<p>除此之外，直接写原生 JS 代码即可。</p>
<hr/>
<h3 data-id="heading-1">一、 什么时候使用 <code>useMemo</code>？</h3>
<p><code>useMemo</code> 的作用是<strong>缓存计算结果</strong>。</p>
<h4 data-id="heading-2">1. 进行昂贵的计算（Expensive Calculation）时</h4>
<p>如果你的组件内部有一个计算过程非常耗时（例如：遍历数万条数据、复杂的数学运算、图像处理），你不希望每次组件重新渲染（比如只是输入框打字）都重新计算一遍。</p>
<ul>
<li><strong>标准</strong>：如果计算耗时超过 1ms（肉眼不可见，但在低端设备累积会卡顿），或者处理数组长度很大。</li>
<li><strong>代码示例</strong>：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// ❌ 每次 render 都会运行，导致卡顿
const <span class="hljs-attr">filteredList</span> = hugeList.filter(item =&gt; item.includes(query))<span class="hljs-comment">;</span>

// ✅ 只有当 hugeList 或 query 变化时才重新计算
const <span class="hljs-attr">filteredList</span> = useMemo(() =&gt; {
  return hugeList.filter(<span class="hljs-attr">item</span> =&gt; item.includes(query))<span class="hljs-comment">;</span>
}, <span class="hljs-section">[hugeList, query]</span>)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-3">2. 防止子组件不必要的渲染（引用稳定性）</h4>
<p>这是最常见但也最容易被忽略的用法。<br/>
在 JavaScript 中，<code>{ a: 1 } !== { a: 1 }</code>（每次创建的对象引用地址不同）。<br/>
如果你的子组件使用了 <code>React.memo</code> 包裹，但你传给它的 props 是一个在父组件中动态生成的<strong>对象</strong>或<strong>数组</strong>，那么 <code>React.memo</code> 会失效，因为每次父组件渲染，生成的对象引用都变了。</p>
<ul>
<li><strong>代码示例</strong>：</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Parent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// ❌ 每次 Parent 渲染，config 都是一个新的对象引用</span>
  <span class="hljs-comment">// 导致 Child 认为 props 变了，从而强制重新渲染</span>
  <span class="hljs-keyword">const</span> config = { <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span> }; 
  
  <span class="hljs-comment">// ✅ 缓存了对象引用，只有依赖变了引用才变</span>
  <span class="hljs-keyword">const</span> memoConfig = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span> }), []);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">config</span>=<span class="hljs-string">{memoConfig}</span> /&gt;</span></span>;
};

<span class="hljs-comment">// Child 被 memo 包裹</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ config }</span>) =&gt;</span> { ... });
</code></pre>
<hr/>
<h3 data-id="heading-4">二、 什么时候使用 <code>useCallback</code>？</h3>
<p><code>useCallback</code> 的作用是<strong>缓存函数引用</strong>。</p>
<p>它的核心用途<strong>只有一个</strong>：<strong>维持函数引用的稳定性，以配合</strong> <code>React.memo</code> <strong>或</strong> <code>useEffect</code> <strong>使用。</strong></p>
<h4 data-id="heading-5">1. 将函数传递给经过优化的子组件（React.memo）</h4>
<p>这是 <code>useCallback</code> 90% 的使用场景。<br/>
如果你把一个函数传给子组件，而子组件用了 <code>React.memo</code>，你不希望父组件渲染时，因为“函数是新创建的”而导致子组件也跟着渲染。</p>
<ul>
<li><strong>代码示例</strong>：</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Parent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// ❌ 每次 Parent 渲染，handleClick 都是一个全新的函数指针</span>
  <span class="hljs-comment">// 导致 BigList 组件的 props 发生变化，破坏了 React.memo 的效果</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Clicked'</span>);
  };

  <span class="hljs-comment">// ✅ 缓存函数引用，只要依赖不变，handleClick 永远是同一个引用</span>
  <span class="hljs-keyword">const</span> memoHandleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Clicked'</span>);
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(c =&gt; c + 1)}&gt;加一<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      
      {/* 如果不传 memoHandleClick，这里的 memo 就白写了 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">BigList</span> <span class="hljs-attr">onItemClick</span>=<span class="hljs-string">{memoHandleClick}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
};

<span class="hljs-keyword">const</span> <span class="hljs-title class_">BigList</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ onItemClick }</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'BigList Rendered'</span>); <span class="hljs-comment">// 使用 useCallback 后，点击“加一”不会触发这里</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>List...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
});
</code></pre>
<h4 data-id="heading-6">2. 函数作为 <code>useEffect</code> 的依赖项时</h4>
<p>如果你的 <code>useEffect</code> 依赖于外部传入的一个函数，为了避免 <code>useEffect</code> 无限循环或者频繁触发，这个函数必须被 <code>useCallback</code> 包裹。</p>
<ul>
<li><strong>代码示例</strong>：</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">ChatRoom</span>({ roomId, createConnection }) {
  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    const connection = <span class="hljs-built_in">createConnection</span>(roomId);
    connection<span class="hljs-selector-class">.connect</span>();
    return () =&gt; connection<span class="hljs-selector-class">.disconnect</span>();
  <span class="hljs-comment">// 如果 createConnection 没有被 useCallback 包裹，</span>
  <span class="hljs-comment">// 每次父组件渲染都会导致这里重跑，连接断开又重连</span>
  }, <span class="hljs-selector-attr">[roomId, createConnection]</span>); 
}
</code></pre>
<hr/>
<h3 data-id="heading-7">三、 什么时候不需要？（避坑指南）</h3>
<p>很多新手会把所有函数和变量都包上，<strong>这是错误的</strong>。</p>
<ol>
<li><strong>简单的计算</strong>：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">// ❌ 没必要，useMemo 本身也有开销（内存分配、依赖比较）
const <span class="hljs-attr">total</span> = useMemo(() =&gt; price * quantity, [price, quantity])<span class="hljs-comment">;</span>

// ✅ 直接算就好，JS 引擎算这种东西极快
const <span class="hljs-attr">total</span> = price * quantity<span class="hljs-comment">;</span>
</code></pre>
<ol start="2">
<li><strong>子组件没有使用</strong> <code>React.memo</code>：<br/>
如果子组件只是一个普通的 <code>div</code> 或者没有用 <code>memo</code> 包裹的组件，你给它传 <code>useCallback</code> 包裹的函数是<strong>完全浪费</strong>的。因为不管 props 变没变，子组件都会跟着父组件一起重新渲染。</li>
<li><strong>仅仅为了“看起来优化了”</strong> ：<br/>
<code>useMemo</code> 和 <code>useCallback</code> 会占用额外的内存，并且 React 需要在每次渲染时对比依赖数组。滥用会导致性能更差，代码可读性降低。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端水印实战：给你的页面穿上“隐形盔甲”]]></title>    <link>https://juejin.cn/post/7586680977855168575</link>    <guid>https://juejin.cn/post/7586680977855168575</guid>    <pubDate>2025-12-23T06:27:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586680977855168575" data-draft-id="7586680977855152191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 前端水印实战：给你的页面穿上“隐形盔甲”"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T06:27:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JS_Likers"/> <meta itemprop="url" content="https://juejin.cn/user/1377017277975032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             前端水印实战：给你的页面穿上“隐形盔甲”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1377017277975032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JS_Likers
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:27:50.000Z" title="Tue Dec 23 2025 06:27:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎使用我的小程序👇👇👇👇</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d25c4001b1b4e6e902dc1f8863bcef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSlNfTGlrZXJz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767076070&amp;x-signature=vg7%2BQlaT7ffX4smqMWMBnYtnyxk%3D" alt="small.png" loading="lazy"/></p>
<hr/>
<p>水印就像网页的“数字纹身”，既保护版权又不影响用户体验。今天我们来聊聊如何在前端优雅地添加水印，让敏感信息既可见又安全！</p>
<h2 data-id="heading-0">一、为什么需要水印？💭</h2>
<p>想象一下，你的内部数据分析页面被截图外泄了——如果有水印，就能立刻追踪到泄露源头！水印主要用途：</p>
<ul>
<li><strong>版权保护</strong>：防止图片、文档被滥用</li>
<li><strong>溯源追踪</strong>：内部系统截图可追溯责任人</li>
<li><strong>状态标识</strong>：区分测试/生产环境</li>
<li><strong>品牌展示</strong>：低调展示品牌信息</li>
</ul>
<h2 data-id="heading-1">二、水印实现方案对比 🆚</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[前端水印方案选择] --&gt; B{需求场景}
    
    B --&gt;|简单文字/logo| C[CSS背景水印]
    B --&gt;|动态内容/复杂效果| D[Canvas生成]
    B --&gt;|高清晰度/可缩放| E[SVG水印]
    
    C --&gt; C1[实现简单]
    C --&gt; C2[性能最优]
    
    D --&gt; D1[功能最强大]
    D --&gt; D2[可生成图片]
    
    E --&gt; E1[矢量不失真]
    E --&gt; E2[兼容性好]
</code></pre>
<h2 data-id="heading-2">三、实战：三种水印实现方式 ✨</h2>
<h3 data-id="heading-3">方案一：CSS背景水印（最简单！）</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.watermarked-page</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
}

<span class="hljs-selector-class">.watermarked-page</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">pointer-events</span>: none; <span class="hljs-comment">/* 关键！让点击穿透 */</span>
  <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'data:image/svg+xml;utf8,&lt;svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"&gt;&lt;text x="20" y="40" transform="rotate(-45 100 100)" fill="rgba(0,0,0,0.1)" font-size="16"&gt;内部使用 严禁外传&lt;/text&gt;&lt;/svg&gt;'</span>);
  <span class="hljs-attribute">background-repeat</span>: repeat;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">9999</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"watermarked-page"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 你的页面内容 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>优点</strong>：实现简单，性能好
<strong>缺点</strong>：水印内容固定，容易被移除</p>
<h3 data-id="heading-4">方案二：Canvas动态生成（最灵活！）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Watermark</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">text = <span class="hljs-string">'内部文档'</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = text
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>()
  }
  
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建画布生成水印图</span>
    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>)
    canvas.<span class="hljs-property">width</span> = <span class="hljs-number">200</span>
    canvas.<span class="hljs-property">height</span> = <span class="hljs-number">150</span>
    
    <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)
    ctx.<span class="hljs-title function_">rotate</span>(-<span class="hljs-number">20</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span>)
    ctx.<span class="hljs-property">font</span> = <span class="hljs-string">'16px Microsoft Yahei'</span>
    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'rgba(128, 128, 128, 0.1)'</span>
    ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span>, <span class="hljs-number">10</span>, <span class="hljs-number">80</span>)
    
    <span class="hljs-comment">// 将水印作为背景</span>
    <span class="hljs-keyword">const</span> watermarkDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
    watermarkDiv.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background-image: url(<span class="hljs-subst">${canvas.toDataURL()}</span>);
      background-repeat: repeat;
      z-index: 9999;
    `</span>
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span> = watermarkDiv
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(watermarkDiv)
  }
  
  <span class="hljs-comment">// 添加用户信息</span>
  <span class="hljs-title function_">setUserInfo</span>(<span class="hljs-params">user</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = <span class="hljs-string">`<span class="hljs-subst">${user.name}</span> <span class="hljs-subst">${user.id}</span> <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleDateString()}</span>`</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">update</span>()
  }
  
  <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>.<span class="hljs-title function_">remove</span>()
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>()
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> watermark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watermark</span>(<span class="hljs-string">'张三 - 2024-03-15'</span>)
</code></pre>
<h3 data-id="heading-5">方案三：SVG水印（最清晰！）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createSVGWatermark</span>(<span class="hljs-params">text, options = {}</span>) {
  <span class="hljs-keyword">const</span> { color = <span class="hljs-string">'rgba(0,0,0,0.1)'</span>, fontSize = <span class="hljs-number">16</span> } = options
  
  <span class="hljs-keyword">const</span> svg = <span class="hljs-string">`
    &lt;svg xmlns="http://www.w3.org/2000/svg" width="300" height="200"&gt;
      &lt;text 
        x="50%" 
        y="50%" 
        font-size="<span class="hljs-subst">${fontSize}</span>"
        fill="<span class="hljs-subst">${color}</span>"
        text-anchor="middle"
        transform="rotate(-45, 150, 100)"
        font-family="Arial"
      &gt;
        <span class="hljs-subst">${text}</span>
      &lt;/text&gt;
    &lt;/svg&gt;
  `</span>
  
  <span class="hljs-keyword">return</span> <span class="hljs-string">`url('data:image/svg+xml;utf8,<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(svg)}</span>')`</span>
}

<span class="hljs-comment">// 应用到页面</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">style</span>.<span class="hljs-property">backgroundImage</span> = <span class="hljs-title function_">createSVGWatermark</span>(
  <span class="hljs-string">`机密文件 • <span class="hljs-subst">${navigator.userAgent.slice(<span class="hljs-number">0</span>, <span class="hljs-number">30</span>)}</span>`</span>
)
</code></pre>
<h2 data-id="heading-6">四、高级技巧：防篡改水印 🛡️</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as 用户
    participant P as 页面
    participant O as 观察器
    participant W as 水印层
    
    U-&gt;&gt;P: 尝试删除水印元素
    O-&gt;&gt;O: MutationObserver检测到DOM变化
    O-&gt;&gt;W: 通知水印被修改
    W-&gt;&gt;W: 立即恢复水印
    W-&gt;&gt;P: 记录操作日志
    Note over P,W: 同时检查开发者工具&lt;br/&gt;定期验证水印完整性
</code></pre>
<h3 data-id="heading-7">实现防删除水印：</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProtectedWatermark</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-literal">null</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initProtection</span>()
  }
  
  <span class="hljs-title function_">initProtection</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 创建水印</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createWatermark</span>()
    
    <span class="hljs-comment">// 2. 监听DOM变化</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(<span class="hljs-function">(<span class="hljs-params">mutations</span>) =&gt;</span> {
      mutations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">mutation</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isWatermarkRemoved</span>(mutation)) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'检测到水印被修改，正在恢复...'</span>)
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">recoverWatermark</span>()
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">logViolation</span>()
        }
      })
    })
    
    <span class="hljs-comment">// 3. 开始监听</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>, {
      <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">attributes</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>
    })
    
    <span class="hljs-comment">// 4. 定期检查水印完整性</span>
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkWatermark</span>(), <span class="hljs-number">1000</span>)
    
    <span class="hljs-comment">// 5. 防止控制台查看</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">preventConsole</span>()
  }
  
  <span class="hljs-title function_">createWatermark</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建水印元素...</span>
  }
  
  <span class="hljs-title function_">isWatermarkRemoved</span>(<span class="hljs-params">mutation</span>) {
    <span class="hljs-comment">// 检查水印是否被移除或修改</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// 简化示例</span>
  }
  
  <span class="hljs-title function_">preventConsole</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 禁用F12和右键检查</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'F12'</span> || 
          (e.<span class="hljs-property">ctrlKey</span> &amp;&amp; e.<span class="hljs-property">shiftKey</span> &amp;&amp; e.<span class="hljs-property">key</span> === <span class="hljs-string">'I'</span>) ||
          (e.<span class="hljs-property">ctrlKey</span> &amp;&amp; e.<span class="hljs-property">key</span> === <span class="hljs-string">'u'</span>)) {
        e.<span class="hljs-title function_">preventDefault</span>()
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'为了保护内容安全，此功能已被禁用'</span>)
      }
    })
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'contextmenu'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> e.<span class="hljs-title function_">preventDefault</span>())
  }
}
</code></pre>
<h2 data-id="heading-8">五、实用水印组件 🎁</h2>
<p>这里是一个开箱即用的水印组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// watermark.js - 完整组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Watermark</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = {
      <span class="hljs-attr">text</span>: <span class="hljs-string">'Watermark'</span>,
      <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>,
      <span class="hljs-attr">color</span>: <span class="hljs-string">'rgba(0,0,0,0.1)'</span>,
      <span class="hljs-attr">angle</span>: -<span class="hljs-number">20</span>,
      <span class="hljs-attr">density</span>: <span class="hljs-string">'normal'</span>, <span class="hljs-comment">// sparse, normal, dense</span>
      <span class="hljs-attr">monitor</span>: <span class="hljs-literal">true</span>,
      ...config
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>()
  }
  
  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createCanvas</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyToPage</span>()
    
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">monitor</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startMonitoring</span>()
    }
    
    <span class="hljs-comment">// 适应窗口变化</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">update</span>())
  }
  
  <span class="hljs-title function_">createCanvas</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>)
    <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>)
    
    <span class="hljs-comment">// 根据密度设置画布大小</span>
    <span class="hljs-keyword">const</span> size = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">density</span> === <span class="hljs-string">'sparse'</span> ? <span class="hljs-number">400</span> : 
                  <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">density</span> === <span class="hljs-string">'dense'</span> ? <span class="hljs-number">150</span> : <span class="hljs-number">250</span>
    
    canvas.<span class="hljs-property">width</span> = size
    canvas.<span class="hljs-property">height</span> = size
    
    <span class="hljs-comment">// 绘制水印</span>
    ctx.<span class="hljs-property">font</span> = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.config.fontSize}</span>px Arial`</span>
    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">color</span>
    ctx.<span class="hljs-property">textAlign</span> = <span class="hljs-string">'center'</span>
    ctx.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">'middle'</span>
    
    ctx.<span class="hljs-title function_">translate</span>(canvas.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>, canvas.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>)
    ctx.<span class="hljs-title function_">rotate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">angle</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span>)
    
    <span class="hljs-comment">// 支持多行文本</span>
    <span class="hljs-keyword">const</span> lines = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">text</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>)
    lines.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">line, index</span>) =&gt;</span> {
      ctx.<span class="hljs-title function_">fillText</span>(
        line, 
        <span class="hljs-number">0</span>, 
        index * <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">fontSize</span> - (lines.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">fontSize</span> / <span class="hljs-number">2</span>
      )
    })
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span> = canvas
  }
  
  <span class="hljs-title function_">applyToPage</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 移除旧水印</span>
    <span class="hljs-keyword">const</span> oldWatermark = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'global-watermark'</span>)
    <span class="hljs-keyword">if</span> (oldWatermark) oldWatermark.<span class="hljs-title function_">remove</span>()
    
    <span class="hljs-comment">// 创建新水印层</span>
    <span class="hljs-keyword">const</span> watermark = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)
    watermark.<span class="hljs-property">id</span> = <span class="hljs-string">'global-watermark'</span>
    watermark.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      background-image: url(<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.canvas.toDataURL()}</span>);
      background-repeat: repeat;
      z-index: 2147483647; /* 最大z-index */
      opacity: 0.8;
    `</span>
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(watermark)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span> = watermark
  }
  
  <span class="hljs-title function_">update</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-keyword">if</span> (config) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>, ...config }
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createCanvas</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyToPage</span>()
  }
  
  <span class="hljs-title function_">destroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">element</span>.<span class="hljs-title function_">remove</span>()
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>.<span class="hljs-title function_">disconnect</span>()
    }
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Watermark</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./watermark.js'</span>

<span class="hljs-comment">// 基础使用</span>
<span class="hljs-keyword">const</span> watermark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watermark</span>({
  <span class="hljs-attr">text</span>: <span class="hljs-string">'内部使用\n严禁外传'</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-string">'rgba(255, 0, 0, 0.08)'</span>,
  <span class="hljs-attr">density</span>: <span class="hljs-string">'dense'</span>
})

<span class="hljs-comment">// 动态更新</span>
watermark.<span class="hljs-title function_">update</span>({
  <span class="hljs-attr">text</span>: <span class="hljs-string">`用户：张三\n时间：<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleString()}</span>`</span>
})
</code></pre>
<h2 data-id="heading-9">六、最佳实践与注意事项 📝</h2>
<ol>
<li>
<p><strong>性能优化</strong>：</p>
<ul>
<li>使用CSS <code>will-change: transform</code> 提升渲染性能</li>
<li>对于动态内容，考虑使用<code>requestAnimationFrame</code>进行更新</li>
<li>移动端适当降低水印密度</li>
</ul>
</li>
<li>
<p><strong>安全须知</strong>：</p>
<ul>
<li>前端水印≠绝对安全，敏感数据还需后端保护</li>
<li>水印信息可以加密或编码</li>
<li>考虑使用不可见的数字水印</li>
</ul>
</li>
<li>
<p><strong>用户体验</strong>：</p>
<ul>
<li>水印透明度建议在0.05-0.15之间</li>
<li>避免遮挡重要操作区域</li>
<li>提供水印显隐切换（权限可控）</li>
</ul>
</li>
<li>
<p><strong>兼容性处理</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 优雅降级方案</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>).<span class="hljs-property">getContext</span>) {
  <span class="hljs-comment">// 使用纯CSS或SVG回退方案</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'使用基础水印方案'</span>)
}
</code></pre>
</li>
</ol>
<h2 data-id="heading-10">七、创意水印灵感 💡</h2>
<p>想让水印更有趣？试试这些创意：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 动态水印（随时间变化）</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  watermark.<span class="hljs-title function_">update</span>({
    <span class="hljs-attr">text</span>: <span class="hljs-string">`北京时间：<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleTimeString()}</span>`</span>
  })
}, <span class="hljs-number">60000</span>)

<span class="hljs-comment">// 2. 随机位置水印</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">randomWatermark</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> texts = [<span class="hljs-string">'保密'</span>, <span class="hljs-string">'内部'</span>, <span class="hljs-string">'机密'</span>, <span class="hljs-string">'严禁外传'</span>]
  <span class="hljs-keyword">const</span> randomText = texts[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * texts.<span class="hljs-property">length</span>)]
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watermark</span>({
    <span class="hljs-attr">text</span>: randomText,
    <span class="hljs-attr">angle</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">60</span> - <span class="hljs-number">30</span>, <span class="hljs-comment">// -30° 到 30°</span>
    <span class="hljs-attr">color</span>: <span class="hljs-string">`rgba(<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">100</span>}</span>, <span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">100</span>}</span>, 255, 0.1)`</span>
  })
}

<span class="hljs-comment">// 3. 用户特定水印</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">userSpecificWatermark</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-comment">// 生成唯一用户识别图案</span>
  <span class="hljs-keyword">const</span> hash = <span class="hljs-title function_">md5</span>(userId) <span class="hljs-comment">// 使用哈希函数</span>
  <span class="hljs-keyword">const</span> pattern = hash.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">6</span>)
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watermark</span>({
    <span class="hljs-attr">text</span>: pattern,
    <span class="hljs-attr">fontSize</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">density</span>: <span class="hljs-string">'dense'</span>
  })
}
</code></pre>
<h2 data-id="heading-11">总结 🎯</h2>
<p>前端水印就像给页面穿上了一件“隐形盔甲”——平时不影响美观，关键时刻却能提供重要保护。选择哪种方案，取决于你的具体需求：</p>
<ul>
<li><strong>简单展示</strong> → CSS背景水印</li>
<li><strong>动态灵活</strong> → Canvas生成</li>
<li><strong>高清需求</strong> → SVG水印</li>
<li><strong>安全敏感</strong> → 防篡改方案</li>
</ul>
<p>记住，没有完美的方案，只有最适合的方案。希望这篇指南能帮你找到最适合的水印实现方式！</p>
<hr/>
<p><strong>小挑战</strong>：你能实现一个水印，当用户尝试截图时自动添加“截图警告”文字吗？试试看，这是很好的实践机会！</p>
<p>（注：本文示例代码可直接使用，但生产环境请根据实际情况调整安全策略）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>