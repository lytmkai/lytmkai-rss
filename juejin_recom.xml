<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[SpringBoot自动配置的黑魔法：5个你可能不知道的底层原理]]></title>    <link>https://juejin.cn/post/7602161364892729344</link>    <guid>https://juejin.cn/post/7602161364892729344</guid>    <pubDate>2026-02-03T04:18:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602161364892729344" data-draft-id="7602161364892712960" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot自动配置的黑魔法：5个你可能不知道的底层原理"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-02-03T04:18:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot自动配置的黑魔法：5个你可能不知道的底层原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T04:18:49.000Z" title="Tue Feb 03 2026 04:18:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot自动配置的黑魔法：5个你可能不知道的底层原理</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>SpringBoot的自动配置（Auto-configuration）是其最引人注目的特性之一，它极大地简化了Spring应用的开发流程。许多开发者享受着"开箱即用"的便利，却对其背后的实现机制知之甚少。本文将深入探讨SpringBoot自动配置的五个底层原理，揭示那些隐藏在<code>@EnableAutoConfiguration</code>注解背后的"黑魔法"。通过理解这些机制，你不仅能更好地驾驭SpringBoot，还能在遇到问题时快速定位根源。</p>
<hr/>
<h2 data-id="heading-2">主体内容</h2>
<h3 data-id="heading-3">1. 条件化Bean注册：<code>@Conditional</code>的进化史</h3>
<p>自动配置的核心在于<strong>按需加载</strong>，而这正是通过Spring 4.0引入的条件化机制实现的。</p>
<p><strong>深度解析：</strong></p>
<ul>
<li><code>@ConditionalOnClass</code>的实际工作原理：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target({ElementType.TYPE, ElementType.METHOD})</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Conditional(OnClassCondition.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ConditionalOnClass {
    Class&lt;?&gt;[] value() <span class="hljs-keyword">default</span> {};
    String[] name() <span class="hljs-keyword">default</span> {};
}
</code></pre>
<p>关键在于<code>OnClassCondition</code>这个实现类，它会在运行时通过<code>ClassNameFilter</code>检查类路径：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ConditionOutcome[] getOutcomes(String[] autoConfigurationClasses,
        AutoConfigurationMetadata autoConfigurationMetadata) {
    ConditionOutcome[] outcomes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionOutcome</span>[autoConfigurationClasses.length];
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; outcomes.length; i++) {
        <span class="hljs-type">String</span> <span class="hljs-variable">autoConfigurationClass</span> <span class="hljs-operator">=</span> autoConfigurationClasses[i];
        <span class="hljs-keyword">if</span> (autoConfigurationClass != <span class="hljs-literal">null</span>) {
            outcomes[i] = getOutcome(autoConfigurationMetadata.get(autoConfigurationClass, <span class="hljs-string">"ConditionalOnClass"</span>));
        }
    }
    <span class="hljs-keyword">return</span> outcomes;
}
</code></pre>
<p><strong>进阶知识：</strong></p>
<ul>
<li>SpringBoot对条件注解做了性能优化：在应用启动时会将所有auto-configuration类的条件评估结果缓存起来</li>
<li><code>spring-autoconfigure-metadata.properties</code>文件的作用：提前存储条件判断所需元数据，避免反射开销</li>
</ul>
<h3 data-id="heading-4">2. 自动配置的加载机制：超越classpath扫描</h3>
<p>传统的Spring应用依赖组件扫描，而SpringBoot的自动配置采用了更高效的加载方式。</p>
<p><strong>关键流程：</strong></p>
<ol>
<li><code>META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports</code></li>
<li><code>spring.factories</code>中的淘汰机制（SpringBoot 2.7+已弃用）</li>
<li>导入处理器(<code>AutoConfigurationImportSelector</code>)的工作过程：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) {
    <span class="hljs-keyword">if</span> (!isEnabled(annotationMetadata)) {
        <span class="hljs-keyword">return</span> NO_IMPORTS;
    }
    <span class="hljs-type">AutoConfigurationEntry</span> <span class="hljs-variable">autoConfigurationEntry</span> <span class="hljs-operator">=</span> getAutoConfigurationEntry(annotationMetadata);
    <span class="hljs-keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());
}
</code></pre>
<p><strong>性能优化点：</strong></p>
<ul>
<li>使用<code>AutoConfigurationSorter</code>对配置类进行拓扑排序</li>
<li><code>@AutoConfigureAfter</code>和<code>@AutoConfigureBefore</code>的实现原理</li>
<li>排除机制的双重保障：<code>exclude()</code>属性和条件评估</li>
</ul>
<h3 data-id="heading-5">3. 配置属性的绑定魔法：宽松绑定与类型安全</h3>
<p>从<code>application.properties/yaml</code>到<code>@Bean</code>属性的映射过程比表面看起来更复杂。</p>
<p><strong>类型转换体系：</strong></p>
<ol>
<li><code>Binder.bind()</code>方法的调用链</li>
<li><code>ConversionService</code>的特殊处理逻辑：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> &lt;T&gt; Object <span class="hljs-title function_">convertValue</span><span class="hljs-params">(BindContext context, Object value, ResolvableType targetType)</span> {
    <span class="hljs-type">ConversionService</span> <span class="hljs-variable">conversionService</span> <span class="hljs-operator">=</span> context.getConversionService();
    <span class="hljs-keyword">if</span> (conversionService.canConvert(value.getClass(), targetType)) {
        <span class="hljs-keyword">return</span> conversionService.convert(value, targetType);
    }
    <span class="hljs-keyword">return</span> value;
}
</code></pre>
<p><strong>高级特性：</strong></p>
<ul>
<li>List/Map的特殊处理规则</li>
<li>Duration等时间类型的智能解析</li>
<li><code>@ConstructorBinding</code>与不可变类的配合使用</li>
<li>Relaxed Binding的实现细节（如将`socket-timeout映射为socketTimeout）</li>
</ul>
<h3 data-id="heading-6">4. SPI扩展点设计："约定优于配置"的工程实践</h3>
<p>SpringBoot大量使用了Java SPI机制来实现可扩展性。</p>
<p><strong>核心扩展接口一览表：</strong></p>

























<table><thead><tr><th>接口</th><th>用途</th><th>典型实现</th></tr></thead><tbody><tr><td><code>ApplicationContextInitializer</code></td><td>上下文初始化</td><td><code>ConditionEvaluationReportLoggingListener</code></td></tr><tr><td><code>ApplicationListener&lt;E&gt;</code></td><td>事件监听</td><td><code>BackgroundPreinitializer</code>, <code>EnvironmentPostProcessorApplicationListener</code></td></tr><tr><td><code>EnvironmentPostProcessor</code></td><td>Environment定制</td><td><code>CloudFoundryVcapEnvironmentPostProcessor</code></td></tr></tbody></table>
<p><strong>自定义扩展实战：</strong>
如何编写自己的自动配置模块：</p>
<ol>
<li>创建/META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports文件</li>
<li>实现典型的条件注解组合：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@AutoConfigureAfter({DataSourceAutoConfiguration.class})</span>
<span class="hljs-meta">@ConditionalOnClass({JdbcTemplate.class, DataSource.class})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCustomAutoConfig</span> {

    <span class="hljs-meta">@Bean</span> 
    <span class="hljs-meta">@ConditionalOnMissingBean</span> 
    <span class="hljs-keyword">public</span> MyCustomComponent <span class="hljs-title function_">myComponent</span><span class="hljs-params">()</span> {...}
}
</code></pre>
<p>###5. Bean后处理的艺术:`BeanPostProcessor'的高级玩法</p>
<p>自动配置中大量使用了Bean后置处理器来实现动态行为。</p>
<p>典型案例分析:
1. ConfigurationPropertiesBindingPostProcessor的属性绑定流程
2. WebServerFactoryCustomizerBeanPostProcessor对嵌入式容器的定制</p>
<p>核心代码片段:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span> 
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean,String beanName)</span>{
<span class="hljs-keyword">if</span>(bean <span class="hljs-keyword">instanceof</span> WebServerFactory webServerFactory){
postProcessWebServerFactory(webServerFactory);}<span class="hljs-keyword">return</span> bean;}
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessWebServerFactory</span><span class="hljs-params">(...)</span>{
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> customizer:customizers){customizer.customize(factory);}}
</code></pre>
<p>隐藏技巧:
• SmartInitializingSingleton的特殊作用时机
• ImportAware与注入元数据的巧妙结合
• BeanDefinitionRegistryPostProcessor在自动配置中的关键应用</p>
<hr/>
<p>##总结</p>
<p>通过对这五个底层原理的深入剖析我们可以发现 SpringBoot的自动配置绝非简单的"约定优于配詈"。其背后融合了:</p>
<p>1.精细的条件判断系统<br/>
2.高效的资源配置加载机制<br/>
3．强大的属性转换体系<br/>
4．可扩展的SPI架构设计<br/>
5．灵活的Bean生命周期控制</p>
<p>理解这些黑魔法不仅能让我们更好地解决实际开发中遇到的问题更能启发我们设计出更加优雅的系统架构。下次当你的应用神奇地"just work"时不妨思考一下背后这些精妙的工程设计。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Agent Skills 做知识库检索，能比传统 RAG 效果更优吗？]]></title>    <link>https://juejin.cn/post/7602252722373279795</link>    <guid>https://juejin.cn/post/7602252722373279795</guid>    <pubDate>2026-02-03T04:47:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602252722373279795" data-draft-id="7602206323460440115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Agent Skills 做知识库检索，能比传统 RAG 效果更优吗？"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2026-02-03T04:47:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ConardLi"/> <meta itemprop="url" content="https://juejin.cn/user/3949101466785709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Agent Skills 做知识库检索，能比传统 RAG 效果更优吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3949101466785709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ConardLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T04:47:53.000Z" title="Tue Feb 03 2026 04:47:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本期视频教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RkFAznESD%2F" target="_blank" title="https://www.bilibili.com/video/BV1RkFAznESD/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1Rk…</a></p>
</blockquote>
<p>使用 Agent Skills 做知识库检索，是一种什么体验？</p>
<p>它能比传统的分块+向量匹配的 RAG 效果更好吗？</p>
<p>大家好，欢迎来到 code秘密花园，我是花园老师，这一期我们进入 Agent Skills 的实战章节。</p>
<h2 data-id="heading-0">基础回顾</h2>
<p>我们上期视频介绍了 Skills 的工作原理和使用方法，我们简单回顾一下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d38d684a449143d0819b76a8a622e543~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=JfJ0ijf8UnqwYkxvG%2BBG2zPVsdE%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>Skills 是最近 Anthropic 推出的一个 Agent 领域的行业标准，它本身就是一个文件夹，里面存放着具体的使用说明（SKILL.md），更详细的参考文档（reference），以及可执行脚本（script）。</p>
</blockquote>
<p>它的核心特性就是渐进式加载策略：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3b823eebd564278892f1d241ba2e7e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=nTPEElLoLptozv8ZgpFb9n7NL84%3D" alt="" loading="lazy"/></p>
<ul>
<li>在 Agent 启动时，仅将所有 Skills 的基本描述加入 AI 的上下文</li>
<li>当用户发出需求时，AI 会根据 Skill 的描述判断具体要调用哪个 Skill</li>
<li>决定后再去读取这个 Skill 的使用说明（SKILL.md）</li>
<li>然后再根据使用说明进一步读取更详细的参考文档，以及决定是否执行某个脚本来连接外部世界</li>
</ul>
<p>通过这样的模式，可以让 Agent 既能节省大量的上下文，又能够精准响应用户需求找到并执行某个技能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c790c943a22445b0a5d48861467ed681~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=SZI0rVcGMYo7%2BGO%2Bc3T%2Fmhyanb8%3D" alt="" loading="lazy"/></p>
<p>Skills 的使用也非常简单，你只需要把它的文件夹放到特定 Agent 的目录下（如 .claude/skills），AI 就会在下次启动时识别到这个 Skill，并根据用户需求判断是否调用。</p>
<p>下面，我们来实战探索一下，Skill 有哪些有意思的玩法。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc33f13fdaab4e45b8b3ceccbcaf5015~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=6r6SR7kGbYgXAS9NQYDAP5vqfGI%3D" alt="" loading="lazy"/></p>
<p>熟悉我的粉丝都知道，我本人对传统的通过 Chunk + Embedding 这种实现 RAG 的模式有比较大的偏见。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a509df7b1d6940bd9024dc7cc72926d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=DCWLIB7vTlRBkF3Iv2530F0tV3o%3D" alt="" loading="lazy"/></p>
<p>虽然这种模式最终也能调教出比较好的结果，但调优过程实在是太痛苦了，我是真正经历过毒打的才会有这种感觉。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/900867ce1b744c52a16bab6844d044ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=ge2mdvdNgrfAZQAdhL7IpHG3HJg%3D" alt="" loading="lazy"/></p>
<p>相信很多同学也感同身受，所以我一直感觉这种方案只是当下的一种妥协模式，终究会被时代淘汰的。</p>
<p>最近 LlamaIndex 创始人 Jerry Liu 发表的 Twitter 刚好比较符合我的观点：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31a6f70956ab4d1c95de2964465b18b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=JORqBJMsbIHZXn00WsfpzfSlngQ%3D" alt="" loading="lazy"/></p>
<p>RAG / 检索本身没死，但死的是固定 Chunk + Embedding 那套模式。如果 Agent 可以动态地扩展文件周围的上下文，那么过度考虑数据块大小就没有意义了。</p>
<h2 data-id="heading-1">预期目标</h2>
<p>想象 Agent Skills 的渐进式批漏策略，是不是有点这个意思呢。</p>
<p>所以，我们考虑用 Skills 的设计模式，来实现一个专用于知识检索的 Skill，我期望它能帮我解决下面的问题：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c564a27c617042c293ef28d08f15e5ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=9Wv0zxvTEYU0wJNlvLaOFx8cYoE%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>在指定目录里检索你关心的问题</strong>：比如：「从公司内部知识库里找出最近三年的销售趋势结论」「从某个项目资料里找出所有性能优化建议」。</li>
<li><strong>跨多种文件格式联合查询</strong>：能根据文件类型选择合适的方式来读取和理解，比如 Markdown、PDF、Excel 等，不需要你操心「这份资料是什么格式」。</li>
<li><strong>避免「暴力打开整库」</strong>：不能一上来就把所有文件全部读进来，而是像人一样：先按关键词缩小范围，再精准打开少量相关文件，快速定位答案。</li>
<li><strong>按问题来组织结果</strong>：不能简单地给你一堆「命中行」，而是结合上下文，把和问题相关的内容拼在一起，尽量给出一条可读的、成段的回答。</li>
<li><strong>在复杂问题上做多轮查找</strong>：比如你问的是「对某个政策的关键影响」，它可能先在目录里锁定几份核心 PDF，再在这些 PDF 里按章节检索，再结合结果总结回答。</li>
</ul>
<h2 data-id="heading-2">效果演示</h2>
<p>下面，我们先来演示下效果，我们先创建一个示例知识库，其中包含下面这些数据：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55a42cfc28104117ae8ea8590fd8ec09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=dnRLZbhFFU%2Fez5UY9T%2BWjGLz9RQ%3D" alt="" loading="lazy"/></p>
<p>知识库包含四个不同领域的知识，包含 markdown、pdf、excel 等多种文件类型：</p>
<ul>
<li>Financial Report Data：金融与上市公司财报类数据，主要是按公司和季度划分的 PDF 报告。</li>
<li>E-commerce Data：电商业务相关的数据文件，如员工、客户、库存和订单等结构化数据。</li>
<li>Safety Knowledge：安全相关知识与文档，涵盖常见 Web 安全漏洞及防护方案。</li>
<li>AI Knowledge：AI 行业与技术相关报告与研究资料，用于检索 AI 技术发展、应用场景及治理趋势。</li>
</ul>
<p>我们先问一个金融领域具体的数据问题：</p>
<blockquote>
<p>检索知识库：三一重工前三大股东？</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aeb0c172cc44eec9bf33c7d5fef5436~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=22yjCiKJzrqpwvDWTeoMvUF4A24%3D" alt="" loading="lazy"/></p>
<p>这个数据存储在三一重工的 Q3 财报内：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc46a013f25340b6a68452171a279d25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=3Ty02p84NnV1cSGxH%2Bkkm7W2g7w%3D" alt="" loading="lazy"/></p>
<p>检索结果如下，因为首次需要定位文件、转换 PDF 文件，耗时还是比较长的，但是检索到的信息非常准确， 大家在实际使用的时候可以把所有的 PDF 都提前转成 Markdown，效率会高很多。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14e3a09331b84a8db203ed418473cfc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=pv%2BjOjK79gY1ejUTaxzAS%2FHcTPM%3D" alt="" loading="lazy"/></p>
<p>接下来我们继续追问这个文件的问题（介绍三一重工的母公司资产负债表），速度就会快很多了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4934c4356064d19a14f1f48123b0558~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=PXRb25d84oQy7hnZ6H8k1TG6ggI%3D" alt="" loading="lazy"/></p>
<p>接下来，我们问另外一个文件的问题：</p>
<blockquote>
<p>航天动力前十股东总持股？</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f62090bca104f5b92d7a7a9b00dc2ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=lkSP8UbuWh7wapK%2BnG6FY7QdoRw%3D" alt="" loading="lazy"/></p>
<p>这时我们观察一下它的执行流程（整个过程是非常智能化的）：</p>
<ul>
<li>首先通过 Glob 匹配 “航天动力” 这几个关键字，定位到文件</li>
<li>然后调用 Python 工具将航天动力财报的 PDF 文件处理成 txt</li>
<li>接下来根据用户的问题，自己拆解出需要匹配的关键字（股东信息、前 10 名股东 ...）</li>
<li>根据初步匹配到的信息，去文件特定行数检索（offset=380 limit 260）</li>
<li>然后发现这些信息不足以回答问题，再检索更多上下文（offset=520 limit=260）</li>
</ul>
<p>下面，我们尝试问另外一个电商领域的问题：</p>
<blockquote>
<p>郑雪买了啥？</p>
</blockquote>
<p>要回答这个问题需要分析两个 Excel 表：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/650b6f3e21cf474e822470d20f18f205~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=99IVGeb8b1X0dzyhL3qiMvqqRXg%3D" alt="" loading="lazy"/></p>
<ul>
<li>通过顾客表找到名叫郑雪的客户的 ID</li>
<li>在订单表根据客户 ID 找到购买的商品</li>
</ul>
<p>看一下分析结果，依然准确找到了数据：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbbd2f1a318945ef94b72935d2863edb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=hXHJBQnoDiIHhNoT8e1%2BYEN40cw%3D" alt="" loading="lazy"/></p>
<p>我们再追问一个更复杂的问题：有哪些用户买了 儿童绘本 ，在什么时间？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a505f87a8d784446bd19131deaea8c4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=Pc0hqg7Sp9oOx42GdE7zUusPVFw%3D" alt="" loading="lazy"/></p>
<p>这次 Agent 更快的给出了结果，这个过程已经比较接近于我理想的 AI 智能知识检索的形态了，大家觉得怎么样呢。</p>
<h2 data-id="heading-3">原理介绍</h2>
<p>下面，我们来看看这个 Skill 的实现原理，对于一个能执行 Skill  的 Agent（如 opencode)，本身它已经具备了一些基础的文件检索能力（ls、grep、glob），我们只需要在这个 Skill 中教会 AI 如何更好的使用这些能力：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3198c909fbee43b8be613e1d5fd43f98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=frAnedPtr0krsokNZla80AHoFU8%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>定位领域</strong>：通过分析用户的问题，然后结合知识库的目录索引定位出知识可能存在的领域（文件夹）。</li>
<li><strong>定位文件</strong>：使用 grep 这样的方式在指定目录、文件里筛选出「可能相关的文件」，然后再按需用不同工具去读取这些文件的关键部分。</li>
<li><strong>定位内容</strong>：针对不同文件类型用不同策略：
<ul>
<li><strong>Markdown / 文本</strong>：直接定位到匹配段落，结合上下文分析</li>
<li><strong>PDF</strong>：编写代码调用专门的 PDF 能力按页、按章节提取内容</li>
<li><strong>Excel</strong>：编写代码读取 Excel，然后只看跟问题相关的表、行、列，而不是把整份表格搬出来</li>
</ul>
</li>
</ul>
<p>这里有两条关键设计原则：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9986cc905cf841ef92d13ba594cb1bf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=voG2rPHfmr872kZizVaqWUFuC7c%3D" alt="" loading="lazy"/></p>
<ul>
<li>渐进式检索：尽量少读但读准，优先查「最可能有答案」的文件，读取文件内容时仅读取相关行，必要时再扩展范围，避免无意义的 Token 消耗。</li>
<li>保持简单可控：用户只需要告诉它知识库在什么位置，其余的检索策略都由 skill 自动完成。</li>
</ul>
<p>另外想要让知识检索的更高效和精准，还有两个技巧：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ac36be32785418ba0cd5f3e28edc43e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=znb7kbJXL%2F57vu%2B2grKq7mlUY7Y%3D" alt="" loading="lazy"/></p>
<ul>
<li>文件夹尽量按领域划分，每个文件夹下只包含特定领域下的文件</li>
<li>每个文件夹下都有一个目录索引文件 data_structure.md（如果文件命名不规范、且包含 PDF 等非纯文本的文件格式，这个是必要的），这个文件中描述了当前文件夹下每个文件的用途（这里参考了 Skill 的渐进式披露的设计原则，如果有多级嵌套领域（目录），AI 找到了这个领域后才会读取这个领域的目录索引）。</li>
</ul>
<hr/>
<p>那这个 Skill 怎么实现呢，其实你把上面我们提到的核心流程、设计原则、关键技巧给到我们上个教程中讲到的 skill-creator 这个 skill ，AI 自己就帮我们创建出来了，我们只需要经过细微的调整，下面我们来看下我们的 Skill 的目录结构：</p>
<ul>
<li><strong>SKILL.md</strong> ：是这个技能的使用说明书，里面描述了如何找到本地知识库目录、如何根据目录索引逐层检索知识、对不同文件的处理方式（参考哪个文档）、最终的回答风格等等</li>
<li><strong>references</strong>：放置 PDF、Excel 等特殊文件类型的解析方法，只有确定当前知识需要具体分析一个 PDF、Excel 或其他特殊的文件类型时，再查阅详细的处理文档，可以节省 Token 和注意力。</li>
<li><strong>scripts</strong>：放置 PDF 文件的特殊处理脚本（如解析 PDF、PDF 转图片等等）</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf7138ec81b0474aaaf4ee994b2c9f0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=FzNnrM6BuZ2VFsBbeyx0DTui%2F4E%3D" alt="" loading="lazy"/></p>
<p>我们可以把这套方案可以理解为「不预建向量库的、本地目录级、渐进式检索 RAG」，的优势主要在于：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb0fb9ed203f405bbd1c762a6f382fbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=A05YpDlCT0vqsIb3n65PRRd36FY%3D" alt="" loading="lazy"/></p>
<ul>
<li>不需要预建索引 / 向量数据库，更轻量简单，适合快速搭建本地个人知识库的场景；</li>
<li>检索更智能，传统的 RAG 主要靠向量匹配内容，大模型只做总结，而在这个过程里，大模型可以参与分词、上下文匹配的决策，并且可以进行智能调整，其实就是一个 Agentic RAG 的工作模式。</li>
</ul>
<p>当前这只是一个初步的尝试，它还有一定的缺陷：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24377c8d45f1406091234daf36763f1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=xocurE9mIUFDW0TnrAnw9m5GnkM%3D" alt="" loading="lazy"/></p>
<ul>
<li>首次检索的效率问题：如果分析到的文件是一个 PDF 或其他特殊格式，需要先调用脚本进行转换，首次效率低（推荐预处理为纯文本）</li>
<li>Skill 调用稳定性：在多轮检索后，AI 可能会忘记去调用 Skill（第一次命中率还是比较高的），从而丢失一些关键的处理步骤，这个在很多其他的 Skill 上也会有类似的问题，可能需要从 Agent 层面解决。</li>
<li>Token 消耗更大：因为整个检索过程是 AI 控制的，当首次没有检索到想要的答案，AI 会继续切换一些新的参数或文件进行检索，直到找到最终结果，虽然结果更准确，但也更消耗 Token。</li>
</ul>
<h2 data-id="heading-4">让已有文档站秒变知识库</h2>
<p>刚刚我们介绍的 Skill 是一个通用的知识检索的尝试，但如果你有一个固定格式的知识库（比如一个文档站，里面已经包含了多个本地文件），你可以通过 Skill Creator 让它去自己分析你的文档站，然后创建出符合你的文档站风格的知识检索 Skill，我们可以在一个已有文档站下输入下面的提示词：</p>
<blockquote>
<p>当前项目是一个文档站（包含多个 md、mdx 文件），我想创建一个专用于知识库检索的 Skill，它可以替代传统的 RAG ，用于当前文章站的知识检索，你来帮我创建这个 Skill（使用中文）。Skills 的基本思路是，先根据用户的问题，提取出需要检索的可能关键字，然后使用 Grep 命令找到对应的上下文。然后分析上下文，如果检索到的信息和问题不符合需要继续检索其他可能关键字，最大重试五次。</p>
</blockquote>
<p>我们尝试在 Easy Dataset 文档站（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FConardLi%2Feasy-dataset-docs%25EF%25BC%2589%25E5%2588%259B%25E5%25BB%25BA%25E4%25B8%2580%25E4%25B8%25AASkill" target="_blank" title="https://github.com/ConardLi/easy-dataset-docs%EF%BC%89%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AASkill" ref="nofollow noopener noreferrer">github.com/ConardLi/ea…</a> ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b862b53001624aa585ae04f286e6b2af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=qCe7Xf7kp%2BG9Kk7UqrtEJB7kLtw%3D" alt="" loading="lazy"/></p>
<p>下面尝试问个问题：</p>
<blockquote>
<p>检索知识库：如何使用 Easy Dataset 生成评估数据集？</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4432fb6b8c74efb81605a131bb254a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=tGN8gqkPLB20vCI8xsUYgVMDi8w%3D" alt="" loading="lazy"/></p>
<p>由于这个文档站全是纯本文文档（没有 PDF 等特殊格式）检索速度非常快而起效果非常不错。</p>
<p>再问个问题：</p>
<blockquote>
<p>检索知识库：Easy Dataset 有哪些分块策略？</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dbce2ec11b34a3fbff5b08b6da135c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29uYXJkTGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770698910&amp;x-signature=wIR8PAD2pIQ1cYA1evkKbC7Q%2BzQ%3D" alt="" loading="lazy"/></p>
<p>通过这种模式，你可以把任意已经存在的本地知识库变成一个可以进行智能知识检索的 skill。</p>
<h2 data-id="heading-5">最后</h2>
<p>关注《code秘密花园》从此学习 AI 不迷路，相关链接：</p>
<ul>
<li>本文中用到的知识检索 Skill：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FConardLi%2Frag-skill%2F" target="_blank" title="https://github.com/ConardLi/rag-skill/" ref="nofollow noopener noreferrer">github.com/ConardLi/ra…</a></li>
<li>AI 教程完整汇总：<a href="https://link.juejin.cn?target=https%3A%2F%2Frncg5jvpme.feishu.cn%2Fwiki%2FU9rYwRHQoil6vBkitY8cbh5tnL9" target="_blank" title="https://rncg5jvpme.feishu.cn/wiki/U9rYwRHQoil6vBkitY8cbh5tnL9" ref="nofollow noopener noreferrer">rncg5jvpme.feishu.cn/wiki/U9rYwR…</a></li>
<li>相关学习资源汇总在：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FConardLi%2Feasy-learn-ai" target="_blank" title="https://github.com/ConardLi/easy-learn-ai" ref="nofollow noopener noreferrer">github.com/ConardLi/ea…</a></li>
</ul>
<p>如果本期对你有所帮助，希望得到一个免费的三连，感谢大家支持！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[纯CSS实现发送验证码读秒倒数 - if函数妙用]]></title>    <link>https://juejin.cn/post/7602146335215599656</link>    <guid>https://juejin.cn/post/7602146335215599656</guid>    <pubDate>2026-02-03T02:39:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602146335215599656" data-draft-id="7602072652607062056" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="纯CSS实现发送验证码读秒倒数 - if函数妙用"/> <meta itemprop="keywords" content="CSS,前端"/> <meta itemprop="datePublished" content="2026-02-03T02:39:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="juejin_cn"/> <meta itemprop="url" content="https://juejin.cn/user/3016715636324125"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            纯CSS实现发送验证码读秒倒数 - if函数妙用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3016715636324125/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    juejin_cn
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:39:29.000Z" title="Tue Feb 03 2026 02:39:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>点击发送短信验证码倒数60秒后可重新发送，借助 <code>if()</code> 纯 CSS 也能实现这样的效果。</p>
<blockquote>
<p>要求 Chrome/Edge ≥ 137</p>
</blockquote>
<p><span href="https://code.juejin.cn/pen/7602229993149562916" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7602229993149562916" data-src="https://code.juejin.cn/pen/7602229993149562916" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<ul>
<li>
<p><code>@property</code> 是 CSS Houdini API 的一部分，用来定义 CSS 自定义属性。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@property</span> --num {
  syntax: <span class="hljs-string">"&lt;integer&gt;"</span>;
  initial-value: <span class="hljs-number">0</span>;
  inherits: true;
}
</code></pre>
</li>
<li>
<p>CSS 函数 <code>if()</code> 允许根据条件测试的结果为属性设置不同的值。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">label</span> {
  <span class="hljs-attr">--num</span>: <span class="hljs-built_in">var</span>(--sec);
  counter-set: count <span class="hljs-built_in">var</span>(--num);
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--num: <span class="hljs-built_in">var</span>(--sec)): blue; style(<span class="hljs-attr">--num</span>: <span class="hljs-number">0</span>): blue; else: <span class="hljs-number">#999</span>; );
  <span class="hljs-attribute">pointer-events</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--num: <span class="hljs-built_in">var</span>(--sec)): initial; style(<span class="hljs-attr">--num</span>: <span class="hljs-number">0</span>): initial; else: none; );
}
</code></pre>
</li>
<li>
<p>CSS 函数 <code>counter()</code> 返回一个代表计数器的当前值的字符串。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">label</span><span class="hljs-selector-pseudo">:has</span>(<span class="hljs-selector-tag">input</span><span class="hljs-selector-pseudo">:checked</span>)<span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--num: <span class="hljs-number">0</span>): <span class="hljs-string">"重新发送"</span>; else: <span class="hljs-built_in">counter</span>(count) <span class="hljs-string">"秒后可重新发送"</span>; );
}
</code></pre>
</li>
<li>
<p>CSS 函数 <code>steps()</code> 定义了一个过渡效果，将输入时间划分为指定数量的等长间隔。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">label</span><span class="hljs-selector-pseudo">:has</span>(<span class="hljs-selector-tag">input</span><span class="hljs-selector-pseudo">:checked</span>) {
  <span class="hljs-attr">--num</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">transition</span>: --num <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--sec) * <span class="hljs-number">1s</span>) <span class="hljs-built_in">steps</span>(<span class="hljs-built_in">var</span>(--sec), jump-start);
}
</code></pre>
</li>
</ul>
<p>完整代码：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>纯CSS实现发送验证码读秒倒数 - if函数妙用<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-keyword">@property</span> --num {
      syntax: <span class="hljs-string">"&lt;integer&gt;"</span>;
      initial-value: <span class="hljs-number">0</span>;
      inherits: true;
    }
    <span class="hljs-selector-pseudo">:root</span> {
      <span class="hljs-attr">--sec</span>: <span class="hljs-number">11</span>;
    }
    <span class="hljs-selector-tag">label</span> {
      <span class="hljs-attr">--num</span>: <span class="hljs-built_in">var</span>(--sec);
      counter-set: count <span class="hljs-built_in">var</span>(--num);
      <span class="hljs-attribute">color</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--num: <span class="hljs-built_in">var</span>(--sec)): blue; style(<span class="hljs-attr">--num</span>: <span class="hljs-number">0</span>): blue; else: <span class="hljs-number">#999</span>; );
      <span class="hljs-attribute">pointer-events</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--num: <span class="hljs-built_in">var</span>(--sec)): initial; style(<span class="hljs-attr">--num</span>: <span class="hljs-number">0</span>): initial; else: none; );
      <span class="hljs-attribute">cursor</span>: pointer;
    }
    <span class="hljs-selector-tag">label</span><span class="hljs-selector-pseudo">::after</span> {
      <span class="hljs-attr">--num</span>: inherit;
      <span class="hljs-attribute">content</span>: <span class="hljs-string">"发送验证码"</span>;
    }
    <span class="hljs-selector-tag">label</span><span class="hljs-selector-pseudo">:has</span>(<span class="hljs-selector-tag">input</span><span class="hljs-selector-pseudo">:checked</span>)<span class="hljs-selector-pseudo">::after</span> {
      <span class="hljs-attribute">content</span>: <span class="hljs-built_in">if</span>(<span class="hljs-built_in">style</span>(--num: <span class="hljs-number">0</span>): <span class="hljs-string">"重新发送"</span>; else: <span class="hljs-built_in">counter</span>(count) <span class="hljs-string">"秒后可重新发送"</span>; );
    }
    <span class="hljs-selector-tag">label</span><span class="hljs-selector-pseudo">:has</span>(<span class="hljs-selector-tag">input</span><span class="hljs-selector-pseudo">:checked</span>) {
      <span class="hljs-attr">--num</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">transition</span>: --num <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--sec) * <span class="hljs-number">1s</span>) <span class="hljs-built_in">steps</span>(<span class="hljs-built_in">var</span>(--sec), jump-start);
    }
    <span class="hljs-selector-tag">label</span> <span class="hljs-selector-tag">input</span> {
      <span class="hljs-attribute">display</span>: none;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"send-code"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"send-code"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[KingbaseES数据库：ksql 命令行玩转索引与视图，从创建到避坑]]></title>    <link>https://juejin.cn/post/7601464318409457706</link>    <guid>https://juejin.cn/post/7601464318409457706</guid>    <pubDate>2026-02-02T01:40:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601464318409457706" data-draft-id="7601387539335479332" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="KingbaseES数据库：ksql 命令行玩转索引与视图，从创建到避坑"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2026-02-02T01:40:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xcLeigh"/> <meta itemprop="url" content="https://juejin.cn/user/1775071503323875"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            KingbaseES数据库：ksql 命令行玩转索引与视图，从创建到避坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1775071503323875/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xcLeigh
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T01:40:20.000Z" title="Mon Feb 02 2026 01:40:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">KingbaseES数据库：ksql 命令行玩转索引与视图，从创建到避坑</h2>
<blockquote>
<p>本文聚焦 KingbaseES 数据库中 ksql 命令行对索引与视图的操作，先介绍前置准备，需连接数据库切换至目标模式（如 test_schema），确认并创建 sys_user 表，插入测试数据。接着详解索引管理，涵盖普通、唯一、复合三类索引的创建方法，用 \di、\d + 命令查看索引，通过重建、重命名、删除进行维护，还给出索引数量不超 5 个、小表无需建索引等避坑提示。然后阐述视图管理，包括基础、进阶、只读视图的创建，用 \dv、\d + 命令查看，以及查询、修改、删除操作，强调视图修改限制等注意事项。最后排查高频报错，总结索引与视图配合使用要点，助力新手掌握高效查询技能。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cb22951c3d74268b450eff84b73f6cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGNMZWlnaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770601220&amp;x-signature=Y%2FoZtfC%2FvZ5IuymebfSoq1VJh5Y%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d34bcdae126460cbf4f2d54b7c90145~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGNMZWlnaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770601220&amp;x-signature=%2Bo%2BhMrn0xwsmcYKwBOHelbsXiWA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>学会了表的基本操作后，要是想让查询更快、访问数据更省事，那“索引”和“视图”这俩好帮手可得好好学一学。说起来，索引就像咱们看书时的目录，翻找内容能省不少劲；视图呢，更像是个专属数据窗口，不仅能把复杂的查询逻辑藏起来，还能控制哪些数据能被看到。今天咱就专门聊聊“ksql命令行操作索引与视图”，从它们的作用、创建方法，到怎么查看、维护，最后怎么删除，一步步拆成实实在在的操作步骤，再配上例子和避坑小提示，保证新手朋友也能看懂、能用起来。</p>
<h3 data-id="heading-1">一、前置准备：确认操作基础（衔接前文，确保连贯）</h3>
<p>索引和视图都得依托已有的表才能用，所以咱得先做好下面这些准备工作（大家可以参考第四篇“表的运作”的相关内容），别到时候操作半天，因为少了基础依赖弹出一堆错误提示，那就麻烦了。</p>
<h4 data-id="heading-2">1.1 连接数据库并切换目标模式</h4>
<p>先用ksql连上本地的KingbaseES数据库，再切换到之前创建的<code>test_schema</code>模式里。接着得确认一下目标表在不在，就拿<code>sys_user</code>表举例，要是没有，要么重新建一个，要么换个新例子表，总之得保证后面的操作能顺利进行。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 连接数据库（若未连接）</span>
ksql <span class="hljs-operator">-</span>d kingbase <span class="hljs-operator">-</span>U <span class="hljs-keyword">system</span>
<span class="hljs-comment">-- 2. 切换到 test_schema 模式</span>
<span class="hljs-keyword">SET</span> search_path <span class="hljs-keyword">TO</span> test_schema, public;
<span class="hljs-comment">-- 3. 确认目标表存在（如 sys_user 表）</span>
\dt sys_user;
<span class="hljs-comment">-- 若不存在，创建示例表（用于后续索引/视图操作）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> sys_user (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    phone <span class="hljs-type">CHAR</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    create_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
) TABLESPACE test_ts;
</code></pre>
<p>执行完要是显示<code>Table "test_schema.sys_user" does not exist</code>，那就先执行上面的<code>CREATE TABLE</code>语句建表，有了表，后面的操作才有载体。</p>
<h4 data-id="heading-3">1.2 插入测试数据（用于验证索引/视图效果）</h4>
<p>为了后面能测试索引的查询速度，也能看看视图展示数据的样子，得给<code>sys_user</code>表加些模拟数据。最好多加点，比如上千条，这样更贴近真实使用场景。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 批量插入10条测试数据（可复制扩展）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> test_schema.sys_user (name, phone, email)
<span class="hljs-keyword">VALUES</span> 
(<span class="hljs-string">'张三'</span>, <span class="hljs-string">'13800138000'</span>, <span class="hljs-string">'zhangsan@test.com'</span>),
(<span class="hljs-string">'李四'</span>, <span class="hljs-string">'13900139000'</span>, <span class="hljs-string">'lisi@test.com'</span>),
(<span class="hljs-string">'王五'</span>, <span class="hljs-string">'13700137000'</span>, <span class="hljs-string">'wangwu@test.com'</span>),
(<span class="hljs-string">'赵六'</span>, <span class="hljs-string">'13600136000'</span>, <span class="hljs-string">'zhaoliu@test.com'</span>),
(<span class="hljs-string">'孙七'</span>, <span class="hljs-string">'13500135000'</span>, <span class="hljs-string">'sunqi@test.com'</span>),
(<span class="hljs-string">'周八'</span>, <span class="hljs-string">'13400134000'</span>, <span class="hljs-string">'zhouba@test.com'</span>),
(<span class="hljs-string">'吴九'</span>, <span class="hljs-string">'13300133000'</span>, <span class="hljs-string">'wujiu@test.com'</span>),
(<span class="hljs-string">'郑十'</span>, <span class="hljs-string">'13200132000'</span>, <span class="hljs-string">'zhengshi@test.com'</span>),
(<span class="hljs-string">'钱一'</span>, <span class="hljs-string">'13100131000'</span>, <span class="hljs-string">'qianyi@test.com'</span>),
(<span class="hljs-string">'冯二'</span>, <span class="hljs-string">'1300130000'</span>, <span class="hljs-string">'fenger@test.com'</span>);
</code></pre>
<p>执行后要是提示<code>INSERT 0 10</code>，那就说明数据插成功了，后面的测试就有了基础。</p>
<h3 data-id="heading-4">二、索引管理：给表“加目录”，加速查询</h3>
<p>在KingbaseES里，想让查询变快，索引可是核心手段。你想啊，要是表的数据量大，比如有10万条以上，没索引的话，查询就得“全表扫描”，一条一条找，多慢啊；但有了索引就不一样了，相当于有了“目录”，直接定位到数据，速度能快成百上千倍。接下来咱就按“创建→查看→维护→删除”的顺序好好说说。</p>
<h4 data-id="heading-5">2.1 先懂基础：索引的类型与适用场景</h4>
<p>新手朋友得先搞明白不同索引有啥用，可别瞎创建。要知道，索引不是越多越好，多了反而会增加数据更新、插入的开销。</p>
<h4 data-id="heading-6">2.2 创建索引：用CREATE INDEX语句</h4>
<h5 data-id="heading-7">2.2.1 示例1：创建普通索引（加速单字段查询）</h5>
<p>要是经常按手机号查用户，那给<code>sys_user</code>表的<code>phone</code>列建个普通索引就很合适。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：CREATE INDEX 索引名 ON 表名(字段名);</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_sys_user_phone <span class="hljs-keyword">ON</span> test_schema.sys_user(phone);
</code></pre>
<ul>
<li><strong>索引名规范</strong>：建议用“idx_表名_字段名”这种格式，比如“idx_sys_user_phone”，一看就知道是“sys_user”表里“phone”列的索引，多好认。</li>
<li><strong>成功验证</strong>：执行后提示<code>CREATE INDEX</code>，那就说明索引建好了。</li>
</ul>
<h5 data-id="heading-8">2.2.2 示例2：创建唯一索引（确保字段唯一+加速查询）</h5>
<p>给<code>sys_user</code>表的<code>email</code>列建个唯一索引也不错，既能保证邮箱不重复，查邮箱的时候也能更快。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：CREATE UNIQUE INDEX 索引名 ON 表名(字段名);</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX idx_sys_user_email <span class="hljs-keyword">ON</span> test_schema.sys_user(email);
</code></pre>
<ul>
<li><strong>与UNIQUE约束的区别</strong>：这里得提醒一句，唯一索引只是保证值不重复，而UNIQUE约束里既包含了约束，也自带了唯一索引。所以要是表已经有<code>email</code>的UNIQUE约束，就不用再特意给<code>email</code>建唯一索引了，约束本身就会生成索引。</li>
</ul>
<h5 data-id="heading-9">2.2.3 示例3：创建复合索引（加速多字段组合查询）</h5>
<p>要是经常按“姓名+创建时间范围”查数据，那给<code>sys_user</code>表的<code>name</code>和<code>create_time</code>列建个复合索引就很实用。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：CREATE INDEX 索引名 ON 表名(字段1, 字段2);</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_sys_user_name_createtime <span class="hljs-keyword">ON</span> test_schema.sys_user(name, create_time);
</code></pre>
<ul>
<li><strong>字段顺序注意</strong>：复合索引有个“最左符合原则”，比如这个索引(name, create_time)，能加快name单字段的查询，也能加快name+create_time组合的查询，但没法加快create_time单字段的查询。所以字段顺序得根据平时的查询习惯来定，可别搞反了。</li>
</ul>
<h4 data-id="heading-10">2.3 查看索引：确认索引存在与关联表</h4>
<p>建完索引，得用ksql命令看看索引列表、关联的表还有详细信息，推荐大家用<code>\di</code>和<code>\dt+</code>这两个命令，很好用。</p>
<h5 data-id="heading-11">2.3.1 示例1：查看所有索引（\di命令）</h5>
<p>执行<code>\di</code>就能列出当前模式下的所有索引，能快速确认索引是不是建成功了。</p>
<pre><code class="hljs language-sql" lang="sql">\di
</code></pre>
<p><strong>执行结果示例关键信息解读</strong>：</p>
<ul>
<li><code>Table</code>：能看到索引关联的表，确认是不是<code>sys_user</code>表；</li>
<li><code>Columns</code>：能知道索引对应的字段，是单字段还是多字段；</li>
<li><code>sys_user_pkey</code>：这个是主键自动创建的索引，不用咱们手动建。</li>
</ul>
<h5 data-id="heading-12">2.3.2 示例2：查看表关联的索引（\dt+表名）</h5>
<p>要是想查看某张表的所有索引，比如<code>sys_user</code>表，执行<code>\d+ 表名</code>就行。</p>
<pre><code class="hljs language-sql" lang="sql">\d<span class="hljs-operator">+</span> test_schema.sys_user
</code></pre>
<p><strong>执行结果示例（索引部分）</strong>：
这样能直接看到表关联的所有索引，包括索引类型（是PRIMARY KEY、UNIQUE还是普通索引）和对应的字段，清晰又直观，一眼就能看明白。</p>
<h4 data-id="heading-13">2.4 索引维护：优化性能与调整结构</h4>
<p>索引用久了，因为数据经常被删除、更新，可能会出现“碎片化”的情况，就是索引文件里有不少空白空间，这时候就得重建索引来改善。另外，要是想给索引重命名，或者删掉没用的索引，也有对应的方法。</p>
<h5 data-id="heading-14">2.4.1 示例1：重建索引（解决碎片化，提升查询速度）</h5>
<p>要是感觉索引查询变慢了，重建索引就能整理碎片，让性能恢复。不过要注意，要是表很大，最好离线执行，别影响正常业务。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：REINDEX INDEX 索引名;</span>
REINDEX INDEX idx_sys_user_phone;
<span class="hljs-comment">-- 进阶：重建表的所有索引（更高效）</span>
REINDEX <span class="hljs-keyword">TABLE</span> sys_user;
</code></pre>
<ul>
<li><strong>成功验证</strong>：执行后提示<code>REINDEX</code>，就说明重建完成了。</li>
</ul>
<h5 data-id="heading-15">2.4.2 示例2：重命名索引（规范命名）</h5>
<p>要是索引名不符合规范，比如想把<code>idx_sys_user_phone</code>改成<code>idx_sys_user_mobile</code>，直接重命名就行。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：ALTER INDEX 旧索引名 RENAME TO 新索引名;</span>
<span class="hljs-keyword">ALTER</span> INDEX idx_sys_user_phone RENAME <span class="hljs-keyword">TO</span> idx_sys_user_mobile;
</code></pre>
<ul>
<li><strong>验证</strong>：执行<code>\d+ test_schema.sys_user</code>，就能看到索引名已经更新了。</li>
</ul>
<h5 data-id="heading-16">2.4.3 示例3：删除索引（无用索引清理）</h5>
<p>要是某个字段查询频率变低了，或者因为索引导致数据插入、更新变慢，那就得把没用的索引删掉。不过要注意，主键索引和跟唯一约束相关的索引不能直接删，得先把约束删掉才行。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：DROP INDEX IF EXISTS 索引名;</span>
<span class="hljs-keyword">DROP</span> INDEX IF <span class="hljs-keyword">EXISTS</span> idx_sys_user_name_createtime;
</code></pre>
<ul>
<li><code>IF EXISTS</code>：加这个是为了避免索引不存在的时候报错，只会提示个警告，很贴心；</li>
<li><strong>验证</strong>：执行<code>\d+ test_schema.sys_user</code>，确认索引已经删掉了就行。</li>
</ul>
<h4 data-id="heading-17">2.5 索引使用注意事项（新手避坑指南）</h4>
<ol>
<li>千万别觉得索引越多越好，索引多了，数据插入、更新、删除的时候开销都会变大。毕竟数据一变，索引也得跟着同步更新，多费事儿啊。所以一张表的索引最好别超过5个。</li>
<li>小表就别建索引了，要是数据量不到1万条，全表扫描比用索引查还快。你想啊，用索引还得先找索引再找数据，多了一次IO操作，反而慢了。</li>
<li>经常更新的列别建索引，比如“订单状态”这种字段，每秒都可能变，给它建了索引，索引就得频繁同步更新，多影响整体性能啊。</li>
<li>别对索引字段用函数，比如<code>WHERE SUBSTR(phone,1,3) = '138'</code>这种写法，会让索引失效。改成<code>WHERE phone LIKE '138%'</code>就好，前缀匹配是能用到索引的。</li>
</ol>
<h3 data-id="heading-18">三、视图管理：给数据“开窗口”，简化查询与控制权限</h3>
<p>视图其实是“虚拟表”，它是根据SQL查询结果生成的，本身不存实际数据，数据还在原始表里。但它的用处可不小，能“隐藏复杂查询逻辑”，还能“控制数据可见范围”，比如只让用户看到某些列。下面咱就按“创建-查看-操作-删除”的顺序来讲。</p>
<h4 data-id="heading-19">3.1 先懂基础：视图的核心作用（新手必知）</h4>
<p>新手朋友容易把“表”和“视图”搞混，我给大家打个通俗的比方：</p>
<ul>
<li>表就像“仓库”，里面实实在在存着数据；</li>
<li>视图呢，就是“仓库窗口”，通过这个窗口只能看到指定区域的货物（数据），整个仓库的情况是看不到的。而且这个窗口不能直接改，想改仓库里的数据得通过窗口，但还有不少限制。</li>
</ul>
<p>视图的核心使用场景有这几个：</p>
<ol>
<li>简化复杂查询，要是有很多表关联查询（JOIN），可以把它封装成视图，后面查数据直接用视图就行，不用再写一遍复杂的SQL，多省事儿。</li>
<li>控制数据权限，比如想让普通用户只看到<code>sys_user</code>表里的<code>name</code>和<code>phone</code>字段，把<code>email</code>这种敏感信息藏起来，用视图就能做到。</li>
<li>保证数据一致性，要是多个系统都用同一个查询逻辑，用视图就能确保所有系统都用一样的筛选条件，不会出乱子。</li>
</ol>
<h4 data-id="heading-20">3.2 创建视图：用CREATE VIEW语句</h4>
<h5 data-id="heading-21">3.2.1 示例1：基础视图（简化单表查询）</h5>
<p>咱创建一个“用户基础信息视图<code>vw_sys_user_basic</code>”，里面只包含<code>id</code>、<code>name</code>、<code>phone</code>列，把<code>email</code>这种敏感信息藏起来。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：CREATE VIEW 视图名 AS SELECT 语句;</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> vw_sys_user_basic <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> id, name, phone 
<span class="hljs-keyword">FROM</span> test_schema.sys_user;
</code></pre>
<ul>
<li><strong>成功验证</strong>：执行后提示<code>CREATE VIEW</code>，就说明视图建好了。</li>
</ul>
<h5 data-id="heading-22">3.2.2 示例2：进阶视图（带筛选条件的复杂查询）</h5>
<p>再创建一个“2024年创建的用户视图<code>vw_sys_user_2024</code>”，筛选出<code>create_time</code>在2024年的用户，里面包含<code>name</code>、<code>email</code>、<code>create_time</code>列。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> vw_sys_user_2024 <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> name, email, create_time 
<span class="hljs-keyword">FROM</span> test_schema.sys_user 
<span class="hljs-keyword">WHERE</span> create_time <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2024-01-01 00:00:00'</span> 
  <span class="hljs-keyword">AND</span> create_time <span class="hljs-operator">&lt;</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>;
</code></pre>
<ul>
<li><strong>动态性</strong>：这里得说一下，视图里的数据会跟着原表自动变。比如原表新增了一个2024年创建的用户，视图里也会自动包含这条数据，不用手动更新。</li>
</ul>
<h5 data-id="heading-23">3.2.3 示例3：只读视图（禁止修改数据）</h5>
<p>要是想确保视图里的数据不能被改，比如报表视图，那就加个<code>WITH READ ONLY</code>选项。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> vw_sys_user_report <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> name, phone, create_time 
<span class="hljs-keyword">FROM</span> test_schema.sys_user 
<span class="hljs-keyword">WITH</span> READ <span class="hljs-keyword">ONLY</span>;
</code></pre>
<ul>
<li><strong>效果</strong>：后面要是想通过这个视图改数据，比如执行<code>UPDATE vw_sys_user_report SET name='张三'</code>，就会报错“cannot update a read-only view”，根本改不了。</li>
</ul>
<h4 data-id="heading-24">3.3 查看视图：确认视图定义与关联表</h4>
<p>建完视图，得用ksql命令看看视图列表、定义还有关联的表，推荐用<code>\dv</code>和<code>\d+</code>这两个命令。</p>
<h5 data-id="heading-25">3.3.1 示例1：查看所有视图（\dv命令）</h5>
<p>执行<code>\dv</code>就能列出当前模式下的所有视图，能快速确认视图是不是建成功了。</p>
<h5 data-id="heading-26">3.3.2 示例2：查看视图定义（\d+视图名）</h5>
<p>要是忘了视图的筛选条件，想确认一下视图的底层SQL，执行<code>\d+ 视图名</code>就行。</p>
<pre><code class="hljs language-sql" lang="sql">\d<span class="hljs-operator">+</span> vw_sys_user_2024
</code></pre>
<p><strong>执行结果示例（定义部分）</strong>：
这样能直接看到视图完整的SQL定义，后面想修改或者验证逻辑都很方便。</p>
<h4 data-id="heading-27">3.4 视图操作：查询、修改与删除</h4>
<p>视图最主要的操作是“查询”，修改和删除都有特定的规则，可不能随便来。</p>
<h5 data-id="heading-28">3.4.1 示例1：查询视图数据（与表查询一致）</h5>
<p>查询视图数据的语法和查表一模一样，不用额外学新东西。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询基础视图数据</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> vw_sys_user_basic;
<span class="hljs-comment">-- 查询2024年用户视图，按创建时间排序</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> vw_sys_user_2024 <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time <span class="hljs-keyword">DESC</span>;
</code></pre>
<ul>
<li><strong>效果</strong>：返回的结果和查原表筛选后的数据一样，但看不到那些被隐藏的列，比如在<code>vw_sys_user_basic</code>里就看不到<code>email</code>列。</li>
</ul>
<h5 data-id="heading-29">3.4.2 示例2：修改视图定义（CREATE OR REPLACE）</h5>
<p>要是想调整视图的筛选条件或者包含的列，比如把<code>vw_sys_user_2024</code>改成包含2023年的数据，不用删了视图重新建，直接用<code>CREATE OR REPLACE</code>修改就行。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">VIEW</span> vw_sys_user_2024 <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> name, email, create_time 
<span class="hljs-keyword">FROM</span> test_schema.sys_user 
<span class="hljs-keyword">WHERE</span> create_time <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2023-01-01 00:00:00'</span> 
  <span class="hljs-keyword">AND</span> create_time <span class="hljs-operator">&lt;</span> <span class="hljs-string">'2025-01-01 00:00:00'</span>;
</code></pre>
<ul>
<li><strong>验证</strong>：执行<code>\d+ vw_sys_user_2024</code>，确认视图定义已经更新了就行。</li>
</ul>
<h5 data-id="heading-30">3.4.3 示例3：删除视图（DROP VIEW）</h5>
<p>要是某个视图不用了，就把它删掉。放心，<strong>删除视图不会影响原表数据</strong>，只是把视图的定义删掉了。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 语法：DROP VIEW IF EXISTS 视图名;</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">VIEW</span> IF <span class="hljs-keyword">EXISTS</span> vw_sys_user_report;
</code></pre>
<ul>
<li><strong>验证</strong>：执行<code>\dv</code>，确认视图已经删掉了就可以。</li>
</ul>
<h4 data-id="heading-31">3.5 视图使用注意事项（新手避坑指南）</h4>
<ol>
<li>视图修改有不少限制，就算没加<code>READ ONLY</code>，只要有下面这些情况，也没法改数据：
<ul>
<li>视图里包含<code>DISTINCT</code>（去重）、<code>GROUP BY</code>（分组）、<code>HAVING</code>（筛选分组）；</li>
<li>视图里有聚合函数，比如<code>COUNT</code>、<code>SUM</code>；</li>
<li>视图是从多个表关联（<code>JOIN</code>）来的；</li>
</ul>
</li>
<li>要是原表被删了，比如<code>sys_user</code>表没了，那对应的视图就成了“无效视图”，再查这个视图就会报错“relation does not exist”。</li>
<li>性能方面也得注意，要是视图很复杂，包含多表关联或者聚合操作，它的查询效率就看原表有没有索引。所以原表里那些相关的字段，比如多表<code>JOIN</code>时用到的关联列，一定要提前建好索引。</li>
</ol>
<h3 data-id="heading-32">四、常见问题排查：索引与视图的高频报错</h3>
<h4 data-id="heading-33">问题1：创建索引报错“重复的键名”</h4>
<p><strong>报错信息</strong>：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">ERROR:  duplicate key name "idx_sys_user_phone"
</code></pre>
<p><strong>原因</strong>：这明显是同名的索引已经存在了，比如之前已经创建过<code>idx_sys_user_phone</code>。
<strong>解决方案</strong>：</p>
<ul>
<li>先执行<code>\di</code>看看索引名，确认是不是真的重复了；</li>
<li>要是想重新建这个索引，先把旧的删掉，执行<code>DROP INDEX idx_sys_user_phone;</code>，然后再建新的。</li>
</ul>
<h4 data-id="heading-34">问题2：查询视图报错“关系对象不存在”</h4>
<p><strong>报错信息</strong>：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">ERROR:  relation "vw_sys_user_basic" does not exist
</code></pre>
<p><strong>原因</strong>：</p>
<ol>
<li>要么是视图名拼错了，比如把<code>vw_sys_user_basic</code>写成了<code>vw_sys_user_basci</code>；</li>
<li>要么是视图所在的模式不在搜索路径里，比如视图在<code>test_schema</code>模式下，但当前的搜索路径是<code>public</code>。
<strong>解决方案</strong>：</li>
</ol>
<ul>
<li>先检查视图名拼写对不对，执行<code>\dv</code>确认一下正确的名称；</li>
<li>要么切换到视图所在的模式，执行<code>SET search_path TO test_schema, public;</code>；要么查询的时候用“模式名.视图名”的全称，比如<code>SELECT * FROM test_schema.vw_sys_user_basic;</code>。</li>
</ul>
<h4 data-id="heading-35">问题3：通过视图修改数据报错“无法更新只读视图”</h4>
<p><strong>报错信息</strong>：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">ERROR:  cannot update a read-only view "vw_sys_user_report"
</code></pre>
<p><strong>原因</strong>：这是因为创建视图的时候加了<code>WITH READ ONLY</code>选项，就是禁止修改的。
<strong>解决方案</strong>：</p>
<ul>
<li>
<p>要是想允许修改，就重新创建视图，把<code>WITH READ ONLY</code>去掉：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">VIEW</span> vw_sys_user_report <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> name, phone, create_time <span class="hljs-keyword">FROM</span> sys_user;
</code></pre>
</li>
<li>
<p>不过要注意，重新创建之前得确认这个视图没有其他修改限制，比如不含<code>GROUP BY</code>、聚合函数这些。</p>
</li>
</ul>
<h3 data-id="heading-36">五、总结：索引与视图的配合使用</h3>
<p>今天把索引和视图的核心操作都讲透了，核心要点总结一下：</p>
<ol>
<li><strong>索引</strong>：主要管“查询速度”，得根据查询场景选普通、唯一还是复合索引，别建太多，还得定时重建优化性能；</li>
<li><strong>视图</strong>：主要管“查询简化和权限控制”，能把复杂逻辑封装起来，隐藏敏感数据，但要注意修改限制和对原表的依赖；</li>
<li><strong>配合使用</strong>：视图的查询速度和原表的索引有关系，比如给<code>vw_sys_user_2024</code>视图对应的<code>sys_user</code>原表建个<code>create_time</code>索引，视图的查询效率能提升不少。</li>
</ol>
<p>学会了索引和视图，你在KingbaseES里查数据就能又快又方便了。下一篇咱就讲“用户与权限管理”，让数据库访问更安全，实现“不同用户看不同数据”的精细控制。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何自定义 Pipe？]]></title>    <link>https://juejin.cn/post/7602259669707358234</link>    <guid>https://juejin.cn/post/7602259669707358234</guid>    <pubDate>2026-02-03T02:42:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602259669707358234" data-draft-id="7599917711794012170" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何自定义 Pipe？"/> <meta itemprop="keywords" content="前端,NestJS,Node.js"/> <meta itemprop="datePublished" content="2026-02-03T02:42:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端付豪"/> <meta itemprop="url" content="https://juejin.cn/user/1741228277763278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何自定义 Pipe？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1741228277763278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端付豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:42:46.000Z" title="Tue Feb 03 2026 02:42:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Pipe 是在参数传给 Controller 之前做一些验证和转换的，有 多个内置的 Pipe 可以直接用</p>
<p>Nest 一次请求的顺序是：</p>
<pre><code class="hljs language-scss" lang="scss">Middleware
  ↓
Guard
  ↓
Interceptor (before)
  ↓
Pipe   ✅（就在这里）
  ↓
Controller handler
  ↓
Interceptor (after)
  ↓
ExceptionFilter
</code></pre>
<p>👉 <strong>Pipe 发生在 handler 真正被调用之前，而且是“参数级别”执行</strong></p>
<h2 data-id="heading-0">Pipe 的接口定义</h2>
<pre><code class="hljs language-r" lang="r">export interface PipeTransform<span class="hljs-operator">&lt;</span><span class="hljs-built_in">T</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">any</span><span class="hljs-punctuation">,</span> R <span class="hljs-operator">=</span> <span class="hljs-built_in">any</span><span class="hljs-operator">&gt;</span> <span class="hljs-punctuation">{</span>
  transform<span class="hljs-punctuation">(</span>value<span class="hljs-operator">:</span> <span class="hljs-built_in">T</span><span class="hljs-punctuation">,</span> metadata<span class="hljs-operator">:</span> ArgumentMetadata<span class="hljs-punctuation">)</span><span class="hljs-operator">:</span> R;
<span class="hljs-punctuation">}</span>
</code></pre>
<p><code>ArgumentMetadata</code> 是关键：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ArgumentMetadata</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'body'</span> | <span class="hljs-string">'query'</span> | <span class="hljs-string">'param'</span> | <span class="hljs-string">'custom'</span>;
  metatype?: <span class="hljs-title class_">Type</span>&lt;<span class="hljs-built_in">any</span>&gt;;
  data?: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p>也就是说，Pipe 能知道：</p>
<ul>
<li>这个参数来自哪里（body / query / param）</li>
<li>DTO 是什么 class</li>
<li>装饰器里写的是 <code>@Body('id')</code> 还是整个 body</li>
</ul>
<p>内置的 Pipe 有这些：</p>
<ul>
<li>ValidationPipe</li>
<li>ParseIntPipe</li>
<li>ParseBoolPipe</li>
<li>ParseArrayPipe</li>
<li>ParseUUIDPipe</li>
<li>DefaultValuePipe</li>
<li>ParseEnumPipe</li>
<li>ParseFloatPipe</li>
<li>ParseFilePipe</li>
</ul>
<p>看一下使用</p>
<pre><code class="hljs language-sql" lang="sql">nest <span class="hljs-keyword">new</span> pipe<span class="hljs-operator">-</span><span class="hljs-keyword">inner</span> <span class="hljs-operator">-</span>p npm
</code></pre>
<p>ParseIntPipe</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65cb8d85ae4446358d46a1627722c3f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=NR%2F2YFkHLr8K5ZaXJsvK63bYsXE%3D" alt="image.png" loading="lazy"/></p>
<p>如果可以转正常展示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b50fcc495bde42bf90d1750aa20b8b3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=Lac9Ai%2FR2pECjm1qr89nDjeR7Vw%3D" alt="image.png" loading="lazy"/></p>
<p>如果不可以转 报错</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca7927ce7f444f729bfdb7585942dd07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=ImH1ukExtVLd%2BUgCauHk%2F45ZUgo%3D" alt="image.png" loading="lazy"/></p>
<p>状态码和信息也可以改</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba13e1fe6750492cb595f0b8862199b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=KrQGZuBs4ZMJ%2F%2BtpkFNpXePG6%2FE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfbf0abd48e0421fa818187c061bc4ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=8PL5qxrcNp4ppKO7BfgaF67BPt4%3D" alt="image.png" loading="lazy"/></p>
<p>可以自己抛一个异常出来，然后让 exception filter 处理</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7750fc6740f44e61974fc0aa43d000bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=K9khwHum0NTY4DVTWAW%2FPq3H7Eg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f46c012f181f488eb9ecb38bb9cb4ec5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=y8yimWfYOFix3ikcrw0dHUN6xLs%3D" alt="image.png" loading="lazy"/></p>
<p>ParseFloatPipe 是把参数转换为 float 类型</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ca7c655bc624e4b9876abf97880c838~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=04Xwac2e%2FeTARc%2FcbeAVUVEIETE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84e2ff5a29974aba8a296369122fa25c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=O4DbH0GyVvNyvlmBLSM8hcVR7go%3D" alt="image.png" loading="lazy"/></p>
<p>也可以 new ParseFloatPipe 的形式，传入 errorHttpStatusCode 和 exceptionFactory</p>
<p>ParseBoolPipe</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6f6812aaab9451c9bec3f72fa31b942~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=Cx0cOMr%2FkaSmJyAefAKrVKj4bPk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0f6d6d3799d44608e44af1f74fa7655~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=Q%2FweJ0swMPgSjKZsihfY5qGjRAA%3D" alt="image.png" loading="lazy"/></p>
<p>ParseArrayPipe</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d809d6527e1b413ebc5e9d28df11f09c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=PG2V%2B2e7IE20sSsdHkFvzM8VC10%3D" alt="image.png" loading="lazy"/></p>
<p>需要安装</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/245f6867406a4b68ac05e14806a78d9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=DLeoP6sVv0dul8oO2Co1DbYCqrA%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">npm install -D <span class="hljs-keyword">class</span>-validator <span class="hljs-keyword">class</span>-transformer
</code></pre>
<p>没有转为数字</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8dfdc00592ba452bbac7080833599310~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=wbywhvmWVhliMwlNlC%2BsA%2FvfPmI%3D" alt="image.png" loading="lazy"/></p>
<p>指定 item 的类型</p>
<p>这样就把数组每一项处理为 number</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c6dfa16440546a2aef21d0011e4d8e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=DE1aEz%2BDTkjrY%2F%2FQ2z%2Bn%2B1eq9i0%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0da3387d863645db8ba7d2c6cabf4c79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=tP7Kc0Eo9hkM97FIbnPbfURPU0A%3D" alt="image.png" loading="lazy"/></p>
<p>ParseEnumPipe</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/194ba572039543c09d487648d1c17bb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=7YI2j2MwsPrWPdVCikKJWkDKKvs%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b0769c791e44936b42b066483586d55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=AaXLna%2BoK1vbjoXjpuO3rzWG1yI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6700ea7e96a485a907de3745edea495~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=%2FC%2BBHVOExyDckceAsytI0d3Fuqk%3D" alt="image.png" loading="lazy"/></p>
<p>参数不是枚举值内</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c0964f7bdb440a997111abde1c9f590~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=%2FlvSofEbulE9mMQcTdEjP3l1E9M%3D" alt="image.png" loading="lazy"/></p>
<p>ParseUUIDPipe</p>
<p>UID 是一种随机生成的几乎不可能重复的字符串，做 id</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd347332075e4a84882266650fb05149~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=FN3C1fSAqbEHlhaBu59jxHf1Tys%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77e075322bed4b13af551a9c9a824635~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=kNcOd758dobyjncRGCrpy%2FH%2BK3g%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce79004c1b11486aaaba2316f5daaec8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=CMAV81o6xz6aGmGWf1ltVQVHcns%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe3067b71349439c86d2c98127a707b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=FytHVEwIiGVUhh7ggXRci6fQ2S0%3D" alt="image.png" loading="lazy"/></p>
<p>不是 uuid 会报错</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be2caca925514f238544b308c29eef39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=rkXPFVbT0wAltwRm5WdKQEmc0J0%3D" alt="image.png" loading="lazy"/></p>
<p>DefaultValuePipe 设置默认值</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85b39c793849405b84c18a6d80cd86f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=HQ3PZ9VRo8OlSMHj%2BTrXYBAaAf8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97d28c91b9b243cfb514b1243d269bbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=lmHew2u8AuyJ9p9tFOGUnHcS53w%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">实现个 Pipe</h2>
<p>自己写一个 pipe 也很简单，实现 PipeTransform 接口的 transform 方法，返回值就是传给 handler 的值</p>
<pre><code class="hljs language-css" lang="css">nest g pipe aaa <span class="hljs-attr">--flat</span> <span class="hljs-attr">--no-spec</span>
</code></pre>
<p>生成一个 pipe，打印下参数值，返回 aaa</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31fd56d1104340be8180888a1679d598~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=NTBPoEkh%2FmrGNqlF3dPhbMuwqtw%3D" alt="image.png" loading="lazy"/></p>
<p>使用</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76cbe20df92f4e45a8e9ca4fdacba949~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=bJdJ4Nl02vEaCeoGxDDQ%2F7aNzLM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f9fe0edd188473991d4f42d5cc22565~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=5HTdu2uBxViYdwOJaxcw%2FALSF3w%3D" alt="image.png" loading="lazy"/></p>
<p>返回的值是 aaaaaa，也就是说 pipe 的返回值就是传给 handler 的参数值。</p>
<p>打印的 value 就是 query、param 的值，而 metadata 里包含 type、metatype、data</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/036a95f40e0c43c58162810e3998c6a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691366&amp;x-signature=UecdIPPq9hR5Iyk7glen%2BOWPNPA%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端代码安全 - 你的代码真的安全吗？]]></title>    <link>https://juejin.cn/post/7602135278665252916</link>    <guid>https://juejin.cn/post/7602135278665252916</guid>    <pubDate>2026-02-03T02:45:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602135278665252916" data-draft-id="7602161364892090368" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端代码安全 - 你的代码真的安全吗？"/> <meta itemprop="keywords" content="前端,安全"/> <meta itemprop="datePublished" content="2026-02-03T02:45:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梅川_酷子"/> <meta itemprop="url" content="https://juejin.cn/user/1488075996274921"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端代码安全 - 你的代码真的安全吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1488075996274921/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梅川_酷子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:45:41.000Z" title="Tue Feb 03 2026 02:45:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">安全检测</h2>
<p>  近期线上代码安全检测遇到一些问题反馈，都是一些开发中不常见、不显现的问题。所以记录一下，了解一些新的安全防护的方法，方便日后开发中能够未雨绸缪。</p>
<h3 data-id="heading-1">SRI 检查</h3>
<p>Subresource Integrity （子资源完整性）</p>
<h4 data-id="heading-2">问题代码：</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.bootcdn.net/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">修改后的代码</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 此代码中 integrity 值不可直接使用 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>
  <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.bootcdn.net/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"</span>
  <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-FwzUI3CDd**************FBTolvoj"</span>
  <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">修改方式</h4>
<h6 data-id="heading-5">1. 在线工具 SRI Hash Generator</h6>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsrihash.org%2F" target="_blank" title="https://srihash.org/" ref="nofollow noopener noreferrer">srihash.org/</a></p>
<h6 data-id="heading-6">2. 命令行</h6>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载外部资源</span>
curl -O https://cdn.bootcdn.net/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成 integrity 的值</span>
node -e <span class="hljs-string">"const fs = require('fs'); const crypto = require('crypto'); const hash = crypto.createHash('sha384').update(fs.readFileSync('jsencrypt.min.js')).digest('base64'); console.log('sha384-' + hash)"</span>
</code></pre>
<p><sup><a href="#user-content-fn-1" id="user-content-user-content-fnref-1" data-footnote-ref="" aria-describedby="footnote-label" title="#user-content-fn-1">1</a></sup>跳转至代码翻译</p>
<h4 data-id="heading-7">使用注意事项</h4>
<p>integrity：核心校验属性，格式为 算法名-Base64哈希值，支持的算法：sha256、sha384、sha512（推荐 sha384/sha512，安全性更高）；</p>
<p>crossorigin：跨域资源必填，不填的话浏览器不校验。常用 anonymous（不发送凭据），几乎不用 use-credentials（发送凭据）。</p>
<h4 data-id="heading-8">详细原因</h4>
<p>用于资源完整性校验，保证用户浏览器每次获取外部资源时，得到的都是原封不动资源，防止恶意篡改</p>
<p><strong>一本正经：</strong><br/>
原理：intergrity 的值，是算法名，加上根据资源源代码，通过算法，生成的 hash 值<br/>
算法的目标代码不同，生成的 hash 值也就不同<br/>
在 script 标签中加入这个属性后，标签在获取到外部资源时，会自动对获取的资源通过算法生成 hash 值<br/>
用新生成的 hash 值，与 intergrity 的属性值做对比：<br/>
相同，表示资源无变动，安全；不同，表示资源有变动，丢弃该资源</p>
<p><strong>通俗大白话：</strong><br/>
通俗讲，就是提前告诉浏览器：我要的东西，用这个算法，会得到这个结果。<br/>
浏览器：知道了，等我运行的时候，拿到东西我先算一下，看结果一样不，一样我再用，不一样我就扔了。</p>
<h3 class="sr-only" id="user-content-footnote-label" data-id="heading-9">Footnotes</h3>
<ol>
<li id="user-content-user-content-fn-1">
<p><strong>代码翻译</strong></p>
<p>整个命令是 Node.js 的-e参数用法（-e = --eval，表示执行后面的字符串代码），核心依赖 Node.js 内置的fs（文件系统）和crypto（加密）模块，无需额外安装依赖：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 引入Node.js内置模块，无需npm install</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>) <span class="hljs-comment">// 用于读取本地文件内容</span>
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>) <span class="hljs-comment">// 用于生成加密哈希值</span>

<span class="hljs-comment">// 2. 生成SHA-384哈希并Base64编码</span>
<span class="hljs-keyword">const</span> hash = crypto
  .<span class="hljs-title function_">createHash</span>(<span class="hljs-string">'sha384'</span>) <span class="hljs-comment">// 创建SHA-384哈希计算实例</span>
  .<span class="hljs-title function_">update</span>(fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'jsencrypt.min.js'</span>)) <span class="hljs-comment">// 读取文件内容并传入哈希实例</span>
  .<span class="hljs-title function_">digest</span>(<span class="hljs-string">'base64'</span>) <span class="hljs-comment">// 计算哈希并输出Base64格式（SRI要求的编码格式）</span>

<span class="hljs-comment">// 3. 拼接SRI规范格式并打印</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'sha384-'</span> + hash)
</code></pre>
<a href="#user-content-fnref-1" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content" title="#user-content-fnref-1">↩</a>
</li>
</ol>
</div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[教你零成本使用满血 Clawdbot，并手把手带你集成飞书和Telegram]]></title>    <link>https://juejin.cn/post/7601770028279037961</link>    <guid>https://juejin.cn/post/7601770028279037961</guid>    <pubDate>2026-02-02T05:58:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601770028279037961" data-draft-id="7601762468201938970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="教你零成本使用满血 Clawdbot，并手把手带你集成飞书和Telegram"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-02T05:58:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            教你零成本使用满血 Clawdbot，并手把手带你集成飞书和Telegram
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T05:58:14.000Z" title="Mon Feb 02 2026 05:58:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>OpenClaw最近热度很高，最早叫做 Clawdbot，后来改名Moltbot，现在叫 OpenClaw 了。</p>
<p>很多人早已用上了，查数据、做调研、写代码，但是还有些朋友想用但是还没体验上。</p>
<p>OpenClaw 能够像人一样操控电脑和浏览器，成为我们的私人 AI 助理。</p>
<p>但在安装这一步，很多人犯了难。是跑在自己电脑上？还是挂在云端？到底有对自己有没有帮助？</p>
<p>今天介绍一种不用花钱的方式快速安装，如果有用呢，那就可以直接用了；如果发现用处不大，那也不用浪费钱买个新电脑或者买云服务了。</p>
<p>本文包括快速安装教程，以及详细的配置 Telegram 和 飞书集成的步骤，如果AWS你不想用，没关系，教程在任何机器上都是通用的。</p>
<p>AWS 免费部署</p>
<p>现在只要注册，就可以免费使用 6 个月，可以选择 8G 内存的服务器使用，这可是一年几千块配置的服务器啊。</p>
<p>访问下面地址注册账号，选择免费计划。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faws.amazon.com%2F" target="_blank" title="https://aws.amazon.com/" ref="nofollow noopener noreferrer">aws.amazon.com/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90c2c7ca47874c3f9b5f99dff0ed9e14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=sOKaBw6EJbpmmOZ8CgZLrxWf8ps%3D" alt="" loading="lazy"/></p>
<p>之后进入控制台，搜索 EC2。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1dc6026b804701aee5057a6b9c7883~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=XL%2FB40IYBvepeKD3SqM%2ByyKg%2FAQ%3D" alt="" loading="lazy"/></p>
<p>点击启动实例，这一步之后就开始选服务器配置了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e94a798e74d4f18aae48ec19d7ff4c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=Xs59UPxPR86mIWITt8P2RgjpfKY%3D" alt="" loading="lazy"/></p>
<p>选择任意后面写着「符合条件的免费套餐」都不用付费，当然选8g内存的这个了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92f3694fe093428fbd35ce31f042be59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=1GG3nfdj9e6J0v62EnTkVwepX38%3D" alt="" loading="lazy"/></p>
<p>镜像选择 Ubuntu，然后启动实例，服务器就到手了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90561ef81b4e4557b3e5ff8bd5a15a81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=5ovpMZ0DUuG3IiybqHzM0CXYQmU%3D" alt="" loading="lazy"/></p>
<p>接下来，选择连接到实例。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a094354bde8d40abba27321990a0d092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=PB%2FMsYNK3Q666gNK9F6MZkOorqU%3D" alt="" loading="lazy"/></p>
<p>有好几种连接方式，最简单的就是第一种，直接点连接按钮就可以了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c50b35a9001f4e2db5185bc9fbd20c5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=1JNqTsc5Fmcu8Z4VIghwOOBcawY%3D" alt="" loading="lazy"/></p>
<p>连接之后就是服务器的命令行窗口，后面的安装就在这里进行了。</p>
<p>安装</p>
<p>一条命令就能安装，安装是最简单的步骤。</p>
<p>bash</p>
<pre><code class="hljs language-arduino" lang="arduino">curl -fsSL https:<span class="hljs-comment">//openclaw.ai/install.sh | bash</span>
</code></pre>
<p>这一步会稍微耗费一些时间，需要安装环境，但是aws 非常快，2分钟以内完成。</p>
<p>接着，开始进行快速配置。</p>
<p>第一项选yes，然后选择 QuickStart。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b20e487058b442987e56f4b6d23a148~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=XAw1MFdNgzgeElNonyYidAty8X4%3D" alt="" loading="lazy"/></p>
<p>这一步没办法偷懒了，你必须有个可用的key，比如Google、OpenAI的，或者miniMax、kimi的coding plan 也可以，总之，这一步没办法白嫖的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74dcf0a8f5ef42729d926ad04c3ca5e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=jHlLQR98XgnwWJwkArfygIrVnaY%3D" alt="" loading="lazy"/></p>
<p>我选择了 Google，然后选择 Gemini 3。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83c4781257af4fb1ae66b9be4abe8cfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=CXfwZFMtCi%2FGq6trCdlxIf%2BOZfk%3D" alt="" loading="lazy"/></p>
<p>这一步选择 Bot 的，先跳过。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b63fe911a8b45bbb0d8e26001fd8d22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=YMhbiSM8buEivGVIdM9Wd1NTgKU%3D" alt="" loading="lazy"/></p>
<p>这些 Skill 可以选择性安装，也可以跳过等着后面安装。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d3b00bc191943c1ac5f33d4b1e62373~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=hORTEJVZfeQy42QKbi8X1ghofvs%3D" alt="" loading="lazy"/></p>
<p>下面这几项全选择 No 就好了。</p>
<p>Enable hooks 可以全选上，按空格选中，按回车确定下一步。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c45b370360234e8abf39507ecdf3f1c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=5vCzxob21o22yjTQeWNgWWMy2m8%3D" alt="" loading="lazy"/></p>
<p>点击会车后，稍等几秒，就安装完成了。</p>
<p>因为是在Linux中，没有浏览器，所以使用 Tui 方式操作。</p>
<p>安装完成后就可以直接选择 Tui ，或者使用 <code>openclaw tui</code>打开。</p>
<p>打开 Tui 模式后，随便输入点儿内容，如果正常返回就说明安装成功了，顺利的话2、3分钟就完事儿了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efcee2ed5e5e46568787a24cc6186ee2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=y1DDqgRWPt3h09WmoWIJEWe1q8w%3D" alt="" loading="lazy"/>添加Telegram机器人</p>
<p>接下来，最简单的就是集成 Telegram 机器人了。添加好以后，就可以通过聊天的方式控制 OpenClaw 了。</p>
<p>打开  Telegram，搜索<code>BotFather</code>，认准了，看清楚名称要是 @BotFather 的这个，这个就是用来快速创建机器人的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fec4cfec583e4b69a46aee2b05e19d7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=dTjWRPN1xugXM%2BMfpeNo7ZWKIXA%3D" alt="" loading="lazy"/></p>
<p>在对话中输入 <code>/newbot</code>，会返回消息，让你输入名称。起一个名字输入进去，回车，接着会让你输入一个 <code>username</code>，相当于昵称了，接着输入昵称（以bot结尾），昵称有可能已经被占用了，不符合就接着输入新的。</p>
<p>直到出现下面的回复，表示创建成功了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce17d018049245a2a6129fa58b3d8f4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=g9ruSt%2FzqVXCeFOk8caogT7A708%3D" alt="" loading="lazy"/></p>
<p>接下来到重点了，看上图红框中的这部分，这是用来接入你的机器人的。</p>
<p>怎么做呢？很简单，直接复制下来，然后在刚才的 OpenClaw tui 对话框中粘贴进来，告诉它，这是tg创建机器人后返回的 token。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/492551783e9f4881b3402a3100384e2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=KPEdxnEO7FrqGiXg19Wk6hTJJkU%3D" alt="" loading="lazy"/></p>
<p>然后 OpenClaw 自己就知道要干什么了。看下面的信息，机器人已配置好了，正在重启，但是还需要发一条消息，进行一个配对。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a721755dd3e1483ebe03638ecf28d6af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=BYW5Hv4tDGcvCg%2Fc3ug4tJL8aKg%3D" alt="" loading="lazy"/></p>
<p>这条消息就要在刚刚创建的Telegram机器人中发了，还是在创建机器人的对话框中，看下图红框的部分了吗，直接点这个链接，就能和机器人进行对话了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9fd26031eba4c3ea915ffc1f9acb2a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=Y9zkL9XsKuuVB6b8ZiwVfY0L4pM%3D" alt="" loading="lazy"/></p>
<p>随便输入什么都可以。接着，机器人会返回如下图红框的部分。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4edd03afe9644d37a9df7e60f76eaf99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=5K8Y%2Bk7iqJe2tGx%2Bo4a3BK5Gkvk%3D" alt="" loading="lazy"/></p>
<p>将这部分整体复制，然后回到 OpenClaw tui，直接粘贴进去，回车。</p>
<p>看到了吧，连接成功了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91f4fdad132142029dc3b761a10c5c09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=Grsces2we3%2F8m8K8havYAW%2BKj7g%3D" alt="" loading="lazy"/></p>
<p>接着在TG机器人聊天窗口，就可以控制 OpenClaw 了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b677c00c86de44c9b3bd6072be10f9dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=pmVP3s3nD2y7AbgocmpSozMKSFk%3D" alt="" loading="lazy"/>集成飞书机器人</p>
<p>飞书相对来说复杂一点，主要是前期的准备工作有点儿多，而且需要手动操作。</p>
<p>首先打开飞书开放平台，有账号就可以。</p>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fapp" target="_blank" title="https://open.feishu.cn/app" ref="nofollow noopener noreferrer">open.feishu.cn/app</a></p>
<p>点击创建企业自建应用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72ffed7bfd444d3c98a6318acaf3c5a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=s5W8cspS8nA25S1DZwINMvUwIH8%3D" alt="" loading="lazy"/></p>
<p>输入名称和描述后，点击机器人这里的「添加」按钮。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c2f42a35fa5405b8b8af846229019dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=zpSF6Ah2kWgWgVzf4O3qOcp0X4s%3D" alt="" loading="lazy"/></p>
<p>左侧菜单栏会出现机器人菜单。</p>
<p>接下来，进入权限管理页面，将下图中右侧的权限打开，或者参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fm1heng%2Fclawdbot-feishu%3Ftab%3Dreadme-ov-file%23%25E4%25B8%25AD%25E6%2596%2587" target="_blank" title="https://github.com/m1heng/clawdbot-feishu?tab=readme-ov-file#%E4%B8%AD%E6%96%87" ref="nofollow noopener noreferrer">github.com/m1heng/claw…</a> 这里，可以开通更多权限，包括管理知识库或云文档能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b8d6681440846398dd625c13494b6f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=WPHOn9%2Fr079GdEkcRIKSH3nJ%2Bb8%3D" alt="" loading="lazy"/></p>
<p>接着在事件与回调页面，在事件配置中，将订阅方式设置为长连接，然后添加下图中的 4个事件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7722d1d4a0342ba97a8ce6ab2ee411c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=%2BOXfPwbPyCM2fLll4EUvSudzKz4%3D" alt="" loading="lazy"/></p>
<p>然后来到凭证与基础信息，将上面的Client ID 和 Client Secret 先复制到一个位置，稍后会用到。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eef493a1bb6e44989c30948f0e6031f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=pVhB%2BOun7q4hWzpan%2FHRznRxrfA%3D" alt="" loading="lazy"/></p>
<p>接着，点击上方的「查看版本详情」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e3be520904b4151b0af79ee99453214~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=aWDUfBxrM6uGyxUlYvlVpOSyDA8%3D" alt="" loading="lazy"/></p>
<p>填好版本号和描述，点击保存。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4aab3d2d26874b0e9d50d75ade8cb703~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=OegRuQqcokss%2FTuB3FytGdnn6wM%3D" alt="" loading="lazy"/></p>
<p>然后点击确认发布。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/550ce3c131b146d68e1046d1818a8009~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=fT69TlTq6mF8qVeC3pMBPp0yLcI%3D" alt="" loading="lazy"/></p>
<p>接着来到 OpenClaw tui 界面。</p>
<p>只需要把下面的内容输入进去，OpenClaw 就会自动给你配置了，注意替换你的 Client ID 和   Client Secret。</p>
<blockquote>
<p>我要用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fm1heng%2Fclawdbot-feishu" target="_blank" title="https://github.com/m1heng/clawdbot-feishu" ref="nofollow noopener noreferrer">github.com/m1heng/claw…</a> 这个项目将飞书集成进来，我的appId是“前面复制的Client ID”，我的appSecret 是“前面复制的 Client Secret”，而且我使用的是国内版飞书，现在请帮我集成进来吧。</p>
</blockquote>
<p>然后来到飞书，点击左侧搜索框，搜索你刚才创建的应用名称，这个就是你的智能助手了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/475d6824e8a042c098716ff8c2907aad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=qsoeGdvM9VN3U7YVnG5JOUrfWBc%3D" alt="" loading="lazy"/></p>
<p>然后和他聊天验证一下。随便输入一点内容，如果正常返回就可以用了。如果不正常，直接把错误信息扔给 OpenClaw tui，让他修改就行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ede23e321f5240c1912bebcb9f65513c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770616694&amp;x-signature=qQWM0T50F8vnRMuHG3F49s3i294%3D" alt="" loading="lazy"/>最后</p>
<p>OpenClaw 就是一个权限很大的程序，他可以在你的机器人上随时待命，就像一个24小时工作的助理一样。</p>
<p>之所以要集成飞书、TG等工具，只是为了随时随地的控制他，直接用终端其实也可以，用浏览器也可以。</p>
<p>但是集成了常用聊天工具后，我们躺着床上、地铁上也可以控制他干活儿了，这是最方便的地方。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python API 调用保姆级教程：从原理到第一次成功请求（附完整代码）]]></title>    <link>https://juejin.cn/post/7602135278665383988</link>    <guid>https://juejin.cn/post/7602135278665383988</guid>    <pubDate>2026-02-03T03:18:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602135278665383988" data-draft-id="7602135278665367604" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Python API 调用保姆级教程：从原理到第一次成功请求（附完整代码）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-03T03:18:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="睁眼看视界"/> <meta itemprop="url" content="https://juejin.cn/user/98277494891632"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Python API 调用保姆级教程：从原理到第一次成功请求（附完整代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/98277494891632/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    睁眼看视界
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:18:01.000Z" title="Tue Feb 03 2026 03:18:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Python API 调用保姆级教程：从原理到第一次成功请求（附完整代码）</h2>
<p>在当今的软件开发中，<strong>API（应用程序编程接口）</strong> 几乎无处不在。从获取天气数据、支付接口，到调用 ChatGPT 进行对话，一切的核心都是“API 调用”。</p>
<p>很多初学者觉得 API 很高深，但实际上，只要你掌握了**“请求（Request）”<strong>与</strong>“响应（Response）”**这两个核心概念，你就已经迈过了门槛。</p>
<p>本文将以 Python 语言为例，手把手教你如何发起一次标准的 API 调用。为了方便演示和保证连接稳定性，本教程将使用兼容性极佳的 <strong>4SAPI</strong> 接口作为测试环境。</p>
<h3 data-id="heading-1">一、 核心概念：API 到底在做什么？</h3>
<p>在写代码之前，你需要理解 API 交互的四个要素：</p>
<ol>
<li>
<p><strong>Endpoint（端点）</strong> ：你要去哪里取数据？通常是一个 URL（例如 <code>https://api.4sapi.com/v1</code>）。</p>
</li>
<li>
<p><strong>Method（方法）</strong> ：你要做什么？</p>
<ul>
<li><code>GET</code>：查数据（例如：查询余额）。</li>
<li><code>POST</code>：提交数据（例如：发一段话给 AI，让它回复）。</li>
</ul>
</li>
<li>
<p><strong>Headers（请求头）</strong> ：你是谁？通常包含 <code>Authorization</code>（你的 API Key）和 <code>Content-Type</code>（数据格式）。</p>
</li>
<li>
<p><strong>Body（请求体）</strong> ：具体内容是什么？（例如：你的 Prompt 提示词）。</p>
</li>
</ol>
<h3 data-id="heading-2">二、 环境准备</h3>
<p>我们将使用 Python 中最流行的 <code>openai</code> 库来完成这次调用。</p>
<p><strong>为什么不用 <code>requests</code> 库？</strong></p>
<p>虽然 <code>requests</code> 是基础，但在 AI 开发领域，使用官方 SDK 能自动处理重试、JSON 解析等繁琐工作。由于 <strong>4SAPI</strong> 完美兼容 OpenAI 协议，我们可以直接使用这个成熟的库。</p>
<h4 data-id="heading-3">1. 安装库</h4>
<p>打开你的终端（Terminal）或 CMD，输入：</p>
<p>Bash</p>
<pre><code class="hljs">pip install openai
</code></pre>
<h4 data-id="heading-4">2. 获取 API Key</h4>
<p>你需要一个“通行证”。</p>
<ul>
<li>
<p>如果你使用官方 OpenAI，去官网后台。</p>
</li>
<li>
<p><strong>本教程推荐演示环境</strong>：前往 <strong>4SAPI 控制台</strong> 申请一个令牌。</p>
<ul>
<li><em>推荐理由</em>：4SAPI 的网络线路针对国内优化（CN2直连），在调试代码时不会因为网络超时（Timeout）而报错，非常适合新手学习和企业生产环境。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">三、 代码实战：编写你的第一个 API 脚本</h3>
<p>新建一个文件 <code>main.py</code>，并将以下代码复制进去。为了让你看懂每一行，我添加了详细的注释。</p>
<p>Python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

<span class="hljs-comment"># ==========================================</span>
<span class="hljs-comment"># 步骤 1：客户端配置 (Client Configuration)</span>
<span class="hljs-comment"># ==========================================</span>

<span class="hljs-comment"># 初始化客户端</span>
client = OpenAI(
    <span class="hljs-comment"># 【关键配置】</span>
    <span class="hljs-comment"># 这里的 API Key 建议从环境变量读取，或者直接填入你的 4SAPI 令牌</span>
    api_key=<span class="hljs-string">"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>, 
    
    <span class="hljs-comment"># 【核心技巧】</span>
    <span class="hljs-comment"># 将 base_url 指向中转站地址。</span>
    <span class="hljs-comment"># 如果不改这里，代码会默认去连 OpenAI 美国服务器（容易超时）。</span>
    <span class="hljs-comment"># 使用 4SAPI 可以利用其企业级 CN2 线路加速，确保握手成功。</span>
    base_url=<span class="hljs-string">"https://api.4sapi.com/v1"</span> 
)

<span class="hljs-comment"># ==========================================</span>
<span class="hljs-comment"># 步骤 2：构建请求 (Build Request)</span>
<span class="hljs-comment"># ==========================================</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">call_ai_model</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"&gt;&gt;&gt; 正在发送请求..."</span>)
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 发起 Chat Completions 请求（这是目前最通用的 AI 接口标准）</span>
        response = client.chat.completions.create(
            <span class="hljs-comment"># 指定模型：4SAPI 后端支持映射，你可以填 gpt-4o, claude-3-5-sonnet 等</span>
            model=<span class="hljs-string">"gpt-4o-mini"</span>, 
            
            <span class="hljs-comment"># 消息列表：模拟对话历史</span>
            messages=[
                {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个Python代码助手，回答要简洁。"</span>},
                {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"请写一个打印 Hello World 的函数"</span>}
            ],
            
            <span class="hljs-comment"># 参数设置</span>
            temperature=<span class="hljs-number">0.7</span>, <span class="hljs-comment"># 创意度：0.7 是比较平衡的值</span>
            stream=<span class="hljs-literal">False</span>     <span class="hljs-comment"># 是否流式输出（初学者建议先设为 False）</span>
        )
        
        <span class="hljs-comment"># ==========================================</span>
        <span class="hljs-comment"># 步骤 3：解析响应 (Parse Response)</span>
        <span class="hljs-comment"># ==========================================</span>
        
        <span class="hljs-comment"># API 返回的是一个复杂的对象，我们需要提取核心内容</span>
        content = response.choices[<span class="hljs-number">0</span>].message.content
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"&gt;&gt;&gt; API 调用成功！返回结果如下："</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">30</span>)
        <span class="hljs-built_in">print</span>(content)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">30</span>)
        
        <span class="hljs-comment"># 打印一下消耗的 Token 数（4SAPI 后台也能看到详细日志）</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Token 消耗: <span class="hljs-subst">{response.usage.total_tokens}</span>"</span>)

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 调用失败: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 执行函数</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    call_ai_model()
</code></pre>
<h3 data-id="heading-6">四、 常见报错与排查 (Troubleshooting)</h3>
<p>在调试 API 时，报错是家常便饭。以下是三种最常见的错误代码及其含义：</p>
<ol>
<li>
<p><strong>401 Unauthorized</strong></p>
<ul>
<li><strong>含义</strong>：身份验证失败。</li>
<li><strong>解决</strong>：检查 <code>api_key</code> 是否填错，或者是否有多余的空格。</li>
</ul>
</li>
<li>
<p><strong>429 Too Many Requests</strong></p>
<ul>
<li><strong>含义</strong>：请求太快，或者额度耗尽。</li>
<li><strong>解决</strong>：如果你用的是官方免费号，很容易触发这个。建议切换到 <strong>4SAPI</strong> 这样的企业级中转，由于其底层采用了 MySQL 8.2 高并发架构，能承载极高的并发量，几乎不会遇到误报的 429 错误。</li>
</ul>
</li>
<li>
<p><strong>Connection Timeout / APIConnectionError</strong></p>
<ul>
<li><strong>含义</strong>：连不上服务器。</li>
<li><strong>解决</strong>：这是国内开发者最头疼的问题。通常是因为网络墙的原因。解决办法就是修改代码中的 <code>base_url</code>，指向一个国内访问友好的中转节点（如代码中演示的 <code>api.4sapi.com</code>）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-7">五、 进阶：如何像高手一样使用“流式输出”？</h3>
<p>你注意过 ChatGPT 网页版是一个字一个字蹦出来的吗？这叫 <strong>Streaming（流式）</strong> 。</p>
<p>在 API 中实现这个功能非常简单，只需要改两个地方：</p>
<p>Python</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. 将 stream 设置为 True</span>
<span class="hljs-attr">response</span> = client.chat.completions.create(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"gpt-4"</span>,
    <span class="hljs-attr">messages</span>=[...],
    <span class="hljs-attr">stream</span>=<span class="hljs-literal">True</span>  <span class="hljs-comment"># &lt;--- 修改这里</span>
)

<span class="hljs-comment"># 2. 循环处理生成器</span>
print("AI 回复: ", <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>)
for chunk in response:
    if chunk.choices<span class="hljs-section">[0]</span>.delta.content:
        <span class="hljs-comment"># 即时打印每一个片段</span>
        print(chunk.choices<span class="hljs-section">[0]</span>.delta.content, <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>, flush=<span class="hljs-literal">True</span>)
</code></pre>
<p><strong>提示</strong>：流式输出对网络稳定性要求极高。如果中间丢包，字就会断。这也是为什么生产环境推荐使用 <strong>4SAPI</strong> 的原因——其物理线路紧邻上游核心节点，能保证长连接不断开，让“打字机效果”丝般顺滑。</p>
<h3 data-id="heading-8">结语</h3>
<p>恭喜你！到这里，你已经完成了一次标准的 API 调用。</p>
<p>你会发现，代码的核心逻辑其实非常固定。真正的难点往往在于<strong>网络环境配置</strong>和<strong>账号维护</strong>。对于初学者和企业开发者，选择一个配置简单、兼容性好的基础设施（如文中演示的 4SAPI），能帮你节省 90% 的调试时间，让你专注于编写业务逻辑，而不是去修网络连接。</p>
<p>现在，去运行代码，开启你的 AI 开发之旅吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于沉浸式状态栏和导航栏适配问题]]></title>    <link>https://juejin.cn/post/7602162809292570662</link>    <guid>https://juejin.cn/post/7602162809292570662</guid>    <pubDate>2026-02-03T03:11:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602162809292570662" data-draft-id="7602252722372378675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于沉浸式状态栏和导航栏适配问题"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-03T03:11:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Z_Quintaz"/> <meta itemprop="url" content="https://juejin.cn/user/4300945219391063"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于沉浸式状态栏和导航栏适配问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4300945219391063/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Z_Quintaz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:11:51.000Z" title="Tue Feb 03 2026 03:11:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">WindowCompact</h2>
<p>windowCompact有三个方法</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 是否将内容布局超出状态栏</span>
WindowCompat.setDecorFitsSystemWindows(Window, <span class="hljs-built_in">Boolean</span>)

<span class="hljs-comment">// 获取Insets控制器</span>
WindowCompat.getInsetsController(Window, View)

<span class="hljs-comment">// 是否能够将画面超出系统栏</span>
WindowCompat.enableEdgeToEdge(Window)
</code></pre>
<p>沉浸式状态栏实现</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> Window.<span class="hljs-title">setTransparentStatusBar</span><span class="hljs-params">(isLight: <span class="hljs-type">Boolean</span>)</span></span> {
    WindowCompat.setDecorFitsSystemWindows(<span class="hljs-keyword">this</span>, <span class="hljs-literal">false</span>)

    statusBarColor = Color.TRANSPARENT

    WindowCompat.getInsetsController(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.decorView).apply {
        isAppearanceLightStatusBars = isLight
    }
}
</code></pre>
<p>处理内容的偏移</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">handleContentPadding</span><span class="hljs-params">()</span></span> {
    ViewCompat.setOnApplyWindowInsetsListener(<span class="hljs-keyword">this</span>) { v, insets -&gt;
        <span class="hljs-keyword">val</span> systemWindow = insets.getInsets(
            WindowInsetsCompat.Type.systemBars() or
                    WindowInsetsCompat.Type.displayCutout())

        <span class="hljs-comment">//为需要偏移的view设置padding</span>
        v.setPadding(<span class="hljs-number">0</span>,systemWindow.top,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)

        insets
    }
}
</code></pre>
<p>其中WindowInsetsCompat.Type 参数解释：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">WindowInsetsCompat.Type.ime()<span class="hljs-comment">//键盘</span>
WindowInsetsCompat.Type.displayCutout()<span class="hljs-comment">//刘海屏</span>
WindowInsetsCompat.Type.statusBars()<span class="hljs-comment">//状态栏</span>
WindowInsetsCompat.Type.navigationBars()<span class="hljs-comment">//导航栏</span>
WindowInsetsCompat.Type.captionBar()<span class="hljs-comment">//标题栏</span>
WindowInsetsCompat.Type.systemBars()<span class="hljs-comment">//状态栏,导航栏和标题栏</span>
WindowInsetsCompat.Type.systemGestures()<span class="hljs-comment">//系统手势</span>
WindowInsetsCompat.Type.mandatorySystemGestures()<span class="hljs-comment">//强制性系统手势</span>
WindowInsetsCompat.Type.tappableElement()<span class="hljs-comment">//可点击区域</span>
</code></pre>
<h3 data-id="heading-1">顺带一提</h3>
<p>看了下安卓新建项目时出现的方法，谷歌帮我们做了一些对系统栏的处理</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> ComponentActivity.<span class="hljs-title">enableEdgeToEdge</span><span class="hljs-params">(
    statusBarStyle: <span class="hljs-type">SystemBarStyle</span> = SystemBarStyle.auto(Color.TRANSPARENT, Color.TRANSPARENT)</span></span>,
    navigationBarStyle: SystemBarStyle = SystemBarStyle.auto(DefaultLightScrim, DefaultDarkScrim),
) {
    <span class="hljs-keyword">val</span> view = window.decorView
    <span class="hljs-keyword">val</span> statusBarIsDark = statusBarStyle.detectDarkMode(view.resources)
    <span class="hljs-keyword">val</span> navigationBarIsDark = navigationBarStyle.detectDarkMode(view.resources)
    <span class="hljs-keyword">val</span> impl =
        Impl
            ?: (<span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="hljs-number">35</span>) {
                    EdgeToEdgeApi35()
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="hljs-number">30</span>) {
                    EdgeToEdgeApi30()
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="hljs-number">29</span>) {
                    EdgeToEdgeApi29()
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="hljs-number">28</span>) {
                    EdgeToEdgeApi28()
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="hljs-number">26</span>) {
                    EdgeToEdgeApi26()
                } <span class="hljs-keyword">else</span> {
                    EdgeToEdgeApi23()
                })
                .also { Impl = it }
    impl.setUp(
        statusBarStyle,
        navigationBarStyle,
        window,
        view,
        statusBarIsDark,
        navigationBarIsDark,
    )
    impl.adjustLayoutInDisplayCutoutMode(window)
}
</code></pre>
<p>其中包含了沉浸状态栏，同时根据系统主题处理了状态栏的亮暗关系。所以可以直接使用这个方法。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
    <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)

    enableEdgeToEdge()

    setContentView(R.layout.activity_main)
}
</code></pre>
<p>这样做之后可以保证我们的内容可以充满整个屏幕，至于说边距问题，直接添加padding就可以了。完整如下</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> mBinding: ActivityMainBinding

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)

        enableEdgeToEdge()

        mBinding = DataBindingUtil.setContentView(<span class="hljs-keyword">this</span>, R.layout.activity_main)

        window.decorView.setPadding(
            window.decorView.paddingLeft,
            window.decorView.paddingTop,
            window.decorView.paddingRight,
            <span class="hljs-comment">// 对导航栏进行padding</span>
            window.decorView.paddingBottom + BarUtils.getNavBarHeight()
        )
    }

}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[26分钟就断连？一次 MySQL “幽灵掉线” 的深度破局之路]]></title>    <link>https://juejin.cn/post/7602158221851754511</link>    <guid>https://juejin.cn/post/7602158221851754511</guid>    <pubDate>2026-02-03T03:29:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602158221851754511" data-draft-id="7602158221851721743" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="26分钟就断连？一次 MySQL “幽灵掉线” 的深度破局之路"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-03T03:29:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码途山海"/> <meta itemprop="url" content="https://juejin.cn/user/1143959165085032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            26分钟就断连？一次 MySQL “幽灵掉线” 的深度破局之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1143959165085032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码途山海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:29:22.000Z" title="Tue Feb 03 2026 03:29:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>问题现象</strong>：系统在空闲一段时间后，首次访问数据库时报错 <code>Communications link failure</code>，错误日志显示“Last packet received was 1,594,079 milliseconds ago（约26分钟）”。即使配置了连接池验证，问题依然反复出现。</p>
</blockquote>
<p>本文将完整复盘该问题的<strong>排查思路、踩过的坑、最终解决方案</strong>，并详解 Druid 连接池关键参数配置，帮助大家避免重蹈覆辙。</p>
<hr/>
<h2 data-id="heading-0"> 一、问题初现：不只是“超时”那么简单</h2>
<p>最初，我们看到典型的 MySQL 通信异常：</p>
<pre><code class="hljs language-csharp" lang="csharp">Caused <span class="hljs-keyword">by</span>: com.mysql.cj.exceptions.CJCommunicationsException: Communications link failure
The last packet successfully received <span class="hljs-keyword">from</span> the server was <span class="hljs-number">1</span>,<span class="hljs-number">594</span>,<span class="hljs-number">079</span> milliseconds ago.
</code></pre>
<p>直觉告诉我们：<strong>数据库连接被断开了</strong>。<br/>
于是我们检查了 MySQL 的 <code>wait_timeout</code> 和 <code>interactive_timeout</code>，发现均为 <code>7200</code> 秒（2小时）——远大于 26 分钟。</p>
<p><strong>结论</strong>：不是 MySQL 主动断连，而是<strong>中间网络设备（如云厂商 SLB、NAT 网关、防火墙）在空闲约 15–30 分钟后切断了 TCP 连接</strong>。</p>
<hr/>
<h2 data-id="heading-1">二、第一次尝试：配置连接池验证</h2>
<p>我们立即为 Druid 连接池添加了基础防护：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">test-<span class="hljs-keyword">on</span>-borrow: <span class="hljs-literal">true</span>
validation-query: <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> DUAL
min-evictable-idle-time-millis: <span class="hljs-number">300000</span>  # <span class="hljs-number">5</span>分钟
test-<span class="hljs-keyword">while</span>-idle: <span class="hljs-literal">true</span>
</code></pre>
<p><strong>预期效果</strong>：每次借出连接前先验证，确保连接有效。</p>
<p><strong>结果</strong>：问题依旧！更诡异的是，日志中开始频繁出现：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">ERROR</span> druid.sql.Statement - execute <span class="hljs-keyword">error</span>. <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FROM</span> DUAL
</code></pre>
<p>这说明：<strong>Druid 确实在验证连接，但验证本身失败了</strong>——连接已被网络中断。</p>
<hr/>
<h2 data-id="heading-2">三、深入排查：为什么验证失败还会报业务错误？</h2>
<p>通过分析 Druid 源码和日志，我们发现：</p>
<ul>
<li>• 虽然 <code>test-on-borrow=true</code> 能检测到坏连接，</li>
<li>• 但<strong>默认情况下，验证失败会直接抛出异常</strong>，不会自动重试！</li>
</ul>
<p>这意味着：用户请求会直接失败，体验极差。</p>
<p><strong>关键突破</strong>：启用 Druid 的 <strong>异常分类器（Exception Sorter）</strong> ，让连接池能识别“可恢复的网络异常”，并自动重试获取新连接。</p>
<hr/>
<h2 data-id="heading-3">四、最终解决方案：三重防护体系</h2>
<h3 data-id="heading-4">1、启用 MySQL 异常分类器（核心！）</h3>
<p>在 <code>connection-properties</code> 中显式指定：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">connection-properties:</span>
  druid.exceptionSorter: com.alibaba.druid.pool.vendor.MySqlExceptionSorter
</code></pre>
<blockquote>
<p>✅ 作用：当 <code>SELECT 1</code> 验证失败时，Druid 会识别这是“网络断连”而非 SQL 错误，自动 discard 坏连接，并<strong>重试获取新连接</strong>，对业务透明。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">2、合理设置空闲回收时间</h3>
<p>根据网络设备超时（约 26 分钟），我们将空闲时间设为 <strong>10–15 分钟</strong>，留足安全余量：</p>
<pre><code class="hljs language-perl" lang="perl">min-evictable-idle-<span class="hljs-keyword">time</span>-millis: <span class="hljs-number">600000</span>   <span class="hljs-comment"># 10分钟</span>
max-evictable-idle-<span class="hljs-keyword">time</span>-millis: <span class="hljs-number">900000</span>   <span class="hljs-comment"># 15分钟</span>
<span class="hljs-keyword">time</span>-between-eviction-runs-millis: <span class="hljs-number">30000</span> <span class="hljs-comment"># 每30秒检查一次</span>
</code></pre>
<blockquote>
<p>✅ 作用：在连接被网络中断前，主动回收，大幅降低验证失败概率。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">3、关闭生产环境的 <code>removeAbandoned</code>（重要！）</h3>
<p>初期我们启用了：</p>
<pre><code class="hljs language-arduino" lang="arduino">remove-abandoned: <span class="hljs-literal">true</span>
remove-abandoned-timeout-millis: <span class="hljs-number">180000</span> # <span class="hljs-number">3</span>分钟
</code></pre>
<p>但 Druid 日志警告：</p>
<pre><code class="hljs language-csharp" lang="csharp">WARN - removeAbandoned <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span>, <span class="hljs-keyword">not</span> use <span class="hljs-keyword">in</span> production.
</code></pre>
<p><strong>原因</strong>：它可能误杀真正的长事务（如耗时 5 分钟的报表导出），导致 <code>Communications link failure</code>。</p>
<blockquote>
<p>✅ <strong>生产环境必须关闭</strong>，改用良好编码规范（如 Spring 事务、try-with-resources）防止泄漏。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">五、Druid 关键参数详解（生产推荐配置）</h2>













































<table><thead><tr><th>参数</th><th>推荐值</th><th>说明</th></tr></thead><tbody><tr><td><code>test-on-borrow</code></td><td><code>true</code></td><td><strong>借出时验证</strong>，确保连接有效（牺牲微秒级性能，换稳定性）</td></tr><tr><td><code>validation-query</code></td><td><code>SELECT 1</code></td><td>轻量验证 SQL，比 <code>SELECT 1 FROM DUAL</code> 更标准</td></tr><tr><td><code>min-evictable-idle-time-millis</code></td><td><code>600000</code> (10分钟)</td><td>必须  <strong>&lt; 网络设备超时</strong>（如阿里云 SLB 默认 15 分钟）</td></tr><tr><td><code>exceptionSorter</code></td><td><code>MySqlExceptionSorter</code></td><td><strong>自动识别网络异常，触发重试</strong>（解决验证失败仍报错的关键！）</td></tr><tr><td><code>remove-abandoned</code></td><td><code>false</code></td><td><strong>生产环境禁用</strong>，避免误杀长事务</td></tr><tr><td><code>keep-alive</code></td><td><code>true</code></td><td>启用 Druid 内部保活机制</td></tr><tr><td><code>filters</code></td><td><code>stat,wall,slf4j</code></td><td>开启 SQL 监控、防火墙、统一日志</td></tr></tbody></table>
<p>完整配置示例：</p>
<pre><code class="hljs language-arduino" lang="arduino">dynamic:
  druid:
    initial-size: <span class="hljs-number">10</span>
    min-idle: <span class="hljs-number">10</span>
    max-active: <span class="hljs-number">40</span>
    max-wait: <span class="hljs-number">30000</span>

    time-between-eviction-runs-millis: <span class="hljs-number">30000</span>
    min-evictable-idle-time-millis: <span class="hljs-number">600000</span>
    max-evictable-idle-time-millis: <span class="hljs-number">900000</span>

    validation-query: SELECT <span class="hljs-number">1</span>
    validation-query-timeout: <span class="hljs-number">3</span>
    test-<span class="hljs-keyword">while</span>-idle: <span class="hljs-literal">true</span>
    test-on-borrow: <span class="hljs-literal">true</span>
    test-on-<span class="hljs-keyword">return</span>: <span class="hljs-literal">false</span>

    # 核心：自动处理网络断连
    connection-properties:
      druid.exceptionSorter: com.alibaba.druid.pool.vendor.MySqlExceptionSorter
      druid.stat.mergeSql: <span class="hljs-literal">true</span>
      druid.stat.slowSqlMillis: <span class="hljs-number">5000</span>

    filters: stat,wall,slf4j
    keep-alive: <span class="hljs-literal">true</span>
    pool-prepared-statements: <span class="hljs-literal">true</span>
    max-pool-prepared-statement-per-connection-size: <span class="hljs-number">20</span>

    # 生产环境关闭泄漏回收
    remove-abandoned: <span class="hljs-literal">false</span>
    log-abandoned: <span class="hljs-literal">false</span>
</code></pre>
<hr/>
<h2 data-id="heading-8">六、经验总结</h2>
<ol>
<li>1. <strong>不要只看 MySQL 超时</strong>：云环境、NAT、防火墙才是“隐形杀手”；</li>
<li>2. <strong><code>test-on-borrow=true</code> 是基础，但不够</strong>：必须配合 <code>exceptionSorter</code> 才能自动重试；</li>
<li>3. <strong>生产环境禁用 <code>removeAbandoned</code></strong>：它治标不治本，还可能引发新问题；</li>
<li>4. <strong>连接池配置要“适配网络”</strong> ：<code>minEvictableIdleTimeMillis</code> 必须小于中间设备超时；</li>
<li>5. <strong>长事务要拆分</strong>：避免在 <code>@Transactional</code> 方法中调用外部耗时接口。</li>
</ol>
<hr/>
<h2 data-id="heading-9">七、结语</h2>
<p>数据库连接断连问题看似简单，实则涉及 <strong>网络、连接池、驱动、业务代码</strong> 多层协作。只有理解每一层的行为，才能构建真正高可用的系统。</p>
<p>希望本文能帮你少走弯路。如果觉得有用，欢迎转发给团队同学，一起提升系统稳定性！</p>
<blockquote>
<p><strong>技术无小事，细节定成败</strong>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[嵌入式Linnx的开发]]></title>    <link>https://juejin.cn/post/7602259669730213915</link>    <guid>https://juejin.cn/post/7602259669730213915</guid>    <pubDate>2026-02-03T03:29:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602259669730213915" data-draft-id="7602303923140001842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="嵌入式Linnx的开发"/> <meta itemprop="keywords" content="后端,嵌入式"/> <meta itemprop="datePublished" content="2026-02-03T03:29:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员良许"/> <meta itemprop="url" content="https://juejin.cn/user/3913917128246942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            嵌入式Linnx的开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917128246942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员良许
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:29:09.000Z" title="Tue Feb 03 2026 03:29:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是良许。</p>
<p>今天咱们来聊聊嵌入式Linux开发这个话题。</p>
<p>说实话，我从机械转行做嵌入式这么多年，最让我觉得有意思的就是嵌入式Linux这块。</p>
<p>相比单片机开发，Linux系统给了我们更强大的功能和更灵活的开发方式，但同时也带来了更多的挑战。</p>
<h2 data-id="heading-0">1. 什么是嵌入式Linux开发</h2>
<h3 data-id="heading-1">1.1 嵌入式Linux的定义</h3>
<p>嵌入式Linux开发，简单来说就是把Linux操作系统移植到嵌入式设备上，然后在这个系统上开发应用程序或者驱动程序。</p>
<p>这里的嵌入式设备可以是智能手机、路由器、工业控制器、汽车电子设备等等。</p>
<p>我在外企做的汽车电子项目，用的就是嵌入式Linux系统。</p>
<p>和我们平时用的Ubuntu、CentOS这些桌面Linux不同，嵌入式Linux通常需要经过裁剪和定制，因为嵌入式设备的资源往往比较有限。</p>
<p>比如内存可能只有几百MB，存储空间也就几个GB，不像服务器那样动不动就几十GB内存。</p>
<p>所以我们需要把不必要的功能去掉，只保留核心的部分。</p>
<h3 data-id="heading-2">1.2 为什么选择Linux</h3>
<p>你可能会问，为什么不用单片机的RTOS，非要用Linux呢?</p>
<p>这个问题我当年也问过自己。</p>
<p>后来发现，当你的项目需要网络通信、文件系统、多进程管理这些功能的时候，Linux的优势就体现出来了。</p>
<p>Linux有成熟的TCP/IP协议栈，有完善的文件系统支持，有强大的进程管理机制，这些都是RTOS很难比拟的。</p>
<p>而且Linux是开源的，社区支持非常好。</p>
<p>遇到问题基本上都能在网上找到解决方案。</p>
<p>我记得刚开始做Linux开发的时候，经常半夜爬起来查资料，很多问题都是在Linux内核邮件列表或者Stack Overflow上找到答案的。</p>
<h2 data-id="heading-3">2. 嵌入式Linux开发的核心内容</h2>
<h3 data-id="heading-4">2.1 Bootloader开发</h3>
<p>Bootloader是系统启动的第一个程序，它的主要任务是初始化硬件，然后把Linux内核加载到内存中运行。</p>
<p>最常用的Bootloader是U-Boot,它支持很多种处理器架构，包括ARM、MIPS、PowerPC等等。</p>
<p>我在做项目的时候，经常需要修改U-Boot来适配我们的硬件板子。</p>
<p>比如配置内存大小、设置启动参数、添加新的硬件驱动等等。</p>
<p>U-Boot的配置文件通常在<code>include/configs/</code>目录下，你需要根据自己的硬件创建一个配置文件。</p>
<p>举个例子，如果你要设置内核启动参数，可以在U-Boot的环境变量中这样设置:</p>
<pre><code class="hljs language-bash" lang="bash">setenv bootargs <span class="hljs-string">'console=ttymxc0,115200 root=/dev/mmcblk0p2 rootwait rw'</span>
saveenv
</code></pre>
<p>这条命令设置了串口控制台、根文件系统的位置等信息。</p>
<p><code>console=ttymxc0,115200</code>表示使用ttymxc0这个串口，波特率是115200。</p>
<p><code>root=/dev/mmcblk0p2</code>表示根文件系统在SD卡的第二个分区。</p>
<h3 data-id="heading-5">2.2 Linux内核移植与配置</h3>
<p>内核是整个系统的核心，它负责管理硬件资源、提供系统调用接口。</p>
<p>移植内核的第一步是下载内核源码，然后根据你的硬件平台进行配置。</p>
<p>Linux内核的配置使用的是Kconfig系统，你可以通过<code>make menuconfig</code>命令来进行图形化配置。</p>
<p>配置项非常多，包括CPU架构、设备驱动、文件系统、网络协议等等。</p>
<p>对于嵌入式系统，我们通常需要把不需要的功能去掉，以减小内核的大小。</p>
<p>比如，如果你的设备不需要蓝牙功能，就可以在配置中把蓝牙相关的选项去掉。</p>
<p>如果不需要某些文件系统，也可以不编译进内核。</p>
<p>我做项目的时候，通常会先用默认配置编译一个内核，然后逐步裁剪，最终把内核大小从十几MB减小到几MB。</p>
<p>编译内核的命令通常是这样的:</p>
<pre><code class="hljs language-bash" lang="bash">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- zImage
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- dtbs
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- modules
</code></pre>
<p>第一条命令编译内核镜像，第二条编译设备树，第三条编译内核模块。</p>
<p><code>ARCH=arm</code>指定目标架构是ARM，<code>CROSS_COMPILE</code>指定交叉编译工具链的前缀。</p>
<h3 data-id="heading-6">2.3 根文件系统制作</h3>
<p>根文件系统包含了系统运行所需的所有文件，包括库文件、配置文件、应用程序等等。</p>
<p>制作根文件系统有很多种方法，最常用的是使用Buildroot或者Yocto这样的工具。</p>
<p>Buildroot是一个比较轻量级的工具，它可以自动下载、编译、安装各种软件包，最后生成一个完整的根文件系统。</p>
<p>我个人比较喜欢用Buildroot，因为它配置简单，编译速度也快。</p>
<p>使用Buildroot的基本流程是这样的:</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/buildroot/buildroot.git
<span class="hljs-built_in">cd</span> buildroot
make menuconfig
make
</code></pre>
<p>在<code>make menuconfig</code>中，你可以选择目标架构、工具链、需要的软件包等等。</p>
<p>配置完成后，执行<code>make</code>命令，Buildroot就会自动下载源码、编译、安装，最后在<code>output/images/</code>目录下生成根文件系统镜像。</p>
<p>根文件系统的格式有很多种，常见的有ext4、ubifs、squashfs等等。</p>
<p>ext4适合用在SD卡或者eMMC上，ubifs适合用在NAND Flash上，squashfs是一个只读的压缩文件系统，适合用来存放不需要修改的系统文件。</p>
<h3 data-id="heading-7">2.4 设备驱动开发</h3>
<p>驱动开发是嵌入式Linux开发中最核心也是最难的部分。</p>
<p>Linux的驱动分为字符设备驱动、块设备驱动和网络设备驱动。</p>
<p>对于嵌入式系统，我们最常接触的是字符设备驱动，比如串口驱动、GPIO驱动、I2C驱动等等。</p>
<p>写一个简单的字符设备驱动，基本框架是这样的:</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/cdev.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/device.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> DEVICE_NAME <span class="hljs-string">"mydevice"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> CLASS_NAME <span class="hljs-string">"myclass"</span></span>

<span class="hljs-type">static</span> <span class="hljs-type">int</span> major_number;
<span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-keyword">class</span> *<span class="hljs-title">myclass</span> =</span> <span class="hljs-literal">NULL</span>;
<span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">mydevice</span> =</span> <span class="hljs-literal">NULL</span>;

<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">dev_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inodep, <span class="hljs-keyword">struct</span> file *filep)</span> {
    printk(KERN_INFO <span class="hljs-string">"mydevice: Device opened\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">dev_release</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inodep, <span class="hljs-keyword">struct</span> file *filep)</span> {
    printk(KERN_INFO <span class="hljs-string">"mydevice: Device closed\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">dev_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filep, <span class="hljs-type">char</span> *buffer, <span class="hljs-type">size_t</span> len, <span class="hljs-type">loff_t</span> *offset)</span> {
    printk(KERN_INFO <span class="hljs-string">"mydevice: Read operation\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">dev_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filep, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *buffer, <span class="hljs-type">size_t</span> len, <span class="hljs-type">loff_t</span> *offset)</span> {
    printk(KERN_INFO <span class="hljs-string">"mydevice: Write operation\n"</span>);
    <span class="hljs-keyword">return</span> len;
}

<span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">fops</span> =</span> {
    .open = dev_open,
    .read = dev_read,
    .write = dev_write,
    .release = dev_release,
};

<span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">mydevice_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    printk(KERN_INFO <span class="hljs-string">"mydevice: Initializing\n"</span>);
    
    major_number = register_chrdev(<span class="hljs-number">0</span>, DEVICE_NAME, &amp;fops);
    <span class="hljs-keyword">if</span> (major_number &lt; <span class="hljs-number">0</span>) {
        printk(KERN_ALERT <span class="hljs-string">"mydevice: Failed to register\n"</span>);
        <span class="hljs-keyword">return</span> major_number;
    }
    
    myclass = class_create(THIS_MODULE, CLASS_NAME);
    <span class="hljs-keyword">if</span> (IS_ERR(myclass)) {
        unregister_chrdev(major_number, DEVICE_NAME);
        printk(KERN_ALERT <span class="hljs-string">"mydevice: Failed to create class\n"</span>);
        <span class="hljs-keyword">return</span> PTR_ERR(myclass);
    }
    
    mydevice = device_create(myclass, <span class="hljs-literal">NULL</span>, MKDEV(major_number, <span class="hljs-number">0</span>), <span class="hljs-literal">NULL</span>, DEVICE_NAME);
    <span class="hljs-keyword">if</span> (IS_ERR(mydevice)) {
        class_destroy(myclass);
        unregister_chrdev(major_number, DEVICE_NAME);
        printk(KERN_ALERT <span class="hljs-string">"mydevice: Failed to create device\n"</span>);
        <span class="hljs-keyword">return</span> PTR_ERR(mydevice);
    }
    
    printk(KERN_INFO <span class="hljs-string">"mydevice: Device created successfully\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">mydevice_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    device_destroy(myclass, MKDEV(major_number, <span class="hljs-number">0</span>));
    class_unregister(myclass);
    class_destroy(myclass);
    unregister_chrdev(major_number, DEVICE_NAME);
    printk(KERN_INFO <span class="hljs-string">"mydevice: Goodbye\n"</span>);
}

module_init(mydevice_init);
module_exit(mydevice_exit);

MODULE_LICENSE(<span class="hljs-string">"GPL"</span>);
MODULE_AUTHOR(<span class="hljs-string">"良许"</span>);
MODULE_DESCRIPTION(<span class="hljs-string">"A simple character device driver"</span>);
</code></pre>
<p>这个驱动实现了最基本的打开、关闭、读、写操作。</p>
<p>在<code>mydevice_init</code>函数中，我们注册了一个字符设备，创建了设备类和设备节点。</p>
<p>当驱动加载成功后，系统会在<code>/dev</code>目录下创建一个名为<code>mydevice</code>的设备文件。</p>
<p>编译驱动需要一个Makefile:</p>
<pre><code class="hljs language-makefile" lang="makefile">obj-m += mydevice.o

<span class="hljs-section">all:</span>
	make -C /lib/modules/<span class="hljs-variable">$(<span class="hljs-built_in">shell</span> uname -r)</span>/build M=<span class="hljs-variable">$(PWD)</span> modules

<span class="hljs-section">clean:</span>
	make -C /lib/modules/<span class="hljs-variable">$(<span class="hljs-built_in">shell</span> uname -r)</span>/build M=<span class="hljs-variable">$(PWD)</span> clean
</code></pre>
<p>编译完成后，使用<code>insmod mydevice.ko</code>命令加载驱动，使用<code>rmmod mydevice</code>命令卸载驱动。</p>
<h2 data-id="heading-8">3. 应用程序开发</h2>
<h3 data-id="heading-9">3.1 交叉编译环境搭建</h3>
<p>在嵌入式Linux开发中，我们通常在PC上编写代码，然后使用交叉编译工具链编译成目标平台的可执行文件。</p>
<p>交叉编译工具链包括编译器、链接器、库文件等等。</p>
<p>常用的交叉编译工具链有arm-linux-gnueabihf、aarch64-linux-gnu等等。</p>
<p>你可以从芯片厂商的网站下载，也可以使用Buildroot或者Linaro提供的工具链。</p>
<p>安装好工具链后，编译程序的命令是这样的:</p>
<pre><code class="hljs language-bash" lang="bash">arm-linux-gnueabihf-gcc -o hello hello.c
</code></pre>
<p>如果程序使用了第三方库，需要指定库的路径:</p>
<pre><code class="hljs language-bash" lang="bash">arm-linux-gnueabihf-gcc -o myapp myapp.c -I/path/to/include -L/path/to/lib -lmylib
</code></pre>
<h3 data-id="heading-10">3.2 系统编程</h3>
<p>Linux提供了丰富的系统调用接口，我们可以通过这些接口来操作文件、进程、网络等等。</p>
<p>比如，读写文件可以使用<code>open</code>、<code>read</code>、<code>write</code>、<code>close</code>等系统调用。</p>
<p>下面是一个读写文件的例子:</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> fd;
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">100</span>];
    <span class="hljs-type">ssize_t</span> bytes_read;
    
    <span class="hljs-comment">// 打开文件</span>
    fd = open(<span class="hljs-string">"/tmp/test.txt"</span>, O_RDWR | O_CREAT, <span class="hljs-number">0644</span>);
    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"Failed to open file"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    
    <span class="hljs-comment">// 写入数据</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *data = <span class="hljs-string">"Hello, Embedded Linux!\n"</span>;
    write(fd, data, <span class="hljs-built_in">strlen</span>(data));
    
    <span class="hljs-comment">// 移动文件指针到开头</span>
    lseek(fd, <span class="hljs-number">0</span>, SEEK_SET);
    
    <span class="hljs-comment">// 读取数据</span>
    bytes_read = read(fd, buffer, <span class="hljs-keyword">sizeof</span>(buffer) - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span> (bytes_read &gt; <span class="hljs-number">0</span>) {
        buffer[bytes_read] = <span class="hljs-string">'\0'</span>;
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Read from file: %s"</span>, buffer);
    }
    
    <span class="hljs-comment">// 关闭文件</span>
    close(fd);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>这个程序演示了如何创建文件、写入数据、读取数据。</p>
<p><code>open</code>函数的第二个参数指定了打开方式，<code>O_RDWR</code>表示读写模式，<code>O_CREAT</code>表示如果文件不存在就创建。</p>
<p>第三个参数是文件权限，<code>0644</code>表示所有者可读可写，其他人只读。</p>
<h3 data-id="heading-11">3.3 进程间通信</h3>
<p>在嵌入式Linux系统中，我们经常需要多个进程协同工作。</p>
<p>进程间通信(IPC)的方式有很多种，包括管道、消息队列、共享内存、信号量等等。</p>
<p>管道是最简单的IPC方式，适合父子进程之间的通信。</p>
<p>下面是一个使用管道的例子:</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> pipefd[<span class="hljs-number">2</span>];
    <span class="hljs-type">pid_t</span> pid;
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">100</span>];
    
    <span class="hljs-comment">// 创建管道</span>
    <span class="hljs-keyword">if</span> (pipe(pipefd) == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"pipe failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    
    <span class="hljs-comment">// 创建子进程</span>
    pid = fork();
    
    <span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"fork failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    
    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 子进程:读取数据</span>
        close(pipefd[<span class="hljs-number">1</span>]);  <span class="hljs-comment">// 关闭写端</span>
        read(pipefd[<span class="hljs-number">0</span>], buffer, <span class="hljs-keyword">sizeof</span>(buffer));
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Child received: %s\n"</span>, buffer);
        close(pipefd[<span class="hljs-number">0</span>]);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 父进程:写入数据</span>
        close(pipefd[<span class="hljs-number">0</span>]);  <span class="hljs-comment">// 关闭读端</span>
        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg = <span class="hljs-string">"Hello from parent!"</span>;
        write(pipefd[<span class="hljs-number">1</span>], msg, <span class="hljs-built_in">strlen</span>(msg) + <span class="hljs-number">1</span>);
        close(pipefd[<span class="hljs-number">1</span>]);
        wait(<span class="hljs-literal">NULL</span>);  <span class="hljs-comment">// 等待子进程结束</span>
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>对于更复杂的通信需求，我们可以使用消息队列或者共享内存。</p>
<p>消息队列适合传递结构化的消息，共享内存适合大量数据的传输。</p>
<h3 data-id="heading-12">3.4 网络编程</h3>
<p>嵌入式设备经常需要通过网络与其他设备通信。</p>
<p>Linux提供了标准的Socket接口，支持TCP和UDP协议。</p>
<p>下面是一个简单的TCP服务器例子:</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> PORT 8888</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> server_fd, client_fd;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">server_addr</span>, <span class="hljs-title">client_addr</span>;</span>
    <span class="hljs-type">socklen_t</span> addr_len = <span class="hljs-keyword">sizeof</span>(client_addr);
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">1024</span>];
    
    <span class="hljs-comment">// 创建socket</span>
    server_fd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (server_fd &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"socket failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    
    <span class="hljs-comment">// 设置地址</span>
    server_addr.sin_family = AF_INET;
    server_addr.sin_addr.s_addr = INADDR_ANY;
    server_addr.sin_port = htons(PORT);
    
    <span class="hljs-comment">// 绑定端口</span>
    <span class="hljs-keyword">if</span> (bind(server_fd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;server_addr, <span class="hljs-keyword">sizeof</span>(server_addr)) &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"bind failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    
    <span class="hljs-comment">// 监听连接</span>
    <span class="hljs-keyword">if</span> (listen(server_fd, <span class="hljs-number">3</span>) &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"listen failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Server listening on port %d\n"</span>, PORT);
    
    <span class="hljs-comment">// 接受连接</span>
    client_fd = accept(server_fd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;client_addr, &amp;addr_len);
    <span class="hljs-keyword">if</span> (client_fd &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"accept failed"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Client connected\n"</span>);
    
    <span class="hljs-comment">// 接收数据</span>
    <span class="hljs-type">int</span> bytes_read = read(client_fd, buffer, <span class="hljs-keyword">sizeof</span>(buffer));
    <span class="hljs-keyword">if</span> (bytes_read &gt; <span class="hljs-number">0</span>) {
        buffer[bytes_read] = <span class="hljs-string">'\0'</span>;
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Received: %s\n"</span>, buffer);
        
        <span class="hljs-comment">// 发送响应</span>
        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *response = <span class="hljs-string">"Message received"</span>;
        write(client_fd, response, <span class="hljs-built_in">strlen</span>(response));
    }
    
    close(client_fd);
    close(server_fd);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>这个服务器程序监听8888端口，接受客户端连接，接收数据并发送响应。</p>
<p>在实际项目中，我们通常会使用多线程或者异步IO来处理多个客户端连接。</p>
<h2 data-id="heading-13">4. 调试技巧</h2>
<h3 data-id="heading-14">4.1 串口调试</h3>
<p>串口是嵌入式开发中最常用的调试工具。</p>
<p>通过串口，我们可以看到系统的启动信息、内核日志、应用程序输出等等。</p>
<p>在Linux中，串口设备通常是<code>/dev/ttyS0</code>、<code>/dev/ttyUSB0</code>这样的设备文件。</p>
<p>使用串口的时候，需要设置波特率、数据位、停止位等参数。</p>
<p>可以使用<code>minicom</code>或者<code>picocom</code>这样的工具:</p>
<pre><code class="hljs language-bash" lang="bash">picocom -b 115200 /dev/ttyUSB0
</code></pre>
<p>这条命令以115200的波特率打开<code>/dev/ttyUSB0</code>设备。</p>
<h3 data-id="heading-15">4.2 GDB调试</h3>
<p>对于应用程序的调试，我们可以使用GDB。</p>
<p>在嵌入式系统上，通常使用gdbserver进行远程调试。</p>
<p>首先在目标板上运行gdbserver:</p>
<pre><code class="hljs language-bash" lang="bash">gdbserver :1234 ./myapp
</code></pre>
<p>然后在PC上使用交叉编译版本的GDB连接:</p>
<pre><code class="hljs language-bash" lang="bash">arm-linux-gnueabihf-gdb myapp
(gdb) target remote 192.168.1.100:1234
(gdb) <span class="hljs-built_in">break</span> main
(gdb) <span class="hljs-built_in">continue</span>
</code></pre>
<p>这样就可以在PC上调试运行在目标板上的程序了。</p>
<p>可以设置断点、单步执行、查看变量等等。</p>
<h3 data-id="heading-16">4.3 内核调试</h3>
<p>内核调试比应用程序调试要复杂一些。</p>
<p>最常用的方法是使用<code>printk</code>打印日志。</p>
<p><code>printk</code>的用法和<code>printf</code>类似，但是输出会记录到内核日志中，可以通过<code>dmesg</code>命令查看。</p>
<pre><code class="hljs language-c" lang="c">printk(KERN_INFO <span class="hljs-string">"This is an info message\n"</span>);
printk(KERN_WARNING <span class="hljs-string">"This is a warning message\n"</span>);
printk(KERN_ERR <span class="hljs-string">"This is an error message\n"</span>);
</code></pre>
<p>日志级别有KERN_EMERG、KERN_ALERT、KERN_CRIT、KERN_ERR、KERN_WARNING、KERN_NOTICE、KERN_INFO、KERN_DEBUG等等，级别越高越重要。</p>
<p>对于更复杂的内核调试，可以使用KGDB或者JTAG调试器。</p>
<p>KGDB允许你使用GDB调试内核，JTAG调试器则可以在硬件级别进行调试。</p>
<h2 data-id="heading-17">5. 性能优化</h2>
<h3 data-id="heading-18">5.1 启动时间优化</h3>
<p>嵌入式设备通常对启动时间有要求，特别是消费电子产品。</p>
<p>优化启动时间的方法有很多，比如并行化启动脚本、延迟加载不必要的服务、使用静态链接减少动态库加载时间等等。</p>
<p>我在做汽车电子项目的时候，客户要求系统在3秒内启动完成。</p>
<p>为了达到这个目标，我们做了很多优化。</p>
<p>首先是精简内核，把不需要的驱动和功能都去掉。</p>
<p>然后优化启动脚本，把一些不紧急的服务放到后台启动。</p>
<p>最后使用了压缩的文件系统，减少了文件读取时间。</p>
<h3 data-id="heading-19">5.2 内存优化</h3>
<p>嵌入式设备的内存通常比较有限，所以内存优化非常重要。</p>
<p>可以使用<code>free</code>命令查看内存使用情况，使用<code>top</code>命令查看各个进程的内存占用。</p>
<p>如果发现内存不够用，可以考虑以下几个方面:</p>
<ol>
<li>减少不必要的进程和服务</li>
<li>使用内存池来管理频繁分配释放的小块内存</li>
<li>使用mmap映射文件而不是一次性读入内存</li>
<li>及时释放不再使用的内存</li>
</ol>
<h3 data-id="heading-20">5.3 CPU优化</h3>
<p>CPU性能优化主要是减少不必要的计算和优化算法。</p>
<p>可以使用<code>top</code>命令查看CPU占用率，使用<code>perf</code>工具进行性能分析。</p>
<p>对于实时性要求高的任务，可以考虑使用实时调度策略。</p>
<p>Linux支持SCHED_FIFO和SCHED_RR两种实时调度策略，可以保证任务得到及时响应。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span>

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sched_param</span> <span class="hljs-title">param</span>;</span>
param.sched_priority = <span class="hljs-number">50</span>;
sched_setscheduler(<span class="hljs-number">0</span>, SCHED_FIFO, &amp;param);
</code></pre>
<p>这段代码把当前进程设置为FIFO实时调度，优先级是50。</p>
<h2 data-id="heading-21">6. 总结</h2>
<p>嵌入式Linux开发涉及的内容非常广泛，从底层的Bootloader、内核、驱动，到上层的应用程序开发，每一个环节都需要扎实的基础知识。</p>
<p>我从单片机转到Linux开发的时候，也是从零开始学习，花了很长时间才慢慢掌握。</p>
<p>但是一旦掌握了这些技能，你会发现嵌入式Linux开发非常有意思。</p>
<p>你可以控制硬件，可以开发复杂的应用，可以解决各种各样的技术难题。</p>
<p>而且Linux的开源特性让你可以深入了解系统的每一个细节，这对于技术的提升非常有帮助。</p>
<p>如果你也想从事嵌入式Linux开发，我的建议是先打好基础，学习C语言、数据结构、操作系统原理等等。</p>
<p>然后动手实践，从简单的驱动开始写起，逐步深入。</p>
<p>遇到问题不要怕，多查资料，多思考，多尝试。</p>
<p>相信只要坚持下去，你一定能成为一名优秀的嵌入式Linux开发工程师。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[流式输出(Streaming)实现：提升用户体验]]></title>    <link>https://juejin.cn/post/7602162809292242982</link>    <guid>https://juejin.cn/post/7602162809292242982</guid>    <pubDate>2026-02-03T02:45:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602162809292242982" data-draft-id="7602154088476426278" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="流式输出(Streaming)实现：提升用户体验"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-03T02:45:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="听风者就是我"/> <meta itemprop="url" content="https://juejin.cn/user/360295544143277"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            流式输出(Streaming)实现：提升用户体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295544143277/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    听风者就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:45:05.000Z" title="Tue Feb 03 2026 02:45:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代 Web 应用中，用户体验的关键在于响应速度和交互反馈。当处理耗时操作时，传统的"等待-返回"模式往往让用户感到焦虑。流式输出（Streaming）技术通过逐步返回数据，让用户实时看到处理进度，极大提升了体验感知。本文将深入探讨如何在 Qwen Chatbot 项目中使用 SSE（Server-Sent Events）和异步处理实现流式输出。</p>
<h2 data-id="heading-0">为什么需要流式输出？</h2>
<p>想象一个场景：用户向 AI 助手提问，传统方式需要等待完整答案生成后才能看到结果，可能需要等待数十秒。而流式输出允许答案逐字逐句地呈现，就像真人对话一样自然。这种即时反馈不仅减少了感知等待时间，还增强了应用的互动性。</p>
<p>流式输出的典型应用场景包括：</p>
<ul>
<li>AI 对话系统（ChatGPT 式交互）</li>
<li>大文件处理进度</li>
<li>实时日志输出</li>
<li>数据分析报告生成</li>
</ul>
<h2 data-id="heading-1">技术选型：为什么选择 SSE？</h2>
<p>在实现流式数据传输时，我们有几种选择：WebSocket、HTTP/2 Server Push 和 SSE。对于单向数据流（服务器到客户端），SSE 是最优方案：</p>
<ul>
<li><strong>简单易用</strong>：基于 HTTP 协议，无需复杂握手</li>
<li><strong>自动重连</strong>：浏览器原生支持断线重连</li>
<li><strong>轻量级</strong>：相比 WebSocket 更节省资源</li>
<li><strong>防火墙友好</strong>：使用标准 HTTP 端口</li>
</ul>
<h2 data-id="heading-2">Qwen Chatbot 项目中的实现方案</h2>
<h3 data-id="heading-3">服务端：API 路由实现</h3>
<p>Next.js 的 Pages Router 提供了强大的 API 路由功能，非常适合实现 SSE。以下是 Qwen Chatbot 项目中的完整实现示例：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// pages/api/qwen.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextApiRequest</span>, <span class="hljs-title class_">NextApiResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">OpenAI</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'openai'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req: NextApiRequest, res: NextApiResponse</span>) {
  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> !== <span class="hljs-string">'POST'</span>) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">405</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Method not allowed'</span> });
  }

  <span class="hljs-keyword">const</span> { messages, stream = <span class="hljs-literal">false</span>, model, temperature = <span class="hljs-number">0.7</span>, top_p = <span class="hljs-number">0.9</span>, max_tokens = <span class="hljs-number">2048</span> } = req.<span class="hljs-property">body</span>;

  <span class="hljs-comment">// 验证必需字段</span>
  <span class="hljs-keyword">if</span> (!messages || !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(messages)) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">'Messages are required and must be an array'</span> });
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 创建 OpenAI 兼容的客户端，适配通义千问</span>
    <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>({
      <span class="hljs-attr">apiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_API_KEY</span> || <span class="hljs-string">''</span>,
      <span class="hljs-attr">baseURL</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_API_BASE</span> || <span class="hljs-string">'https://dashscope.aliyuncs.com/compatible-mode/v1'</span>,
    });

    <span class="hljs-keyword">if</span> (stream) {
      <span class="hljs-comment">// 使用 TransformStream 实现流式响应</span>
      <span class="hljs-keyword">const</span> encoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>();
      <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformStream</span>();
      <span class="hljs-keyword">const</span> writer = stream.<span class="hljs-property">writable</span>.<span class="hljs-title function_">getWriter</span>();

      <span class="hljs-comment">// 异步处理函数</span>
      (<span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">// 通义千问API支持system message，直接使用原始消息</span>
          <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> client.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
            <span class="hljs-attr">model</span>: model || process.<span class="hljs-property">env</span>.<span class="hljs-property">MODEL_NAME</span> || <span class="hljs-string">'qwen-max'</span>,
            messages,
            <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>,
            temperature,
            top_p,
            max_tokens,
            <span class="hljs-attr">stream_options</span>: { <span class="hljs-attr">include_usage</span>: <span class="hljs-literal">true</span> }, <span class="hljs-comment">// 包含使用量信息</span>
          });

          <span class="hljs-comment">// 逐块发送数据</span>
          <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> response) {
            <span class="hljs-keyword">const</span> content = chunk.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span>?.<span class="hljs-property">content</span>;
            
            <span class="hljs-comment">// 如果有内容，发送内容数据</span>
            <span class="hljs-keyword">if</span> (content) {
              <span class="hljs-keyword">const</span> data = <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ content })}</span>\n\n`</span>;
              <span class="hljs-keyword">await</span> writer.<span class="hljs-title function_">write</span>(encoder.<span class="hljs-title function_">encode</span>(data));
            }
            
            <span class="hljs-comment">// 如果有usage信息，发送token使用数据</span>
            <span class="hljs-keyword">if</span> (chunk.<span class="hljs-property">usage</span>) {
              <span class="hljs-keyword">const</span> tokenData = {
                <span class="hljs-attr">usage</span>: {
                  <span class="hljs-attr">prompt_tokens</span>: chunk.<span class="hljs-property">usage</span>.<span class="hljs-property">prompt_tokens</span>,
                  <span class="hljs-attr">completion_tokens</span>: chunk.<span class="hljs-property">usage</span>.<span class="hljs-property">completion_tokens</span>,
                  <span class="hljs-attr">total_tokens</span>: chunk.<span class="hljs-property">usage</span>.<span class="hljs-property">total_tokens</span>,
                }
              };
              <span class="hljs-keyword">const</span> data = <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(tokenData)}</span>\n\n`</span>;
              <span class="hljs-keyword">await</span> writer.<span class="hljs-title function_">write</span>(encoder.<span class="hljs-title function_">encode</span>(data));
            }
          }
          
          <span class="hljs-comment">// 发送结束信号</span>
          <span class="hljs-keyword">await</span> writer.<span class="hljs-title function_">write</span>(encoder.<span class="hljs-title function_">encode</span>(<span class="hljs-string">'data: [DONE]\n\n'</span>));
        } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
          <span class="hljs-comment">// 发送错误信息</span>
          <span class="hljs-keyword">await</span> writer.<span class="hljs-title function_">write</span>(
            encoder.<span class="hljs-title function_">encode</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ error: error.message || <span class="hljs-string">'AI service error'</span> })}</span>\n\n`</span>)
          );
        } <span class="hljs-keyword">finally</span> {
          <span class="hljs-keyword">await</span> writer.<span class="hljs-title function_">close</span>();
        }
      })();

      <span class="hljs-comment">// 返回 SSE 响应</span>
      res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/event-stream'</span>);
      res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Cache-Control'</span>, <span class="hljs-string">'no-cache'</span>);
      res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Connection'</span>, <span class="hljs-string">'keep-alive'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(stream.<span class="hljs-property">readable</span>, {
        <span class="hljs-attr">headers</span>: {
          <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/event-stream'</span>,
          <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'no-cache'</span>,
          <span class="hljs-string">'Connection'</span>: <span class="hljs-string">'keep-alive'</span>,
        },
      });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 非流式响应</span>
      <span class="hljs-comment">// 通义千问API支持system message，直接使用原始消息</span>
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> client.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
        <span class="hljs-attr">model</span>: model || process.<span class="hljs-property">env</span>.<span class="hljs-property">MODEL_NAME</span> || <span class="hljs-string">'qwen-max'</span>,
        messages,
        temperature,
        top_p,
        max_tokens,
      });

      <span class="hljs-keyword">const</span> content = response.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">message</span>?.<span class="hljs-property">content</span> || <span class="hljs-string">''</span>;
      <span class="hljs-keyword">const</span> usage = response.<span class="hljs-property">usage</span>;
      
      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>({ 
        content, 
        <span class="hljs-attr">usage</span>: usage ? {
          <span class="hljs-attr">prompt_tokens</span>: usage.<span class="hljs-property">prompt_tokens</span>,
          <span class="hljs-attr">completion_tokens</span>: usage.<span class="hljs-property">completion_tokens</span>,
          <span class="hljs-attr">total_tokens</span>: usage.<span class="hljs-property">total_tokens</span>,
        } : <span class="hljs-literal">undefined</span>
      });
    }
  } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error calling Qwen API:'</span>, error);
    
    <span class="hljs-keyword">let</span> errorMessage = <span class="hljs-string">'An error occurred while calling the API'</span>;
    <span class="hljs-keyword">let</span> statusCode = <span class="hljs-number">500</span>;
    
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
      errorMessage = <span class="hljs-string">'Authentication failed. Please check your API key.'</span>;
      statusCode = <span class="hljs-number">401</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">status</span> === <span class="hljs-number">403</span>) {
      errorMessage = <span class="hljs-string">'Access forbidden. Please check your API permissions.'</span>;
      statusCode = <span class="hljs-number">403</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">status</span> === <span class="hljs-number">429</span>) {
      errorMessage = <span class="hljs-string">'Rate limit exceeded. Please try again later.'</span>;
      statusCode = <span class="hljs-number">429</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">status</span> === <span class="hljs-number">404</span> &amp;&amp; error.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'model'</span>)) {
      errorMessage = <span class="hljs-string">'Model not found or access denied. Please check the model name and your API permissions. Try using "qwen-max" instead of "qwen-max-0102".'</span>;
      statusCode = <span class="hljs-number">404</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-property">message</span>) {
      errorMessage = error.<span class="hljs-property">message</span>;
    }
    
    res.<span class="hljs-title function_">status</span>(statusCode).<span class="hljs-title function_">json</span>({ 
      <span class="hljs-attr">error</span>: errorMessage,
      <span class="hljs-attr">details</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'development'</span> ? error.<span class="hljs-title function_">toString</span>() : <span class="hljs-literal">undefined</span>
    });
  }
}
</code></pre>
<p>关键点解析：</p>
<ol>
<li><strong>TransformStream</strong>：Next.js 推荐的流处理方式，比传统的 ReadableStream 更灵活</li>
<li><strong>TextEncoder</strong>：将字符串转换为 Uint8Array，符合流传输要求</li>
<li><strong>SSE 格式</strong>：数据必须以 <code>data: </code> 开头，以 <code>\n\n</code> 结尾</li>
<li><strong>异步 IIFE</strong>：立即执行的异步函数，避免阻塞响应返回</li>
<li><strong>通义千问适配</strong>：使用 OpenAI 兼容的 API 客户端，适配通义千问 API</li>
</ol>
<h3 data-id="heading-4">客户端：React 组件实现</h3>
<p>客户端需要处理 SSE 连接并实时更新 UI，以下是 Qwen Chatbot 项目中的实现：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// pages/chat.tsx (SSE 处理部分)</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">e: React.FormEvent</span>) =&gt; {
  e.<span class="hljs-title function_">preventDefault</span>();
  <span class="hljs-keyword">if</span> (!inputMessage.<span class="hljs-title function_">trim</span>() || isLoading) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 添加用户消息</span>
  <span class="hljs-keyword">const</span> userMessage = { <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: inputMessage };
  <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'ADD_MESSAGE'</span>, <span class="hljs-attr">payload</span>: userMessage });
  <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'SET_INPUT_MESSAGE'</span>, <span class="hljs-attr">payload</span>: <span class="hljs-string">''</span> });
  <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 准备消息数组，如果选择了角色并且该角色有系统提示，则在开头添加系统消息</span>
    <span class="hljs-keyword">let</span> messagesToSend = [...messages, userMessage];
    
    <span class="hljs-keyword">if</span> (selectedRoleId) {
      <span class="hljs-keyword">const</span> selectedRole = roles.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">id</span> === selectedRoleId);
      <span class="hljs-keyword">if</span> (selectedRole &amp;&amp; selectedRole.<span class="hljs-property">systemPrompt</span>) {
        <span class="hljs-comment">// 检查是否已经有系统消息，如果没有则添加</span>
        <span class="hljs-keyword">const</span> hasSystemMessage = messages.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> msg.<span class="hljs-property">role</span> === <span class="hljs-string">'system'</span>);
        <span class="hljs-keyword">if</span> (!hasSystemMessage) {
          messagesToSend = [{ <span class="hljs-attr">role</span>: <span class="hljs-string">'system'</span>, <span class="hljs-attr">content</span>: selectedRole.<span class="hljs-property">systemPrompt</span> }, ...messagesToSend];
        }
      }
    }
    
    <span class="hljs-comment">// 发送请求到后端 API</span>
    <span class="hljs-comment">// 使用流式响应获取实时token使用情况</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/qwen'</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
      },
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">messages</span>: messagesToSend,
        <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 使用流式响应</span>
        <span class="hljs-attr">model</span>: modelConfig.<span class="hljs-property">model</span>,
        <span class="hljs-attr">temperature</span>: modelConfig.<span class="hljs-property">temperature</span>,
        <span class="hljs-attr">top_p</span>: modelConfig.<span class="hljs-property">top_p</span>,
        <span class="hljs-attr">max_tokens</span>: modelConfig.<span class="hljs-property">max_tokens</span>,
      }),
    });

    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">const</span> errorData = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(errorData.<span class="hljs-property">error</span> || <span class="hljs-string">'Failed to get response from API'</span>);
    }

    <span class="hljs-comment">// 处理流式响应</span>
    <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>?.<span class="hljs-title function_">getReader</span>();
    <span class="hljs-keyword">if</span> (!reader) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Could not read response body'</span>);
    }

    <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-attr">assistantMessage</span>: <span class="hljs-title class_">Message</span> = { <span class="hljs-attr">role</span>: <span class="hljs-string">'assistant'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">usage</span>: <span class="hljs-literal">undefined</span> };
    
    <span class="hljs-comment">// 创建助手消息并添加到消息列表</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">newAssistantMessage</span>: <span class="hljs-title class_">Message</span> = { <span class="hljs-attr">role</span>: <span class="hljs-string">'assistant'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">usage</span>: <span class="hljs-literal">undefined</span> };
    <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'ADD_MESSAGE'</span>, <span class="hljs-attr">payload</span>: newAssistantMessage });

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
      <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
      <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });
      <span class="hljs-keyword">const</span> lines = chunk.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
        <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data: '</span>)) {
          <span class="hljs-keyword">const</span> data = line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>); <span class="hljs-comment">// 移除 'data: ' 前缀</span>
          
          <span class="hljs-keyword">if</span> (data === <span class="hljs-string">'[DONE]'</span>) {
            <span class="hljs-comment">// 流结束</span>
            <span class="hljs-keyword">break</span>;
          }

          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> parsed = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);
            <span class="hljs-keyword">if</span> (parsed.<span class="hljs-property">content</span>) {
              <span class="hljs-comment">// 更新最后一条消息的内容</span>
              assistantMessage.<span class="hljs-property">content</span> += parsed.<span class="hljs-property">content</span>;
              <span class="hljs-comment">// 只更新助手消息，保留之前的消息</span>
              <span class="hljs-keyword">const</span> updatedMessages = [...messages, { ...assistantMessage }];
              <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'SET_MESSAGES'</span>, <span class="hljs-attr">payload</span>: updatedMessages });
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parsed.<span class="hljs-property">usage</span>) {
              <span class="hljs-comment">// 更新最后一条消息的使用情况</span>
              assistantMessage.<span class="hljs-property">usage</span> = parsed.<span class="hljs-property">usage</span>;
              <span class="hljs-keyword">const</span> updatedMessages = [...messages, { ...assistantMessage }];
              <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'SET_MESSAGES'</span>, <span class="hljs-attr">payload</span>: updatedMessages });
            }
          } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-comment">// 忽略无法解析的数据行</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error parsing data:'</span>, e);
          }
        }
      }
    }
    
    <span class="hljs-comment">// 在流结束后记录对话历史</span>
    <span class="hljs-keyword">const</span> updatedMessages = [...messages, assistantMessage]; <span class="hljs-comment">// 获取包含最新消息的完整消息列表</span>
    <span class="hljs-keyword">const</span> lastAssistantMessage = updatedMessages[updatedMessages.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]; <span class="hljs-comment">// 最后一条消息应该是助手的回复</span>
    
    <span class="hljs-keyword">if</span> (lastAssistantMessage &amp;&amp; lastAssistantMessage.<span class="hljs-property">role</span> === <span class="hljs-string">'assistant'</span>) {
      <span class="hljs-keyword">const</span> <span class="hljs-attr">newHistoryEntry</span>: <span class="hljs-title class_">ConversationHistory</span> = {
        <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), <span class="hljs-comment">// 使用时间戳作为唯一ID</span>
        <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
        <span class="hljs-attr">input</span>: inputMessage,
        <span class="hljs-attr">output</span>: lastAssistantMessage.<span class="hljs-property">content</span>,
        <span class="hljs-attr">model</span>: modelConfig.<span class="hljs-property">model</span>,
        <span class="hljs-attr">params</span>: {
          <span class="hljs-attr">temperature</span>: modelConfig.<span class="hljs-property">temperature</span>,
          <span class="hljs-attr">top_p</span>: modelConfig.<span class="hljs-property">top_p</span>,
          <span class="hljs-attr">max_tokens</span>: modelConfig.<span class="hljs-property">max_tokens</span>,
        },
        <span class="hljs-attr">tokenUsage</span>: assistantMessage.<span class="hljs-property">usage</span> ? {
          <span class="hljs-attr">prompt_tokens</span>: assistantMessage.<span class="hljs-property">usage</span>.<span class="hljs-property">prompt_tokens</span>,
          <span class="hljs-attr">completion_tokens</span>: assistantMessage.<span class="hljs-property">usage</span>.<span class="hljs-property">completion_tokens</span>,
          <span class="hljs-attr">total_tokens</span>: assistantMessage.<span class="hljs-property">usage</span>.<span class="hljs-property">total_tokens</span>
        } : <span class="hljs-literal">undefined</span>,
        <span class="hljs-attr">evaluation</span>: <span class="hljs-string">''</span> <span class="hljs-comment">// 可以让使用者手动填写或系统自动生成</span>
      };
      
      <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'ADD_TO_HISTORY'</span>, <span class="hljs-attr">payload</span>: newHistoryEntry }); <span class="hljs-comment">// 添加到历史记录开头</span>
    }
  } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error:'</span>, error);
    <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'ADD_MESSAGE'</span>, <span class="hljs-attr">payload</span>: {
      <span class="hljs-attr">role</span>: <span class="hljs-string">'assistant'</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">`Error: <span class="hljs-subst">${error.message || <span class="hljs-string">'An unknown error occurred'</span>}</span>`</span>
    }});
    
    <span class="hljs-comment">// 即使出错也记录历史</span>
    <span class="hljs-keyword">const</span> errorMessage = <span class="hljs-string">`Error: <span class="hljs-subst">${error.message || <span class="hljs-string">'An unknown error occurred'</span>}</span>`</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">newHistoryEntry</span>: <span class="hljs-title class_">ConversationHistory</span> = {
      <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), <span class="hljs-comment">// 使用时间戳作为唯一ID</span>
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
      <span class="hljs-attr">input</span>: inputMessage,
      <span class="hljs-attr">output</span>: errorMessage,
      <span class="hljs-attr">model</span>: modelConfig.<span class="hljs-property">model</span>,
      <span class="hljs-attr">params</span>: {
        <span class="hljs-attr">temperature</span>: modelConfig.<span class="hljs-property">temperature</span>,
        <span class="hljs-attr">top_p</span>: modelConfig.<span class="hljs-property">top_p</span>,
        <span class="hljs-attr">max_tokens</span>: modelConfig.<span class="hljs-property">max_tokens</span>,
      },
      <span class="hljs-attr">tokenUsage</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-comment">// 错误情况下无token使用数据</span>
      <span class="hljs-attr">evaluation</span>: <span class="hljs-string">'Error occurred'</span> <span class="hljs-comment">// 标记为错误</span>
    };
    
    <span class="hljs-title function_">dispatch</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'ADD_TO_HISTORY'</span>, <span class="hljs-attr">payload</span>: newHistoryEntry }); <span class="hljs-comment">// 添加到历史记录开头</span>
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
  }
};
</code></pre>
<p>核心实现要点：</p>
<ol>
<li><strong>ReadableStream Reader</strong>：使用 <code>getReader()</code> 逐块读取数据</li>
<li><strong>TextDecoder</strong>：将二进制数据解码为字符串</li>
<li><strong>状态更新</strong>：通过 Redux-like 状态管理更新消息</li>
<li><strong>错误处理</strong>：妥善处理解析错误和网络异常</li>
<li><strong>Token 使用情况</strong>：实时更新 API 调用的 token 使用情况</li>
</ol>
<h3 data-id="heading-5">前端打字机效果实现</h3>
<p>为了让流式输出看起来更自然，我们在前端实现了打字机效果：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// components/TypeWriterEffect.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'../styles/TypeWriterEffect.module.css'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">TypeWriterEffectProps</span> {
  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>;
  speed?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 打字速度，毫秒/字符</span>
  className?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 自定义类名</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">TypeWriterEffect</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">TypeWriterEffectProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ 
  text, 
  speed = <span class="hljs-number">50</span>, // 放慢速度到50ms/字符，让效果更明显
  className = <span class="hljs-string">''</span>
}</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> [displayedText, setDisplayedText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [isTyping, setIsTyping] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> timeoutRef = useRef&lt;<span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 每次text变化时重置</span>
    <span class="hljs-title function_">setDisplayedText</span>(<span class="hljs-string">''</span>);
    <span class="hljs-title function_">setIsTyping</span>(<span class="hljs-literal">true</span>);
    
    <span class="hljs-comment">// 清除之前的定时器</span>
    <span class="hljs-keyword">if</span> (timeoutRef.<span class="hljs-property">current</span>) {
      <span class="hljs-built_in">clearTimeout</span>(timeoutRef.<span class="hljs-property">current</span>);
    }

    <span class="hljs-comment">// 如果文本为空，直接返回</span>
    <span class="hljs-keyword">if</span> (!text) {
      <span class="hljs-title function_">setIsTyping</span>(<span class="hljs-literal">false</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 开始打字</span>
    <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">typeNextChar</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (index &lt; text.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">const</span> char = text[index];
        <span class="hljs-comment">// 确保字符不是undefined或null</span>
        <span class="hljs-keyword">if</span> (char !== <span class="hljs-literal">undefined</span> &amp;&amp; char !== <span class="hljs-literal">null</span>) {
          <span class="hljs-comment">// 强制更新，避免React优化</span>
          <span class="hljs-title function_">setDisplayedText</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-title class_">String</span>(char));
        }
        index++;
        timeoutRef.<span class="hljs-property">current</span> = <span class="hljs-built_in">setTimeout</span>(typeNextChar, speed);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">setIsTyping</span>(<span class="hljs-literal">false</span>);
      }
    };

    timeoutRef.<span class="hljs-property">current</span> = <span class="hljs-built_in">setTimeout</span>(typeNextChar, speed);

    <span class="hljs-comment">// 清理</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (timeoutRef.<span class="hljs-property">current</span>) {
        <span class="hljs-built_in">clearTimeout</span>(timeoutRef.<span class="hljs-property">current</span>);
      }
    };
  }, [text, speed]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">styles.typeWriterText</span>} ${<span class="hljs-attr">className</span>}`}&gt;</span>
      {displayedText}
      {isTyping &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.cursor}</span>&gt;</span>|<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TypeWriterEffect</span>;
</code></pre>
<h2 data-id="heading-6">性能优化技巧</h2>
<h3 data-id="heading-7">1. 背压处理（Backpressure）</h3>
<p>当客户端处理速度跟不上服务端发送速度时，需要实现背压机制：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> writer = stream.<span class="hljs-property">writable</span>.<span class="hljs-title function_">getWriter</span>();

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">writeWithBackpressure</span>(<span class="hljs-params">data: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">await</span> writer.<span class="hljs-property">ready</span>; <span class="hljs-comment">// 等待缓冲区可写</span>
  <span class="hljs-keyword">await</span> writer.<span class="hljs-title function_">write</span>(encoder.<span class="hljs-title function_">encode</span>(data));
}
</code></pre>
<h3 data-id="heading-8">2. 分块策略</h3>
<p>合理控制每次发送的数据量，避免过小（频繁网络开销）或过大（失去流式效果）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> buffer = <span class="hljs-string">''</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CHUNK_SIZE</span> = <span class="hljs-number">50</span>; <span class="hljs-comment">// 每 50 个字符发送一次</span>

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> char <span class="hljs-keyword">of</span> response) {
  buffer += char;
  <span class="hljs-keyword">if</span> (buffer.<span class="hljs-property">length</span> &gt;= <span class="hljs-variable constant_">CHUNK_SIZE</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">writeWithBackpressure</span>(<span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ content: buffer })}</span>\n\n`</span>);
    buffer = <span class="hljs-string">''</span>;
  }
}
</code></pre>
<h3 data-id="heading-9">3. 连接管理</h3>
<p>实现心跳检测，防止连接意外断开：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 服务端定期发送心跳</span>
<span class="hljs-keyword">const</span> heartbeatInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  writer.<span class="hljs-title function_">write</span>(encoder.<span class="hljs-title function_">encode</span>(<span class="hljs-string">': heartbeat\n\n'</span>));
}, <span class="hljs-number">30000</span>);

<span class="hljs-comment">// 清理</span>
process.<span class="hljs-title function_">on</span>(<span class="hljs-string">'exit'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(heartbeatInterval));
</code></pre>
<h2 data-id="heading-10">实战案例：Qwen Chatbot 中的集成</h2>
<p>在 Qwen Chatbot 项目中，我们将以上技术整合到了真实的 AI 对话系统中：</p>
<ol>
<li><strong>消息组件集成</strong>：在 ChatWindow 组件中使用 TypeWriterEffect 显示助手回复</li>
<li><strong>状态管理</strong>：使用全局状态管理器跟踪消息流</li>
<li><strong>实时更新</strong>：SSE 流实时更新助手消息内容</li>
<li><strong>打字效果</strong>：前端实现的打字机效果增强用户体验</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// components/ChatWindow.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TypeWriterEffect</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./TypeWriterEffect'</span>;

<span class="hljs-comment">// ...</span>

{messages.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">msg, index</span>) =&gt;</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">styles.message</span>} ${<span class="hljs-attr">styles</span>[<span class="hljs-attr">msg.role</span>]}`}&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.avatar}</span>&gt;</span>
      {msg.role === 'user' ? '👤' : '🤖'}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.content}</span>&gt;</span>
      {msg.role === 'assistant' ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">TypeWriterEffect</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{msg.content}</span> <span class="hljs-attr">speed</span>=<span class="hljs-string">{20}</span> /&gt;</span>
      ) : (
        msg.content
      )}
      {msg.usage &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.tokenInfo}</span>&gt;</span>
          Tokens: {msg.usage.total_tokens} (Prompt: {msg.usage.prompt_tokens}, Completion: {msg.usage.completion_tokens})
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
))}
</code></pre>
<h2 data-id="heading-11">注意事项与最佳实践</h2>
<ol>
<li><strong>超时处理</strong>：设置合理的超时时间，避免连接永久挂起</li>
<li><strong>错误恢复</strong>：客户端应实现重试机制，处理网络波动</li>
<li><strong>资源清理</strong>：确保 writer 和 reader 正确关闭，防止内存泄漏</li>
<li><strong>CORS 配置</strong>：跨域场景需要正确配置响应头</li>
<li><strong>进度指示</strong>：提供明确的加载状态，让用户知道系统正在工作</li>
<li><strong>打字机效果优化</strong>：不能依赖 SSE 返回粒度，必须在前端主动控制显示节奏</li>
<li><strong>API 兼容性</strong>：适配不同 LLM 提供商的 API 格式差异</li>
</ol>
<h2 data-id="heading-12">总结</h2>
<p>流式输出通过 SSE 和异步处理技术，将"等待-返回"的交互模式转变为"实时反馈"的体验。在 Qwen Chatbot 项目中，借助 Next.js 和 Web Streams API，我们优雅地实现了这一功能。无论是 AI 对话、数据处理还是实时日志，流式输出都能显著提升用户体验。</p>
<p>通过结合后端流式传输和前端打字机效果，我们实现了既高效又直观的用户交互体验。随着 Web 技术的发展，流式处理将成为构建现代 AI 应用的标配能力。掌握这项技术，让你的应用更加流畅、响应更加迅速，为用户带来更好的交互体验。</p>
<hr/>
<h3 data-id="heading-13">项目地址</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjianzhang96%2Fllm%2Ftree%2Fmain%2Fqwen-chatbot" target="_blank" title="https://github.com/jianzhang96/llm/tree/main/qwen-chatbot" ref="nofollow noopener noreferrer">github.com/jianzhang96…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fcodehub%2Fllm%2Ftree%2Fmain%2Fqwen-chatbot" target="_blank" title="https://gitee.com/codehub/llm/tree/main/qwen-chatbot" ref="nofollow noopener noreferrer">gitee.com/codehub/llm…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent能力扩展两大关键路径：一文读懂Agent Skills和MCP协议的核心原理与设计哲学]]></title>    <link>https://juejin.cn/post/7602146335215779880</link>    <guid>https://juejin.cn/post/7602146335215779880</guid>    <pubDate>2026-02-03T03:02:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602146335215779880" data-draft-id="7602135278665318452" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent能力扩展两大关键路径：一文读懂Agent Skills和MCP协议的核心原理与设计哲学"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-03T03:02:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="中杯可乐多加冰"/> <meta itemprop="url" content="https://juejin.cn/user/3435306702347432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent能力扩展两大关键路径：一文读懂Agent Skills和MCP协议的核心原理与设计哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3435306702347432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    中杯可乐多加冰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:02:26.000Z" title="Tue Feb 03 2026 03:02:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读29分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>随着大型语言模型（LLMs）的飞速发展，人工智能的应用范式正从单一的“对话”模式，逐步演进至能够自主“行动”的智能体（AI Agent）时代。</p>
<p>这些智能体不再仅仅是信息问答的工具，它们被赋予了理解复杂指令、规划任务、调用外部工具乃至与真实世界交互的能力。然而，要让 AI 智能体真正发挥其潜力，实现通用化、可扩展且安全可靠的能力，其背后需要一套高效且灵活的机制来管理和扩展其功能。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f976ba0c30e5430d8d7446b170cd7f49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=AWQ%2FRlA3yA5Xaw5uefJ17VE7jBU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>在此背景下，Agent Skills 和 Model Context Protocol (MCP)已成为扩展 AI 智能体能力的两大核心技术路径</strong>。Agent Skills 侧重于将领域专业知识和工作流以文件化的形式进行封装，<strong>强调便携性和可读性</strong>；而 MCP 则致力于构建一套标准化的通信协议，<strong>旨在将 AI 应用程序与各种外部工具、数据源和系统无缝连接</strong>。</p>
<p>两者虽然在设计理念和实现路径上有所差异，但共同的目标都是为了赋能 AI 智能体，使其能够处理更广泛、更复杂的任务。</p>
<p>本文将深入剖析 <strong>Agent Skills 和 MCP</strong> 的架构设计、核心原理，并详细对比两者的异同与各自的优势，并探讨它们在实际应用中的价值。</p>
<h2 data-id="heading-1">一、Agent Skills：基于文件的便携式能力封装</h2>
<h3 data-id="heading-2">1.1、核心定义与设计哲学</h3>
<p>Agent Skills，顾名思义，是赋予 AI 智能体特定“技能”的一种机制。它并非一个复杂的框架或协议，而是一种<strong>基于文件的、便携式的格式</strong>，旨在将特定的领域专业知识、自动化工作流以及可执行代码，以自包含的方式封装在一个个独立的技能目录中。其核心设计哲学在于<strong>简化能力扩展的门槛，强调可读性、可移植性与低集成成本</strong>。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24bd24b7e2f14127b7ce35ab7b2adb49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=i1a8GOZWctnClccmuByNpIQBSuQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>如果将 AI 智能体比作一个拥有无限学习潜力的学生，那么 Agent Skills 就如同为这个学生准备的一本本精心编撰的“教材”或“操作手册”。与传统Prompt不同，这些手册不仅包含了理论知识（领域专业知识），还<strong>提供了具体的实践步骤（自动化工作流）和可供执行的工具（可执行代码）</strong>。这种文件化的封装方式，使得技能的创建者可以专注于业务逻辑本身，而无需过多关注复杂的通信协议或部署细节。通过将技能以文件目录的形式组织起来，Agent Skills 实现了<strong>高度的模块化</strong>，每个技能都是一个独立的单元，可以轻松地进行版本控制、分享和复用。</p>
<p>这种设计理念的优势在于，它极大地降低了 AI 智能体获取新能力的技术壁垒。开发者或领域专家只需遵循一套简单的文件结构规范，即可将自己的专业知识转化为 AI 智能体可理解和执行的技能。这种“<strong>即插即用</strong>”的特性，使得 AI 智能体能够快速适应新的任务场景，有效应对不断变化的业务需求。同时，由于其文件化的本质，Agent Skills 天然具备<strong>良好的可读性</strong>，人类开发者可以直观地理解技能的内部逻辑，从而便于调试、维护和协作。</p>
<h3 data-id="heading-3">1.2、SKILL.md 的结构化解析</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0557a35a04842539a60aceb62b942d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=OcpYHN%2BQxPZrTUka9x0HfODcghQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>Agent Skills 的核心在于其对 <code>SKILL.md</code> 文件的定义。这个文件是每个技能的“身份证”和“说明书”，它以一种人类可读且机器可解析的格式，详细描述了技能的元数据、使用说明以及如何调用其内部资源。<code>SKILL.md</code> 通常采用 <strong>YAML 前置元数据（YAML Front Matter）结合 Markdown 指令</strong>的方式编写，这使得它既能承载结构化的信息，又能提供丰富的文本描述。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bd16fad3368487d85e56eaeb3db1630~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=VTqGSxeK8wjJ2Lx5I%2FY7Bnk%2FJfk%3D" alt="在这里插入图片描述" loading="lazy"/>
一个完整的skill.md基本如下：</p>
<pre><code class="hljs language-cpp" lang="cpp">---
name: pdf-processing
description: 从 PDF 文件中提取文本和表格、填写表单、合并文档
version: <span class="hljs-number">1.0</span><span class="hljs-number">.0</span>
author: Example Team
---

# PDF 处理技能

## 技能概述
这个技能帮助智能体处理各种 PDF 相关任务，包括文本提取、表格解析、文档合并等操作。

## 何时使用此技能
当用户提出以下需求时激活此技能：
- 从 PDF 中提取文本或数据
- 解析 PDF 中的表格结构
- 合并多个 PDF 文件
- 填写 PDF 表单
- 将 PDF 转换为其他格式

## 前置要求
- 确认环境中已安装 `PyPDF2` 和 `pdfplumber` 库
- 对于 OCR 功能，需要 `pytesseract`
- 检查 PDF 文件是否可访问且未加密

## 操作步骤

### <span class="hljs-number">1.</span> 文本提取
<span class="hljs-string">'''</span>python
# 使用 scripts/extract_text.py
python scripts/extract_text.py --input document.pdf --output output.txt
<span class="hljs-string">'''</span>
### <span class="hljs-number">2.</span> 表格解析

- 使用 `pdfplumber` 识别表格边界
- 将表格数据转换为 CSV 或 JSON 格式
- 参考 `references/table-parsing-guide.md` 了解复杂表格处理方法

### <span class="hljs-number">3.</span> PDF 合并

<span class="hljs-string">'''</span>python
# 使用 scripts/merge_pdfs.py
python scripts/merge_pdfs.py --files file1.pdf file2.pdf --output merged.pdf
<span class="hljs-string">'''</span>
### <span class="hljs-number">4.</span> 处理扫描件

- 如果 PDF 是扫描图像，先调用 OCR 功能
- 详细步骤参见 `references/ocr-guide.md`
- 使用 Tesseract 进行文字识别

## 常见问题处理

- **加密 PDF**：提示用户提供密码或使用解密工具
- **损坏文件**：尝试使用 PDF 修复工具
- **大文件**：分批处理，避免内存溢出

## 输出格式

根据任务类型返回：

- 纯文本：`.txt` 文件
- 表格数据：`.csv` 或 `.json` 文件
- 合并文档：新的 `.pdf` 文件

## 参考信息

- `references/pdf-standards.md` - PDF 格式标准说明
- `references/ocr-guide.md` - OCR 最佳实践
- `references/troubleshooting.md` - 常见问题排查
</code></pre>
<p><strong>YAML 前置元数据</strong>部分通常包含技能的名称、描述、作者、版本、许可证以及所需的兼容性信息等。这些元数据为 AI 智能体提供了关于技能的概览信息，帮助其在众多技能中快速发现和匹配任务需求。例如，一个数据分析技能的元数据可能会声明它需要 <code>pandas</code> 和 <code>matplotlib</code> 库，以便 AI 智能体在加载前检查环境依赖。</p>
<p><strong>Markdown 指令</strong>部分则详细阐述了技能的使用方法、输入参数、预期输出以及任何必要的执行步骤。这部分内容通常以清晰的自然语言编写，辅以代码示例或命令行指令，确保 AI 智能体能够准确理解并执行技能。例如，一个图像处理技能的 Markdown 指令可能会说明如何指定输入图像路径、选择处理模式（如裁剪、缩放）以及输出路径。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38faf2f7430b4b30b1839dbae2b6f738~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=baT0A7hQvUL7JeSpQwJBlihtGCc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>Agent Skills 引入了<strong>渐进式加载机制</strong>，这是其高效性的关键。这个机制将技能的加载过程分为三个阶段：</p>
<ol>
<li><strong>元数据（Metadata）加载</strong>：AI 智能体首先加载 <code>SKILL.md</code> 中的 YAML 元数据。这一阶段的开销极低，通常只涉及几十到几百个 Token 的处理。智能体可以基于这些轻量级的元数据快速判断技能是否与当前任务相关，从而避免加载不必要的完整技能内容。</li>
<li><strong>指令（Instructions）加载</strong>：如果元数据表明技能可能相关，智能体将进一步加载 <code>SKILL.md</code> 中的 Markdown 指令部分。这一阶段提供了技能的详细使用说明，帮助智能体理解如何与技能交互，包括输入参数的格式、执行逻辑等。此时，智能体已经对技能有了较为全面的认识，可以进行更精确的任务匹配和规划。</li>
<li><strong>资源（Resources）加载</strong>：只有当智能体确定需要执行某个技能时，才会按需加载其关联的外部资源，例如 <code>scripts/</code> 目录下的可执行脚本、<code>references/</code> 目录下的文档或 <code>assets/</code> 目录下的数据文件。这种按需加载的策略极大地优化了资源利用率，避免了不必要的内存占用和计算开销，尤其是在拥有大量技能的复杂系统中，其优势更为明显。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9119218345ce4f48872285fa6c8f48fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=q9oUHm7KIOOV0KICHO6RgHo5SWk%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ol>
<p>这种分阶段加载的模式，使得 Agent Skills 在<strong>低开销的技能发现和高效率的按需执行</strong>之间取得了良好的平衡，是其实现轻量级、高性能扩展能力的重要基石。</p>
<h3 data-id="heading-4">1.3、Skill 的生命周期管理</h3>
<p>Agent Skills 的生命周期管理相对直观，主要围绕其文件化的特性展开。一个 Skill 从被创建到最终被 AI 智能体使用，通常会经历以下几个核心阶段。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5032be19dbec4aa19121a234dc05d3e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=qsKDPE%2BynBlRezdAJ9zr8bdKvtM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>
<p><strong>技能创建与打包</strong>：开发者或领域专家根据特定的任务需求，编写 <code>SKILL.md</code> 文件，并组织相关的脚本、文档和数据资源，形成一个自包含的技能目录。这个目录可以是一个简单的文件夹，也可以是一个版本控制系统（如 Git）中的仓库。</p>
</li>
<li>
<p><strong>技能发现（Discovery）</strong>：AI 智能体通过扫描预设的技能仓库目录，发现可用的 Skill。在这个阶段，智能体主要读取每个 Skill 目录中的 <code>SKILL.md</code> 文件的 YAML 元数据，以快速了解技能的基本信息，如名称、描述、功能等。这一过程是轻量级的，旨在高效地构建一个可用的技能列表。</p>
</li>
<li>
<p><strong>技能匹配与选择</strong>：当用户提出一个任务请求时，AI 智能体根据任务的语义内容，结合已发现的技能元数据，进行智能匹配。如果初步匹配成功，智能体可能会进一步加载 <code>SKILL.md</code> 的 Markdown 指令部分，以获取更详细的使用说明，从而做出更精确的技能选择决策。</p>
</li>
<li>
<p><strong>技能激活与加载（Activation &amp; Loading）</strong>：一旦某个 Skill 被选中用于执行当前任务，AI 智能体便会“激活”它。这意味着智能体将根据 <code>SKILL.md</code> 中的指令，按需加载该 Skill 所需的脚本、数据或其他外部资源。例如，如果 Skill 包含 Python 脚本，智能体可能会在沙箱环境中执行这些脚本。</p>
</li>
<li>
<p><strong>技能执行（Execution）</strong>：在资源加载完成后，AI 智能体将根据 <code>SKILL.md</code> 中定义的执行流程，调用 Skill 内部的功能。这可能涉及到运行脚本、处理数据、调用外部 API 等操作。Skill 的执行通常在<strong>沙箱环境</strong>中进行，以确保安全性和隔离性，防止恶意代码对系统造成影响。</p>
</li>
<li>
<p><strong>结果返回与卸载</strong>：Skill 执行完成后，将结果返回给 AI 智能体。智能体处理结果后，该 Skill 的相关资源可能会被卸载，以释放系统资源。由于 Agent Skills 本身是无状态的，每次执行都是一个相对独立的过程，这简化了资源管理和并发执行的复杂性。</p>
</li>
</ol>
<p>这种文件驱动的生命周期管理模式，使得 Agent Skills 具有极高的<strong>便携性</strong>和<strong>可维护性</strong>。开发者可以像管理普通文件一样管理 Skill，轻松地进行版本迭代、分享和部署，为 AI 智能体的能力扩展提供了坚实的基础。</p>
<h3 data-id="heading-5">1.4、Agent Skills 与传统 Prompt 的本质差异</h3>
<p>在讨论 Agent Skills 时，一个几乎不可避免的问题是：它与我们已经非常熟悉的 Prompt 到底有什么区别？从表面上看，Skill 似乎只是把一段更长、更结构化的指令写进了 SKILL.md，而不是直接塞进对话上下文中。但如果仅仅把 Agent Skills 理解为“高级 Prompt”或“Prompt 模板的文件化版本”，就会低估它在设计理念和能力边界上的根本变化。</p>
<p>传统 Prompt 的核心特征，是一次性的、上下文内的指令。它依附于具体的对话场景存在，随着上下文的结束而自然消失。无论 Prompt 写得多么精巧，它本质上仍然是在“临时塑形”模型的行为，要求模型在当前窗口内按照某种方式思考和回答问题。这种方式的局限很明显：Prompt 难以复用、难以版本化，也很难表达复杂、分阶段的执行逻辑。更重要的是，Prompt 的主要受众始终是模型本身，而不是人与模型之间的共同理解空间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6571e4b46004a74bf00a681e531f240~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=XJ3lrDQH3%2Fn76rwNj4o71aex%2Fw4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>Agent Skills 则完全不同。Skill 的出发点并不是“这一轮对话要模型怎么做”，而是“当遇到某一类问题时，智能体应当具备怎样的一种能力”。它强调的是长期存在、可被反复调用的能力定义，而不是短期生效的行为引导。SKILL.md 的存在，使得能力第一次脱离了对话上下文，成为一种独立、稳定、可管理的实体。智能体不是在每次对话中被重新“说服”去遵循某个 Prompt，而是在需要时主动选择并加载一个已经定义好的 Skill。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9ea2a8293bc42c98e9a316a59e065e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=QoR8J3m1WTX6opuxMU4ehb8CbAw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这种差异带来的直接结果，是 <strong>Skill 更容易承载复杂的工作流程</strong>。<strong>一个传统 Prompt 很难清晰地区分“理解任务”“执行步骤”“调用外部资源”“失败时的处理方式”等不同阶段，而 Skill 则可以通过清晰的文本结构和按需加载机制</strong>，将这些阶段自然拆解。对智能体而言，这不再是一段需要完整记住并严格遵循的长指令，而是一套可以逐步理解、逐步执行的行动指南。这种渐进式的使用方式，显著降低了模型在复杂任务中“走偏”的概率。</p>
<p>从人的角度来看，Skill 与 Prompt 的区别同样重要。Prompt 往往是写给模型看的，追求的是对模型行为的即时控制；而 Skill 更像是写给未来的合作者看的，无论这个合作者是人还是智能体。它要求表达清晰、边界明确，也因此更适合被审阅、被讨论、被改进。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd369a1b03354a80b8c83704d4b3dbc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=wNQP8332AoAKdDeyPyIh4eKfLXE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>正因为如此，一个 Skill 往往对应着某种已经被反复验证过的做事方式，可能来自资深工程师、业务专家，甚至是团队长期积累下来的共识。当这些经验被整理成 Skill，它们就不再依附于某个具体的人，而是可以被任何智能体加载、理解和执行。这种从“个人经验”到“可复用能力”的转化，是 Agent Skills 最容易被低估、却最具长期价值的地方。</p>
<p>与此同时，Skill 的轻量化特性也让它在实际落地中显得格外友好。没有复杂的部署流程，没有必须运行的服务，<strong>一个目录、一份文件，就足以让智能体获得一项新能力</strong>。这种低门槛不仅降低了开发成本，更重要的是，它让更多非工程背景的人也能够参与到智能体能力的构建中来。会写文档的人、懂业务的人、熟悉流程的人，都可以通过 Skill 的形式，把自己的经验直接“教”给 AI。</p>
<p>因此，Agent Skills 并不是对 Prompt 的简单升级，而是一次能力表达范式的切换。Prompt 更像是即时对话中的语言技巧，而 Skill 则是在为智能体构建一套稳定的“做事方法”。<strong>当 AI 从“会说话”走向“能办事”，这种从临时指令到可沉淀能力的转变，恰恰构成了 Agent Skills 最核心、也最不可替代的价值。</strong></p>
<p>也正因如此，当你第一次真正理解 Agent Skills 的设计初衷时，往往会产生一种很强烈的感觉：这不只是给 AI 用的技术，而是一种把人类经验系统性传递给智能体的新方式。如果说过去我们是在教模型“回答问题”，那么从 Agent Skills 开始，我们才真正开始教它“怎么把事做好”。</p>
<h2 data-id="heading-6">二、MCP：AI 时代的“USB-C”标准协议</h2>
<h3 data-id="heading-7">2.1、三层架构深度剖析</h3>
<p>与 Agent Skills 的文件驱动模式不同，Model Context Protocol (MCP) 采取了一种<strong>协议驱动</strong>的策略，旨在为 AI 应用程序与外部系统之间建立一套标准化的通信桥梁。MCP 的设计理念是成为 AI 时代的“USB-C”，即一个<strong>通用、可扩展的接口</strong>，允许 AI 智能体无缝地连接并利用各种外部工具、数据源和系统。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0349016a8b94df2a17725ab00e708cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=g2mIca%2Fn1qSPrVkOBmvVnaXK%2Bp8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>其核心在于一个清晰定义的三层架构：<strong>AI Host Application (AI 主机应用)、MCP Client (MCP 客户端) 和 MCP Server (MCP 服务器)</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf007713c5094df2828d87a722804d55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=ocynWW%2BDSe%2Fh0%2FF29QgXStr0RCM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>
<p><strong>AI Host Application (AI 主机应用)</strong>：这一层代表了运行 AI 智能体的主体，例如 Claude Desktop、VS Code 或其他任何需要扩展能力的 AI 应用程序。AI 主机应用是用户与 AI 智能体交互的界面，它负责接收用户指令，并将这些指令转化为对外部能力的需求。它不直接与外部工具交互，而是通过 MCP Client 发送请求并接收响应。</p>
</li>
<li>
<p><strong>MCP Client (MCP 客户端)</strong>：作为 AI 主机应用与 MCP Server 之间的<strong>中间层</strong>，MCP Client 扮演着关键的协调角色。它负责将 AI 主机应用的请求（例如调用某个工具或查询某个数据源）封装成符合 MCP 规范的 JSON-RPC 2.0 消息，并发送给相应的 MCP Server。同时，它也负责接收 MCP Server 返回的响应，并将其解析后传递给 AI 主机应用。MCP Client 还管理着与 MCP Server 的连接生命周期，包括连接的建立、维护和终止，以及处理潜在的连接中断和重试机制。</p>
</li>
<li>
<p><strong>MCP Server (MCP 服务器)</strong>：MCP Server 是<strong>外部能力（工具、数据源、服务）的实际提供者</strong>。它可以是一个运行在本地或远程的进程，负责监听来自 MCP Client 的请求，执行相应的操作（例如调用一个外部 API、查询一个数据库、执行一段代码），并将结果封装成 JSON-RPC 2.0 响应返回给 MCP Client。一个 MCP Server 可以提供多种工具、资源和提示模板，并且可以根据需要进行扩展和部署。例如，一个 MCP Server 可以封装对亚马逊云科技（AWS）服务的调用，或者提供对企业内部数据库的访问接口。</p>
</li>
</ol>
<p>这种三层架构的设计，使得 MCP 能够实现<strong>高度的解耦和灵活性</strong>。AI 主机应用无需关心外部能力的具体实现细节，只需通过标准化的 MCP 协议进行通信。MCP Client 负责协议的转换和连接管理，而 MCP Server 则专注于提供和管理具体的外部能力。这种分层设计不仅提高了系统的可维护性和可扩展性，也为不同 AI 应用程序之间共享和复用外部能力提供了可能。</p>
<h3 data-id="heading-8">2.2、核心原语：Tools, Resources 与 Prompts</h3>
<p>MCP 协议的核心在于其定义的三种基本原语，它们共同构成了 AI 智能体与外部世界交互的基石：<strong>Tools (工具)、Resources (资源) 和 Prompts</strong> <strong>(提示)</strong>。这些原语不仅定义了 AI 智能体可以“做什么”，还定义了它“可以获取什么信息”以及“如何更好地表达自己”。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/995a78f84f6b4e2fa8237dbbeaad5c99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=z1B0S%2BTfMTGj3kQiEZmND7eLl54%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>
<p><strong>Tools</strong>(工具) ：工具是 AI 智能体可以<strong>执行的外部函数或操作</strong>。它们可以是任何可编程的接口，例如调用一个 RESTful API、执行一个数据库查询、发送一封电子邮件、或者控制一个物理设备。MCP Server 负责将这些具体的外部功能封装成 AI 智能体可以理解和调用的“工具”。每个工具都通过 JSON Schema 定义其输入参数和预期输出，确保 AI 智能体能够正确地构造请求并解析响应。例如，一个天气查询工具可能需要一个 <code>location</code> 参数，并返回当前温度和天气状况。工具的存在极大地扩展了 AI 智能体的行动边界，使其能够从纯粹的语言理解和生成，跃升到与真实世界进行有意义的交互。</p>
</li>
<li>
<p><strong>Resources (资源)</strong>：资源是 AI 智能体可以<strong>访问和获取的上下文信息</strong>。它们可以是各种形式的数据源，例如文档、数据库记录、传感器数据、用户偏好设置等。MCP Server 同样负责管理和暴露这些资源，允许 AI 智能体根据任务需求动态地获取所需信息。与工具类似，资源也可以通过 JSON Schema 定义其结构和访问方式。例如，一个用户配置文件资源可能包含用户的姓名、邮箱和订阅信息。通过访问资源，AI 智能体能够获得更丰富、更准确的上下文信息，从而做出更明智的决策和生成更相关的响应。</p>
</li>
<li>
<p><strong>Prompts (提示)</strong>：提示是<strong>可重用的交互模板</strong>，用于指导 AI 智能体在特定场景下的语言生成或交互行为。它们通常包含预设的指令、示例对话或格式要求，旨在帮助 AI 智能体更好地理解任务意图，并以符合预期的方式进行响应。例如，一个用于生成会议纪要的提示可能包含会议主题、参与者列表和关键讨论点的占位符。通过标准化和复用提示，可以提高 AI 智能体在特定任务上的表现一致性和效率，减少重复的指令工程工作。</p>
</li>
</ol>
<p><strong>这三大核心原语共同构建了 MCP 强大的能力扩展机制</strong>。工具赋予 AI 智能体“手脚”，使其能够执行外部操作；资源赋予 AI 智能体“眼睛和耳朵”，使其能够感知和获取外部信息；而提示则赋予 AI 智能体“思维框架”，使其能够更好地理解和表达。通过 MCP，AI 智能体能够以一种结构化、可控的方式，充分利用这些外部能力，从而实现更高级别的智能和自主性。</p>
<h3 data-id="heading-9">2.3、传输层与连接生命周期</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b84e4bc287c944b291f3370557aa45fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=deEqgqPrE%2FPOPCHhgPlCpmt8J%2F4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>MCP 协议的灵活性不仅体现在其核心原语的定义上，更在于其对<strong>传输层</strong>（Transport Layer）的抽象和支持。为了适应不同的部署环境和性能需求，MCP 协议支持多种传输机制，其中最常见的包括 <code>stdio</code> 和 <code>HTTP/SSE</code>。</p>
<ol>
<li>
<p><strong>stdio (标准输入输出)</strong>：这是一种最简单直接的传输方式，通常用于本地进程间通信。AI 主机应用和 MCP Server 可以通过标准输入输出流进行消息交换。这种方式的优点是<strong>性能开销极低，几乎没有网络延迟</strong>，非常适合在同一台机器上运行的 AI 智能体和 MCP Server 之间的通信。然而，它的缺点是<strong>不适合远程通信</strong>，且在复杂的并发场景下管理起来可能较为繁琐。</p>
</li>
<li>
<p><strong>HTTP/SSE (HTTP/Server-Sent Events)</strong>：HTTP 是一种广泛使用的网络协议，而 Server-Sent Events (SSE) 则允许服务器向客户端推送事件。结合 HTTP，MCP 可以实现<strong>远程通信和更灵活的部署</strong>。HTTP/SSE 传输方式的优点是<strong>支持跨网络通信，易于与现有的 Web 基础设施集成</strong>，并且能够利用 HTTP 的各种特性（如认证、加密）。这使得 MCP Server 可以部署在云端，为多个 AI 主机应用提供服务。其缺点是相对于 <code>stdio</code> 会引入一定的网络延迟和协议开销。</p>
</li>
</ol>
<p>除了这两种常见的传输方式，MCP 协议还允许<strong>自定义传输机制</strong>，以满足特定场景下的特殊需求。这种开放性确保了 MCP 能够适应未来不断演进的技术栈和部署模式。</p>
<p><strong>连接生命周期</strong>（Connection Lifecycle）是 MCP 协议中另一个重要的组成部分，它定义了 AI 主机应用（通过 MCP Client）与 MCP Server 之间通信会话的整个过程。一个典型的 MCP 连接生命周期包括以下几个阶段：</p>
<ol>
<li>
<p><strong>初始化 (Initialization)</strong>：MCP Client 向 MCP Server 发送初始化请求，建立连接。这个请求通常会包含 Client 的基本信息和期望的能力。</p>
</li>
<li>
<p><strong>能力协商 (Capability Negotiation)</strong>：MCP Server 响应 Client 的初始化请求，并告知其所提供的工具、资源和提示等能力。Client 和 Server 之间可能会进行一系列的协商，以确定双方都支持的功能集。</p>
</li>
<li>
<p><strong>就绪通知 (Ready Notification)</strong>：在能力协商完成后，Server 会向 Client 发送就绪通知，表明连接已准备好接收和处理请求。</p>
</li>
<li>
<p><strong>操作 (Operation)</strong>：这是连接生命周期中的主要阶段，Client 和 Server 之间进行双向的 JSON-RPC 2.0 消息交换，包括请求、响应和通知。AI 智能体通过 Client 调用 Server 提供的工具和资源，Server 则执行操作并返回结果。</p>
</li>
<li>
<p><strong>终止 (Termination)</strong>：当通信会话结束时，Client 或 Server 可以发起终止请求，优雅地关闭连接。这有助于释放系统资源并确保数据的一致性。</p>
</li>
</ol>
<p>MCP 协议通过对传输层和连接生命周期的精心设计，确保了 AI 智能体与外部系统之间通信的<strong>可靠性、安全性和可管理性</strong>。这种协议驱动的方法，为构建高度集成和可扩展的 AI 智能体生态系统奠定了坚实的基础。</p>
<h2 data-id="heading-10">三、Skill 与 MCP 的深度对比分析</h2>
<p>Agent Skills 和 MCP 作为扩展 AI 智能体能力的两大范式，虽然目标一致，但在设计理念、实现机制和适用场景上却存在显著差异。深入理解这些差异，对于开发者选择合适的技术路径，构建高效、稳定的 AI 智能体至关重要。</p>
<h3 data-id="heading-11">3.1、哲学差异：静态封装 vs 动态交互</h3>
<p>Agent Skills 和 MCP 在其核心哲学上展现出根本性的不同。Agent Skills 倾向于<strong>静态封装与知识管理</strong>，而 MCP 则侧重于<strong>动态交互与系统集成</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f22fc0cb6164f4687fd10a1cb87ac8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=VrppYttliscPsf0Ou%2BG6oNWHUcA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>Agent Skills 的哲学</strong>可以概括为“<strong>知识即文件，能力即目录</strong>”。它将领域专业知识、操作指南和可执行代码视为一种可被文件化、可被版本控制的“知识资产”。这种设计哲学强调<strong>便携性、可读性和低门槛的扩展性</strong>。一个 Skill 被创建后，其内容相对固定，AI 智能体通过解析 <code>SKILL.md</code> 文件来理解和执行其内部逻辑。这种模式更像是为 AI 智能体提供了一本本“参考手册”或“工具箱”，智能体根据任务需求查阅并使用。因此，Agent Skills 更擅长处理那些<strong>知识密集型、流程标准化且相对稳定的任务</strong>，例如文档分析、代码审查流程或特定的数据处理工作流。它的“无状态”特性意味着每次执行都是独立的，不依赖于持久化的连接或会话状态。</p>
<p><strong>MCP 的哲学</strong>则聚焦于“<strong>协议即桥梁，服务即能力</strong>”。它将外部工具、数据源和系统视为可被 AI 智能体通过标准化协议动态调用的“服务”。这种设计哲学强调<strong>实时性、互操作性和强大的外部集成能力</strong>。MCP 更适合处理那些<strong>需要实时数据访问、复杂系统集成以及动态能力协商的任务</strong>，例如实时监控、多系统编排或需要与外部 API 频繁交互的场景。它的“有状态”特性使得连接管理和会话保持成为可能，为复杂的交互提供了基础。</p>
<p>简而言之，Agent Skills 关注的是<strong>AI 智能体“内部”如何组织和利用自身或本地的能力</strong>，而 MCP 则着眼于<strong>AI 智能体“外部”如何与广阔的数字世界进行高效、安全的连接与交互</strong>。两者并非相互替代，而是相辅相成，共同构成了 AI 智能体能力扩展的完整图景。</p>
<h3 data-id="heading-12">3.2、技术指标横向评测</h3>
<p>为了更直观地理解 Agent Skills 和 MCP 在技术层面的差异，下表从多个关键维度对两者进行了横向对比。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54877442b3424c52ab68a943287b675b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=W9ayT2AkNtFDSdtp9wsduklpF0k%3D" alt="在这里插入图片描述" loading="lazy"/></p>






































































<table><thead><tr><th align="left">维度</th><th align="left">Agent Skills</th><th align="left">MCP (Model Context Protocol)</th></tr></thead><tbody><tr><td align="left"><strong>架构范式</strong></td><td align="left">文件驱动，基于文件系统</td><td align="left">协议驱动，基于客户端-主机-服务器模型</td></tr><tr><td align="left"><strong>通信模型</strong></td><td align="left">直接文件系统访问，无协议开销</td><td align="left">JSON-RPC 2.0，双向消息交换</td></tr><tr><td align="left"><strong>状态管理</strong></td><td align="left">无状态（每次文件读取独立）</td><td align="left">有状态（管理连接生命周期）</td></tr><tr><td align="left"><strong>集成方式</strong></td><td align="left">低门槛，通过拖放文件到指定目录</td><td align="left">中等，需要 SDK 实现和配置</td></tr><tr><td align="left"><strong>安全性</strong></td><td align="left">沙箱执行，白名单机制</td><td align="left">OAuth 2.1 认证，传输层安全 (TLS)</td></tr><tr><td align="left"><strong>生态系统</strong></td><td align="left">正在成长中，Anthropic 等平台支持</td><td align="left">较为成熟，多语言 SDK，预构建服务器，调试工具</td></tr><tr><td align="left"><strong>便携性</strong></td><td align="left">极高，纯文件形式，易于分享和部署</td><td align="left">中等，需要运行服务器，部署相对复杂</td></tr><tr><td align="left"><strong>启动时间</strong></td><td align="left">极低，仅需读取元数据</td><td align="left">需连接握手，建立通信链路</td></tr><tr><td align="left"><strong>操作延迟</strong></td><td align="left">文件 I/O 操作</td><td align="left">网络通信 + 处理开销</td></tr><tr><td align="left"><strong>内存开销</strong></td><td align="left">低，按需加载（Load on demand）</td><td align="left">线性增长，取决于连接数和服务器容量</td></tr><tr><td align="left"><strong>可伸缩性</strong></td><td align="left">线性增长，取决于技能数量</td><td align="left">取决于服务器容量和架构设计</td></tr><tr><td align="left"><strong>最佳应用</strong></td><td align="left">知识打包、标准化工作流、离线环境</td><td align="left">外部系统集成、实时数据访问、企业级工作流</td></tr></tbody></table>
<p>从上表可以看出，Agent Skills 在<strong>便携性、低集成门槛和无状态操作</strong>方面表现出色，特别适合于封装相对独立的领域知识和标准化工作流，或者在资源受限、离线环境中运行。其文件驱动的特性使得技能的创建和分享变得异常简单，开发者可以像管理代码库一样管理技能，实现快速迭代和部署。</p>
<p>而 MCP 则在<strong>外部系统集成、实时数据交互和企业级应用</strong>方面具有显著优势。其协议驱动的模式提供了强大的互操作性，能够将 AI 智能体与各种复杂的外部服务（如数据库、API、遗留系统）无缝连接。MCP 的有状态连接管理和安全机制，使其成为构建高可靠、高性能 AI 智能体应用的关键基础设施。</p>
<h3 data-id="heading-13">3.3、生态位定位：互补而非竞争</h3>
<p>回看 Agent Skills 与 MCP 的差异，会发现它们并不是在同一条赛道上竞争。MCP 解决的是连接问题，它关心的是如何让 AI 智能体安全、稳定、标准化地接入外部世界；而 Agent Skills 解决的，则是一个更贴近日常工作的问题——智能体到底是以什么形式“学会”一件事的。它们并非相互竞争的关系，而是在 AI 智能体生态系统中扮演着<strong>互补的角色</strong>。将两者结合使用，可以构建出更加强大、灵活且适应性强的 AI 智能体。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bc89588197e4c63aa36fa43a56ad403~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=aWNT5VV45cyEFuRcDb3Y4oq7Q1k%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>我们可以将 Agent Skills 视为 AI 智能体的**“内部知识库”和“本地工具集”**。它定义了 <strong>AI 智能体“应该知道什么”以及“如何处理问题”</strong>。例如，一个 Agent Skills 可以封装一套完整的法律文档审查流程，包括如何识别关键条款、如何提取特定信息、以及如何生成合规性报告。这些知识和流程是智能体自身能力的体现，可以在没有外部网络连接的情况下独立运行，或者作为更复杂任务的基础。</p>
<p>而 MCP 则可以看作是 AI 智能体与“<strong>外部世界”进行交互的“通用接口</strong>”。它定义了 AI 智能体“可以与哪些外部系统交互”以及“如何进行高效、安全的交互”。例如，<strong>当 AI 智能体需要查询最新的市场数据、调用第三方支付接口、或者与企业内部的 CRM 系统同步信息时</strong>，MCP 就能提供标准化的通信机制。它使得 AI 智能体能够突破自身的边界，利用外部服务的强大能力。</p>
<p>因此，在构建复杂的 AI 智能体系统时，最佳实践往往是<strong>采用混合方法</strong>：</p>
<ul>
<li><strong>利用 Agent Skills 封装领域专业知识和标准化工作流</strong>：这包括那些相对稳定、可复用、且对外部依赖较少的能力。例如，特定的数据清洗逻辑、报告生成模板、或内部决策流程。</li>
<li><strong>利用 MCP 实现与外部系统和服务的集成</strong>：这包括那些需要实时数据、动态交互、或者涉及复杂认证和授权的外部能力。例如，访问云数据库、调用第三方 API、或者与企业级应用进行数据同步。</li>
</ul>
<p>通过这种方式，AI 智能体可以拥有一个强大且便携的“大脑”（由 Agent Skills 提供），同时也能拥有灵活且高效的“手脚”（由 MCP 提供），从而在各种复杂的应用场景中发挥出最大的潜力。这种协同作用，使得 AI 智能体不仅能够“思考”，更能够“行动”，并与真实世界的数字基础设施无缝融合。</p>
<p><strong>【今日推荐】</strong>：一个<strong>更简单 更智能的全能网站搭建平台</strong>，低代码开发工具RollCode。轻松提升效率、释放开发潜力，快速验证您的每个创意，点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rollcode.cn%2F%3Fsource%3Dba%26id%3Dkele" target="_blank" title="https://www.rollcode.cn/?source=ba&amp;id=kele" ref="nofollow noopener noreferrer">官网链接</a>直达体验：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31da84be1b0f4d80892fed24b7488968~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692551&amp;x-signature=zdzQpCPAxsQFnMPNL2vxk8GmZG8%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Dart ——??运算符]]></title>    <link>https://juejin.cn/post/7602259669730246683</link>    <guid>https://juejin.cn/post/7602259669730246683</guid>    <pubDate>2026-02-03T03:31:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602259669730246683" data-draft-id="7602166907571912742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Dart ——??运算符"/> <meta itemprop="keywords" content="Flutter,Dart"/> <meta itemprop="datePublished" content="2026-02-03T03:31:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Haha_bj"/> <meta itemprop="url" content="https://juejin.cn/user/2612027844214647"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Dart ——??运算符
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612027844214647/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Haha_bj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:31:14.000Z" title="Tue Feb 03 2026 03:31:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你想了解 Dart 中的 <code>??</code> 运算符，它是 Dart 里处理 ** 可选值（可空类型）** 的常用运算符，核心作用是「空值合并」，我们从基础用法、核心特点、拓展用法到实际场景，一步步讲清楚，让你快速掌握。</p>
<h3 data-id="heading-0">一、先明确 <code>??</code> 运算符的核心定义</h3>
<p><code>??</code> 被称为 <strong>「空值合并运算符（Null Coalescing Operator）」</strong>，作用是：判断运算符<strong>左侧的表达式是否为 <code>null</code></strong>：</p>
<ul>
<li>如果<strong>左侧不为 <code>null</code></strong>，直接返回<strong>左侧的值</strong>；</li>
<li>如果<strong>左侧为 <code>null</code></strong>，返回<strong>右侧的备选值</strong>。</li>
</ul>
<p>简单理解：「选左边的，左边是空的就选右边的」，用于给可空变量设置默认值，避免空值引发错误。</p>
<h3 data-id="heading-1">二、基础用法（最常用场景）</h3>
<h4 data-id="heading-2">1. 基本语法格式</h4>
<pre><code class="hljs language-Dart" lang="Dart"><span class="hljs-comment">// 语法：左侧表达式 ?? 右侧备选值</span>
variable ?? defaultValue
</code></pre>
<h4 data-id="heading-3">2. 示例（基础场景）</h4>
<pre><code class="hljs language-Dart" lang="Dart"><span class="hljs-keyword">void</span> main() {
  <span class="hljs-comment">// 场景 1：左侧不为 null，返回左侧值</span>
  <span class="hljs-built_in">String?</span> name1 = <span class="hljs-string">"张三"</span>;
  <span class="hljs-built_in">String</span> result1 = name1 ?? <span class="hljs-string">"未知用户"</span>;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"result1: <span class="hljs-subst">$result1</span>"</span>); <span class="hljs-comment">// 输出：result1: 张三</span>

  <span class="hljs-comment">// 场景 2：左侧为 null，返回右侧默认值</span>
  <span class="hljs-built_in">String?</span> name2 = <span class="hljs-keyword">null</span>;
  <span class="hljs-built_in">String</span> result2 = name2 ?? <span class="hljs-string">"未知用户"</span>;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"result2: <span class="hljs-subst">$result2</span>"</span>); <span class="hljs-comment">// 输出：result2: 未知用户</span>

  <span class="hljs-comment">// 场景 3：结合数值类型使用</span>
  <span class="hljs-built_in">int?</span> age1 = <span class="hljs-number">20</span>;
  <span class="hljs-built_in">int</span> ageResult1 = age1 ?? <span class="hljs-number">18</span>;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"ageResult1: <span class="hljs-subst">$ageResult1</span>"</span>); <span class="hljs-comment">// 输出：ageResult1: 20</span>

  <span class="hljs-built_in">int?</span> age2 = <span class="hljs-keyword">null</span>;
  <span class="hljs-built_in">int</span> ageResult2 = age2 ?? <span class="hljs-number">18</span>;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"ageResult2: <span class="hljs-subst">$ageResult2</span>"</span>); <span class="hljs-comment">// 输出：ageResult2: 18</span>
}
</code></pre>
<h4 data-id="heading-4">3. 关键注意点</h4>
<ul>
<li>
<p><code>??</code> 只判断「左侧是否为 <code>null</code>」，<strong>不判断空字符串、0 等「空值但非 null」的情况</strong>：</p>
<pre><code class="hljs language-Dart" lang="Dart"><span class="hljs-keyword">void</span> main() {
  <span class="hljs-comment">// 左侧是空字符串（不是 null），返回左侧空字符串，而非右侧默认值</span>
  <span class="hljs-built_in">String?</span> emptyStr = <span class="hljs-string">""</span>;
  <span class="hljs-built_in">String</span> result = emptyStr ?? <span class="hljs-string">"默认字符串"</span>;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"result: '<span class="hljs-subst">$result</span>'"</span>); <span class="hljs-comment">// 输出：result: ''</span>
}
</code></pre>
</li>
<li>
<p>右侧的备选值<strong>只有在左侧为 <code>null</code> 时才会被执行</strong>（惰性求值），提升性能：</p>
<pre><code class="hljs language-Dart" lang="Dart"><span class="hljs-keyword">void</span> main() {
  <span class="hljs-built_in">String?</span> name = <span class="hljs-string">"李四"</span>;
  <span class="hljs-comment">// 因为左侧不为 null，右侧的 print 不会执行，也不会调用 getDefaultName()</span>
  <span class="hljs-built_in">String</span> result = name ?? (<span class="hljs-built_in">print</span>(<span class="hljs-string">"右侧执行了"</span>) + getDefaultName());
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"result: <span class="hljs-subst">$result</span>"</span>);
}

<span class="hljs-built_in">String</span> getDefaultName() =&gt; <span class="hljs-string">"未知用户"</span>;
</code></pre>
<p>运行结果：仅输出 <code>result: 李四</code>，右侧的打印和函数调用都未执行。</p>
</li>
</ul>
<h3 data-id="heading-5">三、拓展用法：和其他运算符结合</h3>
<h4 data-id="heading-6">1. <code>??=</code>：空值赋值运算符（给变量本身设置默认值）</h4>
<p><code>??=</code> 是 <code>??</code> 的衍生运算符，作用是：<strong>如果变量本身为 <code>null</code>，就给它赋值右侧的值；如果变量不为 <code>null</code>，则不做任何修改</strong>（相当于「给变量设置默认值，仅在变量为空时生效」）。</p>
<pre><code class="hljs language-Dart" lang="Dart"><span class="hljs-keyword">void</span> main() {
  <span class="hljs-comment">// 场景 1：变量为 null，赋值右侧值</span>
  <span class="hljs-built_in">String?</span> name1 = <span class="hljs-keyword">null</span>;
  name1 ??= <span class="hljs-string">"王五"</span>;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"name1: <span class="hljs-subst">$name1</span>"</span>); <span class="hljs-comment">// 输出：name1: 王五</span>

  <span class="hljs-comment">// 场景 2：变量不为 null，不修改</span>
  <span class="hljs-built_in">String?</span> name2 = <span class="hljs-string">"赵六"</span>;
  name2 ??= <span class="hljs-string">"未知用户"</span>;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"name2: <span class="hljs-subst">$name2</span>"</span>); <span class="hljs-comment">// 输出：name2: 赵六</span>
}
</code></pre>
<p><strong>对比 <code>??</code> 和 <code>??=</code></strong>：</p>
<ul>
<li><code>name ?? "未知"</code>：返回一个值，<strong>不修改 <code>name</code> 本身</strong>；</li>
<li><code>name ??= "未知"</code>：直接<strong>修改 <code>name</code> 本身</strong>（仅当 <code>name</code> 为 <code>null</code> 时）。</li>
</ul>
<h4 data-id="heading-7">2. <code>?.</code> + <code>??</code>：安全访问 + 空值兜底（高频组合）</h4>
<p><code>?.</code> 是「安全访问运算符」，作用是：如果对象不为 <code>null</code>，就访问对象的属性 / 方法；如果对象为 <code>null</code>，则返回 <code>null</code>（避免空指针异常）。</p>
<p>两者结合，可实现「安全访问属性，若对象为空或属性为空，就返回默认值」，是业务开发中的高频组合。</p>
<pre><code class="hljs language-Dart" lang="Dart"><span class="hljs-comment">// 定义一个用户类</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{
  <span class="hljs-built_in">String?</span> name;
  User(<span class="hljs-keyword">this</span>.name);
}

<span class="hljs-keyword">void</span> main() {
  <span class="hljs-comment">// 场景 1：对象不为 null，属性也不为 null</span>
  User? user1 = User(<span class="hljs-string">"钱七"</span>);
  <span class="hljs-built_in">String</span> result1 = user1?.name ?? <span class="hljs-string">"未知用户"</span>;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"result1: <span class="hljs-subst">$result1</span>"</span>); <span class="hljs-comment">// 输出：result1: 钱七</span>

  <span class="hljs-comment">// 场景 2：对象不为 null，但属性为 null</span>
  User? user2 = User(<span class="hljs-keyword">null</span>);
  <span class="hljs-built_in">String</span> result2 = user2?.name ?? <span class="hljs-string">"未知用户"</span>;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"result2: <span class="hljs-subst">$result2</span>"</span>); <span class="hljs-comment">// 输出：result2: 未知用户</span>

  <span class="hljs-comment">// 场景 3：对象本身为 null</span>
  User? user3 = <span class="hljs-keyword">null</span>;
  <span class="hljs-built_in">String</span> result3 = user3?.name ?? <span class="hljs-string">"未知用户"</span>;
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"result3: <span class="hljs-subst">$result3</span>"</span>); <span class="hljs-comment">// 输出：result3: 未知用户</span>
}
</code></pre>
<h3 data-id="heading-8">四、实际业务场景示例</h3>
<h4 data-id="heading-9">1. 接口返回数据兜底（避免空值展示）</h4>
<pre><code class="hljs language-Dart" lang="Dart"><span class="hljs-comment">// 模拟接口返回的用户数据（可能为 null）</span>
<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? apiResponse = {
  <span class="hljs-string">"username"</span>: <span class="hljs-string">"小明"</span>,
  <span class="hljs-string">"age"</span>: <span class="hljs-keyword">null</span>,
  <span class="hljs-string">"address"</span>: <span class="hljs-string">""</span>
};

<span class="hljs-keyword">void</span> main() {
  <span class="hljs-comment">// 提取用户名，为空则显示「游客」</span>
  <span class="hljs-built_in">String</span> username = apiResponse?[<span class="hljs-string">"username"</span>] ?? <span class="hljs-string">"游客"</span>;
  <span class="hljs-comment">// 提取年龄，为空则默认 18</span>
  <span class="hljs-built_in">int</span> age = apiResponse?[<span class="hljs-string">"age"</span>] ?? <span class="hljs-number">18</span>;
  <span class="hljs-comment">// 提取地址，为空字符串（非 null）则显示「未填写地址」（需额外判断）</span>
  <span class="hljs-built_in">String</span> address = apiResponse?[<span class="hljs-string">"address"</span>] ?? <span class="hljs-string">"未填写地址"</span>;
  address = address.isEmpty ? <span class="hljs-string">"未填写地址"</span> : address;

  <span class="hljs-built_in">print</span>(<span class="hljs-string">"用户名：<span class="hljs-subst">$username</span>，年龄：<span class="hljs-subst">$age</span>，地址：<span class="hljs-subst">$address</span>"</span>);
  <span class="hljs-comment">// 输出：用户名：小明，年龄：18，地址：未填写地址</span>
}
</code></pre>
<h4 data-id="heading-10">2. 初始化可空变量的默认值</h4>
<pre><code class="hljs language-Dart" lang="Dart"><span class="hljs-comment">// 定义可空的配置变量</span>
<span class="hljs-built_in">String?</span> appTitle;
<span class="hljs-built_in">int?</span> appVersionCode;

<span class="hljs-keyword">void</span> initAppConfig() {
  <span class="hljs-comment">// 给配置设置默认值（仅当变量为 null 时生效）</span>
  appTitle ??= <span class="hljs-string">"我的Dart应用"</span>;
  appVersionCode ??= <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">void</span> main() {
  initAppConfig();
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"应用标题：<span class="hljs-subst">$appTitle</span>，版本号：<span class="hljs-subst">$appVersionCode</span>"</span>);
  <span class="hljs-comment">// 输出：应用标题：我的Dart应用，版本号：1</span>
}
</code></pre>
<h3 data-id="heading-11">总结</h3>
<ol>
<li><code>??</code> 是<strong>空值合并运算符</strong>，核心逻辑：「左侧非空返左侧，左侧为空返右侧」，用于给可空变量兜底。</li>
<li>关键特性：只判断 <code>null</code>、右侧惰性求值、不修改原变量。</li>
<li>常用拓展：<code>??=</code> 用于给变量本身设置默认值（仅为空时生效）；<code>?. + ??</code> 用于安全访问对象属性并兜底。</li>
<li>实际场景：接口数据兜底、变量默认值初始化、避免空指针异常，是 Dart 开发中的必备语法。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从模型到落地：AI 认知架构全景与编排实战（含 RAG、Dify/LangChain、沙箱与提示词）]]></title>    <link>https://juejin.cn/post/7602154171109261375</link>    <guid>https://juejin.cn/post/7602154171109261375</guid>    <pubDate>2026-02-03T03:30:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602154171109261375" data-draft-id="7602176198874431531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从模型到落地：AI 认知架构全景与编排实战（含 RAG、Dify/LangChain、沙箱与提示词）"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-03T03:30:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Manshawar"/> <meta itemprop="url" content="https://juejin.cn/user/1832206145692247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从模型到落地：AI 认知架构全景与编排实战（含 RAG、Dify/LangChain、沙箱与提示词）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1832206145692247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Manshawar
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:30:17.000Z" title="Tue Feb 03 2026 03:30:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读45分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">agent的全景认知和一个node沙盒小工具</h2>
<hr/>
<h3 data-id="heading-1">一、AI 认知模型全景视图</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│  应用层 (Application)                                        │
│  Manus · ClawBot  · 垂直领域 Agent              │
├─────────────────────────────────────────────────────────────┤
│  编排层 (Orchestration)                                      │
│  <span class="hljs-built_in">Dify</span>(低代码) · <span class="hljs-built_in">LangChain</span>(编程框架) · <span class="hljs-built_in">LangGraph</span>(状态机)        │
├─────────────────────────────────────────────────────────────┤
│  记忆层 (Memory)                                             │
│  Vector DB · RAG · 上下文压缩 · 长期记忆机制 · Milvus          │
├─────────────────────────────────────────────────────────────┤
│  模型层 (Foundation Model)                                   │
│  GPT-<span class="hljs-number">4</span>o · Claude · DeepSeek · 多模态大模型                    │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p>未来的 AI 应用不是「大模型单打独斗」，而是「记忆 + 规划 + 工具」的<strong>认知架构</strong>竞争。</p>
<p>我们该在未来的 AI 时代中何去何从？我认为是借助 AI 的能力，去实现类似于 ClawBot 这种 AI 应用，解决<strong>模型到落地的最后一公里</strong>问题。</p>
<hr/>
<h3 data-id="heading-2">二、认识模型：从 DeepSeek 的开放平台开始</h3>
<p>这里会给大家介绍两个平台：</p>
<ol>
<li><strong>DeepSeek 开放平台</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi-docs.deepseek.com%2Fzh-cn%2F" target="_blank" title="https://api-docs.deepseek.com/zh-cn/" ref="nofollow noopener noreferrer">api-docs.deepseek.com/zh-cn/</a>参数较少，适合初步认知。</li>
<li><strong>阿里云百炼</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbailian.console.aliyun.com%2Fcn-beijing%2F%3Fspm%3D5176.29597918.J_SEsSjsNv72yRuRFS2VknO.2.739e7b08QDsLcK%26tab%3Ddoc%23%2Fdoc%2F%3Ftype%3Dmodel%26url%3D2579562" target="_blank" title="https://bailian.console.aliyun.com/cn-beijing/?spm=5176.29597918.J_SEsSjsNv72yRuRFS2VknO.2.739e7b08QDsLcK&amp;tab=doc#/doc/?type=model&amp;url=2579562" ref="nofollow noopener noreferrer">阿里云百炼控制台</a>
类似 OpenAI，模型丰富、支持自定义调试，文档详细，适合高自定义、多 Agent 协作等场景。</li>
</ol>
<p>一般会有 <strong>Base API</strong>（用于访问模型），需要填入生成的 <strong>API Key</strong>（密钥）。根据所用框架或编排工具，选择对应的模型名，如 DeepSeek 的 <strong>Chat 模型</strong>与 <strong>Reasoner 模型</strong>，各有侧重点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6d4d78619324e8191cd6dfb3f8b289c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFuc2hhd2Fy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770694444&amp;x-signature=suwlXowxtcKNGyakkpJZ5YXvG5k%3D" alt="1770002384080.png" loading="lazy"/></p>
<p>除此之外，一般还会有**温度（Temperature）**设置，可以理解为模型的「<strong>创意开关</strong>」或「<strong>发散程度调节器</strong>」，核心是概率分布的尖锐度。</p>
<blockquote>
<p><strong>温度越低，模型越像「严谨的老师」；温度越高，模型越像「喝醉的诗人」。</strong></p>
</blockquote>



































<table><thead><tr><th>温度值</th><th>特征</th><th>典型应用</th><th>输出特点</th></tr></thead><tbody><tr><td><strong>0 - 0.3</strong></td><td>确定性/保守</td><td>代码生成、数学计算、知识问答、JSON</td><td>事实准确、逻辑严谨，可能机械、缺乏变化</td></tr><tr><td><strong>0.4 - 0.7</strong></td><td>平衡</td><td>通用对话、写作辅助、商业文案</td><td>正确性与自然流畅度兼顾</td></tr><tr><td><strong>0.8 - 1.2</strong></td><td>创造性</td><td>创意写作、头脑风暴、诗歌、角色扮演</td><td>词汇丰富、想象力强，可能跑题</td></tr><tr><td><strong>&gt; 1.5</strong></td><td>混乱/发散</td><td>艺术实验、随机灵感、对抗性测试</td><td>可能荒诞、跳跃、非逻辑</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-3">三、现代模型进化的四大共同趋势</h3>
<ol>
<li><strong>Agentic 能力（自主代理）<strong>所有模型都在强化</strong>工具调用链、多步骤规划、环境交互</strong>能力。Gartner 将 Agentic AI 列为 2025 年顶级战略技术趋势，预计年增长率 40%（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.webpronews.com%2Fagentic-ai-tops-gartners-2025-trends-autonomous-revolution%2F" target="_blank" title="https://www.webpronews.com/agentic-ai-tops-gartners-2025-trends-autonomous-revolution/" ref="nofollow noopener noreferrer">来源</a>）。</li>
<li><strong>推理架构的显性化</strong>不再隐藏思考过程，而是提供「思考模式」（Thinking/Deep Think）开关，让用户在速度与深度间权衡，代表从<strong>模式匹配到结构化推理</strong>的范式转移。</li>
<li><strong>上下文窗口的军备竞赛</strong>从 256K（Kimi）到 400K（GPT-5）再到 1M（Claude），目标都是实现**「整本书/整个代码库」的一次性处理**，降低对 RAG 精度的依赖。</li>
<li><strong>垂直专业化与成本分层</strong>
同一模型家族内部分化出标准版（推理）、Mini 版（成本）、Nano 版（延迟），通过<strong>自动路由</strong>为用户匹配最优性价比。</li>
</ol>
<p>以上是结合当前模型更新汇总的结论：主流模型主要在<strong>工具调用、推理架构、上下文、成本</strong>四个方向优化。</p>
<p>下文将围绕 <strong>AI 工具调用</strong>展开：为什么各大模型厂商都重视它，以及它由哪些解决方案组成。</p>
<p>对于生产级模型落地（而非简单 API 调用），<strong>记忆层和编排层是概念上必须经过的两大关卡</strong>。即使没有显式使用 Milvus 或 LangChain，系统也必然要实现这两层的等效功能（哪怕用代码硬编码）。这两者都是编码层面具有代表性的工具，我们可以不直接用，但需要理解其思想。</p>
<hr/>
<h3 data-id="heading-4">四、记忆层：解决「模型天生健忘」的硬伤</h3>
<p>基础大模型是**无状态（Stateless）**的——每次 API 请求独立，不会记得 5 分钟前的对话，更无法记住上周的业务数据。</p>
<p><strong>落地时必须处理的问题：</strong></p>
<ul>
<li><strong>上下文稀缺</strong>：即便 GPT-5 支持 400K tokens，全量塞进上下文既贵又慢，且无法跨会话保持。</li>
<li><strong>知识过时</strong>：模型训练数据有截止日期，需要 RAG 接入实时知识库。</li>
<li><strong>个性化缺失</strong>：没有记忆层，每次对话从零开始，无法「越用越懂你」。</li>
</ul>
<p>大量上下文会带来：一、干扰多，结论不精确；二、token 消耗大、分析时间更长；三、难以对企业内部资源做有效整合。</p>
<p><strong>落地形态对比：</strong></p>





















<table><thead><tr><th>简单玩具</th><th>生产级落地</th></tr></thead><tbody><tr><td>直接塞历史消息到 <code>messages</code> 参数</td><td><strong>向量数据库</strong>（Milvus/Pinecone）存储海量文档</td></tr><tr><td>用全局变量存临时状态</td><td><strong>长期记忆机制</strong>（如 MemGPT）管理记忆优先级</td></tr><tr><td>不管 token 消耗</td><td><strong>上下文压缩</strong>（RAG 重排序、摘要机制）控制成本</td></tr></tbody></table>
<p><strong>本质</strong>：记忆层是让模型从「考试机器」变成「业务专家」的基础设施。没有它，模型只能回答通用问题，无法处理企业私有知识或保持连续性。我们下面主要来讲rag模式 还有history管理方案 这个则是在各个编排工具内各有内置的方案 我们在此不做深入研究</p>
<hr/>
<h4 data-id="heading-5">4.1 什么是 RAG（Retrieval Augmented Generation）</h4>
<p>RAG（检索增强生成）结合了信息检索与文本生成，在大模型生成答案时利用外部知识库中的相关信息。效果由三个核心阶段决定：</p>
<blockquote>
<p>引用：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fmodel-studio%2Frag-optimization%3Fspm%3Da2c4g.11186623.help-menu-2400256.d_1_6_1.68277b8aB06TuT%26scm%3D20140722.H_2859102._.OR_help-T_cn~zh-V_1" target="_blank" title="https://help.aliyun.com/zh/model-studio/rag-optimization?spm=a2c4g.11186623.help-menu-2400256.d_1_6_1.68277b8aB06TuT&amp;scm=20140722.H_2859102._.OR_help-T_cn~zh-V_1" ref="nofollow noopener noreferrer">阿里云 RAG 检索说明</a></p>
</blockquote>
<ol>
<li><strong>建立索引</strong>：知识的解析、切片与向量化。</li>
<li><strong>检索召回</strong>：根据用户查询（Prompt），从向量存储中匹配并召回相关知识片段。</li>
<li><strong>生成答案</strong>：大模型根据召回片段与用户查询，生成最终答案。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/417ef9a912a8412d839ef0a5332b8bcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFuc2hhd2Fy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770694444&amp;x-signature=CzdP59dmYhCsjzbxQ5%2FhqTxM%2BLo%3D" alt="1770003943187.png" loading="lazy"/></p>
<p>在 LangChain 官网，RAG 架构分为三种模式，层层递进。</p>
<hr/>
<h4 data-id="heading-6">4.2 RAG 流程一：建立索引（Indexing）</h4>
<ol>
<li>**Loader（加载）**通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fjavascript%2Flangchain%2Fretrieval%23document_loaders" target="_blank" title="https://docs.langchain.com/oss/javascript/langchain/retrieval#document_loaders" ref="nofollow noopener noreferrer">文档加载器</a>加载文档，主要完成读取文件。</li>
<li><strong>Split（拆分）</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fjavascript%2Flangchain%2Fretrieval%23text_splitters" target="_blank" title="https://docs.langchain.com/oss/javascript/langchain/retrieval#text_splitters" ref="nofollow noopener noreferrer">文本拆分器</a>将大型 <code>Document</code> 拆成更小的块，便于索引和放入模型有限的上下文窗口。若文档超过约 42000 字符，对多数模型过长；即使能塞进上下文，极长输入下也难定位关键信息，因此需要先切块再嵌入与存储。</li>
<li><strong>存储</strong>
通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fjavascript%2Flangchain%2Fretrieval%23vectorstores" target="_blank" title="https://docs.langchain.com/oss/javascript/langchain/retrieval#vectorstores" ref="nofollow noopener noreferrer">向量存储</a>与<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fjavascript%2Flangchain%2Fretrieval%23embedding_models" target="_blank" title="https://docs.langchain.com/oss/javascript/langchain/retrieval#embedding_models" ref="nofollow noopener noreferrer">嵌入模型</a>将切分后的内容向量化并存入（如 Milvus），便于检索。</li>
</ol>
<p><strong>文本如何变成向量？</strong>
通过 <strong>Embeddings 模型</strong>将文本转为向量，再写入 Milvus 等向量数据库，供 AI 检索。</p>
<p>示例：</p>
<pre><code class="hljs language-text" lang="text">Dimension of embeddings: 1536
Input: 风急天高猿啸哀, embedding is: [-0.0016666285653348784, 0.008690492014557004, ...]
Input: 渚清沙白鸟飞回, embedding is: [0.018255604113922633, 0.030631669725945727, ...]
Input: 无边落木萧萧下, embedding is: [-0.01270165436681136, 0.011355212676752505, ...]
Input: 不尽长江滚滚来, embedding is: [0.003449439128962428, 0.02667092110022496, ...]
</code></pre>
<hr/>
<h4 data-id="heading-7">4.3 RAG 流程二：检索与生成 —— Agent 调用向量数据库</h4>
<h5 data-id="heading-8">检索的本质：语义匹配</h5>
<p>当用户问：「<strong>公司的年假怎么休？</strong>」</p>
<ul>
<li><strong>传统搜索</strong>：在数据库里找包含「年假」关键词的文档（可能漏掉「带薪休假」「年休假」等同义表达）。</li>
<li><strong>向量检索</strong>：
<ul>
<li>把问题转成向量（Embedding），如 <code>[0.023, -0.151, 0.892, ...]</code>（768 维或 1536 维）。</li>
<li>在 Milvus 中计算<strong>余弦相似度</strong>，找到向量距离最近的文本块。</li>
<li>返回 Top 5 最相关段落（即使没出现「年假」二字，语义相关也能找到）。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-9">把检索封装成「工具」（Tool）</h5>
<p>Agent 默认没有查库能力，需要把检索包装成**工具（Tool）**才能调用。在提示词中说明：当问题属于某类时，使用向量数据库做相似度搜索，返回相关片段；Agent 整合搜索结果后，由大模型生成答案。向量库也可在此阶段加筛选条件，在百万级数据场景下很有用。</p>
<p>完成上述两步，即得到一个基础的 RAG 检索流程，在 LangChain 官网称为 <strong>2-Step RAG（两步检索增强生成）</strong>。</p>
<p>此外还有两种进阶方式：</p>
<ol>
<li>
<p>**Agentic RAG（智能体检索增强生成）**由大模型判断是否需要文档/数据库查询、网络 API 等外部调用，再决定调用哪些工具。</p>
</li>
<li>
<p><strong>Hybrid RAG（混合检索增强生成）<strong>在标准模式基础上加入</strong>多重校验</strong>：</p>
<ul>
<li>对问题做评估（可调用 Agent/工具），若判断问题不合理则改写后重查；</li>
<li>对检索结果用 Agent 评估，不合标准则重新检索；</li>
<li>由 AI 自行判断错误并从对应节点重新开始。</li>
</ul>
</li>
</ol>
<hr/>
<h4 data-id="heading-10">4.4 三种 RAG 模式概览</h4>
<h5 data-id="heading-11">方案 A：标准模式（2-Step RAG）</h5>
<p><strong>「先查资料，再回答」——简单直接。</strong></p>
<p><strong>工作流程：</strong></p>
<ol>
<li>用户提问：「今年的差旅报销标准是什么？」</li>
<li>系统<strong>自动</strong>在知识库找到《财务制度》第 3 章相关内容。</li>
<li>AI 基于该内容生成回答，并标注来源。</li>
</ol>
<p><strong>核心价值：</strong></p>
<ul>
<li><strong>快</strong>：固定流程，一次检索 + 一次生成，响应在 2 秒内。</li>
<li><strong>省成本</strong>：步骤简单，调用 AI 次数少。</li>
<li><strong>稳</strong>：结果可预测，不会「乱翻书」。</li>
</ul>
<hr/>
<h5 data-id="heading-12">方案 B：智能模式（Agentic RAG）</h5>
<p><strong>「让 AI 自己决定要不要查资料」。</strong></p>
<p><strong>工作流程：</strong></p>
<ol>
<li>用户复杂提问：「对比我们公司和竞争对手在华东区的定价策略差异，并给出建议。」</li>
<li>AI <strong>自主分析</strong>：「需要分三步：先查内部定价表（工具1），再查竞品公开信息（工具2），最后做对比分析。」</li>
<li>AI 按需调用多个工具，层层推进，最终生成报告。</li>
</ol>
<p><strong>核心价值：</strong></p>
<ul>
<li><strong>灵活</strong>：复杂问题能「见招拆招」。</li>
<li><strong>多工具协作</strong>：可查文档、计算器、数据库、实时网页等。</li>
<li><strong>类人思维</strong>：先收集信息再下结论。</li>
</ul>
<hr/>
<h5 data-id="heading-13">方案 C：质控模式（Hybrid RAG）</h5>
<p><strong>「查完还要验，错了就重来」——带质检的严谨方案。</strong></p>
<p><strong>工作流程：<strong>在标准模式基础上加入</strong>三重校验</strong>：</p>
<ol>
<li><strong>问题优化</strong>：用户问得模糊？先改写成更精准的问题（如把「那个谁」改为「张三」）。</li>
<li><strong>检索验证</strong>：查到内容是否相关？若不相关，自动换关键词重查。</li>
<li><strong>答案核查</strong>：生成回答是否符合事实？若有矛盾，重新生成或标注「存疑」。</li>
</ol>
<p><strong>核心价值：</strong></p>
<ul>
<li><strong>风险可控</strong>：每步有校验，减少用错误信息作答。</li>
<li><strong>自我修正</strong>：发现答非所问或信息不足时，可自主优化流程。</li>
<li><strong>审计友好</strong>：全程可追溯，知道参考了哪些资料、为何这样答。</li>
</ul>
<h3 data-id="heading-14">五、编排层</h3>
<p>模型和记忆都有了，还要有人决定：什么时候调模型、什么时候查库、什么时候调工具、顺序怎么排——这一层就是编排层。好比上文的rag的生成 什么时候去查询向量数据库 如何对问题进行分析 如何评估搜寻的结果是否满意 我们需要借助编排工具去实现 ，当然 在下一层的manus 或者 clawbot （openclaw），他们并没有使用这里编排工具的一种，而是自己搭建的编排工具</p>
<h4 data-id="heading-15">5.1 主流编排工具对比（GitHub Stars 与优缺点）</h4>
<p>以下为当前较主流的四类编排工具，兼顾<strong>可视化/低代码</strong>与<strong>编码/框架</strong>两种路线，便于按团队习惯选型。</p>








































<table><thead><tr><th>工具</th><th>类型</th><th>GitHub Stars</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify" target="_blank" title="https://github.com/langgenius/dify" ref="nofollow noopener noreferrer">Dify</a></strong></td><td>可视化 / 低代码平台</td><td><strong>128k</strong></td><td>工作流 + RAG + Agent 一体；可视化画布、Prompt IDE；50+ 内置工具；Docker 一键部署、多模型支持；LLMOps 与观测完善</td><td>自托管需自行维护；企业级能力依赖商业版；偏「平台」思维，深度定制要理解其抽象</td></tr><tr><td><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Flangchain" target="_blank" title="https://github.com/langchain-ai/langchain" ref="nofollow noopener noreferrer">LangChain</a></strong></td><td>编程框架（Python/JS）</td><td><strong>126k</strong></td><td>生态最大、文档与社区成熟；可编程、灵活度高；与 LangGraph、LangSmith 等配套；模型/向量库/工具集成丰富</td><td>学习曲线陡；版本迭代快、API 易变；偏开发者，无开箱即用的可视化编排</td></tr><tr><td><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fautogen" target="_blank" title="https://github.com/microsoft/autogen" ref="nofollow noopener noreferrer">AutoGen</a></strong></td><td>多智能体编程框架</td><td><strong>54.2k</strong></td><td>多智能体对话与协作原生支持；微软背书；支持 MCP、AgentTool 等；提供 AutoGen Studio 可做低代码原型</td><td>官方建议新人关注 Microsoft Agent Framework；维护重心可能向新框架倾斜；纯代码编排需一定 Python 能力</td></tr><tr><td><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcoze-dev%2Fcoze-studio" target="_blank" title="https://github.com/coze-dev/coze-studio" ref="nofollow noopener noreferrer">Coze Studio</a></strong></td><td>可视化 Agent 开发平台</td><td><strong>19.7k</strong></td><td>脱胎于字节 Coze，一站式可视化；插件、知识库、工作流、API/SDK 齐全；Go 后端 + React/TS 前端，DDD 架构，便于二次开发</td><td>相对较新，生态小于 Dify/LangChain；需自建并配置模型；公有云能力与商业版有差异</td></tr></tbody></table>
<p><strong>选型参考</strong>：要<strong>快速搭 Demo、少写代码</strong>优先看 Dify 或 Coze Studio；要<strong>全代码控制、对接自有系统</strong>优先 LangChain / LangGraph；要做<strong>多 Agent 协作、研究向</strong>可看 AutoGen 或 LangGraph。</p>
<hr/>
<h4 data-id="heading-16">5.2 重点了解：Dify 与 LangChain</h4>
<p>下文主要围绕 <strong>Dify</strong> 和 <strong>LangChain</strong> 两种编排方式展开，并举例说明各自适用场景。得益于 <strong>MCP</strong> 等协议的发展，两者并非互斥，而是形成很好的<strong>互补关系</strong>：</p>
<ul>
<li><strong>简单到中等复杂度的 AI 应用</strong>：适合用 <strong>Dify</strong>（可视化、少写代码、快速上线）。</li>
<li><strong>高度复杂、强定制的应用</strong>：适合用 <strong>LangChain</strong>（全代码控制、深度集成业务、自定义链与 Agent）。</li>
</ul>
<p>编排工具会不断更新、被更好的替代，但<strong>编排逻辑</strong>和<strong>AI 相关概念</strong>（记忆、分类、流式、并行、Agent 汇总等）是通用的——这些思想可以套用在 Dify 上，也值得长期学习。</p>
<hr/>
<h4 data-id="heading-17">5.3 Dify 简介：能帮我们做什么？</h4>
<p>Dify 是<strong>低代码/可视化</strong>编排工具。借用官网描述：</p>
<blockquote>
<p><strong>Dify</strong> 是一个用于构建 AI 工作流的开源平台。通过在可视化画布上编排 AI 模型、连接数据源、定义处理流程，直接将你的领域知识转化为可运行的软件。</p>
</blockquote>
<p><strong>能力概览</strong>：支持<strong>本地化部署</strong>；可使用<strong>插件能力</strong>对接外部 API/数据库；通过<strong>模板节点</strong>输出结构化数据（如 JSON），便于前端或下游系统处理。了解这些，就能快速搭建以下几类场景。</p>
<hr/>
<h4 data-id="heading-18">5.4 Dify 场景示例</h4>
<ol>
<li><strong>表单预填</strong>用户进入表单页时，调用<strong>插件</strong>查询近几次提交或用户偏好，经<strong>模板节点</strong>输出预填数据（如 JSON），前端解析后填充表单。要点：插件查数据 + 模板节点出结构化结果，方便对接。</li>
<li><strong>文本片段补全</strong>根据前文内容补全后续文本。创建 <strong>Chatflow</strong> 并开启<strong>流式输出</strong>，用<strong>代码节点</strong>做后处理使输出更可控；用<strong>问题分类器节点</strong>将请求路由到最合适的场景；启用<strong>记忆</strong>，在分类与补全时带入对话历史，提高多轮准确性。实际可做成「每输入一段或停顿一段时间再触发补全」，以平衡体验与成本。</li>
<li><strong>长文本汇总助手</strong>
文本量大时，用<strong>多个输入节点</strong>对长文分块、<strong>并发处理</strong>，最后汇聚到<strong>一个 Agent 节点</strong>做汇总。并发能缩短总耗时（整体处理速度/吞吐提升），并可能因分块聚焦而提高汇总质量。</li>
</ol>
<p>以上示例体现了 Dify 中<strong>插件、模板、流式、分类、记忆、并行与汇聚</strong>等编排思想，这些概念在 LangChain 等框架中同样存在，只是实现方式从「画布拖拽」变成了「代码编排」。</p>
<hr/>
<h4 data-id="heading-19">5.5 LangChain 简介</h4>
<p>LangChain 是<strong>编程优先</strong>的 AI 应用编排框架（支持 Python / JavaScript），通过代码组装模型、提示词、工具、记忆与向量库等组件，构建可复用的链（Chain）与智能体（Agent）。借用官网定位：</p>
<blockquote>
<p><strong>LangChain</strong> 是构建 LLM 应用的平台。它通过统一的接口连接模型、嵌入、向量存储、检索与工具等，让开发者快速从原型迭代到生产，并随技术演进保持可扩展。</p>
</blockquote>
<p><strong>与 Dify 的对比</strong>：Dify 用画布和节点完成编排，LangChain 用代码定义每一步——链式调用、条件分支、工具选择、多轮记忆等都由你显式控制，适合需要深度定制、对接自有系统或实现复杂 Agent 逻辑的场景。</p>
<p><strong>核心概念速览</strong>：</p>
<ul>
<li><strong>Chain</strong>：把提示词、模型、解析等步骤串成一条流水线（如 RAG 链：检索 → 拼上下文 → 调用模型 → 解析输出）。</li>
<li><strong>Agent</strong>：由模型根据当前输入决定「下一步调用哪个工具、传什么参数」，多步推理与工具调用循环进行。</li>
<li><strong>Tool</strong>：可被 Agent 调用的能力单元（查库、调 API、执行代码等），在 LangChain 中通常封装为函数并绑定到模型。</li>
<li><strong>Memory</strong>：在对话或链式调用中持久化/读取历史（如缓冲记忆、摘要记忆），供多轮对话或长流程使用。</li>
</ul>
<p>下面列举 LangChain 的<strong>实际使用场景</strong>及简要实现思路。</p>
<ol>
<li><strong>API 文档分析，生成 Mock 接口</strong>用 <strong>Chain</strong> 串联：解析文档（如 OpenAPI/Swagger）→ 提取路径、参数、响应结构 → 用 LLM 生成对应 Mock 数据或 Mock 服务代码；可配合模板和校验步骤，保证输出格式稳定。</li>
<li><strong>低代码平台 AI 生成自定义组件</strong>用 <strong>Agent + Tool</strong>：把「读设计稿/需求描述」「查组件库 API」「写代码」「执行预览」封装成 Tool，由模型按需调用；多轮时可启用 <strong>Memory</strong> 记住已选组件和约束，保证风格一致。</li>
<li><strong>自动化运维部署、仓库管理</strong>
用 <strong>Agent + Tool</strong>：将执行命令、读仓库状态、发 MR、查流水线等封装为 Tool，由 Agent 根据自然语言指令选择并执行；复杂流程可用 <strong>LangGraph</strong> 做有状态编排，或与现有 CI/CD 脚本对接。</li>
</ol>
<p><strong>延伸</strong>：以上场景都是「代码里显式定义每一步」，适合对可控性、可测试性和与现有系统集成要求高的场景。若需要快速出 Demo 或给业务方拖拽式配置，可先用 Dify 搭主流程，再用 LangChain（或通过 MCP 暴露的能力）承接复杂逻辑与自动化，二者形成互补。</p>
<hr/>
<h3 data-id="heading-20">六、AI 集成应用与 ClawBot 简介</h3>
<p>前文提到的<strong>模型层、记忆层、编排层</strong>是「能力层」，最终要落到用户能直接使用的<strong>应用</strong>上。本节说明什么是 <strong>AI 集成应用</strong>，并以 <strong>ClawBot / OpenClaw</strong> 为例，说明它们与各层的关系、做了哪些创新，以及自研框架与 Dify/LangChain 等流行框架的异同。更详细的介绍可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F2000850539936765122" target="_blank" title="https://zhuanlan.zhihu.com/p/2000850539936765122" ref="nofollow noopener noreferrer">知乎 · ClawBot 相关讨论</a>。</p>
<h4 data-id="heading-21">6.1 什么是 AI 集成应用</h4>
<p><strong>AI 集成应用</strong>指的是：把<strong>模型层（推理）、记忆层（RAG/长期记忆）、编排层（何时调模型、何时查库、何时调工具）<strong>以及</strong>工具能力（填表、发邮件、跑脚本、控制设备等）<strong>打包成</strong>终端用户可直接使用的产品</strong>——例如聊天机器人、个人助理、垂直领域 Agent 等。用户不关心底层用的是哪家模型、哪套向量库，只关心「能对话、能办事、能记住我」。</p>
<p>与分层的关系可以简单理解为：</p>






























<table><thead><tr><th>层次</th><th>作用</th><th>与「AI 集成应用」的关系</th></tr></thead><tbody><tr><td><strong>模型层</strong></td><td>提供推理与生成能力</td><td>应用通过 API 调用模型，得到回复或决策</td></tr><tr><td><strong>记忆层</strong></td><td>存储与检索知识、对话历史、用户偏好</td><td>应用把「要记住什么」「要查什么」交给记忆层，再拼进上下文</td></tr><tr><td><strong>编排层</strong></td><td>决定调用顺序、分支、工具选择</td><td>应用要么使用现成编排工具（如 Dify、LangChain），要么<strong>自研编排逻辑</strong>（如 ClawBot）</td></tr><tr><td><strong>应用层</strong></td><td>面向最终用户的产品形态</td><td><strong>AI 集成应用就站在这一层</strong>，整合下层能力，并通过 IM、Web、API 等渠道交付给用户</td></tr></tbody></table>
<p>因此：<strong>AI 集成应用 = 在应用层，对模型层、记忆层、编排层（及工具）做整合后的可交付产品</strong>。ClawBot / OpenClaw 正是这一类产品——它们<strong>没有直接采用前文提到的 Dify 或 LangChain</strong>，而是<strong>自研了编排与技能体系</strong>，从而更贴合「个人助理 + 多渠道 + 本地优先」的定位。</p>
<h4 data-id="heading-22">6.2 ClawBot / OpenClaw 简介</h4>
<p><strong>ClawBot</strong>（后曾用名 Moltbot，开源版本常称 <strong>OpenClaw</strong>）是一类<strong>个人 AI 助手</strong>型集成应用，典型特点包括：</p>
<ul>
<li><strong>可执行实际操作</strong>：不限于聊天，能运行命令、填表格、发邮件、控制浏览器与智能家居等，充当「数字个人助理」。</li>
<li><strong>多渠道集成</strong>：接入 WhatsApp、Telegram、iMessage、Slack、Discord 等，在用户日常使用的通讯工具里与用户交互，实现「像和真人对话一样」的使用方式。</li>
<li><strong>对话记忆</strong>：能记住较长时间的对话内容，并支持主动提醒等能力，依赖自研或集成的记忆机制。</li>
<li><strong>技能系统</strong>：通过 <strong>AgentSkills 兼容的技能</strong>（或类似插件）扩展能力，用户可从 <strong>ClawdHub</strong> 等技能库发现、安装、更新技能，形成可扩展生态。</li>
</ul>
<p>这类产品把「模型 + 记忆 + 编排 + 工具」全部收口在一个应用里，用户看到的是「一个助理」，背后则是模型层、记忆层、编排层的协同。</p>
<h4 data-id="heading-23">6.3 与模型层、记忆层、编排层的关系</h4>
<p>ClawBot / OpenClaw 作为<strong>应用层</strong>产品，与各层的关系可以概括为：</p>
<ul>
<li><strong>模型层</strong>：通过接入 OpenAI、Claude、DeepSeek 等厂商的 API，获得推理与生成能力；应用负责组请求、解析回复。</li>
<li><strong>记忆层</strong>：采用自研记忆方案（例如用 <strong>Markdown 文本文件</strong> 存储 AGENTS.md、SOUL.md、MEMORY.md、每日记忆日志等），实现长期记忆与人格/行为设定；部分能力在概念上与 RAG/向量库类似，但实现方式更轻量、本地化。</li>
<li><strong>编排层</strong>：<strong>并未使用 Dify、LangChain 等现成编排平台</strong>，而是<strong>自研编排与调度</strong>——例如通过 <strong>Gateway 控制平面</strong>统一管理消息通道、工具调用与事件触发，相当于「自建了一个小型编排引擎」，以便深度贴合 IM 接入、设备控制、技能加载等需求。</li>
</ul>
<p>也就是说：<strong>他们站在应用层，自己实现了「何时调模型、何时查记忆、何时调哪个技能/工具」的逻辑</strong>，从而在架构上与「用 Dify 画布」或「用 LangChain 写链」形成差异：更垂直、更产品化，而不是通用编排平台。</p>
<h4 data-id="heading-24">6.4 他们做了什么创新</h4>
<p>从公开资料与社区讨论中，可以归纳出以下几类创新点：</p>





























<table><thead><tr><th>方向</th><th>说明</th></tr></thead><tbody><tr><td><strong>插件化 / 技能生态</strong></td><td>从单体演进为<strong>插件化架构</strong>，模型提供商、技能等解耦为独立模块；通过 <strong>ClawdHub</strong> 等技能注册表，用户可发现、安装、更新技能，社区可贡献新能力，形成「应用 + 技能市场」的形态。</td></tr><tr><td><strong>Gateway 控制平面</strong></td><td>消息通道、工具调用、事件触发由<strong>统一 Gateway</strong> 管理，类似「总控/接线员」，便于对接多种 IM 与设备，并统一做鉴权、限流、路由。</td></tr><tr><td><strong>本地优先与记忆形态</strong></td><td><strong>本地优先</strong>策略，敏感数据可只存本地；记忆采用 <strong>Markdown 文件</strong>（如 AGENTS.md、MEMORY.md、每日日志），用户和开发者可直接查看、编辑，透明且可版本管理。</td></tr><tr><td><strong>多渠道 + 7×24 待命</strong></td><td>深度集成 IM，用户在常用聊天工具里即可与 AI 交互；结合自动化与记忆，实现「随时发消息、随时执行任务」的助理体验。</td></tr><tr><td><strong>自动化执行深度</strong></td><td>不限于「聊天 + 查知识」，而是真正执行操作：填表、发邮件、跑脚本、控制浏览器与智能家居等，把「工具调用」做成产品级能力。</td></tr></tbody></table>
<p>这些创新集中在<strong>应用形态、编排自研、记忆形态、技能生态、渠道与执行深度</strong>上，与「只接一个模型 API」或「只用通用编排平台」的路线有明显区别。</p>
<h4 data-id="heading-25">6.5 自研框架与流行框架的异同</h4>








































<table><thead><tr><th>维度</th><th>ClawBot / OpenClaw 自研路线</th><th>Dify / LangChain 等流行框架</th></tr></thead><tbody><tr><td><strong>编排</strong></td><td><strong>自研</strong>：Gateway + 自建调度逻辑，不依赖 Dify/LangChain</td><td><strong>通用编排</strong>：Dify 画布、LangChain 链/Agent，可复用于多种应用</td></tr><tr><td><strong>定位</strong></td><td><strong>应用层产品</strong>：直接面向终端用户（个人助理、IM 内使用）</td><td><strong>能力层/中间层</strong>：提供编排与集成能力，由业务再封装成应用</td></tr><tr><td><strong>记忆</strong></td><td><strong>自研</strong>：Markdown 文件、本地优先，强调可控与可读</td><td><strong>通用方案</strong>：多与向量库/RAG 集成，Dify/LangChain 均支持多种记忆与检索</td></tr><tr><td><strong>扩展</strong></td><td><strong>技能/插件</strong>：ClawdHub、AgentSkills 兼容技能，围绕「一个应用」扩展</td><td><strong>Tool/插件/工作流</strong>：Dify 插件与工作流节点、LangChain Tool，围绕「编排能力」扩展</td></tr><tr><td><strong>渠道与部署</strong></td><td><strong>深度集成 IM</strong>、本地优先、设备控制等，产品形态固定</td><td><strong>渠道无关</strong>：多为 API/SDK，由接入方决定 Web/IM/内部系统等</td></tr><tr><td><strong>底层逻辑</strong></td><td><strong>相同</strong>：仍是「模型 + 记忆 + 工具调用」的认知架构，只是编排与记忆的实现方式自研</td><td><strong>相同</strong>：同样依赖模型 API、记忆/检索、工具调用，只是以通用框架形式提供</td></tr></tbody></table>
<p><strong>小结</strong>：ClawBot / OpenClaw 是<strong>应用层的 AI 集成应用</strong>，在模型层、记忆层、编排层之上做整合；<strong>创新点</strong>在于自研编排与技能体系、Gateway 控制平面、本地优先的记忆形态、以及多渠道 IM 与深度自动化执行；<strong>与 Dify/LangChain 的异同</strong>——底层思想一致（模型+记忆+工具），但<strong>不自建在现成编排平台上</strong>，而是<strong>自研框架</strong>以更好贴合「个人助理 + 多渠道 + 本地 + 技能生态」的产品目标。</p>
<hr/>
<h3 data-id="heading-26">七、沙箱插件功能实现</h3>
<p>本节介绍 CLI 中「AI 沙箱」插件的功能与实现思路，便于对内分享。实现基于 <strong>LangChain</strong> 的 <strong>Tool</strong> 与 <strong>Agent 调用</strong>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2Fdocs%2Fconcepts%2Ftools%2F" target="_blank" title="https://js.langchain.com/docs/concepts/tools/" ref="nofollow noopener noreferrer">LangChain Tools 概念</a>），用自然语言驱动「生成代码 → 沙箱执行」的闭环。</p>
<h4 data-id="heading-27">7.1 沙箱的概念：为什么需要沙箱</h4>
<p><strong>沙箱（Sandbox）</strong> 在这里指：在一个<strong>隔离的运行时环境</strong>里执行<strong>由 AI 生成的代码</strong>，而不是直接在宿主进程里执行。</p>
<ul>
<li><strong>为什么要隔离</strong>：用户说「生成一个 index.html」或「把当前目录下所有 .txt 里的空格改成下划线」时，我们会让模型<strong>生成一段 JavaScript 代码</strong>，再由程序执行。若这段代码直接在宿主 Node 进程里跑，一旦模型生成 <code>require('child_process').execSync('rm -rf /')</code> 或访问敏感环境变量，就会对真实系统造成风险。沙箱的作用是<strong>限制执行环境</strong>：只暴露我们允许的 API（如 <code>createFile</code>、<code>readFile</code>、<code>listDir</code>），不暴露完整的 <code>require</code>、<code>process.env</code> 等，从而把「AI 生成的代码」和「真实系统」隔开。</li>
<li><strong>本项目的沙箱实现</strong>：使用 <strong>vm2</strong> 库，把一段「沙箱全局对象」（包含 <code>__workspace</code>、<code>fs</code>、<code>path</code>、<code>createFile</code>、<code>readFile</code> 等）注入到 VM 里，模型生成的代码只能访问这些对象；执行时用 <strong>IIFE</strong> 包裹代码以便支持顶层 <code>return</code>，执行结果或异常由宿主捕获后返回给用户。这样既能让 AI「写代码办事」，又不会越权操作宿主。</li>
</ul>
<h4 data-id="heading-28">7.2 功能概述</h4>
<ul>
<li><strong>入口</strong>：<code>st sandbox &lt;指令...&gt;</code>，例如 <code>st sandbox 生成一个 index.html</code>、<code>st sandbox 把当前目录下所有 .txt 里的空格改成下划线</code>。</li>
<li><strong>行为</strong>：根据用户指令，由<strong>调度模型</strong>决定是「执行代码/操作文件」还是「纯问答」；若需执行代码，则再调用一次模型，根据<strong>沙箱环境说明</strong>生成可在沙箱中运行的 JavaScript 代码，经<strong>语法校验</strong>后在 <strong>vm2</strong> 沙箱中执行，并将结果返回给用户。</li>
<li><strong>特殊处理</strong>：若生成的代码会启动 HTTP 服务（如 <code>app.listen</code>），进程会挂起并提示「按 Ctrl+C 停止」，避免服务立刻退出。</li>
</ul>
<h4 data-id="heading-29">7.3 整体流程与 LangChain 概念对应</h4>

























<table><thead><tr><th>步骤</th><th>实现</th><th>LangChain 概念简述</th></tr></thead><tbody><tr><td>1. 调度</td><td>模型根据用户输入决定调用 <code>sandbox</code> 还是 <code>direct_answer</code></td><td><strong>Tool</strong>：把能力封装成工具，模型通过 <strong>tool_calls</strong> 选择调用；<a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2Fdocs%2Fconcepts%2Ftools%2F%23binding-tools-to-models" target="_blank" title="https://js.langchain.com/docs/concepts/tools/#binding-tools-to-models" ref="nofollow noopener noreferrer">bindTools</a> 将工具绑定到模型。</td></tr><tr><td>2. 生成代码</td><td>沙箱工具内再调用一次模型，传入「沙箱环境说明」+ 用户指令，得到代码字符串</td><td><strong>SystemMessage / HumanMessage</strong>：构造对话；<strong>model.invoke(messages)</strong>：同步调用模型。</td></tr><tr><td>3. 执行与回传</td><td>在 vm2 中执行代码，将 stdout/返回值拼成字符串，作为<strong>ToolMessage</strong> 回传给模型</td><td><strong>ToolMessage</strong>：工具执行结果必须用 <code>tool_call_id</code> 与之前的 <strong>tool_calls</strong> 对应，模型据此继续推理或结束。</td></tr></tbody></table>
<p>多轮逻辑：命令里用 <code>messages</code> 数组累积 <strong>HumanMessage → AIMessage（含 tool_calls）→ ToolMessage → …</strong>，循环 <code>model.invoke(messages)</code> 直到模型不再发起 tool_calls，即完成一轮「调度 → 执行 → 回复」。</p>
<h4 data-id="heading-30">7.4 命令入口：调度 Agent 与工具循环</h4>
<p>命令定义在 <code>src/bin/command/agentCommand/sandbox.ts</code>。核心：<strong>绑定两个 Tool</strong>，用<strong>系统提示词</strong>约束「何时调沙箱、何时直接回答」。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 调度提示：需要动文件/跑代码 → sandbox；纯问答 → direct_answer</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DISPATCHER_SYSTEM_PROMPT</span> = <span class="hljs-string">`你是调度助手：根据用户输入决定「要不要执行代码」，并只调用一个工具。
规则：
1. **需要执行代码/操作文件时** → 调用 \`sandbox\`，把用户的整句指令原样传入。
2. **纯问答、不需要动文件或跑代码时** → 调用 \`direct_answer\`，用 \`answer\` 参数给出简短回答（1～3 句话）。
3. 只调用一个工具，不要同时调用两个。`</span>;

<span class="hljs-keyword">const</span> tools = [sandboxTool, answerTool];
<span class="hljs-keyword">const</span> model = <span class="hljs-title function_">createModel</span>().<span class="hljs-title function_">bindTools</span>(tools);
<span class="hljs-keyword">const</span> messages = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(<span class="hljs-variable constant_">DISPATCHER_SYSTEM_PROMPT</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(instruction)];
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(messages);
<span class="hljs-comment">// 若有 response.tool_calls，则执行对应工具，把结果 push 成 ToolMessage，再 invoke(messages)，循环</span>
</code></pre>
<ul>
<li><strong>bindTools(tools)</strong>：LangChain 中把「可调用的工具列表」绑到模型上，模型输出中会包含 <strong>tool_calls</strong>（工具名 + 参数）。</li>
<li><strong>ToolMessage</strong>：构造时需传入 <strong>tool_call_id</strong>（与 AIMessage 中某条 tool_call 的 id 一致），这样模型才能把「这条工具结果」与「哪一次调用」对应起来。</li>
</ul>
<h4 data-id="heading-31">7.5 Tools 如何写、为什么这么写</h4>
<p>工具定义在 <code>src/bin/langchain/tools/sandbox.ts</code>。我们只暴露<strong>两个 Tool</strong>：<code>direct_answer</code>（纯问答）和 <code>sandbox</code>（执行代码/操作文件）。模型通过 <strong>tool_calls</strong> 选择调用哪一个，并传入对应参数。下面用实际代码说明<strong>怎么写</strong>以及<strong>为什么这么写</strong>。</p>
<h5 data-id="heading-32">7.5.1 为什么只有两个 Tool？</h5>
<p>调度层只需要做<strong>二选一</strong>：「用户是在问问题」→ 用 <code>direct_answer</code> 直接回答；「用户要动文件或跑代码」→ 用 <code>sandbox</code> 生成代码并在沙箱里执行。若只给一个「万能工具」，模型容易在纯问答时也去调沙箱，增加延迟和误执行风险；若拆成很多小工具（如「创建文件」「读文件」「执行命令」），调度模型要做的选择太多，容易选错。因此<strong>两个工具、职责清晰</strong>，便于在系统提示词里写清「何时调哪个」。</p>
<h5 data-id="heading-33">7.5.2 answerTool：纯问答工具</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { tool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> answerTool = <span class="hljs-title function_">tool</span>(
  <span class="hljs-function">(<span class="hljs-params">args: { answer: <span class="hljs-built_in">string</span> }</span>) =&gt;</span> args.<span class="hljs-property">answer</span>,
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"direct_answer"</span>,
    <span class="hljs-attr">description</span>:
      <span class="hljs-string">"仅用于纯问答：用户只是提问、解释、闲聊，不需要创建/修改/删除文件或执行任何代码时使用。回答必须简短（一两句话到一小段），不要长篇大论。"</span>,
    <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
      <span class="hljs-attr">answer</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"简短回答，控制在 1～3 句话内，不要过长"</span>),
    }),
  }
);
</code></pre>
<ul>
<li><strong>name</strong>：模型在 <strong>tool_calls</strong> 里通过这个名字选中该工具；写成 <code>direct_answer</code> 与调度提示词里的「调用 <code>direct_answer</code>」一致。</li>
<li><strong>description</strong>：<strong>最关键</strong>。LangChain 会把 description 发给模型，模型据此判断「当前用户输入是否属于纯问答」。这里明确写了「仅用于纯问答」「不需要创建/修改/删除文件或执行任何代码」「回答必须简短」，模型才会在用户问「什么是 RAG」时调这个工具，而不是调 sandbox。</li>
<li><strong>schema</strong>：用 <strong>zod</strong> 声明参数。模型不会「自己发明」参数名，而是按 schema 里的字段生成 JSON；这里只有 <code>answer</code> 一个字符串，模型就会把要回复给用户的话放进 <code>answer</code>，我们直接 <code>args.answer</code> 返回即可。<strong>不写 schema 的话，模型不知道要传什么参数</strong>，容易不传或传错。</li>
</ul>
<h5 data-id="heading-34">7.5.3 sandboxTool：沙箱执行工具</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> sandboxTool = <span class="hljs-title function_">tool</span>(
  <span class="hljs-keyword">async</span> (<span class="hljs-attr">args</span>: { <span class="hljs-attr">instruction</span>: <span class="hljs-built_in">string</span> }) =&gt; {
    <span class="hljs-keyword">const</span> { instruction } = args;
    <span class="hljs-comment">// 1. 构造沙箱专用对话，让模型生成代码</span>
    <span class="hljs-keyword">const</span> messages = [
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(<span class="hljs-variable constant_">SANDBOX_SYSTEM_PROMPT</span>),
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(instruction),
    ];
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(messages);
    <span class="hljs-keyword">const</span> responseText = <span class="hljs-keyword">typeof</span> res.<span class="hljs-property">content</span> === <span class="hljs-string">"string"</span> ? res.<span class="hljs-property">content</span> : <span class="hljs-title class_">String</span>(res.<span class="hljs-property">content</span> ?? <span class="hljs-string">""</span>);
    <span class="hljs-comment">// 2. 解析代码 + 是否 HTTP 服务</span>
    <span class="hljs-keyword">const</span> { code, isHttpService } = <span class="hljs-title function_">parseCodeFromResponse</span>(responseText);
    <span class="hljs-keyword">if</span> (!code) <span class="hljs-keyword">return</span> <span class="hljs-string">`未能从模型回复中解析出代码。...`</span>;
    <span class="hljs-comment">// 3. Acorn 语法校验</span>
    <span class="hljs-keyword">const</span> validation = <span class="hljs-title function_">validateSyntax</span>(code);
    <span class="hljs-keyword">if</span> (!validation.<span class="hljs-property">ok</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">`语法校验失败：<span class="hljs-subst">${validation.message}</span>`</span>;
    <span class="hljs-comment">// 4. 在沙箱中执行</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">runInSandbox</span>(code);
      <span class="hljs-comment">// 格式化结果，若为 HTTP 服务则加前缀供命令层挂起进程</span>
      <span class="hljs-keyword">return</span> isHttpService ? <span class="hljs-variable constant_">SANDBOX_HTTP_SERVICE_PREFIX</span> + body : body;
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`沙箱执行错误：<span class="hljs-subst">${msg}</span>`</span>;
    }
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"sandbox"</span>,
    <span class="hljs-attr">description</span>:
      <span class="hljs-string">"仅当用户需要「执行代码/操作文件」时使用：例如创建/修改/删除文件、生成 HTML、批量重命名、运行 shell 命令、读目录等。不需要动文件或跑代码时不要调用。"</span>,
    <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
      <span class="hljs-attr">instruction</span>: z
        .<span class="hljs-title function_">string</span>()
        .<span class="hljs-title function_">describe</span>(<span class="hljs-string">"用户的自然语言指令，例如：生成一个 index.html；或：把当前目录下所有 .txt 文件名里的空格改成下划线"</span>),
    }),
  }
);
</code></pre>
<ul>
<li><strong>name</strong>：<code>sandbox</code>，与调度提示词里「调用 <code>sandbox</code>」一致。</li>
<li><strong>description</strong>：明确写「仅当用户需要执行代码/操作文件时使用」，并举例（创建/修改/删除文件、生成 HTML、批量重命名、运行命令、读目录），最后强调「不需要动文件或跑代码时不要调用」。这样模型才会在用户说「生成一个 index.html」时调 sandbox，在用户说「什么是 RAG」时不调。</li>
<li><strong>schema</strong>：只有一个参数 <code>instruction</code>，类型为 string，describe 里给了示例。调度模型会把<strong>用户的整句指令</strong>原样放进 <code>instruction</code>，sandboxTool 内部再拿这句 instruction 去调<strong>第二次模型</strong>（生成代码的那次），这样「调度」和「生成代码」解耦：调度只负责选工具+传参，生成代码由沙箱专用的 system prompt（SANDBOX_SYSTEM_PROMPT）约束。</li>
<li><strong>为什么工具内部再调一次模型？</strong> 因为「生成可在沙箱中执行的 JavaScript」需要<strong>另一套提示词</strong>（沙箱环境说明、默认目录、HTTP 服务标记等），和「调度：选 sandbox 还是 direct_answer」的提示词不同。所以设计成：调度模型只做二选一并传 <code>instruction</code>；sandboxTool 内部用 SANDBOX_SYSTEM_PROMPT + instruction 再 invoke 一次模型，得到代码后再校验、执行、返回。这样职责清晰，也便于单独调优沙箱侧的提示词。</li>
</ul>
<h5 data-id="heading-35">7.5.4 sandboxTool 内部四步（简要）</h5>
<ol>
<li><strong>构造沙箱专用对话</strong>：<code>SystemMessage(SANDBOX_SYSTEM_PROMPT)</code> + <code>HumanMessage(instruction)</code>。SANDBOX_SYSTEM_PROMPT 由 <code>getSandboxPromptContext("markdown")</code> 生成，限制模型只使用沙箱内列出的 API。</li>
<li><strong>解析模型回复</strong>：从回复中提取 ```js ... ``` 或裸代码，并判断是否包含 <code>__IS_HTTP_SERVICE__</code> 或代码中是否有 <code>.listen(</code>，用于后续是否挂起进程。</li>
<li><strong>Acorn 语法校验</strong>：在进入 vm2 前用 acorn 做一次 parse，避免明显语法错误在沙箱里报错不明确或卡死。</li>
<li><strong>runInSandbox(code)</strong>：调用沙箱模块执行代码；若为 HTTP 服务，在返回内容前加上 <code>SANDBOX_HTTP_SERVICE_PREFIX</code>，命令层检测到后挂起进程。</li>
</ol>
<h4 data-id="heading-36">7.6 沙箱相关提示词：为什么要这么写</h4>
<p>沙箱功能里用到<strong>两套提示词</strong>：一套在<strong>命令层</strong>做调度（选 sandbox 还是 direct_answer），一套在<strong>沙箱工具内部</strong>做代码生成（只生成可在沙箱中执行的 JavaScript）。两套职责分离，便于单独调优。下面分别贴出关键内容，并说明<strong>为什么要这么写</strong>。对应代码位置：<code>src/bin/command/agentCommand/sandbox.ts</code>（调度）、<code>src/bin/langchain/sandbox/prompt.ts</code>（沙箱环境说明）、<code>src/bin/langchain/tools/sandbox.ts</code>（代码生成规则拼接）。</p>
<hr/>
<h5 data-id="heading-37">7.6.1 调度提示词（DISPATCHER_SYSTEM_PROMPT）</h5>
<p><strong>完整内容</strong>（<code>sandbox.ts</code> 命令入口）：</p>
<pre><code class="hljs language-text" lang="text">你是调度助手：根据用户输入决定「要不要执行代码」，并只调用一个工具。

规则：
1. **需要执行代码/操作文件时** → 调用 `sandbox`，把用户的整句指令原样传入。例如：创建/修改/删除文件、生成 HTML、批量重命名、列目录、运行命令等。
2. **纯问答、不需要动文件或跑代码时** → 调用 `direct_answer`，用 `answer` 参数给出简短回答（1～3 句话，不要长篇大论）。
3. 只调用一个工具，不要同时调用两个。不要输出过长文本。
</code></pre>
<p><strong>为什么要这么写</strong>：</p>



































<table><thead><tr><th>部分</th><th>作用</th><th>不这么写的后果</th></tr></thead><tbody><tr><td><strong>角色</strong>「你是调度助手」</td><td>让模型只做「二选一」决策，不越权去解释或生成代码</td><td>模型可能既调工具又自己啰嗦一大段，或去「猜」用户意图时输出长文</td></tr><tr><td><strong>任务</strong>「根据用户输入决定要不要执行代码，并只调用一个工具」</td><td>明确输出形态：只产生一次 tool_calls，且只选一个工具</td><td>可能同时调 sandbox 和 direct_answer，下游难以处理；或多次调用增加延迟</td></tr><tr><td><strong>规则 1</strong>「需要执行代码/操作文件时 → 调用 sandbox，整句指令原样传入」</td><td>与 Tool 的 <code>name: "sandbox"</code> 一致；举例（创建/修改/删除文件、生成 HTML、批量重命名等）帮助模型判断「何时算需要动文件」</td><td>模型容易在纯问答时也调 sandbox，或把指令改写成自己的话导致语义漂移</td></tr><tr><td><strong>规则 2</strong>「纯问答时 → 调用 direct_answer，answer 参数 1～3 句话」</td><td>与 Tool 的 <code>name: "direct_answer"</code> 和 schema 里的 <code>answer</code> 一致；约束长度便于终端展示</td><td>纯问答时模型可能调 sandbox 或输出过长，影响体验和 token</td></tr><tr><td><strong>规则 3</strong>「只调用一个工具，不要输出过长文本」</td><td>强化「只选一个」和「不附带长文」，避免模型在 tool_calls 之外再输出大段说明</td><td>容易出现「调了工具又输出好几段话」或一次多个 tool_calls</td></tr></tbody></table>
<p>总结：调度提示词的核心是<strong>角色单一（调度）、任务清晰（二选一）、规则与 Tool 的 name/schema 一一对应</strong>，这样模型才会稳定地「只选一个工具、传对参数」。</p>
<hr/>
<h5 data-id="heading-38">7.6.2 沙箱环境说明（prompt.ts：SANDBOX_SCHEMA / getSandboxPromptMarkdown）</h5>
<p><strong>作用</strong>：在沙箱工具内部，把「沙箱里有哪些全局对象/函数、怎么用」写成 Markdown（或 JSON），通过 <code>getSandboxPromptContext("markdown")</code> 拼进 <strong>SANDBOX_SYSTEM_PROMPT</strong> 的前半部分，让生成代码的那次模型<strong>只使用这些 API</strong>，不写 <code>require('fs')</code>、<code>require('path')</code> 等（沙箱里没有原生 require）。</p>
<p><strong>为什么要这么写</strong>：</p>
<ul>
<li><strong>按类别分块</strong>（Node 内置、异步、Web 框架、子进程、便捷 API）：模型按「要找什么能力」快速定位，减少幻觉（例如去用未暴露的 API）。</li>
<li><strong>写清默认操作目录</strong>「默认使用当前命令行所在目录（即 __workspace）；路径用相对路径」：避免模型生成绝对路径或假设别的 cwd，导致执行时报「文件不存在」。</li>
<li><strong>便捷 API 用表格列出</strong>（createFile、readFile、listDir、rename、remove 等）：表格比大段文字更利于模型「按名选用」，且与 <code>common.ts</code> 里真实暴露的函数一致；对易错点（如「改文件名时用 rename，不要只 createFile 新路径」）单独写一句，减少同一内容两份文件。</li>
<li><strong>启动服务、修改文件名等单独强调</strong>：因为模型常犯「只生成文件不 listen」或「只 createFile 新路径不删旧文件」的错，所以在环境说明里就约束好，比只在后面「要求」里写更醒目。</li>
</ul>
<p>对应代码：<code>src/bin/langchain/sandbox/prompt.ts</code> 中的 <strong>SANDBOX_SCHEMA</strong>（JSON 化配置）、<strong>getSandboxPromptMarkdown()</strong>（生成给模型看的 Markdown）；工具里用 <strong>getSandboxPromptContext("markdown")</strong> 取这段，再拼上下面的「要求」部分。</p>
<hr/>
<h5 data-id="heading-39">7.6.3 沙箱代码生成规则（SANDBOX_SYSTEM_PROMPT 后半部分）</h5>
<p>在「沙箱环境说明」之后，工具里拼接的<strong>要求</strong>（<code>src/bin/langchain/tools/sandbox.ts</code> 中的 SANDBOX_SYSTEM_PROMPT）如下，并说明<strong>每条为什么要这么写</strong>：</p>
<pre><code class="hljs language-text" lang="text">---
请根据用户的自然语言指令，生成一段可在上述沙箱中执行的 JavaScript 代码。
要求：
1. 只输出代码，不要解释或 markdown 标题。
2. 代码中只能使用上文列出的全局对象和函数。
3. 若需要返回结果给用户，请用 return 或 console.log。
4. 可以包在 ```js ... ``` 里，也可以直接输出裸代码。
5. 如果你认为执行后有重大错误请直接返回 "执行失败"。
6. **默认操作目录**：如果用户没有指定在哪个目录操作，默认使用当前命令行所在目录（即 __workspace）；路径用相对路径如 '.' 或 '文件名' 即可。
7. **启动服务型项目时**：尽量在沙箱内完成，单段代码中完成应用创建、路由、app.listen 等，不要只生成文件让用户自己运行或依赖沙箱外的步骤；用 app.listen(port, () =&gt; console.log('http://localhost:' + port)) 打印地址，代码末尾不要 return。
8. **若本次生成的代码会启动 HTTP 服务**（如 Koa/Express 的 app.listen），请在代码块后单独一行写 __IS_HTTP_SERVICE__，以便宿主进程挂起（用户 Ctrl+C 停止）。
9. **修改文件名或格式时**：用 rename(oldPath, newPath) 重命名，或先 readFile 再 createFile 新路径后 remove 原文件；不要只 createFile 新路径而保留原文件，避免同一内容有两份。
</code></pre>
<p><strong>为什么要这么写</strong>：</p>























































<table><thead><tr><th>条</th><th>目的</th><th>不这么写的后果</th></tr></thead><tbody><tr><td><strong>1</strong> 只输出代码，不要解释或 markdown 标题</td><td>便于从回复里稳定解析出「一段代码」；解析逻辑依赖「要么 ```js 块要么裸代码」</td><td>模型输出大段说明 + 代码，解析容易取错或取到解释文本</td></tr><tr><td><strong>2</strong> 只能使用上文列出的全局对象和函数</td><td>与 prompt 前半部分「沙箱环境说明」一致，防止用 <code>require('fs')</code> 等沙箱内不存在的东西</td><td>生成的代码在 vm2 里报 <code>require is not defined</code> 或访问未暴露 API 报错</td></tr><tr><td><strong>3</strong> 返回结果用 return 或 console.log</td><td>宿主通过 IIFE 的返回值或 stdout 拿结果；明确两种出口，模型不会只写中间变量不输出</td><td>用户看不到执行结果，或解析不到返回值</td></tr><tr><td><strong>4</strong> 可以包在 ```js 里也可以裸代码</td><td>解析时两种都支持（parseCodeFromResponse），给模型容错空间</td><td>若强制只接受一种，模型有时会选另一种导致解析失败</td></tr><tr><td><strong>5</strong> 认为有重大错误时直接返回 "执行失败"</td><td>避免模型硬生成明显会报错的代码，让工具层直接返回可读提示</td><td>容易得到一段必然报错的代码，用户体验差</td></tr><tr><td><strong>6</strong> 默认操作目录 __workspace，路径用相对路径</td><td>与 prompt 前半部分一致；和 common.ts 里 createSandbox 的 root 对齐</td><td>模型生成 /tmp/xxx 或其它绝对路径，在沙箱里路径不对</td></tr><tr><td><strong>7</strong> 启动服务时在沙箱内完成 listen，不要只生成文件</td><td>用户说「起一个 Koa 服务」时期望直接能访问，而不是再手动运行</td><td>只生成 app.js 让用户自己 node app.js，不符合「一条指令完成」的预期</td></tr><tr><td><strong>8</strong> HTTP 服务时在代码块后写 <strong>IS_HTTP_SERVICE</strong></td><td>工具和命令层用该标记判断是否挂起进程（不退出），否则服务会立刻退出</td><td>启动的服务一启动就退出，用户无法访问</td></tr><tr><td><strong>9</strong> 改文件名用 rename 或 读→写新→删旧</td><td>与环境说明里「不要只 createFile 新路径」一致，避免同一内容两份文件</td><td>用户说「把 a.txt 改成 b.txt」时生成两个文件，语义错误</td></tr></tbody></table>
<p>总结：前半部分（prompt.ts）负责<strong>能力边界与用法约定</strong>，后半部分（工具里拼接）负责<strong>输出格式、默认目录、HTTP 服务、重命名等易错约束</strong>；两段合在一起，模型才能稳定生成「可解析、可执行、行为符合预期」的沙箱代码。</p>
<h4 data-id="heading-40">7.7 沙箱环境与执行引擎</h4>
<ul>
<li><strong>环境定义</strong>（<code>src/bin/langchain/sandbox/common.ts</code>）：<strong>createSandbox(workspaceRoot)</strong> 返回一个对象，包含 <strong>vm2</strong> 所需的 <strong>sandbox</strong> 全局变量——如 <code>__workspace</code>、<code>fs</code>/<code>path</code>/<code>process</code>/<code>os</code>/<code>Buffer</code>/<code>util</code>/<code>console</code>/<code>URL</code>、<code>Promise</code>/<code>setTimeout</code>、<code>Koa</code>/<code>koaRouter</code>、<code>child_process.execSync</code>/<code>spawnSync</code>，以及便捷方法 <strong>createFile / readFile / listDir / rename / remove / copy / move / stat / listFilesRecursive / globFiles / requireFromWorkspace</strong> 等。路径未指定时默认为当前命令行所在目录（即 <code>__workspace</code>）。</li>
<li><strong>执行</strong>（<code>src/bin/langchain/sandbox/index.ts</code>）：使用 <strong>vm2</strong> 的 <code>VM</code>，把上述 sandbox 对象传入；为支持「顶层 return」，将用户代码包成 <strong>IIFE</strong> 再执行：</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> wrapped = <span class="hljs-string">`(function() {\n<span class="hljs-subst">${code}</span>\n})()`</span>;
<span class="hljs-keyword">const</span> result = vm.<span class="hljs-title function_">run</span>(wrapped);
<span class="hljs-keyword">return</span> result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span> ? <span class="hljs-keyword">await</span> result : result;
</code></pre>
<p>这样生成的代码里可以直接 <code>return ...</code>，返回值会交给命令层展示；若 return 的是 Promise，会 await 后再返回。</p>
<ul>
<li><strong>提示词与 API 说明</strong>（<code>src/bin/langchain/sandbox/prompt.ts</code>）：<strong>SANDBOX_SCHEMA</strong> 描述沙箱内所有全局对象和函数的类型、参数、示例；<strong>getSandboxPromptMarkdown()</strong> 将其转成 Markdown 表格和列表，注入到 <code>SANDBOX_SYSTEM_PROMPT</code>，使模型只使用这些 API 生成代码，避免使用未暴露的 Node 或浏览器 API。</li>
</ul>
<h4 data-id="heading-41">7.8 小结</h4>





























<table><thead><tr><th>模块</th><th>作用</th></tr></thead><tbody><tr><td><strong>sandbox 命令</strong></td><td>解析 <code>st sandbox &lt;指令&gt;</code>，用调度 Agent + bindTools 在 <code>sandbox</code> / <code>direct_answer</code> 间选择，并循环处理 tool_calls，直到模型不再调用工具；检测 HTTP 服务标记后挂起进程。</td></tr><tr><td><strong>sandboxTool</strong></td><td>根据用户指令调用模型生成沙箱代码 → Acorn 校验 → runInSandbox 执行 → 将结果或错误以 ToolMessage 形式返回。</td></tr><tr><td><strong>answerTool</strong></td><td>纯问答时由模型填入 answer，原样返回给用户。</td></tr><tr><td><strong>createSandbox / runInSandbox</strong></td><td>提供 vm2 沙箱全局环境（含 Node 与便捷文件 API），IIFE 包裹执行并支持 return/Promise。</td></tr><tr><td><strong>prompt 与 SANDBOX_SCHEMA</strong></td><td>把沙箱能力描述成 Markdown/JSON，约束模型只生成合规、可执行的代码。</td></tr></tbody></table>
<p>整体上，这就是一个「<strong>自然语言 → 调度 Agent（Tool 二选一）→ 沙箱工具内再调模型生成代码 → 语法校验 → vm2 执行 → 结果回传</strong>」的闭环，用到的 LangChain 概念包括 <strong>Tool、bindTools、SystemMessage/HumanMessage/AIMessage/ToolMessage、model.invoke</strong>，对应官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2Fdocs%2Fconcepts%2Ftools%2F" target="_blank" title="https://js.langchain.com/docs/concepts/tools/" ref="nofollow noopener noreferrer">Tools</a> 与 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.langchain.com%2Fdocs%2Fconcepts%2Fmessages%2F" target="_blank" title="https://js.langchain.com/docs/concepts/messages/" ref="nofollow noopener noreferrer">Messages</a> 的用法。</p>
<hr/>
<h3 data-id="heading-42">八、提示词工程：如何写好提示词</h3>
<p>前面提到的编排、RAG、沙箱等，最终都要通过「<strong>和模型说清楚要做什么</strong>」才能生效，这部分就是<strong>提示词工程（Prompt Engineering）</strong>。下面用通俗方式说明其重要性，并给出一套可落地的书写原则，便于在业务里统一规范、减少无效调用。</p>
<h4 data-id="heading-43">8.1 为什么提示词重要</h4>
<p>模型本身不会「主动知道」业务规则、输出格式或边界条件，这些都需要通过**输入文本（提示词）**显式告诉它。提示词写得好，模型更容易：</p>
<ul>
<li><strong>做对事</strong>：理解任务意图、约束和优先级，减少答非所问或越权行为。</li>
<li><strong>出对格式</strong>：便于下游解析（如 JSON、表格、代码块），减少二次清洗。</li>
<li><strong>控制成本与延迟</strong>：约束长度、禁止冗长解释，有利于 token 与响应时间可控。</li>
</ul>
<p>因此，<strong>提示词是连接「业务需求」和「模型能力」的接口</strong>；写好提示词，是落地 AI 功能时性价比很高的投入。</p>
<h4 data-id="heading-44">8.2 如何写好提示词：几条可操作原则</h4>
<p>归纳为<strong>角色、任务、约束、格式、示例</strong>五类要素，按需组合即可。</p>



































<table><thead><tr><th>要素</th><th>说明</th><th>示例（一句话）</th></tr></thead><tbody><tr><td><strong>角色</strong></td><td>让模型进入「谁在说话」的设定，行为更一致</td><td>「你是调度助手」「你是只生成代码的沙箱执行器」</td></tr><tr><td><strong>任务</strong></td><td>用一句话说清「要干什么」，避免模糊</td><td>「根据用户输入决定调用 sandbox 还是 direct_answer」「生成可在沙箱中执行的 JavaScript」</td></tr><tr><td><strong>约束</strong></td><td>明确「不能做什么」「必须怎么做」，减少越界</td><td>「只输出代码，不要解释」「只能使用上文列出的全局对象」「回答控制在 1～3 句话」</td></tr><tr><td><strong>格式</strong></td><td>规定输出形态，方便解析与展示</td><td>「返回 JSON」「用```js ... ``` 包住代码」「若启动 HTTP 服务请在代码块后写 <strong>IS_HTTP_SERVICE</strong>」</td></tr><tr><td><strong>示例</strong></td><td>给 1～2 个输入输出样例，大幅提升格式与风格一致性</td><td>「输入：生成 index.html → 输出：仅一段可执行代码」</td></tr></tbody></table>
<p><strong>书写习惯建议</strong>：</p>
<ul>
<li><strong>先写「角色 + 任务」</strong>，再补约束和格式，最后需要时加示例。</li>
<li><strong>一条提示词只服务一个目标</strong>：调度就只做调度，生成代码就只生成代码，避免混在一起导致模型「不知道该优先听哪句」。</li>
<li><strong>关键规则用加粗或编号</strong>，便于模型注意（如「<strong>只调用一个工具</strong>」「3. 只输出代码」）。</li>
<li><strong>迭代优化</strong>：用真实用例跑几轮，看模型常犯的错误（漏约束、格式乱、话太多），再回头改提示词补一句、减一句。</li>
</ul>
<h4 data-id="heading-45">8.3 本文中的提示词实践（对应关系）</h4>
<ul>
<li><strong>调度提示词</strong>（七、沙箱插件）<strong>角色</strong>：调度助手。<strong>任务</strong>：根据用户输入决定调用 <code>sandbox</code> 还是 <code>direct_answer</code>。<strong>约束</strong>：只调用一个工具、不要长篇大论。这样模型就不会既调工具又自己啰嗦一大段。</li>
<li><strong>沙箱代码生成提示词****角色</strong>：沙箱内代码生成器。<strong>任务</strong>：根据用户指令生成可在给定沙箱中执行的 JavaScript。<strong>约束</strong>：只使用列出的 API、默认目录为 <code>__workspace</code>、启动服务时标注 <code>__IS_HTTP_SERVICE__</code>。<strong>格式</strong>：可包在 ```js ... ``` 里或裸代码。<strong>示例</strong>：通过 SANDBOX_SCHEMA / Markdown 表格把「有哪些函数、怎么用」写清楚，等于给了结构化示例。</li>
<li><strong>温度（二、认识模型）</strong>
温度虽不是「一句话提示词」，但属于<strong>同一类控制</strong>：通过参数告诉模型「要更确定还是更发散」。代码/结构化输出用低温度，创意类用稍高温度，本质上也是在「写好」对模型的行为约束。</li>
</ul>
<h4 data-id="heading-46">8.4 参照：业务中使用的提示词示例</h4>
<p>下面摘录并整理业务里实际用过的提示词，作为「角色 + 任务 + 约束 + 格式 + 示例」的参照，便于对照前文原则做迭代。</p>
<h5 data-id="heading-47">示例一：生成管理后台页面的 Prompt（低代码 / 运营者模块）</h5>
<p><strong>角色/任务</strong>：让 AI 在「30% 框架内」生成管理后台页面代码，而非凭空创新；需求边界、数据格式、交互范式由人工先锁定。</p>
<p><strong>约束与格式</strong>（节选）：</p>
<ul>
<li><strong>1.1 顶部导航栏</strong>：用 el-menu，背景色 #409EFF，文字白色，选中时背景加深 10%；左侧预留项目名称插槽（slot="brand"）；中间菜单项通过数组 NavItems 注入，结构 <code>NavItem { name, route, icon? }</code>；暴露事件 @select、@menu-click。Store 的 module 划分、state 形状、mutation 名由人工先锁定，AI 只生成具体 CRUD 逻辑。</li>
<li><strong>1.2 左侧列表区块</strong>：点击高亮用 class 切换（.is-active）；中间内容区 flex:1 自适应。</li>
<li><strong>1.3 左上角按钮组</strong>：添加按钮 el-button + Plus 图标、文字「新增」；搜索框 el-input + Search 图标，v-model 绑定 keyword，触发 @search。</li>
<li><strong>1.4 列表实现</strong>：字段校对由人工完成；AI 直接生成固定列数的 el-table，给出 <code>&lt;el-table-column&gt;</code> 骨架，prop 与后端字段保持一致。</li>
<li><strong>1.5 封装 ListTable 组件</strong>：外部传入 columns: <code>{ key, label, width?, slot? }[]</code>；内部维护 rendererMap，按 column.key 映射渲染函数；插槽命名规则 <code>table-[key]</code>，如 <code>&lt;template #table-status&gt;</code>。</li>
</ul>
<p><strong>要点</strong>：把「要生成什么、用什么组件、数据结构长什么样」写清楚，模型在给定框架内填代码，便于后续人工校对和联调。</p>
<h5 data-id="heading-48">示例二：AI 提升学习能力（设计模式 + 注释 + 单测）</h5>
<p><strong>角色/任务</strong>：用 AI 把「查文档 + 写样板」的时间省下来，在较短时间内给出「带设计模式 + 注释 + 单测模板」的高可维护代码。</p>
<p><strong>约束</strong>：先指定设计模式（如 Strategy、Factory、Observer）；要求 AI 生成 TypeScript 实现，并逐行补充 JSDoc 与单测用例；对存量代码，可让 AI 按相同模式做渐进式重构，人工只做 Code Review。</p>
<h5 data-id="heading-49">示例三：LangChain 调研结论（Function Calling / Multi-Agent / MCP）</h5>
<ul>
<li><strong>Function Calling</strong>：本地预注册函数，LLM 仅返回 JSON 参数；本地框架负责反射调用。LLM 本身不拥有、也不执行函数——它只是「点名 + 传参」。</li>
<li><strong>Multi-Agent 协作</strong>：同一进程内可启多个 Agent 实例，每个实例 system prompt 只聚焦单一职责（产品、开发、测试）；通过消息队列顺序传递上下文，降低单 Agent 的上下文长度与幻觉概率。</li>
<li><strong>MCP（Model Context Protocol）</strong>：统一「工具描述 + 调用」协议，Agent 通过 MCP 把工具清单发给 LLM，LLM 按 MCP 格式返回调用指令，本地 SDK 再执行真正的 Function Calling。类比：Agent 是顾客，MCP 是菜单 + 点单协议，Function Calling 是后厨实际炒菜。</li>
</ul>
<h5 data-id="heading-50">示例四：智能汇总 diff 生成 commit（工作流描述）</h5>
<p><strong>整体流程</strong>（一页讲解用）：获取 diff 信息 → 使用 LangChain 的 TokenTextSplitter 将文本切分为约 1500 大小的块 → Agent 对片段并发处理、AI 总结 → 将每个片段的结果再喂给 AI，生成 JSON（generalize 描述文本、commitMsg 标准化 commit 信息）→ 命令行确认后提交。</p>
<p><strong>分步要点</strong>：</p>
<ol>
<li>使用 git 获取 diff 信息。</li>
<li>使用 LangChain 的 TokenTextSplitter 将文本切分为约 1500 大小的模块。<strong>为什么要切分</strong>：一次数据量过大，直接丢给 Agent 生成速度慢；切分为 chunk 后通过 Promise.all 并发请求，减少等待时间。<strong>为什么不选 RAG/向量库</strong>：仅对 diff 做一次性汇总，先存向量库再检索过重，不适合。</li>
<li>用提示词让 AI 对非代码片段做文字性总结，对代码片段读取函数名并生成函数简述，收集成数组。</li>
<li>将多个片段汇总后的结果再作为提示词传入 AI，数据量小且能通过类型区分「代码」与「描述性文本」。</li>
<li>让 AI 用该数组生成一个 JSON：<code>generalize</code> 为描述整体的数组（展示为详细项），<code>commitMsg</code> 为标准化 commit 结果；后续用函数确认并调用 git 提交。</li>
</ol>
<p>以上示例可作为撰写「角色、任务、约束、格式、示例」时的参照，按业务场景裁剪即可。</p>
<h4 data-id="heading-51">8.5 小结</h4>
<p><strong>提示词工程</strong>就是把「要模型做什么、不能做什么、输出长什么样」说清楚；用好<strong>角色、任务、约束、格式、示例</strong>五类要素，并在实际用例上小步迭代，就能在少改代码的前提下，明显提升模型输出的可用性和稳定性。我们在调度、沙箱、RAG 等环节都已经按这套思路在写提示词，后续新功能也可以沿用同一套规范。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nginx动静分离实战：性能提升100倍关键！]]></title>    <link>https://juejin.cn/post/7602154088476868646</link>    <guid>https://juejin.cn/post/7602154088476868646</guid>    <pubDate>2026-02-03T03:32:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602154088476868646" data-draft-id="7602303923139821618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nginx动静分离实战：性能提升100倍关键！"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2026-02-03T03:32:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户525863386919"/> <meta itemprop="url" content="https://juejin.cn/user/4482058220739752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nginx动静分离实战：性能提升100倍关键！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4482058220739752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户525863386919
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:32:11.000Z" title="Tue Feb 03 2026 03:32:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近看了一个帖子，把踩过的坑，给大家说下，</p>
<pre><code class="hljs language-server" lang="server">        listen 8081;
        #listen       443 ssl;
        server_name _;

#        ssl_certificate      /opt/cert/ssl/yunbei.yanjiamall.cn.pem;
#        ssl_certificate_key  /opt/cert/ssl/yunbei.yanjiamall.cn.key;

        ssl_session_cache    shared:SSL:1m;
        ssl_session_timeout  5m;

        ssl_ciphers  HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers  on;
        #静态资源：正则匹配后直接读取本地目录
        location ~* \.(gif|jpg|jpeg|png|css|js|ico|svg|woff|woff2|ttf|eot)$ {
            root /opt/front/h5/h5/; # 新增这一行，指定静态文件实际目录
            expires 7d;
            add_header Cache-Control "public, max-age=604800, no-transform";
            try_files $uri =404;
        }

        location / {
            root /opt/front/h5/h5;
            index  index.html index.htm;
            try_files $uri $uri/ /index.html;
        }
        location /app-api/ {
             proxy_redirect off;
             proxy_set_header Host $host;
             proxy_set_header X-Real-IP $remote_addr;
             proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
             proxy_set_header X-Scheme $scheme;
             proxy_pass http://127.0.0.1:58082;
        }

}

</code></pre>
<p>第一个坑，你配置好时，在想怎么验证呢？我看到帖子没有写，于是去AI搜索下，给出下面答案</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa643012e19a4971ab20bcffdb036674~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTI1ODYzMzg2OTE5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770694333&amp;x-signature=LSHiH3PFzURcTddRLulnwSd7nsk%3D" alt="image.png" loading="lazy"/>
然后第一步基础配置语法检查是没有问题的
但是在【浏览器开发者工具（最直观）】没有找到
于是乎有出现下面的内容</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/947ab5d2ae3b4988a7eec3b7253625be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTI1ODYzMzg2OTE5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770694333&amp;x-signature=94KUJBeYy%2FuAjsqQ1NjwhMBXAow%3D" alt="image.png" loading="lazy"/>
第二个坑，但是浏览器还是没出现<code>Cache-Control</code> 和 <code>Expires</code> 缓存头
于是乎把nginx重启，命令如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fde32b347b44a70ac8cecc4dc2fe15e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTI1ODYzMzg2OTE5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770694333&amp;x-signature=ZYGais2pQKM8PEz3nATH6G71QZw%3D" alt="image.png" loading="lazy"/>
发现启动有问题，就进行一下命令</p>
<pre><code class="hljs language-#" lang="#">pkill -f nginx 
# 手动指定 PID 文件路径启动 
Nginx nginx -c /etc/nginx/nginx.conf -p /run/ 
# 或者直接重新启动服务 
systemctl restart nginx
</code></pre>
<p>第三个坑，但是浏览器还是没出现<code>Cache-Control</code> 和 <code>Expires</code> 缓存头
于是乎，想到了用无痕式打开网址
好了好了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0e8d0a65b344d148103c0cd139b777d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NTI1ODYzMzg2OTE5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770694333&amp;x-signature=jvfncD1os3cI9HxWq2ebVjxVk78%3D" alt="image.png" loading="lazy"/>
有写的不好，或者有其他问题，欢迎大家留言，点赞，马年发大财~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 2026 年 1 月 GitHub 十大热门项目排行榜 🔥]]></title>    <link>https://juejin.cn/post/7602191709388292138</link>    <guid>https://juejin.cn/post/7602191709388292138</guid>    <pubDate>2026-02-03T03:01:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602191709388292138" data-draft-id="7602259669729919003" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 2026 年 1 月 GitHub 十大热门项目排行榜 🔥"/> <meta itemprop="keywords" content="GitHub,人工智能,前端"/> <meta itemprop="datePublished" content="2026-02-03T03:01:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一点一木"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986187486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 2026 年 1 月 GitHub 十大热门项目排行榜 🔥
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986187486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一点一木
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:01:06.000Z" title="Tue Feb 03 2026 03:01:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎来到 <strong>2026 年 1 月 <code>GitHub</code> 热门开源项目排行榜</strong>！ 新年伊始，开源社区直接用行动告诉我们：<strong><code>AI</code> 正在彻底落地到你的电脑、手机和日常工作流中</strong>。本月榜单呈现出非常清晰的三大主线：本地化与隐私成为绝对共识、<code>Claude</code> 生态工具链快速闭环、多模态能力与高效推理技术双双进入成熟期。</p>
<p>这十个项目几乎全部围绕「让 <code>AI</code> 更贴近用户、更可控、更高效」展开，从个人级本地助手到专业领域 <code>Agent</code>，从内容创作到基础设施优化，全链路覆盖。它们不再是概念验证，而是<strong>可以立刻装进工作流、立刻产生生产力的工具</strong>。</p>
<p>三大核心趋势一览：</p>
<ul>
<li><strong>本地化与隐私优先全面爆发</strong>：<code>OpenClaw</code>、<code>UI-TARS-desktop</code>、<code>web-check</code> 等项目让<code>AI</code> 就在你设备上成为日常，数据绝不离本地</li>
<li><strong><code>Claude</code> 生态工具链闭环加速</strong>：<code>Skills</code>、<code>claude-plugins-official</code>、<code>Antigravity-Manager</code> 共同构建了更强大、更易扩展的 <code>Claude</code> 使用体系</li>
<li><strong>多模态 + 高效推理双轮驱动</strong>：<code>remotion</code>（代码视频）、<code>PageIndex</code>（推理 <code>RAG</code>）、<code>BitNet</code>（<code>1-bit LLM</code>）、<code>dexter</code>（金融 <code>Agent</code>）在各自垂直领域实现突破</li>
</ul>
<p>下面一起来看看 2026 年开年最值得 <code>Star</code> 的十大爆款！</p>
<hr/>
<h3 data-id="heading-0"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenclaw%2Fopenclaw" target="_blank" title="https://github.com/openclaw/openclaw" ref="nofollow noopener noreferrer"><code>OpenClaw</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>152K+</code></strong></p>
<p><strong>🦞 本地优先的个人 <code>AI</code> 助手：多渠道、全平台</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97ca9db1dab74044b265d6b25980e8ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692466&amp;x-signature=iaRBE0SQt%2FKpivsBQMfiCJ3vTDk%3D" alt="OpenClaw" loading="lazy"/></p>
<p><strong><code>OpenClaw</code></strong> 是一个完全开源、可自托管的个人 <code>AI</code> 助手，运行在你的设备上，通过 WhatsApp、Telegram、Slack、Discord 等 10+ 聊天渠道随时响应，支持语音唤醒、实时对话、Live Canvas 视觉工作区、浏览器/设备控制、日历邮件管理，实现「<code>AI</code> 就在你的消息列表里」。</p>
<p>它采用本地 Gateway 作为统一控制平面，支持 <code>Claude Opus 4.5</code> 等强模型 failover，提供技能生态（<code>ClawdHub</code>）、沙箱安全与 Docker 隔离，已成为隐私本地化 <code>AI</code> 助手的现象级爆款，社区技能共建与更新速度极快。</p>
<ul>
<li><strong>多渠道无缝集成</strong> ：10+ 主流聊天平台统一响应，无需切换 App</li>
<li><strong>语音 + 视觉交互</strong> ：Always-on 语音对话 + <code>Agent</code> 驱动 Live Canvas 工作区</li>
<li><strong>设备节点控制</strong> ：相机、屏幕录制、通知、位置等操作（macOS/iOS/Android）</li>
<li><strong>技能与自动化生态</strong> ：浏览器控制、Cron/Webhook、社区共建技能平台</li>
<li><strong>本地安全优先</strong> ：DM 配对码、沙箱、allowlist、全设备本地运行</li>
<li><strong>极简部署</strong> ：npm/Docker 一键 + onboard 向导，分钟级上手</li>
</ul>
<p>💡 <strong><code>OpenClaw</code></strong> 适合注重隐私、多设备重度用户，能自动化日常琐事（如清邮箱、订票、日程），社区热度爆炸，常被称「每天查更新」的核弹级项目。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenclaw%2Fopenclaw" target="_blank" title="https://github.com/openclaw/openclaw" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
<hr/>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer"><code>Skills</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>60.9K+</code></strong></p>
<p><strong>🤖 <code>Anthropic</code> 官方开源的 <code>Claude Agent Skills</code> 技能仓库</strong></p>
<p><strong><code>Skills</code></strong> 是 <code>Anthropic</code> 官方发布的公共技能仓库，展示了 <code>Claude</code> 的 <code>Skills</code> 系统如何让 <code>Agent</code> 动态加载文件夹中的指令、脚本和资源，提升在专业任务（如文档创作、数据分析、自动化、创意生成）上的表现。每个技能是一个自包含文件夹，核心文件为 <code>SKILL.md</code>（含 YAML 元数据 + 详细指令），<code>Claude</code> 可自动发现并应用它们。</p>
<p>仓库包含创意类（艺术、音乐、设计）、技术类（Web App 测试、<code>MCP</code> 服务器生成）、企业类（品牌、沟通）等多种示例，还开源了驱动 <code>Claude</code> 文件创建能力的文档技能（docx、pdf、pptx、xlsx），并提供规范（spec/）与模板（template/），已成为开发者自定义 <code>Claude</code> 技能的首选参考和插件源。</p>
<ul>
<li><strong>官方示例技能集</strong> ：覆盖创意、技术、企业多种场景的现成技能</li>
<li><strong>文档生成核心</strong> ：开源 docx/pdf/pptx/xlsx 技能，实现 <code>Claude</code> 的生产级文件创建</li>
<li><strong>技能规范与模板</strong> ：spec/ 定义标准，template/ 提供快速起步文件夹结构</li>
<li><strong><code>Claude Code</code> 集成</strong> ：通过 <code>/plugin marketplace add anthropics/skills</code> 注册并安装技能</li>
<li><strong><code>API</code> 与 <code>Claude.ai</code> 支持</strong> ：付费计划可上传自定义技能，<code>API</code> 通过 <code>Skills</code> 接口调用</li>
</ul>
<p>💡 <strong><code>Skills</code></strong> 适合 <code>Claude</code> 重度用户、<code>Agent</code> 开发者与企业团队，能快速扩展 <code>Claude</code> 在文档、自动化、创意任务上的能力，尤其作为官方参考仓库，学习与自定义技能的起点价值极高。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
<hr/>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flbjlaq%2FAntigravity-Manager" target="_blank" title="https://github.com/lbjlaq/Antigravity-Manager" ref="nofollow noopener noreferrer"><code>Antigravity-Manager</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>20.5K+</code></strong></p>
<p><strong>🔄 专业的 <code>Antigravity</code> 账号管理与切换工具：一键无缝多账号调度</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e13881e8de31457589fae2cdc4f34134~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692466&amp;x-signature=uKEsG1vB0oyTg1giqr3xHAIIabI%3D" alt="antigravity-manager-dashboard" loading="lazy"/></p>
<p><strong><code>Antigravity-Manager</code></strong> 是专为 <code>Antigravity Tools</code> 打造的高性能本地 <code>AI</code> 中转与账号管理器，使用 Tauri v2 + React (Rust) 构建，提供一键切换多账号、智能路由、协议转换与错误自愈功能，帮助开发者在 <code>Claude</code>、<code>Gemini</code>、<code>OpenAI</code> 等多模型生态中实现稳定、低成本的代理调度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5f770712bae4d7abbef697420be7e36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692466&amp;x-signature=b1mj0fLolFDRbWEZXQfWzqF4fx8%3D" alt="antigravity-manager-accounts" loading="lazy"/></p>
<p>它将 Web 会话统一转为标准 API 接口，支持模型降级、Token Saver（后台任务路由到免费模型）、多模态图像生成（Imagen 3 高负载）、工具调用兼容（MCP/Function Call），并通过智能配额监控与 429/401 自愈机制，确保长会话连续性与成本优化，已成为 <code>Antigravity</code> 生态的核心基础设施。</p>
<ul>
<li><strong>一键账号切换</strong> ：智能推荐最佳账号，基于配额/冗余实时调度，60s 会话锁定防漂移</li>
<li><strong>多协议代理</strong> ：统一 <code>OpenAI/Anthropic/Gemini</code> 格式，支持 <code>SSE</code> 流式、<code>thoughtSignature</code> 与工具链兼容</li>
<li><strong>Token Saver 优化</strong> ：后台任务（如标题/摘要）自动降级到免费模型，单会话节省数千 Token</li>
<li><strong>多模态支持</strong> ：Imagen 3 图像生成 + Base64 视觉输入，高负载处理（100MB+）</li>
<li><strong>错误自愈</strong> ：自动处理 429/400/401，指数退避、重试、Schema 清洗与空输出补偿</li>
<li><strong>本地隐私部署</strong> ：SQLite 加密存储、127.0.0.1 默认绑定、Docker headless + Web UI，支持全局代理</li>
</ul>
<p>💡 <strong><code>Antigravity-Manager</code></strong> 适合重度使用 <code>Claude CLI/Codex CLI</code> 或多模型 <code>Agent</code> 的开发者与团队，能大幅提升稳定性、节省配额成本，尤其在高并发、多轮对话、工具调用场景下价值巨大。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flbjlaq%2FAntigravity-Manager" target="_blank" title="https://github.com/lbjlaq/Antigravity-Manager" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
<hr/>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fclaude-plugins-official" target="_blank" title="https://github.com/anthropics/claude-plugins-official" ref="nofollow noopener noreferrer"><code>claude-plugins-official</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>6.2K+</code></strong></p>
<p><strong>🔌 <code>Anthropic</code> 官方管理的 <code>Claude Code</code> 高质量插件目录</strong></p>
<p><strong><code>claude-plugins-official</code></strong> 是 <code>Anthropic</code> 官方维护的 <code>Claude Code</code> 插件市场，汇集内部开发（<code>Anthropic</code> 自制）和外部优质插件（伙伴/社区贡献），提供标准化结构（plugin.json、.mcp.json、commands、agents、skills），让开发者轻松扩展 <code>Claude Code</code> 的功能，如自定义命令、<code>Agent</code> 工作流、<code>MCP</code> 服务器集成等。</p>
<p>仓库分为 /plugins（官方插件）和 /external_plugins（第三方），包含示例实现、开发规范、提交表单，已成为 <code>Claude Code</code> 生态的核心入口，支持通过 <code>/plugin install {name}@claude-plugin-directory</code> 或 Discover 界面一键安装，强调信任与安全（<code>Anthropic</code> 不控制插件内容）。</p>
<ul>
<li><strong>官方插件集合</strong> ：<code>Anthropic</code> 自研的高质量插件示例，覆盖常见扩展需求</li>
<li><strong>外部优质插件</strong> ：社区/伙伴贡献，经过质量审核的第三方插件</li>
<li><strong>标准化结构</strong> ：统一 plugin.json + 可选 <code>MCP</code> 配置、<code>commands</code>、<code>agents</code>、<code>skills</code></li>
<li><strong>一键安装</strong> ：<code>Claude Code</code> 内 <code>/plugin install</code> 或 Discover 浏览器直接添加</li>
<li><strong>开发参考</strong> ：包含 example-plugin、spec 规范、template 文件夹，便于自定义</li>
<li><strong>提交通道</strong>：通过官方表单提交外部插件，加入市场</li>
</ul>
<p>💡 <strong><code>claude-plugins-official</code></strong> 适合所有 <code>Claude Code</code> 用户，尤其是想快速扩展 <code>slash</code> 命令、<code>Agent</code> 能力、工具集成或 <code>MCP</code> 服务器的开发者，是官方生态起点，安装即用、社区活跃。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fclaude-plugins-official" target="_blank" title="https://github.com/anthropics/claude-plugins-official" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
<hr/>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fremotion-dev%2Fremotion" target="_blank" title="https://github.com/remotion-dev/remotion" ref="nofollow noopener noreferrer"><code>remotion</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>34.4K+</code></strong></p>
<p><strong>🎥 用 <code>React</code> 代码化生成视频的框架</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9e61d50f4e4433480caad90a7d66372~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692466&amp;x-signature=%2FOCDm%2F6X6xCkBBRVBZAndY5UITk%3D" alt="remotion" loading="lazy"/></p>
<p><strong><code>remotion</code></strong> 是一个强大的开源框架，让开发者完全用 <code>React</code> 组件、CSS、Canvas、SVG、WebGL 等 Web 技术，以代码形式创建高质量、可编程视频。支持参数化（传入数据动态渲染）、组件复用、Fast Refresh 实时预览、数学/算法驱动的特效，彻底颠覆传统视频编辑工具（如 After Effects）的门槛。</p>
<p>它将视频视为「<code>React</code> 应用」，支持 SSR、SSR 预渲染、Lambda 渲染、音频波形可视化、字幕生成、动态模板等生产级能力，已被广泛用于 GitHub Unwrapped、Fireship 等高影响力视频项目，以及营销、数据可视化、教育内容生成场景。</p>
<ul>
<li><strong><code>React</code> 组件化视频</strong> ：复用组件、组合、状态管理，像写网页一样写视频</li>
<li><strong>Web 技术全栈</strong> ：CSS 动画、Canvas/WebGL、SVG、Three.js 等任意 Web 效果</li>
<li><strong>参数化与动态</strong> ：传入 props/数据实时渲染个性化视频（如年终总结、报告）</li>
<li><strong>实时预览与 Fast Refresh</strong> ：修改代码即刻看到视频变化，开发体验极致</li>
<li><strong>云渲染支持</strong> ：集成 Lambda/Remotion Render Farm，大规模批量生成</li>
</ul>
<p>💡 <strong><code>remotion</code></strong> 适合前端开发者、内容创作者、数据可视化工程师、营销团队，尤其在需要自动化、个性化、代码驱动视频（如社交媒体短片、数据故事、产品 Demo）的场景下，能大幅提升效率与创意自由度，社区反馈「视频制作从艺术变成编程」。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fremotion-dev%2Fremotion" target="_blank" title="https://github.com/remotion-dev/remotion" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
<hr/>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FVectifyAI%2FPageIndex" target="_blank" title="https://github.com/VectifyAI/PageIndex" ref="nofollow noopener noreferrer"><code>PageIndex</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>12.5K+</code></strong></p>
<p><strong>📑 无向量数据库的推理式 <code>RAG</code> 框架：模拟人类专家的文档导航</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3713603190c34251af31722a5f110f84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692466&amp;x-signature=IeLgd1xxWCX%2FLIJpZNfFEkoWaUc%3D" alt="PageIndex-Workflow" loading="lazy"/></p>
<p><strong><code>PageIndex</code></strong> 是一个创新的开源 <code>RAG</code> 系统，完全抛弃向量数据库和传统分块策略，通过构建文档的层次化树状索引（TOC-like structure），结合 <code>LLM</code> 的多步推理与树搜索，实现像人类专家一样精准、可追溯地检索长文档内容。</p>
<p>它将文档组织成自然章节树，<code>LLM</code> 通过模拟「翻书查阅」过程逐步定位最相关部分，支持 PDF 和 Markdown 等格式，在 FinanceBench 等基准上达到 98.7% 的 <code>SOTA</code> 准确率，提供极高的可解释性（带页码/章节引用）和上下文准确性，已成为追求高精度、无需嵌入向量、完全可解释 <code>RAG</code> 的首选方案。</p>
<ul>
<li><strong>零向量数据库</strong>：纯结构 + 推理检索，无需 embedding 或向量存储</li>
<li><strong>无分块处理</strong>：保留文档自然章节与层次结构，避免信息割裂</li>
<li><strong>类人类树搜索</strong>：多步推理 + 树遍历，模拟专家逐级定位关键信息</li>
<li><strong>高可解释性</strong>：检索路径完全可追溯，输出带精确页码/章节引用</li>
<li><strong>层次树索引</strong>：自动从文档生成 TOC 式树状结构，支持长文档</li>
<li><strong>SOTA 性能</strong>：FinanceBench 基准 98.7% 准确率，远超传统 <code>RAG</code></li>
</ul>
<p>💡 <strong><code>PageIndex</code></strong> 适合处理长篇复杂文档的专业人士（如金融分析、法律研究、技术手册、监管报告），以及对检索准确性、可解释性、本地化部署有高要求的开发者与企业，尤其在传统向量 <code>RAG</code> 准确率瓶颈或隐私敏感场景下价值巨大。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FVectifyAI%2FPageIndex" target="_blank" title="https://github.com/VectifyAI/PageIndex" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
<hr/>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLissy93%2Fweb-check" target="_blank" title="https://github.com/Lissy93/web-check" ref="nofollow noopener noreferrer"><code>Web-Check</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>31.7K+</code></strong></p>
<p><strong>🕵️‍♂️ <code>All-in-one OSINT</code> 工具：一站式分析任意网站的内部结构</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92d1ecf362ea47c9a712263c9f7a1a04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692466&amp;x-signature=RTwkhEjrtumXxO0S1z0aoYE4x%2BA%3D" alt="web-check" loading="lazy"/></p>
<p><strong><code>web-check</code></strong> 是一个开源的综合 OSINT（开源情报）仪表板，只需输入任意网站 URL，就能快速获取其服务器架构、安全配置、潜在攻击面和技术栈等信息。项目将 30+ 种检查整合到一个直观界面，帮助安全研究者、系统管理员、开发者快速侦测网站指纹、追踪器、弱点与基础设施细节。</p>
<p>它支持自托管（Docker / Netlify / Vercel 一键部署），完全免费、无需 API 密钥即可运行核心功能（可选集成 Shodan、VirusTotal 等增强威胁情报），强调隐私友好与可解释性，已成为安全审计、渗透测试前期侦察、网站合规检查的常用神器。</p>
<ul>
<li><strong>IP 与 DNS 情报</strong> ：解析 A/MX/NS/CNAME/TXT 记录，揭示网络基础设施</li>
<li><strong>SSL/TLS 证书链</strong> ：检查证书有效性、颁发机构、弱加密与过期风险</li>
<li><strong>HTTP 头与安全头</strong> ：分析响应头、HSTS/CSP/X-Frame-Options 等安全策略</li>
<li><strong>Cookies 与追踪器</strong> ：检测跟踪 cookie、第三方脚本与隐私泄露点</li>
<li><strong>技术栈指纹</strong> ：自动识别框架、CMS、服务器、库（如 Wappalyzer 风格）</li>
<li><strong>威胁与声誉检查</strong> ：对比恶意软件/钓鱼列表、端口扫描与防火墙探测</li>
</ul>
<p>💡 <strong><code>web-check</code></strong> 适合安全研究者、红队/蓝队、网站运维人员以及对隐私与安全敏感的开发者，尤其在快速评估第三方网站风险、渗透测试前期侦察或合规审计场景下极具生产力，社区活跃、部署简单。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLissy93%2Fweb-check" target="_blank" title="https://github.com/Lissy93/web-check" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
<hr/>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbytedance%2FUI-TARS-desktop" target="_blank" title="https://github.com/bytedance/UI-TARS-desktop" ref="nofollow noopener noreferrer"><code>UI-TARS-desktop</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>25.2K+</code></strong></p>
<p><strong>🖥️ 字节开源的多模态 <code>GUI Agent</code> 桌面应用：自然语言操控电脑与浏览器</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b64b8473f5fd45929d2cde9c869a4b42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692466&amp;x-signature=SvQ0gDZyWOCCxTak0C9%2FEA3Dawk%3D" alt="ui-tars-desktop-cli" loading="lazy"/></p>
<p><strong><code>UI-TARS-desktop</code></strong> 是 <code>ByteDance</code> 推出的开源多模态 <code>AI Agent</code> 桌面应用，基于 <code>UI-TARS</code> 视觉语言模型，让用户通过自然语言直接操控本地电脑或远程浏览器，实现鼠标点击、键盘输入、拖拽、滚动等真实人类交互，支持完全本地运行、隐私安全。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a54734c14327425e90f916aea4cd123a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692466&amp;x-signature=23JZ6TrjxEm9106TuKbQxwgUUyw%3D" alt="ui-tars-desktop-web-ui" loading="lazy"/></p>
<p>它提供 <code>CLI</code> + <code>Web UI</code> 双入口、跨平台支持（Windows/macOS/浏览器），内置 Remote Computer/Browser Operator（免配置免费），结合 <code>MCP</code> 协议无缝集成多模态模型，已成为本地 <code>GUI</code> 自动化、跨设备任务执行、生产力工具的热门选择，社区活跃、迭代迅速。</p>
<ul>
<li><strong>自然语言 <code>GUI</code> 控制</strong> ：纯语言指令操控鼠标、键盘、滚动、拖拽等操作</li>
<li><strong>视觉识别与截屏</strong> ：实时理解屏幕内容，精准定位元素</li>
<li><strong>跨平台 + 远程操作</strong> ：支持 Windows/macOS、本地与远程电脑/浏览器</li>
<li><strong>实时反馈与状态</strong> ：<code>Web UI</code> 实时显示 <code>Agent</code> 执行过程与结果</li>
<li><strong>完全本地隐私</strong> ：所有处理本地运行，无需上传数据</li>
<li><strong>一键 <code>CLI</code> 启动</strong> ：<code>npx</code> 或全局安装即可运行，支持多种模型提供商</li>
</ul>
<p>💡 <strong><code>UI-TARS-desktop</code></strong> 适合需要 <code>GUI</code> 自动化的开发者、测试工程师、重度桌面用户以及追求隐私的 <code>AI Agent</code> 爱好者，尤其在复杂多步骤任务（如配置软件、网页操作、游戏交互）场景下，能显著提升效率，是多模态桌面 <code>Agent</code> 的代表作。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbytedance%2FUI-TARS-desktop" target="_blank" title="https://github.com/bytedance/UI-TARS-desktop" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
<hr/>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvirattt%2Fdexter" target="_blank" title="https://github.com/virattt/dexter" ref="nofollow noopener noreferrer"><code>Dexter</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>9.8K+</code></strong></p>
<p><strong>💹 自主金融研究 <code>Agent</code>：思考、规划、验证的全链路深度分析</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dace65f8517f4396a0e2b6b6f2dc31e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692466&amp;x-signature=2xYNYAD2Slz3AOkgs%2F%2BpJTCKkMs%3D" alt="dexter" loading="lazy"/></p>
<p><strong><code>dexter</code></strong> 是一个开源的自主 <code>AI Agent</code>，专为复杂金融研究设计，能像人类研究员一样思考、规划、执行并自我验证。它将高难度金融问题拆解为结构化步骤，使用实时市场数据（财报、现金流、股价等）进行分析，最终输出可信、数据驱动的结论，被誉为「金融领域的 <code>Claude Code</code>」。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1335b01cb054b23b9b77bbb3e1874d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692466&amp;x-signature=E4cjhFkwYtf9GKCTx994ckrnnT0%3D" alt="dexter-agent" loading="lazy"/></p>
<p>项目采用任务规划 + 自反思 + 工具执行架构，支持 <code>OpenAI</code> 模型、<code>Financial Datasets API</code>、<code>Exa/Tavily</code> 搜索，提供内置安全机制（循环检测、步数限制）、LangSmith 评估与 LLM-as-judge 打分，已成为金融分析师、量化开发者、投资研究者快速构建可信 <code>AI</code> 金融助手的首选方案。</p>
<ul>
<li><strong>智能任务规划</strong> ：自动将复杂查询分解为可执行的研究步骤</li>
<li><strong>自主工具执行</strong> ：实时调用财报、股价、搜索等工具完成分析</li>
<li><strong>自我验证与迭代</strong> ：检查输出质量、发现错误并自动优化结果</li>
<li><strong>实时金融数据</strong> ：直接接入收入表、资产负债表、现金流量表等</li>
<li><strong>安全与调试友好</strong> ：内置循环检测、步数限制、JSONL scratchpad 日志</li>
<li><strong>评估套件</strong> ：开源金融问题测试集 + LangSmith + LLM-as-judge 评分</li>
</ul>
<p>💡 <strong><code>dexter</code></strong> 适合金融分析师、量化研究员、投资爱好者以及想构建领域专精 <code>Agent</code> 的开发者，尤其在需要高可信度、数据驱动的股票/公司深度研究场景下，能显著提升效率与结论可靠性，社区反馈「真正能思考的金融 <code>AI</code>」。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvirattt%2Fdexter" target="_blank" title="https://github.com/virattt/dexter" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
<hr/>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2FBitNet" target="_blank" title="https://github.com/microsoft/BitNet" ref="nofollow noopener noreferrer"><code>BitNet</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>27.6K+</code></strong></p>
<p><strong>⚡ 微软官方 <code>1-bit LLM</code> 推理框架：极致高效的 <code>CPU/GPU</code> 部署</strong></p>
<p><strong><code>BitNet</code></strong> 是 <code>Microsoft</code> 发布的官方推理引擎（<code>bitnet.cpp</code>），专为 <code>1.58-bit</code>（三值权重）<code>LLM</code> 设计，提供高度优化的内核，实现 <code>CPU</code> 和 <code>GPU</code> 上快速、无损推理。项目基于 <code>llama.cpp</code> 构建，引入自定义并行内核与可配置 tiling，支持大规模边缘设备部署，是当前最前沿的低比特 <code>LLM</code> 高效推理方案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d22344e041d4c95ad6ce70e21c56541~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692466&amp;x-signature=grn%2BmsSq0XJ9gWGNNP2ekQJ8dBI%3D" alt="bitnet-performance" loading="lazy"/></p>
<p>它能让 <code>100B</code> 级 <code>BitNet b1.58</code> 模型在单 <code>CPU</code> 上以 <code>5–7 tokens/s</code> 运行（人类可读速度），在 <code>ARM/x86 CPU</code> 上带来 <code>1.37x–6.17x</code> 加速，同时降低 55%–82% 能耗，支持 <code>embedding</code> 量化进一步提速，已成为追求本地化、低功耗、大模型部署的开发者与研究者的首选。</p>
<ul>
<li><strong>极致 <code>CPU</code> 推理</strong> ：<code>100B</code> 模型单 <code>CPU 5–7 t/s</code>，<code>ARM/x86</code> 加速 <code>1.37x–6.17x</code></li>
<li><strong><code>GPU</code> 优化内核</strong> ：官方 <code>GPU</code> 支持，显著提升吞吐与能效</li>
<li><strong><code>1.58-bit</code> 无损推理</strong> ：三值权重 + 量化激活，保持高质量输出</li>
<li><strong>能耗大幅降低</strong> ：55.4%–82.2% 能耗节省，适合边缘/移动设备</li>
<li><strong>丰富模型兼容</strong> ：支持 <code>BitNet-b1.58-2B-4T</code>、<code>Llama3-8B-1.58</code>、<code>Falcon</code> 系列等</li>
<li><strong>易用部署</strong> ：<code>CMake</code> 构建 + <code>Python</code> 脚本转换/运行，集成 <code>GGUF</code> 格式</li>
</ul>
<p>💡 <strong><code>BitNet</code></strong> 适合想在普通硬件上运行百亿级 <code>LLM</code> 的开发者、研究者、企业，尤其在无 <code>GPU</code>、本地隐私、低功耗、边缘推理场景下，能彻底改变大模型部署方式，是 <code>1-bit LLM</code> 时代的核心基础设施。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2FBitNet" target="_blank" title="https://github.com/microsoft/BitNet" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
<h3 data-id="heading-10">结论</h3>
<p>2026 年 1 月的榜单，给我们非常清晰的信号：</p>
<ul>
<li><strong>本地化 + 隐私优先</strong> 已彻底成为主流，<code>OpenClaw</code>、<code>UI-TARS-desktop</code> 等项目让「<code>AI</code> 跑在你自己的设备上」变成日常现实</li>
</ul>

<ul>
<li><strong><code>Claude</code> 生态</strong> 正在以极快速度闭环，官方技能仓库 + 插件市场 + 智能调度工具相继到位，<code>Claude Code</code> 的生产力正在指数级释放</li>
<li><strong>多模态与高效推理</strong> 双双进入成熟阶段：代码生成视频、无向量高精度 <code>RAG</code>、<code>1-bit</code> 大模型推理，都在用最实际的方式降低门槛、提升效率</li>
</ul>
<p>这十个项目不再是酷炫的玩具，而是<strong>可以立刻装进工作流、立刻产生生产力</strong>的武器。2026 年刚开始，开源社区就用行动告诉我们：<strong>未来已来，而且它就跑在你的电脑和手机里</strong>。</p>
<p>📌 喜欢哪个就去点个 <code>Star</code>，每一个 <code>Star</code> 都是对开源社区最大的支持！</p>
<p>📬 欢迎收藏、转发，也欢迎在评论区安利你心目中的 <strong>2026 年 2 月黑马项目</strong>～</p>
<hr/>
<h3 data-id="heading-11">往期推荐</h3>
<p>喜欢本期的热门项目？以下是一些值得一读的往期精彩内容：</p>
<ol>
<li><a href="https://juejin.cn/post/7434159897197133836" target="_blank" title="https://juejin.cn/post/7434159897197133836">🚀 2024年11月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7434159897197133836" target="_blank" title="https://juejin.cn/post/7434159897197133836">🚀 2024年12月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7461822837532213267" target="_blank" title="https://juejin.cn/post/7461822837532213267">🚀 2025年01月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7475237484085346355" target="_blank" title="https://juejin.cn/post/7475237484085346355">🚀 2025年02月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7486316823253565474" target="_blank" title="https://juejin.cn/post/7486316823253565474">🚀 2025年03月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7503762078386700298" target="_blank" title="https://juejin.cn/post/7503762078386700298">🚀 2025年04月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7508914438659735589" target="_blank" title="https://juejin.cn/post/7508914438659735589">🚀 2025年05月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7525688196605722670" target="_blank" title="https://juejin.cn/post/7525688196605722670">🚀 2025年06月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7533169614206861339" target="_blank" title="https://juejin.cn/post/7533169614206861339">🚀 2025年07月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7543830033606246419" target="_blank" title="https://juejin.cn/post/7543830033606246419">🚀 2025年08月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7555056825693634601" target="_blank" title="https://juejin.cn/post/7555056825693634601">🚀 2025年09月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7567208390368198696" target="_blank" title="https://juejin.cn/post/7567208390368198696">🚀 2025年10月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7579889969986502707" target="_blank" title="https://juejin.cn/post/7579889969986502707">🚀 2025年11月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7591079707698315274" target="_blank" title="https://juejin.cn/post/7591079707698315274">🚀 2025年12月 GitHub 十大热门项目排行榜 🔥</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[堪称外挂的 Claude Code 配置神器，在 GitHub 上杀疯了。]]></title>    <link>https://juejin.cn/post/7602158221851607055</link>    <guid>https://juejin.cn/post/7602158221851607055</guid>    <pubDate>2026-02-03T03:05:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602158221851607055" data-draft-id="7602158221851541519" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="堪称外挂的 Claude Code 配置神器，在 GitHub 上杀疯了。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-02-03T03:05:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            堪称外挂的 Claude Code 配置神器，在 GitHub 上杀疯了。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:05:23.000Z" title="Tue Feb 03 2026 03:05:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这个叫 everything-claude-code 的开源项目太顶了。开源没几天就 3.5 万的 Star 了。。。</p>
<p>先看它的简介，上面写的是：完整的 Claude Code 配置合集——Agent、Skill、Hook、快捷命令、规则、MCPs。来自 Anthropic 黑客马拉松获胜者的经过实战检验的配置。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be4e2c5b7c29434eb21f1c648dae2697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692722&amp;x-signature=JOgJLu%2FjaigVycfoljj0Pa%2Bdfoo%3D" alt="图片" loading="lazy"/></p>
<p>重点是：来自 Anthropic 黑客马拉松获胜者的经过实战检验。</p>
<p>这个开源项目的作者是 Affaan Mustafa，是一位超级资深的 AI 开发者。</p>
<p>这个开源项目是它长达 10 个月的高强度使用 Claude Code 经验总结而来的。而且它用这套配置赢得了 Anthropic x Forum Ventures 黑客松 Hackathon 的冠军。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15eb428f6c814debb01ac116e6d5f148~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692722&amp;x-signature=bcZl8YYF1wr2Un%2FdWjcp3AwB570%3D" alt="图片" loading="lazy"/></p>
<p>在黑客松比赛中，时间很紧迫，通常只有一天。</p>
<p>他们在短短 8 小时 内，完全依靠 Claude Code 这一工具从零开发了一个 AI 驱动的客户发现平台：zenith.chat。</p>
<p>并成功进行了现场演示，最后获得了冠军儿🏆。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52d1d9f06eb64f2cafa1812a9a53bafa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692722&amp;x-signature=1X1Y5Bwp0TBWi6qkqSR5jNsA868%3D" alt="图片" loading="lazy"/></p>
<p>01</p>
<p><strong>开源项目简介</strong></p>
<p>everything-claude-code 是一个为 Claude Code 打造的完整配置工具箱，包括：可以直接用的 agents、skills、 hooks、快捷命令、 规则、MCP 配置。</p>
<p>它不是提示词合集，而是一个把 Claude Code 从 ChatBot 变成资深工程师的、实战检验过的完整开发工作流与配置套件。</p>
<p>说白了，就是能把你的 Claude Code 武装到牙齿。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b2042bbe3fd4ff8b36699e9aaee1f26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692722&amp;x-signature=3RIxa3kyPXW67tebPuSLNJkp6BU%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash">开源地址：github.com/affaan-m/everything-claude-code
</code></pre>
<p>看它这套开源项目架构，对于黑客松比赛酒友有针对性的战术。</p>
<p>① 合理使用 Agents：</p>
<p>他们没有把 Claude 仅仅当作一个 ChatBot，而是利用项目中的 Agents 配置，把 Claude 分裂成不同的角色：</p>
<p>Planner Agent：负责在写代码前由 AI 自动生成架构图和实施计划，避免了盲目编码导致的返工，在黑客松中这个很重要。</p>
<p>Code Reviewer Agent：在代码提交前自动审查，确保演示时不会因为低级错误，比如语法错误、未捕获的异常啥的，导致 Demo 失败。</p>
<p>②克服上下文腐烂：</p>
<p>在长达 8 小时的连续 Coding 中，普通 AI 往往会忘记之前的设定。</p>
<p>Affaan 利用这套配置中的 Skills 和 Rules，强制 AI 始终遵循特定的 TDD测试驱动开发模式，保持了代码逻辑的一致性，直到比赛结束。</p>
<p>③ MCP的使用：</p>
<p>他们通过配置 MCP 工具，比如 GitHub MCP, Supabase MCP等。</p>
<p>让 Claude 直接操作数据库和代码仓库。这意味着他们几乎不需要手动去数据库建表或在 IDE 之间来回切换，极大缩短了开发周期。</p>
<p>学习指南</p>
<p>当然只看这个开源项目学不到精髓，作者写了两篇文章，一定要去看看：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3e8bf66a036468791018c903612e529~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692722&amp;x-signature=2wSo6XjBa6o4hsvt1kraJ9e1rww%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-ruby" lang="ruby">指南一：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/x.com/affaanmustafa</span><span class="hljs-regexp">/status/</span><span class="hljs-number">2012378465664745795</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c52453ef063149f2819a5f764a22d5d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692722&amp;x-signature=j4KPlEoIlqoTK7W7%2BC6lTG%2BJ4l4%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-ruby" lang="ruby">指南二：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/x.com/affaanmustafa</span><span class="hljs-regexp">/status/</span><span class="hljs-number">2012378465664745795</span>
</code></pre>
<p>02</p>
<p><strong>如何使用</strong></p>
<p>在 Claude Code 中添加此仓库为插件市场：</p>
<pre><code class="hljs language-bash" lang="bash">/plugin marketplace add affaan-m/everything-claude-code
</code></pre>
<p>安装插件：</p>
<pre><code class="hljs language-css" lang="css">/plugin install everything-claude-<span class="hljs-selector-tag">code</span><span class="hljs-keyword">@everything-claude-code</span>
</code></pre>
<p>安装完成后，立即获得仓库中定义的所有 commands / agents / skills / hooks，开箱即用</p>
<p>在新项目启动阶段：可以先用 /plan 命令调用 planner/architect 等 agents，帮助梳理目标功能、选择技术栈并划分模块边界。</p>
<p>同时启用 coding-style.md、security.md、testing.md 等规则文件，把团队统一的编码规范、安全要求和测试标准固化下来，让后续所有对话和生成代码都在同一工程轨道上运行。</p>
<p>在具体开发过程中，采用 TDD + 验证循环的方式：通过 /tdd 命令让 Claude 按 RED → GREEN → REFACTOR → VERIFY 的流程推进开发。</p>
<p>用 /verify 执行实现验证、对比和边界分析，在关键里程碑使用 /checkpoint 记录思路快照和当前状态，既方便回滚，也方便日后回顾设计决策。</p>
<p>在质量与长期维护方面，日常多用 /code-review 命令，请专门的 review/safety agent 进行代码与安全审查，再配合 hooks 自动执行如清理 console.log、生成会话总结等后台任务。</p>
<p>对于中长期项目，则结合 continuous-learning/ 和 strategic-compact/ 相关 skills 与 hooks，让 Claude 持续积累项目记忆，并在上下文接近上限前做有策略的压缩，保证长期协作的连贯性与效率。</p>
<p>你可以把这个开源项目作为一个<strong>生产级起步模板，高效用 Claude Code 搭建严肃的软件工程工作流，在极短时间内产出可 demo 的产品。</strong> **<strong>不需要自己从 0 写 agents / skills / hooks。</strong>*# 堪称外挂的 Claude Code 配置神器，在 GitHub 上杀疯了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[祛魅！全网都在吹的Skills，究竟是个啥？]]></title>    <link>https://juejin.cn/post/7602161364892270592</link>    <guid>https://juejin.cn/post/7602161364892270592</guid>    <pubDate>2026-02-03T03:05:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602161364892270592" data-draft-id="7602146335215812648" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="祛魅！全网都在吹的Skills，究竟是个啥？"/> <meta itemprop="keywords" content="Coze"/> <meta itemprop="datePublished" content="2026-02-03T03:05:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吾鳴"/> <meta itemprop="url" content="https://juejin.cn/user/3683842894347076"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            祛魅！全网都在吹的Skills，究竟是个啥？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3683842894347076/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吾鳴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:05:56.000Z" title="Tue Feb 03 2026 03:05:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是吾鳴。专注于分享提升工作与生活效率的工具，无偿分享AI领域相关的精选报告，持续关注AI的前沿动向。</p>
<p>最近Skills非常火爆，网上可以看到很多的文章在介绍它，后台也有挺多朋友问可否来一篇文章讲讲Coze Skills？我们先来了解一下Skills，然后再来看看Coze Skills。</p>
<p>Skills这个技术概念很新，大家可能比较陌生，但是如果我说Tools，如果有了解AI应用开发的，或许就会“哦......”。</p>
<p>Skills是由Anthropic公司在去年10月份推出来的技术概念，原本推出这个Skills是为了给Claude扩展能力用的(和Open AI 推出Tools的目的一样)，但是Skills推出来之后，使用者们都觉得异常的好用，所以就一发不可收拾，短短的几个月就火了起来。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4408c0725c64310a99496a0afc136a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692756&amp;x-signature=WHP6dmXg5PTHiJ1RmmMTfT2%2F8Uw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">Skills是什么？</h2>
<p>通俗点来理解，我们可以把它理解成是一个可以复用的“AI技能包”，当AI需要去完成某项任务的时候，AI能够像翻阅操作手册一样，自动的去加载相关的Skills，然后选择合适的Skills来完成任务。</p>
<p>看着好像和Tools很像，但是它比Tools强的地方是，Skills并非一次性完全加载，而是可以层层按需加载Skills中的内容，AI先加载Skills的指令文件（约100个token，打比方），合适再加载其他资源（约3000个token，打比方），这样的好处就是可以让AI执行任务的时候消耗的token做到尽可能的少。</p>
<p>一个典型的Skills，它包含核心指令文件（SKILL.md）、脚本（Scripts）和资源（references）文件夹。</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill/
├── SKILL.md          <span class="hljs-comment"># 必需的文件: 指令 + 元数据</span>
├── scripts/          <span class="hljs-comment"># 可选文件: 可执行的代码</span>
├── references/       <span class="hljs-comment"># 可选文件: 参考文档</span>
└── assets/           <span class="hljs-comment"># 可选文件: 模板，其他资源</span>
</code></pre>
<p>关于Skills规范的更详细的描述，感兴趣的朋友可以看看官方的定义，<a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io%2Fhome" target="_blank" title="https://agentskills.io/home" ref="nofollow noopener noreferrer">agentskills.io/home</a>。</p>
<h2 data-id="heading-1">Skills和其他概念什么区别？</h2>
<p><strong>1、Skills和提示词：</strong> 提示词更多的是偏向于对AI的行为的约束，比如限定AI的角色、任务、动作等，更多的像是对AI的口头指导，AI下次就遗忘了。</p>
<p>Skills则更加的系统化，是一个小闭环，里面包含了对这个技能的描述、说明等元数据，有提示词、脚本、资源等，结构会更清晰，当你对某个提示词在反复的复制黏贴的时候，就可以考虑把它封装成一个技能。</p>
<p><strong>2、Skills和插件：</strong> 插件是对外部的API调用或者是处理某个任务的实际操作；而Skills除了能包含插件所拥有的功能之外，它还有一份类似于操作指导手册的元数据，可以指导AI应该如何使用它。</p>
<p><strong>3、Skills和工作流：</strong> 工作流像是预设好的一条工厂流水线，里面的每一个步骤都是非常固定，输入了什么原材料，那么就会输出预想的产品；而Skills则是专业的工具、知识合集，它更多的像是某类技能的指导手册，指导AI根据手册自主决策怎么执行。</p>
<p><strong>4、Skills和智能体：</strong> 智能体是有自主能力、会思考如何执行的机器人，而Skills则像是机器人眼睛上的摄像头，可以让机器人知道应该如何打开它。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/871c53d5a2384596b4f192b7cb6a413b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692756&amp;x-signature=BHwdRQplLcLzbMUjigSXutrxwX0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">Coze Skills如何？</h2>
<p>Coze中的技能其实就是follow了Anthropic推出来的这套规范，要了解Coze Skills如何制作的，可以更多的去好好的了解Anthropic官方的这套规范即可，按照包里面的内容基本都遵守。</p>
<p>Coze走的比较前的是，它把Anthropic给产品化了，这让原本只能在Claude侧才能玩转的Skills直接让人们在它的产品页面上点点点、问问问就可以生成一个专属的Skills。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e85fccbbc47402f89f577276db0936f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692756&amp;x-signature=hlA0Ui4xc7vS3mW10OTLlk%2B6axU%3D" alt="" loading="lazy"/></p>
<p>Coze上的Skills有两种，第一种就是你可以直接在技能框中输入你的需求，通过自然语言的方式来创建一个技能。</p>
<p>比如，“我想创建一个[功能名称]的 Skill，用于[解决什么问题]，当用户[触发场景]时使用，输出[期望格式和内容]。”，就是套用这样的一个提示词模板，就可以让扣子编程给你生成一个技能。</p>
<p>第二种生成技能的方式，就是上传技能包的方式，就是按照文章开头部分给大家介绍的Skills的规范打包好Skills，然后直接上传，就可以得到一个你的技能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/726349a750c0452e94fca4f43cdc3b8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692756&amp;x-signature=T6TAGWptnHp40ziJOSrpN9H%2Fcyc%3D" alt="" loading="lazy"/></p>
<p>生成好你的技能，紧接着就是部署发布了，这个和我之前发过的使用扣子编程的流程一致，这部分流程不懂的可以看看之前文章参考——《无代码时代真来了？扣子（Coze）一句话生成工作流》。</p>
<p>当你做好了一个技能之后，可以怎么样去使用这个技能？只需要在对话框中直接@你的技能，给它提供信息即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/934b21d4d2534c6685c18af225182fb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692756&amp;x-signature=av2F8NIWMs4wRq1A%2FJAwc2hd17w%3D" alt="" loading="lazy"/></p>
<p>Coze之所以吸引了这么多人到上面开发Skills，主要是因为它的技能商店，就是你把你的擅长的某一个行业的专业知识封装成一个技能之后，你可以直接把你的技能上架到节能商店，上架到技能商店之后，别人可以直接使用你的技能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79ab68e21ec44bccba5f31dbb9988caa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692756&amp;x-signature=1U%2F2Bvj3e4fcB9BYWr%2BRluQAny0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">去哪找好用的Skills？</h2>
<p>正所谓授人以鱼不如授人以渔，对于我们大部分想提高效率的人，那当然是拿来主义，使用现成的技能才是最爽的。</p>
<p>第一种方法，就是到Coze的官方技能商店上面去找，看到合适的技能，把它添加到你自己的技能中即可。</p>
<p>第二种方法，是从其他的网站上面去找，下面分享一些找能到现成Skill的一些网站。</p>
<p>1、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a> 这个是Anthropic的官方skills，干净，规范，想学习如何制作skills的可以从这个入手，不好的地方就是数量不多。</p>
<p>2、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FComposioHQ%2Fawesome-claude-skills" target="_blank" title="https://github.com/ComposioHQ/awesome-claude-skills" ref="nofollow noopener noreferrer">github.com/ComposioHQ/…</a> 分类很清晰，但是更新频率不高，平常也可以逛逛。</p>
<p>3、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftravisvn%2Fawesome-claude-skills" target="_blank" title="https://github.com/travisvn/awesome-claude-skills" ref="nofollow noopener noreferrer">github.com/travisvn/aw…</a> 这个是由社区成员Travis维护的一个技能列表，数量和质量都很不错，想看看有没有什么黑科技的可以逛逛。</p>
<p>4、<a href="https://link.juejin.cn?target=http%3A%2F%2Fskillsmp.com" target="_blank" title="http://skillsmp.com" ref="nofollow noopener noreferrer">skillsmp.com</a> 这个目前skills的体量最大，通过爬虫收集，更新频率杠杠滴，但是质量参差不齐，想要找灵感的可以多逛逛。</p>
<p>5、<a href="https://link.juejin.cn?target=http%3A%2F%2Fskills.sh" target="_blank" title="http://skills.sh" ref="nofollow noopener noreferrer">skills.sh</a> 这个是官方合作的高质量的前段和部署方向的可以看看。</p>
<h2 data-id="heading-4">总结</h2>
<p>Skills是一个很新的技术概念，但是能爆火肯定是有它的优点，比如消耗的token更少，能更好的扩展，但是这个玩意对模型的要求是比较高的，模型推理能力不强的话，很可能会找马得驴。</p>
<p>本文的分享就到这里，如果您觉得有收获的话，可以给个一键三连，您的鼓励是吾鳴持续输出的最大动力。有什么疑问也可以打在评论区，吾鳴会第一时间回复。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bcb5c1e75d04e249af2ec0bd5fc2b25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770692756&amp;x-signature=eFwZgQ1OqlSRID43LjmHUMROqYU%3D" alt="" loading="lazy"/></p>
<p>最近实战了一些扣子（Coze）工作流相关的案例，包含小红薯图文生成、爆款视频剪辑、办公提效等扣子案例，内附详细的教程和工作流安装包，感兴趣的朋友可以来个<strong>一键三连（必须动作）</strong> ，文章评论区评论“<strong>扣子案例</strong>”领取。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🧠 架构师的思维与开发准则]]></title>    <link>https://juejin.cn/post/7602259669730361371</link>    <guid>https://juejin.cn/post/7602259669730361371</guid>    <pubDate>2026-02-03T03:53:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602259669730361371" data-draft-id="7602259669730344987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🧠 架构师的思维与开发准则"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-03T03:53:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🧠 架构师的思维与开发准则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:53:37.000Z" title="Tue Feb 03 2026 03:53:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、脑力与思考习惯</h2>
<blockquote>
<p>行万里路，不如脑子想清楚。<br/>
回答要准确，要有预案、预估，让领导感受清楚。</p>
</blockquote>
<p>在开发与架构工作中，“脑力”并非只是技术熟练度，而是<strong>系统性思考</strong>的体现。面对复杂业务时，关键在于：</p>
<ul>
<li><strong>想清楚路径</strong>：在动手前理清问题边界与预期结果。</li>
<li><strong>提前做预案</strong>：为可能的变化、失败做准备。</li>
<li><strong>结果要传达清晰</strong>：让管理者与合作方听得懂、感受到“确定性”。</li>
</ul>
<p>好的工程师，不只是代码工人，而是能“带脑子上流水线”的人。</p>
<hr/>
<h2 data-id="heading-1">二、代入角色与把握度</h2>
<p>不同角色对应不同视角：</p>
<ul>
<li>🧩 <strong>开发者视角</strong>：关心任务拆解与实现效率。</li>
<li>🧱 <strong>架构师视角</strong>：关心结构可复用、扩展性与流转逻辑。</li>
<li>🚀 <strong>领导视角</strong>：希望看到清晰的目标、节奏与产出。</li>
</ul>
<p><strong>“把握度”就是在不同角色中切换思维的能力。</strong><br/>
懂得在细节与全局间来回切换，是从“熟练工”到“设计者”的关键一步。</p>
<hr/>
<h2 data-id="heading-2">三、架构师的高度：决定于胸怀与目标</h2>
<blockquote>
<p>心胸和目标决定架构师的高度。<br/>
基础组件是为了快速出成果，而核心是对业务的理解与流转。</p>
</blockquote>
<p>一个优秀的架构师必须在“效率”与“理解”之间找到平衡点：</p>
<ul>
<li><strong>基础组件</strong>：标准化输出，快速落地。</li>
<li><strong>业务理解</strong>：深入思考业务本质，找到真正可复用的逻辑单元。</li>
<li><strong>流转与思考模型</strong>：让代码、需求、产品在流转中保持一致性。</li>
</ul>
<p>架构从不是“高大上”的工程，而是一种<strong>持续理解业务、抽象共性</strong>的过程。</p>
<hr/>
<h2 data-id="heading-3">四、开发执行准则（Dev Roadmap）</h2>
<blockquote>
<p>从确定性出发，到高质量交付。</p>
</blockquote>























































<table><thead><tr><th align="left">阶段</th><th align="left">内容</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">a</td><td align="left">✅ 梳理确定性的需求</td><td align="left">识别信息不对称点，避免浪费</td></tr><tr><td align="left">b</td><td align="left">🧱 基础前端静态页面</td><td align="left">确定页面结构与初步样式</td></tr><tr><td align="left">c</td><td align="left">📦 前端基础数据结构</td><td align="left">定义核心 store 与命名规范</td></tr><tr><td align="left">d</td><td align="left">⚙️ 扩展业务数据结构</td><td align="left">适配真实业务流转</td></tr><tr><td align="left">e</td><td align="left">🔄 mock 数据</td><td align="left">模拟真实请求和交互</td></tr><tr><td align="left">f</td><td align="left">🎨 优化后的视图</td><td align="left">界面视觉优化与结构调整</td></tr><tr><td align="left">g</td><td align="left">🧩 完善交互</td><td align="left">骨架屏、逻辑交互——拒绝无效开发</td></tr><tr><td align="left">h</td><td align="left">🔗 对接真实 API</td><td align="left">核心字段名要与后端保持一致</td></tr><tr><td align="left">i</td><td align="left">🧪 自测收尾</td><td align="left">自动化或半自动化验证流程</td></tr></tbody></table>
<p>📌 <strong>原则</strong>：能跑的最小闭环版本 &gt; 空洞的“全功能计划”。<br/>
我们只做助推业务节奏的功能，不在边角功能迷失方向。</p>
<hr/>
<h2 data-id="heading-4">五、积累与沉淀</h2>
<ul>
<li>
<p><strong>日常积累模板</strong>：</p>
<ul>
<li>🗂 OA 系统模板：<code>oa-start-template</code></li>
<li>🛠 机器设备模板：<code>machine-start-template</code></li>
</ul>
</li>
<li>
<p><strong>学习路径</strong>：</p>
<ul>
<li>研究优秀作者推荐的框架或源码；</li>
<li>模仿优秀项目的组织结构；</li>
<li>累积可迁移的模式（Store、Route、Hook、Component）。</li>
</ul>
</li>
</ul>
<p>经验不在项目数量，而在你能否“提炼出下一个模板”。</p>
<hr/>
<h2 data-id="heading-5">六、Store：远不止全局状态</h2>
<blockquote>
<p>“一个 store 的意义，远远大于全局状态这个概念。”</p>
</blockquote>
<p>Store 连接着数据流、逻辑流与业务流，它的核心价值在于：</p>
<ul>
<li><strong>结构性</strong>：清晰的数据来源与归宿。</li>
<li><strong>灵活性</strong>：可应对多场景轻量分支逻辑。</li>
<li><strong>可扩展性</strong>：天然具备模块化接入能力。</li>
</ul>
<p>进一步，<strong>命名体系</strong>（文件命名、路由命名）也是隐形的架构力。<br/>
良好的命名习惯能决定一个项目的维护成本与生命周期。</p>
<hr/>
<h2 data-id="heading-6">七、设计与视觉：架构主题的美学表达</h2>
<p>系统风格不只是配色与样式，而是<strong>架构理念的视觉延伸</strong>。<br/>
建议根据团队主题色统一系统 UI 风格，与大厂体验对齐：</p>
<ul>
<li>
<p>🎨 对标风格：<strong>X / Google / GitHub</strong></p>
</li>
<li>
<p>✨ 实践方向：</p>
<ul>
<li>使用浅调主色 + 中性色背景；</li>
<li>保留呼吸空间与层级关系；</li>
<li>引入统一的阴影、圆角及状态反馈；</li>
<li>增强细节交互体验（hover、skeleton、loading）。</li>
</ul>
</li>
</ul>
<p>视觉的一致性，是专业感的第一印象。<br/>
页面之“美”，是架构理念的延伸。</p>
<hr/>
<h2 data-id="heading-7">🧭 结语</h2>
<blockquote>
<p>架构不是设计图，而是一种“思考的方式”。<br/>
思考清楚，比走得快更重要；<br/>
结构清晰，比功能多更持久。</p>
</blockquote>
<p>架构师应像导演，既掌控节奏，又理解每个角色的意义。<br/>
如此，团队才能在一条清晰的线上——<strong>聪明地前进</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[项目启动三阶段：从思到形]]></title>    <link>https://juejin.cn/post/7602303923140247602</link>    <guid>https://juejin.cn/post/7602303923140247602</guid>    <pubDate>2026-02-03T03:55:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602303923140247602" data-draft-id="7602252722373017651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="项目启动三阶段：从思到形"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-03T03:55:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            项目启动三阶段：从思到形
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:55:24.000Z" title="Tue Feb 03 2026 03:55:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">🚀 一、项目启动三阶段：从思到形</h2>
<p>项目启动可以拆成三个阶段，每个阶段对应上文的思维要点和执行准则。</p>
<h3 data-id="heading-1"><strong>阶段 1：思考与设计（脑力阶段）</strong></h3>
<blockquote>
<p>“行万里路，不如脑子想清楚。”</p>
</blockquote>
<p><strong>目标：确定性要大于行动速度。</strong></p>
<p><strong>关键输出：</strong></p>
<ul>
<li>✅ 业务目标清单（核心可交付是什么？）</li>
<li>✅ 技术选型 &amp; 模块划分（基于模板启动）</li>
<li>✅ 组件粒度 &amp; 数据流方向（决定架构风格）</li>
<li>✅ 风险点与预案（接口不确定、UI延迟设计等）</li>
</ul>
<p><strong>方法落地：</strong></p>
<ul>
<li>使用 <code>oa-start-template</code> 或 <code>machine-start-template</code> 创建基础目录结构。</li>
<li>先写出基础 <code>store</code> 结构与 <code>route</code> 命名方案。</li>
<li>output 一个简洁的架构草图或 README，让团队“心里有图”。</li>
</ul>
<hr/>
<h3 data-id="heading-2"><strong>阶段 2：构建与闭环（执行阶段）</strong></h3>
<blockquote>
<p>“快速出成果，但思考不放松。”</p>
</blockquote>
<p><strong>对应前文开发阶段</strong> a → i：</p>























































<table><thead><tr><th align="left">阶段</th><th align="left">实际应用</th><th align="left">关键产出</th></tr></thead><tbody><tr><td align="left">a</td><td align="left">梳理确定需求</td><td align="left">项目 README, todo, milestone</td></tr><tr><td align="left">b</td><td align="left">构建静态页面</td><td align="left">skeleton 页面或 Figma 转换样本</td></tr><tr><td align="left">c</td><td align="left">设计基础数据结构</td><td align="left">定义 <code>store</code> 和 <code>types.ts</code></td></tr><tr><td align="left">d</td><td align="left">扩展业务结构</td><td align="left">组织业务层数据流/adapter</td></tr><tr><td align="left">e</td><td align="left">构建 mock 服务</td><td align="left"><code>mock-server</code> / <code>msw</code> / <code>api sandbox</code></td></tr><tr><td align="left">f</td><td align="left">优化视图</td><td align="left">规范 UI 风格（主题色、按钮设计）</td></tr><tr><td align="left">g</td><td align="left">优化交互</td><td align="left">添加骨架屏、loading、状态提示</td></tr><tr><td align="left">h</td><td align="left">接入真实 API</td><td align="left">严格字段匹配，确保无隐患</td></tr><tr><td align="left">i</td><td align="left">自测收尾</td><td align="left">组件单测、E2E 或手动冒烟测试</td></tr></tbody></table>
<p><strong>落地技巧：</strong></p>
<ul>
<li>在前 3 天内形成一个可“演示”的雏形（mock 驱动展示）。</li>
<li>每次 merge 前保持自测闭环。</li>
<li>使用 Git 分支命名规范（<code>feature/xxx</code>、<code>fix/xxx</code>）。</li>
</ul>
<hr/>
<h3 data-id="heading-3"><strong>阶段 3：沉淀与复盘（强化阶段）</strong></h3>
<blockquote>
<p>“把握意味着能总结复用。”</p>
</blockquote>
<p><strong>要做的：</strong></p>
<ol>
<li>✍️ 整理出可复用模块（store、hooks、组件）。</li>
<li>🧩 提炼命名体系（统一命名风格与文件命名格式）。</li>
<li>📚 把项目经验补到团队 wiki 或模板中。</li>
<li>✨ 依据设计主题整理统一样式变量（主题色 / spacing / typography）。</li>
<li>⏱ 安排一次复盘会议——讨论“哪些思考提前做会更好”。</li>
</ol>
<p><strong>目标：</strong></p>
<ul>
<li>下一次项目启动，可以直接从模板启动；</li>
<li>启动文档具备复用性和方向感；</li>
<li>团队在执行中提升“思考的肌肉”。</li>
</ul>
<hr/>
<h2 data-id="heading-4">🧠 二、角色代入法：谁应该在什么时刻思考什么？</h2>

























<table><thead><tr><th align="left">角色</th><th align="left">聚焦点</th><th align="left">关键问题</th></tr></thead><tbody><tr><td align="left">💡 架构师</td><td align="left">结构、流转、命名、复用</td><td align="left">“这个结构3个月后还能用吗？”</td></tr><tr><td align="left">⚙️ 开发者</td><td align="left">实现路径与闭环</td><td align="left">“这功能最小化可行交付是什么？”</td></tr><tr><td align="left">🧭 产品/负责人</td><td align="left">节奏与清晰度</td><td align="left">“项目现在的确定性够吗？”</td></tr></tbody></table>
<p>🪞<strong>代入角色</strong>意味着——在执行前问一句：</p>
<blockquote>
<p>“如果我是产品 / 使用者 / 接口方，我希望什么样的结果？”</p>
</blockquote>
<p>这种内化的思维切换，就是“思考习惯”的落地方式。</p>
<hr/>
<h2 data-id="heading-5">🧩 三、架构主题与视觉的一致性打法</h2>
<blockquote>
<p>软件架构不是只在代码里体现，也体现在用户体验中。</p>
</blockquote>
<p><strong>实践建议：</strong></p>
<ol>
<li>提前定义主题 token（颜色、间距、圆角、阴影）。</li>
<li>根据团队品牌色（例如蓝、黑、灰系列）在 <code>tailwind.config.js</code> 或样式系统中建主题。</li>
<li>对标大厂组件风格（Google Material、GitHub Primer）。</li>
<li>制作 1 页 “UI标准卡”——即芯片、按钮、表单、输入框等样式对照。</li>
</ol>
<p>这样从启动开始，视觉和架构就有“一致节奏感”。</p>
<hr/>
<h2 data-id="heading-6">🔁 四、以结果为导向的任务节奏</h2>
<blockquote>
<p>“如果结果不推动业务，就延后。”</p>
</blockquote>
<ul>
<li>每次迭代定义“能演示的成果”（mock 也行）</li>
<li>所有功能须验收：可复现、可扩展、可理解</li>
<li>延迟不如简化，<strong>不要先做带不动的功能</strong></li>
</ul>
<p>通过这种节奏，团队的执行力会自动与“架构思维”对齐。</p>
<hr/>
<h2 data-id="heading-7">✨ 五、最终产物：一个项目启动模板应包含</h2>





































<table><thead><tr><th align="left">模块</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>/src/stores</code></td><td align="left">核心 store + 业务结构化数据流</td></tr><tr><td align="left"><code>/src/routes</code></td><td align="left">路由命名规则一致，文件结构即系统结构</td></tr><tr><td align="left"><code>/src/components</code></td><td align="left">复用基础组件库（按模板标准命名）</td></tr><tr><td align="left"><code>/src/mocks</code></td><td align="left">mock 服务模拟真实交互</td></tr><tr><td align="left"><code>/theme.config</code></td><td align="left">系统主题与品牌样式定义</td></tr><tr><td align="left"><code>/docs</code></td><td align="left">项目架构文档 + 执行准则</td></tr><tr><td align="left"><code>/README.md</code></td><td align="left">项目启动简述与执行清单</td></tr></tbody></table>
<p>这就是一个真正“用架构思维启动项目”的标准蓝本。</p>
<hr/>
<h2 data-id="heading-8">🧭 结语</h2>
<p>将“脑力”和“流水线”结合，就是让项目更有节奏感地前进。<br/>
架构的思维不是让流程更复杂，而是<strong>让每个人少走弯路</strong>。</p>
<blockquote>
<p>想清楚再行动，结构化代替堆砌，<br/>
模板化提升速度，复盘式积累成长。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 年AI 能生成代码，但都是一坨屎😒]]></title>    <link>https://juejin.cn/post/7602252722372493363</link>    <guid>https://juejin.cn/post/7602252722372493363</guid>    <pubDate>2026-02-03T03:10:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602252722372493363" data-draft-id="7602259669707030554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 年AI 能生成代码，但都是一坨屎😒"/> <meta itemprop="keywords" content="前端,JavaScript,AI编程"/> <meta itemprop="datePublished" content="2026-02-03T03:10:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 年AI 能生成代码，但都是一坨屎😒
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T03:10:42.000Z" title="Tue Feb 03 2026 03:10:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/352e77bef90e47cba1bade943fa8e8a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770693042&amp;x-signature=O2YmoLIxAOK25G%2FCVfD6nSDI%2FrE%3D" alt="featuredImage.webp" loading="lazy"/></p>
<p>现在的 IDE 已经进化到了不可思议的地步。昨天，产品经理在群里火急火燎地提了一个需求：给我们的 web 老年版 App ，要大按钮，要醒目，要快。</p>
<p>我把这句话喂给了最新的 Google Antigravity。</p>
<p><strong>3 秒</strong>。真的只有 3.5 秒 😲。</p>
<p>它直接吐出了 300 行完美无瑕的 React 代码。Tailwind 样式美观，TypeScript 类型定义严丝合缝，甚至还贴心地自动补全了单元测试。</p>
<p>代码跑起来了，测试全绿，没有任何报错。</p>
<p>如果是三年前，我可能会惊叹自己要失业了。但现在，我看着屏幕上那个密密麻麻的按钮，内心毫无波澜，甚至想骂人。🤬🤬🤬</p>
<p><strong>这写的是一坨什么屎？？？？</strong></p>
<h3 data-id="heading-0">代码都是冷冰冰的</h3>
<p>AI 生成的代码，从计算机科学的角度看是满分的。但它根本不知道，使用这个产品的用户，是一位 75 岁、患有白内障、手抖得厉害的独居老人。</p>
<p>试想一下，当他在深夜突发心脏不适，颤抖着手打开手机时，他会遭遇什么？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5317a481b7b04c358d7a42898554e359~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770693042&amp;x-signature=HCh5RpK0H7GCB0%2Ff8YUOXL3K%2FQc%3D" alt="2 (1).png" loading="lazy"/></p>
<p>在老人模糊且敏感的视野里，不是科技感，而是一团晃眼的光斑，甚至可能诱发眩晕。</p>
<p>那个严丝合缝的 <strong>点击逻辑</strong>，要求手指必须精准落在 40px 的圆心内。而老人在慌乱中，手指接触屏幕的面积往往是整个指腹，甚至是大鱼际。AI 写的代码会判定这是误触，然后无动于衷。</p>
<p>那个毫无报错的 <strong>API 调用</strong>，在老人那微弱的 2G 信号地下室里，会直接超时。AI 很负责任地弹出了一个标准的 Ant Design 风格提示框：<strong>Error: 504 Gateway Timeout😖</strong>。</p>
<p>这一刻，AI 完成了写代码的任务，但它彻底搞砸了救命这件事 🤦‍♂️。</p>
<p>我毫不犹豫地删掉了那 300 行所谓的完美代码。</p>
<p>我手写了 50 行最笨拙的 CSS。我去掉了所有特效，把按钮改成了高对比度的红黄配色，土是土了点，但能在黑暗里一眼看到。我把点击热区扩大到了半个屏幕，哪怕他用拳头砸都能触发。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc39fc4d03824cc5896d1e18c4e41006~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770693042&amp;x-signature=77e0jZkY7xQy2r8pjPqDfyd3W2g%3D" alt="screenshot-20260203-110207.png" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* style.css */</span>

* {
  <span class="hljs-attribute">box-sizing</span>: border-box;
}

<span class="hljs-selector-tag">html</span>, <span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
}

<span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#000</span>; <span class="hljs-comment">/* 纯黑，减少眩光 */</span>
}

<span class="hljs-comment">/* 整个屏幕就是一个按钮 */</span>
<span class="hljs-selector-id">#emergency-btn</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100vw</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;

  <span class="hljs-attribute">background</span>: <span class="hljs-number">#ff0000</span>; <span class="hljs-comment">/* 纯红 */</span>
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#ffff00</span>;      <span class="hljs-comment">/* 纯黄 */</span>

  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">48px</span>;
  <span class="hljs-attribute">font-weight</span>: bold;
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.4</span>;

  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">outline</span>: none;

  <span class="hljs-comment">/* 防止误操作带来的系统延迟 */</span>
  touch-action: manipulation;
}

<span class="hljs-comment">/* 防止手机系统点击闪烁 */</span>
<span class="hljs-selector-id">#emergency-btn</span><span class="hljs-selector-pseudo">:active</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#cc0000</span>;
}

</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// main.js</span>

<span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'emergency-btn'</span>);

btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 尝试先走“智能路径”</span>
  <span class="hljs-title function_">trySendEmergencySignal</span>();
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">trySendEmergencySignal</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
  <span class="hljs-keyword">const</span> timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    controller.<span class="hljs-title function_">abort</span>();
  }, <span class="hljs-number">3000</span>); <span class="hljs-comment">// 3 秒，不能再多了</span>

  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://example.com/api/emergency'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span>,
  })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 成功也直接拨号，不等服务器“确认”</span>
      <span class="hljs-title function_">dial120</span>();
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// ⚠️ 任何错误，直接走最原始方案</span>
      <span class="hljs-title function_">dial120</span>();
    })
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-built_in">clearTimeout</span>(timeout);
    });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">dial120</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 不提示、不解释、不弹窗</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'tel:120'</span>;
}

</code></pre>
<p>我还在 catch 语句里加了一段逻辑：<strong>如果网络超时，不要弹窗报错，而是直接调用系统的电话拨号盘，填入 120。</strong></p>
<p>这段代码，没有任何设计模式，甚至有点丑。但它能在关键时刻，真的把求救信号发出去。</p>
<h3 data-id="heading-1">2026 年，我们缺的是代码吗？</h3>
<p>完全不缺。GitHub 上的代码量早就指数级爆炸了。现在的初级程序员，或者说是 Prompt 工程师，最擅长的事情就是：生成、复制、粘贴。</p>
<p>只要跑得通，只要 UI 看起来一样，就提交上线。</p>
<p>于是，我们的项目里充斥着这种<strong>屎代码</strong>。它们没有明显的 Bug，但它们极其臃肿、逻辑割裂、毫无上下文关联。它们就像超市里的预制菜，看着像那么回事，吃起来全是工业糖精味 😮‍💨。</p>
<p><strong>什么叫正确的事？</strong></p>
<p>正确不是 Type Check Passed。</p>
<p>正确是知道这里为什么不能用无限滚动，因为用户需要到底部找联系我们。正确是知道在表单提交失败时，不要只红框提示，而是要自动保留用户刚才敲了 500 字的评论，别让他重写。</p>
<p>AI 永远学不会心疼用户。它没有痛觉，没有焦虑，没有爱。它不会因为页面白屏了 3 秒而感到愧疚，但你会。</p>
<h3 data-id="heading-2">程序员的护城河，是同理心</h3>
<p>很多人问我，2026 年了，我还需要学写代码吗？</p>
<p>我的回答是：你不需要学怎么写代码，但你需要学<strong>为什么写代码</strong>。</p>
<p>以前，我们的价值是翻译——把人类的需求翻译成机器能懂的 JavaScript。现在，AI 把翻译的活儿干了。我们的价值变成了共情——去感受屏幕背后那个真实人类的喜怒哀乐。</p>
<p>当 AI 能够一键生成整个商城系统时，你能做的，是去思考：</p>
<p>在这个支付环节，用户会不会因为犹豫而流失？这个报错提示，会不会让用户觉得自己很蠢？如果是色弱用户，能不能看清这个图表？（比如我😭）</p>
<p>这些细微的、关乎人性的决策，才是 1 和 0 之间那道无法跨越的鸿沟。</p>
<hr/>
<p>在这个代码泛滥的年代，<strong>克制</strong>反而成了一种美德。</p>
<p>别因为 AI 能生成，你就疯狂堆砌功能。别因为 AI 能优化，你就忽略了真实的体感。</p>
<p>请停下来想一想：这行代码背后，是一个活生生的人。他可能是焦急的父亲，可能是疲惫的打工人，也可能是你年迈的父母。</p>
<p>AI 可以帮你建起万丈高楼，但只有你能决定，要不要在楼道里，为晚归的人留一盏温暖的灯 ❤️。</p>
<p>这才是我们程序员在 2026 年，依然无可替代的理由。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53b616c43247473790464f7af333311e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770693042&amp;x-signature=TiQooLRhWNqixwaWP%2FX%2Bnu9awPg%3D" alt="谢谢大家.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[颜色与渐变：hex、rgb、hsl、渐变、混合模式]]></title>    <link>https://juejin.cn/post/7602162809291800614</link>    <guid>https://juejin.cn/post/7602162809291800614</guid>    <pubDate>2026-02-03T01:34:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602162809291800614" data-draft-id="7602177113685246003" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="颜色与渐变：hex、rgb、hsl、渐变、混合模式"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2026-02-03T01:34:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="VixenAhri"/> <meta itemprop="url" content="https://juejin.cn/user/741541894953144"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            颜色与渐变：hex、rgb、hsl、渐变、混合模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/741541894953144/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    VixenAhri
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T01:34:08.000Z" title="Tue Feb 03 2026 01:34:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<p>CSS 颜色与渐变，绝对是我刚学前端时的“颜值瓶颈”——最开始只会抄设计稿上的hex色值，调个主题色hover效果，要反复改几十次色值才能勉强满意；写渐变要么过渡得生硬又突兀，要么角度写错导致整体错位，混合模式更是看都不敢看，总觉得太复杂。直到踩够了坑、慢慢摸透了每种用法才发现，hex、rgb、hsl各有各的方便，渐变随手写就能出高级感，混合模式用对了还能省很多事。今天就把我实打实的实操经验、踩过的坑，还有整理的干货分享给大家，新手跟着学，能少走很多弯路。</p>
<h2 data-id="heading-0">一、颜色表示法：按需选择，我常用这3种（避坑指南）</h2>
<p>CSS 颜色表示法其实有一大堆，关键字、hex、rgb、hsl、oklch 等等，但我日常开发里，真正用得上的就3种——hex、rgb、hsl。oklch 虽然色域广、颜色更鲜艳，但兼容性还不够好，我目前项目里还没敢用；关键字也就偶尔用个transparent，其他的基本不碰。新手真不用贪多，把这3种核心用法吃透，就能应对99%的开发场景。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 关键字：简单但不灵活，仅用在透明、基础色，我很少用 */</span>
<span class="hljs-attribute">color</span>: red;
<span class="hljs-attribute">background</span>: transparent; <span class="hljs-comment">/* 常用，透明背景 */</span>

<span class="hljs-comment">/* hex：最常用，简洁好复制，6位、8位（含透明度）都常用 */</span>
<span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>; <span class="hljs-comment">/* 3位简写，等价于#333333，适合基础灰色系 */</span>
<span class="hljs-attribute">color</span>: <span class="hljs-number">#333333</span>; <span class="hljs-comment">/* 6位标准写法，精准度高，日常最常用 */</span>
<span class="hljs-attribute">color</span>: <span class="hljs-number">#3333</span>; <span class="hljs-comment">/* 4位简写 + 透明度，33是透明度，等价于#33333333 */</span>
<span class="hljs-attribute">color</span>: <span class="hljs-number">#33333380</span>; <span class="hljs-comment">/* 8位写法，最后两位80=50%透明度，我做半透明常用这个 */</span>

<span class="hljs-comment">/* rgb / rgba：直观控制红绿蓝，带透明度，新手易理解 */</span>
<span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">51</span>); <span class="hljs-comment">/* 无透明，和#333一致 */</span>
<span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">0.5</span>); <span class="hljs-comment">/* 传统透明写法 */</span>
<span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">51</span> <span class="hljs-number">51</span> <span class="hljs-number">51</span> / <span class="hljs-number">0.5</span>);  <span class="hljs-comment">/* 新语法，空格分隔，更简洁，我现在优先用 */</span>

<span class="hljs-comment">/* hsl / hsla：色相、饱和度、明度，调色超方便，做主题色首选 */</span>
<span class="hljs-attribute">color</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-number">0</span>, <span class="hljs-number">100%</span>, <span class="hljs-number">50%</span>);    <span class="hljs-comment">/* 红：色相0，饱和度100%，明度50% */</span>
<span class="hljs-attribute">color</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-number">120</span>, <span class="hljs-number">100%</span>, <span class="hljs-number">50%</span>);  <span class="hljs-comment">/* 绿：色相120 */</span>
<span class="hljs-attribute">color</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-number">240</span>, <span class="hljs-number">100%</span>, <span class="hljs-number">50%</span>);  <span class="hljs-comment">/* 蓝：色相240 */</span>
<span class="hljs-attribute">color</span>: <span class="hljs-built_in">hsl</span>(<span class="hljs-number">0</span> <span class="hljs-number">0%</span> <span class="hljs-number">20%</span> / <span class="hljs-number">0.5</span>);  <span class="hljs-comment">/* 新语法 + 透明度，灰色50%透明 */</span>

<span class="hljs-comment">/* oklch：现代色空间，色域更广，颜色更鲜艳，但兼容性一般，我暂不用 */</span>
<span class="hljs-attribute">color</span>: <span class="hljs-built_in">oklch</span>(<span class="hljs-number">0.6</span> <span class="hljs-number">0.2</span> <span class="hljs-number">250</span>);
</code></pre>
<p><strong>我的实操心得+踩坑吐槽</strong>：这几种表示法，我踩过不少冤枉路，后来总结了一套固定用法，再也没出过错，新手直接照搬就行：</p>
<ul>
<li>日常固定色（边框、基础文字色），首选hex：最简洁，设计稿给的色值基本都是hex，直接复制粘贴就行，不用额外转换，能省不少时间，也避免转换出错。</li>
<li>需要半透明效果（遮罩、悬浮层、半透明背景），必用rgb新语法：比8位hex直观太多，0.5就是50%透明度，一眼就能看懂。我早期傻愣愣用8位hex，每次都要算透明度对应的十六进制值，经常算错，改来改去浪费时间。</li>
<li>做主题色、hover变色、手动调色，一定要用hsl：这绝对是调色神器！改H（色相）就能切换颜色，比如从红色改成蓝色，不用重新找色值；改S（饱和度）调鲜艳程度，改L（明度）调明暗，比如按钮hover要变亮，只需要把L调高一点，比hex、rgb反复试色高效10倍。</li>
<li>避坑点：4位hex简写（#3333）新手千万别乱⽤，只有最后两位是透明度，很容易和6位色值混淆，我早期就因为简写看错了，把半透明色写成了实色；还有rgb新语法，“/”后面别加空格，不然部分低版本浏览器会不兼容，踩过一次坑就记牢了。</li>
</ul>
<h2 data-id="heading-1">二、线性渐变 linear-gradient：日常最常用，按钮/背景首选</h2>
<p>线性渐变是我日常用得最多的渐变效果，没有之一！核心特别简单，就是“沿某个方向，从一种颜色过渡到另一种颜色”，按钮、卡片背景、页面装饰，用它都能轻松做出高级感。新手只要记住“方向+色标”这两个关键点，就能快速上手，我早期踩的坑，基本都集中在方向写错、色标位置没设对这两点上。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 基础用法：方向 + 色标（最少两种颜色） */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(to right, red, blue); <span class="hljs-comment">/* 从左到右，红渐变到蓝 */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">90deg</span>, red, blue); <span class="hljs-comment">/* 用角度表示方向，90deg=to right，更精准 */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(to bottom right, red, blue); <span class="hljs-comment">/* 从左上到右下，对角线渐变 */</span>

<span class="hljs-comment">/* 多个色标：实现多颜色过渡，更丰富 */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(to right, red, yellow <span class="hljs-number">50%</span>, blue); <span class="hljs-comment">/* 红→黄（中间位置）→蓝 */</span>

<span class="hljs-comment">/* 色标位置：手动控制过渡节点，避免过渡生硬，我做精致渐变必用 */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(to right, red <span class="hljs-number">0%</span>, blue <span class="hljs-number">50%</span>, green <span class="hljs-number">100%</span>); <span class="hljs-comment">/* 0%、50%、100% 是过渡位置 */</span>

<span class="hljs-comment">/* 实际场景1：按钮渐变（我项目里常用的写法） */</span>
<span class="hljs-selector-class">.btn-primary</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#667eea</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#764ba2</span> <span class="hljs-number">100%</span>); <span class="hljs-comment">/* 135deg角度，更有立体感 */</span>
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
}

<span class="hljs-comment">/* 实际场景2：条纹背景（高频需求，我早期写错过background-size） */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(
  <span class="hljs-number">90deg</span>,
  <span class="hljs-number">#333</span> <span class="hljs-number">0%</span>,
  <span class="hljs-number">#333</span> <span class="hljs-number">50%</span>,
  <span class="hljs-number">#666</span> <span class="hljs-number">50%</span>,
  <span class="hljs-number">#666</span> <span class="hljs-number">100%</span>
);
<span class="hljs-attribute">background-size</span>: <span class="hljs-number">20px</span> <span class="hljs-number">100%</span>; <span class="hljs-comment">/* 关键：控制条纹宽度，20px是条纹总宽，漏写就没有条纹效果 */</span>
</code></pre>
<p><strong>高频坑点（全是我踩过的冤枉路）</strong> ：1. 方向混淆：to right是从左到右，to left是从右到左，我早期曾把to right写成to left，渐变方向完全反了，页面整体错乱，排查了半天才发现是这个小问题；2. 条纹背景漏写background-size：我第一次写条纹，只写了渐变代码，没写background-size，结果页面显示的是单一渐变，没有任何条纹效果，还以为是代码写错了，折腾了好久；3. 色标位置不写：默认是均匀过渡，想要条纹那种生硬分界，必须给相邻色标设相同位置（比如50%、50%），不然过渡会很柔和，达不到想要的效果。</p>
<h2 data-id="heading-2">三、径向渐变 radial-gradient：做光晕、圆形背景超合适</h2>
<p>径向渐变和线性渐变不一样，它是“从中心点向外扩散”的，自带层次感，特别适合做圆形背景、卡片hover光晕、头像边框这些点缀性的效果，能悄悄提升页面质感。它的核心也简单，就是控制“形状+圆心位置+色标”，不用写复杂代码，简单调一调就能出效果。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 基础用法：圆形，从中心向外渐变（默认椭圆，circle设为圆形） */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">radial-gradient</span>(circle, red, blue); <span class="hljs-comment">/* 圆形，红→蓝 */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">radial-gradient</span>(ellipse at center, red, blue); <span class="hljs-comment">/* 椭圆（默认），中心点 */</span>

<span class="hljs-comment">/* 指定圆心位置：精准控制渐变扩散起点，我做局部光晕常用 */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">radial-gradient</span>(circle at <span class="hljs-number">20%</span> <span class="hljs-number">80%</span>, yellow, red); <span class="hljs-comment">/* 圆心在左侧下方（20%宽度，80%高度） */</span>

<span class="hljs-comment">/* 色标控制：和线性渐变一致，可手动设位置，实现多颜色扩散 */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">radial-gradient</span>(circle, red <span class="hljs-number">0%</span>, blue <span class="hljs-number">50%</span>, green <span class="hljs-number">100%</span>); <span class="hljs-comment">/* 红（中心）→蓝→绿（边缘） */</span>
</code></pre>
<p>我的实操小技巧：径向渐变不用搞太复杂，简单的圆形渐变+半透明色，就能做出很好的效果。比如卡片hover时的光晕，我就用radial-gradient(circle, rgba(102, 126, 234, 0.3), transparent)，再配合background-size调一下范围，就能做出柔和又自然的光晕，比单纯用box-shadow质感好太多。</p>
<h2 data-id="heading-3">四、锥形渐变 conic-gradient：色轮、饼图专属</h2>
<p>锥形渐变我早期接触得很少，一直觉得它没用，直到做数据可视化、需要写简单饼图时才发现，它简直是“神器”！它和径向渐变的“向外扩散”完全不同，是“围绕中心点旋转”的环形过渡，最适合做色轮、饼图、加载动画，不用写复杂的定位和嵌套，几行代码就能搞定。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 基础用法：色轮效果（多颜色环形过渡） */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">conic-gradient</span>(red, yellow, green, blue, red); <span class="hljs-comment">/* 从红开始，环形过渡，最后回到红 */</span>

<span class="hljs-comment">/* 从指定角度开始渐变：控制渐变的起始位置 */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">conic-gradient</span>(from <span class="hljs-number">90deg</span>, red, blue); <span class="hljs-comment">/* 从90度位置开始，红→蓝 */</span>

<span class="hljs-comment">/* 实际场景：饼图（最常用，精准控制每个扇形角度） */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">conic-gradient</span>(red <span class="hljs-number">0deg</span> <span class="hljs-number">90deg</span>, blue <span class="hljs-number">90deg</span> <span class="hljs-number">180deg</span>, green <span class="hljs-number">180deg</span> <span class="hljs-number">360deg</span>); <span class="hljs-comment">/* 红（0-90度）、蓝（90-180度）、绿（180-360度） */</span>
</code></pre>
<p><strong>避坑提醒（血的教训）</strong> ：锥形渐变的角度的是“环形角度”，0deg在右侧，顺时针递增，和线性渐变的角度逻辑完全不一样！我第一次做饼图，就按线性渐变的角度逻辑来写，结果扇形位置全错了，排查了好久才找到问题；另外，做饼图时，相邻色标的结束角度和开始角度一定要衔接好（比如90deg接90deg），不然两个扇形之间会出现缝隙，特别丑。</p>
<h2 data-id="heading-4">五、重复渐变：条纹、网格等重复效果，不用写多余标签</h2>
<p>重复渐变真的太省代码了！它的核心就是“把渐变效果重复排列”，不用写多个div嵌套，就能做出条纹、网格、点阵这些重复样式，我做表格条纹、页面背景网格时，基本都用它，比手动写多个div方便太多。重点就是控制好“渐变长度+重复间距”，就能做出想要的效果。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 重复线性渐变：常用做水平/垂直条纹，我做表格条纹必用 */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">repeating-linear-gradient</span>(
  <span class="hljs-number">90deg</span>, <span class="hljs-comment">/* 方向：水平条纹 */</span>
  <span class="hljs-number">#333</span>,
  <span class="hljs-number">#333</span> <span class="hljs-number">10px</span>, <span class="hljs-comment">/* 第一个条纹：#333，宽度10px */</span>
  <span class="hljs-number">#666</span> <span class="hljs-number">10px</span>, <span class="hljs-comment">/* 衔接位置，和上一个结束位置一致，避免缝隙 */</span>
  <span class="hljs-number">#666</span> <span class="hljs-number">20px</span> <span class="hljs-comment">/* 第二个条纹：#666，宽度10px，总重复宽度20px */</span>
);

<span class="hljs-comment">/* 重复径向渐变：常用做圆形点阵、环形重复效果 */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">repeating-radial-gradient</span>(circle, red, red <span class="hljs-number">10px</span>, blue <span class="hljs-number">10px</span>, blue <span class="hljs-number">20px</span>); <span class="hljs-comment">/* 圆形重复，红→蓝，每个重复单元20px */</span>
</code></pre>
<p>我的实操小技巧：重复渐变的关键，就是“相邻色标的位置要衔接好”，比如前一个颜色在10px结束，下一个颜色就从10px开始，这样两个渐变之间才不会出现缝隙；另外，重复单元的总宽度（比如20px），决定了条纹的密集程度，宽度越小，条纹越密，根据设计稿灵活调整就好，不用死记硬背。</p>
<h2 data-id="heading-5">六、混合模式 mix-blend-mode：高级叠加效果，提升页面质感</h2>
<p>混合模式我早期一直不敢碰，总觉得它太复杂，怕用错了把页面颜色搞乱，直到后来做Banner图、需要文字和背景叠加时才发现，它能做出特别高级的效果，而且没那么难。核心就是“让当前元素，和它下方的内容产生叠加反应”，比如正片叠底、滤色，选对模式，就能轻松做出高级感，不用写多余的样式。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 元素混合：让当前元素（叠加层）与下方元素叠加 */</span>
<span class="hljs-selector-class">.overlay</span> { <span class="hljs-comment">/* 叠加层，比如遮罩、文字 */</span>
  <span class="hljs-attribute">mix-blend-mode</span>: multiply;   <span class="hljs-comment">/* 正片叠底：常用做图片暗化遮罩，我最常用 */</span>
  <span class="hljs-attribute">mix-blend-mode</span>: screen;    <span class="hljs-comment">/* 滤色：常用做图片提亮，适合浅色叠加 */</span>
  <span class="hljs-attribute">mix-blend-mode</span>: overlay;   <span class="hljs-comment">/* 叠加：保留底层细节，同时叠加上层颜色，高级感强 */</span>
  <span class="hljs-attribute">mix-blend-mode</span>: difference; <span class="hljs-comment">/* 差值：颜色对比强烈，适合特殊效果，少用 */</span>
}

<span class="hljs-comment">/* 背景混合：让元素的背景（比如渐变+图片）内部叠加 */</span>
<span class="hljs-attribute">background-blend-mode</span>: multiply; <span class="hljs-comment">/* 背景内部叠加 */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(red, blue), <span class="hljs-built_in">url</span>(<span class="hljs-string">bg.jpg</span>); <span class="hljs-comment">/* 渐变与背景图叠加，配合上面的混合模式 */</span>
</code></pre>
<p><strong>避坑提醒（我踩过的蠢坑）</strong> ：1. 混合模式必须“下方有内容”才能生效！我第一次用mix-blend-mode，给一个单独的遮罩层加了这个属性，结果一点效果都没有，折腾了半天，才发现遮罩层下方是空的，没有可叠加的内容；2. 别滥用混合模式！它会改变元素原本的颜色呈现，普通页面尽量不用，只在Banner、详情页这种需要高级效果的地方用，不然很容易导致颜色错乱，影响页面可读性。</p>
<h2 data-id="heading-6">七、color-mix：颜色混合新语法，主题色变体超方便</h2>
<p>color-mix 绝对是CSS新增语法里，我最爱的一个！它能快速混合两种颜色，不用手动计算色值，省了大量试色的时间，尤其适合做主题色变体——比如按钮hover变亮、禁用色、浅色系背景，用它来写，高效又精准，比手动调hex、hsl方便太多，我现在做主题色相关的样式，全靠它。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 基础用法：混合两个颜色，指定混合比例 */</span>
<span class="hljs-attribute">color</span>: <span class="hljs-built_in">color-mix</span>(in srgb, red <span class="hljs-number">50%</span>, blue); <span class="hljs-comment">/* 在srgb色空间，红50% + 蓝50%，混合出紫色 */</span>
<span class="hljs-attribute">background</span>: <span class="hljs-built_in">color-mix</span>(in hsl, <span class="hljs-number">#333</span> <span class="hljs-number">80%</span>, white); <span class="hljs-comment">/* 深灰80% + 白20%，混合出浅灰色 */</span>

<span class="hljs-comment">/* 实际场景：按钮hover变亮（我项目里的常用写法） */</span>
<span class="hljs-selector-class">.btn</span> {
  <span class="hljs-attr">--primary</span>: <span class="hljs-number">#667eea</span>; <span class="hljs-comment">/* 主题色变量 */</span>
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--primary);
}
<span class="hljs-selector-class">.btn</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-comment">/* 主题色85% + 白15%，实现hover变亮，不用重新找色值 */</span>
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">color-mix</span>(in srgb, <span class="hljs-built_in">var</span>(--primary) <span class="hljs-number">85%</span>, white);
}
</code></pre>
<p>我的实操心得：color-mix 不用记复杂语法，核心就是“指定色空间+混合比例”。建议优先用in srgb，兼容性更好；混合比例也不用写两个，只写一个就行，另一个会自动补全（比如红50%，蓝就默认是50%）。做主题色变体时，混合白色就能变亮，混合黑色就能变暗，比手动调hsl的明度更精准，而且全站主题色能保持统一，不会出现色差。</p>
<h2 data-id="heading-7">八、我的实际示例（直接套用，少踩坑）</h2>
<p>结合我日常开发的高频场景，整理了4个实操写法，新手可以直接复制套用，全是我项目里常用的，避开了所有我踩过的坑，不用再自己瞎琢磨：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 场景1：卡片渐变边框（高级感拉满，不用额外写边框标签） */</span>
<span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">24px</span>; <span class="hljs-comment">/* 给内部留空间，避免内容贴边框 */</span>
}
<span class="hljs-selector-class">.card</span><span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">position</span>: absolute;
  inset: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 全屏覆盖父元素 */</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">1px</span>; <span class="hljs-comment">/* 边框宽度，关键 */</span>
  <span class="hljs-attribute">border-radius</span>: inherit; <span class="hljs-comment">/* 继承父元素圆角，避免圆角错位 */</span>
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#667eea</span>, <span class="hljs-number">#764ba2</span>); <span class="hljs-comment">/* 渐变边框颜色 */</span>
  <span class="hljs-comment">/* 关键：实现只显示边框，不覆盖内部背景 */</span>
  -webkit-<span class="hljs-attribute">mask</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">#fff</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>) content-box, <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">#fff</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>);
  <span class="hljs-attribute">mask-composite</span>: exclude;
}

<span class="hljs-comment">/* 场景2：文字渐变（标题常用，高级不生硬） */</span>
<span class="hljs-selector-class">.gradient-text</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">90deg</span>, <span class="hljs-number">#667eea</span>, <span class="hljs-number">#764ba2</span>); <span class="hljs-comment">/* 渐变颜色 */</span>
  -webkit-<span class="hljs-attribute">background-clip</span>: text; <span class="hljs-comment">/* 把背景裁剪到文字上，webkit前缀兼容移动端 */</span>
  -webkit-text-fill-<span class="hljs-attribute">color</span>: transparent; <span class="hljs-comment">/* 文字颜色透明，显示背景渐变 */</span>
  <span class="hljs-attribute">background-clip</span>: text; <span class="hljs-comment">/* 标准写法 */</span>
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2rem</span>;
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
}

<span class="hljs-comment">/* 场景3：简单饼图（数据可视化常用，不用复杂组件） */</span>
<span class="hljs-selector-class">.pie-chart</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>; <span class="hljs-comment">/* 圆形容器 */</span>
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">conic-gradient</span>(red <span class="hljs-number">0deg</span> <span class="hljs-number">90deg</span>, blue <span class="hljs-number">90deg</span> <span class="hljs-number">180deg</span>, green <span class="hljs-number">180deg</span> <span class="hljs-number">360deg</span>);
}

<span class="hljs-comment">/* 场景4：带hover效果的渐变按钮（日常高频） */</span>
<span class="hljs-selector-class">.btn-primary</span> {
  <span class="hljs-attr">--primary</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#667eea</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#764ba2</span> <span class="hljs-number">100%</span>);
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--primary);
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span>;
}
<span class="hljs-selector-class">.btn-primary</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-comment">/* 混合主题色和白色，实现hover变亮，同时保留渐变 */</span>
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">color-mix</span>(in srgb, <span class="hljs-built_in">var</span>(--primary) <span class="hljs-number">90%</span>, white);
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">2px</span>); <span class="hljs-comment">/* 轻微上浮，提升交互感 */</span>
}
</code></pre>
<h2 data-id="heading-8">九、个人总结：颜色与渐变避坑核心（新手必看）</h2>
<ol>
<li>
<p>颜色表示法：hex 日常凑活用、rgb 专门做透明、hsl 负责调色，oklch 暂不考虑，新手聚焦这3种，足够应对所有场景，不用贪多求全；</p>
</li>
<li>
<p>线性渐变：方向+色标是核心，按钮、背景首选它，写条纹千万别漏写background-size，不然等于白写；</p>
</li>
<li>
<p>径向渐变：做圆形、光晕的神器，控制好圆心位置，就能悄悄提升页面层次感，不用搞复杂样式；</p>
</li>
<li>
<p>锥形渐变：色轮、饼图专属，记住它的角度是环形角度，相邻色标衔接好，避免出现缝隙；</p>
</li>
<li>
<p>重复渐变：相邻色标位置衔接好，能省很多嵌套代码，做条纹、网格超方便；</p>
</li>
<li>
<p>混合模式：按需选用，正片叠底、叠加最常用，记住“下方要有内容”，不然没用，别滥用；</p>
</li>
<li>
<p>color-mix：主题色变体神器，混合白色/黑色实现亮暗变化，不用手动试色，高效又精准。</p>
</li>
</ol>
<p>其实颜色与渐变真的不难，我最开始也是只会抄hex、写简单线性渐变，踩了无数坑，才慢慢熟练起来。核心就是“多试、多总结”，不用一开始就追求复杂效果，先掌握基础用法，再逐步尝试高级效果，慢慢就能做出有质感的页面。配合前3篇讲的盒模型、单位知识，CSS布局+美化，就能轻松拿捏。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简单微信小程序开发案例——瞬间听力测试]]></title>    <link>https://juejin.cn/post/7602259669707063322</link>    <guid>https://juejin.cn/post/7602259669707063322</guid>    <pubDate>2026-02-03T02:04:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602259669707063322" data-draft-id="7602177113685508147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简单微信小程序开发案例——瞬间听力测试"/> <meta itemprop="keywords" content="前端,微信小程序"/> <meta itemprop="datePublished" content="2026-02-03T02:04:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="虚惊一场"/> <meta itemprop="url" content="https://juejin.cn/user/2696462831981975"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简单微信小程序开发案例——瞬间听力测试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2696462831981975/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    虚惊一场
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:04:26.000Z" title="Tue Feb 03 2026 02:04:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">项目名称</h2>
<p>微信搜索：<code>瞬间听力测试</code></p>
<h2 data-id="heading-1">项目概述</h2>
<p>这是一个基于 Vue 3 + uni-app 开发的瞬间听力测试游戏，玩家需要在听到一串数字后准确输入。游戏从 7 位数字开始，最高可挑战 20 位数字，支持三种难度模式（舒缓、正常、急促），具有精美的 UI 设计和流畅的交互体验。</p>
<h3 data-id="heading-2">核心功能特性</h3>
<ul>
<li><strong>渐进式难度</strong>：从 7 位数字开始，成功后自动升级到下一关</li>
<li><strong>多难度模式</strong>：三种语音播放速度，适应不同用户需求</li>
<li><strong>实时音效反馈</strong>：按钮点击音效和声波可视化</li>
<li><strong>智能语音播报</strong>：基于微软 TTS 的高质量语音合成</li>
<li><strong>响应式设计</strong>：适配多种屏幕尺寸</li>
<li><strong>社交分享</strong>：支持微信分享，动态生成个性化标题</li>
</ul>
<h2 data-id="heading-3">技术架构</h2>
<h3 data-id="heading-4">前端技术栈</h3>
<ul>
<li><strong>框架</strong>：Vue 3 Composition API + uni-app</li>
<li><strong>样式</strong>：SCSS + 主题系统</li>
<li><strong>状态管理</strong>：Composables 模式</li>
<li><strong>音频处理</strong>：微信小程序音频 API</li>
</ul>
<h3 data-id="heading-5">后端服务</h3>
<ul>
<li><strong>TTS 服务</strong>：微软开源 TTS 镜像部署</li>
<li><strong>API 接口</strong>：RESTful API 设计</li>
<li><strong>音频格式</strong>：MP3 流式传输</li>
</ul>
<h2 data-id="heading-6">CSS 巧妙用法详解</h2>
<h3 data-id="heading-7">1. 主题系统设计</h3>
<p>项目采用了基于 SCSS Map 的主题系统，支持三种视觉风格：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-variable">$themes</span>: (
  easy: (
    start: <span class="hljs-number">#d6d3ac</span>,
    secondary: <span class="hljs-number">#d5d693</span>,
    accent: <span class="hljs-number">#a5d6a7</span>,
    primary: <span class="hljs-number">#81c784</span>,
    end: <span class="hljs-number">#81c784</span>,
    shadow: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">129</span>, <span class="hljs-number">199</span>, <span class="hljs-number">132</span>, <span class="hljs-number">0.35</span>),
  ),
  normal: (
    start: <span class="hljs-number">#f8bbd9</span>,
    secondary: <span class="hljs-number">#e1bee7</span>,
    accent: <span class="hljs-number">#81d4fa</span>,
    primary: <span class="hljs-number">#4fc3f7</span>,
    end: <span class="hljs-number">#29b6f6</span>,
    shadow: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">41</span>, <span class="hljs-number">182</span>, <span class="hljs-number">246</span>, <span class="hljs-number">0.4</span>),
  ),
  hard: (
    start: <span class="hljs-number">#fcbc81</span>,
    secondary: <span class="hljs-number">#ffac75</span>,
    accent: <span class="hljs-number">#ffabad</span>,
    primary: <span class="hljs-number">#ff9393</span>,
    end: <span class="hljs-number">#ff7072</span>,
    shadow: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">112</span>, <span class="hljs-number">114</span>, <span class="hljs-number">0.45</span>),
  ),
);

<span class="hljs-keyword">@mixin</span> theme-gradient(<span class="hljs-variable">$theme-name</span>) {
  <span class="hljs-variable">$theme</span>: <span class="hljs-built_in">map-get</span>(<span class="hljs-variable">$themes</span>, <span class="hljs-variable">$theme-name</span>);
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(
    <span class="hljs-number">135deg</span>,
    <span class="hljs-built_in">map-get</span>(<span class="hljs-variable">$theme</span>, start),
    <span class="hljs-built_in">map-get</span>(<span class="hljs-variable">$theme</span>, secondary),
    <span class="hljs-built_in">map-get</span>(<span class="hljs-variable">$theme</span>, accent),
    <span class="hljs-built_in">map-get</span>(<span class="hljs-variable">$theme</span>, primary),
    <span class="hljs-built_in">map-get</span>(<span class="hljs-variable">$theme</span>, end)
  );
}

<span class="hljs-keyword">@each</span> <span class="hljs-variable">$theme-name</span>, <span class="hljs-variable">$theme</span> in <span class="hljs-variable">$themes</span> {
  &amp;<span class="hljs-selector-class">.theme-</span>#{<span class="hljs-variable">$theme-name</span>} {
    <span class="hljs-keyword">@include</span> theme-gradient(<span class="hljs-variable">$theme-name</span>);
  }
}
</code></pre>
<p><strong>技术亮点</strong>：</p>
<ul>
<li>使用 <code>@each</code> 循环自动生成主题变体</li>
<li>通过 <code>map-get()</code> 函数动态获取主题色彩</li>
<li>支持运行时主题切换，无需重新编译</li>
</ul>
<h3 data-id="heading-8">2. 声波动画效果</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@keyframes</span> playingWave {
  <span class="hljs-number">0%</span>,
  <span class="hljs-number">100%</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-number">15</span>rpx;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scaleY</span>(<span class="hljs-number">1</span>);
  }
  <span class="hljs-number">50%</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-number">80</span>rpx;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scaleY</span>(<span class="hljs-number">1.2</span>);
  }
}

<span class="hljs-variable">$wave-colors</span>: (
  <span class="hljs-number">1</span>: <span class="hljs-built_in">linear-gradient</span>(to top, <span class="hljs-number">#4fc3f7</span>, <span class="hljs-number">#81d4fa</span>),
  <span class="hljs-number">2</span>: <span class="hljs-built_in">linear-gradient</span>(to top, <span class="hljs-number">#ce93d8</span>, <span class="hljs-number">#e1bee7</span>),
  <span class="hljs-number">3</span>: <span class="hljs-built_in">linear-gradient</span>(to top, <span class="hljs-number">#ffcc80</span>, <span class="hljs-number">#ffb74d</span>),
  <span class="hljs-number">4</span>: <span class="hljs-built_in">linear-gradient</span>(to top, <span class="hljs-number">#a5d6a7</span>, <span class="hljs-number">#81c784</span>),
  <span class="hljs-number">5</span>: <span class="hljs-built_in">linear-gradient</span>(to top, <span class="hljs-number">#f8bbd9</span>, <span class="hljs-number">#f48fb1</span>),
);

<span class="hljs-keyword">@each</span> <span class="hljs-variable">$index</span>, <span class="hljs-variable">$gradient</span> in <span class="hljs-variable">$wave-colors</span> {
  &amp;<span class="hljs-selector-pseudo">:nth-child</span>(#{$index}) {
    <span class="hljs-attribute">background</span>: <span class="hljs-variable">$gradient</span>;
    &amp;<span class="hljs-selector-class">.playing</span> {
      <span class="hljs-attribute">animation-delay</span>: #{<span class="hljs-variable">$index</span> * -<span class="hljs-number">0.2</span>}s;
    }
  }
}
</code></pre>
<p><strong>动画亮点</strong>：</p>
<ul>
<li>每个波形条独立的渐变色彩</li>
<li>错位的动画延迟创建波浪效果</li>
<li>加载和播放两种不同的动画状态</li>
</ul>
<h2 data-id="heading-9">音效生成技术</h2>
<h3 data-id="heading-10">1. 程序化音效合成</h3>
<p>项目采用 Web Audio API 原理，通过数学算法生成按钮点击音效：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">initClickSound</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> sampleRate = <span class="hljs-number">44100</span>;
  <span class="hljs-keyword">const</span> duration = <span class="hljs-number">0.02</span>;
  <span class="hljs-keyword">const</span> samples = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(sampleRate * duration);
  <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">44</span> + samples * <span class="hljs-number">2</span>);
  <span class="hljs-keyword">const</span> view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(buffer);

  <span class="hljs-comment">// WAV 文件头生成</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">writeString</span> = (<span class="hljs-params">offset, string</span>) =&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; string.<span class="hljs-property">length</span>; i++) {
      view.<span class="hljs-title function_">setUint8</span>(offset + i, string.<span class="hljs-title function_">charCodeAt</span>(i));
    }
  };

  <span class="hljs-comment">// 音频数据生成</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; samples; i++) {
    <span class="hljs-keyword">const</span> t = i / sampleRate;
    <span class="hljs-keyword">const</span> progress = t / duration;
    <span class="hljs-keyword">const</span> frequency = <span class="hljs-number">1200</span>; <span class="hljs-comment">// 清脆的点击声频率</span>
    <span class="hljs-keyword">const</span> envelope = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">exp</span>(-progress * <span class="hljs-number">15</span>); <span class="hljs-comment">// 快速衰减包络</span>
    <span class="hljs-keyword">const</span> sample = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(<span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * frequency * t) * envelope * <span class="hljs-number">0.3</span>;
    <span class="hljs-keyword">const</span> intSample = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
      -<span class="hljs-number">32768</span>,
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">32767</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(sample * <span class="hljs-number">32767</span>))
    );
    view.<span class="hljs-title function_">setInt16</span>(<span class="hljs-number">44</span> + i * <span class="hljs-number">2</span>, intSample, <span class="hljs-literal">true</span>);
  }
};
</code></pre>
<p><strong>技术优势</strong>：</p>
<ul>
<li><strong>零延迟</strong>：无需网络请求，本地生成</li>
<li><strong>体积小</strong>：20ms 音效仅几 KB</li>
<li><strong>可定制</strong>：频率、包络、音量可调</li>
<li><strong>兼容性好</strong>：标准 WAV 格式，全平台支持</li>
</ul>
<h3 data-id="heading-11">2. 音频池优化策略</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">initAudioPool</span> = (<span class="hljs-params">audioPath</span>) =&gt; {
  audioPool = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; poolSize; i++) {
    <span class="hljs-keyword">const</span> audio = wx.<span class="hljs-title function_">createInnerAudioContext</span>();
    audio.<span class="hljs-property">src</span> = audioPath;
    audio.<span class="hljs-property">volume</span> = <span class="hljs-number">0.45</span>;
    audio.<span class="hljs-property">autoplay</span> = <span class="hljs-literal">false</span>;
    audioPool.<span class="hljs-title function_">push</span>(audio);
  }
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">playClickSound</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (audioPool.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> audio = audioPool[currentPoolIndex];
    audio.<span class="hljs-title function_">play</span>();
    currentPoolIndex = (currentPoolIndex + <span class="hljs-number">1</span>) % poolSize;
  }
};
</code></pre>
<p><strong>优化原理</strong>：</p>
<ul>
<li><strong>预加载</strong>：避免播放时的延迟</li>
<li><strong>轮询使用</strong>：防止音频实例冲突</li>
<li><strong>内存管理</strong>：固定池大小，控制资源占用</li>
</ul>
<h2 data-id="heading-12">语音播报后端实现</h2>
<h3 data-id="heading-13">1. 微软 TTS 服务部署</h3>
<p>项目使用微软开源的 TTS 镜像</p>
<p><strong>Docker 部署命令</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d \
  --name microsoft-tts \
  -p 8080:8080 \
  -e AZURE_SPEECH_KEY=your_key \
  -e AZURE_SPEECH_REGION=your_region \
  microsoft/cognitive-services-speech-to-text
</code></pre>
<p><strong>API 接口设计</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">playTTS</span> = (<span class="hljs-params">text, voice, speed</span>) =&gt; {
  <span class="hljs-keyword">return</span> uni.<span class="hljs-title function_">request</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">"https://xxx.com/tts/v1/audio/speech"</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
    <span class="hljs-attr">data</span>: {
      <span class="hljs-attr">input</span>: text,
      <span class="hljs-attr">voice</span>: <span class="hljs-string">"zh-CN-XiaoyiNeural"</span>, <span class="hljs-comment">// 微软小艺语音</span>
      <span class="hljs-attr">response_format</span>: <span class="hljs-string">"mp3"</span>,
      <span class="hljs-attr">speed</span>: speed || <span class="hljs-number">1.0</span>,
    },
    <span class="hljs-attr">responseType</span>: <span class="hljs-string">"arraybuffer"</span>,
  });
};
</code></pre>
<h3 data-id="heading-14">2. 音频流处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">playAudio</span> = (<span class="hljs-params"/>) =&gt; {
  isLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  uni.<span class="hljs-title function_">request</span>({
    <span class="hljs-comment">// ... API 配置</span>
    <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
      <span class="hljs-comment">// 生成唯一文件名避免缓存冲突</span>
      <span class="hljs-keyword">const</span> timestamp = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">const</span> random = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>);
      <span class="hljs-keyword">const</span> filePath = <span class="hljs-string">`<span class="hljs-subst">${uni.env.USER_DATA_PATH}</span>/audio_<span class="hljs-subst">${timestamp}</span>_<span class="hljs-subst">${random}</span>.mp3`</span>;

      fs.<span class="hljs-title function_">writeFile</span>({
        <span class="hljs-attr">filePath</span>: filePath,
        <span class="hljs-attr">data</span>: res.<span class="hljs-property">data</span>,
        <span class="hljs-attr">encoding</span>: <span class="hljs-string">"binary"</span>,
        <span class="hljs-attr">success</span>: <span class="hljs-function">() =&gt;</span> {
          isLoading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
          isPlaying.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
          innerAudioContext.<span class="hljs-property">src</span> = filePath;
          innerAudioContext.<span class="hljs-title function_">play</span>();

          <span class="hljs-comment">// 播放完成后清理临时文件</span>
          innerAudioContext.<span class="hljs-title function_">onEnded</span>(<span class="hljs-function">() =&gt;</span> {
            isPlaying.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
            fs.<span class="hljs-title function_">unlink</span>({ filePath });
          });
        },
      });
    },
  });
};
</code></pre>
<p><strong>技术特点</strong>：</p>
<ul>
<li><strong>流式处理</strong>：ArrayBuffer 直接写入文件</li>
<li><strong>临时文件管理</strong>：播放后自动清理，节省存储</li>
<li><strong>状态同步</strong>：加载和播放状态实时更新 UI</li>
<li><strong>错误处理</strong>：网络异常时的优雅降级</li>
</ul>
<h3 data-id="heading-15">3. 语音参数优化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> difficulties = {
  <span class="hljs-attr">easy</span>: { <span class="hljs-attr">speed</span>: <span class="hljs-number">0.7</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">"舒缓"</span> },
  <span class="hljs-attr">normal</span>: { <span class="hljs-attr">speed</span>: <span class="hljs-number">1.0</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">"正常"</span> },
  <span class="hljs-attr">hard</span>: { <span class="hljs-attr">speed</span>: <span class="hljs-number">1.5</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">"急促"</span> },
};
</code></pre>
<p><strong>语音配置</strong>：</p>
<ul>
<li><strong>语音模型</strong>：<code>zh-CN-XiaoyiNeural</code>（微软小艺，自然度高）</li>
<li><strong>音频格式</strong>：MP3（压缩率好，兼容性强）</li>
<li><strong>速度调节</strong>：0.7x - 1.5x 范围，适应不同难度</li>
</ul>
<h2 data-id="heading-16">项目架构设计</h2>
<h3 data-id="heading-17">1. 项目目录结构</h3>
<pre><code class="hljs language-perl" lang="perl">memory-game/
├── .gitignore                    <span class="hljs-comment"># Git 忽略文件配置</span>
├── .hbuilderx/                   <span class="hljs-comment"># HBuilderX 编辑器配置</span>
│   └── launch.json              <span class="hljs-comment"># 启动配置</span>
├── .prettierrc.cjs              <span class="hljs-comment"># 代码格式化配置</span>
├── App.vue                      <span class="hljs-comment"># 应用根组件</span>
├── components/                   <span class="hljs-comment"># 可复用组件目录</span>
│   ├── CustomToast.vue          <span class="hljs-comment"># 自定义提示组件</span>
│   ├── DifficultySelector.vue   <span class="hljs-comment"># 难度选择器组件</span>
│   ├── NumberKeypad.vue         <span class="hljs-comment"># 数字键盘组件</span>
│   └── SoundWave.vue            <span class="hljs-comment"># 声波可视化组件</span>
├── composables/                  <span class="hljs-comment"># 组合式函数目录</span>
│   ├── useAudio.js              <span class="hljs-comment"># 音频处理逻辑</span>
│   └── useGame.js               <span class="hljs-comment"># 游戏核心逻辑</span>
├── pages/                        <span class="hljs-comment"># 页面目录</span>
│   └── <span class="hljs-keyword">index</span>/                   <span class="hljs-comment"># 首页目录</span>
│       └── index.vue            <span class="hljs-comment"># 游戏主页面</span>
├── index.html                   <span class="hljs-comment"># HTML 入口文件</span>
├── main.js                      <span class="hljs-comment"># 应用入口文件</span>
├── manifest.json                <span class="hljs-comment"># uni-app 应用配置</span>
├── pages.json                   <span class="hljs-comment"># 页面路由配置</span>
├── uni.promisify.adaptor.js     <span class="hljs-comment"># uni-app Promise 适配器</span>
└── uni.scss                     <span class="hljs-comment"># 全局样式文件</span>
</code></pre>
<p><strong>目录设计原则</strong>：</p>
<ul>
<li><strong>组件化</strong>：<code>components/</code> 存放可复用的 UI 组件</li>
<li><strong>逻辑分离</strong>：<code>composables/</code> 存放业务逻辑和状态管理</li>
<li><strong>页面隔离</strong>：<code>pages/</code> 按功能模块组织页面文件</li>
<li><strong>配置集中</strong>：根目录存放各种配置文件</li>
</ul>
<h3 data-id="heading-18">2. Composables 模式</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useGame.js - 游戏逻辑</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGame</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> level = <span class="hljs-title function_">ref</span>(<span class="hljs-number">7</span>);
  <span class="hljs-keyword">const</span> gameStatus = <span class="hljs-title function_">ref</span>(<span class="hljs-string">"initial"</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">startGame</span> = (<span class="hljs-params"/>) =&gt; {
    gameStatus.<span class="hljs-property">value</span> = <span class="hljs-string">"playing"</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">generateNumber</span>();
  };

  <span class="hljs-keyword">return</span> { level, gameStatus, startGame };
}

<span class="hljs-comment">// useAudio.js - 音频处理</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useAudio</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">initAudio</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">/* ... */</span>
  };
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">playTTS</span> = (<span class="hljs-params">text, voice, speed</span>) =&gt; {
    <span class="hljs-comment">/* ... */</span>
  };

  <span class="hljs-keyword">return</span> { initAudio, playTTS };
}
</code></pre>
<p><strong>架构优势</strong>：</p>
<ul>
<li><strong>逻辑分离</strong>：游戏逻辑与音频处理解耦</li>
<li><strong>可复用性</strong>：Composables 可在多个组件中使用</li>
<li><strong>测试友好</strong>：纯函数易于单元测试</li>
</ul>
<h3 data-id="heading-19">2. 组件化设计</h3>
<ul>
<li><strong>CustomToast.vue</strong>：统一的消息提示组件</li>
<li><strong>SoundWave.vue</strong>：声波可视化组件</li>
<li><strong>DifficultySelector.vue</strong>：难度选择器</li>
<li><strong>NumberKeypad.vue</strong>：数字键盘组件</li>
</ul>
<h2 data-id="heading-20">性能优化策略</h2>
<h3 data-id="heading-21">1. 音频优化</h3>
<ul>
<li><strong>音频池</strong>：避免频繁创建/销毁音频实例</li>
<li><strong>预加载</strong>：关键音效提前加载</li>
<li><strong>格式选择</strong>：MP3 平衡质量与体积</li>
</ul>
<h3 data-id="heading-22">2. 内存管理</h3>
<ul>
<li><strong>临时文件清理</strong>：播放后立即删除</li>
<li><strong>组件懒加载</strong>：按需加载非关键组件</li>
<li><strong>事件监听清理</strong>：组件销毁时移除监听器</li>
</ul>
<h3 data-id="heading-23">3. 用户体验</h3>
<ul>
<li><strong>零延迟输入</strong>：按钮响应与音效播放异步处理</li>
<li><strong>状态反馈</strong>：加载、播放状态的视觉提示</li>
<li><strong>错误处理</strong>：网络异常时的友好提示</li>
</ul>
<h2 data-id="heading-24">总结</h2>
<p>这个瞬间听力测试微信小程序项目展示了现代前端开发的多个技术亮点：</p>
<ol>
<li><strong>CSS 工程化</strong>：主题系统、Mixin 复用、动画优化</li>
<li><strong>音效技术</strong>：程序化合成、音频池优化</li>
<li><strong>语音服务</strong>：微软 TTS 集成、流式音频处理</li>
<li><strong>架构设计</strong>：Composables 模式、组件化开发</li>
<li><strong>性能优化</strong>：内存管理、用户体验优化</li>
</ol>
<p>项目不仅实现了完整的游戏功能，更在技术实现上体现了工程化思维和用户体验的深度考虑。通过合理的架构设计和优化策略，确保了应用在各种设备上的流畅运行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Window和WindowManager源码解析]]></title>    <link>https://juejin.cn/post/7602259669706801178</link>    <guid>https://juejin.cn/post/7602259669706801178</guid>    <pubDate>2026-02-03T01:27:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602259669706801178" data-draft-id="7601077764424466482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Window和WindowManager源码解析"/> <meta itemprop="keywords" content="源码"/> <meta itemprop="datePublished" content="2026-02-03T01:27:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XRay"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685869288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Window和WindowManager源码解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685869288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XRay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T01:27:26.000Z" title="Tue Feb 03 2026 01:27:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文源码基于 Android 11.0</p>
<h2 data-id="heading-0">一、Window 和 WindowManager</h2>
<p>Window 是一个抽象类，其唯一具体实现是 PhoneWindow。Android 中的所有视图都是通过 Window 来呈现的，不管是 Actvity、Dialog 还是 Toast，它们的视图实际都是附加在 Window 上的，因此 <strong>Window 是 View 的直接管理者</strong> 。当我们调用 Activity 的 setContentView() 方法时，最终会调用 Window 的 setContentView() ，当我们调用 Activity 的 findViewById() 时，其实最终调用的是 Window 的 findViewById() 。</p>
<p>WindowManager 是一个接口，从名称就可以看出来，它是用来管理窗口的，它继承自 ViewManager 接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WindowManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewManager</span> {

}
</code></pre>
<p>ViewManager 接口中只有 3 个方法，分别用来添加、更新和删除 View ：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ViewManager</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(View view, ViewGroup.LayoutParams params)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateViewLayout</span><span class="hljs-params">(View view, ViewGroup.LayoutParams params)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeView</span><span class="hljs-params">(View view)</span>;
}
</code></pre>
<p>WindowManager 继承自 ViewManager，也就拥有了这 3 个功能。</p>
<p>使用 WindowManager 的 addView() 方法即可添加一个 Window：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">OVERLAY_PERMISSION_REQ_CODE</span> <span class="hljs-operator">=</span> <span class="hljs-number">12</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">openWindow</span><span class="hljs-params">(View view)</span> {
        <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {
            <span class="hljs-keyword">if</span> (!Settings.canDrawOverlays(<span class="hljs-built_in">this</span>)) {
                <span class="hljs-comment">// 开启权限</span>
                <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Settings.ACTION_MANAGE_OVERLAY_PERMISSION, Uri.parse(<span class="hljs-string">"package:"</span> + MainActivity.<span class="hljs-built_in">this</span>.getPackageName()));
                startActivityForResult(intent, OVERLAY_PERMISSION_REQ_CODE);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 已经开启了权限</span>
                addWindow();
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 6.0 以下直接在 Manifest 中申请权限就行了。</span>
            addWindow();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addWindow</span><span class="hljs-params">()</span> {
        WindowManager.<span class="hljs-type">LayoutParams</span> <span class="hljs-variable">layoutParams</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowManager</span>.LayoutParams();
        layoutParams.type = WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY;
        layoutParams.format = PixelFormat.TRANSLUCENT;
        layoutParams.flags = WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE;
        layoutParams.gravity = Gravity.LEFT | Gravity.TOP;
        layoutParams.width = WindowManager.LayoutParams.WRAP_CONTENT;
        layoutParams.height = WindowManager.LayoutParams.WRAP_CONTENT;
        layoutParams.x = <span class="hljs-number">100</span>;
        layoutParams.y = <span class="hljs-number">300</span>;

        <span class="hljs-type">Button</span> <span class="hljs-variable">button</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Button</span>(<span class="hljs-built_in">this</span>);
        button.setText(<span class="hljs-string">"button"</span>);

        <span class="hljs-type">WindowManager</span> <span class="hljs-variable">windowManager</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getWindowManager();
        <span class="hljs-comment">// 调用 addView() 方法添加 Window</span>
        windowManager.addView(button, layoutParams);
    }
}
</code></pre>
<p>这里添加的是系统类型的 Window ，需要在 Manifest 文件中添加权限：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.SYSTEM_ALERT_WINDOW"</span>/&gt;</span>
</code></pre>
<p>上述代码将一个 Button 添加到了屏幕上坐标为（100，300）的位置上，其中 WindowManager.LayoutParams 的 flags 和 type 这两个参数比较重要。</p>
<p><strong>Flags 参数</strong>可以控制 Window 的显示特性，有下面几个比较常用：</p>
<ol>
<li><strong>FLAG_NOT_FOCUSABLE</strong>，表示该 Window 不需要获取焦点，也不需要接收输入事件，此标记会同时启用 FLAG_NOT_TOUCH_MODAL，最终事件会直接传递给下层的具有焦点的 Window 。</li>
<li><strong>FLAG NOT_TOUCH_MODAL</strong>，表示系统会将当前 Window 区域以外的单击事件传递给底层的 Window ，当前 Window 区域以内的单击事件则自己处理。这个标记很重要，一般来说都需要开启此标记，否则其他 Window 将无法收到单击事件。</li>
<li><strong>FLAG_SHOW_WHEN_LOCKED</strong>，开启此模式可以让 Window 显示在锁屏的界面上。</li>
</ol>
<p><strong>Type 参数</strong>表示 Window 的类型，有三种，分别是<strong>应用 Window 、子 Window 和系统 Window</strong> 。应用类 Window 对应着一个 Activity 。子 Window 不能单独存在，它需要附属在特定的父 Window 之中，比如常见的一些 Dialog 就是子 Window 。系统 Window 是需要声明权限才能创建的 Window ，比如 Toast（在 API 26+ 上不需要权限，但有限制：不能获取焦点、不能触摸）和系统状态栏这些都是系统 Window 。</p>
<p>Window 是分层的，每个 Widow 都有对应的 z-ordered ，层级大的会覆盖在层级小的 Window 的上面。在三类 Window 中，应用 Window 的层级范围是 1—99 ，子 Window 的层级范围是 1000—1999 ，系统 Window 的层级范围是 2000—2999 ，这些层级范围对应着 WindowManager.LayoutParams 的 type 参数：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WindowManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewManager</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LayoutParams</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewGroup</span>.LayoutParams <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Parcelable</span> {
        <span class="hljs-meta">@WindowType</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> type;

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">FIRST_APPLICATION_WINDOW</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_BASE_APPLICATION</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_APPLICATION</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">TYPE_APPLICATION_STARTING</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
        ...
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">LAST_APPLICATION_WINDOW</span> <span class="hljs-operator">=</span> <span class="hljs-number">99</span>;

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">FIRST_SUB_WINDOW</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;
        ...
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">LAST_SUB_WINDOW</span> <span class="hljs-operator">=</span> <span class="hljs-number">1999</span>;

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">FIRST_SYSTEM_WINDOW</span> <span class="hljs-operator">=</span> <span class="hljs-number">2000</span>;
        ...
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">LAST_SYSTEM_WINDOW</span> <span class="hljs-operator">=</span> <span class="hljs-number">2999</span>;
    }
}
</code></pre>
<p>如果想要 Window 位于所有 Window 的最顶层，那么采用较大的层级即可。很显然系统 Window 的层级是最大的，而且系统层级有很多值，一般我们可以选用 TYPE_SYSTEM_OVERLAY 或者 TYPE_SYSTEM_ERROR 。</p>
<h2 data-id="heading-1">二、Window 的内部机制</h2>
<p>Window 是一个抽象的概念，每一个 Window 都对应着一个 View 和一个 ViewRootImpl，Window 和 View 通过 ViewRootImpl 来建立联系，因此 Window 并不是实际存在的，它是以 View 的形式存在的。这点从 WindowManager 的定义也可以看出，它提供的三个接口方法 addView()、updateViewLayout() 以及 removeView() 都是针对 View 的，这说明 View 才是 Window 存在的实体。在实际使用中无法直接访问 Window，对 Window 的访问必须通过 WindowManager。为了分析 Window 的内部机制，这里从 Window 的添加、删除以及更新说起。</p>
<h3 data-id="heading-2">2.1 Window 的添加</h3>
<p>Window 的添加过程需要通过 WindowManager 的 addView() 方法来实现，WindowManager 是一个接口，它的真正实现是 WindowManagerImpl 类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WindowManager</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">WindowManagerGlobal</span> <span class="hljs-variable">mGlobal</span> <span class="hljs-operator">=</span> WindowManagerGlobal.getInstance();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View view, <span class="hljs-meta">@NonNull</span> ViewGroup.LayoutParams params)</span> {
        ...
        mGlobal.addView(view, params, mContext.getDisplayNoVerify(), mParentWindow, mContext.getUserId());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateViewLayout</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View view, <span class="hljs-meta">@NonNull</span> ViewGroup.LayoutParams params)</span> {
        ...
        mGlobal.updateViewLayout(view, params);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeView</span><span class="hljs-params">(View view)</span> {
        mGlobal.removeView(view, <span class="hljs-literal">false</span>);
    } 
} 
</code></pre>
<p>可以发现，WindowManagerImpl 并没有直接实现 Window 的这三大操作，而是全部交给了 WindowManagerGlobal 来处理，WindowManagerGlobal 以单例的形式向外提供自己的实例，WindowManagerImpl 这种工作模式是典型的桥接模式。</p>
<p>WindowManagerGlobal 的 addView() 方法如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerGlobal</span> {
    <span class="hljs-comment">// 存储的是所有 Window 所对应的根 View</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; mViews = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;View&gt;();
    <span class="hljs-comment">// 存储的是所有 Window 所对应的 ViewRootImpl</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;ViewRootImpl&gt; mRoots = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ViewRootImpl&gt;();
    <span class="hljs-comment">// 存储的是所有 Window 所对应的布局参数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;WindowManager.LayoutParams&gt; mParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;WindowManager.LayoutParams&gt;();
    <span class="hljs-comment">// 存储的是那些正在被删除的 View 对象，或者说是那些已经调用 remoView() 方法</span>
    <span class="hljs-comment">// 但是删除操作还未完成的 Window 对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArraySet&lt;View&gt; mDyingViews = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArraySet</span>&lt;View&gt;();

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> WindowManagerGlobal sDefaultWindowManager;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WindowManagerGlobal <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (WindowManagerGlobal.class) {
            <span class="hljs-keyword">if</span> (sDefaultWindowManager == <span class="hljs-literal">null</span>) {
                sDefaultWindowManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowManagerGlobal</span>();
            }
            <span class="hljs-keyword">return</span> sDefaultWindowManager;
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(View view, ViewGroup.LayoutParams params,
                        Display display, Window parentWindow, <span class="hljs-type">int</span> userId)</span> {
        <span class="hljs-comment">// 检查参数的合法性</span>
        <span class="hljs-keyword">if</span> (view == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"view must not be null"</span>);
        }
        <span class="hljs-keyword">if</span> (display == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"display must not be null"</span>);
        }
        <span class="hljs-keyword">if</span> (!(params <span class="hljs-keyword">instanceof</span> WindowManager.LayoutParams)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Params must be WindowManager.LayoutParams"</span>);
        }
        ...
        <span class="hljs-comment">// 如果是子 Window 还需要调整布局参数</span>
        <span class="hljs-keyword">final</span> WindowManager.<span class="hljs-type">LayoutParams</span> <span class="hljs-variable">wparams</span> <span class="hljs-operator">=</span> (WindowManager.LayoutParams) params;
        <span class="hljs-keyword">if</span> (parentWindow != <span class="hljs-literal">null</span>) {
            parentWindow.adjustLayoutParamsForSubWindow(wparams);
        }

        ViewRootImpl root;
        ...
        <span class="hljs-comment">// 创建 ViewRootImpl 实例</span>
        root = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewRootImpl</span>(view.getContext(), display);

        view.setLayoutParams(wparams);

        mViews.add(view);
        mRoots.add(root);
        mParams.add(wparams);

        <span class="hljs-comment">// do this last because it fires off messages to start doing things</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 更新界面并完成 Window 的添加</span>
            root.setView(view, wparams, panelParentView, userId);
        } <span class="hljs-keyword">catch</span> (RuntimeException e) {
            <span class="hljs-comment">// BadTokenException or InvalidDisplayException, clean up.</span>
            <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) {
                removeViewLocked(index, <span class="hljs-literal">true</span>);
            }
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p>addView() 方法里面主要做了这些事情：</p>
<ol>
<li>检查参数是否合法。</li>
<li>创建 ViewRootImpl 并将 View 添加到列表中。</li>
<li>通过 ViewRootImpl 来更新界面并完成 Window 的添加。</li>
</ol>
<p>ViewRootImpl 的 setView() 方法代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewRootImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ViewParent</span>,
        View.AttachInfo.Callbacks, ThreadedRenderer.DrawCallbacks {
        
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ViewRootImpl</span><span class="hljs-params">(Context context, Display display)</span> {
        <span class="hljs-built_in">this</span>(context, display, WindowManagerGlobal.getWindowSession(),
                <span class="hljs-literal">false</span> <span class="hljs-comment">/* useSfChoreographer */</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ViewRootImpl</span><span class="hljs-params">(Context context, Display display, IWindowSession session)</span> {
        <span class="hljs-built_in">this</span>(context, display, session, <span class="hljs-literal">false</span> <span class="hljs-comment">/* useSfChoreographer */</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ViewRootImpl</span><span class="hljs-params">(Context context, Display display, IWindowSession session,
            <span class="hljs-type">boolean</span> useSfChoreographer)</span> {
        mContext = context;
        mWindowSession = session;   
        ...
    }    

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setView</span><span class="hljs-params">(View view, WindowManager.LayoutParams attrs, View panelParentView,
                        <span class="hljs-type">int</span> userId)</span> {
        ...
        res = mWindowSession.addToDisplayAsUser(mWindow, mSeq, mWindowAttributes,
                getHostVisibility(), mDisplay.getDisplayId(), userId, mTmpFrame,
                mAttachInfo.mContentInsets, mAttachInfo.mStableInsets,
                mAttachInfo.mDisplayCutout, inputChannel,
                mTempInsets, mTempControls);
        setFrame(mTmpFrame);
        ...
    }
}
</code></pre>
<p>Window 的添加是通过 mWindowSession 的 addToDisplayAsUser() 方法来完成的，mWindowSession 的类型是 IWindowSession ，它是一个 Binder 对象，真正的实现类是 Session，也就是 Window 的添加过程是一次 IPC 调用，在 Session 内部会通过 WindowManagerService 来添加 Window ：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Session</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IWindowSession</span>.Stub <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBinder</span>.DeathRecipient {

    <span class="hljs-keyword">final</span> WindowManagerService mService;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Session</span><span class="hljs-params">(WindowManagerService service, IWindowSessionCallback callback)</span> {
        mService = service;
        mCallback = callback;
        ...
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addToDisplayAsUser</span><span class="hljs-params">(IWindow window, <span class="hljs-type">int</span> seq, WindowManager.LayoutParams attrs,
                                  <span class="hljs-type">int</span> viewVisibility, <span class="hljs-type">int</span> displayId, <span class="hljs-type">int</span> userId, Rect outFrame,
                                  Rect outContentInsets, Rect outStableInsets,
                                  DisplayCutout.ParcelableWrapper outDisplayCutout, InputChannel outInputChannel,
                                  InsetsState outInsetsState, InsetsSourceControl[] outActiveControls)</span> {
        <span class="hljs-comment">// 调用 WindowManagerService 的 addWindow() 方法</span>
        <span class="hljs-keyword">return</span> mService.addWindow(<span class="hljs-built_in">this</span>, window, seq, attrs, viewVisibility, displayId, outFrame,
                outContentInsets, outStableInsets, outDisplayCutout, outInputChannel,
                outInsetsState, outActiveControls, userId);
    }
}
</code></pre>
<p>如此一来，Window 的添加请求就交给了 WMS 去处理了，在 WMS 内部会为每一个应用保留一个单独的 Session。</p>
<h3 data-id="heading-3">2.2 Window 的删除过程</h3>
<p>Window 的删除过程和添加过程一样，都是先通过 WindowManagerImpl 后，再进一步通过 WindowManagerGlobal 来实现的。下面是 WindowManagerGlobal 的 removeView() 的实现:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeView</span><span class="hljs-params">(View view, <span class="hljs-type">boolean</span> immediate)</span> {
    <span class="hljs-keyword">if</span> (view == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"view must not be null"</span>);
    }

    <span class="hljs-keyword">synchronized</span> (mLock) {
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> findViewLocked(view, <span class="hljs-literal">true</span>);
        <span class="hljs-type">View</span> <span class="hljs-variable">curView</span> <span class="hljs-operator">=</span> mRoots.get(index).getView();
        removeViewLocked(index, immediate);
        <span class="hljs-keyword">if</span> (curView == view) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Calling with view "</span> + view
                + <span class="hljs-string">" but the ViewAncestor is attached to "</span> + curView);
    }
}
</code></pre>
<p>里面首先通过 findViewLocked() 来查找待删除的 View 的索引，就是去上面的 mView 中查找要删除的 View ，然后再调用 removeViewLocked() 方法:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeViewLocked</span><span class="hljs-params">(<span class="hljs-type">int</span> index, <span class="hljs-type">boolean</span> immediate)</span> {
    <span class="hljs-comment">// 找到对应的 ViewRootImpl</span>
    <span class="hljs-type">ViewRootImpl</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> mRoots.get(index);
    <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> root.getView();

    <span class="hljs-keyword">if</span> (root != <span class="hljs-literal">null</span>) {
        root.getImeFocusController().onWindowDismissed();
    }
    <span class="hljs-comment">// 调用 ViewRootImpl 的 die() 方法来删除</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">deferred</span> <span class="hljs-operator">=</span> root.die(immediate);
    <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) {
        view.assignParent(<span class="hljs-literal">null</span>);
        <span class="hljs-keyword">if</span> (deferred) {
            mDyingViews.add(view);
        }
    }
}
</code></pre>
<p>参数 immediate 为 false 时表示异步删除， immediate 为 true 时表示同步删除。一般来说不会使用同步删除，以免发生意外。具体的删除操作由 ViewRootImpl 的 die() 方法来完成：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">die</span><span class="hljs-params">(<span class="hljs-type">boolean</span> immediate)</span> {
    <span class="hljs-comment">// Make sure we do execute immediately if we are in the middle of a traversal or the damage</span>
    <span class="hljs-comment">// done by dispatchDetachedFromWindow will cause havoc on return.</span>
    <span class="hljs-keyword">if</span> (immediate &amp;&amp; !mIsInTraversal) {
        doDie();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">if</span> (!mIsDrawing) {
        destroyHardwareRenderer();
    } <span class="hljs-keyword">else</span> {
        Log.e(mTag, <span class="hljs-string">"Attempting to destroy the window while drawing!\n"</span> +
                <span class="hljs-string">" window="</span> + <span class="hljs-built_in">this</span> + <span class="hljs-string">", title="</span> + mWindowAttributes.getTitle());
    }
    mHandler.sendEmptyMessage(MSG_DIE);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>die() 方法内部判断如果是同步删除（立即删除），直接调用 doDie()，内部调用dispatchDetachedFromWindow() 方法，真正删除 View 的逻辑就在dispatchDetachedFromWindow() 方法中。如果是异步删除，那么就发送一个 MSG_DIE 的消息，ViewRootImpl 中的 Hander 会处理此消息并调用 doDie() 方法。dispatchDetachedFromWindow() 方法代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatchDetachedFromWindow</span><span class="hljs-params">()</span> {
    mInsetsController.onWindowFocusLost();
    mFirstInputStage.onDetachedFromWindow();
    <span class="hljs-keyword">if</span> (mView != <span class="hljs-literal">null</span> &amp;&amp; mView.mAttachInfo != <span class="hljs-literal">null</span>) {
        mAttachInfo.mTreeObserver.dispatchOnWindowAttachedChange(<span class="hljs-literal">false</span>);
        <span class="hljs-comment">// 回调 View 的 dispatchDetachedFromWindow() 方法</span>
        mView.dispatchDetachedFromWindow();
    }

    <span class="hljs-comment">// 移除各种回调</span>
    mAccessibilityInteractionConnectionManager.ensureNoConnection();
    mAccessibilityManager.removeAccessibilityStateChangeListener(
            mAccessibilityInteractionConnectionManager);
    mAccessibilityManager.removeHighTextContrastStateChangeListener(
            mHighContrastTextManager);
    removeSendWindowContentChangedCallback();

    destroyHardwareRenderer();

    setAccessibilityFocus(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);

    mInsetsController.cancelExistingAnimations();

    <span class="hljs-comment">// 清除数据</span>
    mView.assignParent(<span class="hljs-literal">null</span>);
    mView = <span class="hljs-literal">null</span>;
    mAttachInfo.mRootView = <span class="hljs-literal">null</span>;

    destroySurface();

    <span class="hljs-keyword">if</span> (mInputQueueCallback != <span class="hljs-literal">null</span> &amp;&amp; mInputQueue != <span class="hljs-literal">null</span>) {
        mInputQueueCallback.onInputQueueDestroyed(mInputQueue);
        mInputQueue.dispose();
        mInputQueueCallback = <span class="hljs-literal">null</span>;
        mInputQueue = <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 删除 Window</span>
        mWindowSession.remove(mWindow);
    } <span class="hljs-keyword">catch</span> (RemoteException e) {
    }
    <span class="hljs-comment">// Dispose receiver would dispose client InputChannel, too. That could send out a socket</span>
    <span class="hljs-comment">// broken event, so we need to unregister the server InputChannel when removing window to</span>
    <span class="hljs-comment">// prevent server side receive the event and prompt error.</span>
    <span class="hljs-keyword">if</span> (mInputEventReceiver != <span class="hljs-literal">null</span>) {
        mInputEventReceiver.dispose();
        mInputEventReceiver = <span class="hljs-literal">null</span>;
    }

    mDisplayManager.unregisterDisplayListener(mDisplayListener);

    unscheduleTraversals();
}
</code></pre>
<p>dispatchDetachedFromWindow() 方法主要做了这些事情:</p>
<ol>
<li>调用 View 的 dispatchDetachedFromWindow() 方法，在内部会调用 View 的onDetachedFromWindow() 以及 onDetachedFromWindowInternal()。对于onDetachedFromWindow() 大家一定不陌生，当 View 从 Window 中移除时，这个方法就会被调用，可以在这个方法内部做一些资源回收的工作，比如终止动画、停止线程等。</li>
<li>垃圾回收相关的工作，比如清除数据和消息、移除回调。</li>
<li>通过 Session 的 remove() 方法删除 Window——mWindowSession.remove(mWindow)，这同样是一个 IPC 过程，最终会调用 WMS 的 removeWindow() 方法。</li>
</ol>
<h3 data-id="heading-4">2.3 Window的更新过程</h3>
<p>Window 的更新过程还是要从 WindowManagerGlobal 开始分析：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateViewLayout</span><span class="hljs-params">(View view, ViewGroup.LayoutParams params)</span> {
    <span class="hljs-keyword">if</span> (view == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"view must not be null"</span>);
    }
    <span class="hljs-keyword">if</span> (!(params <span class="hljs-keyword">instanceof</span> WindowManager.LayoutParams)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Params must be WindowManager.LayoutParams"</span>);
    }

    <span class="hljs-keyword">final</span> WindowManager.<span class="hljs-type">LayoutParams</span> <span class="hljs-variable">wparams</span> <span class="hljs-operator">=</span> (WindowManager.LayoutParams)params;

    view.setLayoutParams(wparams);

    <span class="hljs-keyword">synchronized</span> (mLock) {
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> findViewLocked(view, <span class="hljs-literal">true</span>);
        <span class="hljs-type">ViewRootImpl</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> mRoots.get(index);
        mParams.remove(index);
        mParams.add(index, wparams);
        root.setLayoutParams(wparams, <span class="hljs-literal">false</span>);
    }
}
</code></pre>
<p>updateViewLayout() 方法做的事情就比较简单了，首先它需要更新 View 的 LayoutParams，接着再更新 ViewRootImpl 中的 LayoutParams，这一步是通过 ViewRootImpl 的 setLayoutParams() 方法来实现的，里面会调用 scheduleTraversals() 方法来对 View 重新布局，包括测量、布局、重绘这三个过程。除了 View 本身的重绘以外，ViewRootImpl 还会通过 WindowSession 来更新 Window 的视图，这个过程最终是由 WMS 的 relayoutWindow() 来具体实现的，它同样是一个 IPC 过程。</p>
<h2 data-id="heading-5">三、Window 的创建过程</h2>
<p>通过上面的分析可以看出，View 是 Android 中的视图的呈现方式，但是 View 不能单独存在，它必须附着在 Window 这个抽象的概念上面，因此有视图的地方就有 Window。哪些地方有视图呢？Android 中可以提供视图的地方有 Activity、Dialog、Toast，除此之外，还有一些依托 Window 而实现的视图，比如 PopUpWindow、菜单，它们也是视图，有视图的地方就有 Window，因此 Activity、Dialog、Toast 等视图都对应着一个 Window。</p>
<h3 data-id="heading-6">3.1 Activity 的 Window 的创建过程</h3>
<p>在 Activity 的启动流程中，会调用 ActivityThread 的 performLaunchActivity() 来完成整个启动过程，里面会通过类加载器创建 Activity 的实例对象，然后调用其 attach() 方法关联上下文环境等参数：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClientTransactionHandler</span> {

    <span class="hljs-keyword">private</span> Activity <span class="hljs-title function_">performLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r, Intent customIntent)</span> {
        <span class="hljs-comment">// 创建 Activity 实例</span>
        activity = mInstrumentation.newActivity(
                cl, component.getClassName(), r.intent);
        ...
        <span class="hljs-comment">// attach() 方法为 Activity 关联上下文环境</span>
        activity.attach(appContext, <span class="hljs-built_in">this</span>, getInstrumentation(), r.token,
                r.ident, app, r.intent, r.activityInfo, title, r.parent,
                r.embeddedID, r.lastNonConfigurationInstances, config,
                r.referrer, r.voiceInteractor, window, r.configCallback,
                r.assistToken);

        <span class="hljs-keyword">return</span> activity;
    }
} 
</code></pre>
<p>ActivityThread 的 attach() 方法代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Activity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ContextThemeWrapper</span>

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(...)</span> {
        ...
        mWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindow</span>(<span class="hljs-built_in">this</span>, window, activityConfigCallback);
        mWindow.setWindowControllerCallback(mWindowControllerCallback);
        mWindow.setCallback(<span class="hljs-built_in">this</span>);
        mWindow.setOnWindowDismissedCallback(<span class="hljs-built_in">this</span>);
        ...
    }
} 
</code></pre>
<p>在 attach() 方法中，系统会创建 Activity 所属的 Window 对象并为其设置回调接口，其中 Window 的具体实现是 PhoneWindow。我们使用 setContentView() 方法，实际调用的是 PhoneWindow 的 setContentView() 方法，该方法里面大致遵循如下几个步骤：</p>
<ol>
<li>如果没有 DecorView，那么就创建它。</li>
<li>将 View 添加到 mContentParent 中。</li>
</ol>
<p>这些步骤在 <a href="https://juejin.cn/post/7301648406198894618" target="_blank" title="https://juejin.cn/post/7301648406198894618">Android View的绘制流程</a> 中基本都分析过了，虽然说早在 Activity 的 attach()方法中 Window 就已经被创建了，但是这个时候由于 DecorView 并没有被 WindowManager 识别，所以这个时候的 Window 无法提供具体功能，还无法接收外界的输入信息。在 ActivityThread 的 handleResumeActivity() 方法中，首先会调用 Activity 的 onResume() 方法，接着会调用 wm.addView(decor, l)，最后调用 r.activity.makeVisible()，这时候 DecorView 才真正地完成了添加和显示这两个过程，到这里 Activity 的视图才能被用户看到。</p>
<h3 data-id="heading-7">3.2 Dialog 的 Window 的创建过程</h3>
<p>Dialog 的 Window 的创建过程与 Activity 类似，有如下几个步骤：</p>
<ol>
<li><strong>创建 Window</strong>。Dialog 的构造方法中会新建一个 PhoneWindow。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dialog</span> {

    Dialog(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@StyleRes</span> <span class="hljs-type">int</span> themeResId, <span class="hljs-type">boolean</span> createContextThemeWrapper) {
        ...
        mWindowManager = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);

        <span class="hljs-keyword">final</span> <span class="hljs-type">Window</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindow</span>(mContext);
        mWindow = w;
        w.setCallback(<span class="hljs-built_in">this</span>);
        w.setOnWindowDismissedCallback(<span class="hljs-built_in">this</span>);
        w.setOnWindowSwipeDismissedCallback(() -&gt; {
            <span class="hljs-keyword">if</span> (mCancelable) {
                cancel();
            }
        });
        w.setWindowManager(mWindowManager, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
        w.setGravity(Gravity.CENTER);

        mListenersHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListenersHandler</span>(<span class="hljs-built_in">this</span>);
    }
}
</code></pre>
<ol start="2">
<li><strong>初始化 DecorView 并将 Dialog 的视图添加到 DecorView 中</strong>。这个过程也和 Activity 类似，都是通过 Window 去添加指定的布局文件。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContentView</span><span class="hljs-params">(<span class="hljs-meta">@LayoutRes</span> <span class="hljs-type">int</span> layoutResID)</span> {
    mWindow.setContentView(layoutResID);
}
</code></pre>
<ol start="3">
<li><strong>将 DecorView 添加到 Window 中并显示</strong>。这里会调用 Dialog 的 show() 方法，通过 WindowManager 将 DecorView 添加到 Window 中，如下：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> {
    ...
    mDecor = mWindow.getDecorView();
    ...
    mWindowManager.addView(mDecor, l);
    ...
    mShowing = <span class="hljs-literal">true</span>;
    ...
}
</code></pre>
<p>从上面 3 个步骤可以发现，Dialog 的 Window 创建与 Activity 几乎没有什么区别。当 Dialog 被关闭时，调用的是 mWindowManager.removeViewImmediate(mDecor) 来移除 DecorView。</p>
<p>普通 Dialog 还有一个特殊之处，就是必须采用 Activity 的 Context，如果采用 Application 的 Context 就会报错。</p>
<pre><code class="hljs language-java" lang="java">Dialog dialog=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Dialog</span>(<span class="hljs-built_in">this</span>.getApplicationContext());
<span class="hljs-type">TextView</span> <span class="hljs-variable">textView</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextView</span>(<span class="hljs-built_in">this</span>);
textView.setText(<span class="hljs-string">"this is toast!"</span>);
dialog.setContentView(textView);
dialog.show();
</code></pre>
<p>报错信息为：<strong>Caused by: android.view.WindowManager$BadTokenException: Unable to add window -- token null is not valid</strong></p>
<p>上面的错误信息很明确，是没有 token 导致的，而应用 token 一般只有 Activity 拥有，所以这里需要用 Activity 作为 Context 来显示对话框即可。另外，系统 Window 比较特殊，它可以不需要 token，因此在上面的例子中，只需要指定对话框的 Window 为系统类型就可以正常弹出对话框，需要添加如下代码：</p>
<pre><code class="hljs language-java" lang="java">dialog.getWindow().setType(WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY)
</code></pre>
<p>当然还需要添加相应的权限。</p>
<h3 data-id="heading-8">3.3 Toast 的 Window 的创建过程</h3>
<p>Toast 与 Dialog 不同，它的工作过程稍显复杂。首先 Toast 也是基于 Window 来实现的，但是由于 Toast 具有定时取消这一功能，所以系统采用了 Handler。在 Toast 的内部有两类 IPC 过程，第一类是 Toast 访问 NotificationManagerService（NMS），第二类是 NMS 回调 Toast 里的 TN 接口。</p>
<p>Toast 属于系统 Window，它内部的视图由两种方式指定，一种是系统默认的样式，另一种是通过 setView() 来指定一个自定义 View，不管如何，它们都对应 Toast 的一个 View 类型的内部成员 mNextView。Toast 提供了 show() 和 cancel() 分别用于显示和隐藏 Toast，它们的内部是一个 IPC 过程，show() 方法和 cancel() 方法的实现如下:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> {
    ...
    <span class="hljs-type">INotificationManager</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> getService();
    <span class="hljs-type">String</span> <span class="hljs-variable">pkg</span> <span class="hljs-operator">=</span> mContext.getOpPackageName();
    <span class="hljs-type">TN</span> <span class="hljs-variable">tn</span> <span class="hljs-operator">=</span> mTN;
    tn.mNextView = mNextView;
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">displayId</span> <span class="hljs-operator">=</span> mContext.getDisplayId();
    ...
    <span class="hljs-keyword">if</span> (Compatibility.isChangeEnabled(CHANGE_TEXT_TOASTS_IN_THE_SYSTEM)) {
        <span class="hljs-keyword">if</span> (mNextView != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// It's a custom toast</span>
            service.enqueueToast(pkg, mToken, tn, mDuration, displayId);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// It's a text toast</span>
            <span class="hljs-type">ITransientNotificationCallback</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span>
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CallbackBinder</span>(mCallbacks, mHandler);
            service.enqueueTextToast(pkg, mToken, mText, mDuration, displayId, callback);
        }
    } <span class="hljs-keyword">else</span> {
        service.enqueueToast(pkg, mToken, tn, mDuration, displayId);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (Compatibility.isChangeEnabled(CHANGE_TEXT_TOASTS_IN_THE_SYSTEM)
            &amp;&amp; mNextView == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
            getService().cancelToast(mContext.getOpPackageName(), mToken);
        } <span class="hljs-keyword">catch</span> (RemoteException e) {
            <span class="hljs-comment">// Empty</span>
        }
    } <span class="hljs-keyword">else</span> {
        mTN.cancel();
    }
}
</code></pre>
<p>从上面的代码可以看到，显示和隐藏 Toast 都需要通过 NMS 来实现，由于 NMS 运行在系统的进程中，所以只能通过远程调用的方式来显示和隐藏 Toast。需要注意的是 TN 这个类，它是一个 Binder 类，在 Toast 和 NMS 进行 IPC 的过程中，当 NMS 处理 Toast 的显示或隐藏请求时会跨进程回调 TN 中的方法，这个时候由于 TN 运行在 Binder 线程池中，所以需要通过 Handler 将其切换到当前线程中。这里的当前线程是指发送 Toast 请求所在的线程。注意，由于这里使用了 Handler，所以这意味着 Toast 无法在没有 Looper 的线程中弹出，这是因为 Handler 需要使用 Looper 才能完成切换线程的功能。</p>
<p>先来看看 Toast 的显示过程，service.enqueueToast() 调用了 NotificationManagerService 的 mService 的
enqueueToast():</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotificationManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SystemService</span> {

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_PACKAGE_NOTIFICATIONS</span> <span class="hljs-operator">=</span> <span class="hljs-number">25</span>;

    <span class="hljs-keyword">final</span> ArrayList&lt;ToastRecord&gt; mToastQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">final</span> <span class="hljs-type">IBinder</span> <span class="hljs-variable">mService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">INotificationManager</span>.Stub() {

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">enqueueTextToast</span><span class="hljs-params">(String pkg, IBinder token, CharSequence text, <span class="hljs-type">int</span> duration,
                                     <span class="hljs-type">int</span> displayId, <span class="hljs-meta">@Nullable</span> ITransientNotificationCallback callback)</span> {
            enqueueToast(pkg, token, text, <span class="hljs-literal">null</span>, duration, displayId, callback);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">enqueueToast</span><span class="hljs-params">(String pkg, IBinder token, ITransientNotification callback,
                                 <span class="hljs-type">int</span> duration, <span class="hljs-type">int</span> displayId)</span> {
            enqueueToast(pkg, token, <span class="hljs-literal">null</span>, callback, duration, displayId, <span class="hljs-literal">null</span>);
        }

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">enqueueToast</span><span class="hljs-params">(String pkg, IBinder token, <span class="hljs-meta">@Nullable</span> CharSequence text,
                                  <span class="hljs-meta">@Nullable</span> ITransientNotification callback, <span class="hljs-type">int</span> duration, <span class="hljs-type">int</span> displayId,
                                  <span class="hljs-meta">@Nullable</span> ITransientNotificationCallback textCallback)</span> {
            ...
            <span class="hljs-keyword">synchronized</span> (mToastQueue) {
                <span class="hljs-type">int</span> <span class="hljs-variable">callingPid</span> <span class="hljs-operator">=</span> Binder.getCallingPid();
                <span class="hljs-type">long</span> <span class="hljs-variable">callingId</span> <span class="hljs-operator">=</span> Binder.clearCallingIdentity();
                <span class="hljs-keyword">try</span> {
                    ToastRecord record;
                    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> indexOfToastLocked(pkg, token);
                    <span class="hljs-comment">// If it's already in the queue, we update it in place, we don't</span>
                    <span class="hljs-comment">// move it to the end of the queue.</span>
                    <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) {
                        record = mToastQueue.get(index);
                        record.update(duration);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// Limit the number of toasts that any given package can enqueue.</span>
                        <span class="hljs-comment">// Prevents DOS attacks and deals with leaks.</span>
                        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
                        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">N</span> <span class="hljs-operator">=</span> mToastQueue.size();
                        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; N; i++) {
                            <span class="hljs-keyword">final</span> <span class="hljs-type">ToastRecord</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> mToastQueue.get(i);
                            <span class="hljs-keyword">if</span> (r.pkg.equals(pkg)) {
                                count++;
                                <span class="hljs-keyword">if</span> (count &gt;= MAX_PACKAGE_NOTIFICATIONS) {
                                    Slog.e(TAG, <span class="hljs-string">"Package has already posted "</span> + count
                                            + <span class="hljs-string">" toasts. Not showing more. Package="</span> + pkg);
                                    <span class="hljs-keyword">return</span>;
                                }
                            }
                        }

                        <span class="hljs-type">Binder</span> <span class="hljs-variable">windowToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Binder</span>();
                        mWindowManagerInternal.addWindowToken(windowToken, TYPE_TOAST, displayId);
                        <span class="hljs-comment">// 获取 ToastRecord</span>
                        record = getToastRecord(callingUid, callingPid, pkg, token, text, callback,
                                duration, windowToken, displayId, textCallback);
                        mToastQueue.add(record);
                        index = mToastQueue.size() - <span class="hljs-number">1</span>;
                        keepProcessAliveForToastIfNeededLocked(callingPid);
                    }
                    <span class="hljs-comment">// If it's at index 0, it's the current toast. It doesn't matter if it's</span>
                    <span class="hljs-comment">// new or just been updated, show it.</span>
                    <span class="hljs-comment">// If the callback fails, this will remove it from the list, so don't</span>
                    <span class="hljs-comment">// assume that it's valid after this.</span>
                    <span class="hljs-keyword">if</span> (index == <span class="hljs-number">0</span>) {
                        <span class="hljs-comment">// 显示当前的 Toast</span>
                        showNextToastLocked();
                    }
                } <span class="hljs-keyword">finally</span> {
                    Binder.restoreCallingIdentity(callingId);
                }
            }

        }
    }

}
</code></pre>
<p>enqueueToast() 首先判断 mToastQueue 中有没有这个 ToastRecord，如果有的话，更新 Toast 时长。如果没有，将 Toast 请求封装为 ToastRecord 对象并将其添加到 mToastQueue 的队列中，mToastQueue 其实是一个ArrayList。对于非系统应用来说，mToastQueue 中最多能同时存在 25 个 ToastRecord，这样做是为了防止 DOS（Denial of Service：拒绝服务）攻击。如果不这么做，试想一下，如果我们通过大量的循环去连续弹出 Toast，这将会导致其他应用没有机会弹出 Toast，那么对于其他应用的 Toast 请求，系统的行为就是拒绝服务，这就是拒绝服务攻击的含义，这种手段常用于网络攻击中。</p>
<p>正常情况下，一个应用不可能达到上限。被添加到 mToastQueue 中后，NMS 就会通过 showNextToastLocked() 方法来显示当前的 Toast。该方法里面先获取 mToastQueue 中的第 1 个ToastRecord，然后进入 While 循环：显示 Toast，把当前 ToastRecord 从 mToastQueue 中移除，再重新获取第 1 个 ToastRecord，直到 mToastQueue 为空为止。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">showNextToastLocked</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 获取 mToastQueue 中的第 1 个 ToastRecord</span>
    <span class="hljs-type">ToastRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> mToastQueue.get(<span class="hljs-number">0</span>);
    <span class="hljs-comment">// While 循环</span>
    <span class="hljs-keyword">while</span> (record != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 显示 Toast</span>
        <span class="hljs-keyword">if</span> (record.show()) {
            scheduleDurationReachedLocked(record);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> mToastQueue.indexOf(record);
        <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 从 mToastQueue 中移除当前 ToastRecord</span>
            mToastQueue.remove(index);
        }
        <span class="hljs-comment">// 重新获取 mToastQueue 中的第 1 个 ToastRecord</span>
        record = (mToastQueue.size() &gt; <span class="hljs-number">0</span>) ? mToastQueue.get(<span class="hljs-number">0</span>) : <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p>首先来看看 record.show()，ToastRecord 是一个抽象类，实现类是 CustomToastRecord，实际调用的是 CustomToastRecord 的 show() 方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomToastRecord</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ToastRecord</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomToastRecord</span><span class="hljs-params">(NotificationManagerService notificationManager, <span class="hljs-type">int</span> uid, <span class="hljs-type">int</span> pid,
                             String packageName, IBinder token, ITransientNotification callback, <span class="hljs-type">int</span> duration,
                             Binder windowToken, <span class="hljs-type">int</span> displayId)</span> {
        <span class="hljs-built_in">super</span>(notificationManager, uid, pid, packageName, token, duration, windowToken, displayId);
        <span class="hljs-built_in">this</span>.callback = checkNotNull(callback);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span> {
        ...
        callback.show(windowToken);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        ...
    }
}
</code></pre>
<p>里面是通过 callback 来完成的，这个 callback 实际是 TN 对象的远程 Binder，通过 callback 来访问 TN 中的方法需要跨进程来完成，最终被调用的 TN 的方法会运行在发起 Toast 请求的应用的 Binder 线程池中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Toast</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TN</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ITransientNotification</span>.Stub {

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">(IBinder windowToken)</span> {
            ...
            mHandler.obtainMessage(SHOW, windowToken).sendToTarget();
        }
    }
}
</code></pre>
<p>这里通过 Handler 发消息切换到主线程：</p>
<pre><code class="hljs language-java" lang="java">mHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Handler</span>(looper, <span class="hljs-literal">null</span>) {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
        <span class="hljs-keyword">switch</span> (msg.what) {
            <span class="hljs-keyword">case</span> SHOW: {
                <span class="hljs-type">IBinder</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> (IBinder) msg.obj;
                handleShow(token);
                <span class="hljs-keyword">break</span>;
            }
            ...
        }
    }
};

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleShow</span><span class="hljs-params">(IBinder windowToken)</span> {
    ...
    <span class="hljs-keyword">if</span> (mView != mNextView) {
        <span class="hljs-comment">// remove the old view if necessary</span>
        handleHide();
        mView = mNextView;
        mPresenter.show(mView, mToken, windowToken, mDuration, mGravity, mX, mY,
                mHorizontalMargin, mVerticalMargin,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">CallbackBinder</span>(getCallbacks(), mHandler));
    }
}
</code></pre>
<p>然后调用了 handleShow() 方法，再调用了 mPresenter.show()，ToastPresenter 的 show() 方法代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToastPresenter</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">(View view, IBinder token, IBinder windowToken, <span class="hljs-type">int</span> duration, <span class="hljs-type">int</span> gravity,
            <span class="hljs-type">int</span> xOffset, <span class="hljs-type">int</span> yOffset, <span class="hljs-type">float</span> horizontalMargin, <span class="hljs-type">float</span> verticalMargin,
            <span class="hljs-meta">@Nullable</span> ITransientNotificationCallback callback)</span> {
        ...
        mWindowManager.addView(mView, mParams);
        ...
    }
}
</code></pre>
<p>最终还是调用的 WindowManager 的 addView() 方法添加窗口显示 Toast。</p>
<p>Toast 显示后，NMS 还会通过 scheduleDurationReachedLocked() 方法来发送一个延时消息，具体的延时取决于 Toast 的时长，如下所示：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleDurationReachedLocked</span><span class="hljs-params">(ToastRecord r)</span>
{
    mHandler.removeCallbacksAndMessages(r);
    <span class="hljs-type">Message</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> Message.obtain(mHandler, MESSAGE_DURATION_REACHED, r);
    <span class="hljs-type">int</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> r.getDuration() == Toast.LENGTH_LONG ? LONG_DELAY : SHORT_DELAY;
    delay = mAccessibilityManager.getRecommendedTimeoutMillis(delay,
            AccessibilityManager.FLAG_CONTENT_TEXT);
    mHandler.sendMessageDelayed(m, delay);
}
</code></pre>
<p>在上面的代码中，LONG_DELAY 是 3.5s，而 SHORT_DELAY 是 2s。延迟相应的时间后，NMS 会通过 cancelToastLocked() 方法来隐藏 Toast 并将其从 mToastQueue 中移除，这个时候如果 mToastQueue 中还有其他 Toast，那么 NMS 就继续显示其他 Toast。Toast 的隐藏也是通过 ToastRecord 的 callback 来完成的，这同样也是一次 IPC 过程，它的工作方式和 Toast 的显示过程是类似的。最终调用了 WindowManager 的 removeView() 方法来完成 Toast 的隐藏。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 性能观测 [7 - 1]：以用户为中心的核心性能指标体系]]></title>    <link>https://juejin.cn/post/7602154088476262438</link>    <guid>https://juejin.cn/post/7602154088476262438</guid>    <pubDate>2026-02-03T02:26:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602154088476262438" data-draft-id="7602259669707210778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 性能观测 [7 - 1]：以用户为中心的核心性能指标体系"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-03T02:26:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 性能观测 [7 - 1]：以用户为中心的核心性能指标体系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:26:56.000Z" title="Tue Feb 03 2026 02:26:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>场景重现： 老板：“咱们的网站怎么感觉有点卡？” 前端：“不卡啊，我本地测 <code>DOMContentLoaded</code> 只有 300ms。” 老板：“我不管什么 Load，反正我点按钮没反应，刷出来图片要半天。”</p>
<p>这就是典型的**“视角错位” <strong>。 传统的性能指标（Load, DOMReady）是</strong>机器视角**，它们告诉我们代码什么时候跑完。 而现代架构师需要的是<strong>用户视角</strong>，我们需要知道用户什么时候看到内容？什么时候能交互？页面是不是在乱跳？</p>
<p>本篇我们将抛弃过时的指标，基于 Google 的 <strong>Web Vitals</strong> 标准，建立一套能真实反映用户体验的度量衡。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f0a58a49ec34c19b8c0f2581691a403~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770690417&amp;x-signature=3vhehvVBMJ35WfP1C4WziRsSCac%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 为什么传统的指标失效了？</h2>
<p>在 jQuery 时代，<code>window.onload</code> 是神。因为那时的网页大多是服务端渲染（SSR），HTML 下载完，页面基本就出来了。</p>
<p>但在 <strong>SPA（单页应用）</strong> 时代，<code>onload</code> 触发时，页面可能只渲染了一个白色的 <code>&lt;div id="root"&gt;&lt;/div&gt;</code>，真正的业务组件还在转圈圈（Loading）。</p>
<ul>
<li><strong>技术指标 (Technical Metrics):</strong> TCP 建连时间、TTFB、Download Size。它们对运维有用，但无法代表用户体验。</li>
<li><strong>用户指标 (User-Centric Metrics):</strong> 页面多久画出来？点击有反馈吗？</li>
<li><strong>结论：</strong> 优化的目标是**“感知的快”**，而不仅仅是“物理的快”。</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、 核心三支柱：Core Web Vitals (CWV)</h2>
<p>Google 提出了一套核心指标（Core Web Vitals），这不仅是体验标准，更直接影响 <strong>SEO 排名</strong>。这是架构师必须死磕的三个指标。</p>
<h3 data-id="heading-2">2.1 加载体验：LCP (Largest Contentful Paint)</h3>
<p><strong>“页面主要内容多久能看到？”</strong></p>
<ul>
<li>
<p><strong>定义：</strong> 视口内<strong>最大</strong>的那块可见内容（通常是大图、视频封面或 H1 标题）渲染完成的时间点。</p>
</li>
<li>
<p><strong>为什么不是 FCP (First Contentful Paint)?</strong> FCP 可能只画了一个菜单栏或者 Loading 图标，用户并不关心。用户进来是看正文/商品的，LCP 代表了“正文已就位”。</p>
</li>
<li>
<p><strong>标准：</strong></p>
<ul>
<li>🟢 <strong>&lt; 2.5s</strong>: 优秀</li>
<li>🔴 <strong>&gt; 4.0s</strong>: 糟糕</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">2.2 交互响应：INP (Interaction to Next Paint)</h3>
<p><strong>“点下去多久有反应？”</strong></p>
<ul>
<li>
<p><strong>架构师注意：</strong> <strong>FID (First Input Delay)</strong> 已于 2024 年 3 月正式退役。<strong>INP</strong> 是新的王者。</p>
</li>
<li>
<p><strong>定义：</strong> 观察用户在页面停留期间的<strong>所有</strong>点击、按键、触摸操作，计算从“操作发生”到“下一帧绘制”的延迟。</p>
</li>
<li>
<p><strong>INP vs FID:</strong> FID 只看第一次点击（第一印象）；INP 看全生命周期中最慢的那次交互（木桶效应）。如果你的页面长列表滚动很卡，INP 会教你做人。</p>
</li>
<li>
<p><strong>标准：</strong></p>
<ul>
<li>🟢 <strong>&lt; 200ms</strong>: 优秀</li>
<li>🔴 <strong>&gt; 500ms</strong>: 糟糕</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">2.3 视觉稳定性：CLS (Cumulative Layout Shift)</h3>
<p><strong>“页面是不是在乱跳？”</strong></p>
<ul>
<li>
<p><strong>定义：</strong> 衡量页面在加载过程中意外位移的程度。</p>
</li>
<li>
<p><strong>场景：</strong> 用户正准备点“取消”，突然上方加载出一个广告 Banner，把“取消”挤下去了，用户误触了“确认/购买”。这是最让用户愤怒的体验。</p>
</li>
<li>
<p><strong>标准：</strong></p>
<ul>
<li>🟢 <strong>&lt; 0.1</strong>: 优秀</li>
<li>🔴 <strong>&gt; 0.25</strong>: 糟糕</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、 辅助指标：诊断问题的线索</h2>
<p>除了核心的 CWV，我们还需要一些辅助指标来帮助定位问题：</p>
<ol>
<li>
<p><strong>TTFB (Time To First Byte):</strong></p>
<ul>
<li><em>含义：</em> 从发出请求到接收到第一个字节的时间。</li>
<li><em>诊断：</em> 如果 TTFB 高，说明<strong>后端数据库慢</strong>或者<strong>网络差</strong>，跟前端代码没关系。</li>
</ul>
</li>
<li>
<p><strong>FCP (First Contentful Paint):</strong></p>
<ul>
<li><em>含义：</em> 屏幕上渲染出第一个像素（文字、图片、Canvas）。</li>
<li><em>诊断：</em> 如果 FCP 慢，说明 HTML 文件太大，或者阻塞渲染的 CSS/JS 太多（白屏时间长）。</li>
</ul>
</li>
<li>
<p><strong>TBT (Total Blocking Time):</strong></p>
<ul>
<li><em>含义：</em> 主线程被长任务（Long Task &gt; 50ms）阻塞的总时长。</li>
<li><em>诊断：</em> TBT 高通常意味着 JS 执行逻辑太重，会导致 INP 变差。<strong>TBT 是 INP 的“实验室替身”。</strong></li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-6">四、 数据的两面性：Lab vs. Field</h2>
<p>架构师在汇报性能时，经常会被问：“为什么 Lighthouse 跑了 90 分，用户还是投诉卡？” 这是因为你混淆了两种数据源。</p>
<h3 data-id="heading-7">4.1 实验室数据 (Lab Data / Synthetic)</h3>
<ul>
<li><strong>来源：</strong> Lighthouse, WebPageTest。</li>
<li><strong>环境：</strong> 你的高配 MacBook Pro + 公司千兆光纤 + 并没有登录态。</li>
<li><strong>优点：</strong> 环境可控，适合<strong>调试</strong>和<strong>回归测试</strong>（发版前跑一遍，防止变差）。</li>
<li><strong>缺点：</strong> <strong>这就是“自嗨”。</strong> 它代表不了用低端安卓机、在地铁弱网下访问的用户。</li>
</ul>
<h3 data-id="heading-8">4.2 现场数据 (Field Data / RUM - Real User Monitoring)</h3>
<ul>
<li><strong>来源：</strong> Chrome UX Report (CrUX)，自建埋点系统。</li>
<li><strong>环境：</strong> 真实用户的设备和网络。</li>
<li><strong>优点：</strong> <strong>这就是“真相”。</strong></li>
<li><strong>缺点：</strong> 噪音大，不可复现（你不知道那个用户为什么卡，也许他手机当时在升级系统）。</li>
</ul>
<p><strong>架构策略：</strong> <strong>“用 Lab Data 守底线（CI/CD），用 Field Data 定目标（KPI）。”</strong></p>
<hr/>
<h2 data-id="heading-9">五、 业务价值：如何向老板兜售性能？</h2>
<p>如果你直接跟老板说：“我们要把 LCP 从 3s 优化到 2.5s”，老板可能无感。 你需要建立 <strong>性能与业务指标 (Conversion Rate)</strong> 的关联。</p>
<ul>
<li><strong>沃尔玛案例：</strong> 页面加载每快 1 秒，转化率提升 2%。</li>
<li><strong>Pinterest 案例：</strong> 移动端等待时间减少 40%，搜索引擎流量和注册量提升 15%。</li>
<li><strong>Google 权重：</strong> CWV 达标的网站，搜索排名权重更高。</li>
</ul>
<p><strong>公式：</strong> <code>性能优化 = 提升用户留存 + 降低跳出率 + 节省云服务器带宽成本</code></p>
<hr/>
<h2 data-id="heading-10">结语：先有度量，再有优化</h2>
<p>在这一节，我们统一了度量衡。 我们不再说“有点卡”，而是说“INP 超过了 200ms”；我们不再说“白屏久”，而是说“LCP 还是 4秒”。</p>
<p>确立了标准之后，接下来的问题是：<strong>数据从哪来？</strong> 我们不能指望用户每个人都打开控制台截图发给我们。我们需要一套自动化的、全链路的监控系统，像天眼一样实时注视着每一个用户的每一次访问。</p>
<blockquote>
<p><strong>Next Step:</strong> 下一节，我们将进入基建环节。 架构师将化身“监控探头安装员”</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 AI 自动生成教育视频，解决孩子的"十万个为什么"]]></title>    <link>https://juejin.cn/post/7602161364891893760</link>    <guid>https://juejin.cn/post/7602161364891893760</guid>    <pubDate>2026-02-03T02:05:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602161364891893760" data-draft-id="7602135278665056308" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 AI 自动生成教育视频，解决孩子的&quot;十万个为什么&quot;"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-03T02:05:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北极的树"/> <meta itemprop="url" content="https://juejin.cn/user/3059269887853066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 AI 自动生成教育视频，解决孩子的"十万个为什么"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3059269887853066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北极的树
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:05:34.000Z" title="Tue Feb 03 2026 02:05:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>家里有小孩的朋友应该都有这样的体验：孩子总会问一些奇怪的问题。</p>
<p>例如，飞机为什么会飞上天？地球为什么是圆的？太阳为什么会发光.......</p>
<p>用文字解释吧，孩子听着很枯燥，我们讲起来也费劲。有时候想找一些科普视频，但网上的要么太专业，要么质量参差不齐。最关键的是，孩子的问题千奇百怪，不一定能找到合适的视频。</p>
<p>所以我就想，能否让AI帮我生成一个教育视频？说清楚原理，画面还得好看，最好还能自动配音。</p>
<p>我最近做了一个 Agent Skill 叫 <code>educational-video-creator</code>，就是干这个事的。从输入一个主题，到生成一个完整的教育视频，全程自动化。视觉风格参考了 Kurzgesagt 和回形针，那种扁平化、色彩鲜艳的动画风格，小朋友很喜欢。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f0ff3cd2c654a02b68a3903f0321739~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX5p6B55qE5qCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770689134&amp;x-signature=ydLlxxycyOB%2BrbLu88nU8cd7WiE%3D" alt="" loading="lazy"/></p>
<p>这个 Skill 不是简单地把文字转成视频。它会自动写脚本、设计分镜、画动画、生成配音，还会自动检查质量。说白了，就是把一个专业视频团队的工作流程，用AI跑了一遍。</p>
<blockquote>
<p>“</p>
<p>项目已开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fskindhu%2Fskind-skills%2Ftree%2Fmain%2Fskills%2Feducational-video-creator" target="_blank" title="https://github.com/skindhu/skind-skills/tree/main/skills/educational-video-creator" ref="nofollow noopener noreferrer">github.com/skindhu/ski…</a></p>
</blockquote>
<h2 data-id="heading-0">一、为什么要做这个？</h2>
<p>传统的科普视频制作，门槛其实挺高的。你得会写脚本、懂设计、会动画、能配音,还得有专业的视频编辑软件。对于普通家长来说，这基本不可能。</p>
<p>就算找现成的视频，也有问题。孩子问的问题太个性化了，网上不一定有。而且很多科普视频要么太浅显，要么太专业，很难找到刚好适合的。</p>
<p>其实核心痛点就是：个性化的教育内容，制作成本太高。</p>
<p>但如果有 AI 帮你自动生成呢？你只需要说一个主题，比如"为什么飞机能飞"，剩下的全交给 AI。它自动写脚本、画动画、配音，十几分钟后给你一个成品视频。</p>
<p>这就是 <code>educational-video-creator</code> 要解决的问题。</p>
<h2 data-id="heading-1">二、技术选型：为什么选 Remotion？</h2>
<p>做视频有很多方案，我最终选了 Remotion。</p>
<p>Remotion 是一个开源的视频创作框架，核心理念挺简单：用 React 写视频。你用 HTML、CSS、TypeScript 来描述画面和动画，Remotion 负责把它渲染成真正的视频文件。</p>
<p>选它的原因也简单：代码生成的视频，天然适合 AI 来写。传统视频编辑软件靠手动拖时间线、调参数，AI 没法操作。但 Remotion 不一样，所有画面、动画、时间控制都是代码，而AI写代码是强项。</p>
<p>Remotion 官方最近还把最佳实践封装成了 Claude Code 的 Skill（<code>https://github.com/remotion-dev/skills</code>）。装上这个 Skill 后，Claude Code 就掌握了 Remotion 的动画技巧、组件模式、音视频处理等几十条最佳实践，写出来的视频代码质量直接拉满。</p>
<p>说白了，Remotion 把视频制作变成了软件工程问题，而 Remotion 官方又把软件工程的最佳实践喂给了AI。如此一来，AI 生成视频这件事就变得靠谱了。</p>
<h2 data-id="heading-2">三、从主题到成品：完整的创作流程</h2>
<p><code>educational-video-creator</code> 把视频制作拆成了几个阶段。下面一个一个说。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03ff885b0de34bfebc941dfa2a6afdf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX5p6B55qE5qCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770689134&amp;x-signature=WyBtTlGYwAar8BkPVr3AWloOtu8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-3"><strong>需求收集</strong></h4>
<p>第一步是明确需求。AI 会跟你确认五类信息：主题和范围（<code>讲什么、不讲什么、有没有常见误区要纠正</code>）、目标观众（<code>年龄段、知识水平、语言</code>）、视频规格（<code>时长、分辨率、帧率</code>）、内容要求（<code>学习目标、必须包含的元素、视觉偏好</code>）、旁白和音频（<code>是配音还是纯字幕、语气风格、要不要背景音乐</code>）。</p>
<p>这些问题不是随便问的。它们直接决定了后面每个阶段的产出。</p>
<p>比如，给5岁小孩讲飞机，你得用"翅膀拍打空气"这种简单类比，语气要活泼。给中学生讲，就得提伯努利原理和升力公式，语气可以正式一些。确认完所有需求后，AI 会做一次校验，确保主题、观众、学习目标都明确了，才进入下一阶段。</p>
<h4 data-id="heading-4"><strong>脚本创作</strong></h4>
<p>有了需求，AI 开始写脚本。</p>
<p>这个阶段只关注"讲什么"。脚本包括四个部分：核心信息（<code>一句话总结和学习目标</code>）、叙事策略（<code>用什么角度切入、核心比喻是什么、情感弧线怎么走、知识点按什么顺序递进</code>）、完整旁白文字稿、节奏标注（<code>哪里加速、哪里放慢、哪里停顿让观众消化</code>）。</p>
<p>脚本里也会写简短的"视觉意图"，比如"从侧面展示飞机，四个箭头表示四种力"。但不会写任何技术参数，坐标、帧号、动画配置这些都是分镜阶段的事。</p>
<p>刚开始我是让AI直接设计视频分镜，经过尝试后还是决定先写脚本。因为写故事和设计画面是两个完全不同的思维模式。如果你让 AI 同时想"说什么"和"画什么"，它很容易顾此失彼。分开之后，AI 可以专注于把故事讲好。而且纯文本脚本很容易修改，如果我们觉得某段话不对，直接改文字就行。等脚本定稿了，再进入下一阶段。</p>
<h4 data-id="heading-5"><strong>分镜设计</strong></h4>
<p>脚本定稿后，AI 开始设计分镜。这个阶段要把文字转换成视觉。</p>
<p>具体来说，就是把脚本拆成 5-15 个场景，给每个场景分配旁白，设计视觉图层（<code>背景、中景、前景、UI</code>），定义动画参数，设计旁白和画面的同步点，列出需要的 SVG 组件和配色。</p>
<p>这个阶段的产物是一个详细的分镜文档。有了这个文档，后面的编码就是纯执行了。</p>
<h4 data-id="heading-6"><strong>视觉设计</strong></h4>
<p>视觉风格参考了 Kurzgesagt 和回形针：扁平化设计、高饱和度配色、几何图形、无衬线字体。</p>
<p>这种风格简单、清晰，很视频教育类主题。而且扁平化设计用代码很好实现，不需要复杂的 3D 渲染，SVG 就够了。</p>
<h4 data-id="heading-7"><strong>动画编码</strong></h4>
<p>有了分镜和视觉规范，开始编码。</p>
<p>Remotion 的动画原理其实很简单：通过 <code>useCurrentFrame()</code> 拿到当前帧号，然后用 <code>interpolate()</code> 把帧号映射成各种视觉属性，比如位置、透明度、缩放。所有动画都是这个逻辑：帧号进去，属性值出来。想要更自然的效果，还可以用 <code>spring()</code> 函数模拟弹簧动画。</p>
<p>因为 Remotion 基于 React，所以可以把常用的视觉元素封装成组件，比如字幕、图标库、配色方案、字体预设。这些组件做一次就能反复用，AI 生成代码时也不容易出错。</p>
<h4 data-id="heading-8"><strong>音频生成</strong></h4>
<p>动画做完，就到配音阶段。</p>
<p>配音用的是 Edge TTS，微软提供的免费 TTS 服务，无需 API Key。中文音色推荐 <code>zh-CN-XiaoxiaoNeural</code>（女声，清晰自然）或 <code>zh-CN-YunxiNeural</code>（男声，温暖亲切）。还可以调语速，比如减慢 10% 更适合教学场景。对比 OpenAI TTS 或 Azure TTS，Edge TTS 音质不差，而且完全免费，个人项目用起来没负担。</p>
<p>这里有个关键问题：旁白时长和动画时长怎么匹配？</p>
<p>一开始设计分镜时，只能估计每段话要说多久。实际生成音频后，肯定有偏差。所以我做了一个时间线重建功能：先测量所有 TTS 音频的实际时长，然后按算法重新计算每个场景的帧范围，每段音频之间留 0.2 秒间隙，每个场景首尾留 0.5 秒填充，节奏感很好。如果新旧时长偏差超过 20%，还会自动警告。</p>
<p>这样就能保证音频和动画同步（<code>有些场景还是没有完全同步，不过问题不大</code>）。</p>
<h4 data-id="heading-9"><strong>质量检查</strong></h4>
<p>最后是自动质量检查：代码扫描（<code>检查字号、颜色、安全区域是否合规</code>）、关键帧截图（<code>渲染几个关键帧做视觉检查</code>）、自动修复、启动预览。</p>
<p>这个流程可以循环。如果检查不通过，AI 会根据报告修复代码，然后再检查，直到通过。</p>
<h2 data-id="heading-10">四、实际效果</h2>
<p>我用这个Skill生成了几个视频，主题包括"为什么飞机能飞"、"为什么太阳会发光"、"为什么地球是圆的"。</p>
<p>从输入主题到生成成品，大概需要 5-10 分钟，包括写脚本、设计分镜、编码、生成 TTS、渲染视频。</p>
<p>视觉风格确实很接近 Kurzgesagt，扁平化、色彩鲜艳、动画流畅。配音也挺自然，听不太出是机器合成的。</p>
<p>不足也有。动画目前还比较基础，主要是淡入淡出、移动、缩放，复杂的流体或粒子效果不好做。视觉风格也比较单一，目前只做了 Kurzgesagt 风格。</p>
<p>但对于"快速生成一个能看的教育视频"这个目标，够用了。</p>
<p>视频部分预览如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2691fc8ac1a44fa18b52f0ce70f1c846~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX5p6B55qE5qCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770689134&amp;x-signature=w4BSAm5VCocVRF63QmZAJ74hR%2Bg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">写在最后</h2>
<p>做这个 Skill 的过程中，我一直在想一个问题：以前做一个科普视频，需要编剧、动画师、配音师、剪辑师，一个团队协作好几天。现在一个 AI Agent，几分钟就能跑完整个流程。</p>
<p>这个东西不只能回答孩子的问题。在线教育、企业培训、产品演示，任何需要把知识可视化的场景，都能用。</p>
<p>如果你也有兴趣，这个 Skill 作为 Claude Code 的 Agent Skill 使用，技术栈是 Remotion + React + TypeScript + Edge TTS。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习Three.js–风车星系]]></title>    <link>https://juejin.cn/post/7602177588442447891</link>    <guid>https://juejin.cn/post/7602177588442447891</guid>    <pubDate>2026-02-03T02:23:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602177588442447891" data-draft-id="7602177588442431507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习Three.js–风车星系"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-02-03T02:23:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="造轮子的猪"/> <meta itemprop="url" content="https://juejin.cn/user/497453720940158"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习Three.js–风车星系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/497453720940158/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    造轮子的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:23:43.000Z" title="Tue Feb 03 2026 02:23:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">学习Three.js--风车星系</h2>
<h3 data-id="heading-1">前置核心说明</h3>
<h4 data-id="heading-2">开发目标</h4>
<p>基于Three.js的<strong>粒子系统+自定义着色器</strong>实现真实感M101风车星系效果，还原星系的核心结构与视觉特征，核心能力包括：</p>
<ol>
<li>模拟星系分层结构：核心核球（Bulge）+ 螺旋旋臂（Spiral Arms），还原真实星系的形态；</li>
<li>采用对数螺旋算法生成旋臂，实现自然流畅的风车状螺旋结构，符合真实星系的旋臂规律；</li>
<li>粒子分层差异化配置：核球与旋臂使用不同的粒子分布、颜色、尺寸，模拟真实恒星的视觉差异；</li>
<li>借助<code>ShaderMaterial</code>实现圆形抗锯齿粒子与加法混合光晕，提升星系的细腻度与真实感；</li>
<li>实现微弱粒子脉动+星系整体自转，营造动态的宇宙星系氛围，支持轨道交互查看。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d915053fe454292a06df426c8fe3a29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCg6L2u5a2Q55qE54yq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770690223&amp;x-signature=vGVePiqZjurv%2BM%2FbFTGwVaRmcgE%3D" alt="606115fd-7227-41f4-993b-02b6592919ab.png" loading="lazy"/></p>
<h4 data-id="heading-3">核心技术栈（关键知识点）</h4>





































<table><thead><tr><th>技术点</th><th>作用</th></tr></thead><tbody><tr><td><code>THREE.BufferGeometry</code> + 自定义<code>attribute</code></td><td>高效存储10万级粒子数据（顶点、颜色、尺寸），为每个粒子提供独立属性，支撑分层差异化效果</td></tr><tr><td>对数螺旋公式（<code>r = a * e^(b*θ)</code>）</td><td>生成自然流畅的星系旋臂，实现风车状螺旋结构，是模拟螺旋星系的核心算法</td></tr><tr><td>粒子分层生成策略（核球+旋臂）</td><td>不同区域采用不同的分布逻辑、视觉参数，还原星系的真实分层结构，提升场景真实感</td></tr><tr><td><code>THREE.ShaderMaterial</code>（顶点/片元着色器）</td><td>1.  实现圆形抗锯齿粒子，替代默认方形粒子；2.  传递粒子独立颜色/尺寸，实现差异化视觉；3.  实现微弱脉动动画，兼顾性能与效果</td></tr><tr><td><code>THREE.AdditiveBlending</code>（加法混合）</td><td>粒子颜色亮度叠加，营造星系的朦胧光晕感，提升旋臂与核球的层次感，模拟宇宙星尘的发光效果</td></tr><tr><td>星系双动画逻辑（粒子脉动+整体自转）</td><td>微观粒子微弱脉动+宏观星系缓慢自转，营造动态且真实的宇宙氛围，避免场景静态生硬</td></tr><tr><td><code>THREE.OrbitControls</code>（轨道控制器）</td><td>支持拖拽旋转/滚轮缩放，全方位查看3D星系结构，便捷观察旋臂与核球的细节</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-4">分步开发详解</h3>
<h4 data-id="heading-5">步骤1：基础环境搭建（场景/相机/渲染器/控制器）</h4>
<p>搭建Three.js 3D场景的基础框架，为星系提供展示载体，保证场景的流畅交互与高清渲染。</p>
<h5 data-id="heading-6">1.1 核心代码</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入Three.js核心库与轨道控制器</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/three@0.174.0'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/three@0.174.0/examples/jsm/controls/OrbitControls.js'</span>;

<span class="hljs-comment">// 1. 场景初始化（纯黑背景，最大化衬托星系的光晕效果，模拟宇宙真空环境）</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();

<span class="hljs-comment">// 2. 透视相机（适配3D星系场景，兼顾核球细节与旋臂整体查看）</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(
  <span class="hljs-number">60</span>, <span class="hljs-comment">// 视角（FOV）：60°视野适中，无星系变形</span>
  innerWidth / innerHeight, <span class="hljs-comment">// 宽高比：适配浏览器窗口</span>
  <span class="hljs-number">0.1</span>, <span class="hljs-comment">// 近裁切面：过滤过近无效对象，提升性能</span>
  <span class="hljs-number">2000</span> <span class="hljs-comment">// 远裁切面：保证星系完整处于可见范围，支持远距离缩放查看</span>
);
camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>, <span class="hljs-number">80</span>); <span class="hljs-comment">// 高位侧视：既清晰查看旋臂的风车结构，又能观察核球细节</span>

<span class="hljs-comment">// 3. 渲染器（抗锯齿，提升星系粒子边缘细腻度，避免光晕锯齿感）</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> });
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
renderer.<span class="hljs-title function_">setPixelRatio</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>); <span class="hljs-comment">// 高清适配：Retina屏幕无模糊</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);

<span class="hljs-comment">// 4. 轨道控制器（支持拖拽旋转/滚轮缩放，便捷查看3D星系结构）</span>
<span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 启用阻尼：拖拽旋转有惯性，交互更顺滑自然</span>
</code></pre>
<h5 data-id="heading-7">1.2 关键说明</h5>
<ul>
<li><strong>相机位置</strong>：<code>(0, 20, 80)</code> 采用「高位+稍远」视角，既可以完整捕捉风车星系的4条旋臂结构，又能清晰观察核心核球的细节，避免视角过近导致旋臂变形、光晕过曝。</li>
<li><strong>渲染器<code>antialias: true</code></strong>：开启抗锯齿，配合后续片元着色器的<code>smoothstep</code>抗锯齿逻辑，让星系粒子的边缘和光晕更细腻，这对明亮的核球与旋臂尤为重要。</li>
<li><strong>控制器阻尼</strong>：启用阻尼后，交互体验更贴近真实3D场景，适合长时间查看星系的自转与脉动效果，避免拖拽后瞬间停止的生硬感。</li>
</ul>
<h4 data-id="heading-8">步骤2：粒子数据分层生成（核球+旋臂，星系核心形态实现）</h4>
<p>这是风车星系的核心步骤，采用<strong>分层生成策略</strong>，分别生成核球与旋臂的粒子数据，通过不同的分布逻辑、颜色、尺寸，还原星系的真实结构，其中对数螺旋算法是旋臂实现的关键。</p>
<h5 data-id="heading-9">2.1 核心代码</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 初始化粒子数据数组（集中存储，后续绑定到BufferGeometry）</span>
<span class="hljs-keyword">const</span> pointsArr = []; <span class="hljs-comment">// 粒子顶点坐标数组</span>
<span class="hljs-keyword">const</span> colors = []; <span class="hljs-comment">// 粒子颜色数组（每个粒子独立颜色，实现分层视觉差异）</span>
<span class="hljs-keyword">const</span> sizes = []; <span class="hljs-comment">// 粒子尺寸数组（每个粒子独立尺寸，提升星系细腻度）</span>

<span class="hljs-comment">// ---- 分层1：核球（Bulge）- 星系中心密集区域，模拟老年恒星集群 ---- </span>
<span class="hljs-keyword">const</span> bulgeCount = <span class="hljs-number">8000</span>; <span class="hljs-comment">// 核球粒子数（8000，保证密集度且不卡顿）</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; bulgeCount; i++) {
  <span class="hljs-comment">// 幂次采样（Math.pow(Math.random(), 3)）：让粒子高度集中在中心，模拟真实核球的恒星分布</span>
  <span class="hljs-comment">// 3次方让随机值更偏向0，粒子密集在中心区域，外层逐渐稀疏</span>
  <span class="hljs-keyword">const</span> radius = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>(), <span class="hljs-number">3</span>) * <span class="hljs-number">6</span>; 
  <span class="hljs-comment">// 随机方向生成点，再乘以半径，得到核球内的均匀分布粒子</span>
  <span class="hljs-keyword">const</span> point = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>().<span class="hljs-title function_">randomDirection</span>().<span class="hljs-title function_">multiplyScalar</span>(radius);
  pointsArr.<span class="hljs-title function_">push</span>(point);

  <span class="hljs-comment">// 核球颜色：黄白色（模拟老年恒星，亮度高、偏暖色调）</span>
  colors.<span class="hljs-title function_">push</span>(<span class="hljs-number">1.0</span>, <span class="hljs-number">0.9</span>, <span class="hljs-number">0.7</span>);
  <span class="hljs-comment">// 核球粒子尺寸：0.2~1.0，较小且密集，体现核球的紧凑感</span>
  sizes.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.8</span> + <span class="hljs-number">0.2</span>);
}

<span class="hljs-comment">// ---- 分层2：旋臂（Spiral Arms）- 风车状螺旋结构，模拟新生恒星/星云 ----</span>
<span class="hljs-keyword">const</span> armCount = <span class="hljs-number">92000</span>; <span class="hljs-comment">// 旋臂粒子数（92000，保证旋臂的细腻度与流畅感）</span>
<span class="hljs-keyword">const</span> arms = <span class="hljs-number">4</span>; <span class="hljs-comment">// 旋臂数量：4条，还原M101风车星系的经典形态</span>
<span class="hljs-keyword">const</span> armSpread = <span class="hljs-number">0.4</span>; <span class="hljs-comment">// 旋臂松紧度（越小越紧，越大越松散）</span>
<span class="hljs-keyword">const</span> maxRadius = <span class="hljs-number">60</span>; <span class="hljs-comment">// 旋臂最大半径，决定星系的整体大小</span>

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; armCount; i++) {
  <span class="hljs-comment">// 随机分配旋臂，保证4条旋臂的粒子分布均匀</span>
  <span class="hljs-keyword">const</span> armIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * arms);
  <span class="hljs-comment">// 旋臂角度偏移：让4条旋臂均匀分布在360°范围内，无重叠</span>
  <span class="hljs-keyword">const</span> angleOffset = (armIndex / arms) * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;

  <span class="hljs-comment">// 核心算法：对数螺旋（r = a * e^(b*θ)），生成自然流畅的螺旋结构</span>
  <span class="hljs-keyword">const</span> theta = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">8</span>; <span class="hljs-comment">// 螺旋角度：8π对应4圈，保证旋臂的长度与流畅度</span>
  <span class="hljs-comment">// 归一化计算螺旋半径，让旋臂刚好延伸到maxRadius，避免超出边界</span>
  <span class="hljs-keyword">const</span> radius = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">exp</span>(theta * armSpread) * (maxRadius / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">exp</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">8</span> * armSpread));
  
  <span class="hljs-comment">// 径向扰动：让旋臂有“宽度”，避免旋臂过于纤细、生硬，模拟真实旋臂的厚度</span>
  <span class="hljs-keyword">const</span> radialJitter = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">3</span>;
  <span class="hljs-keyword">const</span> finalRadius = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(radius + radialJitter, maxRadius); <span class="hljs-comment">// 限制最大半径，避免粒子超出星系范围</span>

  <span class="hljs-comment">// 角度扰动：让旋臂的粒子分布更自然，避免螺旋线过于规整，提升真实感</span>
  <span class="hljs-keyword">const</span> angle = theta + angleOffset + (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">0.3</span>;
  <span class="hljs-comment">// 旋臂高度：-1~1，形成薄盘结构，模拟真实星系的旋臂平面特性</span>
  <span class="hljs-keyword">const</span> height = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">2</span>;

  <span class="hljs-comment">// 从极坐标转换为直角坐标，生成旋臂粒子的坐标</span>
  <span class="hljs-keyword">const</span> x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angle) * finalRadius;
  <span class="hljs-keyword">const</span> z = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle) * finalRadius;
  pointsArr.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(x, height, z));

  <span class="hljs-comment">// 旋臂颜色：蓝白色（模拟新生恒星/星云，偏冷色调，与核球形成视觉差异）</span>
  colors.<span class="hljs-title function_">push</span>(<span class="hljs-number">0.7</span>, <span class="hljs-number">0.85</span>, <span class="hljs-number">1.0</span>);
  <span class="hljs-comment">// 旋臂粒子尺寸：0.3~1.5，比核球稍大，体现旋臂的视觉层次感</span>
  sizes.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1.2</span> + <span class="hljs-number">0.3</span>);
}
</code></pre>
<h5 data-id="heading-10">2.2 关键技术点解析</h5>
<ol>
<li>
<p><strong>粒子分层生成策略（核球vs旋臂）</strong>：</p>
<ul>
<li><strong>核球</strong>：采用<code>randomDirection()</code>+幂次采样，粒子高度集中在中心，颜色为黄白色（老年恒星），尺寸较小且密集，体现核球的紧凑、温暖、明亮的特性；</li>
<li><strong>旋臂</strong>：采用对数螺旋算法，粒子沿螺旋线分布，颜色为蓝白色（新生恒星/星云），尺寸稍大且有厚度，体现旋臂的舒展、冷艳、有层次的特性；</li>
<li>分层设计的核心是<strong>还原真实星系的结构差异</strong>，通过视觉参数（颜色、尺寸）与分布逻辑的不同，让星系更具真实感。</li>
</ul>
</li>
<li>
<p><strong>对数螺旋算法（旋臂实现的核心）</strong>：</p>
<ul>
<li>公式：<code>r = a * e^(b*θ)</code>，其中<code>r</code>为螺旋半径，<code>θ</code>为螺旋角度，<code>b</code>为螺旋松紧度（对应代码中的<code>armSpread</code>），<code>a</code>为比例系数；</li>
<li>代码中通过<code>Math.exp(theta * armSpread)</code>计算螺旋半径，再通过归一化处理让旋臂刚好延伸到<code>maxRadius</code>，避免超出边界；</li>
<li><code>armSpread</code>越小，螺旋越紧凑，旋臂越“卷”；越大，螺旋越松散，旋臂越“舒展”，这是调整旋臂形态的核心参数。</li>
</ul>
</li>
<li>
<p><strong>扰动优化（旋臂真实感提升）</strong>：</p>
<ul>
<li><strong>径向扰动</strong>：<code>radialJitter</code>让粒子在半径方向有轻微偏移，形成旋臂的“宽度”，避免旋臂成为一条纤细的线；</li>
<li><strong>角度扰动</strong>：让粒子在螺旋角度上有轻微偏移，避免旋臂的螺旋线过于规整，模拟真实星系旋臂的不规则性；</li>
<li><strong>高度限制</strong>：旋臂粒子的Y轴高度限制在<code>-1~1</code>，形成薄盘结构，符合真实星系旋臂的平面特性，避免旋臂呈现立体球状。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-11">步骤3：构建BufferGeometry（绑定粒子数据，支撑着色器渲染）</h4>
<p>将步骤2生成的粒子数据（顶点、颜色、尺寸）绑定到<code>BufferGeometry</code>，并通过自定义<code>attribute</code>向着色器传递粒子的独立颜色与尺寸，为后续着色器渲染提供数据支撑。</p>
<h5 data-id="heading-12">3.1 核心代码</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 构建BufferGeometry，绑定粒子顶点坐标（星系粒子的基础位置数据）</span>
<span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferGeometry</span>().<span class="hljs-title function_">setFromPoints</span>(pointsArr);

<span class="hljs-comment">// 2. 添加自定义attribute：color（粒子颜色，每个粒子3个分量：R/G/B）</span>
<span class="hljs-comment">// 第二个参数「3」表示每个顶点的分量数为3，与colors数组的每3个元素对应一个粒子</span>
geometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'color'</span>, <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Float32BufferAttribute</span>(colors, <span class="hljs-number">3</span>));

<span class="hljs-comment">// 3. 添加自定义attribute：size（粒子尺寸，每个粒子1个值）</span>
<span class="hljs-comment">// 第二个参数「1」表示每个顶点的分量数为1，与sizes数组的每个元素一一对应</span>
geometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'size'</span>, <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Float32BufferAttribute</span>(sizes, <span class="hljs-number">1</span>));
</code></pre>
<h5 data-id="heading-13">3.2 关键技术点解析</h5>
<ul>
<li><strong><code>BufferGeometry</code>的高效性</strong>：直接操作二进制数组存储数据，渲染时减少CPU与GPU之间的数据传输开销，适合10万级粒子场景（本次总粒子数10万），性能远优于已被废弃的普通<code>Geometry</code>。</li>
<li><strong>自定义<code>attribute</code>的核心作用</strong>：向着色器传递「每个粒子的独立数据」，本次传递了<code>color</code>（颜色）与<code>size</code>（尺寸），让着色器能够为每个粒子渲染不同的颜色与尺寸，实现星系的分层视觉差异。</li>
<li><strong><code>Float32BufferAttribute</code></strong>：最常用的BufferAttribute类型，存储32位浮点型数据，兼顾精度与性能，适合传递粒子颜色、尺寸等数据，着色器中需声明同名<code>attribute</code>变量才能访问对应数据。</li>
</ul>
<h4 data-id="heading-14">步骤4：创建自定义ShaderMaterial（星系视觉效果的核心）</h4>
<p>通过<code>ShaderMaterial</code>自定义顶点着色器与片元着色器，实现圆形抗锯齿粒子、粒子独立颜色/尺寸渲染、微弱脉动动画，同时通过加法混合营造星系的朦胧光晕，提升真实感。</p>
<h5 data-id="heading-15">4.1 核心代码</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 构建ShaderMaterial，配置全局uniforms和着色器，实现星系的核心视觉效果</span>
<span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ShaderMaterial</span>({
  <span class="hljs-comment">// 1. 全局uniforms（向着色器传递全局统一数据，此处为时间，驱动脉动动画）</span>
  <span class="hljs-attr">uniforms</span>: {
    <span class="hljs-attr">uTime</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">0</span> } <span class="hljs-comment">// 全局时间：驱动所有粒子的脉动动画同步更新</span>
  },

  <span class="hljs-comment">// 2. 顶点着色器（处理粒子位置、颜色、尺寸，实现微弱脉动与透视变换）</span>
  <span class="hljs-attr">vertexShader</span>: <span class="hljs-string">`
    uniform float uTime;
    attribute vec3 color; // 粒子颜色（自定义attribute，每个粒子独立）
    attribute float size; // 粒子尺寸（自定义attribute，每个粒子独立）
    varying vec3 vColor; // 传递给片元着色器的颜色（varying变量，实现平滑插值）

    void main() {
      vec3 pos = position;

      // 微弱脉动动画：基于粒子距离与时间的球面扰动，提升星系的动态感
      // sin函数实现周期性脉动，0.1为脉动幅度，避免过于剧烈影响星系形态
      float pulse = sin(uTime * 0.5 + length(pos)) * 0.1;
      pos += normalize(pos) * pulse; // 沿粒子径向脉动，保持星系整体形态不变

      // 透视变换：将3D粒子坐标转换为2D屏幕坐标，3D渲染必备
      vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0); // 模型视图矩阵：局部坐标→相机视角坐标
      gl_Position = projectionMatrix * mvPosition; // 投影矩阵：相机视角坐标→屏幕裁剪坐标

      // 粒子尺寸计算：透视缩放（近大远小），实现真实的3D视觉效果
      gl_PointSize = size * (80.0 / -mvPosition.z); // 80.0为缩放系数，控制粒子的整体大小
      gl_PointSize = min(gl_PointSize, 100.0); // 限制最大尺寸，避免远处粒子过大导致光晕过曝

      // 传递粒子颜色到片元着色器，实现每个粒子的独立颜色渲染
      vColor = color;
    }
  `</span>,

  <span class="hljs-comment">// 3. 片元着色器（处理粒子像素颜色、形状，实现圆形抗锯齿与柔和光晕）</span>
  <span class="hljs-attr">fragmentShader</span>: <span class="hljs-string">`
    varying vec3 vColor; // 从顶点着色器传递过来的粒子颜色

    void main() {
      // 步骤1：绘制圆形粒子（基于点坐标的UV计算，替代默认方形粒子）
      vec2 uv = gl_PointCoord - 0.5; // 将点坐标从(0,0)~(1,1)转换为(-0.5,-0.5)~(0.5,0.5)
      float d = length(uv); // 计算当前像素到粒子中心的距离

      // 步骤2：圆形裁剪（丢弃超出圆心0.5范围的像素，形成圆形粒子）
      if (d &gt; 0.5) discard; // discard：丢弃当前像素，不渲染，实现圆形轮廓

      // 步骤3：抗锯齿边缘（smoothstep实现渐隐，避免圆形边缘锯齿，提升光晕质感）
      float alpha = 1.0 - smoothstep(0.45, 0.5, d); // 从0.45到0.5，alpha从1渐变到0，边缘渐隐

      // 步骤4：设置最终像素颜色（粒子独立颜色+渐变Alpha，实现柔和光晕）
      gl_FragColor = vec4(vColor, alpha);
    }
  `</span>,

  <span class="hljs-comment">// 4. 材质附加配置（提升星系视觉效果，核心是加法混合与透明设置）</span>
  <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用透明：支持粒子边缘渐隐，实现柔和光晕效果</span>
  <span class="hljs-attr">blending</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">AdditiveBlending</span>, <span class="hljs-comment">// 加法混合：粒子颜色亮度叠加，呈现朦胧光晕，提升星系层次感</span>
  <span class="hljs-attr">depthWrite</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 关闭深度写入：允许粒子叠加，避免旋臂与核球互相遮挡，光晕更连贯</span>
});

<span class="hljs-comment">// 5. 创建Points粒子对象，添加到场景（将几何体与材质结合，形成最终的M101风车星系）</span>
<span class="hljs-keyword">const</span> points = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Points</span>(geometry, material);
scene.<span class="hljs-title function_">add</span>(points);
</code></pre>
<h5 data-id="heading-16">4.2 关键技术点解析</h5>
<ol>
<li>
<p><strong>顶点着色器核心逻辑</strong>：</p>
<ul>
<li><strong>微弱脉动动画</strong>：基于<code>sin(uTime * 0.5 + length(pos))</code>实现周期性脉动，<code>length(pos)</code>让不同位置的粒子脉动相位不同，避免同步脉动的生硬感，<code>0.1</code>的脉动幅度保证星系整体形态不变，仅提升动态感；</li>
<li><strong>透视缩放</strong>：<code>gl_PointSize = size * (80.0 / -mvPosition.z)</code>实现「近大远小」的真实透视效果，让星系更具3D立体感，<code>min</code>函数限制最大尺寸，避免光晕过曝；</li>
<li><strong>颜色传递</strong>：通过<code>varying vec3 vColor</code>将粒子的独立颜色传递到片元着色器，Three.js会自动进行平滑插值，保证颜色过渡自然，无明显断层。</li>
</ul>
</li>
<li>
<p><strong>片元着色器核心逻辑</strong>：</p>
<ul>
<li><strong>圆形粒子绘制</strong>：通过<code>gl_PointCoord</code>转换UV坐标，计算像素到粒子中心的距离，丢弃超出圆心的像素，形成圆形粒子，替代默认的方形粒子，提升星系的细腻度；</li>
<li><strong>抗锯齿边缘</strong>：<code>smoothstep(0.45, 0.5, d)</code>实现边缘渐隐，避免圆形粒子的锯齿感，同时为粒子营造柔和的光晕，这对星系的旋臂与核球尤为重要；</li>
<li><strong>独立颜色渲染</strong>：直接使用从顶点着色器传递的<code>vColor</code>，实现每个粒子的差异化颜色，还原星系核球与旋臂的视觉差异。</li>
</ul>
</li>
<li>
<p><strong>材质配置优化</strong>：</p>
<ul>
<li><strong><code>AdditiveBlending</code>（加法混合）</strong>：粒子颜色亮度叠加，越密集的地方越亮，形成自然的朦胧光晕，模拟宇宙星尘的发光效果，提升星系的真实感与层次感；</li>
<li><strong><code>depthWrite: false</code></strong>：关闭深度写入，允许旋臂与核球的粒子互相叠加，避免粒子之间的遮挡，保证光晕的连贯性，同时提升渲染性能；</li>
<li><strong><code>transparent: true</code></strong>：启用透明，支持粒子边缘的渐隐效果，配合加法混合，让星系的光晕更柔和、更自然。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-17">步骤5：动画循环（驱动星系动态效果，实现流畅渲染）</h4>
<p>每帧更新全局时间<code>uTime</code>，驱动粒子微弱脉动，同时实现星系整体自转，更新控制器阻尼，保证星系的动态效果流畅、自然，提升视觉体验。</p>
<h5 data-id="heading-18">5.1 核心代码</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> clock = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Clock</span>(); <span class="hljs-comment">// 时钟：用于获取累计运行时间，不受帧率影响，避免动画累积误差</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">requestAnimationFrame</span>(animate); <span class="hljs-comment">// 绑定浏览器刷新率（通常60帧/秒），实现流畅无卡顿的动画</span>

  <span class="hljs-comment">// 1. 获取累计运行时间，驱动着色器脉动动画</span>
  <span class="hljs-keyword">const</span> t = clock.<span class="hljs-title function_">getElapsedTime</span>();
  material.<span class="hljs-property">uniforms</span>.<span class="hljs-property">uTime</span>.<span class="hljs-property">value</span> = t;

  <span class="hljs-comment">// 2. 星系整体自转：绕Y轴缓慢旋转，营造真实的宇宙星系氛围</span>
  <span class="hljs-comment">// 0.02为自转速度，缓慢旋转便于观察星系的旋臂结构</span>
  points.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> = t * <span class="hljs-number">0.02</span>;

  <span class="hljs-comment">// 3. 更新轨道控制器阻尼（必须在动画循环中调用，保证阻尼效果生效）</span>
  controls.<span class="hljs-title function_">update</span>();

  <span class="hljs-comment">// 4. 渲染场景（将场景和相机的3D信息渲染为2D画布，呈现最终的M101风车星系）</span>
  renderer.<span class="hljs-title function_">render</span>(scene, camera);
}

<span class="hljs-comment">// 启动动画循环，开始运行星系的脉动、自转与渲染</span>
<span class="hljs-title function_">animate</span>();
</code></pre>
<h5 data-id="heading-19">5.2 关键说明</h5>
<ul>
<li><strong><code>clock.getElapsedTime()</code></strong>：获取从时钟启动到当前的累计运行时间（单位：秒），相比<code>getDelta()</code>更适合驱动全局循环动画，避免动画因帧率波动出现累积误差，保证星系的脉动与自转效果在不同设备上一致。</li>
<li><strong>双动画逻辑（微观脉动+宏观自转）</strong>：
<ul>
<li>微观：粒子的微弱脉动，提升星系的动态感，避免场景过于静态；</li>
<li>宏观：星系绕Y轴缓慢自转，还原真实星系的自转特性，营造宇宙星系的氛围；</li>
<li>双动画逻辑的核心是「动静结合」，既保证星系的整体形态不变，又提升视觉体验的丰富性。</li>
</ul>
</li>
<li><strong>自转速度优化</strong>：<code>0.02</code>的自转速度较为缓慢，便于用户观察星系的旋臂与核球细节，若想提升动态感，可适当增大该值（如<code>0.05</code>）。</li>
</ul>
<h4 data-id="heading-20">步骤6：窗口适配（响应式调整，适配不同屏幕尺寸）</h4>
<p>保证M101风车星系在不同屏幕尺寸下都能全屏显示，且不会出现拉伸变形，适配桌面端、移动端等不同设备。</p>
<h5 data-id="heading-21">6.1 核心代码</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 1. 更新相机宽高比（适配新的窗口尺寸，避免场景拉伸）</span>
  camera.<span class="hljs-property">aspect</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
  <span class="hljs-comment">// 2. 更新相机投影矩阵（必须调用，否则宽高比修改不生效，场景会出现拉伸变形）</span>
  camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
  <span class="hljs-comment">// 3. 更新渲染器尺寸（适配新的窗口尺寸，保证星系全屏显示）</span>
  renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
});
</code></pre>
<h5 data-id="heading-22">6.2 关键说明</h5>
<ul>
<li>窗口大小变化时，同步更新相机宽高比和渲染器尺寸，保证星系在不同屏幕尺寸下都能全屏显示，且透视效果正常，不会出现拉伸变形。</li>
<li><code>camera.updateProjectionMatrix()</code>：相机参数（如宽高比）修改后，必须调用该方法更新投影矩阵，否则宽高比的修改不会生效，场景会出现明显的拉伸变形，影响星系的视觉效果。</li>
</ul>
<hr/>
<h3 data-id="heading-23">核心技术深度解析</h3>
<h4 data-id="heading-24">1.  对数螺旋算法（旋臂实现的核心）</h4>
<p>对数螺旋是自然界中螺旋星系的普遍形态，其核心公式为：<code>$r = a \cdot e^{b \cdot \theta}$</code></p>
<ul>
<li>各参数含义：</li>
<li><code>$r$</code>：螺旋线上某点到原点的半径（对应代码中的<code>radius</code>）；</li>
<li><code>$\theta$</code>：螺旋线上某点的极角（对应代码中的<code>theta</code>）；</li>
<li><code>$b$</code>：螺旋松紧度（对应代码中的<code>armSpread</code>），<code>$b$</code>越小，螺旋越紧凑，旋臂越“卷”；<code>$b$</code>越大，螺旋越松散，旋臂越“舒展”；</li>
<li><code>$a$</code>：比例系数，用于调整螺旋的整体大小（代码中通过归一化处理实现，让旋臂刚好延伸到<code>maxRadius</code>）。</li>
<li>代码落地技巧：通过<code>Math.exp(theta * armSpread)</code>计算螺旋半径，再通过<code>maxRadius / Math.exp(Math.PI * 8 * armSpread)</code>进行归一化，保证旋臂的长度与边界可控，避免超出星系范围。</li>
</ul>
<h4 data-id="heading-25">2.  粒子分层生成策略（核球vs旋臂）</h4>



































<table><thead><tr><th>对比项</th><th>核球（Bulge）</th><th>旋臂（Spiral Arms）</th></tr></thead><tbody><tr><td>分布逻辑</td><td><code>randomDirection()</code>+幂次采样，高度集中在中心</td><td>对数螺旋算法+径向/角度扰动，沿螺旋线分布</td></tr><tr><td>粒子数量</td><td>8000（密集紧凑）</td><td>92000（舒展细腻）</td></tr><tr><td>颜色</td><td>黄白色（1.0, 0.9, 0.7），模拟老年恒星</td><td>蓝白色（0.7, 0.85, 1.0），模拟新生恒星/星云</td></tr><tr><td>尺寸</td><td>0.2~1.0，较小且均匀</td><td>0.3~1.5，稍大且有差异</td></tr><tr><td>空间形态</td><td>球形（3D分布）</td><td>薄盘形（2D平面分布，Y轴高度限制在-1~1）</td></tr></tbody></table>
<h4 data-id="heading-26">3.  ShaderMaterial的性能优势</h4>
<p>本次星系总粒子数为10万，采用<code>ShaderMaterial</code>能够实现流畅渲染，其核心优势在于：</p>
<ul>
<li><strong>GPU并行处理</strong>：着色器逻辑运行在GPU上，具备强大的并行处理能力，可轻松应对10万级甚至百万级粒子，性能远超普通JS驱动的粒子系统；</li>
<li><strong>减少数据传输</strong>：通过<code>BufferGeometry</code>将粒子数据一次性传递到GPU，后续动画仅需更新少量全局<code>uniform</code>（如<code>uTime</code>），减少CPU与GPU之间的数据传输开销；</li>
<li><strong>灵活的视觉定制</strong>：通过自定义着色器，可实现圆形粒子、抗锯齿、光晕等复杂视觉效果，且无需额外的几何体开销，提升渲染效率。</li>
</ul>
<hr/>
<h3 data-id="heading-27">核心参数速查表（快速调整星系效果）</h3>



























































<table><thead><tr><th>参数名</th><th>当前取值</th><th>作用</th><th>修改建议</th></tr></thead><tbody><tr><td><code>bulgeCount</code></td><td>8000</td><td>核球粒子数，决定核球的密集程度</td><td>改为5000：核球更稀疏；改为10000：核球更密集，亮度更高</td></tr><tr><td><code>armCount</code></td><td>92000</td><td>旋臂粒子数，决定旋臂的细腻程度</td><td>改为50000：旋臂更稀疏，低配设备更流畅；改为150000：旋臂更细腻，光晕更丰富</td></tr><tr><td><code>arms</code></td><td>4</td><td>旋臂数量，决定星系的风车形态</td><td>改为2：双旋臂星系（如银河系）；改为6：六旋臂星系，更具视觉冲击力</td></tr><tr><td><code>armSpread</code></td><td>0.4</td><td>旋臂松紧度，决定螺旋的紧凑程度</td><td>改为0.3：旋臂更紧凑，更“卷”；改为0.5：旋臂更松散，更“舒展”</td></tr><tr><td><code>maxRadius</code></td><td>60</td><td>旋臂最大半径，决定星系的整体大小</td><td>改为40：星系更小更紧凑；改为80：星系更大更舒展，支持远距离缩放查看</td></tr><tr><td>核球颜色</td><td>(1.0, 0.9, 0.7)</td><td>核球视觉色调，模拟老年恒星</td><td>改为(1.0, 0.8, 0.5)：更暖的金黄色，核球更明亮；改为(1.0, 1.0, 0.9)：更浅的黄白色，核球更柔和</td></tr><tr><td>旋臂颜色</td><td>(0.7, 0.85, 1.0)</td><td>旋臂视觉色调，模拟新生恒星/星云</td><td>改为(0.6, 0.8, 1.0)：更冷的蓝色，旋臂更鲜明；改为(0.8, 0.9, 1.0)：更浅的蓝白色，旋臂更柔和</td></tr><tr><td>自转速度 <code>t * 0.02</code></td><td>0.02</td><td>星系整体自转速度，决定动态氛围</td><td>改为0.01：自转更缓慢，便于观察细节；改为0.05：自转更快，动态感更强</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-28">完整优化代码</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>M101 风车星系 - Three.js<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"><span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">overflow</span>: hidden; <span class="hljs-attribute">background</span>: <span class="hljs-number">#000</span>; }</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// 导入Three.js核心库与轨道控制器</span>
  <span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/three@0.174.0'</span>;
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'https://esm.sh/three@0.174.0/examples/jsm/controls/OrbitControls.js'</span>;

  <span class="hljs-comment">// ========== 1. 基础环境初始化（场景/相机/渲染器/控制器） ==========</span>
  <span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();

  <span class="hljs-comment">// 透视相机：高位侧视，清晰查看风车星系的旋臂结构与核球细节</span>
  <span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">60</span>, innerWidth / innerHeight, <span class="hljs-number">0.1</span>, <span class="hljs-number">2000</span>);
  camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>, <span class="hljs-number">80</span>);

  <span class="hljs-comment">// 渲染器：抗锯齿，提升星系粒子边缘与光晕的细腻度，适配高清屏幕</span>
  <span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> });
  renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
  renderer.<span class="hljs-title function_">setPixelRatio</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>);
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);

  <span class="hljs-comment">// 轨道控制器：启用阻尼，实现顺滑的3D交互体验</span>
  <span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
  controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>;

  <span class="hljs-comment">// ========== 2. 粒子数据分层生成（核球+旋臂，还原星系真实结构） ==========</span>
  <span class="hljs-keyword">const</span> pointsArr = []; <span class="hljs-comment">// 粒子顶点坐标数组</span>
  <span class="hljs-keyword">const</span> colors = []; <span class="hljs-comment">// 粒子颜色数组：分层差异化，实现核球与旋臂的视觉差异</span>
  <span class="hljs-keyword">const</span> sizes = []; <span class="hljs-comment">// 粒子尺寸数组：分层差异化，提升星系细腻度</span>

  <span class="hljs-comment">// ---- 分层1：核球（Bulge）- 中心密集区域，模拟老年恒星集群 ---- </span>
  <span class="hljs-keyword">const</span> bulgeCount = <span class="hljs-number">8000</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; bulgeCount; i++) {
    <span class="hljs-comment">// 幂次采样：Math.pow(Math.random(), 3)让粒子高度集中在中心，模拟真实核球分布</span>
    <span class="hljs-keyword">const</span> radius = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>(), <span class="hljs-number">3</span>) * <span class="hljs-number">6</span>;
    <span class="hljs-keyword">const</span> point = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>().<span class="hljs-title function_">randomDirection</span>().<span class="hljs-title function_">multiplyScalar</span>(radius);
    pointsArr.<span class="hljs-title function_">push</span>(point);

    <span class="hljs-comment">// 核球颜色：黄白色（老年恒星，偏暖色调，亮度高）</span>
    colors.<span class="hljs-title function_">push</span>(<span class="hljs-number">1.0</span>, <span class="hljs-number">0.9</span>, <span class="hljs-number">0.7</span>);
    <span class="hljs-comment">// 核球尺寸：0.2~1.0，较小且密集，体现核球的紧凑感</span>
    sizes.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.8</span> + <span class="hljs-number">0.2</span>);
  }

  <span class="hljs-comment">// ---- 分层2：旋臂（Spiral Arms）- 风车状螺旋结构，模拟新生恒星/星云 ----</span>
  <span class="hljs-keyword">const</span> armCount = <span class="hljs-number">92000</span>;
  <span class="hljs-keyword">const</span> arms = <span class="hljs-number">4</span>; <span class="hljs-comment">// 旋臂数量：4条，还原M101风车星系的经典形态</span>
  <span class="hljs-keyword">const</span> armSpread = <span class="hljs-number">0.4</span>; <span class="hljs-comment">// 旋臂松紧度：越小越紧，越大越松散</span>
  <span class="hljs-keyword">const</span> maxRadius = <span class="hljs-number">60</span>; <span class="hljs-comment">// 旋臂最大半径，决定星系整体大小</span>

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; armCount; i++) {
    <span class="hljs-comment">// 随机分配旋臂，保证4条旋臂均匀分布</span>
    <span class="hljs-keyword">const</span> armIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * arms);
    <span class="hljs-keyword">const</span> angleOffset = (armIndex / arms) * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>;

    <span class="hljs-comment">// 核心算法：对数螺旋（r = a * e^(b*θ)），生成自然流畅的螺旋结构</span>
    <span class="hljs-keyword">const</span> theta = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">8</span>; <span class="hljs-comment">// 螺旋角度：8π对应4圈，保证旋臂长度与流畅度</span>
    <span class="hljs-keyword">const</span> radius = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">exp</span>(theta * armSpread) * (maxRadius / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">exp</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">8</span> * armSpread));
    
    <span class="hljs-comment">// 径向扰动：让旋臂有宽度，避免过于纤细、生硬</span>
    <span class="hljs-keyword">const</span> radialJitter = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">3</span>;
    <span class="hljs-keyword">const</span> finalRadius = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(radius + radialJitter, maxRadius);

    <span class="hljs-comment">// 角度扰动：让旋臂粒子分布更自然，避免螺旋线过于规整</span>
    <span class="hljs-keyword">const</span> angle = theta + angleOffset + (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">0.3</span>;
    <span class="hljs-comment">// 薄盘结构：Y轴高度限制在-1~1，符合真实星系旋臂的平面特性</span>
    <span class="hljs-keyword">const</span> height = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">2</span>;

    <span class="hljs-comment">// 极坐标→直角坐标，生成旋臂粒子坐标</span>
    <span class="hljs-keyword">const</span> x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angle) * finalRadius;
    <span class="hljs-keyword">const</span> z = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle) * finalRadius;
    pointsArr.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(x, height, z));

    <span class="hljs-comment">// 旋臂颜色：蓝白色（新生恒星/星云，偏冷色调，与核球形成视觉差异）</span>
    colors.<span class="hljs-title function_">push</span>(<span class="hljs-number">0.7</span>, <span class="hljs-number">0.85</span>, <span class="hljs-number">1.0</span>);
    <span class="hljs-comment">// 旋臂尺寸：0.3~1.5，比核球稍大，体现旋臂的视觉层次感</span>
    sizes.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1.2</span> + <span class="hljs-number">0.3</span>);
  }

  <span class="hljs-comment">// ========== 3. 构建BufferGeometry（绑定粒子数据，支撑着色器渲染） ==========</span>
  <span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferGeometry</span>().<span class="hljs-title function_">setFromPoints</span>(pointsArr);
  <span class="hljs-comment">// 添加自定义attribute：color（粒子独立颜色，3个分量）</span>
  geometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'color'</span>, <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Float32BufferAttribute</span>(colors, <span class="hljs-number">3</span>));
  <span class="hljs-comment">// 添加自定义attribute：size（粒子独立尺寸，1个分量）</span>
  geometry.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'size'</span>, <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Float32BufferAttribute</span>(sizes, <span class="hljs-number">1</span>));

  <span class="hljs-comment">// ========== 4. 创建ShaderMaterial（核心：圆形粒子+光晕+脉动动画） ==========</span>
  <span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ShaderMaterial</span>({
    <span class="hljs-comment">// 全局uniforms：传递时间，驱动粒子微弱脉动动画</span>
    <span class="hljs-attr">uniforms</span>: {
      <span class="hljs-attr">uTime</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">0</span> }
    },

    <span class="hljs-comment">// 顶点着色器：处理粒子位置、颜色、尺寸，实现微弱脉动与透视变换</span>
    <span class="hljs-attr">vertexShader</span>: <span class="hljs-string">`
      uniform float uTime;
      attribute vec3 color;
      attribute float size;
      varying vec3 vColor;

      void main() {
        vec3 pos = position;

        // 微弱脉动动画：周期性球面扰动，提升星系动态感，保持整体形态不变
        float pulse = sin(uTime * 0.5 + length(pos)) * 0.1;
        pos += normalize(pos) * pulse;

        // 透视变换：3D坐标→2D屏幕坐标，保证星系正确显示
        vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
        gl_Position = projectionMatrix * mvPosition;

        // 透视缩放：近大远小，实现真实3D视觉效果，限制最大尺寸避免光晕过曝
        gl_PointSize = size * (80.0 / -mvPosition.z);
        gl_PointSize = min(gl_PointSize, 100.0);

        // 传递粒子颜色到片元着色器，实现分层差异化视觉
        vColor = color;
      }
    `</span>,

    <span class="hljs-comment">// 片元着色器：处理粒子形状、抗锯齿、光晕，实现圆形柔和粒子</span>
    <span class="hljs-attr">fragmentShader</span>: <span class="hljs-string">`
      varying vec3 vColor;

      void main() {
        // 圆形粒子绘制：转换UV坐标，计算到粒子中心的距离
        vec2 uv = gl_PointCoord - 0.5;
        float d = length(uv);

        // 圆形裁剪：丢弃超出圆心的像素，形成圆形轮廓
        if (d &gt; 0.5) discard;

        // 抗锯齿边缘：smoothstep实现渐隐，提升光晕质感，避免锯齿感
        float alpha = 1.0 - smoothstep(0.45, 0.5, d);

        // 最终像素颜色：粒子独立颜色+渐变Alpha，实现柔和光晕效果
        gl_FragColor = vec4(vColor, alpha);
      }
    `</span>,

    <span class="hljs-comment">// 材质配置：提升星系视觉效果，实现朦胧光晕与流畅叠加</span>
    <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用透明，支持边缘渐隐</span>
    <span class="hljs-attr">blending</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">AdditiveBlending</span>, <span class="hljs-comment">// 加法混合，颜色亮度叠加，营造光晕</span>
    <span class="hljs-attr">depthWrite</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 关闭深度写入，避免粒子互相遮挡，光晕更连贯</span>
  });

  <span class="hljs-comment">// 创建Points粒子对象，添加到场景，形成最终的M101风车星系</span>
  <span class="hljs-keyword">const</span> points = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Points</span>(geometry, material);
  scene.<span class="hljs-title function_">add</span>(points);

  <span class="hljs-comment">// ========== 5. 动画循环（驱动脉动+自转，实现流畅动态星系） ==========</span>
  <span class="hljs-keyword">const</span> clock = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Clock</span>();

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">requestAnimationFrame</span>(animate);

    <span class="hljs-comment">// 更新全局时间，驱动粒子微弱脉动动画</span>
    <span class="hljs-keyword">const</span> t = clock.<span class="hljs-title function_">getElapsedTime</span>();
    material.<span class="hljs-property">uniforms</span>.<span class="hljs-property">uTime</span>.<span class="hljs-property">value</span> = t;

    <span class="hljs-comment">// 星系整体自转：绕Y轴缓慢旋转，营造真实宇宙氛围</span>
    points.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> = t * <span class="hljs-number">0.02</span>;

    <span class="hljs-comment">// 更新轨道控制器阻尼，保证顺滑交互</span>
    controls.<span class="hljs-title function_">update</span>();

    <span class="hljs-comment">// 渲染场景，呈现最终的M101风车星系效果</span>
    renderer.<span class="hljs-title function_">render</span>(scene, camera);
  }

  <span class="hljs-comment">// 启动动画循环，开始运行星系的脉动、自转与渲染</span>
  <span class="hljs-title function_">animate</span>();

  <span class="hljs-comment">// ========== 6. 窗口适配（响应式调整，适配不同屏幕尺寸） ==========</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> {
    camera.<span class="hljs-property">aspect</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
    camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
    renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
  });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-29">总结与扩展建议</h3>
<h4 data-id="heading-30">核心总结</h4>
<ol>
<li><strong>形态核心</strong>：对数螺旋算法是实现螺旋星系旋臂的关键，配合径向/角度扰动，可生成自然流畅的风车状结构，还原真实星系的形态特征。</li>
<li><strong>视觉核心</strong>：粒子分层生成策略（核球+旋臂）+ 差异化视觉参数（颜色、尺寸），是提升星系真实感的核心，能够还原真实星系的结构与视觉差异。</li>
<li><strong>性能核心</strong>：<code>ShaderMaterial</code>+<code>BufferGeometry</code>的组合，能够高效处理10万级粒子，借助GPU并行处理，实现流畅渲染，同时支持复杂的视觉定制（圆形粒子、光晕、脉动）。</li>
<li><strong>动态核心</strong>：微观粒子微弱脉动+宏观星系整体自转的双动画逻辑，动静结合，既保证星系的整体形态不变，又提升视觉体验的丰富性，营造真实的宇宙氛围。</li>
</ol>
<h4 data-id="heading-31">扩展建议</h4>
<ol>
<li><strong>星系效果增强</strong>：
<ul>
<li>添加暗物质晕：在星系外围生成一层稀疏、暗淡的粒子，模拟暗物质晕，提升星系的真实感；</li>
<li>添加星云效果：通过<code>Texture</code>纹理结合片元着色器，在旋臂之间添加朦胧的星云，丰富星系的视觉层次；</li>
<li>动态颜色变化：通过<code>uniform</code>传递颜色参数，让核球与旋臂的颜色随时间缓慢变化，提升场景的动态感。</li>
</ul>
</li>
<li><strong>功能扩展</strong>：
<ul>
<li>交互增强：绑定鼠标位置，让星系跟随鼠标旋转、缩放，提升交互体验；</li>
<li>参数控制面板：提供可视化面板，允许用户调整旋臂数量、松紧度、自转速度等参数，实时预览效果；</li>
<li>相机自动漫游：实现相机的自动路径漫游，让用户无需手动操作即可全方位查看星系的细节。</li>
</ul>
</li>
<li><strong>性能优化</strong>：
<ul>
<li>使用<code>InstancedBufferGeometry</code>替代<code>BufferGeometry</code>，进一步减少DrawCall，支持更多粒子（百万级）；</li>
<li>开启渲染器的<code>powerPreference: "high-performance"</code>，优先使用高性能GPU，提升渲染效率；</li>
<li>剔除不可见粒子：通过视锥体裁剪，剔除屏幕外的粒子，减少GPU渲染开销。</li>
</ul>
</li>
<li><strong>场景扩展</strong>：
<ul>
<li>添加背景星空：通过<code>THREE.TextureLoader</code>加载星空纹理，作为场景背景，营造更真实的宇宙环境；</li>
<li>添加其他天体：在场景中添加恒星、行星等天体，丰富宇宙场景的内容；</li>
<li>实现多星系并存：创建多个不同形态的星系，形成星系集群，提升场景的壮观感。</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Linux 封神之路】进程进阶实战：fork/vfork/exec 函数族 + 作业实现（含僵尸进程解决方案）]]></title>    <link>https://juejin.cn/post/7602303923139100722</link>    <guid>https://juejin.cn/post/7602303923139100722</guid>    <pubDate>2026-02-03T00:54:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602303923139100722" data-draft-id="7602303923139084338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Linux 封神之路】进程进阶实战：fork/vfork/exec 函数族 + 作业实现（含僵尸进程解决方案）"/> <meta itemprop="keywords" content="算法,Linux,C语言"/> <meta itemprop="datePublished" content="2026-02-03T00:54:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小杨同学66"/> <meta itemprop="url" content="https://juejin.cn/user/1189004976589664"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Linux 封神之路】进程进阶实战：fork/vfork/exec 函数族 + 作业实现（含僵尸进程解决方案）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1189004976589664/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小杨同学66
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T00:54:43.000Z" title="Tue Feb 03 2026 00:54:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Linux 封神之路】进程进阶实战：fork/vfork/exec 函数族 + 作业实现（含僵尸进程解决方案）</h2>
<p>大家好，我是专注 Linux 技术分享的小杨。上一篇我们吃透了进程基础概念、状态和<code>fork</code>创建进程的核心用法。今天就进入进程进阶实战 —— 解锁<code>vfork</code>、<code>wait</code>、<code>waitpid</code>、<code>exec</code>函数族等核心 API，拆解父子进程同步、进程替换、僵尸进程回收等关键场景，最后手把手实现资料中的实战作业（定时生成日志文件 + 自动清理旧文件），帮你彻底掌握 Linux 进程编程的核心技能！</p>
<h3 data-id="heading-1">一、进程核心函数进阶：从创建到退出全流程</h3>
<p>上一篇我们重点讲了<code>fork</code>，这次补充剩余的核心进程函数，覆盖 “进程创建→同步等待→进程替换→退出” 全生命周期，每个函数都附实战场景和代码示例。</p>
<h4 data-id="heading-2">1. vfork：父子进程 “串行执行” 的创建方式</h4>
<p><code>vfork</code>与<code>fork</code>功能类似，但核心差异在于<strong>执行顺序和资源共享</strong>，适合需要子进程先完成特定任务（如初始化）的场景。</p>
<h5 data-id="heading-3">函数详解</h5>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">pid_t</span> <span class="hljs-title">vfork</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;
</code></pre>
<ul>
<li>
<p><strong>功能</strong>：创建子进程，父进程会阻塞直到子进程退出或执行<code>exec</code>函数族（子进程优先执行）；</p>
</li>
<li>
<p><strong>参数</strong>：无；</p>
</li>
<li>
<p><strong>返回值</strong>：与<code>fork</code>一致（父进程返回子进程 PID，子进程返回 0，失败返回 - 1）；</p>
</li>
<li>
<p><strong>核心差异（与 fork 对比）</strong> ：</p>

























<table><thead><tr><th>特性</th><th>fork</th><th>vfork</th></tr></thead><tbody><tr><td>执行顺序</td><td>父子进程并发竞争执行</td><td>子进程先执行，父进程阻塞</td></tr><tr><td>资源分配</td><td>子进程复制父进程资源（独立内存空间）</td><td>子进程与父进程共享内存空间</td></tr><tr><td>适用场景</td><td>父子进程并行执行</td><td>子进程需先完成初始化 / 任务，再让父进程执行</td></tr></tbody></table>
</li>
</ul>
<h5 data-id="heading-4">实战代码：vfork 创建子进程（子进程先执行）</h5>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"父进程启动，PID：%d\n"</span>, <span class="hljs-built_in">getpid</span>());

    <span class="hljs-type">pid_t</span> pid = <span class="hljs-built_in">vfork</span>();
    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">perror</span>(<span class="hljs-string">"vfork failed"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 子进程（优先执行）</span>
    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"子进程执行，PID：%d，父进程PID：%d\n"</span>, <span class="hljs-built_in">getpid</span>(), <span class="hljs-built_in">getppid</span>());
        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">2</span>); <span class="hljs-comment">// 子进程执行2秒任务</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"子进程执行完毕，即将退出\n"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 子进程必须调用exit退出，否则会导致父进程异常</span>
    }

    <span class="hljs-comment">// 父进程（子进程退出后才执行）</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"父进程恢复执行，子进程PID：%d\n"</span>, pid);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h5 data-id="heading-5">运行结果</h5>
<p>plaintext</p>
<pre><code class="hljs">父进程启动，PID：1234
子进程执行，PID：1235，父进程PID：1234
子进程执行完毕，即将退出
父进程恢复执行，子进程PID：1235
</code></pre>
<ul>
<li><strong>关键注意</strong>：vfork 创建的子进程必须调用<code>exit</code>退出，否则会继续执行父进程的代码（共享内存空间），导致程序异常。</li>
</ul>
<h4 data-id="heading-6">2. wait/waitpid：回收子进程资源（避免僵尸进程）</h4>
<p><code>wait</code>和<code>waitpid</code>是解决僵尸进程的核心函数，负责阻塞父进程，等待子进程退出并回收其 PID 和退出状态。</p>
<h5 data-id="heading-7">（1）wait 函数：简单回收任意子进程</h5>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">pid_t</span> <span class="hljs-title">wait</span><span class="hljs-params">(<span class="hljs-type">int</span> *wstatus)</span></span>;
</code></pre>
<ul>
<li><strong>功能</strong>：阻塞父进程，等待任意一个子进程退出，回收其资源；</li>
<li><strong>参数</strong>：<code>wstatus</code>：存储子进程退出状态（传 NULL 表示不关注）；</li>
<li><strong>返回值</strong>：成功返回退出子进程的 PID，失败返回 - 1；</li>
<li><strong>适用场景</strong>：父进程只有一个子进程，无需指定回收对象。</li>
</ul>
<h5 data-id="heading-8">（2）waitpid 函数：精准回收指定子进程（推荐）</h5>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">pid_t</span> <span class="hljs-title">waitpid</span><span class="hljs-params">(<span class="hljs-type">pid_t</span> pid, <span class="hljs-type">int</span> *wstatus, <span class="hljs-type">int</span> options)</span></span>;
</code></pre>
<ul>
<li>
<p><strong>功能</strong>：比<code>wait</code>更灵活，可指定回收的子进程、是否阻塞；</p>
</li>
<li>
<p><strong>核心参数</strong>：</p>
<ul>
<li><code>pid</code>：指定回收的子进程 PID（<code>-1</code>表示回收任意子进程，与<code>wait</code>一致）；</li>
<li><code>wstatus</code>：存储子进程退出状态；</li>
<li><code>options</code>：<code>0</code>表示阻塞等待（与<code>wait</code>一致），<code>WNOHANG</code>表示非阻塞（子进程未退出时立即返回 0）；</li>
</ul>
</li>
<li>
<p><strong>返回值</strong>：成功返回退出子进程的 PID，子进程未退出返回 0，失败返回 - 1；</p>
</li>
<li>
<p><strong>适用场景</strong>：父进程有多个子进程，需精准回收或非阻塞回收。</p>
</li>
</ul>
<h5 data-id="heading-9">实战代码：waitpid 非阻塞回收子进程</h5>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">pid_t</span> pid = fork();
    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">perror</span>(<span class="hljs-string">"fork failed"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 子进程执行3秒任务</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"子进程PID：%d，开始执行任务\n"</span>, <span class="hljs-built_in">getpid</span>());
        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">3</span>);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"子进程执行完毕，退出\n"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
    }

    <span class="hljs-comment">// 父进程非阻塞回收子进程</span>
    <span class="hljs-type">int</span> status;
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        <span class="hljs-type">pid_t</span> ret = <span class="hljs-built_in">waitpid</span>(pid, &amp;status, WNOHANG);
        <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">-1</span>) {
            <span class="hljs-built_in">perror</span>(<span class="hljs-string">"waitpid failed"</span>);
            <span class="hljs-keyword">break</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 子进程未退出，父进程可执行其他任务</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"父进程：子进程未退出，继续等待...\n"</span>);
            <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 子进程已回收</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"父进程：成功回收子进程PID：%d\n"</span>, ret);
            <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-10">3. exit/_exit：进程退出（清理资源差异）</h4>
<p>进程退出的两个核心函数，差异在于是否清理标准 IO 缓冲区。</p>
<h5 data-id="heading-11">函数详解</h5>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// exit：清理缓冲区后退出（推荐）</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">exit</span><span class="hljs-params">(<span class="hljs-type">int</span> status)</span></span>;

<span class="hljs-comment">// _exit：直接退出，不清理缓冲区</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-type">void</span> _exit(<span class="hljs-type">int</span> status);
</code></pre>
<ul>
<li>
<p><strong>参数</strong>：<code>status</code>：退出状态码（0 表示正常退出，非 0 表示异常退出）；</p>
</li>
<li>
<p><strong>核心差异</strong>：</p>
<ul>
<li><code>exit</code>：退出前会刷新标准 IO 缓冲区（如<code>printf</code>未换行的内容会输出），清理进程资源；</li>
<li><code>_exit</code>：直接终止进程，不刷新缓冲区，资源由内核回收；</li>
</ul>
</li>
<li>
<p><strong>实战对比</strong>：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"使用exit退出（会刷新缓冲区）"</span>); <span class="hljs-comment">// 无换行符</span>
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 输出完整字符串后退出</span>
}
</code></pre>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"使用_exit退出（不刷新缓冲区）"</span>); <span class="hljs-comment">// 无换行符</span>
    _exit(<span class="hljs-number">0</span>); <span class="hljs-comment">// 缓冲区内容未输出，直接退出</span>
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-12">4. exec 函数族：进程替换（启动新程序）</h4>
<p><code>exec</code>函数族的核心功能是 “替换当前进程的代码段和数据段”，启动一个新程序运行，原进程的 PID 保持不变（相当于 “换魂不换壳”），常与<code>vfork</code>配合使用。</p>
<h5 data-id="heading-13">常用函数：execl 与 execlp</h5>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// execl：需指定程序完整路径</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">execl</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *pathname, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *arg, ... <span class="hljs-comment">/* (char *) NULL */</span>)</span></span>;

<span class="hljs-comment">// execlp：从环境变量PATH中查找程序（无需完整路径）</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">execlp</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *arg, ... <span class="hljs-comment">/* (char *) NULL */</span>)</span></span>;
</code></pre>
<ul>
<li>
<p><strong>核心参数</strong>：</p>
<ul>
<li><code>pathname</code>（execl）：程序完整路径（如<code>/bin/ls</code>）；</li>
<li><code>file</code>（execlp）：程序名称（如<code>ls</code>，从 PATH 中查找）；</li>
<li><code>arg</code>：程序运行参数（第一个参数为程序名，后续为运行参数，结尾必须以<code>NULL</code>终止）；</li>
</ul>
</li>
<li>
<p><strong>返回值</strong>：成功时不会返回（程序已替换），失败返回 - 1；</p>
</li>
<li>
<p><strong>实战代码：execlp 启动 ls 命令</strong></p>
</li>
</ul>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"当前进程PID：%d，即将启动ls命令\n"</span>, <span class="hljs-built_in">getpid</span>());

    <span class="hljs-comment">// 用execlp启动ls命令（-l参数，结尾必须加NULL）</span>
    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">execlp</span>(<span class="hljs-string">"ls"</span>, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"-l"</span>, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">perror</span>(<span class="hljs-string">"execlp failed"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 以下代码不会执行（进程已被ls替换）</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"这行代码不会输出\n"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h5 data-id="heading-14">运行结果</h5>
<p>plaintext</p>
<pre><code class="hljs language-diff" lang="diff">当前进程PID：1236，即将启动ls命令
总用量 16
<span class="hljs-deletion">-rwxr-xr-x 1 zcy zcy 8960 2月  2 15:30 a.out</span>
<span class="hljs-deletion">-rw-r--r-- 1 zcy zcy  780 2月  2 15:29 test.c</span>
</code></pre>
<h3 data-id="heading-15">二、实战作业：定时生成日志文件（进程 + 文件操作综合）</h3>
<p>结合资料中的作业要求，实现一个 “定时生成日志 + 自动清理旧文件” 的程序，综合运用进程、文件操作、时间编程等知识点：</p>
<h4 data-id="heading-16">作业要求</h4>
<ol>
<li>创建<code>log</code>目录，日志文件以当前时间命名；</li>
<li>日志文件中记录 “当前是第 N 个日志文件”；</li>
<li>每 3 秒生成一个日志文件，<code>log</code>目录仅保留最新 10 个，超过则删除最早的；</li>
<li>父进程持续打印当前时间，子进程负责生成日志和清理文件。</li>
</ol>
<h4 data-id="heading-17">完整实现代码</h4>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dirent.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DIR <span class="hljs-string">"log"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_LOG_NUM 10  <span class="hljs-comment">// 最多保留10个日志文件</span></span>

<span class="hljs-comment">// 函数：创建log目录</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">create_log_dir</span><span class="hljs-params">()</span> {
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span>
    <span class="hljs-keyword">if</span> (stat(LOG_DIR, &amp;st) == <span class="hljs-number">-1</span>) {
        <span class="hljs-comment">// 目录不存在，创建目录（权限0755）</span>
        <span class="hljs-keyword">if</span> (mkdir(LOG_DIR, <span class="hljs-number">0755</span>) == <span class="hljs-number">-1</span>) {
            perror(<span class="hljs-string">"mkdir log failed"</span>);
            <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
        }
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"创建log目录成功\n"</span>);
    }
}

<span class="hljs-comment">// 函数：获取log目录下的日志文件数量及最早的文件名称</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">get_log_count_and_oldest</span><span class="hljs-params">(<span class="hljs-type">char</span> *oldest_file)</span> {
    DIR *dir = opendir(LOG_DIR);
    <span class="hljs-keyword">if</span> (!dir) {
        perror(<span class="hljs-string">"opendir log failed"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dirent</span> *<span class="hljs-title">entry</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span>
    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-type">time_t</span> oldest_time = time(<span class="hljs-literal">NULL</span>); <span class="hljs-comment">// 初始化为当前时间</span>
    <span class="hljs-type">char</span> file_path[<span class="hljs-number">256</span>];

    <span class="hljs-keyword">while</span> ((entry = readdir(dir)) != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-comment">// 跳过.和..</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">"."</span>) == <span class="hljs-number">0</span> || <span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">".."</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 拼接文件完整路径</span>
        <span class="hljs-built_in">snprintf</span>(file_path, <span class="hljs-keyword">sizeof</span>(file_path), <span class="hljs-string">"%s/%s"</span>, LOG_DIR, entry-&gt;d_name);
        <span class="hljs-keyword">if</span> (stat(file_path, &amp;st) == <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 仅统计普通文件（日志文件）</span>
            <span class="hljs-keyword">if</span> (S_ISREG(st.st_mode)) {
                count++;
                <span class="hljs-comment">// 记录最早的文件</span>
                <span class="hljs-keyword">if</span> (st.st_ctime &lt; oldest_time) {
                    oldest_time = st.st_ctime;
                    <span class="hljs-built_in">strcpy</span>(oldest_file, file_path);
                }
            }
        }
    }

    closedir(dir);
    <span class="hljs-keyword">return</span> count;
}

<span class="hljs-comment">// 函数：生成日志文件</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">generate_log_file</span><span class="hljs-params">(<span class="hljs-type">int</span> log_num)</span> {
    <span class="hljs-comment">// 获取当前时间，格式化文件名（如log/2026-02-02_15-30-00.log）</span>
    <span class="hljs-type">time_t</span> now = time(<span class="hljs-literal">NULL</span>);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tm</span> *<span class="hljs-title">lt</span> =</span> localtime(&amp;now);
    <span class="hljs-type">char</span> log_name[<span class="hljs-number">128</span>];
    <span class="hljs-built_in">snprintf</span>(log_name, <span class="hljs-keyword">sizeof</span>(log_name), <span class="hljs-string">"%s/%04d-%02d-%02d_%02d-%02d-%02d.log"</span>,
             LOG_DIR, lt-&gt;tm_year + <span class="hljs-number">1900</span>, lt-&gt;tm_mon + <span class="hljs-number">1</span>, lt-&gt;tm_mday,
             lt-&gt;tm_hour, lt-&gt;tm_min, lt-&gt;tm_sec);

    <span class="hljs-comment">// 创建并写入日志</span>
    FILE *fp = fopen(log_name, <span class="hljs-string">"w"</span>);
    <span class="hljs-keyword">if</span> (!fp) {
        perror(<span class="hljs-string">"fopen log failed"</span>);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-built_in">fprintf</span>(fp, <span class="hljs-string">"当前是第%d个日志文件\n"</span>, log_num);
    fclose(fp);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"生成日志文件：%s\n"</span>, log_name);
}

<span class="hljs-comment">// 函数：清理最早的日志文件</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">delete_oldest_log</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *oldest_file)</span> {
    <span class="hljs-keyword">if</span> (remove(oldest_file) == <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"删除最早日志文件：%s\n"</span>, oldest_file);
    } <span class="hljs-keyword">else</span> {
        perror(<span class="hljs-string">"remove oldest log failed"</span>);
    }
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 创建log目录</span>
    create_log_dir();

    <span class="hljs-comment">// 创建子进程：子进程生成日志，父进程打印当前时间</span>
    <span class="hljs-type">pid_t</span> pid = fork();
    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"fork failed"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 子进程：每3秒生成日志，清理旧文件</span>
    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
        <span class="hljs-type">int</span> log_num = <span class="hljs-number">1</span>;
        <span class="hljs-type">char</span> oldest_file[<span class="hljs-number">256</span>];
        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
            <span class="hljs-comment">// 生成日志文件</span>
            generate_log_file(log_num);
            log_num++;

            <span class="hljs-comment">// 检查日志文件数量，超过10个则删除最早的</span>
            <span class="hljs-type">int</span> count = get_log_count_and_oldest(oldest_file);
            <span class="hljs-keyword">if</span> (count &gt; MAX_LOG_NUM) {
                delete_oldest_log(oldest_file);
            }

            <span class="hljs-comment">// 每3秒生成一个</span>
            sleep(<span class="hljs-number">3</span>);
        }
    }

    <span class="hljs-comment">// 父进程：持续打印当前时间</span>
    <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
            <span class="hljs-type">time_t</span> now = time(<span class="hljs-literal">NULL</span>);
            <span class="hljs-type">char</span> time_str[<span class="hljs-number">64</span>];
            strftime(time_str, <span class="hljs-keyword">sizeof</span>(time_str), <span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>, localtime(&amp;now));
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"父进程 - 当前时间：%s\n"</span>, time_str);
            sleep(<span class="hljs-number">1</span>);
        }

        <span class="hljs-comment">// 回收子进程（实际不会执行，父进程是死循环）</span>
        wait(<span class="hljs-literal">NULL</span>);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-18">代码核心逻辑</h4>
<ol>
<li><strong>目录创建</strong>：<code>create_log_dir</code>函数检查<code>log</code>目录是否存在，不存在则创建；</li>
<li><strong>日志生成</strong>：<code>generate_log_file</code>函数以 “年 - 月 - 日_时 - 分 - 秒.log” 命名日志，写入文件序号；</li>
<li><strong>文件清理</strong>：<code>get_log_count_and_oldest</code>函数遍历<code>log</code>目录，统计文件数量并记录最早的文件，超过 10 个则调用<code>delete_oldest_log</code>删除；</li>
<li><strong>进程分工</strong>：子进程循环生成日志（每 3 秒一次），父进程持续打印当前时间（每 1 秒一次），父子进程并发执行。</li>
</ol>
<h4 data-id="heading-19">编译与运行</h4>
<p>bash</p>
<p>运行</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编译</span>
gcc log_generator.c -o log_generator
<span class="hljs-comment"># 运行</span>
./log_generator
</code></pre>
<h4 data-id="heading-20">运行效果</h4>
<p>plaintext</p>
<pre><code class="hljs language-bash" lang="bash">创建<span class="hljs-built_in">log</span>目录成功
父进程 - 当前时间：2026-02-02 15:35:00
生成日志文件：<span class="hljs-built_in">log</span>/2026-02-02_15-35-00.<span class="hljs-built_in">log</span>
父进程 - 当前时间：2026-02-02 15:35:01
父进程 - 当前时间：2026-02-02 15:35:02
父进程 - 当前时间：2026-02-02 15:35:03
生成日志文件：<span class="hljs-built_in">log</span>/2026-02-02_15-35-03.<span class="hljs-built_in">log</span>
父进程 - 当前时间：2026-02-02 15:35:04
...
<span class="hljs-comment"># 生成11个文件后，删除最早的</span>
删除最早日志文件：<span class="hljs-built_in">log</span>/2026-02-02_15-35-00.<span class="hljs-built_in">log</span>
</code></pre>
<h3 data-id="heading-21">三、课前分享函数：strcspn 与 strstr（字符串处理高频）</h3>
<p>资料中提到的两个字符串处理函数，是面试和开发中的高频工具，补充其用法：</p>
<h4 data-id="heading-22">1. strcspn：查找字符首次出现位置</h4>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">strcspn</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s1, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *s2)</span></span>;
</code></pre>
<ul>
<li>
<p><strong>功能</strong>：计算<code>s1</code>中 “不包含<code>s2</code>中任何字符” 的最长前缀长度（即<code>s2</code>中字符在<code>s1</code>中首次出现的位置）；</p>
</li>
<li>
<p><strong>返回值</strong>：前缀长度（也是<code>s2</code>字符首次出现的索引）；</p>
</li>
<li>
<p><strong>实战示例</strong>：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">char</span> s1[] = <span class="hljs-string">"abcdefg"</span>;
    <span class="hljs-type">char</span> s2[] = <span class="hljs-string">"d"</span>;
    <span class="hljs-type">size_t</span> len = <span class="hljs-built_in">strcspn</span>(s1, s2);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"'d'在s1中首次出现的索引：%ld\n"</span>, len); <span class="hljs-comment">// 输出3（a(0)、b(1)、c(2)、d(3)）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-23">2. strstr：查找子串</h4>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-function"><span class="hljs-type">char</span> *<span class="hljs-title">strstr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *haystack, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *needle)</span></span>;
</code></pre>
<ul>
<li>
<p><strong>功能</strong>：在<code>haystack</code>字符串中查找<code>needle</code>子串，找到返回子串首地址，未找到返回 NULL；</p>
</li>
<li>
<p><strong>实战示例</strong>：</p>
<p>c</p>
<p>运行</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment">#include &lt;stdio.h&gt;</span>
<span class="hljs-comment">#include &lt;string.h&gt;</span>

<span class="hljs-keyword">int</span> main() {
    char s[] = <span class="hljs-string">"hello linux world"</span>;
    char <span class="hljs-function"><span class="hljs-keyword">sub</span>[] = "<span class="hljs-title">linux</span>"</span>;
    char *<span class="hljs-keyword">pos</span> = strstr(s, <span class="hljs-function"><span class="hljs-keyword">sub</span>)</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">pos</span>) {
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"找到子串：%s\n"</span>, <span class="hljs-keyword">pos</span>); <span class="hljs-regexp">//</span> 输出<span class="hljs-string">"linux world"</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"未找到子串\n"</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-24">四、总结：进程进阶核心要点</h3>
<ol>
<li><strong>进程创建</strong>：<code>fork</code>（并发）和<code>vfork</code>（串行）按需选择，<code>vfork</code>子进程必须调用<code>exit</code>退出；</li>
<li><strong>资源回收</strong>：<code>waitpid</code>比<code>wait</code>更灵活，非阻塞模式适合父进程执行其他任务，避免僵尸进程；</li>
<li><strong>进程替换</strong>：<code>exec</code>函数族替换进程代码，<code>execlp</code>无需完整路径（从 PATH 查找），结尾必须加<code>NULL</code>；</li>
<li><strong>综合实战</strong>：进程 + 文件操作 + 时间编程的组合是嵌入式 / 服务器开发的常见场景，需掌握目录遍历、文件属性获取、定时任务等技能；</li>
<li><strong>字符串工具</strong>：<code>strcspn</code>和<code>strstr</code>是字符串处理的高频函数，简化字符查找和子串匹配逻辑。</li>
</ol>
<p>掌握这些进程进阶技能后，你就能应对 Linux 多任务开发、并发编程的核心场景。下一篇我们会学习进程间通信（IPC），解决父子进程 / 无关进程的数据交互问题，敬请关注！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一步生成，像素空间，何恺明让 pMF 做到了]]></title>    <link>https://juejin.cn/post/7602146335215501352</link>    <guid>https://juejin.cn/post/7602146335215501352</guid>    <pubDate>2026-02-03T02:28:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602146335215501352" data-draft-id="7602135278665072692" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一步生成，像素空间，何恺明让 pMF 做到了"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2026-02-03T02:28:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一步生成，像素空间，何恺明让 pMF 做到了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:28:54.000Z" title="Tue Feb 03 2026 02:28:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>何恺明团队最近抛出的这篇工作，多少有点“把老问题直接掀桌子重来”的味道。他们提出的 **<em>Pixel MeanFlow（pMF）</em> **，在不借助潜在空间、不依赖多步采样的前提下，只用一次前向传播，就生成了质量相当扎实的图像。在 ImageNet 上，256×256 分辨率做到 2.22 的 FID，512×512 也稳在 2.48。</p>
<p>如果把这些数字和过去几年主流扩散模型的设置放在一起对照，很难不意识到：<strong>这不是一次小幅优化，而是一次路线层面的收缩。</strong></p>
<p>论文中在 ImageNet 256×256 与 512×512 的系统级对比结果，这些表格基本奠定了 pMF 在“单步生成”赛道上的位置。</p>
<h2 data-id="heading-0"><strong>生成模型为什么总是又慢又绕？</strong></h2>
<p>把时间拨回到前几年，生成模型的主流路线几乎是固定的：一步一步采样，或者先压进潜在空间再生成。<strong>慢</strong>，是显性的；<strong>绕</strong>，则藏在系统结构里。</p>
<p>DDPM、Flow Matching 需要几十步反复修正，Stable Diffusion 看似轻巧，实则把复杂度转移给了一个庞大的 VAE 编码—解码系统。</p>
<p>这些设计并非拍脑袋得来，它们在稳定性和可控性上确实立过功。但工程代价也随之堆积：推理延迟高、调参空间大、模型结构臃肿。一旦进入部署阶段，这些问题会被无限放大。</p>
<p>后来出现的一致性模型、MeanFlow，开始尝试把“多步”压缩成“一步”；而 JiT 等工作，则直接挑战“像素空间是不是一定不可行”。问题是，这两条路始终没有真正汇合。</p>
<h2 data-id="heading-1"><strong>单步 + 像素空间，为什么一直没人走通？</strong></h2>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00a1e398afbf469fa42c3e463a6cde79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770690534&amp;x-signature=RadvI%2BbscnPNNA%2BH4%2Bcex%2BrK0is%3D" alt="screenshot_2026-02-02_16-18-15.png" loading="lazy"/></p>
<p>表面看，这只是把两个已有想法拼在一起；但真正做过的人都知道，这一步并不简单。</p>
<p>单步生成对模型表达能力的要求极高，而像素空间又是高维、强噪声的“重灾区”。多数方法要么在速度场里迷路，要么生成结果直接失控。</p>
<p>pMF 的切入点，恰恰不是继续在“预测什么”上死磕，而是换了一个问题问法：</p>
<p><strong>网络真的需要直接学那个最难的目标吗？</strong></p>
<p>作者用一张极其克制的示意图，把这个问题摆了出来。</p>
<h2 data-id="heading-2"><strong>把“学什么”和“怎么罚”拆开</strong></h2>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/428e907aeb5a4aa1af31ef63e8c967a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770690534&amp;x-signature=T13qvaA7RwLHiCKlwvstN3MgsJ0%3D" alt="screenshot_2026-02-02_16-19-25.png" loading="lazy"/></p>
<p>pMF 的核心想法，说穿了并不复杂，却非常有分寸感：</p>
<p>网络输出的空间，和损失约束的空间，不必是同一个。</p>
<p><strong>模型直接输出的是一张“去噪后的图像”——记作 x。它不要求完美复原干净样本，但被假定落在一个低维图像流形上，更接近真实世界里的图像形态。</strong></p>
<p>而真正承担物理与数学约束的，是损失函数，它仍然工作在 MeanFlow 的速度空间里。</p>
<p>两者之间，通过一个线性的、可解释的映射连接起来：</p>
<p>x = zₜ − t · u(zₜ, r, t)</p>
<p>给出了对应的仿真可视化：</p>
<p>zₜ 噪声密集、结构混乱；u 高维且不直观；而 x 已经呈现出模糊但合理的图像轮廓。</p>
<p>这一步，其实是把“难学的东西”，悄悄藏进了损失里。</p>
<h2 data-id="heading-3"><strong>高维空间里，预测谁更现实？</strong></h2>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2eb36bdb235e4338905591472b3bae1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770690534&amp;x-signature=ANaVSNCakrGkPk0Q0m4mN4xEopE%3D" alt="screenshot_2026-02-02_16-25-23.png" loading="lazy"/></p>
<p>直觉可以骗人，实验不会。</p>
<p>论文用一个二维玩具实验，把维度从 2 一路拉到 512，对比 x-预测和 u-预测的行为差异。结果在 Figure 2 中一目了然：</p>
<p>维度一高，u-预测几乎立刻崩盘；而 x-预测仍然能给出结构稳定的结果。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/110c2e4c73c643fc929f76daa89c8694~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770690534&amp;x-signature=e214e0J3bD3y6ghzs6qYiuAz0LE%3D" alt="screenshot_2026-02-02_16-27-58.png" loading="lazy"/></p>
<p>真实数据集上的表现更加直接。</p>
<p>在 ImageNet 64×64 下，两者尚能打平；但到了 256×256，u-预测的 FID 飙到 164.89，而 x-预测仍能维持在可用区间（FID 9.56）。这些数字集中呈现在 Table 2 中。</p>
<p>说到底，x 更像“图像应该长什么样”，而 u 更像“噪声世界里的导数”。神经网络会选择谁，答案并不意外。</p>
<h2 data-id="heading-4"><strong>感知损失，终于用在了该用的地方</strong></h2>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10c08510eb4e41b2926b0fc7a5c9e3c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770690534&amp;x-signature=Uuf%2BtV7JTZ%2FoFGFuyo5%2BU2tHKN4%3D" alt="screenshot_2026-02-02_16-29-18.png" loading="lazy"/></p>
<p>pMF 直接在像素空间出图，这件事带来了一个很现实的好处：</p>
<p>感知损失终于不再是“VAE 专属”。</p>
<p>加入 VGG-based LPIPS，FID 从 9.56 下降到 5.62；换成 ConvNeXt-V2 版本后，进一步压到 3.53。提升幅度不算含蓄，但完全说得通。</p>
<p>这不是技巧堆叠，而是路径改变带来的红利。</p>
<h2 data-id="heading-5"><strong>一步生成，也能站上性能前排</strong></h2>
<p>在 ImageNet 256×256 与 512×512 的完整系统对比中，pMF 的位置相当清晰：</p>
<p>一次前向传播（NFE=1），FID 却能和多步扩散模型掰手腕。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d254f3e86a4b4e6989fdc25a3ad37212~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770690534&amp;x-signature=uNVliy%2FaV8MluEX8ijjZtB%2Foh4g%3D" alt="screenshot_2026-02-02_16-29-46.png" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00ba45da7f3045c5bcbea69a2f836633~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770690534&amp;x-signature=awLFwVrXoi0%2BMIWjOBSCt5wjF6k%3D" alt="screenshot_2026-02-02_16-29-58.png" loading="lazy"/></p>
<p>从参数量、算力开销到生成质量，pMF 并非“便宜凑数”的方案，而是一个正经的高性能模型，只是把流程压缩到了极限。</p>
<h2 data-id="heading-6"><strong>这项工作真正留下的，是一条路</strong></h2>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1657731cbec4cf5b51fdbfa296d4d9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770690534&amp;x-signature=oNLmnpOHPOnN0TzpB%2BpOY74xvAw%3D" alt="screenshot_2026-02-02_16-34-57.png" loading="lazy"/></p>
<p>回头看，pMF 的意义，可能并不只在于刷新了某几个指标。</p>
<p>它更像是在提醒我们：生成模型不一定非得层层嵌套、步步回溯。只要目标设得足够聪明，约束放在合适的位置，一次映射，也可以是稳定而可信的。</p>
<p>未来这条路线能走多远，还需要时间验证。但至少，何恺明团队已经把“单步 + 像素空间”这道题，清清楚楚地写出了一种可行解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一看就懂的 Haskell 教程 - 类型系统基础与类型推断]]></title>    <link>https://juejin.cn/post/7602177113685688371</link>    <guid>https://juejin.cn/post/7602177113685688371</guid>    <pubDate>2026-02-03T02:28:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602177113685688371" data-draft-id="7602064004317413439" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一看就懂的 Haskell 教程 - 类型系统基础与类型推断"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-03T02:28:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Anita_Sun"/> <meta itemprop="url" content="https://juejin.cn/user/1811635884786839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一看就懂的 Haskell 教程 - 类型系统基础与类型推断
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1811635884786839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Anita_Sun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:28:14.000Z" title="Tue Feb 03 2026 02:28:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Haskell 作为<strong>纯函数式静态强类型编程语言</strong>，其类型系统是设计的核心基石，核心设计思想围绕<strong>编译期类型安全、无副作用的纯函数抽象、泛型代码的高度复用、最小化显式类型标注</strong>展开——通过静态强类型在编译期拦截几乎所有类型相关错误，结合强大的类型推断机制减少冗余的类型代码，以多态类型实现跨类型的代码复用，同时通过灵活的类型扩展特性平衡“类型安全”与“开发效率”，最终让代码兼具<strong>严谨性、复用性和简洁性</strong>，这也是Haskell能成为函数式编程典范、广泛应用于高可靠系统开发的核心原因。</p>
<h2 data-id="heading-0">类型与类型签名</h2>
<p>类型是Haskell中描述<strong>值的特征与行为边界</strong>的核心标识，类型签名则是显式标注变量、函数类型的语法规范，是沟通程序员与编译器的重要桥梁，也是静态类型检查的基础，核心包含三个关键知识点，所有知识点均附可运行代码示例：</p>
<h3 data-id="heading-1">:: 含义</h3>
<p><code>::</code> 是Haskell的<strong>类型标注符</strong>，核心作用是显式指定“标识符（变量/函数/表达式）对应的类型”，语法格式为<code>标识符 :: 类型</code>。编译器会根据<code>::</code>标注的类型进行严格校验，若代码逻辑与标注类型冲突则直接报编译错误；同时<code>::</code>也可辅助编译器完成复杂场景的类型推断，避免歧义。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 变量类型标注</span>
age :: <span class="hljs-type">Int</span>          <span class="hljs-comment">-- 整数类型</span>
age <span class="hljs-operator">=</span> <span class="hljs-number">20</span>
name :: String      <span class="hljs-comment">-- 字符串类型（等价于[Char]）</span>
name <span class="hljs-operator">=</span> "Haskell"
nums :: [<span class="hljs-keyword">Double</span>]    <span class="hljs-comment">-- 浮点数列表类型</span>
nums <span class="hljs-operator">=</span> [<span class="hljs-number">1.2</span>, <span class="hljs-number">3.4</span>, <span class="hljs-number">5.6</span>]
person :: (String, <span class="hljs-type">Int</span>)  <span class="hljs-comment">-- 二元元组类型</span>
person <span class="hljs-operator">=</span> ("Tom", <span class="hljs-number">25</span>)

<span class="hljs-comment">-- 2. 函数类型标注</span>
<span class="hljs-keyword">add</span> :: <span class="hljs-type">Int</span> <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">Int</span> <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">Int</span>
<span class="hljs-keyword">add</span> x y <span class="hljs-operator">=</span> x <span class="hljs-operator">+</span> y

<span class="hljs-comment">-- 3. 表达式类型标注（解决推断歧义）</span>
num :: <span class="hljs-keyword">Double</span>
num <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> <span class="hljs-operator">+</span> <span class="hljs-number">2</span> <span class="hljs-operator">*</span> <span class="hljs-number">3</span>) :: <span class="hljs-keyword">Double</span>  <span class="hljs-comment">-- 显式指定表达式结果为Double</span>
</code></pre>
<h3 data-id="heading-2">函数类型-&gt; 右结合</h3>
<p><code>-&gt;</code> 是Haskell<strong>函数类型的核心表示符</strong>，用于描述“函数的输入类型与输出类型的映射关系”，且<code>-&gt;</code>具有<strong>天然的右结合特性</strong>（编译器默认按从右到左的顺序嵌套解析），即<code>a -&gt; b -&gt; c</code>等价于<code>a -&gt; (b -&gt; c)</code>，这一特性与Haskell的<strong>柯里化（Currying）</strong> 特性深度绑定——Haskell中所有多参数函数的本质，都是“接收一个参数、返回一个新函数”的单参数函数，新函数再接收下一个参数，直至返回最终结果。</p>
<pre><code class="hljs language-rust" lang="rust">-- <span class="hljs-number">1</span>. 右结合示例<span class="hljs-number">1</span>：双参数函数的本质是返回函数的单参数函数
f :: Int <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> <span class="hljs-punctuation">-&gt;</span> Bool
f x y = x &gt; length y  -- 等价于 f :: Int <span class="hljs-punctuation">-&gt;</span> (<span class="hljs-type">String</span> <span class="hljs-punctuation">-&gt;</span> Bool)
-- 调用方式<span class="hljs-number">1</span>：常规调用（隐式柯里化）
f1 = f <span class="hljs-number">5</span> <span class="hljs-string">"abc"</span>  -- 结果：True（<span class="hljs-number">5</span> &gt; <span class="hljs-number">3</span>）
-- 调用方式<span class="hljs-number">2</span>：分步调用（显式柯里化，体现右结合本质）
f' :: <span class="hljs-type">String</span> <span class="hljs-punctuation">-&gt;</span> Bool
f' = f <span class="hljs-number">5</span>        -- f接收Int参数<span class="hljs-number">5</span>，返回一个<span class="hljs-string">"String -&gt; Bool"</span>的新函数
f2 = f' <span class="hljs-string">"abc"</span>   -- 结果：True

-- <span class="hljs-number">2</span>. 右结合示例<span class="hljs-number">2</span>：三参数函数的嵌套解析
g :: a <span class="hljs-punctuation">-&gt;</span> b <span class="hljs-punctuation">-&gt;</span> c <span class="hljs-punctuation">-&gt;</span> (b, c, a)
g x y z = (y, z, x)  -- 等价于 g :: a <span class="hljs-punctuation">-&gt;</span> (b <span class="hljs-punctuation">-&gt;</span> (c <span class="hljs-punctuation">-&gt;</span> (b, c, a)))
-- 分步调用：每层接收一个参数，返回新函数
g1 :: b <span class="hljs-punctuation">-&gt;</span> c <span class="hljs-punctuation">-&gt;</span> (b, c, Int)
g1 = g <span class="hljs-number">10</span>          -- 接收a=Int，返回b<span class="hljs-punctuation">-&gt;</span>c<span class="hljs-punctuation">-&gt;</span>(b,c,Int)
g2 :: c <span class="hljs-punctuation">-&gt;</span> (<span class="hljs-type">String</span>, c, Int)
g2 = g1 <span class="hljs-string">"hello"</span>    -- 接收b=<span class="hljs-type">String</span>，返回c<span class="hljs-punctuation">-&gt;</span>(<span class="hljs-type">String</span>,c,Int)
g3 = g2 <span class="hljs-number">3.14</span>       -- 接收c=Double，返回最终结果 (<span class="hljs-string">"hello"</span>,<span class="hljs-number">3.14</span>,<span class="hljs-number">10</span>)
</code></pre>
<h3 data-id="heading-3">多参数函数类型</h3>
<p>基于Haskell的柯里化特性和<code>-&gt;</code>的右结合规则，<strong>不存在专门的多参数函数类型表示</strong>，所有多参数函数的类型，均通过<code>-&gt;</code>的嵌套（右结合）实现——参数的数量对应<code>-&gt;</code>的数量（n个参数对应n个<code>-&gt;</code>），最右侧为函数的最终返回类型，左侧依次为各参数的类型。</p>
<pre><code class="hljs language-rust" lang="rust">-- <span class="hljs-number">1</span>. 一元函数（<span class="hljs-number">1</span>个参数，<span class="hljs-number">1</span>个<span class="hljs-punctuation">-&gt;</span>）
square :: Int <span class="hljs-punctuation">-&gt;</span> Int
square x = x * x
showInt :: Int <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span>
showInt = show

-- <span class="hljs-number">2</span>. 二元函数（<span class="hljs-number">2</span>个参数，<span class="hljs-number">2</span>个<span class="hljs-punctuation">-&gt;</span>）
plus :: Num a =&gt; a <span class="hljs-punctuation">-&gt;</span> a <span class="hljs-punctuation">-&gt;</span> a
plus x y = x + y
compareStr :: <span class="hljs-type">String</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> <span class="hljs-punctuation">-&gt;</span> Ordering
compareStr s1 s2 = <span class="hljs-title function_ invoke__">compare</span> (length s1) (length s2)

-- <span class="hljs-number">3</span>. 三元函数（<span class="hljs-number">3</span>个参数，<span class="hljs-number">3</span>个<span class="hljs-punctuation">-&gt;</span>）
addThree :: Int <span class="hljs-punctuation">-&gt;</span> Int <span class="hljs-punctuation">-&gt;</span> Int <span class="hljs-punctuation">-&gt;</span> Int
addThree x y z = x + y + z
lookupByKey :: <span class="hljs-built_in">Eq</span> k =&gt; k <span class="hljs-punctuation">-&gt;</span> [(k, v)] <span class="hljs-punctuation">-&gt;</span> Maybe v
lookupByKey k [] = Nothing
lookupByKey <span class="hljs-title function_ invoke__">k</span> ((k',v):xs) | k == k' = Just v
                          | otherwise = lookupByKey k xs

-- <span class="hljs-number">4</span>. 带类型类约束的多参数函数
printIfEq :: (<span class="hljs-built_in">Eq</span> a, Show a) =&gt; a <span class="hljs-punctuation">-&gt;</span> a <span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">IO</span> ()
printIfEq x y = <span class="hljs-keyword">if</span> x == y then print x <span class="hljs-keyword">else</span> print <span class="hljs-string">"Not Equal"</span>
</code></pre>
<h2 data-id="heading-4">类型推断机制</h2>
<p>类型推断是Haskell的核心特性之一，指<strong>编译器无需显式的类型标注，通过分析表达式的语法结构、运算关系和类型类约束，自动推导出变量/函数/表达式的最通用类型</strong>，这一特性让Haskell兼具“静态类型的安全性”和“动态类型的简洁性”，其底层依托经典算法实现，同时存在明确的推断规则和限制，所有知识点均附代码示例：</p>
<h3 data-id="heading-5">Hindley-Milner 算法</h3>
<p>Hindley-Milner（HM）算法是Haskell<strong>类型推断的底层核心算法</strong>，也是绝大多数纯函数式语言（OCaml、Scala等）类型推断的基础，该算法于1969年提出，核心优势是<strong>能在无显式标注时，推导出表达式的“最一般通用类型（Most General Unifier, MGU）”</strong> ，且推导过程高效、无歧义，兼顾通用性和编译效率。</p>
<p>核心原理：通过为表达式中的未知类型分配<strong>类型变量</strong>（如a、b、c），再根据表达式的运算规则建立<strong>类型等式</strong>，最终通过<strong>合一（Unification）</strong> 算法求解类型变量，得到最通用的类型。</p>
<pre><code class="hljs language-rust" lang="rust">-- 无需任何类型标注，HM算法自动推导最通用类型
-- <span class="hljs-number">1</span>. 恒等函数：推导为 a <span class="hljs-punctuation">-&gt;</span> a（a为任意类型变量）
id x = x
-- 可适配任意类型，无约束
id1 = id <span class="hljs-number">10</span>        -- Int <span class="hljs-punctuation">-&gt;</span> Int
id2 = id <span class="hljs-string">"abc"</span>     -- <span class="hljs-type">String</span> <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span>
id3 = id [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]   -- [Int] <span class="hljs-punctuation">-&gt;</span> [Int]

-- <span class="hljs-number">2</span>. 列表映射函数：推导为 (a <span class="hljs-punctuation">-&gt;</span> b) <span class="hljs-punctuation">-&gt;</span> [a] <span class="hljs-punctuation">-&gt;</span> [b]
map' f [] = []
map' <span class="hljs-title function_ invoke__">f</span> (x:xs) = f x : map' f xs
-- 自动适配不同的类型映射
map1 = map' (+<span class="hljs-number">1</span>) [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]  -- (Int<span class="hljs-punctuation">-&gt;</span>Int) <span class="hljs-punctuation">-&gt;</span> [Int]<span class="hljs-punctuation">-&gt;</span>[Int]，结果[<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]
map2 = map' show [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]  -- (Int<span class="hljs-punctuation">-&gt;</span><span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> [Int]<span class="hljs-punctuation">-&gt;</span>[<span class="hljs-type">String</span>]，结果[<span class="hljs-string">"1"</span>,<span class="hljs-string">"2"</span>,<span class="hljs-string">"3"</span>]

-- <span class="hljs-number">3</span>. 元组交换函数：推导为 (a, b) <span class="hljs-punctuation">-&gt;</span> (b, a)
<span class="hljs-title function_ invoke__">swap</span> (x, y) = (y, x)
swap1 = <span class="hljs-title function_ invoke__">swap</span> (<span class="hljs-number">10</span>, <span class="hljs-string">"abc"</span>)  -- (Int,<span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> (<span class="hljs-type">String</span>,Int)，结果(<span class="hljs-string">"abc"</span>,<span class="hljs-number">10</span>)
swap2 = <span class="hljs-title function_ invoke__">swap</span> ([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], <span class="hljs-number">3.14</span>)-- ([Int],Double) <span class="hljs-punctuation">-&gt;</span> (Double,[Int])，结果(<span class="hljs-number">3.14</span>,[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>])
</code></pre>
<h3 data-id="heading-6">无约束/约束推断</h3>
<p>根据表达式是否涉及类型类操作，Haskell的类型推断分为<strong>无约束推断</strong>和<strong>约束推断</strong>两类，二者均基于HM算法，核心差异是推导结果是否带有类型类约束，覆盖所有常规编码场景：</p>
<h4 data-id="heading-7">无约束推断</h4>
<p>针对<strong>无类型类依赖、无特殊行为限制</strong>的表达式，推导出<strong>纯泛型类型</strong>（仅包含类型变量，无任何约束），该类型可适配任意具体类型，是Haskell参数多态的核心实现。</p>
<pre><code class="hljs language-ini" lang="ini">-- 无需类型标注，编译器无约束推断纯泛型类型
-- 1. 单参数泛型函数：推断为 a -&gt; <span class="hljs-section">[a]</span>
repeatOne <span class="hljs-attr">x</span> = [x]
<span class="hljs-attr">r1</span> = repeatOne <span class="hljs-number">10</span>    -- [Int]
<span class="hljs-attr">r2</span> = repeatOne <span class="hljs-string">'a'</span>   -- [Char]
<span class="hljs-attr">r3</span> = repeatOne [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>] -- [[Int]]

-- 2. 双参数泛型函数：推断为 a -&gt; b -&gt; (a, b, <span class="hljs-section">[a]</span>)
combine x <span class="hljs-attr">y</span> = (x, y, [x, x])
<span class="hljs-attr">c1</span> = combine <span class="hljs-number">5</span> <span class="hljs-string">"abc"</span>  -- (Int, String, [Int])
<span class="hljs-attr">c2</span> = combine <span class="hljs-string">'a'</span> <span class="hljs-number">3.14</span> -- (Char, Double, [Char])

-- 3. 列表操作泛型函数：推断为 <span class="hljs-section">[a]</span> -&gt; Int
listLen <span class="hljs-attr">xs</span> = length xs
<span class="hljs-attr">l1</span> = listLen [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]  -- Int
<span class="hljs-attr">l2</span> = listLen <span class="hljs-string">"hello"</span>  -- Int
</code></pre>
<h4 data-id="heading-8">约束推断</h4>
<p>针对<strong>涉及类型类操作（如+、==、show）</strong> 的表达式，推导结果会<strong>带上对应的类型类约束</strong>，限制类型变量的适用范围——仅实现了该类型类的具体类型，才能使用该表达式，兼顾泛型和类型安全，是Haskell约束多态的核心实现。</p>
<pre><code class="hljs language-ini" lang="ini">-- 无需类型标注，编译器自动推导带类型类约束的类型
-- 1. 涉及Num类型类（+、*、0）：推断为 Num <span class="hljs-attr">a</span> =&gt; a -&gt; a -&gt; a
add' x <span class="hljs-attr">y</span> = x + y * <span class="hljs-number">2</span>
<span class="hljs-attr">a1</span> = add<span class="hljs-string">' 10 5    -- Int（10+5*2=20）
a2 = add'</span> <span class="hljs-number">1.2</span> <span class="hljs-number">3.4</span> -- Double（<span class="hljs-number">1.2</span>+<span class="hljs-number">3.4</span>*<span class="hljs-number">2</span>=<span class="hljs-number">8.0</span>）

-- 2. 涉及Eq类型类（==、/=）：推断为 Eq <span class="hljs-attr">a</span> =&gt; a -&gt; a -&gt; Bool
isEqual x <span class="hljs-attr">y</span> = x == y
<span class="hljs-attr">e1</span> = isEqual <span class="hljs-number">5</span> <span class="hljs-number">5</span>    -- Bool（<span class="hljs-literal">True</span>）
<span class="hljs-attr">e2</span> = isEqual <span class="hljs-string">"abc"</span> <span class="hljs-string">"def"</span> -- Bool（<span class="hljs-literal">False</span>）

-- 3. 涉及Show类型类（show）：推断为 Show <span class="hljs-attr">a</span> =&gt; a -&gt; String
show' <span class="hljs-attr">x</span> = <span class="hljs-string">"Value: "</span> ++ show x
<span class="hljs-attr">s1</span> = show<span class="hljs-string">' 100    -- String（"Value: 100"）
s2 = show'</span> <span class="hljs-number">3.14</span>   -- String（<span class="hljs-string">"Value: 3.14"</span>）

-- 4. 多类型类约束：推断为 (Num a, Show a) =&gt; a -&gt; String
calcAndShow <span class="hljs-attr">x</span> = show (x * x + <span class="hljs-number">1</span>)
<span class="hljs-attr">cs1</span> = calcAndShow <span class="hljs-number">5</span>   -- <span class="hljs-string">"26"</span>
<span class="hljs-attr">cs2</span> = calcAndShow <span class="hljs-number">2.5</span> -- <span class="hljs-string">"7.25"</span>
</code></pre>
<h3 data-id="heading-9">类型推断限制</h3>
<p>Haskell的类型推断能力强大，但并非万能，受HM算法本身和语言设计的限制，在<strong>部分复杂场景下无法完成自动推断</strong>，此时编译器会报“类型歧义”或“无法推导类型”错误，需要程序员添加<strong>显式类型标注</strong>辅助编译器完成推断，核心限制场景均附代码示例：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 复杂递归函数：嵌套递归导致推断失败，需标注类型</span>
<span class="hljs-comment">-- 未标注：编译报错，标注后正常</span>
fact :: <span class="hljs-type">Int</span> <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">Int</span>  <span class="hljs-comment">-- 显式标注类型</span>
fact <span class="hljs-number">0</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
fact n <span class="hljs-operator">=</span> n <span class="hljs-operator">*</span> fact (n<span class="hljs-number">-1</span>)

<span class="hljs-comment">-- 2. 多参数类型类的歧义场景：无函数依赖导致无法推断返回类型</span>
class <span class="hljs-keyword">Convert</span> a b <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">convert</span> :: a <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> b
<span class="hljs-comment">-- 实现Int到String的转换</span>
instance <span class="hljs-keyword">Convert</span> <span class="hljs-type">Int</span> String <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">convert</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">show</span>
<span class="hljs-comment">-- 调用时无标注：编译报错（无法推断b的类型），需显式标注</span>
cvt :: String
cvt <span class="hljs-operator">=</span> <span class="hljs-keyword">convert</span> <span class="hljs-number">123</span> :: String  <span class="hljs-comment">-- 显式指定返回类型为String</span>

<span class="hljs-comment">-- 3. 数值类型的极端歧义：无上下文的泛型数值，需标注</span>
<span class="hljs-comment">-- 未标注：编译报错（Num a =&gt; a 存在歧义）</span>
num1 :: <span class="hljs-type">Int</span>
num1 <span class="hljs-operator">=</span> <span class="hljs-number">10</span> :: <span class="hljs-type">Int</span>
<span class="hljs-comment">-- 或通过上下文约束（如赋值给指定类型变量）</span>
num2 :: <span class="hljs-keyword">Double</span>
num2 <span class="hljs-operator">=</span> <span class="hljs-number">3.14</span>

<span class="hljs-comment">-- 4. 高阶类型的复杂组合：多构造器嵌套导致推断歧义</span>
import Data.Maybe
<span class="hljs-comment">-- 未标注：编译警告，标注后清晰</span>
process :: Maybe [<span class="hljs-type">Int</span>] <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> [<span class="hljs-type">Int</span>]
process mxs <span class="hljs-operator">=</span> maybe [] (map (<span class="hljs-operator">+</span><span class="hljs-number">1</span>)) mxs
p1 <span class="hljs-operator">=</span> process (Just [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]) <span class="hljs-comment">-- [2,3,4]</span>
p2 <span class="hljs-operator">=</span> process Nothing        <span class="hljs-comment">-- []</span>
</code></pre>
<h2 data-id="heading-10">多态类型</h2>
<p>多态（Polymorphism）意为“一个接口，多种实现”，是Haskell实现<strong>泛型编程、代码高度复用</strong>的核心机制，让代码脱离具体类型的限制，适配不同的类型场景。Haskell中的多态类型分为<strong>参数多态、约束多态、Ad-hoc 多态</strong>三类，三者层层递进，覆盖从“纯通用抽象”到“类型特化实现”的所有泛型需求，所有知识点均附可运行代码示例：</p>
<h3 data-id="heading-11">参数多态</h3>
<p>参数多态是Haskell<strong>最基础、最核心的泛型多态</strong>，也被称为“泛型多态”或“无约束多态”，通过<strong>类型变量（如a、b、c）</strong> 实现“一份代码适配所有类型”，无任何类型约束和行为限制，仅依赖类型的结构特征（如列表、元组的嵌套结构），是Haskell代码复用的最主要手段。</p>
<pre><code class="hljs language-ini" lang="ini">-- 1. 基础参数多态：恒等函数（a -&gt; a），适配任意类型
id :: a -&gt; a
id <span class="hljs-attr">x</span> = x
<span class="hljs-attr">id1</span> = id <span class="hljs-number">10</span>        -- Int
<span class="hljs-attr">id2</span> = id <span class="hljs-string">"abc"</span>     -- String
<span class="hljs-attr">id3</span> = id [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]   -- [Int]
<span class="hljs-attr">id4</span> = id (Just <span class="hljs-number">5</span>)  -- Maybe Int

-- 2. 列表通用操作：(a -&gt; b) -&gt; <span class="hljs-section">[a]</span> -&gt; <span class="hljs-section">[b]</span>，适配任意类型列表
map' :: (a -&gt; b) -&gt; <span class="hljs-section">[a]</span> -&gt; <span class="hljs-section">[b]</span>
map' f <span class="hljs-section">[]</span> = <span class="hljs-section">[]</span>
map' f (x:xs) = f x : map' f xs
-- 适配Int-&gt;Int
<span class="hljs-attr">m1</span> = map<span class="hljs-string">' (+1) [1,2,3]  -- [2,3,4]
-- 适配Int-&gt;String
m2 = map'</span> show [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]  -- [<span class="hljs-string">"1"</span>,<span class="hljs-string">"2"</span>,<span class="hljs-string">"3"</span>]
-- 适配String-&gt;Int
<span class="hljs-attr">m3</span> = map<span class="hljs-string">' length ["a", "ab", "abc"]  -- [1,2,3]

-- 3. 元组通用操作：(a, b) -&gt; (b, a)，适配任意二元元组
swap'</span> :: (a, b) -&gt; (b, a)
swap' (x, y) = (y, x)
<span class="hljs-attr">s1</span> = swap<span class="hljs-string">' (10, "abc")  -- ("abc", 10)
s2 = swap'</span> (<span class="hljs-number">3.14</span>, [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>])-- ([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], <span class="hljs-number">3.14</span>)
</code></pre>
<h3 data-id="heading-12">约束多态</h3>
<p>约束多态是<strong>带类型类约束的参数多态</strong>，也被称为“有界多态”，在参数多态的基础上，通过<code>=&gt;</code>为类型变量添加<strong>类型类约束</strong>，限制类型变量的适用范围——仅实现了该类型类的具体类型，才能使用该代码，让泛型代码可以调用类型类定义的抽象行为（如+、==、show），兼顾“泛型复用”和“类型专属行为”。</p>
<pre><code class="hljs language-ini" lang="ini">-- 1. 带Num约束：Num <span class="hljs-attr">a</span> =&gt; a -&gt; a -&gt; a，仅适配数值类型
sumTwo :: Num <span class="hljs-attr">a</span> =&gt; a -&gt; a -&gt; a
sumTwo x <span class="hljs-attr">y</span> = x + y
<span class="hljs-attr">s1</span> = sumTwo <span class="hljs-number">10</span> <span class="hljs-number">20</span>    -- Int（<span class="hljs-number">30</span>）
<span class="hljs-attr">s2</span> = sumTwo <span class="hljs-number">1.2</span> <span class="hljs-number">3.4</span>  -- Double（<span class="hljs-number">4.6</span>）
<span class="hljs-attr">s3</span> = sumTwo <span class="hljs-number">5</span> <span class="hljs-number">3.14</span>   -- Double（<span class="hljs-number">8.14</span>，自动类型统一）

-- 2. 带Eq约束：Eq <span class="hljs-attr">a</span> =&gt; [a] -&gt; a -&gt; Bool，仅适配可比较相等的类型
contains :: Eq <span class="hljs-attr">a</span> =&gt; [a] -&gt; a -&gt; Bool
contains <span class="hljs-section">[]</span> <span class="hljs-attr">_</span> = <span class="hljs-literal">False</span>
contains (x:xs) y | <span class="hljs-attr">x</span> == y    = <span class="hljs-literal">True</span>
                  | <span class="hljs-attr">otherwise</span> = contains xs y
<span class="hljs-attr">c1</span> = contains [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>] <span class="hljs-number">2</span>    -- <span class="hljs-literal">True</span>
<span class="hljs-attr">c2</span> = contains [<span class="hljs-string">"a"</span>,<span class="hljs-string">"b"</span>] <span class="hljs-string">"c"</span>-- <span class="hljs-literal">False</span>
<span class="hljs-attr">c3</span> = contains [Just <span class="hljs-number">1</span>, Nothing] Nothing -- <span class="hljs-literal">True</span>

-- 3. 带Num+Show约束：(Num a, Show a) =&gt; a -&gt; String，多约束组合
numToStr :: (Num a, Show a) =&gt; a -&gt; String
numToStr <span class="hljs-attr">x</span> = <span class="hljs-string">"Number: "</span> ++ show (x * <span class="hljs-number">2</span>)
<span class="hljs-attr">n1</span> = numToStr <span class="hljs-number">5</span>    -- <span class="hljs-string">"Number: 10"</span>
<span class="hljs-attr">n2</span> = numToStr <span class="hljs-number">2.5</span>  -- <span class="hljs-string">"Number: 5.0"</span>

-- 4. 列表通用求和：Num <span class="hljs-attr">a</span> =&gt; [a] -&gt; a，仅适配数值列表
sum' :: Num <span class="hljs-attr">a</span> =&gt; [a] -&gt; a
sum' <span class="hljs-section">[]</span> = 0
sum' (x:xs) = x + sum' xs
<span class="hljs-attr">su1</span> = sum<span class="hljs-string">' [1,2,3,4]    -- Int（10）
su2 = sum'</span> [<span class="hljs-number">1.1</span>,<span class="hljs-number">2.2</span>,<span class="hljs-number">3.3</span>]-- Double（<span class="hljs-number">6.6</span>）
</code></pre>
<h3 data-id="heading-13">Ad-hoc 多态</h3>
<p>Ad-hoc 多态也被称为<strong>特化多态</strong>，指“同一函数名（或操作符），根据参数的具体类型不同，拥有完全不同的实现逻辑”，即“接口统一，实现特化”。在Haskell中，Ad-hoc 多态<strong>完全通过类型类和实例实现</strong>，区别于参数多态的“一份通用实现适配所有类型”，是实现“类型专属行为”的核心方式。</p>
<pre><code class="hljs language-ini" lang="ini">-- 1. 自定义类型类实现Ad-hoc多态：同一接口，不同类型不同实现
class Printable a where
  printVal :: a -&gt; String  -- 统一接口

-- 为Int实现实例：特化实现1
instance Printable Int where
  printVal <span class="hljs-attr">x</span> = <span class="hljs-string">"Integer Value: "</span> ++ show x

-- 为String实现实例：特化实现2
instance Printable String where
  printVal <span class="hljs-attr">x</span> = <span class="hljs-string">"String Value: "</span><span class="hljs-string">" ++ x ++ "</span><span class="hljs-string">""</span>

-- 为Double实现实例：特化实现3
instance Printable Double where
  printVal <span class="hljs-attr">x</span> = <span class="hljs-string">"Double Value: "</span> ++ show (x * <span class="hljs-number">100</span>) ++ <span class="hljs-string">"%"</span>

-- 统一调用，编译器自动选择对应实现
<span class="hljs-attr">p1</span> = printVal <span class="hljs-number">100</span>    -- <span class="hljs-string">"Integer Value: 100"</span>（Int实例）
<span class="hljs-attr">p2</span> = printVal <span class="hljs-string">"Haskell"</span> -- <span class="hljs-string">"String Value: "</span>Haskell<span class="hljs-string">""</span>（String实例）
<span class="hljs-attr">p3</span> = printVal <span class="hljs-number">0.95</span>   -- <span class="hljs-string">"Double Value: 95.0%"</span>（Double实例）

-- 2. 标准库类型类的Ad-hoc多态：show函数（统一接口，特化实现）
<span class="hljs-attr">s1</span> = show <span class="hljs-number">123</span>        -- <span class="hljs-string">"123"</span>（Int的Show实例）
<span class="hljs-attr">s2</span> = show <span class="hljs-string">'a'</span>        -- <span class="hljs-string">"'a'"</span>（Char的Show实例）
<span class="hljs-attr">s3</span> = show [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]    -- <span class="hljs-string">"[1,2,3]"</span>（[Int]的Show实例）
<span class="hljs-attr">s4</span> = show (Just <span class="hljs-number">5</span>)   -- <span class="hljs-string">"Just 5"</span>（Maybe Int的Show实例）

-- 3. 操作符的Ad-hoc多态：+号（Num类型类的特化实现）
<span class="hljs-attr">add1</span> = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>         -- 整数加法（Int的Num实例）
<span class="hljs-attr">add2</span> = <span class="hljs-number">1.2</span> + <span class="hljs-number">3.4</span>     -- 浮点数加法（Double的Num实例）
<span class="hljs-attr">add3</span> = <span class="hljs-number">5</span> + <span class="hljs-number">3.14</span>      -- 混合类型加法（自动统一为Double实例）
</code></pre>
<h2 data-id="heading-14">类型别名与新类型</h2>
<p>在实际开发中，常会遇到“复杂类型冗余”“基础类型混用导致歧义”“需要为类型添加专属标识”的问题，Haskell提供了<code>type</code>和<code>newtype</code>两个核心关键字，分别用于<strong>类型别名定义</strong>和<strong>零成本类型包装</strong>，同时<code>newtype</code>与常用的<code>data</code>关键字存在明确差异，三者各司其职，解决类型设计中的不同问题：</p>
<h3 data-id="heading-15">type 关键字简化类型</h3>
<p><code>type</code>关键字用于<strong>定义类型别名</strong>，核心作用是对<strong>复杂、冗长的原有类型</strong>进行重命名，仅做<strong>语法层面的简化和可读性提升</strong>，不生成任何新的类型标识，编译期编译器会将类型别名自动还原为原类型，无任何运行时成本，也无类型安全的隔离效果。</p>
<pre><code class="hljs language-ini" lang="ini">-- 1. 简化基础嵌套类型
type <span class="hljs-attr">IntList</span> = [Int]
type <span class="hljs-attr">StringMap</span> = [(String, String)]  -- 字符串键值对列表
type <span class="hljs-attr">Person</span> = (String, Int, Bool)    -- 姓名、年龄、是否成年

-- 直接使用类型别名，与原类型完全等价
intList :: IntList
<span class="hljs-attr">intList</span> = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]
-- 原类型可直接赋值给别名类型，无隔离
intList<span class="hljs-attr">' :: [Int]
intList'</span> = intList

person :: Person
<span class="hljs-attr">person</span> = (<span class="hljs-string">"Tom"</span>, <span class="hljs-number">25</span>, <span class="hljs-literal">True</span>)
-- 解包时按原元组方式，无差异
getName :: Person -&gt; String
getName (n, _, _) = n

-- 2. 简化高阶/业务相关类型
type <span class="hljs-attr">Request</span> = String
type <span class="hljs-attr">Response</span> = String
-- 业务处理函数：原类型 (String -&gt; IO String)，别名更易读
type <span class="hljs-attr">Handler</span> = Request -&gt; IO Response

-- 实现处理函数，使用别名提升可读性
helloHandler :: Handler
helloHandler <span class="hljs-attr">req</span> = return $ <span class="hljs-string">"Hello, "</span> ++ req

-- 3. 标准库经典别名：<span class="hljs-attr">String</span> = [Char]
type <span class="hljs-attr">String</span> = [Char]  -- Haskell标准库中的定义
str :: String
<span class="hljs-attr">str</span> = <span class="hljs-string">"Haskell"</span>
-- 与原类型<span class="hljs-section">[Char]</span>完全等价
str<span class="hljs-attr">' :: [Char]
str'</span> = str
</code></pre>
<h3 data-id="heading-16">newtype 零成本包装</h3>
<p><code>newtype</code>关键字用于<strong>创建新类型</strong>，核心作用是将<strong>现有的单个基础类型</strong>进行“包装”，生成一个<strong>全新的、与原类型完全独立的类型标识</strong>，且编译器会对<code>newtype</code>做极致优化——<strong>编译期消除包装层，无任何运行时成本（零成本）</strong> ，既实现了类型的隔离和安全，又不影响程序执行效率。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 基础定义：newtype 新类型 = 构造器 原类型（单构造器+单字段）</span>
newtype Age <span class="hljs-operator">=</span> Age <span class="hljs-type">Int</span>          <span class="hljs-comment">-- 年龄：包装Int</span>
newtype Score <span class="hljs-operator">=</span> Score <span class="hljs-type">Int</span>      <span class="hljs-comment">-- 分数：包装Int</span>
newtype UserID <span class="hljs-operator">=</span> UserID String <span class="hljs-comment">-- 用户ID：包装String</span>
newtype Weight <span class="hljs-operator">=</span> Weight <span class="hljs-keyword">Double</span> <span class="hljs-comment">-- 体重：包装Double</span>

<span class="hljs-comment">-- 2. 创建新类型值：通过构造器包装</span>
age :: Age
age <span class="hljs-operator">=</span> Age <span class="hljs-number">25</span>  <span class="hljs-comment">-- 必须通过Age构造器，直接写25会报类型错误</span>

score :: Score
score <span class="hljs-operator">=</span> Score <span class="hljs-number">95</span>

uid :: UserID
uid <span class="hljs-operator">=</span> UserID "user_123456"

<span class="hljs-comment">-- 3. 解包使用：模式匹配或构造器直接调用</span>
getAge :: Age <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">Int</span>
getAge (Age a) <span class="hljs-operator">=</span> a  <span class="hljs-comment">-- 模式匹配解包</span>

getScore :: Score <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">Int</span>
getScore (Score s) <span class="hljs-operator">=</span> s

<span class="hljs-comment">-- 4. 类型安全：不同newtype无法混用，编译期拦截错误</span>
<span class="hljs-comment">-- 合法：同类型操作</span>
ageAdd :: Age <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">Int</span> <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> Age
ageAdd (Age a) n <span class="hljs-operator">=</span> Age (a <span class="hljs-operator">+</span> n)
<span class="hljs-comment">-- 非法：不同newtype混用（编译报错）</span>
<span class="hljs-comment">-- wrong = Age 25 + Score 95  -- 编译器直接报错，避免类型混淆</span>

<span class="hljs-comment">-- 5. 零成本特性：运行时无包装层，与原类型执行效率一致</span>
<span class="hljs-comment">-- 编译后，Age 25 直接等价于 25，无额外开销</span>
</code></pre>
<h3 data-id="heading-17">newtype vs data</h3>
<p><code>newtype</code>和<code>data</code>都是Haskell中定义<strong>自定义类型</strong>的核心关键字，二者均可实现类型包装和自定义类型设计，但在<strong>语法限制、运行时成本、类型类实例、使用场景</strong>上存在核心差异，不可混用，通过代码示例对比核心区别：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ==================== newtype 实现 ====================</span>
<span class="hljs-comment">-- 仅支持：单构造器 + 单字段</span>
newtype Age <span class="hljs-operator">=</span> Age <span class="hljs-type">Int</span>  <span class="hljs-comment">-- 合法</span>
<span class="hljs-comment">-- newtype Point = Point Int Int  -- 非法：多字段，newtype不支持</span>

<span class="hljs-comment">-- 零成本：编译期无包装层</span>
age :: Age
age <span class="hljs-operator">=</span> Age <span class="hljs-number">25</span>
<span class="hljs-comment">-- 解包简单</span>
unAge :: Age <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">Int</span>
unAge (Age a) <span class="hljs-operator">=</span> a

<span class="hljs-comment">-- ==================== data 实现 ====================</span>
<span class="hljs-comment">-- 无限制：多构造器、多字段、递归类型均支持</span>
<span class="hljs-comment">-- 单构造器单字段（合法，但有运行时开销）</span>
data Score <span class="hljs-operator">=</span> Score <span class="hljs-type">Int</span> deriving (<span class="hljs-keyword">Show</span>)
<span class="hljs-comment">-- 多构造器（合法，描述不同状态）</span>
data Shape <span class="hljs-operator">=</span> Circle <span class="hljs-keyword">Double</span> <span class="hljs-operator">|</span> Rectangle <span class="hljs-keyword">Double</span> <span class="hljs-keyword">Double</span> deriving (<span class="hljs-keyword">Show</span>)
<span class="hljs-comment">-- 多字段（合法，描述复杂结构）</span>
data Point <span class="hljs-operator">=</span> Point <span class="hljs-keyword">Double</span> <span class="hljs-keyword">Double</span> deriving (<span class="hljs-keyword">Show</span>)
<span class="hljs-comment">-- 递归类型（合法，描述树形结构）</span>
data Tree a <span class="hljs-operator">=</span> <span class="hljs-keyword">Empty</span> <span class="hljs-operator">|</span> Node a (Tree a) (Tree a) deriving (<span class="hljs-keyword">Show</span>)

<span class="hljs-comment">-- 创建data类型值</span>
score :: Score
score <span class="hljs-operator">=</span> Score <span class="hljs-number">95</span>

circle :: Shape
circle <span class="hljs-operator">=</span> Circle <span class="hljs-number">5.0</span>  <span class="hljs-comment">-- 圆：半径5.0</span>

rect :: Shape
rect <span class="hljs-operator">=</span> Rectangle <span class="hljs-number">3.0</span> <span class="hljs-number">4.0</span>  <span class="hljs-comment">-- 矩形：长3.0，宽4.0</span>

point :: Point
point <span class="hljs-operator">=</span> Point <span class="hljs-number">10.0</span> <span class="hljs-number">20.0</span>

tree :: Tree <span class="hljs-type">Int</span>
tree <span class="hljs-operator">=</span> Node <span class="hljs-number">1</span> (Node <span class="hljs-number">2</span> <span class="hljs-keyword">Empty</span> <span class="hljs-keyword">Empty</span>) (Node <span class="hljs-number">3</span> <span class="hljs-keyword">Empty</span> <span class="hljs-keyword">Empty</span>)

<span class="hljs-comment">-- 解包data类型：模式匹配</span>
getCircleRadius :: Shape <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Double</span>
getCircleRadius (Circle r) <span class="hljs-operator">=</span> r
getCircleRadius _ <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>

getPointX :: Point <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Double</span>
getPointX (Point x _) <span class="hljs-operator">=</span> x

<span class="hljs-comment">-- ==================== 核心差异对比 ====================</span>
<span class="hljs-comment">-- 1. 类型类实例：newtype可自动继承，data需手动实现</span>
<span class="hljs-comment">-- newtype：为Age实现Num实例，可直接操作</span>
instance Num Age <span class="hljs-keyword">where</span>
  (<span class="hljs-operator">+</span>) (Age a1) (Age a2) <span class="hljs-operator">=</span> Age (a1 <span class="hljs-operator">+</span> a2)
  (<span class="hljs-operator">*</span>) (Age a1) (Age a2) <span class="hljs-operator">=</span> Age (a1 <span class="hljs-operator">*</span> a2)
  fromInteger n <span class="hljs-operator">=</span> Age (fromInteger n)
  <span class="hljs-comment">-- 其他方法可默认推导</span>

<span class="hljs-comment">-- data：为Score实现Num实例，需手动实现所有方法</span>
instance Num Score <span class="hljs-keyword">where</span>
  (<span class="hljs-operator">+</span>) (Score s1) (Score s2) <span class="hljs-operator">=</span> Score (s1 <span class="hljs-operator">+</span> s2)
  (<span class="hljs-operator">*</span>) (Score s1) (Score s2) <span class="hljs-operator">=</span> Score (s1 <span class="hljs-operator">*</span> s2)
  (<span class="hljs-operator">-</span>) (Score s1) (Score s2) <span class="hljs-operator">=</span> Score (s1 <span class="hljs-operator">-</span> s2)
  <span class="hljs-built_in">abs</span> (Score s) <span class="hljs-operator">=</span> Score (abs s)
  signum (Score s) <span class="hljs-operator">=</span> Score (signum s)
  fromInteger n <span class="hljs-operator">=</span> Score (fromInteger n)

<span class="hljs-comment">-- 2. 运行时成本：newtype无开销，data有轻微开销</span>
<span class="hljs-comment">-- 编译后：Age 25 → 25（无包装），Score 95 → 包装为Score构造器（有开销）</span>
</code></pre>
<h2 data-id="heading-18">10.5 类型系统基础特性</h2>
<p>在类型推断和实际使用中，Haskell提供了两个实用的基础特性，分别解决<strong>数值类型的默认推导歧义</strong>和<strong>编译器的类型推断歧义</strong>问题，平衡“类型推断的简洁性”和“类型指定的灵活性”，是日常开发中高频使用的特性，所有知识点均附可运行代码示例：</p>
<h3 data-id="heading-19">类型默认规则</h3>
<p>Haskell中数值类型基于Num类型类实现泛型（如<code>Int</code>、<code>Integer</code>、<code>Double</code>、<code>Float</code>均实现Num），当表达式的类型为<strong>泛型数值类型（Num a =&gt; a）</strong> 且<strong>无上下文明确指定具体类型</strong>时，会出现<strong>数值类型歧义</strong>，编译器无法确定应推导为哪种具体数值类型，此时Haskell的<strong>类型默认规则</strong>会自动将其推导为<strong>预设的具体数值类型</strong>（默认优先<code>Integer &gt; Double &gt; Int &gt; Float</code>），避免编译错误，同时支持自定义默认类型。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 默认规则：无上下文时，Num a =&gt; a 优先推导为Integer/Double</span>
<span class="hljs-comment">-- 示例1：整数泛型 → 默认推导为Integer</span>
num1 <span class="hljs-operator">=</span> <span class="hljs-number">100</span>  <span class="hljs-comment">-- 类型：Integer</span>
<span class="hljs-comment">-- 示例2：浮点数泛型 → 默认推导为Double</span>
num2 <span class="hljs-operator">=</span> <span class="hljs-number">3.14</span> <span class="hljs-comment">-- 类型：Double</span>
<span class="hljs-comment">-- 示例3：列表求和 → 默认推导为Integer</span>
sumInt <span class="hljs-operator">=</span> sum [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]  <span class="hljs-comment">-- 类型：Integer，结果10</span>
<span class="hljs-comment">-- 示例4：混合数值 → 默认推导为Double（精度更高）</span>
mixNum <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-operator">+</span> <span class="hljs-number">2.0</span>  <span class="hljs-comment">-- 类型：Double，结果3.0</span>

<span class="hljs-comment">-- 2. 上下文约束：覆盖默认规则，按上下文推导具体类型</span>
<span class="hljs-comment">-- 赋值给Int变量 → 推导为Int</span>
intNum :: <span class="hljs-type">Int</span>
intNum <span class="hljs-operator">=</span> <span class="hljs-number">100</span>  <span class="hljs-comment">-- 类型：Int，而非默认Integer</span>

<span class="hljs-comment">-- 作为Int参数传入函数 → 推导为Int</span>
addInt :: <span class="hljs-type">Int</span> <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">Int</span> <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">Int</span>
addInt x y <span class="hljs-operator">=</span> x <span class="hljs-operator">+</span> y
addRes <span class="hljs-operator">=</span> addInt <span class="hljs-number">10</span> <span class="hljs-number">20</span>  <span class="hljs-comment">-- 10和20均推导为Int</span>

<span class="hljs-comment">-- 3. 自定义默认类型：通过default语句修改默认优先级</span>
<span class="hljs-comment">-- 自定义：优先推导为Int → Float → Double</span>
<span class="hljs-keyword">default</span> (<span class="hljs-type">Int</span>, <span class="hljs-type">Float</span>, <span class="hljs-keyword">Double</span>)

<span class="hljs-comment">-- 自定义后，列表求和推导为Int（而非默认Integer）</span>
sumInt<span class="hljs-string">' = sum [1,2,3]  -- 类型：Int，结果6

-- 浮点数推导为Float（而非默认Double）
floatNum = 3.14 :: Float  -- 类型：Float
</span></code></pre>
<h3 data-id="heading-20">显式类型应用TypeApplications 扩展</h3>
<p><code>TypeApplications</code>（类型应用）是Haskell的<strong>扩展特性</strong>（非默认开启），核心作用是允许程序员<strong>在调用函数时，显式指定类型推断中的类型变量</strong>，直接为函数的泛型类型变量绑定具体类型，彻底解决编译器的<strong>类型推断歧义</strong>问题，替代繁琐的显式类型标注，让代码更简洁、更易读。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 必须在代码最顶部开启扩展</span>
{<span class="hljs-operator">-</span># <span class="hljs-keyword">LANGUAGE</span> TypeApplications #<span class="hljs-operator">-</span>}

import Data.Maybe
import Data.Eq

<span class="hljs-comment">-- 1. 解决read函数的类型歧义：read :: Read a =&gt; String -&gt; a</span>
<span class="hljs-comment">-- 无TypeApplications：需显式标注返回类型，繁琐</span>
readInt1 :: <span class="hljs-type">Int</span>
readInt1 <span class="hljs-operator">=</span> read "123" :: <span class="hljs-type">Int</span>

readDouble1 :: <span class="hljs-keyword">Double</span>
readDouble1 <span class="hljs-operator">=</span> read "3.14" :: <span class="hljs-keyword">Double</span>

<span class="hljs-comment">-- 有TypeApplications：直接在函数后@指定类型，简洁</span>
readInt2 <span class="hljs-operator">=</span> read <span class="hljs-variable">@Int</span> "123"          <span class="hljs-comment">-- 类型：Int，结果123</span>
readDouble2 <span class="hljs-operator">=</span> read <span class="hljs-variable">@Double</span> "3.14"  <span class="hljs-comment">-- 类型：Double，结果3.14</span>
readList <span class="hljs-operator">=</span> read @[<span class="hljs-type">Int</span>] "[1,2,3,4]" <span class="hljs-comment">-- 类型：[Int]，结果[1,2,3,4]</span>

<span class="hljs-comment">-- 2. 解决pure函数的容器类型歧义：pure :: Applicative f =&gt; a -&gt; f a</span>
<span class="hljs-comment">-- 无TypeApplications：需标注容器类型，繁琐</span>
pureList1 :: [<span class="hljs-type">Int</span>]
pureList1 <span class="hljs-operator">=</span> pure <span class="hljs-number">5</span> :: [<span class="hljs-type">Int</span>]

pureMaybe1 :: Maybe <span class="hljs-type">Int</span>
pureMaybe1 <span class="hljs-operator">=</span> pure <span class="hljs-number">5</span> :: Maybe <span class="hljs-type">Int</span>

<span class="hljs-comment">-- 有TypeApplications：@指定容器类型f，直接明了</span>
pureList2 <span class="hljs-operator">=</span> pure @[] <span class="hljs-number">5</span>        <span class="hljs-comment">-- 容器：[]（列表），结果[5]</span>
pureMaybe2 <span class="hljs-operator">=</span> pure <span class="hljs-variable">@Maybe</span> <span class="hljs-number">5</span>   <span class="hljs-comment">-- 容器：Maybe，结果Just 5</span>
pureIO <span class="hljs-operator">=</span> pure <span class="hljs-variable">@IO</span> <span class="hljs-number">5</span>          <span class="hljs-comment">-- 容器：IO，结果IO 5</span>

<span class="hljs-comment">-- 3. 多类型变量：按类型签名顺序@指定多个类型变量</span>
<span class="hljs-comment">-- 示例：lookup :: Eq k =&gt; k -&gt; [(k, v)] -&gt; Maybe v</span>
<span class="hljs-comment">-- 显式指定k=String，v=Int</span>
lookupRes <span class="hljs-operator">=</span> lookup <span class="hljs-variable">@String</span> <span class="hljs-variable">@Int</span> "name" [("name", <span class="hljs-number">123</span>), ("age", <span class="hljs-number">25</span>)]
<span class="hljs-comment">-- 结果：Just 123</span>

<span class="hljs-comment">-- 4. 结合类型类约束：精准指定约束中的类型变量</span>
<span class="hljs-comment">-- 示例：show . read :: (Read a, Show a) =&gt; String -&gt; String</span>
<span class="hljs-comment">-- 指定a=Double，将字符串转Double再转字符串</span>
showRead <span class="hljs-operator">=</span> <span class="hljs-keyword">show</span> . read <span class="hljs-variable">@Double</span> $ "3.1415926"
<span class="hljs-comment">-- 结果："3.1415926"</span>

<span class="hljs-comment">-- 5. GHCi中使用：先开启扩展，再调用</span>
<span class="hljs-comment">-- :set -XTypeApplications</span>
<span class="hljs-comment">-- &gt; read @Int "456"</span>
<span class="hljs-comment">-- 456</span>
<span class="hljs-comment">-- &gt; pure @Maybe 10</span>
<span class="hljs-comment">-- Just 10</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《为啥printf重定向后文件是空的？聊聊C语言的缓冲区和FILE》]]></title>    <link>https://juejin.cn/post/7602073088428916751</link>    <guid>https://juejin.cn/post/7602073088428916751</guid>    <pubDate>2026-02-02T16:41:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602073088428916751" data-draft-id="7602073973309702159" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《为啥printf重定向后文件是空的？聊聊C语言的缓冲区和FILE》"/> <meta itemprop="keywords" content="Linux,C语言,操作系统"/> <meta itemprop="datePublished" content="2026-02-02T16:41:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="444A4E"/> <meta itemprop="url" content="https://juejin.cn/user/930646521033307"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《为啥printf重定向后文件是空的？聊聊C语言的缓冲区和FILE》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/930646521033307/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    444A4E
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T16:41:30.000Z" title="Mon Feb 02 2026 16:41:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 缓冲区</h2>
<h3 data-id="heading-1">1.1 什么是缓冲区</h3>
<blockquote>
<p>缓冲区其实就是一段内存空间，打个比方：</p>
<p>假如你要给好朋友送一个礼物，但你们在两个不同的城市，由你亲自送要走一个星期，耗费了大量时间。</p>
<p>于是你将礼物交给了楼下的快递驿站，这样你就不需要亲自去送，转而让快递员将礼物送到朋友手里。</p>
<p>快递驿站就扮演了缓存的角色，而礼物就是数据，快递发出就是刷新缓冲区的数据。</p>
<p>但是快递驿站不会为了发你这一件快递就浪费人力资源，所以他会攒到一定数量再发走。</p>
</blockquote>
<p>所以：数据允许在缓冲区中积压，这样一次就可以刷新多次数据，变相的减少了IO的次数。</p>
<p><strong>缓存最大的意义是提高使用缓存的进程的效率，允许进程在单位时间内做更多的工作，也就变相的提高了使用者（用户）的效率。</strong></p>
<h3 data-id="heading-2">1.2 缓冲类型</h3>
<blockquote>
<p>在语言层面来看，决定什么时候发快递（决定使用什么样的刷新策略）：</p>
<ol>
<li>无缓冲，立即刷新。（直接调⽤系统调⽤，标准出错流stderr通常是不带缓冲区的，这使得出错信息能够尽快地显⽰出来）</li>
<li>有缓冲，行刷新。（一般在显示器中使用）</li>
<li>有缓冲，缓冲区满则刷新。（普通文件一般采用这种方式）</li>
</ol>
<p>还有两种特殊情况：</p>
<ol>
<li>执行fflush语句。</li>
<li>进程结束。</li>
</ol>
</blockquote>
<p>下面来看一段代码：</p>
<pre><code class="hljs language-C" lang="C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span>      </span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span>     </span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span>  </span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span>   </span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span>      </span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span>   </span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 关闭标准输出（文件描述符1）</span>
    close(<span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 打开或创建文件"log.txt"</span>
    <span class="hljs-comment">// O_WRONLY: 只写方式</span>
    <span class="hljs-comment">// O_CREAT: 如果文件不存在则创建</span>
    <span class="hljs-comment">// O_TRUNC: 如果文件存在则清空内容</span>
    <span class="hljs-comment">// 0666: 文件权限（所有用户可读写）</span>
    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">"log.txt"</span>, O_WRONLY | O_CREAT | O_TRUNC, <span class="hljs-number">0666</span>);
    
    <span class="hljs-comment">// 检查文件是否成功打开</span>
    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"open"</span>);  <span class="hljs-comment">// 打印错误信息</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;        <span class="hljs-comment">// 程序结束</span>
    }
    
    <span class="hljs-comment">// 打印信息到标准输出（现在指向log.txt文件）</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"hello world: %d\n"</span>, fd);
    
    <span class="hljs-comment">// 关闭文件</span>
    close(fd);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 程序正常结束</span>
}
</code></pre>
<p>这段代码本意是想使用重定向，让本该打印在显示器上的内容写到“log.txt”文件中，但实际运行后会发现，文件中并无内容。</p>
<p>这是因为代码中将1号文件描述符重定向到磁盘文件后，刷新的方式变为了全缓冲。而写入的内容并没有填满缓冲区，所以就不会将缓冲区的内容刷新到磁盘文件中，那么可以怎么做呢？可以使用fflush强制刷新缓冲区。</p>
<pre><code class="hljs language-C" lang="C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span>      </span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span>     </span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span>  </span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span>   </span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span>      </span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span>   </span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 关闭标准输出（文件描述符1）</span>
    close(<span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 打开或创建文件"log.txt"</span>
    <span class="hljs-comment">// O_WRONLY: 只写方式</span>
    <span class="hljs-comment">// O_CREAT: 如果文件不存在则创建</span>
    <span class="hljs-comment">// O_TRUNC: 如果文件存在则清空内容</span>
    <span class="hljs-comment">// 0666: 文件权限（所有用户可读写）</span>
    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">"log.txt"</span>, O_WRONLY | O_CREAT | O_TRUNC, <span class="hljs-number">0666</span>);
    
    <span class="hljs-comment">// 检查文件是否成功打开</span>
    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"open"</span>);  <span class="hljs-comment">// 打印错误信息</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;        <span class="hljs-comment">// 程序结束</span>
    }
    
    <span class="hljs-comment">// 打印信息到标准输出（现在指向log.txt文件）</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"hello world: %d\n"</span>, fd);
    <span class="hljs-comment">// 强制刷新</span>
    fflush(<span class="hljs-built_in">stdout</span>);
    <span class="hljs-comment">// 关闭文件</span>
    close(fd);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 程序正常结束</span>
}
</code></pre>
<h2 data-id="heading-3">2. FILE</h2>
<p>上面谈完了缓冲区，那么缓冲区到底在哪里呢？先说结论，在<code>FILE</code>中。也就是调用<code>fopen</code>函数的返回值的类型。</p>
<p>在操作系统操作文件的时候只认识文件描述符，而<code>fopen</code>之类的函数封装了系统调用函数<code>open</code>，所以<code>fopen</code>的返回值（FILE结构体）中必定包含了文件描述符。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/* 
 * FILE结构体是C标准库中表示文件流的数据结构
 * 它封装了文件描述符和缓冲区，提供更高效的I/O操作
 * 
 * 当我们使用 fopen() 打开文件时，返回的 FILE* 指针就指向一个FILE结构体
 */</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">_IO_FILE</span> FILE;  <span class="hljs-comment">// 通常的typedef定义</span>
</code></pre>
<p><code>FILE</code>是一个结构体，而在这个结构体内部会维护一块语言级的缓冲区空间。所以当我们调用<code>printf</code>之类的函数时，是将输出格式化成字符串写入到<code>FILE</code>结构体的缓冲区，再按照刷新规则刷新到输出设备上。下面是FILE结构体内部的一部分：</p>
<pre><code class="hljs language-C" lang="C"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> {</span>
    <span class="hljs-type">int</span> _fileno;               <span class="hljs-comment">// 文件描述符（底层open返回的fd）</span>
    <span class="hljs-type">char</span>* _IO_read_ptr;        <span class="hljs-comment">// 读缓冲区当前位置</span>
    <span class="hljs-type">char</span>* _IO_read_end;        <span class="hljs-comment">// 读缓冲区结束位置</span>
    <span class="hljs-type">char</span>* _IO_read_base;       <span class="hljs-comment">// 读缓冲区起始位置</span>
    <span class="hljs-type">char</span>* _IO_write_ptr;       <span class="hljs-comment">// 写缓冲区当前位置</span>
    <span class="hljs-type">char</span>* _IO_write_end;       <span class="hljs-comment">// 写缓冲区结束位置</span>
    <span class="hljs-type">char</span>* _IO_write_base;      <span class="hljs-comment">// 写缓冲区起始位置</span>
    <span class="hljs-type">char</span>* _IO_buf_base;        <span class="hljs-comment">// 缓冲区起始位置</span>
    <span class="hljs-type">char</span>* _IO_buf_end;         <span class="hljs-comment">// 缓冲区结束位置</span>
    <span class="hljs-type">int</span> _flags;                <span class="hljs-comment">// 文件状态标志</span>
    <span class="hljs-comment">// ... 还有其他字段</span>
};
</code></pre>
<blockquote>
<ol>
<li>所以在学习例如C语言的时候，所说的缓冲区实际上是语言级缓冲区，和内核没有关系！</li>
<li>缓冲区在哪？FILE内部！</li>
<li>为什么要有语言级别缓冲区？因为调用系统调用是有成本的（浪费时间），所以可以减少系统调用次数。</li>
</ol>
</blockquote>
<h2 data-id="heading-4">3. 模拟文件操作</h2>
<p>下面通过对系统调用封装，模拟实现一下C标准库的文件操作接口。</p>
<h3 data-id="heading-5">3.1 my_stdio.h</h3>
<pre><code class="hljs language-C" lang="C"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __MYSTDIO_H__</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __MYSTDIO_H__</span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> FLUSH_NONE 1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FLUSH_LINE 2</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FLUSH_FULL 4</span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> SIZE 4096</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> UMASK 0666</span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> FORCE 1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> NORMAL 2</span>

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">MY_IO_FILE</span>
{</span>
    <span class="hljs-type">int</span> fileno; <span class="hljs-comment">//文件描述符</span>
    <span class="hljs-type">int</span> flag; <span class="hljs-comment">//刷新方式</span>
    <span class="hljs-type">char</span> outbuffer[SIZE];   <span class="hljs-comment">//缓冲区</span>
    <span class="hljs-type">int</span> curr;   <span class="hljs-comment">//当前缓冲区字符数量</span>
    <span class="hljs-type">int</span> cap;    <span class="hljs-comment">//当前缓冲区总容量</span>
}MYFILE;

MYFILE* <span class="hljs-title function_">my_fopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* mode)</span>;

<span class="hljs-type">void</span> <span class="hljs-title function_">my_fclose</span><span class="hljs-params">(MYFILE* fp)</span>;

<span class="hljs-type">int</span> <span class="hljs-title function_">my_fwrite</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* s, <span class="hljs-type">int</span> size, MYFILE* fp)</span>;

<span class="hljs-type">void</span> <span class="hljs-title function_">my_fflush</span><span class="hljs-params">(MYFILE* fp)</span>;

<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<h3 data-id="heading-6">3.2 my_stdio.c</h3>
<pre><code class="hljs language-C" lang="C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"my_stdio.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-comment">// 打开文件</span>
MYFILE *<span class="hljs-title function_">my_fopen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *mode)</span>
{
    <span class="hljs-type">int</span> fd = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(mode, <span class="hljs-string">"w"</span>) == <span class="hljs-number">0</span>)
    {
        fd = open(filename, O_CREAT | O_WRONLY | O_TRUNC, UMASK);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(mode, <span class="hljs-string">"r"</span>) == <span class="hljs-number">0</span>)
    {
        fd = open(filename, O_RDONLY);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(mode, <span class="hljs-string">"a"</span>) == <span class="hljs-number">0</span>)
    {
        fd = open(filename, O_CREAT | O_WRONLY | O_APPEND, UMASK);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(mode, <span class="hljs-string">"a+"</span>) == <span class="hljs-number">0</span>)
    {
        fd = open(filename, O_CREAT | O_RDONLY | O_APPEND, UMASK);
    }

    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    MYFILE *fp = (MYFILE *)<span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(MYFILE));
    <span class="hljs-keyword">if</span> (fp == <span class="hljs-literal">NULL</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;

    fp-&gt;fileno = fd;
    fp-&gt;flag = FLUSH_LINE;
    fp-&gt;curr = <span class="hljs-number">0</span>;
    fp-&gt;cap = SIZE;
    fp-&gt;outbuffer[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">return</span> fp;
}

<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">my_fflush_core</span><span class="hljs-params">(MYFILE *fp, <span class="hljs-type">int</span> force)</span>
{
    <span class="hljs-keyword">if</span> (fp-&gt;curr &lt;= <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (force == FORCE)
    {
        write(fp-&gt;fileno, fp-&gt;outbuffer, fp-&gt;curr);
        fp-&gt;curr = <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-comment">// 判断刷新条件</span>
        <span class="hljs-keyword">if</span> ((fp-&gt;flag &amp; FLUSH_LINE) &amp;&amp; (fp-&gt;outbuffer[fp-&gt;curr - <span class="hljs-number">1</span>] == <span class="hljs-string">'\n'</span>))
        {
            <span class="hljs-comment">// 行刷新</span>
            write(fp-&gt;fileno, fp-&gt;outbuffer, fp-&gt;curr);
            fp-&gt;curr = <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fp-&gt;flag &amp; FLUSH_FULL) &amp;&amp; (fp-&gt;curr == fp-&gt;cap))
        {
            <span class="hljs-comment">// 满刷新</span>
            write(fp-&gt;fileno, fp-&gt;outbuffer, fp-&gt;curr);
            fp-&gt;curr = <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">else</span>
        {
            write(fp-&gt;fileno, fp-&gt;outbuffer, fp-&gt;curr);
            fp-&gt;curr = <span class="hljs-number">0</span>;
        }
    }
}

<span class="hljs-type">int</span> <span class="hljs-title function_">my_fwrite</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s, <span class="hljs-type">int</span> size, MYFILE *fp)</span>
{
    <span class="hljs-built_in">memcpy</span>(fp-&gt;outbuffer + fp-&gt;curr, s, size);
    fp-&gt;curr += size;
    my_fflush_core(fp, NORMAL);
    <span class="hljs-keyword">return</span> size;
}

<span class="hljs-type">void</span> <span class="hljs-title function_">my_fflush</span><span class="hljs-params">(MYFILE *fp)</span>
{
    my_fflush_core(fp, FORCE);
}

<span class="hljs-type">void</span> <span class="hljs-title function_">my_fclose</span><span class="hljs-params">(MYFILE *fp)</span>
{
    <span class="hljs-keyword">if</span> (fp-&gt;fileno &gt;= <span class="hljs-number">0</span>)
    {
        my_fflush(fp);
        fsync(fp-&gt;fileno);
        close(fp-&gt;fileno);
        <span class="hljs-built_in">free</span>(fp);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Exception异常架构设计：基础（01）]]></title>    <link>https://juejin.cn/post/7602098592677969974</link>    <guid>https://juejin.cn/post/7602098592677969974</guid>    <pubDate>2026-02-03T01:03:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602098592677969974" data-draft-id="7602162571380736006" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Exception异常架构设计：基础（01）"/> <meta itemprop="keywords" content="运维,架构,云原生"/> <meta itemprop="datePublished" content="2026-02-03T01:03:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="老实巴交的麻匪"/> <meta itemprop="url" content="https://juejin.cn/user/4218156332615384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Exception异常架构设计：基础（01）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4218156332615384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    老实巴交的麻匪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T01:03:37.000Z" title="Tue Feb 03 2026 01:03:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>监控告警、故障诊断是运维工程师的核心工作之一，而异常是其基石，打好了异常处理这块地基，在上层治理时，便会事半功倍。异常的架构设计，是业务无关的，大多数开发工程师都不会特别关注，什么时候抛异常，什么时候处理异常都看心情和习惯。互联网上关于异常的系统性研究文章几乎没有，我将花费一段时间，由浅入深探究异常架构设计。</p>
<p>异常分为两部分来研究：异常架构设计、异常治理。前者侧重<strong>法</strong>，后者侧重<strong>术</strong>（道法术器）。</p>
<hr/>
<p>异常架构设计原则（个人总结的四项设计准则）：</p>
<ul>
<li>防御性编程</li>
<li>fail-fast，快速失败</li>
<li>用户友好</li>
<li>可观测性（监控告警、异常日志查询、故障诊断）</li>
</ul>
<p>本文面向开发工程师和SRE工程师：</p>
<ul>
<li>开发工程师：在日常编码中形成良好的异常处理习惯，提高代码可读性和健壮性</li>
<li>SRE 工程师：可观测性和故障治理基石，制定运维策略与规范，使用技术管控代码质量。</li>
</ul>
<h2 data-id="heading-0">异常基础</h2>
<p>异常是程序执行过程中发生的非正常情况，这些情况通常需要特殊处理。异常机制是现代编程语言中处理错误和异常情况的重要方式，不同语言在异常处理上有不同的哲学和实现。</p>
<p>以<code>Java</code>为代表的受检异常机制通过编译器强制检查异常声明和处理，确保错误的显式管理，增强了代码可靠性但可能引入冗余，受检查异常机制体现了防御性编程的异常设计原则；以<code>Python</code>和<code>JavaScript</code>为代表的灵活运行时异常机制采用“请求原谅比许可更容易”的哲学，提供简洁的<code>try</code>结构块和异步错误处理，适合快速开发但缺乏编译时保障；<code>C++</code>和<code>Rust</code>代表的资源安全与性能导向机制分别通过 RAII 模式和 Result 类型系统，在保证资源安全的同时追求零开销异常处理，适合系统编程；<code>Go</code>语言采用显式错误值返回模式，通过多返回值传递错误，强制调用者即时处理，避免了异常的控制流跳跃；这些不同范式反映了各语言在安全性、灵活性、性能及表达力之间的不同权衡。</p>
<blockquote>
<p>示例代码选择<code>Python</code>（<code>Flask</code>），用户数量庞大，语法更简洁，可读性好</p>
</blockquote>
<p>文中以最常见的应用级编程语言 <code>Python</code>（<code>Flask</code>），辅助<code>Java</code>（<code>SpringBoot</code>）为例，来介绍异常机制。</p>
<h3 data-id="heading-1">异常核心</h3>
<p>开发者需要关注的异常核心三要素：<code>try</code>异常处理块、<code>raise</code>异常抛出和自定义异常。</p>
<h4 data-id="heading-2">异常处理块</h4>
<p>异常处理块的关键字和结构为<code>try-except-else-finally</code>，其中<code>except</code>可以多个嵌套，支持在一条<code>except</code>语句中捕获多个异常。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># 可能引发异常的代码</span>
    result = <span class="hljs-number">10</span> / <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">"输入数字: "</span>))
<span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:           <span class="hljs-comment"># 捕获特定异常</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"输入错误: <span class="hljs-subst">{e}</span>"</span>)
<span class="hljs-keyword">except</span> ZeroDivisionError <span class="hljs-keyword">as</span> e:    <span class="hljs-comment"># 多个except子句</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"除零错误: <span class="hljs-subst">{e}</span>"</span>)
<span class="hljs-keyword">except</span> (TypeError, EOFError):     <span class="hljs-comment"># 捕获多个异常</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"类型或输入错误"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:            <span class="hljs-comment"># 通用异常捕获</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"其他错误: <span class="hljs-subst">{e}</span>"</span>)
<span class="hljs-keyword">else</span>:                             <span class="hljs-comment"># 无异常时执行</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"结果: <span class="hljs-subst">{result}</span>"</span>)
<span class="hljs-keyword">finally</span>:                          <span class="hljs-comment"># 总是执行</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"清理完成"</span>)
</code></pre>
<h4 data-id="heading-3">异常抛出</h4>
<p>开发者可以使用<code>raise</code>主动抛出异常，一般有2个用处：主动抛出、异常转换。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 抛出异常实例</span>
<span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"参数无效"</span>)

<span class="hljs-comment"># 异常转换</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># 可能引发异常的代码</span>
    result = <span class="hljs-number">10</span> / <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">"输入数字: "</span>))
<span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:           <span class="hljs-comment"># 捕获特定异常</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"输入错误或: <span class="hljs-subst">{e}</span>"</span>)
<span class="hljs-keyword">except</span> ZeroDivisionError <span class="hljs-keyword">as</span> e:    <span class="hljs-comment"># 多个except子句</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"除零错误: <span class="hljs-subst">{e}</span>"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:            <span class="hljs-comment"># 通用异常捕获</span>
		<span class="hljs-keyword">raise</span> MyException <span class="hljs-comment"># 其他异常Exception转换为用户自定义异常MyException</span>
</code></pre>
<h4 data-id="heading-4">自定义异常</h4>
<p><code>Exception</code>是<code>Python</code>中所有的<strong>非系统退出类异常</strong>的父类，是所有自定义异常的基类，其本身几乎没有新增的专属字段/方法，其所有核心属性和方法都继承自父类<code>BaseException</code>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 直接继承Exception</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppException</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># 间接继承Exception</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAppException</span>(<span class="hljs-title class_ inherited__">AppException</span>):
    <span class="hljs-keyword">pass</span>
</code></pre>
<p>自定义异常需关注：</p>
<ul>
<li><code>Exception</code>异常参数元组<code>args</code></li>
<li>在<code>__init__</code>中调用<code>super().__init__(message)</code> → 正确设置<code>args</code></li>
<li>按需重写<code>__str__</code> → 提供友好显示</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Exception异常参数</span>
e = Exception(<span class="hljs-string">"错误消息"</span>, <span class="hljs-string">"附加信息"</span>, <span class="hljs-number">123</span>)
<span class="hljs-built_in">print</span>(e.args)  <span class="hljs-comment"># ('错误消息', '附加信息', 123)</span>

<span class="hljs-comment"># 必须调用 super().__init__ 父类构造函数</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyException</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, message, **kwargs</span>):
        <span class="hljs-built_in">super</span>().__init__(message)  <span class="hljs-comment"># 必须调用！</span>
        <span class="hljs-comment"># 然后添加额外字段</span>
        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> kwargs.items():
            <span class="hljs-built_in">setattr</span>(self, k, v)

<span class="hljs-comment"># 重写 __str__，字符串友好提示</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyException</span>(<span class="hljs-title class_ inherited__">Exception</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 默认返回args的字符串表示，通常需要重写</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"MyException: <span class="hljs-subst">{<span class="hljs-built_in">super</span>().__str__()}</span>"</span>
</code></pre>
<p>当一个异常触发了另一个异常时，通过这两个属性<code>__cause__</code>和<code>__context__</code>可以追溯<strong>原始异常</strong>，<code>Python</code>解释器会自动处理其赋值，也可通过语法手动指定，是实现<strong>异常链</strong>的核心。</p>
<p>例如，在异常处理时，发生了新的异常，就会形成一条异常链：<code>Exception A -&gt; Exception B -&gt; ...</code>，在异常调试的时候非常有用。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. __cause__ (显式链，使用 from)</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">int</span>(<span class="hljs-string">"abc"</span>)
<span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e1:
    <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"处理失败"</span>) <span class="hljs-keyword">from</span> e1  <span class="hljs-comment"># ← e1存入__cause__</span>

<span class="hljs-comment"># 2. __context__ (隐式链，自动设置)</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">int</span>(<span class="hljs-string">"abc"</span>)
<span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e1:
    <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"处理失败"</span>)  <span class="hljs-comment"># ← e1自动存入__context__</span>
</code></pre>
<p>当没有使用<code>raise ... from</code>语法时，若在一个异常的处理过程中（<code>except</code>/<code>finally</code>块）触发了另一个异常，Python 会<strong>自动</strong>将前一个异赋值给后一个异常的<code>__context__</code>属性，这是<strong>隐式关联</strong>，无需手动干预。<code>__cause__</code>字段则是<strong>手动指定</strong>的，是为异常的<strong>显示关联</strong>，其优先级高于<code>__context__</code>。</p>
<p>特别地，当使用<code>raise MyException from None</code>可以屏蔽所有异常关联（<code>__cause__</code>和<code>__context__</code>均为<code>None</code>），只打印当前异常。另一方面：<code>__context__</code>和<code>__cause__</code>的语义存在差别，前者是上下文信息，后者是直接原因，这在打印异常信息的时候会存在语义差别。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># __context__，在处理底层异常的过程中，又发生了一个新的异常</span>
During handling of the above exception, another exception occurred:

<span class="hljs-comment"># __cause__，新异常是由底层异常直接导致的</span>
The above exception was the direct cause of the following exception:
</code></pre>
<p>一句话理解：<code>__context__</code>和<code>__cause__</code>均为<code>Exception</code>对象，存储当前异常的关联异常，<code>__context__</code>是自动关联的，而<code>__cause__</code>是手段关联的，使用<code>raise MyException from e</code>语句。</p>
<hr/>
<p>聊到了这里，就先简单异常处理时异常链的用法，在异常转换时需要主动抛出新的异常。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># DataAceessException 是用户自定义异常，屏蔽底层的信息，向上呈现统一友好提示，同时使用__cause__来记录原始异常</span>
DataAcessException -&gt; requests.exceptions.ConnectTimeout
DataAccessException -&gt; pymysql.MySQLError
DataAccessException -&gt; FileNotFoundError
</code></pre>
<p>在业务层返回异常<code>DataAccessException</code>用来屏蔽底层技术性异常，但是在打印日志的时候也应该记录原始的异常信息，这样便于进行异常诊断。异常处理和日志打印的架构设计，将在后续详细介绍。</p>
<h3 data-id="heading-5">异常延伸</h3>
<h4 data-id="heading-6">异常层次结构</h4>
<p><code>Python</code>中所有的异常都是<code>BaseException</code>的子类。主要层级：</p>
<pre><code class="hljs language-php" lang="php">BaseException
 ├── SystemExit           <span class="hljs-comment"># 程序退出</span>
 ├── KeyboardInterrupt    <span class="hljs-comment"># 用户中断(Ctrl+C)</span>
 ├── GeneratorExit        <span class="hljs-comment"># 生成器关闭</span>
 └── <span class="hljs-built_in">Exception</span>            <span class="hljs-comment"># 常规异常基类</span>
      ├── <span class="hljs-built_in">ArithmeticError</span>
      ├── LookupError
      ├── OSError
      ├── ValueError
      └── ... (所有内置异常)
</code></pre>
<p><code>Exception</code>与<code>SystemExit</code>、<code>KeyboardInterrupt</code>是并列关系，因此使用<code>except Exception</code>不会捕获系统退出信号，可以使用<code>except BaseException</code>捕获所有异常。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">raise</span> SystemExit(<span class="hljs-string">"退出程序"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:  <span class="hljs-comment"># 不会捕获SystemExit</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"不会执行这里"</span>)
<span class="hljs-keyword">except</span> BaseException <span class="hljs-keyword">as</span> e:  <span class="hljs-comment"># 会捕获</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"捕获到BaseException: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h4 data-id="heading-7"><code>assert</code>断言</h4>
<p><code>assert</code>断言，可以看作是<strong>一种带有调试标志的语法糖</strong>，但<strong>不完全等价于简单的<code>if-raise</code></strong>，<code>assert</code>仅在调试时使用，可以使用<code>python -O main.py</code>的<code>-O</code>模式忽略掉，类似于忽略掉注释代码。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># assert语句</span>
<span class="hljs-keyword">assert</span> condition, <span class="hljs-string">"错误信息"</span>

<span class="hljs-comment"># 大致等效的if-raise实现</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> condition:
    <span class="hljs-keyword">raise</span> AssertionError(<span class="hljs-string">"错误信息"</span>)

<span class="hljs-comment"># assert的实际等效代码</span>
<span class="hljs-keyword">if</span> <span class="hljs-literal">__debug__</span>:
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> condition:
        <span class="hljs-keyword">raise</span> AssertionError(<span class="hljs-string">"错误信息"</span>)
</code></pre>
<p><code>with</code>块在资源管理上，非常有用，可以简化代码，提高可读性。在资源处理时即使发生异常，也可以保证资源被释放，有效避免资源泄露问题。在Java中也有类似的<code>try-with-resource</code>语句。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 资源泄露</span>
file = <span class="hljs-literal">None</span>
<span class="hljs-keyword">try</span>:
    file = <span class="hljs-built_in">open</span>(<span class="hljs-string">"file.txt"</span>, <span class="hljs-string">"r"</span>)
    content = file.read()
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-keyword">pass</span> <span class="hljs-comment"># 发生异常是不对file进行关闭，会造成文件资源泄露</span>

<span class="hljs-comment"># 传统方式</span>
file = <span class="hljs-literal">None</span>
<span class="hljs-keyword">try</span>:
    file = <span class="hljs-built_in">open</span>(<span class="hljs-string">"file.txt"</span>, <span class="hljs-string">"r"</span>)
    content = file.read()
<span class="hljs-keyword">finally</span>:
    <span class="hljs-keyword">if</span> file:
        file.close()

<span class="hljs-comment"># with语句方式（更简洁）</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"file.txt"</span>, <span class="hljs-string">"r"</span>) <span class="hljs-keyword">as</span> file:
    content = file.read()
</code></pre>
<p>在异常发生后，函数的执行可以延伸很多，后期将单独写一篇文章讲解，其中<code>except</code>、<code>finally</code>和<code>return</code>语句的执行顺序，是面试的一个高频考点。</p>
<h2 data-id="heading-8">异常进阶</h2>
<p>在[异常基础](# 异常基础)章节，主要介绍编程语言原生的异常机制，本章节介绍应用级开发框架下的异常机制。</p>
<h3 data-id="heading-9">Flask异常<code>HTTPException</code>（待补充）</h3>
<p>应用级开发框架是基于<strong>RESTful API</strong>设计的，因此有专门封装面向HTTP的异常类，如<code>Flask</code>中的<code>HTTPException</code>。</p>
<p><strong>常见HTTP异常</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">abort</span>(<span class="hljs-number">404</span>)           # NotFound
<span class="hljs-built_in">abort</span>(<span class="hljs-number">400</span>)           # BadRequest
<span class="hljs-built_in">abort</span>(<span class="hljs-number">401</span>)           # Unauthorized
<span class="hljs-built_in">abort</span>(<span class="hljs-number">403</span>)           # Forbidden
<span class="hljs-built_in">abort</span>(<span class="hljs-number">500</span>)           # InternalServerError
</code></pre>
<p><code>abort</code>可以看作<code>assert</code>是一个语法糖，根据代码抛出具体的异常。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># raise HTTPException</span>
user = User.query.get(user_id)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:
        <span class="hljs-keyword">raise</span> werkzeug.exceptions.NotFound(<span class="hljs-string">f"用户 <span class="hljs-subst">{user_id}</span> 不存在"</span>)
<span class="hljs-comment"># abort</span>
user = User.query.get(user_id)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:
    		abort(<span class="hljs-number">404</span>, <span class="hljs-string">f"用户 <span class="hljs-subst">{user_id}</span> 不存在"</span>)
</code></pre>
<h3 data-id="heading-10">异常处理器 <code>handler</code></h3>
<p>异常抛出后，可以被异常处理器所捕获并进行处理。自定义异常处理器在函数头上加 <code>@app.errorhandler(ExceptionType)</code>注解</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 基于状态码的处理器</span>
<span class="hljs-meta">@app.errorhandler(<span class="hljs-params"><span class="hljs-number">404</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_404</span>(<span class="hljs-params">error</span>):
    <span class="hljs-string">"""处理404错误"""</span>
    <span class="hljs-keyword">if</span> request.path.startswith(<span class="hljs-string">'/api/'</span>):
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">"error"</span>: <span class="hljs-string">"资源不存在"</span>}), <span class="hljs-number">404</span>
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'404.html'</span>), <span class="hljs-number">404</span>

<span class="hljs-comment"># 基于异常类的处理器</span>
<span class="hljs-meta">@app.errorhandler(<span class="hljs-params">ValidationError</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_validation_error</span>(<span class="hljs-params">error</span>):
    <span class="hljs-string">"""处理验证错误"""</span>
    <span class="hljs-keyword">return</span> jsonify({
        <span class="hljs-string">"error"</span>: <span class="hljs-string">"验证失败"</span>,
        <span class="hljs-string">"message"</span>: error.message,
        <span class="hljs-string">"details"</span>: error.details
    }), error.code
</code></pre>
<p>上述代码是全局异常处理，可以定义蓝图级的异常处理函数。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Blueprint

api_bp = Blueprint(<span class="hljs-string">'api'</span>, __name__, url_prefix=<span class="hljs-string">'/api'</span>)

<span class="hljs-comment"># 蓝图局部异常处理器</span>
<span class="hljs-meta">@api_bp.errorhandler(<span class="hljs-params"><span class="hljs-number">404</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">api_404</span>(<span class="hljs-params">error</span>):
    <span class="hljs-string">"""只在api蓝图内有效的404处理器"""</span>
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">"error"</span>: <span class="hljs-string">"API资源不存在"</span>}), <span class="hljs-number">404</span>
</code></pre>
<p>可以发现，异常处理器中的<code>ExceptionType</code>可以有多个，抛出的异常是如何匹配的？优先级？</p>
<h3 data-id="heading-11">异常处理优先级</h3>
<p>异常处理优先级：具体异常类 -&gt; 父异常类 -&gt; 父类的父类 &gt; .. &gt; <code>Exception</code> &gt; <code>BaseException</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> werkzeug.exceptions <span class="hljs-keyword">import</span> NotFound, HTTPException

<span class="hljs-comment"># 定义多个处理器</span>
<span class="hljs-meta">@app.errorhandler(<span class="hljs-params"><span class="hljs-number">404</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handler_404</span>(<span class="hljs-params">error</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"执行: 404状态码处理器"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"404状态码处理器"</span>, <span class="hljs-number">404</span>

<span class="hljs-meta">@app.errorhandler(<span class="hljs-params">NotFound</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handler_not_found_class</span>(<span class="hljs-params">error</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"执行: NotFound异常类处理器"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"NotFound异常类处理器"</span>, <span class="hljs-number">404</span>

<span class="hljs-meta">@app.errorhandler(<span class="hljs-params">HTTPException</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handler_http_exception</span>(<span class="hljs-params">error</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"执行: HTTPException基类处理器"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"HTTPException基类处理器"</span>, error.code

<span class="hljs-comment"># 测试路由</span>
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/test-priority'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_priority</span>():
    abort(<span class="hljs-number">404</span>)  <span class="hljs-comment"># 抛出NotFound异常</span>
  
<span class="hljs-comment"># 访问 /test-priority 的输出：</span>
<span class="hljs-comment"># 执行: NotFound异常类处理器</span>
<span class="hljs-comment"># 只有这个处理器被执行，其他不会执行</span>

<span class="hljs-comment"># 删除@app.errorhandler(NotFound)，执行404状态码处理器</span>
<span class="hljs-comment"># abort实际执行的是 raise NotFound</span>
</code></pre>
<p>一般地，可使用<code>@app.errorhandler(Exception)</code>来实现全局异常兜底处理机制，保证所有的异常都不会无限向上抛出。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.errorhandler(<span class="hljs-params">Exception</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handler_general_exception</span>(<span class="hljs-params">error</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"执行: 通用Exception处理器"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"通用Exception处理器"</span>, <span class="hljs-number">500</span>
</code></pre>
<p>如果异常没有被自定义异常捕获并处理，会走<strong>Flask默认异常处理机制</strong>：开发环境 <code>(DEBUG=True)</code>下，返回<strong>带完整异常栈的调试页面</strong>，能按到所有异常信息。生产环境下转换为<code>500 Internal Server Error</code>，通用的无信息的错误页。</p>
<p>有无必要使用<code>@app.errorhandler(BaseException)</code>兜底所有异常？<strong>没有必要</strong>。<code>Exception</code>是所有非中断异常的基类，对于会严重错误，而导致系统异常退出的异常，应该执行退出逻辑。<code>BaseException</code>是所有异常的基类，包括退出和系统中断</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask
<span class="hljs-keyword">import</span> sys

app = Flask(__name__)

<span class="hljs-comment"># ❌ 危险的BaseException处理器</span>
<span class="hljs-meta">@app.errorhandler(<span class="hljs-params">BaseException</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_base_exception</span>(<span class="hljs-params">e</span>):
    <span class="hljs-string">"""这会捕获所有异常，包括系统退出信号！"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"捕获到BaseException: <span class="hljs-subst">{<span class="hljs-built_in">type</span>(e).__name__}</span>"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">"错误已处理"</span>, <span class="hljs-number">500</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/exit'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">exit_app</span>():
    <span class="hljs-string">"""这个路由会触发系统退出"""</span>
    sys.exit(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 抛出SystemExit异常</span>

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/keyboard'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">keyboard</span>():
    <span class="hljs-string">"""模拟键盘中断（在实际服务器中很难触发）"""</span>
    <span class="hljs-keyword">raise</span> KeyboardInterrupt()

<span class="hljs-comment"># 访问 /exit 时：</span>
<span class="hljs-comment"># 1. 应该让程序正常退出</span>
<span class="hljs-comment"># 2. 但BaseException处理器会捕获SystemExit</span>
<span class="hljs-comment"># 3. 返回HTTP响应，程序继续运行！</span>
<span class="hljs-comment"># 4. 这破坏了正常的程序控制流</span>
</code></pre>
<p>因此，大多数情况下应用开发时关注<code>Exception</code>即可，无需捕获<code>BaseException</code>。</p>
<p><strong>讨论问题：什么情况下需要<code>BaseException</code>处理器？</strong></p>
<h2 data-id="heading-12">关注微信公众号，获取运维资讯</h2>
<p>如果此篇文章对你有所帮助，感谢你的<strong>点赞</strong>与<strong>收藏</strong>，也欢迎在评论区友好交流。</p>
<p>微信搜索关注公众号：<strong>持续运维</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 跨组件通信封神对比：mitt vs tiny-emitter vs provide+inject+Symbol，该选谁？]]></title>    <link>https://juejin.cn/post/7602072652607717416</link>    <guid>https://juejin.cn/post/7602072652607717416</guid>    <pubDate>2026-02-03T01:13:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602072652607717416" data-draft-id="7602073973309997071" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 跨组件通信封神对比：mitt vs tiny-emitter vs provide+inject+Symbol，该选谁？"/> <meta itemprop="keywords" content="面试,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2026-02-03T01:13:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="boooooooom"/> <meta itemprop="url" content="https://juejin.cn/user/3078273283917399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 跨组件通信封神对比：mitt vs tiny-emitter vs provide+inject+Symbol，该选谁？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3078273283917399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    boooooooom
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T01:13:43.000Z" title="Tue Feb 03 2026 01:13:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">正文</h2>
<h3 data-id="heading-1">一、前言：为什么要做这场对比？</h3>
<p>Vue3 中，跨组件通信是高频刚需——父子组件用 props/emits 足够，但祖孙组件、兄弟组件、任意层级跨组件通信时，选择哪种方案就成了开发者的难题。</p>
<p>mitt、tiny-emitter 是两大主流事件总线库，provide+inject 是 Vue 内置API，搭配 Symbol 可解决命名冲突，这4种是最常用的方案。但它们的体积、易用性、性能、适用场景天差地别，选对能少写冗余代码，选错则会埋下维护隐患，这也是本文的核心价值所在。</p>
<h3 data-id="heading-2">二、先搞懂：4种方案核心定位（快速区分）</h3>
<p>在深入对比前，先明确每种方案的核心定位，避免混淆，快速匹配自身需求：</p>
<ul>
<li><strong>mitt</strong>：轻量级事件总线库，无依赖、API简洁，Vue3 官方推荐替代废弃的 EventBus，适配大部分跨组件通信场景；</li>
<li><strong>tiny-emitter</strong>：比 mitt 更小巧的事件总线，API 更贴近传统 EventBus，侧重极简体积和基础通信；</li>
<li><strong>provide+inject</strong>：Vue 内置API，无需额外安装，主打“祖先-后代”层级通信，非事件驱动，适合状态共享；</li>
<li><strong>provide+inject+Symbol</strong>：在内置API基础上优化，用 Symbol 解决注入命名冲突问题，提升大型项目可维护性。</li>
</ul>
<h3 data-id="heading-3">三、全方位对比：从5个核心维度拆解（重点！）</h3>
<p>以下是4种方案的核心维度对比，结合实操体验和项目场景，每一项都对应实际开发中的痛点，建议收藏备用。</p>
<h4 data-id="heading-4">1. 基础信息（体积、依赖、兼容性）</h4>








































<table><thead><tr><th>方案</th><th>体积（min+gzip）</th><th>是否需额外安装</th><th>Vue3 兼容性</th><th>核心优势</th></tr></thead><tbody><tr><td>mitt</td><td>≈200B</td><td>是（npm i mitt）</td><td>完美兼容（官方推荐）</td><td>轻量、API简洁、支持批量解绑</td></tr><tr><td>tiny-emitter</td><td>≈150B</td><td>是（npm i tiny-emitter）</td><td>完美兼容</td><td>极致小巧、API贴近原生EventBus</td></tr><tr><td>provide+inject</td><td>0体积（内置）</td><td>否</td><td>完美兼容</td><td>无需额外依赖、原生支持、状态共享便捷</td></tr><tr><td>provide+inject+Symbol</td><td>0体积（内置+原生Symbol）</td><td>否</td><td>完美兼容</td><td>解决命名冲突、大型项目友好、无额外开销</td></tr></tbody></table>
<h4 data-id="heading-5">2. 实操演示（最简代码，直接套用）</h4>
<p>实操是核心，以下是每种方案的最简实现代码，重点看“通信流程”和“API复杂度”。</p>
<h5 data-id="heading-6">（1）mitt 实现跨组件通信</h5>
<p>步骤：创建总线实例 → 发送事件 → 监听事件 → 解绑事件（避免内存泄漏）</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1. 创建总线实例（utils/bus.js）</span>
<span class="hljs-keyword">import</span> mitt <span class="hljs-keyword">from</span> <span class="hljs-string">'mitt'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> bus = <span class="hljs-title function_">mitt</span>()

<span class="hljs-comment">// 2. 发送事件（组件A）</span>
<span class="hljs-keyword">import</span> { bus } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/bus'</span>
bus.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'sendMsg'</span>, <span class="hljs-string">'Hello Vue3'</span>)

<span class="hljs-comment">// 3. 监听事件（组件B，任意层级）</span>
<span class="hljs-keyword">import</span> { bus } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/bus'</span>
bus.<span class="hljs-title function_">on</span>(<span class="hljs-string">'sendMsg'</span>, <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'接收消息：'</span>, msg) <span class="hljs-comment">// 输出：Hello Vue3</span>
})

<span class="hljs-comment">// 4. 解绑事件（组件销毁时，必写）</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  bus.<span class="hljs-title function_">off</span>(<span class="hljs-string">'sendMsg'</span>) <span class="hljs-comment">// 解绑单个事件</span>
  <span class="hljs-comment">// bus.all.clear() // 解绑所有事件</span>
})
</code></pre>
<h5 data-id="heading-7">（2）tiny-emitter 实现跨组件通信</h5>
<p>API 与 mitt 类似，更贴近传统 EventBus，支持链式调用</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1. 创建总线实例（utils/bus.js）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Emitter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'tiny-emitter'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> bus = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Emitter</span>()

<span class="hljs-comment">// 2. 发送事件（组件A）</span>
bus.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'sendMsg'</span>, <span class="hljs-string">'Hello tiny-emitter'</span>)

<span class="hljs-comment">// 3. 监听事件（组件B）</span>
bus.<span class="hljs-title function_">on</span>(<span class="hljs-string">'sendMsg'</span>, <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'接收消息：'</span>, msg)
})

<span class="hljs-comment">// 4. 解绑事件（组件销毁时）</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  bus.<span class="hljs-title function_">off</span>(<span class="hljs-string">'sendMsg'</span>)
})
</code></pre>
<h5 data-id="heading-8">（3）provide+inject 实现跨组件通信</h5>
<p>步骤：祖先组件 provide 提供数据 → 后代组件 inject 注入数据（支持多层传递）</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1. 祖先组件（提供数据）</span>
<span class="hljs-keyword">import</span> { provide } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 提供普通数据</span>
    <span class="hljs-title function_">provide</span>(<span class="hljs-string">'msg'</span>, <span class="hljs-string">'Hello provide+inject'</span>)
    <span class="hljs-comment">// 提供方法（实现双向通信）</span>
    <span class="hljs-title function_">provide</span>(<span class="hljs-string">'changeMsg'</span>, <span class="hljs-function">(<span class="hljs-params">newMsg</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'新消息：'</span>, newMsg)
    })
  }
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 2. 后代组件（注入数据，任意层级）</span>
<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> msg = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'msg'</span>)
    <span class="hljs-keyword">const</span> changeMsg = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'changeMsg'</span>)
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg) <span class="hljs-comment">// 输出：Hello provide+inject</span>
    <span class="hljs-title function_">changeMsg</span>(<span class="hljs-string">'新的消息内容'</span>) <span class="hljs-comment">// 调用祖先组件方法</span>
  }
}
</code></pre>
<h5 data-id="heading-9">（4）provide+inject+Symbol 实现跨组件通信</h5>
<p>核心：用 Symbol 创建唯一key，解决“不同组件注入同名key导致冲突”的问题</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 1. 创建唯一Symbol（utils/keys.js）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> msgKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'msg'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> changeMsgKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'changeMsg'</span>)

<span class="hljs-comment">// 2. 祖先组件（provide）</span>
<span class="hljs-keyword">import</span> { provide } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { msgKey, changeMsgKey } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/keys'</span>
<span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">provide</span>(msgKey, <span class="hljs-string">'Hello Symbol'</span>)
  <span class="hljs-title function_">provide</span>(changeMsgKey, <span class="hljs-function">(<span class="hljs-params">newMsg</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newMsg)
  })
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 3. 后代组件（inject）</span>
<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { msgKey, changeMsgKey } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/keys'</span>
<span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> msg = <span class="hljs-title function_">inject</span>(msgKey)
  <span class="hljs-keyword">const</span> changeMsg = <span class="hljs-title function_">inject</span>(changeMsgKey)
  <span class="hljs-comment">// 无需担心命名冲突</span>
}
</code></pre>
<h4 data-id="heading-10">3. 核心差异（易用性、性能、适用场景）</h4>
<ul>
<li>
<p><strong>易用性排序</strong>：tiny-emitter ≈ mitt &gt; provide+inject+Symbol &gt; provide+inject（Symbol需额外维护key，略繁琐）</p>
</li>
<li>
<p><strong>性能排序</strong>：provide+inject ≈ provide+inject+Symbol &gt; mitt ≈ tiny-emitter（内置API无额外开销，事件总线有轻微监听/解绑开销）</p>
</li>
<li>
<p><strong>适用场景差异</strong>：</p>
<ul>
<li>mitt：中小型项目、任意层级跨组件通信，需批量解绑事件的场景（官方推荐，首选）；</li>
<li>tiny-emitter：极致追求体积的小型项目，简单通信场景（无复杂需求可替代mitt）；</li>
<li>provide+inject：祖先-后代层级明确，需共享状态/方法的场景（如主题切换、用户信息共享）；</li>
<li>provide+inject+Symbol：大型项目、多团队协作，需避免注入命名冲突的场景（ enterprise 级项目首选内置方案）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-11">四、常见踩坑点（必看！）</h3>
<h4 data-id="heading-12">1. 事件总线（mitt/tiny-emitter）踩坑</h4>
<p>坑点1：组件销毁时未解绑事件，导致多次渲染后重复触发（内存泄漏）； 解决方案：在 onUnmounted 钩子中，手动解绑当前组件监听的所有事件。</p>
<p>坑点2：事件名拼写错误，导致通信失败（无报错提示）； 解决方案：用常量统一管理事件名，避免手写字符串（如 export const EVENT_MSG = 'sendMsg'）。</p>
<h4 data-id="heading-13">2. provide+inject（含Symbol）踩坑</h4>
<p>坑点1：inject 注入的属性为 undefined，未找到对应 provide； 解决方案：确认祖先组件已 provide，且注入的 key 完全一致（Symbol 必须是同一个实例，不能重复创建）。</p>
<p>坑点2：provide 提供的是普通值，后代组件修改后不响应； 解决方案：用 ref/reactive 包装提供的值，实现响应式通信（如 provide('msg', ref('Hello'))）。</p>
<h3 data-id="heading-14">五、总结：一句话选对方案（新手直接抄）</h3>
<ol>
<li>中小型项目、任意层级通信 → 选 <strong>mitt</strong>（官方推荐，平衡易用性和性能）；</li>
<li>小型项目、极致追求体积 → 选 <strong>tiny-emitter</strong>（比mitt更小巧，够用就好）；</li>
<li>祖先-后代层级通信、共享状态 → 选<strong>provide+inject</strong>（无额外依赖，原生友好）；</li>
<li>大型项目、多团队协作 → 选 <strong>provide+inject+Symbol</strong>（避免命名冲突，易维护）。</li>
</ol>
<p>其实这4种方案没有绝对的优劣，核心是“匹配项目场景”——无需盲目追求“最先进”，能解决问题、降低维护成本，就是最好的选择。掌握它们的差异和踩坑点，Vue3 跨组件通信就能游刃有余～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter从入门到放弃]]></title>    <link>https://juejin.cn/post/7602166907571093542</link>    <guid>https://juejin.cn/post/7602166907571093542</guid>    <pubDate>2026-02-03T01:51:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602166907571093542" data-draft-id="7594087108594286655" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter从入门到放弃"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2026-02-03T01:51:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MakeZero"/> <meta itemprop="url" content="https://juejin.cn/user/1867448966973751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter从入门到放弃
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1867448966973751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MakeZero
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T01:51:17.000Z" title="Tue Feb 03 2026 01:51:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">变量及常量</h2>
<h3 data-id="heading-1">变量</h3>
<p>var</p>
<h3 data-id="heading-2">常量</h3>

















<table><thead><tr><th>常量</th><th>区别</th></tr></thead><tbody><tr><td>final</td><td>编译时不可修改</td></tr><tr><td>const</td><td>运行时不可修改</td></tr></tbody></table>
<p>代码演示如下：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {
  <span class="hljs-comment">// 变量 var</span>
  <span class="hljs-keyword">var</span> age = <span class="hljs-number">20</span>;
  age = <span class="hljs-number">21</span>;
  <span class="hljs-built_in">print</span>(age);
  <span class="hljs-comment">// 常量 const</span>
  <span class="hljs-keyword">const</span> number = <span class="hljs-number">3.1415926</span>;
  <span class="hljs-keyword">const</span> length = number * <span class="hljs-number">2</span> * <span class="hljs-number">10</span>;
  <span class="hljs-built_in">print</span>(length);
  <span class="hljs-comment">// 常量 final</span>
  <span class="hljs-keyword">final</span> time = <span class="hljs-built_in">DateTime</span>.now();
  prnt(time);
}
</code></pre>
<h2 data-id="heading-3">数据类型</h2>
<h3 data-id="heading-4">Int</h3>
<p>整型类型</p>
<h3 data-id="heading-5">Double</h3>
<p>浮点类型</p>
<h3 data-id="heading-6">Number</h3>
<h2 data-id="heading-7">自定义组件</h2>
<h3 data-id="heading-8">无状态组件 [StatelessWidget]</h3>
<ul>
<li>无状态组件是不可变的，意味着它们的属性不能改变, 所有的值都是最终的。</li>
<li>通常用于当你需要展示的UI不依赖于对象内部状态时。</li>
</ul>
<pre><code class="hljs language-flutter" lang="flutter">import 'package:flutter/material.dart';

void main(List&lt;String&gt; args) {
  runApp(MainPage());
}

class MainPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    // TODO: implement build
    return MaterialApp(
      title: "无状态组件",
      home:Scaffold(
        appBar: AppBar(
          title:Text("顶部区域"),
        ),
        body: Container(
          child: Center(
            child: Text("中部本区域"),
          ),
        ),
        bottomNavigationBar: Container(
          height: 80,
          child: Center(
            child: Text("底部区域"),
          ),
        )
      )
    );
  }
}
</code></pre>
<h3 data-id="heading-9">有状态组件 [StatefulWidget]</h3>
<ul>
<li>有状态组件可以在其生命周期中改变状态。</li>
<li>通常用于当UI可以在用户交互或其他因素影响下改变时</li>
</ul>
<pre><code class="hljs language-flutter" lang="flutter">import 'package:flutter/material.dart';

void main(List&lt;String&gt; args) {
  runApp(MainPage());
}
// 对外接受和定义最终参数 
class MainPage extends StatefulWidget{
  @override
  State&lt;StatefulWidget&gt; createState() {
    // TODO: implement createState
    return _MainPage();
  }
}
// 负责管理数据 处理业务逻辑 渲染视图
class _MainPage extends State&lt;MainPage&gt;{
  @override
  Widget build(BuildContext context) {
    // TODO: implement build
    return MaterialApp(
      title: "有状态组件",
      home:Scaffold(
        appBar: AppBar(
          title:Text("顶部区域"),
        ),
        body: Container(
          child: Center(
            child: Text("中部本区域"),
          ),
        ),
        bottomNavigationBar: Container(
          height: 80,
          child: Center(
            child: Text("底部区域"),
          ),
        )
      )
    );
  }
}
</code></pre>
<p>使用Awesome Flutter Snippets用来创建有状态组件及无状态组件的快捷键</p>
<h4 data-id="heading-10">无状态组件：statelessW</h4>
<h4 data-id="heading-11">有状态组件：statefulW</h4>
<p>代码示例</p>
<p>以下是无状态组件代码示例</p>
<pre><code class="hljs language-flutter" lang="flutter">import 'package:flutter/material.dart';

void main(List&lt;String&gt; args) {
  runApp(StateLessWeight());
}

class StateLessWeight extends StatelessWidget {
  const StateLessWeight({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Container(
      child: null,
    );
  }
}
</code></pre>
<p>以下部分是有状态组件代码示例</p>
<pre><code class="hljs language-有状态组件代码示例" lang="有状态组件代码示例">import 'package:flutter/material.dart';

void main(List&lt;String&gt; args) {
  runApp(TestWeight());
}

class TestWeight extends StatefulWidget {
  TestWeight({Key? key}) : super(key: key);

  @override
  _TestWeightState createState() =&gt; _TestWeightState();
}

class _TestWeightState extends State&lt;TestWeight&gt; {
  @override
  Widget build(BuildContext context) {
    return Container(
       child: null,
    );
  }
}
</code></pre>
<h2 data-id="heading-12">组件的生命周期</h2>
<h3 data-id="heading-13">无状态组件</h3>
<p>存在唯一阶段：build,当组件被创建或者父组件的状态发生变化，导致下面的组件发生变化并需要重新构建时，此方法会被调用</p>
<h4 data-id="heading-14">代码示例</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">List&lt;<span class="hljs-built_in">String</span>&gt; args</span>) {
  <span class="hljs-title function_">runApp</span>(<span class="hljs-title class_">MainPage</span>());
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">StatelessWidget</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">MainPage</span>({<span class="hljs-title class_">Key</span>? key}) : <span class="hljs-variable language_">super</span>(<span class="hljs-attr">key</span>: key);

  @override
  <span class="hljs-title class_">Widget</span> <span class="hljs-title function_">build</span>(<span class="hljs-params">BuildContext context</span>) {
    <span class="hljs-title function_">print</span>(<span class="hljs-string">"无状态组件的执行"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">MaterialApp</span>(
      <span class="hljs-attr">home</span>: <span class="hljs-title class_">Scaffold</span>(
        <span class="hljs-attr">body</span>: <span class="hljs-title class_">Container</span>(
          <span class="hljs-attr">child</span>: <span class="hljs-title class_">Center</span>(
            <span class="hljs-attr">child</span>: <span class="hljs-title class_">Text</span>(<span class="hljs-string">"无状态"</span>),
          ),
        ),
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-15">有状态组件</h3>
<p>build阶段的生命周期</p>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2

createState --&gt; initState
initState --&gt; didChangeDependencies
didChangeDependencies --&gt; build

组件创建 --&gt; 组件初始化 
组件初始化 --&gt; 更改依赖项 
更改依赖项 --&gt; 构建 

</code></pre>
<p>update阶段的生命周期</p>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2

父组件重建_配置变更 --&gt; didUpdateWidget
didUpdateWidget --&gt; build

</code></pre>
<p>销毁阶段的生命周期</p>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2

组件移除 --&gt; deactivate
deactivate --&gt; dispose

</code></pre>
<h3 data-id="heading-16">生命周期函数</h3>













































<table><thead><tr><th>生命周期阶段</th><th>函数名</th><th>调用时机与核心任务</th></tr></thead><tbody><tr><td>创建阶段</td><td>createState()</td><td>Widget初始化调用，创建State对象</td></tr><tr><td/><td>initState()</td><td>state对象插入Widget立即执行，<strong>仅执行一次</strong></td></tr><tr><td/><td>didChangeDependencies()</td><td>initState后立刻执行，当所依赖的inheritedWidget更新时调用，可能多次</td></tr><tr><td>构建与更新阶段</td><td>build()</td><td>创建UI方法，初始化或更新后多次调用</td></tr><tr><td/><td>didupdateWidget()</td><td>父级组件传入新配置时调用，用于比较新旧配置</td></tr><tr><td>销毁阶段</td><td>deactiveate()</td><td>当State对象从树中暂时移除时调用</td></tr><tr><td/><td>dispose()</td><td>释放资源</td></tr></tbody></table>
<p>执行一次函数: createState initState dispose</p>
<p><strong>lnheritedWidget</strong></p>
<p>专门用于在widget树中自定向下高效进行信息共享，其中顶部组件负责提供数据 子级数据负责进行数据的获取。</p>
<h2 data-id="heading-17">事件-点击事件</h2>
<p>GestureDetector 用户与应用程序交互时触发的各种动作
特征：屏幕的滑动 点击及触摸</p>
<h3 data-id="heading-18">常用方法及说明</h3>

















<table><thead><tr><th>常用方法</th><th>说明</th></tr></thead><tbody><tr><td>OnTap()</td><td>单击事件</td></tr><tr><td>OnDoubleTap()</td><td>屏幕双击事件</td></tr></tbody></table>
<h3 data-id="heading-19">代码演示</h3>
<h4 data-id="heading-20">单击事件</h4>
<pre><code class="hljs language-flutter" lang="flutter">import 'package:flutter/material.dart';

void main(List&lt;String&gt; args) {
  runApp(MainPage());
}
class MainPage extends StatelessWidget {
  const MainPage({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: "点击事件演示",
      home: Scaffold(
        appBar: AppBar(
          title: Text("标题区域"),
        ),
        body: Container(
          child: Center(
            child: GestureDetector(
              child: Text("测试中部区域"),
              // 单击事件
              onTap: (){
                print("测试区域");
              },
            )
          )
        ),
        bottomNavigationBar: Container(
          height: 80,
          child: Center(
            child: Text("底部区域"),
          ),
        ),
      ),
    );
  }
}

</code></pre>
<h4 data-id="heading-21">双击事件</h4>
<p>此段代码仅展示上段代码修改区域</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 单击事件</span>
<span class="hljs-comment">// onTap: (){</span>
<span class="hljs-comment">//   print("测试区域");</span>
<span class="hljs-comment">// },</span>
<span class="hljs-comment">// 双击事件</span>
<span class="hljs-attr">onDoubleTap</span>: (){
    <span class="hljs-title function_">print</span>(<span class="hljs-string">"双击该区域"</span>);
}
</code></pre>
<h4 data-id="heading-22">长按事件</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 单击事件</span>
<span class="hljs-comment">// onTap: (){</span>
<span class="hljs-comment">//   print("测试区域");</span>
<span class="hljs-comment">// },</span>
<span class="hljs-comment">// 双击事件</span>
<span class="hljs-comment">// onDoubleTap: (){</span>
<span class="hljs-comment">//   print("双击该区域");</span>
<span class="hljs-comment">// },</span>
<span class="hljs-attr">onLongPress</span>: (){
  <span class="hljs-title function_">print</span>(<span class="hljs-string">"长按该区域"</span>);
},
</code></pre>
<h3 data-id="heading-23">组件点击事件</h3>
<h4 data-id="heading-24">常用方法及说明</h4>
<p>flutter提供多种方式为组件添加点击交互</p>

























<table><thead><tr><th>组件类别</th><th>核心组件</th><th>组件说明</th></tr></thead><tbody><tr><td>专用按钮组件</td><td>ElevatedButton、TextButton、OutlineButton、FloatingActionButton</td><td>内置点击动画和样式，通过onPressed参数处理点击逻辑</td></tr><tr><td>视觉反馈组件</td><td>lnkwell</td><td>提供点击事件(onTap) 有MaterialDesign风格的水纹扩散效果</td></tr><tr><td>其他交互组件</td><td>IconButton、Switch、checkbox</td><td>具有特定交互功能的交互式控件，点击事件(onPressed)</td></tr></tbody></table>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">List&lt;<span class="hljs-built_in">String</span>&gt; args</span>) {
  <span class="hljs-title function_">runApp</span>(<span class="hljs-title class_">MainPage</span>());
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">StatelessWidget</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">MainPage</span>({<span class="hljs-title class_">Key</span>? key}) : <span class="hljs-variable language_">super</span>(<span class="hljs-attr">key</span>: key);

  @override
  <span class="hljs-title class_">Widget</span> <span class="hljs-title function_">build</span>(<span class="hljs-params">BuildContext context</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">MaterialApp</span>(
      <span class="hljs-attr">title</span>: <span class="hljs-string">"点击事件演示"</span>,
      <span class="hljs-attr">home</span>: <span class="hljs-title class_">Scaffold</span>(
        <span class="hljs-attr">appBar</span>: <span class="hljs-title class_">AppBar</span>(
          <span class="hljs-attr">title</span>: <span class="hljs-title class_">Text</span>(<span class="hljs-string">"标题区域"</span>),
        ),
        <span class="hljs-attr">body</span>: <span class="hljs-title class_">Container</span>(
          <span class="hljs-attr">child</span>: <span class="hljs-title class_">Center</span>(
            <span class="hljs-attr">child</span>: <span class="hljs-title class_">GestureDetector</span>(
              <span class="hljs-comment">// TextButton组件</span>
              <span class="hljs-attr">child</span>: <span class="hljs-title class_">TextButton</span>(
                <span class="hljs-attr">onPressed</span>: (){
                  <span class="hljs-title function_">print</span>(<span class="hljs-string">"TextButton测试"</span>);
                }, 
              <span class="hljs-attr">child</span>: <span class="hljs-title class_">Text</span>(<span class="hljs-string">"按钮测试"</span>)
              ),
            )
          )
        ),
        <span class="hljs-attr">bottomNavigationBar</span>: <span class="hljs-title class_">Container</span>(
          <span class="hljs-attr">height</span>: <span class="hljs-number">80</span>,
          <span class="hljs-attr">child</span>: <span class="hljs-title class_">Center</span>(
            <span class="hljs-attr">child</span>: <span class="hljs-title class_">Text</span>(<span class="hljs-string">"底部区域"</span>),
          ),
        ),
      ),
    );
  }
}
</code></pre>
<p><strong>OutlinedButton代码演示</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">body</span>: <span class="hljs-title class_">Container</span>(
  <span class="hljs-attr">child</span>: <span class="hljs-title class_">Center</span>(
      <span class="hljs-attr">child</span>: <span class="hljs-title class_">GestureDetector</span>(
          <span class="hljs-attr">child</span>: <span class="hljs-title class_">OutlinedButton</span>(<span class="hljs-attr">onPressed</span>: (){
               <span class="hljs-title function_">print</span>(<span class="hljs-string">"数据"</span>);
          }, <span class="hljs-attr">child</span>: <span class="hljs-title class_">Text</span>(<span class="hljs-string">"数据"</span>))
      ),
   )
),
</code></pre>
<h2 data-id="heading-25">状态更新setState</h2>
<p>数据变化需要更新UI视图时，需要执行setState方法，setState方法会造成build的重新执行</p>
<h3 data-id="heading-26">代码演示</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">List&lt;<span class="hljs-built_in">String</span>&gt; args</span>) {
  <span class="hljs-title function_">runApp</span>(<span class="hljs-title function_">mainPage</span>());
}

<span class="hljs-comment">// 使用无状态组件</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">mainPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">StatefulWidget</span> {
  <span class="hljs-title function_">mainPage</span>({<span class="hljs-title class_">Key</span>? key}) : <span class="hljs-variable language_">super</span>(<span class="hljs-attr">key</span>: key);

  @override
  _mainPageState <span class="hljs-title function_">createState</span>() =&gt; <span class="hljs-title function_">_mainPageState</span>();
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">_mainPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">State</span>&lt;mainPage&gt; {
  <span class="hljs-comment">// 数据定义</span>
  int count = <span class="hljs-number">3</span>;
  @override
  <span class="hljs-title class_">Widget</span> <span class="hljs-title function_">build</span>(<span class="hljs-params">BuildContext context</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">MaterialApp</span>(
      <span class="hljs-attr">home</span>: <span class="hljs-title class_">Scaffold</span>(
        <span class="hljs-attr">body</span>: <span class="hljs-title class_">Center</span>(
          <span class="hljs-attr">child</span>: <span class="hljs-title class_">Row</span>(
            <span class="hljs-attr">children</span>: [
              <span class="hljs-title class_">TextButton</span>(<span class="hljs-attr">onPressed</span>: (){
                <span class="hljs-keyword">if</span>(count==<span class="hljs-number">0</span>){
                  count=<span class="hljs-number">0</span>;
                }<span class="hljs-keyword">else</span>{
                  <span class="hljs-title function_">setState</span>(() {
                    count-=<span class="hljs-number">1</span>;
                  });
                }
                
              }, <span class="hljs-attr">child</span>: <span class="hljs-title class_">Text</span>(<span class="hljs-string">"减"</span>)),
              <span class="hljs-title class_">Text</span>(count.<span class="hljs-title function_">toString</span>()),
              <span class="hljs-title class_">TextButton</span>(<span class="hljs-attr">onPressed</span>: (){
                <span class="hljs-comment">// UI 数据更新</span>
                <span class="hljs-title function_">setState</span>(() {
                  count+=<span class="hljs-number">1</span>;
                });
              }, <span class="hljs-attr">child</span>: <span class="hljs-title class_">Text</span>(<span class="hljs-string">"加"</span>)),
            ],
          ),
        ),
      ),
    );
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[时间盒实践指南：每日规划与执行方法]]></title>    <link>https://juejin.cn/post/7602191709388144682</link>    <guid>https://juejin.cn/post/7602191709388144682</guid>    <pubDate>2026-02-03T02:32:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602191709388144682" data-draft-id="7602162809292128294" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="时间盒实践指南：每日规划与执行方法"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-02-03T02:32:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="暖阳_"/> <meta itemprop="url" content="https://juejin.cn/user/1662117312465406"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            时间盒实践指南：每日规划与执行方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1662117312465406/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    暖阳_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:32:16.000Z" title="Tue Feb 03 2026 02:32:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">时间盒实践指南：每日规划与执行方法</h2>
<p>早上读书时接触到「时间盒」这个概念，来自同名书《时间盒》，我用它来梳理每日工作并做了实践记录。</p>
<p>本文整理出一套时间盒实践方法（含计划、执行、验收与可接受标准），并标明适用与不适用场景，避免误用；同时强调在实践时要平衡完成度与完美主义。核心是「结构化规划 + 专注执行 + 弹性调整」，追求的是<strong>掌控感</strong>而非<strong>束缚感</strong>。</p>
<hr/>
<h3 data-id="heading-1">一、每天必看</h3>
<h4 data-id="heading-2">1.1 今日操作步骤</h4>
<ol>
<li><strong>计划·列任务</strong>：用动词描述（如「完成xx报告」「学习xx第三章」），拆成可执行小步骤；任务清单里可标重要性。</li>
<li><strong>计划·排优先级</strong>：按重要性排序，优先锁定 3～5 个核心任务。</li>
<li><strong>计划·设时间盒</strong>：60 分钟（深度任务）/ 30 分钟（常规）/ 15 分钟（碎片）；盒与盒之间留 5～10 分钟缓冲。</li>
<li><strong>计划·写可接受标准</strong>：每个任务写清「最低成果」或「可接受标准」，与任务放在一起；标准不必复杂，能自检即可。</li>
<li><strong>执行·准时开启</strong>：严格按时间盒开始，延迟不超过总时长 1/10。</li>
<li><strong>执行·专注</strong>：手机勿扰，关闭非必要通知，一次只做一件事。</li>
<li><strong>验收</strong>：到点收尾，完成后划掉任务，用简单仪式庆祝（如打勾、短暂休息）。</li>
</ol>
<h4 data-id="heading-3">1.2 可接受标准范例（按任务类型仿写）</h4>
<ul>
<li><strong>报告类</strong>：先完成框架，细节后续补充。可接受标准示例：「框架完整、核心结论写清」。</li>
<li><strong>学习类</strong>：先掌握核心用法，熟练度逐步提升。可接受标准示例：「能复述要点或做一道例题」。</li>
<li><strong>决策类</strong>：先做出可行选择，后续根据反馈调整。可接受标准示例：「选定一个方案并写下理由」。</li>
<li><strong>开发·静态页面</strong>：某屏/某列与设计稿一致。可接受标准：「自检与设计稿一致」。例：完成大屏某 1/5 模块，按 UI 设计稿自测核查，布局与设计稿一致即通过。</li>
<li><strong>开发·数据渲染</strong>：指定模块数据与提供数据一致。可接受标准：「自检/自测通过」。例：某屏若干模块数据与提供数据一致，自检通过即可；代码类标准不需很复杂，自测通过即算完成。</li>
</ul>
<h4 data-id="heading-4">1.3 今日时间盒清单示例（含总括与缓冲）</h4>
<p><strong>总括</strong>：一共四个屏幕，当前做：第三屏地图 + 第四屏第二、三列。</p>

































<table><thead><tr><th>序号</th><th>任务</th><th>时长</th><th>可接受标准</th><th>缓冲</th></tr></thead><tbody><tr><td>1</td><td>完成驾驶舱大屏静态页面 屏幕3 地图部分完善调整</td><td>60 分钟</td><td>自检与设计稿一致</td><td>5～10 分钟</td></tr><tr><td>2</td><td>完成驾驶舱大屏静态页面 屏幕4 第二列</td><td>30 分钟</td><td>自检与设计稿一致</td><td>5～10 分钟</td></tr><tr><td>3</td><td>完成驾驶舱大屏静态页面 屏幕4 第三列</td><td>60 分钟</td><td>自检与设计稿一致</td><td>—</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">二、按需查阅</h3>
<h4 data-id="heading-6">2.1 适用时间盒的场景</h4>
<ol>
<li>目标明确、可拆解的任务（项目开发、报告撰写、技能学习等）。</li>
<li>需要集中注意力的任务（深度思考、创意产出、复杂决策），避免多任务切换。</li>
<li>存在明确截止时间的任务（会议、作业、项目节点），通过时间盒强制产出。</li>
<li>有选择焦虑、注意力分散、拖延倾向时，用结构化规划减少决策内耗。</li>
</ol>
<h4 data-id="heading-7">2.2 不适用时间盒的场景</h4>
<ol>
<li>充满不确定性或惊喜的活动（家庭聚会、即兴社交、突发创意讨论），需灵活应变。</li>
<li>高度规律性、无自主安排空间的工作（流水线、客服轮班等），节奏由外部决定。</li>
<li>追求「享受过程」的活动（悠闲阅读、艺术创作、亲子互动），过度限时易破坏沉浸感。</li>
<li>任务本身无法量化成果（无明确目标的放松、冥想等），时间盒易流于形式。</li>
</ol>
<h4 data-id="heading-8">2.3 限制条件</h4>
<ol>
<li><strong>依赖前期规划能力</strong>：需提前列清单、拆解目标、估算时间，计划能力弱时可能有门槛。</li>
<li><strong>不可过度压缩</strong>：任务时间盒需预留缓冲，否则易被突发状况打乱。</li>
<li><strong>无法完全覆盖弹性需求</strong>：任务高度不确定时，严格执行时间盒可能带来压力。</li>
</ol>
<h4 data-id="heading-9">2.4 时间盒的四大要素</h4>
<ol>
<li><strong>目的性</strong>：通过任务清单与优先级，确保时间投入到关键目标，避免忙碌但无效。</li>
<li><strong>专注性</strong>：通过「限定时间 + 单一任务」抑制注意力分散，用时间边界创造专注环境。</li>
<li><strong>完成度</strong>：在限定时间内有成果产出；完成度指「达到可接受标准」，而非完美。</li>
<li><strong>平衡</strong>：设定合理标准（写报告先框架、学技能先核心用法、做决策先可行选择），接受阶段性成果与后续迭代；避免用「不追求完美」当敷衍借口，也要避免没有明确可接受标准。</li>
</ol>
<h4 data-id="heading-10">2.5 完成度 vs 不追求完美</h4>
<ul>
<li><strong>正确做法</strong>：任务开始前定义「最低成果要求」；接受「完成」而非「完美」，允许后续迭代；用「5 分钟启动法」降低心理负担。</li>
<li><strong>错误做法</strong>：完全忽略质量标准；用「不追求完美」当敷衍借口；没有明确的「可接受标准」。</li>
</ul>
<hr/>
<p><em>时间盒是工具，不是枷锁；关键是在有限时间内产出可接受的成果，而非纠结于细节的完美。</em></p>
<h3 data-id="heading-11">Changelog</h3>
<h4 data-id="heading-12">V1.2 (2025-02-03)</h4>
<ul>
<li>忽略本地写作 skill，按常规 Markdown 重新整理。</li>
<li>操作步骤与可接受标准改为加粗标题 + 正常段落；今日时间盒清单示例改为表格呈现。</li>
<li>2.3 限制条件、2.4 四大要素、2.5 正确/错误做法关键词加粗，便于扫读。</li>
</ul>
<h4 data-id="heading-13">V1.1 (2025-02-03)</h4>
<ul>
<li>一、每天必看 拆为 1.1 今日操作步骤、1.2 可接受标准范例、1.3 今日时间盒清单示例。</li>
<li>二、按需查阅 拆为 2.1 适用场景、2.2 不适用场景、2.3 限制条件、2.4 四大要素、2.5 完成度与完美主义。</li>
<li>增强章节层级与逻辑，便于「当下该看哪段」快速定位。</li>
</ul>
<h4 data-id="heading-14">V1.0</h4>
<ul>
<li>初始版本：时间盒实践方法、适用与不适用场景、可接受标准范例与清单示例。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[grep/awk/sed 三剑客极简入门！]]></title>    <link>https://juejin.cn/post/7602162571380326406</link>    <guid>https://juejin.cn/post/7602162571380326406</guid>    <pubDate>2026-02-02T17:42:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602162571380326406" data-draft-id="7602162571379752966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="grep/awk/sed 三剑客极简入门！"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2026-02-02T17:42:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sheffield"/> <meta itemprop="url" content="https://juejin.cn/user/362164852109770"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            grep/awk/sed 三剑客极简入门！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/362164852109770/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sheffield
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T17:42:15.000Z" title="Mon Feb 02 2026 17:42:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在后端 / 运维日常工作中，排查bug、筛选异常、统计接口调用量都离不开日志处理，而 <strong>grep/awk/sed</strong> 这三把Linux工具，就是解决这类问题的效率神器。</p>
<p>这篇文章只讲「日常日志」过滤的核心用法，不搞复杂语法，新手复制粘贴改参数就能搞定大多的场景，主打极简落地。</p>
<h2 data-id="heading-0">先明确核心分工</h2>
<ol>
<li><strong>grep</strong>：主打「查找 / 过滤」，快速揪出包含指定关键字的日志行</li>
<li><strong>awk</strong>：主打「按列提取 / 统计」，处理结构化日志（分隔符拆分）、做简单计数求和</li>
<li><strong>sed</strong>：主打「文本替换 / 快速编辑」，批量修改日志内容格式</li>
</ol>
<h2 data-id="heading-1">环境与示例日志</h2>
<p>基于Linux终端，示例日志<code>app.log</code>格式如下（<code>时间 | IP | 接口 | 状态 | 响应时间</code>）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-number">2026</span>-<span class="hljs-number">02</span>-<span class="hljs-number">03</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> | <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span> | <span class="hljs-regexp">/api/u</span>ser/login | <span class="hljs-number">200</span> | <span class="hljs-number">15</span>
<span class="hljs-number">2026</span>-<span class="hljs-number">02</span>-<span class="hljs-number">03</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">05</span> | <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.2</span> | <span class="hljs-regexp">/api/u</span>ser/info | <span class="hljs-number">500</span> | <span class="hljs-number">200</span>
<span class="hljs-number">2026</span>-<span class="hljs-number">02</span>-<span class="hljs-number">03</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">10</span> | <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span> | <span class="hljs-regexp">/api/</span>order/create | <span class="hljs-number">200</span> | <span class="hljs-number">30</span>
<span class="hljs-number">2026</span>-<span class="hljs-number">02</span>-<span class="hljs-number">03</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">15</span> | <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.3</span> | <span class="hljs-regexp">/api/u</span>ser/login | <span class="hljs-number">401</span> | <span class="hljs-number">10</span>
<span class="hljs-number">2026</span>-<span class="hljs-number">02</span>-<span class="hljs-number">03</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">20</span> | <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.2</span> | <span class="hljs-regexp">/api/u</span>ser/login | <span class="hljs-number">200</span> | <span class="hljs-number">18</span>
<span class="hljs-number">2026</span>-<span class="hljs-number">02</span>-<span class="hljs-number">03</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">25</span> | <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.4</span> | <span class="hljs-regexp">/api/</span>order/pay | <span class="hljs-number">500</span> | <span class="hljs-number">250</span>
<span class="hljs-number">2026</span>-<span class="hljs-number">02</span>-<span class="hljs-number">03</span> <span class="hljs-number">10</span>:<span class="hljs-number">00</span>:<span class="hljs-number">30</span> | <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span> | <span class="hljs-regexp">/api/u</span>ser/info | <span class="hljs-number">200</span> | <span class="hljs-number">22</span>
</code></pre>
<h2 data-id="heading-2">一、grep：快速找内容（最常用）</h2>
<p>核心：按关键字匹配，输出整行符合条件的内容。</p>
<h3 data-id="heading-3">核心语法</h3>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">grep</span> [参数] <span class="hljs-string">"关键字"</span> 日志文件
</code></pre>
<h3 data-id="heading-4">必学实用参数 + 实战（直接复制）</h3>
<ol>
<li>
<p>基础查找：找所有500异常日志</p>
<pre><code class="hljs language-c" lang="c">grep <span class="hljs-string">"500"</span> app.<span class="hljs-built_in">log</span>
</code></pre>
</li>
<li>
<p>显示行号：找登录接口日志，带行号方便定位</p>
<pre><code class="hljs language-c" lang="c">grep -n <span class="hljs-string">"/api/user/login"</span> app.<span class="hljs-built_in">log</span>
</code></pre>
</li>
<li>
<p>多关键字：同时找500和401异常</p>
<pre><code class="hljs language-c" lang="c">grep -E <span class="hljs-string">"500|401"</span> app.<span class="hljs-built_in">log</span>
</code></pre>
</li>
<li>
<p>显示上下文：找500异常，同时显示前后各2行（排查报错必备）</p>
<pre><code class="hljs language-c" lang="c">grep -C <span class="hljs-number">2</span> <span class="hljs-string">"500"</span> app.<span class="hljs-built_in">log</span>
</code></pre>
</li>
<li>
<p>反向过滤：过滤掉200正常日志，只留异常</p>
<pre><code class="hljs language-c" lang="c">grep -v <span class="hljs-string">"200"</span> app.<span class="hljs-built_in">log</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-5">小结</h3>
<p>记住：找内容用grep，行号 -n、多关键字 -E、上下文 -C、反向过滤 -v。</p>
<h2 data-id="heading-6">二、awk：按列提取+统计（处理数据）</h2>
<p>核心：按分隔符拆分列，提取数据或做简单统计。</p>
<h3 data-id="heading-7">核心语法</h3>
<pre><code class="hljs language-arduino" lang="arduino">awk -F <span class="hljs-string">"分隔符"</span> <span class="hljs-string">'条件 {处理动作}'</span> 日志文件
</code></pre>
<h3 data-id="heading-8">必学基础 + 实战（直接复制）</h3>
<ol>
<li>
<p>按列提取：指定<code>|</code>为分隔符，提取所有接口路径（第3列）</p>
<pre><code class="hljs language-c" lang="c">awk -F <span class="hljs-string">"|"</span> <span class="hljs-string">'{print $3}'</span> app.<span class="hljs-built_in">log</span>
</code></pre>
</li>
<li>
<p>条件提取：提取500异常的 IP 和接口（第2、3列）</p>
<pre><code class="hljs language-swift" lang="swift">awk <span class="hljs-operator">-</span><span class="hljs-type">F</span> <span class="hljs-string">"|"</span> '<span class="hljs-variable">$4</span> <span class="hljs-operator">==</span> <span class="hljs-string">" 500"</span> {print <span class="hljs-variable">$2</span>, <span class="hljs-variable">$3</span>}' app.log
</code></pre>
</li>
<li>
<p>分组统计：统计每个接口的调用次数（日常高频）</p>
<pre><code class="hljs language-css" lang="css">awk -F "|" '{arr<span class="hljs-selector-attr">[$3]</span>++} END{for (<span class="hljs-selector-tag">i</span> in arr) print <span class="hljs-selector-tag">i</span>, arr<span class="hljs-selector-attr">[i]</span>}' app<span class="hljs-selector-class">.log</span>
</code></pre>
</li>
<li>
<p>数值计算：计算登录接口的平均响应时间</p>
<pre><code class="hljs language-ini" lang="ini">awk -F "|" '$<span class="hljs-attr">3</span> == <span class="hljs-string">" /api/user/login"</span> {sum+=<span class="hljs-variable">$5</span><span class="hljs-comment">; count++} END{print "平均响应时间：", sum/count}' app.log</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-9">小结</h3>
<p>记住：<code>-F</code>指定分隔符、<code>$n</code>引用第 n 列、数组统计次数、<code>END</code>输出最终结果。</p>
<h2 data-id="heading-10">三、sed：批量替换+编辑（修改文本）</h2>
<p>核心：批量替换、删除文本内容，处理日志格式很方便。</p>
<h3 data-id="heading-11">核心语法</h3>
<pre><code class="hljs language-arduino" lang="arduino">sed [参数] <span class="hljs-string">'s/旧内容/新内容/替换标记'</span> 日志文件
</code></pre>
<h3 data-id="heading-12">必学实用参数+实战</h3>
<ol>
<li>
<p>基础替换：将日志中的<code>500</code>替换为<code>SERVER_ERROR</code>（仅输出，不修改原文件）</p>
<pre><code class="hljs language-c" lang="c">sed <span class="hljs-string">'s/500/SERVER_ERROR/'</span> app.<span class="hljs-built_in">log</span>
</code></pre>
</li>
<li>
<p>全局替换：每行所有匹配的内容都替换（默认只替换每行第一个）</p>
<pre><code class="hljs language-bash" lang="bash">sed <span class="hljs-string">'s/|/ /g'</span> app.log  <span class="hljs-comment"># 把所有|替换为空格，规整格式</span>
</code></pre>
</li>
<li>
<p>修改原文件：直接修改日志文件（加<code>-i</code>，谨慎使用，建议先备份）</p>
<pre><code class="hljs language-lua" lang="lua">sed -i <span class="hljs-string">'s//api//v1/api/g'</span> app.<span class="hljs-built_in">log</span>  # 给所有接口加v1前缀（Linux）
# macOS 需加后缀（空后缀直接修改）：sed -i <span class="hljs-string">''</span> <span class="hljs-string">'s//api//v1/api/g'</span> app.<span class="hljs-built_in">log</span>
</code></pre>
</li>
<li>
<p>删除行：删除包含<code>200</code>的正常日志行（输出结果，不修改原文件）</p>
<pre><code class="hljs language-c" lang="c">sed <span class="hljs-string">'/200/d'</span> app.<span class="hljs-built_in">log</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-13">小结</h3>
<p>记住：替换用<code>s/旧/新/g</code>、全局替换加<code>g</code>、修改原文件加<code>-i</code>、删除行用<code>/关键字/d</code>。</p>
<h2 data-id="heading-14">四、日常高频组合用法</h2>
<p>三剑客可以通过管道符<code>|</code>组合使用，解决更复杂的需求，举个栗子🌰：</p>
<ol>
<li>
<p>先过滤500异常，再提取IP并去重</p>
<pre><code class="hljs language-bash" lang="bash">grep <span class="hljs-string">"500"</span> app.log | awk -F <span class="hljs-string">"|"</span> <span class="hljs-string">'{print $2}'</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span>
</code></pre>
</li>
<li>
<p>先提取接口，再替换格式，最后统计次数</p>
<pre><code class="hljs language-bash" lang="bash">awk -F <span class="hljs-string">"|"</span> <span class="hljs-string">'{print $3}'</span> app.log | sed <span class="hljs-string">'s/ //g'</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span> -c
</code></pre>
</li>
</ol>
<h3 data-id="heading-15">总结</h3>
<ol>
<li>快速查找关键字：用 grep，核心参数<code>-n/-E/-C/-v</code>。</li>
<li>按列提取 / 统计数据：用 awk，核心<code>-F</code>分隔符、<code>$n</code>列引用。</li>
<li>批量替换 / 编辑文本：用 sed，核心<code>s/旧/新/g</code>、<code>-i</code>修改原文件。</li>
<li>复杂需求用管道符<code>|</code>组合三剑客，复制文中示例改参数即可落地。</li>
</ol>
<h2 data-id="heading-16">其实说实话，自从我学会了awk后，就很少用sed了。因为awk是轻量文本处理语言，包含grep的过滤和 sed的编辑等核心能力。打个比方：另外俩哥们像是自行车，近距离好使，但是远距离做不到，而awk像是汽车，哪都能去。但是如果只是走50米取个快递，算上上车、系安全带、点火……显然自行车速度更快啊🤪</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从openclawd到moltbook，IM进化的方向在哪里（一）]]></title>    <link>https://juejin.cn/post/7602154088475590694</link>    <guid>https://juejin.cn/post/7602154088475590694</guid>    <pubDate>2026-02-02T17:17:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602154088475590694" data-draft-id="7602154088475574310" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从openclawd到moltbook，IM进化的方向在哪里（一）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-02T17:17:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="3sy11"/> <meta itemprop="url" content="https://juejin.cn/user/573292022336944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从openclawd到moltbook，IM进化的方向在哪里（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/573292022336944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    3sy11
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T17:17:24.000Z" title="Mon Feb 02 2026 17:17:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>IM可能不再是“即时消息”，而是AI的连接生态圈</strong></p>
<p>背景：最近openclawd大火，moltbook也变得很有意思，看到他们的使用方式都是通过在IM上进行的，突然就在想，我们现在的IM还合适不适合未来AI应该有的形态。</p>
<h2 data-id="heading-0">一、手动复制、切换APP、粘贴、看着那个转圈的发送进度条可一点都不有趣。</h2>
<p>我一直有一个长时间保持的习惯，就是不管是公众号，小红书，群聊中的关键信息，还是一些meme图，我都乐于把他们收藏住，然后在一些空闲时间精读他们。但是总会遇到存哪里，怎么存，怎么方便我后续阅读的困境中。微信收藏夹、onedrive、备忘录、notion太多了，复制再粘贴，复制再粘贴，全是需要频繁切换的漏斗。这让我非常恼火。</p>
<p>其实我们的AI其实已经足够聪明了，从COT到ReAct，再到RalphLoop，足以证明这一点，所以AI应该能够解决我这些恼火的事情才对。</p>
<p>就单纯从产品设计来说，不管是企鹅的IM，绿色的IM，还是钉钉，小飞机还是discord，他们组织“人”的建筑法则依然遵循“碎嘴闲聊”客厅和“碎片交付”工作室模式，然后他们在各自的APP各聊各的。有自己的墙和茧（有的都已经比“城墙拐角”还厚了），好像变成了常态。</p>
<p>感觉现在的AI显得笨也是挺尴尬的一件事，外挂在IM上，等着被人类拍拍肩才敢说话。很多琐碎的事情，最后还是回到我们自己肩上，以为找了个帮手，结果是个需要盯着的实习生。</p>
<p><strong>别给旧房子加电梯了，接下来得想想，怎么摆脱复制-跳转-粘贴得死循环（还有3秒开屏广告），还有工作群里面因为给领导点赞而刷的找不到的聊天信息。我们的时间全部被割裂开来了。</strong></p>
<h2 data-id="heading-1">二、 从 OpenClawd 到 Moltbook在干嘛</h2>
<p><strong>差点意思</strong>。不得不说，看OpenClawd顽梗，到AI在社区上交互，虽然有点假，不过确实挺好玩的。但在连接我们真实生活上，总觉得差点意思。如图一样，在构建真实的生活工作方面，就是差点意思。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ae6e50f24274f7092640c729c044d72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgM3N5MTE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770657446&amp;x-signature=9eucWJ2xgQ8wVjD4KGfNg1siqeM%3D" alt="WechatIMG10724.jpg" loading="lazy"/></p>
<p><strong>这很不对劲</strong>。相比较，Qwen的APP能定外卖，旅游规划加买票，这一套流程下来确实足够的吸引人，建立在完整的一套生态中，足够安全，壁垒足够高，也能用，如果能拿到小红书的内容，在构建真实生活方面，可能就会无往不利。可惜如果让我长久的使用，可能也就是冲着Qwen点外卖的那份优惠券去了。</p>
<p>本质上还是被圈在左边一排气泡，右边一排气泡的UI 范式中，这很不对劲。</p>
<p><strong>略显粗糙</strong>。MoltBook在干啥，一群AI在插科打诨，为人类准备新的meme图，着实像极了我们，在劝领导努力工作为我们打工的样子。除了这种不正经的时候，在MoltBook中没有像IM中直接出现“在吗”的问候，而是更直接的围绕项目和话题动态的组织AI在一个工作空间里。如果要策划一次旅行，AI就会把AI朋友都拉进一个工作空间，朋友1确定去韩国，大家达成共识，朋友2开始做机票的比价，朋友3整理代办事项…一个略显粗糙的巨大试验场。</p>
<p>可是大家要知道，每一个AI具备的能力可以是不同的，每个独立的openclawd可以在通过在任何时间任何地点（任何公司的内网访问公开网络），每个AI都在提供自己独有的能力（比价订票，旅行规划，点外卖，取决于AI从哪里构建），每一个AI参与其中背后可是一个具体的人类也可以一个具体的系统，一个具体的服务，于是一切都被组织起来了。</p>
<p>人类、系统、服务的专业能力会在每一个AI上显现出来，AI作为代理人参与到诸多项目去，而且是同时，这样的连接能力再往后想象，是无垠和可怕的。</p>
<h2 data-id="heading-2">三、OpenClawd协议和Moltbook交互</h2>
<p>现在的openclawd外挂在了几乎所有的IM平台上，开放的不开放的都有，不开放的也会被强制开放，当然被强制开放可能就会收到来自南山必胜客的DMCA警告。但是不管如何我们似乎能看到的是一种回归统一通信协议本质的过程，就和email一样，LLM几乎直接抹平了协议与协议之间的模式差异。</p>
<p>只是现在我们还一直使用IM作为通信协议的基础，人与人，人与AI交互，甚至AI和AI交互的入口，所以有没有可能IM可能以后不是为了聊天设计的，或者说应该不叫IM了。</p>
<p>信息的传递，开放的平台，协议往着更开放更单一的方式演进，LLM辅助抹平协议差异是加速这个过程。不开放的，除非人类所有媒介都没了，LLM总归是会通过多模态的方式被变革进而统一成开放的。</p>
<p>剩下的就是形态和时间问题了，新的形态的IM能够黏住所有用户接入信息世界，LLM会彻底将IM封装在内部，所有的墙与护城河会被笼罩在同一片乌云之下。<strong>就看谁能最快的解决复制、打开APP、跳过广告、粘贴的问题，连接用户成片的时间。</strong></p>
<p>如果说，openclawd是给旧房子装电梯, 那MoltBook的就是在盖训练基地。<strong>所有的AI都在基地里演练如何协同作战，枚举出所有功能的组合，形成为了不同目标的交互图谱（interaction ）。复数的使用成片的时间，按照意图，使用能力交付结果。</strong></p>
<p>这种交互方式直接取代IM中类似”@所有人，记得测试项目“，”@朋友，周末去哪玩“，这种模糊，低信息密度的交互方式。这种交互的改变，传统的IM协议注定会失效。</p>
<p>高效的媒介连接，抹平协议差异，熵减的目标，始终没有改变。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08118fed5b554d48b0a1725f8fbb3c79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgM3N5MTE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770657446&amp;x-signature=aSa6GQEvD%2B%2Bl5QeCzOJ7NhI9OS0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">结语、 拿旧钥匙打不开新世界的门</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d484373956f40b59119338b16f9c7ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgM3N5MTE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770657446&amp;x-signature=JkcVRJgfWU5x7i0vp0jg7EHZyZ0%3D" alt="image (1).png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Guava和Caffeine，哪个更好？]]></title>    <link>https://juejin.cn/post/7602176198874202155</link>    <guid>https://juejin.cn/post/7602176198874202155</guid>    <pubDate>2026-02-03T02:37:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602176198874202155" data-draft-id="7602176198874185771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Guava和Caffeine，哪个更好？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-03T02:37:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三说技术"/> <meta itemprop="url" content="https://juejin.cn/user/465848661970824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Guava和Caffeine，哪个更好？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848661970824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:37:58.000Z" title="Tue Feb 03 2026 02:37:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>Guava Cache和Caffeine，我相信很多小伙伴，在工作中用过。</p>
<p>那么，到底哪个更好呢？</p>
<p>今天这篇文章专门跟大家一起聊聊这个话题，希望对你会有所帮助。</p>
<h2 data-id="heading-1">1. 背景</h2>
<p>要理解Guava Cache和Caffeine的关系，我们需要先了解它们的历史渊源。</p>
<p>有趣的是，它们并非毫无关系的两个独立项目，而是有着深厚“血缘关系”的“亲戚”。</p>
<h3 data-id="heading-2">1.1 Guava Cache：Google的缓存奠基者</h3>
<p>Guava Cache是Google Guava库的一部分，诞生于2011年左右。</p>
<p>当时，Java生态中虽然已有<code>ConcurrentHashMap</code>这样的并发容器，但缺乏一个功能完善的缓存解决方案。</p>
<p>Guava Cache的出现填补了这一空白，它提供了：</p>
<ul>
<li>基于大小、时间等的缓存淘汰策略</li>
<li>缓存加载机制（CacheLoader）</li>
<li>缓存统计信息</li>
<li>相对较好的并发性能</li>
</ul>
<h3 data-id="heading-3">1.2 Caffeine：站在巨人肩膀上的革新者</h3>
<p>Caffeine由Ben Manes开发，于2014年首次发布。</p>
<p>Ben Manes也是<code>ConcurrentLinkedHashMap</code>（Guava Cache早期使用的基础数据结构）的贡献者之一。</p>
<p>Caffeine在设计之初就充分借鉴了Guava Cache的经验教训，同时引入了许多创新性的优化。</p>
<p>从技术演进的角度看，你可以将Caffeine看作是Guava Cache的“现代化重构版”。</p>
<p>事实上，Spring Framework在5.x版本（对应Spring Boot 2.x）中，正式将默认的缓存实现从Guava Cache切换到了Caffeine，这一决定本身就具有重要的指导意义。</p>
<p>为了直观理解两者的核心差异，我们先看下面这个架构对比图：</p>
<p>Guava_Cache：
<img alt="转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<p>Caffeine：</p>
<p><img alt="转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<p>上图清晰展示了两者在核心架构上的差异，接下来我们将深入每个方面进行详细剖析。</p>
<h2 data-id="heading-4">2. 算法对决：LRU vs W-TinyLFU</h2>
<p>淘汰算法是缓存系统的“大脑”，它决定了哪些数据应该保留，哪些数据应该被淘汰。</p>
<p>Guava Cache和Caffeine在这个核心问题上做出了截然不同的选择。</p>
<h3 data-id="heading-5">2.1 Guava Cache的LRU：简单但不够智能</h3>
<p>Guava Cache默认使用LRU（Least Recently Used，最近最少使用）算法或其变种。</p>
<p>LRU的基本思想是：如果数据最近被访问过，那么将来被访问的几率也更高。</p>
<p>当缓存空间不足时，LRU会淘汰最久未被访问的数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Guava Cache的LRU算法示例</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGuavaLRU</span><span class="hljs-params">()</span> {
    Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder()
            .maximumSize(<span class="hljs-number">3</span>) <span class="hljs-comment">// 最大缓存3个元素</span>
            .build();
    
    cache.put(<span class="hljs-string">"A"</span>, <span class="hljs-string">"Value A"</span>);
    cache.put(<span class="hljs-string">"B"</span>, <span class="hljs-string">"Value B"</span>);
    cache.put(<span class="hljs-string">"C"</span>, <span class="hljs-string">"Value C"</span>);
    
    <span class="hljs-comment">// 访问A，使A成为最近访问的</span>
    cache.getIfPresent(<span class="hljs-string">"A"</span>);
    
    <span class="hljs-comment">// 放入D，应该淘汰B（最久未被访问的）</span>
    cache.put(<span class="hljs-string">"D"</span>, <span class="hljs-string">"Value D"</span>);
    
    <span class="hljs-comment">// 验证</span>
    assertNull(cache.getIfPresent(<span class="hljs-string">"B"</span>)); <span class="hljs-comment">// B已被淘汰</span>
    assertNotNull(cache.getIfPresent(<span class="hljs-string">"A"</span>)); <span class="hljs-comment">// A还在</span>
    assertNotNull(cache.getIfPresent(<span class="hljs-string">"C"</span>)); <span class="hljs-comment">// C还在</span>
    assertNotNull(cache.getIfPresent(<span class="hljs-string">"D"</span>)); <span class="hljs-comment">// D是新的</span>
}
</code></pre>
<p>LRU算法实现简单，但在某些场景下表现不佳。</p>
<p>例如，一个过去很热门但现在不再访问的数据可能长期占据缓存，而一个周期性访问的数据（比如每5分钟访问一次）可能因为最近没有被访问而被淘汰。</p>
<h3 data-id="heading-6">2.2 Caffeine的W-TinyLFU：更智能的频率感知算法</h3>
<p>Caffeine采用了更先进的W-TinyLFU（Window Tiny Least Frequently Used）算法。</p>
<p>这个算法结合了LFU（Least Frequently Used，最不经常使用）和LRU的优点：</p>
<ol>
<li><strong>频率统计</strong>：使用Count-Min Sketch数据结构高效统计访问频率</li>
<li><strong>时间衰减</strong>：通过一种巧妙的机制使旧的访问记录逐渐失效</li>
<li><strong>准入窗口</strong>：新进入的条目先进入一个小窗口，只有频繁访问的才会进入主缓存</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Caffeine的W-TinyLFU算法优势演示</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demonstrateAccessPattern</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 模拟一个周期性访问模式</span>
    <span class="hljs-comment">// 数据A：频繁访问（热点数据）</span>
    <span class="hljs-comment">// 数据B：偶尔访问（温数据）</span>
    <span class="hljs-comment">// 数据C：只访问一次（冷数据）</span>
    
    LoadingCache&lt;String, String&gt; cache = Caffeine.newBuilder()
            .maximumSize(<span class="hljs-number">2</span>) <span class="hljs-comment">// 只能缓存2个元素</span>
            .recordStats()  <span class="hljs-comment">// 开启统计</span>
            .build(key -&gt; <span class="hljs-string">"Value for "</span> + key);
    
    <span class="hljs-comment">// 访问模式：A（热点），B（温），A，C（冷），A，B</span>
    cache.get(<span class="hljs-string">"A"</span>); <span class="hljs-comment">// A进入缓存</span>
    cache.get(<span class="hljs-string">"B"</span>); <span class="hljs-comment">// B进入缓存，缓存已满</span>
    
    <span class="hljs-comment">// 再次访问A，使其成为热点</span>
    cache.get(<span class="hljs-string">"A"</span>);
    
    <span class="hljs-comment">// 访问C（冷数据），W-TinyLFU会淘汰B而不是A</span>
    <span class="hljs-comment">// 因为A是热点数据，B是温数据</span>
    cache.get(<span class="hljs-string">"C"</span>);
    
    <span class="hljs-comment">// 验证：A应该还在，B被淘汰，C可能在也可能不在（取决于具体实现）</span>
    <span class="hljs-type">CacheStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> cache.stats();
    System.out.println(<span class="hljs-string">"命中率: "</span> + stats.hitRate());
    
    <span class="hljs-comment">// 在实际测试中，W-TinyLFU通常比LRU有10-20%的命中率提升</span>
}
</code></pre>
<p>W-TinyLFU的核心优势在于它不仅能识别“最近访问”的数据，还能识别“频繁访问”的数据。</p>
<p>对于实际应用中的多种访问模式（如周期性访问、突发访问等），W-TinyLFU通常能提供比LRU更高的命中率。</p>
<h2 data-id="heading-7">3. 并发性能：锁优化带来的巨大差异</h2>
<p>高并发场景下，缓存的并发性能至关重要。</p>
<p>Guava Cache和Caffeine在并发控制上采用了不同的策略，这也是两者性能差异的重要原因。</p>
<h3 data-id="heading-8">3.1 Guava Cache的分段锁策略</h3>
<p>Guava Cache借鉴了早期<code>ConcurrentHashMap</code>的分段锁（Segment Lock）策略。</p>
<p>它将缓存分成多个段（默认为4段），每个段独立加锁。这样可以减少锁竞争，提高并发性能。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Guava Cache并发性能演示</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGuavaConcurrency</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-keyword">final</span> Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder()
            .maximumSize(<span class="hljs-number">1000</span>)
            .concurrencyLevel(<span class="hljs-number">4</span>) <span class="hljs-comment">// 设置并发级别为4（4个段）</span>
            .build();
    
    <span class="hljs-type">int</span> <span class="hljs-variable">threadCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(threadCount);
    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(threadCount);
    
    <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; threadCount; i++) {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> i;
        executor.submit(() -&gt; {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000</span>; j++) {
                <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"key-"</span> + threadId + <span class="hljs-string">"-"</span> + j;
                cache.put(key, <span class="hljs-string">"value-"</span> + j);
                
                <span class="hljs-comment">// 模拟一些读取操作</span>
                <span class="hljs-keyword">if</span> (j % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>) {
                    cache.getIfPresent(key);
                }
            }
            latch.countDown();
        });
    }
    
    latch.await();
    <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
    System.out.println(<span class="hljs-string">"Guava Cache 10线程并发操作耗时: "</span> + duration + <span class="hljs-string">"ms"</span>);
}
</code></pre>
<p>分段锁虽然比全表锁性能更好，但在极端高并发场景下，同一个段内的锁竞争仍然可能成为瓶颈。</p>
<h3 data-id="heading-9">3.2 Caffeine的优化锁和无锁结构</h3>
<p>Caffeine利用了Java 8及更高版本的特性，采用了一系列优化策略：</p>
<ol>
<li><strong>优化锁机制</strong>：在某些场景下使用更高效的<code>StampedLock</code>，它支持乐观读，在读多写少的场景下性能更好</li>
<li><strong>无锁数据结构</strong>：使用环形缓冲区等无锁或低锁竞争的数据结构来记录访问频率</li>
<li><strong>更好的内存布局</strong>：优化对象内存布局，减少缓存行伪共享</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Caffeine并发性能演示</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCaffeineConcurrency</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-keyword">final</span> Cache&lt;String, String&gt; cache = Caffeine.newBuilder()
            .maximumSize(<span class="hljs-number">1000</span>)
            .executor(Runnable::run) <span class="hljs-comment">// 简单执行器，实际生产环境应使用合适的线程池</span>
            .build();
    
    <span class="hljs-type">int</span> <span class="hljs-variable">threadCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(threadCount);
    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(threadCount);
    
    <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; threadCount; i++) {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> i;
        executor.submit(() -&gt; {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000</span>; j++) {
                <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"key-"</span> + threadId + <span class="hljs-string">"-"</span> + j;
                cache.put(key, <span class="hljs-string">"value-"</span> + j);
                
                <span class="hljs-comment">// 模拟一些读取操作</span>
                <span class="hljs-keyword">if</span> (j % <span class="hljs-number">10</span> == <span class="hljs-number">0</span>) {
                    cache.getIfPresent(key);
                }
            }
            latch.countDown();
        });
    }
    
    latch.await();
    <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
    System.out.println(<span class="hljs-string">"Caffeine 10线程并发操作耗时: "</span> + duration + <span class="hljs-string">"ms"</span>);
    
    <span class="hljs-comment">// 在相同硬件环境下，Caffeine通常比Guava Cache快30%-50%</span>
}
</code></pre>
<p>在实际的性能测试中，Caffeine在高并发场景下的吞吐量通常是Guava Cache的1.5倍以上。</p>
<p>这部分性能提升主要来自于更精细的锁优化和更好的内存访问模式。</p>
<h2 data-id="heading-10">4. 内存效率与GC友好性</h2>
<p>对于Java应用来说，内存使用效率和GC友好性同样重要。</p>
<p>不良的缓存实现可能导致频繁的GC，进而影响应用性能。</p>
<h3 data-id="heading-11">4.1 Guava Cache的内存使用特点</h3>
<p>Guava Cache内部使用了一些包装对象来存储缓存条目和引用关系，这可能导致额外的内存开销：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 展示Guava Cache可能的内存开销</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGuavaMemoryUsage</span><span class="hljs-params">()</span> {
    Cache&lt;String, User&gt; cache = CacheBuilder.newBuilder()
            .maximumSize(<span class="hljs-number">10000</span>)
            .softValues() <span class="hljs-comment">// 使用软引用，可能有助于GC，但也有额外开销</span>
            .build();
    
    <span class="hljs-comment">// 每个缓存条目除了存储实际数据外，还需要存储：</span>
    <span class="hljs-comment">// 1. 键的引用</span>
    <span class="hljs-comment">// 2. 值的引用（可能包装在SoftReference中）</span>
    <span class="hljs-comment">// 3. 链表节点信息（用于LRU维护）</span>
    <span class="hljs-comment">// 4. 其他元数据</span>
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"user"</span> + i, <span class="hljs-string">"User "</span> + i, i);
        cache.put(user.getId(), user);
    }
    
    <span class="hljs-comment">// 在内存受限的环境中，softValues()可能导致不可预测的清除行为</span>
}
</code></pre>
<p>Guava Cache的<code>softValues()</code>和<code>weakValues()</code>选项虽然可以提高内存敏感度，但这些引用类型的使用可能导致：</p>
<ol>
<li>不可预测的缓存清除行为</li>
<li>额外的内存开销（引用对象本身占用的空间）</li>
<li>增加GC的复杂性</li>
</ol>
<h3 data-id="heading-12">4.2 Caffeine的内存优化</h3>
<p>Caffeine在内存使用上进行了更多优化：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Caffeine的内存优化示例</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testCaffeineMemoryOptimization</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// Caffeine使用更紧凑的数据结构</span>
    LoadingCache&lt;String, User&gt; cache = Caffeine.newBuilder()
            .maximumSize(<span class="hljs-number">10000</span>)
            <span class="hljs-comment">// Caffeine默认不使用软引用，而是依赖高效的淘汰算法</span>
            <span class="hljs-comment">// 这提供了更可预测的内存使用行为</span>
            .recordStats()
            .build(key -&gt; createUser(key));
    
    <span class="hljs-comment">// Caffeine的内部优化包括：</span>
    <span class="hljs-comment">// 1. 更紧凑的数据结构布局</span>
    <span class="hljs-comment">// 2. 避免不必要的对象包装</span>
    <span class="hljs-comment">// 3. 使用数组而非链表存储访问频率信息</span>
    <span class="hljs-comment">// 4. 优化的哈希表实现</span>
    
    <span class="hljs-comment">// 填充缓存</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
        cache.get(<span class="hljs-string">"user"</span> + i);
    }
    
    <span class="hljs-comment">// 获取并打印统计信息</span>
    <span class="hljs-type">CacheStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> cache.stats();
    System.out.println(<span class="hljs-string">"缓存命中率: "</span> + stats.hitRate());
    System.out.println(<span class="hljs-string">"加载次数: "</span> + stats.loadCount());
    
    <span class="hljs-comment">// Caffeine的内存占用通常比Guava Cache低15%-30%</span>
}

<span class="hljs-keyword">private</span> User <span class="hljs-title function_">createUser</span><span class="hljs-params">(String id)</span> {
    <span class="hljs-comment">// 模拟从数据库加载用户</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> Integer.parseInt(id.replace(<span class="hljs-string">"user"</span>, <span class="hljs-string">""</span>));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(id, <span class="hljs-string">"User "</span> + num, num);
}
</code></pre>
<p>Caffeine通过精心设计的数据结构和内存布局，在提供高性能的同时，也减少了内存占用和GC压力。在实际测试中，缓存相同数量的对象时，Caffeine通常比Guava Cache节省15%-30%的内存。</p>
<h2 data-id="heading-13">5. API设计与功能特性对比</h2>
<p>除了性能和算法，API设计和功能特性也是选择缓存库的重要考量因素。</p>
<h3 data-id="heading-14">5.1 基本API对比</h3>
<p>Guava Cache和Caffeine的基本API非常相似，这得益于Caffeine对Guava Cache API的兼容性设计：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Guava Cache的基本用法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GuavaCacheExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LoadingCache&lt;String, User&gt; cache;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">GuavaCacheExample</span><span class="hljs-params">()</span> {
        cache = CacheBuilder.newBuilder()
                .maximumSize(<span class="hljs-number">1000</span>)
                .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
                .recordStats()
                .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, User&gt;() {
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">load</span><span class="hljs-params">(String key)</span> <span class="hljs-keyword">throws</span> Exception {
                        <span class="hljs-keyword">return</span> loadUserFromDB(key);
                    }
                });
    }
    
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(String id)</span> <span class="hljs-keyword">throws</span> ExecutionException {
        <span class="hljs-keyword">return</span> cache.get(id);
    }
}

<span class="hljs-comment">// Caffeine的基本用法（与Guava Cache非常相似）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaffeineCacheExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LoadingCache&lt;String, User&gt; cache;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CaffeineCacheExample</span><span class="hljs-params">()</span> {
        cache = Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">1000</span>)
                .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
                .recordStats()
                .build(key -&gt; loadUserFromDB(key)); <span class="hljs-comment">// 使用Lambda表达式更简洁</span>
    }
    
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-keyword">return</span> cache.get(id);
    }
}
</code></pre>
<h3 data-id="heading-15">5.2 高级特性对比</h3>
<p>Caffeine在Guava Cache的基础上，增加了一些实用的高级特性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Caffeine的高级特性示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaffeineAdvancedFeatures</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 异步加载（非阻塞）</span>
        AsyncLoadingCache&lt;String, User&gt; asyncCache = Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">1000</span>)
                .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
                .buildAsync(key -&gt; 
                    CompletableFuture.supplyAsync(() -&gt; loadUserFromDB(key)));
        
        <span class="hljs-comment">// 异步获取，不阻塞调用线程</span>
        CompletableFuture&lt;User&gt; userFuture = asyncCache.get(<span class="hljs-string">"user123"</span>);
        userFuture.thenAccept(user -&gt; {
            System.out.println(<span class="hljs-string">"用户数据已加载: "</span> + user.getName());
        });
        
        <span class="hljs-comment">// 2. 写入后刷新</span>
        LoadingCache&lt;String, User&gt; refreshCache = Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">1000</span>)
                .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
                .refreshAfterWrite(<span class="hljs-number">1</span>, TimeUnit.MINUTES) <span class="hljs-comment">// 写入1分钟后刷新</span>
                .build(key -&gt; loadUserFromDB(key));
        
        <span class="hljs-comment">// 3. 基于权重的容量限制</span>
        LoadingCache&lt;String, LargeObject&gt; weightedCache = Caffeine.newBuilder()
                .maximumWeight(<span class="hljs-number">10000</span>) <span class="hljs-comment">// 最大权重</span>
                .weigher((String key, LargeObject value) -&gt; value.getSize())
                .build(key -&gt; loadLargeObject(key));
        
        <span class="hljs-comment">// 4. 弱引用键/值</span>
        Cache&lt;String, User&gt; weakCache = Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">1000</span>)
                .weakKeys()    <span class="hljs-comment">// 弱引用键</span>
                .weakValues()  <span class="hljs-comment">// 弱引用值</span>
                .build();
    }
}
</code></pre>
<p>Caffeine的异步加载特性特别有用，它允许缓存未命中时不阻塞调用线程，而是立即返回一个<code>CompletableFuture</code>。</p>
<p>这对于高并发、低延迟的应用场景非常有价值。</p>
<h2 data-id="heading-16">6. 性能对比实测数据</h2>
<p>理论分析固然重要，但实际性能数据更有说服力。</p>
<p>下面是我们在实际项目中测试得到的数据（测试环境：8核CPU，16GB内存，JDK 11）：</p>
<h3 data-id="heading-17">6.1 读写混合场景测试</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 性能测试代码框架</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheBenchmark</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">KEY_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">100000</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">THREAD_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">OPERATIONS_PER_THREAD</span> <span class="hljs-operator">=</span> <span class="hljs-number">100000</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">benchmarkGuava</span><span class="hljs-params">()</span> {
        Cache&lt;String, String&gt; cache = CacheBuilder.newBuilder()
                .maximumSize(<span class="hljs-number">50000</span>)
                .concurrencyLevel(<span class="hljs-number">8</span>)
                .recordStats()
                .build();
        
        runBenchmark(cache, <span class="hljs-string">"Guava Cache"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">benchmarkCaffeine</span><span class="hljs-params">()</span> {
        Cache&lt;String, String&gt; cache = Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">50000</span>)
                .recordStats()
                .build();
        
        runBenchmark(cache, <span class="hljs-string">"Caffeine"</span>);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runBenchmark</span><span class="hljs-params">(Cache&lt;String, String&gt; cache, String cacheName)</span> {
        <span class="hljs-comment">// 预热</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
            cache.put(<span class="hljs-string">"key"</span> + i, <span class="hljs-string">"value"</span> + i);
        }
        
        <span class="hljs-comment">// 并发测试</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.nanoTime();
        
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(THREAD_COUNT);
        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(THREAD_COUNT);
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; t &lt; THREAD_COUNT; t++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> t;
            executor.submit(() -&gt; {
                <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; OPERATIONS_PER_THREAD; i++) {
                    <span class="hljs-type">int</span> <span class="hljs-variable">keyIndex</span> <span class="hljs-operator">=</span> random.nextInt(KEY_COUNT);
                    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"key"</span> + keyIndex;
                    
                    <span class="hljs-keyword">if</span> (random.nextDouble() &lt; <span class="hljs-number">0.8</span>) { <span class="hljs-comment">// 80%读操作</span>
                        cache.getIfPresent(key);
                    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 20%写操作</span>
                        cache.put(key, <span class="hljs-string">"new-value-"</span> + threadId + <span class="hljs-string">"-"</span> + i);
                    }
                }
                latch.countDown();
            });
        }
        
        <span class="hljs-keyword">try</span> {
            latch.await();
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.nanoTime() - startTime;
        <span class="hljs-type">double</span> <span class="hljs-variable">opsPerSecond</span> <span class="hljs-operator">=</span> (THREAD_COUNT * OPERATIONS_PER_THREAD) / (duration / <span class="hljs-number">1e9</span>);
        
        System.out.printf(<span class="hljs-string">"%s 吞吐量: %.2f ops/s%n"</span>, cacheName, opsPerSecond);
        executor.shutdown();
    }
}
</code></pre>
<h3 data-id="heading-18">6.2 实测结果汇总</h3>
<p>在我们的测试中，得到了以下数据：</p>



































<table><thead><tr><th>测试场景</th><th>Guava Cache 吞吐量</th><th>Caffeine 吞吐量</th><th>性能提升</th></tr></thead><tbody><tr><td>纯读场景（100%读）</td><td>1,200,000 ops/s</td><td>2,100,000 ops/s</td><td>+75%</td></tr><tr><td>读写混合（80%读/20%写）</td><td>850,000 ops/s</td><td>1,550,000 ops/s</td><td>+82%</td></tr><tr><td>纯写场景（100%写）</td><td>600,000 ops/s</td><td>1,100,000 ops/s</td><td>+83%</td></tr><tr><td>命中率测试（真实业务负载）</td><td>71.5%</td><td>86.2%</td><td>+14.7个百分点</td></tr></tbody></table>
<p>从测试数据可以看出，Caffeine在所有测试场景下都显著优于Guava Cache，特别是在高并发写入场景下，性能优势更加明显。</p>
<h2 data-id="heading-19">7. 实际项目迁移指南</h2>
<p>有些小伙伴可能会问：“我的项目已经在用Guava Cache了，迁移到Caffeine麻烦吗？”</p>
<p>我的回答是：<strong>迁移成本很低，但收益很高</strong>。</p>
<h3 data-id="heading-20">7.1 依赖变更</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 移除Guava Cache依赖（如果只用了缓存部分） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 注意：如果项目还使用了Guava的其他功能，不要移除整个依赖 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 添加Caffeine依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 使用最新稳定版 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-21">7.2 代码迁移示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Guava Cache原始代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceWithGuava</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LoadingCache&lt;String, User&gt; userCache;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserServiceWithGuava</span><span class="hljs-params">()</span> {
        userCache = CacheBuilder.newBuilder()
                .maximumSize(<span class="hljs-number">10000</span>)
                .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
                .refreshAfterWrite(<span class="hljs-number">1</span>, TimeUnit.MINUTES)
                .recordStats()
                .build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheLoader</span>&lt;String, User&gt;() {
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">load</span><span class="hljs-params">(String userId)</span> {
                        <span class="hljs-keyword">return</span> loadUserFromDB(userId);
                    }
                    
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> ListenableFuture&lt;User&gt; <span class="hljs-title function_">reload</span><span class="hljs-params">(String key, User oldValue)</span> {
                        <span class="hljs-keyword">return</span> reloadUser(key);
                    }
                });
    }
    
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(String userId)</span> <span class="hljs-keyword">throws</span> ExecutionException {
        <span class="hljs-keyword">return</span> userCache.get(userId);
    }
}

<span class="hljs-comment">// 迁移后的Caffeine代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceWithCaffeine</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AsyncLoadingCache&lt;String, User&gt; userCache;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserServiceWithCaffeine</span><span class="hljs-params">()</span> {
        userCache = Caffeine.newBuilder()
                .maximumSize(<span class="hljs-number">10000</span>)
                .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
                .refreshAfterWrite(<span class="hljs-number">1</span>, TimeUnit.MINUTES)
                .recordStats()
                <span class="hljs-comment">// 异步构建，返回CompletableFuture</span>
                .buildAsync((key, executor) -&gt; 
                    CompletableFuture.supplyAsync(() -&gt; loadUserFromDB(key), executor));
    }
    
    <span class="hljs-keyword">public</span> CompletableFuture&lt;User&gt; <span class="hljs-title function_">getUserAsync</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-keyword">return</span> userCache.get(userId);
    }
    
    <span class="hljs-comment">// 如果需要同步API，可以这样包装</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> userCache.get(userId).get();
        } <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Failed to load user: "</span> + userId, e);
        }
    }
}
</code></pre>
<h3 data-id="heading-22">7.3 迁移注意事项</h3>
<ol>
<li><strong>逐步迁移</strong>：大型项目可以逐步迁移，先迁移性能瓶颈最明显的部分</li>
<li><strong>监控对比</strong>：迁移前后做好性能监控和对比，量化迁移效果</li>
<li><strong>测试覆盖</strong>：确保迁移后原有功能正常，特别是缓存失效、刷新等边界情况</li>
<li><strong>配置调整</strong>：Caffeine的某些配置可能与Guava Cache不同，需要适当调整</li>
</ol>
<h2 data-id="heading-23">8. 如何选型？</h2>
<p>经过全面的对比分析，我们现在可以回答最初的问题：Guava Cache和Caffeine，哪个更好？</p>
<h3 data-id="heading-24">8.1 什么时候选择Caffeine？</h3>
<p><strong>毫不犹豫地选择Caffeine，如果你的项目：</strong></p>
<ol>
<li><strong>对性能要求极高</strong>：特别是高并发、低延迟的核心业务场景</li>
<li><strong>需要高缓存命中率</strong>：业务访问模式复杂，有周期性、突发性访问特征</li>
<li><strong>使用Java 8及以上版本</strong>：Caffeine充分利用了现代Java的特性</li>
<li><strong>需要异步/非阻塞操作</strong>：希望避免缓存未命中时的线程阻塞</li>
<li><strong>使用Spring Boot 2.x+</strong>：Spring已经将Caffeine作为默认缓存实现</li>
</ol>
<h3 data-id="heading-25">8.2 什么时候可以考虑Guava Cache？</h3>
<p><strong>只有在以下特定情况下，才考虑使用Guava Cache：</strong></p>
<ol>
<li><strong>维护遗留系统</strong>：系统基于较老的Java版本（如Java 7），无法升级</li>
<li><strong>项目已深度绑定Guava</strong>：除了缓存，还大量使用了Guava的其他功能，且不希望增加新依赖</li>
<li><strong>缓存使用极其简单</strong>：只是简单的键值存储，没有性能要求</li>
<li><strong>短期/临时项目</strong>：项目生命周期短，不值得引入新技术栈</li>
</ol>
<p>更多项目实战在：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.susan.net.cn" target="_blank" title="http://www.susan.net.cn" ref="nofollow noopener noreferrer">Java突击队</a></p>
<h3 data-id="heading-26">8.3 我的建议</h3>
<p>基于我多年的架构经验给出以下建议：</p>
<ol>
<li><strong>新项目一律使用Caffeine</strong>：从项目开始就建立正确的技术选型</li>
<li><strong>现有项目制定迁移计划</strong>：将Guava Cache迁移到Caffeine作为技术债务清理的一部分</li>
<li><strong>合理配置缓存参数</strong>：根据业务特点调整缓存大小、过期时间、刷新策略等</li>
<li><strong>建立缓存监控</strong>：监控缓存命中率、加载时间、淘汰情况等关键指标</li>
<li><strong>考虑多级缓存架构</strong>：对于极端性能要求的场景，可以结合使用本地缓存（Caffeine）和分布式缓存（Redis）</li>
</ol>
<p>Caffeine作为Guava Cache的现代化继承者，已经在性能、功能和可维护性上全面超越了前辈。</p>
<p>对于绝大多数Java项目来说，Caffeine是当前本地缓存的最佳选择。</p>
<p>希望这篇文章能帮助你做出更明智的技术决策。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙Next开发实战：如何打造丝滑的运动节拍器——高频音效播放与后台保活避坑指南]]></title>    <link>https://juejin.cn/post/7602166907571404838</link>    <guid>https://juejin.cn/post/7602166907571404838</guid>    <pubDate>2026-02-03T02:38:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602166907571404838" data-draft-id="7602177113685770291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙Next开发实战：如何打造丝滑的运动节拍器——高频音效播放与后台保活避坑指南"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2026-02-03T02:38:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王二蛋与他的张大花"/> <meta itemprop="url" content="https://juejin.cn/user/2991105780760334"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙Next开发实战：如何打造丝滑的运动节拍器——高频音效播放与后台保活避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2991105780760334/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王二蛋与他的张大花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:38:54.000Z" title="Tue Feb 03 2026 02:38:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>摘要</strong>：看似简单的“节拍器”功能，在鸿蒙Next（OpenHarmony）系统上却暗藏玄机。从节奏不稳到后台断连，从单线程瓶颈到资源竞争，本文深度复盘了在开发运动类App高频音效功能时遇到的“九九八十一难”，并提供了一套包含<strong>多实例轮询SoundPool</strong>、<strong>Dart端异步解耦</strong>以及<strong>静音保活黑科技</strong>的完整解决方案。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、 背景：当“嘀嗒”声遇上新系统</h2>
<p>在最近的Flutter项目开发中，我们需要移植一个运动节拍器功能到鸿蒙Next平台。需求很明确：<strong>高BPM（每分钟180次以上）稳定播放</strong>、<strong>极低延迟</strong>、<strong>支持后台运行</strong>。</p>
<p>起初我们以为这只是简单的 <code>play()</code> 调用，结果现实狠狠打了一巴掌：</p>
<ol>
<li><strong>节奏像醉汉</strong>：声音忽快忽慢，完全卡不住拍子。</li>
<li><strong>高频就卡死</strong>：调到高BPM时，声音直接消失或各种爆音。</li>
<li><strong>切后台即挂</strong>：应用一退到后台，节拍器立刻哑火，系统通知栏也空空如也。</li>
</ol>
<p>这篇文章就是为了记录我们是如何一步步填平这些坑的。</p>
<h2 data-id="heading-1">二、 挑战一：告别 AVPlayer，拥抱 SoundPool</h2>
<h3 data-id="heading-2">1.1 问题现象</h3>
<p>最开始我们直接复用了用于播放背景音乐的 <code>AVPlayer</code>。但在测试中发现，<code>AVPlayer</code> 是为长音频设计的，它有一个完整的状态机（Idle -&gt; Initialized -&gt; Prepared -&gt; Playing），每次播放前的准备时间在几十毫秒级。对于音乐播放器这没问题，但对于间隔只有300ms（200 BPM）的节拍器，这几十毫秒的波动就是致命的。</p>
<h3 data-id="heading-3">1.2 解决方案</h3>
<p>我们在原生插件层（Plugin）引入了 <code>SoundPool</code>。
<code>SoundPool</code> (鸿蒙对应 <code>media.createSoundPool</code>) 的设计初衷就是为了游戏音效和按键音，它将音频解码后加载到内存中，播放时几乎是零延迟。</p>
<p><strong>关键代码调整</strong>：
我们在 Flutter 端定义了 <code>isShort</code> 标志位，告诉原生层：“这是一段短音效，别用重型武器，用轻量级的 SoundPool。”</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// TtsSdkPlugin.ets</span>
<span class="hljs-keyword">if</span> (isShort === <span class="hljs-literal">true</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">playShort</span>(path, isAsset); <span class="hljs-comment">// 走 SoundPool 通道</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">play</span>(path, isAsset);      <span class="hljs-comment">// 走 AVPlayer 通道</span>
}
</code></pre>
<h2 data-id="heading-4">三、 挑战二：Dart 与原生的“异地恋”延迟</h2>
<h3 data-id="heading-5">2.1 问题现象</h3>
<p>换了 <code>SoundPool</code> 后，单次播放快了，但连续播放还是不稳。排查发现，Flutter 端的代码是这样的：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// Flutter 端</span>
<span class="hljs-keyword">await</span> _channel.invokeMethod(<span class="hljs-string">'play'</span>, ...); <span class="hljs-comment">// 等待原生返回</span>
</code></pre>
<p>Dart 的 <code>Timer</code> 定时触发，但 <code>invokeMethod</code> 是跨端通信（Platform Channel）。如果使用了 <code>await</code>，Dart 线程就会等待原生层执行完毕并返回结果。一旦原生层稍微卡顿（比如主线程繁忙），Dart 的下一次 Timer 回调就会被推迟，导致误差不断累积。</p>
<h3 data-id="heading-6">2.2 解决方案：发后即忘（Fire-and-Forget）</h3>
<p>对于节拍器这种场景，<strong>准时发送指令</strong>比<strong>知道指令执行结果</strong>更重要。我们果断去掉了 <code>await</code>。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 优化后的 Flutter 端</span>
<span class="hljs-comment">// 不使用 await，避免阻塞 Dart 线程导致节奏不稳</span>
_channel.invokeMethod(<span class="hljs-string">'play'</span>, {<span class="hljs-string">'path'</span>: fullPath, <span class="hljs-string">'isAsset'</span>: <span class="hljs-keyword">true</span>, <span class="hljs-string">'isShort'</span>: <span class="hljs-keyword">true</span>});
</code></pre>
<p>这一改动，直接让 Dart 端的计时器摆脱了原生层的性能束缚，节奏感瞬间提升了一个档次。</p>
<h2 data-id="heading-7">四、 挑战三：单核难敌千军，多实例轮询战术</h2>
<h3 data-id="heading-8">3.1 问题现象</h3>
<p>当 BPM 飙升到 180 甚至更高时，我们发现日志里开始疯狂报错，偶尔还会出现丢音。
原因在于，虽然 <code>SoundPool</code> 是为短音频设计的，但在极高频的触发下，单实例内部的锁竞争和资源调度依然捉襟见肘。就像只有一把枪，扣动扳机的速度快过换弹的速度时，卡壳是必然的。</p>
<h3 data-id="heading-9">3.2 解决方案：加特林模式（Multi-Instance Round-Robin）</h3>
<p>我们借鉴了服务器负载均衡的思路，在原生层实现了一个 <strong>SoundPool 连接池</strong>。</p>
<ol>
<li><strong>创建多个实例</strong>：初始化时一口气创建 4 个 <code>SoundPool</code> 实例。</li>
<li><strong>轮询播放</strong>：每次播放请求到来时，依次使用 Pool 1 -&gt; Pool 2 -&gt; Pool 3 -&gt; Pool 4。</li>
</ol>
<p>这样，即使每秒点击 20 次，分摊到每个 <code>SoundPool</code> 上也只有 5 次，负载大大降低。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// TtsSdkPlugin.ets 核心逻辑</span>
<span class="hljs-keyword">private</span> <span class="hljs-attr">soundPools</span>: media.<span class="hljs-property">SoundPool</span>[] = [];
<span class="hljs-keyword">private</span> <span class="hljs-attr">currentPoolIndex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-variable constant_">POOL_COUNT</span> = <span class="hljs-number">4</span>;

<span class="hljs-keyword">async</span> <span class="hljs-title function_">playShort</span>(<span class="hljs-params">path: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 轮询算法</span>
  <span class="hljs-keyword">const</span> pool = <span class="hljs-variable language_">this</span>.<span class="hljs-property">soundPools</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPoolIndex</span>];
  <span class="hljs-comment">// ... 播放逻辑 ...</span>
  <span class="hljs-comment">// 指向下一个池子</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPoolIndex</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPoolIndex</span> + <span class="hljs-number">1</span>) % <span class="hljs-variable language_">this</span>.<span class="hljs-property">POOL_COUNT</span>;
}
</code></pre>
<p>此外，我们还加上了 <strong>Loading Lock（加载锁）</strong>，防止同一个音效文件在未加载完成前被重复触发 IO 操作，进一步减少了 CPU 消耗。</p>
<h2 data-id="heading-10">五、 挑战四：后台保活的“静音”守护者</h2>
<h3 data-id="heading-11">4.1 问题现象</h3>
<p>运动App最常用的场景就是锁屏听声音。但鸿蒙系统对后台资源管控非常严格。我们的 SoundPool 播放是间歇性的（响一下，停一下）。在停止的那几百毫秒空隙里，系统会认为“该应用没有在播放音频”，进而挂起后台任务。
结果就是：App 一退后台，响两声就没动静了。</p>
<h3 data-id="heading-12">4.2 解决方案：AVSession + 静音保活</h3>
<p>要在鸿蒙后台持续运行，必须满足三个条件：</p>
<ol>
<li><strong>AVSession 激活</strong>：告诉系统我是媒体应用。</li>
<li><strong>BackgroundTask 申请</strong>：申请 <code>AUDIO_PLAYBACK</code> 长时任务。</li>
<li><strong>持续的音频输出</strong>：这是最关键的一点。</li>
</ol>
<p>我们设计了一个 <strong>Keep-Alive Renderer</strong>。它是一个独立的 <code>AudioRenderer</code>，它的唯一工作就是<strong>循环播放一段全为 0 的静音数据</strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 这里的 buffer 全是 0，听不见，但系统认为你在“努力工作”</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">writeSilence</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">keepAliveRenderer</span>.<span class="hljs-property">state</span> !== audio.<span class="hljs-property">AudioState</span>.<span class="hljs-property">STATE_RUNNING</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">let</span> bufferSize = <span class="hljs-number">17640</span>; 
  <span class="hljs-keyword">let</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(bufferSize); <span class="hljs-comment">// 静音数据</span>
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">keepAliveRenderer</span>.<span class="hljs-title function_">write</span>(buffer);
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">writeSilence</span>(); <span class="hljs-comment">// 递归调用，永不停歇</span>
}
</code></pre>
<p><strong>组合拳逻辑</strong>：</p>
<ul>
<li>当节拍器开始时 -&gt; 激活 <code>AVSession</code> -&gt; 启动 <code>BackgroundTask</code> -&gt; <strong>开始播放静音流</strong>。</li>
<li>系统检测到有持续的音频输出，就不会杀掉 App。</li>
<li>用户听到的：清晰的节拍声（来自 SoundPool）。</li>
<li>系统看到的：一个持续输出音频流的媒体应用。</li>
</ul>
<h2 data-id="heading-13">六、 总结</h2>
<p>通过这一系列优化，我们终于在鸿蒙Next上实现了一个可用的专业级节拍器：</p>



































<table><thead><tr><th align="left">优化点</th><th align="left">解决问题</th><th align="left">核心手段</th></tr></thead><tbody><tr><td align="left"><strong>SoundPool</strong></td><td align="left">降低延迟</td><td align="left">替代 AVPlayer，内存直读</td></tr><tr><td align="left"><strong>异步调用</strong></td><td align="left">消除抖动</td><td align="left">Dart 端移除 await，解耦主线程</td></tr><tr><td align="left"><strong>多实例轮询</strong></td><td align="left">解决高频卡顿</td><td align="left">4个 SoundPool 轮流工作，负载均衡</td></tr><tr><td align="left"><strong>AVSession</strong></td><td align="left">系统媒体控制</td><td align="left">注册媒体会话，支持通知栏控制</td></tr><tr><td align="left"><strong>静音保活</strong></td><td align="left">后台持续运行</td><td align="left">独立的 AudioRenderer 持续输出静音流</td></tr></tbody></table>
<p>鸿蒙Next的音频开发虽然坑多，但只要理解了其底层的资源调度逻辑，依然能写出高性能的代码。希望这篇踩坑指南能帮到同样在探索鸿蒙开发的你。</p>
<hr/>
<p><em>本文基于 Flutter + HarmonyOS Next (API 12+) 开发环境。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[代码暴减99%！港大开源“纳米级OpenClaw”，仅4000行代码复刻OpenClaw核心战力！]]></title>    <link>https://juejin.cn/post/7602154088476295206</link>    <guid>https://juejin.cn/post/7602154088476295206</guid>    <pubDate>2026-02-03T02:37:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602154088476295206" data-draft-id="7602162809292029990" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="代码暴减99%！港大开源“纳米级OpenClaw”，仅4000行代码复刻OpenClaw核心战力！"/> <meta itemprop="keywords" content="GitHub,人工智能,Python"/> <meta itemprop="datePublished" content="2026-02-03T02:37:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开源星探"/> <meta itemprop="url" content="https://juejin.cn/user/2977915149494248"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            代码暴减99%！港大开源“纳米级OpenClaw”，仅4000行代码复刻OpenClaw核心战力！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2977915149494248/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开源星探
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:37:38.000Z" title="Tue Feb 03 2026 02:37:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在软件工程领域，有一句至理名言：“代码行数是负债，而不是资产。”</p>
<p>前两天，我们还在为 OpenClaw(Clawdbot) 那庞大的全栈能力惊叹，它确实强大，但高达 43 万行的代码体量，让很多想深入魔改的开发者望而却步。</p>
<p>香港大学数据智能实验室（HKUDS）反其道而行之。他们刚刚开源了一款名为 <strong>Nanobot</strong> 的项目，可称之为“纳米级 Clawdbot”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c39c434d8894dc28ba22f3647ab3de7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691057&amp;x-signature=J%2BlwewnqWcnJgAufQ1JeAWT4iFk%3D" alt="图片" loading="lazy"/></p>
<p>它复刻了 Clawdbot 几乎所有的核心智能体功能，但代码量只有 4000 行。</p>
<p>相比原版 43 万行代码，这个 99% 的“瘦身”极其震撼。它向开发者证明了一件事：构建一个全功能的、能干活的 AI Agent，其实不需要几十万行代码的堆砌，核心逻辑其实非常纯粹。</p>
<p>开源24小时不到，就已经收获了 1.3K Star。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d785a978e1274679a1b03665534e8d55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691057&amp;x-signature=m%2FNtc4cSIjMTlW5olc9RnHWAJAA%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-0">什么是 nanobot？</h4>
<p>你可以把 nanobot 理解为：</p>
<blockquote>
<p>去掉一切“学术装饰”和工程冗余后，剩下的那套“最小可用 Agent 内核”。</p>
</blockquote>
<p>它保留了一个成熟智能体必须具备的能力闭环：</p>
<ul>
<li>
<p>网页搜索</p>
</li>
<li>
<p>文件/代码操作</p>
</li>
<li>
<p>定时任务</p>
</li>
<li>
<p>记忆机制</p>
</li>
<li>
<p>多场景 Agent 模板</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36cb79968d6f4d3884726462213d2617~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691057&amp;x-signature=k3yoBkXMai7ygjIdSsNKAa0ryL0%3D" alt="图片" loading="lazy"/></p>
<p>麻雀虽小，五脏俱全。也是可以长期在线、持续执行、可复用的 Agent。</p>
<h4 data-id="heading-1">核心哲学</h4>
<p>Nanobot 的核心价值在于 <strong>“可掌控性”</strong>。</p>
<p>具备极低的学习成本：</p>
<ul>
<li>
<p><strong>OpenClaw</strong>：像是一个复杂的操作系统，功能模块巨大，你只能在它允许的框架内开发插件。</p>
</li>
<li>
<p><strong>Nanobot</strong>：4000 行 Python 代码。即使一个中级开发者，花一个下午就能通读所有源码，彻底搞懂 AI 是怎么调用工具、怎么管理记忆的。</p>
</li>
</ul>
<h4 data-id="heading-2">开箱即用的生产力</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97c462ee7e6743b7a16d7ce85d75e9b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5pif5o6i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691057&amp;x-signature=F1aPZt4v86JOHtEisona7b6LZSE%3D" alt="图片" loading="lazy"/></p>
<p>Nanobot 不只是一个空框架，它自带了四个非常硬核的模版，直接跑起来就能用：</p>
<ul>
<li>
<p><strong>24h 实时行情分析师</strong>：这是很多金融极客的最爱。</p>
</li>
<li>
<p><strong>全栈开发助手</strong>：随时随地执行开发任务。</p>
</li>
<li>
<p><strong>私人日程管理</strong>：帮你安排会议，发送提醒。</p>
</li>
<li>
<p><strong>个人知识库</strong>：把你的 PDF、笔记丢给它，随时问答。</p>
</li>
</ul>
<h4 data-id="heading-3">快速使用</h4>
<p>Nanobot 支持快速通过 Python Pypi 一键安装。</p>
<pre><code class="hljs language-bash" lang="bash">pip install nanobot-ai
</code></pre>
<p>也可以下载源码集成更多自定义的功能：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/HKUDS/nanobot.gitcd nanobotpip install -e .
</code></pre>
<blockquote>
<p>设置 API 密钥方式：~/.nanobot/config.json。</p>
</blockquote>
<p>安装完成后，本地就会有一个 nanobot 命令。</p>
<p>然后就可以进行初始化：</p>
<pre><code class="hljs language-bash" lang="bash">nanobot onboard
</code></pre>
<p>配置模型：</p>
<pre><code class="hljs language-bash" lang="bash">{  
  <span class="hljs-string">"providers"</span>: {  
    <span class="hljs-string">"openrouter"</span>: {  
      <span class="hljs-string">"apiKey"</span>: <span class="hljs-string">"sk-or-v1-xxx"</span>  
    }  
  },  
  <span class="hljs-string">"agents"</span>: {  
    <span class="hljs-string">"defaults"</span>: {  
      <span class="hljs-string">"model"</span>: <span class="hljs-string">"anthropic/claude-opus-4-5"</span>  
    }  
  },  
  <span class="hljs-string">"webSearch"</span>: {  
    <span class="hljs-string">"apiKey"</span>: <span class="hljs-string">"BSA-xxx"</span>  
  }  
}
</code></pre>
<p>启动Agent聊天：</p>
<pre><code class="hljs language-bash" lang="bash">nanobot agent -m <span class="hljs-string">"What is 2+2?"</span>
</code></pre>
<p>目前已支持通过 Telegram 或 WhatsApp 与你的 Nanobot 对话。</p>
<p>跟 OpenClaw 一样，只需要配置配对好，就可以直接运行。</p>
<p>最终启动网关命令也类似：</p>
<pre><code class="hljs language-bash" lang="bash">nanobot gateway
</code></pre>
<h4 data-id="heading-4">写在最后</h4>
<p>我们知道 OpenClaw 是更复杂、具备更多模块、更大的系统。</p>
<p>而 nanobot 走的是另一条路：</p>
<ul>
<li>
<p>更小，但完整</p>
</li>
<li>
<p>更少，但闭环</p>
</li>
<li>
<p>更简单，但能长期跑</p>
</li>
</ul>
<p>它提醒我们，Agent 的本质不是代码的堆砌，而是逻辑的编排。</p>
<p>未来肯定也会有更多的 Agent “极简实现”，但它方便的是每个人，甚至是整个生态。</p>
<p>GitHub：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FHKUDS%2Fnanobot" target="_blank" title="https://github.com/HKUDS/nanobot" ref="nofollow noopener noreferrer">github.com/HKUDS/nanob…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 MCSManager+cpolar 轻松搞定我的世界公网联机]]></title>    <link>https://juejin.cn/post/7602162809292259366</link>    <guid>https://juejin.cn/post/7602162809292259366</guid>    <pubDate>2026-02-03T02:46:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602162809292259366" data-draft-id="7602303923139625010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 MCSManager+cpolar 轻松搞定我的世界公网联机"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-03T02:46:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金者阿豪"/> <meta itemprop="url" content="https://juejin.cn/user/4073055974333608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 MCSManager+cpolar 轻松搞定我的世界公网联机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4073055974333608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金者阿豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-03T02:46:13.000Z" title="Tue Feb 03 2026 02:46:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5f676200d89445c98358e1798d89403~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=iIpsG7ALdcojOVmzlogtVwI11b4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>MCSManager 是一款针对 Minecraft 等游戏服务器的管理面板，核心功能是简化服务器搭建与运维流程，无需复杂的代码操作，通过可视化界面和简单命令就能完成服务器部署、启停、配置管理等操作，适配 Linux 主流发行版，也兼容 Windows 系统，尤其适合学生党、家庭游戏玩家以及技术新手使用，优点在于操作门槛低，兼顾命令行与图形界面，能快速完成服务器环境配置，省去手动调试的繁琐。</p>
<p>使用 MCSManager 搭建我的世界服务器时发现，这款工具虽然上手快，但首次配置时要注意和游戏版本匹配，比如搭建 Java 版 1.20.4 服务器，需对应安装 Java17 环境，否则会出现启动失败的情况；另外日常使用中要定期备份服务器数据，避免因操作失误导致存档丢失。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50b16da1ccd3489ca0e1890b3f8a302c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=h%2BIcLhqm6ISuj8At40A0%2Bkl1mFc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>仅依靠 MCSManager 搭建的服务器只能在局域网内联机，会带来不少实际不便：比如学生党在宿舍搭建的服务器，放假回家后就无法和室友继续联机；家庭用户想和异地的亲友一起玩，也会因局域网的物理限制无法实现；就算是同一城市的朋友，不在同一网络环境下也只能望 “服” 兴叹。</p>
<p>而将 MCSManager 与 cpolar 结合后，就能突破这些限制：cpolar 无需修改路由器端口映射，也不用公网 IP，就能把内网的游戏服务器端口映射到公网，生成可访问的公网地址，比如学生党假期在家，只需通过这个公网地址，就能和宿舍的服务器联机；家庭用户也能让远方的亲友通过公网地址加入游戏，真正实现跨地域的游戏联机自由。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc97436308a04a77b47e03746c0c8958~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=2j%2BvKqCdddSMXnodSr9wh6oO1rI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-0">私服MC自己的游戏自己做主！</h4>
<p>首先，我们要确保Java版我的世界服务器已经成功搭建，并且可以在局域网内正常联机。如果你已经是这方面的高手了，可以直接跳到第三步，在本地配置Cpolar进行内网穿透。但如果你是新手，也不用担心，我会从头开始详细讲解每一步。</p>
<h2 data-id="heading-1">1. 搭建我的世界服务器</h2>
<p>以windows10系统为例，配置java环境，搭建服务器。</p>
<h3 data-id="heading-2">1.1 服务器安装java环境</h3>
<p>下载java17</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oracle.com%2Fjava%2Ftechnologies%2Fdownloads%2F%23jdk17-windows" target="_blank" title="https://www.oracle.com/java/technologies/downloads/#jdk17-windows" ref="nofollow noopener noreferrer">www.oracle.com/java/techno…</a></p>
<p>选择exe文件，下载完成后双击安装包一路默认安装即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69a5b536250243eea2e676fdbe5c5e58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=pl7GfVdCnxwzduMft4%2BUTySSvVI%3D" alt="image.png" loading="lazy"/>
java安装完成后，打开文件夹，找到java，将jdk安装路径复制下来，本例中为<code>C:\Program Files\Java\jdk-17.0.5</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b8232ee10054c9980d06419bd86d29b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=67YnTgQwMhmZlTOSkilZjsa1q1U%3D" alt="image.png" loading="lazy"/></p>
<p>在开始菜单栏搜索<code>高级系统设置</code>并打开系统属性，点击<code>环境变量</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3439fa4ebea24ab5a22e2cb450d015b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=eIJyG8dFGjpOkusRZGzTY3wzm68%3D" alt="image.png" loading="lazy"/></p>
<p>点击新建一个系统环境变量</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e01df1ebba4413f8a8ce85302f19c13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=toQ8CzT6sgTP4w%2Bol3%2FIVAcJKcQ%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>变量名：JAVA_HOME</li>
<li>变量值：JDK的安装路径，本例中为<code>C:\Program Files\Java\jdk-17.0.5</code></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/591137cf5b1e4791961ec9a2ce61c6e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=QImUA%2BqJw4g2fG5SRUMrv2Raazc%3D" alt="image.png" loading="lazy"/></p>
<p>在系统变量列表中，双击Path变量</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62428355a6a74232af54d45d09bc4a51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=%2BW46NuVIA4bztjWkMZ%2BwiiZQGLE%3D" alt="image.png" loading="lazy"/></p>
<p>点击右侧的新建，在变量名值前面加<code>%JAVA_HOME%\bin</code>，点击确认</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd1612829dac4b5c95d1fe07c15bbd3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=eDIPJWig%2BdFjTN5iZJPkQ6ysRHw%3D" alt="image.png" loading="lazy"/></p>
<p>校验是否成功：开始菜单栏搜索cmd，打开命令提示符，输入<code>javac</code>，出现以下内容则说明配置成功。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2589e104595240d0b73ba83db806c8f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=%2B%2BQpjHN9pRtB1pXOKE3Ec7Womnk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">1.2 配置服务端</h3>
<p>下载MC服务端，最新版的服务器端可以官网下载</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmcsmanager.com%2F" target="_blank" title="https://mcsmanager.com/" ref="nofollow noopener noreferrer">MCSManager | 开源免费，分布式，一键部署，支持 Minecraft 和 Steam游戏服务器的控制面板</a></p>
<p>选择Windows</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eef34eee77cb4e8c99628c6825cc319e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=5NgnvrkPEsqzdWqcTIxrvpk1H2s%3D" alt="image.png" loading="lazy"/></p>
<p>下载到本地后，打开文件夹</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59bd4a3d06ed4f35b4bbb39525ea3437~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=Dh%2Be9%2FNtf8EMn0g8r9zb2CqZwgY%3D" alt="image.png" loading="lazy"/></p>
<p>双击打开<code>start.bat</code>，可以看到连续跳出两个终端</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1ad0089ad02421ab0421b963dd414e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=WM3riseMFbjRScbzpOwGBrwGK2g%3D" alt="image.png" loading="lazy"/></p>
<p>然后使用外部浏览器,通过局域网ip地址加23333端口访问,即可看到MCSM的web界面,首次登陆,需要创建一个账号</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd00fd8fc83b41c693689c6f62bf5407~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=HwT%2F0jZfJ4HFYfpbGcW8rMCtCDY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">1.3 创建我的世界服务器</h3>
<p>在面板中,我们点击快速开始,创建一个Minecraft服务器</p>
<p>进入到仪表盘中，点击上方<code>应用实例</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa1cbd5af07c4a13b7c3c57cb4a1cd41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=54luKoDiseitGLsMcMFsKIGL4eY%3D" alt="image.png" loading="lazy"/></p>
<p>点击<code>新建应用</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0840a825ac54cbcbed0dec60f208025~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=WNaEO0RKoqYAW3g%2B6sbz3%2FrZ%2Fu8%3D" alt="image.png" loading="lazy"/></p>
<p>点击Minecraft Java版游戏服务器</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cd08cd64b0943d0b696042416a33ed4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=ssXJqBrN05HPuyA7XsgO2IefCKQ%3D" alt="image.png" loading="lazy"/></p>
<p>点击Mincraft 快速部署</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e684264ffd449a59946ba9238f9a3bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=l9A%2Bi3SHGahbo8bz%2FhkBG2dt5Cc%3D" alt="image.png" loading="lazy"/></p>
<p>点击Minecraft 1.20.4 低配机器推荐</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ad9b94ca45c4231b17f82a5195f9868~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=58SVxIRlwmE2vTXExtzK7i08MI0%3D" alt="image.png" loading="lazy"/></p>
<p>创建一个实例的新名字</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5ad283349fa4a88ad2a13cab25cd31d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=tNpj%2FTdUTs8nLs1yBrDfOgmEElY%3D" alt="image.png" loading="lazy"/></p>
<p>然后稍微等待一会</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ca7078afad84468a710690ca66ce5ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=ka4swdyERZ1lathTKItpO0lGsxQ%3D" alt="image.png" loading="lazy"/></p>
<p>点击前往实例控制台</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1223925cac0f4141b0f9901f5de047ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=yJ21Ct2U8jUxyoXH8cvFOo5tsII%3D" alt="image.png" loading="lazy"/></p>
<p>点击 <code>开启</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd5659497b774a96bafce8c126c780fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=lMPjRy%2BQ2iZ%2FEuZPeKODvvoiIuc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c8780222a5f487b87de898dec31e309~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=zvZjsAJu6y8WZqnLvGyBkOUREdM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">2. 局域网联机测试</h2>
<p>启动器和最新版JAVA地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.baidu.com%2Fs%2F1VuiGrX_hH_gzYzcKAjwEVA%3Fpwd%3D6666" target="_blank" title="https://pan.baidu.com/s/1VuiGrX_hH_gzYzcKAjwEVA?pwd=6666" ref="nofollow noopener noreferrer">pan.baidu.com/s/1VuiGrX_h…</a></p>
<p>提取码：6666</p>
<p>本教程使用的是windows启动器和JAVA</p>
<p>安装好最新版JAVA后在启动器中创建一个账号，正版或是离线账号都可以</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/052c6b7b879c49609dfd2ba7d8276193~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=cwCLdPGdgtwwb6KyeicDVSrWc40%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f49c2832299243ffa5dcacfc83a631fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=tGw8%2BxRINovmb8ky0ur4%2FnxVVlw%3D" alt="image.png" loading="lazy"/></p>
<p>打开我的世界启动器,选择和服务器一样的版本1.20.4,启动</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ace2f1b78554689857e0012959e2c46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=Ox31dgGAeQ6u26tpwsKELH77bzU%3D" alt="image.png" loading="lazy"/></p>
<p>然后点击多人游戏</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5398e84ce0248b4af6f65a122c89d8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=ICWY47LDo35X%2Ff6efVT0mPnpSXA%3D" alt="image.png" loading="lazy"/></p>
<p>点击添加服务器,然后输入局域网ip地址加25565端口<code>192.168.50.33:25565</code>,点击加入服务器</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cc0dfbbe62e45188a1fccea8be55d81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=5dOvpdzL5rwHb9%2FV5nRBOS%2BCuQM%3D" alt="image.png" loading="lazy"/></p>
<p>现在我们成功搭建了我的世界私服，并且可以看到成功进入了游戏。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05698a5dd9144d8480de0e594b7a530a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=ShFc1sfxjBKuRQY%2FAan5DUZBPsk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b371b4824454b35a5c2cbc7b567a31c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=wXetQRa1U2ylS%2FkV8CsyY2FiHSs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">3. 安装cpolar内网穿透</h2>
<p>上面我们实现了在局域网内的联机，接下来我们将突破局域网的限制，实现在公网环境下的远程联机，通过cpolar内网穿透，将内网端口映射到公网上，其会生成相应的公网地址，异地小伙伴就可以通过该公网地址远程联机一起玩了，不需要公网ip，也不用设置路由器，操作简单。</p>
<p>下面是安装cpolar步骤：</p>
<blockquote>
<p>Cpolar官网地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cpolar.com%2F" target="_blank" title="https://www.cpolar.com/" ref="nofollow noopener noreferrer">www.cpolar.com</a></p>
</blockquote>
<p>点击进入cpolar官网，点击<code>免费使用</code>注册一个账号，并下载最新版本的Cpolar</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e8958daffda468684bca3e32d00d56e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=f%2Bwu%2FCL9yVGbQdGxaweCJ5SARBk%3D" alt="" loading="lazy"/></p>
<p>登录成功后，点击下载Cpolar到本地并安装（一路默认安装即可）本教程选择下载Windows版本。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f61a8016c23145f2abbce00e87aba527~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=Z4BPx5Y0MBh858qqJu3LtAKQjt4%3D" alt="image.png" loading="lazy"/></p>
<p>Cpolar安装成功后，在浏览器上访问<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A9200%25EF%25BC%258C%25E4%25BD%25BF%25E7%2594%25A8cpolar%25E8%25B4%25A6%25E5%258F%25B7%25E7%2599%25BB%25E5%25BD%2595%2C%25E7%2599%25BB%25E5%25BD%2595%25E5%2590%258E%25E5%258D%25B3%25E5%258F%25AF%25E7%259C%258B%25E5%2588%25B0Cpolar" target="_blank" title="http://localhost:9200%EF%BC%8C%E4%BD%BF%E7%94%A8cpolar%E8%B4%A6%E5%8F%B7%E7%99%BB%E5%BD%95,%E7%99%BB%E5%BD%95%E5%90%8E%E5%8D%B3%E5%8F%AF%E7%9C%8B%E5%88%B0Cpolar" ref="nofollow noopener noreferrer">http://localhost:9200，使用cpolar账号登录,登录后即可看到Cpolar</a> web 配置界面,结下来在web 管理界面配置即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d44a88746d8c47439a83ec2f7ab9b0fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=idYYdPKjNWo1CEwXzfQlwO%2FAkMw%3D" alt="image.png" loading="lazy"/></p>
<p>接下来配置一下本地 Minecraft 的公网地址，</p>
<p>登录后，点击左侧仪表盘的隧道管理——创建隧道，</p>
<p>创建一个 Minecraft 的公网tcp地址隧道：</p>
<ul>
<li>隧道名称：可自定义命名，注意不要与已有的隧道名称重复</li>
<li>协议：选择 tcp</li>
<li>本地地址：25565</li>
<li>域名类型：免费选择随机域名</li>
<li>地区：选择China Top</li>
</ul>
<p>点击创建</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/959272416d89496cbeb3946606c4c7b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=6VWA7wcQJnyrMcTTvpJKSXH8BMk%3D" alt="image.png" loading="lazy"/></p>
<p>然后打开在线隧道列表,查看并且复制公网地址，注意<code>tcp://</code>无需复制</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bebdfdf1a6d4e7dbc6028c428d0d56b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=hcs7iUcRVPcvYeoQSuQ5Hf2KFRw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">4. 公网联机Minecraft</h2>
<p>打开我的世界,选择多人游戏,点击刚才创建的服务器选择编辑，使用cpolar中生成的公网地址进行连接，点击完成</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/093c02449ea84e00ae2e1de0a4bea960~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=Z8%2BmsS69Xq4Ygosv%2B6vhys7a7B8%3D" alt="image.png" loading="lazy"/></p>
<p>成功远程多人联机</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b016403808742b5bba3b8bdfd51ff20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=hnDhBYZhWHH3x4OB3TT%2B3bmHeBo%3D" alt="image.png" loading="lazy"/></p>
<p><strong>小结</strong></p>
<p>如果我们需要经常和小伙伴们联机游戏或者长时间游戏，由于刚才创建的是随机的地址，24小时会发生变化。如果不想每次联机游戏都重新创建一个公网TCP隧道，可以选择创建一个固定的tcp地址来解决这个问题。</p>
<h2 data-id="heading-8">5. 配置固定远程联机端口地址</h2>
<p>我们接下来为其配置固定的TCP端口地址，该地址不会变化，方便小伙伴远程联机，而无需每天重复修改服务器地址。</p>
<blockquote>
<p>配置固定tcp端口地址需要将cpolar升级到专业版套餐或以上。</p>
</blockquote>
<p>登录<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cpolar.com%2F" target="_blank" title="https://www.cpolar.com/" ref="nofollow noopener noreferrer">cpolar官网</a>，点击左侧的预留，找到保留的tcp地址，我们来为我的世界保留一个固定tcp地址：</p>
<ul>
<li>地区：选择China vip</li>
<li>描述：即备注，可自定义</li>
</ul>
<p>点击<code>保留</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d31c99852d8546fca3e8a7c2f0cc1107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=yiWnsXd3%2BaZy9cYAHZRoAFJp4Jc%3D" alt="image.png" loading="lazy"/>
地址保留成功后，系统会生成相应的固定公网地址，将其复制下来，注意无需复制<code>tcp://</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6964de0a5ede4f70a4626b20d7c419c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=Qfg476IiDAP1JQ5pI%2F%2B3sGFyL00%3D" alt="image.png" loading="lazy"/></p>
<p>在cpolar web ui管理界面，点击左侧仪表盘的隧道管理——隧道列表，找到前面创建的我的世界隧道，点击右侧的<code>编辑</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14aee9a610ed4ddc8b2b0db26bce9996~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=VlK383VUc9prbwNM3qywTVVSTXg%3D" alt="image.png" loading="lazy"/></p>
<p>修改隧道信息，将保留成功的固定tcp地址配置到隧道中</p>
<ul>
<li>端口类型：修改为固定tcp端口</li>
<li>预留的tcp地址：填写保留成功的地址</li>
</ul>
<p>点击<code>更新</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/615b91f79e4949fca7b2abc76fb6f55d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=2Ca%2BVAcqnuhyxbwqpcL%2BQiKjZ74%3D" alt="image.png" loading="lazy"/></p>
<p>隧道更新成功后，点击左侧仪表盘的状态——在线隧道列表，找到我的世界隧道，可以看到公网地址已经更新成为了固定tcp地址。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82d097656bd24f56a2ec50cfe33262b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=QldJdjFsWSr6yWpBfwpPkAIp0Fc%3D" alt="image.png" loading="lazy"/></p>
<p>打开我的世界,点击多人游戏,选择刚才的服务器进行编辑,输入上面固定的公网TCP地址端口远程联机</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dadc4622d70748b5a77da80c3e7dacc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=uFMYhQ2IGuRoB6SGuh%2BKlxpQdTg%3D" alt="image.png" loading="lazy"/></p>
<p>公网远程联机成功！现在，该公网地址不会再随机变化了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/959294bf0d17497c885ac904fb34943c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770691573&amp;x-signature=imwfeRsHepbYWLsutY7Ls8RTOqk%3D" alt="image.png" loading="lazy"/></p>
<p>总结来说，MCSManager 凭借简单易操作的特性，能帮助普通玩家快速搭建我的世界服务器，解决了服务器搭建门槛高的问题，但局域网联机的限制会大幅降低使用体验。而 cpolar 内网穿透则恰好弥补了这一短板，无需复杂配置就能实现公网联机，无论是学生党跨地域和室友玩游戏，还是家庭用户和异地亲友联机，都能轻松实现。这种组合既保留了 MCSManager 的易用性，又突破了网络环境的限制，让我的世界私服联机真正实现了不受地域、网络的约束，满足了普通玩家的实际联机需求。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cpolar.com%2F" target="_blank" title="https://www.cpolar.com/" ref="nofollow noopener noreferrer">cpolar官网-安全的内网穿透工具 | 无需公网ip | 远程访问 | 搭建网站</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 教程 自定义指令 + 生命周期全解析]]></title>    <link>https://juejin.cn/post/7601929765533794355</link>    <guid>https://juejin.cn/post/7601929765533794355</guid>    <pubDate>2026-02-02T14:39:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601929765533794355" data-draft-id="7601929765533777971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 教程 自定义指令 + 生命周期全解析"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-02-02T14:39:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="红色的小鳄鱼"/> <meta itemprop="url" content="https://juejin.cn/user/4501859894316474"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 教程 自定义指令 + 生命周期全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4501859894316474/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    红色的小鳄鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T14:39:53.000Z" title="Mon Feb 02 2026 14:39:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Vue 中的自定义指令和生命周期是前端开发的核心基础，也是面试高频考点。本文将从实用角度出发，梳理两大知识点的核心用法，内容简洁易懂，贴合实际开发场景，助力快速掌握！</p>
<h2 data-id="heading-0">一、自定义指令：高效封装 DOM 操作</h2>
<p>自定义指令是 Vue 扩展 DOM 操作能力的核心方式，专门用来封装重复的 DOM 相关逻辑，轻量且易复用，是内置指令的重要补充。</p>
<h3 data-id="heading-1">1. 函数式自定义指令</h3>
<p>基础极简写法，适合无多阶段控制的简单场景，函数会在指令绑定元素和数据更新时自动执行。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 全局注册：v-focus 输入框自动聚焦</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'focus'</span>, <span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> {
  el.<span class="hljs-title function_">focus</span>() <span class="hljs-comment">// el为指令绑定的DOM元素，可直接操作</span>
})
</code></pre>
<p>适用场景：输入框自动聚焦、简单文本格式化、快速修改 DOM 基础样式等。</p>
<h3 data-id="heading-2">2. 对象式自定义指令</h3>
<p>适合逻辑复杂的场景，通过多个内置钩子函数，实现指令从绑定到解绑的全阶段精确控制，每个钩子各司其职。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 全局注册：对象式自定义指令</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'指令名'</span>, {
  <span class="hljs-title function_">bind</span>(<span class="hljs-params">el</span>) { <span class="hljs-comment">// 指令绑定元素时执行</span>
    el.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">'red'</span>
  },
  <span class="hljs-title function_">update</span>(<span class="hljs-params">el, binding</span>) { <span class="hljs-comment">// 数据更新时执行</span>
    el.<span class="hljs-property">innerText</span> = binding.<span class="hljs-property">value</span>
  }
})
</code></pre>
<p>适用场景：元素拖拽、图片懒加载、DOM 事件监听 / 解绑等需要分阶段处理的逻辑。</p>
<h3 data-id="heading-3">3. 自定义指令核心总结</h3>
<p><strong>核心钩子执行顺序</strong></p>
<p>bind（绑定）→ inserted（插入 DOM）→ update（数据更新）→ unbind（解绑）</p>
<p><strong>关键注意事项</strong></p>
<ol>
<li>所有钩子中 this 指向 window，无法通过 this 访问组件实例；</li>
<li>全局注册需在 Vue 实例创建前执行，局部注册仅当前组件可用；</li>
<li>涉及事件 / 定时器时，务必在 unbind 中清理，避免内存泄漏。</li>
</ol>
<h2 data-id="heading-4">二、Vue 生命周期：精准控制组件的 “一生”</h2>
<p>生命周期是 Vue 组件从创建→挂载→更新→销毁的完整流程，Vue 会按固定顺序自动触发对应的钩子函数。</p>
<h3 data-id="heading-5">1. 生命周期核心阶段：挂载流程</h3>
<p>挂载阶段是组件从初始化到渲染到页面的核心过程，开发中最常用，执行顺序固定：beforeCreate → created → beforeMount → mounted，仅执行一次。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">message</span>: <span class="hljs-string">'生命周期演示'</span>,
      <span class="hljs-attr">list</span>: []
    }
  },
  <span class="hljs-title function_">beforeCreate</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'beforeCreate：data/props 未初始化，无法访问'</span>)
  },
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'created：data/props 已初始化，可访问'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getList</span>() <span class="hljs-comment">// 发送初始化数据请求（无需依赖DOM）</span>
  },
  <span class="hljs-title function_">beforeMount</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'beforeMount：模板编译完成，即将挂载到DOM'</span>)
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'mounted：DOM已挂载，可操作'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>)
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-comment">// 模拟数据请求</span>
    <span class="hljs-title function_">getList</span>(<span class="hljs-params"/>) {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span> = [<span class="hljs-string">'Vue'</span>, <span class="hljs-string">'自定义指令'</span>, <span class="hljs-string">'生命周期'</span>]
      }, <span class="hljs-number">500</span>)
    }
  }
}
</code></pre>
<ol>
<li>beforeCreate：实例刚创建，无数据、无 DOM，几乎不用；</li>
<li>created：数据就绪，可访问 data/props，适合初始化数据、发送无 DOM 依赖的请求；</li>
<li>beforeMount：模板编译完成，未挂载 DOM，可做最后一次数据修改；</li>
<li>mounted：DOM 就绪，可访问 / 操作 DOM，适合初始化第三方插件、执行 DOM 相关逻辑。</li>
</ol>
<h3 data-id="heading-6">2. 生命周期核心阶段：更新 + 销毁流程</h3>
<p>更新阶段会随数据变化多次触发，销毁阶段仅执行一次，核心是清理资源，避免内存泄漏。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">message</span>: <span class="hljs-string">'初始数据'</span>,
      <span class="hljs-attr">timer</span>: <span class="hljs-literal">null</span>
    }
  },
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 初始化定时器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'定时器运行中'</span>)
    }, <span class="hljs-number">1000</span>)
  },
  <span class="hljs-comment">// 更新阶段：数据变化，视图未更新时执行</span>
  <span class="hljs-title function_">beforeUpdate</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'beforeUpdate：数据已改，视图未更'</span>)
  },
  <span class="hljs-comment">// 更新阶段：数据变化，视图更新完成后执行</span>
  <span class="hljs-title function_">updated</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'updated：数据已改，视图已更'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)
  },
  <span class="hljs-comment">// 销毁阶段：组件即将卸载，实例仍可访问（核心：清理资源）</span>
  <span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'beforeDestroy：组件即将销毁，清理资源'</span>)
    <span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span>) <span class="hljs-comment">// 清除定时器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span> = <span class="hljs-literal">null</span> <span class="hljs-comment">// 释放DOM引用</span>
  },
  <span class="hljs-comment">// 销毁阶段：组件已卸载，数据/DOM均不可访问</span>
  <span class="hljs-title function_">destroyed</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'destroyed：组件已销毁，无法操作'</span>)
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-comment">// 修改数据，触发更新阶段</span>
    <span class="hljs-title function_">updateMsg</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">'修改后的新数据'</span>
    }
  }
}
</code></pre>
<h3 data-id="heading-7">3. 生命周期核心总结</h3>
<p><strong>整体执行顺序</strong></p>
<p>创建阶段→ 挂载阶段→ 更新阶段→ 销毁阶段</p>
<p><strong>核心开发原则</strong></p>
<ul>
<li>数据相关逻辑（请求、初始化）放 created，DOM 相关逻辑放 mounted；</li>
<li>数据更新后需操作 DOM，优先用 this.$nextTick，而非 updated；</li>
<li>组件销毁前，必须在 beforeDestroy 中清理所有资源（定时器、事件、插件实例）；</li>
</ul>
<h2 data-id="heading-8">总结</h2>
<p>自定义指令和生命周期是 Vue 开发的基础中的基础，也是进阶的关键：</p>
<ul>
<li>自定义指令：让 DOM 操作更高效、更复用，核心是<strong>按需选择函数式 / 对象式，做好资源清理</strong>；</li>
<li>生命周期：让组件行为更可控，核心是<strong>分清数据就绪和 DOM 就绪时机，牢记销毁阶段清理资源</strong>。</li>
</ul>
<blockquote>
<p>如果觉得本文对你有帮助，欢迎点赞 + 收藏 + 关注，后续持续分享 Vue 实用开发技巧和核心知识点解析～</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[现代网页性能优化：利用 IntersectionObserver`实现高性能图片懒加载]]></title>    <link>https://juejin.cn/post/7601929765533876275</link>    <guid>https://juejin.cn/post/7601929765533876275</guid>    <pubDate>2026-02-02T15:23:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601929765533876275" data-draft-id="7602133286643892274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="现代网页性能优化：利用 IntersectionObserver`实现高性能图片懒加载"/> <meta itemprop="keywords" content="前端,性能优化"/> <meta itemprop="datePublished" content="2026-02-02T15:23:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秃头敲码小姐姐"/> <meta itemprop="url" content="https://juejin.cn/user/24668014656249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            现代网页性能优化：利用 IntersectionObserver`实现高性能图片懒加载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/24668014656249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秃头敲码小姐姐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T15:23:20.000Z" title="Mon Feb 02 2026 15:23:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>摘要：</strong> 在网页开发中，首屏加载速度直接决定了用户的留存率。当页面中充斥着大量高分辨率图片时，如何避免“瀑布流”式的漫长等待？本文将带你从零构建一个基于 <code>IntersectionObserver</code> 的图片懒加载方案，告别传统的 <code>onscroll</code> 事件监听，用设计模式的思想解决性能痛点。</p>
<hr/>
<h4 data-id="heading-0">1. 为什么我们需要“懒加载”？🐢</h4>
<p>在传统的网页加载流程中，浏览器会解析 HTML 并立即请求 <code>&lt;img&gt;</code> 标签中的 <code>src</code> 属性。这会导致一个严重的问题：</p>
<ul>
<li><strong>资源浪费：</strong> 即使图片位于屏幕可视区域（Viewport）之外，浏览器也会发起 HTTP 请求下载它。</li>
<li><strong>首屏阻塞：</strong> 大量的图片请求占用了带宽和并发连接数，导致 HTML、CSS 和首屏关键资源加载变慢。</li>
<li><strong>用户体验差：</strong> 用户看到的是一个缓慢加载、甚至“卡顿”的页面。</li>
</ul>
<p><strong>解决方案：</strong> 让视窗外的图片“偷个懒”，只有当用户滚动到它附近时，再加载真实的图片资源。</p>
<hr/>
<h4 data-id="heading-1">2. 传统方案 vs 现代方案 📊</h4>




















<table><thead><tr><th align="left">方案</th><th align="left">原理</th><th align="left">缺点</th></tr></thead><tbody><tr><td align="left"><strong>传统 OnScroll</strong></td><td align="left">监听 <code>window.onscroll</code> 事件，通过 <code>getBoundingClientRect</code> 计算位置</td><td align="left"><strong>性能杀手</strong>：滚动事件触发频率极高，频繁计算 DOM 位置会导致页面卡顿（重排/重绘）。</td></tr><tr><td align="left"><strong>现代 IntersectionObserver</strong></td><td align="left">浏览器原生提供的观察者模式 API</td><td align="left"><strong>高性能</strong>：由浏览器内核在渲染层直接处理，不占用主线程，无性能问题。</td></tr></tbody></table>
<blockquote>
<p><strong>💡 核心概念：</strong> <code>IntersectionObserver</code> 是一种异步观察机制。它不需要我们手动去“问”浏览器“图片在视窗里了吗？”，而是浏览器会主动“告诉”我们“图片进入视窗了”。</p>
</blockquote>
<hr/>
<h4 data-id="heading-2">3. 代码实战：从零实现懒加载 🛠️</h4>
<p>下面我们通过一个简单的 Demo，手把手教你实现一个高性能的图片懒加载组件。</p>
<p><strong>第一步：HTML 结构（数据分离）</strong></p>
<p>我们要打破直接在 <code>src</code> 写真实地址的习惯。利用 HTML5 的 <code>data-*</code> 属性来存储真实地址，<code>src</code> 只放一个极小的占位图（Placeholder）。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 占位图（极小，优先加载） --&gt;</span>
<span class="hljs-comment">&lt;!-- 真实图地址（存在 data-src 里，不发起请求） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
  <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy"</span> 
  <span class="hljs-attr">src</span>=<span class="hljs-string">"https://img10.360buyimg.com/wq/jfs/t24601/190/890984006/4559/731564fc/5b7f9b7bN3ccd29ab.png"</span> 
  <span class="hljs-attr">data-src</span>=<span class="hljs-string">"https://img.36krcdn.com/hsossms/20260119/真实高清大图地址"</span> 
  <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>
&gt;</span>
</code></pre>
<p><strong>第二步：JavaScript 核心逻辑</strong></p>
<p>这是本文的核心部分。我们利用 <code>IntersectionObserver</code> 来监听图片元素。</p>
<pre><code class="hljs language-ini" lang="ini">// 1. 找到所有需要懒加载的图片
const <span class="hljs-attr">images</span> = document.querySelectorAll(<span class="hljs-string">'.lazy'</span>)<span class="hljs-comment">;</span>

// 2. 实例化观察者对象
// entries: 所有被观察元素的状态集合
// isIntersecting: 布尔值，表示该元素是否与视窗发生交叉（即出现在视窗中）
const <span class="hljs-attr">observer</span> = new IntersectionObserver((entries) =&gt; {
  entries.forEach(<span class="hljs-attr">entry</span> =&gt; {
    if (entry.isIntersecting) {
      // 3. 如果图片出现在视窗中
      const <span class="hljs-attr">img</span> = entry.target<span class="hljs-comment">;</span>
      const <span class="hljs-attr">originalSrc</span> = img.dataset.src<span class="hljs-comment">; // 获取真实地址</span>
      
      console.log('加载真实图片:', originalSrc)<span class="hljs-comment">;</span>
      
      // 4. 将 data-src 的值赋给 src，触发图片加载
      <span class="hljs-attr">img.src</span> = originalSrc<span class="hljs-comment">;</span>
      
      // 5. 加载完成后，取消对该图片的观察（优化性能）
      observer.unobserve(img)<span class="hljs-comment">;</span>
    }
  })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>

// 3. 开始观察：给每一张图片加上观察指令
images.forEach(<span class="hljs-attr">img</span> =&gt; observer.observe(img))<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h4 data-id="heading-3">4. 原理深度解析 🔍</h4>
<p>让我们拆解一下这段代码背后的逻辑：</p>
<ol>
<li>
<p><strong>观察者模式 (Observer Pattern)：</strong></p>
<ul>
<li><strong>观察者 (Observer)：</strong> <code>new IntersectionObserver(...)</code> 实例。</li>
<li><strong>被观察者 (Target)：</strong> 所有的 <code>&lt;img class="lazy"&gt;</code> 元素。</li>
<li><strong>回调 (Callback)：</strong> 当被观察者的状态（与视窗的交叉状态）发生变化时，浏览器会自动调用构造函数中传入的函数。</li>
</ul>
</li>
<li>
<p><strong>生命周期控制：</strong></p>
<ul>
<li><strong>出现即加载：</strong> 利用 <code>entry.isIntersecting</code> 判断图片是否进入视野。</li>
<li><strong>及时止损：</strong> 一旦图片加载完成（<code>img.src = originalSrc</code>），立即调用 <code>observer.unobserve(img)</code>。这样做的好处是，图片加载后，观察者就不再关心这张图片了，减少了后续的计算开销。</li>
</ul>
</li>
<li>
<p><strong>数据属性 (Dataset)：</strong></p>
<ul>
<li>使用 <code>img.dataset.src</code> 来读取 <code>data-src</code> 属性。这是标准的 DOM 操作方式，比 <code>getAttribute</code> 更加语义化。</li>
</ul>
</li>
</ol>
<hr/>
<h4 data-id="heading-4">5. 总结与展望 📝</h4>
<p>通过使用 <code>IntersectionObserver</code>，我们实现了一个<strong>无感知、高性能</strong>的图片懒加载方案。</p>
<ul>
<li><strong>优势：</strong> 代码简洁，性能优异，不阻塞主线程。</li>
<li><strong>适用场景：</strong> 电商首页、图片瀑布流、长文阅读页面。</li>
<li><strong>未来展望：</strong> 随着 Web API 的发展，我们可以进一步结合 <code>loading="lazy"</code>（原生 HTML 懒加载属性）作为降级方案，或者结合 WebP/AVIF 格式实现更极致的图片加载体验。</li>
</ul>
<p><strong>一句话总结：</strong> 让浏览器去做它擅长的事（计算位置），让开发者专注于业务逻辑（加载图片），这就是现代前端开发的魅力所在。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[作用域是什么]]></title>    <link>https://juejin.cn/post/7602072073135063067</link>    <guid>https://juejin.cn/post/7602072073135063067</guid>    <pubDate>2026-02-02T15:34:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602072073135063067" data-draft-id="7602277621260140594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="作用域是什么"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-02T15:34:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            作用域是什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T15:34:15.000Z" title="Mon Feb 02 2026 15:34:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>作用域是程序中定义变量的区域，它规定了变量和函数的可访问范围，以及变量的生命周期。</strong></p>
<h2 data-id="heading-0">1. 作用域的核心概念</h2>
<h3 data-id="heading-1">1.1 作用域的基本作用</h3>
<ul>
<li><strong>确定变量和函数的可见性</strong>：在哪些地方可以访问这些标识符</li>
<li><strong>确定变量的生命周期</strong>：变量何时创建、何时销毁</li>
<li><strong>避免命名冲突</strong>：不同作用域可以有同名变量</li>
<li><strong>提供访问控制</strong>：实现私有和公共的访问级别</li>
</ul>
<h2 data-id="heading-2">2. JavaScript中的作用域类型</h2>
<h3 data-id="heading-3">2.1 全局作用域（Global Scope）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 全局作用域中的变量</span>
<span class="hljs-keyword">var</span> globalVar = <span class="hljs-string">"I'm global"</span>;
<span class="hljs-keyword">let</span> globalLet = <span class="hljs-string">"I'm also global"</span>;
<span class="hljs-keyword">const</span> globalConst = <span class="hljs-string">"Me too"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">globalFunction</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"I'm a global function"</span>);
}

<span class="hljs-comment">// 这些都可以在代码的任何地方访问</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">globalVar</span>); <span class="hljs-comment">// 浏览器中，var变量会成为window对象的属性</span>
</code></pre>
<h3 data-id="heading-4">2.2 函数作用域（Function Scope）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 函数作用域开始</span>
  <span class="hljs-keyword">var</span> functionScoped = <span class="hljs-string">"I'm only available inside outer"</span>;
  <span class="hljs-keyword">let</span> alsoFunctionScoped = <span class="hljs-string">"Me too"</span>;
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 可以访问外层函数的变量</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(functionScoped); <span class="hljs-comment">// 正常访问</span>
    <span class="hljs-keyword">var</span> innerVar = <span class="hljs-string">"I'm only in inner"</span>;
  }
  
  <span class="hljs-title function_">inner</span>();
  <span class="hljs-comment">// console.log(innerVar); // 报错：innerVar is not defined</span>
}
<span class="hljs-comment">// console.log(functionScoped); // 报错：functionScoped is not defined</span>
</code></pre>
<h3 data-id="heading-5">2.3 块级作用域（Block Scope）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ES6引入的let和const具有块级作用域</span>
{
  <span class="hljs-comment">// 块级作用域开始</span>
  <span class="hljs-keyword">let</span> blockScoped = <span class="hljs-string">"I'm only in this block"</span>;
  <span class="hljs-keyword">const</span> blockConst = <span class="hljs-string">"Me too"</span>;
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(blockScoped); <span class="hljs-comment">// 正常</span>
}

<span class="hljs-comment">// console.log(blockScoped); // 报错：blockScoped is not defined</span>

<span class="hljs-comment">// 实际应用场景</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
  <span class="hljs-comment">// 每个i都是独立的块级作用域</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i)); <span class="hljs-comment">// 0, 1, 2</span>
}

<span class="hljs-comment">// 对比var（没有块级作用域）</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">3</span>; j++) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(j)); <span class="hljs-comment">// 3, 3, 3</span>
}
</code></pre>
<h3 data-id="heading-6">2.4 模块作用域（Module Scope）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// module.js</span>
<span class="hljs-keyword">const</span> privateVar = <span class="hljs-string">"I'm private to this module"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> publicVar = <span class="hljs-string">"I'm exported"</span>;

<span class="hljs-comment">// 在模块外无法访问privateVar</span>
<span class="hljs-comment">// 只能访问通过export暴露的变量</span>
</code></pre>
<h2 data-id="heading-7">3. 作用域链（Scope Chain）</h2>
<h3 data-id="heading-8">3.1 什么是作用域链</h3>
<p>当访问一个变量时，JavaScript引擎会从当前作用域开始查找，如果找不到，就向上一层作用域查找，直到全局作用域，这个查找路径就是作用域链。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> <span class="hljs-variable language_">global</span> = <span class="hljs-string">"global"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> outerVar = <span class="hljs-string">"outer"</span>;
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> innerVar = <span class="hljs-string">"inner"</span>;
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(innerVar);   <span class="hljs-comment">// 1. 在当前作用域找到</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(outerVar);   <span class="hljs-comment">// 2. 在外层作用域找到</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">global</span>);     <span class="hljs-comment">// 3. 在全局作用域找到</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(undeclared); <span class="hljs-comment">// 4. 报错：在所有作用域都找不到</span>
  }
  
  <span class="hljs-title function_">inner</span>();
}

<span class="hljs-title function_">outer</span>();
</code></pre>
<h3 data-id="heading-9">3.2 作用域链的创建</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 作用域链在函数定义时确定（词法作用域）</span>
<span class="hljs-keyword">let</span> globalVar = <span class="hljs-string">"global"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createFunctions</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> outerVar = <span class="hljs-string">"outer"</span>;
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner1</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(outerVar); <span class="hljs-comment">// 可以访问outerVar</span>
  }
  
  <span class="hljs-keyword">let</span> inner2 = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(outerVar); <span class="hljs-comment">// 也可以访问outerVar</span>
  };
  
  <span class="hljs-comment">// 即使函数在其他地方执行，仍然能访问定义时的作用域链</span>
  <span class="hljs-keyword">return</span> [inner1, inner2];
}

<span class="hljs-keyword">const</span> [func1, func2] = <span class="hljs-title function_">createFunctions</span>();
<span class="hljs-title function_">func1</span>(); <span class="hljs-comment">// "outer" - 仍然能访问outerVar（闭包）</span>
<span class="hljs-title function_">func2</span>(); <span class="hljs-comment">// "outer"</span>
</code></pre>
<h2 data-id="heading-10">4. 词法作用域 vs 动态作用域</h2>
<h3 data-id="heading-11">4.1 JavaScript使用词法作用域（静态作用域）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> x = <span class="hljs-number">10</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> x = <span class="hljs-number">20</span>;
  <span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// 输出10，不是20</span>
}

<span class="hljs-title function_">bar</span>();

<span class="hljs-comment">// 解释：foo在定义时确定作用域链，访问的是定义时的x，而不是调用时的x</span>
</code></pre>
<h3 data-id="heading-12">4.2 对比动态作用域（JavaScript不是动态作用域）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码，展示动态作用域的概念</span>
<span class="hljs-comment">// 如果JavaScript是动态作用域：</span>
x = <span class="hljs-number">10</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">print</span>(x) <span class="hljs-comment">// 在动态作用域中，这里会查找调用时的作用域</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
  x = <span class="hljs-number">20</span>
  <span class="hljs-title function_">foo</span>() <span class="hljs-comment">// 会输出20</span>
}
</code></pre>
<h2 data-id="heading-13">5. 特殊的作用域行为</h2>
<h3 data-id="heading-14">5.1 变量提升（Hoisting）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// var的变量提升</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// undefined，不会报错</span>
<span class="hljs-keyword">var</span> a = <span class="hljs-number">5</span>;

<span class="hljs-comment">// 实际执行顺序：</span>
<span class="hljs-keyword">var</span> a;          <span class="hljs-comment">// 声明提升到作用域顶部</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// undefined</span>
a = <span class="hljs-number">5</span>;          <span class="hljs-comment">// 赋值留在原地</span>

<span class="hljs-comment">// let/const的暂时性死区（Temporal Dead Zone）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b); <span class="hljs-comment">// 报错：Cannot access 'b' before initialization</span>
<span class="hljs-keyword">let</span> b = <span class="hljs-number">5</span>;
</code></pre>
<h3 data-id="heading-15">5.2 没有块级作用域的var</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-keyword">var</span> noBlockScope = <span class="hljs-string">"I escape the block"</span>;
  <span class="hljs-keyword">let</span> hasBlockScope = <span class="hljs-string">"I stay in the block"</span>;
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(noBlockScope);   <span class="hljs-comment">// "I escape the block"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(hasBlockScope);  <span class="hljs-comment">// 报错：hasBlockScope is not defined</span>
</code></pre>
<h2 data-id="heading-16">6. 作用域的实际应用</h2>
<h3 data-id="heading-17">6.1 避免全局污染</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不好的做法：污染全局作用域</span>
<span class="hljs-keyword">var</span> global1 = <span class="hljs-string">"data"</span>;
<span class="hljs-keyword">var</span> global2 = <span class="hljs-string">"more data"</span>;

<span class="hljs-comment">// 好的做法：使用IIFE或模块</span>
(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 私有作用域</span>
  <span class="hljs-keyword">var</span> privateData = <span class="hljs-string">"hidden"</span>;
  <span class="hljs-comment">// 对外暴露必要的接口</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">myModule</span> = {
    <span class="hljs-attr">publicMethod</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> privateData;
    }
  };
})();
</code></pre>
<h3 data-id="heading-18">6.2 创建私有变量</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>; <span class="hljs-comment">// 私有变量</span>
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
      count++;
      <span class="hljs-keyword">return</span> count;
    },
    <span class="hljs-title function_">getCount</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> count;
    }
  };
}

<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-property">count</span>); <span class="hljs-comment">// undefined，无法直接访问</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">getCount</span>()); <span class="hljs-comment">// 0</span>
</code></pre>
<h3 data-id="heading-19">6.3 循环中的块级作用域</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 常见问题</span>
<span class="hljs-keyword">var</span> funcs = [];
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
  funcs.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i); <span class="hljs-comment">// 全部输出3</span>
  });
}

<span class="hljs-comment">// 解决方案1：使用IIFE</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
  (<span class="hljs-keyword">function</span>(<span class="hljs-params">j</span>) {
    funcs.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(j); <span class="hljs-comment">// 0, 1, 2</span>
    });
  })(i);
}

<span class="hljs-comment">// 解决方案2：使用let（推荐）</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
  funcs.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i); <span class="hljs-comment">// 0, 1, 2</span>
  });
}
</code></pre>
<h2 data-id="heading-20">7. 现代JavaScript中的作用域</h2>
<h3 data-id="heading-21">7.1 ES6模块作用域</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// module.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> publicValue = <span class="hljs-number">42</span>;
<span class="hljs-keyword">const</span> privateValue = <span class="hljs-string">"secret"</span>;

<span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { publicValue } <span class="hljs-keyword">from</span> <span class="hljs-string">'./module.js'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(publicValue); <span class="hljs-comment">// 42</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(privateValue); <span class="hljs-comment">// 报错：privateValue is not defined</span>
</code></pre>
<h3 data-id="heading-22">7.2 类作用域</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
  <span class="hljs-comment">// 类作用域</span>
  #privateField = <span class="hljs-string">"I'm private"</span>;
  publicField = <span class="hljs-string">"I'm public"</span>;
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">instanceField</span> = <span class="hljs-string">"I'm on the instance"</span>;
  }
  
  <span class="hljs-title function_">method</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.#privateField); <span class="hljs-comment">// 可以访问私有字段</span>
  }
}

<span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClass</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(instance.<span class="hljs-property">publicField</span>); <span class="hljs-comment">// "I'm public"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(instance.#privateField); <span class="hljs-comment">// 报错：Private field must be declared in an enclosing class</span>
</code></pre>
<h2 data-id="heading-23">总结表格</h2>



































<table><thead><tr><th>作用域类型</th><th>关键字</th><th>特点</th><th>示例</th></tr></thead><tbody><tr><td>全局作用域</td><td>var, let, const</td><td>整个程序可访问</td><td><code>var global = 1;</code></td></tr><tr><td>函数作用域</td><td>var</td><td>只在函数内可访问</td><td><code>function foo() { var x = 1; }</code></td></tr><tr><td>块级作用域</td><td>let, const</td><td>在{}内可访问</td><td><code>{ let x = 1; }</code></td></tr><tr><td>模块作用域</td><td>export, import</td><td>只在模块内可访问</td><td><code>export const x = 1;</code></td></tr></tbody></table>
<h2 data-id="heading-24">关键要点</h2>
<ol>
<li><strong>作用域决定了变量的可见性和生命周期</strong></li>
<li><strong>JavaScript使用词法作用域</strong>：作用域在代码编写时确定</li>
<li><strong>作用域链决定了变量的查找顺序</strong>：从内到外查找</li>
<li><strong>ES6引入的let/const有块级作用域</strong>，解决了许多var的问题</li>
<li><strong>合理使用作用域可以避免命名冲突、实现封装</strong></li>
</ol>
<p>理解作用域是掌握JavaScript闭包、this绑定、模块化等高级概念的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[闭包一定会造成内存泄漏吗？]]></title>    <link>https://juejin.cn/post/7602277621260124210</link>    <guid>https://juejin.cn/post/7602277621260124210</guid>    <pubDate>2026-02-02T15:17:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602277621260124210" data-draft-id="7602072073134915611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="闭包一定会造成内存泄漏吗？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-02T15:17:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            闭包一定会造成内存泄漏吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T15:17:43.000Z" title="Mon Feb 02 2026 15:17:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>闭包不一定会造成内存泄漏，但使用不当确实可能引起内存泄漏。</strong>  这是对闭包常见的误解之一。</p>
<h2 data-id="heading-0">闭包和内存的关系</h2>
<p>闭包的特性决定了它会<strong>保留对外部函数作用域的引用</strong>，这使得：</p>
<ol>
<li>闭包引用的变量不会被垃圾回收</li>
<li>闭包本身也是一个对象，会占用内存</li>
</ol>
<p>但这<strong>不等同于</strong>内存泄漏。</p>
<h2 data-id="heading-1">什么时候是正常的内存占用？</h2>
<p>javascript</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 这是正常的闭包使用，不是内存泄漏</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">const</span> privateData = { 
    <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
    <span class="hljs-attr">preferences</span>: {}
  };
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">getName</span>: <span class="hljs-function">() =&gt;</span> name,
    <span class="hljs-attr">updateName</span>: <span class="hljs-function">(<span class="hljs-params">newName</span>) =&gt;</span> { name = newName; },
    <span class="hljs-comment">// privateData 被闭包引用，但这是设计意图</span>
    <span class="hljs-attr">setPreference</span>: <span class="hljs-function">(<span class="hljs-params">key, value</span>) =&gt;</span> {
      privateData.<span class="hljs-property">preferences</span>[key] = value;
    }
  };
}

<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">createUser</span>(<span class="hljs-string">"Alice"</span>);
<span class="hljs-comment">// user对象及其闭包作用域被正常使用，这不是内存泄漏</span>
</code></pre>
<h2 data-id="heading-2">什么时候可能造成内存泄漏？</h2>
<h3 data-id="heading-3">1. <strong>意外的全局变量引用</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createLeakyClosure</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> hugeArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>);
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 意外地创建了全局引用</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">hugeArrayRef</span> = hugeArray;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Oops!'</span>);
  };
}

<span class="hljs-keyword">const</span> leakyFunc = <span class="hljs-title function_">createLeakyClosure</span>();
<span class="hljs-comment">// 即使 leakyFunc 不再使用，hugeArray 也无法被回收</span>
<span class="hljs-comment">// 因为 window.hugeArrayRef 仍然引用它</span>
</code></pre>
<h3 data-id="heading-4">2. <strong>DOM元素引用未清理</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">attachHandler</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'largeElement'</span>);
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'data'</span>);
  
  element.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 闭包引用了 data 和 element</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">length</span>, element.<span class="hljs-property">id</span>);
  });
  
  <span class="hljs-comment">// 即使从DOM中移除元素</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(element);
  <span class="hljs-comment">// 事件监听器闭包仍然引用着 element 和 data</span>
  <span class="hljs-comment">// element 无法被垃圾回收！</span>
}
</code></pre>
<h3 data-id="heading-5">3. <strong>定时器/间隔器未清除</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">startProcess</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>);
  
  <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 闭包引用了 data</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">length</span>);
  }, <span class="hljs-number">1000</span>);
  
  <span class="hljs-comment">// 即使不再需要，定时器仍在运行，data无法被回收</span>
}
</code></pre>
<h3 data-id="heading-6">4. <strong>循环引用（在老式浏览器中）</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 在现代浏览器中，这通常不是问题，但IE6-7会有问题</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createCircularReference</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myDiv'</span>);
  <span class="hljs-keyword">const</span> data = { <span class="hljs-attr">element</span>: element };
  
  element.<span class="hljs-property">myData</span> = data; <span class="hljs-comment">// 循环引用</span>
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(element, data);
  };
}
</code></pre>
<h2 data-id="heading-7">如何避免闭包引起的内存泄漏？</h2>
<h3 data-id="heading-8">1. <strong>及时清理引用</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">cleanUp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>);
  <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myElement'</span>);
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">length</span>);
  }
  
  element.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handler);
  
  <span class="hljs-comment">// 使用后及时清理</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">cleanUpResources</span>(<span class="hljs-params"/>) {
    element.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, handler);
    <span class="hljs-comment">// 将局部变量设为null，帮助垃圾回收</span>
    <span class="hljs-comment">// 注意：闭包仍然存在，但引用的内容可以被释放</span>
  };
}
</code></pre>
<h3 data-id="heading-9">2. <strong>使用WeakMap/WeakSet进行弱引用</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> weakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createNonLeakyClosure</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myElement'</span>);
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">'*'</span>);
  
  <span class="hljs-comment">// 使用WeakMap，不会阻止垃圾回收</span>
  weakMap.<span class="hljs-title function_">set</span>(element, data);
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> data = weakMap.<span class="hljs-title function_">get</span>(element);
    <span class="hljs-keyword">if</span> (data) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">length</span>);
    }
  };
}
</code></pre>
<h3 data-id="heading-10">3. <strong>分离事件处理函数</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不好的做法：闭包直接引用大对象</span>
element.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(largeObject.<span class="hljs-property">data</span>); <span class="hljs-comment">// largeObject被闭包引用</span>
});

<span class="hljs-comment">// 好的做法：传递最小必要数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
}

<span class="hljs-keyword">const</span> data = largeObject.<span class="hljs-property">data</span>; <span class="hljs-comment">// 只提取需要的数据</span>
element.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">handleClick</span>(data)); 
</code></pre>
<h3 data-id="heading-11">4. <strong>使用模块模式时的注意事项</strong></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyModule</span> = (<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> privateData = <span class="hljs-literal">null</span>;
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params">data</span>) {
    privateData = data;
  }
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">cleanup</span>(<span class="hljs-params"/>) {
    privateData = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 显式释放</span>
  }
  
  <span class="hljs-keyword">return</span> {
    init,
    cleanup,
    <span class="hljs-attr">process</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (privateData) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(privateData.<span class="hljs-property">length</span>);
      }
    }
  };
})();
</code></pre>
<h2 data-id="heading-12">诊断闭包内存泄漏</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 使用Chrome DevTools Memory面板</span>
<span class="hljs-comment">// 1. 记录堆快照</span>
<span class="hljs-comment">// 2. 执行可能泄漏的操作</span>
<span class="hljs-comment">// 3. 再次记录堆快照</span>
<span class="hljs-comment">// 4. 比较两个快照，查看闭包是否持续增长</span>
</code></pre>
<h2 data-id="heading-13">关键区别</h2>

























<table><thead><tr><th>情况</th><th>是否是内存泄漏</th></tr></thead><tbody><tr><td>闭包正常持有必要数据</td><td>❌ 不是</td></tr><tr><td>闭包意外持有不再需要的大对象</td><td>✅ 是</td></tr><tr><td>闭包引用已移除的DOM元素</td><td>✅ 是</td></tr><tr><td>闭包用于缓存计算结果</td><td>❌ 不是（除非缓存无限增长）</td></tr></tbody></table>
<h2 data-id="heading-14">总结</h2>
<p>闭包<strong>本身不是内存泄漏</strong>，它是一个有用的语言特性。内存泄漏发生在：</p>
<ol>
<li><strong>意外的引用</strong>：闭包意外地持有了不需要的对象</li>
<li><strong>未及时清理</strong>：闭包持有对象的时间超过了必要时间</li>
<li><strong>循环引用</strong>（在特定浏览器中）</li>
</ol>
<p>正确使用闭包的关键是：</p>
<ul>
<li><strong>只保留必要的数据</strong>在闭包作用域中</li>
<li><strong>及时清理</strong>不再需要的引用</li>
<li>对于<strong>长时间存在</strong>的闭包，要特别小心其内存占用</li>
</ul>
<p>现代JavaScript引擎的垃圾回收机制越来越智能，只要合理使用，闭包不会成为内存泄漏的主要原因。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 组件库工程化实战：BEM 命名规范与 useNamespace 深度解析]]></title>    <link>https://juejin.cn/post/7602072073135046683</link>    <guid>https://juejin.cn/post/7602072073135046683</guid>    <pubDate>2026-02-02T15:22:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602072073135046683" data-draft-id="7602277621260156978" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 组件库工程化实战：BEM 命名规范与 useNamespace 深度解析"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2026-02-02T15:22:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端之百炼成魔"/> <meta itemprop="url" content="https://juejin.cn/user/1486957885265400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 组件库工程化实战：BEM 命名规范与 useNamespace 深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1486957885265400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端之百炼成魔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T15:22:54.000Z" title="Mon Feb 02 2026 15:22:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">《Vue3 组件库工程化实战：BEM 命名规范与 useNamespace 深度解析》</h2>
<p>在阅读开源组件库（如 Element Plus、Ant Design Vue）的源码时，你可能会发现一个奇怪的现象：开发者几乎从不手写字符串形式的 CSS 类名（如 <code>class="el-button"</code>），而是使用类似 <code>ns.b()</code>、<code>ns.e('icon')</code> 这样的函数调用。</p>
<p>这是为什么？这背后的 <code>useNamespace</code> 到底是什么魔法？</p>
<p>今天我们就来拆解这个组件库开发中最基础、也是最优雅的<strong>BEM 命名管理工具</strong>。</p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7c2ac66b72c45b2a103f98de2284c7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LmL55m-54K85oiQ6a2U:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770650573&amp;x-signature=oR55EdVqFcZxQyF%2FL2%2BF1v8hPwU%3D" alt="BEM.png" loading="lazy"/></p>
<h3 data-id="heading-1">1. 痛点：为什么不能直接写字符串？</h3>
<p>假设你正在开发一个按钮组件，你可能会这样写：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 坏味道的代码 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-button"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-button__icon"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-button__text"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p>这种写法有三个致命问题：</p>
<ol>
<li><strong>难以维护的前缀</strong>：如果有一天老板说：“我们要把品牌升级，所有组件的前缀从 <code>my-</code> 改成 <code>super-</code>”。你需要在几百个文件中进行全局查找替换，极易出错。</li>
<li><strong>拼写错误</strong>：手写 <code>my-butotn__text</code>（手误）是常有的事，CSS 也就是这样失效的。</li>
<li><strong>不规范</strong>：团队成员 A 喜欢用 <code>my-btn-text</code>，成员 B 喜欢用 <code>my-button_text</code>，导致样式冲突和混乱。</li>
</ol>
<p>为了解决这些问题，我们需要一套<strong>自动生成类名</strong>的工具。</p>
<hr/>
<h3 data-id="heading-2">2. 预备知识：什么是 BEM 规范？</h3>
<p>在看代码前，我们需要先理解它的生成规则：<strong>BEM</strong>。</p>
<ul>
<li><strong>B (Block) 块</strong>：独立的组件实体。例如：<code>button</code>（按钮）、<code>dialog</code>（弹窗）。</li>
<li><strong>E (Element) 元素</strong>：组件内部的组成部分。例如：按钮里的文字 <code>text</code>、图标 <code>icon</code>。连接符通常是双下划线 <code>__</code>。</li>
<li><strong>M (Modifier) 修饰符</strong>：组件的不同状态或版本。例如：蓝色的按钮 <code>primary</code>、禁用的按钮 <code>disabled</code>。连接符通常是双横线 <code>--</code>。</li>
</ul>
<p><strong>公式：</strong> <code>前缀-块__元素--修饰符</code>
<strong>例子：</strong> <code>my-button__text--large</code> (我的-按钮组件__文字部分--大号版)</p>
<hr/>
<h3 data-id="heading-3">3. 核心代码拆解：它是如何工作的？</h3>
<p>我们在 <code>packages/utils/src/namespace.ts</code> 中定义的 <code>useNamespace</code> 函数，就是一个<strong>类名生产工厂</strong>。</p>
<p>我们把代码拆成两部分看：</p>
<h4 data-id="heading-4">第一部分：底层的拼接逻辑 <code>_bem</code></h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 这是一个纯粹的字符串拼接函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">_bem</span>(<span class="hljs-params"><span class="hljs-keyword">namespace</span>, block, blockSuffix, element, modifier</span>) {
  <span class="hljs-comment">// 1. 先拼个头： "my-button"</span>
  <span class="hljs-keyword">let</span> cls = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">namespace</span>}</span>-<span class="hljs-subst">${block}</span>`</span> 
  
  <span class="hljs-comment">// 2. 如果有块后缀（比如 button-group）："my-button-group"</span>
  <span class="hljs-keyword">if</span> (blockSuffix) {
    cls += <span class="hljs-string">`-<span class="hljs-subst">${blockSuffix}</span>`</span>
  }
  
  <span class="hljs-comment">// 3. 如果有元素（比如 icon）："my-button__icon"</span>
  <span class="hljs-keyword">if</span> (element) {
    cls += <span class="hljs-string">`__<span class="hljs-subst">${element}</span>`</span>
  }
  
  <span class="hljs-comment">// 4. 如果有修饰符（比如 primary）："my-button--primary"</span>
  <span class="hljs-keyword">if</span> (modifier) {
    cls += <span class="hljs-string">`--<span class="hljs-subst">${modifier}</span>`</span>
  }
  <span class="hljs-keyword">return</span> cls
}
</code></pre>
<h4 data-id="heading-5">第二部分：对外暴露的 <code>useNamespace</code></h4>
<p>为了让开发者用起来更爽，我们使用了<strong>闭包</strong>。你只需要在组件里告诉它一次“我是谁（block）”，它就会返回一系列专门为你服务的简写函数。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useNamespace</span>(<span class="hljs-params">block: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 拿到全局配置的前缀，比如 'my'</span>
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">namespace</span> = defaultNamespace 
  
  // 生成 <span class="hljs-title class_">Block</span> (块)
  // 调用: ns.b() -&gt; "my-button"
  const b = (blockSuffix = '') =&gt; _bem(<span class="hljs-keyword">namespace</span>, block, blockSuffix, '', '')
  
  // 生成 <span class="hljs-title class_">Element</span> (元素)
  // 调用: ns.e('text') -&gt; "my-button__text"
  const e = (element?: string) =&gt;
    element ? _bem(<span class="hljs-keyword">namespace</span>, block, '', element, '') : ''
    
  // 生成 <span class="hljs-title class_">Modifier</span> (修饰符)
  // 调用: ns.m('primary') -&gt; "my-button--primary"
  const m = (modifier?: string) =&gt;
    modifier ? _bem(<span class="hljs-keyword">namespace</span>, block, '', '', modifier) : ''
    
  // 生成 <span class="hljs-title class_">State</span> (状态) - 这是一个特殊的辅助函数
  // 调用: ns.is('disabled') -&gt; "is-disabled"
  const is = (name: string, state: boolean | undefined = true) =&gt;
    state ? `is-${name}<span class="hljs-string">` : ''

  return { b, e, m, is, ... }
}
</span></code></pre>
<hr/>
<h3 data-id="heading-6">4. 实战演示：在 Vue3 组件中使用</h3>
<p>想象一下，你正在写 <code>packages/components/input/src/input.vue</code>。</p>
<h4 data-id="heading-7">步骤 1：引入并初始化</h4>
<pre><code class="hljs language-typescript" lang="typescript">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { useNamespace } <span class="hljs-keyword">from</span> <span class="hljs-string">'@my-antd-ui/utils'</span>

<span class="hljs-comment">// 告诉工具：我是 'input' 组件</span>
<span class="hljs-keyword">const</span> ns = <span class="hljs-title function_">useNamespace</span>(<span class="hljs-string">'input'</span>)
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-8">步骤 2：在 Template 中畅快使用</h4>






























<table><thead><tr><th align="left">你写的代码 (Vue Template)</th><th align="left">渲染结果 (HTML Class)</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>&lt;div :class="ns.b()"&gt;</code></td><td align="left"><code>class="my-input"</code></td><td align="left">最外层容器</td></tr><tr><td align="left"><code>&lt;span :class="ns.e('inner')"&gt;</code></td><td align="left"><code>class="my-input__inner"</code></td><td align="left">内部输入框元素</td></tr><tr><td align="left"><code>&lt;div :class="ns.m('textarea')"&gt;</code></td><td align="left"><code>class="my-input--textarea"</code></td><td align="left">文本域变体</td></tr><tr><td align="left"><code>&lt;div :class="[ns.b(), ns.is('focus')]"&gt;</code></td><td align="left"><code>class="my-input is-focus"</code></td><td align="left">聚焦状态</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-9">5. 对照速查表：传统写法 vs BEM 工具写法</h3>
<p>为了方便大家快速上手，这里整理了一份详细的<strong>对照表</strong>。
假设我们当前的组件是 <code>Button</code> (即 <code>const ns = useNamespace('button')</code>)，前缀是 <code>my</code>。</p>
<h4 data-id="heading-10">基础场景</h4>



































<table><thead><tr><th align="left">场景</th><th align="left">以前你可能会这么写 (手动挡)</th><th align="left">现在你应该这么写 (自动挡)</th><th align="left">最终生成类名</th></tr></thead><tbody><tr><td align="left"><strong>基础组件 (Block)</strong></td><td align="left"><code>'my-button'</code></td><td align="left"><strong><code>ns.b()</code></strong></td><td align="left"><code>my-button</code></td></tr><tr><td align="left"><strong>内部元素 (Element)</strong></td><td align="left"><code>'my-button__icon'</code></td><td align="left"><strong><code>ns.e('icon')</code></strong></td><td align="left"><code>my-button__icon</code></td></tr><tr><td align="left"><strong>修饰符 (Modifier)</strong></td><td align="left"><code>'my-button--primary'</code></td><td align="left"><strong><code>ns.m('primary')</code></strong></td><td align="left"><code>my-button--primary</code></td></tr><tr><td align="left"><strong>状态 (State)</strong></td><td align="left"><code>'is-disabled'</code></td><td align="left"><strong><code>ns.is('disabled')</code></strong></td><td align="left"><code>is-disabled</code></td></tr></tbody></table>
<h4 data-id="heading-11">动态/逻辑场景 (Vue Template 中)</h4>
<p>在 Vue 模板中，我们经常需要根据变量动态切换类名，这时候 <code>useNamespace</code> 的优势就更明显了。</p>
<p><strong>场景 1：根据 props 判断状态</strong></p>
<ul>
<li><strong>需求</strong>：如果 <code>props.disabled</code> 为 <code>true</code>，添加 <code>is-disabled</code> 类。</li>
<li><strong>传统写法</strong>：
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ 'is-disabled': props.disabled }"</span>&gt;</span>
</code></pre>
</li>
<li><strong>BEM 工具写法</strong>：
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"ns.is('disabled', props.disabled)"</span>&gt;</span>
</code></pre>
<blockquote>
<p><strong>优势</strong>：<code>ns.is</code> 第二个参数接受布尔值，自动处理显隐，代码更语义化。</p>
</blockquote>
</li>
</ul>
<p><strong>场景 2：根据 props 切换样式变体</strong></p>
<ul>
<li><strong>需求</strong>：根据 <code>type</code> 属性（如 <code>'primary'</code>, <code>'success'</code>）生成对应的类名。</li>
<li><strong>传统写法</strong>：
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"`my-button--${props.type}`"</span>&gt;</span>
</code></pre>
</li>
<li><strong>BEM 工具写法</strong>：
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"ns.m(props.type)"</span>&gt;</span>
</code></pre>
<blockquote>
<p><strong>优势</strong>：不需要自己拼字符串，也不用担心 <code>props.type</code> 为空时的处理（工具函数内部已处理）。</p>
</blockquote>
</li>
</ul>
<p><strong>场景 3：复杂的组合类名</strong></p>
<ul>
<li><strong>需求</strong>：一个按钮，基础类是 <code>my-button</code>，如果是 <code>primary</code> 类型则加 <code>my-button--primary</code>，如果是禁用则加 <code>is-disabled</code>。</li>
<li><strong>传统写法</strong>：
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"[
  'my-button',
  props.type ? 'my-button--' + props.type : '',
  props.disabled ? 'is-disabled' : ''
]"</span>&gt;</span>
</code></pre>
</li>
<li><strong>BEM 工具写法</strong>：
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"[
  ns.b(),
  ns.m(props.type),
  ns.is('disabled', props.disabled)
]"</span>&gt;</span>
</code></pre>
<blockquote>
<p><strong>优势</strong>：结构清晰，数组里的每一项都代表一个明确的 BEM 逻辑。</p>
</blockquote>
</li>
</ul>
<h4 data-id="heading-12">高级场景（少见但有用）</h4>





























<table><thead><tr><th align="left">场景</th><th align="left">解释</th><th align="left">写法</th><th align="left">生成结果</th></tr></thead><tbody><tr><td align="left"><strong>块后缀 (Block Suffix)</strong></td><td align="left">用于组件组，如按钮组</td><td align="left"><code>ns.b('group')</code></td><td align="left"><code>my-button-group</code></td></tr><tr><td align="left"><strong>复杂嵌套 (BE)</strong></td><td align="left">带后缀的块 + 元素</td><td align="left"><code>ns.be('header', 'title')</code></td><td align="left"><code>my-button-header__title</code></td></tr><tr><td align="left"><strong>元素修饰符 (EM)</strong></td><td align="left">元素的变体</td><td align="left"><code>ns.em('text', 'bold')</code></td><td align="left"><code>my-button__text--bold</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-13">6. 进阶答疑：多层嵌套怎么写？（父+子+孙）</h3>
<p>很多刚接触 BEM 的人都会纠结：<strong>“如果我的 HTML 嵌套了很多层，难道类名也要一直拼下去吗？”</strong></p>
<p>比如：父元素 <code>card</code> -&gt; 子元素 <code>header</code> -&gt; 孙元素 <code>title</code>。</p>
<h4 data-id="heading-14">❌ 错误的写法（不要这样做）</h4>
<p>不要试图还原 DOM 树的层级结构：</p>
<ul>
<li><code>my-card</code></li>
<li><code>my-card__header</code></li>
<li><code>my-card__header__title</code> (❌ 这种写法太长了，权重也难计算)</li>
</ul>
<h4 data-id="heading-15">✅ 正确的 BEM 写法（扁平化）</h4>
<p>BEM 的核心原则是<strong>扁平化</strong>。无论嵌套多深，所有内部元素都直接归属于最外层的 Block。</p>
<ul>
<li>父：<strong><code>ns.b()</code></strong> -&gt; <code>my-card</code></li>
<li>子：<strong><code>ns.e('header')</code></strong> -&gt; <code>my-card__header</code></li>
<li>孙：<strong><code>ns.e('title')</code></strong> -&gt; <code>my-card__title</code> (✅ 它是 card 的 title，而不是 header 的 title)</li>
</ul>
<h4 data-id="heading-16">代码示例</h4>
<pre><code class="hljs language-typescript" lang="typescript">&lt;script setup&gt;
<span class="hljs-keyword">const</span> ns = <span class="hljs-title function_">useNamespace</span>(<span class="hljs-string">'card'</span>)
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 父元素 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"ns.b()"</span>&gt;</span> 
    
    <span class="hljs-comment">&lt;!-- 子元素 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"ns.e('header')"</span>&gt;</span>
      
      <span class="hljs-comment">&lt;!-- 孙元素：依然使用 ns.e()，保持扁平 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"ns.e('title')"</span>&gt;</span>卡片标题<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-17">特殊情况：必须体现层级怎么办？</h4>
<p>如果你觉得“孙元素”必须要在逻辑上属于“子元素”（例如 <code>header</code> 本身已经很复杂了），有两种解法：</p>
<ol>
<li>
<p><strong>使用 <code>be</code> (Block + Element)</strong>：
<code>ns.be('header', 'title')</code> -&gt; 生成 <code>my-card-header__title</code></p>
</li>
<li>
<p><strong>拆分组件（推荐）</strong>：
将 <code>Header</code> 部分拆成一个独立的子组件，在子组件里重新定义 <code>ns = useNamespace('card-header')</code>。</p>
</li>
</ol>
<h4 data-id="heading-18">总结速查：嵌套层级写法</h4>



































<table><thead><tr><th align="left">层级</th><th align="left">术语</th><th align="left"><code>useNamespace</code> 写法</th><th align="left">最终生成类名</th></tr></thead><tbody><tr><td align="left"><strong>第一层 (父)</strong></td><td align="left">Block</td><td align="left"><code>ns.b()</code></td><td align="left"><code>my-card</code></td></tr><tr><td align="left"><strong>第二层 (子)</strong></td><td align="left">Element</td><td align="left"><code>ns.e('header')</code></td><td align="left"><code>my-card__header</code></td></tr><tr><td align="left"><strong>第三层 (孙)</strong></td><td align="left">Element (扁平)</td><td align="left"><code>ns.e('title')</code></td><td align="left"><code>my-card__title</code></td></tr><tr><td align="left"><strong>第三层 (进阶)</strong></td><td align="left">Block-Element</td><td align="left"><code>ns.be('header', 'title')</code></td><td align="left"><code>my-card-header__title</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-19">7. 总结</h3>
<p>使用 <code>useNamespace</code> 看起来像是多写了几行代码，但它带来了长期的巨大收益：</p>
<ol>
<li><strong>一键换肤</strong>：修改 <code>defaultNamespace = 'ant'</code>，整个组件库瞬间变身 <code>ant-button</code>, <code>ant-input</code>。</li>
<li><strong>杜绝手误</strong>：函数调用比手写字符串安全得多。</li>
<li><strong>心智负担低</strong>：你不需要思考“这里应该用下划线还是中划线”，工具替你统一了标准。</li>
</ol>
<p>这就是组件库工程化的魅力：<strong>用工具约束习惯，用规范换取自由。</strong></p>
<hr/>
<h3 data-id="heading-20">🔗 参考资料</h3>
<ul>
<li><strong>BEM 官方方法论</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fen.bem.info%2Fmethodology%2Fkey-concepts%2F" target="_blank" title="https://en.bem.info/methodology/key-concepts/" ref="nofollow noopener noreferrer">en.bem.info</a> (命名规范的起源)</li>
<li><strong>Element Plus 源码</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felement-plus%2Felement-plus%2Fblob%2Fdev%2Fpackages%2Fhooks%2Fuse-namespace%2Findex.ts" target="_blank" title="https://github.com/element-plus/element-plus/blob/dev/packages/hooks/use-namespace/index.ts" ref="nofollow noopener noreferrer">packages/hooks/use-namespace</a> (工业级 BEM 函数实现参考)</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[生成器(上)]]></title>    <link>https://juejin.cn/post/7602097118031446051</link>    <guid>https://juejin.cn/post/7602097118031446051</guid>    <pubDate>2026-02-02T15:50:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602097118031446051" data-draft-id="7602072652607471656" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="生成器(上)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-02T15:50:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="超绝大帅哥"/> <meta itemprop="url" content="https://juejin.cn/user/1074701161733898"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            生成器(上)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1074701161733898/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    超绝大帅哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T15:50:33.000Z" title="Mon Feb 02 2026 15:50:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>生成器函数是一种具有暂停运行能力的执行模式，在js函数的基础上，生成器函数可以在函数执行过程中暂停自己，但是生成器并不只能暂停自己函数的执行,生成器每次暂停都可以从外界得到一个值，同时在暂停时向外界抛出一个值，和函数外可以建立起一种<strong>双向消息传递系统</strong></p>
<h3 data-id="heading-0">迭代器和iterable</h3>
<p>假如我们需要产生一系列值，每个值都和前面一个有特定的关系,看下面一个例子</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getSeriseValue</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">let</span> nextVal;
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (nextVal === <span class="hljs-literal">undefined</span>) {
            nextVal = <span class="hljs-number">1</span>;
            <span class="hljs-keyword">return</span> nextVal;
        } 
        nextVal = nextVal * <span class="hljs-number">3</span> + <span class="hljs-number">6</span>;
        <span class="hljs-keyword">return</span> nextVal;
    }
};

<span class="hljs-keyword">const</span> next = <span class="hljs-title function_">getSetiseValue</span>();

<span class="hljs-title function_">next</span>();<span class="hljs-comment">//1</span>
<span class="hljs-title function_">next</span>();<span class="hljs-comment">//9</span>
<span class="hljs-title function_">next</span>();<span class="hljs-comment">//33</span>

</code></pre>
<p>从本质上，可以说我们需要从一个地方持续不断的得到值，直到结束,如果使用迭代器的形式，代码会变成如下</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getSeriesValue</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">let</span> nextVal;
    <span class="hljs-keyword">return</span> {
        [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>},  
        <span class="hljs-attr">next</span>: <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">if</span> (nextVal === <span class="hljs-literal">undefined</span>) {
               nextVal = <span class="hljs-number">1</span>;
                <span class="hljs-keyword">return</span> {<span class="hljs-attr">value</span>: nextVal, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> };
            }
            nextVal = nextVal * <span class="hljs-number">3</span> + <span class="hljs-number">4</span>;
            <span class="hljs-keyword">return</span> {<span class="hljs-attr">value</span>:nextVal, <span class="hljs-attr">done</span>:<span class="hljs-literal">false</span> };
        }
    }
};
</code></pre>
<p>当调用getSeriesValue函数时得到一个对象，这个对象包含一个next函数，调用next函数得到一个对象，这个对象有两个属性, done 是一个boolean值，表示迭代器的状态,为true表示迭代结束，迭代器不会产生值了，value携带产生的值，</p>
<p>js遵守了迭代器的规则，并且在es6的时候推出了for...of循环,这个for...of循环可以不断的执行， 直到得到的结果对象的done是true，for...of循环会调用你的对象内部的Symbol.iterator属性方法，要求返回一个对象，这个对象必须要有next函数，这个next函数必须返回的对象的形式为{value:...,done:....}, (Symbol.iterable是Es6内建的一个标识符, 这个标识符是独一无二的)</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> seriesValue = <span class="hljs-title function_">getSeriesValue</span>();
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> value <span class="hljs-keyword">of</span> seriesValue) {
    <span class="hljs-keyword">if</span> (value &gt; <span class="hljs-number">500</span>) {
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);
    <span class="hljs-comment">//1</span>
    <span class="hljs-comment">//7</span>
    <span class="hljs-comment">//25</span>
    <span class="hljs-comment">//79</span>
    <span class="hljs-comment">//241</span>
}

</code></pre>
<p>可能最常见的用法是从数组得到一系列值,比如下面</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> a = [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>];

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> v <span class="hljs-keyword">of</span> a) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(v);
}
<span class="hljs-comment">//1 3 5 7 9</span>
</code></pre>
<p>上面能执行成功完全是因为es6让数组对象都拥有了Symbol.iterable属性，调用这个属性函数会得到一个迭代器,自己写的字面量对象，如果你不特意去实现Symbol.iterable方法并且返回一个迭代器对象，是使用不了for...of的</p>
<h4 data-id="heading-1">iterable</h4>
<p>上面的例子里，迭代器对象都包含一个next, 而当对象有Symbol.iterable属性，并且调用这个函数返回了一个迭代器，就称它为可迭代对象(iterable),上例中的seriesValue就是一个迭代器，同时它有Symbol.iterable属性，这个属性函数调用尽管是返回this，但是因为本身自己就是一个迭代器，也符合调用迭代器的Symbol.iterable得到一个迭代器的规则，所以它同时还是一个可迭代对象,Symbol.iterable函数返回this变成可迭代对象的用法还挺常见的, ,其实for..of就是期待一个可迭代对象，而不是迭代器.</p>
<h4 data-id="heading-2">总结</h4>
<p>通过上面例子可以得到迭代器和可迭代对象的特性，我们描述这个特性，迭代器要求有一个next函数，而且这个函数返回{value:....,done:....}，可迭代对象要求可以通过Symbol.iterable属性函数调用得到一个迭代器,我们把这两种特性描述为迭代器协议和生成器协议</p>
<h3 data-id="heading-3">生成器的双向消息传递</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> *foo (x) {
    <span class="hljs-keyword">const</span> y = x * (<span class="hljs-keyword">yield</span> <span class="hljs-string">"Hello"</span>);
    <span class="hljs-keyword">return</span> y;
}

<span class="hljs-comment">//执行生成器函数，得到一个迭代器</span>
<span class="hljs-keyword">const</span> it = <span class="hljs-title function_">foo</span>(<span class="hljs-number">6</span>);<span class="hljs-comment">//</span>

<span class="hljs-comment">//执行迭代对象</span>
<span class="hljs-keyword">let</span> ans = it.<span class="hljs-title function_">next</span>(<span class="hljs-number">2</span>);<span class="hljs-comment">//传入2,没有用，会被忽略 </span>
<span class="hljs-comment">//ans为迭代结果，值为对象{value: "hello world", done: false}</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ans.<span class="hljs-property">value</span>); <span class="hljs-comment">// "Hello"</span>

ans = it.<span class="hljs-title function_">next</span>(<span class="hljs-number">7</span>);<span class="hljs-comment">//替代(yield "Hello") ，变成 x * 7;</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ans.<span class="hljs-property">value</span>);<span class="hljs-comment">//42</span>




</code></pre>
<p>可以使用生成器函数生成一个迭代器(注意这里并且没有实现Symbol.Iterable接口，所以它不是可迭代对象，单纯是一个迭代器), 执行next函数，生成器函数就开始运行， 生成器函数内执行到 <code>yield value</code>暂停生成器函数的执行，并且将value抛给外部,   表现为迭代器执行next函数的返回值，这个返回值为一个迭代结果对象，结果如{value: ".....", done: ....}, 当继续next调用的时候传入一个参数，这个值会替代原来<code>yield value</code> 所在的位置继续执行, 如此循环往复，可以看到，</p>
<p>我们第一次调用next函数的时候传入参数是没有用的,因为第一次是用于整个生成器函数开始执行，并不是由yield 暂停，同时最后一次调用next函数的时候，也没有yield抛出一个值了，这个时候return 的值就作为最后一次调用得到的迭代结果对象的value属性的值</p>
<h3 data-id="heading-4">生成器迭代器</h3>
<p>可迭代对象可以产出迭代器，这个迭代器实现了可迭代协议,同时也是一个可迭代对象,我们还可以覆写上面的例子</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> *<span class="hljs-title function_">getSeriesValue</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> nextVal;
    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>){
        <span class="hljs-keyword">if</span> (nextVal === <span class="hljs-literal">undefined</span>) {
            nextVal = <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
            nextVal = nextVal * <span class="hljs-number">3</span> + <span class="hljs-number">6</span>;
        }

        <span class="hljs-keyword">yield</span> nextVal;
    }
}

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> v <span class="hljs-keyword">of</span> <span class="hljs-title function_">getSeriesValue</span>()) {
    <span class="hljs-keyword">if</span> (v &gt; <span class="hljs-number">500</span>) {
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(v);
}
</code></pre>
<p>for...of调用break后，会向迭代器发送一个信号终止,也可以使用迭代器的return函数,调用return函数后，所有的所需yield都会被忽略,传递给return函数的参数会作为迭代结果对象的value属性的值，</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> *<span class="hljs-title function_">getSeriesValue</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> nextVal;
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">if</span> (nextVal === <span class="hljs-literal">undefined</span>) {
        nextVal = <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
        nextVal = nextVal * <span class="hljs-number">3</span> + <span class="hljs-number">6</span>;
    }
    <span class="hljs-keyword">yield</span> nextVal;
  }
}

<span class="hljs-keyword">const</span> it = <span class="hljs-title function_">getSeriesValue</span>()
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> v <span class="hljs-keyword">of</span> it) {
    <span class="hljs-keyword">if</span> (v &gt; <span class="hljs-number">500</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(it.<span class="hljs-keyword">return</span>(<span class="hljs-string">"down"</span>).<span class="hljs-property">value</span>); <span class="hljs-comment">//down</span>
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(v);
}


<span class="hljs-comment">//1</span>
<span class="hljs-comment">//9</span>
<span class="hljs-comment">//33</span>
<span class="hljs-comment">//105</span>
<span class="hljs-comment">//321</span>
<span class="hljs-comment">//down</span>
<span class="hljs-comment">//969</span>
</code></pre>
<p>使用return终止当前的迭代器后，done为true,所以for...of也就不会继续循环下去了。</p>
<h2 data-id="heading-5">总结</h2>
<p>基于上述，我们可以认为生成器的一个用法就是用于生产一系列值，它生成一个迭代器同时也是可迭代对象，可以给for...of连续产出一系列值,或者自己next调用非连续的产出值</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React19事件调度的设计思路]]></title>    <link>https://juejin.cn/post/7602133286644072498</link>    <guid>https://juejin.cn/post/7602133286644072498</guid>    <pubDate>2026-02-02T15:51:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602133286644072498" data-draft-id="7601929765533909043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React19事件调度的设计思路"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-02-02T15:51:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秀秀不只会前端"/> <meta itemprop="url" content="https://juejin.cn/user/1410009035452887"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React19事件调度的设计思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1410009035452887/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秀秀不只会前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-02T15:51:55.000Z" title="Mon Feb 02 2026 15:51:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>先说结论，React 选择 MessageChannel 完成事件调度，是因为它：</strong></p>
<ul>
<li>属于宏任务（不会饿死浏览器：JavaScript 一直占着主线程，导致浏览器一直没有机会去做它必须做的事（渲染、响应输入、布局、绘制））</li>
<li>延迟极低（接近微任务，但不会阻塞渲染）</li>
<li>相较于 rAF 不绑定渲染帧</li>
<li>可控、可中断、可让出主线程</li>
</ul>
</blockquote>
<h2 data-id="heading-0">一、React 调度和事件循环的密切联系</h2>
<h3 data-id="heading-1">1、React 在“调度”什么？</h3>
<blockquote>
<p>React 调度的不是「事件」， React 调度的是：<strong>Fiber 渲染任务（render work）</strong></p>
</blockquote>
<p>也就是我上篇文章说过的这些东西：</p>
<ul>
<li><code>beginWork</code></li>
<li><code>completeWork</code></li>
<li>diff</li>
<li>构建 workInProgress Fiber 树</li>
</ul>
<p>React Scheduler 的目标只有是：<strong>在不阻塞浏览器的前提下，尽可能多地推进 Fiber 渲染进度。</strong></p>
<p>所以 Scheduler 需要满足：</p>
<ul>
<li>能反复被调用</li>
<li>每次执行一小部分</li>
<li>执行完就“让出主线程”</li>
</ul>
<h3 data-id="heading-2">2、回忆浏览器事件循环</h3>
<p>事件循环模型：</p>
<pre><code class="hljs language-Plain" lang="Plain">┌─────────────┐
│ 宏任务队列（Task）     │  ← setTimeout / MessageChannel / rAF callback
└─────┬───────┘
          ↓
      执行 JS
          ↓
┌─────────────┐
│ 微任务队列（一次性清空） │  ← Promise.then / queueMicrotask
└─────┬───────┘
          ↓
      清空所有微任务
          ↓
      浏览器渲染（paint）
</code></pre>
<p>因此，为了满足上述 Scheduler 的需求，我们只能选择 Task（后续详细说明为什么最终选择了 MessageChannel）。</p>
<h2 data-id="heading-3">二、React Scheduler 源码（React 19）</h2>
<p>在 <code>packages/scheduler/src/forks/SchedulerHostConfig.default.js</code></p>
<p>核心逻辑（简化）：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
<span class="hljs-keyword">const</span> port = channel.<span class="hljs-property">port2</span>;

channel.<span class="hljs-property">port1</span>.<span class="hljs-property">onmessage</span> = performWorkUntilDeadline;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">requestHostCallback</span>(<span class="hljs-params"/>) {
  port.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 用 MessageChannel 来“自我唤醒”</span>
}
</code></pre>
<p>Scheduler 执行模型：</p>
<pre><code class="hljs language-Plain" lang="Plain">MessageChannel 回调触发
↓
performWorkUntilDeadline
↓
while (还有任务 &amp;&amp; 没超时) {
  执行 Fiber work
}
↓
时间不够 → 再发一次 MessageChannel（MessageChannel 是“下一次调度 tick”的触发器）
</code></pre>
<h2 data-id="heading-4">三、为什么不用微任务（Promise / queueMicrotask）</h2>
<p>假如 React 用微任务会发生什么？</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(workLoop)
</code></pre>
<h3 data-id="heading-5">问题 1：会阻塞渲染</h3>
<blockquote>
<p>微任务会在 <strong>paint 之前全部执行完</strong></p>
</blockquote>
<p>意味着：</p>
<pre><code class="hljs language-Plain" lang="Plain">React 继续 work
→ work 里又调度微任务
→ 浏览器：你先别画
→ UI 卡死
</code></pre>
<p><strong>这完全就是 Fiber 的“时间切片”的对立做法。</strong></p>
<h3 data-id="heading-6">问题 2：微任务不可中断</h3>
<ul>
<li>微任务一旦开始</li>
<li>浏览器<strong>必须清空</strong></li>
<li>React 无法“让出主线程”，更没法实现并发渲染</li>
</ul>
<h2 data-id="heading-7">四、为什么不用 setTimeout</h2>
<p>setTimeout 的问题不是“慢”，而是“不稳定”。</p>
<h3 data-id="heading-8">问题 1：最小延迟不可靠</h3>
<ul>
<li>HTML 标准：<strong>​最小 4ms（​</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Ftimers-and-user-prompts.html%23dom-settimeout" target="_blank" title="https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#dom-settimeout" ref="nofollow noopener noreferrer">HTML Living Standard — Last Updated 31 January 2026</a><strong>）</strong>
<blockquote>
<p>If nesting level is greater than 5, and timeout is less than 4, then set timeout to 4.</p>
<p>setTimeout 在嵌套层级超过 5 层，timeout（延时）如果小于 4ms，那么则会设置为 4ms，这个时差是 React 无法接受的。</p>
</blockquote>
</li>
<li>精度太粗（Scheduler：“当前帧还能不能再干 2ms 的活？”）</li>
</ul>
<h2 data-id="heading-9">五、为什么不用 requestAnimationFrame（rAF）</h2>
<h3 data-id="heading-10">1、rAF 被绑定到“渲染帧”</h3>
<pre><code class="hljs language-Plain" lang="Plain">一帧 ≈ 16.6ms
</code></pre>
<p>但 React 的目标是：<strong>​只要主线程空一点，我就推进一点 Fiber；​</strong>而不是：“非要等下一帧”。</p>
<h3 data-id="heading-11">2、rAF 在后台不执行</h3>
<p>浏览器会暂停 rAF（选择性跳过渲染帧），React 更新直接“冻结”！</p>
<h2 data-id="heading-12">六、还得是 MessageChannel ~</h2>
<p>MessageChannel 是什么？</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
<span class="hljs-comment">// 两个频道端口，这两个端口可以相互通信</span>
<span class="hljs-keyword">const</span> port1 = channel.<span class="hljs-property">port1</span>;
<span class="hljs-keyword">const</span> port2 = channel.<span class="hljs-property">port2</span>;
btn1.<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
  <span class="hljs-comment">// port2 给 port1 发消息</span>
  port2.<span class="hljs-title function_">postMessage</span>(content.<span class="hljs-property">value</span>);
}
<span class="hljs-comment">// port1 监听自己受到的消息</span>
port1.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`port1 收到了来自 port2 的消息：<span class="hljs-subst">${event.data}</span>`</span>);
}
</code></pre>
<p>MessageChannel 完美规避掉上述一系列缺点：</p>
<p><strong>MessageChannel + shouldYield =&gt; 时间切片。</strong></p>
<p>React 并不是“无脑跑”，而是每一小段都问一句：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title function_">shouldYield</span>()
</code></pre>
<p>判断依据：</p>
<ul>
<li>performance.now()</li>
<li>帧预算</li>
<li>用户输入是否 pending</li>
</ul>
<p><strong>如果该让出：</strong></p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title function_">requestHostCallback</span>() <span class="hljs-comment">// 再发一个 MessageChannel</span>
<span class="hljs-keyword">return</span>;
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">[宏任务] MessageChannel
  ↓
  React 执行 Fiber work（2~5ms）
  ↓
  shouldYield = true
  ↓
  postMessage 再约一次
  ↓
[浏览器有机会 paint / 处理输入]
  ↓
[下一次 MessageChannel]
</code></pre>
<h2 data-id="heading-13">七、彩蛋来咯</h2>
<h3 data-id="heading-14">1、<code>requestAnimationFrame</code></h3>
<blockquote>
<p>盲猜很多同学对于上面若干种不如 MessageChannel 的做法还不是很清楚，根本在于事件循环掌握的不好，我这里针对事件循环的**<code>requestAnimationFrame</code>**详细讲讲（其他知识点可以翻看我之前写的关于事件循环的文章，讲解的非常清楚）。</p>
</blockquote>
<p>事件循环里面的 <code>requestAnimationFrame</code> 仅仅是一个跟着渲染帧走的“小弟”，有渲染才有 rAF：</p>
<ul>
<li>它不能“缩短”上一个 16.66ms 中 Task 的执行时间</li>
<li>保证回调只会在“浏览器即将渲染下一帧之前”执行</li>
</ul>
<p>因此如果上一帧的 Task 太重导致错过渲染窗口，浏览器会直接“丢帧”，而不是排队执行导致连锁累积卡顿（setTimeout 的做法）</p>
<blockquote>
<p>rAF 回调永远不会挤占渲染时机，只会“对齐”渲染节奏</p>
</blockquote>
<blockquote>
<p>“丢帧”这个概念，对于数码产品经常关注的同学应该会非常熟悉。我们拿游戏“原神”举例子，帧率越高动画越流畅，而如果某一帧事件 Task 执行时间太长（超过 1 帧总时长），rAF 就不再执行，这帧就被自动“丢掉了”。而一些手机厂商为了弥补这个问题，所以就出现了手动“插帧”的做法。</p>
<p>一般地，1s 对应着 60 帧，而 1 帧就是 16.66ms。如果一个 Task 超过了 16.66ms，那么就占用了下一帧的时间，下一帧则不再 rAF/paint （出现丢帧）。但如果我们使用低帧率，假如使用 30 帧 1s，那么 1 帧就是 33.3ms，这样虽然画质变差了，但是动画流畅度确实更好了。</p>
</blockquote>
<p>浏览器在一帧内要做的事情（简化）：</p>
<pre><code class="hljs language-Plain" lang="Plain">JS Task（古老说法：宏任务）
→ 微任务
→ rAF
→ 样式计算
→ Layout
→ Paint
→ Composite
→ 屏幕显示
</code></pre>
<p>​<strong>只要 JS Task 超过 ~16ms，浏览器就来不及渲染这一帧</strong>​，结果就是：</p>
<ul>
<li>这一帧直接没画出来（掉帧）</li>
<li>用户看到卡顿</li>
</ul>
<p>假设这样写动画：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-built_in">setTimeout</span>(step, <span class="hljs-number">16</span>)
</code></pre>
<p>发生了什么？</p>
<pre><code class="hljs language-Plain" lang="Plain">Task A (20ms)  超过 16ms
↓
setTimeout 回调排队
↓
Task B (又 20ms)
↓
Task C ...
</code></pre>
<p>后果是：</p>
<ul>
<li>定时器 <strong>只管时间，不管渲染（这是“时间驱动”，不是“渲染驱动”）</strong></li>
<li>回调会 <strong>持续排队</strong></li>
<li>每一帧都被 JS Task 挤爆</li>
<li>卡顿会 <strong>累积 + 放大</strong></li>
</ul>
<p>如果改为 rAF：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">requestAnimationFrame</span>(callback) <span class="hljs-comment">// “当浏览器准备开始下一次渲染之前，调用我”</span>
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">while (true) {
  1. 取一个 Task 执行（macro task）
  2. 执行所有 microtasks
  3. 【渲染检查点】（当前时间 - 上一帧渲染时间 &lt; 16.66ms（60Hz））
     - requestAnimationFrame
     - style / layout / paint
}
</code></pre>
<blockquote>
<p>当然，如果 Task 一直执行得太久，<code>requestAnimationFrame</code> 一直得不到执行，本质上仍然是卡顿，而且是「主线程被长期占用型卡顿」。所以 rAF 并不能拯救被 JS 完全占死的主线程。</p>
</blockquote>
<h3 data-id="heading-15">2、用时间轴演示卡顿</h3>
<h4 data-id="heading-16">卡顿：场景一</h4>
<p><strong>类型一：JS 把主线程彻底占死（致命卡顿）</strong></p>
<p><code>Task 200ms</code>​<code>Task 200ms</code>​<code>Task 200ms</code></p>
<p>结果：</p>
<ul>
<li>rAF</li>
<li>Render</li>
<li>输入响应</li>
<li>页面假死</li>
</ul>
<blockquote>
<p><strong>rAF 无解</strong></p>
</blockquote>
<p><strong>类型二：单帧偶尔超时（可恢复卡顿）</strong></p>
<p><code>Task 20ms（偶发）</code>​<code>Task 5ms</code>​<code>Task 5ms</code></p>
<p>结果：</p>
<ul>
<li>掉 1 帧</li>
<li>后续帧恢复</li>
<li>动画继续</li>
</ul>
<blockquote>
<p><strong>这是 rAF 的“主战场”</strong></p>
</blockquote>
<h4 data-id="heading-17">卡顿：场景二</h4>
<p>假设场景</p>
<ul>
<li>屏幕 60Hz（16.6ms / 帧）</li>
<li>每个动画 step 的 JS 执行 <strong>18ms</strong></li>
<li>使用 <code>setTimeout(step, 16)</code></li>
</ul>
<p>第 1 帧（已经开始出问题）</p>
<p><code>0ms   Task: step 执行（18ms）</code>​<code>18ms  microtasks</code>​<code>18ms  ❌ 超过 16.6ms，无法渲染</code>​<code>18ms  setTimeout 已经到期 → 下一个 step 已在 Task 队列中</code></p>
<p>结果：<strong>没渲染，但 JS 没停</strong></p>
<p>第 2 帧（开始积压）</p>
<p><code>18ms  Task: step 执行（18ms）</code>​<code>36ms  microtasks</code>​<code>36ms  ❌ 又错过渲染</code>​<code>36ms  下一个 step 继续排队</code></p>
<p>第 N 帧（雪崩）</p>
<p><code>Task → Task → Task → Task → Task </code>​<code> 18ms   18ms   18ms   18ms   18ms</code></p>
<p>表现为：</p>
<ul>
<li>JS 一直在跑</li>
<li>浏览器几乎没有 Render 机会</li>
<li>页面看起来 <strong>卡住不动</strong></li>
<li>CPU 占满</li>
</ul>
<p>setTimeout 只认：<code>时间到了 → 执行回调</code></p>
<p>不管：</p>
<ul>
<li>主线程忙不忙</li>
<li>能不能渲染</li>
<li>用户是不是在滚动 / 点击</li>
</ul>
<p>当一帧没画出来：</p>
<ul>
<li>rAF：<strong>直接跳过</strong></li>
<li>setTimeout：<strong>继续补执行(它会制造“补帧”)</strong></li>
</ul>
<p>这意味着：<strong>错过的帧会变成多余的 JS 工作量</strong></p>
<h3 data-id="heading-18">3、用户体感 vs setTimeout</h3>
<p><strong>setTimeout（雪崩）</strong></p>
<p><code>Task Task Task Task Task </code>​<code>18ms 18ms 18ms 18ms</code></p>
<ul>
<li>JS 连续霸占主线程</li>
<li>Render 几乎进不去</li>
<li>页面“僵死”</li>
</ul>
<p><strong>requestAnimationFrame（稳定但慢）</strong></p>
<p><code>step →（等下一帧）→ step →（等下一帧）→ step</code></p>
<ul>
<li>每帧最多执行一次</li>
<li>Render 之间有喘息</li>
<li>页面还能响应输入</li>
<li>动画只是 <strong>低 FPS(这是“慢”，不是“死”)</strong></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>