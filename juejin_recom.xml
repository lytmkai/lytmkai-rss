<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[【Android技能点】启动链路 + AMS/ATMS 基础概念掌握]]></title>    <link>https://juejin.cn/post/7592340733953228850</link>    <guid>https://juejin.cn/post/7592340733953228850</guid>    <pubDate>2026-01-07T06:17:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592340733953228850" data-draft-id="7592234632482865161" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 【Android技能点】启动链路 + AMS/ATMS 基础概念掌握"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-07T06:17:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="莫比乌斯环"/> <meta itemprop="url" content="https://juejin.cn/user/2840793776394269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             【Android技能点】启动链路 + AMS/ATMS 基础概念掌握
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2840793776394269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    莫比乌斯环
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T06:17:53.000Z" title="Wed Jan 07 2026 06:17:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大家好，这里是你们的技术小伙伴！今天我们来聊聊一个听起来“高端大气上档次”的话题——Android 启动链路以及 AMS/ATMS 的基础技能。别急着逃跑！虽然名字看起来像是编程界的黑魔法，但其实它们一点也不可怕。今天我就用轻松搞笑的方式，带你们快速入门这些看似复杂的概念！</p>
</blockquote>
<h2 data-id="heading-0">关联文章</h2>
<ul>
<li><a href="https://juejin.cn/editor/drafts/7592234632482865161" target="_blank" title="https://juejin.cn/editor/drafts/7592234632482865161">启动链路 + AMS/ATMS 基础概念掌握</a></li>
<li><a href="https://juejin.cn/spost/7592241336290017331" target="_blank" title="https://juejin.cn/spost/7592241336290017331">一张图理清 开机、App启动流程</a></li>
</ul>
<h2 data-id="heading-1">什么是 Android 启动链路？</h2>
<p>简单来说，Android 启动链路就是手机从按下电源键到桌面出现的全过程。这个过程就像你早上起床一样，从闹钟响起（bootloader 启动），到你迷迷糊糊穿衣服（系统服务启动），再到你精神焕发地打开手机刷朋友圈（应用启动）。整个流程相当复杂，但也充满了“工程美感”（程序员的自我安慰）。</p>
<h3 data-id="heading-2">启动链路的几个关键阶段</h3>
<ol>
<li>
<p><strong>Bootloader 阶段</strong><br/>
Bootloader 就像你的闹钟，负责把你从梦乡中叫醒。当然，Bootloader 不会喊“快起床！要迟到了！”，它的工作是加载操作系统内核，让设备从硬件层面进入软件层面。简单说，Bootloader 是启动链路的开场白。</p>
</li>
<li>
<p><strong>内核启动</strong><br/>
内核启动就像你打着哈欠从床上爬起来，开始协调身体各个部分的工作。内核负责初始化系统硬件，比如 CPU、内存、存储设备等。没有内核，就像没有咖啡的早晨，啥也干不成。</p>
</li>
<li>
<p><strong>Zygote 启动</strong><br/>
Zygote 是 Android 系统的核心部分之一，它负责创建应用进程。可以理解为 Zygote 是个“克隆机器”，每次你打开一个应用，它都会从 Zygote 中“复制”出一个新的进程。Zygote 是个勤劳的小伙伴，但也有点懒，因为它会尽可能地复用资源来提高效率。</p>
</li>
<li>
<p><strong>SystemServer 启动</strong><br/>
SystemServer 就像你的大脑，负责管理系统服务，比如 AMS 和 ATMS。SystemServer 一旦启动，整个系统就正式进入了“工作模式”。</p>
</li>
<li>
<p><strong>应用启动</strong><br/>
最后一步就是我们最熟悉的部分：点击图标打开应用。这一步看似简单，实际上背后有一整个复杂的调用链条在支撑。AMS 和 ATMS 就在这里发挥了重要作用。</p>
</li>
</ol>
<h2 data-id="heading-3">AMS 和 ATMS 是什么鬼？</h2>
<p>AMS（Activity Manager Service）和 ATMS（Activity Task Manager Service）是 Android 系统中两位“隐形英雄”，它们在后台默默工作，让我们的手机使用体验更加流畅。</p>
<h3 data-id="heading-4">AMS：活动管理服务</h3>
<p>AMS 的主要职责是管理应用的生命周期。比如，当你切换应用时，AMS 会负责暂停当前应用、启动新应用、回收后台资源等等。AMS 就像一个严谨的时间管理大师，它会确保每个应用都按照规则运行，不会“抢戏”。</p>
<p>举个例子，如果你打开微信后又切到微博，那么 AMS 会把微信放到后台，同时把微博推到前台。AMS 还会在后台偷偷观察微信：“嘿，你别占太多内存啊，不然我就把你干掉了！”</p>
<h3 data-id="heading-5">ATMS：任务管理服务</h3>
<p>ATMS 是 AMS 的好搭档，它主要负责管理任务栈。任务栈可以理解为应用运行时的“历史记录”。比如，当你从微信点开一个网页，然后再返回微信时，这些操作都会记录在任务栈中。</p>
<p>ATMS 就像一个“叠罗汉”高手，每次你打开一个新页面，它都会把这个页面压在任务栈的最上方。当你按下返回键时，它会依次弹出栈顶页面，直到回到桌面。是不是很聪明？</p>
<h2 data-id="heading-6">如何快速掌握这些技能？</h2>
<p>了解了基础概念后，我们再来聊聊如何快速掌握这些技能。其实，你并不需要记住所有细节，只要掌握几个关键点，就能在项目中游刃有余。</p>
<ol>
<li>
<p><strong>多画流程图</strong><br/>
理解启动链路和 AMS/ATMS 的最佳方法就是画流程图。把每个阶段画出来，再用箭头连接起来，你会发现这些复杂的概念其实很有逻辑。</p>
</li>
<li>
<p><strong>多看日志</strong><br/>
如果你是开发者，那就多打开 Logcat，观察系统启动和应用启动时的日志。通过日志，你可以直观地看到 AMS 和 ATMS 的工作过程。</p>
</li>
<li>
<p><strong>多写代码</strong><br/>
学习最好的方式就是实践！试着写一些简单的代码，比如自定义启动流程或者模拟任务栈操作，这样可以帮助你更深入地理解这些机制。</p>
</li>
<li>
<p><strong>多问问题</strong><br/>
不懂就问，不要害怕暴露自己的“菜鸟”身份。每个大佬都是从小白一步步成长起来的！</p>
</li>
</ol>
<h2 data-id="heading-7">最后的一点点鸡汤</h2>
<p>学习 Android 启动链路和 AMS/ATMS 可能会让你感觉有点烧脑，但只要坚持下去，你一定会发现其中的乐趣。毕竟，每个技术大神都是从“啥都不懂”开始的！</p>
<p>所以，不要害怕挑战，让我们一起成为 Android 开发界的“隐藏高手”吧！加油，冲鸭！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack MVVM]]></title>    <link>https://juejin.cn/post/7592166340381294607</link>    <guid>https://juejin.cn/post/7592166340381294607</guid>    <pubDate>2026-01-07T07:04:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592166340381294607" data-draft-id="7592127014188171264" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack MVVM"/> <meta itemprop="keywords" content="Android Jetpack"/> <meta itemprop="datePublished" content="2026-01-07T07:04:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XRay"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685869288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack MVVM
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685869288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XRay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T07:04:09.000Z" title="Wed Jan 07 2026 07:04:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Android开发中的架构</h3>
<p>Android中的开发架构是用来描述 <strong>视图层</strong> 、 <strong>逻辑层</strong> 和 <strong>数据层</strong> 三者之间的关系的。</p>
<ul>
<li>视图层：用户界面，即界面的展示和交互事件的响应。</li>
<li>逻辑层：为了实现系统功能而进行的必要逻辑。</li>
<li>数据层：数据的获取和存储，含本地数据和服务器数据。</li>
</ul>
<p>一般我们的架构之路是从 MVC -&gt; MVP -&gt; MVVM 演变的。</p>
<h5 data-id="heading-1">MVC</h5>
<p>MVC，Model-View-Controller，职责分类如下：</p>
<ul>
<li>Model，模型层，即数据模型，用于获取和存储数据。</li>
<li>View，视图层，在Android中就是xml布局。</li>
<li>Controller，控制层，负责业务逻辑。</li>
</ul>
<p>View接收到用户操作事件，通知到Controller进行对应的逻辑处理，然后通知Model去获取/更新数据，Model再把新的数据传递给View更新界面，这就是一个完整MVC的数据流向。</p>
<p>但在Android中，因为xml布局作为视图层能力很弱，很多操作View的代码是写在Activity/Fragment中的，而业务逻辑同样也是写在Activity/Fragment中。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f8afa9122ab440eda6095265f71a66d1~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=369&amp;h=237&amp;s=4078&amp;e=webp&amp;a=1&amp;b=fdfdfd" alt="MVC" loading="lazy"/></p>
<p>所以，Android中MVC的问题点如下：</p>
<ol>
<li>Activity/Fragment的责任不明确，同时负责View和Controller，这样就导致Activity/Fragment的代码量很大，不满足单一职责原则。</li>
<li>Model耦合View，View的修改会导致Controller和Model都进行改动，不满足最少知识原则。</li>
</ol>
<h5 data-id="heading-2">MVP</h5>
<p>MVP，Model-View-Presenter，职责分类如下：</p>
<ul>
<li>Model，模型层，即数据模型，用于获取和存储数据。</li>
<li>View，视图层，即Activity/Fragment.</li>
<li>Presenter，控制层，负责业务逻辑。</li>
</ul>
<p>MVP解决了MVC的问题：<br/>
1.Activity/Fragment的责任明确，逻辑不再写在Activity/Fragment中，而是在Presenter中；<br/>
2.Model不再持有View。</p>
<p>View层接收到用户操作事件后，调用Presenter进行逻辑处理，然后通知Model获取或更新数据，Model把数据给到Presenter，Presenter再通知View更新界面。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/236ecae85abe4b82bda2953bcc584fb6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=379&amp;h=221&amp;s=4672&amp;e=webp&amp;a=1&amp;b=fefefe" alt="MVP" loading="lazy"/></p>
<p>MVP的实现思路：</p>
<ul>
<li>UI逻辑抽象成IView接口，由具体的Activity实现类来完成，且调用Presenter进行逻辑处理。</li>
<li>业务逻辑抽象成IPresenter接口，由具体的Presenter实现类来完成。逻辑操作完成后调用IView接口方法刷新UI。</li>
</ul>
<p>MVP本质是<strong>面向接口编程，实现了依赖倒置</strong>原则。MVP解决了View层责任不明确的问题，但并没有解决代码耦合的问题，View和Presenter之间相互持有。</p>
<p>所以，MVP的问题点如下：</p>
<ol>
<li>会引入大量的IView、IPresenter接口，增加实现的复杂度。</li>
<li>View和Presenter相互持有，形成耦合。</li>
</ol>
<h5 data-id="heading-3">MVVM</h5>
<p>MVVM，Model-View-ViewModel，职责分类如下：</p>
<ul>
<li>Model，模型层，即数据模型，用于获取和存储数据。</li>
<li>View，视图，即Activity/Fragment。</li>
<li>ViewModel，视图模型，负责业务逻辑。</li>
</ul>
<blockquote>
<p>注意，MVVM这里的ViewModel就是一个名称，可以理解为MVP中的Presenter。不等同于前面文章中的ViewModel组件 ，Jetpack ViewModel组件是对MVVM的ViewModel的具体实施方案。</p>
</blockquote>
<p>MVVM的本质是<strong>数据驱动</strong>，把解耦做的更彻底，ViewModel不持有View 。</p>
<p>View产生事件，使用ViewModel进行逻辑处理后，通知Model更新数据，Model把更新的数据给ViewModel，ViewModel<strong>自动通知View更新界面</strong>，<strong>而不是主动调用View的方法</strong>。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4933d313a8e54f0e9edc2ef440686b29~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=379&amp;h=217&amp;s=4326&amp;e=webp&amp;a=1&amp;b=fdfdfd" alt="MVVM" loading="lazy"/></p>
<blockquote>
<p>到这里你会发现，所谓的架构模式本质上理解很简单。比如MVP，甚至你都可以忽略这个名字，理解成在更高的层面上面向接口编程，实现了依赖倒置原则，就是这么简单。</p>
</blockquote>
<h3 data-id="heading-4">MVVM的实现 —— Jetpack MVVM</h3>
<p>Jetpack MVVM是MVVM架构在Android开发中的一种具体实现方式，是Google官方提供并推荐的。</p>
<p>Jetpack MVVM不仅通过数据驱动实现了View与ViewModel的解耦，还兼顾了Android页面开发中其他不可预期的错误，例如Lifecycle能妥善处理页面生命周期，避免View的空指针问题，ViewModel使得配置更改导致Activity重建时无需重新向后台请求数据，节省了开销。</p>
<p>首先，请看下图，该图显示了所有模块应如何彼此交互： <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e7a8bfa7b6234b3eabae4ff33df78722~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=960&amp;h=720&amp;s=19858&amp;e=webp&amp;a=1&amp;b=26f2c2" alt="Jetpack MVVM 架构" loading="lazy"/></p>
<p>各模块对应MVVM架构：</p>
<ul>
<li><strong>View层：Activity/Fragment</strong></li>
<li><strong>ViewModel层：Jetpack ViewModel + Jetpack LivaData</strong></li>
<li><strong>Model层：Repository仓库，包含 本地持久性数据 和 服务端数据</strong></li>
</ul>
<p><strong>View层</strong> 包含了我们平时写的Activity/Fragment/布局文件等与界面相关的东西。</p>
<p><strong>ViewModel层</strong> 用于持有和UI相关的LiveData数据，以保证这些数据在屏幕旋转时不会丢失，并且还要提供接口给View层调用以及和仓库层进行通信。</p>
<p><strong>Model层</strong> 要做的主要工作是判断调用方请求的数据应该从本地数据源中获取还是从网络数据源中获取，并将获取到的数据返回给调用方。本地数据源可以使用数据库、SharedPreferences等持久化技术来实现，而网络数据源则通常使用Retrofit访问服务器提供的Webservice接口来实现。</p>
<p>另外，图中所有的箭头都是单向的，例如View层指向了ViewModel层，表示View层会持有ViewModel层的引用，但是反过来<strong>ViewModel层却不能持有View层的引用</strong>。除此之外，引用也不能跨层持有，比如View层不能持有仓库层的引用，谨记每一层的组件都只能与它相邻层的组件进行交互。</p>
<p>这种设计打造了一致且愉快的用户体验。无论用户上次使用应用是在几分钟前还是几天之前，现在回到应用时都会立即看到应用在本地保留的数据。如果此数据已过期，则应用的Repository将开始在后台更新数据。</p>
<h5 data-id="heading-5">示例</h5>
<p>这里以一个获取天气信息并展示的业务来说明如何实现Jetpack MVVM。</p>
<p>新建一个天气信息类，里面有2个字段，一个字段用来表示什么样的天气，另一个表示温度：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherInfo</span> {
    <span class="hljs-comment">//晴天/雨天/多云...</span>
    <span class="hljs-keyword">private</span> String text;
    <span class="hljs-comment">//温度</span>
    <span class="hljs-keyword">private</span> String temp;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getText</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> text;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setText</span><span class="hljs-params">(String text)</span> {
        <span class="hljs-built_in">this</span>.text = text;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTemp</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> temp;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTemp</span><span class="hljs-params">(String temp)</span> {
        <span class="hljs-built_in">this</span>.temp = temp;
    }
}
</code></pre>
<p>为了实现数据驱动，需要使用LiveData来包装天气信息，其中loadingLiveData是用来控制进度条的显示的。根据上面的架构图，还需要使用ViewModel来存储LiveData，这样在屏幕旋转时LiveData的数据不会丢失：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherInfoViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewModel</span> {
    <span class="hljs-comment">//天气信息</span>
    <span class="hljs-keyword">private</span> MutableLiveData&lt;WeatherInfo&gt; weatherInfoLiveData;
    <span class="hljs-comment">//进条度的显示</span>
    <span class="hljs-keyword">private</span> MutableLiveData&lt;Boolean&gt; loadingLiveData;

    <span class="hljs-keyword">public</span> LiveData&lt;WeatherInfo&gt; <span class="hljs-title function_">getWeatherInfoLiveData</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> weatherInfoLiveData;
    }

    <span class="hljs-keyword">public</span> LiveData&lt;Boolean&gt; <span class="hljs-title function_">getLoadingLiveData</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> loadingLiveData;
    }
}
</code></pre>
<blockquote>
<p>LiveData是一种可观察的数据存储器，应用组件（如 Activity、Fragment 和 Service）可以使用此存储器监控对象的更改，而无需在它们之间创建明确且严格的依赖路径。LiveData组件还遵循应用组件的生命周期状态，并包括清理逻辑以防止对象泄漏和过多的内存消耗。</p>
</blockquote>
<p>注意到WeatherInfoViewModel类暴露的getWeatherInfoLiveData()方法返回的是LiveData类型，即不可变的，而不是MutableLiveData，好处是避免数据在外部被更改。</p>
<p>我们在WeatherActivity中观察LiveData的更新：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span>{

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        ...
        initData();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initData</span><span class="hljs-params">()</span>{
        <span class="hljs-type">ViewModelProvider</span> <span class="hljs-variable">viewModelProvider</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewModelProvider</span>(<span class="hljs-built_in">this</span>);
        <span class="hljs-type">WeatherInfoViewModel</span> <span class="hljs-variable">weatherInfoViewModel</span> <span class="hljs-operator">=</span> viewModelProvider.get(WeatherInfoViewModel.class);

        weatherInfoViewModel.getWeatherInfoLiveData().observe(<span class="hljs-built_in">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>&lt;WeatherInfo&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onChanged</span><span class="hljs-params">(WeatherInfo weatherInfo)</span> {
                <span class="hljs-comment">//更新天气信息</span>
                mTvWeather.setText(weatherInfo.getText());
                mTvTemp.setText(weatherInfo.getTemp());
            }
        });

        weatherInfoViewModel.getLoadingLiveData().observe(<span class="hljs-built_in">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>&lt;Boolean&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onChanged</span><span class="hljs-params">(Boolean aBoolean)</span> {
                <span class="hljs-comment">//显示或隐藏加载进度条</span>
                mProgressBar.setVisibility(aBoolean? View.VISIBLE:View.GONE);
            }
        });

        ...

    }

}
</code></pre>
<p>每次天气信息更新，相应的onChanged()方法都会回调，而不需要ViewModel主动调用View层方法更新UI，这就是<strong>数据驱动</strong> —— 数据的更改驱动View自动更新。</p>
<p>因为LiveData具有生命周期感知能力，这意味着，只有Activity处于活跃状态，onChanged()才会回调。当Activity的onDestroy()执行时，LiveData会自动移除观察者。</p>
<p>鉴于WeatherInfoViewModel对象比对应的View对象存活的时间更长，WeatherInfoViewModel中不得包含对View对象的直接引用，包括Context。</p>
<p>我们已经使用ViewModel将LiveData与Activity关联起来了，那么如何获取天气信息呢？</p>
<p>一个简单的想法是直接在ViewModel中使用OkHttp从服务器获取天气信息，获取成功后将数据设置给LiveData，但是这样会使ViewModel承担了太多的责任，违背了单一职责原则。</p>
<p>在上面的架构图中，ViewModel将数据获取过程委派给一个新的模块——Repository。这里我们也照着架构图新建一个类WeatherRepository，用来从服务器获取天气信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherRepository</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> WeatherRepository weatherRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> WeatherRepository <span class="hljs-title function_">getWeatherRepository</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (weatherRepository == <span class="hljs-literal">null</span>) {
            weatherRepository = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeatherRepository</span>();
        }
        <span class="hljs-keyword">return</span> weatherRepository;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getWeatherInfoFromServer</span><span class="hljs-params">(Callback callback)</span> {

        OkHttpClient.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.Builder()
                .connectTimeout(<span class="hljs-number">15L</span>, TimeUnit.SECONDS)
                .readTimeout(<span class="hljs-number">15L</span>, TimeUnit.SECONDS)
                .writeTimeout(<span class="hljs-number">15L</span>, TimeUnit.SECONDS)
                .retryOnConnectionFailure(<span class="hljs-literal">true</span>);

        <span class="hljs-type">HttpLoggingInterceptor</span> <span class="hljs-variable">logInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpLoggingInterceptor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpLoggingInterceptor</span>.Logger() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String message)</span> {
                Log.d(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"url info:"</span> + message);
            }
        });
        logInterceptor.setLevel(HttpLoggingInterceptor.Level.BODY);
        builder.addInterceptor(logInterceptor);

        <span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">okHttpClient</span> <span class="hljs-operator">=</span> builder.build();
        <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()
                .url(<span class="hljs-string">"http://xxxx"</span>)
                .get()
                .build();
        <span class="hljs-type">Call</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> okHttpClient.newCall(request);
        call.enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">okhttp3</span>.Callback() {

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> {
                Log.d(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"onFailure: "</span>);
                callback.onFailed(e.getMessage());
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException {
                <span class="hljs-keyword">if</span> (response.isSuccessful()) {
                    <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> response.body().string();
                    <span class="hljs-type">Gson</span> <span class="hljs-variable">gson</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Gson</span>();
                    WeatherInfo weatherInfo;
                    <span class="hljs-keyword">try</span> {
                        weatherInfo = gson.fromJson(data, WeatherInfo.class);
                        callback.onSuccess(weatherInfo);
                    } <span class="hljs-keyword">catch</span> (Exception e) {
                        Log.i(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"Exception e:"</span> + e.getMessage());
                    }
                }
            }

        });
    }
}
</code></pre>
<p>getWeatherInfoFromServer()方法传入一个接口回调Callback：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Callback</span>&lt;T&gt; {
    <span class="hljs-comment">//成功的时候回调</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(T t)</span>;
    <span class="hljs-comment">//失败的时候回调</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailed</span><span class="hljs-params">(String msg)</span>;
}
</code></pre>
<p>在WeatherInfoViewModel中调用getWeatherInfoFromServer()方法，并在接口回调中修改LiveData中的值：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherInfoViewModel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewModel</span> {
    <span class="hljs-comment">//天气信息</span>
    <span class="hljs-keyword">private</span> MutableLiveData&lt;WeatherInfo&gt; weatherInfoLiveData;
    <span class="hljs-comment">//进条度的显示</span>
    <span class="hljs-keyword">private</span> MutableLiveData&lt;Boolean&gt; loadingLiveData;

    <span class="hljs-keyword">public</span> LiveData&lt;WeatherInfo&gt; <span class="hljs-title function_">getWeatherInfoLiveData</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> weatherInfoLiveData;
    }

    <span class="hljs-keyword">public</span> MutableLiveData&lt;Boolean&gt; <span class="hljs-title function_">getLoadingLiveData</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> loadingLiveData;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getWeatherInfo</span><span class="hljs-params">()</span>{
        <span class="hljs-comment">//获取天气信息前显示进度条</span>
        loadingLiveData.setValue(<span class="hljs-literal">true</span>);

        WeatherRepository.getWeatherRepository().getWeatherInfoFromServer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>&lt;WeatherInfo&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(WeatherInfo weatherInfo)</span> {
                <span class="hljs-comment">//获取成功后，让进度条消失</span>
                loadingLiveData.setValue(<span class="hljs-literal">false</span>);
                weatherInfoLiveData.setValue(weatherInfo);
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailed</span><span class="hljs-params">(String msg)</span> {
                loadingLiveData.setValue(<span class="hljs-literal">false</span>);
                weatherInfoLiveData.setValue(<span class="hljs-literal">null</span>);
            }
        });
    }
}
</code></pre>
<p>这样就把获取天气信息委派给了WeatherRepository，当我们还想从本地获取天气信息直接在WeatherRepository中添加相应的方法即可：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherRepository</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getWeatherInfoFromLocal</span><span class="hljs-params">()</span>{
        <span class="hljs-comment">//从本地获取天气信息</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveWeatherInfoToLocal</span><span class="hljs-params">()</span>{
        <span class="hljs-comment">//将天气信息存入本地</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getWeatherInfoFromServer</span><span class="hljs-params">()</span>{
        <span class="hljs-comment">//从服务器获取天气信息</span>
    }
}
</code></pre>
<p>最后，还要在Activity中，调用<code>weatherInfoViewModel.getWeatherInfo()</code>获取天气信息。这样，通过WeatherRepository获取到天气信息后，回调给ViewModel更新其中的LiveData的值，通过数据驱动，相应的View可以拿到天气信息更新UI。</p>
<p>以上就是通过Jetpack MVVM实现的MVVM架构的实现方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Luban 2：简洁高效的Android图片压缩库]]></title>    <link>https://juejin.cn/post/7592241336290033715</link>    <guid>https://juejin.cn/post/7592241336290033715</guid>    <pubDate>2026-01-07T06:53:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592241336290033715" data-draft-id="7592234632483127305" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Luban 2：简洁高效的Android图片压缩库"/> <meta itemprop="keywords" content="Kotlin,微信"/> <meta itemprop="datePublished" content="2026-01-07T06:53:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小熊码匠"/> <meta itemprop="url" content="https://juejin.cn/user/1585942854909582"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Luban 2：简洁高效的Android图片压缩库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1585942854909582/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小熊码匠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T06:53:15.000Z" title="Wed Jan 07 2026 06:53:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>Luban 2</code>（鲁班 2） —— <code>Android</code>图片压缩工具，仿微信朋友圈压缩策略。</p>
<h3 data-id="heading-0">📑 目录</h3>
<ul>
<li><a href="#-%E9%A1%B9%E7%9B%AE%E6%8F%8F%E8%BF%B0" title="#-%E9%A1%B9%E7%9B%AE%E6%8F%8F%E8%BF%B0">📖 项目描述</a></li>
<li><a href="#-%E6%95%88%E6%9E%9C%E4%B8%8E%E5%AF%B9%E6%AF%94" title="#-%E6%95%88%E6%9E%9C%E4%B8%8E%E5%AF%B9%E6%AF%94">📊 效果与对比</a>
<ul>
<li><a href="#-%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95%E7%89%B9%E6%80%A7" title="#-%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95%E7%89%B9%E6%80%A7">🔬 核心算法特性</a></li>
</ul>
</li>
<li><a href="#-%E5%AF%BC%E5%85%A5" title="#-%E5%AF%BC%E5%85%A5">📦 导入</a></li>
<li><a href="#-%E4%BD%BF%E7%94%A8" title="#-%E4%BD%BF%E7%94%A8">💻 使用</a>
<ul>
<li><a href="#-kotlin-coroutines" title="#-kotlin-coroutines">⚡ Kotlin (Coroutines)</a></li>
<li><a href="#-java--builder-%E6%A8%A1%E5%BC%8F" title="#-java--builder-%E6%A8%A1%E5%BC%8F">☕ Java / Builder 模式</a></li>
</ul>
</li>
<li><a href="#-%E6%8D%90%E5%8A%A9" title="#-%E6%8D%90%E5%8A%A9">☕ 捐助</a></li>
<li><a href="#-license" title="#-license">📄 License</a></li>
</ul>
<h2 data-id="heading-1">📖 项目描述</h2>
<p>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fcurzbin%2FLuban" target="_blank" title="https://gitee.com/curzbin/Luban" ref="nofollow noopener noreferrer">Gitee</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCurzibn%2FLuban" target="_blank" title="https://github.com/Curzibn/Luban" ref="nofollow noopener noreferrer">Github</a></p>
<p>目前做<code>App</code>开发总绕不开图片这个元素。但是随着手机拍照分辨率的提升，图片的压缩成为一个很重要的问题。单纯对图片进行裁切，压缩已经有很多文章介绍。但是裁切成多少，压缩成多少却很难控制好，裁切过头图片太小，质量压缩过头则显示效果太差。</p>
<p>于是自然想到<code>App</code>巨头"微信"会是怎么处理，<code>Luban</code>（鲁班）就是通过在微信朋友圈发送近100张不同分辨率图片，对比原图与微信压缩后的图片逆向推算出来的压缩算法。</p>
<p>因为是逆向推算，效果还没法跟微信一模一样，但是已经很接近微信朋友圈压缩后的效果，具体看以下对比！</p>
<p>本库是 <code>Luban</code> 的 <strong>Kotlin 重构版本</strong>，在升级核心算法的同时，利用 <strong>Kotlin Coroutines</strong> 和 <strong>TurboJPEG</strong> 进行了深度优化。新算法比原算法更加健壮和高效，提供更高效的异步处理和更优质的压缩效果。</p>
<h2 data-id="heading-2">📊 效果与对比</h2>















































<table><thead><tr><th align="left">图片类型</th><th align="left">原图（分辨率, 大小）</th><th align="left">Luban（分辨率, 大小）</th><th align="left">Wechat（分辨率, 大小）</th></tr></thead><tbody><tr><td align="left"><strong>标准拍照</strong></td><td align="left">3024×4032, 5.10MB</td><td align="left">1440×1920, 305KB</td><td align="left">1440×1920, 303KB</td></tr><tr><td align="left"><strong>高清大图</strong></td><td align="left">4000×6000, 12.10MB</td><td align="left">1440×2160, 318KB</td><td align="left">1440×2160, 305KB</td></tr><tr><td align="left"><strong>2K 截图</strong></td><td align="left">1440×3200, 2.10MB</td><td align="left">1440×3200, 148KB</td><td align="left">1440×3200, 256KB</td></tr><tr><td align="left"><strong>超长记录</strong></td><td align="left">1242×22080, 6.10MB</td><td align="left">758×13490, 290KB</td><td align="left">744×13129, 256KB</td></tr><tr><td align="left"><strong>全景横图</strong></td><td align="left">12000×5000, 8.10MB</td><td align="left">1440×600, 126KB</td><td align="left">1440×600, 123KB</td></tr><tr><td align="left"><strong>设计原稿</strong></td><td align="left">6000×6000, 6.90MB</td><td align="left">1440×1440, 263KB</td><td align="left">1440×1440, 279KB</td></tr></tbody></table>
<h3 data-id="heading-3">🔬 核心算法特性</h3>
<p>本库采用<strong>自适应统一图像压缩算法 (Adaptive Unified Image Compression)</strong>，通过原图的分辨率特征，动态应用差异化策略，实现画质与体积的最优平衡。</p>
<h4 data-id="heading-4">智能分辨率决策</h4>
<ul>
<li><strong>高清基准 (1440p)</strong>：默认以 1440px 作为短边基准，确保在现代 2K/4K 屏幕上的视觉清晰度</li>
<li><strong>全景墙策略</strong>：自动识别超大全景图（长边 &gt;10800px），锁定长边为 1440px，保留完整视野</li>
<li><strong>超大像素陷阱</strong>：对超过 4096万像素的超高像素图自动执行 1/4 降采样处理</li>
<li><strong>长图内存保护</strong>：针对超长截图建立 10.24MP 像素上限，通过等比缩放防止 OOM</li>
</ul>
<h4 data-id="heading-5">自适应比特率控制</h4>
<ul>
<li><strong>极小图 (&lt;0.5MP)</strong>：几乎不进行有损压缩，防止压缩伪影</li>
<li><strong>高频信息图 (0.5-1MP)</strong>：提高编码质量，补偿分辨率损失</li>
<li><strong>标准图片 (1-3MP)</strong>：应用平衡系数，对标主流社交软件体验</li>
<li><strong>超大图/长图 (&gt;3MP)</strong>：应用高压缩率，显著减少体积</li>
</ul>
<h4 data-id="heading-6">健壮性保障</h4>
<ul>
<li><strong>膨胀回退</strong>：压缩后体积大于原图时，自动透传原图，确保绝不"负优化"</li>
<li><strong>智能格式透传</strong>：保留小体积 PNG 的透明通道，大体积 PNG 自动转码为 JPEG</li>
<li><strong>输入防御</strong>：妥善处理极端分辨率输入（0、负数、1px 等），防止崩溃</li>
</ul>
<h2 data-id="heading-7">📦 导入</h2>
<p>确保项目的 <code>build.gradle</code> 或 <code>build.gradle.kts</code> 已配置 Maven Central 仓库：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">repositories {
    mavenCentral()
}
</code></pre>
<p>在模块的构建文件中添加依赖：</p>
<p><strong>Kotlin DSL (<code>build.gradle.kts</code>):</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">dependencies {
    implementation(<span class="hljs-string">"top.zibin:luban:2.0.0"</span>)
}
</code></pre>
<p><strong>Groovy (<code>build.gradle</code>):</strong></p>
<pre><code class="hljs language-groovy" lang="groovy">dependencies {
    implementation 'top.zibin:luban:2.0.0'
}
</code></pre>
<blockquote>
<p>注意：请访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsearch.maven.org%2Fsearch%3Fq%3Dg%3Atop.zibin%2520a%3Aluban" target="_blank" title="https://search.maven.org/search?q=g:top.zibin%20a:luban" ref="nofollow noopener noreferrer">Maven Central</a> 查看最新版本号。</p>
</blockquote>
<h2 data-id="heading-8">💻 使用</h2>
<h4 data-id="heading-9">⚡ Kotlin (Coroutines)</h4>
<p>在 Kotlin 中，推荐使用 <code>suspend</code> 函数进行调用，代码更简洁。</p>
<h5 data-id="heading-10">压缩单张图片</h5>
<pre><code class="hljs language-kotlin" lang="kotlin">lifecycleScope.launch {
    <span class="hljs-keyword">val</span> inputUri: Uri = ... <span class="hljs-comment">// 图片 Uri</span>
    <span class="hljs-keyword">val</span> outputDir = context.cacheDir
    
    Luban.compress(context, inputUri, outputDir)
        .onSuccess { file -&gt;
            <span class="hljs-comment">// 压缩成功，file 为压缩后的图片文件</span>
            Log.d(<span class="hljs-string">"Luban"</span>, <span class="hljs-string">"Compressed: <span class="hljs-subst">${file.absolutePath}</span>"</span>)
        }
        .onFailure { error -&gt;
            <span class="hljs-comment">// 处理错误</span>
            Log.e(<span class="hljs-string">"Luban"</span>, <span class="hljs-string">"Error: <span class="hljs-subst">${error.message}</span>"</span>)
        }
}
</code></pre>
<h5 data-id="heading-11">压缩单张图片文件</h5>
<pre><code class="hljs language-kotlin" lang="kotlin">lifecycleScope.launch {
    <span class="hljs-keyword">val</span> inputFile: File = ... 
    <span class="hljs-keyword">val</span> outputDir = context.cacheDir
    
    Luban.compress(inputFile, outputDir)
        .onSuccess { file -&gt;
            Log.d(<span class="hljs-string">"Luban"</span>, <span class="hljs-string">"Compressed: <span class="hljs-subst">${file.absolutePath}</span>"</span>)
        }
        .onFailure { error -&gt;
            Log.e(<span class="hljs-string">"Luban"</span>, <span class="hljs-string">"Error: <span class="hljs-subst">${error.message}</span>"</span>)
        }
}
</code></pre>
<h5 data-id="heading-12">压缩到指定文件路径</h5>
<pre><code class="hljs language-kotlin" lang="kotlin">lifecycleScope.launch {
    <span class="hljs-keyword">val</span> inputFile: File = ...
    <span class="hljs-keyword">val</span> outputFile = File(context.cacheDir, <span class="hljs-string">"custom_output.jpg"</span>)
    
    Luban.compressToFile(inputFile, outputFile)
        .onSuccess { file -&gt;
            Log.d(<span class="hljs-string">"Luban"</span>, <span class="hljs-string">"Compressed to: <span class="hljs-subst">${file.absolutePath}</span>"</span>)
        }
        .onFailure { error -&gt;
            Log.e(<span class="hljs-string">"Luban"</span>, <span class="hljs-string">"Error: <span class="hljs-subst">${error.message}</span>"</span>)
        }
}
</code></pre>
<h5 data-id="heading-13">并发压缩多张图片</h5>
<pre><code class="hljs language-kotlin" lang="kotlin">lifecycleScope.launch {
    <span class="hljs-keyword">val</span> uris: List&lt;Uri&gt; = ... 
    <span class="hljs-keyword">val</span> outputDir = context.cacheDir

    <span class="hljs-keyword">val</span> results = Luban.compress(context, uris, outputDir)
    
    results.forEach { result -&gt;
        result.onSuccess { file -&gt; 
            Log.d(<span class="hljs-string">"Luban"</span>, <span class="hljs-string">"Compressed: <span class="hljs-subst">${file.absolutePath}</span>"</span>)
        }
        .onFailure { error -&gt;
            Log.e(<span class="hljs-string">"Luban"</span>, <span class="hljs-string">"Error: <span class="hljs-subst">${error.message}</span>"</span>)
        }
    }
}
</code></pre>
<h5 data-id="heading-14">并发压缩多个文件</h5>
<pre><code class="hljs language-kotlin" lang="kotlin">lifecycleScope.launch {
    <span class="hljs-keyword">val</span> files: List&lt;File&gt; = ...
    <span class="hljs-keyword">val</span> outputDir = context.cacheDir

    <span class="hljs-keyword">val</span> results = Luban.compress(files, outputDir)
    
    results.forEach { result -&gt;
        result.onSuccess { file -&gt; 
            Log.d(<span class="hljs-string">"Luban"</span>, <span class="hljs-string">"Compressed: <span class="hljs-subst">${file.absolutePath}</span>"</span>)
        }
        .onFailure { error -&gt;
            Log.e(<span class="hljs-string">"Luban"</span>, <span class="hljs-string">"Error: <span class="hljs-subst">${error.message}</span>"</span>)
        }
    }
}
</code></pre>
<h5 data-id="heading-15">在其他协程作用域中使用</h5>
<p>如果不在 Activity/Fragment 中使用，可以使用 <code>CoroutineScope</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> scope = CoroutineScope(Dispatchers.Main + SupervisorJob())

scope.launch {
    <span class="hljs-keyword">val</span> inputUri: Uri = ...
    <span class="hljs-keyword">val</span> outputDir = context.cacheDir
    
    Luban.compress(context, inputUri, outputDir)
        .onSuccess { file -&gt;
            <span class="hljs-comment">// 处理成功</span>
        }
        .onFailure { error -&gt;
            <span class="hljs-comment">// 处理错误</span>
        }
}
</code></pre>
<h4 data-id="heading-16">☕ Java / Builder 模式</h4>
<p>对于 Java 项目或偏好回调风格的开发者，可以使用兼容旧版风格的 <code>Luban.with()</code> API。</p>
<h5 data-id="heading-17">压缩单张图片</h5>
<pre><code class="hljs language-java" lang="java">Luban.with(context)
    .load(imageFile) <span class="hljs-comment">// 支持 File, Uri, 或 String 路径</span>
    .setTargetDir(context.getCacheDir())
    .bindLifecycle(lifecycleOwner) <span class="hljs-comment">// 可选：页面销毁时自动取消</span>
    .setCompressListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OnCompressListener</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 开始压缩</span>
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(File file)</span> {
            <span class="hljs-comment">// 压缩成功</span>
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable e)</span> {
            <span class="hljs-comment">// 发生错误</span>
        }
    })
    .launch();
</code></pre>
<h5 data-id="heading-18">压缩多张图片</h5>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; imagePaths = ...; <span class="hljs-comment">// 图片路径列表</span>

Luban.with(context)
    .load(imagePaths) <span class="hljs-comment">// 加载图片列表</span>
    .setTargetDir(context.getCacheDir())
    .setCompressListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OnCompressListener</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 开始压缩</span>
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(File file)</span> {
            <span class="hljs-comment">// 每张图片压缩成功后都会回调一次</span>
            Log.d(<span class="hljs-string">"Luban"</span>, <span class="hljs-string">"Compressed: "</span> + file.getAbsolutePath());
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable e)</span> {
            <span class="hljs-comment">// 发生错误</span>
        }
    })
    .launch();
</code></pre>
<h3 data-id="heading-19">彩蛋</h3>
<p><code>Flutter</code> 版 <code>Luban 2</code> 即将上线，Android、iOS都能使用，敬请期待~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Android技能点】一张图理清 开机、App启动流程]]></title>    <link>https://juejin.cn/post/7592241336290017331</link>    <guid>https://juejin.cn/post/7592241336290017331</guid>    <pubDate>2026-01-07T06:52:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592241336290017331" data-draft-id="7592241336289558579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Android技能点】一张图理清 开机、App启动流程"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-07T06:52:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="莫比乌斯环"/> <meta itemprop="url" content="https://juejin.cn/user/2840793776394269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Android技能点】一张图理清 开机、App启动流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2840793776394269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    莫比乌斯环
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T06:52:36.000Z" title="Wed Jan 07 2026 06:52:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android 开机链路 + 桌面 App「用户点击图标」启动链路（端到端梳理）</h2>
<blockquote>
<p>目的：把 <strong>开机到桌面可用</strong> 的关键链路，以及 <strong>用户在桌面点击图标 → 目标 App Activity 展示首帧</strong> 的完整主干流程串起来。<br/>
说明：不同 Android 版本实现细节略有差异（Android 10+ 引入 ATMS 分工更明显），本文以 <strong>通用主干</strong> 为主，必要处点出关键分工。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1) 开机链路（Boot Chain）：Kernel → init → zygote → system_server → launcher</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91c45c1118d141bbbf939a4454d62222~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I6r5q-U5LmM5pav546v:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768373556&amp;x-signature=09s85SaeUBDneej4DNW4JTyNdLA%3D" alt="开机流程 diagram-2026-01-07-064408.png" loading="lazy"/></p>
<h4 data-id="heading-2">1.1 Kernel 启动 init（Native）</h4>
<ul>
<li>Kernel 启动完成后启动用户态第一个进程：<code>/init</code></li>
<li><code>init</code> 负责：
<ul>
<li>挂载分区、初始化 SELinux、安全策略</li>
<li>解析 <code>init.rc</code> / <code>*.rc</code></li>
<li>启动关键守护/服务：<code>servicemanager</code>、<code>zygote</code>、<code>surfaceflinger</code> 等</li>
</ul>
</li>
</ul>
<p><strong>关键产物</strong></p>
<ul>
<li>Binder 驱动就绪 + <code>servicemanager</code> 提供服务注册/发现</li>
<li>图形基础（<code>surfaceflinger</code>）启动，为后续 SystemUI/Launcher 出图打底</li>
</ul>
<h4 data-id="heading-3">1.2 init 启动 Zygote（Native → Java 孵化器）</h4>
<ul>
<li>通过 rc 启动 <code>zygote</code>/<code>zygote64</code></li>
<li>Zygote 做两件核心事：
<ol>
<li><strong>预加载</strong>（classes、resources、常用库）以提升后续 fork 性能</li>
<li>提供 <strong>fork</strong>：派生 <code>system_server</code> 和各 App 进程</li>
</ol>
</li>
</ul>
<p>常见入口：</p>
<ul>
<li><code>com.android.internal.os.ZygoteInit.main()</code>
<ul>
<li><code>preload()</code></li>
<li><code>forkSystemServer()</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">1.3 system_server 启动：SystemServer 拉起核心系统服务（Java）</h4>
<ul>
<li><code>com.android.server.SystemServer.main()</code> → <code>run()</code></li>
<li>分阶段启动大量 System Services（版本略有差异），关键与“启动/桌面”强相关的包括：
<ul>
<li><strong>AMS</strong>（ActivityManagerService）：进程/广播/服务/ANR 等</li>
<li><strong>ATMS</strong>（ActivityTaskManagerService，Android 10+）：Activity/Task 启动与任务栈</li>
<li><strong>WMS</strong>（WindowManagerService）：窗口管理与显示策略</li>
<li><strong>PMS</strong>（PackageManagerService）：包解析、组件解析、权限</li>
<li><code>InputManagerService</code>：输入</li>
<li><code>PowerManagerService</code>：电源与唤醒</li>
<li><code>DisplayManagerService</code>：显示</li>
<li>以及 SystemUI、网络、音频等</li>
</ul>
</li>
</ul>
<p><strong>关键节点：systemReady / bootCompleted</strong></p>
<ul>
<li>系统服务启动完成后会进入 <code>systemReady()</code>，随后发出 BOOT_COMPLETED（对三方 app 影响很大）</li>
</ul>
<h4 data-id="heading-5">1.4 SystemUI/Launcher 出现（桌面可用）</h4>
<ul>
<li>一般会先启动 <strong>SystemUI</strong>（状态栏、导航栏、锁屏等）</li>
<li>解锁后/或满足条件后，启动 <strong>Launcher</strong>（桌面应用）</li>
</ul>
<p><strong>桌面启动方式（概念）</strong></p>
<ul>
<li>SystemServer 选择一个 HOME Activity（Launcher）
<ul>
<li>Intent：<code>ACTION_MAIN</code> + <code>CATEGORY_HOME</code></li>
</ul>
</li>
<li>走一次标准的 Activity 启动链路（见第 2 部分）</li>
</ul>
<hr/>
<h3 data-id="heading-6">2) 桌面用户点击图标：Launcher → SystemServer → 目标 App 首帧</h3>
<blockquote>
<p>场景：用户在桌面点击某个 App 图标（目标 Activity 可能是 LAUNCHER Activity），系统完成从点击到界面显示。</p>
</blockquote>
<h4 data-id="heading-7">2.1 触摸事件到 Launcher：Input → View → onClick</h4>
<ul>
<li>触摸从硬件到应用的主链路（高层概念）：
<ol>
<li>Input 驱动产生事件</li>
<li><code>InputManagerService</code> 分发</li>
<li>通过 WMS 选择焦点窗口/目标应用</li>
<li>事件到达 Launcher 进程（<code>ViewRootImpl</code> → <code>DecorView</code> → <code>View</code>）</li>
<li>点击触发 Launcher 的图标点击逻辑</li>
</ol>
</li>
</ul>
<h4 data-id="heading-8">2.2 Launcher 组装 Intent 并发起 startActivity</h4>
<ul>
<li>Launcher 通常为目标 App 组装：
<ul>
<li>显式 Intent：<code>ComponentName(包名/Activity)</code></li>
<li>或隐式 Intent（较少用于图标）</li>
<li>常带 flag：<code>FLAG_ACTIVITY_NEW_TASK</code>（因 Launcher 非目标 app 内部页面跳转）</li>
</ul>
</li>
</ul>
<p>Launcher 侧常见入口（概念）：</p>
<ul>
<li><code>Activity.startActivity()</code> / <code>Context.startActivity()</code></li>
<li><code>Instrumentation.execStartActivity()</code></li>
<li>进入系统服务（Binder）：
<ul>
<li>Android 10+ 常见：<code>IActivityTaskManager.startActivity(...)</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">2.3 进入 SystemServer：ATMS 做 Activity 启动决策（任务栈/复用/权限）</h4>
<p>SystemServer 侧关键流程（高层语义）：</p>
<ol>
<li>权限校验、调用者校验（是否允许启动、后台启动限制等）</li>
<li>通过 PMS 解析目标组件（ActivityInfo/ProcessName/UID 等）</li>
<li>计算任务栈归属与启动模式（standard/singleTask…）</li>
<li>判断是 <strong>冷/温/热启动</strong>：
<ul>
<li>进程是否存在</li>
<li>目标 Activity 是否已存在于任务栈</li>
</ul>
</li>
</ol>
<blockquote>
<p>结论：ATMS 负责“<strong>Activity/Task 怎么启动、放哪、复用谁</strong>”；而“<strong>进程怎么来</strong>”交给 AMS。</p>
</blockquote>
<h4 data-id="heading-10">2.4 冷启动分支：目标进程不存在 → AMS 创建进程（zygote fork）</h4>
<p><strong>触发条件</strong></p>
<ul>
<li>目标 App 进程尚未创建，或被杀</li>
</ul>
<p><strong>关键链路（概念）</strong></p>
<ul>
<li>ATMS：需要进程 → 请求 AMS</li>
<li>AMS：准备 <code>ProcessRecord</code>（uid/selinux/abi/进程名）</li>
<li><code>ZygoteProcess.start(...)</code>：
<ul>
<li>通过 socket 与 zygote 通信</li>
<li>zygote fork 出目标 App 进程</li>
</ul>
</li>
</ul>
<h4 data-id="heading-11">2.5 目标 App 进程起来：ActivityThread.main → attach 到 AMS</h4>
<p>App 进程入口：</p>
<ul>
<li><code>android.app.ActivityThread.main()</code>
<ul>
<li>建立主线程 Looper</li>
<li><code>attach(false)</code>：
<ul>
<li>Binder → <code>IActivityManager.attachApplication(appThread)</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>SystemServer（AMS）收到 attach：</p>
<ul>
<li>记录进程已上线</li>
<li>回调到 App 进程：
<ul>
<li><code>IApplicationThread.bindApplication(...)</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">2.6 bindApplication：创建 Application / 初始化运行环境</h4>
<p>App 进程执行：</p>
<ul>
<li><code>ActivityThread.handleBindApplication()</code>
<ul>
<li>创建 <code>LoadedApk</code></li>
<li>创建 <code>Application</code></li>
<li><code>Application.onCreate()</code></li>
<li>安装 ContentProviders（如有）</li>
</ul>
</li>
</ul>
<blockquote>
<p>到这一步：<strong>进程与应用级初始化完成</strong>，但 Activity 还未真正 onCreate（下一步由 ATMS 发起 Launch）。</p>
</blockquote>
<h4 data-id="heading-13">2.7 真正启动 Activity：SystemServer 下发事务 → App 执行 onCreate/onResume</h4>
<p>Android P+ 常用事务机制（概念）：</p>
<ul>
<li>SystemServer（ATMS）构造 <code>ClientTransaction</code>
<ul>
<li>包含 <code>LaunchActivityItem</code>、<code>ResumeActivityItem</code> 等</li>
</ul>
</li>
<li>Binder → App：<code>IApplicationThread.scheduleTransaction(transaction)</code></li>
</ul>
<p>App 侧执行：</p>
<ul>
<li><code>TransactionExecutor.execute()</code></li>
<li><code>ActivityThread.handleLaunchActivity()</code>
<ul>
<li>创建 Activity 实例</li>
<li><code>Activity.attach()</code></li>
<li><code>Activity.onCreate()</code></li>
</ul>
</li>
<li>随后 <code>onStart()</code>、<code>onResume()</code></li>
</ul>
<h4 data-id="heading-14">2.8 首帧显示：WMS/Surface + App 绘制管线</h4>
<p>并行协作点：</p>
<ul>
<li>ATMS/WMS 控制窗口可见性、转场动画、焦点</li>
<li>App 在 <code>onResume</code> 前后触发视图树创建</li>
<li>首帧绘制：
<ul>
<li><code>Choreographer</code> 驱动 measure/layout/draw</li>
<li><code>Surface</code> 提交给 SurfaceFlinger 合成显示</li>
</ul>
</li>
</ul>
<p><strong>用户可见结果</strong></p>
<ul>
<li>屏幕从桌面切到目标 App，展示首帧</li>
</ul>
<hr/>
<h3 data-id="heading-15">3) 冷/温/热启动对比（用户点击图标时常见）</h3>
<ul>
<li><strong>冷启动（Cold）</strong>：无进程 → fork + bindApplication + LaunchActivity + 首帧</li>
<li><strong>温启动（Warm）</strong>：进程在，但 Activity 不在前台/需新建 → 省掉 fork 和 Application.onCreate（多数情况）</li>
<li><strong>热启动（Hot）</strong>：Activity 实例仍在 → 多为 task 切前台 + onRestart/onStart/onResume + 窗口切换</li>
</ul>
<hr/>
<h3 data-id="heading-16">4) 一张“时序图”（从点击到首帧）</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de50e860b4734b949ca6faf00d73d69c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I6r5q-U5LmM5pav546v:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768373556&amp;x-signature=V6Fwvos2phsJSl5B9UbMELFo8Kw%3D" alt="桌面App启动 diagram-2026-01-07-064804.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-17">5) 你可以拿来对照的观测手段</h3>
<ul>
<li><code>adb shell am start -W &lt;intent&gt;</code>：粗看启动耗时</li>
<li><code>adb shell dumpsys activity activities</code>：任务栈/Activity 状态</li>
<li><code>adb shell dumpsys activity processes</code>：进程状态</li>
<li><code>adb shell dumpsys window windows</code>：窗口状态</li>
<li><code>perfetto/atrace</code>：精确看 bindApplication、launch、首帧绘制 slice</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android中第三方库的使用]]></title>    <link>https://juejin.cn/post/7592134330313424939</link>    <guid>https://juejin.cn/post/7592134330313424939</guid>    <pubDate>2026-01-07T07:25:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592134330313424939" data-draft-id="7591806035758497834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android中第三方库的使用"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-07T07:25:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Pawns"/> <meta itemprop="url" content="https://juejin.cn/user/3254200295233767"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android中第三方库的使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3254200295233767/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Pawns
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T07:25:18.000Z" title="Wed Jan 07 2026 07:25:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">1.<code>greendao</code></h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgreenrobot%2FgreenDAO" target="_blank" title="https://github.com/greenrobot/greenDAO" ref="nofollow noopener noreferrer">github地址</a>
作为本地数据库的知名第三方，学习它的使用过程</p>
<h5 data-id="heading-1">1.导入</h5>
<h6 data-id="heading-2">1.在<code>build.gradle</code>App层次</h6>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98100b4242324a6d9cc4ce93195cd49b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGF3bnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375518&amp;x-signature=X2pGpb2qywVobOqgyYaRDTWygN4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c830a939c23489cbeaa88f94920a812~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGF3bnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375518&amp;x-signature=RG65AiH4vRrkJmXKL79gZ%2BvCwLM%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-3">2.在<code>build.gradle</code>Project层次</h6>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5467fb7f2754a839fb5175dd58ac005~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGF3bnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375518&amp;x-signature=F26fsEqmPJvJEdHnFzLBrdhmtOc%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-4">2.创建实体类Entity</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1dd2686893d4709b9ef1d392d41af90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGF3bnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375518&amp;x-signature=ZAluDtovf3IawFzNlt5dgLRlMfk%3D" alt="image.png" loading="lazy"/></p>
<p>完成上图所示的步骤后，再点击菜单栏<code>Build</code>-&gt;<code>Make Project</code>即可自动注解创建的实体类，如上图没有框出来的部分。</p>
<blockquote>
<p>同时还会生成如下的三个文件</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17269528012d429c96ffc1f548b1bd17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGF3bnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375518&amp;x-signature=Lx0FEMk8soBzHTLAwd%2Bkkr8JBXI%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-5">3.自定义工具类</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c364b822eb0f4f7aa3aaa4c40adeb4e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGF3bnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375518&amp;x-signature=1Szoup6C4%2F8vaboejAtZlYbquUY%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-6">4.使用</h5>
<p>初始化</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c61d095116bb488b9155bb513c5c200a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGF3bnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375518&amp;x-signature=pvHfdK1Xr2jy2n7XecbDO3n7IM0%3D" alt="image.png" loading="lazy"/></p>
<p>其他的增删改查就是很普通的方法了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[历时1年，TinyEditor v4.0 正式发布！]]></title>    <link>https://juejin.cn/post/7592152007840350208</link>    <guid>https://juejin.cn/post/7592152007840350208</guid>    <pubDate>2026-01-07T08:32:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592152007840350208" data-draft-id="7592094314472767523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="历时1年，TinyEditor v4.0 正式发布！"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2026-01-07T08:32:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpenTiny社区"/> <meta itemprop="url" content="https://juejin.cn/user/3808325101432983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            历时1年，TinyEditor v4.0 正式发布！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808325101432983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpenTiny社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:32:07.000Z" title="Wed Jan 07 2026 08:32:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文由体验技术团队Kagol原创。</p>
<p>TinyEditor 是一个基于 Quill 2.0 的富文本编辑器，在 Quill 基础上扩展了丰富的模块和格式，框架无关、功能强大、开箱即用。</p>
<ul>
<li>源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-editor%2F" target="_blank" title="https://github.com/opentiny/tiny-editor/" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a></li>
<li>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor%2F" target="_blank" title="https://opentiny.github.io/tiny-editor/" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editor…</a></li>
</ul>
<p>去年1月2日，我们发布了 v3.25 版本，功能基本已经完备，之后 v3.x 版本进入了维护期，同时开启了漫长的 v4.0 版本的开发，v4.0 的核心目标是体验优化和稳定性提升，并支持多人协同编辑。</p>
<p>在长达1年的开发和打磨后，我们荣幸地宣布 <strong>TinyEditor v4.0</strong> 正式发布！这个版本汇聚了团队的心血，带来了激动人心多人协同编辑新功能、以及大量体验优化和稳定性改进。</p>
<p><strong>重点特性：</strong></p>
<ul>
<li>支持多人协同编辑：一起在编辑器写（玩）文档（贪吃蛇游戏摸鱼）🐶</li>
<li>基于 quill-table-up 的新表格方案：表格操作体验++⚡️</li>
<li>基于 <code>emoji-mart</code> 的 Emoji 表情：表情党最爱😍</li>
<li>支持斜杆菜单和丰富的快捷键：键盘流的福音😄</li>
<li>图片/视频/文件上传体验优化🌄</li>
</ul>
<p>详细的 Release Notes 请参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-editor%2Freleases%2Ftag%2Fv4.0.0" target="_blank" title="https://github.com/opentiny/tiny-editor/releases/tag/v4.0.0" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a></p>
<p>欢迎安装 v4.0 版本体验：</p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> <span class="hljs-keyword">@opentiny</span>/fluent-editor<span class="hljs-keyword">@4</span>.0.0
</code></pre>
<h2 data-id="heading-0">1 亮点特性</h2>
<h3 data-id="heading-1">1.1 多人协作编辑</h3>
<p>v4.0 最重磅的功能之一是引入了<strong>完整的协作编辑能力</strong>。我们集成了 quill-cursor 模块，支持多人实时协作编辑，并提供了独立的 npm 包供开发者集成。无论是需要离线支持还是云端协作，TinyEditor 都能胜任。</p>
<p>你可以在我们的演示项目中进行体验：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor%2Fprojects%2F" target="_blank" title="https://opentiny.github.io/tiny-editor/projects/" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editor…</a></p>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83e7ddefd0ea4c63b04df3c819c1f679~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768379527&amp;x-signature=gq%2F6Zh4%2Fa9vxk1Ika8eWUkBT%2BE8%3D" alt="1.JPG" loading="lazy"/></p>
<p>关于协同编辑更详细的介绍，参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FJ_aIaAUxUtj-dtqvYZW0ng" target="_blank" title="https://mp.weixin.qq.com/s/J_aIaAUxUtj-dtqvYZW0ng" ref="nofollow noopener noreferrer">如何使用 TinyEditor 快速部署一个多人协同富文本编辑器？</a></p>
<h3 data-id="heading-2">1.2 表格能力升级</h3>
<p>集成了 <strong>table-up</strong> 模块，大幅提升了表格编辑和操作能力，支持更复杂的表格场景。</p>
<p>体验地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor%2Fdocs%2Fdemo%2Ftable-up" target="_blank" title="https://opentiny.github.io/tiny-editor/docs/demo/table-up" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editor…</a></p>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc7dfebfda6349149ae19e31e71bc158~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768379527&amp;x-signature=DXvaDwSPXsGgc2ocpFvXmaGIsUk%3D" alt="2.gif" loading="lazy"/></p>
<p>详细介绍可以参考之前的文章： <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FpnQVjqHLH_fxpC7s10trzA" target="_blank" title="https://mp.weixin.qq.com/s/pnQVjqHLH_fxpC7s10trzA" ref="nofollow noopener noreferrer">TinyEditor v4.0 alpha：表格更强大，表情更丰富，上传体验超乎想象！</a></p>
<h3 data-id="heading-3">1.3 更丰富的 Emoji 表情😘</h3>
<ul>
<li>集成 <strong>emoji-mart</strong>，提供丰富的表情选择</li>
<li>修复了插入表情后的光标位置问题</li>
<li>完善了表情插入的交互体验</li>
</ul>
<p>体验地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor%2Fdocs%2Fdemo%2Femoji" target="_blank" title="https://opentiny.github.io/tiny-editor/docs/demo/emoji" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editor…</a></p>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81cf625cd7a144f5a4e1434ffffb93f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768379527&amp;x-signature=nu0YUDKy1BFPBpefppBvoSFwgOI%3D" alt="3.gif" loading="lazy"/></p>
<p>详细介绍可以参考之前的文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FpnQVjqHLH_fxpC7s10trzA" target="_blank" title="https://mp.weixin.qq.com/s/pnQVjqHLH_fxpC7s10trzA" ref="nofollow noopener noreferrer">TinyEditor v4.0 alpha：表格更强大，表情更丰富，上传体验超乎想象！</a></p>
<h3 data-id="heading-4">1.4 快捷键和快速菜单</h3>
<p>新增了强大的快捷键系统和快速菜单功能，让高级用户能够更高效地操作编辑器。</p>
<p>体验地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor%2Fprojects%2F" target="_blank" title="https://opentiny.github.io/tiny-editor/projects/" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editor…</a></p>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f07f004d21b843e5ad83de958c8a741e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768379527&amp;x-signature=1zQV79O8UNX4qDmrNIlucyY4elU%3D" alt="4.png" loading="lazy"/></p>
<h3 data-id="heading-5">1.5 颜色选择器升级</h3>
<p>自定义颜色选择器现在能保存当前选择，并支持添加更多颜色。</p>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/961273ada6244a04890af3e272840cab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768379527&amp;x-signature=ahCvkoHc1XYxspiKJv076a%2Fckqs%3D" alt="5.png" loading="lazy"/></p>
<h3 data-id="heading-6">1.6 文本模板与国际化</h3>
<ul>
<li>支持 i18n 文本模板替换</li>
<li>完善了国际化翻译（header、picker 等组件）</li>
<li>更好的多语言支持体验</li>
</ul>
<h3 data-id="heading-7">1.7 图片和文件增强</h3>
<ul>
<li><strong>图片工具栏</strong>：选中图片时显示专门的操作工具栏</li>
<li><strong>自定义上传</strong>：增加 <code>allowInvalidUrl</code> 选项，支持 Electron 等特定场景</li>
<li><strong>改进的上传逻辑</strong>：优化了失败状态的处理</li>
</ul>
<h2 data-id="heading-8">2 技术改进</h2>
<h3 data-id="heading-9">2.1 构建和工程化</h3>
<ul>
<li>修复了 SSR 构建问题</li>
<li>优化了 Vite 配置，解决了 PostCSS 和 Tailwind 的兼容性问题</li>
<li>改进了 SCSS 文件引入方式</li>
<li>输出文件名称优化</li>
</ul>
<h3 data-id="heading-10">2.2 依赖管理</h3>
<ul>
<li>外部化 emoji-mart 和 floating-ui 依赖，减少包体积</li>
<li>移除了 better-table 和 lodash-es，优化依赖树</li>
</ul>
<h3 data-id="heading-11">2.3 代码质量</h3>
<ul>
<li>完整的测试覆盖率提升</li>
<li>重构优化：移除冗余代码</li>
<li>API 标准化：<code>scrollIntoView</code> → <code>scrollSelectionIntoView</code></li>
<li>示例代码 <code>async/await</code> 改造，代码现代化</li>
</ul>
<h3 data-id="heading-12">2.4 类型安全</h3>
<ul>
<li>修复了因 TypeScript 类型导致的编译错误</li>
<li>改进了类型定义</li>
</ul>
<h3 data-id="heading-13">2.5 API 导出增强</h3>
<p>v4.0 导出了工具栏配置常量，方便开发者定制：</p>
<ul>
<li><code>DEFAULT_TOOLBAR</code>：默认工具栏配置</li>
<li><code>FULL_TOOLBAR</code>：完整工具栏配置</li>
</ul>
<h3 data-id="heading-14">2.6 增加自动发包工作流</h3>
<ul>
<li>增加 auto-publish / auto-deploy 等自动化工作流，支持打 tag 之后自动发版本、生成 Release Notes</li>
<li>PR 门禁在单元测试基础上增加 npm 包和网站构建，确保合入 PR 之前，npm 包构建和网站构建是正常的，通过自动化方式保障版本质量。</li>
</ul>
<h2 data-id="heading-15">3 问题修复</h2>
<p>v4.0 修复了大量已知问题，包括：</p>
<ul>
<li>工具栏选择器不跟随光标变化的问题</li>
<li>行高作用域问题</li>
<li>列表样式显示不正确</li>
<li>背景色 SVG 图标问题</li>
<li>VitePress 默认样式影响的问题</li>
<li>自定义上传失败时表格数据结构破坏的问题</li>
<li>多项文档和国际化翻译问题</li>
</ul>
<h2 data-id="heading-16">4 社区贡献</h2>
<p>感谢所有为 v4.0 做出贡献的开发者！你们的辛勤付出让 TinyEditor 变得更好！</p>
<ul>
<li>@chenxi-20</li>
<li>@GaoNeng-wWw</li>
<li>@jany55555</li>
<li>@qwangry</li>
<li>@shenyaofeng</li>
<li>@vaebe</li>
<li>@wuyiping0628</li>
<li>@Yinlin124</li>
<li>@zzxming</li>
</ul>
<blockquote>
<p>注：排名不分先后，按名字首字母排序。</p>
</blockquote>
<p>如果你有任何建议或反馈，欢迎通过 GitHub Issues 与我们联系。</p>
<h2 data-id="heading-17">往期推荐文章</h2>
<ul>
<li>👍<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI2MDE3MTM4MA%3D%3D%26mid%3D2701521363%26idx%3D1%26sn%3D1d9ac1d8fd757848553e6d6a628a4696%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI2MDE3MTM4MA==&amp;mid=2701521363&amp;idx=1&amp;sn=1d9ac1d8fd757848553e6d6a628a4696&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">TinyEditor：一个基于 Quill 2.0 的富文本编辑器，功能强大、开箱即用！</a></li>
<li>🎈<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI2MDE3MTM4MA%3D%3D%26mid%3D2701521458%26idx%3D1%26sn%3D56fa9b07b0667801ce33c569569eb820%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI2MDE3MTM4MA==&amp;mid=2701521458&amp;idx=1&amp;sn=56fa9b07b0667801ce33c569569eb820&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">TinyEditor 富文本开源2个月的总结：增加格式刷、截屏、TypeScript 类型声明等新特性</a></li>
<li>🥳<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI2MDE3MTM4MA%3D%3D%26mid%3D2701521498%26idx%3D1%26sn%3D2f09766e9ef5633d2f7df5d7bbef505e%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI2MDE3MTM4MA==&amp;mid=2701521498&amp;idx=1&amp;sn=2f09766e9ef5633d2f7df5d7bbef505e&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">重磅更新！TinyEditor 开源富文本支持 LaTeX 可编辑公式啦~</a></li>
<li>🎉<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI2MDE3MTM4MA%3D%3D%26mid%3D2701521407%26idx%3D1%26sn%3Ddb2240d78afddcb4f790e155e4ed684a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI2MDE3MTM4MA==&amp;mid=2701521407&amp;idx=1&amp;sn=db2240d78afddcb4f790e155e4ed684a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">喜报！TinyEditor 开源富文本迎来了第一位贡献者</a></li>
<li>👏<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI2MDE3MTM4MA%3D%3D%26mid%3D2701521518%26idx%3D1%26sn%3Dbe00e70af3e2ec312ffa67fe254fbf1e%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI2MDE3MTM4MA==&amp;mid=2701521518&amp;idx=1&amp;sn=be00e70af3e2ec312ffa67fe254fbf1e&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">让我们一起来建设 TinyEditor 开源富文本编辑器吧！</a></li>
<li>✨<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI2MDE3MTM4MA%3D%3D%26mid%3D2701521560%26idx%3D1%26sn%3Dcd5c8fca9de30d44645e6f8c7099abb0%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI2MDE3MTM4MA==&amp;mid=2701521560&amp;idx=1&amp;sn=cd5c8fca9de30d44645e6f8c7099abb0&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">TinyEditor v3.25.0 正式发布！2025年第一个版本，增加标题列表导航、分隔线等实用特性</a></li>
<li>⚡️<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI2MDE3MTM4MA%3D%3D%26mid%3D2701521653%26idx%3D1%26sn%3Db17914b431c14826d150aa21bd054389%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI2MDE3MTM4MA==&amp;mid=2701521653&amp;idx=1&amp;sn=b17914b431c14826d150aa21bd054389&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">TinyEditor v4.0 alpha 版本发布：更强大的表格、更丰富的表情、更好的上传体验</a></li>
</ul>
<h2 data-id="heading-18">关于OpenTiny</h2>
<p>欢迎加入 OpenTiny 开源社区。添加微信小助手：opentiny-official 一起参与交流前端技术～</p>
<p>OpenTiny 官网：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.design" target="_blank" title="https://opentiny.design" ref="nofollow noopener noreferrer">opentiny.design</a></strong><br/>
OpenTiny 代码仓库：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny" target="_blank" title="https://github.com/opentiny" ref="nofollow noopener noreferrer">github.com/opentiny</a></strong><br/>
TinyVue 源码：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-vue" target="_blank" title="https://github.com/opentiny/tiny-vue" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a></strong><br/>
TinyEngine 源码： <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-engine" target="_blank" title="https://github.com/opentiny/tiny-engine" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a></strong><br/>
欢迎进入代码仓库 Star🌟TinyEngine、TinyVue、TinyNG、TinyCLI、TinyEditor~</p>
<p>如果你也想要共建，可以进入代码仓库，找到 good first issue标签，一起参与开源贡献~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[迅雷基于阿里云 EMR Serverless Spark 实现数仓资源效率与业务提升]]></title>    <link>https://juejin.cn/post/7592170171634597903</link>    <guid>https://juejin.cn/post/7592170171634597903</guid>    <pubDate>2026-01-07T08:33:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592170171634597903" data-draft-id="7592152007839956992" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="迅雷基于阿里云 EMR Serverless Spark 实现数仓资源效率与业务提升"/> <meta itemprop="keywords" content="Spark"/> <meta itemprop="datePublished" content="2026-01-07T08:33:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            迅雷基于阿里云 EMR Serverless Spark 实现数仓资源效率与业务提升
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:33:49.000Z" title="Wed Jan 07 2026 08:33:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>刘敏 | 迅雷大数据平台负责人</p>
<p>尤帅 | 迅雷大数据平台资深工程师</p>
<p>陈照 | 阿里云公共云业务事业部解决方案架构师</p>
<p>潘锦棉 | 阿里云公共云业务事业部解决方案架构师 </p>
<p>刘瑞伟 | 阿里云公共云业务事业部大数据解决方案架构师</p>
<h2 data-id="heading-0">一、背景介绍</h2>
<h3 data-id="heading-1">企业简介</h3>
<p>迅雷（纳斯达克股票代码：XNET）作为全球分布式技术领域的先行者，以技术构建商业，以服务创造共识，从而建立一个高效可信的存储与传输网络。</p>
<p>自2003年创立以来，公司通过持续深耕P2P传输、边缘计算与区块链技术，构建起覆盖全球的高效可信数据网络：这一网络不仅承载着亿级用户的日常数字生活，更成为Web3.0时代基础设施的重要实践者。</p>
<p>凭借对极致用户体验的追求，迅雷打造了多款行业标杆产品：革命性的迅雷下载引擎重新定义了文件传输效率，迅雷云盘以去中心化存储架构实现数据主权回归，玩客云等智能硬件则开创了共享计算新生态。</p>
<p>截至2025年，迅雷产品矩阵已服务全球超4亿注册用户，形成极具价值的实时行为数据金矿。</p>
<p>技术底座决定商业边界。迅雷深耕三大技术能力：</p>
<p>1. 海量数据实时治理能力：每秒处理PB级传输日志与存储元数据</p>
<p>2. 亿级节点动态调度系统：通过智能算法实现全球分布式节点毫秒级响应</p>
<p>3. 跨场景联邦计算架构：在保障隐私安全前提下激活数据要素价值</p>
<p>这套经受高并发淬炼的技术体系，不仅支撑着影视、游戏、IoT等行业的关键业务场景，更沉淀出对数据流动规律的深度认知：这正是迅雷与阿里云在大数据智能时代展开深度协同的底层逻辑。</p>
<h3 data-id="heading-2">核心业务痛点</h3>
<p>随着业务的发展，在大数据平台侧遇到了一些痛点：</p>
<ul>
<li>
<p><strong>数据处理效率存在瓶颈</strong>：原 Hadoop 集群难以充分利用业界领先的 <strong>Native 加速</strong> 与 <strong>Remote Shuffle Service</strong> 等技术，整体性能提升受限，进而影响降本增效。</p>
</li>
<li>
<p><strong>计算资源弹性不足</strong>：原 Hadoop 集群资源固定，当出现数据量突增、任务回溯等需要临时扩容的场景时，容易发生资源紧张；且扩容周期较长，难以快速缓解问题。</p>
</li>
<li>
<p><strong>运维复杂度较高</strong>：原集群在资源层面需要较多人力介入；Spark 引擎升级、Python 环境管理等常见运维操作流程复杂且生产风险较高。同时，由于集群版本偏低，在业务用量增长后更易触发开源缺陷，导致稳定性下降，且难以原地升级。</p>
</li>
<li>
<p><strong>成本管控压力较大</strong>：调度任务呈现“夜间繁忙、日间空闲”的典型波峰波谷特征，固定资源在日间存在较多闲置，造成不必要的成本浪费。</p>
</li>
</ul>
<h3 data-id="heading-3">技术升级核心诉求</h3>
<ol>
<li>
<p>降本增效：在提升数据处理效率的同时，降低集群运维成本与硬件投入成本；</p>
</li>
<li>
<p>极致弹性：实现计算资源“按需分配、秒级扩容”，精准匹配业务流量波动，避免资源闲置与短缺；</p>
</li>
<li>
<p>极简运维：摆脱集群管理负担，让技术团队聚焦核心业务开发与优化；</p>
</li>
<li>
<p>稳定可靠：保障高并发场景下数据处理的稳定性与准确性，支持任务断点续跑、故障自动恢复。</p>
</li>
</ol>
<h2 data-id="heading-4">二、阿里云 EMR Serverless Spark 技术赋能</h2>
<p><strong>1、Serverless 模式突破算力瓶颈，实现弹性敏捷的数据处理</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0140c8322768445f8cab43d2307db987~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768379629&amp;x-signature=%2Fl5LQNavMBojYZpnVb%2F55yzwQn4%3D" alt="image.png" loading="lazy"/></p>
<p>原集群是一个典型的服务器架构，困境是，资源要么长期被打满，要么在空窗期大量闲置。图中 <code>yarn_cluster_totalMB</code> 基本是一条平直的上沿线，代表集群的总内存容量是固定不变的；而 <code>yarn_cluster_allocatedMB</code> 在大多数时间几乎贴着这条上沿线运行，意味着集群绝大部分时间都处在全分配的状态。看上去利用率很高，但从架构与交付视角，这更像是在提示：集群已经被当作一个“刚性资源池”使用，而不是一个能够平滑承接业务波动的弹性资源底座。</p>
<p>当 <code>allocatedMB</code> 长时间接近 <code>totalMB</code>，系统几乎没有任何缓冲空间。只要业务侧出现突发峰值、某个作业发生数据倾斜导致执行时间拉长、或者出现 shuffle 放大、重试增多，YARN 的调度就会立刻转向排队与拥塞。于是用户感知到的往往不是“高利用率”，而是更直观的体验问题：提交任务后排队时间变长，交互式分析不再及时，批处理窗口被挤压，甚至在极端情况下形成雪崩效应——任务变慢占用资源更久，导致后续任务更排队；排队越多，超时与重试越多，反过来又进一步加剧拥塞。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1889ccb296944f1796aedda6dde03480~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768379629&amp;x-signature=0O%2B8NPJAAx4Dyfdey7UuoBfGG%2BM%3D" alt="image.png" loading="lazy"/></p>
<p>在迁移到 EMR Serverless Spark 之后，从上述这张 Workspace memory consumption 曲线呈现出非常典型的“潮汐型负载”特征：在业务高峰期内存用量可以快速拉升到数十 TB；而在任务完成、负载回落后，资源占用又能迅速下降，甚至回归到接近 0 的水平。对迅雷而言，这意味着计算资源不再被固定集群容量所束缚，峰值时能够按需获得足够的内存与并发能力去承接批处理窗口、突发任务或临时分析，从而显著降低排队、拥塞与“顶格运行”的风险，让作业完成时间与交付节奏更可控。</p>
<p>从系统能力角度看，这条曲线体现的是 Serverless Spark 把“容量规划与资源池运维”从用户侧彻底剥离：平台能够基于作业生命周期自动拉起资源、按需扩展、在空闲时自动回收，实现真正的弹性伸缩与更强的资源隔离。最终带来的直接收益是成本与使用量强绑定——高峰期用多少付多少，低谷期几乎不产生资源占用，也就不再为闲置容量长期买单；同时平台用自动化调度与回收机制保障资源供给的及时性与稳定性。</p>
<p><strong>2、灵活访问归档数据</strong></p>
<p>迅雷数据团队将大量OSS数据以归档、冷归档、深度冷归档类型存储达到降低存储费用的目的，这些归档数据无法直接访问，需要提前执行解冻操作。</p>
<p>EMR Serverless Spark提供自动和手动两种解冻方式便于作业灵活访问归档数据，详见<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Femr%2Femr-serverless-spark%2Fuse-cases%2Funfreeze-the-oss-archive%3Fspm%3Da2c4g.11186623.help-menu-search-28066.d_0" target="_blank" title="https://help.aliyun.com/zh/emr/emr-serverless-spark/use-cases/unfreeze-the-oss-archive?spm=a2c4g.11186623.help-menu-search-28066.d_0" ref="nofollow noopener noreferrer">解冻OSS归档文件</a></p>
<ul>
<li>
<p>自动解冻，在作业生产plan阶段识别出归档文件，自动提交解冻请求，使得作业执行时能够正常读取数据。但对于分区值需要动态计算得出的场景，自动解冻方式无法一次提交所有解冻请求，进而影响作业执行效率。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--conf spark.sql.emr.autoRestoreOssArchive.enabled=true</span>
</code></pre>
</li>
<li>
<p>手动解冻，提供restore sql语法显示对表、分区提前解冻，解冻过程对用户更友好。</p>
</li>
</ul>
<p>借助上述功能，我们能够快速响应数据分析师对历史归档数据的访问需求，降低存储成本的同时加速业务迭代。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 解冻整个表对应的OSS归档文件供后续查询。</span>
RESTORE <span class="hljs-keyword">TABLE</span> table_name;

<span class="hljs-comment">-- 指定分区解冻, 精细化控制解冻粒度，节省资源与时间。</span>
RESTORE <span class="hljs-keyword">TABLE</span> table_name <span class="hljs-keyword">PARTITION</span> (pt1<span class="hljs-operator">=</span><span class="hljs-string">'a'</span>, pt2<span class="hljs-operator">=</span><span class="hljs-string">'b'</span>);
</code></pre>
<p><strong>3、基于Kyuubi的交互式开发</strong></p>
<p>Serverless Spark内置了100%兼容开源的Kyuubi Gateway，并在云原生稳定性和多租隔离性等方面进行了增强。一方面能复用Driver/Executor资源，避免容器启动延迟，提供秒级查询，另一方面利用Spark的动态资源伸缩，闲时及时释放资源，避免浪费，从而提供高性价比的交互式分析能力。</p>
<p>迅雷自研的数据开发平台通过beeline和hue无缝对接Kyuubi Gateway，支持日常的数仓任务开发以及即席查询，显著提升开发分析效率，同时大幅降低了数据开发，数据分析和临时查询成本。</p>
<h2 data-id="heading-5">三、业务与技术价值双重突破</h2>
<p>迁移到 EMR Serverless Spark 之后，最直观的感受是 <strong>TCO 明显下降</strong>：不再需要为固定集群按峰值长期备资源，平台按作业生命周期弹性拉起与回收，低谷期资源占用可降到接近 0，只为实际消耗付费。同时，托管化带来的稳定性与调度效率提升，减少了排队、重试和资源争抢等隐性成本，使同样的业务产出用更少的资源与更少的运维投入就能完成。</p>
<p>更关键的是<strong>交付确定性提升</strong>：大作业整体可提速约 1 小时，报表链路从过去的长尾波动变成更可控的出数节奏，关键报表能稳定在 6:00 前产出。夜间人工干预大幅减少，基本无需运维人员深夜响应。本质上反映了失败率与长尾显著降低——平台通过弹性供给、隔离与自动化恢复，把原本需要人工兜底的容量与稳定性问题前移到系统能力中解决，让生产链路更稳、更准点。</p>
<h2 data-id="heading-6">四、未来展望</h2>
<p>在<strong>场景拓展</strong>上，将EMR Serverless Spark广泛应用于临时查询、数据集成等更多业务场景，进一步释放其弹性、免运维的优势；另一方面，在<strong>技术深化</strong>上，积极探索AI与大数据的融合创新，充分发挥Serverless Spark在海量数据处理与AI协同方面的潜力，为业务创造更大价值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入解析 OpenCode：下一代 AI 编程助手的架构艺术]]></title>    <link>https://juejin.cn/post/7592170706026266659</link>    <guid>https://juejin.cn/post/7592170706026266659</guid>    <pubDate>2026-01-07T07:45:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592170706026266659" data-draft-id="7592170706025922595" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入解析 OpenCode：下一代 AI 编程助手的架构艺术"/> <meta itemprop="keywords" content="TypeScript,AIGC"/> <meta itemprop="datePublished" content="2026-01-07T07:45:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tam"/> <meta itemprop="url" content="https://juejin.cn/user/1222312659527768"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入解析 OpenCode：下一代 AI 编程助手的架构艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1222312659527768/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tam
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T07:45:41.000Z" title="Wed Jan 07 2026 07:45:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从零到一，揭秘这个2026年开年最火的开源 AI Coding Agent 的内部运作机制</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">目录</h2>
<ul>
<li><a href="#%E5%BC%95%E8%A8%80%E5%BD%93-ai-%E5%AD%A6%E4%BC%9A%E5%86%99%E4%BB%A3%E7%A0%81" title="#%E5%BC%95%E8%A8%80%E5%BD%93-ai-%E5%AD%A6%E4%BC%9A%E5%86%99%E4%BB%A3%E7%A0%81">引言：当 AI 学会写代码</a></li>
<li><a href="#%E7%AC%AC%E4%B8%80%E7%AB%A0%E9%B8%9F%E7%9E%B0%E5%85%A8%E5%B1%80---opencode-%E6%9E%B6%E6%9E%84%E6%80%BB%E8%A7%88" title="#%E7%AC%AC%E4%B8%80%E7%AB%A0%E9%B8%9F%E7%9E%B0%E5%85%A8%E5%B1%80---opencode-%E6%9E%B6%E6%9E%84%E6%80%BB%E8%A7%88">第一章：鸟瞰全局 - OpenCode 架构总览</a></li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86---ai-%E7%9A%84%E8%AE%B0%E5%BF%86%E5%AE%AB%E6%AE%BF" title="#%E7%AC%AC%E4%BA%8C%E7%AB%A0%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86---ai-%E7%9A%84%E8%AE%B0%E5%BF%86%E5%AE%AB%E6%AE%BF">第二章：会话管理 - AI 的"记忆宫殿"</a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E7%AB%A0agent-%E7%B3%BB%E7%BB%9F---%E6%80%9D%E8%80%83%E7%9A%84%E8%89%BA%E6%9C%AF" title="#%E7%AC%AC%E4%B8%89%E7%AB%A0agent-%E7%B3%BB%E7%BB%9F---%E6%80%9D%E8%80%83%E7%9A%84%E8%89%BA%E6%9C%AF">第三章：Agent 系统 - 思考的艺术</a></li>
<li><a href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0%E5%B7%A5%E5%85%B7%E7%B3%BB%E7%BB%9F---ai-%E7%9A%84%E7%91%9E%E5%A3%AB%E5%86%9B%E5%88%80" title="#%E7%AC%AC%E5%9B%9B%E7%AB%A0%E5%B7%A5%E5%85%B7%E7%B3%BB%E7%BB%9F---ai-%E7%9A%84%E7%91%9E%E5%A3%AB%E5%86%9B%E5%88%80">第四章：工具系统 - AI 的"瑞士军刀"</a></li>
<li><a href="#%E7%AC%AC%E4%BA%94%E7%AB%A0provider-%E6%8A%BD%E8%B1%A1%E5%B1%82---%E4%B8%87%E7%89%A9%E7%9A%86%E5%8F%AF-llm" title="#%E7%AC%AC%E4%BA%94%E7%AB%A0provider-%E6%8A%BD%E8%B1%A1%E5%B1%82---%E4%B8%87%E7%89%A9%E7%9A%86%E5%8F%AF-llm">第五章：Provider 抽象层 - 万物皆可 LLM</a></li>
<li><a href="#%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8E%8B%E7%BC%A9---%E8%AE%B0%E5%BF%86%E7%9A%84%E8%89%BA%E6%9C%AF" title="#%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8E%8B%E7%BC%A9---%E8%AE%B0%E5%BF%86%E7%9A%84%E8%89%BA%E6%9C%AF">第六章：上下文压缩 - 记忆的艺术</a></li>
<li><a href="#%E7%AC%AC%E4%B8%83%E7%AB%A0%E5%AE%89%E5%85%A8%E4%B8%8E%E6%9D%83%E9%99%90---%E4%BF%A1%E4%BB%BB%E4%BD%86%E8%A6%81%E9%AA%8C%E8%AF%81" title="#%E7%AC%AC%E4%B8%83%E7%AB%A0%E5%AE%89%E5%85%A8%E4%B8%8E%E6%9D%83%E9%99%90---%E4%BF%A1%E4%BB%BB%E4%BD%86%E8%A6%81%E9%AA%8C%E8%AF%81">第七章：安全与权限 - 信任但要验证</a></li>
<li><a href="#%E7%AC%AC%E5%85%AB%E7%AB%A0%E4%BA%AE%E7%82%B9%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90" title="#%E7%AC%AC%E5%85%AB%E7%AB%A0%E4%BA%AE%E7%82%B9%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90">第八章：亮点技术深度解析</a></li>
<li><a href="#%E7%AC%AC%E4%B9%9D%E7%AB%A0%E4%BB%8E%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" title="#%E7%AC%AC%E4%B9%9D%E7%AB%A0%E4%BB%8E%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">第九章：从源码学习设计模式</a></li>
<li><a href="#%E7%AC%AC%E5%8D%81%E7%AB%A0%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8E%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5" title="#%E7%AC%AC%E5%8D%81%E7%AB%A0%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%8E%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5">第十章：性能优化与工程实践</a></li>
<li><a href="#%E7%BB%93%E8%AF%ADai-%E7%BC%96%E7%A8%8B%E7%9A%84%E6%9C%AA%E6%9D%A5" title="#%E7%BB%93%E8%AF%ADai-%E7%BC%96%E7%A8%8B%E7%9A%84%E6%9C%AA%E6%9D%A5">结语：AI 编程的未来</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">引言：当 AI 学会写代码</h2>
<p>还记得第一次让 ChatGPT 帮你写代码的感觉吗？那种"哇，这也行？"的惊叹，很快就被"等等，这代码跑不起来啊"的沮丧所取代。</p>
<p>AI 能写代码，但它不能<strong>真正地</strong>写代码——它不能读取你的文件、不能运行测试、不能理解你项目的上下文。它就像一个被蒙上眼睛、绑住手脚的天才程序员：有能力，但无法施展。</p>
<p><strong>OpenCode</strong> 的出现，正是为了解开这些束缚。</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   传统 LLM Chatbot          vs         OpenCode Agent          │
│                                                                 │
│   ┌─────────────┐                    ┌─────────────────────┐   │
│   │    User     │                    │        User         │   │
│   └──────┬──────┘                    └──────────┬──────────┘   │
│          │                                      │              │
│          ▼                                      ▼              │
│   ┌─────────────┐                    ┌─────────────────────┐   │
│   │     LLM     │                    │       Agent         │   │
│   │  (黑箱对话)  │                    │  ┌───────────────┐  │   │
│   └─────────────┘                    │  │  思考 (Think)  │  │   │
│          │                           │  ├───────────────┤  │   │
│          ▼                           │  │  工具 (Tools)  │  │   │
│   ┌─────────────┐                    │  │  ├─ Read      │  │   │
│   │  纯文本回复  │                    │  │  ├─ Write     │  │   │
│   │  (无法执行)  │                    │  │  ├─ Bash      │  │   │
│   └─────────────┘                    │  │  ├─ Grep      │  │   │
│                                      │  │  └─ ...       │  │   │
│                                      │  ├───────────────┤  │   │
│                                      │  │  执行 (Action) │  │   │
│                                      │  └───────────────┘  │   │
│                                      └─────────────────────┘   │
│                                                 │              │
│                                                 ▼              │
│                                      ┌─────────────────────┐   │
│                                      │   真实的代码修改     │   │
│                                      │   可运行的结果       │   │
│                                      └─────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p>OpenCode 是一个开源的 AI 编程助手，但更准确地说，它是一个<strong>完整的 Agent 框架</strong>。它让 LLM 能够：</p>
<ul>
<li>🔍 <strong>阅读</strong>你的代码文件</li>
<li>✏️ <strong>编辑</strong>你的代码</li>
<li>🖥️ <strong>执行</strong> shell 命令</li>
<li>🔎 <strong>搜索</strong>代码库</li>
<li>🤔 <strong>思考</strong>并展示推理过程</li>
<li>📝 <strong>记忆</strong>长对话上下文</li>
<li>🔄 <strong>回滚</strong>任何修改</li>
</ul>
<p>这不是一个简单的 API wrapper，而是一个精心设计的工程艺术品。让我们一起深入它的内部，看看现代 AI Agent 是如何构建的。</p>
<hr/>
<h2 data-id="heading-2">第一章：鸟瞰全局 - OpenCode 架构总览</h2>
<h3 data-id="heading-3">1.1 Monorepo 的选择</h3>
<p>OpenCode 采用 <strong>Monorepo</strong> 架构，使用 <strong>Bun</strong> 作为运行时和包管理器，<strong>Turbo</strong> 作为构建编排工具。这个选择并非偶然：</p>
<pre><code class="hljs language-bash" lang="bash">opencode/
├── packages/
│   ├── opencode/        <span class="hljs-comment"># 核心 CLI 和服务器 (心脏)</span>
│   ├── console/         <span class="hljs-comment"># Web 管理控制台 (大脑可视化)</span>
│   │   ├── app/         <span class="hljs-comment"># SolidJS Web UI</span>
│   │   ├── core/        <span class="hljs-comment"># 后端逻辑</span>
│   │   ├── <span class="hljs-keyword">function</span>/    <span class="hljs-comment"># Serverless 函数</span>
│   │   └── mail/        <span class="hljs-comment"># 邮件模板</span>
│   ├── desktop/         <span class="hljs-comment"># Tauri 桌面应用 (Native 外壳)</span>
│   ├── app/             <span class="hljs-comment"># 共享 UI 组件 (统一视觉)</span>
│   ├── sdk/js/          <span class="hljs-comment"># JavaScript SDK (对外接口)</span>
│   ├── ui/              <span class="hljs-comment"># UI 组件库 (设计系统)</span>
│   ├── plugin/          <span class="hljs-comment"># 插件系统 (扩展能力)</span>
│   ├── util/            <span class="hljs-comment"># 共享工具函数 (基础设施)</span>
│   ├── web/             <span class="hljs-comment"># 文档网站 (知识库)</span>
│   └── identity/        <span class="hljs-comment"># 身份认证 (安全门户)</span>
├── infra/               <span class="hljs-comment"># 基础设施即代码 (SST/AWS)</span>
└── sdks/                <span class="hljs-comment"># SDK 分发</span>
</code></pre>
<p><strong>为什么是 Monorepo？</strong></p>
<p>想象一下，你正在建造一座现代化的智能大厦：</p>
<ul>
<li><strong>CLI</strong> 是大厦的电梯系统——用户通过它进入</li>
<li><strong>Server</strong> 是大厦的中央控制室——协调一切</li>
<li><strong>Desktop</strong> 是大厦的豪华门厅——精致的入口</li>
<li><strong>Web Console</strong> 是大厦的监控中心——全局可视</li>
<li><strong>SDK</strong> 是大厦的 API 接口——供外部系统对接</li>
</ul>
<p>这些组件需要<strong>共享代码</strong>（UI 组件、工具函数、类型定义），需要<strong>同步版本</strong>，需要<strong>统一构建</strong>。Monorepo 让这一切变得优雅。</p>
<h3 data-id="heading-4">1.2 技术栈全景</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "Frontend Layer"
        CLI[CLI/TUI&lt;br/&gt;yargs + ink]
        Desktop[Desktop&lt;br/&gt;Tauri 2]
        Web[Web Console&lt;br/&gt;SolidJS + Vite]
    end

    subgraph "API Layer"
        Server[HTTP Server&lt;br/&gt;Hono]
        WS[WebSocket&lt;br/&gt;Real-time]
        ACP[ACP Protocol]
        MCP[MCP Protocol]
    end

    subgraph "Core Layer"
        Session[Session Manager]
        Agent[Agent System]
        Tool[Tool Registry]
        Provider[Provider Layer]
    end

    subgraph "Infrastructure"
        Storage[Storage&lt;br/&gt;SQLite/Postgres]
        Config[Config Manager]
        Permission[Permission System]
        Bus[Event Bus]
    end

    subgraph "External"
        LLM[LLM Providers&lt;br/&gt;Anthropic/OpenAI/Google...]
        Git[Git/VCS]
        FS[File System]
    end

    CLI --&gt; Server
    Desktop --&gt; Server
    Web --&gt; Server

    Server --&gt; Session
    WS --&gt; Session
    ACP --&gt; Session
    MCP --&gt; Tool

    Session --&gt; Agent
    Session --&gt; Provider
    Agent --&gt; Tool

    Tool --&gt; FS
    Tool --&gt; Git
    Provider --&gt; LLM

    Session --&gt; Storage
    Session --&gt; Bus
    Tool --&gt; Permission
</code></pre>
<h3 data-id="heading-5">1.3 核心包结构深入</h3>
<p>让我们聚焦 <code>packages/opencode</code>——这是整个系统的心脏：</p>
<pre><code class="hljs language-bash" lang="bash">packages/opencode/src/
├── cli/cmd/           <span class="hljs-comment"># CLI 命令入口 (17+ 命令)</span>
│   ├── run.ts         <span class="hljs-comment"># 主运行命令</span>
│   ├── auth.ts        <span class="hljs-comment"># 认证命令</span>
│   ├── serve.ts       <span class="hljs-comment"># 服务器模式</span>
│   ├── mcp.ts         <span class="hljs-comment"># MCP 服务器</span>
│   └── ...
│
├── agent/             <span class="hljs-comment"># Agent 系统</span>
│   └── agent.ts       <span class="hljs-comment"># Agent 定义与配置</span>
│
├── session/           <span class="hljs-comment"># 会话管理 (核心!)</span>
│   ├── index.ts       <span class="hljs-comment"># Session CRUD</span>
│   ├── message-v2.ts  <span class="hljs-comment"># 消息 Schema</span>
│   ├── prompt.ts      <span class="hljs-comment"># 提示词构建 + 主循环</span>
│   ├── processor.ts   <span class="hljs-comment"># 流式处理管道</span>
│   ├── compaction.ts  <span class="hljs-comment"># 上下文压缩</span>
│   ├── summary.ts     <span class="hljs-comment"># 摘要生成</span>
│   ├── llm.ts         <span class="hljs-comment"># LLM 调用接口</span>
│   ├── system.ts      <span class="hljs-comment"># System Prompt 构建</span>
│   ├── revert.ts      <span class="hljs-comment"># 回滚功能</span>
│   ├── status.ts      <span class="hljs-comment"># 状态追踪</span>
│   ├── retry.ts       <span class="hljs-comment"># 重试逻辑</span>
│   └── todo.ts        <span class="hljs-comment"># 任务追踪</span>
│
├── provider/          <span class="hljs-comment"># LLM Provider 抽象</span>
│   └── provider.ts    <span class="hljs-comment"># 18+ 提供商支持</span>
│
├── tool/              <span class="hljs-comment"># 工具系统</span>
│   ├── registry.ts    <span class="hljs-comment"># 工具注册表</span>
│   ├── tool.ts        <span class="hljs-comment"># 工具定义接口</span>
│   ├── bash.ts        <span class="hljs-comment"># Shell 执行</span>
│   ├── read.ts        <span class="hljs-comment"># 文件读取</span>
│   ├── write.ts       <span class="hljs-comment"># 文件写入</span>
│   ├── edit.ts        <span class="hljs-comment"># 文件编辑</span>
│   ├── grep.ts        <span class="hljs-comment"># 代码搜索</span>
│   ├── glob.ts        <span class="hljs-comment"># 文件匹配</span>
│   ├── lsp.ts         <span class="hljs-comment"># LSP 集成</span>
│   ├── task.ts        <span class="hljs-comment"># 子任务</span>
│   └── ...
│
├── server/            <span class="hljs-comment"># HTTP 服务器</span>
│   ├── server.ts      <span class="hljs-comment"># Hono 服务器</span>
│   └── tui.ts         <span class="hljs-comment"># TUI 路由</span>
│
├── mcp/               <span class="hljs-comment"># Model Context Protocol</span>
├── lsp/               <span class="hljs-comment"># Language Server Protocol</span>
├── project/           <span class="hljs-comment"># 项目管理</span>
├── permission/        <span class="hljs-comment"># 权限系统</span>
├── storage/           <span class="hljs-comment"># 数据存储</span>
├── bus/               <span class="hljs-comment"># 事件总线</span>
├── config/            <span class="hljs-comment"># 配置管理</span>
├── worktree/          <span class="hljs-comment"># Git Worktree</span>
├── snapshot/          <span class="hljs-comment"># 文件快照</span>
└── plugin/            <span class="hljs-comment"># 插件系统</span>
</code></pre>
<p>这个结构体现了<strong>关注点分离</strong>的设计哲学：每个目录都有明确的职责，模块之间通过清晰的接口通信。</p>
<hr/>
<h2 data-id="heading-6">第二章：会话管理 - AI 的"记忆宫殿"</h2>
<blockquote>
<p>"记忆是智慧的母亲。" —— 埃斯库罗斯</p>
</blockquote>
<p>如果说 LLM 是 Agent 的大脑，那么 <strong>Session Management</strong> 就是它的记忆系统。没有记忆的 AI，就像患了阿尔茨海默症的天才——每次对话都从零开始。</p>
<h3 data-id="heading-7">2.1 会话的数据模型</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">erDiagram
    Session ||--o{ Message : contains
    Message ||--o{ Part : contains
    Session {
        string id PK
        string projectID FK
        string directory
        string title
        timestamp created
        timestamp updated
        json summary
        json permission
    }
    Message {
        string id PK
        string sessionID FK
        string role "user|assistant"
        string parentID "for assistant"
        string agent
        json model
        json tokens
        float cost
        string finish
        json error
    }
    Part {
        string id PK
        string messageID FK
        string type "text|tool|reasoning|file|..."
        json content
        json state "for tool parts"
        timestamp created
    }
</code></pre>
<p>这个三层结构设计得非常精妙：</p>
<ol>
<li><strong>Session</strong> - 一次完整的任务会话</li>
<li><strong>Message</strong> - 用户或 AI 的一次发言</li>
<li><strong>Part</strong> - 发言中的组成部分（文本、工具调用、思考过程等）</li>
</ol>
<p><strong>为什么需要 Part 层级？</strong></p>
<p>传统的 chatbot 只有 Message 层级——一条消息就是一段文本。但 AI Agent 的输出要复杂得多：</p>
<pre><code class="hljs language-css" lang="css">User: <span class="hljs-string">"帮我修复 src/app.ts 的 bug"</span>

Assistant Response:
├─ ReasoningPart: <span class="hljs-string">"让我先读取文件看看问题..."</span>
├─ ToolPart: { name: <span class="hljs-string">"read"</span>, input: {...}, output: <span class="hljs-string">"..."</span> }
├─ ReasoningPart: <span class="hljs-string">"我发现第 42 行有类型错误..."</span>
├─ ToolPart: { name: <span class="hljs-string">"edit"</span>, input: {...}, output: <span class="hljs-string">"..."</span> }
├─ TextPart: <span class="hljs-string">"已修复！问题是..."</span>
└─ PatchPart: { diff: <span class="hljs-string">"..."</span> }
</code></pre>
<p>Part 层级让我们能够：</p>
<ul>
<li><strong>流式更新</strong>：每个 Part 可以独立更新，UI 实时刷新</li>
<li><strong>状态追踪</strong>：工具执行有独立的状态机</li>
<li><strong>细粒度存储</strong>：只更新变化的部分</li>
<li><strong>差异化渲染</strong>：思考过程、工具调用、最终回复用不同样式显示</li>
</ul>
<h3 data-id="heading-8">2.2 消息的类型系统</h3>
<p>OpenCode 使用 <strong>Zod</strong> 定义了严格的类型系统：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用户消息 Schema</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">UserMessage</span> = z.<span class="hljs-title function_">object</span>({
  <span class="hljs-attr">id</span>: z.<span class="hljs-title function_">string</span>(),
  <span class="hljs-attr">sessionID</span>: z.<span class="hljs-title function_">string</span>(),
  <span class="hljs-attr">role</span>: z.<span class="hljs-title function_">literal</span>(<span class="hljs-string">"user"</span>),
  <span class="hljs-attr">time</span>: z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">created</span>: z.<span class="hljs-title function_">number</span>() }),

  <span class="hljs-comment">// AI 配置</span>
  <span class="hljs-attr">agent</span>: z.<span class="hljs-title function_">string</span>(),
  <span class="hljs-attr">model</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">providerID</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">modelID</span>: z.<span class="hljs-title function_">string</span>(),
  }),

  <span class="hljs-comment">// 可选覆盖</span>
  <span class="hljs-attr">system</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">optional</span>(),      <span class="hljs-comment">// 自定义 system prompt</span>
  <span class="hljs-attr">tools</span>: z.<span class="hljs-title function_">record</span>(z.<span class="hljs-title function_">boolean</span>()).<span class="hljs-title function_">optional</span>(), <span class="hljs-comment">// 工具开关</span>
  <span class="hljs-attr">variant</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">optional</span>(),     <span class="hljs-comment">// 模型变体</span>

  <span class="hljs-comment">// 摘要信息</span>
  <span class="hljs-attr">summary</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">title</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">optional</span>(),
    <span class="hljs-attr">body</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">optional</span>(),
    <span class="hljs-attr">diffs</span>: z.<span class="hljs-title function_">array</span>(<span class="hljs-title class_">FileDiff</span>),
  }).<span class="hljs-title function_">optional</span>(),
});

<span class="hljs-comment">// 助手消息 Schema</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AssistantMessage</span> = z.<span class="hljs-title function_">object</span>({
  <span class="hljs-attr">id</span>: z.<span class="hljs-title function_">string</span>(),
  <span class="hljs-attr">sessionID</span>: z.<span class="hljs-title function_">string</span>(),
  <span class="hljs-attr">role</span>: z.<span class="hljs-title function_">literal</span>(<span class="hljs-string">"assistant"</span>),
  <span class="hljs-attr">parentID</span>: z.<span class="hljs-title function_">string</span>(),  <span class="hljs-comment">// 关联到用户消息</span>

  <span class="hljs-attr">time</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">created</span>: z.<span class="hljs-title function_">number</span>(),
    <span class="hljs-attr">completed</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">optional</span>(),
  }),

  <span class="hljs-comment">// 模型信息</span>
  <span class="hljs-attr">modelID</span>: z.<span class="hljs-title function_">string</span>(),
  <span class="hljs-attr">providerID</span>: z.<span class="hljs-title function_">string</span>(),
  <span class="hljs-attr">agent</span>: z.<span class="hljs-title function_">string</span>(),
  <span class="hljs-attr">mode</span>: z.<span class="hljs-title function_">string</span>(),

  <span class="hljs-comment">// 执行结果</span>
  <span class="hljs-attr">finish</span>: z.<span class="hljs-title function_">enum</span>([<span class="hljs-string">"tool-calls"</span>, <span class="hljs-string">"stop"</span>, <span class="hljs-string">"length"</span>, <span class="hljs-string">"content-filter"</span>, <span class="hljs-string">"other"</span>]),
  <span class="hljs-attr">error</span>: <span class="hljs-title class_">MessageError</span>.<span class="hljs-title function_">optional</span>(),

  <span class="hljs-comment">// 成本追踪</span>
  <span class="hljs-attr">cost</span>: z.<span class="hljs-title function_">number</span>(),
  <span class="hljs-attr">tokens</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">input</span>: z.<span class="hljs-title function_">number</span>(),
    <span class="hljs-attr">output</span>: z.<span class="hljs-title function_">number</span>(),
    <span class="hljs-attr">reasoning</span>: z.<span class="hljs-title function_">number</span>(),
    <span class="hljs-attr">cache</span>: z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">read</span>: z.<span class="hljs-title function_">number</span>(), <span class="hljs-attr">write</span>: z.<span class="hljs-title function_">number</span>() }),
  }),
});
</code></pre>
<p><strong><code>finish</code> 字段的智慧</strong></p>
<p>注意 <code>finish</code> 字段的枚举值：</p>
<ul>
<li><code>"tool-calls"</code>: AI 需要调用工具，循环继续</li>
<li><code>"stop"</code>: AI 主动结束，循环终止</li>
<li><code>"length"</code>: 输出过长被截断</li>
<li><code>"content-filter"</code>: 内容被过滤</li>
<li><code>"other"</code>: 其他原因</li>
</ul>
<p>这个字段是<strong>主循环的控制开关</strong>——只有当 <code>finish !== "tool-calls"</code> 时，Agent 才会停止工作。</p>
<h3 data-id="heading-9">2.3 Part 的类型宇宙</h3>
<p>Part 使用 <strong>Discriminated Union</strong> 模式，这是 TypeScript 类型系统的一个强大特性：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Part</span> =
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"text"</span>; <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>; }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"reasoning"</span>; <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>; }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"tool"</span>; <span class="hljs-attr">state</span>: <span class="hljs-title class_">ToolState</span>; }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"file"</span>; <span class="hljs-attr">source</span>: <span class="hljs-string">"file"</span> | <span class="hljs-string">"symbol"</span> | <span class="hljs-string">"resource"</span>; <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>; }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"snapshot"</span>; <span class="hljs-attr">ref</span>: <span class="hljs-built_in">string</span>; }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"patch"</span>; <span class="hljs-attr">diff</span>: <span class="hljs-built_in">string</span>; }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"step-start"</span>; <span class="hljs-attr">snapshot</span>: <span class="hljs-built_in">string</span>; }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"step-finish"</span>; <span class="hljs-attr">usage</span>: <span class="hljs-title class_">Usage</span>; }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"agent"</span>; <span class="hljs-attr">agentID</span>: <span class="hljs-built_in">string</span>; }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"compaction"</span>; }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"subtask"</span>; <span class="hljs-attr">taskID</span>: <span class="hljs-built_in">string</span>; }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"retry"</span>; <span class="hljs-attr">attempt</span>: <span class="hljs-built_in">number</span>; };
</code></pre>
<p>每种类型都有其独特的用途：</p>




























































<table><thead><tr><th>类型</th><th>用途</th><th>示例</th></tr></thead><tbody><tr><td><code>text</code></td><td>AI 的文本回复</td><td>"我已经修复了这个 bug..."</td></tr><tr><td><code>reasoning</code></td><td>思考过程</td><td>"让我分析一下这个函数..."</td></tr><tr><td><code>tool</code></td><td>工具调用</td><td>Read, Write, Bash, Grep...</td></tr><tr><td><code>file</code></td><td>文件附件</td><td>读取的代码文件内容</td></tr><tr><td><code>snapshot</code></td><td>Git 快照引用</td><td>用于回滚</td></tr><tr><td><code>patch</code></td><td>文件变更</td><td>diff 格式的修改</td></tr><tr><td><code>step-start/finish</code></td><td>步骤边界</td><td>用于计算 token 和成本</td></tr><tr><td><code>compaction</code></td><td>压缩标记</td><td>标记上下文被压缩</td></tr><tr><td><code>subtask</code></td><td>子任务</td><td>调用其他 Agent</td></tr><tr><td><code>retry</code></td><td>重试元数据</td><td>记录重试次数</td></tr></tbody></table>
<h3 data-id="heading-10">2.4 Tool Part 的状态机</h3>
<p>工具调用是 Agent 最核心的能力，它的状态管理尤为重要：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2
    [*] --&gt; Pending: tool-input-start
    Pending --&gt; Running: tool-call
    Running --&gt; Completed: tool-result
    Running --&gt; Error: tool-error
    Completed --&gt; [*]
    Error --&gt; [*]

    note right of Pending
        等待输入完成
        raw: 原始 JSON 字符串
    end note

    note right of Running
        正在执行
        input: 解析后的参数
        time.start: 开始时间
    end note

    note right of Completed
        执行成功
        output: 执行结果
        title: 展示标题
        metadata: 额外信息
        time.end: 结束时间
    end note

    note right of Error
        执行失败
        error: 错误信息
    end note
</code></pre>
<p>状态的数据结构：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ToolState</span> =
  | {
      <span class="hljs-attr">status</span>: <span class="hljs-string">"pending"</span>;
      <span class="hljs-attr">input</span>: {};
      <span class="hljs-attr">raw</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// 流式接收的原始 JSON</span>
    }
  | {
      <span class="hljs-attr">status</span>: <span class="hljs-string">"running"</span>;
      <span class="hljs-attr">input</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;;
      title?: <span class="hljs-built_in">string</span>;
      metadata?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;;
      <span class="hljs-attr">time</span>: { <span class="hljs-attr">start</span>: <span class="hljs-built_in">number</span> };
    }
  | {
      <span class="hljs-attr">status</span>: <span class="hljs-string">"completed"</span>;
      <span class="hljs-attr">input</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;;
      <span class="hljs-attr">output</span>: <span class="hljs-built_in">string</span>;
      <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
      <span class="hljs-attr">metadata</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;;
      <span class="hljs-attr">time</span>: { <span class="hljs-attr">start</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">end</span>: <span class="hljs-built_in">number</span>; compacted?: <span class="hljs-built_in">number</span> };
      attachments?: <span class="hljs-title class_">FilePart</span>[];
    }
  | {
      <span class="hljs-attr">status</span>: <span class="hljs-string">"error"</span>;
      <span class="hljs-attr">input</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;;
      <span class="hljs-attr">error</span>: <span class="hljs-built_in">string</span>;
      <span class="hljs-attr">time</span>: { <span class="hljs-attr">start</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">end</span>: <span class="hljs-built_in">number</span> };
    };
</code></pre>
<p><strong>为什么需要 <code>pending</code> 状态？</strong></p>
<p>当 LLM 决定调用工具时，它会流式输出工具的参数。在参数完整之前，我们只有一个不完整的 JSON 字符串：</p>
<pre><code class="hljs language-bash" lang="bash">接收中: {<span class="hljs-string">"file_path"</span>: <span class="hljs-string">"src/ap
接收中: {"</span>file_path<span class="hljs-string">": "</span>src/app.ts<span class="hljs-string">", "</span>off
接收中: {<span class="hljs-string">"file_path"</span>: <span class="hljs-string">"src/app.ts"</span>, <span class="hljs-string">"offset"</span>: 0, <span class="hljs-string">"limit"</span>: 100}
</code></pre>
<p><code>pending</code> 状态让我们能够在 UI 上显示"正在准备工具调用..."，而不是等到参数完整才显示。</p>
<hr/>
<h2 data-id="heading-11">第三章：Agent 系统 - 思考的艺术</h2>
<h3 data-id="heading-12">3.1 什么是 Agent？</h3>
<p>在 OpenCode 中，<strong>Agent</strong> 不仅仅是一个 LLM 的包装——它是一个<strong>人格化的角色定义</strong>。每个 Agent 有自己的：</p>
<ul>
<li><strong>System Prompt</strong> - 行为指南</li>
<li><strong>权限配置</strong> - 能做什么</li>
<li><strong>模型参数</strong> - temperature, topP 等</li>
<li><strong>步数限制</strong> - 最多执行多少轮</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">AgentInfo</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;           <span class="hljs-comment">// 唯一标识符</span>
  <span class="hljs-attr">mode</span>: <span class="hljs-string">"subagent"</span> | <span class="hljs-string">"primary"</span> | <span class="hljs-string">"all"</span>;  <span class="hljs-comment">// 使用模式</span>
  permission?: <span class="hljs-title class_">PermissionRuleset</span>;  <span class="hljs-comment">// 权限规则</span>
  prompt?: <span class="hljs-built_in">string</span>;        <span class="hljs-comment">// 自定义 System Prompt</span>
  temperature?: <span class="hljs-built_in">number</span>;   <span class="hljs-comment">// 创造性程度</span>
  topP?: <span class="hljs-built_in">number</span>;          <span class="hljs-comment">// 采样范围</span>
  steps?: <span class="hljs-built_in">number</span>;         <span class="hljs-comment">// 最大步数</span>
}
</code></pre>
<h3 data-id="heading-13">3.2 内置 Agent 图鉴</h3>
<p>OpenCode 内置了多个专业化的 Agent：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph "Primary Agents"
        Build[build&lt;br/&gt;主执行 Agent]
        Plan[plan&lt;br/&gt;规划 Agent]
    end

    subgraph "Subagents"
        Explore[explore&lt;br/&gt;探索 Agent&lt;br/&gt;只读权限]
        General[general&lt;br/&gt;通用 Agent]
    end

    subgraph "Hidden Agents"
        Compaction[compaction&lt;br/&gt;压缩 Agent]
        Title[title&lt;br/&gt;标题生成]
        Summary[summary&lt;br/&gt;摘要生成]
    end

    Build --&gt; Explore
    Build --&gt; General
    Build --&gt; Compaction
    Build --&gt; Title
    Build --&gt; Summary
</code></pre>
<p><strong>各 Agent 的职责：</strong></p>





















































<table><thead><tr><th>Agent</th><th>模式</th><th>职责</th><th>特点</th></tr></thead><tbody><tr><td><code>build</code></td><td>primary</td><td>主要的代码执行 Agent</td><td>原生权限，最常用</td></tr><tr><td><code>plan</code></td><td>primary</td><td>规划阶段 Agent</td><td>用于制定实施计划</td></tr><tr><td><code>explore</code></td><td>subagent</td><td>代码库探索</td><td><strong>只读权限</strong>，快速搜索</td></tr><tr><td><code>general</code></td><td>subagent</td><td>通用多步任务</td><td>完整权限</td></tr><tr><td><code>compaction</code></td><td>hidden</td><td>上下文压缩</td><td>自动调用，用户不可见</td></tr><tr><td><code>title</code></td><td>hidden</td><td>生成会话标题</td><td>使用小模型，成本低</td></tr><tr><td><code>summary</code></td><td>hidden</td><td>生成消息摘要</td><td>自动总结对话</td></tr></tbody></table>
<h3 data-id="heading-14">3.3 Explore Agent 的妙用</h3>
<p><code>explore</code> Agent 是一个<strong>只读的快速探索者</strong>，它的设计体现了"最小权限原则"：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-attr">name</span>: <span class="hljs-string">"explore"</span>,
  <span class="hljs-attr">mode</span>: <span class="hljs-string">"subagent"</span>,
  <span class="hljs-attr">permission</span>: {
    <span class="hljs-comment">// 只允许读取操作</span>
    <span class="hljs-string">"tool.read"</span>: { <span class="hljs-attr">allow</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">"tool.glob"</span>: { <span class="hljs-attr">allow</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">"tool.grep"</span>: { <span class="hljs-attr">allow</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-comment">// 禁止写入操作</span>
    <span class="hljs-string">"tool.write"</span>: { <span class="hljs-attr">deny</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">"tool.edit"</span>: { <span class="hljs-attr">deny</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">"tool.bash"</span>: { <span class="hljs-attr">deny</span>: <span class="hljs-literal">true</span> },
  },
  <span class="hljs-attr">prompt</span>: <span class="hljs-string">`You are a fast codebase explorer. Your job is to quickly
    find relevant files and code patterns. You cannot modify anything.`</span>,
  <span class="hljs-attr">steps</span>: <span class="hljs-number">10</span>,  <span class="hljs-comment">// 最多 10 轮，快速完成</span>
}
</code></pre>
<p><strong>使用场景：</strong></p>
<p>当用户问"这个项目的路由是怎么实现的？"，主 Agent 可以：</p>
<ol>
<li>创建一个 <code>explore</code> 子任务</li>
<li>Explore Agent 快速搜索代码</li>
<li>返回结果给主 Agent</li>
<li>主 Agent 综合回答</li>
</ol>
<p>这样的设计有几个好处：</p>
<ul>
<li><strong>安全</strong>：探索过程不会意外修改文件</li>
<li><strong>高效</strong>：explore 有专门优化的 prompt</li>
<li><strong>并行</strong>：多个探索任务可以并行执行</li>
</ul>
<h3 data-id="heading-15">3.4 Agent 的调用链</h3>
<pre><code class="hljs language-css" lang="css">User <span class="hljs-selector-tag">Input</span>: <span class="hljs-string">"帮我重构这个函数"</span>
     │
     ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Build Agent                              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 思考：我需要先了解这个函数的用途和上下文                      │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 工具调用：Task (创建 explore 子任务)                        │  │
│  │ { agent: <span class="hljs-string">"explore"</span>, prompt: <span class="hljs-string">"找出所有调用这个函数的地方"</span> }   │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                  │
└──────────────────────────────│──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Explore Agent                             │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 工具：Grep (搜索函数引用)                                    │  │
│  │ 工具：Read (读取相关文件)                                    │  │
│  │ 返回：找到 <span class="hljs-number">5</span> 处调用，位于 <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.ts</span>, <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.ts</span>, c<span class="hljs-selector-class">.ts</span>...               │  │
│  └───────────────────────────────────────────────────────────┘  │
└──────────────────────────────│──────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Build Agent (继续)                        │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 思考：了解了上下文，现在可以安全地重构                        │  │
│  │ 工具：Edit (修改函数)                                        │  │
│  │ 工具：Edit (更新调用处)                                      │  │
│  │ 输出：重构完成，修改了 <span class="hljs-number">6</span> 个文件                              │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-16">第四章：工具系统 - AI 的"瑞士军刀"</h2>
<h3 data-id="heading-17">4.1 工具的设计哲学</h3>
<p>工具是 Agent 与真实世界交互的桥梁。OpenCode 的工具系统遵循几个设计原则：</p>
<ol>
<li><strong>声明式定义</strong>：使用 Zod Schema 定义参数</li>
<li><strong>上下文感知</strong>：每个工具都能访问会话上下文</li>
<li><strong>状态追踪</strong>：执行过程实时更新</li>
<li><strong>权限控制</strong>：每个工具调用都经过权限检查</li>
<li><strong>可扩展</strong>：支持自定义工具和 MCP 协议</li>
</ol>
<h3 data-id="heading-18">4.2 工具定义接口</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 工具定义接口</span>
<span class="hljs-title class_">Tool</span>.<span class="hljs-property">define</span> = (<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">init</span>: <span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>;           <span class="hljs-comment">// 给 LLM 看的描述</span>
  <span class="hljs-attr">parameters</span>: <span class="hljs-title class_">ZodSchema</span>;         <span class="hljs-comment">// 参数 Schema</span>
  <span class="hljs-attr">execute</span>: <span class="hljs-function">(<span class="hljs-params">args: T, ctx: ToolContext</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ToolResult</span>&gt;;
  formatValidationError?: <span class="hljs-function">(<span class="hljs-params">error: ZodError</span>) =&gt;</span> <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// 自定义错误格式</span>
}));

<span class="hljs-comment">// 工具上下文</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ToolContext</span> {
  <span class="hljs-attr">sessionID</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">messageID</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">agent</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">abort</span>: <span class="hljs-title class_">AbortSignal</span>;           <span class="hljs-comment">// 用于取消执行</span>
  <span class="hljs-attr">callID</span>: <span class="hljs-built_in">string</span>;               <span class="hljs-comment">// 本次调用的唯一 ID</span>

  <span class="hljs-comment">// 动态方法</span>
  <span class="hljs-title function_">metadata</span>(<span class="hljs-attr">input</span>: <span class="hljs-built_in">object</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;  <span class="hljs-comment">// 更新元数据</span>
  <span class="hljs-title function_">ask</span>(<span class="hljs-attr">request</span>: <span class="hljs-title class_">PermissionRequest</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;  <span class="hljs-comment">// 请求权限</span>
}

<span class="hljs-comment">// 工具执行结果</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ToolResult</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;                <span class="hljs-comment">// 展示给用户的标题</span>
  <span class="hljs-attr">output</span>: <span class="hljs-built_in">string</span>;               <span class="hljs-comment">// 返回给 LLM 的输出</span>
  metadata?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;;  <span class="hljs-comment">// 额外信息</span>
  attachments?: <span class="hljs-title class_">FilePart</span>[];     <span class="hljs-comment">// 附件（如图片）</span>
}
</code></pre>
<h3 data-id="heading-19">4.3 核心工具详解</h3>
<h4 data-id="heading-20">Read Tool - 文件读取</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Tool</span>.<span class="hljs-title function_">define</span>(<span class="hljs-string">"read"</span>, <span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">description</span>: <span class="hljs-string">`Reads a file from the local filesystem.
    - The file_path parameter must be an absolute path
    - By default reads up to 2000 lines
    - Can read images (PNG, JPG), PDFs, and Jupyter notebooks
    - Results use cat -n format with line numbers`</span>,

  <span class="hljs-attr">parameters</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">file_path</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"Absolute path to the file"</span>),
    <span class="hljs-attr">offset</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">optional</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"Starting line number"</span>),
    <span class="hljs-attr">limit</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">optional</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"Number of lines to read"</span>),
  }),

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">{ file_path, offset, limit }, ctx</span>) {
    <span class="hljs-comment">// 1. 规范化路径</span>
    <span class="hljs-keyword">const</span> normalizedPath = <span class="hljs-title function_">normalizePath</span>(file_path);

    <span class="hljs-comment">// 2. 检查权限</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isExternalPath</span>(normalizedPath)) {
      <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">ask</span>({ <span class="hljs-attr">permission</span>: <span class="hljs-string">"read.external"</span>, <span class="hljs-attr">path</span>: normalizedPath });
    }

    <span class="hljs-comment">// 3. 检测文件类型</span>
    <span class="hljs-keyword">const</span> fileType = <span class="hljs-title function_">detectFileType</span>(normalizedPath);

    <span class="hljs-comment">// 4. 根据类型读取</span>
    <span class="hljs-keyword">if</span> (fileType === <span class="hljs-string">"image"</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">title</span>: <span class="hljs-string">`Read image`</span>, <span class="hljs-attr">output</span>: <span class="hljs-string">"[Image]"</span>, <span class="hljs-attr">attachments</span>: [...] };
    }
    <span class="hljs-keyword">if</span> (fileType === <span class="hljs-string">"pdf"</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">title</span>: <span class="hljs-string">`Read PDF`</span>, <span class="hljs-attr">output</span>: <span class="hljs-title function_">extractPdfText</span>(normalizedPath) };
    }

    <span class="hljs-comment">// 5. 读取文本文件</span>
    <span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> <span class="hljs-title function_">readFile</span>(normalizedPath, { offset, limit });

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">title</span>: <span class="hljs-string">`Read <span class="hljs-subst">${basename(normalizedPath)}</span>`</span>,
      <span class="hljs-attr">output</span>: <span class="hljs-title function_">formatWithLineNumbers</span>(content, offset),
      <span class="hljs-attr">metadata</span>: { <span class="hljs-attr">lines</span>: content.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>).<span class="hljs-property">length</span>, <span class="hljs-attr">path</span>: normalizedPath },
    };
  },
}));
</code></pre>
<h4 data-id="heading-21">Edit Tool - 精确编辑</h4>
<p>Edit Tool 是最复杂的工具之一，它实现了<strong>精确的字符串替换</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Tool</span>.<span class="hljs-title function_">define</span>(<span class="hljs-string">"edit"</span>, <span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">description</span>: <span class="hljs-string">`Performs exact string replacements in files.
    - You must read the file before editing
    - old_string must be unique in the file
    - Use replace_all for batch replacements`</span>,

  <span class="hljs-attr">parameters</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">file_path</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">old_string</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"Text to replace"</span>),
    <span class="hljs-attr">new_string</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"Replacement text"</span>),
    <span class="hljs-attr">replace_all</span>: z.<span class="hljs-title function_">boolean</span>().<span class="hljs-title function_">default</span>(<span class="hljs-literal">false</span>),
  }),

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">{ file_path, old_string, new_string, replace_all }, ctx</span>) {
    <span class="hljs-comment">// 1. 读取当前内容</span>
    <span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> <span class="hljs-title function_">readFile</span>(file_path);

    <span class="hljs-comment">// 2. 验证 old_string 存在且唯一（除非 replace_all）</span>
    <span class="hljs-keyword">const</span> occurrences = <span class="hljs-title function_">countOccurrences</span>(content, old_string);

    <span class="hljs-keyword">if</span> (occurrences === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`String not found in file`</span>);
    }
    <span class="hljs-keyword">if</span> (occurrences &gt; <span class="hljs-number">1</span> &amp;&amp; !replace_all) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`String appears <span class="hljs-subst">${occurrences}</span> times. Use replace_all or provide more context.`</span>);
    }

    <span class="hljs-comment">// 3. 执行替换</span>
    <span class="hljs-keyword">const</span> newContent = replace_all
      ? content.<span class="hljs-title function_">replaceAll</span>(old_string, new_string)
      : content.<span class="hljs-title function_">replace</span>(old_string, new_string);

    <span class="hljs-comment">// 4. 写入文件</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">writeFile</span>(file_path, newContent);

    <span class="hljs-comment">// 5. 生成 diff</span>
    <span class="hljs-keyword">const</span> diff = <span class="hljs-title function_">createDiff</span>(content, newContent, file_path);

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">title</span>: <span class="hljs-string">`Edit <span class="hljs-subst">${basename(file_path)}</span>`</span>,
      <span class="hljs-attr">output</span>: diff,
      <span class="hljs-attr">metadata</span>: {
        <span class="hljs-attr">replacements</span>: replace_all ? occurrences : <span class="hljs-number">1</span>,
        <span class="hljs-attr">path</span>: file_path,
      },
    };
  },
}));
</code></pre>
<p><strong>为什么用字符串替换而不是行号？</strong></p>
<p>行号编辑（"修改第 42 行"）看似简单，但有一个致命问题：<strong>LLM 数不准行号</strong>。</p>
<p>当 AI 说"请看第 42 行"，它可能实际上指的是第 40 行或第 45 行。但字符串匹配是精确的——要么找到，要么找不到。</p>
<p>这种设计还有一个好处：<strong>强制 AI 提供上下文</strong>。如果替换目标不唯一，AI 必须提供更多周围代码来消歧义，这反而提高了编辑的准确性。</p>
<h4 data-id="heading-22">Bash Tool - Shell 执行</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">Tool</span>.<span class="hljs-title function_">define</span>(<span class="hljs-string">"bash"</span>, <span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">description</span>: <span class="hljs-string">`Executes bash commands with timeout and security measures.
    - Avoid file operations, use dedicated tools instead
    - Commands timeout after 2 minutes by default
    - Output truncated at 30000 characters`</span>,

  <span class="hljs-attr">parameters</span>: z.<span class="hljs-title function_">object</span>({
    <span class="hljs-attr">command</span>: z.<span class="hljs-title function_">string</span>(),
    <span class="hljs-attr">timeout</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">max</span>(<span class="hljs-number">600000</span>).<span class="hljs-title function_">optional</span>(),
    <span class="hljs-attr">run_in_background</span>: z.<span class="hljs-title function_">boolean</span>().<span class="hljs-title function_">optional</span>(),
    <span class="hljs-attr">description</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"5-10 word description of what this does"</span>),
  }),

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">{ command, timeout = <span class="hljs-number">120000</span>, run_in_background }, ctx</span>) {
    <span class="hljs-comment">// 1. 安全检查</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">containsDangerousPatterns</span>(command)) {
      <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">ask</span>({
        <span class="hljs-attr">permission</span>: <span class="hljs-string">"bash.dangerous"</span>,
        command,
        <span class="hljs-attr">warning</span>: <span class="hljs-string">"This command may be destructive"</span>,
      });
    }

    <span class="hljs-comment">// 2. 创建 shell 进程</span>
    <span class="hljs-keyword">const</span> shell = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createShell</span>({
      command,
      timeout,
      <span class="hljs-attr">cwd</span>: <span class="hljs-title function_">getWorkingDirectory</span>(),
      <span class="hljs-attr">abort</span>: ctx.<span class="hljs-property">abort</span>,
    });

    <span class="hljs-comment">// 3. 后台运行处理</span>
    <span class="hljs-keyword">if</span> (run_in_background) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">title</span>: <span class="hljs-string">`Background: <span class="hljs-subst">${description}</span>`</span>,
        <span class="hljs-attr">output</span>: <span class="hljs-string">`Started in background. Task ID: <span class="hljs-subst">${shell.id}</span>`</span>,
        <span class="hljs-attr">metadata</span>: { <span class="hljs-attr">taskId</span>: shell.<span class="hljs-property">id</span>, <span class="hljs-attr">background</span>: <span class="hljs-literal">true</span> },
      };
    }

    <span class="hljs-comment">// 4. 等待执行完成</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> shell.<span class="hljs-title function_">wait</span>();

    <span class="hljs-comment">// 5. 截断过长输出</span>
    <span class="hljs-keyword">const</span> output = <span class="hljs-title function_">truncate</span>(result.<span class="hljs-property">output</span>, <span class="hljs-number">30000</span>);

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">title</span>: description || <span class="hljs-string">`Run: <span class="hljs-subst">${command.slice(<span class="hljs-number">0</span>, <span class="hljs-number">50</span>)}</span>`</span>,
      <span class="hljs-attr">output</span>: <span class="hljs-string">`Exit code: <span class="hljs-subst">${result.exitCode}</span>\n\n<span class="hljs-subst">${output}</span>`</span>,
      <span class="hljs-attr">metadata</span>: { <span class="hljs-attr">exitCode</span>: result.<span class="hljs-property">exitCode</span>, <span class="hljs-attr">duration</span>: result.<span class="hljs-property">duration</span> },
    };
  },
}));
</code></pre>
<h3 data-id="heading-23">4.4 工具注册表</h3>
<p>所有工具通过 <code>ToolRegistry</code> 统一管理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">ToolRegistry</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">tools</span>(<span class="hljs-params">providerID: <span class="hljs-built_in">string</span>, agent?: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Tool</span>[] {
    <span class="hljs-keyword">const</span> builtinTools = [
      <span class="hljs-title class_">InvalidTool</span>,      <span class="hljs-comment">// 处理无效工具调用</span>
      <span class="hljs-title class_">BashTool</span>,         <span class="hljs-comment">// Shell 执行</span>
      <span class="hljs-title class_">ReadTool</span>,         <span class="hljs-comment">// 文件读取</span>
      <span class="hljs-title class_">GlobTool</span>,         <span class="hljs-comment">// 文件匹配</span>
      <span class="hljs-title class_">GrepTool</span>,         <span class="hljs-comment">// 代码搜索</span>
      <span class="hljs-title class_">EditTool</span>,         <span class="hljs-comment">// 文件编辑</span>
      <span class="hljs-title class_">WriteTool</span>,        <span class="hljs-comment">// 文件写入</span>
      <span class="hljs-title class_">TaskTool</span>,         <span class="hljs-comment">// 子任务</span>
      <span class="hljs-title class_">WebFetchTool</span>,     <span class="hljs-comment">// 网页获取</span>
      <span class="hljs-title class_">TodoReadTool</span>,     <span class="hljs-comment">// 任务列表读取</span>
      <span class="hljs-title class_">TodoWriteTool</span>,    <span class="hljs-comment">// 任务列表写入</span>
      <span class="hljs-title class_">WebSearchTool</span>,    <span class="hljs-comment">// 网页搜索</span>
      <span class="hljs-title class_">SkillTool</span>,        <span class="hljs-comment">// 技能调用</span>
    ];

    <span class="hljs-comment">// 可选工具</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Config</span>.<span class="hljs-title function_">get</span>().<span class="hljs-property">experimental</span>?.<span class="hljs-property">lsp</span>) {
      builtinTools.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">LSPTool</span>);  <span class="hljs-comment">// Language Server Protocol</span>
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Config</span>.<span class="hljs-title function_">get</span>().<span class="hljs-property">experimental</span>?.<span class="hljs-property">batch</span>) {
      builtinTools.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">BatchTool</span>);  <span class="hljs-comment">// 批量操作</span>
    }

    <span class="hljs-comment">// 自定义工具</span>
    <span class="hljs-keyword">const</span> customTools = <span class="hljs-title function_">loadCustomTools</span>(<span class="hljs-string">"~/.opencode/tool/"</span>);

    <span class="hljs-comment">// MCP 工具</span>
    <span class="hljs-keyword">const</span> mcpTools = <span class="hljs-variable constant_">MCP</span>.<span class="hljs-title function_">tools</span>();

    <span class="hljs-keyword">return</span> [...builtinTools, ...customTools, ...mcpTools];
  }
}
</code></pre>
<h3 data-id="heading-24">4.5 MCP：工具的无限扩展</h3>
<p><strong>Model Context Protocol (MCP)</strong> 是一个开放协议，允许外部服务为 AI 提供工具和资源。OpenCode 完整支持 MCP：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph "OpenCode"
        Agent[Agent]
        MCPClient[MCP Client]
    end

    subgraph "MCP Servers"
        GitHub[GitHub MCP]
        Database[Database MCP]
        Notion[Notion MCP]
        Custom[Custom MCP]
    end

    Agent --&gt; MCPClient
    MCPClient --&gt; GitHub
    MCPClient --&gt; Database
    MCPClient --&gt; Notion
    MCPClient --&gt; Custom

    GitHub -.-&gt;|tools: pr, issue, ...| MCPClient
    Database -.-&gt;|tools: query, insert, ...| MCPClient
    Notion -.-&gt;|resources: pages, databases| MCPClient
    Custom -.-&gt;|custom tools| MCPClient
</code></pre>
<p>配置 MCP 服务器：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// .opencode/config.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcp"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"servers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"github"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"-y"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"@modelcontextprotocol/server-github"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"GITHUB_TOKEN"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"..."</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"postgres"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"-y"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"@modelcontextprotocol/server-postgres"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"DATABASE_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"..."</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这样，AI 就能直接操作 GitHub PR、查询数据库，甚至更新 Notion 文档——而这些能力完全通过配置添加，无需修改代码。</p>
<hr/>
<h2 data-id="heading-25">第五章：Provider 抽象层 - 万物皆可 LLM</h2>
<h3 data-id="heading-26">5.1 多 Provider 的挑战</h3>
<p>现在市面上有太多 LLM 提供商了：</p>
<ul>
<li>Anthropic (Claude)</li>
<li>OpenAI (GPT-4, o1)</li>
<li>Google (Gemini, Vertex AI)</li>
<li>Azure OpenAI</li>
<li>AWS Bedrock</li>
<li>Groq, Mistral, Cohere...</li>
</ul>
<p>每个提供商的 API 都略有不同：不同的认证方式、不同的请求格式、不同的 streaming 实现、不同的错误处理...</p>
<p>OpenCode 的 Provider 抽象层解决了这个问题。</p>
<h3 data-id="heading-27">5.2 统一的 Provider 接口</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Provider</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-comment">// 认证</span>
  <span class="hljs-title function_">getApiKey</span>(): <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>;

  <span class="hljs-comment">// 模型列表</span>
  <span class="hljs-title function_">models</span>(): <span class="hljs-title class_">Model</span>[];

  <span class="hljs-comment">// 获取语言模型实例</span>
  <span class="hljs-title function_">languageModel</span>(<span class="hljs-attr">modelID</span>: <span class="hljs-built_in">string</span>, options?: <span class="hljs-title class_">ModelOptions</span>): <span class="hljs-title class_">LanguageModel</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Model</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">provider</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-comment">// 能力</span>
  <span class="hljs-attr">context</span>: <span class="hljs-built_in">number</span>;          <span class="hljs-comment">// 上下文窗口大小</span>
  maxOutput?: <span class="hljs-built_in">number</span>;       <span class="hljs-comment">// 最大输出长度</span>
  supportsImages?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 支持图像输入</span>
  supportsToolUse?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 支持工具调用</span>
  supportsReasoning?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 支持推理（如 o1）</span>

  <span class="hljs-comment">// 成本</span>
  pricing?: {
    <span class="hljs-attr">input</span>: <span class="hljs-built_in">number</span>;   <span class="hljs-comment">// $ per 1M tokens</span>
    <span class="hljs-attr">output</span>: <span class="hljs-built_in">number</span>;
    cache?: { <span class="hljs-attr">read</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">write</span>: <span class="hljs-built_in">number</span> };
  };

  <span class="hljs-comment">// 配置</span>
  options?: <span class="hljs-title class_">ModelOptions</span>;
}
</code></pre>
<h3 data-id="heading-28">5.3 Provider 注册表</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "Provider Registry"
        Anthropic[Anthropic Provider]
        OpenAI[OpenAI Provider]
        Google[Google Provider]
        Azure[Azure Provider]
        Groq[Groq Provider]
        More[... 15+ more]
    end

    subgraph "AI SDK"
        SDK[Vercel AI SDK]
    end

    subgraph "Application"
        Session[Session]
        LLM[LLM Module]
    end

    Session --&gt; LLM
    LLM --&gt; SDK
    SDK --&gt; Anthropic
    SDK --&gt; OpenAI
    SDK --&gt; Google
    SDK --&gt; Azure
    SDK --&gt; Groq
    SDK --&gt; More
</code></pre>
<p>OpenCode 使用 <strong>Vercel AI SDK</strong> 作为底层，它提供了统一的 streaming 接口：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { streamText } <span class="hljs-keyword">from</span> <span class="hljs-string">"ai"</span>;
<span class="hljs-keyword">import</span> { anthropic } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/anthropic"</span>;
<span class="hljs-keyword">import</span> { openai } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/openai"</span>;
<span class="hljs-keyword">import</span> { google } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/google"</span>;

<span class="hljs-comment">// 无论使用哪个 provider，调用方式都一样</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">streamText</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-title function_">anthropic</span>(<span class="hljs-string">"claude-3-5-sonnet"</span>),  <span class="hljs-comment">// 或 openai("gpt-4"), google("gemini-pro")</span>
  <span class="hljs-attr">messages</span>: [...],
  <span class="hljs-attr">tools</span>: {...},
});

<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> result.<span class="hljs-property">fullStream</span>) {
  <span class="hljs-comment">// 统一的流式处理</span>
}
</code></pre>
<h3 data-id="heading-29">5.4 智能模型选择</h3>
<p>OpenCode 会根据任务自动选择合适的模型：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 主任务：使用配置的主模型</span>
<span class="hljs-keyword">const</span> mainModel = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Provider</span>.<span class="hljs-title function_">getModel</span>(config.<span class="hljs-property">model</span>);

<span class="hljs-comment">// 小任务（标题、摘要）：使用小模型节省成本</span>
<span class="hljs-keyword">const</span> smallModel = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Provider</span>.<span class="hljs-title function_">getSmallModel</span>(mainModel);

<span class="hljs-comment">// 不同任务使用不同模型</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateTitle</span>(<span class="hljs-params">sessionID: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">LLM</span>.<span class="hljs-title function_">stream</span>({
    <span class="hljs-attr">model</span>: smallModel,  <span class="hljs-comment">// 使用便宜的小模型</span>
    <span class="hljs-attr">small</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">agent</span>: <span class="hljs-string">"title"</span>,
    <span class="hljs-comment">// ...</span>
  });
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">executeMainTask</span>(<span class="hljs-params">sessionID: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">LLM</span>.<span class="hljs-title function_">stream</span>({
    <span class="hljs-attr">model</span>: mainModel,   <span class="hljs-comment">// 使用强大的主模型</span>
    <span class="hljs-attr">agent</span>: <span class="hljs-string">"build"</span>,
    <span class="hljs-comment">// ...</span>
  });
}
</code></pre>
<h3 data-id="heading-30">5.5 Provider 特定优化</h3>
<p>不同的 Provider 有不同的最佳实践，OpenCode 对此进行了优化：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Anthropic 特定的 System Prompt</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PROMPT_ANTHROPIC</span> = <span class="hljs-string">`
You are Claude, made by Anthropic.
You have access to a set of tools...
`</span>;

<span class="hljs-comment">// OpenAI 特定的 System Prompt</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PROMPT_OPENAI</span> = <span class="hljs-string">`
You are a helpful assistant with access to tools...
`</span>;

<span class="hljs-comment">// 根据 Provider 选择合适的 prompt</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getSystemPrompt</span>(<span class="hljs-params">providerID: <span class="hljs-built_in">string</span>, model: Model</span>) {
  <span class="hljs-keyword">if</span> (providerID === <span class="hljs-string">"anthropic"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">PROMPT_ANTHROPIC</span>;
  }
  <span class="hljs-keyword">if</span> (providerID === <span class="hljs-string">"openai"</span> &amp;&amp; model.<span class="hljs-property">supportsReasoning</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">PROMPT_OPENAI_REASONING</span>;  <span class="hljs-comment">// o1 模型的特殊处理</span>
  }
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>Prompt Caching 优化</strong></p>
<p>Anthropic 支持 Prompt Caching，可以缓存 System Prompt 以减少 token 消耗：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// System prompt 分成两部分</span>
<span class="hljs-keyword">const</span> system = [
  header,   <span class="hljs-comment">// [0] 不变的头部 - 可缓存</span>
  body,     <span class="hljs-comment">// [1] 动态的正文</span>
];

<span class="hljs-comment">// 如果头部不变，API 会使用缓存</span>
<span class="hljs-comment">// 显著减少 input token 成本</span>
</code></pre>
<hr/>
<h2 data-id="heading-31">第六章：上下文压缩 - 记忆的艺术</h2>
<h3 data-id="heading-32">6.1 长对话的困境</h3>
<p>LLM 有一个根本限制：<strong>上下文窗口是有限的</strong>。</p>
<p>即使是 Claude 的 200K token 窗口，在复杂的编程任务中也会很快被填满：</p>
<pre><code class="hljs language-scss" lang="scss">用户问题              → <span class="hljs-number">500</span> tokens
代码文件 <span class="hljs-number">1</span> (<span class="hljs-number">500</span> 行)   → <span class="hljs-number">8</span>,<span class="hljs-number">000</span> tokens
代码文件 <span class="hljs-number">2</span> (<span class="hljs-number">300</span> 行)   → <span class="hljs-number">5</span>,<span class="hljs-number">000</span> tokens
AI 思考 + 回复        → <span class="hljs-number">3</span>,<span class="hljs-number">000</span> tokens
工具调用结果 <span class="hljs-number">1</span>        → <span class="hljs-number">2</span>,<span class="hljs-number">000</span> tokens
工具调用结果 <span class="hljs-number">2</span>        → <span class="hljs-number">10</span>,<span class="hljs-number">000</span> tokens
...
第 <span class="hljs-number">10</span> 轮对话后        → <span class="hljs-number">150</span>,<span class="hljs-number">000</span> tokens 😱
</code></pre>
<p>当上下文接近限制时，会发生两件坏事：</p>
<ol>
<li><strong>性能下降</strong>：处理时间变长，质量下降</li>
<li><strong>失败风险</strong>：超过限制会直接报错</li>
</ol>
<h3 data-id="heading-33">6.2 OpenCode 的压缩策略</h3>
<p>OpenCode 采用了<strong>多层压缩策略</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "Level 1: 裁剪"
        Prune[工具输出裁剪&lt;br/&gt;移除旧的大输出]
    end

    subgraph "Level 2: 摘要"
        Compact[上下文压缩&lt;br/&gt;生成对话摘要]
    end

    subgraph "Level 3: 过滤"
        Filter[消息过滤&lt;br/&gt;跳过已压缩部分]
    end

    Overflow{Token 溢出?} --&gt; |Yes| Prune
    Prune --&gt; |仍然溢出| Compact
    Compact --&gt; Filter
    Filter --&gt; Continue[继续对话]

    Overflow --&gt; |No| Continue
</code></pre>
<h4 data-id="heading-34">层级 1：工具输出裁剪 (Prune)</h4>
<p>旧的工具输出往往占用大量空间但已不再需要：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">prune</span>(<span class="hljs-params">sessionID: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> messages = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Session</span>.<span class="hljs-title function_">messages</span>(sessionID);
  <span class="hljs-keyword">let</span> protectedTokens = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PROTECT_THRESHOLD</span> = <span class="hljs-number">40_000</span>;  <span class="hljs-comment">// 保护最近 40K tokens</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PRUNE_THRESHOLD</span> = <span class="hljs-number">20_000</span>;    <span class="hljs-comment">// 只裁剪超过 20K 的输出</span>

  <span class="hljs-comment">// 从后往前扫描</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = messages.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
    <span class="hljs-keyword">const</span> msg = messages[i];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> part <span class="hljs-keyword">of</span> msg.<span class="hljs-property">parts</span>) {
      <span class="hljs-keyword">if</span> (part.<span class="hljs-property">type</span> === <span class="hljs-string">"tool"</span> &amp;&amp; part.<span class="hljs-property">state</span>.<span class="hljs-property">status</span> === <span class="hljs-string">"completed"</span>) {
        <span class="hljs-keyword">const</span> outputSize = <span class="hljs-title function_">estimateTokens</span>(part.<span class="hljs-property">state</span>.<span class="hljs-property">output</span>);

        <span class="hljs-comment">// 保护最近的工具调用</span>
        <span class="hljs-keyword">if</span> (protectedTokens &lt; <span class="hljs-variable constant_">PROTECT_THRESHOLD</span>) {
          protectedTokens += outputSize;
          <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 裁剪大输出</span>
        <span class="hljs-keyword">if</span> (outputSize &gt; <span class="hljs-variable constant_">PRUNE_THRESHOLD</span>) {
          part.<span class="hljs-property">state</span>.<span class="hljs-property">output</span> = <span class="hljs-string">"[TOOL OUTPUT PRUNED]"</span>;
          part.<span class="hljs-property">state</span>.<span class="hljs-property">time</span>.<span class="hljs-property">compacted</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
        }
      }
    }
  }
}
</code></pre>
<p><strong>为什么不全部裁剪？</strong></p>
<p>AI 在思考时需要参考最近的工具输出。如果把所有输出都裁掉，它会失去上下文，开始重复相同的工具调用（"让我再读一下这个文件..."）。</p>
<p>40K tokens 的保护区是一个平衡点：足够 AI 工作，又不会占用太多空间。</p>
<h4 data-id="heading-35">层级 2：上下文压缩 (Compaction)</h4>
<p>当裁剪不够时，需要更激进的压缩——<strong>生成摘要</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">compact</span>(<span class="hljs-params">sessionID: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 1. 创建压缩 Agent 消息</span>
  <span class="hljs-keyword">const</span> compactionMessage = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Session</span>.<span class="hljs-title function_">createAssistant</span>({
    sessionID,
    <span class="hljs-attr">agent</span>: <span class="hljs-string">"compaction"</span>,
    <span class="hljs-attr">mode</span>: <span class="hljs-string">"compact"</span>,
  });

  <span class="hljs-comment">// 2. 构建压缩提示</span>
  <span class="hljs-keyword">const</span> compactionPrompt = <span class="hljs-string">`
You are a conversation summarizer. Your task is to create a comprehensive
summary of the conversation so far that preserves all important context
needed to continue the task.

Include:
- What the user originally asked
- What actions have been taken
- Current state of the task
- Any important findings or decisions

The summary will replace the conversation history, so it must be complete.
`</span>;

  <span class="hljs-comment">// 3. 调用 LLM 生成摘要</span>
  <span class="hljs-keyword">const</span> summary = <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">LLM</span>.<span class="hljs-title function_">stream</span>({
    <span class="hljs-attr">agent</span>: <span class="hljs-string">"compaction"</span>,
    <span class="hljs-attr">messages</span>: <span class="hljs-title function_">getAllMessages</span>(sessionID),
    <span class="hljs-attr">system</span>: compactionPrompt,
  });

  <span class="hljs-comment">// 4. 标记压缩点</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Session</span>.<span class="hljs-title function_">updatePart</span>(compactionMessage.<span class="hljs-property">id</span>, {
    <span class="hljs-attr">type</span>: <span class="hljs-string">"compaction"</span>,
  });

  <span class="hljs-comment">// 5. 创建合成用户消息继续对话</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Session</span>.<span class="hljs-title function_">createSyntheticUser</span>({
    sessionID,
    <span class="hljs-attr">content</span>: <span class="hljs-string">"Please continue with the task based on the summary above."</span>,
  });
}
</code></pre>
<p>压缩后的对话历史：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">[压缩前 - <span class="hljs-number">150</span>K tokens]
<span class="hljs-symbol">User:</span> 帮我重构用户模块
<span class="hljs-symbol">AI:</span> 让我先看看代码... [工具调用 x <span class="hljs-number">20</span>]
<span class="hljs-symbol">User:</span> 那个函数有 bug
<span class="hljs-symbol">AI:</span> 我来修复... [工具调用 x <span class="hljs-number">15</span>]
<span class="hljs-symbol">User:</span> 还需要加测试
<span class="hljs-symbol">AI:</span> 好的... [工具调用 x <span class="hljs-number">10</span>]

[压缩后 - <span class="hljs-number">5</span>K tokens]
AI (compaction):
## 任务摘要
用户请求重构用户模块。已完成：
<span class="hljs-number">1</span>. 分析了 src/user/ 下的所有文件
<span class="hljs-number">2</span>. 重构了 UserService，将其拆分为三个小类
<span class="hljs-number">3</span>. 修复了 getUserById 的空指针 bug
<span class="hljs-number">4</span>. 添加了单元测试，覆盖率达 <span class="hljs-number">85%</span>

当前状态：基本完成，用户可能还有后续需求。

User (synthetic): Please <span class="hljs-keyword">continue</span> <span class="hljs-keyword">with</span> the task based <span class="hljs-keyword">on</span> the summary above.
</code></pre>
<h4 data-id="heading-36">层级 3：消息过滤</h4>
<p>在构建 LLM 输入时，会自动跳过已压缩部分：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">filterCompacted</span>(<span class="hljs-params">messages: Message[]</span>): <span class="hljs-title class_">Message</span>[] {
  <span class="hljs-comment">// 找到最后一个压缩标记</span>
  <span class="hljs-keyword">const</span> lastCompactionIndex = messages.<span class="hljs-title function_">findLastIndex</span>(
    <span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> msg.<span class="hljs-property">parts</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">type</span> === <span class="hljs-string">"compaction"</span>)
  );

  <span class="hljs-keyword">if</span> (lastCompactionIndex === -<span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> messages;  <span class="hljs-comment">// 没有压缩，返回全部</span>
  }

  <span class="hljs-comment">// 只返回压缩标记之后的消息</span>
  <span class="hljs-keyword">return</span> messages.<span class="hljs-title function_">slice</span>(lastCompactionIndex);
}
</code></pre>
<h3 data-id="heading-37">6.3 溢出检测</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isOverflow</span>(<span class="hljs-params">model: Model, messages: Message[]</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">const</span> contextLimit = model.<span class="hljs-property">context</span>;
  <span class="hljs-keyword">const</span> outputReserve = model.<span class="hljs-property">maxOutput</span> || <span class="hljs-number">8192</span>;
  <span class="hljs-keyword">const</span> currentTokens = <span class="hljs-title function_">estimateTokens</span>(messages);

  <span class="hljs-comment">// 留出足够的输出空间</span>
  <span class="hljs-keyword">return</span> currentTokens &gt; contextLimit - outputReserve;
}
</code></pre>
<p>这个检查在每次 LLM 调用前执行。一旦检测到溢出风险，会立即触发压缩流程。</p>
<hr/>
<h2 data-id="heading-38">第七章：安全与权限 - 信任但要验证</h2>
<h3 data-id="heading-39">7.1 为什么需要权限系统？</h3>
<p>AI Agent 拥有强大的能力，但"能力越大，责任越大"。想象一下这些场景：</p>
<ul>
<li>AI 执行 <code>rm -rf /</code> 会怎样？</li>
<li>AI 读取 <code>~/.ssh/id_rsa</code> 会怎样？</li>
<li>AI 向外部服务发送你的代码会怎样？</li>
</ul>
<p>没有权限系统，这些都可能发生。OpenCode 实现了<strong>细粒度的权限控制</strong>。</p>
<h3 data-id="heading-40">7.2 权限模型</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "Permission Sources"
        Agent[Agent 权限&lt;br/&gt;agent.permission]
        Session[Session 权限&lt;br/&gt;session.permission]
        Config[全局配置&lt;br/&gt;config.permission]
    end

    subgraph "Permission Check"
        Merge[权限合并]
        Check[权限检查]
        Ask[用户询问]
    end

    subgraph "Decision"
        Allow[允许执行]
        Deny[拒绝执行]
        Remember[记住选择]
    end

    Agent --&gt; Merge
    Session --&gt; Merge
    Config --&gt; Merge
    Merge --&gt; Check
    Check --&gt; |明确允许| Allow
    Check --&gt; |明确拒绝| Deny
    Check --&gt; |需要确认| Ask
    Ask --&gt; |用户允许| Allow
    Ask --&gt; |用户拒绝| Deny
    Ask --&gt; |记住选择| Remember
    Remember --&gt; Allow
    Remember --&gt; Deny
</code></pre>
<h3 data-id="heading-41">7.3 权限规则定义</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PermissionRule</span> {
  <span class="hljs-comment">// 匹配条件</span>
  tool?: <span class="hljs-built_in">string</span>;           <span class="hljs-comment">// 工具名匹配</span>
  path?: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">RegExp</span>;  <span class="hljs-comment">// 路径匹配</span>
  command?: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">RegExp</span>; <span class="hljs-comment">// 命令匹配</span>

  <span class="hljs-comment">// 决策</span>
  allow?: <span class="hljs-built_in">boolean</span>;         <span class="hljs-comment">// 允许</span>
  deny?: <span class="hljs-built_in">boolean</span>;          <span class="hljs-comment">// 拒绝</span>
  ask?: <span class="hljs-built_in">boolean</span>;           <span class="hljs-comment">// 询问用户</span>

  <span class="hljs-comment">// 记忆</span>
  always?: <span class="hljs-built_in">boolean</span>;        <span class="hljs-comment">// 记住这个选择</span>
}

<span class="hljs-comment">// 示例配置</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">permissionRules</span>: <span class="hljs-title class_">PermissionRule</span>[] = [
  <span class="hljs-comment">// 允许读取项目内文件</span>
  { <span class="hljs-attr">tool</span>: <span class="hljs-string">"read"</span>, <span class="hljs-attr">path</span>: <span class="hljs-regexp">/^\/project\//</span>, <span class="hljs-attr">allow</span>: <span class="hljs-literal">true</span> },

  <span class="hljs-comment">// 拒绝读取私钥</span>
  { <span class="hljs-attr">tool</span>: <span class="hljs-string">"read"</span>, <span class="hljs-attr">path</span>: <span class="hljs-regexp">/\.ssh|\.env|password/</span>, <span class="hljs-attr">deny</span>: <span class="hljs-literal">true</span> },

  <span class="hljs-comment">// 危险命令需要确认</span>
  { <span class="hljs-attr">tool</span>: <span class="hljs-string">"bash"</span>, <span class="hljs-attr">command</span>: <span class="hljs-regexp">/rm|sudo|chmod|curl/</span>, <span class="hljs-attr">ask</span>: <span class="hljs-literal">true</span> },

  <span class="hljs-comment">// 外部路径需要确认</span>
  { <span class="hljs-attr">tool</span>: <span class="hljs-string">"write"</span>, <span class="hljs-attr">path</span>: <span class="hljs-regexp">/^(?!\/project\/)/</span>, <span class="hljs-attr">ask</span>: <span class="hljs-literal">true</span> },
];
</code></pre>
<h3 data-id="heading-42">7.4 权限检查流程</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkPermission</span>(<span class="hljs-params">
  tool: <span class="hljs-built_in">string</span>,
  args: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt;,
  ctx: ToolContext
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-comment">// 1. 获取合并后的权限规则</span>
  <span class="hljs-keyword">const</span> rules = <span class="hljs-title class_">PermissionNext</span>.<span class="hljs-title function_">merge</span>(
    ctx.<span class="hljs-property">agent</span>.<span class="hljs-property">permission</span>,
    ctx.<span class="hljs-property">session</span>.<span class="hljs-property">permission</span>,
    <span class="hljs-title class_">Config</span>.<span class="hljs-title function_">get</span>().<span class="hljs-property">permission</span>
  );

  <span class="hljs-comment">// 2. 找到匹配的规则</span>
  <span class="hljs-keyword">const</span> matchedRule = rules.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">rule</span> =&gt;</span> <span class="hljs-title function_">matches</span>(rule, tool, args));

  <span class="hljs-comment">// 3. 如果明确允许，直接通过</span>
  <span class="hljs-keyword">if</span> (matchedRule?.<span class="hljs-property">allow</span>) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 4. 如果明确拒绝，抛出异常</span>
  <span class="hljs-keyword">if</span> (matchedRule?.<span class="hljs-property">deny</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionNext</span>.<span class="hljs-title class_">RejectedError</span>(tool, args);
  }

  <span class="hljs-comment">// 5. 如果需要询问，请求用户确认</span>
  <span class="hljs-keyword">if</span> (!matchedRule || matchedRule.<span class="hljs-property">ask</span>) {
    <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">ask</span>({
      <span class="hljs-attr">permission</span>: <span class="hljs-string">`tool.<span class="hljs-subst">${tool}</span>`</span>,
      <span class="hljs-attr">metadata</span>: args,
      <span class="hljs-attr">patterns</span>: <span class="hljs-title function_">extractPatterns</span>(args),
      <span class="hljs-attr">always</span>: matchedRule?.<span class="hljs-property">always</span> ?? <span class="hljs-literal">false</span>,
    });
  }
}
</code></pre>
<h3 data-id="heading-43">7.5 用户交互界面</h3>
<p>当需要用户确认时，CLI 会显示：</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────────────────────────────────────────────────────┐
│  🔐 Permission Required                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Tool: bash                                                     │
│  Command: <span class="hljs-built_in">rm</span> -rf ./dist                                         │
│                                                                 │
│  This <span class="hljs-built_in">command</span> will delete the ./dist directory.                 │
│                                                                 │
│  [Y] Allow once                                                 │
│  [A] Always allow this pattern                                  │
│  [N] Deny                                                       │
│  [D] Always deny this pattern                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p>选择 "Always allow" 会将规则保存到 Session 权限中，后续相同模式的请求自动通过。</p>
<h3 data-id="heading-44">7.6 死循环保护 (Doom Loop Detection)</h3>
<p>权限系统还包含一个特殊保护：<strong>死循环检测</strong>。</p>
<p>当 AI 陷入无效循环时（重复调用相同工具），系统会自动介入：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">detectDoomLoop</span>(<span class="hljs-params">toolParts: ToolPart[]</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">if</span> (toolParts.<span class="hljs-property">length</span> &lt; <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  <span class="hljs-comment">// 获取最近 3 次工具调用</span>
  <span class="hljs-keyword">const</span> last3 = toolParts.<span class="hljs-title function_">slice</span>(-<span class="hljs-number">3</span>);

  <span class="hljs-comment">// 检查是否完全相同</span>
  <span class="hljs-keyword">const</span> allSame = last3.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">part</span> =&gt;</span>
    part.<span class="hljs-property">state</span>.<span class="hljs-property">name</span> === last3[<span class="hljs-number">0</span>].<span class="hljs-property">state</span>.<span class="hljs-property">name</span> &amp;&amp;
    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(part.<span class="hljs-property">state</span>.<span class="hljs-property">input</span>) === <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(last3[<span class="hljs-number">0</span>].<span class="hljs-property">state</span>.<span class="hljs-property">input</span>)
  );

  <span class="hljs-keyword">return</span> allSame;
}

<span class="hljs-comment">// 在工具调用时检查</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">onToolCall</span>(<span class="hljs-params">tool: <span class="hljs-built_in">string</span>, input: <span class="hljs-built_in">object</span>, ctx: ToolContext</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">detectDoomLoop</span>(<span class="hljs-title function_">getRecentToolParts</span>(ctx.<span class="hljs-property">messageID</span>))) {
    <span class="hljs-comment">// 询问用户是否继续</span>
    <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">ask</span>({
      <span class="hljs-attr">permission</span>: <span class="hljs-string">"doom_loop"</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">`AI is calling the same tool (<span class="hljs-subst">${tool}</span>) repeatedly with identical arguments. This might indicate a stuck loop.`</span>,
      <span class="hljs-attr">options</span>: [<span class="hljs-string">"Continue anyway"</span>, <span class="hljs-string">"Stop and intervene"</span>],
    });
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-45">第八章：亮点技术深度解析</h2>
<h3 data-id="heading-46">8.1 流式思考提取 (Reasoning Extraction)</h3>
<p>OpenCode 最酷的功能之一是<strong>实时显示 AI 的思考过程</strong>。这是如何实现的？</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant LLM
    participant Middleware
    participant Processor
    participant UI

    LLM-&gt;&gt;Middleware: &lt;think&gt;让我分析一下...
    Middleware-&gt;&gt;Processor: reasoning-start
    Processor-&gt;&gt;UI: 显示"思考中..."

    LLM-&gt;&gt;Middleware: 这个函数有问题...&lt;/think&gt;
    Middleware-&gt;&gt;Processor: reasoning-delta
    Processor-&gt;&gt;UI: 实时更新思考内容

    LLM-&gt;&gt;Middleware: 我需要调用 read 工具
    Middleware-&gt;&gt;Processor: reasoning-end, text-start
    Processor-&gt;&gt;UI: 显示完整思考，开始显示回复
</code></pre>
<p><strong>实现原理：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { wrapLanguageModel, extractReasoningMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">"ai"</span>;

<span class="hljs-comment">// 包装模型以提取思考过程</span>
<span class="hljs-keyword">const</span> wrappedModel = <span class="hljs-title function_">wrapLanguageModel</span>(baseModel,
  <span class="hljs-title function_">extractReasoningMiddleware</span>({
    <span class="hljs-attr">tagName</span>: <span class="hljs-string">"think"</span>  <span class="hljs-comment">// 提取 &lt;think&gt;...&lt;/think&gt; 中的内容</span>
  })
);

<span class="hljs-comment">// 流式事件处理</span>
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> event <span class="hljs-keyword">of</span> stream.<span class="hljs-property">fullStream</span>) {
  <span class="hljs-keyword">switch</span> (event.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"reasoning-start"</span>:
      <span class="hljs-comment">// 创建思考 Part</span>
      <span class="hljs-title function_">createReasoningPart</span>(messageID);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"reasoning-delta"</span>:
      <span class="hljs-comment">// 追加思考内容</span>
      <span class="hljs-title function_">appendToReasoningPart</span>(messageID, event.<span class="hljs-property">text</span>);
      <span class="hljs-comment">// UI 实时更新</span>
      <span class="hljs-title function_">publishPartUpdate</span>(messageID, partID);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"reasoning-end"</span>:
      <span class="hljs-comment">// 完成思考</span>
      <span class="hljs-title function_">finalizeReasoningPart</span>(messageID);
      <span class="hljs-keyword">break</span>;
  }
}
</code></pre>
<p><strong>用户看到的效果：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript">┌─────────────────────────────────────────────────────────────────┐
│ 🤔 <span class="hljs-title class_">Thinking</span>...                                                  │
├─────────────────────────────────────────────────────────────────┤
│ 让我分析一下这个函数。                                           │
│                                                                 │
│ 问题出在第 <span class="hljs-number">42</span> 行：<span class="hljs-title function_">fetchData</span>() 返回的是 <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;，        │
│ 但代码直接赋值给 <span class="hljs-built_in">string</span> 类型的变量，没有 <span class="hljs-keyword">await</span>。                 │
│                                                                 │
│ 我需要：                                                        │
│ <span class="hljs-number">1.</span> 读取完整文件确认上下文                                        │
│ <span class="hljs-number">2.</span> 添加 <span class="hljs-keyword">await</span> 关键字                                            │
│ <span class="hljs-number">3.</span> 确保函数是 <span class="hljs-keyword">async</span> 的                                          │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p>这不仅提供了更好的用户体验，还增加了<strong>透明度</strong>——用户可以看到 AI 是如何思考的，从而更好地理解和验证其决策。</p>
<h3 data-id="heading-47">8.2 文件系统快照与回滚</h3>
<p>OpenCode 的另一个亮点是<strong>任何修改都可以回滚</strong>。这是通过 Git 快照实现的：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 步骤开始时创建快照</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">onStepStart</span>(<span class="hljs-params">ctx: StepContext</span>) {
  <span class="hljs-comment">// 记录当前 Git 状态</span>
  <span class="hljs-keyword">const</span> snapshot = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Snapshot</span>.<span class="hljs-title function_">track</span>({
    <span class="hljs-attr">directory</span>: ctx.<span class="hljs-property">directory</span>,
    <span class="hljs-attr">includeUntracked</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 包括未跟踪文件</span>
  });

  <span class="hljs-comment">// 保存快照引用</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Session</span>.<span class="hljs-title function_">updatePart</span>(ctx.<span class="hljs-property">messageID</span>, {
    <span class="hljs-attr">type</span>: <span class="hljs-string">"step-start"</span>,
    <span class="hljs-attr">snapshot</span>: snapshot.<span class="hljs-property">ref</span>,
  });
}

<span class="hljs-comment">// 步骤结束时计算变更</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">onStepFinish</span>(<span class="hljs-params">ctx: StepContext</span>) {
  <span class="hljs-keyword">const</span> startSnapshot = <span class="hljs-title function_">getStepStartSnapshot</span>(ctx.<span class="hljs-property">messageID</span>);
  <span class="hljs-keyword">const</span> currentSnapshot = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Snapshot</span>.<span class="hljs-title function_">track</span>({ <span class="hljs-attr">directory</span>: ctx.<span class="hljs-property">directory</span> });

  <span class="hljs-comment">// 计算 diff</span>
  <span class="hljs-keyword">const</span> patch = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Snapshot</span>.<span class="hljs-title function_">diff</span>(startSnapshot, currentSnapshot);

  <span class="hljs-comment">// 保存 patch</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Session</span>.<span class="hljs-title function_">updatePart</span>(ctx.<span class="hljs-property">messageID</span>, {
    <span class="hljs-attr">type</span>: <span class="hljs-string">"patch"</span>,
    <span class="hljs-attr">diff</span>: patch,
    <span class="hljs-attr">additions</span>: <span class="hljs-title function_">countAdditions</span>(patch),
    <span class="hljs-attr">deletions</span>: <span class="hljs-title function_">countDeletions</span>(patch),
  });
}

<span class="hljs-comment">// 回滚到任意快照</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">revert</span>(<span class="hljs-params">sessionID: <span class="hljs-built_in">string</span>, messageID: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> snapshot = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Session</span>.<span class="hljs-title function_">getSnapshot</span>(messageID);

  <span class="hljs-comment">// 恢复文件状态</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Snapshot</span>.<span class="hljs-title function_">restore</span>(snapshot.<span class="hljs-property">ref</span>);

  <span class="hljs-comment">// 创建回滚消息</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Session</span>.<span class="hljs-title function_">updatePart</span>(messageID, {
    <span class="hljs-attr">type</span>: <span class="hljs-string">"revert"</span>,
    <span class="hljs-attr">snapshot</span>: snapshot.<span class="hljs-property">ref</span>,
  });
}
</code></pre>
<p><strong>回滚界面：</strong></p>
<pre><code class="hljs language-less" lang="less">┌─────────────────────────────────────────────────────────────────┐
│ 📜 <span class="hljs-selector-tag">Session</span> <span class="hljs-selector-tag">History</span>                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ <span class="hljs-selector-attr">[1]</span> <span class="hljs-number">10</span>:<span class="hljs-number">30</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Read</span> <span class="hljs-selector-tag">src</span>/<span class="hljs-selector-tag">app</span><span class="hljs-selector-class">.ts</span>                                    │
│ <span class="hljs-selector-attr">[2]</span> <span class="hljs-number">10</span>:<span class="hljs-number">31</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Edit</span> <span class="hljs-selector-tag">src</span>/<span class="hljs-selector-tag">app</span><span class="hljs-selector-class">.ts</span> (+<span class="hljs-number">5</span>, -<span class="hljs-number">3</span>)          <span class="hljs-selector-attr">[🔄 Revert]</span>      │
│ <span class="hljs-selector-attr">[3]</span> <span class="hljs-number">10</span>:<span class="hljs-number">32</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Run</span> <span class="hljs-selector-tag">tests</span>                                          │
│ <span class="hljs-selector-attr">[4]</span> <span class="hljs-number">10</span>:<span class="hljs-number">33</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Edit</span> <span class="hljs-selector-tag">src</span>/<span class="hljs-selector-tag">utils</span><span class="hljs-selector-class">.ts</span> (+<span class="hljs-number">20</span>, -<span class="hljs-number">0</span>)       <span class="hljs-selector-attr">[🔄 Revert]</span>      │
│ <span class="hljs-selector-attr">[5]</span> <span class="hljs-number">10</span>:<span class="hljs-number">35</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Create</span> <span class="hljs-selector-tag">src</span>/<span class="hljs-selector-tag">new-file</span><span class="hljs-selector-class">.ts</span> (+<span class="hljs-number">50</span>, -<span class="hljs-number">0</span>)  <span class="hljs-selector-attr">[🔄 Revert]</span>      │
│                                                                 │
│ <span class="hljs-selector-tag">Select</span> <span class="hljs-selector-tag">step</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">revert</span>, <span class="hljs-selector-tag">or</span> <span class="hljs-selector-tag">press</span> <span class="hljs-selector-tag">Q</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">cancel</span>                     │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-48">8.3 智能摘要生成</h3>
<p>每次对话结束后，OpenCode 会自动生成摘要：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">summarize</span>(<span class="hljs-params">sessionID: <span class="hljs-built_in">string</span>, messageID: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 1. 生成标题</span>
  <span class="hljs-keyword">const</span> title = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateTitle</span>(sessionID, messageID);

  <span class="hljs-comment">// 2. 生成正文摘要</span>
  <span class="hljs-keyword">const</span> body = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateBody</span>(sessionID, messageID);

  <span class="hljs-comment">// 3. 计算文件变更统计</span>
  <span class="hljs-keyword">const</span> diffs = <span class="hljs-keyword">await</span> <span class="hljs-title function_">computeDiffs</span>(sessionID);

  <span class="hljs-comment">// 4. 保存摘要</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Session</span>.<span class="hljs-title function_">updateMessage</span>(messageID, {
    <span class="hljs-attr">summary</span>: { title, body, diffs },
  });
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateTitle</span>(<span class="hljs-params">sessionID: <span class="hljs-built_in">string</span>, messageID: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 使用小模型生成标题</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">LLM</span>.<span class="hljs-title function_">stream</span>({
    <span class="hljs-attr">model</span>: smallModel,
    <span class="hljs-attr">agent</span>: <span class="hljs-string">"title"</span>,
    <span class="hljs-attr">messages</span>: <span class="hljs-title function_">getFirstUserMessage</span>(sessionID),
    <span class="hljs-attr">system</span>: <span class="hljs-string">"Generate a concise title (max 100 chars) for this conversation."</span>,
  });

  <span class="hljs-keyword">return</span> result.<span class="hljs-property">text</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>);
}
</code></pre>
<p>摘要用于：</p>
<ul>
<li>会话列表显示</li>
<li>历史搜索</li>
<li>上下文压缩后的参考</li>
</ul>
<h3 data-id="heading-49">8.4 Prompt Caching 优化</h3>
<p>Anthropic 的 API 支持 Prompt Caching，OpenCode 充分利用了这一特性：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// System prompt 分成两部分</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">buildSystemPrompt</span>(<span class="hljs-params">agent: Agent, custom: <span class="hljs-built_in">string</span>[]</span>) {
  <span class="hljs-keyword">return</span> [
    <span class="hljs-comment">// [0] 静态头部 - 可被缓存</span>
    <span class="hljs-variable constant_">PROVIDER_HEADER</span>,

    <span class="hljs-comment">// [1] 动态正文 - 每次可能不同</span>
    [
      agent.<span class="hljs-property">prompt</span>,
      ...custom,
      <span class="hljs-title function_">environmentInfo</span>(),
    ].<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
  ];
}

<span class="hljs-comment">// 如果头部不变，Anthropic 会使用缓存</span>
<span class="hljs-comment">// 可以节省 50-90% 的 input token</span>
</code></pre>
<p><strong>成本对比：</strong></p>
<pre><code class="hljs language-ini" lang="ini">Without Caching:
- Input: 50,000 tokens × $3/<span class="hljs-attr">M</span> = <span class="hljs-variable">$0</span>.<span class="hljs-number">15</span>
- Output: 2,000 tokens × $15/<span class="hljs-attr">M</span> = <span class="hljs-variable">$0</span>.<span class="hljs-number">03</span>
- Total: $0.18

With Caching (80% cache hit):
- Input (cached): 40,000 tokens × $0.30/<span class="hljs-attr">M</span> = <span class="hljs-variable">$0</span>.<span class="hljs-number">012</span>
- Input (new): 10,000 tokens × $3/<span class="hljs-attr">M</span> = <span class="hljs-variable">$0</span>.<span class="hljs-number">03</span>
- Output: 2,000 tokens × $15/<span class="hljs-attr">M</span> = <span class="hljs-variable">$0</span>.<span class="hljs-number">03</span>
- Total: $0.072

Savings: 60%!
</code></pre>
<h3 data-id="heading-50">8.5 并行工具执行</h3>
<p>当 AI 需要调用多个独立工具时，OpenCode 支持<strong>并行执行</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// AI 返回多个工具调用</span>
<span class="hljs-keyword">const</span> toolCalls = [
  { <span class="hljs-attr">name</span>: <span class="hljs-string">"read"</span>, <span class="hljs-attr">args</span>: { <span class="hljs-attr">file_path</span>: <span class="hljs-string">"src/a.ts"</span> } },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">"read"</span>, <span class="hljs-attr">args</span>: { <span class="hljs-attr">file_path</span>: <span class="hljs-string">"src/b.ts"</span> } },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">"grep"</span>, <span class="hljs-attr">args</span>: { <span class="hljs-attr">pattern</span>: <span class="hljs-string">"TODO"</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">"src/"</span> } },
];

<span class="hljs-comment">// 并行执行所有工具</span>
<span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
  toolCalls.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">async</span> (call) =&gt; {
    <span class="hljs-keyword">const</span> tool = <span class="hljs-title class_">ToolRegistry</span>.<span class="hljs-title function_">get</span>(call.<span class="hljs-property">name</span>);
    <span class="hljs-keyword">return</span> tool.<span class="hljs-title function_">execute</span>(call.<span class="hljs-property">args</span>, ctx);
  })
);

<span class="hljs-comment">// 所有结果一起返回给 LLM</span>
</code></pre>
<p>这显著提高了效率，特别是在需要读取多个文件或执行多个搜索时。</p>
<hr/>
<h2 data-id="heading-51">第九章：从源码学习设计模式</h2>
<p>OpenCode 的代码库是学习现代 TypeScript 设计模式的绝佳教材。让我们看看它使用了哪些模式。</p>
<h3 data-id="heading-52">9.1 Namespace 模式</h3>
<p>OpenCode 大量使用 TypeScript 的 <code>namespace</code> 来组织代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// session/index.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Session</span> {
  <span class="hljs-comment">// 类型定义</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Info</span> = z.<span class="hljs-title function_">object</span>({...});
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Info</span> = z.<span class="hljs-property">infer</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Info</span>&gt;;

  <span class="hljs-comment">// 事件定义</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Event</span> = {
    <span class="hljs-title class_">Created</span>: <span class="hljs-title class_">BusEvent</span>.<span class="hljs-title function_">define</span>(<span class="hljs-string">"session.created"</span>, <span class="hljs-title class_">Info</span>),
    <span class="hljs-title class_">Updated</span>: <span class="hljs-title class_">BusEvent</span>.<span class="hljs-title function_">define</span>(<span class="hljs-string">"session.updated"</span>, <span class="hljs-title class_">Info</span>),
    <span class="hljs-title class_">Deleted</span>: <span class="hljs-title class_">BusEvent</span>.<span class="hljs-title function_">define</span>(<span class="hljs-string">"session.deleted"</span>, z.<span class="hljs-title function_">string</span>()),
  };

  <span class="hljs-comment">// 方法</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">input: CreateInput</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Info</span>&gt; {...}
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Info</span> | <span class="hljs-literal">null</span>&gt; {...}
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, editor: Editor</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Info</span>&gt; {...}
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {...}
}
</code></pre>
<p><strong>为什么用 Namespace？</strong></p>
<ol>
<li><strong>命名空间隔离</strong>：避免全局污染</li>
<li><strong>组织代码</strong>：相关功能放在一起</li>
<li><strong>类型和值共存</strong>：<code>Session.Info</code> 既是类型也是 Schema</li>
<li><strong>自文档化</strong>：<code>Session.create()</code> 比 <code>createSession()</code> 更清晰</li>
</ol>
<h3 data-id="heading-53">9.2 Discriminated Union 模式</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用字面量类型作为判别器</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Part</span> =
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"text"</span>; <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>; }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"tool"</span>; <span class="hljs-attr">state</span>: <span class="hljs-title class_">ToolState</span>; }
  | { <span class="hljs-attr">type</span>: <span class="hljs-string">"reasoning"</span>; <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>; };

<span class="hljs-comment">// 类型收窄</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderPart</span>(<span class="hljs-params">part: Part</span>) {
  <span class="hljs-keyword">switch</span> (part.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"text"</span>:
      <span class="hljs-comment">// TypeScript 知道这里 part 是 { type: "text"; content: string }</span>
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Text</span>&gt;</span>{part.content}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span></span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"tool"</span>:
      <span class="hljs-comment">// TypeScript 知道这里 part 是 { type: "tool"; state: ToolState }</span>
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ToolCall</span> <span class="hljs-attr">state</span>=<span class="hljs-string">{part.state}</span> /&gt;</span></span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"reasoning"</span>:
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Thinking</span>&gt;</span>{part.content}<span class="hljs-tag">&lt;/<span class="hljs-name">Thinking</span>&gt;</span></span>;
  }
}
</code></pre>
<p>这种模式在 OpenCode 中无处不在，它让复杂的类型变得可管理。</p>
<h3 data-id="heading-54">9.3 Builder 模式</h3>
<p>System Prompt 的构建使用了 Builder 模式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SystemPromptBuilder</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">parts</span>: <span class="hljs-built_in">string</span>[] = [];

  <span class="hljs-title function_">addHeader</span>(<span class="hljs-params">providerID: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parts</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">SystemPrompt</span>.<span class="hljs-title function_">header</span>(providerID));
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">addAgentPrompt</span>(<span class="hljs-params">agent: Agent</span>) {
    <span class="hljs-keyword">if</span> (agent.<span class="hljs-property">prompt</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">parts</span>.<span class="hljs-title function_">push</span>(agent.<span class="hljs-property">prompt</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">addCustomInstructions</span>(<span class="hljs-params">paths: <span class="hljs-built_in">string</span>[]</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> path <span class="hljs-keyword">of</span> paths) {
      <span class="hljs-keyword">const</span> content = <span class="hljs-title function_">readFileSync</span>(path, <span class="hljs-string">"utf-8"</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">parts</span>.<span class="hljs-title function_">push</span>(content);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">addEnvironment</span>(<span class="hljs-params">info: EnvInfo</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parts</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">formatEnvironment</span>(info));
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">build</span>(): <span class="hljs-built_in">string</span>[] {
    <span class="hljs-comment">// 返回可缓存的两部分结构</span>
    <span class="hljs-keyword">return</span> [
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">parts</span>[<span class="hljs-number">0</span>],  <span class="hljs-comment">// header</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">parts</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),  <span class="hljs-comment">// body</span>
    ];
  }
}
</code></pre>
<h3 data-id="heading-55">9.4 Factory 模式</h3>
<p>工具创建使用了 Factory 模式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Tool</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> define&lt;T <span class="hljs-keyword">extends</span> z.<span class="hljs-property">ZodObject</span>&lt;<span class="hljs-built_in">any</span>&gt;&gt;(
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">init</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">ToolDefinition</span>&lt;T&gt;
  ): <span class="hljs-title class_">Tool</span> {
    <span class="hljs-comment">// 延迟初始化</span>
    <span class="hljs-keyword">let</span> <span class="hljs-attr">definition</span>: <span class="hljs-title class_">ToolDefinition</span>&lt;T&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">return</span> {
      id,
      <span class="hljs-keyword">get</span> <span class="hljs-title function_">schema</span>() {
        definition ??= <span class="hljs-title function_">init</span>();
        <span class="hljs-keyword">return</span> definition.<span class="hljs-property">parameters</span>;
      },
      <span class="hljs-keyword">get</span> <span class="hljs-title function_">description</span>() {
        definition ??= <span class="hljs-title function_">init</span>();
        <span class="hljs-keyword">return</span> definition.<span class="hljs-property">description</span>;
      },
      <span class="hljs-keyword">async</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">args: z.infer&lt;T&gt;, ctx: ToolContext</span>) {
        definition ??= <span class="hljs-title function_">init</span>();
        <span class="hljs-keyword">return</span> definition.<span class="hljs-title function_">execute</span>(args, ctx);
      },
    };
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ReadTool</span> = <span class="hljs-title class_">Tool</span>.<span class="hljs-title function_">define</span>(<span class="hljs-string">"read"</span>, <span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">description</span>: <span class="hljs-string">"Reads a file"</span>,
  <span class="hljs-attr">parameters</span>: z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">file_path</span>: z.<span class="hljs-title function_">string</span>() }),
  <span class="hljs-attr">execute</span>: <span class="hljs-keyword">async</span> (args, ctx) =&gt; {...},
}));
</code></pre>
<p>延迟初始化（<code>init()</code> 只在首次使用时调用）可以加快启动速度。</p>
<h3 data-id="heading-56">9.5 Observer 模式 (Event Bus)</h3>
<p>OpenCode 使用事件总线实现松耦合通信：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义事件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">SessionCreated</span> = <span class="hljs-title class_">BusEvent</span>.<span class="hljs-title function_">define</span>(<span class="hljs-string">"session.created"</span>, <span class="hljs-title class_">Session</span>.<span class="hljs-property">Info</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MessageUpdated</span> = <span class="hljs-title class_">BusEvent</span>.<span class="hljs-title function_">define</span>(<span class="hljs-string">"message.updated"</span>, <span class="hljs-title class_">MessageV2</span>.<span class="hljs-property">Info</span>);

<span class="hljs-comment">// 发布事件</span>
<span class="hljs-title class_">Bus</span>.<span class="hljs-title function_">publish</span>(<span class="hljs-title class_">SessionCreated</span>, sessionInfo);

<span class="hljs-comment">// 订阅事件</span>
<span class="hljs-title class_">Bus</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-title class_">SessionCreated</span>, <span class="hljs-function">(<span class="hljs-params">session</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`New session: <span class="hljs-subst">${session.title}</span>`</span>);
});

<span class="hljs-comment">// 在 UI 中使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">SessionList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [sessions, setSessions] = useState&lt;<span class="hljs-title class_">Session</span>.<span class="hljs-property">Info</span>[]&gt;([]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 订阅会话变更</span>
    <span class="hljs-keyword">const</span> unsubscribe = <span class="hljs-title class_">Bus</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-title class_">SessionCreated</span>, <span class="hljs-function">(<span class="hljs-params">session</span>) =&gt;</span> {
      <span class="hljs-title function_">setSessions</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, session]);
    });

    <span class="hljs-keyword">return</span> unsubscribe;
  }, []);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">List</span> <span class="hljs-attr">items</span>=<span class="hljs-string">{sessions}</span> /&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-57">9.6 Strategy 模式</h3>
<p>Provider 实现使用了 Strategy 模式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProviderStrategy</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">getApiKey</span>(): <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>;
  <span class="hljs-title function_">models</span>(): <span class="hljs-title class_">Model</span>[];
  <span class="hljs-title function_">languageModel</span>(<span class="hljs-attr">modelID</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">LanguageModel</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AnthropicProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProviderStrategy</span> {
  id = <span class="hljs-string">"anthropic"</span>;

  <span class="hljs-title function_">getApiKey</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> process.<span class="hljs-property">env</span>.<span class="hljs-property">ANTHROPIC_API_KEY</span>;
  }

  <span class="hljs-title function_">models</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> [
      { <span class="hljs-attr">id</span>: <span class="hljs-string">"claude-3-5-sonnet"</span>, <span class="hljs-attr">context</span>: <span class="hljs-number">200000</span>, ... },
      { <span class="hljs-attr">id</span>: <span class="hljs-string">"claude-3-opus"</span>, <span class="hljs-attr">context</span>: <span class="hljs-number">200000</span>, ... },
    ];
  }

  <span class="hljs-title function_">languageModel</span>(<span class="hljs-params">modelID: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">anthropic</span>(modelID);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OpenAIProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProviderStrategy</span> {
  id = <span class="hljs-string">"openai"</span>;
  <span class="hljs-comment">// ... 不同的实现</span>
}

<span class="hljs-comment">// 统一使用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getProvider</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">ProviderStrategy</span> {
  <span class="hljs-keyword">const</span> providers = {
    <span class="hljs-attr">anthropic</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnthropicProvider</span>(),
    <span class="hljs-attr">openai</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAIProvider</span>(),
    <span class="hljs-comment">// ...</span>
  };
  <span class="hljs-keyword">return</span> providers[id];
}
</code></pre>
<hr/>
<h2 data-id="heading-58">第十章：性能优化与工程实践</h2>
<h3 data-id="heading-59">10.1 启动性能优化</h3>
<p>CLI 工具的启动速度至关重要。OpenCode 采用了多种优化：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 延迟导入</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runCommand</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 只在需要时才导入重型模块</span>
  <span class="hljs-keyword">const</span> { <span class="hljs-title class_">Session</span> } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"./session"</span>);
  <span class="hljs-keyword">const</span> { <span class="hljs-title class_">Server</span> } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"./server"</span>);
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 2. 延迟初始化</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">_config</span>: <span class="hljs-title class_">Config</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getConfig</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 首次调用时才加载配置</span>
  _config ??= <span class="hljs-title function_">loadConfig</span>();
  <span class="hljs-keyword">return</span> _config;
}

<span class="hljs-comment">// 3. 并行初始化</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 并行执行独立的初始化任务</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
    <span class="hljs-title function_">loadConfig</span>(),
    <span class="hljs-title function_">initializeStorage</span>(),
    <span class="hljs-title function_">discoverMCPServers</span>(),
  ]);
}
</code></pre>
<h3 data-id="heading-60">10.2 内存管理</h3>
<p>长时间运行的 Agent 需要注意内存管理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 流式处理，避免大字符串</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title function_">streamFile</span>(<span class="hljs-params">path: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> stream = <span class="hljs-title function_">createReadStream</span>(path);
  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
    <span class="hljs-keyword">yield</span> chunk.<span class="hljs-title function_">toString</span>();
  }
}

<span class="hljs-comment">// 2. 及时清理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">cleanup</span>(<span class="hljs-params">sessionID: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 清理缓存</span>
  messageCache.<span class="hljs-title function_">delete</span>(sessionID);
  partCache.<span class="hljs-title function_">delete</span>(sessionID);

  <span class="hljs-comment">// 触发 GC（在 Bun 中）</span>
  <span class="hljs-title class_">Bun</span>.<span class="hljs-title function_">gc</span>(<span class="hljs-literal">true</span>);
}

<span class="hljs-comment">// 3. 弱引用缓存</span>
<span class="hljs-keyword">const</span> cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>&lt;<span class="hljs-built_in">object</span>, <span class="hljs-title class_">ComputedValue</span>&gt;();
</code></pre>
<h3 data-id="heading-61">10.3 并发控制</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用信号量限制并发</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Semaphore</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">permits</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">queue</span>: (<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>)[] = [];

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">permits: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">permits</span> = permits;
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">acquire</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">permits</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">permits</span>--;
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">push</span>(resolve));
  }

  <span class="hljs-title function_">release</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> next = <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">shift</span>();
    <span class="hljs-keyword">if</span> (next) {
      <span class="hljs-title function_">next</span>();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">permits</span>++;
    }
  }
}

<span class="hljs-comment">// 限制同时执行的工具数量</span>
<span class="hljs-keyword">const</span> toolSemaphore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">5</span>);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">executeTool</span>(<span class="hljs-params">tool: Tool, args: <span class="hljs-built_in">object</span>, ctx: ToolContext</span>) {
  <span class="hljs-keyword">await</span> toolSemaphore.<span class="hljs-title function_">acquire</span>();
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> tool.<span class="hljs-title function_">execute</span>(args, ctx);
  } <span class="hljs-keyword">finally</span> {
    toolSemaphore.<span class="hljs-title function_">release</span>();
  }
}
</code></pre>
<h3 data-id="heading-62">10.4 错误处理最佳实践</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 类型化错误</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolExecutionError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Error</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">public</span> tool: <span class="hljs-built_in">string</span>,
    <span class="hljs-keyword">public</span> args: <span class="hljs-built_in">object</span>,
    <span class="hljs-keyword">public</span> cause: <span class="hljs-built_in">Error</span>
  </span>) {
    <span class="hljs-variable language_">super</span>(<span class="hljs-string">`Tool <span class="hljs-subst">${tool}</span> failed: <span class="hljs-subst">${cause.message}</span>`</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">"ToolExecutionError"</span>;
  }
}

<span class="hljs-comment">// 2. 错误边界</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> safeExecute&lt;T&gt;(
  <span class="hljs-attr">fn</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;T&gt;,
  <span class="hljs-attr">fallback</span>: T
): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Execution failed:"</span>, error);
    <span class="hljs-keyword">return</span> fallback;
  }
}

<span class="hljs-comment">// 3. 重试逻辑</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> withRetry&lt;T&gt;(
  <span class="hljs-attr">fn</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;T&gt;,
  <span class="hljs-attr">options</span>: { <span class="hljs-attr">maxAttempts</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">delay</span>: <span class="hljs-built_in">number</span> }
): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">lastError</span>: <span class="hljs-title class_">Error</span> | <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> attempt = <span class="hljs-number">1</span>; attempt &lt;= options.<span class="hljs-property">maxAttempts</span>; attempt++) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      lastError = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>;

      <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isRetryable</span>(error) || attempt === options.<span class="hljs-property">maxAttempts</span>) {
        <span class="hljs-keyword">throw</span> error;
      }

      <span class="hljs-comment">// 指数退避</span>
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(options.<span class="hljs-property">delay</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, attempt - <span class="hljs-number">1</span>));
    }
  }

  <span class="hljs-keyword">throw</span> lastError;
}
</code></pre>
<h3 data-id="heading-63">10.5 测试策略</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 单元测试</span>
<span class="hljs-title function_">describe</span>(<span class="hljs-string">"Session"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should create session with correct defaults"</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Session</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">projectID</span>: <span class="hljs-string">"test-project"</span>,
      <span class="hljs-attr">directory</span>: <span class="hljs-string">"/test"</span>,
    });

    <span class="hljs-title function_">expect</span>(session.<span class="hljs-property">id</span>).<span class="hljs-title function_">toBeDefined</span>();
    <span class="hljs-title function_">expect</span>(session.<span class="hljs-property">title</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">""</span>);
    <span class="hljs-title function_">expect</span>(session.<span class="hljs-property">time</span>.<span class="hljs-property">created</span>).<span class="hljs-title function_">toBeLessThanOrEqual</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());
  });
});

<span class="hljs-comment">// 2. 集成测试</span>
<span class="hljs-title function_">describe</span>(<span class="hljs-string">"Tool Execution"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should read file correctly"</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">ReadTool</span>.<span class="hljs-title function_">execute</span>(
      { <span class="hljs-attr">file_path</span>: <span class="hljs-string">"/test/file.txt"</span> },
      mockContext
    );

    <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">output</span>).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">"file content"</span>);
  });
});

<span class="hljs-comment">// 3. E2E 测试</span>
<span class="hljs-title function_">describe</span>(<span class="hljs-string">"Full Workflow"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">"should complete code editing task"</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Session</span>.<span class="hljs-title function_">create</span>({...});

    <span class="hljs-keyword">await</span> <span class="hljs-title class_">SessionPrompt</span>.<span class="hljs-title function_">prompt</span>({
      <span class="hljs-attr">sessionID</span>: session.<span class="hljs-property">id</span>,
      <span class="hljs-attr">parts</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">"text"</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">"Fix the bug in app.ts"</span> }],
    });

    <span class="hljs-keyword">const</span> messages = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Session</span>.<span class="hljs-title function_">messages</span>(session.<span class="hljs-property">id</span>);
    <span class="hljs-keyword">const</span> lastAssistant = messages.<span class="hljs-title function_">findLast</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">role</span> === <span class="hljs-string">"assistant"</span>);

    <span class="hljs-title function_">expect</span>(lastAssistant.<span class="hljs-property">finish</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">"stop"</span>);
    <span class="hljs-title function_">expect</span>(lastAssistant.<span class="hljs-property">parts</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">type</span> === <span class="hljs-string">"tool"</span> &amp;&amp; p.<span class="hljs-property">state</span>.<span class="hljs-property">name</span> === <span class="hljs-string">"edit"</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);
  });
});
</code></pre>
<hr/>
<h2 data-id="heading-64">结语：AI 编程的未来</h2>
<h3 data-id="heading-65">回顾：我们学到了什么？</h3>
<p>通过深入 OpenCode 的源码，我们看到了一个现代 AI Agent 框架的完整实现：</p>
<ol>
<li><strong>会话管理</strong>：三层结构（Session → Message → Part）支持复杂的状态追踪</li>
<li><strong>Agent 系统</strong>：专业化的角色定义，支持子任务和并行执行</li>
<li><strong>工具系统</strong>：声明式定义，上下文感知，权限控制</li>
<li><strong>Provider 抽象</strong>：统一接口，支持 18+ LLM 提供商</li>
<li><strong>上下文压缩</strong>：多层策略（裁剪、摘要、过滤）解决长对话问题</li>
<li><strong>安全机制</strong>：细粒度权限控制，死循环保护</li>
</ol>
<h3 data-id="heading-66">展望：AI 编程的下一步</h3>
<p>OpenCode 代表了 AI 编程助手的<strong>当前水平</strong>，但这只是开始。未来可能的发展方向：</p>
<p><strong>1. 更强的代码理解</strong></p>
<ul>
<li>集成更多 LSP 功能</li>
<li>支持类型推导和重构</li>
<li>理解项目架构和设计模式</li>
</ul>
<p><strong>2. 更智能的任务规划</strong></p>
<ul>
<li>自动分解复杂任务</li>
<li>预测可能的问题和解决方案</li>
<li>学习用户的编码习惯</li>
</ul>
<p><strong>3. 更好的协作体验</strong></p>
<ul>
<li>多 Agent 协作</li>
<li>人机混合编程</li>
<li>实时代码审查</li>
</ul>
<p><strong>4. 更广泛的集成</strong></p>
<ul>
<li>与 CI/CD 系统集成</li>
<li>支持更多编程语言和框架</li>
<li>连接更多外部服务（数据库、API、文档）</li>
</ul>
<h3 data-id="heading-67">最后的话</h3>
<p>OpenCode 不仅仅是一个工具，它是对"AI 能为编程做什么"这个问题的一次认真回答。</p>
<p>它的代码库展示了如何将复杂的 AI 能力包装成优雅的开发体验。每一个设计决策——从流式思考提取到上下文压缩，从权限系统到回滚功能——都是为了让 AI 成为真正有用的编程伙伴。</p>
<p>如果你是一名开发者，我强烈建议你：</p>
<ol>
<li><strong>使用它</strong>：亲身体验 AI 编程的感觉</li>
<li><strong>阅读它</strong>：源码是最好的教材</li>
<li><strong>贡献它</strong>：开源项目需要社区的力量</li>
</ol>
<p>AI 不会取代程序员，但会使用 AI 的程序员会取代不会的。</p>
<p><strong>现在，是时候拥抱 AI 编程的未来了。</strong></p>
<hr/>
<h2 data-id="heading-68">附录：快速参考</h2>
<h3 data-id="heading-69">A. 核心文件位置</h3>









































<table><thead><tr><th>功能</th><th>文件路径</th></tr></thead><tbody><tr><td>CLI 入口</td><td><code>packages/opencode/src/index.ts</code></td></tr><tr><td>Session 管理</td><td><code>packages/opencode/src/session/index.ts</code></td></tr><tr><td>主循环</td><td><code>packages/opencode/src/session/prompt.ts</code></td></tr><tr><td>流处理</td><td><code>packages/opencode/src/session/processor.ts</code></td></tr><tr><td>LLM 调用</td><td><code>packages/opencode/src/session/llm.ts</code></td></tr><tr><td>工具注册</td><td><code>packages/opencode/src/tool/registry.ts</code></td></tr><tr><td>Provider</td><td><code>packages/opencode/src/provider/provider.ts</code></td></tr><tr><td>权限系统</td><td><code>packages/opencode/src/permission/</code></td></tr></tbody></table>
<h3 data-id="heading-70">B. 关键类型定义</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Session</span>
<span class="hljs-title class_">Session</span>.<span class="hljs-property">Info</span>
<span class="hljs-title class_">Session</span>.<span class="hljs-property">Event</span>.<span class="hljs-property">Created</span>
<span class="hljs-title class_">Session</span>.<span class="hljs-property">Event</span>.<span class="hljs-property">Updated</span>

<span class="hljs-comment">// Message</span>
<span class="hljs-title class_">MessageV2</span>.<span class="hljs-property">User</span>
<span class="hljs-title class_">MessageV2</span>.<span class="hljs-property">Assistant</span>
<span class="hljs-title class_">MessageV2</span>.<span class="hljs-property">Part</span>

<span class="hljs-comment">// Tool</span>
<span class="hljs-title class_">Tool</span>.<span class="hljs-property">Context</span>
<span class="hljs-title class_">Tool</span>.<span class="hljs-property">Result</span>
<span class="hljs-title class_">ToolState</span>

<span class="hljs-comment">// Agent</span>
<span class="hljs-title class_">Agent</span>.<span class="hljs-property">Info</span>
<span class="hljs-title class_">Agent</span>.<span class="hljs-property">Mode</span>

<span class="hljs-comment">// Provider</span>
<span class="hljs-title class_">Provider</span>.<span class="hljs-property">Model</span>
<span class="hljs-title class_">Provider</span>.<span class="hljs-property">Options</span>
</code></pre>
<h3 data-id="heading-71">C. 配置文件</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 全局配置</span>
~/.opencode/config.json

<span class="hljs-comment"># 项目配置</span>
.opencode/config.json

<span class="hljs-comment"># 自定义指令</span>
AGENTS.md
CLAUDE.md
CONTEXT.md

<span class="hljs-comment"># 自定义工具</span>
~/.opencode/tool/*.ts
</code></pre>
<h3 data-id="heading-72">D. 环境变量</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># API Keys</span>
ANTHROPIC_API_KEY=sk-ant-...
OPENAI_API_KEY=sk-...
GOOGLE_API_KEY=...

<span class="hljs-comment"># 配置</span>
OPENCODE_MODEL=claude-4-5-sonnet
OPENCODE_PROVIDER=anthropic
OPENCODE_DEBUG=<span class="hljs-literal">true</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么"缓存"能提高系统性能？——从 CPU 缓存到分布式缓存]]></title>    <link>https://juejin.cn/post/7592170706026823715</link>    <guid>https://juejin.cn/post/7592170706026823715</guid>    <pubDate>2026-01-07T08:46:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592170706026823715" data-draft-id="7592170171634761743" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么&quot;缓存&quot;能提高系统性能？——从 CPU 缓存到分布式缓存"/> <meta itemprop="keywords" content="后端,面试"/> <meta itemprop="datePublished" content="2026-01-07T08:46:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么"缓存"能提高系统性能？——从 CPU 缓存到分布式缓存
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:46:41.000Z" title="Wed Jan 07 2026 08:46:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">💨 为什么"缓存"能提高系统性能？——从 CPU 缓存到分布式缓存 ⚡</h2>
<blockquote>
<p>大家好，我是无限大，欢迎收看十万个为什么系列文章</p>
<p>希望今天的内容能对大家有所帮助</p>
</blockquote>
<p>想象一下：你去图书馆借一本书，每次都要从书架上找，看完再放回去——这样是不是很麻烦？</p>
<p>如果把你最近常看的几本书放在书桌旁边，是不是方便多了？</p>
<p>这就是<strong>缓存</strong>的原理！它就像你书桌旁边的"常用书区"，把频繁使用的数据存放在离CPU更近的地方，提高访问速度。</p>
<h3 data-id="heading-1">🤔 核心问题：缓存的工作原理是什么？不同层级的缓存有何作用？</h3>
<p>很多人觉得"缓存"是个复杂的技术概念，其实它的本质很简单：<strong>用空间换时间</strong>——把数据存放在更快的存储介质中，减少访问慢介质的次数。</p>
<h4 data-id="heading-2">缓存的"三大法宝"</h4>
<ul>
<li>⚡ <strong>速度</strong>：缓存的访问速度比原始存储快得多</li>
<li>📊 <strong>命中率</strong>：缓存中找到数据的概率（越高越好）</li>
<li>🔄 <strong>替换策略</strong>：当缓存满了，如何决定淘汰哪些数据</li>
</ul>
<h4 data-id="heading-3">为什么缓存能提高性能？</h4>
<ul>
<li>🐌 <strong>存储速度差异</strong>：不同存储介质的速度差异巨大（CPU缓存是硬盘的1000倍以上）</li>
<li>🔁 <strong>局部性原理</strong>：程序和数据的访问具有局部性（时间局部性、空间局部性）</li>
<li>💪 <strong>减少CPU等待</strong>：CPU不用长时间等待慢存储的响应</li>
<li>💰 <strong>降低成本</strong>：高速存储（如CPU缓存）成本高，低速存储（如硬盘）成本低，缓存可以平衡成本和性能</li>
</ul>
<h3 data-id="heading-4">📜 从"CPU"到"分布式"：缓存的进化史</h3>
<h4 data-id="heading-5">1. ⚡ CPU缓存："离CPU最近的缓存"</h4>
<p>1980年代，随着CPU速度的飞速提升，<strong>CPU缓存</strong>应运而生，它是离CPU最近的缓存。</p>
<p><strong>发展历程</strong>：</p>
<ul>
<li><strong>一级缓存（L1 Cache）</strong>：1985年，英特尔80386 CPU首次引入L1缓存</li>
<li><strong>二级缓存（L2 Cache）</strong>：1995年，奔腾Pro CPU首次将L2缓存集成在CPU芯片中</li>
<li><strong>三级缓存（L3 Cache）</strong>：2003年，至强处理器首次引入L3缓存</li>
</ul>
<p><strong>CPU缓存的特点</strong>：</p>
<ul>
<li>速度极快（L1缓存访问延迟&lt;1ns，L3缓存&lt;10ns）</li>
<li>容量小（L1缓存几十KB，L3缓存几MB到几十MB）</li>
<li>多级结构（L1→L2→L3）</li>
<li>硬件管理，软件不可见</li>
</ul>
<h4 data-id="heading-6">2. 📝 内存缓存："程序的高速缓冲区"</h4>
<p>1990年代，随着操作系统的发展，<strong>内存缓存</strong>开始普及，它是程序运行时的高速缓冲区。</p>
<p><strong>发展历程</strong>：</p>
<ul>
<li><strong>虚拟内存</strong>：1960年代提出，1980年代普及</li>
<li><strong>文件系统缓存</strong>：操作系统将常用文件数据缓存到内存</li>
<li><strong>应用程序缓存</strong>：程序内部使用内存缓存提高性能</li>
</ul>
<p><strong>内存缓存的特点</strong>：</p>
<ul>
<li>速度快（访问延迟约100ns）</li>
<li>容量中等（几GB到几十GB）</li>
<li>软件可管理</li>
<li>易失性（断电数据丢失）</li>
</ul>
<h4 data-id="heading-7">3. 💾 磁盘缓存："硬盘的加速神器"</h4>
<p>2000年代，随着机械硬盘的广泛使用，<strong>磁盘缓存</strong>成为提高硬盘性能的关键。</p>
<p><strong>发展历程</strong>：</p>
<ul>
<li><strong>硬盘内部缓存</strong>：硬盘控制器上的高速缓存</li>
<li><strong>RAID缓存</strong>：RAID控制器上的高速缓存</li>
<li><strong>固态混合硬盘（SSHD）</strong>：结合了机械硬盘和闪存缓存</li>
</ul>
<p><strong>磁盘缓存的特点</strong>：</p>
<ul>
<li>速度较慢（访问延迟约5ms）</li>
<li>容量较大（几十MB到几GB）</li>
<li>非易失性（部分RAID缓存有电池备份）</li>
<li>硬件和软件共同管理</li>
</ul>
<h4 data-id="heading-8">4. 🌐 分布式缓存："互联网时代的缓存"</h4>
<p>2010年代，随着互联网的兴起，<strong>分布式缓存</strong>成为大规模系统的必备组件。</p>
<p><strong>发展历程</strong>：</p>
<ul>
<li><strong>Memcached</strong>：2003年诞生，最早的分布式缓存</li>
<li><strong>Redis</strong>：2009年诞生，功能更丰富的分布式缓存</li>
<li><strong>Tair</strong>：阿里巴巴开源的分布式缓存</li>
<li><strong>ElastiCache</strong>：AWS提供的托管缓存服务</li>
</ul>
<p><strong>分布式缓存的特点</strong>：</p>
<ul>
<li>速度快（访问延迟约1ms）</li>
<li>容量大（几十GB到几百GB）</li>
<li>分布式架构，支持水平扩展</li>
<li>支持持久化（部分缓存支持）</li>
<li>软件管理，高度可控</li>
</ul>
<h3 data-id="heading-9">🔧 技术原理：缓存的"秘密武器"</h3>
<h4 data-id="heading-10">1. 📊 局部性原理："缓存的理论基础"</h4>
<p>局部性原理是缓存存在的<strong>理论基础</strong>，它包括两种类型：</p>
<p><strong>时间局部性</strong>：</p>
<ul>
<li>最近访问过的数据，未来很可能再次被访问</li>
<li>比如：循环变量、常用函数、热点数据</li>
<li>例子：你今天看的书，明天可能还会看</li>
</ul>
<p><strong>空间局部性</strong>：</p>
<ul>
<li>访问某个位置的数据，其附近的数据未来很可能被访问</li>
<li>比如：数组遍历、结构体访问、连续存储</li>
<li>例子：你看了第100页，接下来可能会看第101页</li>
</ul>
<h4 data-id="heading-11">2. 🎯 缓存命中率："缓存的生命线"</h4>
<p>缓存命中率是衡量缓存效果的<strong>核心指标</strong>，它表示缓存中找到数据的概率：</p>
<p><strong>计算公式</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">缓存命中率 = 缓存命中次数 / (缓存命中次数 + 缓存未命中次数)
</code></pre>
<p><strong>影响命中率的因素</strong>：</p>
<ul>
<li>📦 <strong>缓存容量</strong>：容量越大，命中率越高（但成本也越高）</li>
<li>🔄 <strong>替换策略</strong>：好的替换策略能提高命中率</li>
<li>🔍 <strong>局部性好坏</strong>：程序的局部性越好，命中率越高</li>
<li>📊 <strong>数据分布</strong>：热点数据越集中，命中率越高</li>
</ul>
<p><strong>行业标准</strong>：</p>
<ul>
<li>CPU缓存：命中率可达90%以上</li>
<li>内存缓存：命中率可达80%以上</li>
<li>分布式缓存：命中率可达70%以上</li>
</ul>
<h4 data-id="heading-12">3. 🔄 缓存替换算法："谁该被淘汰？"</h4>
<p>当缓存满了，需要决定淘汰哪些数据，这就是<strong>缓存替换算法</strong>的工作！</p>
<p><strong>常见的替换算法</strong>：</p>
<h5 data-id="heading-13">📌 FIFO（先进先出）</h5>
<ul>
<li><strong>原理</strong>：先进入缓存的数据先淘汰</li>
<li><strong>优点</strong>：实现简单，开销小</li>
<li><strong>缺点</strong>：不考虑数据的访问频率</li>
<li><strong>例子</strong>：排队买票，先到先得</li>
</ul>
<h5 data-id="heading-14">📈 LRU（最近最少使用）</h5>
<ul>
<li><strong>原理</strong>：淘汰最近最少使用的数据</li>
<li><strong>优点</strong>：考虑了时间局部性</li>
<li><strong>缺点</strong>：实现复杂，需要维护访问顺序</li>
<li><strong>例子</strong>：书架上的书，最久没看的先放回书架</li>
</ul>
<p><strong>代码实例</strong>：Python实现LRU缓存</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> OrderedDict

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LRUCache</span>:
    <span class="hljs-string">"""简单的LRU缓存实现"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, capacity: <span class="hljs-built_in">int</span></span>):
        self.capacity = capacity
        self.cache = OrderedDict()
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self, key: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">any</span>:
        <span class="hljs-string">"""获取缓存中的数据，如果不存在返回None"""</span>
        <span class="hljs-keyword">if</span> key <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.cache:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        <span class="hljs-comment"># 将访问的键移到末尾，表示最近使用</span>
        self.cache.move_to_end(key)
        <span class="hljs-keyword">return</span> self.cache[key]
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">put</span>(<span class="hljs-params">self, key: <span class="hljs-built_in">str</span>, value: <span class="hljs-built_in">any</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""将数据放入缓存"""</span>
        <span class="hljs-keyword">if</span> key <span class="hljs-keyword">in</span> self.cache:
            <span class="hljs-comment"># 更新数据，并移到末尾</span>
            self.cache.move_to_end(key)
        self.cache[key] = value
        <span class="hljs-comment"># 如果缓存满了，淘汰最早的键</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.cache) &gt; self.capacity:
            self.cache.popitem(last=<span class="hljs-literal">False</span>)
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""返回缓存的字符串表示"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"LRUCache(capacity=<span class="hljs-subst">{self.capacity}</span>, items=<span class="hljs-subst">{<span class="hljs-built_in">list</span>(self.cache.items())}</span>)"</span>)

<span class="hljs-comment"># 测试LRU缓存</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🎯 测试LRU缓存"</span>)
    cache = LRUCache(capacity=<span class="hljs-number">3</span>)
  
    <span class="hljs-comment"># 放入数据</span>
    cache.put(<span class="hljs-string">"A"</span>, <span class="hljs-number">1</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"放入A: <span class="hljs-subst">{cache}</span>"</span>)
  
    cache.put(<span class="hljs-string">"B"</span>, <span class="hljs-number">2</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"放入B: <span class="hljs-subst">{cache}</span>"</span>)
  
    cache.put(<span class="hljs-string">"C"</span>, <span class="hljs-number">3</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"放入C: <span class="hljs-subst">{cache}</span>"</span>)
  
    <span class="hljs-comment"># 访问A，移到末尾</span>
    cache.get(<span class="hljs-string">"A"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"访问A: <span class="hljs-subst">{cache}</span>"</span>)
  
    <span class="hljs-comment"># 放入D，淘汰最早的B</span>
    cache.put(<span class="hljs-string">"D"</span>, <span class="hljs-number">4</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"放入D: <span class="hljs-subst">{cache}</span>"</span>)
  
    <span class="hljs-comment"># 访问不存在的E</span>
    result = cache.get(<span class="hljs-string">"E"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"访问E: <span class="hljs-subst">{result}</span>, 缓存: <span class="hljs-subst">{cache}</span>"</span>)
  
    <span class="hljs-comment"># 输出</span>
    <span class="hljs-comment"># 🎯 测试LRU缓存</span>
    <span class="hljs-comment"># 放入A: LRUCache(capacity=3, items=[('A', 1)]))</span>
    <span class="hljs-comment"># 放入B: LRUCache(capacity=3, items=[('A', 1), ('B', 2)]))</span>
    <span class="hljs-comment"># 放入C: LRUCache(capacity=3, items=[('A', 1), ('B', 2), ('C', 3)]))</span>
    <span class="hljs-comment"># 访问A: LRUCache(capacity=3, items=[('B', 2), ('C', 3), ('A', 1)]))</span>
    <span class="hljs-comment"># 放入D: LRUCache(capacity=3, items=[('C', 3), ('A', 1), ('D', 4)]))</span>
    <span class="hljs-comment"># 访问E: None, 缓存: LRUCache(capacity=3, items=[('C', 3), ('A', 1), ('D', 4)]))</span>
</code></pre>
<h5 data-id="heading-15">📊 LFU（最少使用频率）</h5>
<ul>
<li><strong>原理</strong>：淘汰使用频率最低的数据</li>
<li><strong>优点</strong>：考虑了数据的访问频率</li>
<li><strong>缺点</strong>：实现复杂，需要维护访问频率</li>
<li><strong>例子</strong>：图书馆的书，借的人最少的先下架</li>
</ul>
<h5 data-id="heading-16">🏆 其他算法</h5>
<ul>
<li><strong>LRU-K</strong>：结合了LRU和LFU的优点</li>
<li><strong>ARC（自适应替换缓存）</strong>：自动平衡LRU和LFU</li>
<li><strong>MRU（最近最常使用）</strong>：淘汰最近最常使用的数据</li>
</ul>
<h4 data-id="heading-17">4. 📍 缓存一致性："数据同步问题"</h4>
<p>当原始数据发生变化时，如何确保缓存中的数据与原始数据一致？这就是<strong>缓存一致性</strong>问题！</p>
<p><strong>常见的解决方案</strong>：</p>
<h5 data-id="heading-18">1. 🔄 缓存更新策略</h5>
<ul>
<li><strong>更新缓存</strong>：修改原始数据后，同时更新缓存</li>
<li><strong>删除缓存</strong>：修改原始数据后，删除缓存（下次访问时重新加载）</li>
<li><strong>延迟双删</strong>：修改数据后，先删缓存，再更新数据库，再延迟删一次缓存</li>
</ul>
<h5 data-id="heading-19">2. 🏃 异步更新</h5>
<ul>
<li>使用消息队列（如Kafka、RabbitMQ）异步更新缓存</li>
<li>适合实时性要求不高的场景</li>
</ul>
<h5 data-id="heading-20">3. 🔒 分布式锁</h5>
<ul>
<li>确保缓存更新的原子性</li>
<li>防止并发更新导致的数据不一致</li>
</ul>
<h5 data-id="heading-21">4. 💡 读写分离</h5>
<ul>
<li>写操作直接更新数据库，不更新缓存</li>
<li>读操作先读缓存，缓存未命中则从数据库加载</li>
<li>适合读多写少的场景</li>
</ul>
<h3 data-id="heading-22">📊 趣味对比：不同层级缓存的速度和容量差异</h3>






















































































<table><thead><tr><th>缓存层级</th><th>存储介质</th><th>访问速度</th><th>容量大小</th><th>成本/GB</th><th>管理方式</th><th>典型应用</th></tr></thead><tbody><tr><td>⚡ L1 CPU缓存</td><td>SRAM</td><td>&lt;1ns</td><td>几十KB</td><td>$1,000,000+</td><td>硬件</td><td>CPU指令和数据</td></tr><tr><td>📝 L2 CPU缓存</td><td>SRAM</td><td>1-5ns</td><td>几百KB</td><td>$500,000+</td><td>硬件</td><td>CPU常用数据</td></tr><tr><td>🗄️ L3 CPU缓存</td><td>SRAM</td><td>5-10ns</td><td>几MB到几十MB</td><td>$100,000+</td><td>硬件</td><td>CPU共享数据</td></tr><tr><td>💻 内存缓存</td><td>DRAM</td><td>~100ns</td><td>几GB到几十GB</td><td>$100-500</td><td>软件</td><td>操作系统、应用程序</td></tr><tr><td>💾 磁盘缓存</td><td>闪存/DRAM</td><td>~5ms</td><td>几十MB到几GB</td><td>$10-100</td><td>硬件+软件</td><td>硬盘、RAID控制器</td></tr><tr><td>🌐 分布式缓存</td><td>内存集群</td><td>~1ms</td><td>几十GB到几百GB</td><td>$100-300</td><td>软件</td><td>互联网应用、大数据平台</td></tr><tr><td>📀 硬盘</td><td>HDD</td><td>~10ms</td><td>几TB</td><td>$0.1-1</td><td>软件</td><td>持久化存储</td></tr><tr><td>📼 磁带</td><td>磁带</td><td>~100ms</td><td>几十TB</td><td>$0.01-0.1</td><td>软件</td><td>归档存储</td></tr></tbody></table>
<h3 data-id="heading-23">🏢 缓存的应用场景：无处不在的缓存</h3>



























































<table><thead><tr><th>应用场景</th><th>举例</th><th>缓存技术</th><th>效果</th></tr></thead><tbody><tr><td>⚡ 互联网应用</td><td>淘宝、京东</td><td>Redis、Memcached</td><td>响应时间从几百ms降到几ms</td></tr><tr><td>📱 移动应用</td><td>微信、抖音</td><td>本地缓存+分布式缓存</td><td>减少网络请求，节省流量</td></tr><tr><td>🎮 游戏</td><td>王者荣耀、英雄联盟</td><td>内存缓存+Redis</td><td>实时更新玩家数据，低延迟</td></tr><tr><td>🔍 搜索引擎</td><td>百度、Google</td><td>倒排索引缓存</td><td>搜索结果快速返回</td></tr><tr><td>📊 大数据平台</td><td>Hadoop、Spark</td><td>内存缓存</td><td>计算结果复用，加速处理</td></tr><tr><td>📚 数据库</td><td>MySQL、Oracle</td><td>查询缓存、缓冲池</td><td>减少磁盘I/O，提高查询速度</td></tr><tr><td>🌐 CDN</td><td>阿里云CDN、Cloudflare</td><td>边缘缓存</td><td>静态资源快速访问</td></tr><tr><td>🎯 机器学习</td><td>TensorFlow、PyTorch</td><td>GPU缓存</td><td>加速模型训练</td></tr></tbody></table>
<h3 data-id="heading-24">📈 数据支撑：缓存的"硬核实力"</h3>
<ul>
<li>⚡ <strong>CPU缓存命中率可达90%以上</strong>，减少CPU等待时间</li>
<li>💨 <strong>分布式缓存可将系统响应时间降低50%以上</strong></li>
<li>📊 <strong>互联网应用中，80%的请求访问20%的数据</strong>（符合帕累托法则）</li>
<li>💰 <strong>缓存可以减少70%以上的数据库压力</strong>，降低硬件成本</li>
<li>🔄 <strong>Redis的QPS（每秒处理请求数）可达10万以上</strong>，是传统数据库的100倍</li>
<li>🚀 <strong>CDN可将静态资源的加载速度提高3-5倍</strong></li>
<li>⏱️ <strong>内存访问速度是硬盘的1000倍以上</strong></li>
</ul>
<h3 data-id="heading-25">🔧 代码实例：Redis分布式缓存使用示例</h3>
<p><strong>Python + Redis 示例</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> redis
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># 连接Redis</span>
r = redis.Redis(host=<span class="hljs-string">'localhost'</span>, port=<span class="hljs-number">6379</span>, db=<span class="hljs-number">0</span>)

<span class="hljs-comment"># 模拟从数据库获取数据的函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_data_from_db</span>(<span class="hljs-params">key</span>):
    <span class="hljs-string">"""从数据库获取数据（模拟耗时操作）"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📊 从数据库获取数据: <span class="hljs-subst">{key}</span>"</span>)
    time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 模拟数据库查询耗时</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"数据_<span class="hljs-subst">{key}</span>"</span>

<span class="hljs-comment"># 使用缓存的函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_data</span>(<span class="hljs-params">key, cache_expire=<span class="hljs-number">3600</span></span>):
    <span class="hljs-string">"""从缓存获取数据，如果缓存未命中则从数据库加载"""</span>
    <span class="hljs-comment"># 先从缓存获取</span>
    cached_data = r.get(key)
  
    <span class="hljs-keyword">if</span> cached_data:
        <span class="hljs-comment"># 缓存命中</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 缓存命中: <span class="hljs-subst">{key}</span>"</span>)
        <span class="hljs-keyword">return</span> cached_data.decode(<span class="hljs-string">'utf-8'</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 缓存未命中，从数据库加载</span>
        data = get_data_from_db(key)
        <span class="hljs-comment"># 将数据存入缓存</span>
        r.<span class="hljs-built_in">set</span>(key, data, ex=cache_expire)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"💾 数据已存入缓存: <span class="hljs-subst">{key}</span>"</span>)
        <span class="hljs-keyword">return</span> data

<span class="hljs-comment"># 测试缓存效果</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🎯 测试Redis缓存效果"</span>)
  
    <span class="hljs-comment"># 第一次访问，缓存未命中</span>
    start_time = time.time()
    data1 = get_data(<span class="hljs-string">"user_123"</span>)
    end_time = time.time()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第一次访问耗时: <span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据: <span class="hljs-subst">{data1}</span>"</span>)
    <span class="hljs-built_in">print</span>()
  
    <span class="hljs-comment"># 第二次访问，缓存命中</span>
    start_time = time.time()
    data2 = get_data(<span class="hljs-string">"user_123"</span>)
    end_time = time.time()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第二次访问耗时: <span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据: <span class="hljs-subst">{data2}</span>"</span>)
    <span class="hljs-built_in">print</span>()
  
    <span class="hljs-comment"># 访问另一个key</span>
    start_time = time.time()
    data3 = get_data(<span class="hljs-string">"product_456"</span>)
    end_time = time.time()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"访问新key耗时: <span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据: <span class="hljs-subst">{data3}</span>"</span>)
    <span class="hljs-built_in">print</span>()
  
    <span class="hljs-comment"># 输出</span>
    <span class="hljs-comment"># 🎯 测试Redis缓存效果</span>
    <span class="hljs-comment"># 📊 从数据库获取数据: user_123</span>
    <span class="hljs-comment"># 💾 数据已存入缓存: user_123</span>
    <span class="hljs-comment"># 第一次访问耗时: 1.01秒</span>
    <span class="hljs-comment"># 数据: 数据_user_123</span>
    <span class="hljs-comment">#</span>
    <span class="hljs-comment"># ✅ 缓存命中: user_123</span>
    <span class="hljs-comment"># 第二次访问耗时: 0.01秒</span>
    <span class="hljs-comment"># 数据: 数据_user_123</span>
    <span class="hljs-comment">#</span>
    <span class="hljs-comment"># 📊 从数据库获取数据: product_456</span>
    <span class="hljs-comment"># 💾 数据已存入缓存: product_456</span>
    <span class="hljs-comment"># 访问新key耗时: 1.01秒</span>
    <span class="hljs-comment"># 数据: 数据_product_456</span>
</code></pre>
<h3 data-id="heading-26">⚠️ 常见误区纠正</h3>
<h4 data-id="heading-27">1. "缓存容量越大越好？"</h4>
<p><strong>错！</strong> 缓存容量并非越大越好：</p>
<ul>
<li>💰 成本高：高速存储的成本是低速存储的100倍以上</li>
<li>⏱️ 缓存管理开销大：容量越大，管理越复杂</li>
<li>🔍 命中率边际效应：当容量超过一定值，命中率提升不明显</li>
</ul>
<h4 data-id="heading-28">2. "缓存能解决所有性能问题？"</h4>
<p><strong>错！</strong> 缓存不是"银弹"：</p>
<ul>
<li>🔄 缓存失效：当数据频繁变化时，缓存命中率会很低</li>
<li>🔧 引入复杂性：需要处理缓存一致性、穿透、击穿、雪崩等问题</li>
<li>📊 不适用于所有场景：对于一次性访问的数据，缓存没有意义</li>
</ul>
<h4 data-id="heading-29">3. "分布式缓存一定比单机缓存好？"</h4>
<p><strong>不一定！</strong> 分布式缓存的选择取决于场景：</p>
<ul>
<li>🏢 大规模应用：需要分布式缓存</li>
<li>🏠 小型应用：单机缓存足够，维护简单</li>
<li>⚡ 性能要求极高：单机缓存可能更快（无网络开销）</li>
</ul>
<h4 data-id="heading-30">4. "缓存穿透和缓存击穿是一回事？"</h4>
<p><strong>错！</strong> 它们是不同的概念：</p>
<ul>
<li>🔍 <strong>缓存穿透</strong>：访问不存在的数据，缓存和数据库都没有</li>
<li>💥 <strong>缓存击穿</strong>：热点数据过期，大量请求同时访问，导致数据库压力骤增</li>
<li>❄️ <strong>缓存雪崩</strong>：大量缓存同时过期，导致数据库压力骤增</li>
</ul>
<h4 data-id="heading-31">5. "Redis是唯一的分布式缓存选择？"</h4>
<p><strong>错！</strong> 还有很多其他选择：</p>
<ul>
<li>📦 <strong>Memcached</strong>：简单高效，适合纯缓存场景</li>
<li>🔧 <strong>Tair</strong>：阿里巴巴开源，支持多种存储引擎</li>
<li>🌐 <strong>ElastiCache</strong>：AWS托管，支持Redis和Memcached</li>
<li>🎯 <strong>Hazelcast</strong>：分布式内存数据网格</li>
<li>💪 <strong>Ignite</strong>：高性能分布式缓存</li>
</ul>
<h3 data-id="heading-32">🔮 未来展望：缓存技术的发展趋势</h3>
<h4 data-id="heading-33">1. 🤖 AI驱动的缓存</h4>
<p>AI将融入缓存的各个环节：</p>
<ul>
<li><strong>智能预测</strong>：预测未来的访问模式，提前加载数据</li>
<li><strong>自适应调整</strong>：根据访问模式自动调整缓存容量和替换策略</li>
<li><strong>异常检测</strong>：自动检测缓存热点和异常访问</li>
</ul>
<h4 data-id="heading-34">2. ☁️ 云原生缓存</h4>
<p>随着云计算的普及，云原生缓存将成为主流：</p>
<ul>
<li><strong>Serverless缓存</strong>：无需管理服务器，按需付费</li>
<li><strong>边缘缓存</strong>：将缓存部署在边缘节点，减少延迟</li>
<li><strong>多云缓存</strong>：支持跨云部署，提高可用性</li>
</ul>
<h4 data-id="heading-35">3. 🚀 新型存储介质</h4>
<p>新型存储介质将改变缓存格局：</p>
<ul>
<li><strong>3D XPoint</strong>：速度接近DRAM，容量接近NAND Flash</li>
<li><strong>MRAM</strong>：非易失性，速度快，寿命长</li>
<li><strong>ReRAM</strong>：电阻式内存，密度高，功耗低</li>
</ul>
<h4 data-id="heading-36">4. 🔄 缓存与计算融合</h4>
<p>缓存和计算的边界将越来越模糊：</p>
<ul>
<li><strong>计算近数据</strong>：将计算能力嵌入存储设备</li>
<li><strong>内存计算</strong>：直接在内存中进行计算</li>
<li><strong>GPU缓存</strong>：加速AI和图形计算</li>
</ul>
<h3 data-id="heading-37">🎓 互动小测验：你答对了吗？</h3>


















































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>缓存的本质是什么？</td><td>用空间换时间</td><td>✅/❌</td></tr><tr><td>局部性原理包括哪两种？</td><td>时间局部性和空间局部性</td><td>✅/❌</td></tr><tr><td>最常用的缓存替换算法是什么？</td><td>LRU（最近最少使用）</td><td>✅/❌</td></tr><tr><td>CPU缓存的命中率可达多少？</td><td>90%以上</td><td>✅/❌</td></tr><tr><td>Redis的QPS可达多少？</td><td>10万以上</td><td>✅/❌</td></tr><tr><td>缓存击穿是什么？</td><td>热点数据过期导致数据库压力骤增</td><td>✅/❌</td></tr><tr><td>缓存一致性的解决方案有哪些？</td><td>更新缓存、删除缓存、异步更新等</td><td>✅/❌</td></tr><tr><td>内存访问速度是硬盘的多少倍？</td><td>1000倍以上</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-38">🎯 结语：缓存——系统性能的"加速器"</h3>
<p>从CPU缓存到分布式缓存，缓存技术已经成为<strong>现代计算机系统的核心组件</strong>！</p>
<p><strong>记住</strong>：</p>
<ul>
<li>⚡ 缓存是"用空间换时间"的典型应用</li>
<li>📊 局部性原理是缓存存在的理论基础</li>
<li>🎯 命中率是衡量缓存效果的核心指标</li>
<li>🔄 好的替换策略能提高命中率</li>
<li>💡 缓存不是万能的，需要根据场景选择</li>
</ul>
<p>下次当你使用手机APP、浏览网页、玩游戏时，不妨想想背后的缓存技术——正是这些看不见的"加速器"，让我们的数字生活变得更加流畅和便捷！</p>
<h3 data-id="heading-39">💬 互动话题</h3>
<ol>
<li>你在项目中使用过哪些缓存技术？效果如何？</li>
<li>你遇到过哪些缓存相关的问题？最后是怎么解决的？</li>
<li>你觉得未来的缓存技术会是什么样子？</li>
<li>如果你设计缓存系统，会考虑哪些因素？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[代码修仙录 · 第1期：宗门大阵崩了？只因少了毫秒三魂！]]></title>    <link>https://juejin.cn/post/7592361736130625546</link>    <guid>https://juejin.cn/post/7592361736130625546</guid>    <pubDate>2026-01-07T08:49:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592361736130625546" data-draft-id="7592340733954097202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="代码修仙录 · 第1期：宗门大阵崩了？只因少了毫秒三魂！"/> <meta itemprop="keywords" content="后端,数据库,MySQL"/> <meta itemprop="datePublished" content="2026-01-07T08:49:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洛小豆"/> <meta itemprop="url" content="https://juejin.cn/user/2049145406229127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            代码修仙录 · 第1期：宗门大阵崩了？只因少了毫秒三魂！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2049145406229127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洛小豆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:49:36.000Z" title="Wed Jan 07 2026 08:49:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>代码修仙录系列 · 第1期</p>
<p>关注我，和小豆一起在掘金修炼代码</p>
</blockquote>
<h2 data-id="heading-0">🔥 宗门异象</h2>
<p>子时已过，八哥宗内一片死寂，唯有几块<code>灵镜（显示器）</code>泛着幽幽蓝光，映照着修士们疲惫的面庞。</p>
<p>突然，幻术师小汐一声惊呼，打破了藏经阁的宁静。</p>
<p>“不好！护宗大阵的<code>时间法则（Timestamp）</code>崩塌了！凡人们都在逆流光阴，因果全乱了！”</p>
<p>正在闭目养神、运转周天的我，被这突如其来的神识传音吓了一跳，差点走火入魔。我急忙起身，快步走到小汐的法阵前。</p>
<p>“师妹，切勿惊慌，发生何事？”</p>
<p>小汐指着手中的<strong>探灵盘（浏览器控制台）</strong>，眉心紧锁，周身灵气紊乱：“师兄你看，这灵力流（<strong>Network Response</strong>）中回响的时间法印，怎么只有十道符文？这显然是<strong>练气期（秒级）的低阶法力，根本支撑不起这十三道（毫秒级）的幻境运转啊！</strong>”</p>
<h2 data-id="heading-1">🎯 问心查探</h2>
<p>我定睛一瞧，探灵盘上红光隐现。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 幻境（前端）获取的天道时间</span>
<span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(); 
<span class="hljs-comment">// 乃是 13 位精细之数：1704723600123</span>

<span class="hljs-comment">// 阵枢（后端）吐出的时间法印</span>
<span class="hljs-keyword">const</span> serverTime = <span class="hljs-number">1704723600</span>; 
<span class="hljs-comment">// 竟只有 10 位！缺了三魂七魄！</span>
</code></pre>
<p>“这……”我面露尴尬之色，额头渗出一丝冷汗，“此乃我筑基初期时布下的阵法。当时为了节省灵石（存储空间），便选用了 <code>TIMESTAMP</code> 这一古法来封印时间。”</p>
<p>小汐一听，顿时柳眉倒竖：“师兄！你糊涂啊！凡人（用户）在幻境中的一举一动，皆需精确到毫厘。若同一息（秒）内，凡人连续施展了三招，你这练气期的法印如何分辨先后？岂不是因果倒置，天下大乱？”</p>
<p>她祭出<strong>观天镜（页面）</strong>，只见凡人的操作记录在那疯狂跳动，如同中了幻术一般，毫无次序可言。</p>
<h2 data-id="heading-2">🧠 长老指点</h2>
<p>“还在用 <code>TIMESTAMP</code> ？”</p>
<p>一个清冷的声音从阴影中传来。</p>
<p>我和小汐回头一看，竟是<strong>金丹期长老</strong>阿辰。他不知何时已站在身后，手中端着那只万年不离身的<strong>紫金红葫芦（保温杯）</strong>，周身散发着深不可测的威压。</p>
<p>“辰长老！”我们二人连忙行礼。</p>
<p>阿辰微微颔首，随手祭出一枚<strong>留影石（白板）</strong>，指尖灵力流转，在虚空中画出了两条道纹。</p>
<p>“豆子，你这阵法，有两处致命<strong>道伤（缺陷）</strong>。”</p>
<p>阿辰长老的声音不大，却如洪钟大吕，直击道心。</p>
<p>“其一，<code>TIMESTAMP</code> 乃是<strong>随波逐流的浮萍</strong>。它强依附于<strong>宗门灵脉（服务器时区）</strong>。若是有朝一日，宗门迁址到了大洋彼岸，或者灵脉守护者（运维）手抖改了时区，你这满阁的经书，时间便会瞬间错乱。”</p>
<p>“其二，”阿辰指着另一条道纹，“此法寿元有限。待到<strong>天道历 2038 年</strong>（2038年1月19日），此法便会<strong>天人五衰（溢出）</strong>，届时阵法必将崩塌。”</p>
<p>小汐在一旁听得连连点头：“长老所言极是！那该修习何种法门？”</p>
<p>阿辰淡淡吐出几个字：“<strong><code>DATETIME(3)</code> 配合 UTC 心法。</strong>”</p>
<p>他解释道：“<code>DATETIME</code> 如同<strong>刻在石上的真言</strong>，任凭沧海桑田（时区变化），它自岿然不动。而那 <code>(3)</code>，便是开启**毫厘（毫秒）**之眼的钥匙。”</p>
<h2 data-id="heading-3">💻 演练法诀</h2>
<p>既然长老指明了大道，我不敢怠慢，当即决定<strong>洗髓伐经（重构）</strong>。</p>
<h3 data-id="heading-4">第一式：重铸灵脉（数据库改造）</h3>
<p>我屏气凝神，双手在**法盘（键盘）**上飞舞，打出一道道法诀：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 废弃旧法，重铸根基</span>
<span class="hljs-comment">-- 将字段修为从 TIMESTAMP 提升至 DATETIME(3)</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> `user_actions`
MODIFY <span class="hljs-keyword">COLUMN</span> `created_at` DATETIME(<span class="hljs-number">3</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1000-01-01 00:00:00.000'</span>;
</code></pre>
<p><strong>【技术破壁】</strong>：注意这 <code>(3)</code>，在 MySQL 中代表保留 3 位小数，即毫秒精度。若不写，默认是 0，依旧是秒级。</p>
<h3 data-id="heading-5">第二式：流转乾坤（前后端交互）</h3>
<p>为确保灵力流转无误，我绘制了一幅<strong>灵力流转图（时序图）</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 幻术师 as 小汐(前端)
    participant 阵法师 as 我(后端)
    participant 藏经阁 as MySQL

    Note over 幻术师, 藏经阁: 宗门铁律：交互只用 UTC 真言

    幻术师-&gt;&gt;阵法师: 传音：凡人操作 (13位时间戳)
    阵法师-&gt;&gt;阵法师: 运转心法：转为 UTC 格式
    Note right of 阵法师: 2025-01-09 01:00:00.123
    阵法师-&gt;&gt;藏经阁: 封印入库 (DATETIME(3))
    藏经阁--&gt;&gt;阵法师: 封印完成
    
    幻术师-&gt;&gt;阵法师: 查探因果
    阵法师-&gt;&gt;藏经阁: 解开封印
    藏经阁--&gt;&gt;阵法师: 2025-01-09 01:00:00.123
    阵法师--&gt;&gt;幻术师: 回响：UTC 时间法印
    Note left of 幻术师: 幻术师自行演化&lt;br/&gt;为凡人本地时间
</code></pre>
<h3 data-id="heading-6">第三式：运转周天（后端代码）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 引入时间法则法宝</span>
<span class="hljs-keyword">const</span> dayjs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dayjs'</span>);
<span class="hljs-keyword">const</span> utc = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dayjs/plugin/utc'</span>);
dayjs.<span class="hljs-title function_">extend</span>(utc);

<span class="hljs-comment">// 阵法核心代码</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentDaoTime</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 【技术破壁】：获取当前 UTC 时间，并保留毫秒</span>
    <span class="hljs-keyword">return</span> dayjs.<span class="hljs-title function_">utc</span>().<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD HH:mm:ss.SSS'</span>);
}

<span class="hljs-keyword">const</span> daoTime = <span class="hljs-title function_">getCurrentDaoTime</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`封印时间: <span class="hljs-subst">${daoTime}</span>`</span>); 
<span class="hljs-comment">// 显像: 2025-01-09 01:00:00.123</span>
</code></pre>
<h2 data-id="heading-7">📊 渡劫成功</h2>
<p>法诀打完，重启阵眼。只见红光尽退，灵力流转顺畅无比。</p>
<p>小汐再次祭出<strong>探灵盘</strong>，只见那时间法印已是十三位齐全，毫厘不差。</p>
<p>“成了！”小汐喜上眉梢，指着观天镜中的列表，“师兄你看，凡人的每一步操作，如今都如<strong>因果律</strong>一般清晰，次序分明，再无错乱。”</p>
<p>那一刻，原本压抑的藏经阁内，仿佛有一阵清风拂过。</p>
<h2 data-id="heading-8">💡 道友留步</h2>
<p>今日这场渡劫，虽惊心动魄，却也让我道心更稳。特留下几句真言，赠予诸位道友：</p>
<p><strong>【心法口诀】</strong></p>
<ol>
<li><strong>弃 TIMESTAMP，修 DATETIME</strong>：MySQL 5.6.4 后，<code>DATETIME</code> 已是大成之法，仅多占 1 字节，便可延寿至 9999 年。</li>
<li><strong>开天眼 (3)</strong>：切记加上 <code>(3)</code>，否则仍是睁眼瞎（丢失毫秒）。</li>
<li><strong>UTC 护体</strong>：阵法内部（DB &amp; 后端）只认 UTC，莫要让阵法去猜时区。</li>
</ol>
<p><strong>【心魔预警】</strong></p>
<ul>
<li>❌ <strong>切忌</strong>：老阵法直接升级字段，若不备份，恐有**炸炉（数据丢失）**之险。</li>
<li>❌ <strong>切忌</strong>：连接法宝（Driver）配置错误，若不指定时区，法宝会自动扭曲时间。</li>
</ul>
<h2 data-id="heading-9">🌙 归隐</h2>
<p>窗外雷声渐歇，看来今晚的渡劫已然安然度过。</p>
<p>阿辰长老收起留影石，拂衣而去，深藏功与名。只留下一句回荡在空荡荡的工位上：</p>
<p>“<strong>修仙无岁月，技术不进则退。好自为之。</strong>”</p>
<p>我看了看灵镜右下角的时间，正是北京时间 <strong>02:15:30.500</strong>。</p>
<p>在此毫秒之间，我与小汐对视一眼，皆是劫后余生的庆幸。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[线程池深度解析]]></title>    <link>https://juejin.cn/post/7592170706026758179</link>    <guid>https://juejin.cn/post/7592170706026758179</guid>    <pubDate>2026-01-07T08:35:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592170706026758179" data-draft-id="7592166340381949967" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="线程池深度解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-07T08:35:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="以梦为马不负韶华"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056900429"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            线程池深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056900429/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    以梦为马不负韶华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:35:13.000Z" title="Wed Jan 07 2026 08:35:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">线程池深度解析：从使用到源码，再到生产实践</h2>
<h3 data-id="heading-1">一、为什么需要线程池？</h3>
<h4 data-id="heading-2">1.1 线程的代价</h4>
<p>在开始讲解线程池之前，我们先看一个简单的例子：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 原始方式：每次请求都创建新线程</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(Request request)</span> {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
        <span class="hljs-comment">// 处理业务逻辑</span>
        process(request);
    }).start();
}
</code></pre>
<p>这种方式有什么问题？</p>
<ul>
<li><strong>创建成本高</strong>：每次创建线程需要分配内存、初始化栈（默认1MB）</li>
<li><strong>资源浪费</strong>：线程创建/销毁消耗CPU资源</li>
<li><strong>难以管理</strong>：线程数量无限制，容易导致系统崩溃</li>
</ul>
<h4 data-id="heading-3">1.2 线程池的救赎</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用线程池后的优雅方式</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">threadPool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(Request request)</span> {
    threadPool.execute(() -&gt; {
        process(request);
    });
}
</code></pre>
<h3 data-id="heading-4">二、Java线程池家族</h3>
<h4 data-id="heading-5">2.1 Executors工厂类</h4>
<p>Java提供了4种常用的线程池：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 固定大小线程池</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">fixedPool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
<span class="hljs-comment">// 适用场景：已知并发量，需要控制资源</span>

<span class="hljs-comment">// 2. 单线程线程池</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">singlePool</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();
<span class="hljs-comment">// 适用场景：任务需要顺序执行</span>

<span class="hljs-comment">// 3. 可缓存线程池</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">cachedPool</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();
<span class="hljs-comment">// 适用场景：短期异步任务，线程数自动调整</span>

<span class="hljs-comment">// 4. 定时任务线程池</span>
<span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduledPool</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">5</span>);
<span class="hljs-comment">// 适用场景：延迟执行或周期性任务</span>
</code></pre>
<h4 data-id="heading-6">2.2 这些"快捷方式"的真相</h4>
<p>我们点开源码看看：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Executors.newFixedThreadPool源码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newFixedThreadPool</span><span class="hljs-params">(<span class="hljs-type">int</span> nThreads)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
        nThreads,                  <span class="hljs-comment">// 核心线程数</span>
        nThreads,                  <span class="hljs-comment">// 最大线程数</span>
        <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS, <span class="hljs-comment">// 空闲线程存活时间</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;() <span class="hljs-comment">// 无界队列</span>
    );
}
</code></pre>
<p><strong>注意坑点</strong>：<code>LinkedBlockingQueue</code>默认是<code>Integer.MAX_VALUE</code>，任务堆积可能OOM！</p>
<h3 data-id="heading-7">三、深入ThreadPoolExecutor源码</h3>
<h4 data-id="heading-8">3.1 核心参数解析</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ThreadPoolExecutor</span><span class="hljs-params">(
    <span class="hljs-type">int</span> corePoolSize,      // 核心线程数（长期存活的线程）
    <span class="hljs-type">int</span> maximumPoolSize,   // 最大线程数
    <span class="hljs-type">long</span> keepAliveTime,    // 空闲线程存活时间
    TimeUnit unit,         // 时间单位
    BlockingQueue&lt;Runnable&gt; workQueue,  // 工作队列
    ThreadFactory threadFactory,        // 线程工厂
    RejectedExecutionHandler handler    // 拒绝策略
)</span>
</code></pre>
<h4 data-id="heading-9">3.2 线程池工作流程（源码级解析）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 简化版的execute方法流程</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Runnable command)</span> {
    <span class="hljs-comment">// 第一阶段：核心线程处理</span>
    <span class="hljs-keyword">if</span> (workerCount &lt; corePoolSize) {
        <span class="hljs-keyword">if</span> (addWorker(command, <span class="hljs-literal">true</span>))  <span class="hljs-comment">// 创建核心线程</span>
            <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 第二阶段：任务入队</span>
    <span class="hljs-keyword">if</span> (isRunning() &amp;&amp; workQueue.offer(command)) {
        <span class="hljs-comment">// 再次检查</span>
        <span class="hljs-keyword">if</span> (!isRunning() &amp;&amp; remove(command))
            reject(command);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (workerCount == <span class="hljs-number">0</span>)
            addWorker(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);
    }
    
    <span class="hljs-comment">// 第三阶段：创建非核心线程</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!addWorker(command, <span class="hljs-literal">false</span>))
        <span class="hljs-comment">// 第四阶段：拒绝策略</span>
        reject(command);
}
</code></pre>
<p>让我们用流程图更直观地理解：</p>
<pre><code class="hljs language-markdown" lang="markdown">任务提交
<span class="hljs-code">    ↓
当前线程数 &lt; corePoolSize?
    ├── 是 → 创建核心线程执行任务
    ↓
    └── 否 → 工作队列未满?
        ├── 是 → 任务入队等待
        ↓
        └── 否 → 当前线程数 &lt; maximumPoolSize?
            ├── 是 → 创建临时线程执行
            ↓
            └── 否 → 执行拒绝策略
</span></code></pre>
<h4 data-id="heading-10">3.3 Worker内部类：线程池的真正执行者</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Worker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-keyword">final</span> Thread thread;  <span class="hljs-comment">// 实际执行任务的线程</span>
    Runnable firstTask;   <span class="hljs-comment">// 初始任务</span>
    
    Worker(Runnable firstTask) {
        <span class="hljs-built_in">this</span>.firstTask = firstTask;
        <span class="hljs-built_in">this</span>.thread = getThreadFactory().newThread(<span class="hljs-built_in">this</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        runWorker(<span class="hljs-built_in">this</span>);  <span class="hljs-comment">// 核心执行方法</span>
    }
    
    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runWorker</span><span class="hljs-params">(Worker w)</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">wt</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> w.firstTask;
        w.firstTask = <span class="hljs-literal">null</span>;
        
        <span class="hljs-keyword">while</span> (task != <span class="hljs-literal">null</span> || (task = getTask()) != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 获取锁，确保线程不会被其他任务中断</span>
            w.lock();
            
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 执行前的钩子方法</span>
                beforeExecute(wt, task);
                
                <span class="hljs-keyword">try</span> {
                    task.run();  <span class="hljs-comment">// 执行任务！</span>
                    afterExecute(task, <span class="hljs-literal">null</span>);
                } <span class="hljs-keyword">catch</span> (Throwable ex) {
                    afterExecute(task, ex);
                    <span class="hljs-keyword">throw</span> ex;
                }
            } <span class="hljs-keyword">finally</span> {
                task = <span class="hljs-literal">null</span>;
                w.completedTasks++;  <span class="hljs-comment">// 统计完成任务数</span>
                w.unlock();
            }
        }
        
        processWorkerExit(w, completedAbruptly);
    }
}
</code></pre>
<h4 data-id="heading-11">3.4 getTask()：线程如何获取任务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> Runnable <span class="hljs-title function_">getTask</span><span class="hljs-params">()</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-variable">timedOut</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 上次poll是否超时</span>
    
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> ctl.get();
        <span class="hljs-type">int</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> runStateOf(c);
        
        <span class="hljs-comment">// 检查线程池状态</span>
        <span class="hljs-keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) {
            decrementWorkerCount();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">wc</span> <span class="hljs-operator">=</span> workerCountOf(c);
        
        <span class="hljs-comment">// 判断是否允许超时回收线程</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">timed</span> <span class="hljs-operator">=</span> allowCoreThreadTimeOut || wc &gt; corePoolSize;
        
        <span class="hljs-keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))
            &amp;&amp; (wc &gt; <span class="hljs-number">1</span> || workQueue.isEmpty())) {
            <span class="hljs-keyword">if</span> (compareAndDecrementWorkerCount(c))
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">continue</span>;
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 关键：从队列取任务</span>
            <span class="hljs-type">Runnable</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                workQueue.take();
            <span class="hljs-keyword">if</span> (r != <span class="hljs-literal">null</span>)
                <span class="hljs-keyword">return</span> r;
            timedOut = <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (InterruptedException retry) {
            timedOut = <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-12">四、拒绝策略详解</h3>
<h4 data-id="heading-13">4.1 Java内置的4种拒绝策略</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. AbortPolicy（默认） - 直接抛出异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rejectedExecution</span><span class="hljs-params">(Runnable r, ThreadPoolExecutor e)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RejectedExecutionException</span>(<span class="hljs-string">"Task rejected"</span>);
}

<span class="hljs-comment">// 2. CallerRunsPolicy - 让调用者线程执行</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rejectedExecution</span><span class="hljs-params">(Runnable r, ThreadPoolExecutor e)</span> {
    <span class="hljs-keyword">if</span> (!e.isShutdown()) {
        r.run();  <span class="hljs-comment">// 注意：是run()不是start()！</span>
    }
}

<span class="hljs-comment">// 3. DiscardPolicy - 默默丢弃</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rejectedExecution</span><span class="hljs-params">(Runnable r, ThreadPoolExecutor e)</span> {
    <span class="hljs-comment">// 什么都不做，直接丢弃</span>
}

<span class="hljs-comment">// 4. DiscardOldestPolicy - 丢弃队列最老任务</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rejectedExecution</span><span class="hljs-params">(Runnable r, ThreadPoolExecutor e)</span> {
    <span class="hljs-keyword">if</span> (!e.isShutdown()) {
        e.getQueue().poll();  <span class="hljs-comment">// 丢弃队头</span>
        e.execute(r);         <span class="hljs-comment">// 尝试重新执行</span>
    }
}
</code></pre>
<h4 data-id="heading-14">4.2 自定义拒绝策略实战</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomRejectPolicy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RejectedExecutionHandler</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MeterRegistry meterRegistry;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rejectedExecution</span><span class="hljs-params">(Runnable r, ThreadPoolExecutor executor)</span> {
        <span class="hljs-comment">// 1. 记录指标</span>
        meterRegistry.counter(<span class="hljs-string">"threadpool.rejected.tasks"</span>).increment();
        
        <span class="hljs-comment">// 2. 降级策略</span>
        <span class="hljs-keyword">if</span> (r <span class="hljs-keyword">instanceof</span> ImportantTask) {
            <span class="hljs-comment">// 重要任务：记录日志，等待重试</span>
            log.warn(<span class="hljs-string">"重要任务被拒绝，放入重试队列"</span>);
            retryQueue.offer((ImportantTask) r);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 普通任务：异步持久化，稍后处理</span>
            asyncSaveToDB(r);
        }
        
        <span class="hljs-comment">// 3. 告警通知</span>
        <span class="hljs-keyword">if</span> (needAlert(executor)) {
            sendAlert(executor);
        }
    }
}
</code></pre>
<h3 data-id="heading-15">五、生产环境线程池配置方案</h3>
<h4 data-id="heading-16">5.1 线程数计算公式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 根据任务类型设置线程数</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolConfig</span> {
    
    <span class="hljs-comment">/**
     * CPU密集型任务（计算、加密等）
     * 线程数 = CPU核心数 + 1
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">cpuIntensivePool</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">cpuCores</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            cpuCores + <span class="hljs-number">1</span>,
            cpuCores + <span class="hljs-number">1</span>,
            <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>)
        );
    }
    
    <span class="hljs-comment">/**
     * IO密集型任务（网络请求、数据库操作等）
     * 线程数 = CPU核心数 * (1 + 等待时间/计算时间)
     * 通常设置为 CPU核心数 * 2 ~ 5
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">ioIntensivePool</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">cpuCores</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            cpuCores * <span class="hljs-number">2</span>,
            cpuCores * <span class="hljs-number">5</span>,
            <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">2000</span>)
        );
    }
    
    <span class="hljs-comment">/**
     * 混合型任务
     * 最佳线程数 = CPU核心数 * (1 + 阻塞系数)
     * 阻塞系数 = 阻塞时间 / (阻塞时间 + 计算时间)
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">mixedPool</span><span class="hljs-params">(<span class="hljs-type">double</span> blockingCoefficient)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">cpuCores</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();
        <span class="hljs-type">int</span> <span class="hljs-variable">optimalThreads</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (cpuCores * (<span class="hljs-number">1</span> + blockingCoefficient));
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            optimalThreads,
            optimalThreads * <span class="hljs-number">2</span>,
            <span class="hljs-number">30L</span>, TimeUnit.SECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(optimalThreads * <span class="hljs-number">10</span>)
        );
    }
}
</code></pre>
<h4 data-id="heading-17">5.2 Spring Boot中的最佳配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">thread-pool:</span>
  <span class="hljs-attr">configs:</span>
    <span class="hljs-attr">order-process:</span>
      <span class="hljs-attr">core-size:</span> <span class="hljs-number">8</span>
      <span class="hljs-attr">max-size:</span> <span class="hljs-number">16</span>
      <span class="hljs-attr">queue-capacity:</span> <span class="hljs-number">100</span>
      <span class="hljs-attr">keep-alive-seconds:</span> <span class="hljs-number">60</span>
      <span class="hljs-attr">thread-name-prefix:</span> <span class="hljs-string">order-</span>
      <span class="hljs-attr">reject-policy:</span> <span class="hljs-string">CALLER_RUNS</span>
      
    <span class="hljs-attr">payment-callback:</span>
      <span class="hljs-attr">core-size:</span> <span class="hljs-number">4</span>
      <span class="hljs-attr">max-size:</span> <span class="hljs-number">8</span>
      <span class="hljs-attr">queue-capacity:</span> <span class="hljs-number">200</span>
      <span class="hljs-attr">thread-name-prefix:</span> <span class="hljs-string">payment-</span>
      <span class="hljs-attr">reject-policy:</span> <span class="hljs-string">ABORT</span>
      
    <span class="hljs-attr">report-generate:</span>
      <span class="hljs-attr">core-size:</span> <span class="hljs-number">2</span>
      <span class="hljs-attr">max-size:</span> <span class="hljs-number">4</span>
      <span class="hljs-attr">queue-capacity:</span> <span class="hljs-number">1000</span>
      <span class="hljs-attr">thread-name-prefix:</span> <span class="hljs-string">report-</span>
      <span class="hljs-attr">allow-core-thread-timeout:</span> <span class="hljs-literal">true</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableConfigurationProperties(ThreadPoolProperties.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Map&lt;String, ExecutorService&gt; <span class="hljs-title function_">threadPools</span><span class="hljs-params">(
            ThreadPoolProperties properties)</span> {
        
        Map&lt;String, ExecutorService&gt; pools = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        properties.getConfigs().forEach((name, config) -&gt; {
            <span class="hljs-comment">// 动态参数配置</span>
            <span class="hljs-type">DynamicThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> 
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicThreadPoolExecutor</span>(
                    config.getCoreSize(),
                    config.getMaxSize(),
                    config.getKeepAliveSeconds(),
                    TimeUnit.SECONDS,
                    createQueue(config.getQueueCapacity()),
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomThreadFactory</span>(config.getThreadNamePrefix()),
                    createRejectPolicy(config.getRejectPolicy())
                );
            
            <span class="hljs-comment">// 允许核心线程超时</span>
            <span class="hljs-keyword">if</span> (config.isAllowCoreThreadTimeout()) {
                executor.allowCoreThreadTimeOut(<span class="hljs-literal">true</span>);
            }
            
            <span class="hljs-comment">// 注册监控</span>
            ThreadPoolMonitor.register(name, executor);
            
            pools.put(name, executor);
        });
        
        <span class="hljs-keyword">return</span> pools;
    }
    
    <span class="hljs-keyword">private</span> BlockingQueue&lt;Runnable&gt; <span class="hljs-title function_">createQueue</span><span class="hljs-params">(<span class="hljs-type">int</span> capacity)</span> {
        <span class="hljs-comment">// 根据队列大小选择队列类型</span>
        <span class="hljs-keyword">if</span> (capacity &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousQueue</span>&lt;&gt;();
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (capacity &lt;= <span class="hljs-number">10000</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(capacity);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(capacity);
        }
    }
}
</code></pre>
<h4 data-id="heading-18">5.3 动态线程池：美团动态线程池实践</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicThreadPoolExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ThreadPoolExecutor</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String poolName;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadPoolProperties properties;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DynamicThreadPoolExecutor</span><span class="hljs-params">(String poolName, 
                                     ThreadPoolProperties properties)</span> {
        <span class="hljs-built_in">super</span>(properties.getCoreSize(), 
              properties.getMaxSize(),
              properties.getKeepAliveSeconds(), 
              TimeUnit.SECONDS,
              <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizableCapacityLinkedBlockingQueue</span>&lt;&gt;(
                  properties.getQueueCapacity()
              ));
        <span class="hljs-built_in">this</span>.poolName = poolName;
        <span class="hljs-built_in">this</span>.properties = properties;
        
        <span class="hljs-comment">// 初始化监听</span>
        initListeners();
    }
    
    <span class="hljs-comment">/**
     * 动态调整核心线程数
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCorePoolSize</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize)</span> {
        <span class="hljs-keyword">if</span> (corePoolSize &gt;= <span class="hljs-number">0</span> &amp;&amp; 
            corePoolSize &lt;= getMaximumPoolSize()) {
            <span class="hljs-built_in">super</span>.setCorePoolSize(corePoolSize);
            
            <span class="hljs-comment">// 记录变更</span>
            log.info(<span class="hljs-string">"线程池{}核心线程数调整为: {}"</span>, 
                     poolName, corePoolSize);
        }
    }
    
    <span class="hljs-comment">/**
     * 动态调整最大线程数
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMaximumPoolSize</span><span class="hljs-params">(<span class="hljs-type">int</span> maximumPoolSize)</span> {
        <span class="hljs-keyword">if</span> (maximumPoolSize &gt;= getCorePoolSize()) {
            <span class="hljs-built_in">super</span>.setMaximumPoolSize(maximumPoolSize);
            
            <span class="hljs-comment">// 记录变更</span>
            log.info(<span class="hljs-string">"线程池{}最大线程数调整为: {}"</span>, 
                     poolName, maximumPoolSize);
        }
    }
    
    <span class="hljs-comment">/**
     * 动态调整队列容量
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setQueueCapacity</span><span class="hljs-params">(<span class="hljs-type">int</span> capacity)</span> {
        ResizableCapacityLinkedBlockingQueue&lt;Runnable&gt; queue = 
            (ResizableCapacityLinkedBlockingQueue&lt;Runnable&gt;) getQueue();
        queue.setCapacity(capacity);
        
        log.info(<span class="hljs-string">"线程池{}队列容量调整为: {}"</span>, poolName, capacity);
    }
}

<span class="hljs-comment">// 可调整容量的队列</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResizableCapacityLinkedBlockingQueue</span>&lt;E&gt; 
        <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;E&gt; {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> capacity;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResizableCapacityLinkedBlockingQueue</span><span class="hljs-params">(<span class="hljs-type">int</span> capacity)</span> {
        <span class="hljs-built_in">super</span>(capacity);
        <span class="hljs-built_in">this</span>.capacity = capacity;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCapacity</span><span class="hljs-params">(<span class="hljs-type">int</span> newCapacity)</span> {
        <span class="hljs-keyword">if</span> (newCapacity &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();
        }
        
        <span class="hljs-comment">// 调整容量</span>
        <span class="hljs-built_in">this</span>.capacity = newCapacity;
        
        <span class="hljs-comment">// 如果新容量小于当前size，需要移除多余元素</span>
        <span class="hljs-keyword">while</span> (size() &gt; newCapacity) {
            poll();
        }
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">offer</span><span class="hljs-params">(E e)</span> {
        <span class="hljs-comment">// 动态判断是否接受新任务</span>
        <span class="hljs-keyword">if</span> (size() &gt;= capacity) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.offer(e);
    }
}
</code></pre>
<h3 data-id="heading-19">六、线程池监控方案</h3>
<h4 data-id="heading-20">6.1 监控指标体系</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolMonitor</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MeterRegistry meterRegistry;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitor</span><span class="hljs-params">(String poolName, ThreadPoolExecutor executor)</span> {
        <span class="hljs-comment">// 1. 核心指标</span>
        monitorCoreMetrics(poolName, executor);
        
        <span class="hljs-comment">// 2. 队列指标</span>
        monitorQueueMetrics(poolName, executor);
        
        <span class="hljs-comment">// 3. 任务执行指标</span>
        monitorTaskMetrics(poolName, executor);
        
        <span class="hljs-comment">// 4. 线程状态指标</span>
        monitorThreadMetrics(poolName, executor);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorCoreMetrics</span><span class="hljs-params">(String poolName, 
                                    ThreadPoolExecutor executor)</span> {
        <span class="hljs-comment">// 线程数指标</span>
        Gauge.builder(<span class="hljs-string">"threadpool.core.size"</span>, 
                     executor, ThreadPoolExecutor::getCorePoolSize)
            .tag(<span class="hljs-string">"pool"</span>, poolName)
            .register(meterRegistry);
            
        Gauge.builder(<span class="hljs-string">"threadpool.active.count"</span>,
                     executor, ThreadPoolExecutor::getActiveCount)
            .tag(<span class="hljs-string">"pool"</span>, poolName)
            .register(meterRegistry);
            
        Gauge.builder(<span class="hljs-string">"threadpool.largest.pool.size"</span>,
                     executor, ThreadPoolExecutor::getLargestPoolSize)
            .tag(<span class="hljs-string">"pool"</span>, poolName)
            .register(meterRegistry);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorQueueMetrics</span><span class="hljs-params">(String poolName,
                                     ThreadPoolExecutor executor)</span> {
        BlockingQueue&lt;Runnable&gt; queue = executor.getQueue();
        
        Gauge.builder(<span class="hljs-string">"threadpool.queue.size"</span>,
                     queue, BlockingQueue::size)
            .tag(<span class="hljs-string">"pool"</span>, poolName)
            .register(meterRegistry);
            
        Gauge.builder(<span class="hljs-string">"threadpool.queue.remaining"</span>,
                     queue, q -&gt; q.remainingCapacity())
            .tag(<span class="hljs-string">"pool"</span>, poolName)
            .register(meterRegistry);
    }
}
</code></pre>
<h4 data-id="heading-21">6.2 可视化监控面板（Grafana）</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"panels"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"线程池状态"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"targets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"expr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"threadpool_active_count{pool=\"$pool\"}"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"legendFormat"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"活跃线程"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"expr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"threadpool_core_size{pool=\"$pool\"}"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"legendFormat"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"核心线程"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"expr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"threadpool_max_size{pool=\"$pool\"}"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"legendFormat"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"最大线程"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"队列监控"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"targets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"expr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"threadpool_queue_size{pool=\"$pool\"}"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"legendFormat"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"队列大小"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"expr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"threadpool_queue_remaining{pool=\"$pool\"}"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"legendFormat"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"队列剩余容量"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-22">6.3 告警规则配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># alert-rules.yml</span>
<span class="hljs-attr">groups:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">threadpool_alerts</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">ThreadPoolQueueFull</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">threadpool_queue_remaining{pool="order-process"}</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">1m</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">"订单线程池队列已满"</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ $labels.pool }}</span>队列已满，持续1分钟"</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">ThreadPoolRejectedTasksHigh</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">rate(threadpool_rejected_tasks_total{pool="payment-callback"}[5m])</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">30s</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">"支付回调线程池拒绝任务过多"</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ $labels.pool }}</span>5分钟内拒绝任务超过10个"</span>
          
      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">ThreadPoolActiveThreadsHigh</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">threadpool_active_count{pool="report-generate"}</span> <span class="hljs-string">/</span> <span class="hljs-string">threadpool_max_size{pool="report-generate"}</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">0.8</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">2m</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">"报表生成线程池使用率过高"</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ $labels.pool }}</span>活跃线程数达到最大线程数的80%"</span>
</code></pre>
<h3 data-id="heading-23">七、常见问题与解决方案</h3>
<h4 data-id="heading-24">7.1 线程池中的线程异常怎么办？</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeThreadPoolExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ThreadPoolExecutor</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterExecute</span><span class="hljs-params">(Runnable r, Throwable t)</span> {
        <span class="hljs-built_in">super</span>.afterExecute(r, t);
        
        <span class="hljs-comment">// 处理未捕获异常</span>
        <span class="hljs-keyword">if</span> (t == <span class="hljs-literal">null</span> &amp;&amp; r <span class="hljs-keyword">instanceof</span> Future&lt;?&gt;) {
            <span class="hljs-keyword">try</span> {
                Future&lt;?&gt; future = (Future&lt;?&gt;) r;
                <span class="hljs-keyword">if</span> (future.isDone()) {
                    future.get();
                }
            } <span class="hljs-keyword">catch</span> (CancellationException ce) {
                t = ce;
            } <span class="hljs-keyword">catch</span> (ExecutionException ee) {
                t = ee.getCause();
            } <span class="hljs-keyword">catch</span> (InterruptedException ie) {
                Thread.currentThread().interrupt();
            }
        }
        
        <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 记录异常并采取恢复措施</span>
            log.error(<span class="hljs-string">"线程池任务执行异常"</span>, t);
            handleException(t);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleException</span><span class="hljs-params">(Throwable t)</span> {
        <span class="hljs-comment">// 1. 发送告警</span>
        alertSystem.send(t);
        
        <span class="hljs-comment">// 2. 重试机制</span>
        <span class="hljs-keyword">if</span> (canRetry(t)) {
            retryQueue.offer(currentTask);
        }
        
        <span class="hljs-comment">// 3. 降级处理</span>
        fallbackService.process(currentTask);
    }
}
</code></pre>
<h4 data-id="heading-25">7.2 如何优雅关闭线程池？</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolShutdownHandler</span> {
    
    <span class="hljs-meta">@PreDestroy</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdownAll</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. 拒绝新任务</span>
        threadPool.shutdown();
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 等待现有任务完成（最多等待30分钟）</span>
            <span class="hljs-keyword">if</span> (!threadPool.awaitTermination(<span class="hljs-number">30</span>, TimeUnit.MINUTES)) {
                <span class="hljs-comment">// 3. 强制关闭</span>
                List&lt;Runnable&gt; unfinishedTasks = 
                    threadPool.shutdownNow();
                
                <span class="hljs-comment">// 4. 处理未完成的任务</span>
                handleUnfinishedTasks(unfinishedTasks);
                
                <span class="hljs-comment">// 5. 再次等待</span>
                <span class="hljs-keyword">if</span> (!threadPool.awaitTermination(<span class="hljs-number">10</span>, TimeUnit.MINUTES)) {
                    log.error(<span class="hljs-string">"线程池无法正常关闭"</span>);
                }
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            <span class="hljs-comment">// 6. 重新中断</span>
            threadPool.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleUnfinishedTasks</span><span class="hljs-params">(List&lt;Runnable&gt; tasks)</span> {
        <span class="hljs-comment">// 持久化未完成任务</span>
        tasks.forEach(task -&gt; {
            <span class="hljs-keyword">if</span> (task <span class="hljs-keyword">instanceof</span> PersistableTask) {
                taskPersistenceService.save((PersistableTask) task);
            }
        });
    }
}
</code></pre>
<h3 data-id="heading-26">八、最佳实践总结</h3>
<h4 data-id="heading-27">8.1 线程池配置清单</h4>








































<table><thead><tr><th>配置项</th><th>推荐值</th><th>说明</th></tr></thead><tbody><tr><td>corePoolSize</td><td>CPU核心数+1～核心数*2</td><td>根据任务类型调整</td></tr><tr><td>maximumPoolSize</td><td>corePoolSize的2～4倍</td><td>为突发流量预留</td></tr><tr><td>keepAliveTime</td><td>30～60秒</td><td>避免频繁创建线程</td></tr><tr><td>workQueue</td><td>ArrayBlockingQueue</td><td>有界队列，防止OOM</td></tr><tr><td>threadFactory</td><td>自定义命名</td><td>方便问题排查</td></tr><tr><td>rejectedPolicy</td><td>CallerRunsPolicy</td><td>或自定义降级策略</td></tr></tbody></table>
<h4 data-id="heading-28">8.2 线程池使用"七不要"</h4>
<ol>
<li><strong>不要</strong>使用Executors的快捷方法</li>
<li><strong>不要</strong>使用无界队列（LinkedBlockingQueue默认无界）</li>
<li><strong>不要</strong>让任务抛出未捕获异常</li>
<li><strong>不要</strong>在任务中无限循环而不检查中断</li>
<li><strong>不要</strong>忘记关闭线程池</li>
<li><strong>不要</strong>所有业务共用一个线程池</li>
<li><strong>不要</strong>忽视线程池监控</li>
</ol>
<h4 data-id="heading-29">8.3 推荐的线程池工具类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolUtils</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, ExecutorService&gt; POOLS = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-comment">/**
     * 获取或创建线程池
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">getOrCreate</span><span class="hljs-params">(String poolName,
                                              Supplier&lt;ExecutorService&gt; creator)</span> {
        <span class="hljs-keyword">return</span> POOLS.computeIfAbsent(poolName, k -&gt; creator.get());
    }
    
    <span class="hljs-comment">/**
     * 安全执行任务
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; CompletableFuture&lt;T&gt; <span class="hljs-title function_">safeSubmit</span><span class="hljs-params">(
            ExecutorService executor, 
            Callable&lt;T&gt; task)</span> {
        CompletableFuture&lt;T&gt; future = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>&lt;&gt;();
        
        executor.submit(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> task.call();
                future.complete(result);
            } <span class="hljs-keyword">catch</span> (Throwable t) {
                future.completeExceptionally(t);
                log.error(<span class="hljs-string">"任务执行失败"</span>, t);
            }
        });
        
        <span class="hljs-keyword">return</span> future;
    }
    
    <span class="hljs-comment">/**
     * 优雅关闭所有线程池
     */</span>
    <span class="hljs-meta">@PreDestroy</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdownAll</span><span class="hljs-params">()</span> {
        POOLS.forEach((name, pool) -&gt; {
            <span class="hljs-keyword">try</span> {
                pool.shutdown();
                <span class="hljs-keyword">if</span> (!pool.awaitTermination(<span class="hljs-number">60</span>, TimeUnit.SECONDS)) {
                    pool.shutdownNow();
                }
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                pool.shutdownNow();
                Thread.currentThread().interrupt();
            }
        });
    }
}
</code></pre>
<h3 data-id="heading-30">九、进阶：虚拟线程（Java 21+）</h3>
<p>Java 21引入了虚拟线程，这是对线程模型的革命性改进：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建虚拟线程</span>
<span class="hljs-type">Thread</span> <span class="hljs-variable">virtualThread</span> <span class="hljs-operator">=</span> Thread.ofVirtual()
    .name(<span class="hljs-string">"virtual-thread-"</span>, <span class="hljs-number">0</span>)
    .start(() -&gt; {
        <span class="hljs-comment">// 任务逻辑</span>
    });

<span class="hljs-comment">// 使用虚拟线程的ExecutorService</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">virtualExecutor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor();

<span class="hljs-comment">// 性能对比：10万个任务</span>
<span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

<span class="hljs-comment">// 传统线程池：可能创建数千个平台线程</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">200</span>)) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100_000</span>; i++) {
        executor.submit(() -&gt; {
            Thread.sleep(<span class="hljs-number">100</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"done"</span>;
        });
    }
}

<span class="hljs-comment">// 虚拟线程：轻松处理</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100_000</span>; i++) {
        executor.submit(() -&gt; {
            Thread.sleep(<span class="hljs-number">100</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"done"</span>;
        });
    }
}
</code></pre>
<p>虚拟线程的优势：</p>
<ul>
<li><strong>轻量级</strong>：内存开销约2KB（平台线程约1MB）</li>
<li><strong>高并发</strong>：轻松支持数百万个虚拟线程</li>
<li><strong>兼容性</strong>：完全兼容现有Thread API</li>
</ul>
<h3 data-id="heading-31">总结</h3>
<p>线程池是Java并发编程的核心组件，正确使用线程池需要：</p>
<ol>
<li><strong>理解原理</strong>：掌握ThreadPoolExecutor的工作机制</li>
<li><strong>合理配置</strong>：根据业务场景选择合适的参数</li>
<li><strong>监控预警</strong>：建立完善的监控体系</li>
<li><strong>动态调整</strong>：根据负载情况动态调整参数</li>
<li><strong>优雅处理</strong>：做好异常处理和优雅关闭</li>
</ol>
<p>记住：没有万能的线程池配置，只有最适合你业务场景的配置。通过监控、分析和调整，不断优化你的线程池配置，才能构建出稳定高效的系统。</p>
<p>希望这篇文章能帮助你全面掌握线程池！如果有任何问题，欢迎随时讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么你的 SELECT 有时会阻塞？]]></title>    <link>https://juejin.cn/post/7592166340382064655</link>    <guid>https://juejin.cn/post/7592166340382064655</guid>    <pubDate>2026-01-07T08:49:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592166340382064655" data-draft-id="7592170171634614287" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么你的 SELECT 有时会阻塞？"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2026-01-07T08:49:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="邵伯"/> <meta itemprop="url" content="https://juejin.cn/user/1160695730942141"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么你的 SELECT 有时会阻塞？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1160695730942141/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    邵伯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:49:43.000Z" title="Wed Jan 07 2026 08:49:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>上篇「<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">插入意向锁</a>」时为了产生间隙锁、插入意向锁时使用了 'SELECT . . . FOR UPDATE'，
但你有没有想过：<strong>为什么有时候一个普通的 <code>SELECT</code> 不加锁，而加上 <code>FOR UPDATE</code> 就会阻塞别人？</strong>
我们就来进一步理解：<strong>快照读（Snapshot Read）</strong> 和 <strong>当前读（Current Read）</strong>。</p>
</blockquote>
<h2 data-id="heading-0">一、基本概念：MySQL 的两种“读”法</h2>
<p>在 Mysql 中，<strong>并非所有 <code>SELECT</code> 都一样</strong>。根据是否加锁、是否读最新数据，分为两类：</p>
<h3 data-id="heading-1">快照读（Snapshot Read）</h3>
<ul>
<li><strong>定义</strong>：读取事务开始时（或语句开始时）的一致性视图（Read View），<strong>不加任何锁</strong>。</li>
<li><strong>典型语句</strong>：</li>
</ul>
<pre><code class="hljs language-sql" lang="sql">  <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span>;
</code></pre>
<ul>
<li><strong>底层机制</strong>：基于 <strong>MVCC（多版本并发控制）</strong>，通过 undo log 构建历史版本。</li>
<li><strong>特点</strong>：
<ul>
<li>读不阻塞写，写不阻塞读；</li>
<li>在 RR 隔离级别下，整个事务看到同一快照（可重复读）；</li>
<li>在 RC 级别下，每次 SELECT 都生成新快照（不可重复读）。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">当前读（Current Read）</h3>
<ul>
<li><strong>定义</strong>：读取数据库中<strong>最新的、已提交的数据</strong>，并<strong>加锁</strong>以防止其他事务修改。</li>
<li><strong>典型语句</strong>：</li>
</ul>
<pre><code class="hljs language-sql" lang="sql">  <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;        <span class="hljs-comment">-- 排他锁</span>
  <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> LOCK <span class="hljs-keyword">IN</span> SHARE MODE; <span class="hljs-comment">-- 共享锁（MySQL 8.0+ 可用 FOR SHARE）</span>
  <span class="hljs-keyword">UPDATE</span> orders <span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'paid'</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">123</span>;
  <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">123</span>;
</code></pre>
<ul>
<li><strong>底层机制</strong>：直接访问聚簇索引或二级索引的最新记录，并根据隔离级别加 <strong>记录锁 / 间隙锁(RR) / Next-Key Lock</strong>。</li>
<li><strong>特点</strong>：
<ul>
<li>会阻塞其他写操作（甚至读操作，取决于锁类型）</li>
<li>是实现“悲观锁”和防止并发冲突的关键手段。</li>
</ul>
</li>
</ul>
<hr/>
<blockquote>
<p><strong>快照读 = 安静地看历史；当前读 = 大声宣布“我要改这里，请别动！”</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-3">二、使用场景：什么时候该用哪种读？</h2>
<h3 data-id="heading-4">场景 1：只读查询 → 用快照读</h3>
<ul>
<li>用户查看订单列表、商品详情等；</li>
<li>对数据一致性要求不高，或能接受“稍旧”数据；</li>
<li><strong>优势</strong>：零锁开销，高并发无压力。</li>
</ul>
<h3 data-id="heading-5">场景 2：先查后改（Check-Then-Act）→ 必须用当前读！</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码：错误示范（快照读）</span>
<span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> select(<span class="hljs-string">"SELECT * FROM orders WHERE id = 123"</span>); <span class="hljs-comment">// 快照读</span>
<span class="hljs-keyword">if</span> (order.status == <span class="hljs-string">"unpaid"</span>) {
    update(<span class="hljs-string">"UPDATE orders SET status = 'paid' WHERE id = 123"</span>);
}
</code></pre>
<p>→ <strong>问题</strong>：两个线程同时执行，都看到 <code>status=unpaid</code>，导致重复支付！</p>
<p>正确做法（当前读）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 加锁读取最新状态（仅用来体现当前读的作用，高并发场景下不建议使用 FOR UPDATE）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">123</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;
<span class="hljs-comment">-- 再判断并更新</span>
</code></pre>
<h3 data-id="heading-6">场景 3：防止幻读（RR 级别下）</h3>
<ul>
<li>业务要求“范围内不能有新数据插入”，如库存扣减、唯一编号生成；</li>
<li>必须用 <code>SELECT ... FOR UPDATE</code> 触发 <strong>Next-Key Lock（记录 + 间隙锁）</strong>；</li>
<li>否则即使快照读看不到新数据，别人仍可插入，破坏业务逻辑。</li>
</ul>
<hr/>
<h2 data-id="heading-7">三、避坑指南</h2>
<h3 data-id="heading-8">问题 1：<code>FOR UPDATE</code> 导致大量阻塞甚至死锁</h3>
<ul>
<li><strong>原因</strong>：范围查询未走索引，InnoDB 在 RR 下对主键全表加间隙锁；</li>
<li><strong>案例</strong>：</li>
</ul>
<pre><code class="hljs language-sql" lang="sql">  <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> create_time <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2024-01-01'</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>; <span class="hljs-comment">-- create_time 无索引</span>
</code></pre>
<p>→ 锁住整个表，所有 INSERT 被阻塞！
<strong>解决方案</strong>：</p>
<ul>
<li>确保 <code>WHERE</code> 条件命中索引；</li>
<li>高并发场景考虑降级到 <strong>READ COMMITTED</strong>（只加记录锁，不加间隙锁）；</li>
<li>避免大范围扫描，改用分页或等值查询。</li>
</ul>
<hr/>
<h3 data-id="heading-9">问题 2：快照读 + 当前读混合，误判“幻读”</h3>
<ul>
<li><strong>现象</strong>：</li>
</ul>
<pre><code class="hljs language-SQL" lang="SQL">  <span class="hljs-comment">-- 事务内</span>
  <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> t <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span>;               <span class="hljs-comment">-- 快照读，返回 0</span>
  <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> t <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;   <span class="hljs-comment">-- 当前读，返回 1！</span>
</code></pre>
<ul>
<li><strong>误解</strong>：“RR 下怎么还有幻读？”</li>
<li><strong>真相</strong>：这不是幻读！快照读看历史，当前读看现在，两者本就不该一致。</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>统一读取模式：要么全用快照读（接受只读一致性），要么关键路径全用当前读；</li>
<li>不要用快照读做业务判断后再用当前读更新。</li>
</ul>
<hr/>
<h3 data-id="heading-10">问题 3：RC 级别下 <code>FOR UPDATE</code> 无法防止幻读</h3>
<ul>
<li><strong>现象</strong>：在 RC 下，即使用了 <code>FOR UPDATE</code>，别人仍可插入新数据；</li>
<li><strong>原因</strong>：RC 不使用间隙锁，只锁已有记录；</li>
<li><strong>影响</strong>：如“查无此用户 → 插入”可能失败（唯一键冲突）。</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>依赖 <strong>数据库唯一索引</strong> 作为最终兜底；</li>
<li>应用层做好异常捕获与重试（如捕获 <code>Duplicate entry</code>）；</li>
<li>核心链路若需强一致性，保留 RR + 精准加锁。</li>
</ul>
<hr/>
<p>快照读和当前读，是 InnoDB 实现高性能与一致性平衡的双翼。</p>
<ul>
<li><strong>快照读</strong> 让读操作如丝般顺滑；</li>
<li><strong>当前读</strong> 为写操作筑起安全防线。</li>
</ul>
<p>但在实际开发中，<strong>最大的风险不是技术本身，而是“不知道自己在用哪种读”</strong>。</p>
<p>下次当你写下 <code>SELECT</code> 时，不妨多想一步 <strong>“我需要的是历史快照，还是此刻的真实？”</strong></p>
<hr/>
<blockquote>
<p>💡 <strong>感谢你看完这篇内容，这是我自己在工作学习中遇到的case，做一些简单的研究，并总结经验，如有遗漏或不合理的地方，欢迎你提出问题，让我们一起探索</strong>。</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[聊聊那个让 React 新手抓狂的“闭包陷阱”：Count 为什么永远是 0？]]></title>    <link>https://juejin.cn/post/7592340733954162738</link>    <guid>https://juejin.cn/post/7592340733954162738</guid>    <pubDate>2026-01-07T08:48:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592340733954162738" data-draft-id="7592340733954113586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="聊聊那个让 React 新手抓狂的“闭包陷阱”：Count 为什么永远是 0？"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2026-01-07T08:48:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白兰地空瓶"/> <meta itemprop="url" content="https://juejin.cn/user/191753514127514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            聊聊那个让 React 新手抓狂的“闭包陷阱”：Count 为什么永远是 0？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/191753514127514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白兰地空瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:48:20.000Z" title="Wed Jan 07 2026 08:48:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>写 React Hooks 的时候，你有没有遇到过这种“灵异事件”：</p>
<p>明明天在这个组件里 <code>setCount</code> 已经加到飞起了，界面上的数字也在跳动，但是 <code>setInterval</code> 或者是 <code>useEffect</code> 里的 console.log 打印出来的，却永远是初始值 <code>0</code>？</p>
<p>这时候你会怀疑人生：“是我眼花了，还是 React 坏了？”</p>
<p>其实 React 没坏，你只是掉进了**“闭包陷阱” (Stale Closure)**。今天咱们就借一段简单的代码，扒一扒这个坑的底裤，顺便看看怎么优雅地爬出来。</p>
<h2 data-id="heading-0">案发现场：诡异的“时间冻结”</h2>
<p>让我们先看看这段经典的“受害者”代码。这是很多同学（包括刚开始写 Hooks 的我）都会写出的逻辑：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// ❌ 这是一个典型的闭包陷阱现场</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 这里的 count 永远是 0，仿佛时间被冻结了</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Current count:'</span>, count); 
    }, <span class="hljs-number">1000</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
  }, []); <span class="hljs-comment">// 👈 罪魁祸首在这里：空依赖数组</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;count + 1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-1">现象描述</h3>
<p>当你运行这段代码，点击按钮让 <code>count</code> 增加时：</p>
<ol>
<li><strong>界面（UI）</strong> ：显示 <code>1, 2, 3...</code> （正常更新，说明 State 确实变了）。</li>
<li><strong>控制台（Console）</strong> ：<code>Current count: 0</code> ... <code>Current count: 0</code> ... （像复读机一样）。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8787fa35fdb0442595788b6adc9c1aba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95YWw5Zyw56m655O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380500&amp;x-signature=2HcvO1aNigeoTCwI%2BESR24eYbuI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">为什么会这样？</h2>
<p>要理解这个问题，首先要修正一个心智模型：<strong>每一次渲染（Render），都是一次独立的“快照”。</strong></p>
<ol>
<li>
<p><strong>第一次渲染 (Mount)</strong> ：</p>
<ul>
<li>React 创建了组件，此时 <code>count = 0</code>。</li>
<li><code>useEffect</code> 执行。因为它依赖是 <code>[]</code>，所以它<strong>只在第一次渲染时执行</strong>。</li>
<li><code>setInterval</code> 被创建。<strong>关键点来了：</strong> 这个定时器的回调函数是在 <code>count</code> 为 <code>0</code> 的那个闭包作用域里定义的。它捕获了那一刻的 <code>count</code>（也就是 0）。</li>
</ul>
</li>
<li>
<p><strong>第二次渲染 (点击按钮后)</strong> ：</p>
<ul>
<li>React 再次执行组件函数，<code>count</code> 变成了 <code>1</code>。</li>
<li><strong>但是！</strong> <code>useEffect</code> 的依赖数组是空的，React 认为“没必要重新运行这个 Effect”。</li>
<li>于是，那个<strong>旧的</strong>定时器（Mount 时创建的）依然在坚强地活着。它手里紧紧攥着的，依然是第一次渲染时的旧变量 <code>0</code>。</li>
</ul>
</li>
</ol>
<p><strong>简单来说：你的组件 UI 已经活在 2026 年了，但那个定时器还活在 2023 年，它根本不知道外面的世界变了。这就是 JS 词法作用域与 React Hooks 机制碰撞出的“火花”。</strong></p>
<hr/>
<h2 data-id="heading-3">怎么爬出陷阱？</h2>
<p>既然知道了是因为“引用了旧变量”，那想要实现如下图片效果，思路就很清晰了：<strong>要么让 Effect 重新执行，要么用某种方式穿透闭包。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/751012036d0f41d1bc7915dc62a74560~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m95YWw5Zyw56m655O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380500&amp;x-signature=PblHcTKo%2BqkdwP%2F4iFhuHJlF9%2Bs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">方法一：诚实地告诉 React 你的依赖（官方推荐）</h3>
<p>这就是修复后的代码逻辑，也是最符合 React 数据流直觉的写法：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ✅ 此时能读到最新的 count</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Current count:'</span>, count);
  }, <span class="hljs-number">1000</span>);

  <span class="hljs-comment">// 每次 effect 重新执行之前 都会执行上一次的清理函数</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
}, [count]); <span class="hljs-comment">// 👈 把 count 加入依赖数组</span>
</code></pre>
<p><strong>原理分析：</strong> 一旦把 <code>[count]</code> 加入依赖数组，逻辑就变了：</p>
<ol>
<li><code>count</code> 变了 -&gt; <code>useEffect</code> 发现依赖变了。</li>
<li>React 先执行 <code>cleanup</code> 函数（<code>clearInterval</code>），杀掉旧的定时器。</li>
<li>React 执行新的 <code>useEffect</code>，创建一个<strong>新</strong>的定时器。</li>
<li>这个<strong>新</strong>定时器是在当前渲染闭包里创建的，所以它捕获的是<strong>最新</strong>的 <code>count</code>。</li>
</ol>
<p><strong>潜在问题：</strong> 虽然 Bug 修好了，但带来了<strong>性能抖动</strong>。如果 <code>count</code> 变化很快（比如动画），定时器会被频繁地 <code>创建 -&gt; 销毁 -&gt; 创建</code>。如果定时器间隔很短，这可能会导致计时不准。</p>
<hr/>
<h3 data-id="heading-5">方法二：函数式更新</h3>
<p>如果你只是想让 <code>count</code> 加 1，而不关心在 <code>setInterval</code> 里打印日志，可以用函数式更新：</p>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(() =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    <span class="hljs-comment">// ✅ prev 永远是 React 内部拿到的最新状态，不需要依赖 count</span>
    <span class="hljs-built_in">setCount</span>(prev =&gt; prev + <span class="hljs-number">1</span>); 
  }, <span class="hljs-number">1000</span>);
  return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
}, <span class="hljs-selector-attr">[]</span>); 
</code></pre>
<p>这能解决 UI 更新问题，但解决不了“在定时器里获取最新值打印”的问题。</p>
<hr/>
<h3 data-id="heading-6">方法三：终极大法 useRef</h3>
<p>如果你既不想让定时器频繁重启（保持依赖为 <code>[]</code>），又想在回调里拿到最新的值，<code>useRef</code> 是最佳选择。</p>
<p><strong>为什么？</strong> 因为 <code>useRef</code> 返回的 <code>ref</code> 对象在组件的整个生命周期内保持<strong>引用不变</strong>，但它的 <code>.current</code> 属性是<strong>可变</strong>的。这就像一个挂在墙上的白板，无论房间（闭包）怎么换，白板还是那一块，上面的字随时能改。</p>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 1. 创建一个 ref</span>
const countRef = <span class="hljs-built_in">useRef</span>(count);

<span class="hljs-comment">// 2. 每次渲染都把最新的 count 写入 ref</span>
<span class="hljs-comment">// 这一步确保 ref.current 永远是最新的</span>
countRef<span class="hljs-selector-class">.current</span> = count; 

<span class="hljs-built_in">useEffect</span>(() =&gt; {
  const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
    <span class="hljs-comment">// 3. ✅ 永远读取 ref 里的最新值</span>
    <span class="hljs-comment">// 这里的闭包引用的是 countRef 对象本身，这个对象是永远不变的</span>
    console<span class="hljs-selector-class">.log</span>('Current count:', countRef.current);
  }, <span class="hljs-number">1000</span>);

  return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
}, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// 👈 依赖依然是空，定时器稳如泰山，不会重启！</span>
</code></pre>
<p>这也是知名 Hooks 库 <code>ahooks</code> 中 <code>useInterval</code> 的核心实现原理。</p>
<hr/>
<h2 data-id="heading-7">总结</h2>
<p>React 闭包陷阱本质上是 <strong>JavaScript 闭包机制</strong> 与 <strong>React 声明式编程</strong> 之间的一种“沟通误会”。</p>
<ul>
<li><strong>陷阱成因</strong>：<code>useEffect</code>、<code>useCallback</code> 等 Hooks 的依赖数组写少了，导致内部函数引用了旧的渲染闭包中的变量。</li>
<li><strong>基础解法</strong>：补全依赖数组（但要注意副作用的频繁执行）。</li>
<li><strong>进阶解法</strong>：使用 <code>useRef</code> 作为“逃生舱”，在不重启 Effect 的情况下，透过闭包读取最新状态。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter自定义组件： 为横向列表自定义“进度条”式滚动指示器]]></title>    <link>https://juejin.cn/post/7592276645361319936</link>    <guid>https://juejin.cn/post/7592276645361319936</guid>    <pubDate>2026-01-07T08:51:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592276645361319936" data-draft-id="7592152007840399360" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter自定义组件： 为横向列表自定义“进度条”式滚动指示器"/> <meta itemprop="keywords" content="Flutter,Dart,前端"/> <meta itemprop="datePublished" content="2026-01-07T08:51:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="儿歌八万首"/> <meta itemprop="url" content="https://juejin.cn/user/3034307822894333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter自定义组件： 为横向列表自定义“进度条”式滚动指示器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3034307822894333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    儿歌八万首
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:51:15.000Z" title="Wed Jan 07 2026 08:51:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p> 之前写过一篇<a href="https://juejin.cn/post/7585751355593834515" target="_blank" title="https://juejin.cn/post/7585751355593834515">Android 自定义 View 实战：打造一个跟随滑动的丝滑指示器</a>，今天使用 Flutter 来实现一个相同的效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3138c3892d394de2a9a69ad84ee48b1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YS_5q2M5YWr5LiH6aaW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380675&amp;x-signature=3k%2FFEcZ2E9h4wRWEBiWYTifknX8%3D" alt="image.png" loading="lazy"/></p>
<p>本文将实现一个根据列表滚动动态偏移的自定义指示器。</p>
<h2 data-id="heading-0">1. 核心原理</h2>
<p>实现这个效果的关键在于：<strong>监听滚动事件，并计算滚动比例。</strong></p>
<ol>
<li><strong>监听滚动</strong>：使用 <code>NotificationListener&lt;ScrollNotification&gt;</code> 捕捉滚动进度。</li>
<li><strong>计算比例</strong>：<code>滚动比例 = 当前滚动偏移量 / 最大可滚动距离</code>。</li>
<li><strong>联动指示器</strong>：根据比例计算指示器“滑块”的位移。</li>
</ol>
<hr/>
<h2 data-id="heading-1">2. 准备工作</h2>
<p>我们需要一个基本的横向列表结构。这里建议使用 <code>SingleChildScrollView</code> 配合 <code>ScrollController</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">final</span> ScrollController _scrollController = ScrollController();
double _progress = <span class="hljs-number">0.0</span>; <span class="hljs-comment">// 存储滚动比例 (0.0 ~ 1.0)</span>
</code></pre>
<h2 data-id="heading-2">3. 实现步骤</h2>
<h3 data-id="heading-3">第一步：构建横向列表</h3>
<p>我们使用 <code>NotificationListener</code> 包裹滚动视图，在 <code>onNotification</code> 回调中计算进度。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">NotificationListener&lt;ScrollNotification&gt;(
  onNotification: (ScrollNotification notification) {
    <span class="hljs-comment">// 只有在滚动时才更新进度</span>
    <span class="hljs-keyword">if</span> (notification <span class="hljs-keyword">is</span> ScrollUpdateNotification) {
      setState(() {
        <span class="hljs-comment">// 计算滚动比例：当前位置 / 最大滚动范围</span>
        _progress = _scrollController.offset / _scrollController.position.maxScrollExtent;
        <span class="hljs-comment">// 确保进度在 0~1 之间</span>
        _progress = _progress.clamp(<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);
      });
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },
  child: SingleChildScrollView(
    controller: _scrollController,
    scrollDirection: Axis.horizontal,
    child: Row(
      children: List.generate(<span class="hljs-number">10</span>, (index) =&gt; _buildItem(index)),
    ),
  ),
)
</code></pre>
<h3 data-id="heading-4">第二步：自定义指示器组件</h3>
<p>指示器由两部分组成：<strong>底槽 (Track)</strong> 和 <strong>滑块 (Thumb)</strong> 。滑块的位置通过 <code>_progress</code> 动态计算。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Widget _buildIndicator() {
      <span class="hljs-keyword">const</span> double trackWidth = <span class="hljs-number">40.0</span>; <span class="hljs-comment">// 底槽宽度</span>
      <span class="hljs-keyword">const</span> double thumbWidth = <span class="hljs-number">20.0</span>; <span class="hljs-comment">// 滑块宽度</span>

      <span class="hljs-keyword">return</span> Container(
        width: trackWidth,
        height: <span class="hljs-number">4.0</span>,
        decoration: BoxDecoration(
          color: Colors.grey[<span class="hljs-number">300</span>], <span class="hljs-comment">// 底槽颜色</span>
          borderRadius: BorderRadius.circular(<span class="hljs-number">2.0</span>),
        ),
        child: Stack(
          children: [
            Positioned(
              <span class="hljs-comment">// 核心逻辑：计算滑块的左间距</span>
              <span class="hljs-comment">// 左间距 = 比例 * (底槽宽度 - 滑块宽度)</span>
              left: _progress * (trackWidth - thumbWidth),
              child: Container(
                width: thumbWidth,
                height: <span class="hljs-number">4.0</span>,
                decoration: BoxDecoration(
                  color: Colors.blue, <span class="hljs-comment">// 滑块颜色</span>
                  borderRadius: BorderRadius.circular(<span class="hljs-number">2.0</span>),
                ),
              ),
            ),
          ],
        ),
      );
    }
</code></pre>
<h2 data-id="heading-5">4. 完整代码示例</h2>
<p>下面是将上述逻辑整合后的一个完整 Widget 示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">  <span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomScrollIndicatorDemo</span> <span class="hljs-title">extends</span> <span class="hljs-title">StatefulWidget</span> {
      <span class="hljs-keyword">const</span> CustomScrollIndicatorDemo({<span class="hljs-keyword">super</span>.key});

      <span class="hljs-meta">@override</span>
      State&lt;CustomScrollIndicatorDemo&gt; createState() =&gt; _CustomScrollIndicatorDemoState();
    }

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">_CustomScrollIndicatorDemoState</span> <span class="hljs-title">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-type">CustomScrollIndicatorDemo</span>&gt; {
      <span class="hljs-keyword">final</span> ScrollController _scrollController = ScrollController();
      double _progress = <span class="hljs-number">0.0</span>;

      <span class="hljs-meta">@override</span>
      void dispose() {
        _scrollController.dispose();
        <span class="hljs-keyword">super</span>.dispose();
      }

      <span class="hljs-meta">@override</span>
      Widget build(BuildContext context) {
        <span class="hljs-keyword">return</span> Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            <span class="hljs-comment">// 1. 列表部分</span>
            SizedBox(
              height: <span class="hljs-number">100</span>,
              child: NotificationListener&lt;ScrollNotification&gt;(
                onNotification: (notification) {
                  <span class="hljs-keyword">if</span> (notification <span class="hljs-keyword">is</span> ScrollUpdateNotification) {
                    setState(() {
                      <span class="hljs-comment">// 计算滚动比例</span>
                      <span class="hljs-keyword">if</span> (_scrollController.hasClients) {
                        _progress = _scrollController.offset / 
                                   _scrollController.position.maxScrollExtent;
                        _progress = _progress.clamp(<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);
                      }
                    });
                  }
                  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                },
                child: SingleChildScrollView(
                  controller: _scrollController,
                  scrollDirection: Axis.horizontal,
                  padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="hljs-number">16</span>),
                  child: Row(
                    children: List.generate(<span class="hljs-number">10</span>, (index) =&gt; _buildItem(index)),
                  ),
                ),
              ),
            ),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">12</span>),
            <span class="hljs-comment">// 2. 指示器部分</span>
            _buildIndicator(),
          ],
        );
      }

      <span class="hljs-comment">// 模拟列表项</span>
      Widget _buildItem(int index) {
        <span class="hljs-keyword">return</span> Container(
          width: <span class="hljs-number">60</span>,
          margin: <span class="hljs-keyword">const</span> EdgeInsets.only(right: <span class="hljs-number">20</span>),
          child: Column(
            children: [
              Container(
                width: <span class="hljs-number">50</span>,
                height: <span class="hljs-number">50</span>,
                decoration: BoxDecoration(
                  color: Colors.blue[<span class="hljs-number">50</span>],
                  borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
                ),
                child: Icon(Icons.category, color: Colors.blue[<span class="hljs-number">400</span>]),
              ),
              <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
              Text(<span class="hljs-string">'分类 $index'</span>, style: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">12</span>)),
            ],
          ),
        );
      }

      <span class="hljs-comment">// 构建指示器</span>
      Widget _buildIndicator() {
        <span class="hljs-keyword">return</span> Container(
          width: <span class="hljs-number">40</span>,
          height: <span class="hljs-number">4</span>,
          decoration: BoxDecoration(
            color: Colors.black12,
            borderRadius: BorderRadius.circular(<span class="hljs-number">2</span>),
          ),
          alignment: Alignment.centerLeft,
          child: FractionallySizedBox(
            widthFactor: <span class="hljs-number">1.0</span>, <span class="hljs-comment">// 占满父容器，配合下面的布局</span>
            child: Stack(
              children: [
                Positioned(
                  left: _progress * (<span class="hljs-number">40</span> - <span class="hljs-number">20</span>), <span class="hljs-comment">// 40是总宽，20是滑块宽</span>
                  child: Container(
                    width: <span class="hljs-number">20</span>,
                    height: <span class="hljs-number">4</span>,
                    decoration: BoxDecoration(
                      color: Colors.blue,
                      borderRadius: BorderRadius.circular(<span class="hljs-number">2</span>),
                    ),
                  ),
                ),
              ],
            ),
          ),
        );
      }
    }

</code></pre>
<h2 data-id="heading-6">5. 优化建议</h2>
<ol>
<li><strong>动态计算滑块宽度</strong>：如果你的列表项数量是动态的，你可以根据 <code>viewportDimension / contentDimension</code> 的比例来动态设置滑块宽度，这样指示器的体验会更接近原生滚动条。</li>
<li><strong>缓动动画</strong>：如果你希望指示器移动更丝滑，可以考虑使用 <code>AnimatedPositioned</code> 配合较短的动画时间，或者直接使用 <code>CustomPainter</code> 来绘制。</li>
<li><strong>封装组件</strong>：将这个逻辑封装成一个 <code>CustomScrollbar</code> 组件，方便在不同页面复用。</li>
</ol>
<h2 data-id="heading-7">总结</h2>
<p>通过 <code>NotificationListener</code> 结合 <code>ScrollController</code>，我们可以轻松获取滚动的实时进度。利用这个进度来驱动 <code>Stack</code> 中 <code>Positioned</code> 的位移，就能实现任何你想要的自定义指示器效果。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI地图 Tech说】第二期：一文解码百度地图ETA]]></title>    <link>https://juejin.cn/post/7592159803410284580</link>    <guid>https://juejin.cn/post/7592159803410284580</guid>    <pubDate>2026-01-07T08:01:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592159803410284580" data-draft-id="7592144524308987910" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI地图 Tech说】第二期：一文解码百度地图ETA"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-07T08:01:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="百度地图汽车版"/> <meta itemprop="url" content="https://juejin.cn/user/837165218019883"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI地图 Tech说】第二期：一文解码百度地图ETA
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/837165218019883/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    百度地图汽车版
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:01:44.000Z" title="Wed Jan 07 2026 08:01:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40e6e3290ae7481eaad6a8a02a3ae5cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5Zyw5Zu-5rG96L2m54mI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377704&amp;x-signature=bfmNesS6XhQF9hD22y8ibG1QZKs%3D" alt="image.png" loading="lazy"/>
你有没有这样的体验？导航说30分钟能到，结果真的一分不差？</p>
<p>有时候导航告诉你要绕行5分钟的路，其实省下了20分钟的堵车。</p>
<p>这些神奇的“预知能力”，就是我们常听到的ETA（Estimated Time of Arrival，预计到达时间），别看它们只是一个个数字，其实背后藏着一整套复杂又高效的技术体系。</p>
<p><strong/></p><p align="center"><strong>百度地图ETA</strong></p><p/>
<p><strong/></p><p align="center"><strong>到底是怎么精准计算出来的呢？</strong></p><p/>
<p><strong/></p><p align="center"><strong>【AI地图 Tech说】第二期将为你揭开奥秘！</strong></p><p/>
<h2 data-id="heading-0">一、基础介绍</h2>
<p>ETA预测的本质，就是给定出发地、目的地和出发时间后，预测驾车所需的时间。例如，当你在某个时间T请求路线（如Route = a→b→c→d→e）时，ETA系统便开始计算驾车预计行驶的时长。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cd7cff835cb4403adc80d520628ae00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5Zyw5Zu-5rG96L2m54mI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377704&amp;x-signature=J7I8NLH83OWfVWUQlvm2UMpaVuk%3D" alt="image.png" loading="lazy"/>
<strong>1.0时代：静态ETA（2010年前）</strong></p>
<p>最初，百度地图ETA功能的计算方式极为简单，仅通过距离除以限速得出。然而，这种方式计算出的结果误差常常超过30%，一旦遭遇交通拥堵状况，更是完全无法应对，由此引发了用户的诸多吐槽。</p>
<p><strong>2.0时代：动态ETA（2010-2015年）</strong></p>
<p>百度地图首次接入实时交通数据，能够识别实时拥堵路段并提供基本绕行建议。然而，这种方法仍无法预测拥堵的进一步变化趋势。</p>
<p><strong>3.0时代：个性化ETA（2015-2021年）</strong></p>
<p>通过引入机器学习与用户画像，百度地图开始分析驾驶习惯（如激进型或保守型司机）、车辆类型（如货车或新能源车），实现了针对不同人群的个性化路线推荐。</p>
<p><strong>4.0时代：预见性ETA（2021年至今）</strong></p>
<p>百度地图融入AI技术，如预训练大模型和时空预测技术，开始实现未来30-60分钟的精准路况预测，甚至能准确量化天气对行车速度的影响。</p>
<h2 data-id="heading-1">二、技术优势</h2>
<p>百度地图ETA为何如此精准？背后的核心在于预训练交通大模型与端到端路线通行时间预测两大技术。</p>
<p><strong>1</strong> <strong>）预训练交通大模型：海量AI知识集成体</strong></p>
<p>预训练交通大模型通过地图脱敏轨迹数据，建模城市交通规律，为智能交通提供底座能力。预训练交通大模型基于千亿公里驾驶数据，能够精准捕捉不同城市在时段、天气、区域上的交通规律，如北京周一比周五早高峰堵12%、上海雨天车速下降22%、深圳科技园晚高峰比早高峰堵35%。同时，该模型还具备持续学习优化能力，每天都会结合最新观察到的真实拥堵情况自动更新模型参数。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18c878979c064dd99387ddb59a8d2601~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5Zyw5Zu-5rG96L2m54mI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377704&amp;x-signature=DIoWHFd%2F4dQ4dZCeSm13aNdIdL8%3D" alt="image.png" loading="lazy"/>
预训练交通大模型的框架主要分为3个部分：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f73d671275344493b97fe428f586db6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5Zyw5Zu-5rG96L2m54mI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377704&amp;x-signature=uvGIeEzBqJvvvEW6Rack8dtJgLg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4084a2513888462db6bb90450c78fc56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5Zyw5Zu-5rG96L2m54mI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377704&amp;x-signature=ctcsqj8KTfWBASA5%2FdEPaQr1oV8%3D" alt="image.png" loading="lazy"/>
<strong>a.Large-Scale Traffic Corpus（大型交通语料数据）</strong></p>
<p>将原始的脱敏GPS轨迹点处理成路段粒度的交通时序信息和路线粒度的个性化导航行为。</p>
<p><strong>b.Pre-Train Model（预训练模型）</strong></p>
<p>基于历史交通大数据充分训练预训练模型，表征普适性的交通规律信息。</p>
<p><strong>c.Downstream Task（下游任务）</strong></p>
<p>基于预训练的交通图嵌入，通过Zero-Shot或者Fine-tune应用于通行时间预估、交通流量预估、路线排序、智能信控等场景。</p>
<p><strong>2）端到端路线通行时间预测：基于交通大模型FineTune的ETA-GNN AI仿真推演路线模型</strong></p>
<p>在预训练交通大模型基础上，百度地图进一步应用端到端路线通行时间预测，进行更细致的AI仿真推演，不再局限于逐路段的简单计算，而是精确模拟红绿灯等待时间、前方车辆汇入情况及施工路段的实际通行效率。同时通过动态概率模型实时评估，决策绕行还是等待，以达到最佳出行策略，预测准确率高达92%。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7af54c70a3a4422da8346ab8b41c9f56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5Zyw5Zu-5rG96L2m54mI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377704&amp;x-signature=GYumIbWb7q%2BVr371UGz29R%2B0bNE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0ad2fa490d04cb080dbe1faf190720b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5Zyw5Zu-5rG96L2m54mI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377704&amp;x-signature=FPIorzm3G7GI99xmE%2FP8MlY7SwM%3D" alt="image.png" loading="lazy"/></p>
<p>端到端路线预测体系涵盖以下核心能力：</p>
<p><strong>a.长时流量预测能力（Supervised FineTune）</strong></p>
<p>全天候预测能力：通过对历史流量数据的监督微调，模型可实现对未来 24小时路段流量变化趋势的精准预测，适用于节假日、景区周边等高动态场景。</p>
<p>零样本迁移泛化：预训练模型内置“早晚高峰模式库”，可直接迁移至新城市路网，实现冷启动场景下的预测精度显著提升。</p>
<p><strong>b.动态交通关系图谱建模</strong></p>
<p>时空图表示学习：捕捉交通流随时间与空间变化的普适规律。</p>
<p>路网级传播效应建模：通过图神经网络（GNN）结构，量化不同路段之间的流量传导影响，实现更高精度的区域级拥堵预测与调度模拟。</p>
<p><strong>c.地理语义位置编码（GeoEmbedding）</strong></p>
<p>多维地理语义融合：将传统经纬度转换为包含道路等级、POI密度、地形坡度等语义信息的向量表示。</p>
<p>跨模态建模能力：融合天气、热度等环境信息，实现对不同条件下相同路段的动态编码与差异化建模，例如“暴雨下立交桥”和“晴天立交桥”的通行效率差异。</p>
<p><strong>d.轨迹表示学习与个性化ETA</strong></p>
<p>行为建模：通过车辆历史脱敏的轨迹聚类，区分不同驾驶风格（如保守型 vs 效率型），提供分群精准ETA预测。</p>
<p>实时风格感知与动态修正：感知车辆当前驾驶状态（如频繁变道、急加速等），动态调整ETA和路径建议，实现个性化自适应路线仿真与推荐。</p>
<h2 data-id="heading-2">三、应用场景</h2>
<p>百度地图ETA广泛应用于各类场景中：</p>
<p>日常通勤：准确预测早晚高峰路况，帮助通勤族合理安排出行。</p>
<p>机场接送：精准判断当前出发是否能赶上航班，解决旅途焦虑。</p>
<p>重大活动预警：如演唱会结束前提前提醒车主提前离场，避免拥堵。</p>
<p>节假日旅游：提前预测旅游景区附近的拥堵趋势，提供更舒适的出游体验。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74d62d39e50e4b3ba42d2482e4fa3944~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5Zyw5Zu-5rG96L2m54mI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377704&amp;x-signature=M9uHB%2BJQLLL2lfsNfPIRFGdXKvU%3D" alt="image.png" loading="lazy"/></p>
<p>通过持续的技术进化和AI驱动的全面赋能，百度地图的ETA精准度在短途、长途、拥堵、节假日等多个场景均已显著领先行业水平，在用户感知层面更显稳健和准确。更值得一提的是，在节假日（尤其“五一”这类与日常规律差异显著的场景下），其表现尤为突出。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dec617335e148f6aa2be2a24af8f8bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m-5bqm5Zyw5Zu-5rG96L2m54mI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377704&amp;x-signature=TG0OTwY5fej7AB09EmvTLMwDNI8%3D" alt="image.png" loading="lazy"/></p>
<p><strong/></p><p align="center"><strong>出行从此告别盲目与焦虑</strong></p><p/>
<p><strong/></p><p align="center"><strong>百度地图将每一次的未知变成清晰的规划</strong></p><p/>
<p><strong/></p><p align="center"><strong>让用户安心出发，自信抵达！</strong></p><p/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌟从“抽卡式编程”到规范驱动： 深度解析「Vibe Coding」的三层跃迁]]></title>    <link>https://juejin.cn/post/7592170171634434063</link>    <guid>https://juejin.cn/post/7592170171634434063</guid>    <pubDate>2026-01-07T08:13:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592170171634434063" data-draft-id="7592170171634286607" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🌟从“抽卡式编程”到规范驱动： 深度解析「Vibe Coding」的三层跃迁"/> <meta itemprop="keywords" content="LLM,VibeCoding,微信小程序"/> <meta itemprop="datePublished" content="2026-01-07T08:13:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="栀秋666"/> <meta itemprop="url" content="https://juejin.cn/user/2566698322650307"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🌟从“抽卡式编程”到规范驱动： 深度解析「Vibe Coding」的三层跃迁
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2566698322650307/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    栀秋666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:13:35.000Z" title="Wed Jan 07 2026 08:13:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🌟从“抽卡式编程”到规范驱动： 深度解析「Vibe Coding」的三层跃迁</h2>
<hr/>
<p>在微信小程序生态中，“做一个计分器”这种需求看似轻如鸿毛——不就是加减分数、存个历史记录吗？但正是这类“小而美”的项目，成了检验AI编程成熟度的试金石。</p>
<p>我们曾幻想一句 <code>“帮我做个扑克计分小程序”</code> 就能一键生成可用代码；也曾陷入“改三天不如重写两天”的泥潭。直到一种全新的编程理念悄然崛起：<strong>Vibe Coding（氛围编程）</strong>。</p>
<p>这不是玄学，也不是摆拍晒屏的“氛围感”，而是一套<strong>以开发者意图为核心、AI为协作者、规范为契约的现代开发哲学</strong>。</p>
<p>今天，我们就以一个“手搓计分小程序”的真实演进路径，拆解 Vibe Coding 的三大阶段，见证它如何从“碰运气”走向“控流程”，最终实现 <strong>AI 驱动的工程化落地</strong>。</p>
<hr/>
<h3 data-id="heading-1">🧠 什么是 Vibe Coding？不是“写提示词”，而是“营造开发场域”</h3>
<p>很多人误解了 Vibe Coding —— 它不是简单地把需求丢给 AI 然后祈祷出好代码，也不是靠截图+emoji 装酷炫技。</p>
<p>真正的 <strong>Vibe Coding，是通过精准的语言、结构化的上下文和角色化指令，在人与AI之间构建一种“共情式协作”的开发氛围</strong>。</p>
<p>就像乐队指挥不需要亲自演奏每件乐器，却能让整个乐团奏出和谐乐章。<br/>
Vibe Coding 的本质，是<strong>让开发者成为“导演”而非“码农”</strong>，用“氛围”引导AI完成从理解→设计→编码→验证的全流程输出。</p>
<p>而这一过程，经历了三个关键跃迁：</p>
<blockquote>
<p>✅ 第一阶段：Prompt 抽卡 —— “试试看能不能中奖”<br/>
✅ 第二阶段：提示词工程化 —— “我学会怎么下注了”<br/>
✅ 第三阶段：规范驱动 + 多Agent协作 —— “我已经掌控牌局”</p>
</blockquote>
<p>让我们从一个真实的案例出发，层层深入。</p>
<hr/>
<h3 data-id="heading-2">🎲 阶段一：抽卡式编程 —— 当AI变成“随机代码生成器”</h3>
<h4 data-id="heading-3">场景还原：</h4>
<p>你打开 Cursor 或 Trae，输入：</p>
<blockquote>
<p>“用 Vue 写一个微信小程序，用来记录四人打扑克的得分。”</p>
</blockquote>
<p>几秒后，AI 返回了一堆代码：</p>
<ul>
<li>页面布局错乱</li>
<li>分数计算逻辑不符合本地翻倍规则</li>
<li>数据没持久化</li>
<li>甚至用了 React 的语法……</li>
</ul>
<p>你花了两小时 debug，最后发现还不如自己写。</p>
<p>这，就是典型的 <strong>“Prompt 抽卡”模式</strong>：把模糊需求扔进黑箱，期待开出 SSR 级别的代码 SSR（Super Super Rare），结果抽到一堆 N 卡。</p>
<h4 data-id="heading-4">问题根源在哪？</h4>
<ul>
<li>❌ 缺乏角色设定：AI 不知道自己该扮演谁</li>
<li>❌ 没有上下文约束：没有说明平台、技术栈、交互逻辑</li>
<li>❌ 输出无格式要求：返回的是碎片代码还是完整文件树？</li>
<li>❌ 忽视业务细节：“底分×翻倍”“庄家轮换”等规则未明确</li>
</ul>
<p>此时的 AI，就像一个天赋异禀但毫无纪律的新手程序员，<strong>能力强，但不可控</strong>。</p>
<blockquote>
<p>💡 <strong>Vibe Coding 启示录①：没有氛围的提示 = 没有灵魂的施工图</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-5">🛠️ 阶段二：提示词工程化 —— 开始建立“沟通契约”</h3>
<p>当你意识到不能靠“一句话玄学”时，你就进入了 Vibe Coding 的第二层境界：<strong>工程化表达</strong>。</p>
<p>不再说“做个计分器”，而是这样写提示词：</p>
<pre><code class="hljs language-text" lang="text">你是一位资深微信小程序前端工程师，擅长使用 WXML + WXSS + JavaScript 构建高性能原生应用。

请基于以下需求生成代码：
- 功能目标：支持4人扑克游戏计分，支持自定义底分、每局翻倍、更换庄家
- 核心功能：
  1. 玩家人数可配置（2~6人）
  2. 每局可录入胜负方及倍数，自动计算得分并累加总分
  3. 历史记录保存至本地缓存
  4. 界面适配移动端手势操作，按钮大小符合微信设计规范
- 技术要求：
  - 使用 ES6+ 语法
  - 页面结构为 pages/score/index
  - 样式采用类 TailwindCSS 的原子类命名方式（如 mt-4, flex-center）
  - 输出为完整的 .wxml + .wxss + .js 文件内容
- 输出格式：
  严格按照【文件名】→【代码】的方式组织，例如：
  【pages/score/index.wxml】
  &lt;view class="container"&gt;...&lt;/view&gt;
</code></pre>
<p>这个提示词的变化在于：</p>

























<table><thead><tr><th>维度</th><th>变化</th></tr></thead><tbody><tr><td>角色</td><td>明确为“小程序工程师”</td></tr><tr><td>上下文</td><td>包含业务规则和技术约束</td></tr><tr><td>结构</td><td>功能拆解 + 技术选型</td></tr><tr><td>输出控制</td><td>强制格式化，便于复制粘贴</td></tr></tbody></table>
<p>结果呢？AI 一次性生成了<strong>90%可用的代码</strong>，只需微调即可运行。</p>
<blockquote>
<p>✅ 成功的关键不再是“运气”，而是“表达力”。</p>
</blockquote>
<h4 data-id="heading-6">🌱 Vibe Coding 的进化意义</h4>
<p>这一阶段的核心突破是：<strong>开发者开始掌握“与AI对话的语言体系”</strong>。</p>
<p>你不再祈求奇迹，而是通过专业化、结构化的 prompt，建立起与AI之间的“沟通契约”。这种契约感，正是 Vibe Coding 的核心气质 —— <strong>不是命令机器，而是共同创作</strong>。</p>
<blockquote>
<p>💡 <strong>Vibe Coding 启示录②：好的提示词 = 给AI戴上耳机听清节奏</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-7">🚀 阶段三：SDD + 多Agent协作 —— 进入生产级 Vibe Coding 时代</h3>
<p>然而，即使提示词再精妙，单个 AI 工程师依然难以覆盖产品全链路。<br/>
真正的质变，发生在 <strong>SDD（Spec-Driven Development，规范驱动开发） + 多Agent协作</strong> 的融合之下。</p>
<p>这才是 Vibe Coding 的终极形态：<strong>一场由AI主演、人类导演的协同交响曲</strong>。</p>
<hr/>
<h4 data-id="heading-8">🎭 构建你的虚拟开发团队：多Agent协作架构</h4>
<p>想象一下，你要开发的不是一个静态页面，而是一个真正可上线的小程序。你需要：</p>





























<table><thead><tr><th>角色</th><th>职责</th></tr></thead><tbody><tr><td>虚拟产品经理</td><td>输出PRD，明确功能边界与优先级</td></tr><tr><td>虚拟UI设计师</td><td>产出高保真原型，符合小程序规范</td></tr><tr><td>虚拟前端工程师</td><td>实现交互逻辑与页面渲染</td></tr><tr><td>虚拟后端工程师</td><td>设计API接口与数据模型</td></tr><tr><td>虚拟测试工程师</td><td>编写测试用例，执行自动化验证</td></tr></tbody></table>
<p>现在，这一切都可以由 <strong>同一个大模型（如 Claude code 4.5 / Gemini 3 Pro）扮演不同角色</strong> 来完成。</p>
<p>所有环节围绕一份中心文档展开：<strong>规范说明书（Spec）</strong></p>
<p>Vibe Coding 不再是“人 + AI”的单打独斗，而是演变为一套<strong>多 Agent 协作的自动化开发流水线</strong>。<br/>
在真正写代码之前，先让 AI 扮演不同角色，按专业流程依次推进：</p>
<h5 data-id="heading-9">举个例子</h5>
<p>如果你要开发一个微信计分小程序：
我们需要在微信开发者工具中建立一个新项目</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/170fd9d0ca684fff8ab034e389c94d80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qCA56eLNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768378414&amp;x-signature=7k1Bz4dlL2i3QDIfl%2BnmvYgY9MI%3D" alt="image.png" loading="lazy"/></p>
<p>然后对拥有强能力的大模型如 Claude code 4.5 / Gemini 3 Pro等进行交流
（1）你是一个大师级的微信小程序产品经理，我现在需要你帮我把想法变成需求文档，用于给到AI编程工具进行实现</p>
<p>（2）我们需要先讨论一下需求，等确定了所有的需求，我们在进行第二步</p>
<p>（3）做一个微信小程序， 用于麻将或扑克的计分</p>
<p>经过一系列提问，LLM给出了他给出的需求文档</p>
<pre><code class="hljs language-markdown" lang="markdown">Role: Expert WeChat Mini Program Developer
Task: Create a standalone scoring Mini Program (offline-first).
Language: JavaScript (Native WeChat Framework), WXSS, WXML.
<span class="hljs-bullet">1.</span> Project Context (项目背景)
这是一个用于线下桌游（麻将、扑克）的通用记分工具。
核心逻辑：基于“零和游戏”规则（Zero-Sum Game），即每局所有玩家的得分之和必须为 0。
运行模式：单机版，无后端，所有数据存储在本地缓存（LocalStorage）。
用户：通常由其中一名玩家操作，记录所有人的分数。
<span class="hljs-bullet">2.</span> Tech Stack (技术栈约束)
Framework: Native WeChat Mini Program (原生开发).
Styling: Standard WXSS (Flexbox layout). Minimalistic design.
Storage: wx.setStorageSync / wx.getStorageSync.
Logic: No external dependencies. Pure JS logic.
<span class="hljs-bullet">3.</span> Data Schema (数据结构设计)
Please strict follow this JSON structure for LocalStorage key game<span class="hljs-emphasis">_history.
code
JSON
[
  {
    "id": "uuid_</span>v4<span class="hljs-emphasis">_string",          // 唯一牌局ID
    "name": "2023-10-01 欢乐麻将",    // 牌局名称
    "createTime": 1696123456789,     // 创建时间戳
    "playerCount": 4,                // 玩家人数 (2-6)
    "players": [                     // 玩家列表
      { "id": 0, "name": "张三", "totalScore": 10 },
      { "id": 1, "name": "李四", "totalScore": -5 },
      { "id": 2, "name": "王五", "totalScore": -5 },
      { "id": 3, "name": "赵六", "totalScore": 0 }
    ],
    "rounds": [                      // 对局记录流水
      {
        "roundId": 1,
        "timestamp": 1696123500000,
        "scores": [10, -5, -5, 0]    // 对应 players 数组索引的分数变化
      }
    ]
  }
]
4. Page Flow &amp; Requirements (页面逻辑)
Page 1: Home (首页 - 牌局列表)
UI:
Show list of saved games (Name + Date + Player names).
If list is empty, show a placeholder image + "Create New Game" button.
Floating Action Button (FAB): "+" to create a new game.
Interaction:
Click item -&gt; Go to Page 3 (Scoreboard).
Long press item -&gt; Option to Delete game.
Page 2: Create Game (新建牌局)
UI:
Input: "Game Name" (Default: Current Date + "Game").
Selector: "Player Count" (Range: 2 to 6, Default: 4).
Dynamic Inputs: "Player Names" based on count (Default: P1, P2, P3...).
Logic:
On "Start": Initialize the data structure and save to LocalStorage, then redirect to Page 3.
Page 3: Scoreboard (计分看板 - 核心页)
Header:
Grid layout showing current totalScore for each player.
Highlight the winner (highest score) in Red, loser in Green.
Body (List):
Reverse chronological list of rounds (Round 10, Round 9...).
Show specific score changes for that round (e.g., +10 | -5 | -5 | 0).
Delete Function: Allow deleting the last record only (to prevent logic errors).
Footer:
Large Button: "Record Round" -&gt; Opens Page 4.
Page 4: Input Score (记分录入)
UI:
List of players. Each row has: Player Name + Input Field (Number).
Auto-Balance Button: A button next to the last player or at the bottom.
Logic: Calculates 0 - (Sum of other players) and fills the remaining field.
Validation (Strict Zero-Sum):
Before saving, check: Sum(scores) === 0.
If Sum !== 0, show Toast error: "Total score must be 0! Current: +X".
Allow input of 0.
Save:
On success: Update players.totalScore, push to rounds, save to LocalStorage, go back to Page 3.
5. Edge Cases (异常处理)
Input Type: Ensure inputs handle negative numbers (keyboard type usually digit or number allowing -).
Empty Input: Treat empty input as 0.
Data Persistence: Update LocalStorage immediately after every round addition/deletion.
</span></code></pre>
<p>于是，我们通过虚拟产品经理得到了我们<strong>产品需求文档</strong></p>
<p>然后，打开你喜欢的 AI 编辑器（比如 <strong>Trae、Cursor</strong>），把刚才新建的空项目文件夹拖进去，把这份 需求文档 粘进去，让它开始生成代码</p>
<p>不出意外，你将获得了一个代码质量还不错的微信小程序</p>
<p>这便是<strong>vibe coding</strong> 的魅力之一</p>
<hr/>
<h4 data-id="heading-10">📜 什么是 SDD？先定规则，再写代码</h4>
<p>以登录功能为例，传统开发常因“我以为你是这么想的”导致返工。而在 SDD 模式下，一切以 <strong>唯一真理源（Single Source of Truth）</strong> 为准：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// spec/auth.login.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"endpoint"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"POST /auth/login"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户登录接口"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"request"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"username"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"password"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"response"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"token"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"expires_in"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"number"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"fail"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">401</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户名或密码错误"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">400</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"参数缺失"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"validation"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"需进行前后端双重校验"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>前端按此写请求逻辑，后端据此实现接口，测试据此编写断言。<br/>
<strong>所有人对齐的不是口头约定，而是这份 JSON 文档</strong>。</p>
<blockquote>
<p>✅ 当规范成为契约，AI 才能真正“履约式编程”。</p>
</blockquote>
<hr/>
<h4 data-id="heading-11">⚙️ 大模型如何支撑 SDD 落地？</h4>
<p>新一代大模型（如 Claude code 4.5、Gemini 3 Pro）具备三大能力，使 SDD 成为可能：</p>





















<table><thead><tr><th>能力</th><th>应用场景示例</th></tr></thead><tbody><tr><td><strong>任务分解能力</strong></td><td>将“做计分器”拆解为玩家管理、分数录入、规则引擎等模块</td></tr><tr><td><strong>跨角色推理能力</strong></td><td>同一模型切换身份：先当产品经理写PRD，再当工程师写代码</td></tr><tr><td><strong>长上下文记忆</strong></td><td>支持百万token上下文，保持全局一致性（如变量命名统一）</td></tr></tbody></table>
<p>这意味着：<strong>你只需提供初始意图，AI 自动帮你完成从0到1的系统设计</strong>。</p>
<hr/>
<h3 data-id="heading-12">🌈 Vibe Coding 的三层跃迁总结</h3>





































<table><thead><tr><th>层级</th><th>名称</th><th>核心特征</th><th>开发者角色</th><th>AI角色</th><th>是否可用于生产</th></tr></thead><tbody><tr><td>L1</td><td>抽卡式编程</td><td>一句话Prompt，结果随机</td><td>用户</td><td>随机生成器</td><td>❌</td></tr><tr><td>L2</td><td>提示词工程化</td><td>结构化Prompt，可控输出</td><td>导演</td><td>演员</td><td>✅（需人工审核）</td></tr><tr><td>L3</td><td>SDD + 多Agent</td><td>规范驱动，角色分工</td><td>总监制</td><td>全栈团队</td><td>✅✅✅（可直接部署）</td></tr></tbody></table>
<blockquote>
<p>🎯 <strong>Vibe Coding 的终极目标：让人专注于“定义价值”，让AI负责“实现价值”</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-13">🔮 未来已来：AI编程工程师的新能力模型</h3>
<p>随着 Vibe Coding 的普及，未来的开发者竞争力将发生根本性重构：</p>

























<table><thead><tr><th>旧能力</th><th>新能力</th></tr></thead><tbody><tr><td>手敲代码速度</td><td>定义规范的能力</td></tr><tr><td>记忆API文档</td><td>设计提示词的能力</td></tr><tr><td>Debug技巧</td><td>构建多Agent协作流程的能力</td></tr><tr><td>单兵作战</td><td>指挥AI团队协同的能力</td></tr></tbody></table>
<p>就像工业革命中，工人从手工纺纱转向操作机床，<strong>程序员也将从“写代码的人”进化为“创造开发流程的人”</strong>。</p>
<hr/>
<h3 data-id="heading-14">📣 写给每一位开发者的建议</h3>
<p>如果你还在用 AI “补一行少一行”，那你只看到了冰山一角。</p>
<p>真正的 Vibe Coding，是：</p>
<ul>
<li>在项目启动前，先让 AI 写 PRD；</li>
<li>在编码之前，先让 AI 出 Spec；</li>
<li>在测试之前，先让 AI 写用例；</li>
<li>最后再让 AI 写代码，并自动对比是否符合规范。</li>
</ul>
<p><strong>让 AI 不只是工具，而是贯穿 SDLC（软件开发生命周期）的协作伙伴</strong>。</p>
<p>哪怕只是一个“计分小程序”，也能跑通整套流程。下次接到类似需求时，不妨试试：</p>
<blockquote>
<p>“请你作为AI产品经理，为‘四人斗地主计分小程序’撰写一份详细PRD，包含功能列表、交互流程、数据规则和扩展性考虑。”</p>
</blockquote>
<p>你会发现，AI 不仅能给你答案，还能帮你<strong>提出更好的问题</strong>。</p>
<hr/>
<h3 data-id="heading-15">🏁 结语：从“手搓”到“流程驱动”，Vibe Coding 正在重塑开发本质</h3>
<p>我们曾以为 AI 是来抢饭碗的。<br/>
但现在明白：<strong>AI 不是替代者，而是放大器</strong>。</p>
<p>它放大的，是你对业务的理解、对系统的抽象、对协作的设计。</p>
<p>那个曾经需要一周才能交付的计分小程序，如今可以在 <strong>一个下午内，由你主导、AI执行、规范保障</strong> 完成交付。</p>
<p>而这，正是 <strong>Vibe Coding 的魅力所在</strong>：<br/>
它不追求炫技式的“秒出代码”，而是追求<strong>可持续、可复用、可规模化</strong>的智能开发新范式。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[超越Sora的开源思路：如何用预训练组件高效训练你的视频扩散模型？（附训练代码）]]></title>    <link>https://juejin.cn/post/7592148975848259627</link>    <guid>https://juejin.cn/post/7592148975848259627</guid>    <pubDate>2026-01-07T08:51:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592148975848259627" data-draft-id="7592134330313605163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="超越Sora的开源思路：如何用预训练组件高效训练你的视频扩散模型？（附训练代码）"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2026-01-07T08:51:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            超越Sora的开源思路：如何用预训练组件高效训练你的视频扩散模型？（附训练代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:51:22.000Z" title="Wed Jan 07 2026 08:51:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当我们开始思考3D数据或视频时，一个很自然的想法就是把它们视为一系列2D帧，然后通过简单地把时间作为额外维度来应用同样的模型。</p>
<p>从直觉上看，这种方法似乎可行，但实际上它很快会遇到瓶颈。随着输入变得更高维，模型通常需要变得更大才能表现良好。这导致内存使用增加、计算成本上升，训练也更难稳定，尤其是在GPU资源有限的情况下。</p>
<p>对于像视频生成这样的任务，这个问题变得更加严重。视频中的帧并不是独立的，它们在时间上紧密相连。由于这种强烈的时间依赖性，单一的生成模型很难同时学会物体的外观和运动方式。</p>
<p>在这篇文章中，将介绍隐式流扩散模型，这是一个为应对上述挑战而设计的两阶段框架。第一阶段专注于学习像素级的空间关系，而第二阶段则建模视频帧之间的时间依赖性。</p>
<p>到文章结尾，你将看到LFDM如何用于在MHAD数据集上进行条件式的图像到视频生成，并配有PyTorch的实战代码实现。</p>
<h2 data-id="heading-0"><strong>隐式流扩散模型的核心思想</strong></h2>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0314ce4d7822494f9ebfad7fd3c82e9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=K37b%2BDvrPnfi0bTyeXCWBlE8EX0%3D" alt="screenshot_2026-01-06_15-26-06.png" loading="lazy"/></p>
<p>正如前文提到的，视频之所以难以建模，是因为空间外观和时间运动高度纠缠。当扩散模型直接在像素空间逐帧生成视频时，结果往往不稳定，导致闪烁、物体形状扭曲或帧间突然不一致。</p>
<p>与其直接生成视频，LFDM采用了一种不同的策略：通过光流来建模运动。在第一阶段，模型被训练来预测源帧和目标帧之间的光流。然后，这个流被用来扭曲源帧，从而生成对应的目标帧。</p>
<p>给定一个源帧 x0，我们可以进一步训练一个扩散模型来生成一系列光流，例如 flow(x0, x1), flow(x0, x2)……通过用这些预测的流来扭曲同一个源帧 x0，就可以合成并组装出连贯的未来帧。</p>
<p>因为所有帧都是由同一张源图像变形生成的，空间结构保持一致，并且运动随时间演化更平滑。这使得扩散模型可以专注于学习运动动态，而非细节外观，让学习问题变得更简单，生成的视频也更稳定。</p>
<p>LFDM背后的另一个关键思想是：光流是在隐式空间而不是直接在像素级应用的。这显著降低了内存使用和计算成本。在我的实验中，源帧被缩放到128×128，并编码成32×32的隐式特征。模型预测一个流场来扭曲这个隐式表示，然后解码器将扭曲后的隐式表示重建为目标帧。</p>
<ul>
<li><strong>阶段一：隐式流自编码器</strong></li>
</ul>

<ul>
<li>训练一个自编码器，将源帧编码到隐式空间，并将经过流扭曲的隐式表示解码回图像。</li>
<li>训练一个流预测器，用于估计源帧和目标帧之间在隐式空间（32×32）的光流。</li>
</ul>

<ul>
<li><strong>阶段二：扩散模型</strong></li>
</ul>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5eab270f43bd4e5aa760f5a29c7307de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=fGxNFd8%2B76PEKTnLJO1PrGmFD90%3D" alt="screenshot_2026-01-06_15-29-10.png" loading="lazy"/></p>
<ul>
<li>使用第一阶段训练好的流预测器，从一个固定的源帧 x0 生成一系列隐式光流（如上图所示）。</li>
<li>使用扩散模型（或其他生成模型）来建模这个流序列的分布，并生成新的隐式流序列。</li>
</ul>

<ul>
<li><strong>光流与反向采样</strong></li>
</ul>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b69bc1d9b004119b49dccb3d0f667b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=jLEteBFUIW%2BJyEraZtGJ1aCHuFM%3D" alt="screenshot_2026-01-06_15-30-23.png" loading="lazy"/></p>
<p>在计算机视觉中，光流通过为每个像素估计一个2D位移向量，来描述两个连续图像帧 x0 和 x1 之间像素的表观运动。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cccdefe1852940d9882036da50d3cee9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=FQ%2ByjSNGwB1d0rWnZREN745CKyk%3D" alt="screenshot_2026-01-06_15-31-31.png" loading="lazy"/></p>
<p>流扭曲可以用上面的方程表示，其中 p = (x, y) 表示像素坐标，(u, v) 表示光流的水平和垂直分量。这个方程定义了一个像素级的映射，描述了源帧 x0 中的像素如何被移动到目标帧 x1 中，将每个在 (x, y) 的像素映射到 (x + u, y + v)。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e71dd42e3f2543cda885e6f631e4c3af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=7lUh594k8OPHnTxHS3%2FDhx5pzsU%3D" alt="screenshot_2026-01-06_15-32-07.png" loading="lazy"/></p>
<p>根据流动方向，扭曲可以分为前向扭曲和后向扭曲。前向扭曲使用流场将源帧的每个像素映射到目标帧，但有些像素可能会落在有效图像区域之外，导致缺失或未定义的区域（见A图）。而后向扭曲则指定每个目标像素如何从源帧采样，从而避免了这些缺失区域。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aed28923d7f34204ac3b7e8c568e2adc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=Ij4QOF%2B2nZGYNmSJ6rCvgnq4nBQ%3D" alt="screenshot_2026-01-06_15-32-22.png" loading="lazy"/></p>
<p>在LFDM中，我们选择后向扭曲，因为所有未来帧（x₁, x₂, ...）都是从同一个源帧（x₀）采样得到的，确保了跨时间的空间和外观一致性。此外，后向扭曲避免了目标帧中的缺失或未定义区域。</p>
<h2 data-id="heading-1"><strong>关节动画的运动表示</strong></h2>
<p>对于简单的运动，传统的光流方法（例如经典的或基于学习的方法）通常效果不错。然而，当运动变得更加复杂时——例如，当多个物体独立运动或发生关节式、非刚性的变形时——准确估计光流就变得困难得多。</p>
<p>因此，LFDM采用了基于MRAA的运动表示，它使用结构化的关键点位移来建模运动，并将它们聚合成一个密集的变形场。这种设计使得LFDM即使在复杂的运动场景下，也能以更稳定、更连贯的方式预测光流和遮挡图。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0306cd0de4f04e9fb2fdb7817b18f563~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=ir4VPvbqBdnYYrBdP2w%2BQNWXDhg%3D" alt="screenshot_2026-01-06_15-32-59.png" loading="lazy"/></p>
<p>MRAA背后的核心思想相当简单：它不试图一次性建模复杂的整体运动，而是将运动分解成几个较小的局部运动。每个部分被单独建模，然后所有这些局部运动被组合起来形成整体运动。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6e88f523e954da8b976714927729c81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=qicLinOV%2BZ9Rt7kY6cwIW6GxVfI%3D" alt="screenshot_2026-01-06_15-33-13.png" loading="lazy"/></p>
<p>例如，当一个人将手从低位举过头顶时，多个身体部位——如肩膀、上臂和前臂——会一起运动。MRAA不是直接估计一个单一的、全局的像素级运动场，而是对连续帧之间每个局部组件的相对运动进行建模，然后通过加权聚合将它们组合起来，产生最终的整体运动场（光流）。</p>
<ul>
<li><strong>MRAA的组成部分</strong></li>
</ul>

<ul>
<li><strong>区域预测器：</strong> 从输入图像中提取一组关键区域，每个区域代表一个局部运动组件。这些区域提供了参与运动的物体部件的结构化和紧凑表示。</li>
<li><strong>流预测器：</strong> 通过组合区域级运动，建模源帧和驱动帧之间的相对运动。它将运动聚合成一个密集的变形场以及一个遮挡图。</li>
<li><strong>生成器：</strong> 使用预测的流和遮挡图来扭曲源图像，以重建目标帧。通过重建损失，它实现了对有意义的、稳定的运动表示的端到端学习。</li>
<li><strong>背景运动预测器：</strong> 估计静态背景的全局运动，例如相机移动。</li>
</ul>
<p>注：遮挡图指示了由于帧间遮挡而变得不可见的区域，在这些区域，直接从源图像进行扭曲并不可靠。它允许模型在重建过程中降低这些区域的权重或忽略它们，从而防止伪影并提高时间一致性。</p>
<h2 data-id="heading-2"><strong>区域预测器</strong></h2>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34f6855fef7c49a8abda532c898c3cfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=%2Br0%2BuVYs%2FP6C%2FqLy9Asd5fV20L8%3D" alt="screenshot_2026-01-06_15-34-52.png" loading="lazy"/></p>
<p>区域预测器的目标是学习图像中多个区域的可微分局部表示。它使用一个U-Net来预测每个区域的软热图，以概率方式将像素分配到不同的区域。</p>
<p>从这些热图中，我们计算每个区域的中心和协方差：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7da4f119fde940f5883051b9388b0402~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=QzbzHxF4pV6rZaxFMVUTQbXwGYI%3D" alt="screenshot_2026-01-06_15-35-11.png" loading="lazy"/></p>
<p>基于这些一阶和二阶矩，我们进一步利用PCA推导出每个区域相对于规范坐标系的仿射表示。这些稀疏的、区域级的线索随后被流预测器用来建模密集的光流。</p>
<p>另一个细节是，流预测器在隐式空间运行，并预测一个空间分辨率低得多的光流，而不是直接在像素级。为了保持区域表示与这个隐式流对齐，我们在训练区域预测器时，将输入图像缩放到与隐式特征相同的分辨率。在我的实现中，128×128的图像被缩放到32×32作为模型输入。</p>
<pre><code class="hljs language-ini" lang="ini">class RegionPredictor(nn.Module):
    def __init__(self, <span class="hljs-attr">block_expansion</span>=<span class="hljs-number">32</span>, num_regions=<span class="hljs-number">10</span>, num_channels=<span class="hljs-number">3</span>, \
                 <span class="hljs-attr">max_features</span>=<span class="hljs-number">1024</span>, num_blocks=<span class="hljs-number">5</span>, temperature=<span class="hljs-number">0.1</span>, scale_factor=<span class="hljs-number">0.25</span>, pad=<span class="hljs-number">0</span>):
        super().__init__()
        <span class="hljs-attr">self.temperature</span> = temperature
        <span class="hljs-attr">self.scale_factor</span> = scale_factor
       
        <span class="hljs-attr">self.predictor</span> = Hourglass(
            block_expansion,
            <span class="hljs-attr">in_features</span>=num_channels,
            <span class="hljs-attr">max_features</span>=max_features,
            <span class="hljs-attr">num_blocks</span>=num_blocks
        )
        
        <span class="hljs-attr">self.regions</span> = nn.Conv2d(
            <span class="hljs-attr">in_channels</span>=self.predictor.out_filters,
            <span class="hljs-attr">out_channels</span>=num_regions,
            <span class="hljs-attr">kernel_size</span>=(<span class="hljs-number">7</span>, <span class="hljs-number">7</span>),
            <span class="hljs-attr">padding</span>=pad
        )
        
        <span class="hljs-comment"># Rescale 128 * 128 frame into 32 * 32</span>
        if self.scale_factor != 1:
            <span class="hljs-attr">self.down</span> = AntiAliasInterpolation2d(num_channels, self.scale_factor)
        else:
            <span class="hljs-attr">self.down</span> = None
    
    def _region_to_pca_params(self, region: torch.Tensor):
        <span class="hljs-comment"># region: (B, K, H, W) softmax heatmap</span>
        B, K, H, <span class="hljs-attr">W</span> = region.shape
        <span class="hljs-attr">grid</span> = make_coordinate_grid((H, W), region.dtype).to(region.device)
        <span class="hljs-attr">grid</span> = grid.unsqueeze(<span class="hljs-number">0</span>).unsqueeze(<span class="hljs-number">0</span>)
        
        <span class="hljs-comment"># mean/shift: (B, K, 2)   </span>
        <span class="hljs-attr">region_w</span> = region.unsqueeze(-<span class="hljs-number">1</span>)               
        <span class="hljs-attr">mean</span> = (region_w * grid).sum(dim=(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>))        
        
        <span class="hljs-comment"># covariance: (B, K, 2, 2)</span>
        <span class="hljs-attr">mean_sub</span> = grid - mean.unsqueeze(-<span class="hljs-number">2</span>).unsqueeze(-<span class="hljs-number">2</span>)
        <span class="hljs-attr">covar</span> = mean_sub.unsqueeze(-<span class="hljs-number">1</span>) * mean_sub.unsqueeze(-<span class="hljs-number">2</span>)  
        <span class="hljs-attr">covar</span> = covar * region.unsqueeze(-<span class="hljs-number">1</span>).unsqueeze(-<span class="hljs-number">1</span>)       
        <span class="hljs-attr">covar</span> = covar.sum(dim=(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>))
        <span class="hljs-attr">I</span> = torch.eye(<span class="hljs-number">2</span>, device=covar.device, dtype=covar.dtype).view(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)
        <span class="hljs-attr">covar</span> = covar + <span class="hljs-number">1</span>e-<span class="hljs-number">6</span> * I
        <span class="hljs-attr">covar</span> = <span class="hljs-number">0.5</span> * (covar + covar.transpose(-<span class="hljs-number">1</span>, -<span class="hljs-number">2</span>))
        
        <span class="hljs-comment"># SVD to get sqrt(covar) as "affine"</span>
        <span class="hljs-attr">covar_flat</span> = covar.view(-<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)           
        U, S, <span class="hljs-attr">Vh</span> = torch.linalg.svd(covar_flat, full_matrices=<span class="hljs-literal">False</span>)
        
        <span class="hljs-comment"># sqrt matrix: U * diag(sqrt(S))</span>
        <span class="hljs-attr">D</span> = torch.diag_embed(torch.sqrt(torch.clamp(S, min=<span class="hljs-number">1</span>e-<span class="hljs-number">6</span>))) 
        <span class="hljs-attr">sqrt</span> = U @ D                                               
        <span class="hljs-attr">sqrt</span> = sqrt.view(B, K, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)
        <span class="hljs-attr">U</span> = U.view(B, K, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)
        <span class="hljs-attr">D</span> = D.view(B, K, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)
        return {"shift": mean, "covar": covar, "affine": sqrt, "u": U, "d": D}
    
    def forward(self, x: torch.Tensor):
        <span class="hljs-comment"># x: (B, 3, H, W)</span>
        if self.down is not None:
            <span class="hljs-attr">x</span> = self.down(x)
        
        <span class="hljs-attr">feature_map</span> = self.predictor(x)
        <span class="hljs-attr">logits</span> = self.regions(feature_map)  <span class="hljs-comment"># (B, K, H, W)</span>
        B, K, H, <span class="hljs-attr">W</span> = logits.shape
        <span class="hljs-attr">region</span> = logits.view(B, K, -<span class="hljs-number">1</span>)
        <span class="hljs-attr">region</span> = F.softmax(region / self.temperature, dim=<span class="hljs-number">2</span>)
        <span class="hljs-attr">region</span> = region.view(B, K, H, W)
        
        <span class="hljs-attr">region_params</span> = self._region_to_pca_params(region)
        region_params<span class="hljs-section">["heatmap"]</span> = region
        return region_params
</code></pre>
<h2 data-id="heading-3"><strong>像素级流预测器</strong></h2>
<p>在区域预测器中，我们获得了每个区域的粗略的、区域级的运动信息。流预测器然后通过以下方程聚合这些区域级线索，合成一个密集的光流场：（其中A: 仿射矩阵，s: 区域中心，x: 像素坐标）</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67c24b152cb74232bef27a6777da1709~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=9mWHemDunVcc%2FcyQ6laBz1kVNCo%3D" alt="screenshot_2026-01-06_15-37-14.png" loading="lazy"/></p>
<p>思路很简单。我们首先通过 x - s_drv 移动像素坐标，使得一切都以驱动区域为中心。然后，我们使用驱动帧的逆仿射变换 A_drv^-1 将坐标带入一个规范空间。之后，我们应用源帧的仿射变换 A_src 将其映射回源姿态。最后，我们加上 s_src 得到用于后向扭曲的流网格。</p>
<pre><code class="hljs language-class" lang="class">    def __init__(self, block_expansion=64, num_blocks=5, max_features=1024, \
                 num_regions=10, num_channels=3, scale_factor=0.25):
        super().__init__()
        self.num_regions = num_regions
        self.scale_factor = scale_factor

        in_ch = (num_regions + 1) * (num_channels + 1)
        self.hourglass = Hourglass(
            block_expansion=block_expansion,
            in_features=in_ch,
            max_features=max_features,
            num_blocks=num_blocks,
        )
        self.mask = nn.Conv2d(self.hourglass.out_filters, num_regions + 1, kernel_size=7, padding=3)
        self.occlusion = nn.Conv2d(self.hourglass.out_filters, 1, kernel_size=7, padding=3)
        if self.scale_factor != 1:
            self.down = AntiAliasInterpolation2d(num_channels, self.scale_factor)
    
    def create_heatmap_representations(self, source_image, driving_region_params, source_region_params):
        spatial_size = source_image.shape[2:]  # (h, w)
        covar_d = driving_region_params["covar"]
        covar_s = source_region_params["covar"]
        
        gaussian_driving = region2gaussian(driving_region_params["shift"], covar=covar_d, spatial_size=spatial_size)
        gaussian_source = region2gaussian(source_region_params["shift"], covar=covar_s, spatial_size=spatial_size)
        heatmap = gaussian_driving - gaussian_source  # (B, K, H, W)
        # add background channel (zeros), can consider adding background feature
        zeros = torch.zeros(heatmap.size(0), 1, spatial_size[0], spatial_size[1],
                            device=heatmap.device, dtype=heatmap.dtype)
        heatmap = torch.cat([zeros, heatmap], dim=1)  # (B, K+1, H, W)
        return heatmap.unsqueeze(2)  # (B, K+1, 1, H, W)
    
    def create_sparse_motions(self, source_image, driving_region_params, source_region_params):
        bs, _, h, w = source_image.shape
        identity_grid = make_coordinate_grid((h, w), type=source_region_params["shift"].type())
        identity_grid = identity_grid.view(1, 1, h, w, 2)  # (1,1,H,W,2)
        # region-wise coords centered at driving shift
        coordinate_grid = identity_grid - driving_region_params["shift"].view(bs, self.num_regions, 1, 1, 2)
        
        affine = torch.matmul(source_region_params["affine"], torch.inverse(driving_region_params["affine"]))
        affine = affine * torch.sign(affine[:, :, 0:1, 0:1])
        affine = affine.unsqueeze(-3).unsqueeze(-3)             # (B,K,1,1,2,2)
        affine = affine.repeat(1, 1, h, w, 1, 1)                # (B,K,H,W,2,2)
        
        coordinate_grid = torch.matmul(affine, coordinate_grid.unsqueeze(-1)).squeeze(-1)  # (B,K,H,W,2)
        driving_to_source = coordinate_grid + source_region_params["shift"].view(bs, self.num_regions, 1, 1, 2)
        # background motion is always identity (no bg predictor)
        bg_grid = identity_grid.repeat(bs, 1, 1, 1, 1)  # (B,1,H,W,2)
        return torch.cat([bg_grid, driving_to_source], dim=1)
    
    def create_deformed_source_image(self, source_image, sparse_motions):
        bs, _, h, w = source_image.shape
        source_repeat = source_image.unsqueeze(1).unsqueeze(1).repeat(bs, self.num_regions + 1, 1, 1, 1, 1)
        source_repeat = source_repeat.view(bs * (self.num_regions + 1), -1, h, w)
        sparse_motions = sparse_motions.view(bs * (self.num_regions + 1), h, w, 2)
        sparse_deformed = F.grid_sample(source_repeat, sparse_motions)
        sparse_deformed = sparse_deformed.view(bs, self.num_regions + 1, -1, h, w)
        return sparse_deformed
    
    def forward(self, source_image, driving_region_params, source_region_params):
        if self.scale_factor != 1:
            source_image = self.down(source_image)
        bs, _, h, w = source_image.shape
        heatmap_representation = self.create_heatmap_representations(source_image, driving_region_params, source_region_params)
        sparse_motion = self.create_sparse_motions(source_image, driving_region_params, source_region_params) 
        deformed_source = self.create_deformed_source_image(source_image, sparse_motion) # (B, K+1, C, H, W)
        
        predictor_input = torch.cat([heatmap_representation, deformed_source], dim=2)    # (B, K+1, 1+C, H, W)
        predictor_input = predictor_input.view(bs, -1, h, w)
        prediction = self.hourglass(predictor_input)
        mask = F.softmax(self.mask(prediction), dim=1).unsqueeze(2)  # (B,K+1,1,H,W)
        
        sparse_motion = sparse_motion.permute(0, 1, 4, 2, 3)         # (B,K+1,2,H,W)
        deformation = (sparse_motion * mask).sum(dim=1).permute(0, 2, 3, 1)  # (B,H,W,2)
        out_dict = {"optical_flow": deformation}
        out_dict["occlusion_map"] = torch.sigmoid(self.occlusion(prediction))
        return out_dict
</code></pre>
<p>还使用一个U-Net来预测一个遮挡图。它告诉我们，对于每个像素，哪个区域的运动是可靠的。更重要的是，它让生成器知道哪些部分被遮挡了，无法通过扭曲获得，因此这些区域需要生成器自己来填充。</p>
<h2 data-id="heading-4"><strong>生成器与训练循环</strong></h2>
<p>最后，第一阶段训练的最后一个部分是生成器，它是一个基于自编码器的模型。它首先将源帧 x_s 编码成一个隐式表示 z_s。然后，这个隐式表示被光流扭曲，产生一个变形后的特征。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3e4c9daed374d3a86683ddf7cfaf563~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=szRGOVl%2B6nb9kUEtMM6OiNDlb7Q%3D" alt="screenshot_2026-01-06_15-37-50.png" loading="lazy"/></p>
<p>一个遮挡图 M 被用来混合变形后的隐式表示和原始隐式表示，指示哪些区域应该被信任，哪些需要被填充。解码器然后使用这个混合后的隐式表示来重建目标帧 x_t。</p>
<pre><code class="hljs language-ini" lang="ini">class Generator(nn.Module):
    def __init__(self, <span class="hljs-attr">num_channels</span>=<span class="hljs-number">3</span>, num_regions=<span class="hljs-number">10</span>, block_expansion=<span class="hljs-number">64</span>, max_features=<span class="hljs-number">512</span>,
                 <span class="hljs-attr">num_down_blocks</span>=<span class="hljs-number">2</span>, num_bottleneck_blocks=<span class="hljs-number">6</span>):   
        super().__init__()
        <span class="hljs-attr">self.first</span> = SameBlock2d(num_channels, block_expansion, kernel_size=(<span class="hljs-number">7</span>, <span class="hljs-number">7</span>), padding=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>)) 
        <span class="hljs-attr">down_blocks</span> = []
        <span class="hljs-attr">up_blocks</span> = []
        
        for i in range(num_down_blocks):
            <span class="hljs-attr">in_features</span>  = min(max_features, block_expansion * (<span class="hljs-number">2</span> ** i))
            <span class="hljs-attr">out_features</span> = min(max_features, block_expansion * (<span class="hljs-number">2</span> ** (i + <span class="hljs-number">1</span>)))
            down_blocks.append(DownBlock2d(in_features, out_features, <span class="hljs-attr">kernel_size</span>=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)))

        for i in range(num_down_blocks):
            <span class="hljs-attr">in_features</span>  = min(max_features, block_expansion * (<span class="hljs-number">2</span> ** (num_down_blocks - i)))
            <span class="hljs-attr">out_features</span> = min(max_features, block_expansion * (<span class="hljs-number">2</span> ** (num_down_blocks - i - <span class="hljs-number">1</span>)))
            up_blocks.append(UpBlock2d(in_features, out_features, <span class="hljs-attr">kernel_size</span>=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)))

        <span class="hljs-attr">self.down_blocks</span> = nn.ModuleList(down_blocks)
        <span class="hljs-attr">self.up_blocks</span> = nn.ModuleList(up_blocks)
        <span class="hljs-attr">in_features</span> = min(max_features, block_expansion * (<span class="hljs-number">2</span> ** num_down_blocks))
        
        <span class="hljs-attr">self.bottleneck</span> = nn.Sequential(*[
            ResBlock2d(in_features, kernel_size=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))
            for _ in range(num_bottleneck_blocks)
        ])
        <span class="hljs-attr">self.final</span> = nn.Conv2d(block_expansion, num_channels, kernel_size=(<span class="hljs-number">7</span>, <span class="hljs-number">7</span>), padding=(<span class="hljs-number">3</span>, <span class="hljs-number">3</span>))
        <span class="hljs-attr">self.num_channels</span> = num_channels
   
    @staticmethod
    def deform_input(inp, grid):
        <span class="hljs-comment"># grid: (B, H, W, 2) in normalized coords for grid_sample</span>
        b, c, h, <span class="hljs-attr">w</span> = inp.shape
        gh, <span class="hljs-attr">gw</span> = grid.shape[<span class="hljs-number">1</span>], grid.shape[<span class="hljs-number">2</span>]
        if (gh, gw) != (h, w):
            <span class="hljs-attr">grid</span> = grid.permute(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)  <span class="hljs-comment"># (B,2,H,W)</span>
            <span class="hljs-attr">grid</span> = F.interpolate(grid, size=(h, w), mode=<span class="hljs-string">'bilinear'</span>, align_corners=<span class="hljs-literal">True</span>)
            <span class="hljs-attr">grid</span> = grid.permute(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>)  <span class="hljs-comment"># (B,H,W,2)</span>
        return F.grid_sample(inp, grid, <span class="hljs-attr">align_corners</span>=<span class="hljs-literal">True</span>)
    
    def apply_optical(self, x_skip, x_prev, motion_params):
        if motion_params is None:
            return x_prev if x_prev is not None else x_skip
        <span class="hljs-attr">x</span> = self.deform_input(x_skip, motion_params[<span class="hljs-string">'optical_flow'</span>])
        <span class="hljs-attr">occ</span> = motion_params[<span class="hljs-string">'occlusion_map'</span>]
        if occ.shape<span class="hljs-section">[-2:]</span> != x.shape<span class="hljs-section">[-2:]</span>:
            <span class="hljs-attr">occ</span> = F.interpolate(occ, size=x.shape[-<span class="hljs-number">2</span>:], mode=<span class="hljs-string">'bilinear'</span>, align_corners=<span class="hljs-literal">True</span>)

        if x_prev is None:
            return x * occ
        return x * occ + x_prev * (1 - occ)
    
    def forward(self, source_image, motion_params):
        <span class="hljs-attr">out</span> = self.first(source_image)
        <span class="hljs-attr">skips</span> = [out]
        for block in self.down_blocks: <span class="hljs-comment"># Encoder</span>
            <span class="hljs-attr">out</span> = block(out)
            skips.append(out)
        
        <span class="hljs-attr">output_dict</span> = {
            "bottle_neck_feat": out,
            "deformed": self.deform_input(source_image, motion_params<span class="hljs-section">["optical_flow"]</span>),
            "optical_flow": motion_params<span class="hljs-section">["optical_flow"]</span>,
        }
        output_dict<span class="hljs-section">["occlusion_map"]</span> = motion_params<span class="hljs-section">["occlusion_map"]</span>
        <span class="hljs-attr">out</span> = self.apply_optical(x_skip=out, x_prev=None, motion_params=motion_params)
        <span class="hljs-attr">out</span> = self.bottleneck(out)
        
        for i, up in enumerate(self.up_blocks): <span class="hljs-comment"># Decoder</span>
            <span class="hljs-attr">out</span> = self.apply_optical(
                <span class="hljs-attr">x_skip</span>=skips[-(i + <span class="hljs-number">1</span>)],
                <span class="hljs-attr">x_prev</span>=out,
                <span class="hljs-attr">motion_params</span>=motion_params
            )
            <span class="hljs-attr">out</span> = up(out)
        <span class="hljs-attr">out</span> = torch.sigmoid(self.final(out))
        output_dict<span class="hljs-section">["prediction"]</span> = out
        return output_dict
    
    def compute_fea(self, source_image):
        <span class="hljs-attr">out</span> = self.first(source_image)
        for block in self.down_blocks:
            <span class="hljs-attr">out</span> = block(out)
        return out
</code></pre>
<ul>
<li><strong>UTD-MHAD数据集</strong></li>
</ul>
<p>在这个实现中，我使用UTD-MHAD数据集来训练模型的两个阶段。对于第一阶段，从同一个视频中随机采样两帧，一帧作为源帧，另一帧作为目标帧。对于第二阶段，随机选择一个视频，并提取一个连续的40帧序列作为模型输入。</p>
<pre><code class="hljs language-ini" lang="ini">from PIL import Image
from decord import VideoReader, cpu
class UTDDataset(Dataset):
    def __init__(self,
                 <span class="hljs-attr">root</span>=<span class="hljs-string">"/content/drive/MyDrive/LFDM_data"</span>,
                 <span class="hljs-attr">image_size</span>=<span class="hljs-number">128</span>,
                 <span class="hljs-attr">mode</span>=<span class="hljs-string">"stage1"</span>,
                 <span class="hljs-attr">clip_len</span>=<span class="hljs-number">40</span>):
        super().__init__()
        assert mode in <span class="hljs-section">["stage1", "stage2"]</span>
        
        <span class="hljs-attr">self.mode</span> = mode
        <span class="hljs-attr">self.clip_len</span> = clip_len
        <span class="hljs-attr">self.video_files</span> = sorted(glob(os.path.join(root, <span class="hljs-string">"**"</span>, <span class="hljs-string">"*.avi"</span>), recursive=<span class="hljs-literal">True</span>))
        
        <span class="hljs-attr">self.transform</span> = transforms.Compose([
            transforms.Resize((image_size, image_size)),
            transforms.ToTensor(),
        ])
    
    def __len__(self):
        return len(self.video_files)
    
    def __getitem__(self, idx):
        <span class="hljs-comment"># Stage 1: random (x0, xt)</span>
        if <span class="hljs-attr">self.mode</span> == <span class="hljs-string">"stage1"</span>:
            while True:
                <span class="hljs-attr">vid_path</span> = random.choice(self.video_files)
                <span class="hljs-attr">vr</span> = VideoReader(vid_path, ctx=cpu(<span class="hljs-number">0</span>))
                <span class="hljs-attr">n</span> = len(vr)
                if n &lt; 2:
                    continue
                
                i0, <span class="hljs-attr">i1</span> = sorted(random.sample(range(n), <span class="hljs-number">2</span>))
                <span class="hljs-attr">f0</span> = Image.fromarray(vr[i0].asnumpy())
                <span class="hljs-attr">f1</span> = Image.fromarray(vr[i1].asnumpy())
                <span class="hljs-attr">x0</span> = self.transform(f0)
                <span class="hljs-attr">xt</span> = self.transform(f1)
                return x0, xt
        
        <span class="hljs-comment"># Stage 2: clip + action</span>
        <span class="hljs-attr">vid_path</span> = self.video_files[idx]
        <span class="hljs-attr">vr</span> = VideoReader(vid_path, ctx=cpu(<span class="hljs-number">0</span>))
        <span class="hljs-attr">n</span> = len(vr)
        if <span class="hljs-attr">n</span> == <span class="hljs-number">0</span>:
            return self.__getitem__((idx + 1) % len(self.video_files))
        
        <span class="hljs-attr">K</span> = self.clip_len
        if n &gt;= K:
            <span class="hljs-attr">start</span> = random.randint(<span class="hljs-number">0</span>, n - K)
            <span class="hljs-attr">indices</span> = range(start, start + K)
        else:
            <span class="hljs-attr">indices</span> = sorted(random.choices(range(n), k=K))
        
        <span class="hljs-attr">frames</span> = []
        for i in indices:
            <span class="hljs-attr">img</span> = Image.fromarray(vr[i].asnumpy())
            frames.append(self.transform(img))
        
        <span class="hljs-attr">clip</span> = torch.stack(frames, dim=<span class="hljs-number">1</span>)  <span class="hljs-comment"># (C, K, H, W)</span>
        <span class="hljs-attr">video_name</span> = os.path.basename(vid_path)
        <span class="hljs-attr">action_idx</span> = int(video_name.split(<span class="hljs-string">"_"</span>)[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>:]) - <span class="hljs-number">1</span>  <span class="hljs-comment"># a01 -&gt; 0</span>
        return clip, action_idx
</code></pre>
<ul>
<li><strong>第一阶段训练循环</strong></li>
</ul>

<ul>
<li>从源帧 x0 和目标帧 xt 中提取区域信息。</li>
<li>使用流预测器预测光流和遮挡图。</li>
<li>用预测的运动扭曲源帧，并使用生成器重建目标帧 pred_xt。</li>
<li>测量重建帧与目标帧之间的感知损失。</li>
</ul>
<p>注：你也可以尝试应用一个等变性损失，这可以加强几何一致性，并提高学习到的运动表示的稳定性。</p>
<pre><code class="hljs language-def" lang="def">    x_vgg = vgg(pred)
    y_vgg = vgg(real)
    loss = 0.0
    for i, w in enumerate(per_weights):
        loss = loss + w * torch.abs(x_vgg[i] - y_vgg[i].detach()).mean()
    return loss

region_predictor = RegionPredictor().to(device)
flow_predictor = PixelwiseFlowPredictor().to(device)
generator = Generator().to(device)
total_iters   = 200000
save_interval = 20000

# You may use any pretrained VGG model.
# Here, we use the outputs of the last five layers to compute the perceptual loss.
vgg = Vgg19().to(device)
vgg.eval()  
for p in vgg.parameters():
    p.requires_grad_(False)

dataset = UTDDataset(mode="stage1", image_size=128)
dataloader = DataLoader(
    dataset, 
    batch_size=16, 
    shuffle=True, 
    pin_memory=True, 
    drop_last=True, 
    num_workers=4
)
optimizer = torch.optim.Adam(
    list(region_predictor.parameters()) +
    list(flow_predictor.parameters()) +
    list(generator.parameters()), 
    lr=5e-5, 
    betas=(0.5, 0.999)
)
data_iter = iter(dataloader)
pbar = trange(1, total_iters + 1, desc="Training", dynamic_ncols=True)

for it in pbar:
    try:
        x0, xt = next(data_iter)
    except StopIteration:
        data_iter = iter(dataloader)
        x0, xt = next(data_iter)
    
    x0, xt = x0.to(device, non_blocking=True), xt.to(device, non_blocking=True)
    source_region  = region_predictor(x0)
    driving_region = region_predictor(xt)
    motion = flow_predictor(x0, source_region_params=source_region, driving_region_params=driving_region)             
    generated = generator(x0, motion)
    pred = generated["prediction"]        
    real = xt
    
    perc = perceptual_loss(vgg, pred, real)
    optimizer.zero_grad(set_to_none=True)
    perc.backward()
    optimizer.step()
    
    # ---- save ----
    if it % save_interval == 0:
        ckpt = {
            "it": it,
            "region_predictor": region_predictor.state_dict(),
            "flow_predictor": flow_predictor.state_dict(),
            "generator": generator.state_dict(),
            "optimizer": optimizer.state_dict(),
        }
        torch.save(ckpt, f"stage1_ckpt_{it:06d}.pt")
</code></pre>
<h2 data-id="heading-5"><strong>LFDM第二阶段训练</strong></h2>
<p>终于到了最后一步。我们现在要做的事情很简单：训练一个生成模型，能够生成合理的隐式流序列，其形状为：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ddb1468248648038af2e759f4ef30dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=%2F%2Fszc%2Fq%2BfRXYEjPaT4xMtiewEBs%3D" alt="screenshot_2026-01-06_15-39-55.png" loading="lazy"/></p>
<p>到了这一步，大部分困难的工作已经完成了。使用MRAA风格的方法，我们已经分离了空间结构，并将原始图像压缩到了一个低维隐式空间。因此，模型不再需要关心外观——它只需要学习运动如何随时间演化。</p>
<p>我们现在可以将隐式流序列视为一个3D体积，并使用扩散模型来生成它。当然，扩散模型不是唯一的选择——整流流、Transformer或GANs在这里也能很好地工作。</p>
<p>注：在我的实现中，我使用了“修正流”而不是扩散模型，因为它更容易实现且收敛更快。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> ...
<span class="hljs-keyword">from</span> einops <span class="hljs-keyword">import</span> rearrange

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TemporalSelfAttention</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, dim, heads=<span class="hljs-number">8</span>, max_frames=<span class="hljs-number">64</span>, dropout=<span class="hljs-number">0.0</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.max_frames = max_frames
        self.pos_emb = nn.Embedding(max_frames, dim)
        self.attn = nn.MultiheadAttention(dim, heads, dropout=dropout, batch_first=<span class="hljs-literal">True</span>)
   
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        b, c, f, h, w = x.shape
        <span class="hljs-keyword">if</span> f &gt; self.max_frames:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"num_frames=<span class="hljs-subst">{f}</span> exceeds max_frames=<span class="hljs-subst">{self.max_frames}</span>"</span>)
        
        x_seq = rearrange(x, <span class="hljs-string">'b c f h w -&gt; (b h w) f c'</span>)   <span class="hljs-comment"># (BHW, F, C)</span>
        pos = torch.arange(f, device=x.device)
        x_seq = x_seq + self.pos_emb(pos).unsqueeze(<span class="hljs-number">0</span>)     <span class="hljs-comment"># (BHW, F, C)</span>
        out, _ = self.attn(x_seq, x_seq, x_seq, need_weights=<span class="hljs-literal">False</span>)
        out = rearrange(out, <span class="hljs-string">'(b h w) f c -&gt; b c f h w'</span>, b=b, h=h, w=w)
        <span class="hljs-keyword">return</span> out

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SinusoidalPosEmb</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, dim</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.dim = dim
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        device = x.device
        half_dim = self.dim // <span class="hljs-number">2</span>
        emb = math.log(<span class="hljs-number">10000</span>) / (half_dim - <span class="hljs-number">1</span>)
        emb = torch.exp(torch.arange(half_dim, device=device) * -emb)
        emb = x[:, <span class="hljs-literal">None</span>] * emb[<span class="hljs-literal">None</span>, :]
        emb = torch.cat((emb.sin(), emb.cos()), dim=-<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span> emb

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Residual</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, fn</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.fn = fn
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, *args, **kwargs</span>):
        <span class="hljs-keyword">return</span> self.fn(x, *args, **kwargs) + x

<span class="hljs-keyword">def</span> <span class="hljs-title function_">Upsample</span>(<span class="hljs-params">dim, padding_mode=<span class="hljs-string">"reflect"</span></span>):
    <span class="hljs-keyword">return</span> nn.Sequential(
        nn.Upsample(scale_factor=(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>), mode=<span class="hljs-string">'nearest'</span>),
        nn.Conv3d(dim, dim, (<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>), (<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>), (<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>), padding_mode=padding_mode)
    )

<span class="hljs-keyword">def</span> <span class="hljs-title function_">Downsample</span>(<span class="hljs-params">dim</span>):
    <span class="hljs-keyword">return</span> nn.Conv3d(dim, dim, (<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>), (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>), (<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>))

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NormAttn</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, norm, attn</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.norm = norm
        self.attn = attn
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> self.attn(self.norm(x))

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResnetBlock</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, dim, dim_out, *, time_emb_dim=<span class="hljs-literal">None</span>, groups=<span class="hljs-number">8</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        <span class="hljs-keyword">if</span> time_emb_dim <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.mlp = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">else</span>:
            self.mlp = nn.Sequential(
                nn.SiLU(),
                nn.Linear(time_emb_dim, dim_out * <span class="hljs-number">2</span>)
            )
        self.conv1 = nn.Conv3d(dim, dim_out, (<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>))
        self.norm1 = nn.GroupNorm(groups, dim_out)
        self.act1  = nn.SiLU()
        self.conv2 = nn.Conv3d(dim_out, dim_out, (<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>), padding=(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>))
        self.norm2 = nn.GroupNorm(groups, dim_out)
        self.act2  = nn.SiLU()
        self.res_conv = nn.Conv3d(dim, dim_out, <span class="hljs-number">1</span>) <span class="hljs-keyword">if</span> dim != dim_out <span class="hljs-keyword">else</span> nn.Identity()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x, time_emb=<span class="hljs-literal">None</span></span>):
        scale = shift = <span class="hljs-literal">None</span>
        <span class="hljs-keyword">if</span> self.mlp <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            t = self.mlp(time_emb)
            t = rearrange(t, <span class="hljs-string">'b c -&gt; b c 1 1 1'</span>)
            scale, shift = t.chunk(<span class="hljs-number">2</span>, dim=<span class="hljs-number">1</span>)
        
        h = self.conv1(x)
        h = self.norm1(h)
        <span class="hljs-keyword">if</span> scale <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            h = h * (scale + <span class="hljs-number">1</span>) + shift
        h = self.act1(h)
        h = self.conv2(h)
        h = self.norm2(h)
        h = self.act2(h)
        <span class="hljs-keyword">return</span> h + self.res_conv(x)
</code></pre>
<p>以上是U-Net模型的一些关键模块。这里，我们添加了一个时间注意力模块，通过关注时间（帧）维度来更好地保持时间一致性。</p>
<pre><code class="hljs language-ini" lang="ini">class Unet3D(nn.Module):
    def __init__(self, <span class="hljs-attr">dim</span>=<span class="hljs-number">64</span>, num_classes=<span class="hljs-number">28</span>, cond_embed_dim=<span class="hljs-number">128</span>, dim_mults=(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>),
                 <span class="hljs-attr">channels</span>=<span class="hljs-number">3</span> + <span class="hljs-number">256</span>, attn_heads=<span class="hljs-number">8</span>, max_frames=<span class="hljs-number">64</span>, init_kernel_size=<span class="hljs-number">7</span>, resnet_groups=<span class="hljs-number">8</span>):
        super().__init__()
        <span class="hljs-attr">self.channels</span> = channels
        <span class="hljs-attr">init_dim</span> = dim
        <span class="hljs-attr">init_padding</span> = init_kernel_size // <span class="hljs-number">2</span>
        <span class="hljs-attr">self.init_conv</span> = nn.Conv3d(
            channels, init_dim,
            <span class="hljs-attr">kernel_size</span>=(<span class="hljs-number">1</span>, init_kernel_size, init_kernel_size),
            <span class="hljs-attr">padding</span>=(<span class="hljs-number">0</span>, init_padding, init_padding),
            <span class="hljs-attr">padding_mode</span>=<span class="hljs-string">"zeros"</span>
        )
        
        <span class="hljs-attr">self.init_norm</span> = nn.GroupNorm(<span class="hljs-number">1</span>, init_dim, eps=<span class="hljs-number">1</span>e-<span class="hljs-number">5</span>)
        <span class="hljs-attr">self.init_attn</span> = TemporalSelfAttention(init_dim, heads=attn_heads, max_frames=max_frames)
        <span class="hljs-attr">self.init_attn_res</span> = Residual(lambda x: self.init_attn(self.init_norm(x)))
        <span class="hljs-attr">dims</span> = [init_dim] + [dim * m for m in dim_mults]
        <span class="hljs-attr">in_out</span> = list(zip(dims[:-<span class="hljs-number">1</span>], dims[<span class="hljs-number">1</span>:]))
        <span class="hljs-attr">num_resolutions</span> = len(in_out)
        
        <span class="hljs-comment"># time embedding</span>
        <span class="hljs-attr">time_dim</span> = dim * <span class="hljs-number">4</span>
        <span class="hljs-attr">self.time_mlp</span> = nn.Sequential(
            SinusoidalPosEmb(dim),
            nn.Linear(dim, time_dim),
            nn.GELU(),
            nn.Linear(time_dim, time_dim)
        )
        
        <span class="hljs-comment"># class embedding</span>
        <span class="hljs-attr">self.cond_emb</span> = nn.Embedding(num_classes, cond_embed_dim)
        <span class="hljs-attr">cond_dim</span> = time_dim + cond_embed_dim
        
        <span class="hljs-attr">block_klass</span> = partial(ResnetBlock, groups=resnet_groups)
        <span class="hljs-attr">block_klass_cond</span> = partial(block_klass, time_emb_dim=cond_dim)
        <span class="hljs-attr">self.downs</span> = nn.ModuleList([])
        <span class="hljs-attr">self.ups</span> = nn.ModuleList([])
        
        for ind, (dim_in, dim_out) in enumerate(in_out):
            <span class="hljs-attr">is_last</span> = ind &gt;= (num_resolutions - <span class="hljs-number">1</span>)
            <span class="hljs-attr">norm</span> = nn.GroupNorm(<span class="hljs-number">1</span>, dim_out, eps=<span class="hljs-number">1</span>e-<span class="hljs-number">5</span>)
            <span class="hljs-attr">attn</span> = TemporalSelfAttention(dim_out, heads=attn_heads, max_frames=max_frames)
            <span class="hljs-attr">attn_res</span> = Residual(NormAttn(norm, attn))
            
            self.downs.append(nn.ModuleList(<span class="hljs-section">[
                block_klass_cond(dim_in, dim_out),
                block_klass_cond(dim_out, dim_out),
                attn_res,
                Downsample(dim_out) if not is_last else nn.Identity()
            ]</span>))
        
        <span class="hljs-attr">mid_dim</span> = dims[-<span class="hljs-number">1</span>]
        <span class="hljs-attr">self.mid_block1</span> = block_klass_cond(mid_dim, mid_dim)
        <span class="hljs-attr">norm</span> = nn.GroupNorm(<span class="hljs-number">1</span>, mid_dim, eps=<span class="hljs-number">1</span>e-<span class="hljs-number">5</span>)
        <span class="hljs-attr">attn</span> = TemporalSelfAttention(mid_dim, heads=attn_heads, max_frames=max_frames)
        <span class="hljs-attr">self.mid_attn_res</span> = Residual(NormAttn(norm, attn))
        <span class="hljs-attr">self.mid_block2</span> = block_klass_cond(mid_dim, mid_dim)
        
        for ind, (dim_in, dim_out) in enumerate(reversed(in_out)):
            <span class="hljs-attr">is_last</span> = ind &gt;= (num_resolutions - <span class="hljs-number">1</span>)
            <span class="hljs-attr">norm</span> = nn.GroupNorm(<span class="hljs-number">1</span>, dim_in, eps=<span class="hljs-number">1</span>e-<span class="hljs-number">5</span>)
            <span class="hljs-attr">attn</span> = TemporalSelfAttention(dim_in, heads=attn_heads, max_frames=max_frames)
            <span class="hljs-attr">attn_res</span> = Residual(NormAttn(norm, attn))
            
            self.ups.append(nn.ModuleList(<span class="hljs-section">[
                block_klass_cond(dim_out * 2, dim_in),
                block_klass_cond(dim_in, dim_in),
                attn_res,
                Upsample(dim_in, padding_mode="zeros") if not is_last else nn.Identity()
            ]</span>))
        
        <span class="hljs-attr">self.out</span> = nn.Sequential(
            block_klass(dim * 2, dim),
            nn.Conv3d(dim, 3, 1)
        )
    
    def forward(self, x, time, cond):
        <span class="hljs-attr">device</span> = x.device
        <span class="hljs-attr">x</span> = self.init_conv(x)
        <span class="hljs-attr">r</span> = x.clone()
        <span class="hljs-attr">x</span> = self.init_attn_res(x)
        <span class="hljs-attr">t</span> = self.time_mlp(time)
        if cond.dim() == 2 and cond.size(-1) == 1:
            <span class="hljs-attr">cond</span> = cond.squeeze(-<span class="hljs-number">1</span>)
        <span class="hljs-attr">cond</span> = cond.long().to(device)
        <span class="hljs-attr">t</span> = torch.cat([t, self.cond_emb(cond)], dim=-<span class="hljs-number">1</span>)
        
        <span class="hljs-attr">h</span> = [] <span class="hljs-comment"># unet</span>
        for block1, block2, attn_res, downsample in self.downs:
            <span class="hljs-attr">x</span> = block1(x, t)
            <span class="hljs-attr">x</span> = block2(x, t)
            <span class="hljs-attr">x</span> = attn_res(x)
            h.append(x)
            <span class="hljs-attr">x</span> = downsample(x)

        <span class="hljs-attr">x</span> = self.mid_block1(x, t)
        <span class="hljs-attr">x</span> = self.mid_attn_res(x)
        <span class="hljs-attr">x</span> = self.mid_block2(x, t)
        
        for block1, block2, attn_res, upsample in self.ups:
            <span class="hljs-attr">x</span> = torch.cat([x, h.pop()], dim=<span class="hljs-number">1</span>)
            <span class="hljs-attr">x</span> = block1(x, t)
            <span class="hljs-attr">x</span> = block2(x, t)
            <span class="hljs-attr">x</span> = attn_res(x)
            <span class="hljs-attr">x</span> = upsample(x)
        <span class="hljs-attr">x</span> = torch.cat([x, r], dim=<span class="hljs-number">1</span>)
        return self.out(x)
</code></pre>
<p>get_latent_flow_residual 函数收集源帧与所有其他帧之间的流。它还输出源帧的特征图，用作U-Net的条件输入。</p>
<pre><code class="hljs language-@torch.no_grad()" lang="@torch.no_grad()">def get_latent_flow_residual(x, region_predictor, flow_predictor, generator):
    b, _, T, H, W = x.shape
    source_img = x[:, :, 0]  # (B,3,H,W)
    flow_list = []
    conf_list = []
    source_region = region_predictor(source_img)
    for t in range(T):
        driving_img = x[:, :, t]
        driving_region = region_predictor(driving_img)
        flow_motion = flow_predictor(
            source_img,
            source_region_params=source_region,
            driving_region_params=driving_region
        )
        grid = flow_motion["optical_flow"]  
        conf = flow_motion["occlusion_map"] 
        flow_list.append(grid)  # keep (B,H,W,2)
        conf_list.append(conf)
    
    fea = generator.compute_fea(source_img) 
    grid = torch.stack(flow_list, dim=1)  # (B,T,H,W,2)
    conf = torch.stack(conf_list, dim=2)  # (B,1,T,H,W)
    id_grid = make_coordinate_grid((32, 32), grid.dtype).to(grid.device)
    id_grid = id_grid.unsqueeze(0).repeat(b, 1, 1, 1)
    id_grid = id_grid.unsqueeze(1).repeat(1, T, 1, 1, 1) 
    delta = grid - id_grid  
    
    delta = delta.permute(0, 4, 1, 2, 3).contiguous()
    conf = conf * 2 - 1   # conf to [-1,1]
    out = torch.cat([delta, conf], dim=1)  
    # fea repeat on T (B,C,Hf,Wf)-&gt;(B,C,T,Hf,Wf)
    fea = fea.unsqueeze(2).repeat(1, 1, T, 1, 1)
    return out, fea

from torchdiffeq import odeint
class RectifiedFlow(nn.Module):
    def __init__(self, unet, p_uncond=0.25, null_label_id=27):
        super().__init__()
        self.unet = unet
        self.p_uncond = p_uncond
        self.null_label_id = null_label_id
    
    def forward(self, x0, fea, label):
        B = x0.size(0)
        device = x0.device
        # Classified Free Guidence
        if (self.null_label_id is not None) and (self.p_uncond &gt; 0):
            drop = torch.rand(B, device=device) &lt; self.p_uncond
            label = label.clone()
            label[drop] = self.null_label_id
        
        t = torch.rand(B, device=device) # (B,)
        t_view = t.view(B, 1, 1, 1, 1)
        x1 = torch.randn_like(x0)
        x_t = (1.0 - t_view) * x1 + t_view * x0
        v_gt = x0 - x1
        
        x_in = torch.cat([x_t, fea], dim=1) # (B, C+C_fea, F, H, W)
        v_pred = self.unet(x_in, t, label)
        loss = F.mse_loss(v_pred, v_gt)
        return loss

@torch.no_grad()
def rf_sample_target(model, fea, label,  device, steps=40):
    # You can use this function to get the latent flow
    # and use the 'decoder' in Generator to recover the video back
    B = label.size(0)
    x0 = torch.randn(B, 3, 40, 32, 32, device=device)
    def func(t, x):
        t_vec = torch.full((B,), float(t), device=device)
        x_in = torch.cat([x, fea], dim=1)
        v = model(x_in, t_vec, label)
        return v
    
    t_span = torch.linspace(0.0, 1.0, steps + 1, device=device)
    x_traj = odeint(func, x0, t_span, method="rk4", rtol=1e-5, atol=1e-5)
    x1 = x_traj[-1]
    x1 = x1.clamp(-1, 1)
    return x1, x0
</code></pre>
<ul>
<li><strong>无分类器引导</strong></li>
</ul>
<p>对于视频生成，仅仅使用一个标签来控制输出通常是不够的。标签只告诉模型要生成什么动作，但它没有解释这个动作应该如何随时间演化。</p>
<p>因此，模型在训练过程中很容易走捷径，生成一个仅仅“看起来在动”的序列，而没有真正遵循给定标签的语义含义。换句话说，条件信号太弱了，所以模型可以轻易忽略它。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9774a72cb6214a46a0e2306a7bb30290~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380682&amp;x-signature=QpKsWXOFpFO12K6JHS61A5gbDOQ%3D" alt="screenshot_2026-01-06_15-41-47.png" loading="lazy"/></p>
<p>为了解决这个问题，引入无分类器引导来让标签更重要。CFG通过在生成过程中放大条件的影响，明确地加强了条件的约束力，迫使模型遵循标签，而不是退回到通用的、无条件的运动。这对于视频生成尤其重要，因为可能的运动空间比图像大得多。</p>
<p>注：在实践中，CFG非常容易实现。只需添加一个额外的类别来表示空（无条件）条件，并在训练过程中随机丢弃原始标签。</p>
<pre><code class="hljs language-device" lang="device">best_path = "Your pretrain model"
ckpt = torch.load(best_path, map_location=device)
generator.load_state_dict(ckpt["generator"])
region_predictor.load_state_dict(ckpt["region_predictor"])
flow_predictor.load_state_dict(ckpt["flow_predictor"])

unet = Unet3D()
rf_model = RectifiedFlow(unet).to(device)
dataset = UTDDataset(mode='stage2)
optimizer = torch.optim.Adam(list(unet.parameters()), lr=1e-4, betas=(0.9, 0.999))
dataloader = torch.utils.data.DataLoader(dataset, batch_size=4, shuffle=True, num_workers=4)

total_iters = 200000
log_interval = 20000
running_loss = 0.0
loss_history = []
iter_history = []

generator.eval()
region_predictor.eval()
flow_predictor.eval()
unet.train()
data_iter = iter(dataloader)
pbar = trange(1, total_iters + 1, desc="Training", dynamic_ncols=True)

for it in pbar:
    try:
        clip, label = next(data_iter)
    except StopIteration:
        data_iter = iter(dataloader)
        clip, label = next(data_iter)
    
    clip, label = clip.to(device), label.to(device)
    B = clip.size(0)
    
    flow, fea = get_latent_flow_residual(clip, region_predictor, flow_predictor, generator)
    loss = rf_model(flow, fea, label)
    optimizer.zero_grad()
    loss.backward()
    
    torch.nn.utils.clip_grad_norm_(unet.parameters(), 1.0)
    optimizer.step()
    ema_update(ema_unet, unet, beta=0.995)
    running_loss += loss.item()
    pbar.set_postfix({"loss": f"{loss.item():.4f}"})
    
    if it % log_interval == 0:
        avg_loss = running_loss / log_interval
        pbar.write(f"[Iter {it}] loss = {avg_loss:.4f}")
        iter_history.append(it)
        loss_history.append(avg_loss)
        running_loss = 0.0

        torch.save(
            {
                "unet": unet.state_dict(),
                "ema_unet": ema_unet.state_dict(),
                "optimizer": optimizer.state_dict(),
                "it": it,
            },
            f"{ckpt_dir}/unet_{it}.pt"
        )
        pbar.write(f"Saved checkpoint at iter {it}")
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[罗技鼠标因为服务器证书过期无法使用？我是如何解决 SSL 证书问题]]></title>    <link>https://juejin.cn/post/7592236397535346724</link>    <guid>https://juejin.cn/post/7592236397535346724</guid>    <pubDate>2026-01-07T08:54:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592236397535346724" data-draft-id="7592236397535297572" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="罗技鼠标因为服务器证书过期无法使用？我是如何解决 SSL 证书问题"/> <meta itemprop="keywords" content="前端,Android,Flutter"/> <meta itemprop="datePublished" content="2026-01-07T08:54:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            罗技鼠标因为服务器证书过期无法使用？我是如何解决 SSL 证书问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:54:26.000Z" title="Wed Jan 07 2026 08:54:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有时候不得不说，大家都是一个草台班子，想破了都没理解，这么大的企业可以证书能过期没处理，过期就算了，关键这服务器过期会导致鼠标配置用不了也是醉了，而且能持续这么长时间：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd0ed3b843074079a69217c19e27e063~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380865&amp;x-signature=cBfr%2BT%2BUxAzdBDN8YEB%2Fff%2BCF%2Fw%3D" alt="" loading="lazy"/></p>
<p>当然，对于个人来说其实也是，相信很多人用的都是免费证书，在此之前大家应该都是 3 个月换一次，而前段时间，Let’s Encrypt 也宣布了将全面缩短 TLS/SSL 证书的有效期， <strong>从现有的 90 天调整为45 天</strong> ，这对于个人 Free 用户来说，无疑是灾难的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/052b9706b5674546aa54355dec2167e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380865&amp;x-signature=%2Bk0Ugg4NkrBCYS%2BMkXieABxM%2BAI%3D" alt="" loading="lazy"/></p>
<p>那我是怎么解决的？其实从 Let's Encrypt 将免费 SSL 证书有效期缩短到三个月之后，我就很烦 SSL 这个问题，所以我当时找了个脚本解决这个，整体其实还挺简单的：<strong>Let’s Encrypt + acme.sh ，可以 20 分钟搞定两个不同场景的域名 SSL 自动更新</strong>，不得不赞叹劳动人民为了 Free 的智慧。</p>
<p>首先我有两个 ssl 证书：</p>
<ul>
<li>一个是主域名的，域名的 ssl 证书和 dns 都在腾讯云，服务器也是腾讯云的，证书之前是手动部署在我服务器内的 nginx 配置下</li>
<li>一个是子域名的，img 子域名和其对应的 ssl ，是给七牛云配置的 https 域名支持</li>
</ul>
<p>基于这个场景，我用 <strong>Let’s Encrypt + acme.sh</strong> 做自动续签 ，因为对比 Certbot ，acme.sh 在完全手动控制 nginx 配置上更方便，而且轻量又不依赖 openssl，高可控且不需要修改我目前的 Nginx 配置。</p>
<blockquote>
<p>也 Free 。</p>
</blockquote>
<h2 data-id="heading-0">主域名</h2>
<p>对于主域名，因为我现在的证书路径在我服务器的：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">/etc/nginx/<span class="hljs-keyword">default</span>.d/<span class="hljs-number">1_</span>XXXX.cn_bundle.crt
/etc/nginx/<span class="hljs-keyword">default</span>.d/<span class="hljs-number">2_</span>XXXX.cn.<span class="hljs-keyword">key</span>
</code></pre>
<p>所以我需要确保：</p>
<ul>
<li>每次续期后自动覆盖这两个文件</li>
<li>自动 reload nginx</li>
<li>不会破坏现有 nginx 配置</li>
<li>Let’s Encrypt 的 challenge 能正常走 HTTP（ 80 端口是可访问的）</li>
</ul>
<p>所以具体流程为：</p>
<h3 data-id="heading-1">1、安装 <code>acme.sh</code></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 acme.sh</span>
curl https://get.acme.sh | sh
<span class="hljs-comment"># 重启 shell</span>
<span class="hljs-built_in">source</span> ~/.bashrc
</code></pre>
<h3 data-id="heading-2">2、适配配置</h3>
<p>因为我现在的 80 端口配置是：</p>
<pre><code class="hljs language-perl" lang="perl">location /{
    rewrite ^(.*) https:<span class="hljs-regexp">//</span>$host$1 permanent;
}
</code></pre>
<p>对于 <code>acme.sh</code> 来说，会检测到 challenge 无法验证，所以我需要在 <strong>80 的 server 块【最前面】加一段例外配置，必须放在所有 rewrite 之前</strong>，把 acme 的验证排除在跳转之外，这里的 <code>/usr/share/nginx/html</code> 就是 nginx 默认的 server root ：</p>
<pre><code class="hljs language-bash" lang="bash">location ^~ /.well-known/acme-challenge/ {
    root /usr/share/nginx/html;
    allow all;
}
</code></pre>
<h3 data-id="heading-3">3、开始签发</h3>
<p>因为我是有 XXXX.cn 和 <a href="https://link.juejin.cn?target=www.XXXX.cn" target="_blank" title="www.XXXX.cn" ref="nofollow noopener noreferrer">www.XXXX.cn</a> 两个需要解析的，所以命令是如下所示，这里的 <code>/usr/share/nginx/html</code> 就是前面的 server root ：</p>
<pre><code class="hljs language-css" lang="css">acme<span class="hljs-selector-class">.sh</span> <span class="hljs-attr">--issue</span> -d XXXX<span class="hljs-selector-class">.cn</span> -d www<span class="hljs-selector-class">.XXXX</span><span class="hljs-selector-class">.cn</span> -w /usr/share/nginx/<span class="hljs-selector-tag">html</span>
</code></pre>
<p>在这里我遇到了两个问题：</p>
<ul>
<li><code>acme.sh is using ZeroSSL as default CA now.</code> ，acme.sh 默认改用 ZeroSSL 导致必须注册账号并绑定邮箱的提示，你可以通过 <code>acme.sh --register-account -m 你的邮箱@example.com</code> 来解决，但是我不想弄，所以我用 <code>acme.sh --set-default-ca --server letsencrypt</code> 切回 Let’s Encrypt</li>
</ul>

<ul>
<li>
<p><code>curl: (60) SSL certificate problem: unable to get local issuer certificate</code> ，acme.sh 访问 Let’s Encrypt 的 API 时，系统信任链不完整，CA 根证书过期或缺失，这在老版本 CentOS（特别是 CentOS 7）上非常常见，因为系统自带的 CA bundle 太旧了，无法验证 Let’s Encrypt 的新根证书 ISRG Root X1，解决方式就是<strong>更新 ca-certificates</strong> ：</p>
<pre><code class="hljs language-sql" lang="sql"> yum <span class="hljs-keyword">update</span> ca<span class="hljs-operator">-</span>certificates <span class="hljs-operator">-</span>y
 <span class="hljs-keyword">update</span><span class="hljs-operator">-</span>ca<span class="hljs-operator">-</span>trust
</code></pre>
</li>
</ul>
<p>申请颁发成功后， acme.sh 会告诉你证书路径一般在：</p>
<pre><code class="hljs language-javascript" lang="javascript">~<span class="hljs-regexp">/.acme.sh/</span><span class="hljs-variable constant_">XXXX</span>.<span class="hljs-property">cn</span>/
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd6a119100ef4d73812a8a222ebae688~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380865&amp;x-signature=rq%2FP%2FoShse81mdfU4cmdHDZGq8Q%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">4、安装证书</h3>
<p>最后，只需要通过以下命令，就可以直接成功将颁发的证书自动部署并安装到指定位置，同时开启了定时任务，<strong>acme.sh 会自动创建 cron，每 60 天自动续期，也会自动 reload Nginx</strong>，之后不需要做任何其他事情。</p>
<pre><code class="hljs language-scss" lang="scss">acme<span class="hljs-selector-class">.sh</span> <span class="hljs-attr">--install-cert</span> -d XXXX<span class="hljs-selector-class">.cn</span> \
<span class="hljs-attr">--key-file</span> /etc/nginx/default<span class="hljs-selector-class">.d</span>/<span class="hljs-number">2</span>_XXXX<span class="hljs-selector-class">.cn</span><span class="hljs-selector-class">.key</span> \
<span class="hljs-attr">--fullchain-file</span> /etc/nginx/default<span class="hljs-selector-class">.d</span>/<span class="hljs-number">1</span>_XXXX<span class="hljs-selector-class">.cn_bundle</span><span class="hljs-selector-class">.crt</span> \
<span class="hljs-attr">--reloadcmd</span> "nginx -s reload"
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6320bde34f34f529f22e0810a4829a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380865&amp;x-signature=4H4KtEOCCK63D1ON4gU%2BIARpzLQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">第三方平台</h2>
<p>因为图床的 SSL 证书是在七牛云的，所以还需要处理七牛云的证书问题，这也可以通过 <strong>acme.sh → 自动续签 → 自动上传到七牛云</strong> 来实现全自动化证书管理。</p>
<blockquote>
<p>acme.sh 已经内置了 Qiniu API 自动部署证书（deploy hook）,基本知名的第三方平台都有。</p>
</blockquote>
<p>因为我是在腾讯云的域名，使用的是腾讯云 DNS（DNSPod），所以我需要结合腾讯云的流程来完成。</p>
<h3 data-id="heading-6">1、获取 DNSPod API Token</h3>
<p>登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.dnspod.cn%2Faccount%2Ftoken" target="_blank" title="https://console.dnspod.cn/account/token" ref="nofollow noopener noreferrer">console.dnspod.cn/account/tok…</a>，创建一个 Token：</p>
<ul>
<li>Token 名称：任意</li>
<li>权限：只需要 DNS 读取/写入</li>
</ul>
<p>这样我们得到：</p>
<ul>
<li><code>DP_Id</code>（ID）</li>
<li><code>DP_Key</code>（Token）</li>
</ul>
<h3 data-id="heading-7">2、获取七牛云 AK/SK（用于自动上传证书）</h3>
<p>通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fportal.qiniu.com%2Fuser%2Fkey" target="_blank" title="https://portal.qiniu.com/user/key" ref="nofollow noopener noreferrer">portal.qiniu.com/user/key</a>，获得：</p>
<ul>
<li><code>QINIU_AK</code></li>
<li><code>QINIU_SK</code></li>
</ul>
<h3 data-id="heading-8">3、使用 dns_dp 自动为 img.cdn.XXX.cn 签发证书</h3>
<p>通过下面命令，就可以自动签发对应证书了</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">DP_Id</span>=<span class="hljs-string">"你的DP_Id"</span>
export <span class="hljs-attr">DP_Key</span>=<span class="hljs-string">"你的DP_Key"</span>
​
acme.sh --issue \
  -d img.cdn.XXX.cn \
  --dns dns_dp
</code></pre>
<h3 data-id="heading-9">4、执行部署</h3>
<p>执行以下命令，执行成功后，七牛 CDN 的 img.cdn.XXX.cn 的 HTTPS 配置会自动替换成 <code>acme.sh</code> 的新证书</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">QINIU_AK</span>=<span class="hljs-string">"你的七牛AK"</span>
export <span class="hljs-attr">QINIU_SK</span>=<span class="hljs-string">"你的七牛SK"</span>
​
acme.sh --deploy \
  -d img.cdn.XXX.cn \
  --deploy-hook qiniu
</code></pre>
<p>之后 <code>acme.sh</code> 会每 60 天自动续签 Let's Encrypt 证书，自动运行 qiniu deploy hook，自动上传证书到七牛 CDN，再也不需要再手动登录七牛云上传证书。</p>
<p>实际上如果是阿里云也类似：</p>
<pre><code class="hljs language-ini" lang="ini">export <span class="hljs-attr">Ali_Key</span>=<span class="hljs-string">"你的阿里云AccessKeyId"</span>
export <span class="hljs-attr">Ali_Secret</span>=<span class="hljs-string">"你的阿里云AccessKeySecret"</span>
​
acme.sh --issue \
  -d img.cdn.XXX.cn \
  --dns dns_ali
</code></pre>
<blockquote>
<p>基本各大平台都支持。</p>
</blockquote>
<h2 data-id="heading-10">最后</h2>
<p>可以看到，实际操作起来还是挺简单的，而且是在你自己的服务器，安全问题也比使用第三方平台或者面板更可控，之后，你也可以通过以下命令查看 <code>acme.sh</code> 管理的证书状态。</p>
<pre><code class="hljs language-css" lang="css">acme<span class="hljs-selector-class">.sh</span> <span class="hljs-attr">--list</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14fc44bd1fca4090afaba1d45e65a039~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380865&amp;x-signature=%2FoJwtGUHVtQJHH70F1QUi9yN8hg%3D" alt="" loading="lazy"/></p>
<p>如果你想强制立即续签，也可以通过以下命令完成：</p>
<pre><code class="hljs language-css" lang="css">cme<span class="hljs-selector-class">.sh</span> <span class="hljs-attr">--renew</span> -d <span class="hljs-selector-tag">img</span><span class="hljs-selector-class">.cdn</span><span class="hljs-selector-class">.XXX</span><span class="hljs-selector-class">.cn</span> <span class="hljs-attr">--force</span>
</code></pre>
<p>另外 <code>acme.sh</code> 的<strong>自动续签完全不依赖 systemd 服务</strong>，它是通过 <strong>cron 定时任务</strong> 来实现的，也就是就算服务器重启，只要 cron 服务是系统自带并默认启动的，续签任务也会继续按计划运行，不需要手动恢复。</p>
<blockquote>
<p>正常来说，cron 作为 Linux 默认核心服务，重启后一般都是会自动恢复。</p>
</blockquote>
<p>如果还有什么差异性需求，通过 AI 也可以看快速解决，可以说 Let’s Encrypt + acme.sh 花费了我 20 分钟的时间，就解决了我蛋疼了一年的问题，对于懒人来收还是十分不错的选择。</p>
<blockquote>
<p>对于企业来说，可能有财务和安全考虑问题，对于个人，基本瞒住。</p>
</blockquote>
<p>另外有个冷知识，<strong>其实安卓的 APK 证书也是也有有效期的，只是一般来说，可能企业倒闭了证书还没到</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 流式对话该怎么做？SSE、fetch、axios 一次讲清楚]]></title>    <link>https://juejin.cn/post/7592170706026987555</link>    <guid>https://juejin.cn/post/7592170706026987555</guid>    <pubDate>2026-01-07T08:56:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592170706026987555" data-draft-id="7592531796038828066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 流式对话该怎么做？SSE、fetch、axios 一次讲清楚"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-07T08:56:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sailing"/> <meta itemprop="url" content="https://juejin.cn/user/307518988100237"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 流式对话该怎么做？SSE、fetch、axios 一次讲清楚
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/307518988100237/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sailing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:56:14.000Z" title="Wed Jan 07 2026 08:56:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在做 <strong>AI 对话产品</strong> 时，很多人都会遇到一个问题：</p>
<blockquote>
<p><strong>为什么有的实现能像 ChatGPT 一样逐字输出，而有的只能“等半天一次性返回”？</strong></p>
</blockquote>
<p>问题的核心，往往不在模型，而在 <strong>前后端的流式通信方式</strong>。</p>
<div align="center">
    <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58ca1957a6034de58674e28e81ed8fa2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FpbGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768380973&amp;x-signature=%2BClQFxqsXIn%2BNN9GmUpqR1TgCP0%3D" width="100%" loading="lazy"/></div>

<p>本文从实战出发，系统讲清楚 <strong>SSE、fetch、axios 在 AI 流式对话中的本质区别与选型建议</strong>。</p>
<h2 data-id="heading-0">先给结论（重要）</h2>
<blockquote>
<p><strong>AI 流式对话的正确打开方式：</strong></p>
<ul>
<li>✅ 首选：<code>fetch + ReadableStream</code></li>
<li>✅ 可选：<code>SSE（EventSource）</code></li>
<li>❌ 不推荐：<code>axios</code></li>
</ul>
</blockquote>
<p>如果你现在用的是 axios，还在纠结“为什么没有逐 token 输出”，可以直接往下看结论部分。</p>
<h2 data-id="heading-1">AI 流式对话的本质需求</h2>
<p>在传统接口中，请求和响应通常是这样的：</p>
<pre><code class="hljs">请求 → 等待 → 返回完整结果
</code></pre>
<p>但 AI 对话不是。</p>
<p><strong>AI 流式对话的真实需求是：</strong></p>
<ul>
<li>模型 <strong>逐 token 生成</strong></li>
<li>前端 <strong>边接收、边渲染</strong></li>
<li>连接可持续数十秒</li>
<li>用户能感知“正在思考 / 正在输出”</li>
</ul>
<p>这决定了：<strong>必须支持真正的 HTTP 流式响应</strong></p>
<h2 data-id="heading-2">SSE、fetch、axios 的本质区别</h2>
<p>在对比之前，先明确一个容易混淆的点：</p>
<h3 data-id="heading-3">1、SSE 是「协议能力」</h3>
<p><strong>SSE（Server-Sent Events）</strong> 是一种 <strong>基于 HTTP 的流式推送协议</strong></p>
<ul>
<li><code>Content-Type: text/event-stream</code></li>
<li>服务端可以不断向客户端推送数据</li>
<li>浏览器原生支持 <code>EventSource</code></li>
</ul>
<p>它解决的是：<strong>“服务端如何持续推送数据”</strong></p>
<h3 data-id="heading-4">2、fetch / axios 是「请求工具」</h3>

















<table><thead><tr><th>工具</th><th>本质</th></tr></thead><tbody><tr><td>fetch</td><td>浏览器原生 HTTP API</td></tr><tr><td>axios</td><td>对 XHR / fetch 的封装库</td></tr></tbody></table>
<p>它们解决的是：<strong>“前端如何发请求、拿响应”</strong></p>
<h2 data-id="heading-5">常用流式方案</h2>
<h3 data-id="heading-6">SSE：最简单的流式方案</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> es = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(<span class="hljs-string">'/api/chat/stream'</span>)

es.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">data</span>)
}
</code></pre>
<p>优点</p>
<ul>
<li>✅ 原生支持流式</li>
<li>✅ 自动重连</li>
<li>✅ 心跳、事件类型清晰</li>
<li>✅ 非常适合 <strong>AI 单向输出</strong></li>
</ul>
<p>缺点（关键）</p>
<ul>
<li>❌ 只支持 <code>GET</code></li>
<li>❌ 不能自定义 Header（鉴权不友好）</li>
<li>❌ 只能 <strong>服务端 → 客户端</strong></li>
</ul>
<p>适合场景：<strong>AI 回答输出</strong>、<strong>推理过程</strong> / <strong>日志流</strong>、<strong>实时通知类数据</strong>。</p>
<h3 data-id="heading-7">fetch + ReadableStream（推荐）</h3>
<p>这是目前 <strong>AI 产品中最主流、最灵活的方案</strong>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/chat'</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
  },
  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ prompt })
})

<span class="hljs-keyword">const</span> reader = res.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>()
<span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>()

<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-keyword">const</span> { value, done } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>()
  <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>
  <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(chunk)
}
</code></pre>
<p><strong>为什么它是首选？</strong></p>
<ul>
<li>✅ 支持 POST（可传 prompt、上下文）</li>
<li>✅ 可自定义 Header（token、traceId）</li>
<li>✅ 真正的 chunk / token 级流式</li>
<li>✅ 与 OpenAI / Claude 接口完全一致</li>
<li>✅ Web / Node / Edge Runtime 通用</li>
</ul>
<p><strong>一句话总结</strong>：<code>fetch + stream</code> 是目前 <strong>AI 流式对话的标准</strong></p>
<h2 data-id="heading-8">axios：为什么不适合 AI 流式？</h2>
<p>这是很多人踩坑最多的地方。</p>
<p><strong>常见误解</strong></p>
<pre><code class="hljs language-js" lang="js">axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/chat'</span>, data, {
  <span class="hljs-title function_">onDownloadProgress</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e)
  }
})
</code></pre>
<p>看起来像“流式”，但实际上 <strong>axios 的真实问题</strong>：</p>
<ul>
<li>浏览器端基于 XHR</li>
<li>响应会被 <strong>缓冲</strong></li>
<li><code>onDownloadProgress</code> 不是 token 级回调</li>
<li>延迟明显、体验差</li>
</ul>
<p><strong>结论</strong>：axios 在浏览器端 <strong>不支持真正的流式响应</strong></p>
<p>它更适合普通 REST API、表单提交、数据请求，但 <strong>不适合 AI 流式输出</strong>。</p>
<h2 data-id="heading-9">总结</h2>

































<table><thead><tr><th>方案</th><th>真流式</th><th>POST</th><th>Header</th><th>推荐度</th></tr></thead><tbody><tr><td>SSE (EventSource)</td><td>✅</td><td>❌</td><td>❌</td><td>⭐⭐⭐</td></tr><tr><td>fetch + stream</td><td>✅</td><td>✅</td><td>✅</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>axios</td><td>❌</td><td>✅</td><td>✅</td><td>⭐</td></tr></tbody></table>
<ul>
<li>SSE 是流式协议</li>
<li>fetch 是流式容器</li>
<li>axios 是传统请求工具</li>
</ul>
<p>如果你正在做 AI 产品，通信层选错，后面再怎么优化模型和前端体验，都会事倍功半。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3D-AIGC 存储架构演进：从 NFS、GlusterFS 到 JuiceFS]]></title>    <link>https://juejin.cn/post/7592438587388411942</link>    <guid>https://juejin.cn/post/7592438587388411942</guid>    <pubDate>2026-01-07T09:01:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592438587388411942" data-draft-id="7592361736130773002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3D-AIGC 存储架构演进：从 NFS、GlusterFS 到 JuiceFS"/> <meta itemprop="keywords" content="后端,运维,人工智能"/> <meta itemprop="datePublished" content="2026-01-07T09:01:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JuiceFS"/> <meta itemprop="url" content="https://juejin.cn/user/2665636828032446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3D-AIGC 存储架构演进：从 NFS、GlusterFS 到 JuiceFS
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2665636828032446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JuiceFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T09:01:19.000Z" title="Wed Jan 07 2026 09:01:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>光影焕像（Lightillusions）是一家专注于空间智能技术，结合 3D 视觉、图形学和生成模型技术，致力于打造创新的 3D 基础模型公司。公司由谭平教授领导，谭教授曾担任阿里巴巴达摩院实验室负责人，目前是香港科技大学的教授，同时担任冯诺伊曼人工智能研究室副院长，并是香港科技大学与比亚迪联合实验室的主任。</p>
<p>区别于二维模型，三维模型单个模型的大小可达几 GB，尤其是点云数据等复杂模型。当数据量达到 PB 级别时，管理与存储成为巨大的挑战。经过尝试 NFS、GlusterFS 等方案后，我们最终选择了 JuiceFS，成功搭建了一个统一的存储平台，为多个场景服务，并支持跨平台访问，包括 Windows 和 Linux 系统。<strong>该平台目前已管理上亿文件，数据处理速度提升了 200%~250%，还实现了高效的存储扩容，同时运维管理得到了极大简化，使得团队能够更专注于核心任务的推进</strong>。</p>
<h2 data-id="heading-0">01 3D-AIGC 存储需求</h2>
<p>我们的研究主要集中在感知和生成两个方向。在三维领域，任务的复杂性与图像和文本处理有本质区别，这对我们的 AI 模型、算法以及基础设施建设都提出了更高的要求。</p>
<p>我们通过一个 3D 数据处理流程，来展示三维数据处理的复杂性。下图左侧是一个三维模型，包含纹理（左上角的折射纹理）和几何信息（右下角的几何结构）。首先，我们生成渲染图像。每个模型还附带文本标签，描述其内容、几何特征和纹理特征，这些标签与每个模型紧密相关。此外，我们还处理几何数据，如采样点以及从数据预处理过程中得到的必要数值（如 3DS、SDF 等）。需要注意的是，三维模型的文件格式非常多样，图片格式也各不相同。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b8f785b058e48ee9571dbb9ca5c7cc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768381278&amp;x-signature=eYQBNQI59JvpIydmVHs%2BnREJ6PQ%3D" alt="" loading="lazy"/></p>
<p>我们的工作场景涉及语言模型、图像/视频模型到三维模型，随着数据量的增长，存储负担也在不断增加。以下是这些场景中数据使用的主要特点：</p>
<ul>
<li>语言模型的数据通常由大量小文件组成。尽管单个文本文件较小，但随着数据量的增加，文件数量可能达到数百万甚至数千万个，这使得管理如此庞大的文件数成为存储的一个主要难点。</li>
<li>图像和视频数据，尤其是高分辨率图像和长时间的视频，通常较为庞大。单张图像的大小通常在几百 KB 到几 MB 之间，而视频文件可能达到 GB 级别。在预处理过程中，如数据增强、分辨率调整和帧提取等，数据量会显著增加，特别是在视频处理中，每个视频通常会被拆解为大量的图像文件，管理这些庞大的文件集，带来了更高的复杂性。</li>
<li>三维模型，特别是点云数据等复杂模型，单个模型的大小可达几 GB。<strong>三维数据的预处理过程比其他数据更加复杂，涉及纹理映射、几何重建等多个步骤，这些处理不仅消耗大量计算资源，还可能增加数据体积</strong>。此外，三维模型通常由多个文件组成，文件数量庞大，随着数据量的增长，管理这些文件的难度也会增加。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60d21446f1504d8e918051c10d6fa74f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768381278&amp;x-signature=yPpvGEqZwC%2B8fonX48Pd6TIB5rA%3D" alt="" loading="lazy"/></p>
<p>由上述环节的存储特点，我们希望构建的存储平台能够满足以下几项要求：</p>
<ul>
<li>
<p><strong>多样的数据格式与跨节点共享</strong>：不同模型的数据格式差异较大，特别是三维模型的格式复杂性和跨平台兼容问题，存储系统需要支持多种格式，并有效管理跨节点和跨平台的数据共享。</p>
</li>
<li>
<p><strong>可以处理不同尺寸的数据模型</strong>：无论是语言模型的小文件、大规模图片/视频数据，还是三维模型的大文件，存储系统必须具备高扩展性，以应对快速增长的存储需求，并高效处理大尺寸数据的存储和访问。</p>
</li>
<li>
<p><strong>跨云与集群存储的挑战</strong>：随着数据量的增加，特别是三维模型的 PB 级存储需求，跨云和集群存储问题愈加突出。存储系统需要支持跨区域、跨云的无缝数据访问和高效的集群管理。</p>
</li>
<li>
<p><strong>方便扩容</strong>：无论是语言模型、图片/视频模型，还是三维模型，扩容需求始终存在，尤其是三维模型的存储和处理对扩容的需求更高。</p>
</li>
<li>
<p><strong>简单的运维</strong>：存储系统应提供简便的管理界面和工具，尤其是对于三维模型的管理，运维要求更高，自动化管理和容错能力是必不可少的。</p>
</li>
</ul>
<h2 data-id="heading-1">02 存储方案探索：从 NFS、Gluster、CephFS 到 JuiceFS</h2>
<h3 data-id="heading-2">前期方案：NFS 挂载</h3>
<p>最初，我们采用了最简单的方案——使用 NFS 进行挂载。然而，在实际操作中，我们发现训练集群和渲染集群需要各自独立的集群来进行挂载操作。这种方式的维护非常繁琐，尤其是当添加新的数据时，我们需要单独为每个新数据写入挂载点。到了数据量达到约 100 万物体级别时，我们已经无法继续维持这种方案，因此在早期阶段，我们就放弃了这一方案。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a748cf9a96024a6289c22e9b81571ff2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768381278&amp;x-signature=0Az8pLZenRH8h09JPi9hy82PG9A%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">中期方案：GlusterFS</h3>
<p>GlusterFS 是一个相对易于上手的选择，安装配置简单，性能也能得到一定保障，且无需划分多个挂载点，只需增加新节点即可。虽然在前期使用时，GlusterFS 大大减轻了我们的工作量，但我们也发现它的生态系统存在一些问题。</p>
<p>首先，GlusterFS 许多执行脚本和功能需要手动编写定时任务。特别是在添加新存储时，它还会有一些额外要求，例如需要按特定倍数增加节点。此外，像克隆、数据同步等操作的支持也相对较弱，导致我们在使用过程中频繁查阅文档，且许多操作并不稳定。例如，使用 FIO 等工具进行测速时，结果并不总是可靠。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c94f454704e94b8f8b3fe6de4622d9a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768381278&amp;x-signature=kJiyQY%2FdeksFqPR3s0mmpZ83OtQ%3D" alt="" loading="lazy"/></p>
<p><strong>更为严重的问题是，当存储的小文件数量达到一定规模时，GlusterFS 的性能会急剧下降</strong>。举个例子，一个模型可能会生成 100 张图片，若有 1000 万个模型，就会产生 10 亿张图片。GlusterFS 在后期的寻址变得极为困难，尤其是小文件过多时，性能会显著下降，导致系统崩溃。</p>
<h3 data-id="heading-4">最终选型：CephFS vs JuiceFS</h3>
<p>随着存储需求的增加，我们决定转向可持续性更好的方案。在评估了多种方案后，我们主要对比了 CephFS 和 JuiceFS。虽然 Ceph 被广泛使用，但通过自己的实践和对比文档，我们发现 Ceph 的运维和管理成本非常高，尤其对于我们这样的小团队来说，处理这些复杂的运维任务显得尤为困难。</p>
<p>JuiceFS 有两个原生自带的特性非常符合我们的需求。<strong>首先是客户端数据缓存功能</strong>。对于我们的模型训练集群，通常会配备高性能的 NVMe 存储。如果能够充分利用客户端的缓存，便能显著加速模型训练，并减少对 JuiceFS 存储的压力。</p>
<p><strong>其次，JuiceFS 对 S3 的兼容性对我们也至关重要</strong>。由于我们基于存储开发了一些可视化平台用于数据标注、整理和统计，S3 兼容性使得我们能够快速进行网页开发，支持可视化和数据统计操作等功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed3dffd8b85f4e5bb15575c83732b5c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768381278&amp;x-signature=p5YsKGyMWCTD36jK3nbqdL%2B1oZM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">03 基于 JuiceFS 的存储平台实践</h2>
<h3 data-id="heading-6">元数据引擎选择与拓扑</h3>
<p>JuiceFS 采用的是元数据与数据分离的架构，有多种元数据引擎可供选择。我们首先快速验证了 Redis 存储方案，官方提供了详细的文档支持。Redis 的优势在于其轻量化，配置过程通常只需一天或半天时间，数据迁移也相对顺利。<strong>然而，当小文件数量超过 1 亿时，Redis 的速度和性能会显著下降</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6237420fd584e9cb6a18f26347eaf73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768381278&amp;x-signature=5vttxVsFK6gTLrdhulyDWdbiO2M%3D" alt="" loading="lazy"/></p>
<p>正如之前提到的，每个模型可能会渲染出 100 张图片，再加上其他杂项文件，导致小文件的数量急剧增加。虽然我们可以通过打包小文件来减轻问题，但一旦打包后进行修改或可视化操作，复杂性就大大增加。因此，我们希望能够保留原始的小图片文件，以便后续处理。</p>
<p>随着文件数量的增加，很快超出 Redis 的处理能力，我们决定将存储系统迁移到 TiKV 和 Kubernetes 组合上。TiKV 与 K8s 的组合能够为我们提供更高可用的元数据存储方案。此外，通过基准测试我们发现，尽管 TiKV 的性能稍逊一筹，但差距并不显著，且相较于 Redis，它对小文件的支持更好。我们也咨询过 JuiceFS 的工程师，了解到 Redis 在集群模式下的扩展性较差，于是我们准备切换到 TiKV。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa5fdeb97c244e209bc099cbc4f0ba4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768381278&amp;x-signature=efEkRQL86M0W1FuGrv8VX94gX9k%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">最新架构：JuiceFS + TiKV + SeaweedFS</h3>
<p>我们使用了 JuiceFS 来管理对象存储。TiKV 和 K8s 来搭建元数据存储系统。对象存储部分使用了 SeaweedFS，这使得我们能够快速扩展存储规模，且无论是小数据还是大数据，访问速度都很快。此外，我们的对象存储分布在多个平台：包括本地存储、阿里云存储以及国外的 R2 和 Amazon 对象存储。通过 JuiceFS，我们能够将这些不同存储系统集成起来，并提供一个统一的接口。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea49b530cada47728a000cbfc47ad18f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768381278&amp;x-signature=hLAbSDIzujWwsOEqGOvacqk2nWI%3D" alt="" loading="lazy"/></p>
<p>为了更好地管理系统资源，我们在 K8s 上搭建了资源监控平台。当前系统由大约 60 台 Linux 机器和若干 Windows 机器组成，负责渲染和数据处理任务。我们对读取稳定性进行了监控，结果显示，即使是多台异构服务器同时进行读取操作，整个系统的 I/O 性能依然非常稳定，基本能够充分利用带宽资源。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6222d614784476dbd77800057b643aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768381278&amp;x-signature=yuMT9Jc%2BbpF4MMXurjWNxFj4tGE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">实践中遇到的问题</h3>
<p>在优化存储方案的过程中，我们最初尝试了 EC（纠删码） 存储方案，旨在减少存储需求并提升效率。然而，在大规模数据迁移中，EC 存储的计算速度较慢，并且在高吞吐量和频繁数据变化的场景下，性能表现不佳，尤其与 SeaweedFS 结合时，存在性能瓶颈。基于这些问题，我们决定放弃 EC 存储，转而采用副本存储方案。</p>
<p>我们设置了独立服务器并配置了定时任务，以进行大数据量的元数据备份。在 TiKV 中，我们实现了冗余副本机制，采用了多个副本方案来确保数据的完整性。同时，在对象存储方面，我们采用了双副本编码来进一步提高数据可靠性。虽然副本存储能够有效保证数据冗余和高可用性，但由于处理 PB 级数据和大量增量数据，存储成本依然较高。未来，我们可能会考虑进一步优化存储方案，以降低存储成本。</p>
<p>另外，我们也发现当使用全闪存服务器 + JuiceFS 并未带来显著的性能提升。瓶颈主要出现在网络带宽和延迟上。因此，我们计划在后期考虑使用 InfiniBand（IB）连接存储服务器和训练服务器，以最大化资源利用效率。</p>
<h2 data-id="heading-9">04 小结</h2>
<p>在使用 GlusterFS 时，我们每天最多只能处理 20 万个模型；<strong>而切换到 JuiceFS 后，处理能力大幅提升，日均数据处理能力增加了 2.5 倍，小文件吞吐能力也显著提高，特别是在存储量达到 70% 后，系统仍能保持稳定运行</strong>。此外，扩容也非常便捷，而之前的架构，扩容过程非常繁琐，操作起来比较麻烦。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/825e8a4c32d84a52aaaee70a65f8a8db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768381278&amp;x-signature=dMSPvcMzulaW0K6z33XgdsvXbp8%3D" alt="" loading="lazy"/></p>
<p>最后再总结一下 JuiceFS 在三维生成任务中表现出来的优势：</p>
<ul>
<li>
<p><strong>小文件性能</strong>： 小文件处理能力是一个关键点，JuiceFS 依然提供了一个较好的解决方案。</p>
</li>
<li>
<p><strong>跨平台特性</strong>： 跨平台支持非常重要。我们发现有些数据只能在 Windows 软件中打开，因此需要同时在 Windows 和 Linux 系统上处理相同的数据，并在同一个挂载节点上进行读写。这种需求使得跨平台的特性尤为关键，JuiceFS 的设计很好地解决了这一问题。</p>
</li>
<li>
<p><strong>低运维成本</strong>： JuiceFS 的运维成本极低。配置完成后，只需要进行一些简单的测试和节点的管理（例如，丢弃某些节点并监控鲁棒性）。我们在迁移数据时花费了大约半年的时间，到目前为止并未遇到太大的问题。</p>
</li>
<li>
<p><strong>本地缓存机制</strong>： 之前，如果想使用本地缓存，我们需要手动在代码中实现本地缓存逻辑，但 JuiceFS 提供了非常方便的本地缓存机制，通过设置挂载参数来优化训练场景的性能。</p>
</li>
<li>
<p><strong>迁移成本低</strong>： 尤其是在迁移小文件时，我们发现使用 JuiceFS 进行元数据和对象存储的迁移非常方便，节省了我们大量时间和精力。相比之下，之前使用其他存储系统迁移时，过程非常痛苦。</p>
</li>
</ul>
<p>综上所述，JuiceFS 在大规模数据处理中的表现非常出色，提供了高效、稳定的存储解决方案。它不仅简化了存储管理和扩容过程，还大大提升了系统性能，让我们能够更加专注于核心任务的推进。</p>
<p>此外，官方提供一些工具也非常便捷，例如我们使用 Sync 在处理小文件迁移时，效率极高。在没有额外性能优化的情况下，我们成功迁移了 500TB 的数据，其中包含大量的小数据和图片文件，迁移时间不到 5 天，结果超出我们的预期。</p>
<p>我们希望本文中的一些实践经验，能为正在面临类似问题的开发者提供参考，如果有其他疑问欢迎加入 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjuicefs.com%2Fzh-cn%2F" target="_blank" title="https://juicefs.com/zh-cn/" ref="nofollow noopener noreferrer">JuiceFS 社区</a>与大家共同交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在国内也能使用 Claude cli给自己提效，附实操方法]]></title>    <link>https://juejin.cn/post/7592040819819184169</link>    <guid>https://juejin.cn/post/7592040819819184169</guid>    <pubDate>2026-01-07T07:04:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592040819819184169" data-draft-id="7592134330313293867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在国内也能使用 Claude cli给自己提效，附实操方法"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-07T07:04:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="demo007x"/> <meta itemprop="url" content="https://juejin.cn/user/78820566119870"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在国内也能使用 Claude cli给自己提效，附实操方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/78820566119870/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    demo007x
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T07:04:32.000Z" title="Wed Jan 07 2026 07:04:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">在国内也能使用 Claude cli给自己提效，附实操方法</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aef140d3b5e24d30a7e6345bca3720a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGVtbzAwN3g=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768374272&amp;x-signature=lJG8kuP1fG4Sj%2FgT8M6O%2BiaUs2A%3D" alt="image.png" loading="lazy"/></p>
<p>众所周知 Anthropic 公司于2025年9月5日更新政策，禁止中国企业和个人使用Claude服务，涵盖中国大陆及海外子公司，并拦截通过云服务等间接访问方式。</p>
<p>Claude CLI是Anthropic推出的交互式命令行工具，它将强大的 ClaudeAI 能力直接集成到你的终端环境中。与传统的AI聊天工具不同，ClaudeCLI 专为软件工程Q任务设计，能够直接读取、编辑代码文件，执行命令，甚至管理整个项目的开发流程。</p>
<h3 data-id="heading-1">实操方法</h3>
<h4 data-id="heading-2">安装Claude CLI</h4>
<p>首先你需安装 nodeJS，推荐安装最新版本。</p>
<p>然后打开你机器的终端（terminal）使用 npm 安装 Claude CLI：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g @anthropic-ai/claude-code
</code></pre>
<p>这样安装的 Claude CLI 会全局可用。版本为 claude-cli 的最新版本，如果你发现这个版本不可用，可以使用下面的固定版本(2.0.57)，实测可用。使用以下命令：</p>
<pre><code class="hljs language-css" lang="css">npm install -g <span class="hljs-keyword">@anthropic-ai</span>/claude-code<span class="hljs-keyword">@2</span>.0.57
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16f5febf33ae4bb1b7bd1e65cd24e7d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGVtbzAwN3g=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768374272&amp;x-signature=hmIJb%2F9ljxYCBPUT89nBA%2FEBuUA%3D" alt="image.png" loading="lazy"/>
安装完成后在 terminal 中输入claude, 如果出现提示命令未找到，则说明安装成功，如果出现其他错误，则说明安装失败，请检查网络是否正常，或者尝试重新安装。</p>
<h4 data-id="heading-3">配置Claude CLI</h4>
<p>配置Claude CLI需要一个Claude账号，如果没有请先注册一个。当然在国内是经不能注册 claude 账户了；那么我们可以使用智谱的API，完美兼容 Claude API 服务。</p>
<p>1、首先你需要一个智谱账号，如果没有请先注册一个。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bigmodel.cn%2Fglm-coding%3Fic%3DBYIKDI0LB5" target="_blank" title="https://www.bigmodel.cn/glm-coding?ic=BYIKDI0LB5" ref="nofollow noopener noreferrer">智谱 GLM Coding</a></p>
<p>2、获取你的智谱API密钥，打开<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bigmodel.cn%2Fglm-coding%3Fic%3DBYIKDI0LB5" target="_blank" title="https://www.bigmodel.cn/glm-coding?ic=BYIKDI0LB5" ref="nofollow noopener noreferrer">apikeys</a>查看你的API密钥。你也可以重新生成一个。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8db2b88ec237424f983e349ec86b0592~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGVtbzAwN3g=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768374272&amp;x-signature=dEdy0tIdu8%2F0kqaIlRog%2FuLJVjg%3D" alt="image.png" loading="lazy"/>
3、打开你自己电脑的目录 <code>C:\Users\youusername.claude</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be50e497d9514eeba2783b4605b71521~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGVtbzAwN3g=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768374272&amp;x-signature=vu8oL%2FfTmNkABhqX8UUHwIb9BwI%3D" alt="image.png" loading="lazy"/></p>
<p>4、将你的API密钥写入 <code>config.json</code> 文件中，格式如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ANTHROPIC_AUTH_TOKEN"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你自己的 apikeys"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ANTHROPIC_BASE_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://open.bigmodel.cn/api/anthropic"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"API_TIMEOUT_MS"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3000000"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>5、保存文件，然后在 terminal 中输入claude，如果出现提示命令未找到，则说明配置成功，不出意外， Claude CLI 将会启动。如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71ee7e51b6a94f88948ae31938eb905e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGVtbzAwN3g=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768374272&amp;x-signature=3vw%2BD38wr%2FNeAVI4Td4v2wUboaw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">编写第一个Claude CLI程序</h4>
<p>1、打开你的终端（terminal），输入 <code>claude</code>，如果出现提示命令未找到，则说明配置成功，不出意外， Claude CLI 将会启动。</p>
<p>2、输入我们的prompt或者是要求：“帮我创建一个企业官网的首页 index.html”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7f33ddf0974423ebb38259082c3862b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGVtbzAwN3g=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768374272&amp;x-signature=GR%2FjmKiMt61z7juzVY%2B2YjFABEo%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/185599319a3441a0b01a75d202620b8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGVtbzAwN3g=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768374272&amp;x-signature=K%2F76KWUk8Mn8Carykziz1a3FqLA%3D" alt="image.png" loading="lazy"/></p>
<p>3、Claude CLI 将会按照我们的要求帮我们生成 index.html 的文件，包括HTML结构，CSS样式，JavaScript脚本。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1808f8342c141a2b225dad42cea457d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGVtbzAwN3g=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768374272&amp;x-signature=x%2B7xaEeDV6wR9E7UL1Png%2Fafl%2BY%3D" alt="image.png" loading="lazy"/></p>
<p>两分钟后，页面做完了。一起来看效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/785d963ba5bb41d3984ef9c26b54f6d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGVtbzAwN3g=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768374272&amp;x-signature=iJWqsAXqTS6Vo9uRzCStZ6miz7Q%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">总结</h3>
<p>通过以上步骤，你已经成功安装并配置了Claude CLI，并编写了一个简单的程序。Claude CLI 的功能远不止于此，它还支持读取、编辑代码文件，执行命令，甚至管理整个项目的开发流程。希望这篇教程能帮助你快速上手 Claude CLI，并在你的开发工作中发挥重要作用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年最火的前端项目出炉，No.1 易主！]]></title>    <link>https://juejin.cn/post/7592134330313179179</link>    <guid>https://juejin.cn/post/7592134330313179179</guid>    <pubDate>2026-01-07T06:44:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592134330313179179" data-draft-id="7592040819819085865" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年最火的前端项目出炉，No.1 易主！"/> <meta itemprop="keywords" content="前端,JavaScript,Node.js"/> <meta itemprop="datePublished" content="2026-01-07T06:44:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年最火的前端项目出炉，No.1 易主！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T06:44:42.000Z" title="Wed Jan 07 2026 06:44:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    206
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>快来看！JavaScript Rising Stars 公布了 <a href="https://link.juejin.cn?target=https%3A%2F%2Frisingstars.js.org%2F2025%2Fen" target="_blank" title="https://risingstars.js.org/2025/en" ref="nofollow noopener noreferrer">2025 年 JavaScript 明星项目榜单</a>。</p>
<p>此榜单根据 2025 年 GitHub 新增的星标数量，还建立了以下榜单：</p>
<p>最受欢迎的项目、前端框架、React 生态系统、后端/全栈、构建工具、人工智能、移动端、Vue 生态系统、状态管理、CSS in JS、组件库、测试、桌面端、静态站点、GraphQL。</p>
<p>让我们看一看都是哪些项目上榜了。</p>
<h2 data-id="heading-1">2. 最受欢迎项目</h2>
<p>2025 最受欢迎的 JavaScript 项目 Top 10 分别是：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ecc272d2c4642718e4c97fdd49be41b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=zjsMca3LufT5Xvmu6eJi44k8u4g%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">2.1. 总冠军：n8n 🏆</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fn8n.io%2F" target="_blank" title="https://n8n.io/" ref="nofollow noopener noreferrer">n8n</a> 是 2025 年的绝对赢家，一年内获得了超过 112000 个星标。过往从来没有一个项目在一年内获得如此多的星标。</p>
<p>n8n 是一个工作流自动化平台，具备原生 AI 功能，可通过可视化工作流连接各种应用程序和服务。它的成功反映了市场对无代码自动化工具日益增长的需求。</p>
<p>此外，在前 10 中还有 3 个与 AI 有关的项目，分别是：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fonlook.com%2F" target="_blank" title="https://onlook.com/" ref="nofollow noopener noreferrer">Onlook</a>：为 React 应用带来 AI 优先的视觉编辑功能</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdyad.sh%2F" target="_blank" title="https://dyad.sh/" ref="nofollow noopener noreferrer">Dyad</a>：一款免费、本地化、开源的 AI 应用构建器，也是 v0/lovable/Bolt 的替代方案</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstagehand.dev%2F" target="_blank" title="https://stagehand.dev/" ref="nofollow noopener noreferrer">Stagehand</a>：AI 驱动的浏览器自动化</li>
</ul>
<h3 data-id="heading-3">2.2. 亚军：React Bits</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Freactbits.dev%2F" target="_blank" title="https://reactbits.dev/" ref="nofollow noopener noreferrer">React Bits</a> 是一系列精美的 React 动画组件（背景效果、文本动画、卡片等），非常适合构建令人印象深刻的网站。</p>
<p>有趣的是，它以 shadcn/ui 项目的形式分发，可以通过命令行从 shadcn/ui 注册表获取，也可以通过传统的复制粘贴方式添加到代码库中。</p>
<p>该文档附带一个后台工作室，可让你调整和自定义所有组件的设置（颜色、速度、粒子数量……），并将其导出为代码片段，你可以将其复制粘贴到代码库中。</p>
<h3 data-id="heading-4">2.3. 季军：shadcn-ui</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fui.shadcn.com%2F" target="_blank" title="https://ui.shadcn.com/" ref="nofollow noopener noreferrer">shadcn-ui</a> 是 2023 年和 2024 年的冠军，2025 年依然保持了强劲的发展势头。</p>
<p>这是一套设计精良、注重细节（例如可访问性、键盘交互等）且风格统一的 React 组件，融合了 Radix UI、TanStack Table 等无头组件的精华……</p>
<p>shadcn/ui 最令人惊叹的特点是，它在开箱即用的功能和可定制性之间找到了最佳平衡点。</p>
<h2 data-id="heading-5">3. 前端框架</h2>
<p>前端框架 Top 15 分别是：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90422fbb0d724cc19205216d2cec76e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=IKkAba%2BumSs4gSiR3MmwuS0ArIw%3D" alt="" loading="lazy"/></p>
<p>React 重新夺回了 2024 年被 htmx 夺走的王冠。</p>
<p>虽然有关于 Solid 或 Svelte 等替代方案是否更适合新项目的争论，但因为 LLMs 基于 React 代码库进行训练，使得这些替代方案很难获得市场份额。</p>
<p>React 19 引入了重大改进，包括 <strong>Activity API</strong> 和用于管理用户事件的增强型 hooks。</p>
<p>说到 effects，Cloudflare 因为错误使用 useEffect ，导致无限调用其 API ，最终导致自身遭受 DDoS 攻击，造成了服务中断。</p>
<p>React 向服务器端迁移，推出了 React Server Components，这是近年来最大的变革。然而，这种变革也带来了巨大的功能和风险，例如 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact2shell.com%2F" target="_blank" title="https://react2shell.com/" ref="nofollow noopener noreferrer">React2Shell</a> 漏洞，这是一个 React Server Components 中的远程代码执行 (RCE) 漏洞，需要紧急发布补丁进行修复。（<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2025%2F12%2F03%2Fcritical-security-vulnerability-in-react-server-components" target="_blank" title="https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components" ref="nofollow noopener noreferrer">2025 年 12 月 3 日</a>，<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2025%2F12%2F11%2Fdenial-of-service-and-source-code-exposure-in-react-server-components" target="_blank" title="https://react.dev/blog/2025/12/11/denial-of-service-and-source-code-exposure-in-react-server-components" ref="nofollow noopener noreferrer">2025 年 12 月 11 日）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fripplejs.com%2F" target="_blank" title="https://ripplejs.com/" ref="nofollow noopener noreferrer">Ripple</a> 位列第二，是前五名中的新秀。它是一个全新的 UI 框架，融合了 React、Solid 和 Svelte 的优点。它拥有响应式原语、组件化架构和模板语法。</p>
<p>目前仍处于早期开发阶段。React 有 Next.js，Vue.js 有 Nuxt，Svelte 有 SvelteKit，Solid 有 SolidStart……Ripple 是否也会有自己的元框架来处理服务器端渲染？</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsvelte.dev%2F" target="_blank" title="https://svelte.dev/" ref="nofollow noopener noreferrer">Svelte</a> 连续第三年位列第三。Svelte 5 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsvelte.dev%2Fdocs%2Fsvelte%2Fwhat-are-runes" target="_blank" title="https://svelte.dev/docs/svelte/what-are-runes" ref="nofollow noopener noreferrer">Runes</a> 响应式系统（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">state、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">、</span></span></span></span></span>derived、$effect）已成为状态管理的标准方式。</p>
<h2 data-id="heading-6">4. React 生态系统</h2>
<p>React 生态系统 Top 10 分别是：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b58e5280c2f14b13944b16bce0e4d57e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=%2BuiZO2m0aA070ZZbawNXNJlZNSY%3D" alt="" loading="lazy"/></p>
<p>2025 年，React 生态系统迎来了一个明显的转折点，其核心在于一个长期存在的矛盾：日益强大的服务器端功能与保持客户端开发简洁性和可预测性之间的冲突。</p>
<p>在 Next.js 的引领下，React 向服务器组件、服务器函数和流式传输的转型，开启了性能和架构方面的新可能。与此同时，这种转变也引入了一种新的思维模式：理解客户端-服务器边界、数据生命周期和渲染阶段对于日常开发至关重要。</p>
<p>社区对此反应不一。</p>
<p>一些人欣然接受新的服务器优先方向，认为这是 React 的自然演进；而另一些人则质疑，这种增加的复杂性是否值得用于日常 UI 开发。围绕服务器功能和请求边界的安全事件进一步加剧了这场争论。这些事件暴露了高度抽象的全栈模式带来的风险，同时也表明了另一件事：React 的服务器端模型已经达到了实际应用的程度，其假设正在生产环境中接受压力测试、审计和挑战。</p>
<p>在此背景下，TanStack Start 因其以更以客户端为中心（且同构）的视角看待 React 的新功能而备受关注，它优先考虑清晰性、类型安全性和显式控制。这自然而然地将讨论的焦点从框架本身转移到了关于开发者应该接受多少抽象以及复杂性真正归属的理念之争，而非功能竞赛。</p>
<h2 data-id="heading-7">5. 后端 / 全栈</h2>
<p>后端 / 全栈 Top 10 分别是：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be8bf6275d4f4099819c15ebdebc0538~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=2FvvI6OV6kflCtxxUCFhWgmy3NQ%3D" alt="" loading="lazy"/></p>
<p>一款新晋产品荣获后端/全栈类别冠军！</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmotia.dev%2F" target="_blank" title="https://motia.dev/" ref="nofollow noopener noreferrer">Motia</a> 代表了后端工程领域的范式转变，它将以往需要多个独立框架才能实现的功能整合到一个系统中。用户无需再为 API、后台任务、队列、工作流、数据流和 AI 代理等各种工具而烦恼，Motia 提供了一个涵盖所有后端功能的统一框架。</p>
<p>Motia 的核心是使用名为“步骤”<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.motia.dev%2Fdocs%2Fconcepts%2Fsteps" target="_blank" title="https://www.motia.dev/docs/concepts/steps" ref="nofollow noopener noreferrer">（Steps）</a>的基本单元，它是一种单一的抽象概念，定义了代码的运行方式、运行时间、运行地点以及运行内容。每个步骤都包含一个配置（用于定义触发器、路径和计划任务）和一个处理程序（用于执行业务逻辑）。更改步骤类型，相同的模式即可应用于不同的用例：API 端点、事件处理程序或定时任务。</p>
<p>步骤可以用 TypeScript 或 Python 编写。它还通过 Workbench 提供内置的可观察性，Workbench 是一个可视化控制面板，用于管理、调试和观察运行情况，此外还内置了状态管理和流式传输功能。</p>
<p>接下来的 4 个项目与 2024 年相同，只是 Hono 和 Astro 的位置互换了。</p>
<p>去年排名第一的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpayloadcms.com%2F" target="_blank" title="https://payloadcms.com/" ref="nofollow noopener noreferrer">Payload 是一款基于 Next.js 的混合型无头 CMS 和管理面板。最大的新闻是它</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fpayloadcms.com%2Fposts%2Fblog%2Fpayload-is-joining-figma" target="_blank" title="https://payloadcms.com/posts/blog/payload-is-joining-figma" ref="nofollow noopener noreferrer">被 Figma 收购</a>，其最终目标是缩小设计与代码之间的差距。</p>
<p>Next.js 16 引入了<a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fblog%2Fnext-16%23cache-components" target="_blank" title="https://nextjs.org/blog/next-16#cache-components" ref="nofollow noopener noreferrer">缓存组件</a>，使缓存机制更加明确和灵活。开发者可以创建包含来自服务器的动态内容流的静态页面框架。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fastro.build%2F" target="_blank" title="https://astro.build/" ref="nofollow noopener noreferrer">Astro</a> 位列第四，它继续闪耀着光芒，作为一个多功能的框架，可以构建内容丰富的应用程序（例如您喜爱的 JS Rising Stars！），同时提供良好的开发者体验并注重性能。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhono.dev%2F" target="_blank" title="https://hono.dev/" ref="nofollow noopener noreferrer">Hono</a> 位列第五，凭借其轻量级核心（可在 Node.js 运行时、Cloudflare 工作进程等各种环境中运行）以及丰富的处理器和中间件生态系统，成为现代 Web 服务器的标准（即使 <a href="https://link.juejin.cn?target=https%3A%2F%2Fexpressjs.com%2F" target="_blank" title="https://expressjs.com/" ref="nofollow noopener noreferrer">Express 仍然流行！）。</a></p>
<p>元框架类别中最大的变化是<a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Fstart%2Flatest" target="_blank" title="https://tanstack.com/start/latest" ref="nofollow noopener noreferrer">Tanstack Start</a>的崛起，如果你想在 React 之上构建全栈应用程序，它是 Next.js 的最佳替代方案之一。</p>
<h2 data-id="heading-8">6. 工具</h2>
<p>工具 Top 5 分别是：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06a12e0f133d4e70acc67461df248a82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=cC8H9AIzxFl4f5kri5a72rYE6Mc%3D" alt="" loading="lazy"/></p>
<p>Bun 的持续努力最终获得了回报，这款一体化 JavaScript 工具包荣登榜首。在过去的一年中，它不断提升性能、增强对<a href="https://link.juejin.cn?target=https%3A%2F%2Fbun.com%2Fblog%2Fbun-v1.2%23node-js-compatibility" target="_blank" title="https://bun.com/blog/bun-v1.2#node-js-compatibility" ref="nofollow noopener noreferrer">Node.js 的兼容性</a>，并推出许多实用新功能，使其成为<a href="https://link.juejin.cn?target=https%3A%2F%2Fbun.com%2Fblog%2Fbun-v1.3%23full-stack-javascript-runtime" target="_blank" title="https://bun.com/blog/bun-v1.3#full-stack-javascript-runtime" ref="nofollow noopener noreferrer">全栈 JavaScript 开发的理想平台</a>。年底，Bun 被 Anthropic 收购，我们非常期待 2026 年 Bun 的发展。</p>
<p>今年对 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvoidzero.dev%2F" target="_blank" title="https://voidzero.dev/" ref="nofollow noopener noreferrer">void(0)</a> 来说也意义非凡。该公司<a href="https://link.juejin.cn?target=https%3A%2F%2Fvoidzero.dev%2Fposts%2Fannouncing-voidzero-inc" target="_blank" title="https://voidzero.dev/posts/announcing-voidzero-inc" ref="nofollow noopener noreferrer">在 2024 年底宣布</a>，其正在开发新一代前端基础设施工具（Oxc 和 Rolldown），并已让我们得以一窥未来发展方向。其旗舰项目 Vite 在这一年中持续改进，稳定了新的<a href="https://link.juejin.cn?target=https%3A%2F%2Fmain.vite.dev%2Fguide%2Fapi-environment" target="_blank" title="https://main.vite.dev/guide/api-environment" ref="nofollow noopener noreferrer">Environment API</a>，并实现了对<a href="https://link.juejin.cn?target=https%3A%2F%2Fvite.dev%2Fblog%2Fannouncing-vite8-beta" target="_blank" title="https://vite.dev/blog/announcing-vite8-beta" ref="nofollow noopener noreferrer">基于 Rust 的全新打包工具 Rolldown 的</a>支持。该项目甚至还拥有了自己的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DbmWQqAKLgT4" target="_blank" title="https://www.youtube.com/watch?v=bmWQqAKLgT4" ref="nofollow noopener noreferrer">纪录片</a>。Vitest 也发布了其最受期待的功能之一：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvoidzero.dev%2Fposts%2Fannouncing-vitest-4" target="_blank" title="https://voidzero.dev/posts/announcing-vitest-4" ref="nofollow noopener noreferrer">浏览器模式</a>。Oxc 生态系统中涌现出许多令人兴奋的新项目，它们将成为现有工具极具吸引力的替代方案：<a href="https://link.juejin.cn?target=https%3A%2F%2Foxc.rs%2Fblog%2F2025-06-10-oxlint-stable.html" target="_blank" title="https://oxc.rs/blog/2025-06-10-oxlint-stable.html" ref="nofollow noopener noreferrer">Oxlint</a>有望成为新一代 ESLint，而<a href="https://link.juejin.cn?target=https%3A%2F%2Foxc.rs%2Fblog%2F2025-12-01-oxfmt-alpha.html" target="_blank" title="https://oxc.rs/blog/2025-12-01-oxfmt-alpha.html" ref="nofollow noopener noreferrer">Oxfmt 则</a>可能成为新一代 Prettier。该公司在年底完成了<a href="https://link.juejin.cn?target=https%3A%2F%2Fvoidzero.dev%2Fposts%2Fannouncing-series-a" target="_blank" title="https://voidzero.dev/posts/announcing-series-a" ref="nofollow noopener noreferrer">新一轮 A 轮融资</a>，并发布了其首款商业产品<a href="https://link.juejin.cn?target=https%3A%2F%2Fvoidzero.dev%2Fposts%2Fannouncing-vite-plus" target="_blank" title="https://voidzero.dev/posts/announcing-vite-plus" ref="nofollow noopener noreferrer">Vite+</a>。</p>
<p>值得一提的还有<a href="https://link.juejin.cn?target=https%3A%2F%2Frspack.rs%2F" target="_blank" title="https://rspack.rs/" ref="nofollow noopener noreferrer">Rspack</a>。这款来自字节跳动的基于 Rust 的打包工具，速度更快，而且可以即插即用，是 webpack 的替代方案，因此它<a href="https://link.juejin.cn?target=https%3A%2F%2Fnpmtrends.com%2F%40rspack%2Fcore" target="_blank" title="https://npmtrends.com/@rspack/core" ref="nofollow noopener noreferrer">今年被广泛采用</a>也就不足为奇了。更广泛的 Rstack 生态系统也值得关注，它催生了<a href="https://link.juejin.cn?target=https%3A%2F%2Frstest.rs%2F" target="_blank" title="https://rstest.rs/" ref="nofollow noopener noreferrer">Rstest</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Frslint.org%2F" target="_blank" title="https://rslint.org/" ref="nofollow noopener noreferrer">Rslint</a>等新工具。</p>
<p>Next.js 最近将默认打包工具<a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fblog%2Fnext-16%23turbopack-stable" target="_blank" title="https://nextjs.org/blog/next-16#turbopack-stable" ref="nofollow noopener noreferrer">切换为 Turbopack</a> ，相比之前的打包工具 webpack，速度有了显著提升。需要注意的是，也可以<a href="https://link.juejin.cn?target=https%3A%2F%2Frspack.rs%2Fblog%2Frspack-next-partner" target="_blank" title="https://rspack.rs/blog/rspack-next-partner" ref="nofollow noopener noreferrer">使用 Rspack 构建 Next.js 应用</a>。</p>
<p>尽管尚未完全成熟，但微软用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Ftypescript%2Ftypescript-native-port%2Fhttps%3A%2F%2Fdevblogs.microsoft.com%2Ftypescript%2Ftypescript-native-port%2F" target="_blank" title="https://devblogs.microsoft.com/typescript/typescript-native-port/https://devblogs.microsoft.com/typescript/typescript-native-port/" ref="nofollow noopener noreferrer">Go 语言重写 TypeScript</a>无疑是今年最重要的公告之一，这将显著提升其速度。团队近期<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Ftypescript%2Fprogress-on-typescript-7-december-2025%2F" target="_blank" title="https://devblogs.microsoft.com/typescript/progress-on-typescript-7-december-2025/" ref="nofollow noopener noreferrer">分享了最新进展</a>，原生 TypeScript 体验似乎已经准备好迎接早期用户。TypeScript 6.0 将是最后一个基于 JavaScript 的版本，它将作为过渡到 TypeScript 7.0（Go 重写版）的桥梁。展望 2025 年，现代基础设施工具越来越多地源自大型企业或风险投资支持的公司，这引发了一个重要问题：成熟的、社区驱动的项目能否在未来一年保持竞争力？</p>
<h2 data-id="heading-9">7. 人工智能</h2>
<p>人工智能 Top 10 分别是：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74036c20abac48289c5af6dc3491b66e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=chKX8nRWjWklwrLGTDiU0ogiyP4%3D" alt="" loading="lazy"/></p>
<p>聊天机器人时代已经结束。如今开发者们更关注的工具并非聊天机器人库或提示器，而是工作流引擎。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fn8n.io%2F" target="_blank" title="https://n8n.io/" ref="nofollow noopener noreferrer">n8n</a> 的表现令人瞩目，预计 2025 年用户数量将增长 11.2 万。这并不令人意外，n8n 正在成为连接前沿模型和构建这些代理工具的首选工具。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdyad.sh%2F" target="_blank" title="https://dyad.sh/" ref="nofollow noopener noreferrer">Dyad</a> 、<a href="https://link.juejin.cn?target=https%3A%2F%2Fflowiseai.com%2F" target="_blank" title="https://flowiseai.com/" ref="nofollow noopener noreferrer">Flowise</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fmastra.ai%2F" target="_blank" title="https://mastra.ai/" ref="nofollow noopener noreferrer">Mastra</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fstagehand.dev%2F" target="_blank" title="https://stagehand.dev/" ref="nofollow noopener noreferrer">Stagehand</a> 等公司堪称自动化和代理工作流领域的佼佼者。Vercel 仍然是那些希望从底层掌控聊天和代理流程的用户的首选（但他们也在不断添加代理功能）。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTanStack%2Fai" target="_blank" title="https://github.com/TanStack/ai" ref="nofollow noopener noreferrer">TanStack AI</a> 虽然是后起之秀，但凭借其强大的代理功能，正在迅速崛起。</p>
<p>所以，这是你们 2026 年的作业：别再问“如何让我的 LLM 做出更好的回应”，而是开始问“哪些工作流程可以完全交给 AI 处理？”</p>
<p>选择 n8n 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fflowiseai.com%2F" target="_blank" title="https://flowiseai.com/" ref="nofollow noopener noreferrer">Flowise</a>，构建一个能够根据事件触发、推理选项并自动执行操作的程序，无需征得许可。搭建一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fmastra.ai%2F" target="_blank" title="https://mastra.ai/" ref="nofollow noopener noreferrer">Mastra</a> 代理，使其能够跨多个工具和平台进行协调。尝试使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fstagehand.dev%2F" target="_blank" title="https://stagehand.dev/" ref="nofollow noopener noreferrer">Stagehand</a> 来自动化浏览器任务。</p>
<p>聊天机器人只是辅助轮，是时候卸掉它们了。</p>
<p>哦，还有，请关注一下<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cloudflare.com%2Fcode-mode%2F" target="_blank" title="https://blog.cloudflare.com/code-mode/" ref="nofollow noopener noreferrer">“code mode”</a>这匹黑马。它可能是自 MCP 以来这个领域最重大的突破。</p>
<h2 data-id="heading-10">8. 移动端</h2>
<p>移动端 Top 10 分别是：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/951a4e490a0143cba4bd5e651c97bb4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=5aD6WBCeP4awoF22c3r3EDvIG%2BM%3D" alt="" loading="lazy"/></p>
<p>在 JavaScript Rising Stars 评选活动长达十年的历史中，React Native 及其主要元框架 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.expo.dev%2F" target="_blank" title="https://docs.expo.dev/" ref="nofollow noopener noreferrer">Expo</a> 首次未能跻身移动端榜首。取而代之的是两个新晋框架 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" target="_blank" title="https://github.com/Snapchat/Valdi" ref="nofollow noopener noreferrer">Valdi</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Flynxjs.org%2F" target="_blank" title="https://lynxjs.org/" ref="nofollow noopener noreferrer">Lynx——</a>它们分别是 Snap（Snapchat 的母公司）和字节跳动（TikTok 的母公司）的内部框架。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" target="_blank" title="https://github.com/Snapchat/Valdi" ref="nofollow noopener noreferrer">Valdi</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Flynxjs.org%2F" target="_blank" title="https://lynxjs.org/" ref="nofollow noopener noreferrer">Lynx</a>对 React Native 开发者来说并不陌生。它们都借鉴了 Web 技术，能够渲染原生视图，同时支持 TypeScript、JSX、Flexbox 布局、热重载和 CSS。Valdi 组件的外观与 React 类组件<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi%2Fblob%2Fmain%2Fdocs%2Fdocs%2Fcore-component.md" target="_blank" title="https://github.com/Snapchat/Valdi/blob/main/docs/docs/core-component.md" ref="nofollow noopener noreferrer">类似</a>，而 Lynx 则同时支持命令式 API 和功能齐全的 <a href="https://link.juejin.cn?target=https%3A%2F%2Flynxjs.org%2Fguide%2Fstart%2Fquick-start%3Fios-simulator-platform%3Dmacos-arm64%26explorer-platform%3Dios-simulator" target="_blank" title="https://lynxjs.org/guide/start/quick-start?ios-simulator-platform=macos-arm64&amp;explorer-platform=ios-simulator" ref="nofollow noopener noreferrer">React 抽象层</a>（默认情况下推荐使用后者）。</p>
<p>它们之间的区别在于它们针对的业务需求进行了优化。Valdi 的设计目标是轻量级、延迟加载和可扩展，从而支持用户逐屏选择性地<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi%2Fblob%2Fmain%2Fdocs%2Fdocs%2Ffaq.md%23why-did-snap-create-this" target="_blank" title="https://github.com/Snapchat/Valdi/blob/main/docs/docs/faq.md#why-did-snap-create-this" ref="nofollow noopener noreferrer">启用新功能</a>，而不会造成显著的性能损失。Lynx 的设计目标是提供丰富的交互体验，它采用<a href="https://link.juejin.cn?target=https%3A%2F%2Flynxjs.org%2Fnext%2Fblog%2Flynx-unlock-native-for-more%23use-the-main-thread-responsibly-for-interactivity" target="_blank" title="https://lynxjs.org/next/blog/lynx-unlock-native-for-more#use-the-main-thread-responsibly-for-interactivity" ref="nofollow noopener noreferrer">双线程架构，</a>提供类似 Web 的抽象层，避免单线程瓶颈。</p>
<p>但它们并非唯一撼动 React Native 霸主地位的新兴框架。排名第四的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdioxuslabs.com%2F" target="_blank" title="https://dioxuslabs.com/" ref="nofollow noopener noreferrer">Dioxus</a> 是一个雄心勃勃的框架，旨在基于 Web 技术打造“<a href="https://link.juejin.cn?target=https%3A%2F%2Fdioxuslabs.com%2Flearn%2F0.7%2F%23what-is-dioxus" target="_blank" title="https://dioxuslabs.com/learn/0.7/#what-is-dioxus" ref="nofollow noopener noreferrer">更优秀的 Flutter</a> ”，但又无需功能齐全的 Web 视图。</p>
<p>虽然目前 Dioxus 默认使用系统 Web 视图，但其长期目标是稳定 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDioxusLabs%2Fblitz" target="_blank" title="https://github.com/DioxusLabs/blitz" ref="nofollow noopener noreferrer">Blitz</a> ——一个轻量级的 Web 渲染器，它通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgfx-rs%2Fwgpu" target="_blank" title="https://github.com/gfx-rs/wgpu" ref="nofollow noopener noreferrer">wgpu</a>使用原生图形 API（例如 Vulkan 和 Metal）进行绘制。目前，Dioxus 应用仅支持 Rust 脚本，但未来计划支持更多语言。</p>
<h2 data-id="heading-11">9. Vue 生态系统</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cd61abad1e949d0a91c6a66ec808457~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=Vf0K2EbbtocNQJnNkKlzDcALgrY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">10. 状态管理</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fddc5efa1be4b279a8ea66b6f37e405~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=5FKAJ3nYpeaIvKBVEBtosJnMA78%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">11. 样式 / CSS in JS</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e466df1b55c4ba79374aa1cd518a87b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=figdZsRJeRuUIBzO7jKEALiq798%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">12. 组件库</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bda131f86544a5090e48a32a1da3a30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=d6sxAU69HNVrIiomscjcfuYtUpQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">13. 测试</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/852157b412d04a849b47c06a695a68a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=Sz21mrefBVUKuUI9FpQIEBSsp04%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-16">14. 桌面端</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/395921e3bc834df69ddaa866799a256b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=tEEuj%2BvCSqGiTbpSg0D1aBhqirE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-17">15. 静态站点</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d638ec0ced104652b0fde1a45667a204~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=Dd0exnmnqUl0nspOZTzZj7aSkEI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-18">16. GraphQL</h2>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab485357b7a8406386bbdba8a3280393~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377245&amp;x-signature=u5t0Xk1%2Fu0aWb9iD%2BU5qnKqAvf0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-19">最后</h2>
<p>作为准前端开发专家的你，第一时间获取前端资讯、技术干货、AI 课程，那不得关注下我的公众号「冴羽」。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS App的tcp、udp数据包抓取在实际开发中的使用方式]]></title>    <link>https://juejin.cn/post/7592144524308774918</link>    <guid>https://juejin.cn/post/7592144524308774918</guid>    <pubDate>2026-01-07T07:06:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592144524308774918" data-draft-id="7592236397534609444" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS App的tcp、udp数据包抓取在实际开发中的使用方式"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-07T07:06:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS App的tcp、udp数据包抓取在实际开发中的使用方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T07:06:37.000Z" title="Wed Jan 07 2026 07:06:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我开始用数据流抓包的方式看 iOS 网络行为，是在一次很典型的场景里。</p>
<p>接口返回完全正常，日志也没有异常，但功能在真机上偶发失效。
代理抓包工具里，HTTPS 请求干净得不像是有问题的样子。</p>
<hr/>
<h2 data-id="heading-0"><strong>先明确一件事：iOS 数据流抓包在看什么</strong></h2>
<p>很多人第一次听到iOS 数据流抓包，会下意识以为这是 Wireshark 那一套。</p>
<p>但在实际调试中，我更关心的是一个更宽泛的范围：</p>
<ul>
<li>HTTPS 请求是否真实发出</li>
<li>Socket 通信是否建立</li>
<li>TCP / UDP 是否存在频繁断开</li>
<li>DNS 查询是否异常或被重试</li>
</ul>
<p>这些内容，统统属于 iOS 设备的数据流。</p>
<hr/>
<h2 data-id="heading-1"><strong>代理抓包为什么经常看不到这些问题</strong></h2>
<p>代理抓包工具更擅长的是“请求语义层”：</p>
<ul>
<li>URL、参数、Header</li>
<li>返回结构、状态码</li>
<li>请求重放和模拟</li>
</ul>
<p>但它们默认忽略了一个前提：<strong>只要请求不走代理，或者协议不是 HTTP，就直接消失。</strong></p>
<p>在涉及 Socket、长连接、DNS 异常时，这个盲区会被无限放大。</p>
<hr/>
<h2 data-id="heading-2"><strong>数据流抓包，是为了确认通信是否发生了</strong></h2>
<p>在进入具体操作前，我通常会先给自己一个明确目标，这一步不是为了看懂协议，而是确认数据有没有流动。</p>
<p>只要能确认有流量在哪一刻发生是否中断，就已经比 HTTPS 抓包多了一层信息。</p>
<hr/>
<h2 data-id="heading-3"><strong>通过 USB 抓取 iOS 设备的数据流</strong></h2>
<p>在这一步，我使用 <strong>抓包大师（Sniff Master）</strong> 来做设备侧的数据流抓包。</p>
<p>整个过程比想象中简单：</p>
<ul>
<li>用 USB 将 iOS 设备连接到电脑</li>
<li>在抓包大师中选择对应的 iOS 设备</li>
<li>在功能选择区切换到「数据流抓包」</li>
<li>进入数据流界面后点击开始</li>
</ul>
<p>不需要在 iOS 上配置代理，也不需要安装或信任证书。</p>
<hr/>
<h2 data-id="heading-4"><strong>只抓某个 App，是数据流分析的关键一步</strong></h2>
<p>如果直接抓整个设备的数据流，很快就会被信息淹没。</p>
<p>系统服务、后台同步、其他 App 的网络行为，会让你很难判断目标 App 在做什么。</p>
<p>在抓包大师里，可以通过「选择 App」的方式，只抓取指定 App 的数据流。
这一点在定位问题时非常重要。</p>
<hr/>
<h2 data-id="heading-5"><strong>从数据量变化中判断问题位置</strong></h2>
<p>有一次问题中，我并没有立刻尝试解析任何数据。</p>
<p>只是观察几件事：</p>
<ul>
<li>App 启动后是否立刻有 TCP 数据</li>
<li>数据包大小是否规律</li>
<li>某个操作是否伴随明显的数据流变化</li>
</ul>
<p>结果发现：
用户点击按钮后，HTTPS 请求正常返回，但对应的 Socket 数据几乎没有任何变化。</p>
<p>问题位置一下子就缩小了。</p>
<hr/>
<h2 data-id="heading-6"><strong>DNS 数据，也经常被忽略</strong></h2>
<p>在 iOS 数据流抓包中，DNS 是一个很容易被忽略的部分。</p>
<p>但在以下场景里，它非常关键：</p>
<ul>
<li>线上偶发无法连接</li>
<li>切换网络后恢复</li>
<li>不同地区表现不一致</li>
</ul>
<p>通过数据流抓包，可以看到 DNS 请求是否频繁失败或重试，这类问题用 HTTPS 抓包是很难发现的。</p>
<hr/>
<h2 data-id="heading-7"><strong>需要更深入分析时，再导出数据</strong></h2>
<p>当我已经确认问题大致发生在哪个阶段时，才会考虑进一步分析。</p>
<p>抓包大师支持将数据导出为 Wireshark 可用的格式，这一步通常用于：</p>
<ul>
<li>复盘复杂通信过程</li>
<li>与后端或网络同事协作</li>
<li>离线对比正常与异常样本</li>
</ul>
<p>在 Windows 或 Mac 上都可以完成，不依赖特定环境。</p>
<hr/>
<h2 data-id="heading-8"><strong>数据流抓包不是替代，而是补充</strong></h2>
<p>在实际工作中，我从来不会只靠数据流抓包解决所有问题。</p>
<p>更常见的组合是：</p>
<ul>
<li>代理抓包：验证接口语义</li>
<li>数据流抓包：确认通信事实</li>
<li>日志与代码：定位具体逻辑</li>
</ul>
<p>数据流抓包承担的，是把模糊问题拉回现实的作用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ubuntu服务器快速上手：初始配置与安全设置教程]]></title>    <link>https://juejin.cn/post/7592340733953736754</link>    <guid>https://juejin.cn/post/7592340733953736754</guid>    <pubDate>2026-01-07T07:18:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592340733953736754" data-draft-id="7592340733953703986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ubuntu服务器快速上手：初始配置与安全设置教程"/> <meta itemprop="keywords" content="Ubuntu"/> <meta itemprop="datePublished" content="2026-01-07T07:18:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DigitalOcean"/> <meta itemprop="url" content="https://juejin.cn/user/2031553217827127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ubuntu服务器快速上手：初始配置与安全设置教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2031553217827127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    DigitalOcean
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T07:18:14.000Z" title="Wed Jan 07 2026 07:18:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>首次创建新的Ubuntu服务器时，您应该执行一些重要的配置步骤作为初始设置的一部分。这些步骤将提高您服务器的安全性和可用性，并为后续操作打下坚实的基础。</p>
<p>本教程已在 Ubuntu 22.04 LTS、24.04 LTS 和 24.10 上经过验证。所使用的命令基于默认软件包，这些软件包在当前临时版本以及即将发布的、采用 apt、OpenSSH 和 UFW 默认配置的 25.x 版本中保持稳定。</p>
<h2 data-id="heading-0"><strong>Ubuntu 初始服务器设置</strong></h2>
<ul>
<li>
<p>以 root 身份登录</p>
</li>
<li>
<p>创建新用户</p>
</li>
<li>
<p>授予管理权限</p>
</li>
<li>
<p>设置防火墙</p>
</li>
<li>
<p>为您的普通用户启用外部访问</p>
<ul>
<li/>
</ul>
</li>
</ul>
<h2 data-id="heading-1"><strong>步骤 1 - 以 root 身份登录</strong></h2>
<p>要登录到您的服务器，您需要知道服务器的公网 IP 地址。如果您为认证安装了 SSH 密钥，则还需要 root 用户账户的密码或私钥。如果您尚未登录过您的服务器，可以按照我们关于如何通过 SSH 连接 Droplets 的指南操作，DigitalOcean英文官网中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.digitalocean.com%2Fproducts%2Fdroplets%2Fhow-to%2Fconnect-with-ssh%2F" target="_blank" title="https://docs.digitalocean.com/products/droplets/how-to/connect-with-ssh/" ref="nofollow noopener noreferrer">教程</a>详细介绍了此过程。</p>
<p>如果您当前未连接到服务器，请使用以下命令以 root 用户身份登录。将命令中高亮的 your_server_ip 部分替换为您服务器的公网 IP 地址：</p>
<pre><code class="hljs language-css" lang="css">ssh root<span class="hljs-keyword">@your_server_ip</span>
</code></pre>
<p>如果出现关于主机真实性的警告，请接受它。如果您的服务器使用密码认证，请提供您的 root 密码以登录。如果您使用的 SSH 密钥受密码保护，则可能需要在每个会话中首次使用该密钥时输入密码。如果您是首次使用密码登录服务器，可能还需要更改 root 密码。如果收到提示，请按照说明更改密码。</p>
<p><strong>关于 root</strong></p>
<p>root 用户是 Linux 环境中具有提升权限的管理员用户。由于 root 账户具有较高的权限，不建议您经常使用它。即使是无意的，root 账户也可能进行极具破坏性的更改。</p>
<p>下一步是创建一个具有较低权限的新用户账户以供日常使用。稍后，我们将向您展示如何在需要时临时获取提升的权限。</p>
<h2 data-id="heading-2"><strong>步骤 2 - 创建新用户</strong></h2>
<p>以 root 身份登录后，您将能够添加新用户账户。将来，我们将使用这个新账户而不是 root 登录。</p>
<p>此示例创建了一个名为 sammy 的新用户，但您应将其替换为您喜欢的用户名：</p>
<pre><code class="hljs">adduser sammy
</code></pre>
<p>您将被问到几个问题，首先是账户密码。</p>
<p>输入一个强密码，并可选地填写任何您希望提供的其他信息。这些信息不是必需的，您可以在任何想要跳过的字段中按 ENTER。</p>
<h2 data-id="heading-3"><strong>步骤 3 - 授予管理权限</strong></h2>
<p>现在您有了一个具有普通账户权限的新用户账户。但是，您有时需要以 root 用户身份执行管理任务。</p>
<p>为了避免注销普通用户再以 root 账户重新登录，您可以为您用户的普通账户设置所谓的超级用户或 root 权限。这些权限将使您的普通用户能够在命令前加上 sudo 来以管理权限运行命令。</p>
<p>要将这些权限添加到您的新用户，您需要将该用户添加到 sudo 系统组。在 Ubuntu 上，默认情况下，属于 sudo 组成员的用户被允许使用 sudo 命令。</p>
<p>以 root 身份，运行以下命令将您的新用户添加到 sudo 组（将高亮的 sammy 用户名替换为您的新用户）：</p>
<pre><code class="hljs">usermod -aG sudo sammy
</code></pre>
<p>现在，当以您的普通用户身份登录时，您可以在命令前输入 sudo 以超级用户权限运行它们。</p>
<h2 data-id="heading-4"><strong>步骤 4 - 设置防火墙</strong></h2>
<p>Ubuntu 服务器可以使用 UFW firewall 应用来确保只允许连接到特定服务。您可以使用此应用程序设置基本防火墙。</p>
<blockquote>
<p><strong>注意：</strong> 如果您的服务器运行在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aidroplet.com%2Fproduct%2Fcloudcpu%2F" target="_blank" title="https://www.aidroplet.com/product/cloudcpu/" ref="nofollow noopener noreferrer">DigitalOcean 云平台</a>上，您可以选择使用 DigitalOcean Cloud Firewalls 而不是 UFW firewall。我们建议一次只使用一个防火墙，以避免可能难以调试的规则冲突。</p>
</blockquote>
<p>应用程序在安装时可以向 UFW 注册其配置文件。这些配置文件允许 UFW 按名称管理这些应用程序。允许您连接到服务器的服务 OpenSSH 已在 UFW 中注册了配置文件。</p>
<p>您可以通过输入以下命令查看已安装的 UFW 配置文件列表：</p>
<pre><code class="hljs">ufw app list
</code></pre>
<p><strong>输出</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Available applications:</span>
  <span class="hljs-string">OpenSSH</span>
</code></pre>
<p>您需要确保防火墙允许 SSH 连接，以便您下次可以登录服务器。通过输入以下命令允许这些连接：</p>
<pre><code class="hljs">ufw allow OpenSSH
</code></pre>
<p>现在通过输入以下命令启用防火墙：</p>
<pre><code class="hljs language-bash" lang="bash">ufw <span class="hljs-built_in">enable</span>
</code></pre>
<p>输入 y 并按 ENTER 继续。您可以通过输入以下命令查看 SSH 连接是否仍然被允许：</p>
<pre><code class="hljs language-lua" lang="lua">ufw <span class="hljs-built_in">status</span>
</code></pre>
<p><strong>输出</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">Status:</span> active

<span class="hljs-keyword">To</span>                         Action      <span class="hljs-keyword">From</span>
--                         ------      ----
OpenSSH                    ALLOW       Anywhere
OpenSSH (v6)               ALLOW       Anywhere (v6)
</code></pre>
<p>防火墙当前除了 SSH 外阻止所有连接。如果您安装并配置了其他服务，您将需要调整防火墙设置以允许新的流量进入您的服务器。</p>
<p>以后要添加 HTTP 访问，请仅允许您需要的服务：</p>
<pre><code class="hljs language-bash" lang="bash">ufw allow 80/tcp
ufw allow 443/tcp
</code></pre>
<h2 data-id="heading-5"><strong>步骤 5 - 为您的普通用户启用外部访问</strong></h2>
<p>现在您有了一个供日常使用的普通用户，您需要确保可以直接 SSH 登录到该账户。</p>
<blockquote>
<p><strong>注意：</strong> 在确认您可以使用新用户登录并使用 sudo 之前，我们建议保持以 root 身份登录。如果遇到连接问题，您可以以 root 身份进行故障排除并进行必要的更改。如果您使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aidroplet.com%2Fproduct%2Fcloudcpu%2F" target="_blank" title="https://www.aidroplet.com/product/cloudcpu/" ref="nofollow noopener noreferrer">DigitalOcean Droplet</a> 并且遇到 root SSH 连接问题，可以使用 Recovery Console 重新获得对 Droplet 的访问权限。</p>
</blockquote>
<p>为您的普通用户配置 SSH 访问取决于您服务器的 root 账户是使用密码还是 SSH 密钥进行认证。</p>
<p><strong>如果 root 账户使用密码认证</strong></p>
<p>如果您使用密码登录到 root 账户，则 SSH 已启用密码认证。您可以打开一个新的终端会话，使用 SSH 和您的新用户名登录到您的新用户账户：</p>
<pre><code class="hljs language-css" lang="css">ssh sammy<span class="hljs-keyword">@your_server_ip</span>
</code></pre>
<p>输入您普通用户的密码后，您将被登录。请记住，如果您需要以管理权限运行命令，请在命令前输入 <code>sudo</code>，如下所示：</p>
<pre><code class="hljs">sudo command_to_run
</code></pre>
<p>在每个会话中首次使用 <code>sudo</code> 时（以及之后定期地），系统会提示您输入普通用户的密码。</p>
<p>为了增强服务器的安全性，我们强烈建议设置 SSH 密钥而不是使用密码认证。按照我们关于在 Ubuntu 上设置 SSH 密钥 的指南来学习如何配置基于密钥的认证。</p>
<p><strong>如果 root 账户使用</strong> <strong>SSH</strong> <strong>密钥认证</strong></p>
<p>如果您使用 SSH 密钥登录到 root 账户，则 SSH 的密码认证是禁用的。要使用 SSH 密钥以普通用户身份登录，您必须将本地公钥的副本添加到您新用户的 ~/.ssh/authorized_keys 文件中。</p>
<p>由于您的公钥已经在服务器上 root 账户的 ~/.ssh/authorized_keys 文件中，您可以使用当前会话将该文件和目录结构复制到您的新用户账户。</p>
<p>使用正确的所有权和权限复制文件的最简单方法是使用 rsync 命令。这个命令将复制 root 用户的 .ssh 目录，保留权限，并修改文件所有者，所有这些操作在一个命令中完成。请确保更改下面命令中高亮的部分以匹配您普通用户的名称：</p>
<blockquote>
<p><strong>注意：</strong> rsync 命令对以尾部斜杠结尾的源和目标与没有尾部斜杠的处理方式不同。使用下面的 rsync 时，请确保源目录（~/.ssh）不包含尾部斜杠（检查确认您没有使用 ~/.ssh/）。</p>
<p>如果意外地在命令中添加了尾部斜杠，rsync 将复制 root 账户 ~/.ssh 目录的<em>内容</em>到 sudo 用户的主目录，而不是复制整个 ~/.ssh 目录结构。文件将位于错误的位置，SSH 将无法找到并使用它们。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">rsync --archive --<span class="hljs-built_in">chown</span>=sammy:sammy ~/.ssh /home/sammy
</code></pre>
<p>现在，在本地机器上打开一个新的终端会话，并使用 SSH 和您的新用户名：</p>
<pre><code class="hljs language-css" lang="css">ssh sammy<span class="hljs-keyword">@your_server_ip</span>
</code></pre>
<p>您应该可以在不使用密码的情况下使用新用户账户连接到您的服务器。请记住，如果您需要以管理权限运行命令，请在命令前输入 sudo，如下所示：</p>
<pre><code class="hljs">sudo command_to_run
</code></pre>
<p>在每个会话中首次使用 sudo 时（以及之后定期地），系统会提示您输入普通用户的密码。</p>
<h2 data-id="heading-6"><strong>常见问题</strong></h2>
<p><strong>1. Ubuntu 可以用作服务器吗？</strong></p>
<p>当然可以。Ubuntu 是全球最受欢迎的服务器操作系统之一，设计用于广泛的场景，从轻量级 VPS 实例到企业级集群。</p>
<p><strong>Ubuntu Server 的主要优势：</strong></p>





























<table><thead><tr><th>特性</th><th>描述</th></tr></thead><tbody><tr><td>开源且免费</td><td>无需许可证费用。</td></tr><tr><td>LTS 支持</td><td>长期支持版本可获得 5 年的更新。</td></tr><tr><td>云就绪</td><td>针对主流云（DigitalOcean、AWS、GCP）的优化镜像。</td></tr><tr><td>DevOps 友好</td><td>自带 OpenSSH、apt 和 systemd。</td></tr><tr><td>广泛的硬件支持</td><td>可在 x86、ARM、PPC 等架构上运行。</td></tr></tbody></table>
<p><strong>Ubuntu 能够很好处理的服务器任务示例：</strong></p>
<ul>
<li>
<p>Web 托管（Apache、Nginx）</p>
</li>
<li>
<p>数据库（PostgreSQL、MySQL、MongoDB）</p>
</li>
<li>
<p>应用服务器（Node.js、Python、Java）</p>
</li>
<li>
<p>容器编排（Docker、Kubernetes）</p>
</li>
<li>
<p>文件存储和备份</p>
<ul>
<li/>
</ul>
</li>
</ul>
<p><strong>示例：</strong> 要检查您的 Ubuntu 版本：</p>
<pre><code class="hljs language-bash" lang="bash">lsb_release -a
<span class="hljs-comment"># 或者</span>
<span class="hljs-built_in">cat</span> /etc/os-release
</code></pre>
<p>有关 SSH 和包管理的更多信息，请参阅DigitalOcean 英文官网的：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.digitalocean.com%2Fcommunity%2Ftutorials%2Fhow-to-create-ssh-keys-with-openssh-on-macos-or-linux" target="_blank" title="https://www.digitalocean.com/community/tutorials/how-to-create-ssh-keys-with-openssh-on-macos-or-linux" ref="nofollow noopener noreferrer">OpenSSH 密钥指南</a>。</p>
<p><strong>2. Ubuntu Server 是免费的吗？</strong></p>
<p>是的。Ubuntu Server 完全免费下载、安装和使用，适用于任何目的——个人、教育或商业用途。没有许可费用或订阅费。</p>
<p>如果您正在寻找一个简单可靠的方式来开始，可以考虑在 DigitalOcean 上部署一个 Ubuntu Droplet。DigitalOcean 提供预配置的 Ubuntu 服务器镜像，因此您只需点击几下即可启动安全、可用于生产的服务器——非常适合初学者和专家。</p>
<blockquote>
<p><strong>注意：</strong> 只有需要扩展安全维护、合规性功能或企业支持时，您才需要 Ubuntu Pro。对于大多数用户和典型工作负载，免费版本的 Ubuntu Server 已绰绰有余。</p>
</blockquote>
<p><strong>3. 对于新服务器，我应该选择哪个 Ubuntu 版本？</strong></p>
<p><strong>建议：</strong></p>
<p>使用长期支持（LTS）版本。LTS 版本是生产就绪的，并可获得五年的更新。</p>
<p><strong>流行的</strong> <strong>LTS</strong> <strong>版本：</strong></p>























<table><thead><tr><th>版本</th><th>发布日期</th><th>支持结束时间</th><th>备注</th></tr></thead><tbody><tr><td>Ubuntu 24.04 LTS</td><td>2024 年 4 月</td><td>2029 年 4 月</td><td>最新版本；推荐用于新安装</td></tr><tr><td>Ubuntu 22.04 LTS</td><td>2022 年 4 月</td><td>2027 年 4 月</td><td>广泛使用；高度稳定</td></tr></tbody></table>
<p>检查您当前的版本：</p>
<pre><code class="hljs language-arduino" lang="arduino">lsb_release -cs   # 显示代号（例如，<span class="hljs-number">22.04</span> 是 <span class="hljs-string">'jammy'</span>）
</code></pre>
<p>本指南及其命令已在 24.04 LTS 和 22.04 LTS 上验证。</p>
<p><strong>4. 我应该为</strong> <strong>SSH</strong> <strong>禁用密码认证吗？</strong></p>
<p>是的，为了增强安全性。</p>
<p>一旦您设置了 SSH 密钥认证并确认可以登录，为 SSH 禁用密码认证可以减少您服务器遭受暴力破解攻击的风险。</p>
<p><strong>步骤：</strong></p>
<p>打开 SSH 配置：</p>
<pre><code class="hljs language-bash" lang="bash">sudo nano /etc/ssh/sshd_config
</code></pre>
<p>找到并设置：</p>
<pre><code class="hljs language-perl" lang="perl">PasswordAuthentication <span class="hljs-keyword">no</span>
</code></pre>
<p>重启 SSH：</p>
<pre><code class="hljs">sudo systemctl reload sshd
</code></pre>
<blockquote>
<p><strong>重要：</strong> 在进行此更改之前，请始终保持另一种访问服务器的方式，例如 DigitalOcean 的 Droplet 控制台或备用访问。</p>
</blockquote>
<p><strong>5. 我需要更改默认的</strong> <strong>SSH</strong> ****<strong>端口</strong> <strong>吗？</strong></p>
<p>将 SSH 端口从 22 更改为是可选的，并且不能替代正确的 SSH 密钥认证或防火墙配置。</p>
<p><strong>利弊：</strong></p>





















<table><thead><tr><th>更改端口 22</th><th>影响</th></tr></thead><tbody><tr><td>略微减少扫描</td><td>自动化机器人可能会绕过非 22 端口</td></tr><tr><td><strong>不是</strong>安全替代品</td><td>攻击者仍然可以找到开放端口</td></tr><tr><td>需要更新防火墙</td><td>需要更改 UFW 或 firewalld 规则</td></tr></tbody></table>
<p>如果您要更改端口：</p>
<p>编辑 <code>/etc/ssh/sshd_config</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">Port</span> <span class="hljs-number">2277</span>   <span class="hljs-comment"># 示例端口；使用 &gt;1024 且未被占用的端口</span>
</code></pre>
<p>更新 UFW 规则：</p>
<pre><code class="hljs language-bash" lang="bash">sudo ufw allow 2277/tcp
</code></pre>
<p>连接时使用：</p>
<pre><code class="hljs language-css" lang="css">ssh -<span class="hljs-selector-tag">p</span> <span class="hljs-number">2277</span> user<span class="hljs-keyword">@your_server_ip</span>
</code></pre>
<blockquote>
<p>记录您的新端口以避免被锁在外面。将其作为额外步骤使用，而不是您的主要防御手段。</p>
</blockquote>
<h2 data-id="heading-7"><strong>小结</strong></h2>
<p>恭喜！您已经完成了 Ubuntu 服务器基本的初始设置过程。通过遵循这些步骤，您极大地提高了服务器的安全性并为未来的配置奠定了基础。您现在拥有一个具有 sudo 权限的非 root 用户账户，用于更安全的日常管理；一个配置好的防火墙（UFW），限制除您明确允许之外的所有流量；以及一个安全的 SSH 密钥认证系统——显著降低了未经授权访问的风险。</p>
<p>有了这些最佳实践，您的 Ubuntu 服务器已经为 Web 托管、应用程序部署以及您需要的任何进一步定制做好了准备。本教程中完成的设置是几乎所有 Linux 服务器项目的基本要求，理解这些基础知识将帮助您自信地管理云中或本地的基础设施。</p>
<p>如果你还需要浏览更多关于云服务相关知识或DigitalOcean 云平台产品的使用教程，可访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aidroplet.com%2F" target="_blank" title="https://www.aidroplet.com/" ref="nofollow noopener noreferrer">DigitalOcean中国区独家战略合作伙伴卓普云AI Droplet官网</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[toB系统如何提升系统质量？]]></title>    <link>https://juejin.cn/post/7592166340381540367</link>    <guid>https://juejin.cn/post/7592166340381540367</guid>    <pubDate>2026-01-07T07:20:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592166340381540367" data-draft-id="7591730714140917802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="toB系统如何提升系统质量？"/> <meta itemprop="keywords" content="产品,产品经理"/> <meta itemprop="datePublished" content="2026-01-07T07:20:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yoo前端"/> <meta itemprop="url" content="https://juejin.cn/user/2791012486624116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            toB系统如何提升系统质量？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2791012486624116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yoo前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T07:20:01.000Z" title="Wed Jan 07 2026 07:20:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 ToB 场景下，“有没有人看（PV / UV）”几乎是<strong>伪指标</strong>，因为<strong>使用是被强制的，价值不来自“被访问”，而来自“被依赖、被信任、被高效使用”</strong> 。</p>
<p>因此，ToB 系统的质量评估，必须从**“业务可用性 + 工作效率 + 风险控制 + 演进能力”**几个维度来重构指标体系。</p>
<p>下面我按<strong>产品经理可落地的结构</strong>展开。</p>
<hr/>
<h2 data-id="heading-0">一、ToB 系统质量的核心判断逻辑（先给结论）</h2>
<blockquote>
<p><strong>一个高质量 ToB 系统，不是“有人用”，而是：</strong></p>
</blockquote>
<ol>
<li>能否<strong>稳定支撑关键业务</strong></li>
<li>是否<strong>显著降低人工成本</strong></li>
<li>是否<strong>减少错误与风险</strong></li>
<li>是否<strong>能被持续扩展与演进</strong></li>
</ol>
<p>对应的指标体系，<strong>完全不同于 ToC 页面指标</strong>。</p>
<hr/>
<h2 data-id="heading-1">二、ToB 系统质量的五大核心维度</h2>
<h3 data-id="heading-2">1️⃣ 业务完成度（最重要）</h3>
<p><strong>关注：事情有没有被顺利做完</strong></p>

























<table><thead><tr><th>指标</th><th>含义</th></tr></thead><tbody><tr><td>任务完成率</td><td>发起的业务中成功完成的比例</td></tr><tr><td>业务闭环率</td><td>有开始、有结果的业务占比</td></tr><tr><td>异常中断率</td><td>因系统问题导致中断</td></tr><tr><td>回退 / 重做率</td><td>业务被反复处理的比例</td></tr></tbody></table>
<p>👉 典型问题：</p>
<ul>
<li>系统是否成为“业务瓶颈”</li>
<li>是否存在“表面可用、实则难用”</li>
</ul>
<hr/>
<h3 data-id="heading-3">2️⃣ 操作效率（ToB 的“体验”）</h3>
<p>ToB 不追求爽，而追求 <strong>快、少、稳</strong></p>

























<table><thead><tr><th>指标</th><th>含义</th></tr></thead><tbody><tr><td>单任务平均耗时</td><td>完成一次业务需要多久</td></tr><tr><td>操作步数</td><td>点击 / 填写次数</td></tr><tr><td>等待时间</td><td>接口 / 页面响应时间</td></tr><tr><td>人均处理量</td><td>单人每日可处理业务数</td></tr></tbody></table>
<p>👉 提升方向：</p>
<ul>
<li>减步骤</li>
<li>减等待</li>
<li>减认知负担</li>
</ul>
<hr/>
<h3 data-id="heading-4">3️⃣ 错误与风险控制（隐性价值）</h3>
<p><strong>ToB 系统最大的价值之一是“防错”</strong></p>

























<table><thead><tr><th>指标</th><th>含义</th></tr></thead><tbody><tr><td>操作错误率</td><td>填错、漏填、误操作</td></tr><tr><td>校验拦截率</td><td>系统提前阻止的错误</td></tr><tr><td>异常修复时长</td><td>从发现到恢复</td></tr><tr><td>审计通过率</td><td>合规 / 审计成功比例</td></tr></tbody></table>
<p>👉 一个好 ToB 系统：</p>
<ul>
<li><strong>错误越多，说明系统越差</strong></li>
<li><strong>拦截越多，反而说明系统越好</strong></li>
</ul>
<hr/>
<h3 data-id="heading-5">4️⃣ 稳定性与可靠性（底线）</h3>

























<table><thead><tr><th>指标</th><th>含义</th></tr></thead><tbody><tr><td>系统可用性（SLA）</td><td>可用时间占比</td></tr><tr><td>接口成功率</td><td>API 成功返回</td></tr><tr><td>峰值承载能力</td><td>高峰期是否稳定</td></tr><tr><td>故障影响范围</td><td>故障波及多少业务</td></tr></tbody></table>
<p>👉 在 ToB：</p>
<ul>
<li>99.9% 和 99.99% 是<strong>完全不同的产品级别</strong></li>
</ul>
<hr/>
<h3 data-id="heading-6">5️⃣ 演进与适配能力（长期质量）</h3>
<p><strong>今天能用 ≠ 明天能改</strong></p>

























<table><thead><tr><th>指标</th><th>含义</th></tr></thead><tbody><tr><td>配置覆盖率</td><td>是否配置而非写死</td></tr><tr><td>新需求交付周期</td><td>从需求到上线</td></tr><tr><td>模块复用率</td><td>功能可复用程度</td></tr><tr><td>规则外化比例</td><td>业务规则是否可配置</td></tr></tbody></table>
<p>👉 这是<strong>产品成熟度</strong>的体现。</p>
<hr/>
<h2 data-id="heading-7">三、从“页面指标”到“业务指标”的转变</h2>
<h3 data-id="heading-8">❌ ToC 思维（不适用）</h3>
<ul>
<li>PV、UV、停留时长</li>
<li>页面跳出率</li>
</ul>
<h3 data-id="heading-9">✅ ToB 正确视角</h3>
<ul>
<li><strong>业务对象 × 生命周期</strong></li>
<li><strong>人 × 角色 × 权限</strong></li>
<li><strong>流程 × 时效 × 成功率</strong></li>
</ul>
<p>示例：</p>
<pre><code class="hljs">订单
  → 创建
  → 审批
  → 执行
  → 完成
</code></pre>
<p>每个节点都有：</p>
<ul>
<li>耗时</li>
<li>成功率</li>
<li>异常率</li>
<li>责任角色</li>
</ul>
<hr/>
<h2 data-id="heading-10">四、ToB 前端埋点该埋什么（非常关键）</h2>
<h3 data-id="heading-11">1️⃣ 不埋“看了什么”，埋“做了什么”</h3>

























<table><thead><tr><th>类型</th><th>示例</th></tr></thead><tbody><tr><td>业务动作</td><td>创建订单、提交审批</td></tr><tr><td>关键节点</td><td>审批通过、驳回</td></tr><tr><td>异常动作</td><td>校验失败、接口报错</td></tr><tr><td>性能节点</td><td>提交到返回耗时</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-12">2️⃣ 埋点的核心对象不是页面，而是<strong>业务实体</strong></h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"event"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"order_submit"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"order_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"O123"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"operator_role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"finance"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"duration"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3200</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"success"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-13">五、AI 在 ToB 系统质量提升中的真正价值</h2>
<h3 data-id="heading-14">1️⃣ AI = 业务过程显微镜</h3>
<p>AI 不看页面，而是看：</p>
<ul>
<li>哪类人</li>
<li>在哪一步</li>
<li>经常卡住</li>
<li>为什么卡住</li>
</ul>
<p>自动输出：</p>
<blockquote>
<p>“70% 的异常发生在审批第二步，主要集中在新员工账号。”</p>
</blockquote>
<hr/>
<h3 data-id="heading-15">2️⃣ AI 自动发现“隐性低效点”</h3>
<p>传统问题：</p>
<blockquote>
<p>没人抱怨 ≠ 没问题</p>
</blockquote>
<p>AI 可以发现：</p>
<ul>
<li>操作耗时异常</li>
<li>某人 / 某角色效率显著低于均值</li>
<li>某配置导致整体效率下降</li>
</ul>
<hr/>
<h3 data-id="heading-16">3️⃣ AI 辅助流程与规则优化</h3>
<ul>
<li>
<p>自动模拟流程变更对效率的影响</p>
</li>
<li>
<p>推荐：</p>
<ul>
<li>减少审批层级</li>
<li>合并操作步骤</li>
<li>放宽不必要校验</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-17">4️⃣ 从“监控系统”升级为“业务管家”</h3>
<p>最终形态：</p>
<blockquote>
<p><strong>PM 不再问：</strong></p>
<ul>
<li>“这个功能有人用吗？”</li>
</ul>
</blockquote>
<blockquote>
<p><strong>而是问：</strong></p>
<ul>
<li>“这个系统是不是已经成为业务最优解？”</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-18">六、一句话总结（ToB 产品经理视角）</h2>
<blockquote>
<p><strong>ToB 系统质量，不是“被使用的频率”，而是：</strong></p>
<ul>
<li>业务是否顺畅</li>
<li>人是否高效</li>
<li>错误是否被系统消灭</li>
<li>系统是否经得起变化</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git 焚决！一个绝招助你找回丢失的代码文件！]]></title>    <link>https://juejin.cn/post/7592144524308873222</link>    <guid>https://juejin.cn/post/7592144524308873222</guid>    <pubDate>2026-01-07T07:16:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592144524308873222" data-draft-id="7592133956734582825" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git 焚决！一个绝招助你找回丢失的代码文件！"/> <meta itemprop="keywords" content="前端,Git"/> <meta itemprop="datePublished" content="2026-01-07T07:16:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云一鹤"/> <meta itemprop="url" content="https://juejin.cn/user/729731452122382"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git 焚决！一个绝招助你找回丢失的代码文件！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731452122382/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云一鹤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T07:16:44.000Z" title="Wed Jan 07 2026 07:16:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>众所周知，代码只要提交到 git 仓库就有记录。哪怕是被覆盖或者删除了，都可以从仓库进行还原</p>
<p>但是如果代码没有提交，却不小心被搞丢了，还有办法找回吗？</p>
<p>答案是有的，我已经踩过坑并整理到文章中了</p>
<p>希望大家永远不会遇到这种糟心事</p>
<p>一旦碰上了，那滋味简直...不堪回首</p>
<p>你也不想代码被不小心搞丢后从头再写一遍吧？</p>
<p>赶紧收藏转发，保不齐哪一天就能用上呢</p>
<p>也可以提前学习，养成良好习惯，避免文件找不回来，有备无患！</p>
<h2 data-id="heading-0">1. 准备工作</h2>
<p>我在项目中新增了一个“歌词本”文件夹，存了 50 首爱听的歌</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a40cd67d3f6545928d35b4872faf9021~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=7RHEZEAifX8zuMXb5QjmJiC9e7s%3D" alt="1.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/736e4c0d66f847e398a17a4d3f85d9d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=lppjtBrVeD69GLcdGXP%2FyaCnyOI%3D" alt="2.png" loading="lazy"/></p>
<p>因为不是所有的情况都能找回丢失的文件，<code>只能找回已暂存（git add）过的文件</code></p>
<p>所以下面我将模拟 4 种场景进行测试，测试哪一种场景才能找回丢失的文件</p>
<h2 data-id="heading-1">2. 场景测试</h2>
<h3 data-id="heading-2">2.0 测试说明</h3>
<p>接下来我会在 4 种不同的场景下分别运行这个 <code>git bash</code> 命令</p>
<pre><code class="hljs language-bash" lang="bash">git fsck --lost-found
</code></pre>
<p>注意：命令皆在项目<code>根目录</code>（与.git 文件夹同级）下执行</p>
<p>预期：如果<code>根目录</code>（与.git 文件夹同级）下生成了 <code>lost-found</code> 文件夹即说明文件恢复成功</p>
<h3 data-id="heading-3">2.1 场景-1：未暂存 -&gt; 运行 git fsck --lost-found 命令</h3>
<p>现在是未暂存状态</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/112674b423d54f00a2e9cf0079965e24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=OvfXdmh2G48FcaAQ9FIet4BcMME%3D" alt="3.png" loading="lazy"/></p>
<p>运行命令</p>
<pre><code class="hljs language-bash" lang="bash">git fsck --lost-found
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41903bff36ca4ce08a7ccafe12175904~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=cVoawBNyRwSFcd59obxpJVu0mE0%3D" alt="4.png" loading="lazy"/></p>
<p>命令执行成功，但是却没有生成 lost-found 文件夹</p>
<h3 data-id="heading-4">2.2 场景-2：未暂存 -&gt; 删除文件 -&gt; 运行 git fsck --lost-found 命令</h3>
<p>为了节省文章空间，这里就省略截图了</p>
<p>重新运行命令</p>
<p>也没有生成 lost-found 文件夹</p>
<h3 data-id="heading-5">2.3 场景-3：已暂存 -&gt; 运行 git fsck --lost-found 命令</h3>
<p>现在我把“歌词本”文件夹暂存（git add .）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1fd05f7fa3d4339b46885fb46a69bfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=gJmPa5Hs%2BO%2FKZXSpOUJC61KMsvI%3D" alt="5.png" loading="lazy"/></p>
<p>再次运行命令</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41903bff36ca4ce08a7ccafe12175904~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=cVoawBNyRwSFcd59obxpJVu0mE0%3D" alt="4.png" loading="lazy"/></p>
<p>还是没有生成 lost-found 文件夹</p>
<h3 data-id="heading-6">2.4 场景-4：已暂存 -&gt; 删除文件 -&gt; 运行 git fsck --lost-found 命令</h3>
<p>节省文章空间，截图就省略了</p>
<p>重新运行命令</p>
<p>也没有生成 lost-found 文件夹</p>
<h3 data-id="heading-7">2.5 场景-5：已暂存 -&gt; 删除文件 -&gt; 再次暂存 -&gt; 运行 git fsck --lost-found 命令</h3>
<p>然后我把“歌词本”文件夹整个给丢弃了，再次暂存（git add .）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/111f2bd967da49f1b0ce119cf3526516~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=axmrj19a5HrQcVF2GngvQd1ZbxE%3D" alt="6.png" loading="lazy"/></p>
<p>最后运行命令</p>
<pre><code class="hljs language-bash" lang="bash">git fsck --lost-found
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7dab138949447f6bc0cc7c0a32ab304~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=3gH%2F6I5bnk7OSfGdKgjwqGjAB6g%3D" alt="7.png" loading="lazy"/></p>
<p>这次成功了！！！</p>
<p>.git 文件夹下面生成了 lost-found 文件夹，打开后里面有 other 文件夹， other 里面就是曾经暂存过的所有文件列表</p>
<p>可以看到正好 50 个项目</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b15c3d6bb89040faa967b21263079bf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=JT0QTQKEp1SHZGuUrvZonviDSb8%3D" alt="8.png" loading="lazy"/></p>
<p>这些文件是以其对象的 SHA 哈希值命名的，但是文件内容就是原始内容（如果是文本文件，就可以直接打开查看）</p>
<p>用 vscode 打开整个 lost-found 文件夹，可以看到，里面全部都是刚才被我故意丢弃的歌词文件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0eea68a5bc874014beba15a809575806~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=Op5ltWACt1qnjzpT%2FMkZEubBApM%3D" alt="9.png" loading="lazy"/></p>
<p>在实际项目中，我们还可以再结合 <code>vscode 的时间</code>线功能，就可以把丢失的代码文件恢复的八九不离十了；</p>
<blockquote>
<p>随堂笔记：不是 git add 之后，文件就会到.git/lost-found/other 目录中，而是当内容删除后才存在！！</p>
</blockquote>
<h2 data-id="heading-8">3. 找回前提：文件 add 到暂存区过！</h2>
<p>现在来解释，为啥只有 <code>场景-5：已暂存 -&gt; 删除文件 -&gt; 再次暂存 -&gt; 运行 git fsck --lost-found 命令</code> 才能找回丢失文件的原因</p>
<p>执行 <code>git add .</code> 命令的时候，Git 会把 歌词本里面的 50 个.txt 文件内容存成 50 个 blob 对象，写入 <code>.git/objects/</code> 文件夹</p>
<p>但是只有<code>“悬挂”（dangling）-无引用，但存在</code>的对象能通过 fsck 恢复到 .git/lost-found/ 目录中</p>
<p>未被 git 记录的文件，和 git 中正常存在（有引用关系）的文件是不会出现在 .git/objects/ 目录中，这就是为什么只有添加到暂存区后主动删除后才能生成到 <code>.git/lost-found/</code> 文件夹的原因</p>
<p>只要你把文件暂存到 git 中，git 就会记住它，哪怕你之后 git reset，git rebase，cherry-pick，或者提交拉取覆盖，切换分支甚至删除文件。只要这个 blob 还没被 git gc 清理，它就能被 git fsck --lost-found 找出来</p>
<p><code>git fsck --lost-found</code> 本质是恢复 Git 管理过的数据，对于没有被 git add 过的文件， Git 从来就不知道这个文件存在过，自然也就找不到了</p>
<h2 data-id="heading-9">4. git fsck --lost-found 命令解释</h2>
<p><code>git fsck --lost-found</code> 是 Git 内置命令，用于检查 Git 仓库的对象数据库（object database），并将任何“悬挂”（dangling）或“丢失”的对象恢复到 <code>.git/lost-found/</code> 目录中。这是一个诊断和恢复工具，常用于修复损坏的仓库或找回意外丢失的数据。</p>
<ul>
<li>
<p>git fsck：这是核心命令，用于验证 Git 仓库中对象的完整性。它会检查所有对象（如提交、树、blob 和标签）的连通性、有效性和 SHA-1 校验和。如果发现问题（如损坏的对象或无法访问的引用），它会报告错误。</p>
</li>
<li>
<p>--lost-found 选项：这个选项扩展了 fsck 的行为，不仅检查问题，还会将那些“悬挂”的对象（即存在于对象数据库中，但没有被任何引用如分支、标签或 HEAD 指向的对象）复制到 .git/lost-found/ 目录下。具体来说：</p>
<p>悬挂的提交（commits）会放在 <code>.git/lost-found/commit/</code> 目录中，每个文件名为其 SHA-1 值，是一个包含提交元数据的文本文件。</p>
<p>其他悬挂对象（如树、blob 或标签）会放在 <code>.git/lost-found/other/</code> 目录中，同样以 SHA-1 命名。</p>
</li>
</ul>
<p>这些悬挂对象通常是因为操作如 git rebase、git reset 或手动删除引用而产生的。它们不是仓库损坏的标志，而是 Git 的正常行为（Git 默认保留这些对象一段时间，以防需要恢复）。</p>
<h2 data-id="heading-10">5. 通过关键词快速搜索</h2>
<p>我想在一大堆文件中找到想要的文件怎么办？</p>
<p>直接 vscode 打开整个 .git/lost-found/other 目录，然后全局搜索关键词即可</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59ddaa3ad0844fc19bd863d389ea28ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=3pGlNP51lervLFngwi69lUOAn7A%3D" alt="10.png" loading="lazy"/></p>
<p>我本来还研究了半天的搜索命令，最后发现还不如在 vscode 中全局搜索方便😓</p>
<h2 data-id="heading-11">6. 搜索进阶！查找最近修改的 15 个文件</h2>
<p>不过新的问题也随之出现，文件太多怎么办？如果我 .git/lost-found/other 文件夹下面有几千个文件，我想找回最近被误删的文件，难道要挨个打开查看文件内容吗？</p>
<p>好问题，我也给你想到了解决方法。继续往下看。</p>
<p>前面的图片中显示 .git/lost-found/other 文件夹很干净，只有被我手动丢弃的 50 个歌词文件，是因为我之前清理了 git 的缓存，其实在我清理缓存之前 .git/lost-found/other 文件夹是存在两千多个文件的，如下图所示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5f4b698e21442978b45c4d6bdb66625~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=UnLzAI%2BmIj3iCjZWZSo%2BT3fiaZM%3D" alt="11.png" loading="lazy"/></p>
<p>要想在这两千多个文件中找到我丢失的那 50 个歌词文件，工作量可想而知！</p>
<p>毕竟不是所有的文件我都记得住，通过关键词查找回来</p>
<p>别急，我有好办法！</p>
<p>我现在新增 15 个不同格式的文件进行测试</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cada4041948c4420a860f164df46468b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=qz0KiIGJKQtzR9IMTVkbwRABg8Q%3D" alt="12.png" loading="lazy"/></p>
<p>然后把文件暂存后删除，测试能否精确找回这 15 个文件</p>
<p>注意！需要重新运行 <code>git fsck --lost-found</code> 命令才能更新.git/lost-found/other 文件夹哦！否则会搜出来旧的数据</p>
<p>还是在项目<code>根目录</code>（与.git 文件夹同级）下运行命令</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-built_in">mkdir</span> -p recent_lost
&gt; temp_times.txt  <span class="hljs-comment"># 先创建空文件，避免后续错误</span>

<span class="hljs-keyword">for</span> lost_file <span class="hljs-keyword">in</span> .git/lost-found/other/*; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"<span class="hljs-variable">$lost_file</span>"</span> ]; <span class="hljs-keyword">then</span>  <span class="hljs-comment"># 如果没有文件，跳过（处理空目录）</span>
        <span class="hljs-built_in">continue</span>
    <span class="hljs-keyword">fi</span>
    sha=$(<span class="hljs-built_in">basename</span> <span class="hljs-string">"<span class="hljs-variable">$lost_file</span>"</span>)
    obj_dir=<span class="hljs-string">".git/objects/<span class="hljs-variable">${sha:0:2}</span>"</span>
    obj_file=<span class="hljs-string">"<span class="hljs-variable">$obj_dir</span>/<span class="hljs-variable">${sha:2}</span>"</span>
    <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"<span class="hljs-variable">$obj_file</span>"</span> ]; <span class="hljs-keyword">then</span>
        mtime=$(<span class="hljs-built_in">stat</span> -c %Y <span class="hljs-string">"<span class="hljs-variable">$obj_file</span>"</span> 2&gt;/dev/null)  <span class="hljs-comment"># 获取 Unix 时间戳，忽略错误</span>
        <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$mtime</span>"</span> ]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$mtime</span> <span class="hljs-variable">$sha</span>"</span> &gt;&gt; temp_times.txt
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>

<span class="hljs-keyword">if</span> [ -s temp_times.txt ]; <span class="hljs-keyword">then</span>  <span class="hljs-comment"># 只在文件非空时排序</span>
    <span class="hljs-built_in">sort</span> -nr temp_times.txt | <span class="hljs-built_in">head</span> -n 15 | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> mtime sha; <span class="hljs-keyword">do</span>
        <span class="hljs-built_in">cp</span> <span class="hljs-string">".git/lost-found/other/<span class="hljs-variable">$sha</span>"</span> <span class="hljs-string">"recent_lost/<span class="hljs-variable">$sha</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Copied recent object: <span class="hljs-variable">$sha</span> (mtime: <span class="hljs-subst">$(date -d @$mtime)</span>)"</span>
    <span class="hljs-keyword">done</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"No recent objects found or no mtime available. This may happen if objects are packed (not loose) or no matching files in .git/objects/."</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">rm</span> -f temp_times.txt  <span class="hljs-comment"># 用 -f 忽略如果文件不存在</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78cce64abd454080b3011e83bf78909c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=CVdqM9Y2lDlGZ4hOntC%2F4lbk99I%3D" alt="13.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55de8db0c6884c659805fa31367732aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=au8CvthE4Ap40CnyA7WKdKAVolU%3D" alt="14.png" loading="lazy"/></p>
<p>成功提取出最近修改的 15 个文件，并将其存入自动创建的 <code>recent_lost/</code> 文件夹中</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68117122cba34065b9162f44e85f2b46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=MKEjAxRqQYNZcgpru0%2FtFijgf%2BM%3D" alt="15.png" loading="lazy"/></p>
<p>用 vscode 打开项目，会发现除了 js，html，vue，txt 等文本文件打开后可以直观的看见内容外，其他的格式根本看不了一点，那咋搞？别急，请看下文-判断文件类型</p>
<p>解释：脚本遍历 other/ 中的 SHA，查找对应 .git/objects/ 中的文件，获取 mtime，按时间降序复制前 N 个到新目录 recent_lost/。这样你只需检查少数文件。</p>
<p>tip：如果想调整找回的数量，自己把 15 这个数字更改即可</p>
<h2 data-id="heading-12">7. 如何判断文件类型？</h2>
<p>运行下面这个循环脚本能批量检查文件类型</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> recent_lost/*; <span class="hljs-keyword">do</span>
    file_type=$(file <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span>)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$file</span>: <span class="hljs-variable">$file_type</span>"</span>
<span class="hljs-keyword">done</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/039ea435837649bd80e84462c2bd1a1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=BBKwKetY5oqz8ejqA6cq1UOjBSU%3D" alt="16.png" loading="lazy"/></p>
<p>如图所示，html，json，js，excel，jpg，mp4，pdf，dwg 等格式都能正确判断出来</p>
<p>然后挨个复制哈希值，在 recent_lost 文件搜索文件：按组合键 chrl + p -&gt; 粘贴哈希值</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7618f15aba44484bac405dff6edd462b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=LNwUbK%2F9ip96%2F0f2NYCwAeb8tDY%3D" alt="17.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46418ef3c8874d42adffb886d62de570~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=du7LGNh6NHyRT3kXBwCjG4%2BsHmM%3D" alt="18.png" loading="lazy"/></p>
<p>在 vscode 中找到这个 excel 的哈希值对应的文件，然后鼠标右键，<code>在文件资源管理器中显示</code></p>
<p>然后手动更改文件后缀为对应的文件类型，即可还原内容啦！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65428f40084d410e814922e71093fbec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375004&amp;x-signature=ESjyIq0cb9NP34vFqTqCeYnd9J0%3D" alt="19.png" loading="lazy"/></p>
<p>其他的格式我就不挨个还原啦，步骤都跟还原 excel 一样的</p>
<h2 data-id="heading-13">8. git 瘦身</h2>
<ul>
<li>
<p>强制垃圾回收并立即 prune：</p>
<pre><code class="hljs language-bash" lang="bash">git gc --aggressive --prune=now
</code></pre>
<p>运行这个命令后，删除 lost-found 文件夹，然后新增文件暂存删除暂存后重新 git fsck --lost-found，就会发现，以前的被清理干净了，只剩下了刚才新增删除的文件</p>
</li>
<li>
<p>压缩 .git/objects 文件夹</p>
<pre><code class="hljs language-bash" lang="bash">git repack -a -d -f --depth=50 --window=50
</code></pre>
<p>命令的作用是删除冗余的旧 pack 文件和松散对象，释放空间；命令只影响存储格式，不修改仓库历史、提交或文件内容。SHA 值不变，仓库功能完整。</p>
<p>可是我运行后发现并没啥用，估计是我这个仓库有好几年的历史了，长期累积导致体积变大，压无可压了</p>
</li>
<li>
<p>重新 clone 项目</p>
<p>如果你不嫌麻烦的话，重新 git clone git 仓库也是可以的，不过我已经实践了一遍，重新拉取代码跟运行 git gc --aggressive --prune=now 命令并无区别，.git/objects 文件夹依然是同样的大小</p>
<p>记得提前将 .git/config 文件备份，clone 后再覆盖哦</p>
</li>
</ul>
<h2 data-id="heading-14">总结</h2>
<ul>
<li>
<p>如果没有暂存过，就无法通过 git 命令找回。不过可以试试编辑器的历史记录功能，这里用 vscode 举例</p>
<p>操作步骤：同时按住 <code>ctrl + shift + p</code> 调用快捷键 -&gt; 输入并打开 <code>本地历史记录：查找要还原的条目</code> -&gt; 就可以看见本地历史文件列表了</p>
</li>
<li>
<p>如果是用 Socurcetree 提交代码的时候，报错然后丢失了文件，或许去<code>贮藏</code>菜单下面可以找到代码（我今天就被 Socurcetree 给坑了，报错后自己给我丢到贮藏去了）</p>
</li>
<li>
<p>只能还原丢失的文件内容，无法还原文件名，不过我想能找回内容也够用了</p>
</li>
<li>
<p>养成良好习惯，随时 git add . 呀！</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AOP详解：从原理到实战]]></title>    <link>https://juejin.cn/post/7592361736130068490</link>    <guid>https://juejin.cn/post/7592361736130068490</guid>    <pubDate>2026-01-07T07:23:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592361736130068490" data-draft-id="7592361736130052106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AOP详解：从原理到实战"/> <meta itemprop="keywords" content="Spring"/> <meta itemprop="datePublished" content="2026-01-07T07:23:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AOP详解：从原理到实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T07:23:50.000Z" title="Wed Jan 07 2026 07:23:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring AOP详解：从原理到实战</h2>
<h3 data-id="heading-1">前言</h3>
<p>AOP（Aspect-Oriented Programming，面向切面编程）是Spring框架的另一大核心特性。它通过将横切关注点（Cross-Cutting Concerns）从业务逻辑中分离出来，实现了代码的解耦和复用。本文将深入讲解Spring AOP的核心概念、实现原理和实战应用。</p>
<h3 data-id="heading-2">一、什么是AOP</h3>
<h4 data-id="heading-3">1.1 AOP的概念</h4>
<p>AOP是一种编程范式，它将程序中的横切关注点（如日志、事务、安全等）从业务逻辑中分离出来，形成独立的切面。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22415fa2d33b4fd5ab8ca0466b2b309f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375430&amp;x-signature=JFeKaFAx10CFw2rzstcO%2BKp905w%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">1.2 核心概念</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c13a945da5d4259b027e9017ec15ab2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375430&amp;x-signature=I1gTMjKipp%2Fizrs8%2B6v4y9LJMYc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">1.3 为什么需要AOP</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 没有AOP的代码 - 存在的问题
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceWithoutAOP</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 1. 日志记录</span>
        System.out.println(<span class="hljs-string">"开始创建用户: "</span> + user.getUsername());
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-comment">// 2. 权限检查</span>
        <span class="hljs-keyword">if</span> (!SecurityContext.hasPermission(<span class="hljs-string">"user:create"</span>)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityException</span>(<span class="hljs-string">"没有权限"</span>);
        }

        <span class="hljs-comment">// 3. 参数校验</span>
        <span class="hljs-keyword">if</span> (user.getUsername() == <span class="hljs-literal">null</span> || user.getUsername().isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户名不能为空"</span>);
        }

        <span class="hljs-comment">// 4. 事务开启</span>
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">tx</span> <span class="hljs-operator">=</span> TransactionManager.begin();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 5. 核心业务逻辑</span>
            saveUser(user);

            <span class="hljs-comment">// 6. 事务提交</span>
            tx.commit();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 7. 事务回滚</span>
            tx.rollback();
            <span class="hljs-keyword">throw</span> e;
        }

        <span class="hljs-comment">// 8. 日志记录</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(<span class="hljs-string">"创建用户完成，耗时: "</span> + (endTime - startTime) + <span class="hljs-string">"ms"</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 实际的业务逻辑</span>
        System.out.println(<span class="hljs-string">"保存用户到数据库"</span>);
    }
}

<span class="hljs-comment">// 问题：</span>
<span class="hljs-comment">// 1. 代码重复：日志、权限、事务等代码在每个方法中重复</span>
<span class="hljs-comment">// 2. 代码混乱：业务逻辑与系统服务代码混在一起</span>
<span class="hljs-comment">// 3. 难以维护：修改日志逻辑需要改动所有方法</span>
<span class="hljs-comment">// 4. 违反单一职责：一个方法承担了太多责任</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 使用AOP的代码 - 简洁清晰
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceWithAOP</span> {

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-meta">@RequiresPermission("user:create")</span>
    <span class="hljs-meta">@Validated</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 纯粹的业务逻辑</span>
        saveUser(user);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span> {
        System.out.println(<span class="hljs-string">"保存用户到数据库"</span>);
    }
}

<span class="hljs-comment">// 优势：</span>
<span class="hljs-comment">// 1. 代码简洁：只包含核心业务逻辑</span>
<span class="hljs-comment">// 2. 易于维护：系统服务代码集中管理</span>
<span class="hljs-comment">// 3. 可复用：切面可以应用于多个方法</span>
<span class="hljs-comment">// 4. 符合单一职责：业务方法只关注业务逻辑</span>
</code></pre>
<h3 data-id="heading-6">二、Spring AOP基础</h3>
<h4 data-id="heading-7">2.1 通知类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 五种通知类型演示
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdviceTypeDemo</span> {

    <span class="hljs-comment">/**
     * 前置通知：在目标方法执行之前执行
     */</span>
    <span class="hljs-meta">@Before("execution(* com.example.service.*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeAdvice</span><span class="hljs-params">(JoinPoint joinPoint)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();
        System.out.println(<span class="hljs-string">"前置通知：准备执行方法 "</span> + methodName);
    }

    <span class="hljs-comment">/**
     * 后置通知：在目标方法执行之后执行（无论是否抛出异常）
     */</span>
    <span class="hljs-meta">@After("execution(* com.example.service.*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterAdvice</span><span class="hljs-params">(JoinPoint joinPoint)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();
        System.out.println(<span class="hljs-string">"后置通知：方法 "</span> + methodName + <span class="hljs-string">" 执行完成"</span>);
    }

    <span class="hljs-comment">/**
     * 返回通知：在目标方法正常返回之后执行
     */</span>
    <span class="hljs-meta">@AfterReturning(
        pointcut = "execution(* com.example.service.*.*(..))",
        returning = "result"
    )</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterReturningAdvice</span><span class="hljs-params">(JoinPoint joinPoint, Object result)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();
        System.out.println(<span class="hljs-string">"返回通知：方法 "</span> + methodName + <span class="hljs-string">" 返回值 "</span> + result);
    }

    <span class="hljs-comment">/**
     * 异常通知：在目标方法抛出异常后执行
     */</span>
    <span class="hljs-meta">@AfterThrowing(
        pointcut = "execution(* com.example.service.*.*(..))",
        throwing = "ex"
    )</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterThrowingAdvice</span><span class="hljs-params">(JoinPoint joinPoint, Exception ex)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();
        System.out.println(<span class="hljs-string">"异常通知：方法 "</span> + methodName + <span class="hljs-string">" 抛出异常 "</span> + ex.getMessage());
    }

    <span class="hljs-comment">/**
     * 环绕通知：包围目标方法执行，最强大的通知类型
     */</span>
    <span class="hljs-meta">@Around("execution(* com.example.service.*.*(..))")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">aroundAdvice</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();

        System.out.println(<span class="hljs-string">"环绕通知：方法 "</span> + methodName + <span class="hljs-string">" 开始执行"</span>);
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行目标方法</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();

            <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            System.out.println(<span class="hljs-string">"环绕通知：方法 "</span> + methodName + <span class="hljs-string">" 执行成功，耗时 "</span> +
                             (endTime - startTime) + <span class="hljs-string">"ms"</span>);

            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (Throwable e) {
            System.out.println(<span class="hljs-string">"环绕通知：方法 "</span> + methodName + <span class="hljs-string">" 执行失败"</span>);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<p><strong>通知执行顺序：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03c4398f94834319933eaa2fef40b99e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375430&amp;x-signature=pNse%2FqWMr59Vlpz7epSd6UQGhN8%3D" alt="" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fb8f3fa4b6045ee8aa27527168c495b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375430&amp;x-signature=W7DRIFi2uH0xH6UPAyh4HiHcZak%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">2.2 切点表达式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 切点表达式示例
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PointcutExpressionDemo</span> {

    <span class="hljs-comment">/**
     * execution表达式：最常用
     * 语法：execution(修饰符? 返回类型 包名.类名.方法名(参数) 异常?)
     */</span>

    <span class="hljs-comment">// 匹配UserService的所有public方法</span>
    <span class="hljs-meta">@Pointcut("execution(public * com.example.service.UserService.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userServiceMethods</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">// 匹配所有Service的所有方法</span>
    <span class="hljs-meta">@Pointcut("execution(* com.example.service.*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">allServiceMethods</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">// 匹配所有返回User的方法</span>
    <span class="hljs-meta">@Pointcut("execution(com.example.entity.User *.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnUser</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">// 匹配第一个参数是Long类型的方法</span>
    <span class="hljs-meta">@Pointcut("execution(* *(Long, ..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">firstParamIsLong</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">/**
     * within表达式：匹配特定类型
     */</span>

    <span class="hljs-comment">// 匹配service包下的所有类</span>
    <span class="hljs-meta">@Pointcut("within(com.example.service.*)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">withinService</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">// 匹配service包及子包下的所有类</span>
    <span class="hljs-meta">@Pointcut("within(com.example.service..*)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">withinServicePackage</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@annotation</span>表达式：匹配带有特定注解的方法
     */</span>

    <span class="hljs-comment">// 匹配带有@Transactional注解的方法</span>
    <span class="hljs-meta">@Pointcut("@annotation(org.springframework.transaction.annotation.Transactional)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transactionalMethods</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">// 匹配带有@RequiresPermission注解的方法</span>
    <span class="hljs-meta">@Pointcut("@annotation(com.example.annotation.RequiresPermission)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requiresPermissionMethods</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@within</span>表达式：匹配带有特定注解的类的所有方法
     */</span>

    <span class="hljs-comment">// 匹配带有@Service注解的类的所有方法</span>
    <span class="hljs-meta">@Pointcut("@within(org.springframework.stereotype.Service)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serviceBeans</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">/**
     * args表达式：匹配参数类型
     */</span>

    <span class="hljs-comment">// 匹配参数是User类型的方法</span>
    <span class="hljs-meta">@Pointcut("args(com.example.entity.User)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">argsUser</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">/**
     * 组合切点表达式
     */</span>

    <span class="hljs-comment">// 与运算：同时满足两个条件</span>
    <span class="hljs-meta">@Pointcut("userServiceMethods() &amp;&amp; args(Long)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userServiceWithLongParam</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">// 或运算：满足任一条件</span>
    <span class="hljs-meta">@Pointcut("withinService() || withinServicePackage()")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serviceOrPackage</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">// 非运算：不满足条件</span>
    <span class="hljs-meta">@Pointcut("allServiceMethods() &amp;&amp; !userServiceMethods()")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">excludeUserService</span><span class="hljs-params">()</span> {}
}
</code></pre>
<h4 data-id="heading-9">2.3 完整的切面示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 日志切面
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingAspect</span> {

    <span class="hljs-comment">/**
     * 定义切点：service层所有方法
     */</span>
    <span class="hljs-meta">@Pointcut("execution(* com.example.service..*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serviceLayer</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">/**
     * 环绕通知：记录方法执行时间和参数
     */</span>
    <span class="hljs-meta">@Around("serviceLayer()")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">logAround</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 获取方法信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> joinPoint.getTarget().getClass().getSimpleName();
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();
        Object[] args = joinPoint.getArgs();

        <span class="hljs-comment">// 记录开始</span>
        log.info(<span class="hljs-string">"开始执行: {}.{}(), 参数: {}"</span>, className, methodName, Arrays.toString(args));
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行目标方法</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();

            <span class="hljs-comment">// 记录成功</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            log.info(<span class="hljs-string">"执行成功: {}.{}(), 耗时: {}ms, 返回值: {}"</span>,
                    className, methodName, (endTime - startTime), result);

            <span class="hljs-keyword">return</span> result;

        } <span class="hljs-keyword">catch</span> (Throwable e) {
            <span class="hljs-comment">// 记录异常</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            log.error(<span class="hljs-string">"执行失败: {}.{}(), 耗时: {}ms, 异常: {}"</span>,
                     className, methodName, (endTime - startTime), e.getMessage());
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<h3 data-id="heading-10">三、AOP实现原理</h3>
<h4 data-id="heading-11">3.1 JDK动态代理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * JDK动态代理示例
 * 要求：目标对象必须实现接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> {
    User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
        System.out.println(<span class="hljs-string">"查询用户: "</span> + id);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(id, <span class="hljs-string">"User"</span> + id);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span> {
        System.out.println(<span class="hljs-string">"保存用户: "</span> + user.getUsername());
    }
}

<span class="hljs-comment">/**
 * 自定义InvocationHandler
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {

    <span class="hljs-keyword">private</span> Object target;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LogInvocationHandler</span><span class="hljs-params">(Object target)</span> {
        <span class="hljs-built_in">this</span>.target = target;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 前置增强</span>
        System.out.println(<span class="hljs-string">"JDK代理 - 方法开始: "</span> + method.getName());
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-comment">// 调用目标方法</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);

        <span class="hljs-comment">// 后置增强</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(<span class="hljs-string">"JDK代理 - 方法结束: "</span> + method.getName() +
                         <span class="hljs-string">", 耗时: "</span> + (endTime - startTime) + <span class="hljs-string">"ms"</span>);

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">/**
     * 创建代理对象
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">createProxy</span><span class="hljs-params">(T target)</span> {
        <span class="hljs-keyword">return</span> (T) Proxy.newProxyInstance(
            target.getClass().getClassLoader(),
            target.getClass().getInterfaces(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogInvocationHandler</span>(target)
        );
    }
}

<span class="hljs-comment">/**
 * 使用JDK代理
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdkProxyDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建目标对象</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();

        <span class="hljs-comment">// 创建代理对象</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> LogInvocationHandler.createProxy(target);

        <span class="hljs-comment">// 调用代理对象的方法</span>
        proxy.findById(<span class="hljs-number">1L</span>);
        proxy.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">"张三"</span>));
    }
}
</code></pre>
<h4 data-id="heading-12">3.2 CGLIB代理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * CGLIB代理示例
 * 优势：不需要实现接口，通过继承实现
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
        System.out.println(<span class="hljs-string">"查询订单: "</span> + id);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(id, <span class="hljs-string">"ORDER"</span> + id);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(Order order)</span> {
        System.out.println(<span class="hljs-string">"保存订单: "</span> + order.getOrderNo());
    }
}

<span class="hljs-comment">/**
 * 自定义MethodInterceptor
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogMethodInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object obj, Method method, Object[] args,
                          MethodProxy proxy)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 前置增强</span>
        System.out.println(<span class="hljs-string">"CGLIB代理 - 方法开始: "</span> + method.getName());
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-comment">// 调用父类方法（目标方法）</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> proxy.invokeSuper(obj, args);

        <span class="hljs-comment">// 后置增强</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(<span class="hljs-string">"CGLIB代理 - 方法结束: "</span> + method.getName() +
                         <span class="hljs-string">", 耗时: "</span> + (endTime - startTime) + <span class="hljs-string">"ms"</span>);

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">/**
     * 创建代理对象
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span> {
        <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();
        enhancer.setSuperclass(clazz);
        enhancer.setCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LogMethodInterceptor</span>());
        <span class="hljs-keyword">return</span> (T) enhancer.create();
    }
}

<span class="hljs-comment">/**
 * 使用CGLIB代理
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibProxyDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建代理对象（无需目标对象）</span>
        <span class="hljs-type">OrderService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> LogMethodInterceptor.createProxy(OrderService.class);

        <span class="hljs-comment">// 调用代理对象的方法</span>
        proxy.findById(<span class="hljs-number">1L</span>);
        proxy.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">"ORD20240101"</span>));
    }
}
</code></pre>
<h4 data-id="heading-13">3.3 Spring AOP代理选择</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e14c35ef80f54878b05a407f105bf6e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375430&amp;x-signature=ol1sgXJSNZQB4oTo4uN5lCEPxis%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Spring AOP配置
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAspectJAutoProxy(proxyTargetClass = true)</span>  <span class="hljs-comment">// 强制使用CGLIB</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AopConfig</span> {
}
</code></pre>
<h3 data-id="heading-14">四、实战案例</h3>
<h4 data-id="heading-15">4.1 案例1：性能监控切面</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 性能监控注解
 */</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> PerformanceMonitor {
    String <span class="hljs-title function_">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;
    <span class="hljs-type">long</span> <span class="hljs-title function_">threshold</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 默认阈值1秒</span>
}

<span class="hljs-comment">/**
 * 性能监控切面
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMonitorAspect</span> {

    <span class="hljs-meta">@Around("@annotation(monitor)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">monitor</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, PerformanceMonitor monitor)</span>
            <span class="hljs-keyword">throws</span> Throwable {

        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().toShortString();
        <span class="hljs-type">String</span> <span class="hljs-variable">operationName</span> <span class="hljs-operator">=</span> monitor.value().isEmpty() ? methodName : monitor.value();
        <span class="hljs-type">long</span> <span class="hljs-variable">threshold</span> <span class="hljs-operator">=</span> monitor.threshold();

        <span class="hljs-comment">// 开始计时</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();

            <span class="hljs-comment">// 计算耗时</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> endTime - startTime;

            <span class="hljs-comment">// 记录性能数据</span>
            <span class="hljs-keyword">if</span> (duration &gt; threshold) {
                log.warn(<span class="hljs-string">"性能警告: {} 执行耗时 {}ms，超过阈值 {}ms"</span>,
                        operationName, duration, threshold);
            } <span class="hljs-keyword">else</span> {
                log.info(<span class="hljs-string">"性能监控: {} 执行耗时 {}ms"</span>, operationName, duration);
            }

            <span class="hljs-comment">// 可以将性能数据发送到监控系统</span>
            sendToMonitoringSystem(operationName, duration);

            <span class="hljs-keyword">return</span> result;

        } <span class="hljs-keyword">catch</span> (Throwable e) {
            <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> endTime - startTime;
            log.error(<span class="hljs-string">"性能监控: {} 执行失败，耗时 {}ms"</span>, operationName, duration);
            <span class="hljs-keyword">throw</span> e;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendToMonitoringSystem</span><span class="hljs-params">(String operation, <span class="hljs-type">long</span> duration)</span> {
        <span class="hljs-comment">// 发送到Prometheus、Grafana等监控系统</span>
        <span class="hljs-comment">// MetricsRegistry.timer(operation).record(duration, TimeUnit.MILLISECONDS);</span>
    }
}

<span class="hljs-comment">/**
 * 使用性能监控
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {

    <span class="hljs-meta">@PerformanceMonitor(value = "查询商品列表", threshold = 500)</span>
    <span class="hljs-keyword">public</span> List&lt;Product&gt; <span class="hljs-title function_">findProducts</span><span class="hljs-params">(String category)</span> {
        <span class="hljs-comment">// 模拟数据库查询</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">300</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
        <span class="hljs-keyword">return</span> Arrays.asList(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-number">1L</span>, <span class="hljs-string">"商品1"</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-number">2L</span>, <span class="hljs-string">"商品2"</span>)
        );
    }

    <span class="hljs-meta">@PerformanceMonitor(value = "生成报表", threshold = 2000)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">generateReport</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟耗时操作</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">1500</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h4 data-id="heading-16">4.2 案例2：操作日志切面</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 操作日志注解
 */</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> OperationLog {
    String <span class="hljs-title function_">module</span><span class="hljs-params">()</span>;        <span class="hljs-comment">// 模块名</span>
    String <span class="hljs-title function_">operation</span><span class="hljs-params">()</span>;     <span class="hljs-comment">// 操作类型</span>
    String <span class="hljs-title function_">description</span><span class="hljs-params">()</span>;   <span class="hljs-comment">// 操作描述</span>
}

<span class="hljs-comment">/**
 * 操作日志实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SysOperationLog</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String <span class="hljs-keyword">module</span>;
    <span class="hljs-keyword">private</span> String operation;
    <span class="hljs-keyword">private</span> String description;
    <span class="hljs-keyword">private</span> String method;
    <span class="hljs-keyword">private</span> String params;
    <span class="hljs-keyword">private</span> String result;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String ip;
    <span class="hljs-keyword">private</span> Long duration;
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> String errorMsg;
}

<span class="hljs-comment">/**
 * 操作日志切面
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperationLogAspect</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OperationLogService operationLogService;

    <span class="hljs-meta">@Around("@annotation(operationLog)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">logOperation</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, OperationLog operationLog)</span>
            <span class="hljs-keyword">throws</span> Throwable {

        <span class="hljs-comment">// 创建日志对象</span>
        <span class="hljs-type">SysOperationLog</span> <span class="hljs-variable">sysLog</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SysOperationLog</span>();
        sysLog.setModule(operationLog.<span class="hljs-keyword">module</span>());
        sysLog.setOperation(operationLog.operation());
        sysLog.setDescription(operationLog.description());
        sysLog.setCreateTime(LocalDateTime.now());

        <span class="hljs-comment">// 获取方法信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> joinPoint.getTarget().getClass().getName();
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();
        sysLog.setMethod(className + <span class="hljs-string">"."</span> + methodName);

        <span class="hljs-comment">// 获取方法参数</span>
        Object[] args = joinPoint.getArgs();
        sysLog.setParams(JSON.toJSONString(args));

        <span class="hljs-comment">// 获取用户信息</span>
        sysLog.setUsername(getCurrentUsername());
        sysLog.setIp(getClientIp());

        <span class="hljs-comment">// 开始计时</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行目标方法</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();

            <span class="hljs-comment">// 记录返回值</span>
            sysLog.setResult(JSON.toJSONString(result));

            <span class="hljs-comment">// 计算耗时</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            sysLog.setDuration(endTime - startTime);

            <span class="hljs-comment">// 异步保存日志</span>
            operationLogService.saveAsync(sysLog);

            <span class="hljs-keyword">return</span> result;

        } <span class="hljs-keyword">catch</span> (Throwable e) {
            <span class="hljs-comment">// 记录异常</span>
            sysLog.setErrorMsg(e.getMessage());
            <span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            sysLog.setDuration(endTime - startTime);

            <span class="hljs-comment">// 异步保存日志</span>
            operationLogService.saveAsync(sysLog);

            <span class="hljs-keyword">throw</span> e;
        }
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getCurrentUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 从SecurityContext获取当前用户</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"admin"</span>;  <span class="hljs-comment">// 简化示例</span>
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getClientIp</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 从HttpServletRequest获取客户端IP</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"127.0.0.1"</span>;  <span class="hljs-comment">// 简化示例</span>
    }
}

<span class="hljs-comment">/**
 * 使用操作日志
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-meta">@OperationLog(
        module = "用户管理",
        operation = "创建",
        description = "创建新用户"
    )</span>
    <span class="hljs-keyword">public</span> Result&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        userService.createUser(user);
        <span class="hljs-keyword">return</span> Result.success(user);
    }

    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-meta">@OperationLog(
        module = "用户管理",
        operation = "删除",
        description = "删除用户"
    )</span>
    <span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        userService.deleteUser(id);
        <span class="hljs-keyword">return</span> Result.success();
    }
}
</code></pre>
<h4 data-id="heading-17">4.3 案例3：权限校验切面</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 权限校验注解
 */</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RequiresPermission {
    String[] value();           <span class="hljs-comment">// 需要的权限</span>
    Logical <span class="hljs-title function_">logical</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> Logical.AND;  <span class="hljs-comment">// 多个权限的逻辑关系</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Logical</span> {
    AND, OR
}

<span class="hljs-comment">/**
 * 权限校验切面
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionAspect</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PermissionService permissionService;

    <span class="hljs-meta">@Before("@annotation(requiresPermission)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkPermission</span><span class="hljs-params">(JoinPoint joinPoint, RequiresPermission requiresPermission)</span> {
        String[] permissions = requiresPermission.value();
        <span class="hljs-type">Logical</span> <span class="hljs-variable">logical</span> <span class="hljs-operator">=</span> requiresPermission.logical();

        <span class="hljs-comment">// 获取当前用户</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> getCurrentUsername();

        <span class="hljs-comment">// 检查权限</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasPermission</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (logical == Logical.AND) {
            <span class="hljs-comment">// AND：需要拥有所有权限</span>
            hasPermission = permissionService.hasAllPermissions(username, permissions);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// OR：拥有任一权限即可</span>
            hasPermission = permissionService.hasAnyPermission(username, permissions);
        }

        <span class="hljs-keyword">if</span> (!hasPermission) {
            <span class="hljs-type">String</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> joinPoint.getSignature().toShortString();
            log.warn(<span class="hljs-string">"权限不足: 用户[{}]访问方法[{}]需要权限{}"</span>, username, method, permissions);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PermissionDeniedException</span>(<span class="hljs-string">"权限不足"</span>);
        }

        log.info(<span class="hljs-string">"权限校验通过: 用户[{}]访问方法[{}]"</span>, username, joinPoint.getSignature().toShortString());
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getCurrentUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 从SecurityContext获取当前用户</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"admin"</span>;  <span class="hljs-comment">// 简化示例</span>
    }
}

<span class="hljs-comment">/**
 * 权限服务
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionService</span> {

    <span class="hljs-comment">// 用户权限缓存（实际应从数据库或Redis获取）</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Set&lt;String&gt;&gt; userPermissions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PermissionService</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 初始化测试数据</span>
        userPermissions.put(<span class="hljs-string">"admin"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(Arrays.asList(
            <span class="hljs-string">"user:create"</span>, <span class="hljs-string">"user:update"</span>, <span class="hljs-string">"user:delete"</span>, <span class="hljs-string">"user:view"</span>
        )));
        userPermissions.put(<span class="hljs-string">"user"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(Arrays.asList(
            <span class="hljs-string">"user:view"</span>
        )));
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasAllPermissions</span><span class="hljs-params">(String username, String[] permissions)</span> {
        Set&lt;String&gt; userPerms = userPermissions.getOrDefault(username, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;());
        <span class="hljs-keyword">return</span> userPerms.containsAll(Arrays.asList(permissions));
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasAnyPermission</span><span class="hljs-params">(String username, String[] permissions)</span> {
        Set&lt;String&gt; userPerms = userPermissions.getOrDefault(username, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;());
        <span class="hljs-keyword">for</span> (String permission : permissions) {
            <span class="hljs-keyword">if</span> (userPerms.contains(permission)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}

<span class="hljs-comment">/**
 * 使用权限校验
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-meta">@RequiresPermission("user:create")</span>
    <span class="hljs-keyword">public</span> Result&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-comment">// 只有拥有user:create权限的用户才能访问</span>
        <span class="hljs-keyword">return</span> Result.success(user);
    }

    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-meta">@RequiresPermission({"user:delete", "admin:all"}, logical = Logical.OR)</span>
    <span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-comment">// 拥有user:delete或admin:all权限之一即可访问</span>
        <span class="hljs-keyword">return</span> Result.success();
    }
}
</code></pre>
<h4 data-id="heading-18">4.4 案例4：缓存切面</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 缓存注解
 */</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Cacheable {
    String <span class="hljs-title function_">key</span><span class="hljs-params">()</span>;               <span class="hljs-comment">// 缓存key</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">expire</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">3600</span>;  <span class="hljs-comment">// 过期时间（秒）</span>
}

<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> CacheEvict {
    String <span class="hljs-title function_">key</span><span class="hljs-params">()</span>;  <span class="hljs-comment">// 要删除的缓存key</span>
}

<span class="hljs-comment">/**
 * 缓存切面
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheAspect</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

    <span class="hljs-comment">/**
     * 缓存查询
     */</span>
    <span class="hljs-meta">@Around("@annotation(cacheable)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">cache</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, Cacheable cacheable)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 构建缓存key</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> buildCacheKey(cacheable.key(), joinPoint);

        <span class="hljs-comment">// 尝试从缓存获取</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">cachedValue</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
        <span class="hljs-keyword">if</span> (cachedValue != <span class="hljs-literal">null</span>) {
            log.info(<span class="hljs-string">"缓存命中: {}"</span>, cacheKey);
            <span class="hljs-keyword">return</span> cachedValue;
        }

        <span class="hljs-comment">// 缓存未命中，执行方法</span>
        log.info(<span class="hljs-string">"缓存未命中: {}"</span>, cacheKey);
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();

        <span class="hljs-comment">// 存入缓存</span>
        <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) {
            redisTemplate.opsForValue().set(cacheKey, result,
                cacheable.expire(), TimeUnit.SECONDS);
            log.info(<span class="hljs-string">"缓存写入: {}, 过期时间: {}秒"</span>, cacheKey, cacheable.expire());
        }

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">/**
     * 缓存清除
     */</span>
    <span class="hljs-meta">@AfterReturning("@annotation(cacheEvict)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">evictCache</span><span class="hljs-params">(JoinPoint joinPoint, CacheEvict cacheEvict)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> buildCacheKey(cacheEvict.key(), joinPoint);
        redisTemplate.delete(cacheKey);
        log.info(<span class="hljs-string">"缓存清除: {}"</span>, cacheKey);
    }

    <span class="hljs-comment">/**
     * 构建缓存key
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildCacheKey</span><span class="hljs-params">(String keyPattern, JoinPoint joinPoint)</span> {
        Object[] args = joinPoint.getArgs();

        <span class="hljs-comment">// 支持SpEL表达式（简化版）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPattern;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) {
            key = key.replace(<span class="hljs-string">"#p"</span> + i, String.valueOf(args[i]));
        }

        <span class="hljs-keyword">return</span> key;
    }
}

<span class="hljs-comment">/**
 * 使用缓存
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {

    <span class="hljs-meta">@Cacheable(key = "product:#p0", expire = 1800)</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
        log.info(<span class="hljs-string">"从数据库查询商品: {}"</span>, id);
        <span class="hljs-comment">// 模拟数据库查询</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(id, <span class="hljs-string">"商品"</span> + id);
    }

    <span class="hljs-meta">@CacheEvict(key = "product:#p0.id")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProduct</span><span class="hljs-params">(Product product)</span> {
        log.info(<span class="hljs-string">"更新商品: {}"</span>, product.getId());
        <span class="hljs-comment">// 更新数据库</span>
    }
}
</code></pre>
<h4 data-id="heading-19">4.5 案例5：防重复提交切面</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 防重复提交注解
 */</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> PreventDuplicateSubmit {
    <span class="hljs-type">int</span> <span class="hljs-title function_">timeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">5</span>;  <span class="hljs-comment">// 锁定时间（秒）</span>
}

<span class="hljs-comment">/**
 * 防重复提交切面
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreventDuplicateSubmitAspect</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;

    <span class="hljs-meta">@Around("@annotation(preventDuplicate)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">preventDuplicate</span><span class="hljs-params">(ProceedingJoinPoint joinPoint,
                                   PreventDuplicateSubmit preventDuplicate)</span> <span class="hljs-keyword">throws</span> Throwable {

        <span class="hljs-comment">// 构建唯一key（用户 + 方法 + 参数）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> buildSubmitKey(joinPoint);
        <span class="hljs-type">int</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> preventDuplicate.timeout();

        <span class="hljs-comment">// 尝试获取锁</span>
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue()
            .setIfAbsent(key, <span class="hljs-string">"1"</span>, timeout, TimeUnit.SECONDS);

        <span class="hljs-keyword">if</span> (success == <span class="hljs-literal">null</span> || !success) {
            log.warn(<span class="hljs-string">"重复提交: {}"</span>, key);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DuplicateSubmitException</span>(<span class="hljs-string">"请勿重复提交"</span>);
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行方法</span>
            <span class="hljs-keyword">return</span> joinPoint.proceed();
        } <span class="hljs-keyword">catch</span> (Throwable e) {
            <span class="hljs-comment">// 发生异常时释放锁</span>
            redisTemplate.delete(key);
            <span class="hljs-keyword">throw</span> e;
        }
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildSubmitKey</span><span class="hljs-params">(JoinPoint joinPoint)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> getCurrentUsername();
        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> joinPoint.getTarget().getClass().getSimpleName();
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();
        Object[] args = joinPoint.getArgs();

        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"submit:%s:%s:%s:%s"</span>,
            username, className, methodName, Arrays.hashCode(args));
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getCurrentUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"user123"</span>;  <span class="hljs-comment">// 简化示例</span>
    }
}

<span class="hljs-comment">/**
 * 使用防重复提交
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-meta">@PreventDuplicateSubmit(timeout = 10)</span>
    <span class="hljs-keyword">public</span> Result&lt;Order&gt; <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span> {
        <span class="hljs-comment">// 创建订单（防止用户重复点击）</span>
        <span class="hljs-keyword">return</span> Result.success(order);
    }
}
</code></pre>
<h3 data-id="heading-20">五、事务管理与AOP</h3>
<h4 data-id="heading-21">5.1 声明式事务原理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Spring事务是基于AOP实现的
 * <span class="hljs-doctag">@Transactional</span>注解的处理流程
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionAspectSimulation</span> {

    <span class="hljs-meta">@Around("@annotation(transactional)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">handleTransaction</span><span class="hljs-params">(ProceedingJoinPoint joinPoint,
                                    Transactional transactional)</span> <span class="hljs-keyword">throws</span> Throwable {

        <span class="hljs-comment">// 1. 获取事务管理器</span>
        <span class="hljs-type">TransactionManager</span> <span class="hljs-variable">txManager</span> <span class="hljs-operator">=</span> getTransactionManager();

        <span class="hljs-comment">// 2. 开启事务</span>
        <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> txManager.begin();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 3. 执行业务方法</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();

            <span class="hljs-comment">// 4. 提交事务</span>
            txManager.commit(status);

            <span class="hljs-keyword">return</span> result;

        } <span class="hljs-keyword">catch</span> (Throwable e) {
            <span class="hljs-comment">// 5. 回滚事务</span>
            txManager.rollback(status);
            <span class="hljs-keyword">throw</span> e;
        }
    }

    <span class="hljs-keyword">private</span> TransactionManager <span class="hljs-title function_">getTransactionManager</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionManager</span>();
    }
}

<span class="hljs-comment">/**
 * 事务传播行为示例
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderDao orderDao;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderItemService orderItemService;

    <span class="hljs-comment">/**
     * REQUIRED：如果当前有事务，加入该事务；否则创建新事务
     */</span>
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        orderDao.save(order);

        <span class="hljs-comment">// 加入当前事务</span>
        orderItemService.saveItems(order.getItems());
    }

    <span class="hljs-comment">/**
     * REQUIRES_NEW：总是创建新事务，挂起当前事务
     */</span>
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrderWithNewTransaction</span><span class="hljs-params">(Order order)</span> {
        orderDao.save(order);

        <span class="hljs-comment">// 在新事务中执行</span>
        orderItemService.saveItemsInNewTransaction(order.getItems());
    }

    <span class="hljs-comment">/**
     * NESTED：嵌套事务
     */</span>
    <span class="hljs-meta">@Transactional(propagation = Propagation.NESTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrderWithNested</span><span class="hljs-params">(Order order)</span> {
        orderDao.save(order);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 嵌套事务，可以独立回滚</span>
            orderItemService.saveItemsNested(order.getItems());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 子事务回滚不影响主事务</span>
            log.error(<span class="hljs-string">"保存订单项失败"</span>, e);
        }
    }
}
</code></pre>
<h4 data-id="heading-22">5.2 事务失效场景</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 事务失效的常见场景
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionFailureDemo</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserDao userDao;

    <span class="hljs-comment">/**
     * 场景1：方法不是public（事务失效）
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">privateMethod</span><span class="hljs-params">()</span> {  <span class="hljs-comment">//事务不生效</span>
        userDao.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>());
    }

    <span class="hljs-comment">/**
     * 场景2：同类内部调用（事务失效）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">//直接调用，绕过代理，事务不生效</span>
        <span class="hljs-built_in">this</span>.innerMethod();
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">innerMethod</span><span class="hljs-params">()</span> {
        userDao.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>());
    }

    <span class="hljs-comment">/**
     * 场景3：异常被捕获（事务失效）
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">catchException</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            userDao.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>());
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">//异常被捕获，事务不会回滚</span>
        }
    }

    <span class="hljs-comment">/**
     * 场景4：抛出检查异常（默认不回滚）
     */</span>
    <span class="hljs-meta">@Transactional</span>  <span class="hljs-comment">//默认只回滚RuntimeException</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkedExceptionMethod</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        userDao.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>());
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>();  <span class="hljs-comment">// 不会回滚</span>
    }

    <span class="hljs-comment">/**
     * 正确做法：指定回滚异常
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">correctMethod</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        userDao.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>());
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>();  <span class="hljs-comment">// ✓ 会回滚</span>
    }
}

<span class="hljs-comment">/**
 * 解决同类调用问题
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionSolution</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserDao userDao;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ApplicationContext context;

    <span class="hljs-comment">/**
     * 方案1：注入自己
     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TransactionSolution self;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod1</span><span class="hljs-params">()</span> {
        self.innerMethod();  <span class="hljs-comment">// ✓ 通过代理调用</span>
    }

    <span class="hljs-comment">/**
     * 方案2：从容器获取
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod2</span><span class="hljs-params">()</span> {
        <span class="hljs-type">TransactionSolution</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> context.getBean(TransactionSolution.class);
        proxy.innerMethod();  <span class="hljs-comment">// ✓ 通过代理调用</span>
    }

    <span class="hljs-comment">/**
     * 方案3：使用AopContext
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod3</span><span class="hljs-params">()</span> {
        ((TransactionSolution) AopContext.currentProxy()).innerMethod();  <span class="hljs-comment">// ✓</span>
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">innerMethod</span><span class="hljs-params">()</span> {
        userDao.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>());
    }
}
</code></pre>
<h3 data-id="heading-23">六、最佳实践</h3>
<h4 data-id="heading-24">6.1 切面设计原则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 1. 切面职责单一
 */</span>

<span class="hljs-comment">//不好：一个切面做太多事</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BadAspect</span> {
    <span class="hljs-meta">@Around("execution(* com.example..*(..))")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">doEverything</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 日志</span>
        <span class="hljs-comment">// 权限检查</span>
        <span class="hljs-comment">// 缓存</span>
        <span class="hljs-comment">// 事务</span>
        <span class="hljs-comment">// ...</span>
        <span class="hljs-keyword">return</span> joinPoint.proceed();
    }
}

<span class="hljs-comment">// ✓ 好：每个切面专注一个职责</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingAspect</span> { <span class="hljs-comment">/* 只负责日志 */</span> }

<span class="hljs-meta">@Aspect</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityAspect</span> { <span class="hljs-comment">/* 只负责权限 */</span> }

<span class="hljs-meta">@Aspect</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachingAspect</span> { <span class="hljs-comment">/* 只负责缓存 */</span> }

<span class="hljs-comment">/**
 * 2. 精确的切点表达式
 */</span>

<span class="hljs-comment">// 不好：范围太大</span>
<span class="hljs-meta">@Pointcut("execution(* *.*(..))")</span>  <span class="hljs-comment">// 匹配所有方法</span>

<span class="hljs-comment">// ✓ 好：精确匹配</span>
<span class="hljs-meta">@Pointcut("execution(* com.example.service.*.*(..))")</span>  <span class="hljs-comment">// 只匹配service层</span>
</code></pre>
<h4 data-id="heading-25">6.2 性能优化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 1. 使用<span class="hljs-doctag">@Pointcut</span>复用切点表达式
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedAspect</span> {

    <span class="hljs-comment">// 定义可复用的切点</span>
    <span class="hljs-meta">@Pointcut("execution(* com.example.service..*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serviceLayer</span><span class="hljs-params">()</span> {}

    <span class="hljs-meta">@Pointcut("@annotation(com.example.annotation.Log)")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logAnnotation</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">// 复用切点</span>
    <span class="hljs-meta">@Before("serviceLayer() &amp;&amp; logAnnotation()")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeLog</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// ...</span>
    }

    <span class="hljs-meta">@After("serviceLayer() &amp;&amp; logAnnotation()")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterLog</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// ...</span>
    }
}

<span class="hljs-comment">/**
 * 2. 避免在切面中进行耗时操作
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncLoggingAspect</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ThreadPoolTaskExecutor executor;

    <span class="hljs-meta">@Around("@annotation(com.example.annotation.Log)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">log</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();

        <span class="hljs-comment">// ✓ 异步保存日志，不阻塞业务</span>
        executor.execute(() -&gt; saveLog(joinPoint, result));

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveLog</span><span class="hljs-params">(JoinPoint joinPoint, Object result)</span> {
        <span class="hljs-comment">// 耗时的日志保存操作</span>
    }
}
</code></pre>
<h4 data-id="heading-26">6.3 切面执行顺序</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 使用<span class="hljs-doctag">@Order</span>控制切面执行顺序
 */</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Order(1)</span>  <span class="hljs-comment">// 数字越小，优先级越高</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityAspect</span> {
    <span class="hljs-comment">// 最先执行</span>
}

<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Order(2)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingAspect</span> {
    <span class="hljs-comment">// 第二执行</span>
}

<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Order(3)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionAspect</span> {
    <span class="hljs-comment">// 最后执行</span>
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f22ca31b56049b5a6bff8bc234dce52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768375430&amp;x-signature=giNGZVgIfj3YZrSsHpnnjST%2FRfg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-27">七、总结</h3>
<p>Spring AOP是Spring框架的重要组成部分，它将横切关注点从业务逻辑中分离出来，使代码更加简洁、易于维护。在实际开发中，合理运用AOP可以大大提高开发效率和代码质量。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ofd文件]]></title>    <link>https://juejin.cn/post/7592159803410022436</link>    <guid>https://juejin.cn/post/7592159803410022436</guid>    <pubDate>2026-01-07T07:24:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592159803410022436" data-draft-id="7592144524308905990" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ofd文件"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-07T07:24:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="林太白"/> <meta itemprop="url" content="https://juejin.cn/user/1874034273300919"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ofd文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1874034273300919/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    林太白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T07:24:06.000Z" title="Wed Jan 07 2026 07:24:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ofd文件处理预览</h2>
<p>文章内容所涉及的源码地址，求朋友们给个star啊</p>
<pre><code class="hljs language-markdown" lang="markdown">::: tip

个人网站 （[<span class="hljs-string">https://nexuslin.github.io/</span>](<span class="hljs-link">https://nexuslin.github.io/</span>)）

文章内容所涉及的源码地址，求朋友们给个star啊


同路之人，幸得君顾，盼得君之一赞！

与君同行，愿得青眼相加！

你的star

如春风化雨，润物无声；

如山间清泉，滋润心田；

如长河落日，映照初心；

亦如暗夜明灯，照亮前路；

是吾辈前行之明灯，亦是我坚持的动力!

愿君前程似锦，代码如诗，人生如画！

【GIthub地址】（[<span class="hljs-string">https://github.com/lintaibai/TG</span>](<span class="hljs-link">https://gitee.com/lintaibai/TG</span>)）

【Gitee地址】（[<span class="hljs-string">https://gitee.com/lintaibai/TG</span>](<span class="hljs-link">https://gitee.com/lintaibai/TG</span>)）


:::
</code></pre>
<h3 data-id="heading-1">OFD文件是什么</h3>
<p>本质上就是一种国产的压缩文件</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-number">2016</span>年成为国家标准（<span class="hljs-variable constant_">GB</span>/T <span class="hljs-number">33190</span>-<span class="hljs-number">2016</span>）

<span class="hljs-comment">// 国家标准网站</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=3AF6682D939116B6F5EED53D01A9DB5D</span>
</code></pre>
<p>OFD（Open Fixed-layout Document）开放式版式文件</p>
<p>中国自主研发的一种电子文档格式‌</p>
<p>中国国家标准版的电子文件格式，类似于 PDF</p>
<p>具有以下特点：</p>
<ul>
<li>基于XML和ZIP技术</li>
<li>支持数字签名</li>
<li>支持版式固定</li>
<li>支持国产密码算法</li>
<li>支持长期保存格式</li>
</ul>
<h3 data-id="heading-2">OFD 文件结构</h3>
<p>OFD 文件本质上是一个 ZIP 压缩包，包含以下结构</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-property">ofd</span>
├── <span class="hljs-variable constant_">OFD</span>.<span class="hljs-property">xml</span>          <span class="hljs-comment">// 文档根文件</span>
├── <span class="hljs-title class_">Doc</span>_0/
│   ├── <span class="hljs-title class_">Doc</span>_0/       <span class="hljs-comment">// 文档目录</span>
│   │   ├── <span class="hljs-title class_">Document</span>.<span class="hljs-property">xml</span>
│   │   └── <span class="hljs-title class_">Pages</span>/
│   │       └── <span class="hljs-title class_">Page</span>_0/
│   │           ├── <span class="hljs-title class_">Page</span>.<span class="hljs-property">xml</span>
│   │           └── <span class="hljs-title class_">Res</span>/        <span class="hljs-comment">// 资源目录</span>
│   │               ├── image/
│   │               └── font/
└── <span class="hljs-title class_">Public</span>.<span class="hljs-property">xml</span>       <span class="hljs-comment">// 公共资源</span>
</code></pre>
<h3 data-id="heading-3">相关库的认识</h3>
<p>想要解决ofd文件的预览，我们必须认识相关的两个依赖库</p>
<pre><code class="hljs language-javascript" lang="javascript">jszip 
<span class="hljs-title class_">JSZipUtils</span> 
</code></pre>
<p>这两个库存的作用和认识</p>
<h4 data-id="heading-4"><code>jszip</code>的认识使用</h4>
<h5 data-id="heading-5">认识</h5>
<p>JSZip 是一个用于创建、读取和编辑 .zip 文件的JavaScript库。它可以在浏览器和Node.js环境中使用。</p>
<h5 data-id="heading-6">主要功能：</h5>
<ul>
<li>创建新的 ZIP 文件</li>
<li>读取现有的 ZIP 文件</li>
<li>向 ZIP 文件中添加或删除文件</li>
<li>生成 ZIP 文件并下载</li>
</ul>
<h5 data-id="heading-7">使用示例</h5>
<pre><code class="hljs language-plain" lang="plain">// 创建一个新的 ZIP 文件
var zip = new JSZip();

// 添加一个文本文件
zip.file("hello.txt", "Hello World\n");

// 添加一个文件夹和其中的文件
zip.folder("images").file("smile.gif", "base64数据", {base64: true});

// 生成 ZIP 文件
zip.generateAsync({type:"blob"})
.then(function(content) {
    // 在浏览器中下载
    saveAs(content, "example.zip");
});
</code></pre>
<h5 data-id="heading-8">常见应用场景：</h5>
<ul>
<li>在前端打包多个文件供用户下载</li>
<li>动态生成包含多个文件的压缩包</li>
<li>处理上传的 ZIP 文件内容</li>
</ul>
<h4 data-id="heading-9"><code>JSZipUtils </code>的认识使用</h4>
<h5 data-id="heading-10">认识</h5>
<p>JSZipUtils 是 JSZip 的一个辅助工具库，主要用于处理二进制数据，特别是在获取远程文件时非常有用。</p>
<h5 data-id="heading-11">主要功能：</h5>
<ul>
<li>获取二进制数据</li>
<li>处理跨域请求</li>
<li>提供便捷的文件获取方法</li>
</ul>
<h5 data-id="heading-12">基本使用示例：</h5>
<pre><code class="hljs language-plain" lang="plain">// 获取远程二进制数据
JSZipUtils.getBinaryContent("path/to/file.zip", function(err, data) {
    if(err) {
        throw err;
    }
    
    // 使用获取到的数据创建 JSZip 对象
    JSZip.loadAsync(data)
    .then(function(zip) {
        // 处理 zip 文件内容
        return zip.file("hello.txt").async("string");
    })
    .then(function(text) {
        console.log(text);
    });
});
</code></pre>
<h5 data-id="heading-13">常见应用场景：</h5>
<ul>
<li>下载并处理远程 ZIP 文件</li>
<li>获取二进制文件内容</li>
<li>处理跨域的二进制数据请求</li>
</ul>
<h4 data-id="heading-14">为什么 JSZipUtils 被废弃</h4>
<p>JSZipUtils 被废弃的主要原因有：</p>
<ol>
<li>现代浏览器原生支持更好：fetch API 已经成为现代浏览器的标准，提供了更强大和灵活的功能</li>
<li>维护问题：JSZipUtils 已经很久没有更新，可能存在安全漏洞</li>
<li>功能冗余：fetch API 可以完全覆盖 JSZipUtils 的功能，而且提供更多特性</li>
</ol>
<h5 data-id="heading-15">使用 fetch API 替代的示例</h5>
<h6 data-id="heading-16">原来的 JSZipUtils 写法：</h6>
<pre><code class="hljs language-plain" lang="plain">JSZipUtils.getBinaryContent("path/to/file.zip", function(err, data) {
    if(err) {
        throw err;
    }
    JSZip.loadAsync(data)
    .then(function(zip) {
        // 处理 zip 文件
    });
});
</code></pre>
<h6 data-id="heading-17">使用 fetch API 的现代写法：</h6>
<pre><code class="hljs language-plain" lang="plain">fetch("path/to/file.zip")
    .then(response =&gt; {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.arrayBuffer();
    })
    .then(data =&gt; {
        return JSZip.loadAsync(data);
    })
    .then(zip =&gt; {
        // 处理 zip 文件
    })
    .catch(error =&gt; {
        console.error("Error:", error);
    });
</code></pre>
<h5 data-id="heading-18">fetch API 的优势</h5>
<ol>
<li>更好的错误处理：</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">fetch(url)
    .then(response =&gt; {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.arrayBuffer();
    })
</code></pre>
<ol start="2">
<li>支持更多数据类型：</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">// 获取不同类型的数据
fetch(url)
    .then(response =&gt; response.arrayBuffer())  // 二进制数据
    .then(response =&gt; response.blob())        // Blob 对象
    .then(response =&gt; response.text())        // 文本数据
    .then(response =&gt; response.json())        // JSON 数据
</code></pre>
<ol start="3">
<li>支持请求配置：</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">fetch(url, {
    method: 'GET',
    headers: {
        'Authorization': 'Bearer token',
        'Content-Type': 'application/octet-stream'
    },
    mode: 'cors',
    credentials: 'include'
})
</code></pre>
<ol start="4">
<li>支持异步/等待语法：</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">async function loadZip(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const data = await response.arrayBuffer();
        const zip = await JSZip.loadAsync(data);
        return zip;
    } catch (error) {
        console.error('Error:', error);
        throw error;
    }
}
</code></pre>
<h5 data-id="heading-19">完整的迁移示例</h5>
<p>假设我们要下载一个 ZIP 文件，解压后获取其中的文件内容：</p>
<pre><code class="hljs language-plain" lang="plain">// 使用 async/await 的现代写法
async function processZipFile(url) {
    try {
        // 1. 获取文件
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // 2. 转换为二进制数据
        const arrayBuffer = await response.arrayBuffer();
        
        // 3. 加载到 JSZip
        const zip = await JSZip.loadAsync(arrayBuffer);
        
        // 4. 处理文件内容
        const files = Object.keys(zip.files);
        for (const filename of files) {
            if (!zip.files[filename].dir) {
                const content = await zip.file(filename).async('string');
                console.log(`${filename}: ${content}`);
            }
        }
        
        return zip;
    } catch (error) {
        console.error('Error processing zip file:', error);
        throw error;
    }
}

// 使用示例
processZipFile('path/to/file.zip')
    .then(zip =&gt; {
        console.log('Zip file processed successfully');
    })
    .catch(error =&gt; {
        console.error('Failed to process zip file:', error);
    });
</code></pre>
<h5 data-id="heading-20">兼容性考虑</h5>
<p>如果需要支持较老的浏览器，可以添加 polyfill：</p>
<pre><code class="hljs language-plain" lang="plain">// 添加 fetch polyfill（如果需要）
import 'whatwg-fetch';

// 或者使用条件加载
if (!window.fetch) {
    // 加载 fetch polyfill
}
</code></pre>
<h5 data-id="heading-21">总结</h5>
<p>迁移到 fetch API 的好处：</p>
<ol>
<li>更现代的 API 设计</li>
<li>更好的错误处理机制</li>
<li>更灵活的数据处理能力</li>
<li>更好的性能和浏览器支持</li>
<li>更少的依赖，减少包大小</li>
<li>更好的 TypeScript 支持</li>
</ol>
<p>建议在新的项目中直接使用 fetch API，在现有项目中逐步将 JSZipUtils 的调用替换为 fetch API 的实现。</p>
<h4 data-id="heading-22">JSZipUtils和<code>jszip</code>的配合使用</h4>
<p>通常在实际应用中，这两个库会配合使用：</p>
<pre><code class="hljs language-plain" lang="plain">// 下载远程文件并创建新的 ZIP 包
JSZipUtils.getBinaryContent("path/to/image.jpg", function(err, data) {
    if(err) throw err;
    
    var zip = new JSZip();
    zip.file("image.jpg", data, {binary: true});
    
    zip.generateAsync({type:"blob"})
    .then(function(content) {
        saveAs(content, "new.zip");
    });
});
</code></pre>
<h5 data-id="heading-23">注意事项</h5>
<ol>
<li>在浏览器中使用时，如果处理大文件，要注意内存使用情况</li>
<li>处理远程文件时要注意跨域问题</li>
<li>JSZipUtils 已经被标记为废弃，推荐使用原生的 fetch API 替代</li>
<li>现代项目中，也可以考虑使用更新的替代方案，如 JSZip 的最新版本配合 fetch API</li>
</ol>
<p>这两个库在前端处理文件压缩和解压缩任务时非常实用，特别是在需要动态处理文件内容的场景中。</p>
<h3 data-id="heading-24"/>
<h3 data-id="heading-25">vue3之中预览<code>ofd.js</code>文件</h3>
<p>接下来我们就简单实现一下<code>ofd.js</code>文件的预览，我们的想法是在vue3之中替代掉老旧的JSZipUtils库，当然，和之前一样我们还是以实现功能然后进行优化为主</p>
<p>因为ofd文件的本质上是一种压缩包，所以我们需要先解压 OFD 文件，然后解析其中的内容。</p>
<p>先来看看标准的ofd文件是什么样子的</p>
<pre><code class="hljs language-javascript" lang="javascript">{
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"OFD.xml"</span>,
    <span class="hljs-string">"dir"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-string">"date"</span>: <span class="hljs-string">"2020-08-22T16:21:20.000Z"</span>,
    <span class="hljs-string">"comment"</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-string">"unixPermissions"</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-string">"dosPermissions"</span>: <span class="hljs-number">32</span>,
    <span class="hljs-string">"_data"</span>: {
        <span class="hljs-string">"compressedSize"</span>: <span class="hljs-number">446</span>,
        <span class="hljs-string">"uncompressedSize"</span>: <span class="hljs-number">1269</span>,
        <span class="hljs-string">"crc32"</span>: -<span class="hljs-number">2125441896</span>,
        <span class="hljs-string">"compression"</span>: {
            <span class="hljs-string">"magic"</span>: <span class="hljs-string">"\b\u0000"</span>
        },
        <span class="hljs-string">"compressedContent"</span>: {
            <span class="hljs-string">"0"</span>: <span class="hljs-number">157</span>,
            <span class="hljs-string">"1"</span>: <span class="hljs-number">84</span>,
            <span class="hljs-string">"2"</span>: <span class="hljs-number">209</span>,
            <span class="hljs-string">"3"</span>: <span class="hljs-number">110</span>,
             xxx
        }
    },
    <span class="hljs-string">"_dataBinary"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"options"</span>: {
        <span class="hljs-string">"compression"</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-string">"compressionOptions"</span>: <span class="hljs-literal">null</span>
    },
    <span class="hljs-string">"unsafeOriginalName"</span>: <span class="hljs-string">"OFD.xml"</span>
}
</code></pre>
<h4 data-id="heading-26">方式1-使用easyofd的方式预览</h4>
<p>推荐的预览方式</p>
<h5 data-id="heading-27">安装相关依赖</h5>
<pre><code class="hljs language-javascript" lang="javascript">pnpm i jszip x2js jb2 opentype.<span class="hljs-property">js</span> easyofd
</code></pre>
<h5 data-id="heading-28">预览文件</h5>
<pre><code class="hljs language-javascript" lang="javascript">&lt;script setup&gt;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">EasyOFD</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"easyofd"</span>;
<span class="hljs-keyword">import</span> { onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">let</span> yourElement=<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"1111111"</span>);
  <span class="hljs-keyword">let</span> ofd=<span class="hljs-keyword">new</span> <span class="hljs-title class_">EasyOFD</span>(<span class="hljs-string">'myofdID'</span>, yourElement);
})

&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"1111111"</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> &gt;</span><span class="css">
 <span class="hljs-selector-class">.OfdButton</span>{
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#007bff</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
      <span class="hljs-attribute">border</span>: none;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;
      <span class="hljs-attribute">cursor</span>: pointer;
      <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">10px</span>;
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-29">方式2-使用ofd的方式预览</h4>
<pre><code class="hljs language-javascript" lang="javascript">相关源码地址
<span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/DLTech21/ofd.js</span>
</code></pre>
<h5 data-id="heading-30">安装依赖</h5>
<p>这里我们先安装必须的依赖，后面剔除</p>
<pre><code class="hljs language-javascript" lang="javascript">pnpm install jszip
pnpm install jszip-utils（后面剔除）
pnpm i @lapo/asn1js
pnpm i js-sha1
pnpm i ofd-xml-parser js-md5 jsrsasign jsrsasign-util sm-crypto
</code></pre>
<p>安装成功以后我们首要的就是将ofd之前的版本兼容到vue3</p>
<p>这里需要我们<code>main.TS</code>之中设置一下全局</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 设置全局变量</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span>) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">global</span> = <span class="hljs-variable language_">window</span>;
}
</code></pre>
<h5 data-id="heading-31">文件之中使用</h5>
<pre><code class="hljs language-javascript" lang="javascript">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-container</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:100vw; height: 100vh;"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-header</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"background:#F5F5F5;display: flex; height: 40px; border: 1px solid #e8e8e8; align-items: center;"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"uploadFile"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-icon"</span>&gt;</span>打开OFD<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">font-awesome-icon</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">"cloud-upload-alt"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"fileRef"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">".ofd"</span> @<span class="hljs-attr">change</span>=<span class="hljs-string">"fileChanged"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"uploadPdfFile"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-icon"</span>&gt;</span>PDF2OFD<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">font-awesome-icon</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">"cloud-upload-alt"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"pdfFileRef"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">".pdf"</span> @<span class="hljs-attr">change</span>=<span class="hljs-string">"pdfFileChanged"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"display: flex;align-items: center"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"ofdObj"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-icon"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-left: 10px"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"downPdf"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"ofdBase64"</span>&gt;</span>
          下载PDF
          <span class="hljs-tag">&lt;<span class="hljs-name">font-awesome-icon</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">"download"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"scale-icon"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-left: 10px"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"plus"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">font-awesome-icon</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">"search-plus"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"scale-icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"minus"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">font-awesome-icon</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">"search-minus"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"scale-icon"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">font-awesome-icon</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">"step-backward"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"firstPage"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"scale-icon"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 18px"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"prePage"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">font-awesome-icon</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">"caret-left"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"scale-icon"</span>&gt;</span>
          {{pageIndex}}/{{pageCount}}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"scale-icon"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 18px"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"nextPage"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">font-awesome-icon</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">"caret-right"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"scale-icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"lastPage"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">font-awesome-icon</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">"step-forward"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-header</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">el-main</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: auto;background: #808080;;padding: 0"</span> <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"loading"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"leftMenu"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"left-section"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"demo(1)"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>电子发票<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"demo(2)"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>电子公文<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"demo(3)"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>骑缝章<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-icon"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"demo(4)"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>多页文档<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-section"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"content"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"contentDivRef"</span> @<span class="hljs-attr">mousewheel</span>=<span class="hljs-string">"scrool"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-main</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"SealContainer"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sealInfoDiv"</span> <span class="hljs-attr">hidden</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"sealInfoDivRef"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"SealContainer mask"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"closeSealInfoDialog"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"SealContainer-layout"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"SealContainer-content"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content-title"</span>&gt;</span>签章信息<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subcontent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>签章人<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"spSigner"</span>&gt;</span>[无效的签章结构]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subcontent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>签章提供者<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"spProvider"</span>&gt;</span>[无效的签章结构]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subcontent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>原文摘要值<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"spHashedValue"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"showMore('原文摘要值', 'spHashedValue')"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"cursor: pointer"</span>&gt;</span>[无效的签章结构]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subcontent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>签名值<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"spSignedValue"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"showMore('签名值', 'spSignedValue')"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"cursor: pointer"</span>&gt;</span>[无效的签章结构]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subcontent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>签名算法<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"spSignMethod"</span>&gt;</span>[无效的签章结构]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subcontent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>版本号<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"spVersion"</span>&gt;</span>[无效的签章结构]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subcontent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>验签结果<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"VerifyRet"</span>&gt;</span>[无效的签章结构]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content-title"</span>&gt;</span>印章信息<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subcontent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>印章标识<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"spSealID"</span>&gt;</span>[无效的签章结构]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subcontent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>印章名称<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"spSealName"</span>&gt;</span>[无效的签章结构]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subcontent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>印章类型<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"spSealType"</span>&gt;</span>[无效的签章结构]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subcontent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>有效时间<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"spSealAuthTime"</span>&gt;</span>[无效的签章结构]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subcontent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>制章日期<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"spSealMakeTime"</span>&gt;</span>[无效的签章结构]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subcontent"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span>印章版本<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"value"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"spSealVersion"</span>&gt;</span>[无效的签章结构]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"position:absolute;right:1%;top:1%;"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">""</span> <span class="hljs-attr">id</span>=<span class="hljs-string">""</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"X"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"closeSealInfoDialog()"</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span> <span class="hljs-attr">:title</span>=<span class="hljs-string">"dialogTitle"</span> <span class="hljs-attr">:visible.sync</span>=<span class="hljs-string">"dialogVisible"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"text-align: left"</span>&gt;</span>{{dialogValue}}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">slot</span>=<span class="hljs-string">"footer"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dialog-footer"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"dialogVisible = false"</span>&gt;</span>确 定<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-container</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onMounted, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { parseOfdDocument, renderOfd, renderOfdByScale, digestCheck, getPageScale, setPageScale } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils/ofd/ofd.js"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">JSZipUtils</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"jszip-utils"</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessage</span>, <span class="hljs-title class_">ElMessageBox</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>
<span class="hljs-comment">// 响应式数据</span>
<span class="hljs-keyword">const</span> fileRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
<span class="hljs-keyword">const</span> pdfFileRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
<span class="hljs-keyword">const</span> contentDivRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
<span class="hljs-keyword">const</span> sealInfoDivRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

<span class="hljs-keyword">const</span> state = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">pdfFile</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">ofdBase64</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">pageIndex</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">pageCount</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">scale</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">dialogTitle</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">dialogValue</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">dialogVisible</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">ofdObj</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">screenWidth</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">clientWidth</span>
})

<span class="hljs-comment">// 方法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">uploadFile</span> = (<span class="hljs-params"/>) =&gt; {
  state.<span class="hljs-property">pdfFile</span> = <span class="hljs-literal">null</span>
  fileRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">click</span>()
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">fileChanged</span> = (<span class="hljs-params">e</span>) =&gt; {
  <span class="hljs-keyword">const</span> file = e.<span class="hljs-property">target</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">const</span> ext = file.<span class="hljs-property">name</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/.+\./</span>, <span class="hljs-string">""</span>)
  
  <span class="hljs-keyword">if</span> ([<span class="hljs-string">"ofd"</span>].<span class="hljs-title function_">indexOf</span>(ext) === -<span class="hljs-number">1</span>) {
    <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">alert</span>(<span class="hljs-string">'仅支持ofd类型'</span>, <span class="hljs-string">'error'</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">'确定'</span>,
      <span class="hljs-attr">callback</span>: <span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> {
        <span class="hljs-title class_">ElMessage</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'info'</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`action: <span class="hljs-subst">${action}</span>`</span>
        })
      }
    })
    <span class="hljs-keyword">return</span>
  }
  
  <span class="hljs-keyword">if</span> (file.<span class="hljs-property">size</span> &gt; <span class="hljs-number">100</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) {
    <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">alert</span>(<span class="hljs-string">'文件大小需 &lt; 100M'</span>, <span class="hljs-string">'error'</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">'确定'</span>,
      <span class="hljs-attr">callback</span>: <span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> {
        <span class="hljs-title class_">ElMessage</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'info'</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`action: <span class="hljs-subst">${action}</span>`</span>
        })
      }
    })
    <span class="hljs-keyword">return</span>
  }
  
  <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>()
  reader.<span class="hljs-title function_">readAsDataURL</span>(file)
  reader.<span class="hljs-property">onload</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    state.<span class="hljs-property">ofdBase64</span> = e.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>)[<span class="hljs-number">1</span>]
  }
  
  <span class="hljs-title function_">getOfdDocumentObj</span>(file, state.<span class="hljs-property">screenWidth</span>)
  fileRef.<span class="hljs-property">value</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">uploadPdfFile</span> = (<span class="hljs-params"/>) =&gt; {
  state.<span class="hljs-property">pdfFile</span> = <span class="hljs-literal">null</span>
  pdfFileRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">click</span>()
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">pdfFileChanged</span> = (<span class="hljs-params">e</span>) =&gt; {
  <span class="hljs-keyword">const</span> file = e.<span class="hljs-property">target</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">const</span> ext = file.<span class="hljs-property">name</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/.+\./</span>, <span class="hljs-string">""</span>)
  
  <span class="hljs-keyword">if</span> ([<span class="hljs-string">"pdf"</span>].<span class="hljs-title function_">indexOf</span>(ext) === -<span class="hljs-number">1</span>) {
    <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">alert</span>(<span class="hljs-string">'仅支持pdf类型'</span>, <span class="hljs-string">'error'</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">'确定'</span>,
      <span class="hljs-attr">callback</span>: <span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> {
        <span class="hljs-title class_">ElMessage</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'info'</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`action: <span class="hljs-subst">${action}</span>`</span>
        })
      }
    })
    <span class="hljs-keyword">return</span>
  }
  
  <span class="hljs-keyword">if</span> (file.<span class="hljs-property">size</span> &gt; <span class="hljs-number">100</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) {
    <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">alert</span>(<span class="hljs-string">'文件大小需 &lt; 100M'</span>, <span class="hljs-string">'error'</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">'确定'</span>,
      <span class="hljs-attr">callback</span>: <span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> {
        <span class="hljs-title class_">ElMessage</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'info'</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`action: <span class="hljs-subst">${action}</span>`</span>
        })
      }
    })
    <span class="hljs-keyword">return</span>
  }
  
  <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>()
  reader.<span class="hljs-title function_">readAsDataURL</span>(file)
  reader.<span class="hljs-property">onload</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> pdfBase64 = e.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>)[<span class="hljs-number">1</span>]
    <span class="hljs-title function_">downOfd</span>(pdfBase64)
  }
  
  pdfFileRef.<span class="hljs-property">value</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">downOfd</span> = (<span class="hljs-params">pdfBase64</span>) =&gt; {
  state.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
  <span class="hljs-title function_">axios</span>({
    <span class="hljs-attr">method</span>: <span class="hljs-string">"post"</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">"https://51shouzu.xyz/api/ofd/convertOfd"</span>,
    <span class="hljs-attr">data</span>: {
      pdfBase64,
    }
  }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    state.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">const</span> binary = <span class="hljs-title function_">atob</span>(response.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\s/g</span>, <span class="hljs-string">''</span>))
    <span class="hljs-keyword">const</span> len = binary.<span class="hljs-property">length</span>
    <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(len)
    <span class="hljs-keyword">const</span> view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
      view[i] = binary.<span class="hljs-title function_">charCodeAt</span>(i)
    }
    <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([view], <span class="hljs-literal">null</span>)
    <span class="hljs-keyword">const</span> url = <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">createObjectURL</span>(blob)
    <span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'a'</span>)
    link.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>
    link.<span class="hljs-property">href</span> = url
    link.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'download'</span>, <span class="hljs-string">'ofd.ofd'</span>)
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(link)
    link.<span class="hljs-title function_">click</span>()
  }).<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error, <span class="hljs-string">"error"</span>)
    <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">alert</span>(<span class="hljs-string">'PDF打开失败'</span>, error, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">'确定'</span>,
      <span class="hljs-attr">callback</span>: <span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> {
        <span class="hljs-title class_">ElMessage</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'info'</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`action: <span class="hljs-subst">${action}</span>`</span>
        })
      }
    })
  })
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">downPdf</span> = (<span class="hljs-params"/>) =&gt; {
  state.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
  <span class="hljs-title function_">axios</span>({
    <span class="hljs-attr">method</span>: <span class="hljs-string">"post"</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">"https://51shouzu.xyz/api/ofd/convertPdf"</span>,
    <span class="hljs-attr">data</span>: {
      <span class="hljs-attr">ofdBase64</span>: state.<span class="hljs-property">ofdBase64</span>
    }
  }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    state.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">const</span> binary = <span class="hljs-title function_">atob</span>(response.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\s/g</span>, <span class="hljs-string">''</span>))
    <span class="hljs-keyword">const</span> len = binary.<span class="hljs-property">length</span>
    <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(len)
    <span class="hljs-keyword">const</span> view = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
      view[i] = binary.<span class="hljs-title function_">charCodeAt</span>(i)
    }
    <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([view], { <span class="hljs-attr">type</span>: <span class="hljs-string">"application/pdf"</span> })
    <span class="hljs-keyword">const</span> url = <span class="hljs-variable constant_">URL</span>.<span class="hljs-title function_">createObjectURL</span>(blob)
    <span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'a'</span>)
    link.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>
    link.<span class="hljs-property">href</span> = url
    link.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'download'</span>, <span class="hljs-string">'ofd.pdf'</span>)
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(link)
    link.<span class="hljs-title function_">click</span>()
  }).<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error, <span class="hljs-string">"error"</span>)
    <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">alert</span>(<span class="hljs-string">'OFD打开失败'</span>, error, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">'确定'</span>,
      <span class="hljs-attr">callback</span>: <span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> {
        <span class="hljs-title class_">ElMessage</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'info'</span>,
          <span class="hljs-attr">message</span>: <span class="hljs-string">`action: <span class="hljs-subst">${action}</span>`</span>
        })
      }
    })
  })
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">plus</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setPageScale</span>(++state.<span class="hljs-property">scale</span>)
  <span class="hljs-keyword">const</span> divs = <span class="hljs-title function_">renderOfdByScale</span>(state.<span class="hljs-property">ofdObj</span>)
  <span class="hljs-title function_">displayOfdDiv</span>(divs)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">minus</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">setPageScale</span>(--state.<span class="hljs-property">scale</span>)
  <span class="hljs-keyword">const</span> divs = <span class="hljs-title function_">renderOfdByScale</span>(state.<span class="hljs-property">ofdObj</span>)
  <span class="hljs-title function_">displayOfdDiv</span>(divs)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">prePage</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> contentDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'content'</span>)
  <span class="hljs-keyword">const</span> ele = contentDiv.<span class="hljs-property">children</span>.<span class="hljs-title function_">item</span>(state.<span class="hljs-property">pageIndex</span> - <span class="hljs-number">2</span>)
  ele?.<span class="hljs-title function_">scrollIntoView</span>(<span class="hljs-literal">true</span>)
  <span class="hljs-keyword">if</span> (ele) state.<span class="hljs-property">pageIndex</span> = state.<span class="hljs-property">pageIndex</span> - <span class="hljs-number">1</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">firstPage</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> contentDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'content'</span>)
  <span class="hljs-keyword">const</span> ele = contentDiv.<span class="hljs-property">firstElementChild</span>
  ele?.<span class="hljs-title function_">scrollIntoView</span>(<span class="hljs-literal">true</span>)
  <span class="hljs-keyword">if</span> (ele) state.<span class="hljs-property">pageIndex</span> = <span class="hljs-number">1</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">nextPage</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> contentDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'content'</span>)
  <span class="hljs-keyword">const</span> ele = contentDiv.<span class="hljs-property">children</span>.<span class="hljs-title function_">item</span>(state.<span class="hljs-property">pageIndex</span>)
  ele?.<span class="hljs-title function_">scrollIntoView</span>(<span class="hljs-literal">true</span>)
  <span class="hljs-keyword">if</span> (ele) ++state.<span class="hljs-property">pageIndex</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">lastPage</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> contentDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'content'</span>)
  <span class="hljs-keyword">const</span> ele = contentDiv.<span class="hljs-property">lastElementChild</span>
  ele?.<span class="hljs-title function_">scrollIntoView</span>(<span class="hljs-literal">true</span>)
  <span class="hljs-keyword">if</span> (ele) state.<span class="hljs-property">pageIndex</span> = contentDiv.<span class="hljs-property">childElementCount</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">demo</span> = (<span class="hljs-params">value</span>) =&gt; {
  <span class="hljs-keyword">let</span> ofdFile = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">switch</span> (value) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
      ofdFile = <span class="hljs-string">'999.ofd'</span>
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
      ofdFile = <span class="hljs-string">'n.ofd'</span>
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
      ofdFile = <span class="hljs-string">'h.ofd'</span>
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:
      ofdFile = <span class="hljs-string">'2.ofd'</span>
      <span class="hljs-keyword">break</span>
  }
  <span class="hljs-title class_">JSZipUtils</span>.<span class="hljs-title function_">getBinaryContent</span>(ofdFile, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"JSZipUtils===1"</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">const</span> base64String = <span class="hljs-title function_">btoa</span>(<span class="hljs-title class_">String</span>.<span class="hljs-property">fromCharCode</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(data)))
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"JSZipUtils===2"</span>);
      state.<span class="hljs-property">ofdBase64</span> = base64String
    }
  })
  <span class="hljs-title function_">getOfdDocumentObj</span>(ofdFile, state.<span class="hljs-property">screenWidth</span>)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getOfdDocumentObj</span> = (<span class="hljs-params">file, screenWidth</span>) =&gt; {
  <span class="hljs-keyword">const</span> t = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>()
  state.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
  
  <span class="hljs-title function_">parseOfdDocument</span>({
    <span class="hljs-attr">ofd</span>: file,
    <span class="hljs-title function_">success</span>(<span class="hljs-params">res</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)
      <span class="hljs-keyword">const</span> t1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>()
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'解析ofd'</span>, t1 - t)
      state.<span class="hljs-property">ofdObj</span> = res[<span class="hljs-number">0</span>]
      state.<span class="hljs-property">pageCount</span> = res[<span class="hljs-number">0</span>].<span class="hljs-property">pages</span>.<span class="hljs-property">length</span>
      <span class="hljs-keyword">const</span> divs = <span class="hljs-title function_">renderOfd</span>(screenWidth, res[<span class="hljs-number">0</span>])
      <span class="hljs-keyword">const</span> t2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>()
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'xml转svg'</span>, t2 - t1)
      <span class="hljs-title function_">displayOfdDiv</span>(divs)
      <span class="hljs-keyword">const</span> t3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>()
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'svg渲染到页面'</span>, t3 - t2)
      state.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
    },
    <span class="hljs-title function_">fail</span>(<span class="hljs-params">error</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)
      state.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
      <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">alert</span>(<span class="hljs-string">'OFD打开失败'</span>, error, {
        <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">'确定'</span>,
        <span class="hljs-attr">callback</span>: <span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> {
          <span class="hljs-title class_">ElMessage</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'info'</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">`action: <span class="hljs-subst">${action}</span>`</span>
          })
        }
      })
    }
  })
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">displayOfdDiv</span> = (<span class="hljs-params">divs</span>) =&gt; {
  state.<span class="hljs-property">scale</span> = <span class="hljs-title function_">getPageScale</span>()
  <span class="hljs-keyword">const</span> contentDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'content'</span>)
  contentDiv.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> div <span class="hljs-keyword">of</span> divs) {
    contentDiv.<span class="hljs-title function_">appendChild</span>(div)
  }
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> ele <span class="hljs-keyword">of</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">'seal_img_div'</span>)) {
    <span class="hljs-title function_">addEventOnSealDiv</span>(ele, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(ele.<span class="hljs-property">dataset</span>.<span class="hljs-property">sesSignature</span>), <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(ele.<span class="hljs-property">dataset</span>.<span class="hljs-property">signedInfo</span>))
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">addEventOnSealDiv</span> = (<span class="hljs-params">div, SES_Signature, signedInfo</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-variable language_">global</span>.<span class="hljs-property">HashRet</span> = <span class="hljs-literal">null</span>
    <span class="hljs-variable language_">global</span>.<span class="hljs-property">VerifyRet</span> = signedInfo.<span class="hljs-property">VerifyRet</span>
    
    div.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sealInfoDiv'</span>).<span class="hljs-property">hidden</span> = <span class="hljs-literal">false</span>
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'sealInfoDiv'</span>).<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'style'</span>, <span class="hljs-string">'display:flex;align-items: center;justify-content: center;'</span>)
      
      <span class="hljs-keyword">if</span> (SES_Signature.<span class="hljs-property">realVersion</span> &lt; <span class="hljs-number">4</span>) {
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSigner'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">cert</span>[<span class="hljs-string">'commonName'</span>]
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spProvider'</span>).<span class="hljs-property">innerText</span> = signedInfo.<span class="hljs-property">Provider</span>[<span class="hljs-string">'@_ProviderName'</span>]
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spHashedValue'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">dataHash</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">''</span>)
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSignedValue'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">signature</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">''</span>)
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSignMethod'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">signatureAlgorithm</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">''</span>)
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealID'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">esID</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealName'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">property</span>.<span class="hljs-property">name</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealType'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">property</span>.<span class="hljs-property">type</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealAuthTime'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"从 "</span> + SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">property</span>.<span class="hljs-property">validStart</span> + <span class="hljs-string">" 到 "</span> + SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">property</span>.<span class="hljs-property">validEnd</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealMakeTime'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">property</span>.<span class="hljs-property">createDate</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealVersion'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">header</span>.<span class="hljs-property">version</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSigner'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">cert</span>[<span class="hljs-string">'commonName'</span>]
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spProvider'</span>).<span class="hljs-property">innerText</span> = signedInfo.<span class="hljs-property">Provider</span>[<span class="hljs-string">'@_ProviderName'</span>]
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spHashedValue'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">dataHash</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">''</span>)
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSignedValue'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">signature</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">''</span>)
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSignMethod'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">signatureAlgID</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">''</span>)
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealID'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">esID</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealName'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">property</span>.<span class="hljs-property">name</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealType'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">property</span>.<span class="hljs-property">type</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealAuthTime'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"从 "</span> + SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">property</span>.<span class="hljs-property">validStart</span> + <span class="hljs-string">" 到 "</span> + SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">property</span>.<span class="hljs-property">validEnd</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealMakeTime'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">property</span>.<span class="hljs-property">createDate</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealVersion'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">eseal</span>.<span class="hljs-property">esealInfo</span>.<span class="hljs-property">header</span>.<span class="hljs-property">version</span>
      }
      
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spVersion'</span>).<span class="hljs-property">innerText</span> = SES_Signature.<span class="hljs-property">toSign</span>.<span class="hljs-property">version</span>
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'VerifyRet'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"文件摘要值后台验证中，请稍等... "</span> + (<span class="hljs-variable language_">global</span>.<span class="hljs-property">VerifyRet</span> ? <span class="hljs-string">"签名值验证成功"</span> : <span class="hljs-string">"签名值验证失败"</span>)
      
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">global</span>.<span class="hljs-property">HashRet</span> == <span class="hljs-literal">null</span> || <span class="hljs-variable language_">global</span>.<span class="hljs-property">HashRet</span> == <span class="hljs-literal">undefined</span> || <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">global</span>.<span class="hljs-property">HashRet</span>).<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">const</span> signRetStr = <span class="hljs-variable language_">global</span>.<span class="hljs-property">VerifyRet</span> ? <span class="hljs-string">"签名值验证成功"</span> : <span class="hljs-string">"签名值验证失败"</span>
          <span class="hljs-variable language_">global</span>.<span class="hljs-property">HashRet</span> = <span class="hljs-title function_">digestCheck</span>(<span class="hljs-variable language_">global</span>.<span class="hljs-property">toBeChecked</span>.<span class="hljs-title function_">get</span>(signedInfo.<span class="hljs-property">signatureID</span>))
          <span class="hljs-keyword">const</span> hashRetStr = <span class="hljs-variable language_">global</span>.<span class="hljs-property">HashRet</span> ? <span class="hljs-string">"文件摘要值验证成功"</span> : <span class="hljs-string">"文件摘要值验证失败"</span>
          <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'VerifyRet'</span>).<span class="hljs-property">innerText</span> = hashRetStr + <span class="hljs-string">" "</span> + signRetStr
        }, <span class="hljs-number">1000</span>)
      }
    })
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e)
  }
  
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">global</span>.<span class="hljs-property">VerifyRet</span>) {
    div.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'class'</span>, <span class="hljs-string">'gray'</span>)
  }
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">closeSealInfoDialog</span> = (<span class="hljs-params"/>) =&gt; {
  sealInfoDivRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'style'</span>, <span class="hljs-string">'display: none'</span>)
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSigner'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"[无效的签章结构]"</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spProvider'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"[无效的签章结构]"</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spHashedValue'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"[无效的签章结构]"</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSignedValue'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"[无效的签章结构]"</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSignMethod'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"[无效的签章结构]"</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealID'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"[无效的签章结构]"</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealName'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"[无效的签章结构]"</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealType'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"[无效的签章结构]"</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealAuthTime'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"[无效的签章结构]"</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealMakeTime'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"[无效的签章结构]"</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spSealVersion'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"[无效的签章结构]"</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'spVersion'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"[无效的签章结构]"</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'VerifyRet'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">"[无效的签章结构]"</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">showMore</span> = (<span class="hljs-params">title, id</span>) =&gt; {
  state.<span class="hljs-property">dialogVisible</span> = <span class="hljs-literal">true</span>
  state.<span class="hljs-property">dialogValue</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(id).<span class="hljs-property">innerText</span>
  state.<span class="hljs-property">dialogTitle</span> = title
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">scrool</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> scrolled = contentDivRef.<span class="hljs-property">value</span>.<span class="hljs-property">firstElementChild</span>?.<span class="hljs-title function_">getBoundingClientRect</span>()?.<span class="hljs-property">top</span> - <span class="hljs-number">60</span>
  <span class="hljs-keyword">let</span> top = <span class="hljs-number">0</span>
  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; contentDivRef.<span class="hljs-property">value</span>.<span class="hljs-property">childElementCount</span>; i++) {
    top += (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(contentDivRef.<span class="hljs-property">value</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">item</span>(i)?.<span class="hljs-property">style</span>.<span class="hljs-property">height</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'px'</span>, <span class="hljs-string">''</span>)) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(contentDivRef.<span class="hljs-property">value</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">item</span>(i)?.<span class="hljs-property">style</span>.<span class="hljs-property">marginBottom</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'px'</span>, <span class="hljs-string">''</span>)))
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(scrolled) &lt; top) {
      index = i
      <span class="hljs-keyword">break</span>
    }
  }
  
  state.<span class="hljs-property">pageIndex</span> = index + <span class="hljs-number">1</span>
}

<span class="hljs-comment">// 生命周期钩子</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  state.<span class="hljs-property">screenWidth</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">clientWidth</span> - <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'leftMenu'</span>).<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">width</span>
  
  contentDivRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, scrool)
  
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">onresize</span> = <span class="hljs-function">() =&gt;</span> {
    state.<span class="hljs-property">screenWidth</span> = (<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">clientWidth</span> - <span class="hljs-number">88</span>)
    <span class="hljs-keyword">const</span> divs = <span class="hljs-title function_">renderOfd</span>(state.<span class="hljs-property">screenWidth</span>, state.<span class="hljs-property">ofdObj</span>)
    <span class="hljs-title function_">displayOfdDiv</span>(divs)
  }
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 保持原有的样式不变 */</span>
<span class="hljs-selector-class">.upload-icon</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">cursor</span>: pointer;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">28px</span>;
  <span class="hljs-attribute">padding-left</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">padding-right</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">59</span>, <span class="hljs-number">95</span>, <span class="hljs-number">232</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">1px</span>;
  <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#5867dd</span>;
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">500</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">1px</span>;
}

<span class="hljs-selector-class">.scale-icon</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">cursor</span>: pointer;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">33px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">28px</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#F5F5F5</span>;;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">1px</span>;
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">500</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#333333</span>;
  <span class="hljs-attribute">text-align</span>: center;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">2px</span>;
}

<span class="hljs-selector-class">.scale-icon</span> <span class="hljs-selector-pseudo">:active</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">59</span>, <span class="hljs-number">95</span>, <span class="hljs-number">232</span>);
}

<span class="hljs-selector-class">.scale-icon</span> <span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">59</span>, <span class="hljs-number">95</span>, <span class="hljs-number">232</span>);
}

<span class="hljs-selector-class">.text-icon</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">cursor</span>: pointer;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">28px</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">90%</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">59</span>, <span class="hljs-number">95</span>, <span class="hljs-number">232</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">1px</span>;
  <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#5867dd</span>;
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">500</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-selector-class">.hidden</span> {
  <span class="hljs-attribute">display</span>: none <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.SealContainer</span> {
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">99999</span>;
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100vw</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
}

<span class="hljs-selector-class">.SealContainer</span> <span class="hljs-selector-class">.mask</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#000000</span>;
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.3</span>;
}

<span class="hljs-selector-class">.content-title</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">text-align</span>: center;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">rgb</span>(<span class="hljs-number">59</span>, <span class="hljs-number">95</span>, <span class="hljs-number">232</span>);
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgb</span>(<span class="hljs-number">59</span>, <span class="hljs-number">95</span>, <span class="hljs-number">232</span>);
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">10px</span>;
}

<span class="hljs-selector-class">.SealContainer-content</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">overflow-y</span>: auto;
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">align-items</span>: center;
}

<span class="hljs-selector-class">.SealContainer-layout</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">60%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">80vh</span>;
  <span class="hljs-attribute">overflow-y</span>: auto;
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">100</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">align-items</span>: center;
}

<span class="hljs-selector-class">.subcontent</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">80%</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">text-align</span>: left;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">font-family</span>: simsun;
}

<span class="hljs-selector-class">.subcontent</span> <span class="hljs-selector-class">.title</span> {
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
}

<span class="hljs-selector-class">.subcontent</span> <span class="hljs-selector-class">.value</span> {
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">400</span>;
  -webkit-line-clamp: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">display</span>: -webkit-box;
  -webkit-box-orient: vertical;
  <span class="hljs-attribute">overflow</span>: hidden;
}

<span class="hljs-selector-class">.left-section</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">88px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>:<span class="hljs-number">#F5F5F5</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e8e8e8</span>;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column
}

<span class="hljs-selector-class">.main-section</span> {
  <span class="hljs-attribute">padding-top</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">margin-left</span>:<span class="hljs-number">88px</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#808080</span>;
  <span class="hljs-attribute">overflow</span>: hidden
}

<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">767px</span>) {
  <span class="hljs-selector-class">.SealContainer-layout</span> {
    <span class="hljs-attribute">position</span>: relative;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">90%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">90vh</span>;
    <span class="hljs-attribute">overflow-y</span>: auto;
    <span class="hljs-attribute">background</span>: white;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">100</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
    <span class="hljs-attribute">align-items</span>: center;
  }

  <span class="hljs-selector-class">.subcontent</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">95%</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">text-align</span>: left;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
    <span class="hljs-attribute">font-family</span>: simsun;
  }

  <span class="hljs-selector-class">.left-section</span> {
    <span class="hljs-attribute">position</span>: fixed;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">0px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">background</span>:<span class="hljs-number">#F5F5F5</span>;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e8e8e8</span>;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">display</span>: none;
    <span class="hljs-attribute">flex-direction</span>: column;
  }

  <span class="hljs-selector-class">.main-section</span> {
    <span class="hljs-attribute">padding-top</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">margin-left</span>:<span class="hljs-number">0px</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">justify-content</span>: center;
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#808080</span>;
    <span class="hljs-attribute">overflow</span>: hidden
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

</span></code></pre>
<h4 data-id="heading-32">方式3-<code>ofd.js</code>文件预览以及使用（废弃）</h4>
<p>查看了一下npm上已经需要付费了，所以我果断放弃了</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// npm地址</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//www.npmjs.com/package/ofd.js</span>

<span class="hljs-comment">// 安装</span>
pnpm install ofd.<span class="hljs-property">js</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Android 中执行 View.invalidate() 方法后经历了什么]]></title>    <link>https://juejin.cn/post/7592340733953818674</link>    <guid>https://juejin.cn/post/7592340733953818674</guid>    <pubDate>2026-01-07T07:34:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592340733953818674" data-draft-id="7592234632483602441" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Android 中执行 View.invalidate() 方法后经历了什么"/> <meta itemprop="keywords" content="Kotlin,Android,Java"/> <meta itemprop="datePublished" content="2026-01-07T07:34:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="愤怒的代码"/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Android 中执行 View.invalidate() 方法后经历了什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    愤怒的代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T07:34:46.000Z" title="Wed Jan 07 2026 07:34:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Android 中，<code>view.invalidate()</code> 是触发界面重绘的核心方法。它的调用链是一个从 <strong>子 View 向上溯源至 ViewRootImpl，再向下派发绘制信号</strong> 的过程。</p>
<h2 data-id="heading-0">0x00、<code>View.invalidate()</code></h2>
<p>当调用 <code>invalidate()</code> 时，最终会进入 <code>invalidateInternal</code> 方法，并进行“脏区域”的标记。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * 这里注释可以看出，此方法会触发onDraw方法，且只能在UI线程执行，非UI线程使用postInvalidate()
     * Invalidate the whole view. If the view is visible,
     * {<span class="hljs-doctag">@link</span> #onDraw(android.graphics.Canvas)} will be called at some point in
     * the future.
     * &lt;p&gt;
     * This must be called from a UI thread. To call from a non-UI thread, call
     * {<span class="hljs-doctag">@link</span> #postInvalidate()}.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidate</span><span class="hljs-params">()</span> {
        invalidate(<span class="hljs-literal">true</span>);
    }
    
		<span class="hljs-meta">@UnsupportedAppUsage</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidate</span><span class="hljs-params">(<span class="hljs-type">boolean</span> invalidateCache)</span> {
        invalidateInternal(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, mRight - mLeft, mBottom - mTop, invalidateCache, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidateInternal</span><span class="hljs-params">(<span class="hljs-type">int</span> l, <span class="hljs-type">int</span> t, <span class="hljs-type">int</span> r, <span class="hljs-type">int</span> b, <span class="hljs-type">boolean</span> invalidateCache,
            <span class="hljs-type">boolean</span> fullInvalidate)</span> {
        <span class="hljs-comment">//...</span>
				<span class="hljs-comment">// 1. 如果 View 不可见或者正在执行动画，直接跳过返回</span>
        <span class="hljs-keyword">if</span> (skipInvalidate()) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// Reset content capture caches</span>
        mPrivateFlags4 &amp;= ~PFLAG4_CONTENT_CAPTURE_IMPORTANCE_MASK;
        mContentCaptureSessionCached = <span class="hljs-literal">false</span>;
				<span class="hljs-comment">// 2.1 设置“脏区域”，标记需要重绘制的区域</span>
        <span class="hljs-keyword">if</span> ((mPrivateFlags &amp; (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)) == (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)
                || (invalidateCache &amp;&amp; (mPrivateFlags &amp; PFLAG_DRAWING_CACHE_VALID) == PFLAG_DRAWING_CACHE_VALID)
                || (mPrivateFlags &amp; PFLAG_INVALIDATED) != PFLAG_INVALIDATED
                || (fullInvalidate &amp;&amp; isOpaque() != mLastIsOpaque)) {
            <span class="hljs-keyword">if</span> (fullInvalidate) {
                mLastIsOpaque = isOpaque();
                mPrivateFlags &amp;= ~PFLAG_DRAWN;
            }
						<span class="hljs-comment">// 2.2 标记该 View 的内容失效，需要重新绘制</span>
            mPrivateFlags |= PFLAG_DIRTY;

            <span class="hljs-keyword">if</span> (invalidateCache) {
                mPrivateFlags |= PFLAG_INVALIDATED;
                mPrivateFlags &amp;= ~PFLAG_DRAWING_CACHE_VALID;
            }

						<span class="hljs-comment">// 3. 将重绘请求向上传递给父容器</span>
            <span class="hljs-comment">// Propagate the damage rectangle to the parent view.</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">AttachInfo</span> <span class="hljs-variable">ai</span> <span class="hljs-operator">=</span> mAttachInfo;
            <span class="hljs-comment">// 获取到该View的父控件，即 ViewGroup</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">ViewParent</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> mParent;
            <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">null</span> &amp;&amp; ai != <span class="hljs-literal">null</span> &amp;&amp; l &lt; r &amp;&amp; t &lt; b) {
                <span class="hljs-keyword">final</span> <span class="hljs-type">Rect</span> <span class="hljs-variable">damage</span> <span class="hljs-operator">=</span> ai.mTmpInvalRect;
                <span class="hljs-comment">// 3.1 设置失效的矩形区域</span>
                damage.set(l, t, r, b);
                <span class="hljs-comment">// 3.2 调用父控件的 invalidateChild</span>
                p.invalidateChild(<span class="hljs-built_in">this</span>, damage);
            }

            <span class="hljs-comment">//...</span>
        }
    }

</code></pre>
<h2 data-id="heading-1">0x01、<code>ViewGroup.invalidateChild()</code></h2>
<p><code>ViewGroup</code> 作为父容器，负责计算子 View 在父容器坐标系下的失效区域，并继续往上传递。</p>
<p>这里分别有两条绘制路径：<strong>硬件绘制路径和软件绘制路径</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidateChild</span><span class="hljs-params">(View child, <span class="hljs-keyword">final</span> Rect dirty)</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">AttachInfo</span> <span class="hljs-variable">attachInfo</span> <span class="hljs-operator">=</span> mAttachInfo;
        <span class="hljs-comment">// 1.**硬件绘制路径，**目前的主流Android版本应该是默认开启硬件加速的</span>
        <span class="hljs-keyword">if</span> (attachInfo != <span class="hljs-literal">null</span> &amp;&amp; attachInfo.mHardwareAccelerated) {
            <span class="hljs-comment">// HW accelerated fast path</span>
            <span class="hljs-comment">// 硬件加速通道，这里会执行后返回，不再使用软件绘制，这个也是View性能优化的关键</span>
            onDescendantInvalidated(child, child);
            <span class="hljs-keyword">return</span>;
        }
        
				<span class="hljs-comment">// 2.**软件绘制路径，**使用软件计算哪块区域是需要重新绘制的</span>
        <span class="hljs-type">ViewParent</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>;
        <span class="hljs-keyword">if</span> (attachInfo != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// If the child is drawing an animation, we want to copy this flag onto</span>
            <span class="hljs-comment">// ourselves and the parent to make sure the invalidate request goes</span>
            <span class="hljs-comment">// through</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">drawAnimation</span> <span class="hljs-operator">=</span> (child.mPrivateFlags &amp; PFLAG_DRAW_ANIMATION) != <span class="hljs-number">0</span>;

            <span class="hljs-comment">// Check whether the child that requests the invalidate is fully opaque</span>
            <span class="hljs-comment">// Views being animated or transformed are not considered opaque because we may</span>
            <span class="hljs-comment">// be invalidating their old position and need the parent to paint behind them.</span>
            <span class="hljs-type">Matrix</span> <span class="hljs-variable">childMatrix</span> <span class="hljs-operator">=</span> child.getMatrix();
            <span class="hljs-comment">// Mark the child as dirty, using the appropriate flag</span>
            <span class="hljs-comment">// Make sure we do not set both flags at the same time</span>

            <span class="hljs-keyword">if</span> (child.mLayerType != LAYER_TYPE_NONE) {
                mPrivateFlags |= PFLAG_INVALIDATED;
                mPrivateFlags &amp;= ~PFLAG_DRAWING_CACHE_VALID;
            }

            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] location = attachInfo.mInvalidateChildLocation;
            <span class="hljs-comment">// 获取子 View 的位置</span>
            location[CHILD_LEFT_INDEX] = child.mLeft;
            location[CHILD_TOP_INDEX] = child.mTop;
            <span class="hljs-comment">// 如果 View 有旋转、缩放等变换（Matrix）</span>
            <span class="hljs-keyword">if</span> (!childMatrix.isIdentity() ||
                    (mGroupFlags &amp; ViewGroup.FLAG_SUPPORT_STATIC_TRANSFORMATIONS) != <span class="hljs-number">0</span>) {
                <span class="hljs-type">RectF</span> <span class="hljs-variable">boundingRect</span> <span class="hljs-operator">=</span> attachInfo.mTmpTransformRect;
                boundingRect.set(dirty);
                Matrix transformMatrix;
                <span class="hljs-keyword">if</span> ((mGroupFlags &amp; ViewGroup.FLAG_SUPPORT_STATIC_TRANSFORMATIONS) != <span class="hljs-number">0</span>) {
                    <span class="hljs-type">Transformation</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> attachInfo.mTmpTransformation;
                    <span class="hljs-type">boolean</span> <span class="hljs-variable">transformed</span> <span class="hljs-operator">=</span> getChildStaticTransformation(child, t);
                    <span class="hljs-keyword">if</span> (transformed) {
                        transformMatrix = attachInfo.mTmpMatrix;
                        transformMatrix.set(t.getMatrix());
                        <span class="hljs-keyword">if</span> (!childMatrix.isIdentity()) {
                            transformMatrix.preConcat(childMatrix);
                        }
                    } <span class="hljs-keyword">else</span> {
                        transformMatrix = childMatrix;
                    }
                } <span class="hljs-keyword">else</span> {
                    transformMatrix = childMatrix;
                }
                <span class="hljs-comment">// 将 dirty 矩形按矩阵进行变换映射</span>
                transformMatrix.mapRect(boundingRect);
                <span class="hljs-comment">// 重新计算变换后的矩形边界</span>
                dirty.set((<span class="hljs-type">int</span>) Math.floor(boundingRect.left),
                        (<span class="hljs-type">int</span>) Math.floor(boundingRect.top),
                        (<span class="hljs-type">int</span>) Math.ceil(boundingRect.right),
                        (<span class="hljs-type">int</span>) Math.ceil(boundingRect.bottom));
            }
						<span class="hljs-comment">// 核心循环：向上冒泡</span>
            <span class="hljs-keyword">do</span> {
                <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">if</span> (parent <span class="hljs-keyword">instanceof</span> View) {
                    view = (View) parent;
                }
								<span class="hljs-comment">// 同步动画状态</span>
                <span class="hljs-keyword">if</span> (drawAnimation) {
                    <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) {
                        view.mPrivateFlags |= PFLAG_DRAW_ANIMATION;
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parent <span class="hljs-keyword">instanceof</span> ViewRootImpl) {
                        ((ViewRootImpl) parent).mIsAnimating = <span class="hljs-literal">true</span>;
                    }
                }

                <span class="hljs-comment">// If the parent is dirty opaque or not dirty, mark it dirty with the opaque</span>
                <span class="hljs-comment">// flag coming from the child that initiated the invalidate</span>
                <span class="hljs-comment">// 标记当前层级为脏区域 DIRTY</span>
                <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">if</span> ((view.mPrivateFlags &amp; PFLAG_DIRTY_MASK) != PFLAG_DIRTY) {
                        view.mPrivateFlags = (view.mPrivateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DIRTY;
                    }
                }

								<span class="hljs-comment">// 向上递归，并获取下一个父节点</span>
                parent = parent.invalidateChildInParent(location, dirty);
                <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// Account for transform on current parent</span>
                    <span class="hljs-comment">// 处理父节点的 Matrix 变换</span>
                    <span class="hljs-type">Matrix</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> view.getMatrix();
                    <span class="hljs-keyword">if</span> (!m.isIdentity()) {
                        <span class="hljs-type">RectF</span> <span class="hljs-variable">boundingRect</span> <span class="hljs-operator">=</span> attachInfo.mTmpTransformRect;
                        boundingRect.set(dirty);
                        m.mapRect(boundingRect);
                        <span class="hljs-comment">// 更新 dirty 矩形区域</span>
                        dirty.set((<span class="hljs-type">int</span>) Math.floor(boundingRect.left),
                                (<span class="hljs-type">int</span>) Math.floor(boundingRect.top),
                                (<span class="hljs-type">int</span>) Math.ceil(boundingRect.right),
                                (<span class="hljs-type">int</span>) Math.ceil(boundingRect.bottom));
                    }
                }
            } <span class="hljs-keyword">while</span> (parent != <span class="hljs-literal">null</span>);
        }
    }
</code></pre>
<h2 data-id="heading-2">0x02、<code>ViewGroup.onDescendantInvalidated()</code> 硬件绘制路径</h2>
<p>可以看到<strong>硬件加速</strong>开启后的重绘路径。相比于之前分析的 <code>invalidateChild</code>（软件绘制路径），它的逻辑极其精简。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDescendantInvalidated</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View child, <span class="hljs-meta">@NonNull</span> View target)</span> {
        <span class="hljs-comment">/*
         * HW-only, Rect-ignoring damage codepath
         *
         * We don't deal with rectangles here, since RenderThread native code computes damage for
         * everything drawn by HWUI (and SW layer / drawing cache doesn't keep track of damage area)
         */</span>

        <span class="hljs-comment">// if set, combine the animation flag into the parent</span>
        mPrivateFlags |= (target.mPrivateFlags &amp; PFLAG_DRAW_ANIMATION);
				<span class="hljs-comment">// 脏标记处理</span>
        <span class="hljs-keyword">if</span> ((target.mPrivateFlags &amp; ~PFLAG_DIRTY_MASK) != <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// We lazily use PFLAG_DIRTY, since computing opaque isn't worth the potential</span>
            <span class="hljs-comment">// optimization in provides in a DisplayList world.</span>
            mPrivateFlags = (mPrivateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DIRTY;

            <span class="hljs-comment">// simplified invalidateChildInParent behavior: clear cache validity to be safe...</span>
            mPrivateFlags &amp;= ~PFLAG_DRAWING_CACHE_VALID;
        }

        <span class="hljs-comment">// ... and mark inval if in software layer that needs to repaint (hw handled in native)</span>
        <span class="hljs-comment">// 如果某个父 View 设置了 setLayerType(LAYER_TYPE_SOFTWARE)</span>
        <span class="hljs-comment">// 这个父 View 就必须像普通 View 一样走完整的 invalidate 流程</span>
        <span class="hljs-comment">// 因为它需要 CPU 重新把子 View 绘制到它的 Bitmap 缓存里</span>
        <span class="hljs-keyword">if</span> (mLayerType == LAYER_TYPE_SOFTWARE) {
            <span class="hljs-comment">// Layered parents should be invalidated. Escalate to a full invalidate (and note that</span>
            <span class="hljs-comment">// we do this after consuming any relevant flags from the originating descendant)</span>
            mPrivateFlags |= PFLAG_INVALIDATED | PFLAG_DIRTY;
            target = <span class="hljs-built_in">this</span>;
        }
				<span class="hljs-comment">// 递归向上传递,一直传递到 ViewRootImpl 的 onDescendantInvalidated</span>
        <span class="hljs-keyword">if</span> (mParent != <span class="hljs-literal">null</span>) {
            mParent.onDescendantInvalidated(<span class="hljs-built_in">this</span>, target);
        }
    }

</code></pre>
<p>硬件加速下，脏区域的计算交给了底层的 RenderThread 和 GPU，而不是在 Java 层手动算矩形。</p>
<p>在软件绘制时，CPU 需要知道精确的 <code>Rect</code> 区域，以便只对该区域进行像素填充。但在硬件加速（HWUI）中：</p>
<ul>
<li>每个 View 都有一个对应的 <strong><code>RenderNode</code></strong>（在 Native 层）。</li>
<li>View 的绘制指令被记录在 <strong><code>DisplayList</code></strong> 中。</li>
<li><strong><code>RenderThread</code>（渲染线程）</strong> 知道所有 View 的层级和位置。当某个 View 失效时，渲染线程会自动合并受影响的区域。因此，Java 层不需要费力去算坐标偏移和矩形交集，只需要告知系统：<strong>这个View失效了，需要更新</strong>。</li>
</ul>
<h2 data-id="heading-3">0x03、<code>ViewRootImpl</code> 冒泡的终点</h2>
<h3 data-id="heading-4"><strong>3.1 软件绘制路径计算的终点</strong>: <code>ViewRootImpl.invalidateChildInParent()</code></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> ViewParent <span class="hljs-title function_">invalidateChildInParent</span><span class="hljs-params">(<span class="hljs-type">int</span>[] location, Rect dirty)</span> {
        checkThread();
        <span class="hljs-keyword">if</span> (DEBUG_DRAW) Log.v(mTag, <span class="hljs-string">"Invalidate child: "</span> + dirty);
				<span class="hljs-comment">// // dirty 为 null 代表全量刷新</span>
        <span class="hljs-keyword">if</span> (dirty == <span class="hljs-literal">null</span>) {
            invalidate();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dirty.isEmpty() &amp;&amp; !mIsAnimating) {
		        <span class="hljs-comment">// 区域为空且没动画，直接拦截，不触发刷新</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
				<span class="hljs-comment">// 处理滚动偏移</span>
        <span class="hljs-keyword">if</span> (mCurScrollY != <span class="hljs-number">0</span> || mTranslator != <span class="hljs-literal">null</span>) {
            mTempRect.set(dirty);
            dirty = mTempRect;
            <span class="hljs-keyword">if</span> (mCurScrollY != <span class="hljs-number">0</span>) {
                dirty.offset(<span class="hljs-number">0</span>, -mCurScrollY);
            }
            <span class="hljs-keyword">if</span> (mTranslator != <span class="hljs-literal">null</span>) {
                mTranslator.translateRectInAppWindowToScreen(dirty);
            }
            <span class="hljs-keyword">if</span> (mAttachInfo.mScalingRequired) {
                dirty.inset(-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>);
            }
        }
				<span class="hljs-comment">// 触发刷新,此方法内部会调用 scheduleTraversals()。</span>
        invalidateRectOnScreen(dirty);
				<span class="hljs-comment">// 返回 null，告知 ViewGroup 冒泡循环结束</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidateRectOnScreen</span><span class="hljs-params">(Rect dirty)</span> {
        <span class="hljs-keyword">if</span> (DEBUG_DRAW) Log.v(mTag, <span class="hljs-string">"invalidateRectOnScreen: "</span> + dirty);
        <span class="hljs-keyword">final</span> <span class="hljs-type">Rect</span> <span class="hljs-variable">localDirty</span> <span class="hljs-operator">=</span> mDirty;

        <span class="hljs-comment">// Add the new dirty rect to the current one</span>
        <span class="hljs-comment">// 合并脏区域</span>
        localDirty.union(dirty.left, dirty.top, dirty.right, dirty.bottom);
        <span class="hljs-comment">// Intersect with the bounds of the window to skip</span>
        <span class="hljs-comment">// updates that lie outside of the visible region</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">appScale</span> <span class="hljs-operator">=</span> mAttachInfo.mApplicationScale;
        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">intersected</span> <span class="hljs-operator">=</span> localDirty.intersect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>,
                (<span class="hljs-type">int</span>) (mWidth * appScale + <span class="hljs-number">0.5f</span>), (<span class="hljs-type">int</span>) (mHeight * appScale + <span class="hljs-number">0.5f</span>));
        <span class="hljs-keyword">if</span> (!intersected) {
            localDirty.setEmpty();
        }
        <span class="hljs-keyword">if</span> (!mWillDrawSoon &amp;&amp; (intersected || mIsAnimating)) {
		        <span class="hljs-comment">// 最终触发调度遍历</span>
            scheduleTraversals();
        }
    }
</code></pre>
<h3 data-id="heading-5"><strong>3.2 硬件绘制路径终点：</strong><code>ViewRootImpl.onDescendantInvalidated()</code></h3>
<p>与软件路径那种精细计算矩形、处理滚动偏移的逻辑相比，硬件加速路径的终点显得极其“简单粗暴”的。这种简化正是硬件加速性能优势的体现。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDescendantInvalidated</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View child, <span class="hljs-meta">@NonNull</span> View descendant)</span> {
        <span class="hljs-keyword">if</span> (sToolkitEnableInvalidateCheckThreadFlagValue) {
            checkThread();
        }
        <span class="hljs-keyword">if</span> ((descendant.mPrivateFlags &amp; PFLAG_DRAW_ANIMATION) != <span class="hljs-number">0</span>) {
            mIsAnimating = <span class="hljs-literal">true</span>;
        }
        invalidate();
    }

    <span class="hljs-meta">@UnsupportedAppUsage</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidate</span><span class="hljs-params">()</span> {
		    <span class="hljs-comment">// 全量标记脏区域</span>
        mDirty.set(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, mWidth, mHeight);
        <span class="hljs-keyword">if</span> (!mWillDrawSoon) {
		        <span class="hljs-comment">// 最终触发调度遍历，</span>
            scheduleTraversals();
        }
    }
</code></pre>
<p>可以看到不管是软件绘制还是硬件绘制最终都会触发 <code>scheduleTraversals()</code> 。</p>
<pre><code class="hljs language-java" lang="java">		<span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleTraversals</span><span class="hljs-params">()</span> {
				<span class="hljs-comment">// 防抖机制，可以避免在同一帧时间内多次调用invalidate(),也只会执行一次。</span>
        <span class="hljs-keyword">if</span> (!mTraversalScheduled) {
            mTraversalScheduled = <span class="hljs-literal">true</span>;
            <span class="hljs-comment">// 设置同步屏障，主线程将暂时停止处理普通的 Handler 消息（如点击事件、日志、业务逻辑），</span>
            <span class="hljs-comment">// 直到绘制完成后移除屏障。这确保了 UI 渲染消息一旦到来，能立刻获得 CPU 执行权。</span>
            mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();
            <span class="hljs-comment">// 注册 VSYNC 信号回调</span>
            mChoreographer.postCallback(
                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="hljs-literal">null</span>);
            <span class="hljs-comment">// 通知渲染引擎</span>
            notifyRendererOfFramePending();
            <span class="hljs-comment">// 唤醒系统</span>
            <span class="hljs-comment">// 此方法可以维持高能耗状态，确保这一帧能平滑地画出来，而不会因为系统降频导致掉帧</span>
            pokeDrawLockIfNeeded();
        }
    }
</code></pre>
<p><code>Choreographer</code> 会等待下一个硬件 VSYNC 信号。信号到达后，它会发送一个<strong>异步消息</strong>来执行 <code>mTraversalRunnable</code>。</p>
<p><strong><code>mTraversalRunnable</code></strong>：这个 Runnable 内部执行的就是著名的 <code>doTraversal()</code> -&gt; <code>performTraversals()</code>（包含 Measure、Layout、Draw 流程）</p>
<pre><code class="hljs language-java" lang="java">		<span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TraversalRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
            doTraversal();
        }
    }
    
		<span class="hljs-keyword">final</span> <span class="hljs-type">TraversalRunnable</span> <span class="hljs-variable">mTraversalRunnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TraversalRunnable</span>();

		<span class="hljs-keyword">void</span> <span class="hljs-title function_">doTraversal</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (mTraversalScheduled) {
            mTraversalScheduled = <span class="hljs-literal">false</span>;
            <span class="hljs-comment">// 注意在VSYNC信号到来后马上就移除了同步屏障</span>
            <span class="hljs-comment">// 如果没有移除，会导致正常的普通消息（如事件、日志、业务逻辑）可能无法正常执行从而ANR</span>
            mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);

            <span class="hljs-keyword">if</span> (mProfile) {
                Debug.startMethodTracing(<span class="hljs-string">"ViewAncestor"</span>);
            }
						<span class="hljs-comment">// 执行测量、布局、绘制动作</span>
            performTraversals();

            <span class="hljs-keyword">if</span> (mProfile) {
                Debug.stopMethodTracing();
                mProfile = <span class="hljs-literal">false</span>;
            }
        }
    }
    
</code></pre>
<p>通知渲染线程</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * Notifies the HardwareRenderer that a new frame will be coming soon.
     * Currently only {<span class="hljs-doctag">@link</span> ThreadedRenderer} cares about this, and uses
     * this knowledge to adjust the scheduling of off-thread animations
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyRendererOfFramePending</span><span class="hljs-params">()</span> {
		    <span class="hljs-comment">// 通知渲染线程新的一帧数据马上就要到了，这个方法执行之后会调用native方法</span>
        <span class="hljs-keyword">if</span> (mAttachInfo.mThreadedRenderer != <span class="hljs-literal">null</span>) {
            mAttachInfo.mThreadedRenderer.notifyFramePending();
        }
    }
</code></pre>
<p>渲染线程执行native方法 <code>HardwareRenderer.notifyFramePending()</code> 。</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * Notifies the hardware renderer that a call to {<span class="hljs-doctag">@link</span> FrameRenderRequest#syncAndDraw()} will
     * be coming soon. This is used to help schedule when RenderThread-driven animations will
     * happen as the renderer wants to avoid producing more than one frame per vsync signal.
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyFramePending</span><span class="hljs-params">()</span> {
        nNotifyFramePending(mNativeProxy);
    }
</code></pre>
<p>渲染线程将UI线程的绘制操作转成GPU执行指令，GPU渲染后（填充图形缓冲）就会交给<code>SurfaceFlinger</code>进行图形合成，最后交给显示驱动进行屏幕显示。</p>
<h2 data-id="heading-6">0x04、宏观流程总结</h2>
<p>将整个 <code>View.invalidate()</code> 到 <code>ViewRootImpl.scheduleTraversals()</code> 的过程串联起来，其本质是一次<strong>请求的向上溯源再向下派发绘制信号的调度机制。</strong></p>
<p>向上溯源：不停地去找父View直到找到ViewRootImpl。</p>
<p>向下派发：通过VSYNC信号执行 View树的测量、布局和绘制操作。</p>








































<table><thead><tr><th><strong>步骤</strong></th><th><strong>组件</strong></th><th><strong>行为</strong></th></tr></thead><tbody><tr><td><strong>1. 发起</strong></td><td><code>View</code></td><td>调用 <code>invalidate()</code>。</td></tr><tr><td><strong>2. 冒泡</strong></td><td><code>ViewGroup</code></td><td>标记 <code>PFLAG_DIRTY</code>，向上寻找 <code>ViewRootImpl</code>。</td></tr><tr><td><strong>3. 调度</strong></td><td><code>ViewRootImpl</code></td><td>执行 <code>scheduleTraversals()</code>。</td></tr><tr><td><strong>4. 屏蔽</strong></td><td><code>MessageQueue</code></td><td>插入 <strong>同步屏障</strong>，拦截普通消息。</td></tr><tr><td><strong>5. 等待</strong></td><td><code>Choreographer</code></td><td>等待硬件 <strong>VSYNC 信号</strong>。</td></tr><tr><td><strong>6. 回调</strong></td><td><code>mTraversalRunnable</code></td><td>信号到达，执行 <code>performTraversals()</code>。</td></tr></tbody></table>
<p><strong>引用</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2Fmain%2F%2B%2Fmain%3Aframeworks%2Fbase%2Fcore%2Fjava%2Fandroid%2Fview%2FChoreographer.java" target="_blank" title="https://cs.android.com/android/platform/superproject/main/+/main:frameworks/base/core/java/android/view/Choreographer.java" ref="nofollow noopener noreferrer">cs.android.com/android/pla…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2Fmain%2F%2B%2Fmain%3Aframeworks%2Fbase%2Fcore%2Fjava%2Fandroid%2Fview%2FView.java" target="_blank" title="https://cs.android.com/android/platform/superproject/main/+/main:frameworks/base/core/java/android/view/View.java" ref="nofollow noopener noreferrer">cs.android.com/android/pla…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2Fmain%2F%2B%2Fmain%3Aframeworks%2Fbase%2Fcore%2Fjava%2Fandroid%2Fview%2FViewGroup.java" target="_blank" title="https://cs.android.com/android/platform/superproject/main/+/main:frameworks/base/core/java/android/view/ViewGroup.java" ref="nofollow noopener noreferrer">cs.android.com/android/pla…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习一些常用的混合模式之BlendMode.srcOut]]></title>    <link>https://juejin.cn/post/7592159803410153508</link>    <guid>https://juejin.cn/post/7592159803410153508</guid>    <pubDate>2026-01-07T07:42:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592159803410153508" data-draft-id="7592040819819151401" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习一些常用的混合模式之BlendMode.srcOut"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2026-01-07T07:42:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习一些常用的混合模式之BlendMode.srcOut
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T07:42:47.000Z" title="Wed Jan 07 2026 07:42:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>1 SrcOut</p>
<p>用途：</p>
<p><code>Keeps the source pixels that do not cover destination pixels. Discards source pixels that cover destination pixels. Discards all destination pixels.</code></p>
<p>计算公式：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76ea23f6128349d3a704d74b54febde7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768376567&amp;x-signature=VIhu6qDaJzN7WKtWH0BVRMYahGU%3D" alt="image.png" width="30%" loading="lazy"/>
<p>测试代码:</p>
<pre><code class="hljs language-js" lang="js"> @override
  <span class="hljs-keyword">void</span> <span class="hljs-title function_">paint</span>(<span class="hljs-params">Canvas canvas, Size size</span>) {
    <span class="hljs-keyword">var</span> width = size.<span class="hljs-property">width</span>;
    <span class="hljs-keyword">var</span> height = size.<span class="hljs-property">height</span>;

    canvas.<span class="hljs-title function_">saveLayer</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), <span class="hljs-title class_">Paint</span>());
    canvas.<span class="hljs-title function_">drawRect</span>(
      <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height),
      <span class="hljs-title class_">Paint</span>()..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">red</span>.<span class="hljs-title function_">withOpacity</span>(<span class="hljs-number">1</span>), <span class="hljs-comment">// 半透明红色</span>
    );

    <span class="hljs-keyword">var</span> srcPath = <span class="hljs-title class_">Path</span>();
    srcPath.<span class="hljs-title function_">addRect</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(width/<span class="hljs-number">2</span> - <span class="hljs-number">30</span>, height/<span class="hljs-number">2</span> - <span class="hljs-number">30</span>, <span class="hljs-number">60</span>, <span class="hljs-number">60</span>));
    <span class="hljs-keyword">var</span> srcPaint = <span class="hljs-title class_">Paint</span>()
      ..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">blue</span> <span class="hljs-comment">// 源颜色：蓝色</span>
      ..<span class="hljs-property">style</span> = <span class="hljs-title class_">PaintingStyle</span>.<span class="hljs-property">stroke</span> <span class="hljs-comment">// 填充模式</span>
      ..<span class="hljs-property">strokeWidth</span> = <span class="hljs-number">10</span>
      ..<span class="hljs-property">blendMode</span> = <span class="hljs-title class_">BlendMode</span>.<span class="hljs-property">srcOut</span>; <span class="hljs-comment">// 混合模式</span>
    canvas.<span class="hljs-title function_">drawPath</span>(srcPath, srcPaint);
    canvas.<span class="hljs-title function_">restore</span>();
  }
</code></pre>
<p>第一个矩形就是dst 第二个边框就是src</p>
<p>参考上面的公式可以得出</p>
<p>a = (1 - dst.a) * src.a = （1-1）*1 = 0</p>
<p>c = (1 - dst.a) * src.c = 0</p>
<p>所以混合的结果就是"00000000" 就是透明的。所以效果如下</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/147fe500818e46bba95cab3abc518f75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768376567&amp;x-signature=V7QtAt0CbxmE%2B0unc7aSUb8g7y0%3D" alt="image.png" width="30%" loading="lazy"/>
<p>通过修改src的alpha(透明度)属性，也可以实现不同的效果。比如改成0.7就是下面的效果。按公式计算混合区的透明度就是0.3,色值就是 blue * 0.3</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b28eae499ceb4b19bdcbaa82c1841166~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768376567&amp;x-signature=tTeKtCo3qsNx77iecr7eTHZOotc%3D" alt="image.png" width="30%" loading="lazy"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ArkUI-X 6.0 跨平台框架能否取代 Flutter？]]></title>    <link>https://juejin.cn/post/7592170706026446883</link>    <guid>https://juejin.cn/post/7592170706026446883</guid>    <pubDate>2026-01-07T08:01:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592170706026446883" data-draft-id="7592170706026381347" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ArkUI-X 6.0 跨平台框架能否取代 Flutter？"/> <meta itemprop="keywords" content="Flutter,客户端,ArkUI"/> <meta itemprop="datePublished" content="2026-01-07T08:01:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老刘"/> <meta itemprop="url" content="https://juejin.cn/user/662360127965769"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ArkUI-X 6.0 跨平台框架能否取代 Flutter？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/662360127965769/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老刘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T08:01:57.000Z" title="Wed Jan 07 2026 08:01:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>大家好，我是老刘</strong></p>
<p>最近ArkUI-X 6.0.0 Release 版本正式发布了。</p>
<p>很多兄弟跑来问我：</p>
<p>“老刘，ArkUI 现在的跨平台能力能不能取代 Flutter？”</p>
<p>“我是不是该去学 ArkTS 了？”</p>
<p>先抛出我的核心结论，别嫌扎心：</p>
<p><strong>在全球范围和通用场景下，短期内 ArkUI 根本撼动不了 Flutter 的地位。</strong></p>
<p>这不仅是技术问题，也是生态问题。</p>
<p><strong>在国内市场，如果算上某些“不可名状”的神秘力量加持。</strong></p>
<p>ArkUI 还真有可能在特定领域撕开一道口子，成为 Flutter 的替代者。</p>
<p>为什么这么说？</p>
<p>今天咱们就从代码、渲染、性能、生态这几个实打实的维度。</p>
<p>来一场 ArkUI-X 与 Flutter 的硬碰硬。</p>
<hr/>
<h2 data-id="heading-0">一、 渲染机制与性能：拙劣的模仿者还是优秀的同行者？</h2>
<p>聊完开场白，咱们直接切入要害。</p>
<p>渲染引擎，这才是跨平台框架的“心脏”。</p>
<h3 data-id="heading-1">1. 都是“自带干粮”的狠人</h3>
<p>Flutter 为什么能火？</p>
<p>因为它自己背着画板（渲染引擎）去别人家里（Android/iOS）画画。</p>
<p>不管是按钮还是列表，都是它一个像素一个像素画出来的。</p>
<p>ArkUI-X 在这一点上，跟 Flutter 简直是一个模子里刻出来的。</p>
<p>来看下面的架构图，不能说毫无关系，只能说一模一样。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f8e14f5f8884c49be1d8e7116f5779a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377716&amp;x-signature=OWseP6Ke3DzenKBYXUzbSOHMqkE%3D" alt="" loading="lazy"/></p>
<p>这种架构的优势很明显：</p>
<p>多端一致性极高。</p>
<p>你在 iPhone 上画的圆，到了 Android 也就是这个圆，不会变成椭圆。</p>
<p>不用担心老旧手机系统版本低，因为渲染逻辑都在你自己的包里。</p>
<p>但劣势也很明显：</p>
<p>包体积大。</p>
<p>背着画板出门，行李能不重吗？</p>
<h3 data-id="heading-2">2. Impeller vs Skia</h3>
<p>Flutter 正在干一件大事。</p>
<p>它在逐渐抛弃 Skia，全面拥抱 Impeller。</p>
<p>因为 Skia 虽然强，但在移动端容易出现“着色器编译卡顿”（Jank）。</p>
<p>Impeller 是专门为现代 GPU（Metal/Vulkan）设计的，性能更猛，更丝滑。</p>
<p>反观 ArkUI-X。</p>
<p>目前在 Android/iOS 上，主力还是依赖 Skia。</p>
<p>这就有点尴尬了。</p>
<p>Flutter 都要换引擎了，ArkUI-X 还在用人家上一代的方案。</p>
<p>就像赛车比赛，对手换了涡轮增压，你还在调教自然吸气。</p>
<p>虽然够用，但极限性能上，肯定是要吃亏的。</p>
<h3 data-id="heading-3">3. 最致命的“精神分裂”</h3>
<p>这是 ArkUI-X 目前最大的隐患，也是很多兄弟没注意到的坑。</p>
<p>Flutter 是“一视同仁”。</p>
<p>不管在 Android、iOS 还是鸿蒙，它都用自己的引擎画。</p>
<p>ArkUI-X 是“看人下菜碟”。</p>
<p><strong>在纯鸿蒙（OpenHarmony）侧：</strong> ，大家常说的引擎叫 arkui_ace_engine，负责把 ArkTS 声明式代码解析成 Native UI，并管理动画、事件、绘制管线等。</p>
<p><strong>在 Android/iOS：</strong> SDK 里自带了一份“裁剪+移植版”的 ACE Engine，一般文档里会写作 ArkUI ACE Engine Lite。</p>
<p>Lite版把对鸿蒙系统能力的依赖换成了对 Skia + 平台 Native 窗口的适配</p>
<p>这就导致了一个严重的问题：<strong>底层不一致。</strong></p>
<p>这种“双标”会带来什么后果？</p>
<p>我给你们列几个可能出现的潜在场景（只是说有这种隐患，不是一定会出现这个问题）：</p>
<p><strong>第一，像素级的差异。</strong></p>
<p>设计师给了一个带 0.5dp 边框的圆角按钮。</p>
<p>在鸿蒙上，系统渲染得很锐利，完美对齐像素。</p>
<p>在 Android 上抗锯齿算法一算，可能就变糊了，或者线条变粗了。</p>
<p>你跟设计师解释说这是引擎差异？</p>
<p>设计师只会觉得你菜。</p>
<p><strong>第二，文字排版的噩梦。</strong></p>
<p>做过跨平台的都知道，文字渲染是终极 Boss。</p>
<p>鸿蒙用的是系统的排版引擎。</p>
<p>Android 端用的是 ArkUI-X 自带的字体整形器。</p>
<p>结果就是：</p>
<p>同样的字号，同样的行高。</p>
<p>在鸿蒙上刚好一行显示完。</p>
<p>在 Android 上可能就多出一个字，给你换行了。</p>
<p>当然这个情况可能有点夸张了，但是在一些特殊场景下，也不是完全没有可能。</p>
<p><strong>第三，手感的“恐怖谷”。</strong></p>
<p>滑动的阻尼感，惯性滚动的距离。</p>
<p>鸿蒙端是系统级的丝滑，符合鸿蒙用户的肌肉记忆。</p>
<p>Android 端是 ArkUI-X 模拟出来的手感。</p>
<p>虽然在这个版本已经优化了很多，但那种微妙的“不跟手”或者“太跟手”，</p>
<p>会让用户觉得这个 App “怪怪的”。</p>
<p>所以，别看架构图画得像。</p>
<p>在细节的打磨上，ArkUI-X 还有很长的路要走。</p>
<hr/>
<h2 data-id="heading-4">二、 开发语言与体验：Dart vs ArkTS</h2>
<ol>
<li>
<p><strong>Flutter (Dart)</strong></p>
<ul>
<li>
<p><strong>特点</strong>：专为 UI 设计，支持有状态热重载 (Hot Reload)，开发效率极高。</p>
</li>
<li>
<p><strong>门槛</strong>：需要学习一门新语言，虽然简单但仍有认知成本。</p>
</li>
</ul>
</li>
<li>
<p><strong>ArkUI (ArkTS)</strong></p>
<ul>
<li>
<p><strong>特点</strong>：基于 TypeScript 扩展，拥有庞大的前端开发者基础。</p>
</li>
<li>
<p><strong>双刃剑</strong>：</p>
<ul>
<li>
<p><strong>利</strong>：前端开发者上手极快，语法亲切。</p>
</li>
<li>
<p><strong>弊</strong>：为性能牺牲了灵活性（Static Strict Mode），虽然是 TS 的脸，却是静态的心，编码约束较多。</p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>老刘的观点</strong></p>
<p>我觉得ArkTS属于是对TS的魔改了，目的是通过 静态化 + AOT 来换取接近原生的性能。（这两点是不是都很像Dart呢？）</p>
<p>Dart本身其实最初的设计目标就是解决TS的性能和动态类型的各种问题，ArkTS本质上也是沿着相同的路径去优化。</p>
<p>但是这种魔改基本也放弃了使用TS生态的优势，个人觉得还不如像Dart一样直接另起炉灶。</p>
<p>当然这也可以理解，毕竟Flutter刚开始的时候已经有Dart了，还是邻居团队，可以直接拿来用。</p>
<p>ArkUI-X 则需要在短时间内创建一个新语言，时间上捉襟见肘，基于已经很完善的TS进行修改就能快很多。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-5">三、 生态系统：Flutter 的绝对护城河</h2>
<p>如果说渲染性能是基础战力，那生态系统就是持久战的补给线。在这方面，Flutter 拥有绝对的统治力。</p>
<h3 data-id="heading-6">1. Flutter 的“军火库”</h3>
<p>经过多年的积累，Flutter 的 <code>pub.dev</code> 上已经拥有了数以万计的高质量第三方库。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71abcfbbb1f14003995650cd6a2143b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377716&amp;x-signature=xEYEuqYNlNsWxD9W3UpeUyAUtNM%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p><strong>开箱即用</strong>：无论是高德地图、微信支付、Firebase，还是复杂的图表库、动画库，基本上都能找到官方或社区维护的高质量插件。</p>
</li>
<li>
<p><strong>遇到问题</strong>：你在开发中遇到的 99% 的坑，全球开发者已经在 StackOverflow 或 GitHub Issues 里帮你踩过了。这种“安全感”是技术选型中极重要的考量。</p>
</li>
</ul>
<h3 data-id="heading-7">2. ArkUI-X 的“拓荒期”</h3>
<p>鸿蒙原生（HarmonyOS Next）的生态正在华为的强力推动下飞速发展，但这并不等同于 <strong>ArkUI-X 的跨平台生态</strong>。</p>
<ul>
<li>
<p><strong>现状</strong>：目前 ArkUI 的第三方库主要集中在纯鸿蒙端。当你试图用 ArkUI-X 编译到 Android 或 iOS 时，会发现很多涉及系统底层能力的库是缺失的。</p>
</li>
<li>
<p><strong>结果</strong>：你必须自己去写 Android 的 Java/Kotlin 代码和 iOS 的 ObjC/Swift 代码，并通过桥接。这意味着，你本来想“一次编写，到处运行”，结果变成了“一次编写，三处填坑”。</p>
</li>
</ul>
<h3 data-id="heading-8">3. 生态壁垒</h3>
<p>生态的建设不是一朝一夕之功。Flutter 的护城河不仅是 Google 的投入，更是全球数百万开发者几年时间一行行代码堆出来的。</p>
<p>对于 ArkUI-X 来说，要跨越这座高山，除了华为官方的努力，还需要给出足够的利益诱惑，让社区愿意为 Android/iOS 端的适配贡献代码。在这一点上，目前还看不到足以改变局势的动力。</p>
<hr/>
<h2 data-id="heading-9">四、 AI友好度：谁更懂智能时代的开发？</h2>
<p>在这个“言必称 AI”的时代，评测一个框架如果不聊 AI，那就是耍流氓。</p>
<p>这里的 AI 友好度，我们分两个层面来看：<strong>AI 帮你写代码</strong> 和 <strong>AI 赋能 App</strong>。</p>
<h3 data-id="heading-10">1. 谁是 AI 编程助手的宠儿？</h3>
<p><strong>Flutter (Dart) 完胜。</strong></p>
<p>原因很简单：<strong>语料投喂量。</strong></p>
<p>GitHub 上有多少 Flutter 代码？StackOverflow 上有多少 Dart 问答？</p>
<p>这就导致了一个结果：你用 Cursor 或者 Claude Code 写 Flutter，AI 真的能猜透你的心思。它生成的代码，准确率极高，甚至能帮你处理复杂的逻辑。</p>
<p>反观 <strong>ArkUI (ArkTS)</strong>。</p>
<p>由于是新生代语言，且大部分代码闭源或仅在国内流转，通用大模型（如 ChatGPT 或 Claude）对 ArkTS 的最新语法掌握得并不完美。</p>
<p>经常出现的情况是：AI 给你写了一段代码，你一看，挺像模像样，一跑就报错。</p>
<h3 data-id="heading-11">2. 谁能吃到系统的“AI 红利”？</h3>
<p><strong>这方面，双方各擅胜场。</strong></p>
<p><strong>Flutter 的杀手锏是 Gemini。</strong></p>
<p>Google 官方推出了 <code>google_generative_ai</code> 插件（目前已整合到Firebase中），让 Flutter 开发者能以极低的门槛接入 Gemini 大模型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95f96f26ac1e4f468a035ad26c654a65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377716&amp;x-signature=2gexoWx7YL5GwTSvEfYCsVO6GSw%3D" alt="" loading="lazy"/></p>
<p>无论是文本生成、多模态识别，还是打造智能 Agent，Flutter 都有现成的、高质量的官方支持。</p>
<p>当然，除了自家的Gemini，Flutter 也有支持其他大模型的三方库，比如 OpenAI 的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60b977bead804cc0b3c1b96a8438eb5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768377716&amp;x-signature=mLrPwwGMPwquouzAOcso4enAv3U%3D" alt="" loading="lazy"/></p>
<p>这对于想要快速赋予 App “大模型能力”的团队来说，诱惑力巨大。</p>
<p>因此这方面，Flutter 更胜一筹，而 ArkUI 则需要手动接入不同的API。</p>
<p><strong>ArkUI 的优势</strong></p>
<p>在鸿蒙系统上，AI 能力的终局是可以下沉到控件级。你使用 ArkUI 的 <code>Image</code> 或 <code>Text</code> 组件，默认就支持系统的 OCR、分词和抠图能力。</p>
<p>这种润物细无声的 AI 体验，不需要开发者额外集成 SDK，是原生框架独有的特权。</p>
<p>当然，这种能力很难做到跨平台，只能是鸿蒙系统独享了。</p>
<hr/>
<h2 data-id="heading-12">五、 战略定位：谁会选择 ArkUI？</h2>
<p>谁会放弃成熟的 Flutter，转投 ArkUI-X 的怀抱？</p>
<h3 data-id="heading-13">1. 鸿蒙原生优先 (HarmonyOS First) 的团队</h3>
<p>这是 ArkUI-X 的<strong>基本盘</strong>。</p>
<p>如果你的 App 主要是为了服务国内用户，且必须自主可控。</p>
<p>比如你因为某些原因<strong>不得不</strong>先开发鸿蒙版。</p>
<p>这时候，既然已经用 ArkTS 写了一套高质量的代码，为什么不顺手用 ArkUI-X 生成一个 Android/iOS 包呢？</p>
<p>哪怕只是用来应付一下非主力渠道，也是极其划算的。</p>
<p><strong>这时候，ArkUI-X 是“顺带”的福利。</strong></p>
<h3 data-id="heading-14">2. 只有“一套代码”预算的国内小微项目</h3>
<p>对于一些预算有限的外包团队或初创公司。</p>
<p>如果客户点名要“鸿蒙版”，同时又不想放弃 Android 和 iOS。</p>
<p>招两拨人？没钱。</p>
<p>用 Flutter？还得单独去写鸿蒙的适配（虽说 Flutter 对鸿蒙的支持也在变好，但毕竟隔了一层）。</p>
<p>这时候，ArkUI-X 就成了一个<strong>虽然不完美，但能交差</strong>的解决方案。</p>
<h3 data-id="heading-15">3. Flutter 的死忠粉们会动摇吗？</h3>
<p><strong>很难。</strong></p>
<p>如果你的业务面向全球，或者你的团队已经积累了大量的 Flutter 资产。</p>
<p>转投 ArkUI-X 几乎没有理由。</p>
<p>Flutter 的成熟度、社区活跃度、以及 Google 的背书，依然是目前跨平台开发的<strong>最优解</strong>。</p>
<p>除非……华为给的实在太多了（比如某些特定的扶持计划）。</p>
<h3 data-id="heading-16">4. 总结</h3>
<p><strong>Flutter 是为了“让世界平权”。</strong> 它想让一套代码在所有设备上运行得一样好。</p>
<p><strong>ArkUI 是为了“让鸿蒙破圈”。</strong> 它想让鸿蒙的代码能溢出到 Android 和 iOS 上，为鸿蒙生态输血。</p>
<p><strong>出发点不同，终局自然也不同。</strong></p>
<hr/>
<h2 data-id="heading-17">六、 结语：一场没有输家的博弈</h2>
<p>回到最初的那个问题：<strong>ArkUI 能否取代 Flutter？</strong></p>
<p>如果你还在期待一个非黑即白的答案，那你可能看低了这场博弈的格局。</p>
<p><strong>这从来不是一场“你死我活”的决斗，而是一次“划江而治”的重新洗牌。</strong></p>
<p>Flutter 依然是那个仗剑走天涯的侠客，它的征途是星辰大海，是全球化的广阔天地。</p>
<p>凭借着 Google 的技术底蕴和全球开发者的智慧，它构建起了一座令人叹为观止的生态壁垒。</p>
<p>在很长一段时间内，它依然是跨平台领域的“通用货币”。</p>
<p>而 ArkUI-X，更像是一位守土卫疆的将军。</p>
<p>它背靠着鸿蒙这棵大树，虽然在跨平台的征途中还显得有些稚嫩，甚至步履蹒跚，但谁又能说它不能成长成为下一个Flutter呢。</p>
<p><strong>作为开发者，我们不需要成为工具的殉道者，而应该成为时代的冲浪者。</strong></p>
<p>老刘给兄弟们最后一点建议：</p>
<ol>
<li>
<p><strong>不要急于下注</strong></p>
<p>技术的发展不是一蹴而就，等技术成熟生态完善了再考虑投入时间和精力。</p>
</li>
<li>
<p><strong>技术栈的边界正在模糊。</strong></p>
<p>你会发现，声明式 UI、响应式编程、状态管理，这些核心思想在 Flutter、SwiftUI、Compose 乃至 ArkUI 里都是通用的。</p>
<p><strong>真正值钱的，不是你背熟了多少个 API，而是你对开发范式的深刻理解。</strong></p>
</li>
</ol>
<p>与其纠结“学哪个”，不如问问自己：</p>
<p><strong>当新的浪潮打过来时，你的冲浪板准备好了吗？</strong></p>
<blockquote>
<p>如果看到这里的同学对客户端或者Flutter开发感兴趣，欢迎联系老刘，我们互相学习。</p>
<p>私信免费领老刘整理的《Flutter开发手册》，覆盖90%应用开发场景。</p>
<p>可以作为Flutter学习的知识地图。</p>
<p>—— laoliu_dev</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第8章 Three.js入门]]></title>    <link>https://juejin.cn/post/7592166340381016079</link>    <guid>https://juejin.cn/post/7592166340381016079</guid>    <pubDate>2026-01-07T06:06:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592166340381016079" data-draft-id="7592170171633614863" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第8章 Three.js入门"/> <meta itemprop="keywords" content="three.js,前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-07T06:06:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XiaoYu2002"/> <meta itemprop="url" content="https://juejin.cn/user/251124329220663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第8章 Three.js入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/251124329220663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XiaoYu2002
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T06:06:52.000Z" title="Wed Jan 07 2026 06:06:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">8.1 初始化项目</h2>
<p>three.js 是一个基于JavaScript 的WebGL 引擎，可直接在浏览器中运行GPU 驱动的游戏与图形驱动的应用。 three.js 的库提供了大量用于在浏览器中绘制3D场景的特性与API。我们的入门就基于three.js库去调用对应的API。</p>
<p>需要完成的前置条件如下4点：</p>
<p>（1）创建一个空项目THREEJS。</p>
<p>（2）创建index.html和main.ts文件，用于后续编写示例代码。</p>
<p>（3）安装three.js库和对应声明文件。</p>
<p>（4）安装Vite用于启动项目。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 安装three.js库和对应声明文件</span>
npm i three
npm i --save-dev <span class="hljs-meta">@types</span>/three
<span class="hljs-comment">// 安装Vite用于启动项目</span>
npm i vite -D
</code></pre>
<p>其中index.html是作为展示3D场景界面的文件，然后需要导入main.ts文件，main.ts文件是作为编写three.js的代码文件。</p>
<pre><code class="hljs language-html" lang="html">// index.html
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">html</span>,
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">overflow</span>: hidden;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./main.ts"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>接着到package.json文件中配置vite的启动命令，然后启动项目。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// package.json</span>
{
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"vite"</span>,
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"vite build"</span>
  },
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"three"</span>: <span class="hljs-string">"^0.182.0"</span>
  },
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-string">"@types/three"</span>: <span class="hljs-string">"^0.182.0"</span>,
    <span class="hljs-string">"vite"</span>: <span class="hljs-string">"^7.3.0"</span>
  }
}
</code></pre>
<h2 data-id="heading-1">8.2 案例搭建</h2>
<p>完成项目的初始化并启动项目后，项目界面是一片空白，因为我们还没有编写对应代码，接下来回到main.ts文件中，完成以下3点操作：</p>
<p>（1）引入three库。</p>
<p>（2）创建场景</p>
<p>（3）创建网格。</p>
<p>创建场景永远是第一件要做的事情，它是所有3D物体的容器，就像在2D Canvas中必须先获取画布上下文一样基础。接着是创建网格，three.js中的所有可见的3D物体都是基于网格去组成，网格可以有多个，网格包含几何体和材质。</p>
<p>几何体（Geometry）：定义了物体的形状，即顶点、面等结构信息。</p>
<p>材质（Material）：定义了物体表面的外观，例如颜色、纹理、光滑度等。</p>
<p>创建网格也意味着需要创建几何体和材质，然后放入网格中。几何体有多种形状，对应不同方法，填入不同参数；材质也有多种材质选择，通过不同方法去操作。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;

<span class="hljs-comment">//创建场景</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();

<span class="hljs-comment">//创建几何体</span>
<span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// x，y，z三轴</span>

<span class="hljs-comment">//创建材质</span>
<span class="hljs-comment">//MeshBasicMaterial 这个材质是不受光照影响</span>
<span class="hljs-comment">//MeshLambertMaterial 这个材质是受光照影响 漫反射材质</span>
<span class="hljs-comment">//MeshPhongMaterial 这个材质是受光照影响 镜面高光</span>
<span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({<span class="hljs-attr">color</span>: <span class="hljs-number">0x00ff00</span>});

<span class="hljs-comment">//网格 几何体 + 材质 可以有多个</span>
<span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material);

<span class="hljs-comment">//将网格添加到场景中</span>
scene.<span class="hljs-title function_">add</span>(mesh);
</code></pre>
<p>网格需要包含几何体和材质是很好理解的，几何体是物品的形状，而材质是物品的表面，网格就是将两者结合起来的“完整物体”，类似于3D建模。</p>
<p>创建网格属于场景的部分，而一个最简的Three.js代码结构需要包含三个核心组件：</p>
<p>（1）Scene（场景）：是舞台。所有演员、道具、灯光都必须放在这个舞台上。</p>
<p>（2）Camera（相机）：是摄像机。它决定了你从哪个角度、以何种视野去观看舞台。</p>
<p>（3）Renderer（渲染器）：是负责把摄像机拍到的画面，实际绘制到屏幕画布上的“渲染引擎”。没有它，一切准备都只是数据，看不到图像。</p>
<p>因此创建网格并填充对应的几何体和材质意味着我们拥有了一个最简单的物品填入场景中作为被观察对象（网格需要添加到场景中），在这之后还需要创建相机和渲染器。接下来我们开始创建相机。</p>
<p>相机通过THREE.PerspectiveCamera()创建，需要四个参数分别是：视野角度（fov）、宽高比（aspect）、近裁剪面（near）、远裁剪面（far）。它们一起构成了一个视锥体，决定了相机能看到什么。视野角度控制可见范围的垂直开合程度，类似摄像机的镜头焦距；宽高比确保渲染不变形，通常直接使用窗口比例；远近裁剪面则定义了相机能看清的最小和最大距离，就像人眼的最近视点和最远视点。相机视角如图8-1所示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19cae6da398341a2848a1b6f68a32dd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768370812&amp;x-signature=KA0iU9flyXYymY7F7Se0Ooa%2FOJI%3D" alt="image.png" loading="lazy"/></p>
<p align="center">
 <b> 图8-1 相机视角</b>
</p>
<p>在我们以下代码示例中，第一个参数 75 是垂直视野角度，类似人眼睁开的角度，值越大看到的场景越广；第二个参数 window.innerWidth / window.innerHeight 是宽高比，通常设置为渲染区域的宽除以高，以确保物体不被拉伸变形；第三个参数 0.1 是近裁剪面，表示相机能看清的最短距离，比这更近的物体将被裁剪不可见；第四个参数 1000 是远裁剪面，表示相机能看清的最远距离，比这更远的物体同样不可见，这四个参数共同划定了相机在三维空间中实际能观察到的范围。</p>
<p>接着我们需要设置相机放置的位置，就和现实一样，拍摄所在的位置决定了画面的叙事视角、视觉重点和情感基调。将相机靠近物体并采用低角度，能像电影特写一样赋予主体压迫感和权威性，常用于突出核心元素或营造紧张氛围；反之，将相机拉远并提升高度，则形成俯瞰式的宏观视角，适合展现场景全貌、空间关系或个体的渺小感。通过精确控制相机与主体的距离、高度和角度，能够决定整个场景是通过一个“第一人称”的沉浸式窗口呈现，还是作为一个“上帝视角”的客观全景被观察。</p>
<p>最后，我们需要将相机加入场景中，正如前面所说的所有演员、道具、灯光都必须放在这个舞台（场景）上。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 创建相机</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">75</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>);
<span class="hljs-comment">// 设置相机放置的位置</span>
camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">400</span>);
<span class="hljs-comment">// 将相机加入场景</span>
scene.<span class="hljs-title function_">add</span>(camera);
</code></pre>
<p>最后，我们需要创建渲染器，将摄像机拍到的画面，实际绘制到屏幕画布。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 创建WebGL渲染器实例，这是Three.js用来绘制3D场景的核心工具</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>();
<span class="hljs-comment">// 设置渲染器输出画布的尺寸为整个浏览器窗口的宽度和高度</span>
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-comment">// 将渲染器自动生成的&lt;canvas&gt;画布DOM元素添加到网页的&lt;body&gt;中，这样画面才能显示出来</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);
<span class="hljs-comment">// 执行一次性的渲染操作：命令渲染器从指定相机（camera）的视角，将场景（scene）中的所有物体绘制到画布上</span>
renderer.<span class="hljs-title function_">render</span>(scene, camera);
</code></pre>
<p>实际完整Demo代码如下：</p>
<p>如果创建材质选择MeshPhongMaterial这种受光照影响的要素，那么需要添加光照，否则看不见。如果你的画面看不到物体的话，你需要考虑去看下代码部分中的材质是否受光照影响。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;

<span class="hljs-comment">//创建场景</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();

<span class="hljs-comment">//创建几何体</span>
<span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// x，y，z三轴</span>

<span class="hljs-comment">//创建材质</span>
<span class="hljs-comment">//MeshBasicMaterial 这个材质是不受光照影响</span>
<span class="hljs-comment">//MeshLambertMaterial 这个材质是受光照影响 漫反射材质</span>
<span class="hljs-comment">//MeshPhongMaterial 这个材质是受光照影响 镜面高光</span>
<span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0x00ff00</span> });

<span class="hljs-comment">//网格 几何体 + 材质 可以有多个</span>
<span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material);

<span class="hljs-comment">//将网格添加到场景中</span>
scene.<span class="hljs-title function_">add</span>(mesh);


<span class="hljs-comment">// 创建相机</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">75</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>);
<span class="hljs-comment">// 设置相机放置的位置</span>
camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">400</span>);
<span class="hljs-comment">// 将相机加入场景</span>
scene.<span class="hljs-title function_">add</span>(camera);

<span class="hljs-comment">// 创建WebGL渲染器实例，这是Three.js用来绘制3D场景的核心工具</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>();
<span class="hljs-comment">// 设置渲染器输出画布的尺寸为整个浏览器窗口的宽度和高度</span>
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-comment">// 将渲染器自动生成的&lt;canvas&gt;画布DOM元素添加到网页的&lt;body&gt;中，这样画面才能显示出来</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);
<span class="hljs-comment">// 执行一次性的渲染操作：命令渲染器从指定相机（camera）的视角，将场景（scene）中的所有物体绘制到画布上</span>
renderer.<span class="hljs-title function_">render</span>(scene, camera);
</code></pre>
<p>Three.js创建的Demo画面如图8-2所示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61f0874e08964505840138e55154160e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768370812&amp;x-signature=xbCTNDVOGgZx2cVpwlvxjpI%2BjfU%3D" alt="image-20251218205238843" loading="lazy"/></p>
<p align="center">
 <b> 图8-2 Three.js创建Demo画面</b>
</p>
<p>目前我们场景内只有一个正方块物体，正被相机拍摄着，但看着就像2D的画面。因此我们可以通过引入OrbitControls（轨道控制器）来实现拖动效果，从而实现3D效果。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/examples/jsm/controls/OrbitControls.js'</span>;
<span class="hljs-comment">//创建轨道控制器</span>
<span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">animate</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">requestAnimationFrame</span>(animate);
    controls.<span class="hljs-title function_">update</span>();
    renderer.<span class="hljs-title function_">render</span>(scene, camera);
}
<span class="hljs-title function_">animate</span>();
</code></pre>
<p>轨道控制器拖动效果如图8-3所示。由于目前正方体是没有边缘线的，因此静止的时候看起来更像是不规则的平面物体，我稍微添加了几条红色线条（不太规范）来辅助理解，大致能看出这是一个正方体。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71d1e7abae4f457ca6da6babca60367a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768370812&amp;x-signature=j7kllwZuYREQRyG9mp8TEdQR%2B9E%3D" alt="image-20251218205731942" loading="lazy"/></p>
<p align="center">
 <b> 图8-3 轨道控制器拖动效果</b>
</p>
<p>以上是Three.js入门的一个简单案例。在创建轨道控制器的时候，我们添加了一个定时器，并且使用了递归，但不会出现死循环导致爆栈的情况。因为使用的是浏览器原生API requestAnimationFrame 实现的动画循环，它并不是传统意义上的递归死循环。</p>
<p>代码步骤思路为以下2步：</p>
<p>（1）requestAnimationFrame(animate)：向浏览器“预约”下一帧，告诉浏览器：“在下次屏幕刷新绘制时，请调用animate函数”。它不会立即、连续地调用自身。</p>
<p>（2）浏览器控制节奏：浏览器会以屏幕刷新率（通常是60FPS，即每秒约60次） 的节奏来回调animate函数。当页面隐藏或最小化时，浏览器会自动暂停这些回调以节省资源。</p>
<p>所以通过requestAnimationFrame执行循环，每帧执行完后会释放主线程，等待浏览器下一次绘制时机（执行时机在DOM回流和重绘之前），浏览器牢牢掌控住绘制的运行时间间隔，甚至决定了什么时候会暂停，所以自然不会出现死循环的情况。</p>
<p>这种非阻塞的协作式循环在性能优化（与屏幕刷新同步，避免不必要的重复渲染），节能（页面不可见时自动暂停）和流畅动画（动画更新与屏幕刷新率一致）方面都很不错。这种技术被称为RAF技术。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">animate</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 递归调用animate</span>
  <span class="hljs-title function_">requestAnimationFrame</span>(animate);
  controls.<span class="hljs-title function_">update</span>();
  renderer.<span class="hljs-title function_">render</span>(scene, camera);
}
<span class="hljs-title function_">animate</span>();
</code></pre>
<p>通过以上思路，需要先有整体的场景，然后往场景里添加被观察对象（演员、道具、灯光等），接着是观察对象（相机），最后用渲染器将相机拍到的画面渲染出来。在这里场景是我们（导演）的视角，而摄像机才是观众的视角。相机所拍摄的部分才是我们想展现的部分。我们应该从实际摄影所带来的经验中去思考如何拍摄。</p>
<h2 data-id="heading-2">8.3 添加灯光</h2>
<p>接下来，我们修改材质，将其设置为MeshPhongMaterial这种受光照影响的材质，然后加入灯光，看效果如何。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0x00ff00</span> });

<span class="hljs-comment">// 添加平行光源（模拟太阳光）</span>
<span class="hljs-keyword">const</span> directionalLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">1</span>);
directionalLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>).<span class="hljs-title function_">normalize</span>();
scene.<span class="hljs-title function_">add</span>(directionalLight);
</code></pre>
<p>模拟太阳光对材质进行照射如图8-4所示。可见物体呈现了不一样的质感。像太阳光属于平行光的一种，只能照射到正方体的正面，因此正方体背面还是不可见的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7ac1e4caf8141b3a92c891769fedadf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWGlhb1l1MjAwMg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768370812&amp;x-signature=V0eQMp3ZHh6YumFDXGrNebYEFe8%3D" alt="image-20251218211611489" loading="lazy"/></p>
<p align="center">
 <b> 图8-4 模拟太阳光</b>
</p>
<p>在Three.js中，灯光是塑造三维空间体积感、材质属性和场景氛围的核心工具，本质上是通过模拟光线与物体材质的交互来定义视觉层次。主要分为四种基本类型：</p>
<p>（1）环境光提供均匀无方向的基底照明，如同阴天的漫射光，用于消除纯黑阴影；</p>
<p>（2）平行光模拟无限远处的光源（如太阳），发出平行光线，产生方向明确的阴影，适合户外场景；</p>
<p>（3）点光源从一个点向所有方向均匀辐射光线，像灯泡或蜡烛，能营造真实的衰减和柔和的明暗过渡；</p>
<p>（4）聚光灯则形成锥形的光束，像手电筒或舞台追光，带有清晰的照射范围和边缘衰减，常用于突出特定物体或制造戏剧性焦点。</p>
<p>实际应用中，通常需要组合多种灯光——例如用环境光奠定基调，再用平行光或点光源刻画主次和投影——才能构建出既有层次又自然可信的三维视觉空间。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在 Rust 中以惯用方式使用全局变量]]></title>    <link>https://juejin.cn/post/7592241336289706035</link>    <guid>https://juejin.cn/post/7592241336289706035</guid>    <pubDate>2026-01-07T06:27:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592241336289706035" data-draft-id="7592382702943371310" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在 Rust 中以惯用方式使用全局变量"/> <meta itemprop="keywords" content="后端,Rust"/> <meta itemprop="datePublished" content="2026-01-07T06:27:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xuejianxinokok"/> <meta itemprop="url" content="https://juejin.cn/user/2115899365524222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在 Rust 中以惯用方式使用全局变量
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2115899365524222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xuejianxinokok
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T06:27:56.000Z" title="Wed Jan 07 2026 06:27:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">如何在 Rust 中以惯用方式使用全局变量</h2>
<p>在 Rust 中声明和使用全局变量可能比较棘手。Rust 通常通过强制我们非常明确地定义全局变量来确保其健壮性。</p>
<p>在本文中，我将讨论 Rust 编译器想要避免的陷阱。然后，我将向您展示针对不同场景的最佳解决方案。</p>
<h3 data-id="heading-1">关键要点</h3>
<ul>
<li>在 Rust 中，声明全局变量时应使用 <code>static</code> 或 <code>const</code>，因为在全局作用域中不允许使用 <code>let</code>。</li>
<li>对于<strong>线程安全</strong>的运行时全局变量初始化，请考虑使用 <code>std::sync::Once</code> 或外部库，如 <code>lazy_static</code> 或 <code>once_cell</code>。</li>
<li>由于存在潜在的安全问题，请避免直接使用 <code>static mut</code>；而是将访问操作包装在 <code>unsafe</code> 代码块中，或者使用互斥锁等同步原语。</li>
<li>对于单线程应用程序，<code>thread_local!</code> 宏可以提供一种安全的方式来处理全局状态，而<strong>无需进行同步</strong>。</li>
<li>尽可能将全局变量重构为局部作用域，使用像 <code>Arc</code> 这样的智能指针来实现共享所有权和线程安全。</li>
<li>了解 Rust 中 <code>const</code> 和 <code>static</code> 的区别：<code>const</code> 变量是内联的且不可变的(const 在编译时直接使用变量内容替换了变量,存在多份数据)，而 <code>static</code> 变量可以具有可变状态，并可通过原子类型或互斥锁等内部可变性选项来实现。</li>
</ul>
<h3 data-id="heading-2">概述</h3>
<p>在 Rust 中实现全局状态有很多种方法。如果您时间紧迫，这里快速概述一下我的建议。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69307f3d1cfd4665a1725662822bbdc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeHVlamlhbnhpbm9rb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768372076&amp;x-signature=trNcuqXG3Wq6RHWK30OumM%2B0ch8%3D" alt="A Flowchart for finding the best solution for global variables" loading="lazy"/></p>
<p>您可以通过以下链接跳转到本文的特定章节：</p>
<ul>
<li>无全局变量： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sitepoint.com%2Frust-global-variables%2F%23refactortheexample" target="_blank" title="https://www.sitepoint.com/rust-global-variables/#refactortheexample" ref="nofollow noopener noreferrer">重构为 Arc / Rc</a></li>
<li><strong>编译时</strong>初始化的全局变量： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sitepoint.com%2Frust-global-variables%2F%23whenthevalueisknownatcompiletime" target="_blank" title="https://www.sitepoint.com/rust-global-variables/#whenthevalueisknownatcompiletime" ref="nofollow noopener noreferrer">const T / static T</a></li>
<li>使用外部库可以轻松实现运行时初始化的全局变量： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sitepoint.com%2Frust-global-variables%2F%23externallibraries" target="_blank" title="https://www.sitepoint.com/rust-global-variables/#externallibraries" ref="nofollow noopener noreferrer">lazy_static / once_cell</a></li>
<li>实现你自己的运行时初始化： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sitepoint.com%2Frust-global-variables%2F%23multithreadedglobalswithruntimeinitialization" target="_blank" title="https://www.sitepoint.com/rust-global-variables/#multithreadedglobalswithruntimeinitialization" ref="nofollow noopener noreferrer">std::sync::Once + static mut T</a></li>
<li>针对单线程运行时初始化的特殊情况： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sitepoint.com%2Frust-global-variables%2F%23singlethreadedglobalswithruntimeinitialization" target="_blank" title="https://www.sitepoint.com/rust-global-variables/#singlethreadedglobalswithruntimeinitialization" ref="nofollow noopener noreferrer">thread_local</a></li>
</ul>
<h3 data-id="heading-3">Rust 中使用全局变量的初次尝试</h3>
<p>我们先来看一个全局变量使用不当的例子。假设我想把程序的启动时间存储在一个全局字符串中。之后，我想从多个线程访问这个值。</p>
<p>Rust 初学者可能会想当然地使用 <code>let</code> 来声明全局变量，就像声明其他 Rust 变量一样。完整的程序可能如下所示：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> chrono::Utc;

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">START_TIME</span> = Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>();

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">thread_1</span> = std::thread::<span class="hljs-title function_ invoke__">spawn</span>(||{
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Started {}, called thread 1 {}"</span>, START_TIME.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>(), Utc::<span class="hljs-title function_ invoke__">now</span>());
    });
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">thread_2</span> = std::thread::<span class="hljs-title function_ invoke__">spawn</span>(||{
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Started {}, called thread 2 {}"</span>, START_TIME.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>(), Utc::<span class="hljs-title function_ invoke__">now</span>());
    });

    <span class="hljs-comment">// Join threads and panic on error to show what went wrong</span>
    thread_1.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    thread_2.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
}
</code></pre>
<p>你自己去<a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.rust-lang.org%2F%3Fversion%3Dstable%26mode%3Ddebug%26edition%3D2018%26gist%3D51f73323b3d86ebbb1a89376d9235850" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=51f73323b3d86ebbb1a89376d9235850" ref="nofollow noopener noreferrer">rust  playgroud</a>上试试吧！</p>
<p>这是 Rust 中无效的语法。<code>let</code> 不能用于全局作用域。我们只能使用 <code>static</code> 或 <code>const</code> .  而<code>const</code> 声明的是一个真正的常量，而不是一个变量。只有 <code>static</code> 才能声明一个全局变量。</p>
<p>其背后的原因是， <code>let</code> 在运行时将变量分配到<strong>栈</strong>上。请注意，即使在堆上分配变量，例如 <code>let t = Box::new();</code> ，情况也是如此。在生成的机器代码中，仍然存在一个指向堆的指针，该指针最终会被存储在栈上。</p>
<p>全局变量存储在程序的<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FData_segment" target="_blank" title="https://en.wikipedia.org/wiki/Data_segment" ref="nofollow noopener noreferrer">数据段</a>中。它们的地址是固定的，地址在程序执行期间不会改变。而 <a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FData_segment%23Text" target="_blank" title="https://en.wikipedia.org/wiki/Data_segment#Text" ref="nofollow noopener noreferrer">代码段</a>可以包含常量地址，并且完全不需要占用栈空间。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8479d19dcc004b3bbf9fd38a7a37867b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeHVlamlhbnhpbm9rb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768372076&amp;x-signature=lFz3vCotI%2BfmMCfpR%2Fa4o1GuuUo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>好的，所以我们现在可以理解为什么需要不同的语法了。Rust 作为一种现代系统编程语言，希望非常明确地管理内存。</p>
<p>让我们再试一次 <code>static</code> ：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> chrono::Utc;

<span class="hljs-keyword">static</span> START_TIME: <span class="hljs-type">String</span> = Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>();

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>编译器还不满意：</p>
<pre><code class="hljs language-rust" lang="rust">error[E0015]: calls <span class="hljs-keyword">in</span> statics are limited to constant functions, tuple structs and tuple variants
 -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">3</span>:<span class="hljs-number">24</span>
  |
<span class="hljs-number">3</span> | <span class="hljs-keyword">static</span> start: <span class="hljs-type">String</span> = Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>();
  |                        ^^^^^^^^^^^^^^^^^^^^^^
</code></pre>
<p>嗯，所以静态变量的初始值不能在运行时计算。那或许就让它保持未初始化状态吧？</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> chrono::Utc;

<span class="hljs-keyword">static</span> START_TIME;

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>这将产生一个新的错误：</p>
<pre><code class="hljs language-rust" lang="rust">Compiling playground v0.<span class="hljs-number">0.1</span> (/playground)
error: free <span class="hljs-keyword">static</span> item without body
 -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">21</span>:<span class="hljs-number">1</span>
  |
<span class="hljs-number">3</span> | <span class="hljs-keyword">static</span> START_TIME;
  | ^^^^^^^^^^^^^^^^^-
  |                  |
  |                  help: provide a definition <span class="hljs-keyword">for</span> <span class="hljs-title class_">the</span> <span class="hljs-keyword">static</span>: `= &lt;expr&gt;;`
</code></pre>
<p>所以这个方法也不行！所有静态值<strong>必须在任何用户代码运行之前完全初始化并有效</strong>。</p>
<p>如果你是从其他语言（例如 JavaScript 或 Python）转而使用 Rust，这或许会显得过于限制。但任何一位 C++ 高手都能跟你讲讲<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.cppreference.com%2Fw%2Fcpp%2Flanguage%2Fsiof" target="_blank" title="https://en.cppreference.com/w/cpp/language/siof" ref="nofollow noopener noreferrer">静态初始化顺序的惨痛</a>教训，如果我们不小心，就可能导致未定义的初始化顺序。</p>
<p>例如，想象一下这样的情况：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">static</span> A: <span class="hljs-type">u32</span> = <span class="hljs-title function_ invoke__">foo</span>();
<span class="hljs-keyword">static</span> B: <span class="hljs-type">u32</span> = <span class="hljs-title function_ invoke__">foo</span>();
<span class="hljs-keyword">static</span> C: <span class="hljs-type">u32</span> = A + B;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">foo</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> {
    C + <span class="hljs-number">1</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"A: {} B: {} C: {}"</span>, A, B, C);
}
</code></pre>
<p>由于循环依赖，这段代码片段中存在  不 安全的初始化顺序。</p>
<p>如果是 C++，它不关心安全性，结果将是 <code>A: 1 B: 1 C: 2</code> 它在任何代码运行之前进行零初始化，然后顺序在每个编译单元内从上到下定义。</p>
<p>至少结果已经明确。然而，当静态变量来自不同的 <code>.cpp</code> 文件，也就是不同的编译单元时，问题就出现了。这时，变量的顺序就无法确定，通常取决于编译命令行中文件的顺序。</p>
<p>在 Rust 中，<strong>零初始化是不允许的</strong>。毕竟，零对于很多类型（例如 <code>Box</code> 来说都是无效值。此外，Rust 也不接受奇怪的顺序问题。只要我们避免使用 <code>unsafe</code> ，编译器就应该只允许我们编写合理的代码。这就是为什么编译器会阻止我们使用直接的运行时初始化。</p>
<p>但我能否通过使用 <code>None</code> （相当于空指针）来绕过初始化呢？至少这完全符合 Rust 的类型系统。我肯定可以把初始化代码移到 main 函数的顶部，对吧？</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">static</span> <span class="hljs-keyword">mut</span> START_TIME: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt; = <span class="hljs-literal">None</span>;

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    START_TIME = <span class="hljs-title function_ invoke__">Some</span>(Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>());
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>呃，我们遇到的错误是……</p>
<pre><code class="hljs language-rust" lang="rust">error[E0133]: <span class="hljs-keyword">use</span> of mutable <span class="hljs-keyword">static</span> is <span class="hljs-keyword">unsafe</span> and requires <span class="hljs-keyword">unsafe</span> function or block
  -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">24</span>:<span class="hljs-number">5</span>
  |
<span class="hljs-number">6</span> |     START_TIME = <span class="hljs-title function_ invoke__">Some</span>(Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>());
  |     ^^^^^^^^^^ <span class="hljs-keyword">use</span> of mutable <span class="hljs-keyword">static</span>
  |
  = note: mutable statics can be mutated by multiple threads: aliasing violations or data races will cause undefined behavior
</code></pre>
<p>此时，我可以把它放在一个 <code>unsafe{...}</code> 代码块里，这样就能正常运行。<strong>有时候，这确实是一个有效的策略，比如用来测试代码的其余部分是否按预期工作</strong>。但这并不是我想向你展示的惯用方法。所以，让我们来探讨一下编译器保证安全的解决方案。</p>
<h3 data-id="heading-4">重构示例</h3>
<p>您可能已经注意到，这个例子完全不需要全局变量。而且通常情况下，如果我们能想到不用全局变量的解决方案，就应该避免使用它们。</p>
<p>这里的想法是将声明放在主函数内部：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">start_time</span> = Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">thread_1</span> = std::thread::<span class="hljs-title function_ invoke__">spawn</span>(||{
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Started {}, called thread 1 {}"</span>, &amp;start_time, Utc::<span class="hljs-title function_ invoke__">now</span>());
    });
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">thread_2</span> = std::thread::<span class="hljs-title function_ invoke__">spawn</span>(||{
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Started {}, called thread 2 {}"</span>, &amp;start_time, Utc::<span class="hljs-title function_ invoke__">now</span>());
    });

    <span class="hljs-comment">// Join threads and panic on error to show what went wrong</span>
    thread_1.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    thread_2.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
}
</code></pre>
<p>唯一的问题是通不过borrow检查器：</p>
<pre><code class="hljs language-rust" lang="rust">error[E0373]: closure may outlive the current function, but it borrows `start_time`, which is owned by the current function
  -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">42</span>:<span class="hljs-number">39</span>
   |
<span class="hljs-number">42</span> |     <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">thread_1</span> = std::thread::<span class="hljs-title function_ invoke__">spawn</span>(||{
   |                                       ^^ may outlive borrowed value `start_time`
<span class="hljs-number">43</span> |         <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Started {}, called thread 1 {}"</span>, &amp;start_time, Utc::<span class="hljs-title function_ invoke__">now</span>());
   |                                                     ---------- `start_time` is borrowed here
   |
note: function requires argument <span class="hljs-keyword">type</span> <span class="hljs-title class_">to</span> outlive `<span class="hljs-symbol">'static</span>`
</code></pre>
<p>这个错误并不十分明显。编译器告诉我们，新创建的线程的生命周期可能比 <code>start_time</code> 值更长，而 start_time 值存在于 main 函数的栈帧中。</p>
<p>从技术上讲，这是不可能的。线程是被join的，因此main线程不会在子线程完成之前退出。</p>
<p>但编译器不够智能，无法处理这种特殊情况。通常情况下，当创建一个新线程时，提供的闭包只能借用具有<strong>静态生命周期</strong>的元素。换句话说，借用的值必须在整个程序生命周期内都保持有效。</p>
<p>对于刚开始学习 Rust 的人来说，你可能会想直接使用全局变量。但至少有两种方法比这简单得多。最简单的方法是复制字符串值，然后将字符串的所有权转移到闭包中。当然，这需要额外的内存分配。但在这个例子中，它<strong>只是一个短字符串，(复制)对性能影响不大</strong>。</p>
<p>但如果要<strong>共享的对象很大</strong>呢？如果您不想克隆它，可以将其包装在引用计数智能指针之后 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Frc%2Fstruct.Rc.html" target="_blank" title="https://doc.rust-lang.org/std/rc/struct.Rc.html" ref="nofollow noopener noreferrer">。Rc</a> 是单线程引用计数类型。Arc 是<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Fsync%2Fstruct.Arc.html" target="_blank" title="https://doc.rust-lang.org/std/sync/struct.Arc.html" ref="nofollow noopener noreferrer">原子</a>版本，可以在线程间安全地共享值。</p>
<p>因此，为了满足编译器的要求，我们可以使用 <code>Arc</code> ，如下所示：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">/* Final Solution */</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">start_time</span> = Arc::<span class="hljs-title function_ invoke__">new</span>(Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>());
    <span class="hljs-comment">// This clones the Arc pointer, not the String behind it</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">cloned_start_time</span> = start_time.<span class="hljs-title function_ invoke__">clone</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">thread_1</span> = std::thread::<span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> ||{
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Started {}, called thread 1 {}"</span>, cloned_start_time, Utc::<span class="hljs-title function_ invoke__">now</span>());
    });
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">thread_2</span> = std::thread::<span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> ||{
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Started {}, called thread 2 {}"</span>, start_time, Utc::<span class="hljs-title function_ invoke__">now</span>());
    });

    <span class="hljs-comment">// Join threads and panic on error to show what went wrong</span>
    thread_1.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    thread_2.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
}
</code></pre>
<p>可以去<a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.rust-lang.org%2F%3Fversion%3Dstable%26mode%3Ddebug%26edition%3D2018%26gist%3Dd2f6ba289c511d6708879409f632541d" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d2f6ba289c511d6708879409f632541d" ref="nofollow noopener noreferrer">playground</a>上试试！</p>
<p>以上简要介绍了如何在避免使用全局变量的情况下在线程间<strong>共享状态</strong>。除了我目前展示的内容之外，您可能还需要<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fbook%2Fch15-05-interior-mutability.html" target="_blank" title="https://doc.rust-lang.org/book/ch15-05-interior-mutability.html" ref="nofollow noopener noreferrer">内部可变性</a>来<strong>修改</strong>共享状态。本文篇幅有限，无法全面介绍内部可变性。但在本例中，我会选择使用 <code>Arc&lt;Mutex&lt;String&gt;&gt;</code> 为 <code>start_time</code> 添加线程安全的内部可变性。</p>
<h3 data-id="heading-5">当全局变量值在  [编译时]  已知时</h3>
<p>根据我的经验，全局状态最常见的用途不是变量，而是常量。在 Rust 中，它们有两种类型：</p>
<ul>
<li>常量值用 <code>const</code> 定义。这些常量值会被编译器内联。内部变量的可变性是绝对不允许的。</li>
<li>静态变量，用 <code>static</code> 定义，在<strong>数据段中占据固定的空间。它们内部可以修改</strong>。</li>
</ul>
<p>它们都可以使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Fkeyword.const.html%23compile-time-constants" target="_blank" title="https://doc.rust-lang.org/std/keyword.const.html#compile-time-constants" ref="nofollow noopener noreferrer">编译时常量</a>进行初始化。这些常量可以是简单的值，例如 <code>42</code> 或 <code>"hello world"</code> 。也可以是包含多个其他编译时常量和标记为 <code>const</code> 函数的表达式。只要避免循环依赖即可。（您可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Freference%2Fconst_eval.html" target="_blank" title="https://doc.rust-lang.org/reference/const_eval.html" ref="nofollow noopener noreferrer">Rust 参考手册</a>中找到有关常量表达式的更多详细信息。）</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::sync::atomic::AtomicU64;
<span class="hljs-keyword">use</span> std::sync::{Arc,Mutex};

<span class="hljs-keyword">static</span> COUNTER: AtomicU64 = AtomicU64::<span class="hljs-title function_ invoke__">new</span>(TI_BYTE);

<span class="hljs-keyword">const</span> GI_BYTE: <span class="hljs-type">u64</span> = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;
<span class="hljs-keyword">const</span> TI_BYTE: <span class="hljs-type">u64</span> = <span class="hljs-number">1024</span> * GI_BYTE;
</code></pre>
<p>通常情况下， <code>const</code> 是更好的选择——除非你需要内部可变性，或者你特别想避免内联。</p>
<p>如果您需要内部可变性，有多种选择。对于大多数基本类型， <a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Fsync%2Fatomic%2F" target="_blank" title="https://doc.rust-lang.org/std/sync/atomic/" ref="nofollow noopener noreferrer"><code>std::sync::atomic</code></a> 中都有相应的原子变体。它们提供了一个简洁的 API，用于原子地加载、存储和更新值。</p>
<p>在无法使用原子操作的情况下，通常的选择是使用锁。Rust 的标准库提供了<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Fsync%2Fstruct.RwLock.html" target="_blank" title="https://doc.rust-lang.org/std/sync/struct.RwLock.html" ref="nofollow noopener noreferrer">读写锁</a> （ <code>RwLock</code> ）和<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Fsync%2Fstruct.Mutex.html" target="_blank" title="https://doc.rust-lang.org/std/sync/struct.Mutex.html" ref="nofollow noopener noreferrer">互斥锁</a> （ <code>Mutex</code> ）。</p>
<p>但是，如果您需要在<strong>运行时计算值</strong>，或者需要堆分配，那么 <code>const</code> 和 <code>static</code> 就无济于事了。</p>
<h3 data-id="heading-6">Rust 中的   [单线程]   全局变量及其   [运行时]  初始化</h3>
<p>我编写的大多数应用程序都只有单线程。在这种情况下，锁 机制是不必要的。</p>
<p>然而，仅仅因为只有一个线程，我们就不应该直接使用 <code>static mut</code> 并将访问操作包装在 <code>unsafe</code> 中。这样做可能会导致严重的内存损坏。</p>
<p>例如，不安全地从全局变量借用值可能会导致<strong>同时存在多个可变引用</strong>。然后，我们可以使用其中一个引用来遍历一个向量，再使用另一个引用从同一个向量中删除值。这样一来，迭代器就可能超出有效的内存边界，而安全的 Rust 代码本可以避免这种潜在的崩溃。</p>
<p>但标准库提供了一种“全局”存储值的方法，以便在<strong>单个线程内</strong>安全访问。我指的是<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Fthread%2Fstruct.LocalKey.html" target="_blank" title="https://doc.rust-lang.org/std/thread/struct.LocalKey.html" ref="nofollow noopener noreferrer">线程局部变量</a> 。在多线程情况下，每个线程都会获得该变量的独立副本。但在我们的例子中，由于只有一个线程，所以只有一个副本。</p>
<p>线程局部变量使用 <code> </code>thread_local!<code> </code> 宏创建。访问它们需要使用闭包，如下例所示：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> chrono::Utc;

thread_local!(<span class="hljs-keyword">static</span> GLOBAL_DATA: <span class="hljs-type">String</span> = Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>());

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    GLOBAL_DATA.<span class="hljs-title function_ invoke__">with</span>(|text| {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, *text);
    });
}
</code></pre>
<p>这并非最简单的解决方案。但它允许我们执行任意初始化代码，这些代码会在首次访问该值时及时运行。</p>
<p>线程局部变量在内部可变性方面表现出色。与其他所有解决方案不同，它不需要<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Fmarker%2Ftrait.Sync.html" target="_blank" title="https://doc.rust-lang.org/std/marker/trait.Sync.html" ref="nofollow noopener noreferrer">同步机制</a> 。这使得可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Fcell%2Fstruct.RefCell.html" target="_blank" title="https://doc.rust-lang.org/std/cell/struct.RefCell.html" ref="nofollow noopener noreferrer">RefCell</a> 来实现内部可变性，从而避免了<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Fsync%2Fstruct.Mutex.html" target="_blank" title="https://doc.rust-lang.org/std/sync/struct.Mutex.html" ref="nofollow noopener noreferrer">互斥锁</a>带来的额外开销。</p>
<p>线程局部变量的绝对性能高度依赖于平台。但我<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjakmeier%2Fglobals-in-rust%2Fblob%2Fmain%2Fglobals_benchmarks%2Fsummary.md" target="_blank" title="https://github.com/jakmeier/globals-in-rust/blob/main/globals_benchmarks/summary.md" ref="nofollow noopener noreferrer">在自己的电脑上做了一些简单的测试，</a> 将其与依赖锁的内部可变性进行比较，发现前者速度快了 10 倍。我预计结果在其他平台上不会相反，但如果您非常在意性能，请务必运行您自己的基准测试。</p>
<p>以下是如何使用 <code>RefCell</code> 实现内部可变性的示例：</p>
<pre><code class="hljs language-rust" lang="rust">thread_local!(<span class="hljs-keyword">static</span> GLOBAL_DATA: RefCell&lt;<span class="hljs-type">String</span>&gt; = RefCell::<span class="hljs-title function_ invoke__">new</span>(Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>()));

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    GLOBAL_DATA.<span class="hljs-title function_ invoke__">with</span>(|text| {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Global string is {}"</span>, *text.<span class="hljs-title function_ invoke__">borrow</span>());
    });

    GLOBAL_DATA.<span class="hljs-title function_ invoke__">with</span>(|text| {
        *text.<span class="hljs-title function_ invoke__">borrow_mut</span>() = Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>();
    });

    GLOBAL_DATA.<span class="hljs-title function_ invoke__">with</span>(|text| {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Global string is {}"</span>, *text.<span class="hljs-title function_ invoke__">borrow</span>());
    });
}
</code></pre>
<p>你可以自己去<a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.rust-lang.org%2F%3Fversion%3Dstable%26mode%3Ddebug%26edition%3D2018%26gist%3Db14e53d011da0b9300ffbadc83dfa535" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=b14e53d011da0b9300ffbadc83dfa535" ref="nofollow noopener noreferrer">playground</a>上试试吧！</p>
<p>顺便一提，虽然 WebAssembly 中的线程与 x86_64 平台上的线程有所不同，但这种使用 <code>thread_local!</code> + <code>RefCell</code> 模式同样适用于编译 Rust 代码并在浏览器中运行。在这种情况下，使用针对多线程代码的安全方法就显得有些多余了。（如果您还不了解在浏览器中运行 Rust 的概念，可以阅读我之前写的文章《 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sitepoint.com%2Frust-tutorial-introduction-javascript-devs%2F" target="_blank" title="https://www.sitepoint.com/rust-tutorial-introduction-javascript-devs/" ref="nofollow noopener noreferrer">Rust 教程：面向 JavaScript 开发者的 Rust 入门</a> 》。）</p>
<p>线程局部变量的一个需要注意的地方是，它们的实现取决于平台。通常情况下，你不会注意到这一点，但需要注意的是，正因如此 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Fthread%2Fstruct.LocalKey.html%23platform-specific-behavior" target="_blank" title="https://doc.rust-lang.org/std/thread/struct.LocalKey.html#platform-specific-behavior" ref="nofollow noopener noreferrer">，丢弃语义也与平台相关</a> 。</p>
<p>综上所述，多线程全局变量的解决方案显然也适用于单线程情况。而且，如果没有内部可变性，它们的速度似乎与线程局部变量一样快。</p>
<p>接下来我们就来看看这个问题。</p>
<h3 data-id="heading-7">具有 [运行时] 初始化的 [多线程] 全局变量</h3>
<p>目前标准库对于运行时初始化的安全全局变量还没有很好的解决方案。但是，如果你清楚自己在做什么，可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Fsync%2Fstruct.Once.html" target="_blank" title="https://doc.rust-lang.org/std/sync/struct.Once.html" ref="nofollow noopener noreferrer"><code>std::sync::Once</code> 来</a>构建一个能够安全地使用 <code>unsafe</code> 程序。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fstd%2Fsync%2Fstruct.Once.html%23examples-1" target="_blank" title="https://doc.rust-lang.org/std/sync/struct.Once.html#examples-1" ref="nofollow noopener noreferrer">官方文档中的示例</a>是一个很好的起点。如果您还需要内部可变性，则必须将该方法与读写锁或互斥锁结合使用。以下是具体示例：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">static</span> <span class="hljs-keyword">mut</span> STD_ONCE_COUNTER: <span class="hljs-type">Option</span>&lt;Mutex&lt;<span class="hljs-type">String</span>&gt;&gt; = <span class="hljs-literal">None</span>;
<span class="hljs-keyword">static</span> INIT: Once = Once::<span class="hljs-title function_ invoke__">new</span>();

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">global_string</span>&lt;<span class="hljs-symbol">'a</span>&gt;() <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">'a</span> Mutex&lt;<span class="hljs-type">String</span>&gt; {
    INIT.<span class="hljs-title function_ invoke__">call_once</span>(|| {
        <span class="hljs-comment">// Since this access is inside a call_once, before any other accesses, it is safe</span>
        <span class="hljs-keyword">unsafe</span> {
            *STD_ONCE_COUNTER.<span class="hljs-title function_ invoke__">borrow_mut</span>() = <span class="hljs-title function_ invoke__">Some</span>(Mutex::<span class="hljs-title function_ invoke__">new</span>(Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>()));
        }
    });
    <span class="hljs-comment">// As long as this function is the only place with access to the static variable,</span>
    <span class="hljs-comment">// giving out a read-only borrow here is safe because it is guaranteed no more mutable</span>
    <span class="hljs-comment">// references will exist at this point or in the future.</span>
    <span class="hljs-keyword">unsafe</span> { STD_ONCE_COUNTER.<span class="hljs-title function_ invoke__">as_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>() }
}
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Global string is {}"</span>, *<span class="hljs-title function_ invoke__">global_string</span>().<span class="hljs-title function_ invoke__">lock</span>().<span class="hljs-title function_ invoke__">unwrap</span>());
    *<span class="hljs-title function_ invoke__">global_string</span>().<span class="hljs-title function_ invoke__">lock</span>().<span class="hljs-title function_ invoke__">unwrap</span>() = Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>();
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Global string is {}"</span>, *<span class="hljs-title function_ invoke__">global_string</span>().<span class="hljs-title function_ invoke__">lock</span>().<span class="hljs-title function_ invoke__">unwrap</span>());
}
</code></pre>
<p>你自己去<a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.rust-lang.org%2F%3Fversion%3Dstable%26mode%3Ddebug%26edition%3D2018%26gist%3D54b65ae08be815dcbe8515d3890af86f" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=54b65ae08be815dcbe8515d3890af86f" ref="nofollow noopener noreferrer">playground</a>上试试吧！</p>
<p>如果你想要更简单的方式，我强烈推荐以下两个 crate，我将在下一节中讨论。</p>
<h3 data-id="heading-8">Rust 中用于管理全局变量的外部库</h3>
<p>根据流行度和个人喜好，我想推荐两个我认为是 2021 年 Rust 中实现简单全局变量的最佳选择。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcrates.io%2Fcrates%2Fonce_cell" target="_blank" title="https://crates.io/crates/once_cell" ref="nofollow noopener noreferrer">Once Cell</a> 目前已被考虑纳入标准库。（参见此<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frust-lang%2Frust%2Fissues%2F74465" target="_blank" title="https://github.com/rust-lang/rust/issues/74465" ref="nofollow noopener noreferrer">跟踪问题</a> 。）如果您使用的是 nightly 编译器，您可以通过在项目的 <code>main.rs</code> 中添加 <code>#![feature(once_cell)]</code> 来使用它的不稳定 API。</p>
<p>以下是在稳定编译器上使用 <code>once_cell</code> 以及额外依赖项的示例：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> once_cell::sync::Lazy;

<span class="hljs-keyword">static</span> GLOBAL_DATA: Lazy&lt;<span class="hljs-type">String</span>&gt; = Lazy::<span class="hljs-title function_ invoke__">new</span>(||Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>());

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, *GLOBAL_DATA);
}
</code></pre>
<p>你自己去<a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.rust-lang.org%2F%3Fversion%3Dstable%26mode%3Ddebug%26edition%3D2018%26gist%3Dda7b3377df1c0cf522ce36e4466bf510" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=da7b3377df1c0cf522ce36e4466bf510" ref="nofollow noopener noreferrer">playground</a>上试试吧！</p>
<p>最后，还有 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcrates.io%2Fcrates%2Flazy_static" target="_blank" title="https://crates.io/crates/lazy_static" ref="nofollow noopener noreferrer">Lazy Static</a> ，它是目前最流行的用于初始化全局变量的 crate。它使用一个带有少量语法扩展（ <code>static ref</code> ）的宏来定义全局变量。</p>
<p>以下是同样的例子，从 <code>once_cell</code> 翻译成 <code>lazy_static</code> ：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[macro_use]</span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> lazy_static;

lazy_static!(
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">ref</span> GLOBAL_DATA: <span class="hljs-type">String</span> = Utc::<span class="hljs-title function_ invoke__">now</span>().<span class="hljs-title function_ invoke__">to_string</span>();
);

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, *GLOBAL_DATA);
}
</code></pre>
<p>你自己去<a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.rust-lang.org%2F%3Fversion%3Dstable%26mode%3Ddebug%26edition%3D2018%26gist%3De3a938e2d286620c48316de06d6ef7da" target="_blank" title="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=e3a938e2d286620c48316de06d6ef7da" ref="nofollow noopener noreferrer">操场</a>上试试吧！</p>
<p><code>once_cell</code> 和 <code>lazy_static</code> 之间的选择，本质上取决于你更喜欢哪种语法。</p>
<p>此外，两者都支持内部可变性。只需将 <code>String</code> 包装在 <code>Mutex</code> 或 <code>RwLock</code> 中即可。</p>
<h3 data-id="heading-9">结论</h3>
<p>以上就是我所知的在 Rust 中实现全局变量的所有（合理的）方法。我希望它能更简单一些。但全局状态本身就很复杂。考虑到 Rust 的内存安全保证，似乎不可能找到一个简单通用的解决方案。但我希望这篇文章能帮助你从众多可用的选项中理清思路。</p>
<p>总的来说，Rust 社区倾向于赋予用户最大的权力——但这同时也使事情变得更加复杂。</p>
<h3 data-id="heading-10">关于如何在 Rust 中惯用全局变量的常见问题解答</h3>
<h4 data-id="heading-11">What Is the Difference Between Static and Const in Rust?</h4>
<p>Rust 中 static 和 const 有什么区别？</p>
<p>在 Rust 中，<code>static</code> 和 <code>const</code> 都用于声明全局变量，但它们的特性有所不同。<code>const</code> 在 Rust 中表示常量值，这意味着它的值不会改变。它类似于变量，但它的值是固定的，不能更改。另一方面，<code>static</code> 变量是存储在程序二进制文件只读数据段中的全局变量。<strong>它在整个程序中都可用，而不仅仅是在其声明的作用域内</strong>。与 <code>const</code> 不同(const 可能被拷贝多份)，<strong><code>static</code> 变量在内存中具有固定的地址</strong>。</p>
<h4 data-id="heading-12">如何在 Rust 中声明全局变量？</h4>
<p>在 Rust 中，可以使用 static 关键字声明全局变量。例如：</p>
<p><code>static GLOBAL: i32 = 10;</code></p>
<p>在这个例子中，GLOBAL 是一个 i32 类型的全局变量，其初始值为 10。请记住，静态变量是只读的，您不能修改它们。</p>
<h4 data-id="heading-13">我可以在 Rust 中修改全局变量吗？</h4>
<p>不，你不能直接修改 Rust 中的全局变量，因为它们默认是不可变的。这是 Rust 的一个安全特性，用于防止编译时出现数据竞争。不过，你可以在 <code>std::sync</code> 模块中使用 Mutex 或 RwLock 来实现可变全局变量。</p>
<h4 data-id="heading-14">Rust 中 'lazy_static!' 宏的用途是什么？</h4>
<p>Rust 中的 <code>lazy_static!</code> 宏允许你以惰性方式初始化静态变量。这意味着静态变量的<strong>初始化会被延迟到首次访问时</strong>才执行。当初始化操作开销较大，而你只想在必要时才执行时，这种方式非常有用。</p>
<h4 data-id="heading-15">如何在 Rust 中使用 'lazy_static!' 宏声明全局变量？</h4>
<p>以下示例展示了如何在 Rust 中使用 'lazy_static!' 宏来声明全局变量：</p>
<p><code>#[macro_use]</code><br/>
<code>extern crate lazy_static;</code><br/>
<code>use std::sync::Mutex;</code><br/>
<code>lazy_static! {static ref GLOBAL: Mutex&lt;i32&gt; = Mutex::new(0);</code><br/>
<code>}</code></p>
<p>在这个例子中，GLOBAL 是一个 Mutex 类型的全局变量。<code>&lt;i32&gt;</code> 并初始化为值 0。'lazy_static!' 宏确保初始化以线程安全的方式完成，并且只执行一次。</p>
<h4 data-id="heading-16">Rust 中 'static' 和 'static mut' 有什么区别？</h4>
<p>在 Rust 中，<code>static</code> 用于声明<strong>只读</strong>的全局变量，而 <code>static mut</code> 用于声明可变的全局变量。但是，<code>static mut</code> 是<strong>不安全的</strong>，因为如果两个线程同时访问同一个变量，可能会导致未定义行为。</p>
<h4 data-id="heading-17">如何在 Rust 中安全地访问静态 mut 变量？</h4>
<p>在 Rust 中，可以使用 <code>unsafe</code> 关键字安全地访问静态可变变量 (static mut)。例如：</p>
<p><code>static mut GLOBAL: i32 = 10;</code></p>
<p><code>fn main() {</code><br/>
<code>unsafe {</code><br/>
<code>GLOBAL = 20;</code><br/>
<code>println!("{}", GLOBAL);</code><br/>
<code>}</code><br/>
<code>}</code></p>
<p>在这个例子中，“unsafe”关键字用于指示代码可能会执行在安全代码中未定义的操作。</p>
<h4 data-id="heading-18">Rust 中全局变量的生命周期是什么？</h4>
<p>在 Rust 中，<strong>全局变量的生命周期与程序的运行时间相同。这意味着全局变量在程序启动时创建，并在程序结束时销毁</strong>。</p>
<h4 data-id="heading-19">我可以在 Rust 函数中使用全局变量吗？</h4>
<p>是的，你可以在 Rust 函数中使用全局变量。但是，使用时要格外小心，因为如果使用不当，它们可能会导致数据竞争。通常建议尽可能使用局部变量而不是全局变量。</p>
<h4 data-id="heading-20">Rust 中全局变量的替代方案有哪些？</h4>
<p>如果你想在 Rust 程序的不同部分之间共享数据，可以使用一些替代全局变量的方法。这些方法包括将数据作为函数参数传递、从函数返回数据、使用结构体和枚举等数据结构，以及使用通道和锁等并发原语。</p>
<hr/>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sitepoint.com%2Frust-global-variables%2F" target="_blank" title="https://www.sitepoint.com/rust-global-variables/" ref="nofollow noopener noreferrer">原文地址</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Instagram负责人Adam对2026年内容生态的判断]]></title>    <link>https://juejin.cn/post/7592276497399513138</link>    <guid>https://juejin.cn/post/7592276497399513138</guid>    <pubDate>2026-01-07T06:44:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592276497399513138" data-draft-id="7592361736129806346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Instagram负责人Adam对2026年内容生态的判断"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-07T06:44:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XCaptaino"/> <meta itemprop="url" content="https://juejin.cn/user/3052665287739005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Instagram负责人Adam对2026年内容生态的判断
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3052665287739005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XCaptaino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T06:44:30.000Z" title="Wed Jan 07 2026 06:44:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、2026年内容生态预测</h2>
<p>这是关于 Instagram 负责人 Adam Mosseri 对 2026 年内容生态的判断： 在 AI 快速涌入社交媒体、生成海量“看起来很真”的图片和视频的背景下，创作者真正稀缺、真正有价值的，不再是“内容做得多精致”，而是“可信度”和“独一无二的个人性”。</p>
<p>他认为：未来创作者不会变得不重要，反而会更重要，因为在 AI 内容充斥的世界里，大家会更依赖“认识的人”和“信得过的人”，而不是抽象的机构或看起来完美的画面。</p>
<h2 data-id="heading-1">二、AI 洪水下的根本变化：从“好不好看”到“可信不可信”</h2>
<ol>
<li>AI 让制作精致内容的门槛几乎为零</li>
</ol>
<ul>
<li>生成照片级真实（photorealistic）的图片、视频、甚至声音的工具进步很快。</li>
<li>内容生产成本被大幅压缩，很多人可以轻松做出过去需要专业设备和技能才能做出的“高质量”内容。</li>
<li>这意味着：“画面真实感、好看、光线好、皮肤完美”这类原本可以帮创作者脱颖而出的特点，变成了任何会用工具的人都能复制的“标配”。</li>
</ul>
<p>Mosseri 把这描述为一种“过剩”：当某种东西太多、太容易获得时，它就不再是区分度。</p>
<ol start="2">
<li>“真实性”变成稀缺品</li>
</ol>
<ul>
<li>早期的 AI 生成作品还有明显破绽（比如皮肤过度光滑、光线怪异），但这些“破绽”只会越来越少。</li>
<li>随着 AI 输出越来越逼真，用户用“看上去像不太自然”来判断是不是 AI 内容，会越来越不可靠。</li>
<li>在这种情况下，他认为：“真实性”（authenticity）正在变成一种稀缺资源。 人们需要新的方式来判断：这个内容是不是“真实的”、是不是“有人在背后负责”。</li>
</ul>
<h2 data-id="heading-2">三、为什么创作者会“更重要而不是更不重要”？</h2>
<ol>
<li>媒体结构的长期变化：从机构到个人</li>
</ol>
<p>Mosseri 把这个趋势放在更大的背景里讲：</p>
<ul>
<li>互联网降低了“触达受众”的成本，个体可以绕开传统媒体（报纸、电视台、出版机构）直接发声。</li>
<li>结果是：个别运动员的个人粉丝量不亚于整个球队。 一些记者的个人公信力超过其所在媒体。 很多创作者的受众体量大于传统媒体品牌。</li>
</ul>
<p>这是一个长期的“去机构化、向个人聚焦”的过程。</p>
<ol start="2">
<li>对机构的信任下降，对人的信任上升</li>
</ol>
<ul>
<li>过去几十年里，公众对政府、大公司、传统媒体等机构的信任持续走低。</li>
<li>这推动了“创作者内容”的崛起： 人们更愿意看一个自己喜欢、觉得真诚的创作者拍的内容，而不是“机构包装出来的官方宣传”。</li>
</ul>
<p>在 AI 来临之前，这种“人比机构更可信”的趋势就已经在发生了。</p>
<ol start="3">
<li>AI 的冲击：规模有了，但“作者”消失了</li>
</ol>
<ul>
<li>AI 可以无限放大内容生产的规模，却不带来明确的“创作者身份”。</li>
<li>即使 AI 作品质量很高，人们常常觉得它“有点造出来的感觉”（fabricated），缺乏真实感。</li>
<li>在内容量暴涨的环境里，Mosseri 提出一个新的核心问题：</li>
</ul>
<blockquote>
<p>核心不再是“你能不能做内容”，而是“这个东西看起来是不是只能由你来做”。</p>
</blockquote>
<p>也就是说，“谁在创作”会比“内容看起来多完美”更关键。</p>
<h2 data-id="heading-3">四、Instagram 审美趋势的变化：从精修大片到“粗糙感”</h2>
<ol>
<li>精致主页面的时代已经过去</li>
</ol>
<p>Mosseri 回顾了 Instagram 自身的变化：</p>
<ul>
<li>过去：Instagram 代表“精致、滤镜、精心布置的生活照”。</li>
<li>现在：大多数人已经不再在主页面（Feed）上频繁发生活瞬间。 更多的“日常分享”转移到：Stories（限时动态） 私信（DM）</li>
</ul>
<ol start="2">
<li>Stories 和私信里的内容是什么样？</li>
</ol>
<ul>
<li>技术上不完美：模糊的照片 抖动的视频 随手拍、没有构图和修饰</li>
<li>情感上更接近：自然、随意、带有明显“此刻”的痕迹。</li>
</ul>
<p>这与手机厂商、相机厂商追求的方向形成鲜明对比——后者一直在强调更高像素、更高级的图像处理、更接近“专业摄影”的虚化效果。</p>
<ol start="3">
<li>“粗糙感”成了一种反向的真实性信号</li>
</ol>
<p>Mosseri 认为：</p>
<ul>
<li>当“精致、好看”变得非常普遍、非常廉价的时候，人们反而被“不完美、未加工”的内容所吸引。</li>
<li>他预测未来会出现明显的“加速”：创作者会刻意保留或制造一些“粗糙感”来表达真实。在一个一切都可被优化的世界里，留有瑕疵反而成为“有人在现场”“这是真的”的证据。</li>
</ul>
<h2 data-id="heading-4">五、Instagram 的产品和算法如何配合这种趋势？</h2>
<ol>
<li>打压“模板化、自动化”的内容</li>
</ol>
<p>Instagram 最近的一些策略体现了这种偏好：</p>
<ul>
<li>降低以下内容的推荐权重：过于模板化、批量化的内容 纯转发、没有明显二次创作的内容 看起来像“通用的、批量 AI 生成”的内容</li>
<li>允许使用 AI 工具，但强调：必须能看出明显的“创作意图” 不鼓励机械、海量的“无个性”产出</li>
</ul>
<ol start="2">
<li>2025 年 12 月算法更新的重点</li>
</ol>
<p>文章提到 Instagram 的一次重要算法更新，主要倾向：</p>
<ul>
<li>更看重：主题的清晰度（topical clarity）：账号内容是否围绕相对明确的主题，而不是啥都发。 早期互动信号：内容发出后，初期的点赞、评论、分享反馈如何。 原创性：是否为原创，是否有明显的个人化表达。</li>
<li>限制：同一个账号如果覆盖很多不相关的主题，整体分发会变弱。 看起来“模式化”“公式化”“缺乏原创变体”的内容更难得到推荐。</li>
</ul>
<p>这跟 Mosseri 的观点是统一的： 在内容极度过剩的情况下，平台不得不更用力地区分“填充时间的内容”和“真正能建立信任关系的内容”。</p>
<h2 data-id="heading-5">六、下一步：连“粗糙感”也会被 AI 模仿</h2>
<p>Mosseri 也提醒： 哪怕现在“粗糙”“不修边幅”是一种真实性信号，未来 AI 也会学会完美复制这种风格。</p>
<ul>
<li>AI 很快可以生成：看起来像手机随手拍的模糊照片 带手抖的“伪视频” 看似临时、冲动的“假即兴”内容</li>
<li>这意味着：不管画面是精致还是粗糙，都可能是 AI。 光靠“画面风格”来判断真伪会变得越来越不可靠。</li>
</ul>
<p>观众将从“看内容”转向“看人”</p>
<p>面对这种局面，Mosseri 认为：</p>
<ul>
<li>用户将被迫改变思维方式：从“这张图/这段视频看起来真实吗？”转向 “发这东西的人是谁？我信不信这个人？”</li>
<li>对他这一代人来说，人们习惯默认：照片和视频大体上都是真实记录现实的。 这种直觉正在失效，适应新的现实需要时间。</li>
</ul>
<h2 data-id="heading-6">七、对创作者和平台分别意味着什么？</h2>
<ol>
<li>对创作者：不要拒绝技术，而要保留“你的痕迹”</li>
</ol>
<p>Mosseri 的建议不是“别用 AI”，而是：</p>
<ul>
<li>可以用 AI，但要避免：被工具同质化 让作品失去“只有你才能这样讲”的感觉</li>
<li>关键是：你用 AI 做出来的东西，观众能不能一眼看出：“这是你一贯的风格、观点、人格延续”？ 你有没有持续在积累“个人声誉、长期身份、内容风格”的资产？</li>
</ul>
<ol start="2">
<li>对平台：如何管理海量“合成内容”而不损坏信任</li>
</ol>
<p>对 Instagram 这类平台来说，难题是：</p>
<ul>
<li>AI 内容会源源不断涌入平台。</li>
<li>但如果不加管理，用户对平台整体内容的信任会下降。</li>
<li>所以平台需要：识别、旗标、降权那些缺乏明确作者、缺少创作意图、只追求数量的内容。 提升那些能承载“真实人格、长期关系、稳定身份”的创作者和作品。</li>
</ul>
<p>用一句话概括 Mosseri 的判断：</p>
<blockquote>
<p>当“逼真感”因为 AI 而变得廉价时，真正稀有的东西会变成： 真实的人、持续的身份、一贯的风格，以及对受众负责的态度。</p>
</blockquote>
<h2 data-id="heading-7">八、核心结论</h2>
<p>AI 会让“做得像真的内容”变得到处都是，但也正因为这样， 在社交媒体里，能够保持“可识别的人味、长期的一致性和可被追责的个人身份”的创作者，反而会变得比以往任何时候都更有价值。</p>
<p>参考来源：</p>
<p>Instagram Head Adam Mosseri Sees Creator Value Rising As AI Floods Social Feeds</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.netinfluencer.com%2Finstagram-head-adam-mosseri-sees-creator-value-rising-as-ai-floods-social-feeds%2F" target="_blank" title="https://www.netinfluencer.com/instagram-head-adam-mosseri-sees-creator-value-rising-as-ai-floods-social-feeds/" ref="nofollow noopener noreferrer">www.netinfluencer.com/instagram-h…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[查看 Base64 编码的字体包对应的字符集]]></title>    <link>https://juejin.cn/post/7592276497399480370</link>    <guid>https://juejin.cn/post/7592276497399480370</guid>    <pubDate>2026-01-07T06:39:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592276497399480370" data-draft-id="7592234632482799625" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="查看 Base64 编码的字体包对应的字符集"/> <meta itemprop="keywords" content="前端,CSS,字体"/> <meta itemprop="datePublished" content="2026-01-07T06:39:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端小黑屋"/> <meta itemprop="url" content="https://juejin.cn/user/4476867078793198"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            查看 Base64 编码的字体包对应的字符集
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4476867078793198/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端小黑屋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T06:39:54.000Z" title="Wed Jan 07 2026 06:39:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Base64 转换为 字体文件 .woff</h2>
<p>若从代码中看到Base64 编码的字体包，不好确认包含哪些字体，可以通过截取的方式进行解析：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@font-face</span> {
    <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'SourceHanSerifCN-Regular'</span>;
    <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'data:font/woff2;charset=utf-8;base64,d09GMgABAAAAABEcAA8AAAAAH6AAABDAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP0ZGVE0cBlYAgkoIBBEICq08pBwLcAABNgIkA3YEIAWDbAeEMBckGHYbiRkjkpPaFpD9ZfJgDD3UkS0ShGvVBPNHa81DfmMfdiJsq+ZWNXkwlSw2Sriib3gwX8v+zJn/nmynWVkuMkpyoJhNGbIqOHYxMO2901tPgB+QZLtMh8tnC7fN8NsjpqGSEymBKlw65SM//3UMhqe5/bvdBhjzdtvoUjZgVI4RJx4H/RHJkSU2NjrJkCr1C0r4MZP6I2r07PrB9/Pw3+17d6Zmpv7kkaSSWJTyAq6udc7q2DBWxlGI/3/XysrM7v4jcAVAYatqfI3JJEtJbmaBMwdM2SIJVSMJWO6pvuqyq9AVhoyrMnWyFbKXbXaLpCIWUyxAp88TmwIA2Ajh2R7J+Yw7A/9aUs5hcj35FFjQfYjxA2B7+LxGDGtIYwYELAOm+Q1d4/9RUGv+W+Nd8xC2d0LAMEZG2wdtqkBUaELPwgSYXcn/C8IE4x7KHsJtZQmY0PU7t5w81WrEmvB/CNhHaFvQrIzE6Vy6TUsa/QUEqWlGNslRLpANkTw70zip4mvFN8I0jYYuWvU67Jr1SNo561OEborRee5i8MumJPREPujCbTZQnx0RujZ4j8BGWzTDXrUcd9iSpxoUck4N29tgQ0FAfXQz9VOHqypbOeUYixFlvmLXyRVenrKuwUniaR6G4Ok3Rvm+o9jAQEplpzQrPYxuYvHWI7scijTNRBGtPCb+E6fsbrWrz4zgKaOagF/XoPqE+I+ZpNn4EsAm80vU16SBaxMq6/uigZrZHcT0wBShoQr4dQCtqd2q4JlTRZ6sMxZlDhVHbrntNNQQaAAM0ejkFlESrvI7B4/r+7QUydOf2OWPOonQrhpBJoeK70Ab8sZCoI5GvlgKkRSHina9ZVj7aN0+0MfVTkE51HIFvIDNTq7izfPHqMnh3/6NB9VHt4KbDyv315YfhDfAu36/8rCyv1L8SDFNwC7HGOyjgRxUfeDfV2tXEJqWomVERmDYmriOKb4ScdTLA8a0EId8rMxcuvb5+99HtOoLLTxyyQblB+Bp/lX4U3h1kBLh8kzg3WcVmbXTod1asACeVWIxjluDlmqiJQ1emEFflEzUeuhl+FBWxbEy4T9mYZlYVdp1b6jYcMuoJ5GlJxQXLahrZeTcuyMi1kFo4wZSaP1GaFun9oHndOs6PI3R5b+GKZptAvsaKUNzrcErQmjVqAqwNCsVo8GNXSyiAOc43rnmZAiEK6hMLym5XGdIfCHdu4GWJM+NBmGNxNpRatzz4c5IDOTvnaUocYOeTFZWFBnXXVYLWCmbSedGcVBY6s2pvQ3KnzgoLozTLOoVnpFYBDo2jAEJhLl+0kpPtPOEHMH5o0szjDuQI156VdeQFlURckakS7ialeSP5SWYyQpyoV/TLOvDT6VTJU/7CFp5iMXYjbYkoKLaug7HWCXFxBMt21ncUIp4MBnAU5Sb6PQVZkxyoF4qg+Ufqkz/Oq9uop+JcEhJAmiI9lAC2AbuAOJIYmdfS0IwvF52JsSAlvgZAC99Z4+F9lQNggtbnmCTFAp8j5h7wv58Amnti3L7P9T119Vbwc3Kdb8zrCMFbfnUqLCM7KWsiJvrzdOoujMp3GkFEWlnvF9jMplFwTPhQCGePp1SJm0BRQ+bqJhTOZehGmTW66IzokHRzdopB3KmZaSsla5mGCtiouNCrnXZjH0vY00esey1azJWr0UOz0tQ08HObzSpN0Zbu8Zo/5tdn8tsow4NpoIlOm7+6W6dBV71SDW7y9de77/Nfj8WETwTFyHtZ3dXdopQnI6LUPX2hmxgnOblMLHQ1XZuueutLh/1o9FJ+pbIvamL1Vwd/na8UZcD/ObpUTl9925ovpIW/dnprJ0VlJjrPm1wagIXI/BwXUoDPCxGAN+7jb/OTXiYPsBJXhjaZ3jt62jC7tt/509YJNtLeUayN7vpF6lHssMO+PhHZuvcrPAAXz2ruG7hHgF2vqbd0GhbWpt823xyal1xYmRn3e4g/BkCDTakNUCDzxAQMRYXx4gdwoUIPHo6rQ4eFiJEByMpQUehCX7cTZYb3PZym9wQ+T4sfABCK851Y9DatfAPuNz42nX48UsUT8eFprDaW0EleplJ8SCj94f7FQa87lryIeKbTVOXWsaT0VSD/sRzl6LVR/dJevCNDAo87kp7H/Xy9jiC3s13i1qirFCk3cHOnO6nc1SHj0H8UB0s9ngifAwe1G/Mp17jNEEcIsjld4vCi7ZMfNMKfL53j8uh8S7BuBCFHnMiYcdgEFexRvzNSk3dYo/GMZ1Kcu/SrRelqkXJxUpaV+8bCbx1DpX98QYWshECRIcHTyJ4KH6LekW0QVEa6pyOrhQjsFsSxFQik5ie3cvuUxy/rirxAhW+B1HqRTEyhR/xZ1zomVVF/H0zIW2wcAokrgR/RvASXIxQDK3c1F02uqtPkYBWy2sGbox/YABt22mUOKbBXFPXWismnku1qwM7c9YI9BIB5XyM3XPtKxtR3A9/hwKKYYMYJbJton5Ur0MIoFQ20nLUiXSVT7q6x6MCZ9L1i1/v29gqnTI4mG545fuDZP8b/Wu8/0X4fiXD8MmgTApwpZxRh0bb9n95I34ykKw0YfPlN2jgfxSvx8UonLOaJoZPiBHi9mbl190WP0zfs1uAhapjefj5PTfc0vfaFpO8HtFMH1wMfzkyWxyn+kyY4vlH7w8UoBsqf+/K89mvANhldKNzj65XOZ2UIf9nNol/QfFoRnB6PI+JC0JUHQ3Z9rz1LDid/P1HiFe01cWi4TQYiv6/lnj6i/r4btnI1G0VeXdNeX3XBm1g25c96LBLqzU4OFVnz7YR8yWagTiXZpKgItfoPXVrtb4gq7ii0/yW5T3rO+NNOWXXv21vOPXIMtJBSitFZd1hbnXvbFXeNOBLn3sAjXak1UGDVBSfxKkoNFiX1gGNPtAyT6AK/BwBVRAHMqbWiGGqibORh2rBrGtjpe+/XRN10LAYIQqITwjJyHJM/s2a+MMKVV9RRCVAVvsaMY1qSJ/br2nWPU0lThFfEOVvn9ryD0soAY5UrBEPUdmsc5ky5H+k2/7JlMvq7qIShsQ9hGF6h+l3ZxIh3IlphHn8Hr3/zn2UAJFeoSIUD8bvIyVuXVsXqbguLqK+y124/BAh/Igxaq7daRsRQjCIQWT2AIj8XqecaRvwjnwLQvE7OITCNfQAZV97EULkEWJqzWrdohgl9AkQ8flkOPPEqJ2Df7KnsXk4XdDs6OCflA28hXOnHmgmqPUY1O+LDj8emx0x4Ppks6FD3JHgoLD1wUPXKY1XS3ICvQ9OJl3S7dcpl+NdPHW4M2efqUqEQhK29aNGtkzRiHisf/Afvp6LoQ5glUU15h+8c3YGnl8a/9QbWMv77eCx5gvfREpGEoie9dunVe3UwoNUbAGF39forkg6pXK4IExtdbhh1uXsutyadRe6miVkBb2d34u0s5luXD10UGOPj/bhHU2Oe3e7DaTNkCQfvwA+RjNlOFbrGNItghcWhZ96d9Q7kdgLKHaCCle2dH1NGMAFBR4zx3uLN37JrRSXdvqtSDqlc9QpdqA1JWfLJjtBd3dV+/QK52jAsGvsl4Sq0C5WVWjqSYfbGcci5toKpjyyXsH/3nR9k0ZKJ/oPpdRaBrwDev36L5H1N/nf4vy2Wj82jfFLN3i1xZGt46yeNxop7+HsjnGH4DtnEjrRXzkwhKBYHnYXgY9KgBfs06/vr+o4Iahu37e/sl1woqJDMB6fiMvVmXrbpM8dGJ59lZtasd7ZZ6cSxSP4ZNurP4V5Yey3W/QcY1wPBB7b6OF1ojrhh10ttKH5iDd/v69eks0+Zzzdx6Im7lbby1Hh9azfOB4gvCnwKoJtwS4h8OvGPzsy8rMnnvR4NcKvBxCMhV1DyPphuquSTmkcLoXXfyD7FT+ntffa1JtGwPueZ4w5m3IwJ2NTVyeOmSsP9jcUM7Aj2FMG/Lo2cYzy+zzMPcBtgpUda8HW53lG7s6mxu48I1NMMPUYL/zAPu5FijJD00jaZfvxPnLN0+Y0ustWH4UK6e08JefAKh9DL12usvhGf6vk3CwMgi8GLzGwIIH/4LUVKOJKYHOvIvD7WtvOi1usezNM4+nz3tAcdIDLSuBtut8e20rKvQed5XVlctQpPOIByPAK7EMwdawHIWtGr2gsNRc0hZj9iiZrXkAwRexCDaz5TmYZr9vu4B2A+qQC1kX4tmRNUhp6YK4zt4kycHpS9NVufEfqAD/+7JkbY+8aq3AWHdp15ZOy+iVuDsBcN65Q4t7g4u6O2pjU0aZ1lwRhi23549verfEen/2CS/f9o80zJiREk+vS0koRYH3tIcve6JoiLSwJu4aUUKpae77kf69brN+Iy1v7ZaEDm1D3JvcFBP67Lk8sWTwKc8O4wEc40ybY80fPEjS3IvzSv6PWScJ3AXEvcP8bhaFjIy1dn5IuewiKPGZzjvvNl5U99sp8X9EZW2FAYfscAfamDlJUTPCsOROL1Odx5i24wUbGZ80PD/+qhV8zpF0vuooZ8PuarFeSuZOwW4INsNHI+2lwRr2odm+VRP//P+6nQP8m6ywX2g819KRFeabGlSqt6Jlbfyv61vrm8UzIBlGy2rVsTnllS3Sge1IUCLxY/bz4xMi1jsvQgCwUq/vxBfYasfXdTfHvSGhHsosTj6T67NEAobcDHyDYng3QaGTy+N5Dg3cekz7DzsMbnOKUqiUdQ9oLSk5dv3Lz7tBdQbzKmZcDkpgWvD9oyozPfKW+9w+YvG28O0yZezyZr263aTywv83CpYeePcn7QKZmNqMvO1A28+MFmou+y2Ua7etGVHP9LfowC/VFA+83CE0LuotiZlg1lXPQ+WADFVvExpHjPRmzNza5sFxqNsns0NheRXMZcxHSIgpBqpYF7yFNnVwQNvlmoDkg0ywiG3Pl6fkaxGoVVTmW6IWqMOWmmbwg3l2mbGagbF/wXRoP7Gj2iaZ50+1MfAeqDH9GSlI5X+w4ff3nnYDlxa4iMLzeSo73g3sK5TPNzCSMsxm2vr63SnhzOwkB2Hz2B9Xq5zDE9mdvaeB9vsUl/n3U5EvvZEgCySmMbzEhGJcF/f8/Y5AHddloki9nyCDnULLhC9xf4ORSHXp5uUwmOo2lhd0whOs9s4Kz5Qk3BosgAZ8gstsPCOtDlZ4uz3Jmeb1L3B5xLaBeRE3Jb+TUHFxhBebaWghzR3AB00AFPloTsRHxhMcAZZTQ6VwWGGBvYIEFG3BtSIBmfFgcMocggZYLFsBwgNUCCsj4casS4JpC+IgWK0uSCBlYuCiRJm7G+MSeO8WLBP4DXrB+mVrOj94Z/zgITJcqxc6DLsViOTuq4WAzOjDrDfMlsayBFtmAiZDywKLRsY8Xg4fAsus0w8wYzHJTyGEkjYHfwU4anhEbrcZsIzXrv8X5ElhEim90RnwMj2AFqwtUmrEsWR+kWABIP6xM8QWw1Bh7bYDPs/8EsI2A97sK/CKxpcv1/g/WYCPgXUQgYZJ1ekXVDEaT2WK12aHoGJikyZAlR54CRUqUqVClRp0GTVq06dClR99mWxhgYTNkxBiHCVNmNevjXbimfoCAhIKGgXVcrhkBgEFAweDBB4eAhIKGgXVcrjkBwCEgoaBhYB2Xa0EAYBBQMHjwwSEgoaBhYB2Xa0mDAaCGQW71mi+0qv8eIV5220GYmgyKyE4C27AKutl5Dh7Yyg0pqGbr/6ug9SdWvQe+eqvASjFH1JIhAAAA'</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">'woff2'</span>),
        <span class="hljs-built_in">url</span>(<span class="hljs-string">'data:font/woff;charset=utf-8;base64,d09GRgABAAAAABZoAA8AAAAAH6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAAAV8AAAABsAAAAckAYbsE9TLzIAAAHMAAAAQAAAAFYdOhoTY21hcAAAAoQAAABAAAABSv+QAe1jdnQgAAACxAAAAAQAAAAEAEQFEWdhc3AAABXoAAAACAAAAAj//wADZ2x5ZgAAAzgAABDZAAAWvEmDa7NoZWFkAAABWAAAADIAAAA2IcA+HWhoZWEAAAGMAAAAIAAAACQPhgWzaG10eAAAAgwAAAB2AAAAdjUJI9xsb2NhAAACyAAAAHAAAABwl7CdIm1heHAAAAGsAAAAHwAAACAAfAB2bmFtZQAAFBQAAAD8AAAB7AGKDLpwb3N0AAAVEAAAANgAAAIwsRGCpnZoZWEAABYMAAAAIgAAACQJTRVYdm10eAAAFjAAAAA2AAAAdioNIKR42mNgZGBgAOKPvadWxvPbfGXQ5mAAgbsGv4KhdAgD29/jHJJsm4BcDgYmkCgAZckMKAAAeNpjYGRgYNv09zjDDg4GBob/zzkkGYAiKIAFAIprBUp42mNgZGBgMGdwZWBmAAEmIGZkAIk5MOiBBAAP7gDzAHjaY2DkYGCcwMDKwMBqzDqTgYFRDkIzX2dIYxJiYGBiYGVmQAcCCOZ/xf9RbGn/0hh2sNQzygEFGEGiAGPYCX0C7ABEAAAAAAKqAAAIAADDAXsBWAFYAaYBsgFQALgC0wGaAS0BogBEAMsBCgGiAQoBUAHfAVAA0QDdAAYA8AEEAZwB9gFIAe4BlgHjAosB3wE1AwoBhQFoAscARgFWAbIBTgGgAlQCBAIIATMBRgBIAVgBRgH8AAB42mNgYGBmgGAZBkYGEHAB8hjBfBYGDSDNBqQZGZj+W/2P+v+fgeG/4n9HIP2I4Q5UPRAwsjEgOCMUAACcYQt2AEQFEQAAACwALAAsAFQAngDWAQ4BQgFyAbIB8gIWAkgChAKsAuQDDANIA34DzgQgBGIEjgTEBOQFFgVMBXoFmgXoBiQGWAaUBs4HDAdwB6wH3ggiCFYIdAjKCQYJNAl2CbQJ6AokClAKggqiCtQLCgs+C1542oVYC1hUZbee9e09e5B0mBlmIDKBYRhGNEQZBn6PeOXiqEhF5MNDaKTo8ZKCmr+RkfkTKYeDWpqgEt4QlYx0fjW8K14SkUNESIiKOpqJSoWXCmYvz/ftGais55zn8WH23s6s91vvete71oyMyGJkMpIuf1XGyRSyQXtBFhplU/Cy+2F7BfnlKBtH6KVsL8cey9ljm0IAR5QN2HOzWq826tX6GOKPgVCEM+Wvdn4Ww9fKaEjZKZlMESd30CuNTAb6XuCt01siOT0nvYKZVJAR2ES2XxULWsrEvMIWsb2FPJdNkgh2uavi41VQjsma+HiNvITG42CJTCYcovF6yXSyQTKZUR8WYQkPMuhVoCdq6WYQMer91VpB4Qs6rZIzUJgItUUVCpw3jGy4cu0uNoMO2znwOHXRlLLZcY20EM2+Y3dagl7Lb8oTQ+w8b3+porS8Akt4FV7Ec3uLRk+b2D8Ji3NPB3p9vSPmn29OCIlX1ULxPCipVckAkp+0CMsFP5kvzdDMCfqAwCBiCdcEmsO8vD0N3CAw+MvUKpk+LFIwTnWvx/YvsfbKkjp4+7f//nZer2mh1tXT8BvcDOkQdGwdlGLlsnkXYPDhBzDn5D9G4h4YOCAAc7ACP8N/JVBOIZlyUE856C3rRxkwO4MbBLWOkiDdBEN3zuRhIYwGK1bhhQqCM8hcyIBPMRnzxLJbhNx6Cd6AiTAJkuowNRNT+RbMwE/wU5wWr6qBkkwoqWH5lVG8XIrXT8qvh0+LnianF9T6SLPaYNKrvPVCv5naLks9z9fzZdrZJjGNJ7zPhAk+ooMnZ2AmFsWr6mBDJhTXqhJwDfStxsQa9LmAUfW0tgA2ipNFcfoypfwe1w90f8KU3xETeXD4xMf7IM//IK6qJ6Set+lmyculgJoGjKmmknGlUKukWFL8l560KAbSOgXSG52C9AMlGKRaUfr8WaWCegplCTcZLYqBh/j3H23+HFvPZ8JnMB30dW5Th6yswrtYAQmgrioQsJM8Hq/Fx4fnvhi1sA5C9sEcOLAEbRCSgNm4B7/A96zpV697jaeQskraC1aan4neKFi5ujN7Okcd/V+9dKWw3iTkprjMzjs283ZxGbsjS+08l8bbyVJ5haoGp2Ziei3rlGpowNAaVfzvtUtIUJ3C+bDqlIrqBkiDTCYPpfieT+M7UeWhDYQ0iKWMTpL6p9ia6u6IjMcNVO95NM7zEo80kFYh8IaAINMIoJL3Ay+zv1rFGS1CXicxmLDr6vHb/ooBzwe+0GdI4lJYwyMVbwKNnn5l7weF/16z2lc/0JJnggPQBvUMgWGEUK4GUowAqnDJKnrB35CkAxO7AGFSo7j1BMbhQ9IkFrAOJgubCLnbQPxuY2gqzUBJWvAm3t35FD00RRvXl15pUCPhbqUa3ElxdU9rXYJjGh8zw7tLfYvnb5HCTp4njbAK5z8dk/ZSvZQH81XFHhrPtzsPjQ+AAZz250lP3wtcoYVjHWKGXRDvjRftpE2s+5E0QQ7REw2s/p5PlaxwMAwlYzsfyknXFG18vFYepUno4nmHCzKd4dU86ZA0ppVqozaAWs6Q1CwFUFNNWztmOAKgj7j7vrsdsrkD+JgVozNJbuwaK/lsqAeN6s4XqSSvcae1fkx75hlWbZlKw/sHalQk0J+HMN5Lo9MS+oCZXUQgVOcAB1OBy8lBEUtQhH3bwKtmwVksx3gsP7vwPHhztTgFjx4+DNGwFWKPHoU+GTX49cFH+PGxYzDv0UEYXJPBeCNSHcoln/d1uoHOTM1dBQaVt/yPKvDnVTyfhq2ko82O5g4CMnGaVP8TMAB88Zx8J7W2Jee/hLmOM7irkmX4IVzPhBvLVQltmPiLlCMOdeX4wlM5eguGgEHEFORK0ezKWQl0uNDz/CVlfpH/J7vfPrZgOHcOa/ayjLdKHKR93r6y9+78xHefJuC36tFvWN/56GX1WXjjtpS+RMhOvHkuW1NY0Vfi4qUn9xRDKRdusnDGBeMhGAQ6SQXWdNwgueFpAwnjdWwA8t7kDgwuP4dZ2CbnJj+YkTp/ti5PozMYwmNCUJT/Is5hU4DYEZT/czJsQtiA5zw5zdFCGINd+zTx2piJMGXwkFF+fs/gqsfMUWcQLpNwM1QJ1VVrLvq5Bw4YOzLC2a+tVCcWyuEAeuPty+m0vN7f5Gn29DJLAzoUBoElXPIHb44ZbYCg03I1NYtLJ5uwGn/Cb+3q2X6bG4/f+GjnidNVax+V5J1L7zXPb1mRrZnLHmWcnJk1obY1H8LxdmJJwaJ1kUOHNWzOPZoydBS2gPuYovyLzN+pZlivebsU45SKkZFi0nMGTzo7BD0OIwSU4gugJASHGWcr5THKmfLyOkyhHVTD9FEDxZlQVofVkIeLWU/V07kRQuP6OXuKDggqiuHgsgVCgWiWtK9NFkVILdbh9YLmzUnETgp+5u7eaL/eQhtM6ajFI2gbW+j4vEEafwkq+sZz9XhbpFMomOurdPqe7Art3xSKpZSwqFNIBteLxU5pEluXiLVNJO8BtEJzKw2r6Zwkr1DSYF0qvl2TQD8vPOlw86Gff9b1+V5/DOF6cfP5CvMW4mYsW4hZFST0NJghtpGMbwIrDDzjDMt3dgmu0CP5k+y8XcP5kxrm/7KfqKepnHO625tdL39EAsHSIpaewXmYeFVsboH7aPiKJH0D+bCxhXjWoGkKUxSxigeUzJ7zyUGKohSrSBRDE3OcuuIpVrAzn150n+up6B+hhJEYLAcijgTC48AWkm+HDfCpnQTLix2nJ907wYq6ATSTuBESgi+5qkmgXEEx1ctSGruPy+tBEomOascvTdcVxj1y7A1L8+S3OJ7hsmE5Zg2Xz2WiGNW51ulRj6nmS/lU6htmyoRaUCjpCZng5d5SZ9JNMIiJPjIiku2oAR5AH5uYjXjp1OyN8n5n59hKcrPfqITzhlHLUl975gJ2bTqc2Hhg/yf/tSN3iV9f6zgPA3jX3vgmODSoGfIC9SFLpqfNHDvQf1ba5KMf5yYvndvf5BO9Z5ll6txR763efx6FqXHS2az0bOlCLj0bnaCgZgKVziBw6ghzGNty6FEURmoZFrXJYvQmzQUnd33XYEsuTt768BL0w6a79iIlLrvCX4dMI5cuvrEU+JarP8fAUszeQ7XbiT/jmbJVSqumfT1vchtjds7PdorrRznxY9pgq3DPJswoCQV6BCXRaWU0+Y6QTXh4Fz7esBWete14HKQb3T+sj+GV91/b8o4VuHPfXw9pzgf3Lz4HRd7q96xhw7KCRr9dmdmEv7L81lGcPTS/3mybM6rpjh1AusnXyU2SbzPPNod5S/lxcsPE4skVLfW210qAu4JZ/LYHsyvzEj56sO7GmuuwwCA0kTXjRqPj8pWfo0M1VmVhxcSV331ggz75O0kSSw+rGK6d4uppfr1kRpcXS6yCN9slB3G03MTM3Feh9+XMYaSU5A7Uf1G4vYnrHzL2QeGUiqLMUVO3X1z0A/AejtXci+8XT7pHMkKHr/jiulgeMnPOoNdXnFyQc2llguNY3LAF+zOGsr0tn+q0SLBJiJEj2D/Gp9ZJKFOdQq8zqrWezsHoAwaS/8Mz02aNr56RtMDDMigodmhIesKEMTzsxGQeVOKiU/z3fLDq+KNXh1lCggcOCXjB77nYcReqZmuQ5CJqrFZVDghE+r7ViryQIWnch+0y0J0w5Rr0AaZuxVvCPXVGLx07k+sZ+w6mJAb/QEt4RGRQ9x9aDiN3e0nR+neWFK6j/lo4Z+J/WC5d+O5OKdoT7nydnxZq+M93IRlyXl7/y0Z8gg+nJc2d+MqGH74+8k9qUkd2fLiirGzFhzswxCckcdj87PyMT/jEt4TJy0u/Dn0hqv+osfhw4vI5I7Yue/nd4Kh3Yhb8Y9bx0rpk1usWyuEZqpegbs+KGA4sEYVa6xydGmcfcGqJ3X6gFdwPi40H+IXZDef5SrHhiPwGzDcK2Xdyt/07WUUpattUV1Zgwz2b2tgdDHjd2QXU5uPfm3aksW0T60POne7c+UIW5Y99ewpwcsCI8uw5BR0jDFfLjxwybtyQ8LFjLXZx6U1euAzZfXl5fmx4WHR0mCWms15rtWrbNs6p382PHqPGG3hio9OHcsWv5H0ljOA/YwCLqyIKyYjoM7aah0VQ/VjUFJUvGTxhwuDwceNwEyx5XhgSl4uO9Tc9xyX29YqJSS4a3N/XrZnBD4lh8JjDMMX7eAXbUvZtzYxbl9LvlZfH2I/SNe8SL/X+TLazUY6fd3IMChe1Ed3UugaDvKYVy3BxDTkkNhzmb8Aio0Dca0nwXTyRqrWSSUeuTWWUtm/sZtRRDXfV0dFqbGY45CvKqR/F8eipZTeAlp9yUqw6KVyHtwyCVKXTZ3qC2M7Q2UXdUdFM9RzVs4/TQU5lwCreUxL6QOgRRneJ/ICpt1sdCuM+sdUmv7plpSDfI97aw7fGfzqK3yd+X8ELNojtK2y89GBEauWsXbukY0Dg9GsQsGWQBafjZad67oFXSiKWO+XTtmnRt5tYWSsbGzKnHau/t4nyOYlplp7V9BfNutY9Tc/R/ka0jN0jckUlWH0Vf1Utti92yXbRvuMM+HS3aAnYqMclUFwPtkk59/sRJMyXSNs+3Yz9iYovxUr8ZUva9oZ7DdvTtogbYMG3jbi60ZgD7vtXXC2Ijy+4umI/Po4EBVyiC/ZjDHJqNUFsEWZLfmL681wyef8+l3TdS76kU4uRtBYc/fxiPR1OU4TSDjadvm278QkBDzHtCu9WB2nO+cRdpvPp4yJb93Qq3Yd3sjXjx6s6i0n+jY9ols4zbKZnONZ9BqM6qGd0QLciXOODebl3JNOVPCTvwN7W+n2vFYPiiriwk9/205sH8xJeXVu98P66mWY6PEqzEJuvPYgWd6vGj9cAyamtSFjdnPvB5bUv71zXB+sdFcuYdpNoTROc8xE8fzdy5uOu7aZHcJy917hbC63puhGRoycHli/jQSu+ZOfdGmEOPxI78rYOCAyLGqKJrMWNbV5xcdr29Yt+yOfHRkk9wj9pkdspTpC0j1NH5hmI2btnHw90urHCYHLZOWf7dddq/O3J4+tkrmlVTYktc811rH7Udu673nP1761dt20uyQ8JKM4q3J/huDZyfvqLs/oFD3u4qnRKyxHzjOTx06V9jbhR3HJ5AZ0WbP7TCRUZTqtooN916YbFppQ0ovP9Pqo9vIOQ79uGLxagDFPezEjMKopYfrDSe6YJfqS6TMLy2XQJXP0vg3MPNFNN2vg4l7fII9m4DWJfoKW2p0EjXWP+3llcTtIblp6v4vhamPWc28q8I4cuwOy+blT/vevmvVPdQWJ7j+nng8dx2/aPj5Oq3mP86A3FiHvSIZzkI/9m9xZOfomhU9Fylkyogjchg74rWu3w4O7roqN1jqPcWHU09RYr3d0P0c//X7u34pAN1ybjMTyTjHl7SPBB8ADNCfaqA00lHxnr6fDksh053I/q2Fi14yHn7tnzynhgv/2VU4z/Z/eW3z4l1qzHWjy8CQ0NkIsFx0jIBvAGQxHU12NJCh3ySrrKLVMyE7BBs0dsrAeWQgpDxflOzuPEaqGDYjl/55F+LQsySWNkBIyEP7DT8ZX4U9rdLZPeUjxrjYtJmrl6dDD6NZGUU7AYlpxiXHUtbKyMCBsRHGIs+vh1/lmJtp1cKqWN4jhoTn4U5/c9XGGS9nD5oenqrnbOIs4anK7kOhyNZDckYsVw7stf3cA83BFPj/m//ZUjAAAAAHjarY+xasNAEESf4tgkBFKkSJFKkJBOQj4wOC4CxiBcubDAvSTOskBI5ix1+a/8WeqMHHVpXPhg2dmdudld4I49Hv274Yn3AY/45HvAYx68xwFPePUysd7tvfRvZ2WPR3zxMeAxz/wMeELsvbDFUtBRkeIIWAodOajKxLSU5LC1RVelLlhWx0Oa2bZUL6ahlqDPThYWH0NIpLxQJOp3YnIxa9nV6ljVpY5asdGoS0b/ec3EzhVG7oaphjd1GzeusL4JI3/hJ03ncrtO68S6cr/aBP83lmoWzAMTGf3fnVc5aUR/hC/LfnF21p3KpvanoYrrHMAFq/ELCWhcDHjabc/HTgNBFAXRriGYnHMyOQePPd1vWBown4LEhh3fDwhqSUut2t2jl6r0+75Sekv/vfj5pIqKMcaZYJIOU0wzwyxzzLPAIksss8Iqa6yzwSZbbLPDLnvsc0CXQ4445oRTzjjngkuuuOaGW+6454EeNX0GNOTO58f7aNi09tEO7ZN9ti92ZF//mnu2tn07sI3Vy8WG1c/6WT/rZ/2sn/WzftEv+sW94l5xr7hX3CvuFfeKe+FeuBfeE94T3hPeE94T3hP6oR/6oR/6oR/6od/qt/U3rrx+fgAAAAH//wACeNpjYGBgZACCq0vUOUD0XYNfwVA6BAA/sgZfAHjaY2AUYGCR/MPGsIOD4e9xRj+2TQwMDIwMyIAFAHYyBMEAAHja42BgDWUAAg4IzgJCdzCJoLOQ+O6Y4kxc/x9C8RYQ/f8tED4E8ZEhw00mBSZ9GAQAm3Ab5wAA'</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">'woff'</span>);
    <span class="hljs-attribute">font-weight</span>: normal;
    <span class="hljs-attribute">font-style</span>: normal;
    <span class="hljs-attribute">font-display</span>: swap;
}
</code></pre>
<p>截取Base64的部分</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@font-face</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'MyFont'</span>;
  <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">data:font/woff2;base64,你的base64字符串</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">'woff2'</span>);
  <span class="hljs-attribute">font-weight</span>: normal;
  <span class="hljs-attribute">font-style</span>: normal;
}
</code></pre>
<p>截取后通过JS解析（可以直接在浏览器端运行）</p>
<pre><code class="hljs language-ini" lang="ini">// 解码 Base64 为二进制数据
function base64ToFont(base64String, <span class="hljs-attr">filename</span> = <span class="hljs-string">'font.woff'</span>) {
  // 移除 data URL 前缀（如果有）
  const <span class="hljs-attr">base64Data</span> = base64String.replace(/^data:font\/\w+<span class="hljs-comment">;base64,/, '');</span>
  
  // 解码 Base64
  const <span class="hljs-attr">binaryString</span> = atob(base64Data)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">bytes</span> = new Uint8Array(binaryString.length)<span class="hljs-comment">;</span>
  
  for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; binaryString.length; i++) {</span>
    bytes<span class="hljs-section">[i]</span> = binaryString.charCodeAt(i)<span class="hljs-comment">;</span>
  }
  
  // 创建 Blob 对象
  const <span class="hljs-attr">blob</span> = new Blob([bytes], { type: <span class="hljs-string">'font/woff'</span> })<span class="hljs-comment">;</span>
  
  // 创建下载链接
  const <span class="hljs-attr">url</span> = URL.createObjectURL(blob)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">link</span> = document.createElement(<span class="hljs-string">'a'</span>)<span class="hljs-comment">;</span>
  <span class="hljs-attr">link.href</span> = url<span class="hljs-comment">;</span>
  <span class="hljs-attr">link.download</span> = filename<span class="hljs-comment">;</span>
  link.click()<span class="hljs-comment">;</span>
  
  // 清理
  URL.revokeObjectURL(url)<span class="hljs-comment">;</span>
}
</code></pre>
<p>比如上述的文件</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">base64ToFont</span>(<span class="hljs-string">'d09GMgABAAAAABEcAA8AAAAAH6AAABDAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP0ZGVE0cBlYAgkoIBBEICq08pBwLcAABNgIkA3YEIAWDbAeEMBckGHYbiRkjkpPaFpD9ZfJgDD3UkS0ShGvVBPNHa81DfmMfdiJsq+ZWNXkwlSw2Sriib3gwX8v+zJn/nmynWVkuMkpyoJhNGbIqOHYxMO2901tPgB+QZLtMh8tnC7fN8NsjpqGSEymBKlw65SM//3UMhqe5/bvdBhjzdtvoUjZgVI4RJx4H/RHJkSU2NjrJkCr1C0r4MZP6I2r07PrB9/Pw3+17d6Zmpv7kkaSSWJTyAq6udc7q2DBWxlGI/3/XysrM7v4jcAVAYatqfI3JJEtJbmaBMwdM2SIJVSMJWO6pvuqyq9AVhoyrMnWyFbKXbXaLpCIWUyxAp88TmwIA2Ajh2R7J+Yw7A/9aUs5hcj35FFjQfYjxA2B7+LxGDGtIYwYELAOm+Q1d4/9RUGv+W+Nd8xC2d0LAMEZG2wdtqkBUaELPwgSYXcn/C8IE4x7KHsJtZQmY0PU7t5w81WrEmvB/CNhHaFvQrIzE6Vy6TUsa/QUEqWlGNslRLpANkTw70zip4mvFN8I0jYYuWvU67Jr1SNo561OEborRee5i8MumJPREPujCbTZQnx0RujZ4j8BGWzTDXrUcd9iSpxoUck4N29tgQ0FAfXQz9VOHqypbOeUYixFlvmLXyRVenrKuwUniaR6G4Ok3Rvm+o9jAQEplpzQrPYxuYvHWI7scijTNRBGtPCb+E6fsbrWrz4zgKaOagF/XoPqE+I+ZpNn4EsAm80vU16SBaxMq6/uigZrZHcT0wBShoQr4dQCtqd2q4JlTRZ6sMxZlDhVHbrntNNQQaAAM0ejkFlESrvI7B4/r+7QUydOf2OWPOonQrhpBJoeK70Ab8sZCoI5GvlgKkRSHina9ZVj7aN0+0MfVTkE51HIFvIDNTq7izfPHqMnh3/6NB9VHt4KbDyv315YfhDfAu36/8rCyv1L8SDFNwC7HGOyjgRxUfeDfV2tXEJqWomVERmDYmriOKb4ScdTLA8a0EId8rMxcuvb5+99HtOoLLTxyyQblB+Bp/lX4U3h1kBLh8kzg3WcVmbXTod1asACeVWIxjluDlmqiJQ1emEFflEzUeuhl+FBWxbEy4T9mYZlYVdp1b6jYcMuoJ5GlJxQXLahrZeTcuyMi1kFo4wZSaP1GaFun9oHndOs6PI3R5b+GKZptAvsaKUNzrcErQmjVqAqwNCsVo8GNXSyiAOc43rnmZAiEK6hMLym5XGdIfCHdu4GWJM+NBmGNxNpRatzz4c5IDOTvnaUocYOeTFZWFBnXXVYLWCmbSedGcVBY6s2pvQ3KnzgoLozTLOoVnpFYBDo2jAEJhLl+0kpPtPOEHMH5o0szjDuQI156VdeQFlURckakS7ialeSP5SWYyQpyoV/TLOvDT6VTJU/7CFp5iMXYjbYkoKLaug7HWCXFxBMt21ncUIp4MBnAU5Sb6PQVZkxyoF4qg+Ufqkz/Oq9uop+JcEhJAmiI9lAC2AbuAOJIYmdfS0IwvF52JsSAlvgZAC99Z4+F9lQNggtbnmCTFAp8j5h7wv58Amnti3L7P9T119Vbwc3Kdb8zrCMFbfnUqLCM7KWsiJvrzdOoujMp3GkFEWlnvF9jMplFwTPhQCGePp1SJm0BRQ+bqJhTOZehGmTW66IzokHRzdopB3KmZaSsla5mGCtiouNCrnXZjH0vY00esey1azJWr0UOz0tQ08HObzSpN0Zbu8Zo/5tdn8tsow4NpoIlOm7+6W6dBV71SDW7y9de77/Nfj8WETwTFyHtZ3dXdopQnI6LUPX2hmxgnOblMLHQ1XZuueutLh/1o9FJ+pbIvamL1Vwd/na8UZcD/ObpUTl9925ovpIW/dnprJ0VlJjrPm1wagIXI/BwXUoDPCxGAN+7jb/OTXiYPsBJXhjaZ3jt62jC7tt/509YJNtLeUayN7vpF6lHssMO+PhHZuvcrPAAXz2ruG7hHgF2vqbd0GhbWpt823xyal1xYmRn3e4g/BkCDTakNUCDzxAQMRYXx4gdwoUIPHo6rQ4eFiJEByMpQUehCX7cTZYb3PZym9wQ+T4sfABCK851Y9DatfAPuNz42nX48UsUT8eFprDaW0EleplJ8SCj94f7FQa87lryIeKbTVOXWsaT0VSD/sRzl6LVR/dJevCNDAo87kp7H/Xy9jiC3s13i1qirFCk3cHOnO6nc1SHj0H8UB0s9ngifAwe1G/Mp17jNEEcIsjld4vCi7ZMfNMKfL53j8uh8S7BuBCFHnMiYcdgEFexRvzNSk3dYo/GMZ1Kcu/SrRelqkXJxUpaV+8bCbx1DpX98QYWshECRIcHTyJ4KH6LekW0QVEa6pyOrhQjsFsSxFQik5ie3cvuUxy/rirxAhW+B1HqRTEyhR/xZ1zomVVF/H0zIW2wcAokrgR/RvASXIxQDK3c1F02uqtPkYBWy2sGbox/YABt22mUOKbBXFPXWismnku1qwM7c9YI9BIB5XyM3XPtKxtR3A9/hwKKYYMYJbJton5Ur0MIoFQ20nLUiXSVT7q6x6MCZ9L1i1/v29gqnTI4mG545fuDZP8b/Wu8/0X4fiXD8MmgTApwpZxRh0bb9n95I34ykKw0YfPlN2jgfxSvx8UonLOaJoZPiBHi9mbl190WP0zfs1uAhapjefj5PTfc0vfaFpO8HtFMH1wMfzkyWxyn+kyY4vlH7w8UoBsqf+/K89mvANhldKNzj65XOZ2UIf9nNol/QfFoRnB6PI+JC0JUHQ3Z9rz1LDid/P1HiFe01cWi4TQYiv6/lnj6i/r4btnI1G0VeXdNeX3XBm1g25c96LBLqzU4OFVnz7YR8yWagTiXZpKgItfoPXVrtb4gq7ii0/yW5T3rO+NNOWXXv21vOPXIMtJBSitFZd1hbnXvbFXeNOBLn3sAjXak1UGDVBSfxKkoNFiX1gGNPtAyT6AK/BwBVRAHMqbWiGGqibORh2rBrGtjpe+/XRN10LAYIQqITwjJyHJM/s2a+MMKVV9RRCVAVvsaMY1qSJ/br2nWPU0lThFfEOVvn9ryD0soAY5UrBEPUdmsc5ky5H+k2/7JlMvq7qIShsQ9hGF6h+l3ZxIh3IlphHn8Hr3/zn2UAJFeoSIUD8bvIyVuXVsXqbguLqK+y124/BAh/Igxaq7daRsRQjCIQWT2AIj8XqecaRvwjnwLQvE7OITCNfQAZV97EULkEWJqzWrdohgl9AkQ8flkOPPEqJ2Df7KnsXk4XdDs6OCflA28hXOnHmgmqPUY1O+LDj8emx0x4Ppks6FD3JHgoLD1wUPXKY1XS3ICvQ9OJl3S7dcpl+NdPHW4M2efqUqEQhK29aNGtkzRiHisf/Afvp6LoQ5glUU15h+8c3YGnl8a/9QbWMv77eCx5gvfREpGEoie9dunVe3UwoNUbAGF39forkg6pXK4IExtdbhh1uXsutyadRe6miVkBb2d34u0s5luXD10UGOPj/bhHU2Oe3e7DaTNkCQfvwA+RjNlOFbrGNItghcWhZ96d9Q7kdgLKHaCCle2dH1NGMAFBR4zx3uLN37JrRSXdvqtSDqlc9QpdqA1JWfLJjtBd3dV+/QK52jAsGvsl4Sq0C5WVWjqSYfbGcci5toKpjyyXsH/3nR9k0ZKJ/oPpdRaBrwDev36L5H1N/nf4vy2Wj82jfFLN3i1xZGt46yeNxop7+HsjnGH4DtnEjrRXzkwhKBYHnYXgY9KgBfs06/vr+o4Iahu37e/sl1woqJDMB6fiMvVmXrbpM8dGJ59lZtasd7ZZ6cSxSP4ZNurP4V5Yey3W/QcY1wPBB7b6OF1ojrhh10ttKH5iDd/v69eks0+Zzzdx6Im7lbby1Hh9azfOB4gvCnwKoJtwS4h8OvGPzsy8rMnnvR4NcKvBxCMhV1DyPphuquSTmkcLoXXfyD7FT+ntffa1JtGwPueZ4w5m3IwJ2NTVyeOmSsP9jcUM7Aj2FMG/Lo2cYzy+zzMPcBtgpUda8HW53lG7s6mxu48I1NMMPUYL/zAPu5FijJD00jaZfvxPnLN0+Y0ustWH4UK6e08JefAKh9DL12usvhGf6vk3CwMgi8GLzGwIIH/4LUVKOJKYHOvIvD7WtvOi1usezNM4+nz3tAcdIDLSuBtut8e20rKvQed5XVlctQpPOIByPAK7EMwdawHIWtGr2gsNRc0hZj9iiZrXkAwRexCDaz5TmYZr9vu4B2A+qQC1kX4tmRNUhp6YK4zt4kycHpS9NVufEfqAD/+7JkbY+8aq3AWHdp15ZOy+iVuDsBcN65Q4t7g4u6O2pjU0aZ1lwRhi23549verfEen/2CS/f9o80zJiREk+vS0koRYH3tIcve6JoiLSwJu4aUUKpae77kf69brN+Iy1v7ZaEDm1D3JvcFBP67Lk8sWTwKc8O4wEc40ybY80fPEjS3IvzSv6PWScJ3AXEvcP8bhaFjIy1dn5IuewiKPGZzjvvNl5U99sp8X9EZW2FAYfscAfamDlJUTPCsOROL1Odx5i24wUbGZ80PD/+qhV8zpF0vuooZ8PuarFeSuZOwW4INsNHI+2lwRr2odm+VRP//P+6nQP8m6ywX2g819KRFeabGlSqt6Jlbfyv61vrm8UzIBlGy2rVsTnllS3Sge1IUCLxY/bz4xMi1jsvQgCwUq/vxBfYasfXdTfHvSGhHsosTj6T67NEAobcDHyDYng3QaGTy+N5Dg3cekz7DzsMbnOKUqiUdQ9oLSk5dv3Lz7tBdQbzKmZcDkpgWvD9oyozPfKW+9w+YvG28O0yZezyZr263aTywv83CpYeePcn7QKZmNqMvO1A28+MFmou+y2Ua7etGVHP9LfowC/VFA+83CE0LuotiZlg1lXPQ+WADFVvExpHjPRmzNza5sFxqNsns0NheRXMZcxHSIgpBqpYF7yFNnVwQNvlmoDkg0ywiG3Pl6fkaxGoVVTmW6IWqMOWmmbwg3l2mbGagbF/wXRoP7Gj2iaZ50+1MfAeqDH9GSlI5X+w4ff3nnYDlxa4iMLzeSo73g3sK5TPNzCSMsxm2vr63SnhzOwkB2Hz2B9Xq5zDE9mdvaeB9vsUl/n3U5EvvZEgCySmMbzEhGJcF/f8/Y5AHddloki9nyCDnULLhC9xf4ORSHXp5uUwmOo2lhd0whOs9s4Kz5Qk3BosgAZ8gstsPCOtDlZ4uz3Jmeb1L3B5xLaBeRE3Jb+TUHFxhBebaWghzR3AB00AFPloTsRHxhMcAZZTQ6VwWGGBvYIEFG3BtSIBmfFgcMocggZYLFsBwgNUCCsj4casS4JpC+IgWK0uSCBlYuCiRJm7G+MSeO8WLBP4DXrB+mVrOj94Z/zgITJcqxc6DLsViOTuq4WAzOjDrDfMlsayBFtmAiZDywKLRsY8Xg4fAsus0w8wYzHJTyGEkjYHfwU4anhEbrcZsIzXrv8X5ElhEim90RnwMj2AFqwtUmrEsWR+kWABIP6xM8QWw1Bh7bYDPs/8EsI2A97sK/CKxpcv1/g/WYCPgXUQgYZJ1ekXVDEaT2WK12aHoGJikyZAlR54CRUqUqVClRp0GTVq06dClR99mWxhgYTNkxBiHCVNmNevjXbimfoCAhIKGgXVcrhkBgEFAweDBB4eAhIKGgXVcrjkBwCEgoaBhYB2Xa0EAYBBQMHjwwSEgoaBhYB2Xa0mDAaCGQW71mi+0qv8eIV5220GYmgyKyE4C27AKutl5Dh7Yyg0pqGbr/6ug9SdWvQe+eqvASjFH1JIhAAAA'</span>)
</code></pre>
<p>解析后浏览器自动下载了 font.woff 文件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24328eee3ffd4100b9a84b815e768ead~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5bCP6buR5bGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768372793&amp;x-signature=K%2F%2F%2FXC26MTD8mRT12DCHl7H3%2Fuw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">查看字体包的 Character set</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwakamaifondue.com%2F" target="_blank" title="https://wakamaifondue.com/" ref="nofollow noopener noreferrer">Wakamai Fondue</a>:  Drop A Font ! 只需要把 <code>font.woff</code> 文件传上去，即可查看字体文件对应的字符集（如图）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a19f32eb0b5445a1bd5c483301b0de3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5bCP6buR5bGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768372793&amp;x-signature=p03Z64le%2Fn2yBib4MzcHHKo15LY%3D" alt="SourceHanSerifCN-Regular from 1.0 css.png" loading="lazy"/></p>
<blockquote>
<p>从图中就可以查看到对应的字符集包含哪些内容，更清晰了解到哪些字体不在字体包内。</p>
</blockquote>
<h3 data-id="heading-2">字符集说明</h3>
<p>需要注意一点，字符集对应的编码是【十六进制】</p>
<blockquote>
<p>如上图所看到的字符 【A】 对应的编码是 【FF21】 （说明是个特殊字符）</p>
<p>这跟我们平时键盘敲出来的字符A是不同的，键盘 【A】 的是 【0x41】 （如下图所示）</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a90f8f84f2314adabe3b7356e9216a21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5bCP6buR5bGL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768372793&amp;x-signature=YJnrW5fVX0G42I4K7RMhll%2Bg710%3D" alt="image.png" loading="lazy"/></p>
<p>要确认清楚字符集的对应，这样才能更好地了解清楚，避免错认。</p>
<h4 data-id="heading-3">大写字母A-Z编码</h4>







































































































































































<table><thead><tr><th>字符</th><th>十进制</th><th>十六进制</th><th>二进制</th></tr></thead><tbody><tr><td>A</td><td>65</td><td>0x41</td><td>01000001</td></tr><tr><td>B</td><td>66</td><td>0x42</td><td>01000010</td></tr><tr><td>C</td><td>67</td><td>0x43</td><td>01000011</td></tr><tr><td>D</td><td>68</td><td>0x44</td><td>01000100</td></tr><tr><td>E</td><td>69</td><td>0x45</td><td>01000101</td></tr><tr><td>F</td><td>70</td><td>0x46</td><td>01000110</td></tr><tr><td>G</td><td>71</td><td>0x47</td><td>01000111</td></tr><tr><td>H</td><td>72</td><td>0x48</td><td>01001000</td></tr><tr><td>I</td><td>73</td><td>0x49</td><td>01001001</td></tr><tr><td>J</td><td>74</td><td>0x4A</td><td>01001010</td></tr><tr><td>K</td><td>75</td><td>0x4B</td><td>01001011</td></tr><tr><td>L</td><td>76</td><td>0x4C</td><td>01001100</td></tr><tr><td>M</td><td>77</td><td>0x4D</td><td>01001101</td></tr><tr><td>N</td><td>78</td><td>0x4E</td><td>01001110</td></tr><tr><td>O</td><td>79</td><td>0x4F</td><td>01001111</td></tr><tr><td>P</td><td>80</td><td>0x50</td><td>01010000</td></tr><tr><td>Q</td><td>81</td><td>0x51</td><td>01010001</td></tr><tr><td>R</td><td>82</td><td>0x52</td><td>01010010</td></tr><tr><td>S</td><td>83</td><td>0x53</td><td>01010011</td></tr><tr><td>T</td><td>84</td><td>0x54</td><td>01010100</td></tr><tr><td>U</td><td>85</td><td>0x55</td><td>01010101</td></tr><tr><td>V</td><td>86</td><td>0x56</td><td>01010110</td></tr><tr><td>W</td><td>87</td><td>0x57</td><td>01010111</td></tr><tr><td>X</td><td>88</td><td>0x58</td><td>01011000</td></tr><tr><td>Y</td><td>89</td><td>0x59</td><td>01011001</td></tr><tr><td>Z</td><td>90</td><td>0x5A</td><td>01011010</td></tr></tbody></table>
<h4 data-id="heading-4">小写字母a-z编码</h4>







































































































































































<table><thead><tr><th>字符</th><th>十进制</th><th>十六进制</th><th>二进制</th></tr></thead><tbody><tr><td>a</td><td>97</td><td>0x61</td><td>01100001</td></tr><tr><td>b</td><td>98</td><td>0x62</td><td>01100010</td></tr><tr><td>c</td><td>99</td><td>0x63</td><td>01100011</td></tr><tr><td>d</td><td>100</td><td>0x64</td><td>01100100</td></tr><tr><td>e</td><td>101</td><td>0x65</td><td>01100101</td></tr><tr><td>f</td><td>102</td><td>0x66</td><td>01100110</td></tr><tr><td>g</td><td>103</td><td>0x67</td><td>01100111</td></tr><tr><td>h</td><td>104</td><td>0x68</td><td>01101000</td></tr><tr><td>i</td><td>105</td><td>0x69</td><td>01101001</td></tr><tr><td>j</td><td>106</td><td>0x6A</td><td>01101010</td></tr><tr><td>k</td><td>107</td><td>0x6B</td><td>01101011</td></tr><tr><td>l</td><td>108</td><td>0x6C</td><td>01101100</td></tr><tr><td>m</td><td>109</td><td>0x6D</td><td>01101101</td></tr><tr><td>n</td><td>110</td><td>0x6E</td><td>01101110</td></tr><tr><td>o</td><td>111</td><td>0x6F</td><td>01101111</td></tr><tr><td>p</td><td>112</td><td>0x70</td><td>01110000</td></tr><tr><td>q</td><td>113</td><td>0x71</td><td>01110001</td></tr><tr><td>r</td><td>114</td><td>0x72</td><td>01110010</td></tr><tr><td>s</td><td>115</td><td>0x73</td><td>01110011</td></tr><tr><td>t</td><td>116</td><td>0x74</td><td>01110100</td></tr><tr><td>u</td><td>117</td><td>0x75</td><td>01110101</td></tr><tr><td>v</td><td>118</td><td>0x76</td><td>01110110</td></tr><tr><td>w</td><td>119</td><td>0x77</td><td>01110111</td></tr><tr><td>x</td><td>120</td><td>0x78</td><td>01111000</td></tr><tr><td>y</td><td>121</td><td>0x79</td><td>01111001</td></tr><tr><td>z</td><td>122</td><td>0x7A</td><td>01111010</td></tr></tbody></table>
<h4 data-id="heading-5">0-9的数字编码如下</h4>







































































<table><thead><tr><th>字符</th><th>十进制</th><th>十六进制</th><th>二进制</th></tr></thead><tbody><tr><td>0</td><td>48</td><td>0x30</td><td>00110000</td></tr><tr><td>1</td><td>49</td><td>0x31</td><td>00110001</td></tr><tr><td>2</td><td>50</td><td>0x32</td><td>00110010</td></tr><tr><td>3</td><td>51</td><td>0x33</td><td>00110011</td></tr><tr><td>4</td><td>52</td><td>0x34</td><td>00110100</td></tr><tr><td>5</td><td>53</td><td>0x35</td><td>00110101</td></tr><tr><td>6</td><td>54</td><td>0x36</td><td>00110110</td></tr><tr><td>7</td><td>55</td><td>0x37</td><td>00110111</td></tr><tr><td>8</td><td>56</td><td>0x38</td><td>00111000</td></tr><tr><td>9</td><td>57</td><td>0x39</td><td>00111001</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[发现一个宝藏图片对比工具！速度比 ImageMagick 快 6 倍，还是开源的]]></title>    <link>https://juejin.cn/post/7592382702943600686</link>    <guid>https://juejin.cn/post/7592382702943600686</guid>    <pubDate>2026-01-07T06:52:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592382702943600686" data-draft-id="7592170706025938979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="发现一个宝藏图片对比工具！速度比 ImageMagick 快 6 倍，还是开源的"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-07T06:52:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Immerse"/> <meta itemprop="url" content="https://juejin.cn/user/2708812817761752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            发现一个宝藏图片对比工具！速度比 ImageMagick 快 6 倍，还是开源的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2708812817761752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Immerse
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T06:52:29.000Z" title="Wed Jan 07 2026 06:52:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 Immerse，一名独立开发者、内容创作者、AGI 实践者。</p>
<p>关注公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com%2Fother%2Fwx_public_account.webp" target="_blank" title="https://yaolifeng.com/other/wx_public_account.webp" ref="nofollow noopener noreferrer">沉浸式趣谈</a>，获取最新文章（更多内容只在公众号更新）</p>
<p>个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyaolifeng.com" target="_blank" title="https://yaolifeng.com" ref="nofollow noopener noreferrer">yaolifeng.com</a> 也同步更新。</p>
<p>转载请在文章开头注明出处和版权信息。</p>
<p>我会在这里分享关于<code>编程</code>、<code>独立开发</code>、<code>AI干货</code>、<code>开源</code>、<code>个人思考</code>等内容。</p>
<p>如果本文对您有所帮助，欢迎动动小手指一键三连(<code>点赞</code>、<code>评论</code>、<code>转发</code>)，给我一些支持和鼓励，谢谢！</p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c3a21fb824b4c3ea23957e373444b72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768373548&amp;x-signature=i9961AIV4RyGU5pDq3pxq41VxzY%3D" alt="" loading="lazy"/></p>
<p>今天给大家分享一个超牛的图片对比工具 — Odiff。</p>
<p>不仅速度快到飞起，还完全开源免费。</p>
<h2 data-id="heading-0">速度很快</h2>
<p>官网拿它和常用的 ImageMagick、pixelmatch 对比了一下。</p>
<p>完整的网页截图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adc8b6935abb4948a20f19067162cef0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1tZXJzZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768373548&amp;x-signature=OISTrCurhbgL7LrXgUqnwapBIO8%3D" alt="" loading="lazy"/></p>
<p>ImageMagick 要 8.8 秒，pixelmatch 要 7.7 秒。</p>
<p>Odiff？1.2 秒搞定。</p>
<p>快了 6 倍不止。</p>
<p>更夸张的是 8K 大图对比：</p>
<p>别的工具要 9-10 秒，Odiff 只要 2 秒。</p>
<h2 data-id="heading-1">技术方面</h2>
<p>Odiff 最早用 OCaml 写的，现在用 Zig 重写了。</p>
<p>支持 SSE2、AVX2、AVX512 和 NEON。</p>
<p>直接榨干 CPU 的并行计算能力，一次处理多个像素。</p>
<p>难怪能这么快。</p>
<h2 data-id="heading-2">功能很全</h2>
<p>快归快，功能没缩水。</p>
<p>跨格式对比随便玩，jpg 和 png 直接比，不用转格式。</p>
<p>支持的格式也多：png、jpg、jpeg、webp、tiff 全都行。</p>
<p>抗锯齿检测、区域忽略这些高级功能也有。</p>
<p>用的是 YIQ NTSC 算法，判断视觉差异更准确。</p>
<p>不同布局的图片也能对比。</p>
<p>输出结果很详细，差异像素数量、百分比、对比图都给你生成好。</p>
<h2 data-id="heading-3">上手超简单</h2>
<p>装个 npm 包就能用：</p>
<pre><code class="hljs language-bash" lang="bash">npm install odiff-bin
</code></pre>
<p>然后直接用命令行：</p>
<pre><code class="hljs language-bash" lang="bash">odiff base.png compare.png diff.png
</code></pre>
<p>第三个参数是输出的对比图，可以不写。</p>
<p>如果你想在 Node.js 代码里用，也很简单：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> { compare } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'odiff-bin'</span>);

<span class="hljs-keyword">const</span> { match, reason } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">compare</span>(<span class="hljs-string">'path/to/first.png'</span>, <span class="hljs-string">'path/to/second.png'</span>, <span class="hljs-string">'path/to/diff.png'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(match); <span class="hljs-comment">// true 或 false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason); <span class="hljs-comment">// 不匹配的原因</span>
</code></pre>
<p>返回结果会告诉你图片是否匹配。</p>
<p>如果不匹配，会给出原因：是像素差异，还是布局不同。</p>
<p>还有差异像素数量和差异百分比。</p>
<h2 data-id="heading-4">还有个服务器模式</h2>
<p>对比大量图片的话，推荐用服务器模式。</p>
<p>Odiff 提供了服务器模式。</p>
<p>它会启动一个常驻进程，多次对比都用同一个进程，省去了启动开销。</p>
<p>Node.js 里用起来也很简单：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">ODiffServer</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'odiff-bin'</span>);

<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ODiffServer</span>();

<span class="hljs-keyword">const</span> result1 = <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">compare</span>(<span class="hljs-string">'a.png'</span>, <span class="hljs-string">'b.png'</span>, <span class="hljs-string">'diff1.png'</span>);
<span class="hljs-keyword">const</span> result2 = <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">compare</span>(<span class="hljs-string">'c.png'</span>, <span class="hljs-string">'d.png'</span>, <span class="hljs-string">'diff2.png'</span>);

server.<span class="hljs-title function_">stop</span>();
</code></pre>
<p>还可以设置超时时间，防止某个对比卡住：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">await</span> server.<span class="hljs-title function_">compare</span>(<span class="hljs-string">'a.png'</span>, <span class="hljs-string">'b.png'</span>, <span class="hljs-string">'diff.png'</span>, {
    <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.3</span>,
    <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>,
});
</code></pre>
<p>服务器模式还会自动根据 CPU 核心数并行处理。</p>
<p>多个测试用例同时跑也不会阻塞。</p>
<h2 data-id="heading-5">集成也很方便</h2>
<p>用 Playwright 的话，有专门的插件：</p>
<pre><code class="hljs language-bash" lang="bash">npm install playwright-odiff
</code></pre>
<p>然后在测试文件里：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'playwright-odiff/setup'</span>;

<span class="hljs-title function_">expect</span>(page).<span class="hljs-title function_">toHaveScreenshotOdiff</span>(<span class="hljs-string">'screenshot-name'</span>);
</code></pre>
<p>Cypress 也有对应的插件 cypress-odiff。</p>
<p>还有很多视觉回归测试服务直接集成了 Odiff。</p>
<p>比如 LostPixel、Argos CI、Visual Regression Tracker。</p>
<p>Argos CI 之前发推说，换到 Odiff 之后速度提升了 8 倍。</p>
<h2 data-id="heading-6">完全开源免费</h2>
<p>Odiff 是 MIT 协议的开源项目。</p>
<p>代码全在 GitHub 上，维护也很活跃。</p>
<p>提供预编译的二进制文件，Windows、Mac、Linux 都支持。</p>
<p>npm 安装的话，会自动下载对应平台的版本，不用操心。</p>
<h2 data-id="heading-7">写在最后</h2>
<p>做视觉回归测试，或者平时需要对比图片的话。</p>
<p>强烈推荐试试 Odiff。</p>
<p>速度快到飞起，功能还全，开箱即用。</p>
<p>关键还是开源免费的，良心。</p>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FdmtrKovalenko%2Fodiff" target="_blank" title="https://github.com/dmtrKovalenko/odiff" ref="nofollow noopener noreferrer">github.com/dmtrKovalen…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flexbox 布局中的滚动失效问题：为什么需要 `min-h-0`？]]></title>    <link>https://juejin.cn/post/7592276497399627826</link>    <guid>https://juejin.cn/post/7592276497399627826</guid>    <pubDate>2026-01-07T07:01:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592276497399627826" data-draft-id="7592241336289935411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flexbox 布局中的滚动失效问题：为什么需要 `min-h-0`？"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2026-01-07T07:01:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flexbox 布局中的滚动失效问题：为什么需要 `min-h-0`？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T07:01:04.000Z" title="Wed Jan 07 2026 07:01:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flexbox 布局中的滚动失效问题：为什么需要 <code>min-h-0</code>？</h2>
<h3 data-id="heading-1">前言</h3>
<p>在使用 Flexbox 布局时，你是否遇到过这样的问题：明明设置了 <code>overflow-y-auto</code>，但内容却无法滚动，反而把整个布局撑开了？这是一个常见的 Flexbox 陷阱，本文将深入分析其原因，并提供解决方案。</p>
<h3 data-id="heading-2">问题场景</h3>
<p>假设我们有一个典型的后台管理系统布局：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;div className=<span class="hljs-string">"flex flex-col h-full"</span>&gt;
  {<span class="hljs-comment">/* 顶部导航栏 */</span>}
  &lt;div className=<span class="hljs-string">"h-[57px] shrink-0"</span>&gt;顶部栏&lt;/div&gt;

  {<span class="hljs-comment">/* 内容区域 */</span>}
  &lt;div className=<span class="hljs-string">"flex-1 flex"</span>&gt;
    {<span class="hljs-comment">/* 左侧菜单 */</span>}
    &lt;div className=<span class="hljs-string">"w-fit h-full"</span>&gt;
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"CustomMenu flex flex-col h-full"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex-1 overflow-y-auto"</span>&gt;</span>
          {/* 菜单项很多，超过容器高度 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">Menu</span> <span class="hljs-attr">items</span>=<span class="hljs-string">{menuItems}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>&gt;</span>折叠按钮<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    &lt;/div&gt;

    {<span class="hljs-comment">/* 右侧内容区 */</span>}
    &lt;div className=<span class="hljs-string">"flex-1"</span>&gt;内容区&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p><strong>预期效果</strong>：当菜单项很多时，菜单区域应该可以滚动，折叠按钮固定在底部。</p>
<p><strong>实际效果</strong>：菜单无法滚动，整个布局被撑开，按钮被挤到视口外。</p>
<h3 data-id="heading-3">问题根源：Flexbox 的 <code>min-height: auto</code></h3>
<h4 data-id="heading-4">Flexbox 的默认行为</h4>
<p>在 Flexbox 布局中，flex 子项有一个<strong>默认的 <code>min-height: auto</code></strong>（注意：不是 <code>0</code>！）。</p>
<p>这意味着：<strong>flex 子项的最小高度不能小于其内容的高度</strong>。</p>
<h4 data-id="heading-5">问题流程分析</h4>
<p>让我们看看没有 <code>min-h-0</code> 时发生了什么：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. 菜单内容高度 = <span class="hljs-number">2000px</span>（假设有很多菜单项）
   ↓
<span class="hljs-number">2</span>. <span class="hljs-attribute">flex</span>-<span class="hljs-number">1</span> <span class="hljs-attribute">overflow-y</span>-auto 容器被内容撑到 <span class="hljs-number">2000px</span>
   ↓
<span class="hljs-number">3</span>. CustomMenu (h-full) 被撑到 <span class="hljs-number">2000px</span>（继承子元素高度）
   ↓
<span class="hljs-number">4</span>. 左侧菜单容器 (h-full) 被撑到 <span class="hljs-number">2000px</span>
   ↓
<span class="hljs-number">5</span>. <span class="hljs-attribute">flex</span>-<span class="hljs-number">1</span> <span class="hljs-attribute">flex</span> 容器被撑到 <span class="hljs-number">2000px</span>（因为 <span class="hljs-attribute">min-height</span>: auto 阻止缩小）
   ↓
<span class="hljs-number">6</span>. 整个布局被撑开，按钮被挤到视口外
   ↓
<span class="hljs-number">7</span>. overflow-y-auto 不生效（因为容器高度 = 内容高度，没有<span class="hljs-string">"溢出"</span>）
</code></pre>
<h4 data-id="heading-6">可视化对比</h4>
<p><strong>没有 <code>min-h-0</code>（错误）</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────┐
│ 顶部栏 (<span class="hljs-number">57px</span>)    │
├─────────────────┤
│                 │
│  菜单内容       │ ← 容器被内容撑开
│  (<span class="hljs-number">2000px</span>)       │
│                 │
│                 │
│  <span class="hljs-selector-attr">[按钮被挤下去]</span> │ ← 按钮看不到
└─────────────────┘
</code></pre>
<p><strong>有 <code>min-h-0</code>（正确）</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────┐
│ 顶部栏 (<span class="hljs-number">57px</span>)    │
├─────────────────┤
│ ┌─────────────┐ │
│ │ 菜单内容    │ │ ← 容器高度固定
│ │ (可滚动)    │ │ ← <span class="hljs-attribute">overflow</span> 生效
│ │             │ │
│ └─────────────┘ │
│ <span class="hljs-selector-attr">[按钮固定底部]</span>  │ ← 按钮可见
└─────────────────┘
</code></pre>
<h3 data-id="heading-7">解决方案：使用 <code>min-h-0</code></h3>
<h4 data-id="heading-8">修复代码</h4>
<p>在需要滚动的 flex 容器上添加 <code>min-h-0</code>：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;div className=<span class="hljs-string">"flex flex-col h-full"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-[57px] shrink-0"</span>&gt;</span>顶部栏<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>

  {<span class="hljs-comment">/* 关键：添加 min-h-0 */</span>}
  &lt;div className=<span class="hljs-string">"flex-1 flex min-h-0"</span>&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-fit h-full"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"CustomMenu flex flex-col h-full"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex-1 overflow-y-auto"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Menu</span> <span class="hljs-attr">items</span>=<span class="hljs-string">{menuItems}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>&gt;</span>折叠按钮<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex-1"</span>&gt;</span>内容区<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h4 data-id="heading-9">修复后的流程</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. <span class="hljs-attribute">flex</span>-<span class="hljs-number">1</span> <span class="hljs-attribute">flex</span> min-h-<span class="hljs-number">0</span> 容器高度 = 可用空间（比如 <span class="hljs-number">800px</span>）
   ↓
<span class="hljs-number">2</span>. 左侧菜单容器 (h-full) = <span class="hljs-number">800px</span>（继承父容器）
   ↓
<span class="hljs-number">3</span>. CustomMenu (h-full) = <span class="hljs-number">800px</span>（继承父容器）
   ↓
<span class="hljs-number">4</span>. <span class="hljs-attribute">flex</span>-<span class="hljs-number">1</span> <span class="hljs-attribute">overflow-y</span>-auto 容器 = <span class="hljs-number">800px</span>（继承父容器）
   ↓
<span class="hljs-number">5</span>. 菜单内容 <span class="hljs-number">2000px</span> &gt; 容器 <span class="hljs-number">800px</span> → 产生溢出
   ↓
<span class="hljs-number">6</span>. <span class="hljs-attribute">overflow-y</span>-auto 生效 → 可以滚动！
</code></pre>
<h3 data-id="heading-10">为什么需要在整个布局链中传递？</h3>
<p>高度限制需要在整个布局链中正确传递：</p>
<pre><code class="hljs language-scss" lang="scss">h-full (最外层)
  ↓
<span class="hljs-attribute">flex</span>-<span class="hljs-number">1</span> <span class="hljs-attribute">flex</span> min-h-<span class="hljs-number">0</span>  ← 关键：允许缩小
  ↓
h-full (左侧菜单容器)
  ↓
h-full (CustomMenu)
  ↓
<span class="hljs-attribute">flex</span>-<span class="hljs-number">1</span> <span class="hljs-attribute">overflow-y</span>-auto  ← 可以滚动
</code></pre>
<p>每一层都需要正确的高度限制，<code>min-h-0</code> 是打破 Flexbox 默认行为的关键。</p>
<h3 data-id="heading-11">其他相关场景</h3>
<h4 data-id="heading-12">场景 1：水平滚动</h4>
<p>同样的问题也适用于水平滚动：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 允许水平缩小 */</span>
}

<span class="hljs-selector-class">.scrollable</span> {
  <span class="hljs-attribute">overflow-x</span>: auto;
}
</code></pre>
<h4 data-id="heading-13">场景 2：Grid 布局</h4>
<p>Grid 布局也有类似的问题，但 Grid 的默认 <code>min-size</code> 是 <code>0</code>，所以通常不需要额外设置。</p>
<h4 data-id="heading-14">场景 3：嵌套 Flexbox</h4>
<p>在多层嵌套的 Flexbox 中，每一层可能都需要 <code>min-h-0</code>：</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;div className=<span class="hljs-string">"flex flex-col h-full"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex-1 flex min-h-0"</span>&gt;</span>
    {' '}
    {/* 第一层 */}
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex-1 flex min-h-0"</span>&gt;</span>
      {' '}
      {/* 第二层 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex-1 overflow-y-auto"</span>&gt;</span>
        {' '}
        {/* 可以滚动 */}
        内容
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/div&gt;
</code></pre>
<h3 data-id="heading-15">最佳实践</h3>
<ol>
<li><strong>在需要滚动的 flex 容器上，总是添加 <code>min-h-0</code></strong></li>
<li><strong>使用浏览器开发者工具检查元素的实际高度</strong></li>
<li><strong>理解 Flexbox 的默认行为：<code>min-height: auto</code></strong></li>
<li><strong>在布局设计时，考虑内容可能超出容器的情况</strong></li>
</ol>
<h3 data-id="heading-16">总结</h3>
<ul>
<li><strong>问题</strong>：Flexbox 默认 <code>min-height: auto</code> 会阻止容器缩小</li>
<li><strong>结果</strong>：容器被内容撑开，<code>overflow</code> 不生效</li>
<li><strong>解决</strong>：<code>min-h-0</code> 允许容器缩小，<code>overflow</code> 才能正常工作</li>
</ul>
<p>这是一个常见的 Flexbox 布局陷阱，记住这个简单的规则：<strong>在需要滚动的 flex 容器上，记得加 <code>min-h-0</code></strong>！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[盘点 5 个大厂最近开源的 GitHub 项目。]]></title>    <link>https://juejin.cn/post/7592152007839399936</link>    <guid>https://juejin.cn/post/7592152007839399936</guid>    <pubDate>2026-01-07T05:35:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592152007839399936" data-draft-id="7592166340380753935" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="盘点 5 个大厂最近开源的 GitHub 项目。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-07T05:35:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            盘点 5 个大厂最近开源的 GitHub 项目。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T05:35:00.000Z" title="Wed Jan 07 2026 05:35:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">01、英伟达开源 AI 玩游戏模型</h2>
<p>NitroGen 是英伟达开源的项目，让 AI 像人一样玩游戏。</p>
<p>开源一两周就有 1.2K 的 Star 了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/254d1e11f4704df4b8bc7417c81e8d91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768368900&amp;x-signature=Zn9inMrlkkknFZvZo3XVCRAg2kU%3D" alt="图片" loading="lazy"/></p>
<p>它不是那种只能玩特定游戏的脚本，而是一个通用的游戏大模型。</p>
<p>它的核心逻辑非常有意思：它像人类玩家一样，只看屏幕画面，然后决定手柄该怎么按。</p>
<p>更有趣的是它的训练方式。团队没有去对接成百上千个游戏的 API，而是直接利用了互联网上依然存在的海量游戏视频来进行行为克隆。</p>
<p>它通过看别人玩游戏学会了操作，经过训练后，它甚至能适应它从未见过的游戏。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a843fe2a92eb41529ebc6bcf5893a104~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768368900&amp;x-signature=NPt4ZRxRXuloFAsk6ZPhefKVpPg%3D" alt="图片" loading="lazy"/></p>
<p>目前这个项目已经开源了代码和模型，支持在 Windows 上运行。</p>
<p>只要你打开游戏，运行这个 Agent，它就能通过捕捉屏幕画面来接管操作。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/MineDojo/NitroGen</span>
</code></pre>
<h2 data-id="heading-1">02、Meta 推出音频分割模型</h2>
<p>Meta 之前的 Segment Anything Model 在图像分割领域可以说是杀疯了，现在他们把这套魔法带到了音频领域。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/424940ed27814a7db8923273d1969f41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768368900&amp;x-signature=3M4KLVDTlcQw7wk5M%2Bqv0xTkzIE%3D" alt="图片" loading="lazy"/></p>
<p>SAM-Audio 的功能简单说就是音频版的抠图。</p>
<p>你给它一段嘈杂的录音，告诉它我要听里面的狗叫声或者把吉他声分离出来，它就能精准地把目标声音提取出来，顺便把剩下的背景音也分离开。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/324725897c9d40959af1ec244af30b0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768368900&amp;x-signature=cLdQqtqfEyqMa99itXo9Z9YlYvs%3D" alt="图片" loading="lazy"/></p>
<p>它的交互方式非常灵活，不光支持文字指令，你甚至可以给它看一段视频，框选视频里的某个人或物体，它就能识别对应的声音并提取出来。</p>
<p>此外，它也支持通过时间戳来定位声音。这背后的技术利用了音频-视觉感知编码器，让模型能理解声音和画面、文本之间的语义联系。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc000f6a40fc43e0b7038379dfc13e89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768368900&amp;x-signature=33a1Z3qOQCbEft4LS8iHhoW7HJU%3D" alt="图片" loading="lazy"/></p>
<p>对于做视频剪辑、声音设计或者音频修复的人来说，这简直是神器。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/facebookresearch/sam-audio</span>
</code></pre>
<h2 data-id="heading-2">03、阿里推出图层 AI 生成模型</h2>
<p>Qwen-Image-Layered 生成的不是一张图，而是自带图层的图像，就像是你直接得到了一个 PSD 源文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/925d9b40075840b08063a825be17f36a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768368900&amp;x-signature=rET%2FKGWt%2BfDETZ22b%2FRlqdUBJ6k%3D" alt="图片" loading="lazy"/></p>
<p>这个模型能把图像拆解成透明的 RGBA 层。比如生成一张森林里的女孩，它会把女孩放在一层，身后的树木一层，天空又是一层。</p>
<p>你可以随意移动、缩放或者删除画面里的物体，而不会在背景上留下一个难看的黑洞，因为模型已经把被遮挡的背景部分也补全了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd76a7659bf8472f9dd856612ef11f4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768368900&amp;x-signature=hB%2B16MpA5lLcKhWKo7fZRMmiihY%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3391af8d065e4611bb9699b36ec3096c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768368900&amp;x-signature=KRmh9%2F4lWSj03MjihamHHIqUWDA%3D" alt="图片" loading="lazy"/></p>
<p>这对于设计师和二次创作者来说太重要了。</p>
<p>它让 AI 生成的内容瞬间具备了极高的可编辑性。你不仅可以用它生成新的分层图像，甚至可以把现有的普通图片丢进去，让它帮你拆成图层。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/QwenLM/Qwen-Image-Layered </span>
</code></pre>
<h2 data-id="heading-3">04、谷歌开源</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c8bd6c85a1949608561b72e1385e6b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768368900&amp;x-signature=xV5BYD9I22zGA4PjLUzlQXOcyFw%3D" alt="图片" loading="lazy"/></p>
<p>之前推荐过，这个谷歌开源的项目也登上过每周开源热榜。Google 定义了一套标准，让 AI 不仅仅会说话，还能变出用户界面 UI。</p>
<p>AI 发一串 JSON 数据告诉你的手机或浏览器：给我渲染一个日历组件，外加一个确认按钮。</p>
<p>你的客户端收到指令后，就会用原生的组件把这个界面画出来。</p>
<p>这样做既保证了界面的美观和交互体验，又避免了直接执行 AI 生成的代码所带来的安全风险。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b2256c85bd946d683a5c34865075fe6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768368900&amp;x-signature=Dz8pUTYZtBXNa60l%2FrWDHBflbIg%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>这个项目的牛逼之处是把 AI 的思考和界面的展示解耦了。</p>
<p>未来的聊天机器人可能不再只是一个对话框，而是一个能根据你的需求随时变身的全能 App？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cd7b3dd64ff4062b1057d13fac2f7b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768368900&amp;x-signature=nU3pn%2Bu4E3SrifFUguGNlRrr7AU%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/google/A2UI</span>
</code></pre>
<h2 data-id="heading-4">05、阿里开源语音交互大模型</h2>
<p>Fun-Audio-Chat 就是阿里通义团队开源的项目。</p>
<p>主打的是低延迟和自然对话，不像传统的语音交互那样有漫长的等待。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ef558c7353645d19da1ec20a52d828c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768368900&amp;x-signature=aZMpc0WV%2FDydYsp6KjhMfnuD5JE%3D" alt="图片" loading="lazy"/></p>
<p>技术上，它搞了个双分辨率的架构，简单说就是用粗粒度的特征来处理语义，用细粒度的特征来保证音质，这样既省算力又能跑得快。</p>
<p>而且它通过 Core-Cocktail 训练法，在保留了强大的文本理解能力的同时，还能听懂你说话的语气，甚至在回复时带上相应的情感。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bfdd72d29d146e58376a9c55d44dc97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768368900&amp;x-signature=T2S9AVg2P0EbMFygU4ff0yJresg%3D" alt="图片" loading="lazy"/></p>
<p>它可以支持语音打断、甚至理解非语言的声音，比如笑声啥的。</p>
<p>对于想要开发实时语音聊天应用、客服机器人或者虚拟伴侣的开发者来说，这个开源项目提供了一套非常接近商业级效果的现成方案。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/FunAudioLLM/Fun-Audio-Chat</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 架构方法（一）：概述 4+1 视图模型]]></title>    <link>https://juejin.cn/post/7592251792651698203</link>    <guid>https://juejin.cn/post/7592251792651698203</guid>    <pubDate>2026-01-07T03:32:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592251792651698203" data-draft-id="7592164124659384370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 架构方法（一）：概述 4+1 视图模型"/> <meta itemprop="keywords" content="前端,架构,设计模式"/> <meta itemprop="datePublished" content="2026-01-07T03:32:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 架构方法（一）：概述 4+1 视图模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T03:32:58.000Z" title="Wed Jan 07 2026 03:32:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f01ad05c7d7f44cc94a5c91a388c7ac3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768361578&amp;x-signature=7H9yzqshPICvA43cTt5Ryhvwvqs%3D" alt="Gemini_Generated_Image_wtlcmdwtlcmdwtlc.png" loading="lazy"/></p>
<p>这个模型由 Philippe Kruchten 在 1995 年提出。它的本质含义是：<strong>没有一种单一的视图能够涵盖系统的方方面面。不同的利益相关者（Stakeholders）关心的是不同的东西。</strong></p>
<ul>
<li><strong>业务方</strong>关心功能（能不能用？）。</li>
<li><strong>开发</strong>关心代码结构（好不好写？）。</li>
<li><strong>运维</strong>关心部署和硬件（稳不稳定？）。</li>
<li><strong>用户</strong>关心操作流程（顺不顺畅？）。</li>
</ul>
<p>架构师的职责，就是通过这 5 个视角，把这些“鸡同鸭讲”的需求统一成一个完整的系统设计。</p>
<p>为了让你更好理解，我将这个经典的后端/通用架构概念，<strong>完整“翻译”成前端架构师的视角</strong>。</p>
<hr/>
<h3 data-id="heading-0">1. 场景视图 (Scenarios / Use Cases View) —— “+1” 的那个核心</h3>
<p><strong>本质：系统的灵魂，它驱动了其他 4 个视图。</strong> 这是架构设计的<strong>起点</strong>。如果不知道系统要干什么，设计就无从谈起。</p>
<ul>
<li>
<p><strong>关注点</strong>：用户怎么用这个系统？核心业务流程是什么？</p>
</li>
<li>
<p><strong>谁看</strong>：所有利益相关者（产品经理、测试、开发、用户）。</p>
</li>
<li>
<p><strong>前端架构视角</strong>：</p>
<ul>
<li>这不是指某个具体的 Button 点击事件，而是<strong>关键链路 (Critical User Journeys)</strong> 。</li>
<li><strong>例子</strong>：用户进入首页 -&gt; 登录 -&gt; 浏览商品 -&gt; 加入购物车 -&gt; 结算。</li>
<li><strong>架构决策</strong>：如果“秒杀”是核心场景，那么你在后续的“处理视图”中就必须设计高并发的防抖策略；在“物理视图”中就要考虑 CDN 缓存。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    %% 样式定义
    classDef icon fill:#fff9c4,stroke:#fbc02d,stroke-width:3px,color:#333,rx:50,ry:50;
    classDef step fill:#fff,stroke:#fbc02d,stroke-width:2px,color:#333,rx:10,ry:10;
    classDef note fill:#fffde7,stroke:none,color:#666;

    %% 左侧：核心概念
    User((用户&lt;br/&gt;User)):::icon

    %% 右侧：关键链路 (Critical Journey)
    subgraph Journey [关键链路: 秒杀场景]
        direction LR
        Step1[进入详情页]:::step --&gt; Step2[抢购点击]:::step
        Step2 --&gt; Step3[排队等待]:::step
        Step3 --&gt; Step4[创建订单]:::step
        Step4 --&gt; Step5[支付成功]:::step
    end

    User ==&gt; Step1

    %% 架构决策点
    Note1(架构决策点:&lt;br/&gt;CDN缓存, 骨架屏):::note -.-&gt; Step1
    Note2(架构决策点:&lt;br/&gt;高并发防抖, 乐观UI):::note -.-&gt; Step2
</code></pre>
<hr/>
<h3 data-id="heading-1">2. 逻辑视图 (Logical View) —— “功能是怎么组织的？”</h3>
<p><strong>本质：系统的抽象模型。</strong> 这是最接近业务逻辑的一层，忽略具体的代码文件，只看<strong>概念</strong>。</p>
<ul>
<li>
<p><strong>关注点</strong>：系统有哪些“部件”？它们之间是什么关系？</p>
</li>
<li>
<p><strong>谁看</strong>：开发人员、业务分析师。</p>
</li>
<li>
<p><strong>前端架构视角</strong>：</p>
<ul>
<li><strong>组件模型</strong>：原子组件 vs 业务组件。</li>
<li><strong>领域模型</strong>：User, Product, Order 等实体定义（TypeScript Interface 定义）。</li>
<li><strong>状态管理设计</strong>：全局状态（Redux/Pinia）存什么？局部状态存什么？模块间如何通信？</li>
<li><strong>例子</strong>：画一张图，展示 <code>OrderList</code> 组件依赖 <code>UserStore</code> 和 <code>API Service</code>，而不关心它们具体写在哪个文件里。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    %% 样式定义
    classDef icon fill:#e1f5fe,stroke:#039be5,stroke-width:3px,color:#333,rx:50,ry:50;
    classDef layer fill:#fff,stroke:#039be5,stroke-width:2px,color:#333,rx:5,ry:5;
    classDef rel stroke:#90caf9,stroke-width:2px,stroke-dasharray: 5 5;

    %% 左侧
    Logic((抽象&lt;br/&gt;逻辑)):::icon

    %% 右侧：分层架构
    subgraph LayerSystem [前端逻辑分层]
        direction TB
        UI[&lt;b&gt;表现层 UI Layer&lt;/b&gt;&lt;br/&gt;Button, Layout, Page]:::layer
        Adapter[&lt;b&gt;适配层 Adapter&lt;/b&gt;&lt;br/&gt;Hooks, Presenters]:::layer
        Domain[&lt;b&gt;领域层 Domain&lt;/b&gt;&lt;br/&gt;UserEntity, CartModel]:::layer
        Infra[&lt;b&gt;基础层 Infra&lt;/b&gt;&lt;br/&gt;Axios, Storage, Logger]:::layer
    end

    Logic ==&gt; UI

    %% 依赖关系 (单向依赖是架构的关键)
    UI --&gt; Adapter
    Adapter --&gt; Domain
    Adapter --&gt; Infra
</code></pre>
<hr/>
<h3 data-id="heading-2">3. 开发视图 (Development / Implementation View) —— “代码是怎么写的？”</h3>
<p><strong>本质：系统的静态组织结构。</strong> 这是程序员每天面对的 IDE 里的样子。</p>
<ul>
<li>
<p><strong>关注点</strong>：文件目录怎么分？用什么框架？依赖怎么管？</p>
</li>
<li>
<p><strong>谁看</strong>：开发人员、构建工程师。</p>
</li>
<li>
<p><strong>前端架构视角</strong>：</p>
<ul>
<li><strong>工程化结构</strong>：Monorepo (Nx/Turborepo) 还是 Multirepo？</li>
<li><strong>目录规范</strong>：<code>src/components</code>, <code>src/hooks</code>, <code>src/utils</code> 怎么归类？</li>
<li><strong>依赖管理</strong>：<code>package.json</code> 里的依赖，公共库（Shared Library）如何抽取？</li>
<li><strong>构建工具</strong>：Vite/Webpack 配置，分包策略（Chunking）。</li>
<li><strong>例子</strong>：决定把所有的 API 请求封装在 <code>@api</code> 目录下，并禁止组件直接调用 <code>axios</code>，这就是开发视图的约束。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    %% 样式定义
    classDef icon fill:#f3e5f5,stroke:#8e24aa,stroke-width:3px,color:#333,rx:50,ry:50;
    classDef file fill:#fff,stroke:#8e24aa,stroke-width:2px,color:#333,rx:2,ry:2;
    classDef tool fill:#f3e5f5,stroke:#8e24aa,stroke-width:1px,color:#333,stroke-dasharray: 5 5;

    %% 左侧
    Dev((工程&lt;br/&gt;代码)):::icon

    %% 右侧：目录与工具
    subgraph ProjectStructure [工程化与目录规范]
        direction TB
        
        subgraph Mono [Monorepo 仓库]
            Pkg1[packages/ui-lib]:::file
            Pkg2[apps/web-client]:::file
            Config[tsconfig.json]:::file
        end

        subgraph Toolchain [构建工具链]
            Vite(Vite / Webpack):::tool
            Lint(ESLint / Prettier):::tool
        end
    end

    Dev ==&gt; Mono
    Mono -.-&gt; Toolchain
</code></pre>
<hr/>
<h3 data-id="heading-3">4. 处理视图 (Process View) —— “系统是怎么运行的？”</h3>
<p><strong>本质：系统的动态行为、并发与性能。</strong> 对于前端来说，这是最容易被忽视，但最考验功底的一层。</p>
<ul>
<li>
<p><strong>关注点</strong>：性能、并发、同步/异步、时序。</p>
</li>
<li>
<p><strong>谁看</strong>：系统集成人员、高级开发。</p>
</li>
<li>
<p><strong>前端架构视角</strong>：</p>
<ul>
<li><strong>异步流控</strong>：接口竞态问题（Race Condition）怎么处理？Promise 并发限制。</li>
<li><strong>生命周期</strong>：SSR（服务端渲染）的数据注水（Hydration）流程是怎样的？</li>
<li><strong>性能优化</strong>：Web Worker 处理复杂计算，避免阻塞主线程（UI 线程）。</li>
<li><strong>通信机制</strong>：WebSocket 怎么保持心跳？跨 Tab 通信（SharedWorker/LocalStorage）怎么做？</li>
<li><strong>例子</strong>：设计一个“大文件分片上传”的功能，你需要画出切片、上传、暂停、续传的时序图，这属于处理视图。</li>
</ul>
</li>
</ul>
<hr/>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    %% 样式定义
    classDef icon fill:#e8f5e9,stroke:#43a047,stroke-width:3px,color:#333,rx:50,ry:50;
    classDef action fill:#fff,stroke:#43a047,stroke-width:2px,color:#333,rx:10,ry:10;
    classDef async fill:#c8e6c9,stroke:none,color:#333,rx:5,ry:5;

    %% 左侧
    Run((运行&lt;br/&gt;时序)):::icon

    %% 右侧：大文件上传时序
    subgraph AsyncProcess [大文件分片上传流程]
        direction TB
        Start[开始上传]:::action --&gt; Check{检查文件}:::action
        Check --&gt;|太大| Slice[Web Worker&lt;br/&gt;进行切片计算]:::async
        Slice --&gt; Upload[并发上传切片&lt;br/&gt;Promise.all]:::action
        Upload --&gt; Pause{网络中断?}:::action
        Pause --&gt;|是| Wait[暂停 &amp; 记录断点]:::async
        Pause --&gt;|否| Finish[合并请求]:::action
    end

    Run ==&gt; Start
</code></pre>
<h3 data-id="heading-4">5. 物理视图 (Physical / Deployment View) —— “代码跑在哪里？”</h3>
<p><strong>本质：软件到硬件的映射。</strong> 前端代码最终是要通过网络传输并运行在用户设备上的。</p>
<ul>
<li>
<p><strong>关注点</strong>：部署、网络拓扑、硬件限制。</p>
</li>
<li>
<p><strong>谁看</strong>：运维工程师 (DevOps)、系统管理员。</p>
</li>
<li>
<p><strong>前端架构视角</strong>：</p>
<ul>
<li><strong>部署策略</strong>：静态资源上 CDN，Nginx 反向代理配置。</li>
<li><strong>运行环境</strong>：BFF 层运行在 Docker 容器里；前端代码运行在用户的 Chrome/Safari 里（考虑兼容性）。</li>
<li><strong>网络环境</strong>：弱网情况下如何降级？离线包（PWA）策略。</li>
<li><strong>多端适配</strong>：同一套代码是跑在 PC 浏览器，还是内嵌在 App 的 WebView 里？</li>
<li><strong>例子</strong>：决定使用“灰度发布”系统，将新版本的 JS 文件只推给 10% 的用户，这属于物理视图的范畴。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    %% 样式定义
    classDef icon fill:#fff3e0,stroke:#fb8c00,stroke-width:3px,color:#333,rx:50,ry:50;
    classDef device fill:#fff,stroke:#fb8c00,stroke-width:2px,color:#333,rx:5,ry:5;
    classDef net fill:#ffe0b2,stroke:none,color:#333,rx:20,ry:20;

    %% 左侧
    Deploy((部署&lt;br/&gt;环境)):::icon

    %% 右侧：部署拓扑
    subgraph NetworkTopology [资源分发与运行环境]
        direction LR
        
        subgraph Cloud [云端设施]
            CICD[CI/CD 构建产物]:::device --&gt; OSS[对象存储]:::device
            OSS --&gt; CDN((CDN 边缘节点)):::net
        end

        subgraph Client [用户终端]
            CDN --&gt; Browser[PC 浏览器]:::device
            CDN --&gt; Mobile[手机 WebView]:::device
            CDN --&gt; Hybrid[小程序]:::device
        end
    end

    Deploy ==&gt; Cloud
</code></pre>
<hr/>
<h3 data-id="heading-5">总结：软件开发的本质是什么？</h3>
<p>通过 4+1 视图，我们可以得出软件开发的本质：</p>
<ol>
<li>
<p><strong>控制复杂度 (Managing Complexity)</strong> ： 如果没有分层和视图，系统就是一团乱麻。4+1 试图把复杂问题拆解成 5 个维度分别解决。</p>
</li>
<li>
<p><strong>沟通与妥协 (Communication &amp; Trade-offs)</strong> ： 架构不是追求“完美的代码”，而是平衡各方利益。</p>
<ul>
<li>为了<strong>物理视图</strong>的加载速度（上 CDN），可能要牺牲<strong>开发视图</strong>的便利性（复杂的构建流程）。</li>
<li>为了<strong>处理视图</strong>的流畅度（虚拟列表），可能要增加<strong>逻辑视图</strong>的复杂度。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-6">此时此刻，你可以做的 Next Step</h3>
<p>作为想转型的架构师，<strong>不要只写代码，开始写文档</strong>。</p>
<p>你可以挑选你当前负责的一个复杂模块，尝试写一份<strong>简易版的技术设计文档 (TDD)</strong> ，强制自己包含以下三点：</p>
<ol>
<li><strong>逻辑图</strong>：用方块图画出组件和数据流。</li>
<li><strong>处理图</strong>：用时序图画出关键的用户交互流程。</li>
<li><strong>部署说明</strong>：说明代码构建后怎么发布，有没有缓存策略。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3 中 v-for 动态组件 ref 收集失败问题排查与解决]]></title>    <link>https://juejin.cn/post/7592241336289132595</link>    <guid>https://juejin.cn/post/7592241336289132595</guid>    <pubDate>2026-01-07T04:50:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592241336289132595" data-draft-id="7592176349713858598" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 中 v-for 动态组件 ref 收集失败问题排查与解决"/> <meta itemprop="keywords" content="Vue.js,前端,前端框架"/> <meta itemprop="datePublished" content="2026-01-07T04:50:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Hashan"/> <meta itemprop="url" content="https://juejin.cn/user/3523276916662526"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 中 v-for 动态组件 ref 收集失败问题排查与解决
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3523276916662526/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Hashan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T04:50:49.000Z" title="Wed Jan 07 2026 04:50:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue 3 中 v-for 动态组件 ref 收集失败问题排查与解决</h2>
<h3 data-id="heading-1">问题描述</h3>
<p>在开发部门管理页面的搜索栏功能时，遇到了一个奇怪的问题：在 <code>v-for</code> 循环中渲染的动态组件，无法正确收集到 <code>ref</code> 数组中。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5548ace0c0344a91aca132292ead51e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFzaGFu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768366249&amp;x-signature=gEsLtTch%2FjP4m3GdED3QIcVp%2B1w%3D" alt="image.png" width="30%" loading="lazy"/>
<h4 data-id="heading-2">问题现象</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// schema-search-bar.vue</span>
<span class="hljs-keyword">const</span> searchComList = <span class="hljs-title function_">ref</span>([]);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getValue</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> dtoObj = {};
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"searchComList"</span>, searchComList.<span class="hljs-property">value</span>); <span class="hljs-comment">// 输出: Proxy(Array) {}</span>
  searchComList.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">component</span>) =&gt;</span> {
    dtoObj = { ...dtoObj, ...component.<span class="hljs-title function_">getValue</span>() };
  });
  <span class="hljs-keyword">return</span> dtoObj; <span class="hljs-comment">// 返回: {}</span>
};
</code></pre>
<p><strong>现象：</strong></p>
<ul>
<li><code>searchComList.value</code> 始终是空数组 <code>[]</code></li>
<li>无法获取到任何子组件的实例</li>
<li>导致搜索功能无法正常工作</li>
</ul>
<h4 data-id="heading-3">代码结构</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-form v-if="schema &amp;&amp; schema.properties" :inline="true"&gt;
    &lt;el-form-item v-for="(schemaItem, key) in schema.properties" :key="key"&gt;
      &lt;!-- 动态组件 --&gt;
      &lt;component 
        :ref="searchComList"  &lt;!-- ❌ 问题所在 --&gt;
        :is="SearchItemConfig[schemaItem.option?.comType]?.component" 
        :schemaKey="key"
        :schema="schemaItem"&gt;
      &lt;/component&gt;
    &lt;/el-form-item&gt;
  &lt;/el-form&gt;
&lt;/template&gt;

&lt;script setup&gt;
const searchComList = ref([]);
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-4">排查过程</h3>
<h4 data-id="heading-5">1. 初步怀疑：打印时机问题</h4>
<p>最初怀疑是打印时机不对，组件还没有挂载完成。但即使使用 <code>nextTick</code> 或在 <code>onMounted</code> 中打印，<code>searchComList.value</code> 仍然是空数组。</p>
<h4 data-id="heading-6">2. 对比其他正常工作的代码</h4>
<p>在同一个项目中，发现 <code>schema-view.vue</code> 中类似的代码却能正常工作：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- schema-view.vue - ✅ 正常工作 --&gt;
&lt;component 
  v-for="(item, key) in components" 
  :key="key" 
  :is="ComponentConfig[key]?.component" 
  ref="comListRef"  &lt;!-- ✅ 使用字符串形式 --&gt;
  @command="onComponentCommand"&gt;
&lt;/component&gt;

&lt;script setup&gt;
const comListRef = ref([]);
// comListRef.value 能正确收集到所有组件实例
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-7">3. 发现关键差异</h4>
<p>对比两个文件的代码，发现了关键差异：</p>




















<table><thead><tr><th>文件</th><th>ref 写法</th><th>结果</th></tr></thead><tbody><tr><td><code>schema-view.vue</code></td><td><code>ref="comListRef"</code> (字符串)</td><td>✅ 正常工作</td></tr><tr><td><code>schema-search-bar.vue</code></td><td><code>:ref="searchComList"</code> (绑定对象)</td><td>❌ 无法收集</td></tr></tbody></table>
<h3 data-id="heading-8">根本原因</h3>
<h4 data-id="heading-9">Vue 3 中 v-for 使用 ref 的机制</h4>
<p>在 Vue 3 中，<code>v-for</code> 中使用 <code>ref</code> 时，<strong>两种写法的行为完全不同</strong>：</p>
<h5 data-id="heading-10">1. 字符串形式的 ref（自动收集到数组）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;component v-for="item in list" ref="comListRef" /&gt;
</code></pre>
<p><strong>行为：</strong></p>
<ul>
<li>Vue 会自动将 <code>ref</code> 的值设置为一个<strong>数组</strong></li>
<li>数组中的元素按顺序对应 <code>v-for</code> 中的每一项</li>
<li>这是 Vue 3 的<strong>特殊处理机制</strong></li>
</ul>
<h5 data-id="heading-11">2. 绑定 ref 对象（不会自动收集）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;component v-for="item in list" :ref="comListRef" /&gt;
</code></pre>
<p><strong>行为：</strong></p>
<ul>
<li><code>:ref</code> 绑定的是一个 ref 对象，Vue 会直接赋值</li>
<li>在 <code>v-for</code> 中，<strong>不会自动收集到数组</strong></li>
<li>每次循环都会覆盖上一次的值</li>
<li>最终只会保留最后一个组件的引用</li>
</ul>
<h4 data-id="heading-12">官方文档说明</h4>
<p>根据 Vue 3 官方文档：</p>
<blockquote>
<p>当在 <code>v-for</code> 中使用 <code>ref</code> 时，ref 的值将是一个数组，包含所有循环项对应的组件实例。</p>
</blockquote>
<p><strong>关键点：</strong> 这个特性<strong>只适用于字符串形式的 <code>ref</code></strong>，不适用于 <code>:ref</code> 绑定。</p>
<h3 data-id="heading-13">解决方案</h3>
<h4 data-id="heading-14">方案一：使用字符串形式的 ref（推荐）</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-form-item v-for="(schemaItem, key) in schema.properties" :key="key"&gt;
    &lt;component 
      ref="searchComList"  &lt;!-- ✅ 去掉冒号，使用字符串形式 --&gt;
      :is="SearchItemConfig[schemaItem.option?.comType]?.component" 
      :schemaKey="key"
      :schema="schemaItem"&gt;
    &lt;/component&gt;
  &lt;/el-form-item&gt;
&lt;/template&gt;

&lt;script setup&gt;
const searchComList = ref([]);
// 现在 searchComList.value 会自动收集到所有组件实例
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-15">方案二：使用函数形式的 ref（更灵活）</h4>
<p>如果需要更精细的控制（比如去重、按 key 索引等），可以使用函数形式：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-form-item v-for="(schemaItem, key) in schema.properties" :key="key"&gt;
    &lt;component 
      :ref="(el) =&gt; handleRef(el, key)"  &lt;!-- ✅ 函数形式 --&gt;
      :is="SearchItemConfig[schemaItem.option?.comType]?.component" 
      :schemaKey="key"
      :schema="schemaItem"&gt;
    &lt;/component&gt;
  &lt;/el-form-item&gt;
&lt;/template&gt;

&lt;script setup&gt;
const searchComList = ref([]);
const componentMap = new Map();

const handleRef = (el, key) =&gt; {
  if (el) {
    // 如果已经存在，先移除旧的（避免重复）
    if (componentMap.has(key)) {
      const oldIndex = searchComList.value.indexOf(componentMap.get(key));
      if (oldIndex &gt; -1) {
        searchComList.value.splice(oldIndex, 1);
      }
    }
    // 添加新的组件实例
    componentMap.set(key, el);
    searchComList.value.push(el);
  } else {
    // 组件卸载时，从 Map 和数组中移除
    if (componentMap.has(key)) {
      const oldEl = componentMap.get(key);
      const index = searchComList.value.indexOf(oldEl);
      if (index &gt; -1) {
        searchComList.value.splice(index, 1);
      }
      componentMap.delete(key);
    }
  }
};
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-16">技术要点总结</h3>
<h4 data-id="heading-17">1. Vue 3 ref 在 v-for 中的行为</h4>

























<table><thead><tr><th>写法</th><th>在 v-for 中的行为</th><th>适用场景</th></tr></thead><tbody><tr><td><code>ref="xxx"</code></td><td>自动收集到数组</td><td>✅ 推荐，简单场景</td></tr><tr><td><code>:ref="xxx"</code></td><td>不会自动收集，会覆盖</td><td>❌ 不适用于 v-for</td></tr><tr><td><code>:ref="(el) =&gt; fn(el)"</code></td><td>手动控制收集逻辑</td><td>✅ 需要精细控制时</td></tr></tbody></table>
<h4 data-id="heading-18">2. 最佳实践</h4>
<ol>
<li>
<p><strong>在 v-for 中使用 ref 时，优先使用字符串形式</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;component v-for="item in list" ref="comListRef" /&gt;
</code></pre>
</li>
<li>
<p><strong>如果需要按 key 索引或去重，使用函数形式</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;component v-for="(item, key) in list" :ref="(el) =&gt; handleRef(el, key)" /&gt;
</code></pre>
</li>
<li>
<p><strong>避免在 v-for 中使用 <code>:ref="refObject"</code></strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- ❌ 不推荐 --&gt;
&lt;component v-for="item in list" :ref="comListRef" /&gt;
</code></pre>
</li>
</ol>
<h4 data-id="heading-19">3. 调试技巧</h4>
<p>当遇到 ref 收集问题时，可以：</p>
<ol>
<li><strong>检查 ref 的写法</strong>：确认是字符串还是绑定对象</li>
<li><strong>使用 nextTick 延迟检查</strong>：确保组件已挂载</li>
<li><strong>对比正常工作的代码</strong>：找出差异点</li>
<li><strong>查看 Vue DevTools</strong>：检查组件实例是否正确创建</li>
</ol>
<h3 data-id="heading-20">相关资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fguide%2Fessentials%2Ftemplate-refs.html%23refs-inside-v-for" target="_blank" title="https://vuejs.org/guide/essentials/template-refs.html#refs-inside-v-for" ref="nofollow noopener noreferrer">Vue 3 官方文档 - Template Refs</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2Fapi%2Fbuilt-in-special-attributes.html%23ref" target="_blank" title="https://vuejs.org/api/built-in-special-attributes.html#ref" ref="nofollow noopener noreferrer">Vue 3 官方文档 - v-for with ref</a></li>
</ul>
<h3 data-id="heading-21">总结</h3>
<p>这个问题看似简单，但实际上涉及到 Vue 3 中 <code>ref</code> 在 <code>v-for</code> 中的特殊处理机制。关键点在于：</p>
<ol>
<li><strong>字符串形式的 <code>ref</code> 在 v-for 中会自动收集到数组</strong></li>
<li><strong>绑定形式的 <code>:ref</code> 在 v-for 中不会自动收集</strong></li>
<li><strong>函数形式的 <code>:ref</code> 可以手动控制收集逻辑</strong></li>
</ol>
<p>记住这个规则，可以避免很多类似的坑。在开发过程中，如果遇到 ref 收集问题，首先检查是否在 v-for 中使用了错误的 ref 写法。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小程序"邪修"秘籍：那些官方文档不会告诉你的骚操作]]></title>    <link>https://juejin.cn/post/7592251792651763739</link>    <guid>https://juejin.cn/post/7592251792651763739</guid>    <pubDate>2026-01-07T03:46:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592251792651763739" data-draft-id="7592176349713645606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小程序&quot;邪修&quot;秘籍：那些官方文档不会告诉你的骚操作"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-07T03:46:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员Agions"/> <meta itemprop="url" content="https://juejin.cn/user/360295545187751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小程序"邪修"秘籍：那些官方文档不会告诉你的骚操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295545187751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员Agions
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T03:46:48.000Z" title="Wed Jan 07 2026 03:46:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>摘要</strong>：小程序开发，表面上是"戴着镣铐跳舞"，实际上是"在夹缝中求生存"。官方文档写得云淡风轻，实际开发却处处是坑。本文收录了多年小程序开发中积累的"邪修"技巧——那些不太正经但确实有效的解决方案。警告：部分技巧可能随时失效，请谨慎使用。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">引言：小程序开发者的日常崩溃</h2>
<p><strong>场景一：</strong>
产品经理："这个页面能不能像 H5 一样丝滑滚动？"
你："小程序有性能限制..."
产品经理："竞品可以。"
你：（内心崩溃）</p>
<p><strong>场景二：</strong>
设计师："这个动画效果很简单啊，就是一个弹性回弹。"
你："小程序的动画 API..."
设计师："Figma 里一秒钟就做出来了。"
你：（开始掉头发）</p>
<p><strong>场景三：</strong>
测试："这个在 iOS 上正常，安卓上怎么崩了？"
你："我看看..."（打开微信开发者工具，一切正常）
你："真机调试..."（问题复现）
你："这..."
测试："还有，在微信 8.0.32 版本上也有问题。"
你：（想转行）</p>
<p><strong>欢迎来到小程序开发的世界。</strong></p>
<p>今天，我要分享一些"邪修"技巧——那些官方文档不会告诉你，但能救你命的骚操作。</p>
<hr/>
<h2 data-id="heading-1">第一章：性能优化の黑魔法</h2>
<h3 data-id="heading-2">1.1 setData 的"分片"艺术</h3>
<p><strong>问题：</strong> setData 数据量大时，页面卡顿严重。</p>
<p><strong>官方建议：</strong> 减少 setData 的数据量。</p>
<p><strong>邪修技巧：</strong> 数据分片 + 路径更新</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误做法：一次性更新大数组</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
  <span class="hljs-attr">list</span>: newList, <span class="hljs-comment">// 假设有 1000 条数据</span>
})

<span class="hljs-comment">// ✅ 邪修技巧一：路径更新（只更新变化的部分）</span>
<span class="hljs-comment">// 假设只有第 5 条数据变了</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
  <span class="hljs-string">"list[5].name"</span>: <span class="hljs-string">"新名字"</span>,
  <span class="hljs-string">"list[5].status"</span>: <span class="hljs-string">"updated"</span>,
})

<span class="hljs-comment">// ✅ 邪修技巧二：分片更新（大数据量时）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setDataInChunks</span>(<span class="hljs-params">data, chunkSize = <span class="hljs-number">20</span></span>) {
  <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i += chunkSize) {
    <span class="hljs-keyword">const</span> chunk = {}
    keys.<span class="hljs-title function_">slice</span>(i, i + chunkSize).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
      chunk[key] = data[key]
    })
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>(chunk, resolve)
    })
  }
}

<span class="hljs-comment">// ✅ 邪修技巧三：虚拟列表（终极方案）</span>
<span class="hljs-comment">// 只渲染可视区域的数据</span>
<span class="hljs-title class_">Page</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">visibleList</span>: [], <span class="hljs-comment">// 当前可见的数据</span>
    <span class="hljs-attr">startIndex</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 起始索引</span>
    <span class="hljs-attr">itemHeight</span>: <span class="hljs-number">100</span>, <span class="hljs-comment">// 每项高度</span>
    <span class="hljs-attr">containerHeight</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 容器高度</span>
  },

  <span class="hljs-attr">fullList</span>: [], <span class="hljs-comment">// 完整数据放在非响应式属性中</span>

  <span class="hljs-title function_">onScroll</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-keyword">const</span> { scrollTop } = e.<span class="hljs-property">detail</span>
    <span class="hljs-keyword">const</span> startIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(scrollTop / <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">itemHeight</span>)
    <span class="hljs-keyword">const</span> visibleCount =
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">containerHeight</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">itemHeight</span>) + <span class="hljs-number">2</span>

    <span class="hljs-comment">// 只有 startIndex 变化时才更新</span>
    <span class="hljs-keyword">if</span> (startIndex !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">startIndex</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
        startIndex,
        <span class="hljs-attr">visibleList</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">fullList</span>.<span class="hljs-title function_">slice</span>(startIndex, startIndex + visibleCount),
      })
    }
  },
})
</code></pre>
<h3 data-id="heading-3">1.2 图片加载の"障眼法"</h3>
<p><strong>问题：</strong> 大量图片加载时，页面白屏或卡顿。</p>
<p><strong>邪修技巧：</strong> 渐进式加载 + 占位图 + 懒加载</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- WXML --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"image-wrapper"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 占位骨架 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">view</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"skeleton"</span>
    <span class="hljs-attr">wx:if</span>=<span class="hljs-string">"{{!imageLoaded}}"</span>
    <span class="hljs-attr">style</span>=<span class="hljs-string">"background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite;"</span>
  /&gt;</span>

  <span class="hljs-comment">&lt;!-- 缩略图（先加载小图） --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">image</span>
    <span class="hljs-attr">wx:if</span>=<span class="hljs-string">"{{!imageLoaded}}"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"thumbnail"</span>
    <span class="hljs-attr">src</span>=<span class="hljs-string">"{{thumbnailUrl}}"</span>
    <span class="hljs-attr">mode</span>=<span class="hljs-string">"aspectFill"</span>
  /&gt;</span>

  <span class="hljs-comment">&lt;!-- 原图（懒加载） --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">image</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"main-image {{imageLoaded ? 'loaded' : ''}}"</span>
    <span class="hljs-attr">src</span>=<span class="hljs-string">"{{imageUrl}}"</span>
    <span class="hljs-attr">mode</span>=<span class="hljs-string">"aspectFill"</span>
    <span class="hljs-attr">lazy-load</span>
    <span class="hljs-attr">bindload</span>=<span class="hljs-string">"onImageLoad"</span>
    <span class="hljs-attr">binderror</span>=<span class="hljs-string">"onImageError"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JS</span>
<span class="hljs-title class_">Page</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">imageLoaded</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">thumbnailUrl</span>: <span class="hljs-string">""</span>, <span class="hljs-comment">// 缩略图 URL（可以用 OSS 的图片处理参数生成）</span>
    <span class="hljs-attr">imageUrl</span>: <span class="hljs-string">""</span>,
  },

  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> originalUrl = <span class="hljs-string">"https://example.com/big-image.jpg"</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
      <span class="hljs-comment">// 阿里云 OSS 图片处理：生成 100px 宽的缩略图</span>
      <span class="hljs-attr">thumbnailUrl</span>: <span class="hljs-string">`<span class="hljs-subst">${originalUrl}</span>?x-oss-process=image/resize,w_100`</span>,
      <span class="hljs-attr">imageUrl</span>: originalUrl,
    })
  },

  <span class="hljs-title function_">onImageLoad</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">imageLoaded</span>: <span class="hljs-literal">true</span> })
  },

  <span class="hljs-title function_">onImageError</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 加载失败时显示默认图</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
      <span class="hljs-attr">imageUrl</span>: <span class="hljs-string">"/images/default.png"</span>,
      <span class="hljs-attr">imageLoaded</span>: <span class="hljs-literal">true</span>,
    })
  },
})
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* WXSS */</span>
<span class="hljs-selector-class">.image-wrapper</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
}

<span class="hljs-selector-class">.skeleton</span> {
  <span class="hljs-attribute">position</span>: absolute;
  inset: <span class="hljs-number">0</span>;
}

<span class="hljs-selector-class">.thumbnail</span> {
  <span class="hljs-attribute">position</span>: absolute;
  inset: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">10px</span>);
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.1</span>);
}

<span class="hljs-selector-class">.main-image</span> {
  <span class="hljs-attribute">position</span>: absolute;
  inset: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-selector-class">.main-image</span><span class="hljs-selector-class">.loaded</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">@keyframes</span> shimmer {
  <span class="hljs-number">0%</span> {
    <span class="hljs-attribute">background-position</span>: -<span class="hljs-number">200%</span> <span class="hljs-number">0</span>;
  }
  <span class="hljs-number">100%</span> {
    <span class="hljs-attribute">background-position</span>: <span class="hljs-number">200%</span> <span class="hljs-number">0</span>;
  }
}
</code></pre>
<h3 data-id="heading-4">1.3 长列表の"回收站"策略</h3>
<p><strong>问题：</strong> 无限滚动列表，滚动久了内存爆炸。</p>
<p><strong>邪修技巧：</strong> DOM 回收 + 骨架占位</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 核心思路：只保留可视区域 ± 缓冲区的真实 DOM，其他用骨架占位</span>
<span class="hljs-title class_">Component</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">list</span>: [],
    <span class="hljs-attr">recycledIndexes</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(), <span class="hljs-comment">// 被回收的索引</span>
  },

  <span class="hljs-comment">// 配置</span>
  <span class="hljs-attr">BUFFER_SIZE</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">// 缓冲区大小</span>
  <span class="hljs-attr">RECYCLE_THRESHOLD</span>: <span class="hljs-number">20</span>, <span class="hljs-comment">// 超出多少开始回收</span>

  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">onScroll</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-keyword">const</span> { scrollTop } = e.<span class="hljs-property">detail</span>
      <span class="hljs-keyword">const</span> itemHeight = <span class="hljs-number">120</span>
      <span class="hljs-keyword">const</span> viewportHeight = <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewportHeight</span> || <span class="hljs-number">600</span>

      <span class="hljs-comment">// 计算可视区域</span>
      <span class="hljs-keyword">const</span> startIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(scrollTop / itemHeight)
      <span class="hljs-keyword">const</span> endIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>((scrollTop + viewportHeight) / itemHeight)

      <span class="hljs-comment">// 计算需要保留的范围（可视区 + 缓冲区）</span>
      <span class="hljs-keyword">const</span> keepStart = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, startIndex - <span class="hljs-variable language_">this</span>.<span class="hljs-property">BUFFER_SIZE</span>)
      <span class="hljs-keyword">const</span> keepEnd = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">list</span>.<span class="hljs-property">length</span>,
        endIndex + <span class="hljs-variable language_">this</span>.<span class="hljs-property">BUFFER_SIZE</span>
      )

      <span class="hljs-comment">// 回收超出范围的 DOM</span>
      <span class="hljs-keyword">const</span> recycledIndexes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (
          index &lt; keepStart - <span class="hljs-variable language_">this</span>.<span class="hljs-property">RECYCLE_THRESHOLD</span> ||
          index &gt; keepEnd + <span class="hljs-variable language_">this</span>.<span class="hljs-property">RECYCLE_THRESHOLD</span>
        ) {
          recycledIndexes.<span class="hljs-title function_">add</span>(index)
        }
      })

      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">recycledIndexes</span>: [...recycledIndexes] })
    },
  },
})
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- WXML：根据是否被回收显示不同内容 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">scroll-view</span> <span class="hljs-attr">scroll-y</span> <span class="hljs-attr">bindscroll</span>=<span class="hljs-string">"onScroll"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: 100vh;"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">wx:for</span>=<span class="hljs-string">"{{list}}"</span> <span class="hljs-attr">wx:key</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"list-item"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: 120px;"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 被回收的显示骨架 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">block</span> <span class="hljs-attr">wx:if</span>=<span class="hljs-string">"{{recycledIndexes.includes(index)}}"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"skeleton-item"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">block</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 未被回收的显示真实内容 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">block</span> <span class="hljs-attr">wx:else</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">image</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"{{item.image}}"</span> <span class="hljs-attr">lazy-load</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>{{item.title}}<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>{{item.desc}}<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">block</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">scroll-view</span>&gt;</span>
</code></pre>
<hr/>
<h2 data-id="heading-5">第二章：样式の"奇技淫巧"</h2>
<h3 data-id="heading-6">2.1 安全区域の"万能公式"</h3>
<p><strong>问题：</strong> iPhone 刘海屏、底部安全区域适配。</p>
<p><strong>邪修技巧：</strong> CSS 变量 + env() + 兜底值</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 在 app.wxss 中定义全局变量 */</span>
page {
  <span class="hljs-attr">--safe-area-top</span>: <span class="hljs-built_in">env</span>(safe-area-inset-top, <span class="hljs-number">0px</span>);
  <span class="hljs-attr">--safe-area-bottom</span>: <span class="hljs-built_in">env</span>(safe-area-inset-bottom, <span class="hljs-number">0px</span>);
  <span class="hljs-attr">--safe-area-left</span>: <span class="hljs-built_in">env</span>(safe-area-inset-left, <span class="hljs-number">0px</span>);
  <span class="hljs-attr">--safe-area-right</span>: <span class="hljs-built_in">env</span>(safe-area-inset-right, <span class="hljs-number">0px</span>);

  <span class="hljs-comment">/* 导航栏高度（状态栏 + 导航栏） */</span>
  <span class="hljs-attr">--nav-height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--safe-area-top) + <span class="hljs-number">44px</span>);

  <span class="hljs-comment">/* 底部 TabBar 高度 */</span>
  <span class="hljs-attr">--tabbar-height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--safe-area-bottom) + <span class="hljs-number">50px</span>);
}

<span class="hljs-comment">/* 自定义导航栏 */</span>
<span class="hljs-selector-class">.custom-navbar</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">var</span>(--nav-height);
  <span class="hljs-attribute">padding-top</span>: <span class="hljs-built_in">var</span>(--safe-area-top);
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">999</span>;
}

<span class="hljs-comment">/* 页面内容（避开导航栏） */</span>
<span class="hljs-selector-class">.page-content</span> {
  <span class="hljs-attribute">padding-top</span>: <span class="hljs-built_in">var</span>(--nav-height);
  <span class="hljs-attribute">padding-bottom</span>: <span class="hljs-built_in">var</span>(--tabbar-height);
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
  <span class="hljs-attribute">box-sizing</span>: border-box;
}

<span class="hljs-comment">/* 底部固定按钮 */</span>
<span class="hljs-selector-class">.bottom-button</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span> <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">padding-bottom</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">12px</span> + <span class="hljs-built_in">var</span>(--safe-area-bottom));
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
}
</code></pre>
<h3 data-id="heading-7">2.2 1px 边框の"像素级"方案</h3>
<p><strong>问题：</strong> 在高清屏上，1px 边框看起来太粗。</p>
<p><strong>邪修技巧：</strong> 伪元素 + transform 缩放</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 通用 1px 边框 mixin（用 class 实现） */</span>

<span class="hljs-comment">/* 底部 1px 边框 */</span>
<span class="hljs-selector-class">.border-bottom-1px</span> {
  <span class="hljs-attribute">position</span>: relative;
}

<span class="hljs-selector-class">.border-bottom-1px</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">1px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#e5e5e5</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scaleY</span>(<span class="hljs-number">0.5</span>);
  <span class="hljs-attribute">transform-origin</span>: <span class="hljs-number">0</span> <span class="hljs-number">100%</span>;
}

<span class="hljs-comment">/* 四周 1px 边框 */</span>
<span class="hljs-selector-class">.border-1px</span> {
  <span class="hljs-attribute">position</span>: relative;
}

<span class="hljs-selector-class">.border-1px</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200%</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e5e5e5</span>;
  <span class="hljs-attribute">border-radius</span>: inherit;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">0.5</span>);
  <span class="hljs-attribute">transform-origin</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span>;
  <span class="hljs-attribute">pointer-events</span>: none;
  <span class="hljs-attribute">box-sizing</span>: border-box;
}

<span class="hljs-comment">/* 带圆角的 1px 边框 */</span>
<span class="hljs-selector-class">.border-1px-radius</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.border-1px-radius</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200%</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e5e5e5</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">16px</span>; <span class="hljs-comment">/* 圆角也要 *2 */</span>
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">0.5</span>);
  <span class="hljs-attribute">transform-origin</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span>;
  <span class="hljs-attribute">pointer-events</span>: none;
  <span class="hljs-attribute">box-sizing</span>: border-box;
}
</code></pre>
<h3 data-id="heading-8">2.3 文字截断の"终极方案"</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 单行截断 */</span>
<span class="hljs-selector-class">.text-ellipsis</span> {
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">text-overflow</span>: ellipsis;
  <span class="hljs-attribute">white-space</span>: nowrap;
}

<span class="hljs-comment">/* 多行截断（兼容性最好的方案） */</span>
<span class="hljs-selector-class">.text-ellipsis-2</span> {
  <span class="hljs-attribute">display</span>: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: <span class="hljs-number">2</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">text-overflow</span>: ellipsis;
  <span class="hljs-attribute">word-break</span>: break-all;
}

<span class="hljs-comment">/* 多行截断 + 展开收起（需要 JS 配合） */</span>
<span class="hljs-selector-class">.text-expandable</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">max-height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">1.5em</span> * <span class="hljs-number">3</span>); <span class="hljs-comment">/* 3 行 */</span>
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">transition</span>: max-height <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-selector-class">.text-expandable</span><span class="hljs-selector-class">.expanded</span> {
  <span class="hljs-attribute">max-height</span>: none;
}

<span class="hljs-selector-class">.text-expandable</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">"...展开"</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">padding-left</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(to right, transparent, <span class="hljs-number">#fff</span> <span class="hljs-number">50%</span>);
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#1890ff</span>;
}

<span class="hljs-selector-class">.text-expandable</span><span class="hljs-selector-class">.expanded</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: none;
}
</code></pre>
<hr/>
<h2 data-id="heading-9">第三章：交互の"黑科技"</h2>
<h3 data-id="heading-10">3.1 下拉刷新の"自定义"方案</h3>
<p><strong>问题：</strong> 原生下拉刷新样式太丑，无法自定义。</p>
<p><strong>邪修技巧：</strong> 禁用原生 + 自己实现</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// page.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"enablePullDownRefresh"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"disableScroll"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- WXML --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"pull-refresh-container"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 下拉提示区域 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">view</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"pull-refresh-header"</span>
    <span class="hljs-attr">style</span>=<span class="hljs-string">"transform: translateY({{pullDistance - 80}}px);"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">view</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"refresh-icon {{refreshing ? 'rotating' : ''}}"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">"transform: rotate({{pullDistance * 2}}deg);"</span>
    &gt;</span>
      ↻
    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>{{refreshText}}<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 内容区域 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">scroll-view</span>
    <span class="hljs-attr">scroll-y</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"content-scroll"</span>
    <span class="hljs-attr">style</span>=<span class="hljs-string">"transform: translateY({{pullDistance}}px);"</span>
    <span class="hljs-attr">bindtouchstart</span>=<span class="hljs-string">"onTouchStart"</span>
    <span class="hljs-attr">bindtouchmove</span>=<span class="hljs-string">"onTouchMove"</span>
    <span class="hljs-attr">bindtouchend</span>=<span class="hljs-string">"onTouchEnd"</span>
    <span class="hljs-attr">bindscroll</span>=<span class="hljs-string">"onScroll"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">scroll-view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JS</span>
<span class="hljs-title class_">Component</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">pullDistance</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">refreshing</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">refreshText</span>: <span class="hljs-string">"下拉刷新"</span>,
    <span class="hljs-attr">startY</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">scrollTop</span>: <span class="hljs-number">0</span>,
  },

  <span class="hljs-attr">THRESHOLD</span>: <span class="hljs-number">80</span>, <span class="hljs-comment">// 触发刷新的阈值</span>

  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">onTouchStart</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">refreshing</span>) <span class="hljs-keyword">return</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">startY</span>: e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientY</span> })
    },

    <span class="hljs-title function_">onTouchMove</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">refreshing</span>) <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">scrollTop</span> &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-comment">// 不在顶部时不触发</span>

      <span class="hljs-keyword">const</span> currentY = e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientY</span>
      <span class="hljs-keyword">const</span> distance = currentY - <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">startY</span>

      <span class="hljs-keyword">if</span> (distance &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 阻尼效果：拉得越远，阻力越大</span>
        <span class="hljs-keyword">const</span> pullDistance = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(distance * <span class="hljs-number">0.5</span>, <span class="hljs-number">120</span>)
        <span class="hljs-keyword">const</span> refreshText =
          pullDistance &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">THRESHOLD</span> ? <span class="hljs-string">"释放刷新"</span> : <span class="hljs-string">"下拉刷新"</span>

        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ pullDistance, refreshText })
      }
    },

    <span class="hljs-title function_">onTouchEnd</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">refreshing</span>) <span class="hljs-keyword">return</span>

      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">pullDistance</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">THRESHOLD</span>) {
        <span class="hljs-comment">// 触发刷新</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
          <span class="hljs-attr">pullDistance</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">THRESHOLD</span>,
          <span class="hljs-attr">refreshing</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">refreshText</span>: <span class="hljs-string">"刷新中..."</span>,
        })

        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">triggerEvent</span>(<span class="hljs-string">"refresh"</span>)
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 回弹</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">pullDistance</span>: <span class="hljs-number">0</span> })
      }
    },

    <span class="hljs-title function_">onScroll</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">scrollTop</span>: e.<span class="hljs-property">detail</span>.<span class="hljs-property">scrollTop</span> })
    },

    <span class="hljs-comment">// 外部调用：刷新完成</span>
    <span class="hljs-title function_">stopRefresh</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
        <span class="hljs-attr">pullDistance</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">refreshing</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">refreshText</span>: <span class="hljs-string">"下拉刷新"</span>,
      })
    },
  },
})
</code></pre>
<h3 data-id="heading-11">3.2 手势密码の"纯 Canvas"实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 手势密码组件</span>
<span class="hljs-title class_">Component</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">points</span>: [], <span class="hljs-comment">// 9 个点的坐标</span>
    <span class="hljs-attr">selectedPoints</span>: [], <span class="hljs-comment">// 已选中的点</span>
    <span class="hljs-attr">touchPoint</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 当前触摸点</span>
  },

  <span class="hljs-attr">lifetimes</span>: {
    <span class="hljs-title function_">attached</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initCanvas</span>()
    },
  },

  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">initCanvas</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> query = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createSelectorQuery</span>()
      query
        .<span class="hljs-title function_">select</span>(<span class="hljs-string">"#gesture-canvas"</span>)
        .<span class="hljs-title function_">fields</span>({ <span class="hljs-attr">node</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">size</span>: <span class="hljs-literal">true</span> })
        .<span class="hljs-title function_">exec</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-keyword">const</span> canvas = res[<span class="hljs-number">0</span>].<span class="hljs-property">node</span>
          <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>)

          <span class="hljs-comment">// 设置 canvas 尺寸</span>
          <span class="hljs-keyword">const</span> dpr = wx.<span class="hljs-title function_">getSystemInfoSync</span>().<span class="hljs-property">pixelRatio</span>
          canvas.<span class="hljs-property">width</span> = res[<span class="hljs-number">0</span>].<span class="hljs-property">width</span> * dpr
          canvas.<span class="hljs-property">height</span> = res[<span class="hljs-number">0</span>].<span class="hljs-property">height</span> * dpr
          ctx.<span class="hljs-title function_">scale</span>(dpr, dpr)

          <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvas</span> = canvas
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctx</span> = ctx
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvasWidth</span> = res[<span class="hljs-number">0</span>].<span class="hljs-property">width</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvasHeight</span> = res[<span class="hljs-number">0</span>].<span class="hljs-property">height</span>

          <span class="hljs-comment">// 初始化 9 个点</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initPoints</span>()
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">draw</span>()
        })
    },

    <span class="hljs-title function_">initPoints</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> padding = <span class="hljs-number">50</span>
      <span class="hljs-keyword">const</span> width = <span class="hljs-variable language_">this</span>.<span class="hljs-property">canvasWidth</span> - padding * <span class="hljs-number">2</span>
      <span class="hljs-keyword">const</span> gap = width / <span class="hljs-number">2</span>
      <span class="hljs-keyword">const</span> points = []

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> row = <span class="hljs-number">0</span>; row &lt; <span class="hljs-number">3</span>; row++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> col = <span class="hljs-number">0</span>; col &lt; <span class="hljs-number">3</span>; col++) {
          points.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">x</span>: padding + col * gap,
            <span class="hljs-attr">y</span>: padding + row * gap,
            <span class="hljs-attr">index</span>: row * <span class="hljs-number">3</span> + col,
          })
        }
      }

      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ points })
    },

    <span class="hljs-title function_">draw</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> { ctx, canvasWidth, canvasHeight } = <span class="hljs-variable language_">this</span>
      <span class="hljs-keyword">const</span> { points, selectedPoints, touchPoint } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>

      <span class="hljs-comment">// 清空画布</span>
      ctx.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvasWidth, canvasHeight)

      <span class="hljs-comment">// 画连线</span>
      <span class="hljs-keyword">if</span> (selectedPoints.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        ctx.<span class="hljs-title function_">beginPath</span>()
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">"#1890ff"</span>
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">3</span>
        ctx.<span class="hljs-property">lineCap</span> = <span class="hljs-string">"round"</span>
        ctx.<span class="hljs-property">lineJoin</span> = <span class="hljs-string">"round"</span>

        selectedPoints.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">pointIndex, i</span>) =&gt;</span> {
          <span class="hljs-keyword">const</span> point = points[pointIndex]
          <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) {
            ctx.<span class="hljs-title function_">moveTo</span>(point.<span class="hljs-property">x</span>, point.<span class="hljs-property">y</span>)
          } <span class="hljs-keyword">else</span> {
            ctx.<span class="hljs-title function_">lineTo</span>(point.<span class="hljs-property">x</span>, point.<span class="hljs-property">y</span>)
          }
        })

        <span class="hljs-comment">// 连接到当前触摸点</span>
        <span class="hljs-keyword">if</span> (touchPoint) {
          ctx.<span class="hljs-title function_">lineTo</span>(touchPoint.<span class="hljs-property">x</span>, touchPoint.<span class="hljs-property">y</span>)
        }

        ctx.<span class="hljs-title function_">stroke</span>()
      }

      <span class="hljs-comment">// 画点</span>
      points.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">point, index</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> isSelected = selectedPoints.<span class="hljs-title function_">includes</span>(index)

        <span class="hljs-comment">// 外圈</span>
        ctx.<span class="hljs-title function_">beginPath</span>()
        ctx.<span class="hljs-title function_">arc</span>(point.<span class="hljs-property">x</span>, point.<span class="hljs-property">y</span>, <span class="hljs-number">25</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>)
        ctx.<span class="hljs-property">strokeStyle</span> = isSelected ? <span class="hljs-string">"#1890ff"</span> : <span class="hljs-string">"#ddd"</span>
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">2</span>
        ctx.<span class="hljs-title function_">stroke</span>()

        <span class="hljs-comment">// 内圈</span>
        ctx.<span class="hljs-title function_">beginPath</span>()
        ctx.<span class="hljs-title function_">arc</span>(point.<span class="hljs-property">x</span>, point.<span class="hljs-property">y</span>, isSelected ? <span class="hljs-number">10</span> : <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>)
        ctx.<span class="hljs-property">fillStyle</span> = isSelected ? <span class="hljs-string">"#1890ff"</span> : <span class="hljs-string">"#ddd"</span>
        ctx.<span class="hljs-title function_">fill</span>()
      })
    },

    <span class="hljs-title function_">onTouchStart</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">selectedPoints</span>: [], <span class="hljs-attr">touchPoint</span>: <span class="hljs-literal">null</span> })
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleTouch</span>(e)
    },

    <span class="hljs-title function_">onTouchMove</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleTouch</span>(e)
    },

    <span class="hljs-title function_">onTouchEnd</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> { selectedPoints } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>

      <span class="hljs-keyword">if</span> (selectedPoints.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">4</span>) {
        <span class="hljs-comment">// 触发事件，返回密码</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">triggerEvent</span>(<span class="hljs-string">"complete"</span>, {
          <span class="hljs-attr">password</span>: selectedPoints.<span class="hljs-title function_">join</span>(<span class="hljs-string">""</span>),
        })
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (selectedPoints.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 密码太短</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">triggerEvent</span>(<span class="hljs-string">"error"</span>, {
          <span class="hljs-attr">message</span>: <span class="hljs-string">"至少连接 4 个点"</span>,
        })
      }

      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">touchPoint</span>: <span class="hljs-literal">null</span> })
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">draw</span>()
    },

    <span class="hljs-title function_">handleTouch</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-keyword">const</span> touch = e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>]
      <span class="hljs-keyword">const</span> { points, selectedPoints } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>

      <span class="hljs-comment">// 获取相对于 canvas 的坐标</span>
      <span class="hljs-keyword">const</span> query = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createSelectorQuery</span>()
      query
        .<span class="hljs-title function_">select</span>(<span class="hljs-string">"#gesture-canvas"</span>)
        .<span class="hljs-title function_">boundingClientRect</span>(<span class="hljs-function">(<span class="hljs-params">rect</span>) =&gt;</span> {
          <span class="hljs-keyword">const</span> x = touch.<span class="hljs-property">clientX</span> - rect.<span class="hljs-property">left</span>
          <span class="hljs-keyword">const</span> y = touch.<span class="hljs-property">clientY</span> - rect.<span class="hljs-property">top</span>

          <span class="hljs-comment">// 检查是否触碰到某个点</span>
          points.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">point, index</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> distance = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(
              <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(x - point.<span class="hljs-property">x</span>, <span class="hljs-number">2</span>) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(y - point.<span class="hljs-property">y</span>, <span class="hljs-number">2</span>)
            )

            <span class="hljs-keyword">if</span> (distance &lt; <span class="hljs-number">30</span> &amp;&amp; !selectedPoints.<span class="hljs-title function_">includes</span>(index)) {
              selectedPoints.<span class="hljs-title function_">push</span>(index)
              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ selectedPoints })
            }
          })

          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">touchPoint</span>: { x, y } })
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">draw</span>()
        })
        .<span class="hljs-title function_">exec</span>()
    },
  },
})
</code></pre>
<hr/>
<h2 data-id="heading-12">第四章：数据の"骚操作"</h2>
<h3 data-id="heading-13">4.1 本地存储の"加密"方案</h3>
<p><strong>问题：</strong> wx.setStorageSync 存储的数据是明文，容易被篡改。</p>
<p><strong>邪修技巧：</strong> 简单加密 + 签名校验</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/secureStorage.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SECRET_KEY</span> = <span class="hljs-string">"your-secret-key-here"</span> <span class="hljs-comment">// 实际项目中应该更复杂</span>

<span class="hljs-comment">// 简单的加密函数（生产环境建议用更强的加密）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> str = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)
  <span class="hljs-comment">// Base64 编码 + 简单混淆</span>
  <span class="hljs-keyword">const</span> base64 = wx.<span class="hljs-title function_">arrayBufferToBase64</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>().<span class="hljs-title function_">encode</span>(str))
  <span class="hljs-comment">// 添加签名</span>
  <span class="hljs-keyword">const</span> signature = <span class="hljs-title function_">generateSignature</span>(base64)
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${base64}</span>.<span class="hljs-subst">${signature}</span>`</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">encryptedData</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> [base64, signature] = encryptedData.<span class="hljs-title function_">split</span>(<span class="hljs-string">"."</span>)

    <span class="hljs-comment">// 验证签名</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">generateSignature</span>(base64) !== signature) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"数据签名验证失败，可能被篡改"</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }

    <span class="hljs-comment">// 解码</span>
    <span class="hljs-keyword">const</span> buffer = wx.<span class="hljs-title function_">base64ToArrayBuffer</span>(base64)
    <span class="hljs-keyword">const</span> str = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>().<span class="hljs-title function_">decode</span>(buffer)
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(str)
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"解密失败"</span>, e)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
  }
}

<span class="hljs-comment">// 生成签名（简单实现，生产环境用 HMAC）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">generateSignature</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">let</span> hash = <span class="hljs-number">0</span>
  <span class="hljs-keyword">const</span> str = data + <span class="hljs-variable constant_">SECRET_KEY</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; str.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> char = str.<span class="hljs-title function_">charCodeAt</span>(i)
    hash = (hash &lt;&lt; <span class="hljs-number">5</span>) - hash + char
    hash = hash &amp; hash
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(hash).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)
}

<span class="hljs-comment">// 封装的安全存储 API</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> secureStorage = {
  <span class="hljs-title function_">set</span>(<span class="hljs-params">key, value, options = {}</span>) {
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">encrypt</span>: shouldEncrypt = <span class="hljs-literal">true</span>, expire = <span class="hljs-number">0</span> } = options

    <span class="hljs-keyword">const</span> data = {
      value,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">expire</span>: expire &gt; <span class="hljs-number">0</span> ? <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + expire : <span class="hljs-number">0</span>,
    }

    <span class="hljs-keyword">const</span> storageValue = shouldEncrypt ? <span class="hljs-title function_">encrypt</span>(data) : <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)
    wx.<span class="hljs-title function_">setStorageSync</span>(key, storageValue)
  },

  <span class="hljs-title function_">get</span>(<span class="hljs-params">key, options = {}</span>) {
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">decrypt</span>: shouldDecrypt = <span class="hljs-literal">true</span>, defaultValue = <span class="hljs-literal">null</span> } = options

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> storageValue = wx.<span class="hljs-title function_">getStorageSync</span>(key)
      <span class="hljs-keyword">if</span> (!storageValue) <span class="hljs-keyword">return</span> defaultValue

      <span class="hljs-keyword">const</span> data = shouldDecrypt
        ? <span class="hljs-title function_">decrypt</span>(storageValue)
        : <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(storageValue)

      <span class="hljs-keyword">if</span> (!data) <span class="hljs-keyword">return</span> defaultValue

      <span class="hljs-comment">// 检查是否过期</span>
      <span class="hljs-keyword">if</span> (data.<span class="hljs-property">expire</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() &gt; data.<span class="hljs-property">expire</span>) {
        wx.<span class="hljs-title function_">removeStorageSync</span>(key)
        <span class="hljs-keyword">return</span> defaultValue
      }

      <span class="hljs-keyword">return</span> data.<span class="hljs-property">value</span>
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> defaultValue
    }
  },

  <span class="hljs-title function_">remove</span>(<span class="hljs-params">key</span>) {
    wx.<span class="hljs-title function_">removeStorageSync</span>(key)
  },
}

<span class="hljs-comment">// 使用示例</span>
secureStorage.<span class="hljs-title function_">set</span>(<span class="hljs-string">"userToken"</span>, <span class="hljs-string">"abc123"</span>, { <span class="hljs-attr">expire</span>: <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> }) <span class="hljs-comment">// 7天过期</span>
<span class="hljs-keyword">const</span> token = secureStorage.<span class="hljs-title function_">get</span>(<span class="hljs-string">"userToken"</span>)
</code></pre>
<h3 data-id="heading-14">4.2 请求の"智能重试"</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/request.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_RETRY</span> = <span class="hljs-number">3</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">RETRY_DELAY</span> = <span class="hljs-number">1000</span>

<span class="hljs-comment">// 判断是否应该重试</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">shouldRetry</span>(<span class="hljs-params">error, retryCount</span>) {
  <span class="hljs-keyword">if</span> (retryCount &gt;= <span class="hljs-variable constant_">MAX_RETRY</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

  <span class="hljs-comment">// 网络错误重试</span>
  <span class="hljs-keyword">if</span> (error.<span class="hljs-property">errMsg</span>?.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"request:fail"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

  <span class="hljs-comment">// 超时重试</span>
  <span class="hljs-keyword">if</span> (error.<span class="hljs-property">errMsg</span>?.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"timeout"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

  <span class="hljs-comment">// 5xx 错误重试</span>
  <span class="hljs-keyword">if</span> (error.<span class="hljs-property">statusCode</span> &gt;= <span class="hljs-number">500</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}

<span class="hljs-comment">// 延迟函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">delay</span> = (<span class="hljs-params">ms</span>) =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, ms))

<span class="hljs-comment">// 带重试的请求</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">requestWithRetry</span>(<span class="hljs-params">options, retryCount = <span class="hljs-number">0</span></span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      wx.<span class="hljs-title function_">request</span>({
        ...options,
        <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (res.<span class="hljs-property">statusCode</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; res.<span class="hljs-property">statusCode</span> &lt; <span class="hljs-number">300</span>) {
            <span class="hljs-title function_">resolve</span>(res)
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">reject</span>({ ...res, <span class="hljs-attr">errMsg</span>: <span class="hljs-string">`HTTP <span class="hljs-subst">${res.statusCode}</span>`</span> })
          }
        },
        <span class="hljs-attr">fail</span>: reject,
      })
    })

    <span class="hljs-keyword">return</span> response
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">shouldRetry</span>(error, retryCount)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
        <span class="hljs-string">`请求失败，<span class="hljs-subst">${RETRY_DELAY}</span>ms 后重试 (<span class="hljs-subst">${retryCount + <span class="hljs-number">1</span>}</span>/<span class="hljs-subst">${MAX_RETRY}</span>)`</span>
      )

      <span class="hljs-comment">// 指数退避</span>
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(<span class="hljs-variable constant_">RETRY_DELAY</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, retryCount))

      <span class="hljs-keyword">return</span> <span class="hljs-title function_">requestWithRetry</span>(options, retryCount + <span class="hljs-number">1</span>)
    }

    <span class="hljs-keyword">throw</span> error
  }
}

<span class="hljs-comment">// 请求队列（防止并发过多）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestQueue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">maxConcurrent = <span class="hljs-number">5</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxConcurrent</span> = maxConcurrent
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentCount</span> = <span class="hljs-number">0</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span> = []
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">requestFn</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentCount</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxConcurrent</span>) {
      <span class="hljs-comment">// 等待队列</span>
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">push</span>(resolve))
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentCount</span>++

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestFn</span>()
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentCount</span>--

      <span class="hljs-comment">// 释放队列中的下一个</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> next = <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">shift</span>()
        <span class="hljs-title function_">next</span>()
      }
    }
  }
}

<span class="hljs-keyword">const</span> requestQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestQueue</span>(<span class="hljs-number">5</span>)

<span class="hljs-comment">// 最终封装的请求函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-keyword">return</span> requestQueue.<span class="hljs-title function_">add</span>(<span class="hljs-function">() =&gt;</span>
    <span class="hljs-title function_">requestWithRetry</span>({
      <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>,
      ...options,
      <span class="hljs-attr">header</span>: {
        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>,
        ...options.<span class="hljs-property">header</span>,
      },
    })
  )
}
</code></pre>
<h3 data-id="heading-15">4.3 全局状态の"响应式"方案</h3>
<p><strong>问题：</strong> 小程序没有 Vuex/Redux，跨页面状态管理很麻烦。</p>
<p><strong>邪修技巧：</strong> 简易响应式 Store</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// store/index.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Store</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">initialState = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = initialState
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">computedCache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
  }

  <span class="hljs-comment">// 获取状态</span>
  <span class="hljs-title function_">getState</span>(<span class="hljs-params">path</span>) {
    <span class="hljs-keyword">if</span> (!path) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>
    <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">split</span>(<span class="hljs-string">"."</span>).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">obj, key</span>) =&gt;</span> obj?.[key], <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>)
  }

  <span class="hljs-comment">// 设置状态</span>
  <span class="hljs-title function_">setState</span>(<span class="hljs-params">path, value</span>) {
    <span class="hljs-keyword">const</span> keys = path.<span class="hljs-title function_">split</span>(<span class="hljs-string">"."</span>)
    <span class="hljs-keyword">const</span> lastKey = keys.<span class="hljs-title function_">pop</span>()
    <span class="hljs-keyword">const</span> target = keys.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">obj, key</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!obj[key]) obj[key] = {}
      <span class="hljs-keyword">return</span> obj[key]
    }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>)

    <span class="hljs-keyword">const</span> oldValue = target[lastKey]
    target[lastKey] = value

    <span class="hljs-comment">// 通知监听者</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">notify</span>(path, value, oldValue)
  }

  <span class="hljs-comment">// 批量更新</span>
  <span class="hljs-title function_">batchUpdate</span>(<span class="hljs-params">updates</span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(updates).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[path, value]</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(path, value)
    })
  }

  <span class="hljs-comment">// 订阅变化</span>
  <span class="hljs-title function_">subscribe</span>(<span class="hljs-params">path, callback, immediate = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">has</span>(path)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">set</span>(path, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>())
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">get</span>(path).<span class="hljs-title function_">add</span>(callback)

    <span class="hljs-comment">// 立即执行一次</span>
    <span class="hljs-keyword">if</span> (immediate) {
      <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getState</span>(path), <span class="hljs-literal">undefined</span>)
    }

    <span class="hljs-comment">// 返回取消订阅函数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">get</span>(path)?.<span class="hljs-title function_">delete</span>(callback)
    }
  }

  <span class="hljs-comment">// 通知监听者</span>
  <span class="hljs-title function_">notify</span>(<span class="hljs-params">path, newValue, oldValue</span>) {
    <span class="hljs-comment">// 精确匹配</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">get</span>(path)?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> <span class="hljs-title function_">cb</span>(newValue, oldValue))

    <span class="hljs-comment">// 父路径也要通知（如 'user' 变化时，'user.name' 的监听者也要通知）</span>
    <span class="hljs-keyword">const</span> parts = path.<span class="hljs-title function_">split</span>(<span class="hljs-string">"."</span>)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = parts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt; <span class="hljs-number">0</span>; i--) {
      <span class="hljs-keyword">const</span> parentPath = parts.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, i).<span class="hljs-title function_">join</span>(<span class="hljs-string">"."</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listeners</span>.<span class="hljs-title function_">get</span>(parentPath)?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">cb</span>) =&gt;</span> {
        <span class="hljs-title function_">cb</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getState</span>(parentPath), <span class="hljs-literal">undefined</span>)
      })
    }

    <span class="hljs-comment">// 清除相关的计算缓存</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">computedCache</span>.<span class="hljs-title function_">clear</span>()
  }

  <span class="hljs-comment">// 计算属性</span>
  <span class="hljs-title function_">computed</span>(<span class="hljs-params">name, getter</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">computedCache</span>.<span class="hljs-title function_">has</span>(name)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">computedCache</span>.<span class="hljs-title function_">get</span>(name)
    }

    <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">getter</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">computedCache</span>.<span class="hljs-title function_">set</span>(name, value)
    <span class="hljs-keyword">return</span> value
  }
}

<span class="hljs-comment">// 创建全局 store</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Store</span>({
  <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-attr">cart</span>: [],
  <span class="hljs-attr">settings</span>: {
    <span class="hljs-attr">theme</span>: <span class="hljs-string">"light"</span>,
    <span class="hljs-attr">language</span>: <span class="hljs-string">"zh-CN"</span>,
  },
})

<span class="hljs-comment">// 页面 Mixin：自动绑定 store 到页面 data</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">connectStore</span>(<span class="hljs-params">mapState = {}</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">data</span>: {},

    <span class="hljs-title function_">onLoad</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_storeUnsubscribes</span> = []

      <span class="hljs-comment">// 订阅 store 变化</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(mapState).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[dataKey, storePath]</span>) =&gt;</span> {
        <span class="hljs-comment">// 初始化数据</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ [dataKey]: store.<span class="hljs-title function_">getState</span>(storePath) })

        <span class="hljs-comment">// 订阅变化</span>
        <span class="hljs-keyword">const</span> unsubscribe = store.<span class="hljs-title function_">subscribe</span>(storePath, <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ [dataKey]: value })
        })

        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_storeUnsubscribes</span>.<span class="hljs-title function_">push</span>(unsubscribe)
      })
    },

    <span class="hljs-title function_">onUnload</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 取消订阅</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_storeUnsubscribes</span>?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">unsub</span>) =&gt;</span> <span class="hljs-title function_">unsub</span>())
    },
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-comment">// pages/cart/cart.js</span>
<span class="hljs-keyword">import</span> { store, connectStore } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../store/index"</span>

<span class="hljs-title class_">Page</span>({
  ...<span class="hljs-title function_">connectStore</span>({
    <span class="hljs-attr">cartItems</span>: <span class="hljs-string">"cart"</span>,
    <span class="hljs-attr">user</span>: <span class="hljs-string">"user"</span>,
  }),

  <span class="hljs-title function_">addToCart</span>(<span class="hljs-params">item</span>) {
    <span class="hljs-keyword">const</span> cart = store.<span class="hljs-title function_">getState</span>(<span class="hljs-string">"cart"</span>)
    store.<span class="hljs-title function_">setState</span>(<span class="hljs-string">"cart"</span>, [...cart, item])
  },

  <span class="hljs-title function_">clearCart</span>(<span class="hljs-params"/>) {
    store.<span class="hljs-title function_">setState</span>(<span class="hljs-string">"cart"</span>, [])
  },
})
</code></pre>
<hr/>
<h2 data-id="heading-16">第五章：调试の"神器"</h2>
<h3 data-id="heading-17">5.1 自制调试面板</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// components/debug-panel/debug-panel.js</span>
<span class="hljs-title class_">Component</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">visible</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">logs</span>: [],
    <span class="hljs-attr">systemInfo</span>: {},
    <span class="hljs-attr">networkType</span>: <span class="hljs-string">""</span>,
    <span class="hljs-attr">performance</span>: {},
  },

  <span class="hljs-attr">lifetimes</span>: {
    <span class="hljs-title function_">attached</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 劫持 console</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">hijackConsole</span>()

      <span class="hljs-comment">// 获取系统信息</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getSystemInfo</span>()

      <span class="hljs-comment">// 监听网络变化</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">watchNetwork</span>()

      <span class="hljs-comment">// 性能监控</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">watchPerformance</span>()
    },
  },

  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">toggle</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">visible</span>: !<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">visible</span> })
    },

    <span class="hljs-title function_">hijackConsole</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> originalLog = <span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>
      <span class="hljs-keyword">const</span> originalError = <span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>
      <span class="hljs-keyword">const</span> originalWarn = <span class="hljs-variable language_">console</span>.<span class="hljs-property">warn</span>

      <span class="hljs-keyword">const</span> <span class="hljs-title function_">addLog</span> = (<span class="hljs-params">type, args</span>) =&gt; {
        <span class="hljs-keyword">const</span> log = {
          type,
          <span class="hljs-attr">content</span>: args
            .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">arg</span>) =&gt;</span>
              <span class="hljs-keyword">typeof</span> arg === <span class="hljs-string">"object"</span>
                ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(arg, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)
                : <span class="hljs-title class_">String</span>(arg)
            )
            .<span class="hljs-title function_">join</span>(<span class="hljs-string">" "</span>),
          <span class="hljs-attr">time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toLocaleTimeString</span>(),
        }

        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
          <span class="hljs-attr">logs</span>: [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">logs</span>.<span class="hljs-title function_">slice</span>(-<span class="hljs-number">99</span>), log], <span class="hljs-comment">// 最多保留 100 条</span>
        })
      }

      <span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span> = <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
        <span class="hljs-title function_">addLog</span>(<span class="hljs-string">"log"</span>, args)
        originalLog.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">console</span>, args)
      }

      <span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span> = <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
        <span class="hljs-title function_">addLog</span>(<span class="hljs-string">"error"</span>, args)
        originalError.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">console</span>, args)
      }

      <span class="hljs-variable language_">console</span>.<span class="hljs-property">warn</span> = <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
        <span class="hljs-title function_">addLog</span>(<span class="hljs-string">"warn"</span>, args)
        originalWarn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">console</span>, args)
      }
    },

    <span class="hljs-title function_">getSystemInfo</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> systemInfo = wx.<span class="hljs-title function_">getSystemInfoSync</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ systemInfo })
    },

    <span class="hljs-title function_">watchNetwork</span>(<span class="hljs-params"/>) {
      wx.<span class="hljs-title function_">getNetworkType</span>({
        <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">networkType</span>: res.<span class="hljs-property">networkType</span> })
        },
      })

      wx.<span class="hljs-title function_">onNetworkStatusChange</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">networkType</span>: res.<span class="hljs-property">networkType</span> })
      })
    },

    <span class="hljs-title function_">watchPerformance</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 获取性能数据</span>
      <span class="hljs-keyword">const</span> performance = wx.<span class="hljs-title function_">getPerformance</span>()
      <span class="hljs-keyword">const</span> observer = performance.<span class="hljs-title function_">createObserver</span>(<span class="hljs-function">(<span class="hljs-params">entryList</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> entries = entryList.<span class="hljs-title function_">getEntries</span>()
        entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">entry</span>) =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Performance] <span class="hljs-subst">${entry.name}</span>: <span class="hljs-subst">${entry.duration}</span>ms`</span>)
        })
      })

      observer.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">"render"</span>, <span class="hljs-string">"script"</span>, <span class="hljs-string">"navigation"</span>] })
    },

    <span class="hljs-title function_">clearLogs</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">logs</span>: [] })
    },

    <span class="hljs-title function_">copyLogs</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> text = <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">logs</span>
        .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">log</span>) =&gt;</span> <span class="hljs-string">`[<span class="hljs-subst">${log.time}</span>] [<span class="hljs-subst">${log.type}</span>] <span class="hljs-subst">${log.content}</span>`</span>)
        .<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>)

      wx.<span class="hljs-title function_">setClipboardData</span>({
        <span class="hljs-attr">data</span>: text,
        <span class="hljs-attr">success</span>: <span class="hljs-function">() =&gt;</span> {
          wx.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">"已复制到剪贴板"</span> })
        },
      })
    },
  },
})
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- debug-panel.wxml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"debug-trigger"</span> <span class="hljs-attr">bindtap</span>=<span class="hljs-string">"toggle"</span>&gt;</span>🐛<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"debug-panel {{visible ? 'visible' : ''}}"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"debug-header"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>调试面板<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">bindtap</span>=<span class="hljs-string">"toggle"</span>&gt;</span>✕<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"debug-tabs"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tab active"</span>&gt;</span>日志<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tab"</span>&gt;</span>系统<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tab"</span>&gt;</span>网络<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">scroll-view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"debug-content"</span> <span class="hljs-attr">scroll-y</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">wx:for</span>=<span class="hljs-string">"{{logs}}"</span> <span class="hljs-attr">wx:key</span>=<span class="hljs-string">"index"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"log-item log-{{item.type}}"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"log-time"</span>&gt;</span>{{item.time}}<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">text</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"log-content"</span>&gt;</span>{{item.content}}<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">scroll-view</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"debug-footer"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"mini"</span> <span class="hljs-attr">bindtap</span>=<span class="hljs-string">"clearLogs"</span>&gt;</span>清空<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"mini"</span> <span class="hljs-attr">bindtap</span>=<span class="hljs-string">"copyLogs"</span>&gt;</span>复制<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
</code></pre>
<h3 data-id="heading-18">5.2 性能监控埋点</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/performance.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMonitor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">marks</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">measures</span> = []
  }

  <span class="hljs-comment">// 标记开始</span>
  <span class="hljs-title function_">mark</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">marks</span>.<span class="hljs-title function_">set</span>(name, <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>())
  }

  <span class="hljs-comment">// 测量耗时</span>
  <span class="hljs-title function_">measure</span>(<span class="hljs-params">name, startMark, endMark</span>) {
    <span class="hljs-keyword">const</span> start = <span class="hljs-variable language_">this</span>.<span class="hljs-property">marks</span>.<span class="hljs-title function_">get</span>(startMark)
    <span class="hljs-keyword">const</span> end = endMark ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">marks</span>.<span class="hljs-title function_">get</span>(endMark) : <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()

    <span class="hljs-keyword">if</span> (!start) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`Mark "<span class="hljs-subst">${startMark}</span>" not found`</span>)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">const</span> duration = end - start
    <span class="hljs-keyword">const</span> measure = { name, duration, <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">measures</span>.<span class="hljs-title function_">push</span>(measure)

    <span class="hljs-comment">// 超过阈值告警</span>
    <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">1000</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[Performance] <span class="hljs-subst">${name}</span> 耗时 <span class="hljs-subst">${duration}</span>ms，超过 1s 阈值`</span>)
    }

    <span class="hljs-keyword">return</span> duration
  }

  <span class="hljs-comment">// 自动测量函数执行时间</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">measureAsync</span>(<span class="hljs-params">name, fn</span>) {
    <span class="hljs-keyword">const</span> startMark = <span class="hljs-string">`<span class="hljs-subst">${name}</span>_start`</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">mark</span>(startMark)

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">measure</span>(name, startMark)
      <span class="hljs-keyword">return</span> result
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">measure</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span>_error`</span>, startMark)
      <span class="hljs-keyword">throw</span> error
    }
  }

  <span class="hljs-comment">// 获取报告</span>
  <span class="hljs-title function_">getReport</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">measures</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">measures</span>,
      <span class="hljs-attr">summary</span>: {
        <span class="hljs-attr">total</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">measures</span>.<span class="hljs-property">length</span>,
        <span class="hljs-attr">avgDuration</span>:
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">measures</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, m</span>) =&gt;</span> sum + m.<span class="hljs-property">duration</span>, <span class="hljs-number">0</span>) /
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">measures</span>.<span class="hljs-property">length</span>,
        <span class="hljs-attr">maxDuration</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(...<span class="hljs-variable language_">this</span>.<span class="hljs-property">measures</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">m</span>) =&gt;</span> m.<span class="hljs-property">duration</span>)),
        <span class="hljs-attr">slowCount</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">measures</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">m</span>) =&gt;</span> m.<span class="hljs-property">duration</span> &gt; <span class="hljs-number">1000</span>).<span class="hljs-property">length</span>,
      },
    }
  }

  <span class="hljs-comment">// 上报数据</span>
  <span class="hljs-title function_">report</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> report = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getReport</span>()

    <span class="hljs-comment">// 上报到服务器</span>
    wx.<span class="hljs-title function_">request</span>({
      <span class="hljs-attr">url</span>: <span class="hljs-string">"https://your-api.com/performance"</span>,
      <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
      <span class="hljs-attr">data</span>: report,
    })

    <span class="hljs-comment">// 清空数据</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">measures</span> = []
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> perfMonitor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceMonitor</span>()

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-comment">// 页面加载性能监控</span>
<span class="hljs-title class_">Page</span>({
  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params"/>) {
    perfMonitor.<span class="hljs-title function_">mark</span>(<span class="hljs-string">"pageLoad_start"</span>)
  },

  <span class="hljs-title function_">onReady</span>(<span class="hljs-params"/>) {
    perfMonitor.<span class="hljs-title function_">measure</span>(<span class="hljs-string">"pageLoad"</span>, <span class="hljs-string">"pageLoad_start"</span>)
  },

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> perfMonitor.<span class="hljs-title function_">measureAsync</span>(<span class="hljs-string">"fetchData"</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">request</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">"/api/data"</span> })
      <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>
    })

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ data })
  },
})
</code></pre>
<hr/>
<h2 data-id="heading-19">写在最后：邪修有风险，使用需谨慎</h2>
<p>这些"邪修"技巧，都是在实际项目中踩坑后总结出来的。</p>
<p><strong>它们有几个共同特点：</strong></p>
<ol>
<li><strong>官方文档不会告诉你</strong>：因为这些不是"标准做法"</li>
<li><strong>可能随时失效</strong>：微信更新后，某些 hack 可能不再有效</li>
<li><strong>有一定风险</strong>：绕过官方限制，可能带来兼容性问题</li>
<li><strong>但确实有效</strong>：在特定场景下，能解决实际问题</li>
</ol>
<p><strong>使用建议：</strong></p>
<ul>
<li>优先使用官方方案</li>
<li>邪修技巧作为备选</li>
<li>做好兼容性测试</li>
<li>关注微信更新日志</li>
<li>随时准备替代方案</li>
</ul>
<p><strong>最后，愿你的小程序：</strong></p>
<ul>
<li>性能如丝般顺滑</li>
<li>体验如原生般流畅</li>
<li>Bug 如晨露般消散</li>
<li>审核如绿灯般通过</li>
</ul>
<hr/>
<blockquote>
<p>💬 <strong>互动时间</strong>：你在小程序开发中遇到过什么奇葩问题？用了什么骚操作解决的？评论区分享一下你的"邪修"经验！</p>
<p>觉得这篇文章有用？<strong>点赞 + 在看 + 转发</strong>，让更多小程序开发者少踩坑～</p>
</blockquote>
<hr/>
<p><em>本文作者是一个在小程序坑里摸爬滚打多年的老开发。关注我，一起在微信的"围墙花园"里优雅地生存。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 ViewPager2 + Fragment 架构中玩转 Jetpack Compose]]></title>    <link>https://juejin.cn/post/7592040819818381353</link>    <guid>https://juejin.cn/post/7592040819818381353</guid>    <pubDate>2026-01-07T02:38:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592040819818381353" data-draft-id="7592058764120637459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 ViewPager2 + Fragment 架构中玩转 Jetpack Compose"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-07T02:38:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户4165967369355"/> <meta itemprop="url" content="https://juejin.cn/user/1146150492576877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 ViewPager2 + Fragment 架构中玩转 Jetpack Compose
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1146150492576877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户4165967369355
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T02:38:41.000Z" title="Wed Jan 07 2026 02:38:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着 Android 开发进入 Compose 时代，许多开发者选择在现有的 <code>ViewPager2</code> 架构中引入 Compose，通过这种“混合模式”平滑过渡。虽然两者可以共存，但由于 View 系统与 Compose 的底层渲染机制存在差异，实际落地时有几个**“深坑”**必须避开。</p>
<p>本文总结了在 <code>ViewPager2 + Fragment</code> 中使用 Compose 的四大核心要点。</p>
<hr/>
<h2 data-id="heading-0">1. 内存泄漏的“隐形杀手”：ViewCompositionStrategy</h2>
<p>在 Fragment 中使用 <code>ComposeView</code> 时，最常见的问题是 <strong>Composition（组合）的销毁时机</strong>。</p>
<ul>
<li><strong>痛点</strong>：Fragment 的 View 生命周期与 Fragment 对象本身的生命周期是不一致的。如果 Compose 不知道 View 已经销毁，它可能会继续持有引用，导致内存泄漏或崩溃。</li>
<li><strong>对策</strong>：必须在 <code>onCreateView</code> 中明确指定销毁策略。</li>
</ul>
<p>Kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(
    inflater: <span class="hljs-type">LayoutInflater</span>, container: <span class="hljs-type">ViewGroup</span>?, savedInstanceState: <span class="hljs-type">Bundle</span>?
)</span></span>: View {
    <span class="hljs-keyword">return</span> ComposeView(requireContext()).apply {
        <span class="hljs-comment">// 关键代码：确保 View 被销毁时，Composition 也能正确清理</span>
        setViewCompositionStrategy(
            ViewCompositionStrategy.DisposeOnViewTreeLifecycleDestroyed
        )
        setContent {
            MaterialTheme {
                MyPagerScreen()
            }
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-1">2. 状态丢失：记住 rememberSaveable</h2>
<p><code>ViewPager2</code> 默认会销毁超出缓存范围（<code>offscreenPageLimit</code>）的 Fragment 视图。</p>
<ul>
<li>
<p><strong>痛点</strong>：当我们从第 1 页滑动到第 10 页，再滑回第 1 页时，原本输入的文字或滑动的位置可能消失了。</p>
</li>
<li>
<p><strong>对策</strong>：</p>
<ol>
<li><strong>Compose 内部状态</strong>：使用 <code>rememberSaveable</code> 代替 <code>remember</code>。</li>
<li><strong>业务逻辑状态</strong>：将状态托管在 <code>ViewModel</code> 中，并利用 <code>collectAsStateWithLifecycle()</code> 进行观察。</li>
</ol>
</li>
</ul>
<hr/>
<h2 data-id="heading-2">3. 滑动冲突：横向滚动的博弈</h2>
<p><code>ViewPager2</code> 本质上是一个横向滑动的 <code>RecyclerView</code>，而 Compose 里的 <code>LazyRow</code> 也是横滑。</p>
<ul>
<li><strong>痛点</strong>：当我们在 Compose 内部滑动列表时，可能会意外触发 ViewPager 的翻页。</li>
<li><strong>现状</strong>：Compose 1.2+ 已经支持了嵌套滚动（Nested Scrolling）。但在某些复杂交互（如内嵌地图或自定义绘图）中，我们仍需手动干预。</li>
<li><strong>Tips</strong>：如果遇到极端的滑动冲突，可以通过 <code>Modifier.pointerInput</code> 结合 <code>requestDisallowInterceptTouchEvent(true)</code> 来强制让 Compose 优先获得控制权。</li>
</ul>
<hr/>
<h2 data-id="heading-3">4. 预加载与性能调优：OffscreenPageLimit</h2>
<p>Compose 的首次渲染（Initial Composition）相对 View 来说更消耗 CPU 资源。</p>
<ul>
<li>
<p><strong>问题</strong>：快速滑动 ViewPager2 时，Compose 界面可能会出现短暂的白屏或掉帧。</p>
</li>
<li>
<p><strong>优化方案</strong>：</p>
<ul>
<li><strong>设置预加载</strong>：<code>viewPager2.offscreenPageLimit = 1</code>。这会提前初始化相邻页面的 Compose 内容，牺牲少量内存换取丝滑的滑动体验。</li>
<li><strong>基线配置文件 (Baseline Profiles)</strong> ：在生产环境下使用 Baseline Profiles，可以显著提升 Compose 组件的冷启动性能，减少滑动卡顿。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-4">总结</h2>
<p>在 <code>ViewPager2</code> 中嵌套 <code>Fragment</code> + <code>Compose</code> 是目前的黄金过渡方案。只要记住**“策略销毁、状态持久、预加载优化”**这三板斧，就能在享受 Compose 开发效率的同时，保证应用的稳定性。</p>
<p><strong>💡 避坑 checklist：</strong></p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否设置了 <code>DisposeOnViewTreeLifecycleDestroyed</code>？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 关键 UI 状态是否使用了 <code>rememberSaveable</code>？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否针对 <code>ViewPager2</code> 开启了合理的 <code>offscreenPageLimit</code>？</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android进程模型基础]]></title>    <link>https://juejin.cn/post/7592152007839219712</link>    <guid>https://juejin.cn/post/7592152007839219712</guid>    <pubDate>2026-01-07T03:39:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592152007839219712" data-draft-id="7592127014188236800" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android进程模型基础"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-07T03:39:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户7458900207954"/> <meta itemprop="url" content="https://juejin.cn/user/2788814857713687"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android进程模型基础
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788814857713687/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户7458900207954
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T03:39:21.000Z" title="Wed Jan 07 2026 03:39:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基础回顾</h2>



































<table><thead><tr><th>维度</th><th>进程</th><th>线程</th></tr></thead><tbody><tr><td>定义</td><td>操作系统资源分配的基本单位</td><td>CPU调度的基本单位</td></tr><tr><td>内存空间</td><td>独立内存空间，相互隔离</td><td>共享进程的内存空间</td></tr><tr><td>通信方式</td><td>IPC（Binder、Socket、共享文件等）</td><td>共享内存、Handler等</td></tr><tr><td>创建开销</td><td>大（需分配独立内存空间）</td><td>小（共享进程资源）</td></tr><tr><td>Android 体现</td><td>每个应用默认一个进程，可配置多进程</td><td>主线程（UI线程）+ 工作线程</td></tr></tbody></table>
<h2 data-id="heading-1">Android进程</h2>
<p>Android基于Linux内核，但有自己的进程管理策略</p>
<pre><code class="hljs language-xml" lang="xml">// 在AndroidManifest.xml中声明进程
<span class="hljs-tag">&lt;<span class="hljs-name">application</span>
    <span class="hljs-attr">android:process</span>=<span class="hljs-string">":remote"</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 冒号表示私有进程 --&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 默认情况下，所有组件运行在application指定的进程中 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">".MainActivity"</span> /&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 可以为特定组件指定不同进程 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">service</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">".RemoteService"</span>
        <span class="hljs-attr">android:process</span>=<span class="hljs-string">":background"</span> /&gt;</span>
        
    <span class="hljs-tag">&lt;<span class="hljs-name">activity</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">".WebViewActivity"</span>
        <span class="hljs-attr">android:process</span>=<span class="hljs-string">":webview"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
</code></pre>
<p><strong>默认情况下，一个Android应用运行在一个进程中</strong>。这个进程的名称通常就是应用的包名。</p>
<p>虽然默认是单进程，但在以下场景中需要考虑多进程：</p>
<ul>
<li>规避内存限制</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 在AndroidManifest中为组件指定独立进程 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">application</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 主进程，负责UI --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">".MainActivity"</span> /&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 独立进程，处理内存密集型任务 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">service</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">".ImageProcessingService"</span>
        <span class="hljs-attr">android:process</span>=<span class="hljs-string">":image_process"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
</code></pre>
<p>每个进程有独立的内存空间。Android为每个进程设置内存上限（比如256MB）。如果应用需要处理大图、视频等，可以放到独立进程，避免主进程OOM。</p>
<ul>
<li>独立运行的组件</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 音乐播放器应用：播放服务运行在独立进程</span>
<span class="hljs-comment">// 这样即使主进程崩溃，音乐还能继续播放</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MusicService</span> : <span class="hljs-type">Service</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        Log.d(<span class="hljs-string">"MusicService"</span>, <span class="hljs-string">"运行在独立进程，进程名: <span class="hljs-subst">${getProcessName()}</span>"</span>)
    }
}
</code></pre>
<p>使用场景例如：播放器，音乐播放不受UI进程影响；下载器，下载任务独立运行；推送服务，保持长连接，与UI逻辑分离。</p>
<ul>
<li>隔离不稳定模块</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- WebView独立进程，避免崩溃影响主应用 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">activity</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">".WebViewActivity"</span>
    <span class="hljs-attr">android:process</span>=<span class="hljs-string">":webview"</span> /&gt;</span>
</code></pre>
<p>WebView、第三方SDK等可能不稳定的模块，放在独立进程可以避免崩溃影响主应用。</p>
<ul>
<li>提升性能（谨慎使用）</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 将频繁GC的后台任务放到独立进程 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">service</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">".DataSyncService"</span>
    <span class="hljs-attr">android:process</span>=<span class="hljs-string">":sync"</span> /&gt;</span>
</code></pre>
<p>如果某个组件频繁创建/销毁对象导致GC，会影响UI流畅度。独立进程后，GC只影响该进程。</p>
<h3 data-id="heading-2">多进程优缺点</h3>






























<table><thead><tr><th>优点</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>内存隔离</td><td>每个进程独立内存空间，可突破单进程内存限制</td><td>图片编辑应用：UI进程 + 图片处理进程</td></tr><tr><td>稳定性提升</td><td>一个进程崩溃不影响其他进程</td><td>WebView崩溃不会导致整个应用退出</td></tr><tr><td>安全隔离</td><td>敏感操作可在独立进程进行</td><td>支付模块运行在独立进程</td></tr><tr><td>性能优化</td><td>可利用多核CPU并行计算</td><td>视频转码应用使用多进程并行处理</td></tr></tbody></table>






























<table><thead><tr><th>缺点</th><th>说明</th><th>解决方案</th></tr></thead><tbody><tr><td>通信复杂</td><td>进程间不能直接共享内存，需要IPC</td><td>使用Binder、Messenger、AIDL等</td></tr><tr><td>开销增大</td><td>每个进程都有独立的内存、类加载等开销</td><td>谨慎创建，避免过多进程</td></tr><tr><td>数据同步难</td><td>共享数据需要额外机制</td><td>使用ContentProvider、文件、SharedPreferences（MODE_MULTI_PROCESS已废弃）</td></tr><tr><td>调试困难</td><td>多进程调试复杂，需附加到不同进程</td><td>使用Android Studio的多进程调试功能</td></tr></tbody></table>
<h2 data-id="heading-3">Android进程的创建过程</h2>
<h3 data-id="heading-4">Zygote：所有应用的"母体"</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6847d66b6cda4b06b30d790601efd411~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzQ1ODkwMDIwNzk1NA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768361961&amp;x-signature=IsGUOgE1%2FMMSTx3o5x%2FUL%2FJpm%2B4%3D" alt="image.png" loading="lazy"/></p>
<p>当系统需要启动一个新的应用时，如果为每个应用都从头初始化整个运行环境（包括加载系统资源、类库等），会非常耗时。Zygote进程就是为了解决这个问题而设计的。</p>
<p>Zygote进程在系统启动时被创建，它已经完成了：</p>
<ol>
<li>初始化虚拟机（DVM/ART）</li>
<li>加载系统资源</li>
<li>预加载Android框架的类和资源</li>
</ol>
<p>当需要启动新应用时，Zygote会<code>fork</code>出一个子进程。这个子进程会继承Zygote进程已经加载的系统资源和类，这样新进程就无需重新加载这些，从而大大加快了启动速度。</p>
<p>fork是Unix/Linux系统中创建新进程的系统调用。传统上，fork会复制父进程的整个地址空间给子进程。但是，如果父进程很大，那么复制整个地址空间将会非常耗时，而且子进程可能很快就会通过exec系统调用加载一个新的程序，这样刚才复制的地址空间就被完全替换了，导致复制操作白费了。</p>
<p>为了解决这个问题，现代操作系统（包括Linux）实现了写时复制（Copy-on-Write，简称COW）技术。其核心思想是：当父进程调用fork创建子进程时，内核并不复制整个进程的地址空间，而是让子进程和父进程共享相同的物理内存页。但是，这些内存页会被标记为写时复制。也就是说，当父进程或子进程试图修改某个内存页时，内核才会复制这个页，然后让修改方拥有这个页的私有副本。</p>
<p>这样，fork操作就变得非常轻量，因为只需要复制父进程的页表（一种数据结构，用于将虚拟地址映射到物理地址），而不需要复制实际的物理内存页。子进程几乎可以立即开始运行。</p>
<h3 data-id="heading-5">进程优先级：Android如何管理进程生死</h3>
<p>Android根据进程的重要性动态调整优先级：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ProcessList.java中定义的进程优先级</span>
<span class="hljs-comment">// 数字越小优先级越高</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">FOREGROUND_APP_ADJ</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;      <span class="hljs-comment">// 前台应用</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">VISIBLE_APP_ADJ</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;       <span class="hljs-comment">// 可见应用</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PERCEPTIBLE_APP_ADJ</span> <span class="hljs-operator">=</span> <span class="hljs-number">200</span>;   <span class="hljs-comment">// 可感知应用（如播放音乐）</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BACKUP_APP_ADJ</span> <span class="hljs-operator">=</span> <span class="hljs-number">300</span>;        <span class="hljs-comment">// 备份进程</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CACHED_APP_MIN_ADJ</span> <span class="hljs-operator">=</span> <span class="hljs-number">350</span>;    <span class="hljs-comment">// 缓存应用（最低）</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CACHED_APP_MAX_ADJ</span> <span class="hljs-operator">=</span> <span class="hljs-number">400</span>;
</code></pre>
<pre><code class="hljs">应用启动 → 前台进程（最高优先级）
用户按Home键 → 可见进程（次高优先级）
转到其他应用 → 服务进程（如果有Service）
长时间在后台 → 缓存进程（可能被回收）
</code></pre>
<p>Android的进程回收机制主要通过 <strong>Low Memory Killer (LMK)</strong> 和 <strong>OOM Adj</strong>评分系统来实现智能管理。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 简化版LMK内核代码逻辑（kernel/drivers/staging/android/lowmemorykiller.c）</span>
<span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">lowmemory_killer</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> {
    <span class="hljs-keyword">while</span> (!kthread_should_stop()) {
        <span class="hljs-comment">// 1. 检查当前内存压力</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">other_free</span> <span class="hljs-operator">=</span> global_page_state(NR_FREE_PAGES);
        <span class="hljs-type">int</span> <span class="hljs-variable">other_file</span> <span class="hljs-operator">=</span> global_page_state(NR_FILE_PAGES);
        
        <span class="hljs-comment">// 2. 遍历进程，计算"badness"分数</span>
        for_each_process(p) {
            <span class="hljs-comment">// 跳过不可杀进程（init、kthread等）</span>
            <span class="hljs-keyword">if</span> (p-&gt;flags &amp; PF_KTHREAD)
                <span class="hljs-keyword">continue</span>;
            
            <span class="hljs-comment">// 获取进程的oom_score_adj（用户空间设置）</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">oom_score_adj</span> <span class="hljs-operator">=</span> p-&gt;signal-&gt;oom_score_adj;
            <span class="hljs-keyword">if</span> (oom_score_adj == OOM_SCORE_ADJ_MAX)
                <span class="hljs-keyword">continue</span>;
            
            <span class="hljs-comment">// 3. 计算综合分数</span>
            points = oom_badness(p, NULL, nodemask, totalpages);
            
            <span class="hljs-comment">// 4. 找到最"坏"的进程</span>
            <span class="hljs-keyword">if</span> (points &gt; selected_points) {
                selected = p;
                selected_points = points;
            }
        }
        
        <span class="hljs-comment">// 5. 如果内存紧张，杀掉选中的进程</span>
        <span class="hljs-keyword">if</span> (selected) {
            send_sig(SIGKILL, selected, <span class="hljs-number">0</span>);
        }
        
        <span class="hljs-comment">// 6. 休眠，等待下一次检查</span>
        schedule_timeout_interruptible(poll_interval);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gradle脚本执行]]></title>    <link>https://juejin.cn/post/7592234632482455561</link>    <guid>https://juejin.cn/post/7592234632482455561</guid>    <pubDate>2026-01-07T03:54:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592234632482455561" data-draft-id="7592164124660351026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gradle脚本执行"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-07T03:54:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GoldenPlayer"/> <meta itemprop="url" content="https://juejin.cn/user/2999123453948119"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gradle脚本执行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123453948119/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GoldenPlayer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T03:54:23.000Z" title="Wed Jan 07 2026 03:54:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>只要 <code>apply from: 'config.gradle'</code> 这行代码被读到，<code>config.gradle</code> 里的代码就会被立即执行。</strong></p>
<h3 data-id="heading-0">详细解释为什么</h3>
<p>Gradle 的生命周期分为三个阶段，这对于理解脚本执行时机非常重要：</p>
<ol>
<li>
<p><strong>初始化阶段 (Initialization)</strong>：
Gradle 决定有哪些项目参与构建（读取 <code>settings.gradle</code>）</p>
</li>
<li>
<p><strong>配置阶段 (Configuration) —— <strong>重点在这里</strong></strong>：</p>
<ul>
<li>当点击 <strong>Sync</strong>（大象图标）或者点击 <strong>Run</strong>（绿色三角形）时，Gradle <strong>必须</strong>先执行这个阶段。</li>
<li>在这个阶段，Gradle 会把所有的 <code>build.gradle</code> 文件从头到尾执行一遍，为了搞清楚项目有哪些依赖、版本号是多少、有哪些 Task 等等。</li>
<li>当根目录的 <code>build.gradle</code> 执行到 <code>apply from: 'config.gradle'</code> 这一行时，它会<strong>立即跳转</strong>去执行 <code>config.gradle</code> 的全部内容。</li>
<li>因此，<code>ext { ... }</code> 里的 <code>buildNum = getAndIncrementBuildNum()</code> 会被立即调用</li>
</ul>
</li>
<li>
<p><strong>执行阶段 (Execution)</strong>：</p>
<ul>
<li>只有当你真正编译（Run/Assemble）时才会进入这个阶段。这里才是真正执行编译 Java/Kotlin 代码、打包 APK 的地方</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-1">这对 <code>buildNum</code> 意味着什么？</h3>
<p>正因为 <code>config.gradle</code> 在 <strong>Sync</strong> 阶段（配置阶段）就会被执行，所以在写自增逻辑时必须非常小心：</p>
<ul>
<li>
<p><strong>如果不加判断</strong>：
每次点击 Sync，或者修改了 <code>build.gradle</code> 自动刷新，<code>getAndIncrementBuildNum()</code> 就会跑一遍，导致 <code>version.properties</code> 里的数字莫名其妙一直增加。</p>
</li>
<li>
<p><strong>加了 <code>taskNames</code> 判断后</strong>：</p>
<ol>
<li><strong>Sync 时</strong>：Gradle 执行 <code>config.gradle</code> -&gt; 调用 <code>getAndIncrementBuildNum()</code> -&gt; 获取到 <code>taskNames</code> 是空的（或者只是 generate 任务） -&gt; <strong>代码逻辑判断不满足条件</strong> -&gt; <strong>只读取旧值，不执行 <code>+1</code> 写入操作</strong>。</li>
<li><strong>打包/Run 时</strong>：Gradle 执行 <code>config.gradle</code> -&gt; 调用 <code>getAndIncrementBuildNum()</code> -&gt; 获取到 <code>taskNames</code> 包含 "assemble" -&gt; <strong>代码逻辑满足条件</strong> -&gt; <strong>执行 <code>+1</code> 并写入文件</strong>。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-2">关于代码位置</h3>
<p>在 <code>root/build.gradle</code> 中写的：</p>
<pre><code class="hljs language-groovy" lang="groovy">buildscript {
    apply from: 'config.gradle' // &lt;--- 就在这一行
    // ...
}
</code></pre>
<p>这行代码让 <code>config.gradle</code> 成为了构建脚本的一部分。一旦执行到这里，<code>config.gradle</code> 里的 <code>ext</code> 变量就会被加载到内存中，供后面的 <code>allprojects</code> 或者 <code>app/build.gradle</code> 使用</p>
<h3 data-id="heading-3">总结</h3>
<ol>
<li><strong>执行了吗？</strong> 是的，每次 Sync 或 Build 必执行</li>
<li><strong>为什么看不到效果？</strong> 之前是因为只有在 <code>release</code> 任务时才写入文件，而可能是在点 <code>Run</code> (debug) 或者 <code>Sync</code>，导致逻辑走进了 <code>else</code> 分支（不保存）</li>
<li><strong>现在的解决办法</strong>：它通过检测 <code>taskNames</code> 来区分“仅仅是 Sync”还是“真正的打包/运行”，从而决定是否要增加版本号</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手配置 Ralph -- 火爆 X 的全自动 AI 编程工具]]></title>    <link>https://juejin.cn/post/7592089325913440256</link>    <guid>https://juejin.cn/post/7592089325913440256</guid>    <pubDate>2026-01-07T02:20:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592089325913440256" data-draft-id="7592127014188154880" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手配置 Ralph  -- 火爆 X 的全自动 AI 编程工具"/> <meta itemprop="keywords" content="前端,后端,GitHub"/> <meta itemprop="datePublished" content="2026-01-07T02:20:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Charlo"/> <meta itemprop="url" content="https://juejin.cn/user/1239904845853870"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手配置 Ralph  -- 火爆 X 的全自动 AI 编程工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904845853870/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Charlo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T02:20:03.000Z" title="Wed Jan 07 2026 02:20:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">工具背景</h2>
<h3 data-id="heading-1">1. 角色介绍：Ralph Wiggum (拉尔夫·维/威格姆)</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/911475286774481fbd30db929e91c636~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768357202&amp;x-signature=sX8zgtelYQ2TxL90o9NrFQLHQk4%3D" alt="G9-gtHmW0AE8pmK.jfif" loading="lazy"/>
<strong>出处：</strong>  《辛普森一家》(The Simpsons)[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fvertexaisearch.cloud.google.com%252Fgrounding-api-redirect%252FAUZIYQFituw0EQEANs5tUm0fBhF0ohGW-yc4l9MklnAfs5wVnYRdvexWDQvuMMZNZw4N4J-TO0zR1MGFsoMd5pgNhVx7C8O_ZlMkOv0pABluAZLsjl4Vr7AjXsdXpKKrmIz_Pg6QvEWtyg3niS8U" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQFituw0EQEANs5tUm0fBhF0ohGW-yc4l9MklnAfs5wVnYRdvexWDQvuMMZNZw4N4J-TO0zR1MGFsoMd5pgNhVx7C8O_ZlMkOv0pABluAZLsjl4Vr7AjXsdXpKKrmIz_Pg6QvEWtyg3niS8U" ref="nofollow noopener noreferrer">1</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fvertexaisearch.cloud.google.com%252Fgrounding-api-redirect%252FAUZIYQFYu_2zwukIiw8ai2BfvlaTCI17E9en3WIh12d5D5fU6PponFSjtJWFtIWPeelsoSHEL2gmD4pR-VAv8PigBXTedgdlibOlysvVTFtkALDwGQAtaDT361ZpFGkZo-2bRMOuSeYIXScMvHmv246OBkmqZD_LZfxMd-rsIcIzTx3QCwP7HiqvmHZxD3uqrUwjHwd1WksIW7uvK3OXJBJQGShslw%253D%253D" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQFYu_2zwukIiw8ai2BfvlaTCI17E9en3WIh12d5D5fU6PponFSjtJWFtIWPeelsoSHEL2gmD4pR-VAv8PigBXTedgdlibOlysvVTFtkALDwGQAtaDT361ZpFGkZo-2bRMOuSeYIXScMvHmv246OBkmqZD_LZfxMd-rsIcIzTx3QCwP7HiqvmHZxD3uqrUwjHwd1WksIW7uvK3OXJBJQGShslw%3D%3D" ref="nofollow noopener noreferrer">2</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fvertexaisearch.cloud.google.com%252Fgrounding-api-redirect%252FAUZIYQGv0l_98-Ff2aihGC0vH2igcbQMSZbD2Yft1OOZCLmEHZXc19JFOmU_YyIqiXy_sriuVZQ4eXd8shtHCmJ1WUi-UfWx8YmI0b86IDH_0znw2kC7ANNQtA%253D%253D" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQGv0l_98-Ff2aihGC0vH2igcbQMSZbD2Yft1OOZCLmEHZXc19JFOmU_YyIqiXy_sriuVZQ4eXd8shtHCmJ1WUi-UfWx8YmI0b86IDH_0znw2kC7ANNQtA%3D%3D" ref="nofollow noopener noreferrer">3</a>]</p>
<ul>
<li>
<p><strong>身份：</strong>  斯普林菲尔德小学 (Springfield Elementary) 的二年级学生，这也是警察局长克兰西·维格姆 (Chief Wiggum) 的儿子。</p>
</li>
<li>
<p><strong>性格特征：</strong></p>
<ul>
<li>
<p><strong>天真与怪诞：</strong>  Ralph 是剧中典型的“大智若愚”或纯粹“脱线”的角色。他经常说出一些毫无逻辑、与当下情境无关的经典台词（Non-sequiturs），既好笑又带有一种奇怪的诗意。</p>
</li>
<li>
<p><strong>单纯善良：</strong>  尽管他经常被视为“由于某种原因不太聪明”的孩子，但他心地非常善良，几乎没有恶意。</p>
</li>
<li>
<p><strong>经典台词：</strong></p>
<ul>
<li>"I'm in danger!" (我即使身处险境也只会傻笑地说这句话，已成为极著名的互联网迷因/表情包)</li>
<li>"Me fail English? That's unpossible!" (我英语挂科了？那是不可能的！——语法本身就是错的)</li>
<li>"My cat's breath smells like cat food." (我猫咪的嘴巴闻起来像猫粮。)</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. 工具介绍：Ralph (AI Coding Agent / Workflow)</h3>
<p> <strong>The Ralph Wiggum Technique</strong> (拉尔夫[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fvertexaisearch.cloud.google.com%252Fgrounding-api-redirect%252FAUZIYQFituw0EQEANs5tUm0fBhF0ohGW-yc4l9MklnAfs5wVnYRdvexWDQvuMMZNZw4N4J-TO0zR1MGFsoMd5pgNhVx7C8O_ZlMkOv0pABluAZLsjl4Vr7AjXsdXpKKrmIz_Pg6QvEWtyg3niS8U" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQFituw0EQEANs5tUm0fBhF0ohGW-yc4l9MklnAfs5wVnYRdvexWDQvuMMZNZw4N4J-TO0zR1MGFsoMd5pgNhVx7C8O_ZlMkOv0pABluAZLsjl4Vr7AjXsdXpKKrmIz_Pg6QvEWtyg3niS8U" ref="nofollow noopener noreferrer">1</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fvertexaisearch.cloud.google.com%252Fgrounding-api-redirect%252FAUZIYQFYu_2zwukIiw8ai2BfvlaTCI17E9en3WIh12d5D5fU6PponFSjtJWFtIWPeelsoSHEL2gmD4pR-VAv8PigBXTedgdlibOlysvVTFtkALDwGQAtaDT361ZpFGkZo-2bRMOuSeYIXScMvHmv246OBkmqZD_LZfxMd-rsIcIzTx3QCwP7HiqvmHZxD3uqrUwjHwd1WksIW7uvK3OXJBJQGShslw%253D%253D" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQFYu_2zwukIiw8ai2BfvlaTCI17E9en3WIh12d5D5fU6PponFSjtJWFtIWPeelsoSHEL2gmD4pR-VAv8PigBXTedgdlibOlysvVTFtkALDwGQAtaDT361ZpFGkZo-2bRMOuSeYIXScMvHmv246OBkmqZD_LZfxMd-rsIcIzTx3QCwP7HiqvmHZxD3uqrUwjHwd1WksIW7uvK3OXJBJQGShslw%3D%3D" ref="nofollow noopener noreferrer">2</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fvertexaisearch.cloud.google.com%252Fgrounding-api-redirect%252FAUZIYQHyFXfMFoR2N52qXupW_4xSPkY5qwA30y31gOpp581kPsWsFArIFVaSvkvPsq9pr8RQxQvEWuVHKfx7NjnzfECysVTjxZ-j6CphwEq_ZDiXfnQTrKYTdE1pKN-65oLHCiLO5wOb3tBFR_e-zGofSBV8oWoMMw%253D%253D" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQHyFXfMFoR2N52qXupW_4xSPkY5qwA30y31gOpp581kPsWsFArIFVaSvkvPsq9pr8RQxQvEWuVHKfx7NjnzfECysVTjxZ-j6CphwEq_ZDiXfnQTrKYTdE1pKN-65oLHCiLO5wOb3tBFR_e-zGofSBV8oWoMMw%3D%3D" ref="nofollow noopener noreferrer">4</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fvertexaisearch.cloud.google.com%252Fgrounding-api-redirect%252FAUZIYQGIk9jnzUUOAqVhhzlBaaDerJUat5AESijp0zWmdoLjN-Z_Sx2BSQ-lnFr8pxvo3nsdtEKU8_j-XJIRIVNa2YBQzg2-N-Zkbm2aw3rq24aJtNYt-6FcWQq0y9H9e7ePVQZOx9oIfJw8qrbx9e8%253D" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQGIk9jnzUUOAqVhhzlBaaDerJUat5AESijp0zWmdoLjN-Z_Sx2BSQ-lnFr8pxvo3nsdtEKU8_j-XJIRIVNa2YBQzg2-N-Zkbm2aw3rq24aJtNYt-6FcWQq0y9H9e7ePVQZOx9oIfJw8qrbx9e8%3D" ref="nofollow noopener noreferrer">5</a>]·维格姆技术) 或 <strong>Ralph Loop</strong>，是近期（2024-2025年）在 AI 辅助编程领域兴起的一种工具/工作流概念。[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fvertexaisearch.cloud.google.com%252Fgrounding-api-redirect%252FAUZIYQFYu_2zwukIiw8ai2BfvlaTCI17E9en3WIh12d5D5fU6PponFSjtJWFtIWPeelsoSHEL2gmD4pR-VAv8PigBXTedgdlibOlysvVTFtkALDwGQAtaDT361ZpFGkZo-2bRMOuSeYIXScMvHmv246OBkmqZD_LZfxMd-rsIcIzTx3QCwP7HiqvmHZxD3uqrUwjHwd1WksIW7uvK3OXJBJQGShslw%253D%253D" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQFYu_2zwukIiw8ai2BfvlaTCI17E9en3WIh12d5D5fU6PponFSjtJWFtIWPeelsoSHEL2gmD4pR-VAv8PigBXTedgdlibOlysvVTFtkALDwGQAtaDT361ZpFGkZo-2bRMOuSeYIXScMvHmv246OBkmqZD_LZfxMd-rsIcIzTx3QCwP7HiqvmHZxD3uqrUwjHwd1WksIW7uvK3OXJBJQGShslw%3D%3D" ref="nofollow noopener noreferrer">2</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fvertexaisearch.cloud.google.com%252Fgrounding-api-redirect%252FAUZIYQGv0l_98-Ff2aihGC0vH2igcbQMSZbD2Yft1OOZCLmEHZXc19JFOmU_YyIqiXy_sriuVZQ4eXd8shtHCmJ1WUi-UfWx8YmI0b86IDH_0znw2kC7ANNQtA%253D%253D" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQGv0l_98-Ff2aihGC0vH2igcbQMSZbD2Yft1OOZCLmEHZXc19JFOmU_YyIqiXy_sriuVZQ4eXd8shtHCmJ1WUi-UfWx8YmI0b86IDH_0znw2kC7ANNQtA%3D%3D" ref="nofollow noopener noreferrer">3</a>]</p>
<p><strong>背景与命名来源：</strong><br/>
这个工具/技术的命名正是致敬了上述的《辛普森一家》角色 Ralph Wiggum。开发者之所以这样命名，是因为这个 AI 代理的工作方式就像 Ralph 一样——<strong>虽然它可能一开始看起来笨笨的，总是犯错（比如代码跑不通），但它非常执着（Persistent），会一直尝试直到把事情做对。</strong></p>
<p><strong>核心功能与用途：</strong></p>
<ul>
<li>
<p><strong>不仅仅是聊天机器人：</strong>  它是基于 <strong>Claude Code</strong> (Anthropic 推出的 CLI 工具) 或类似 LLM 的一种自动化脚本或插件。</p>
</li>
<li>
<p><strong>死循环纠错 (The Loop)：</strong>  它的核心是一个 Bash 循环 (Loop)。当你给它一个编程任务（比如“修复这个 bug”或“重构这个模块”），它不仅是写一次代码，而是会：</p>
<ol>
<li>写代码。[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fvertexaisearch.cloud.google.com%252Fgrounding-api-redirect%252FAUZIYQHyFXfMFoR2N52qXupW_4xSPkY5qwA30y31gOpp581kPsWsFArIFVaSvkvPsq9pr8RQxQvEWuVHKfx7NjnzfECysVTjxZ-j6CphwEq_ZDiXfnQTrKYTdE1pKN-65oLHCiLO5wOb3tBFR_e-zGofSBV8oWoMMw%253D%253D" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQHyFXfMFoR2N52qXupW_4xSPkY5qwA30y31gOpp581kPsWsFArIFVaSvkvPsq9pr8RQxQvEWuVHKfx7NjnzfECysVTjxZ-j6CphwEq_ZDiXfnQTrKYTdE1pKN-65oLHCiLO5wOb3tBFR_e-zGofSBV8oWoMMw%3D%3D" ref="nofollow noopener noreferrer">4</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fvertexaisearch.cloud.google.com%252Fgrounding-api-redirect%252FAUZIYQEcnUvxl3_eYgtZf94US3BKguEIFiTBg_PgJCrg3qWvzmM-VIfClzWJqPrs0bO58DfV_D_Dq1F5zcCXhFrDhy2CvpybTdoVsYVvzizU3NXQ29QCpIbyZGry2nmzWzMcPxsBTTf5sY8%253D" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQEcnUvxl3_eYgtZf94US3BKguEIFiTBg_PgJCrg3qWvzmM-VIfClzWJqPrs0bO58DfV_D_Dq1F5zcCXhFrDhy2CvpybTdoVsYVvzizU3NXQ29QCpIbyZGry2nmzWzMcPxsBTTf5sY8%3D" ref="nofollow noopener noreferrer">6</a>]</li>
<li>运行测试/命令。[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fvertexaisearch.cloud.google.com%252Fgrounding-api-redirect%252FAUZIYQHyFXfMFoR2N52qXupW_4xSPkY5qwA30y31gOpp581kPsWsFArIFVaSvkvPsq9pr8RQxQvEWuVHKfx7NjnzfECysVTjxZ-j6CphwEq_ZDiXfnQTrKYTdE1pKN-65oLHCiLO5wOb3tBFR_e-zGofSBV8oWoMMw%253D%253D" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQHyFXfMFoR2N52qXupW_4xSPkY5qwA30y31gOpp581kPsWsFArIFVaSvkvPsq9pr8RQxQvEWuVHKfx7NjnzfECysVTjxZ-j6CphwEq_ZDiXfnQTrKYTdE1pKN-65oLHCiLO5wOb3tBFR_e-zGofSBV8oWoMMw%3D%3D" ref="nofollow noopener noreferrer">4</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fvertexaisearch.cloud.google.com%252Fgrounding-api-redirect%252FAUZIYQEcnUvxl3_eYgtZf94US3BKguEIFiTBg_PgJCrg3qWvzmM-VIfClzWJqPrs0bO58DfV_D_Dq1F5zcCXhFrDhy2CvpybTdoVsYVvzizU3NXQ29QCpIbyZGry2nmzWzMcPxsBTTf5sY8%253D" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQEcnUvxl3_eYgtZf94US3BKguEIFiTBg_PgJCrg3qWvzmM-VIfClzWJqPrs0bO58DfV_D_Dq1F5zcCXhFrDhy2CvpybTdoVsYVvzizU3NXQ29QCpIbyZGry2nmzWzMcPxsBTTf5sY8%3D" ref="nofollow noopener noreferrer">6</a>]</li>
<li>如果报错，它会读取错误信息。</li>
<li><strong>自动再次尝试修复</strong>，直到测试通过（Exit code 0）。</li>
</ol>
</li>
<li>
<p><strong>"Shipping Code" (交付代码)：</strong>  标题中的 "get Ralph working and shipping code" 指的是配置好这个自动化循环，让 AI 能够在你睡觉或做其他事时，不知疲倦地通过成百上千次试错，最终交付可运行的代码。</p>
</li>
</ul>
<p>它由Geoffrey Huntley创建，并在<a href="https://link.juejin.cn?target=https%3A%2F%2Fghuntley.com%2Fralph" target="_blank" title="https://ghuntley.com/ralph" ref="nofollow noopener noreferrer">他的原始帖子</a>中宣布。Ralph反复运行AmpCode（或你选择的其他AI代理），直到所有任务完成。</p>
<p>每次迭代都使用全新的上下文窗口（保持对话线程小而高效）。记忆通过git历史和文本文件持久化。</p>
<h2 data-id="heading-3">工作原理</h2>
<p>Ralph是一个bash循环，执行以下步骤：</p>
<ol>
<li>将提示传递给AI代理</li>
<li>代理从prd.json中选择下一个任务</li>
<li>代理实现该任务</li>
<li>代理运行类型检查和测试</li>
<li>如果通过，代理提交代码</li>
<li>代理标记任务完成</li>
<li>代理记录学习成果</li>
<li>循环重复直到所有任务完成</li>
</ol>
<p>记忆仅通过以下方式持久化：</p>
<ul>
<li>Git提交</li>
<li>progress.txt（学习成果）</li>
<li>prd.json（任务状态）</li>
</ul>
<h2 data-id="heading-4">文件结构</h2>
<pre><code class="hljs language-bash" lang="bash">scripts/ralph/
├── ralph.sh      <span class="hljs-comment"># 主脚本</span>
├── prompt.md     <span class="hljs-comment"># 每次迭代的指令</span>
├── prd.json      <span class="hljs-comment"># 任务列表</span>
└── progress.txt  <span class="hljs-comment"># 进度日志</span>
</code></pre>
<h2 data-id="heading-5">详细文件说明</h2>
<h3 data-id="heading-6">ralph.sh</h3>
<p>主循环脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-built_in">set</span> -e

MAX_ITERATIONS=<span class="hljs-variable">${1:-10}</span>
SCRIPT_DIR=<span class="hljs-string">"<span class="hljs-subst">$(cd <span class="hljs-string">"<span class="hljs-subst">$(dirname 
  <span class="hljs-string">"<span class="hljs-variable">${BASH_SOURCE[0]}</span>"</span>)</span>"</span> &amp;&amp; pwd)</span>"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"🚀 Starting Ralph"</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 1 <span class="hljs-variable">$MAX_ITERATIONS</span>); <span class="hljs-keyword">do</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"═══ Iteration <span class="hljs-variable">$i</span> ═══"</span>
  
  OUTPUT=$(<span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">$SCRIPT_DIR</span>/prompt.md"</span> \
    | amp --dangerously-allow-all 2&gt;&amp;1 \
    | <span class="hljs-built_in">tee</span> /dev/stderr) || <span class="hljs-literal">true</span>
  
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$OUTPUT</span>"</span> | \
    grep -q <span class="hljs-string">"&lt;promise&gt;COMPLETE&lt;/promise&gt;"</span>
  <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ Done!"</span>
    <span class="hljs-built_in">exit</span> 0
  <span class="hljs-keyword">fi</span>
  
  <span class="hljs-built_in">sleep</span> 2
<span class="hljs-keyword">done</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️ Max iterations reached"</span>
<span class="hljs-built_in">exit</span> 1
</code></pre>
<p>使其可执行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x scripts/ralph/ralph.sh
</code></pre>
<p>支持的其他代理：</p>
<ul>
<li>Claude Code: <code>claude --dangerously-skip-permissions</code></li>
</ul>
<h3 data-id="heading-7">prompt.md</h3>
<p>每次迭代的指令：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Ralph Agent Instructions</span>

<span class="hljs-section">## 你的任务</span>

<span class="hljs-bullet">1.</span> 读取 <span class="hljs-code">`scripts/ralph/prd.json`</span>
<span class="hljs-bullet">2.</span> 读取 <span class="hljs-code">`scripts/ralph/progress.txt`</span>（先查看代码库模式）
<span class="hljs-bullet">3.</span> 检查你是否在正确的分支上
<span class="hljs-bullet">4.</span> 选择优先级最高且 <span class="hljs-code">`passes: false`</span> 的任务
<span class="hljs-bullet">5.</span> 实现那一个任务
<span class="hljs-bullet">6.</span> 运行类型检查和测试
<span class="hljs-bullet">7.</span> 使用学习成果更新AGENTS.md文件
<span class="hljs-bullet">8.</span> 提交：<span class="hljs-code">`feat: [ID] - [Title]`</span>
<span class="hljs-bullet">9.</span> 更新prd.json：<span class="hljs-code">`passes: true`</span>
<span class="hljs-bullet">10.</span> 将学习成果追加到progress.txt

<span class="hljs-section">## 进度格式</span>

追加到progress.txt：


<span class="hljs-section">## [日期] - [任务ID]</span>
<span class="hljs-bullet">-</span> 实现了什么
<span class="hljs-bullet">-</span> 更改了哪些文件
<span class="hljs-bullet">-</span> <span class="hljs-strong">**学习成果：**</span>
<span class="hljs-bullet">  -</span> 发现的模式
<span class="hljs-section">  - 遇到的问题
---</span>


<span class="hljs-section">## 代码库模式</span>

将可重用模式添加到progress.txt的顶部：


<span class="hljs-section">## Codebase Patterns</span>
<span class="hljs-bullet">-</span> 迁移：使用IF NOT EXISTS
<span class="hljs-bullet">-</span> React：useRef<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Timeout</span> | <span class="hljs-attr">null</span>&gt;</span></span>(null)


<span class="hljs-section">## 停止条件</span>

如果所有任务都通过，回复：

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">promise</span>&gt;</span></span>COMPLETE<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">promise</span>&gt;</span></span>


否则正常结束。
</code></pre>
<h3 data-id="heading-8">prd.json</h3>
<p>任务列表：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"branchName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ralph/feature"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"userStories"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"US-001"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"添加登录表单"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"acceptanceCriteria"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"邮箱/密码字段"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"验证邮箱格式"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"类型检查通过"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"priority"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"passes"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"notes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>关键字段：</p>
<ul>
<li><code>branchName</code> — 使用的分支</li>
<li><code>priority</code> — 数值越小优先级越高</li>
<li><code>passes</code> — 完成时设置为true</li>
</ul>
<h3 data-id="heading-9">progress.txt</h3>
<p>开始时包含上下文：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Ralph Progress Log</span>
Started: 2024-01-15

<span class="hljs-section">## Codebase Patterns</span>
<span class="hljs-bullet">-</span> 迁移：IF NOT EXISTS
<span class="hljs-bullet">-</span> 类型：从actions.ts导出

<span class="hljs-section">## Key Files</span>
<span class="hljs-bullet">-</span> db/schema.ts
<span class="hljs-section">- app/auth/actions.ts
---</span>
</code></pre>
<p>Ralph在每个任务后追加内容，模式在迭代中累积。</p>
<h2 data-id="heading-10">运行Ralph</h2>
<pre><code class="hljs language-bash" lang="bash">./scripts/ralph/ralph.sh 25
</code></pre>
<p>运行最多25次迭代。Ralph将：</p>
<ul>
<li>创建功能分支</li>
<li>逐个完成任务</li>
<li>每个任务完成后提交</li>
<li>当所有任务通过时停止</li>
</ul>
<h2 data-id="heading-11">成功的关键因素</h2>
<h3 data-id="heading-12">1. 小任务</h3>
<p>必须适合一个上下文窗口：</p>
<pre><code class="hljs language-shell" lang="shell">❌ 太大：
<span class="hljs-meta prompt_">&gt; </span><span class="bash"><span class="hljs-string">"构建整个认证系统"</span></span>
✅ 合适大小：
<span class="hljs-meta prompt_">&gt; </span><span class="bash"><span class="hljs-string">"添加登录表单"</span></span>
<span class="hljs-meta prompt_">&gt; </span><span class="bash"><span class="hljs-string">"添加邮箱验证"</span></span>
<span class="hljs-meta prompt_">&gt; </span><span class="bash"><span class="hljs-string">"添加认证服务器操作"</span></span>
</code></pre>
<h3 data-id="heading-13">2. 反馈循环</h3>
<p>Ralph需要快速反馈：</p>
<ul>
<li><code>npm run typecheck</code></li>
<li><code>npm test</code></li>
</ul>
<p>没有这些，错误的代码会不断累积。</p>
<h3 data-id="heading-14">3. 明确的标准</h3>
<pre><code class="hljs language-shell" lang="shell">❌ 模糊：
<span class="hljs-meta prompt_">&gt; </span><span class="bash"><span class="hljs-string">"用户可以登录"</span></span>
✅ 明确：
<span class="hljs-meta prompt_">&gt; </span><span class="bash">- 邮箱/密码字段</span>
<span class="hljs-meta prompt_">&gt; </span><span class="bash">- 验证邮箱格式</span>
<span class="hljs-meta prompt_">&gt; </span><span class="bash">- 失败时显示错误</span>
<span class="hljs-meta prompt_">&gt; </span><span class="bash">- 类型检查通过</span>
<span class="hljs-meta prompt_">&gt; </span><span class="bash">- 在localhost:<span class="hljs-variable">$PORT</span>/login验证（PORT默认为3000）</span>
</code></pre>
<h3 data-id="heading-15">4. 学习成果累积</h3>
<p>到第10个任务时，Ralph已经知道了任务1-9的模式。</p>
<p>学习成果的两个位置：</p>
<ol>
<li>progress.txt — Ralph迭代的会话记忆</li>
<li>AGENTS.md — 人类和未来代理的永久文档</li>
</ol>
<p>在提交之前，Ralph会更新已编辑文件所在目录的AGENTS.md文件（如果发现可重用模式、问题或约定）。</p>
<h3 data-id="heading-16">5. AGENTS.md更新</h3>
<p>当Ralph学到值得保留的东西时，会更新AGENTS.md：</p>
<pre><code class="hljs language-diff" lang="diff">✅ 好的添加：
<span class="hljs-deletion">- "修改X时，也要更新Y"</span>
<span class="hljs-deletion">- "这个模块使用模式Z"</span>
<span class="hljs-deletion">- "测试需要开发服务器运行"</span>
❌ 不要添加：
<span class="hljs-deletion">- 特定任务的细节</span>
<span class="hljs-deletion">- 临时笔记</span>
<span class="hljs-deletion">- 已在progress.txt中的信息</span>
</code></pre>
<h3 data-id="heading-17">6. 浏览器测试</h3>
<p>对于UI更改，使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2F%40sawyerhood" target="_blank" title="https://x.com/@sawyerhood" ref="nofollow noopener noreferrer">@sawyerhood</a>的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSawyerHood%2Fdev-browser" target="_blank" title="https://github.com/SawyerHood/dev-browser" ref="nofollow noopener noreferrer">dev-browser技能</a>。使用<code>Load the dev-browser skill</code>加载它，然后：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动浏览器服务器</span>
~/.config/amp/skills/dev-browser/server.sh &amp;
<span class="hljs-comment"># 等待"Ready"消息</span>

<span class="hljs-comment"># 使用 heredocs 编写脚本</span>
<span class="hljs-built_in">cd</span> ~/.config/amp/skills/dev-browser &amp;&amp; npx tsx &lt;&lt;<span class="hljs-string">'EOF'</span>
import { connect, waitForPageLoad } from <span class="hljs-string">"@/client.js"</span>;

const client = await connect();
const page = await client.page(<span class="hljs-string">"test"</span>);
await page.setViewportSize({ width: 1280, height: 900 });
const port = process.env.PORT || <span class="hljs-string">"3000"</span>;
await page.goto(`http://localhost:<span class="hljs-variable">${port}</span>/your-page`);
await waitForPageLoad(page);
await page.screenshot({ path: <span class="hljs-string">"tmp/screenshot.png"</span> });
await client.disconnect();
EOF
</code></pre>
<p>只有通过截图验证才算完成。</p>
<h2 data-id="heading-18">常见问题</h2>
<ul>
<li>
<p><strong>幂等迁移：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> email TEXT;
</code></pre>
</li>
<li>
<p><strong>交互式提示：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n\n\n"</span> | npm run db:generate
</code></pre>
</li>
<li>
<p><strong>模式更改：</strong>
编辑模式后，检查：</p>
<ul>
<li>服务器操作</li>
<li>UI组件</li>
<li>API路由</li>
</ul>
</li>
<li>
<p><strong>修复相关文件是可以的：</strong>
如果类型检查需要其他更改，可以进行这些更改，这不算是范围蔓延。</p>
</li>
</ul>
<h2 data-id="heading-19">监控</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 任务状态</span>
<span class="hljs-built_in">cat</span> scripts/ralph/prd.json | \
jq <span class="hljs-string">'.userStories[] | {id, passes}'</span>
<span class="hljs-comment"># 学习成果</span>
<span class="hljs-built_in">cat</span> scripts/ralph/progress.txt
<span class="hljs-comment"># 提交记录</span>
git <span class="hljs-built_in">log</span> --oneline -10
</code></pre>
<h2 data-id="heading-20">实际结果</h2>
<p>我们构建了一个评估系统：</p>
<ul>
<li>13个用户故事</li>
<li>约15次迭代</li>
<li>每次2-5分钟</li>
<li>总共约1小时</li>
</ul>
<p>学习成果会累积。到第10个任务时，Ralph已经了解了我们的模式。</p>
<h2 data-id="heading-21">不适合使用的场景</h2>
<ul>
<li>探索性工作</li>
<li>没有明确标准的重大重构</li>
<li>安全关键代码</li>
<li>需要人工审查的任何内容</li>
</ul>
<h2 data-id="heading-22">视频教程</h2>
<p>有关如何使用Ralph的精彩视频演练，请查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2F%40mattpocockuk" target="_blank" title="https://x.com/@mattpocockuk" ref="nofollow noopener noreferrer">@mattpocockuk</a>的视频...</p>
<blockquote>
<p>My Ralph Wiggum breakdown went viral. It's a keep-it-simple-stupid approach to AI coding that lets you ship while you sleep. So here's a full explanation, example code, and demo.</p>
</blockquote>
<p><em>15:51 视频时长</em></p>
<h2 data-id="heading-23">关于作者</h2>
<p>Ryan Carson - 父亲、CEO、创始人、开发者</p>
<p>关注他：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fryancarson" target="_blank" title="https://x.com/ryancarson" ref="nofollow noopener noreferrer">@ryancarson</a></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS应用（App）生命周期、视图控制器（UIViewController）生命周期和视图（UIView）生命周期]]></title>    <link>https://juejin.cn/post/7592127014188351488</link>    <guid>https://juejin.cn/post/7592127014188351488</guid>    <pubDate>2026-01-07T02:32:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592127014188351488" data-draft-id="7592176349712957478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS应用（App）生命周期、视图控制器（UIViewController）生命周期和视图（UIView）生命周期"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2026-01-07T02:32:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="茅根竹蔗水__"/> <meta itemprop="url" content="https://juejin.cn/user/1073569923886071"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS应用（App）生命周期、视图控制器（UIViewController）生命周期和视图（UIView）生命周期
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1073569923886071/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    茅根竹蔗水__
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T02:32:03.000Z" title="Wed Jan 07 2026 02:32:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>清晰的理解它们能帮你更好地管理应用状态和资源。</strong></p>
</blockquote>
<h3 data-id="heading-0">一、iOS 应用（App）生命周期</h3>
<p>应用生命周期描述了 App 从启动到终止的整个过程，由<code>UIApplicationDelegate</code>（应用代理）来管理。</p>
<h4 data-id="heading-1">核心阶段与代理方法（按执行顺序）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit

<span class="hljs-keyword">@UIApplicationMain</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIApplicationDelegate</span> {

    <span class="hljs-keyword">var</span> window: <span class="hljs-type">UIWindow</span>?

    <span class="hljs-comment">// 1. App启动完成（最核心的入口）</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>, <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span>) -&gt; <span class="hljs-type">Bool</span> {

        <span class="hljs-built_in">print</span>(<span class="hljs-string">"应用启动完成 - didFinishLaunchingWithOptions"</span>)

        <span class="hljs-comment">// 通常在这里初始化根视图控制器、配置全局设置等</span>

        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

    }


    <span class="hljs-comment">// 2. App即将进入前台（还未激活，可做界面刷新）</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">applicationWillEnterForeground</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>) {
    
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"即将进入前台 - applicationWillEnterForeground"</span>)

    }


    <span class="hljs-comment">// 3. App已进入前台并激活（用户可交互）</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">applicationDidBecomeActive</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>) {

        <span class="hljs-built_in">print</span>(<span class="hljs-string">"已激活 - applicationDidBecomeActive"</span>)

        <span class="hljs-comment">// 恢复定时器、重新开始播放音频、刷新数据等</span>

    }

    <span class="hljs-comment">// 4. App即将进入后台（用户按Home键/切换App）</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">applicationWillResignActive</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>) {

        <span class="hljs-built_in">print</span>(<span class="hljs-string">"即将失活 - applicationWillResignActive"</span>)

        <span class="hljs-comment">// 暂停定时器、保存临时数据、暂停音频播放等</span>

    }


    <span class="hljs-comment">// 5. App已进入后台</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">applicationDidEnterBackground</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>) {

        <span class="hljs-built_in">print</span>(<span class="hljs-string">"已进入后台 - applicationDidEnterBackground"</span>)

        <span class="hljs-comment">// 持久化数据、释放不必要的资源（有大约5秒时间，耗时操作需申请后台任务）</span>

    }

    <span class="hljs-comment">// 6. App即将终止（仅在后台时可能触发，如系统回收内存）</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">applicationWillTerminate</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>) {

        <span class="hljs-built_in">print</span>(<span class="hljs-string">"即将终止 - applicationWillTerminate"</span>)

        <span class="hljs-comment">// 最终的资源清理、数据保存</span>

    }

}
</code></pre>
<h4 data-id="heading-2">关键说明</h4>
<ul>
<li><strong>启动流程</strong>：用户点击 App 图标 → 系统加载可执行文件 → 调用<code>didFinishLaunchingWithOptions</code> → 显示界面 → 进入活跃状态。</li>
<li><strong>后台与前台切换</strong>：活跃 → 失活（<code>WillResignActive</code>）→ 后台（<code>DidEnterBackground</code>）→ 前台（<code>WillEnterForeground</code>）→ 活跃（<code>DidBecomeActive</code>）。</li>
<li><strong>终止</strong>：后台状态下系统回收内存，触发<code>applicationWillTerminate</code>（若 App 在前台，直接终止，不触发此方法）。</li>
</ul>
<h3 data-id="heading-3">二、UIViewController 生命周期</h3>
<p>视图控制器是管理 UIView 的核心，其生命周期围绕视图的创建、显示、隐藏、销毁展开，是 iOS 开发中最常接触的生命周期。</p>
<h4 data-id="heading-4">核心方法（按执行顺序）</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: <span class="hljs-title class_">UIViewController</span> {

    <span class="hljs-comment">// 1. 初始化（创建VC对象）</span>
    <span class="hljs-keyword">init?</span>(<span class="hljs-params">coder</span>: <span class="hljs-type">NSCoder</span>) {
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>(coder: coder)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 初始化 - init"</span>)
        <span class="hljs-comment">// 初始化非UI相关的属性</span>
    }

    <span class="hljs-comment">// 2. 加载视图（首次访问view属性时触发）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadView</span>() {
        <span class="hljs-keyword">super</span>.loadView()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 加载视图 - loadView"</span>)
        <span class="hljs-comment">// 手动创建view（若不重写，系统会加载storyboard/xib的view）</span>
        <span class="hljs-keyword">self</span>.view <span class="hljs-operator">=</span> <span class="hljs-type">UIView</span>(frame: <span class="hljs-type">UIScreen</span>.main.bounds)
        <span class="hljs-keyword">self</span>.view.backgroundColor <span class="hljs-operator">=</span> .white
    }

    <span class="hljs-comment">// 3. 视图加载完成（view已创建完成）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 视图加载完成 - viewDidLoad"</span>)
        <span class="hljs-comment">// 初始化UI控件、绑定数据、添加监听（只执行一次）</span>
    }

    <span class="hljs-comment">// 4. 视图即将布局子视图（view的bounds变化时触发，如旋转屏幕）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewWillLayoutSubviews</span>() {
        <span class="hljs-keyword">super</span>.viewWillLayoutSubviews()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"4. 视图即将布局子视图 - viewWillLayoutSubviews"</span>)
        <span class="hljs-comment">// 调整控件布局（执行多次）</span>
    }

    <span class="hljs-comment">// 5. 视图已布局子视图</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLayoutSubviews</span>() {
        <span class="hljs-keyword">super</span>.viewDidLayoutSubviews()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"5. 视图已布局子视图 - viewDidLayoutSubviews"</span>)
        <span class="hljs-comment">// 获取控件最终的frame（执行多次）</span>
    }

    <span class="hljs-comment">// 6. 视图即将显示在屏幕上（每次显示都触发，如push/pop后重新显示）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewWillAppear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-keyword">super</span>.viewWillAppear(animated)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"6. 视图即将显示 - viewWillAppear"</span>)
        <span class="hljs-comment">// 刷新数据、开始动画、注册通知等</span>
    }

    <span class="hljs-comment">// 7. 视图已显示在屏幕上</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidAppear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-keyword">super</span>.viewDidAppear(animated)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"7. 视图已显示 - viewDidAppear"</span>)
        <span class="hljs-comment">// 启动定时器、请求网络数据、播放视频等</span>
    }

    <span class="hljs-comment">// 8. 视图即将从屏幕上消失</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewWillDisappear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-keyword">super</span>.viewWillDisappear(animated)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"8. 视图即将消失 - viewWillDisappear"</span>)
        <span class="hljs-comment">// 暂停动画、移除通知、保存数据等</span>
    }

    <span class="hljs-comment">// 9. 视图已从屏幕上消失</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidDisappear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-keyword">super</span>.viewDidDisappear(animated)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"9. 视图已消失 - viewDidDisappear"</span>)
        <span class="hljs-comment">// 释放不必要的资源（如图片缓存）</span>
    }

    <span class="hljs-comment">// 10. 内存警告（系统内存不足时触发）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didReceiveMemoryWarning</span>() {
        <span class="hljs-keyword">super</span>.didReceiveMemoryWarning()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"10. 内存警告 - didReceiveMemoryWarning"</span>)
        <span class="hljs-comment">// 释放缓存、非必要的视图等</span>
    }

    <span class="hljs-comment">// 11. 视图控制器销毁（deinit）</span>
    <span class="hljs-keyword">deinit</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"11. 视图控制器销毁 - deinit"</span>)
        <span class="hljs-comment">// 最终的资源释放（如移除监听、取消网络请求）</span>
    }
}
</code></pre>
<h4 data-id="heading-5">关键说明</h4>
<ul>
<li><strong>核心流程</strong>：初始化 → 加载视图 → 视图加载完成 → 布局子视图 → 即将显示 → 已显示 → 即将消失 → 已消失 → 销毁。</li>
<li><strong>viewDidLoad</strong>：只执行一次，适合做一次性初始化；<strong>viewWillAppear/viewDidAppear</strong>：每次显示都执行，适合刷新动态数据。</li>
<li><strong>内存警告</strong>：<code>didReceiveMemoryWarning</code>中需主动释放非必要资源，避免 App 被系统杀死。</li>
<li><strong>deinit</strong>：只有当 VC 的引用计数为 0 时才会触发，需确保无循环引用（如闭包未捕获 self 为 weak/unowned）。</li>
</ul>
<h3 data-id="heading-6">三、UIView 生命周期</h3>
<p>UIView 的生命周期依附于视图控制器，核心是 “创建 - 布局 - 绘制 - 销毁”，重点关注布局和绘制相关方法。</p>
<h4 data-id="heading-7">核心阶段与方法</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomView</span>: <span class="hljs-title class_">UIView</span> {

    <span class="hljs-comment">// 1. 初始化（创建View）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>(<span class="hljs-params">frame</span>: <span class="hljs-type">CGRect</span>) {
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>(frame: frame)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. View初始化 - init(frame:)"</span>)
        <span class="hljs-comment">// 设置默认属性（如背景色、圆角）</span>
        <span class="hljs-keyword">self</span>.backgroundColor <span class="hljs-operator">=</span> .lightGray
    }

    <span class="hljs-keyword">required</span> <span class="hljs-keyword">init?</span>(<span class="hljs-params">coder</span>: <span class="hljs-type">NSCoder</span>) {
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>(coder: coder)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. View初始化 - init(coder:)"</span>)
    }

    <span class="hljs-comment">// 2. 准备布局（iOS 6+，替代autoresizingMask）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">prepareForLayout</span>() {
        <span class="hljs-keyword">super</span>.prepareForLayout()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 准备布局 - prepareForLayout"</span>)
        <span class="hljs-comment">// 布局前的准备工作（如设置约束优先级）</span>
    }

    <span class="hljs-comment">// 3. 布局子视图（bounds变化时触发，如frame、center修改）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">layoutSubviews</span>() {
        <span class="hljs-keyword">super</span>.layoutSubviews()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 布局子视图 - layoutSubviews"</span>)
        <span class="hljs-comment">// 手动调整子视图frame（若不用AutoLayout）</span>
        <span class="hljs-keyword">for</span> subview <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.subviews {
            subview.center <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.center
        }
    }

    <span class="hljs-comment">// 4. 绘制内容（首次显示/setNeedsDisplay()触发）</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">draw</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">rect</span>: <span class="hljs-type">CGRect</span>) {
        <span class="hljs-keyword">super</span>.draw(rect)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"4. 绘制内容 - draw(_:)"</span>)
        <span class="hljs-comment">// 手动绘制图形（如绘制线条、文字）</span>
        <span class="hljs-keyword">let</span> context <span class="hljs-operator">=</span> <span class="hljs-type">UIGraphicsGetCurrentContext</span>()
        context<span class="hljs-operator">?</span>.setStrokeColor(<span class="hljs-type">UIColor</span>.red.cgColor)
        context<span class="hljs-operator">?</span>.stroke(<span class="hljs-type">CGRect</span>(x: <span class="hljs-number">10</span>, y: <span class="hljs-number">10</span>, width: <span class="hljs-number">100</span>, height: <span class="hljs-number">100</span>))
    }

    <span class="hljs-comment">// 5. 即将添加到父视图</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">willMove</span>(<span class="hljs-params">toSuperview</span> <span class="hljs-params">newSuperview</span>: <span class="hljs-type">UIView</span>?) {
        <span class="hljs-keyword">super</span>.willMove(toSuperview: newSuperview)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"5. 即将添加到父视图 - willMove(toSuperview:)"</span>)
        <span class="hljs-comment">// 父视图变化前的处理</span>
    }

    <span class="hljs-comment">// 6. 已添加到父视图</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didMoveToSuperview</span>() {
        <span class="hljs-keyword">super</span>.didMoveToSuperview()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"6. 已添加到父视图 - didMoveToSuperview"</span>)
        <span class="hljs-comment">// 父视图变化后的处理（如根据父视图调整自身大小）</span>
    }

    <span class="hljs-comment">// 7. 即将添加到窗口</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">willMove</span>(<span class="hljs-params">toWindow</span> <span class="hljs-params">newWindow</span>: <span class="hljs-type">UIWindow</span>?) {
        <span class="hljs-keyword">super</span>.willMove(toWindow: newWindow)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"7. 即将添加到窗口 - willMove(toWindow:)"</span>)
    }

    <span class="hljs-comment">// 8. 已添加到窗口</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">didMoveToWindow</span>() {
        <span class="hljs-keyword">super</span>.didMoveToWindow()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"8. 已添加到窗口 - didMoveToWindow"</span>)
        <span class="hljs-comment">// 只有添加到window后，View才会真正显示在屏幕上</span>
    }

    <span class="hljs-comment">// 9. 销毁（deinit）</span>
    <span class="hljs-keyword">deinit</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"9. View销毁 - deinit"</span>)
        <span class="hljs-comment">// 释放View相关资源（如移除子视图、取消动画）</span>
    }
}

</code></pre>
<h4 data-id="heading-8">关键说明</h4>
<ul>
<li><strong>layoutSubviews</strong>：最常用的方法，每次 View 的尺寸变化都会触发，适合手动调整子视图布局（若使用 AutoLayout，系统会自动处理，无需重写）。</li>
<li><strong>draw(_:)</strong> ：仅在需要手动绘制内容时重写，避免在其中做耗时操作（会影响渲染性能）；调用<code>setNeedsDisplay()</code>可触发重新绘制。</li>
<li><strong>Window 关联</strong>：View 只有添加到<code>UIWindow</code>（应用的主窗口）后，才会被渲染并显示在屏幕上；<code>didMoveToWindow</code>是 View 真正 “可见” 的标志。</li>
<li><strong>销毁</strong>：当 View 从父视图移除且无强引用时，<code>deinit</code>触发，需确保子视图也被正确释放。</li>
</ul>
<h3 data-id="heading-9">总结</h3>
<ol>
<li><strong>应用生命周期</strong>：全局层面，管理 App 从启动到终止的状态，核心是<code>UIApplicationDelegate</code>的代理方法，关注前台 / 后台切换和资源保存。</li>
<li><strong>视图控制器生命周期</strong>：页面层面，核心是<code>viewDidLoad</code>（一次性初始化）、<code>viewWillAppear</code>（每次显示刷新）、<code>deinit</code>（资源释放），是业务逻辑的主要载体。</li>
<li><strong>视图生命周期</strong>：控件层面，依附于 VC，核心是<code>layoutSubviews</code>（布局）和<code>draw(_:)</code>（绘制），关注控件尺寸调整和视觉渲染。</li>
</ol>
<p>三者的关联：App 启动后创建根 VC → VC 创建并加载 View → View 添加到 Window 显示 → App 进入前台活跃状态；App 进入后台时，VC 的 View 会被隐藏，资源可按需释放。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面向Java程序员的思维链（CoT）提示词写法学习指南]]></title>    <link>https://juejin.cn/post/7592251792651534363</link>    <guid>https://juejin.cn/post/7592251792651534363</guid>    <pubDate>2026-01-07T03:07:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592251792651534363" data-draft-id="7592251792651468827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面向Java程序员的思维链（CoT）提示词写法学习指南"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-07T03:07:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="帅气的你"/> <meta itemprop="url" content="https://juejin.cn/user/1626932940649534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面向Java程序员的思维链（CoT）提示词写法学习指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1626932940649534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    帅气的你
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T03:07:45.000Z" title="Wed Jan 07 2026 03:07:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读40分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">面向Java程序员的思维链（CoT）提示词写法学习指南</h2>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#1-%E6%80%9D%E7%BB%B4%E9%93%BEcot%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E8%AE%B2%E8%A7%A3" title="#1-%E6%80%9D%E7%BB%B4%E9%93%BEcot%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E8%AE%B2%E8%A7%A3">思维链（CoT）提示词基础概念讲解</a></li>
<li><a href="#2-java%E5%BC%80%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8Bcot%E6%8F%90%E7%A4%BA%E8%AF%8D%E7%9A%84%E5%85%B3%E9%94%AE%E6%9E%84%E6%88%90%E8%A6%81%E7%B4%A0%E6%8B%86%E8%A7%A3" title="#2-java%E5%BC%80%E5%8F%91%E5%9C%BA%E6%99%AF%E4%B8%8Bcot%E6%8F%90%E7%A4%BA%E8%AF%8D%E7%9A%84%E5%85%B3%E9%94%AE%E6%9E%84%E6%88%90%E8%A6%81%E7%B4%A0%E6%8B%86%E8%A7%A3">Java开发场景下CoT提示词的关键构成要素拆解</a></li>
<li><a href="#3-%E5%A4%8D%E6%9D%82java%E6%8A%80%E6%9C%AF%E9%9C%80%E6%B1%82%E6%8B%86%E8%A7%A3%E4%B8%BAai%E5%8F%AF%E7%90%86%E8%A7%A3%E6%AD%A5%E9%AA%A4%E7%9A%84%E5%AE%9E%E6%93%8D%E6%A1%88%E4%BE%8B" title="#3-%E5%A4%8D%E6%9D%82java%E6%8A%80%E6%9C%AF%E9%9C%80%E6%B1%82%E6%8B%86%E8%A7%A3%E4%B8%BAai%E5%8F%AF%E7%90%86%E8%A7%A3%E6%AD%A5%E9%AA%A4%E7%9A%84%E5%AE%9E%E6%93%8D%E6%A1%88%E4%BE%8B">复杂Java技术需求拆解为AI可理解步骤的实操案例</a></li>
<li><a href="#4-java%E5%BC%80%E5%8F%91%E4%BA%BA%E5%91%98%E4%BD%BF%E7%94%A8cot%E6%8F%90%E7%A4%BA%E8%AF%8D%E7%9A%84%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97%E4%B8%8E%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7" title="#4-java%E5%BC%80%E5%8F%91%E4%BA%BA%E5%91%98%E4%BD%BF%E7%94%A8cot%E6%8F%90%E7%A4%BA%E8%AF%8D%E7%9A%84%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97%E4%B8%8E%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7">Java开发人员使用CoT提示词的避坑指南与优化技巧</a></li>
<li><a href="#5-%E5%AE%9E%E6%88%98%E7%BB%83%E4%B9%A0%E4%BB%BB%E5%8A%A1%E8%AE%BE%E8%AE%A1" title="#5-%E5%AE%9E%E6%88%98%E7%BB%83%E4%B9%A0%E4%BB%BB%E5%8A%A1%E8%AE%BE%E8%AE%A1">实战练习任务设计</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">1. 思维链（CoT）提示词基础概念讲解</h3>
<h4 data-id="heading-3">1.1 CoT提示词的核心定义</h4>
<p><strong>思维链（Chain of Thought，CoT）提示词</strong>是一种引导AI进行逐步推理的提示词编写方法。其核心思想是将复杂问题拆解为一系列逻辑连贯的中间步骤，让AI按照人类思考问题的方式，逐步推导出最终答案。</p>
<p>对于Java开发人员而言，CoT提示词的本质可以类比为<strong>代码逻辑流程</strong>：</p>
<ul>
<li><strong>传统提示词</strong>：类似于直接调用一个黑盒方法，只关注输入输出，不关心内部实现</li>
<li><strong>CoT提示词</strong>：类似于编写一个包含多个步骤的方法，每一步都有明确的逻辑和中间结果，最终组合成完整的解决方案</li>
</ul>
<p><strong>类比示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 传统提示词（黑盒调用）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> processComplexBusiness(data); <span class="hljs-comment">// AI直接给出结果，过程不透明</span>

<span class="hljs-comment">// CoT提示词（步骤化推理）</span>
<span class="hljs-comment">// 步骤1：数据校验</span>
<span class="hljs-keyword">if</span> (!validateInput(data)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationException</span>(<span class="hljs-string">"输入数据不合法"</span>);
}
<span class="hljs-comment">// 步骤2：业务逻辑处理</span>
<span class="hljs-type">BusinessResult</span> <span class="hljs-variable">businessResult</span> <span class="hljs-operator">=</span> executeBusinessLogic(data);
<span class="hljs-comment">// 步骤3：结果封装</span>
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> formatResult(businessResult);
</code></pre>
<h4 data-id="heading-4">1.2 CoT提示词在Java开发场景中的价值</h4>
<h5 data-id="heading-5">1.2.1 辅助解决复杂Java问题</h5>
<p><strong>场景1：多线程并发调试</strong></p>
<ul>
<li><strong>无CoT提示词</strong>：直接询问"如何解决Java多线程死锁问题？"</li>
<li><strong>有CoT提示词</strong>：
<ol>
<li>先分析死锁产生的条件（互斥资源、持有并等待、不可抢占、循环等待）</li>
<li>使用jstack或jvisualvm定位死锁线程</li>
<li>分析线程调用栈，找出资源竞争点</li>
<li>提供解决方案（避免嵌套锁、使用超时锁、调整锁顺序）</li>
</ol>
</li>
</ul>
<p><strong>场景2：框架源码分析</strong></p>
<ul>
<li><strong>无CoT提示词</strong>：询问"Spring Boot自动配置原理是什么？"</li>
<li><strong>有CoT提示词</strong>：
<ol>
<li>从@SpringBootApplication注解入手</li>
<li>分析@EnableAutoConfiguration的导入机制</li>
<li>追踪spring.factories文件的加载流程</li>
<li>理解条件注解（@ConditionalOnClass等）的匹配逻辑</li>
<li>总结自动配置的完整链路</li>
</ol>
</li>
</ul>
<h5 data-id="heading-6">1.2.2 生成结构化技术方案</h5>
<p><strong>场景：Spring Boot项目架构设计</strong></p>
<p><strong>CoT提示词示例</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">请帮我设计一个Spring Boot微服务项目的架构方案，请按以下步骤思考：

步骤1：明确业务边界
<span class="hljs-deletion">- 识别核心业务模块（用户服务、订单服务、支付服务）</span>
<span class="hljs-deletion">- 确定服务间的依赖关系</span>

步骤2：技术选型
<span class="hljs-deletion">- Web框架：Spring Boot 3.x</span>
<span class="hljs-deletion">- 服务注册与发现：Nacos</span>
<span class="hljs-deletion">- 配置中心：Nacos Config</span>
<span class="hljs-deletion">- 网关：Spring Cloud Gateway</span>
<span class="hljs-deletion">- 数据库：MySQL 8.0 + Redis 7.0</span>
<span class="hljs-deletion">- 消息队列：RocketMQ</span>

步骤3：分层架构设计
<span class="hljs-deletion">- Controller层：RESTful API设计</span>
<span class="hljs-deletion">- Service层：业务逻辑封装</span>
<span class="hljs-deletion">- Repository层：数据访问抽象</span>
<span class="hljs-deletion">- 公共模块：统一响应格式、异常处理、工具类</span>

步骤4：非功能性需求
<span class="hljs-deletion">- 接口限流：使用Sentinel</span>
<span class="hljs-deletion">- 分布式事务：Seata</span>
<span class="hljs-deletion">- 日志追踪：SkyWalking</span>
<span class="hljs-deletion">- 监控告警：Prometheus + Grafana</span>

请按照以上步骤，输出完整的架构设计方案。
</code></pre>
<h5 data-id="heading-7">1.2.3 优化AI生成代码的准确性</h5>
<p><strong>场景：避免语法错误和设计模式问题</strong></p>
<p><strong>无CoT提示词</strong>：直接要求"写一个单例模式"</p>
<p><strong>有CoT提示词</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">请实现一个线程安全的单例模式，请按以下步骤思考：

步骤1：选择实现方式
<span class="hljs-deletion">- 考虑场景：是否需要延迟加载？是否需要序列化支持？</span>
<span class="hljs-deletion">- 推荐：双重检查锁定（DCL）或枚举单例</span>

步骤2：实现核心逻辑
<span class="hljs-deletion">- 私有化构造函数</span>
<span class="hljs-deletion">- 提供静态获取实例方法</span>
<span class="hljs-deletion">- 添加volatile关键字保证可见性（如使用DCL）</span>

步骤3：考虑边界情况
<span class="hljs-deletion">- 反射攻击防护</span>
<span class="hljs-deletion">- 序列化/反序列化防护</span>
<span class="hljs-deletion">- 多线程环境下的安全性验证</span>

步骤4：编写单元测试
<span class="hljs-deletion">- 验证单例性</span>
<span class="hljs-deletion">- 验证线程安全性</span>

请按照以上步骤，输出完整的代码实现和测试用例。
</code></pre>
<hr/>
<h3 data-id="heading-8">2. Java开发场景下CoT提示词的关键构成要素拆解</h3>
<p>一个高质量的Java开发CoT提示词应包含以下四个核心模块：</p>
<h4 data-id="heading-9">2.1 模块1：需求边界定义</h4>
<p><strong>作用</strong>：明确问题的范围、约束条件和预期目标，避免AI生成范围偏差或不符合实际需求的代码。</p>
<p><strong>Java场景示例</strong>：实现基于Redis的Java缓存工具类</p>
<p><strong>无边界定义</strong>：</p>
<pre><code class="hljs">写一个Redis缓存工具类
</code></pre>
<p><strong>有边界定义的CoT提示词</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">请实现一个基于Redis的Java缓存工具类，请先明确以下边界条件：

边界1：功能范围
<span class="hljs-deletion">- 支持String、Object类型的缓存读写</span>
<span class="hljs-deletion">- 支持设置过期时间（支持固定时间和相对时间）</span>
<span class="hljs-deletion">- 支持批量操作（批量读取、批量删除）</span>
<span class="hljs-deletion">- 不支持分布式锁功能（后续单独实现）</span>

边界2：异常处理要求
<span class="hljs-deletion">- Redis连接失败：抛出自定义CacheException，包含原始异常信息</span>
<span class="hljs-deletion">- 序列化失败：记录日志并返回null，不中断业务流程</span>
<span class="hljs-deletion">- 键值对不存在：返回null，不抛异常</span>

边界3：与Spring框架集成方式
<span class="hljs-deletion">- 使用Spring Data Redis作为底层客户端</span>
<span class="hljs-deletion">- 支持通过@Autowired注入使用</span>
<span class="hljs-deletion">- 配置类使用@Configuration，支持条件装配（@ConditionalOnClass(RedisTemplate.class)）</span>

边界4：性能要求
<span class="hljs-deletion">- 批量操作使用Pipeline减少网络往返</span>
<span class="hljs-deletion">- 对象序列化使用Jackson（避免Java原生序列化的性能问题）</span>

请按照以上边界条件，设计并实现该缓存工具类。
</code></pre>
<h4 data-id="heading-10">2.2 模块2：技术栈限定</h4>
<p><strong>作用</strong>：指定具体的技术版本和依赖，确保AI生成的代码符合当前项目技术栈，减少适配成本。</p>
<p><strong>Java场景示例</strong>：微服务接口开发</p>
<p><strong>无技术栈限定</strong>：</p>
<pre><code class="hljs">开发一个用户查询接口
</code></pre>
<p><strong>有技术栈限定的CoT提示词</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">请开发一个用户查询接口，技术栈要求如下：

技术栈限定：
<span class="hljs-deletion">- Java版本：Java 17（使用record类型定义DTO）</span>
<span class="hljs-deletion">- Web框架：Spring Boot 3.2.0</span>
<span class="hljs-deletion">- 数据库：MySQL 8.0</span>
<span class="hljs-deletion">- ORM框架：MyBatis-Plus 3.5.3</span>
<span class="hljs-deletion">- 参数校验：Hibernate Validator 8.0.0</span>
<span class="hljs-deletion">- 响应格式：统一使用Result&lt;T&gt;封装（code、message、data字段）</span>
<span class="hljs-deletion">- 日志框架：SLF4J + Logback</span>

请按照以上技术栈，输出完整的接口代码（Controller、Service、Mapper、实体类）。
</code></pre>
<h4 data-id="heading-11">2.3 模块3：步骤化推理引导</h4>
<p><strong>作用</strong>：将复杂需求拆解为清晰的步骤序列，引导AI按照Java开发的标准流程输出代码。</p>
<p><strong>Java场景示例</strong>：开发Java接口并实现数据校验</p>
<p><strong>无步骤引导</strong>：</p>
<pre><code class="hljs">开发一个用户注册接口，需要数据校验
</code></pre>
<p><strong>有步骤引导的CoT提示词</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">请开发一个用户注册接口并实现数据校验，请按以下步骤实现：

步骤1：定义接口请求参数实体类
<span class="hljs-bullet">-</span> 创建UserRegisterRequest类
<span class="hljs-bullet">-</span> 使用Hibernate Validator注解标注校验规则：
<span class="hljs-bullet">  *</span> @NotNull + @Size：用户名（3-20字符）
<span class="hljs-bullet">  *</span> @NotNull + @Email：邮箱格式校验
<span class="hljs-bullet">  *</span> @NotNull + @Pattern：手机号格式校验（11位数字）
<span class="hljs-bullet">  *</span> @NotNull + @Size(min=8)：密码长度校验

步骤2：编写接口Controller层
<span class="hljs-bullet">-</span> 使用@RestController + @RequestMapping
<span class="hljs-bullet">-</span> 方法参数使用@Valid注解触发校验
<span class="hljs-bullet">-</span> 方法参数使用@RequestBody接收JSON请求

步骤3：编写接口Service层逻辑
<span class="hljs-bullet">-</span> 实现用户注册业务逻辑
<span class="hljs-bullet">-</span> 检查用户名、邮箱、手机号是否已存在
<span class="hljs-bullet">-</span> 密码使用BCrypt加密存储
<span class="hljs-bullet">-</span> 返回用户ID

步骤4：全局异常处理校验失败场景
<span class="hljs-bullet">-</span> 创建@ControllerAdvice全局异常处理器
<span class="hljs-bullet">-</span> 捕获MethodArgumentNotValidException
<span class="hljs-bullet">-</span> 提取校验失败的字段和错误信息
<span class="hljs-bullet">-</span> 返回统一的错误响应格式（code=400，message包含具体校验错误）

步骤5：编写单元测试
<span class="hljs-bullet">-</span> 测试正常注册场景
<span class="hljs-bullet">-</span> 测试各种校验失败场景（用户名过短、邮箱格式错误等）

请按照以上步骤，输出完整的代码实现。
</code></pre>
<h4 data-id="heading-12">2.4 模块4：输出格式要求</h4>
<p><strong>作用</strong>：明确AI输出的格式和规范，确保生成的代码可直接复用，符合团队编码规范。</p>
<p><strong>Java场景示例</strong>：缓存工具类实现</p>
<p><strong>无输出格式要求</strong>：</p>
<pre><code class="hljs">实现一个缓存工具类
</code></pre>
<p><strong>有输出格式要求的CoT提示词</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">请实现一个Redis缓存工具类，输出格式要求如下：

输出格式要求：
<span class="hljs-bullet">1.</span> 代码结构
<span class="hljs-bullet">   -</span> 完整的类代码（包含package、import、类注释）
<span class="hljs-bullet">   -</span> 关键方法需包含JavaDoc注释（@param、@return、@throws）
<span class="hljs-bullet">   -</span> 代码需符合阿里巴巴Java开发手册规范：
<span class="hljs-bullet">     *</span> 类名使用UpperCamelCase
<span class="hljs-bullet">     *</span> 方法名使用lowerCamelCase
<span class="hljs-bullet">     *</span> 常量使用UPPER<span class="hljs-emphasis">_SNAKE_</span>CASE
<span class="hljs-bullet">     *</span> 每行代码不超过120字符

<span class="hljs-bullet">2.</span> 关键步骤注释
<span class="hljs-bullet">   -</span> 每个核心方法内部需添加步骤注释，说明逻辑流程
<span class="hljs-bullet">   -</span> 复杂逻辑需解释设计思路（如为什么使用Pipeline）

<span class="hljs-bullet">3.</span> 测试用例
<span class="hljs-bullet">   -</span> 提供JUnit 5测试类
<span class="hljs-bullet">   -</span> 包含正常场景和异常场景的测试用例
<span class="hljs-bullet">   -</span> 测试类命名：CacheUtilTest

<span class="hljs-bullet">4.</span> 使用示例
<span class="hljs-bullet">   -</span> 提供Spring Boot配置类示例
<span class="hljs-bullet">   -</span> 提供Controller中使用缓存工具类的示例代码

请按照以上格式要求，输出完整的实现代码。
</code></pre>
<hr/>
<h3 data-id="heading-13">3. 复杂Java技术需求拆解为AI可理解步骤的实操案例</h3>
<h4 data-id="heading-14">案例1：实现分布式事务（Seata）在微服务中的集成</h4>
<h5 data-id="heading-15">第一步：明确需求核心痛点</h5>
<p><strong>核心痛点</strong>：</p>
<ul>
<li>微服务架构下，跨服务的数据一致性难以保证</li>
<li>部分服务执行成功、部分服务执行失败时，已成功的数据无法回滚</li>
<li>需要实现分布式事务的ACID特性（特别是原子性和一致性）</li>
</ul>
<p><strong>业务场景示例</strong>：</p>
<ul>
<li>订单服务创建订单</li>
<li>库存服务扣减库存</li>
<li>支付服务处理支付</li>
<li>任何一个服务失败，都需要回滚所有已执行的操作</li>
</ul>
<h5 data-id="heading-16">第二步：拆解技术实现子步骤</h5>
<p><strong>步骤拆解</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">步骤1：引入Seata依赖（指定版本）
<span class="hljs-bullet">-</span> 在订单服务、库存服务、支付服务的pom.xml中添加Seata依赖
<span class="hljs-bullet">-</span> 使用Seata 1.7.1版本（与Spring Boot 3.x兼容）
<span class="hljs-bullet">-</span> 依赖包括：seata-spring-boot-starter、seata-all

步骤2：配置Seata事务组、注册中心地址
<span class="hljs-bullet">-</span> 在application.yml中配置：
<span class="hljs-bullet">  *</span> seata.application-id：应用ID
<span class="hljs-bullet">  *</span> seata.tx-service-group：事务组名称（需与Seata Server配置一致）
<span class="hljs-bullet">  *</span> seata.config.type：配置中心类型（nacos/file）
<span class="hljs-bullet">  *</span> seata.registry.type：注册中心类型（nacos/eureka）
<span class="hljs-bullet">  *</span> seata.registry.nacos.server-addr：Nacos地址

步骤3：编写业务服务（含@GlobalTransactional注解使用）
<span class="hljs-bullet">-</span> 在订单服务中创建订单方法上添加@GlobalTransactional注解
<span class="hljs-bullet">-</span> 调用库存服务和支付服务时，确保使用Feign或RestTemplate进行HTTP调用
<span class="hljs-bullet">-</span> 注意：@GlobalTransactional只能标注在发起事务的服务方法上

步骤4：配置数据源代理
<span class="hljs-bullet">-</span> 配置Seata的数据源代理，替换原有的DataSource
<span class="hljs-bullet">-</span> 使用SeataDataSourceBeanPostProcessor自动代理数据源
<span class="hljs-bullet">-</span> 注意：需排除Spring Boot的自动数据源配置，避免冲突

步骤5：测试事务回滚场景
<span class="hljs-bullet">-</span> 模拟库存服务抛出异常
<span class="hljs-bullet">-</span> 验证订单服务和支付服务的数据是否被回滚
<span class="hljs-bullet">-</span> 查看Seata Server的事务日志，确认事务状态
</code></pre>
<h5 data-id="heading-17">第三步：标注每个子步骤的技术关键点</h5>
<p><strong>技术关键点标注</strong>：</p>
<ul>
<li><strong>步骤1关键点</strong>：Seata版本需与Spring Boot版本匹配，Spring Boot 3.x需使用Seata 1.7.1+</li>
<li><strong>步骤2关键点</strong>：tx-service-group需在Seata Server的file.conf中配置对应的集群名称</li>
<li><strong>步骤3关键点</strong>：@GlobalTransactional注解需放在事务发起方，被调用方不需要添加</li>
<li><strong>步骤4关键点</strong>：数据源代理配置需注意与Spring Boot自动配置的兼容，避免数据源冲突；需配置undo_log表用于存储回滚日志</li>
<li><strong>步骤5关键点</strong>：测试时需确保Seata Server正常运行，且各服务的注册中心配置正确</li>
</ul>
<h5 data-id="heading-18">第四步：设计对应的CoT提示词</h5>
<p><strong>完整CoT提示词</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">请帮我实现Seata分布式事务在Spring Boot微服务中的集成，请按以下步骤思考并实现：

【需求背景】
我需要在一个包含订单服务、库存服务、支付服务的微服务系统中，实现分布式事务。
当订单服务创建订单后，需要调用库存服务扣减库存，然后调用支付服务处理支付。
如果任何一个服务失败，都需要回滚所有已执行的操作。

【技术栈限定】
<span class="hljs-deletion">- Spring Boot 3.2.0</span>
<span class="hljs-deletion">- Java 17</span>
<span class="hljs-deletion">- Seata 1.7.1</span>
<span class="hljs-deletion">- Nacos 2.2.0（作为注册中心和配置中心）</span>
<span class="hljs-deletion">- MySQL 8.0</span>
<span class="hljs-deletion">- MyBatis-Plus 3.5.3</span>

【实现步骤】

步骤1：引入Seata依赖
<span class="hljs-deletion">- 在三个服务的pom.xml中添加Seata相关依赖</span>
<span class="hljs-deletion">- 指定Seata版本为1.7.1（确保与Spring Boot 3.x兼容）</span>
<span class="hljs-deletion">- 依赖包括：seata-spring-boot-starter、seata-all</span>

步骤2：配置Seata事务组和注册中心
<span class="hljs-deletion">- 在application.yml中配置Seata相关参数：</span>
  * seata.application-id：各服务的应用ID（order-service、inventory-service、payment-service）
  * seata.tx-service-group：事务组名称（my_test_tx_group）
  * seata.config.type：nacos
  * seata.config.nacos.server-addr：127.0.0.1:8848
  * seata.registry.type：nacos
  * seata.registry.nacos.server-addr：127.0.0.1:8848
<span class="hljs-deletion">- 注意：tx-service-group需与Seata Server的file.conf中配置的集群名称一致</span>

步骤3：编写业务服务代码
<span class="hljs-deletion">- 在订单服务的OrderService中创建createOrder方法</span>
<span class="hljs-deletion">- 方法上添加@GlobalTransactional(rollbackFor = Exception.class)注解</span>
<span class="hljs-deletion">- 方法内部依次调用：</span>
  1. 本地数据库插入订单记录
  2. 通过Feign调用库存服务扣减库存
  3. 通过Feign调用支付服务处理支付
<span class="hljs-deletion">- 注意：@GlobalTransactional只能标注在事务发起方（订单服务），被调用方不需要添加</span>

步骤4：配置数据源代理
<span class="hljs-deletion">- 创建SeataConfig配置类</span>
<span class="hljs-deletion">- 使用@Configuration注解</span>
<span class="hljs-deletion">- 配置SeataDataSourceBeanPostProcessor自动代理数据源</span>
<span class="hljs-deletion">- 排除Spring Boot的自动数据源配置（使用@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)）</span>
<span class="hljs-deletion">- 在各服务的数据库中创建undo_log表（用于存储Seata的回滚日志）</span>

步骤5：测试事务回滚场景
<span class="hljs-deletion">- 编写测试用例，模拟库存服务抛出异常</span>
<span class="hljs-deletion">- 验证订单服务的数据是否被回滚（订单记录不应存在）</span>
<span class="hljs-deletion">- 查看Seata Server的控制台，确认事务状态为Rollbacked</span>

【输出要求】
1. 提供三个服务的完整配置代码（application.yml）
2. 提供订单服务的完整业务代码（Controller、Service、Mapper）
3. 提供SeataConfig配置类代码
4. 提供undo_log表的SQL脚本
5. 提供测试用例代码
6. 代码需符合阿里巴巴Java开发手册规范，包含必要的注释

请按照以上步骤，输出完整的实现方案。
</code></pre>
<h5 data-id="heading-19">第五步：对比"无CoT提示词"与"有CoT提示词"的AI输出差异</h5>
<p><strong>无CoT提示词</strong>：</p>
<pre><code class="hljs">请帮我集成Seata分布式事务
</code></pre>
<p><strong>AI输出特点</strong>：</p>
<ul>
<li>可能只给出部分配置代码，缺少关键步骤</li>
<li>没有说明@GlobalTransactional的使用位置</li>
<li>缺少数据源代理配置</li>
<li>没有提供测试用例</li>
<li>代码注释不完整</li>
</ul>
<p><strong>有CoT提示词</strong>：</p>
<ul>
<li>输出完整的三个服务的配置和代码</li>
<li>明确说明@GlobalTransactional的使用场景和注意事项</li>
<li>包含数据源代理配置和undo_log表创建脚本</li>
<li>提供完整的测试用例</li>
<li>代码包含详细注释和关键点说明</li>
<li>输出结构清晰，可直接按照步骤实施</li>
</ul>
<hr/>
<h4 data-id="heading-20">案例2：开发Java定时任务并实现动态启停与参数调整</h4>
<h5 data-id="heading-21">第一步：明确需求核心痛点</h5>
<p><strong>核心痛点</strong>：</p>
<ul>
<li>传统@Scheduled注解实现的定时任务无法动态启停</li>
<li>任务执行参数需要重启应用才能修改</li>
<li>需要支持多个定时任务的管理，每个任务可独立控制</li>
</ul>
<h5 data-id="heading-22">第二步：拆解技术实现子步骤</h5>
<p><strong>步骤拆解</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">步骤1：设计定时任务管理接口
<span class="hljs-deletion">- 定义TaskScheduler接口，包含启动、停止、更新参数方法</span>
<span class="hljs-deletion">- 使用ThreadPoolTaskScheduler作为任务调度器</span>
<span class="hljs-deletion">- 使用ScheduledFuture保存任务句柄，用于后续停止任务</span>

步骤2：实现任务配置存储
<span class="hljs-deletion">- 创建TaskConfig实体类（任务名称、cron表达式、是否启用、任务参数）</span>
<span class="hljs-deletion">- 使用数据库存储任务配置（支持动态修改）</span>
<span class="hljs-deletion">- 提供TaskConfigService用于配置的CRUD操作</span>

步骤3：实现动态任务调度核心逻辑
<span class="hljs-deletion">- 创建DynamicTaskScheduler类，实现TaskScheduler接口</span>
<span class="hljs-deletion">- 实现startTask方法：根据配置创建ScheduledFuture并启动任务</span>
<span class="hljs-deletion">- 实现stopTask方法：通过ScheduledFuture取消任务</span>
<span class="hljs-deletion">- 实现updateTask方法：先停止旧任务，再启动新任务</span>

步骤4：实现任务配置变更监听
<span class="hljs-deletion">- 使用@EventListener监听配置变更事件</span>
<span class="hljs-deletion">- 当配置变更时，自动更新对应的定时任务</span>
<span class="hljs-deletion">- 支持任务的启用/禁用切换</span>

步骤5：提供管理接口
<span class="hljs-deletion">- 创建TaskManageController，提供RESTful API</span>
<span class="hljs-deletion">- 接口包括：启动任务、停止任务、更新任务配置、查询任务状态</span>
<span class="hljs-deletion">- 使用统一响应格式封装返回结果</span>
</code></pre>
<h5 data-id="heading-23">第三步：标注每个子步骤的技术关键点</h5>
<p><strong>技术关键点</strong>：</p>
<ul>
<li><strong>步骤1关键点</strong>：ThreadPoolTaskScheduler需配置线程池大小，避免任务过多导致线程耗尽</li>
<li><strong>步骤2关键点</strong>：任务参数使用JSON格式存储，方便扩展；需考虑配置的并发修改问题</li>
<li><strong>步骤3关键点</strong>：ScheduledFuture的cancel方法需传入true参数，确保正在执行的任务也能被中断</li>
<li><strong>步骤4关键点</strong>：配置变更监听需考虑事务提交时机，避免配置已更新但任务未更新的不一致状态</li>
<li><strong>步骤5关键点</strong>：管理接口需添加权限控制，避免未授权用户操作定时任务</li>
</ul>
<h5 data-id="heading-24">第四步：设计对应的CoT提示词</h5>
<p><strong>完整CoT提示词</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">请帮我实现Java定时任务的动态启停与参数调整功能，请按以下步骤思考并实现：

【需求背景】
我需要实现一个定时任务管理系统，支持：
<span class="hljs-bullet">1.</span> 动态启动和停止定时任务（无需重启应用）
<span class="hljs-bullet">2.</span> 动态修改任务的执行参数和cron表达式
<span class="hljs-bullet">3.</span> 支持多个定时任务的独立管理
<span class="hljs-bullet">4.</span> 任务配置存储在数据库中，支持持久化

【技术栈限定】
<span class="hljs-bullet">-</span> Spring Boot 3.2.0
<span class="hljs-bullet">-</span> Java 17
<span class="hljs-bullet">-</span> MySQL 8.0
<span class="hljs-bullet">-</span> MyBatis-Plus 3.5.3
<span class="hljs-bullet">-</span> Spring Task（使用ThreadPoolTaskScheduler）

【实现步骤】

步骤1：设计定时任务管理接口
<span class="hljs-bullet">-</span> 创建TaskScheduler接口，定义以下方法：
<span class="hljs-bullet">  *</span> void startTask(String taskName)：启动指定任务
<span class="hljs-bullet">  *</span> void stopTask(String taskName)：停止指定任务
<span class="hljs-bullet">  *</span> void updateTask(String taskName, TaskConfig config)：更新任务配置
<span class="hljs-bullet">  *</span> TaskStatus getTaskStatus(String taskName)：获取任务状态
<span class="hljs-bullet">-</span> 使用ThreadPoolTaskScheduler作为底层调度器
<span class="hljs-bullet">-</span> 使用ConcurrentHashMap<span class="xml">&lt;String, ScheduledFuture&gt;</span>保存任务句柄，key为任务名称

步骤2：实现任务配置存储
<span class="hljs-bullet">-</span> 创建TaskConfig实体类，包含字段：
<span class="hljs-bullet">  *</span> taskName：任务名称（唯一）
<span class="hljs-bullet">  *</span> cronExpression：cron表达式
<span class="hljs-bullet">  *</span> enabled：是否启用
<span class="hljs-bullet">  *</span> taskParams：任务参数（JSON格式存储）
<span class="hljs-bullet">  *</span> description：任务描述
<span class="hljs-bullet">-</span> 创建task<span class="hljs-emphasis">_config表，使用MyBatis-Plus进行CRUD操作
- 创建TaskConfigService，提供配置的增删改查方法

步骤3：实现动态任务调度核心逻辑
- 创建DynamicTaskScheduler类，实现TaskScheduler接口
- 实现startTask方法：
  1. 从数据库查询任务配置
  2. 检查任务是否已存在，如存在则先停止
  3. 根据cron表达式创建ScheduledFuture
  4. 将ScheduledFuture保存到Map中
- 实现stopTask方法：
  1. 从Map中获取ScheduledFuture
  2. 调用cancel(true)取消任务（true表示中断正在执行的任务）
  3. 从Map中移除任务句柄
- 实现updateTask方法：
  1. 更新数据库中的任务配置
  2. 调用stopTask停止旧任务
  3. 调用startTask启动新任务

步骤4：实现任务配置变更监听
- 创建TaskConfigChangeEvent事件类
- 在TaskConfigService的更新方法中发布事件
- 创建TaskConfigChangeListener，使用@EventListener监听事件
- 监听器中调用DynamicTaskScheduler的updateTask方法更新任务

步骤5：提供管理接口
- 创建TaskManageController，提供以下RESTful API：
  * POST /api/task/start/{taskName}：启动任务
  * POST /api/task/stop/{taskName}：停止任务
  * PUT /api/task/{taskName}：更新任务配置
  * GET /api/task/{taskName}/status：查询任务状态
  * GET /api/task/list：查询所有任务列表
- 使用统一响应格式Result<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">T</span>&gt;</span></span>封装返回结果
- 添加参数校验和异常处理

【输出要求】
1. 提供完整的实体类、Service、Controller代码
2. 提供数据库表创建SQL脚本
3. 提供ThreadPoolTaskScheduler的配置类代码
4. 提供使用示例（如何定义一个可动态管理的定时任务）
5. 代码需包含详细注释，说明关键逻辑
6. 提供API测试用例（使用Postman或curl命令）

请按照以上步骤，输出完整的实现方案。
</span></code></pre>
<hr/>
<h4 data-id="heading-25">案例3：优化Java项目中MySQL慢查询（含SQL改写、索引设计）</h4>
<h5 data-id="heading-26">第一步：明确需求核心痛点</h5>
<p><strong>核心痛点</strong>：</p>
<ul>
<li>生产环境出现慢查询，影响系统性能</li>
<li>需要识别慢查询SQL，分析执行计划</li>
<li>通过SQL改写和索引优化提升查询性能</li>
</ul>
<h5 data-id="heading-27">第二步：拆解技术实现子步骤</h5>
<p><strong>步骤拆解</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">步骤1：开启MySQL慢查询日志
<span class="hljs-deletion">- 配置slow_query_log=ON</span>
<span class="hljs-deletion">- 设置long_query_time阈值（如1秒）</span>
<span class="hljs-deletion">- 配置slow_query_log_file路径</span>

步骤2：分析慢查询SQL
<span class="hljs-deletion">- 使用mysqldumpslow工具分析慢查询日志</span>
<span class="hljs-deletion">- 识别高频慢查询SQL</span>
<span class="hljs-deletion">- 使用EXPLAIN分析SQL执行计划</span>

步骤3：SQL改写优化
<span class="hljs-deletion">- 避免SELECT *，只查询需要的字段</span>
<span class="hljs-deletion">- 使用JOIN替代子查询</span>
<span class="hljs-deletion">- 避免在WHERE子句中使用函数</span>
<span class="hljs-deletion">- 使用LIMIT限制返回结果集大小</span>

步骤4：索引设计优化
<span class="hljs-deletion">- 分析WHERE、ORDER BY、GROUP BY字段</span>
<span class="hljs-deletion">- 创建合适的索引（单列索引、复合索引）</span>
<span class="hljs-deletion">- 注意索引的选择性和覆盖索引的使用</span>
<span class="hljs-deletion">- 避免创建过多索引（影响写入性能）</span>

步骤5：验证优化效果
<span class="hljs-deletion">- 对比优化前后的执行时间</span>
<span class="hljs-deletion">- 使用EXPLAIN对比执行计划变化</span>
<span class="hljs-deletion">- 监控慢查询日志，确认慢查询数量减少</span>
</code></pre>
<h5 data-id="heading-28">第三步：标注每个子步骤的技术关键点</h5>
<p><strong>技术关键点</strong>：</p>
<ul>
<li><strong>步骤1关键点</strong>：生产环境开启慢查询日志需注意磁盘空间，定期清理日志文件</li>
<li><strong>步骤2关键点</strong>：EXPLAIN重点关注type字段（ALL最差，index最好）、key字段（是否使用索引）、rows字段（扫描行数）</li>
<li><strong>步骤3关键点</strong>：SQL改写需保证业务逻辑不变，建议先在测试环境验证</li>
<li><strong>步骤4关键点</strong>：复合索引遵循最左前缀原则；索引字段顺序需考虑查询频率和选择性</li>
<li><strong>步骤5关键点</strong>：优化后需持续监控，避免出现新的慢查询</li>
</ul>
<h5 data-id="heading-29">第四步：设计对应的CoT提示词</h5>
<p><strong>完整CoT提示词</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">请帮我优化Java项目中的MySQL慢查询问题，请按以下步骤分析并优化：

【问题背景】
生产环境出现慢查询，影响系统性能。需要识别慢查询<span class="hljs-keyword">SQL</span>，通过<span class="hljs-keyword">SQL</span>改写和索引优化提升查询性能。

【当前环境】
<span class="hljs-operator">-</span> MySQL <span class="hljs-number">8.0</span>
<span class="hljs-operator">-</span> Spring Boot <span class="hljs-number">3.2</span><span class="hljs-number">.0</span>
<span class="hljs-operator">-</span> MyBatis<span class="hljs-operator">-</span>Plus <span class="hljs-number">3.5</span><span class="hljs-number">.3</span>
<span class="hljs-operator">-</span> 主要慢查询表：<span class="hljs-keyword">order</span>表（<span class="hljs-number">1000</span>万数据）、<span class="hljs-keyword">user</span>表（<span class="hljs-number">500</span>万数据）

【优化步骤】

步骤<span class="hljs-number">1</span>：开启MySQL慢查询日志
<span class="hljs-operator">-</span> 在MySQL配置文件中设置：
  <span class="hljs-operator">*</span> slow_query_log <span class="hljs-operator">=</span> <span class="hljs-keyword">ON</span>
  <span class="hljs-operator">*</span> long_query_time <span class="hljs-operator">=</span> <span class="hljs-number">1</span>（超过<span class="hljs-number">1</span>秒的查询记录为慢查询）
  <span class="hljs-operator">*</span> slow_query_log_file <span class="hljs-operator">=</span> <span class="hljs-operator">/</span>var<span class="hljs-operator">/</span>log<span class="hljs-operator">/</span>mysql<span class="hljs-operator">/</span>slow<span class="hljs-operator">-</span>query.log
<span class="hljs-operator">-</span> 提供开启慢查询日志的<span class="hljs-keyword">SQL</span>命令和配置文件示例

步骤<span class="hljs-number">2</span>：分析慢查询<span class="hljs-keyword">SQL</span>
<span class="hljs-operator">-</span> 使用mysqldumpslow工具分析慢查询日志：
  <span class="hljs-operator">*</span> mysqldumpslow <span class="hljs-operator">-</span>s t <span class="hljs-operator">-</span>t <span class="hljs-number">10</span> slow<span class="hljs-operator">-</span>query.log（按执行时间排序，显示前<span class="hljs-number">10</span>条）
<span class="hljs-operator">-</span> 识别高频慢查询<span class="hljs-keyword">SQL</span>，重点关注：
  <span class="hljs-operator">*</span> 执行次数最多的<span class="hljs-keyword">SQL</span>
  <span class="hljs-operator">*</span> 平均执行时间最长的<span class="hljs-keyword">SQL</span>
  <span class="hljs-operator">*</span> 总耗时最长的<span class="hljs-keyword">SQL</span>
<span class="hljs-operator">-</span> 对每个慢查询<span class="hljs-keyword">SQL</span>使用EXPLAIN分析执行计划：
  <span class="hljs-operator">*</span> 重点关注type字段（<span class="hljs-keyword">ALL</span>表示全表扫描，需优化）
  <span class="hljs-operator">*</span> 关注key字段（是否使用了索引）
  <span class="hljs-operator">*</span> 关注<span class="hljs-keyword">rows</span>字段（扫描的行数）

步骤<span class="hljs-number">3</span>：<span class="hljs-keyword">SQL</span>改写优化
针对以下常见慢查询场景，提供<span class="hljs-keyword">SQL</span>改写方案：
<span class="hljs-operator">-</span> 场景<span class="hljs-number">1</span>：<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> create_time <span class="hljs-operator">&gt;</span> ?
  <span class="hljs-operator">*</span> 改写：只查询需要的字段，避免全字段查询
<span class="hljs-operator">-</span> 场景<span class="hljs-number">2</span>：<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> order_id <span class="hljs-keyword">FROM</span> order_item <span class="hljs-keyword">WHERE</span> product_id <span class="hljs-operator">=</span> ?)
  <span class="hljs-operator">*</span> 改写：使用<span class="hljs-keyword">JOIN</span>替代子查询
<span class="hljs-operator">-</span> 场景<span class="hljs-number">3</span>：<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-type">DATE</span>(create_time) <span class="hljs-operator">=</span> <span class="hljs-string">'2024-01-01'</span>
  <span class="hljs-operator">*</span> 改写：避免在<span class="hljs-keyword">WHERE</span>子句中使用函数，改为范围查询
<span class="hljs-operator">-</span> 场景<span class="hljs-number">4</span>：<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time <span class="hljs-keyword">DESC</span> LIMIT <span class="hljs-number">10</span>
  <span class="hljs-operator">*</span> 改写：如果只需要前<span class="hljs-number">10</span>条，确保有索引支持排序

步骤<span class="hljs-number">4</span>：索引设计优化
针对<span class="hljs-keyword">order</span>表和<span class="hljs-keyword">user</span>表，设计合适的索引：
<span class="hljs-operator">-</span> <span class="hljs-keyword">order</span>表索引设计：
  <span class="hljs-operator">*</span> 主键索引：id（已存在）
  <span class="hljs-operator">*</span> 复合索引：(user_id, create_time) <span class="hljs-operator">-</span> 用于用户订单查询和排序
  <span class="hljs-operator">*</span> 单列索引：status <span class="hljs-operator">-</span> 用于订单状态筛选
  <span class="hljs-operator">*</span> 注意：避免创建过多索引，影响<span class="hljs-keyword">INSERT</span><span class="hljs-operator">/</span><span class="hljs-keyword">UPDATE</span>性能
<span class="hljs-operator">-</span> <span class="hljs-keyword">user</span>表索引设计：
  <span class="hljs-operator">*</span> 主键索引：id（已存在）
  <span class="hljs-operator">*</span> 唯一索引：email <span class="hljs-operator">-</span> 用于登录查询
  <span class="hljs-operator">*</span> 复合索引：(phone, status) <span class="hljs-operator">-</span> 用于手机号和状态联合查询
<span class="hljs-operator">-</span> 索引创建<span class="hljs-keyword">SQL</span>示例：
  <span class="hljs-operator">*</span> <span class="hljs-keyword">CREATE</span> INDEX idx_user_create_time <span class="hljs-keyword">ON</span> <span class="hljs-keyword">order</span>(user_id, create_time);
  <span class="hljs-operator">*</span> <span class="hljs-keyword">CREATE</span> INDEX idx_status <span class="hljs-keyword">ON</span> <span class="hljs-keyword">order</span>(status);

步骤<span class="hljs-number">5</span>：验证优化效果
<span class="hljs-operator">-</span> 对比优化前后的执行时间：
  <span class="hljs-operator">*</span> 使用<span class="hljs-keyword">SELECT</span> BENCHMARK(<span class="hljs-number">1000000</span>, <span class="hljs-keyword">SQL</span>)测试执行时间
  <span class="hljs-operator">*</span> 或使用EXPLAIN ANALYZE（MySQL <span class="hljs-number">8.0</span><span class="hljs-number">.18</span><span class="hljs-operator">+</span>）查看实际执行时间
<span class="hljs-operator">-</span> 使用EXPLAIN对比执行计划变化：
  <span class="hljs-operator">*</span> 优化前：type<span class="hljs-operator">=</span><span class="hljs-keyword">ALL</span>, <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">10000000</span>
  <span class="hljs-operator">*</span> 优化后：type<span class="hljs-operator">=</span><span class="hljs-keyword">ref</span>, <span class="hljs-keyword">rows</span><span class="hljs-operator">=</span><span class="hljs-number">100</span>, key<span class="hljs-operator">=</span>idx_user_create_time
<span class="hljs-operator">-</span> 监控慢查询日志，确认慢查询数量减少

【输出要求】
<span class="hljs-number">1.</span> 提供MySQL慢查询日志配置示例（my.cnf或my.ini）
<span class="hljs-number">2.</span> 提供慢查询分析脚本（shell脚本或Python脚本）
<span class="hljs-number">3.</span> 提供至少<span class="hljs-number">3</span>个<span class="hljs-keyword">SQL</span>改写示例（改写前后的<span class="hljs-keyword">SQL</span>对比）
<span class="hljs-number">4.</span> 提供完整的索引设计<span class="hljs-keyword">SQL</span>脚本
<span class="hljs-number">5.</span> 提供索引设计说明文档（说明每个索引的设计理由）
<span class="hljs-number">6.</span> 提供优化效果验证方法（包括测试<span class="hljs-keyword">SQL</span>和预期结果）
<span class="hljs-number">7.</span> 提供Java代码层面的优化建议（如使用MyBatis<span class="hljs-operator">-</span>Plus的批量查询、分页查询优化）

请按照以上步骤，输出完整的优化方案。
</code></pre>
<hr/>
<h3 data-id="heading-30">4. Java开发人员使用CoT提示词的避坑指南与优化技巧</h3>
<h4 data-id="heading-31">4.1 常见问题及优化方案</h4>
<h5 data-id="heading-32">问题1：步骤拆解过于笼统</h5>
<p><strong>问题表现</strong>：</p>
<pre><code class="hljs">请开发一个Java缓存工具类
</code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>未拆解缓存更新策略、并发安全处理等关键步骤</li>
<li>AI可能输出简单粗糙的实现，缺少必要的功能</li>
<li>没有明确技术选型和异常处理要求</li>
</ul>
<p><strong>优化方案</strong>：</p>
<p><strong>优化后的CoT提示词</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">请开发一个Java缓存工具类，请按以下步骤实现：

步骤1：定义缓存接口
<span class="hljs-deletion">- 定义Cache接口，包含get、put、delete、clear方法</span>
<span class="hljs-deletion">- 考虑泛型设计，支持不同类型的缓存值</span>

步骤2：实现核心缓存逻辑
<span class="hljs-deletion">- 使用ConcurrentHashMap作为底层存储（保证线程安全）</span>
<span class="hljs-deletion">- 实现基本的get、put、delete方法</span>
<span class="hljs-deletion">- 考虑缓存容量限制（LRU淘汰策略）</span>

步骤3：实现缓存过期机制
<span class="hljs-deletion">- 为每个缓存项添加过期时间字段</span>
<span class="hljs-deletion">- 实现定时清理过期缓存的机制（使用ScheduledExecutorService）</span>
<span class="hljs-deletion">- 在get方法中检查是否过期，过期则返回null并删除</span>

步骤4：处理并发安全
<span class="hljs-deletion">- 使用ConcurrentHashMap保证并发读写安全</span>
<span class="hljs-deletion">- 对于缓存更新操作，使用synchronized或ReentrantLock保证原子性</span>
<span class="hljs-deletion">- 考虑缓存穿透问题（对不存在的key也进行缓存，设置较短的过期时间）</span>

步骤5：编写单元测试
<span class="hljs-deletion">- 测试基本功能（get、put、delete）</span>
<span class="hljs-deletion">- 测试过期机制</span>
<span class="hljs-deletion">- 测试并发场景（使用CountDownLatch模拟多线程）</span>

请按照以上步骤，输出完整的代码实现。
</code></pre>
<p><strong>优化要点</strong>：</p>
<ul>
<li>按"定义接口→实现核心逻辑→处理异常→编写测试"的Java开发流程拆解步骤</li>
<li>每个步骤补充1-2个技术细节（如使用ConcurrentHashMap、LRU策略）</li>
<li>明确异常场景的处理方式（缓存穿透）</li>
</ul>
<hr/>
<h5 data-id="heading-33">问题2：未限定技术细节</h5>
<p><strong>问题表现</strong>：</p>
<pre><code class="hljs">请实现文件上传功能
</code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>未说明使用Java NIO还是传统IO流</li>
<li>未指定文件存储方式（本地存储、OSS、MinIO）</li>
<li>AI可能生成不符合项目技术选型的代码</li>
</ul>
<p><strong>优化方案</strong>：</p>
<p><strong>优化后的CoT提示词</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">请实现文件上传功能，技术细节要求如下：

【技术栈限定】
<span class="hljs-bullet">-</span> 使用Spring Boot 3.2.0
<span class="hljs-bullet">-</span> 文件存储：本地文件系统（不使用OSS或MinIO）
<span class="hljs-bullet">-</span> 文件处理：使用Apache Commons FileUpload（不使用Java NIO）
<span class="hljs-bullet">-</span> 文件大小限制：单个文件最大10MB，总请求大小最大50MB
<span class="hljs-bullet">-</span> 支持的文件类型：jpg、png、pdf、doc、docx

【实现步骤】

步骤1：配置文件上传参数
<span class="hljs-bullet">-</span> 在application.yml中配置：
<span class="hljs-bullet">  *</span> spring.servlet.multipart.max-file-size: 10MB
<span class="hljs-bullet">  *</span> spring.servlet.multipart.max-request-size: 50MB
<span class="hljs-bullet">  *</span> spring.servlet.multipart.enabled: true

步骤2：实现文件上传Controller
<span class="hljs-bullet">-</span> 使用@PostMapping接收multipart/form-data请求
<span class="hljs-bullet">-</span> 使用@RequestParam("file") MultipartFile接收文件
<span class="hljs-bullet">-</span> 文件类型校验：检查文件扩展名是否在允许列表中
<span class="hljs-bullet">-</span> 文件大小校验：检查文件大小是否超过限制

步骤3：实现文件存储逻辑
<span class="hljs-bullet">-</span> 创建FileStorageService服务类
<span class="hljs-bullet">-</span> 生成唯一文件名（UUID + 原始文件扩展名）
<span class="hljs-bullet">-</span> 将文件保存到指定目录（如：/data/uploads/yyyy/MM/dd/）
<span class="hljs-bullet">-</span> 按日期创建子目录，避免单个目录文件过多

步骤4：实现文件信息记录
<span class="hljs-bullet">-</span> 创建FileInfo实体类（文件名、原始文件名、文件路径、文件大小、上传时间）
<span class="hljs-bullet">-</span> 将文件信息保存到数据库（用于后续文件管理和下载）

步骤5：异常处理
<span class="hljs-bullet">-</span> 文件大小超限：抛出FileSizeLimitExceededException
<span class="hljs-bullet">-</span> 文件类型不支持：抛出UnsupportedFileTypeException
<span class="hljs-bullet">-</span> 文件保存失败：抛出FileStorageException
<span class="hljs-bullet">-</span> 使用@ControllerAdvice统一处理异常，返回错误响应

请按照以上技术细节和步骤，输出完整的实现代码。
</code></pre>
<p><strong>优化要点</strong>：</p>
<ul>
<li>明确指定技术选型（本地存储、Commons FileUpload）</li>
<li>限定具体的技术参数（文件大小、支持类型）</li>
<li>说明每个步骤的技术实现细节</li>
</ul>
<hr/>
<h5 data-id="heading-34">问题3：忽略异常场景引导</h5>
<p><strong>问题表现</strong>：</p>
<pre><code class="hljs">请实现Redis缓存工具类
</code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>未要求AI考虑Redis连接超时、序列化失败等异常场景</li>
<li>生成的代码可能缺乏健壮性，生产环境容易出问题</li>
</ul>
<p><strong>优化方案</strong>：</p>
<p><strong>优化后的CoT提示词</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">请实现Redis缓存工具类，请特别关注异常场景的处理：

【技术栈限定】
<span class="hljs-bullet">-</span> Spring Boot 3.2.0
<span class="hljs-bullet">-</span> Spring Data Redis
<span class="hljs-bullet">-</span> Jackson序列化

【实现步骤】

步骤1：实现基本缓存操作
<span class="hljs-bullet">-</span> 实现get、put、delete、exists方法
<span class="hljs-bullet">-</span> 使用RedisTemplate进行操作

步骤2：处理Redis连接异常场景
<span class="hljs-bullet">-</span> Redis连接超时：捕获RedisConnectionFailureException
<span class="hljs-bullet">  *</span> 记录错误日志（包含原始异常信息）
<span class="hljs-bullet">  *</span> 返回null或false，不中断业务流程
<span class="hljs-bullet">  *</span> 考虑实现降级策略（连接失败时使用本地缓存）
<span class="hljs-bullet">-</span> Redis命令执行失败：捕获RedisException
<span class="hljs-bullet">  *</span> 记录错误日志
<span class="hljs-bullet">  *</span> 根据异常类型决定是否重试（如网络超时可重试，命令错误不重试）

步骤3：处理序列化异常场景
<span class="hljs-bullet">-</span> 对象序列化失败：捕获JsonProcessingException
<span class="hljs-bullet">  *</span> 记录错误日志（包含序列化失败的key和对象类型）
<span class="hljs-bullet">  *</span> 返回null，不抛异常
<span class="hljs-bullet">  *</span> 考虑使用try-catch包裹序列化操作
<span class="hljs-bullet">-</span> 对象反序列化失败：捕获JsonMappingException
<span class="hljs-bullet">  *</span> 记录错误日志
<span class="hljs-bullet">  *</span> 返回null，并删除该key（避免下次再次反序列化失败）

步骤4：处理缓存穿透场景
<span class="hljs-bullet">-</span> 对于查询不存在的key，也进行缓存（缓存null值，设置较短过期时间）
<span class="hljs-bullet">-</span> 使用布隆过滤器（BloomFilter）预先判断key是否存在（可选）

步骤5：编写异常场景测试用例
<span class="hljs-bullet">-</span> 测试Redis连接断开场景
<span class="hljs-bullet">-</span> 测试序列化失败场景
<span class="hljs-bullet">-</span> 测试缓存穿透场景
<span class="hljs-bullet">-</span> 验证异常情况下系统不会崩溃

【输出要求】
<span class="hljs-bullet">-</span> 代码需包含完整的异常处理逻辑
<span class="hljs-bullet">-</span> 每个异常场景都需有对应的日志记录
<span class="hljs-bullet">-</span> 提供异常场景的测试用例
<span class="hljs-bullet">-</span> 说明异常处理的设计思路

请按照以上步骤，输出完整的实现代码。
</code></pre>
<p><strong>优化要点</strong>：</p>
<ul>
<li>明确列出需要处理的异常场景（连接超时、序列化失败等）</li>
<li>要求AI为每个异常场景提供处理方案</li>
<li>要求提供异常场景的测试用例</li>
</ul>
<hr/>
<h4 data-id="heading-35">4.2 通用优化技巧总结</h4>
<h5 data-id="heading-36">技巧1：使用"先分析后实现"的CoT结构</h5>
<p><strong>模板</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">请帮我实现[功能描述]，请按以下步骤思考：

步骤1：需求分析
<span class="hljs-deletion">- 明确功能的核心目标</span>
<span class="hljs-deletion">- 识别关键的技术难点</span>
<span class="hljs-deletion">- 列出需要处理的边界情况</span>

步骤2：技术选型
<span class="hljs-deletion">- 选择合适的技术方案</span>
<span class="hljs-deletion">- 说明选型理由</span>
<span class="hljs-deletion">- 列出技术栈版本要求</span>

步骤3：详细设计
<span class="hljs-deletion">- 设计类结构和接口</span>
<span class="hljs-deletion">- 设计数据模型</span>
<span class="hljs-deletion">- 设计异常处理机制</span>

步骤4：编码实现
<span class="hljs-deletion">- 按照设计实现代码</span>
<span class="hljs-deletion">- 添加必要的注释</span>
<span class="hljs-deletion">- 遵循编码规范</span>

步骤5：测试验证
<span class="hljs-deletion">- 编写单元测试</span>
<span class="hljs-deletion">- 编写集成测试</span>
<span class="hljs-deletion">- 验证边界情况</span>

请按照以上步骤，输出完整的实现方案。
</code></pre>
<h5 data-id="heading-37">技巧2：使用"对比优化"的CoT结构</h5>
<p><strong>模板</strong>：</p>
<pre><code class="hljs language-diff" lang="diff">请帮我优化[现有功能]，请按以下步骤分析：

步骤1：现状分析
<span class="hljs-deletion">- 分析当前实现的优缺点</span>
<span class="hljs-deletion">- 识别性能瓶颈</span>
<span class="hljs-deletion">- 找出潜在问题</span>

步骤2：优化方案设计
<span class="hljs-deletion">- 设计优化方案</span>
<span class="hljs-deletion">- 对比优化前后的差异</span>
<span class="hljs-deletion">- 评估优化效果</span>

步骤3：实施优化
<span class="hljs-deletion">- 按照优化方案修改代码</span>
<span class="hljs-deletion">- 保持功能兼容性</span>
<span class="hljs-deletion">- 添加必要的注释</span>

步骤4：验证优化效果
<span class="hljs-deletion">- 对比优化前后的性能指标</span>
<span class="hljs-deletion">- 验证功能正确性</span>
<span class="hljs-deletion">- 确认无回归问题</span>

请按照以上步骤，输出优化方案和代码。
</code></pre>
<h5 data-id="heading-38">技巧3：使用"场景驱动"的CoT结构</h5>
<p><strong>模板</strong>：</p>
<pre><code class="hljs language-css" lang="css">请帮我实现<span class="hljs-selector-attr">[功能描述]</span>，请针对以下场景分别设计解决方案：

场景<span class="hljs-number">1</span>：<span class="hljs-selector-attr">[场景描述]</span>
- 需求特点：<span class="hljs-selector-attr">[特点说明]</span>
- 实现方案：<span class="hljs-selector-attr">[方案说明]</span>
- 关键技术点：<span class="hljs-selector-attr">[技术点说明]</span>

场景<span class="hljs-number">2</span>：<span class="hljs-selector-attr">[场景描述]</span>
- 需求特点：<span class="hljs-selector-attr">[特点说明]</span>
- 实现方案：<span class="hljs-selector-attr">[方案说明]</span>
- 关键技术点：<span class="hljs-selector-attr">[技术点说明]</span>

...

请针对每个场景，输出对应的实现代码和说明。
</code></pre>
<hr/>
<h3 data-id="heading-39">5. 实战练习任务设计</h3>
<h4 data-id="heading-40">5.1 练习任务</h4>
<p><strong>任务描述</strong>：</p>
<p>请按照本指南所学的方法，自行拆解以下复杂Java需求，并设计对应的CoT提示词：</p>
<p><strong>需求</strong>：开发一个基于RabbitMQ的Java消息队列生产者/消费者，实现消息可靠投递（含确认机制、死信队列）与延迟消息功能。</p>
<p><strong>要求</strong>：</p>
<ol>
<li>将需求拆解为5-7个清晰的步骤</li>
<li>每个步骤需包含技术细节说明</li>
<li>明确技术栈限定和输出格式要求</li>
<li>考虑异常场景的处理</li>
<li>设计完整的CoT提示词</li>
</ol>
<hr/>
<h4 data-id="heading-41">5.2 参考拆解思路</h4>
<h5 data-id="heading-42">第一步：明确需求核心痛点</h5>
<p><strong>核心痛点</strong>：</p>
<ul>
<li>消息在传输过程中可能丢失（网络故障、服务重启）</li>
<li>消费者处理消息失败后，消息需要重新投递或进入死信队列</li>
<li>需要支持延迟消息功能（如订单30分钟未支付自动取消）</li>
</ul>
<h5 data-id="heading-43">第二步：拆解技术实现子步骤</h5>
<p><strong>步骤拆解</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">步骤1：引入RabbitMQ依赖和配置连接
<span class="hljs-bullet">-</span> 在pom.xml中添加spring-boot-starter-amqp依赖
<span class="hljs-bullet">-</span> 配置RabbitMQ连接信息（host、port、username、password、virtual-host）
<span class="hljs-bullet">-</span> 配置RabbitMQTemplate和ConnectionFactory

步骤2：实现消息可靠投递机制（生产者端）
<span class="hljs-bullet">-</span> 开启发布确认模式（publisher-confirm-type: correlated）
<span class="hljs-bullet">-</span> 实现ConfirmCallback回调，处理消息发送成功/失败的回调
<span class="hljs-bullet">-</span> 开启返回模式（publisher-returns: true），处理路由失败的消息
<span class="hljs-bullet">-</span> 实现ReturnCallback回调，处理路由失败的消息
<span class="hljs-bullet">-</span> 消息持久化：设置delivery-mode为2（持久化）

步骤3：实现消息确认机制（消费者端）
<span class="hljs-bullet">-</span> 设置手动确认模式（acknowledge-mode: manual）
<span class="hljs-bullet">-</span> 在消费者方法中使用Channel.basicAck确认消息
<span class="hljs-bullet">-</span> 实现消息处理失败时的拒绝机制（basicNack或basicReject）
<span class="hljs-bullet">-</span> 设置requeue参数，决定是否重新入队

步骤4：实现死信队列机制
<span class="hljs-bullet">-</span> 创建死信交换机（DLX）和死信队列（DLQ）
<span class="hljs-bullet">-</span> 在业务队列上绑定死信交换机，设置x-dead-letter-exchange参数
<span class="hljs-bullet">-</span> 配置消息进入死信队列的条件（消息被拒绝且不重新入队、消息过期、队列达到最大长度）
<span class="hljs-bullet">-</span> 创建死信队列的消费者，处理死信消息（记录日志、告警等）

步骤5：实现延迟消息功能
<span class="hljs-bullet">-</span> 方案1：使用RabbitMQ延迟消息插件（rabbitmq-delayed-message-exchange）
<span class="hljs-bullet">  *</span> 安装延迟消息插件
<span class="hljs-bullet">  *</span> 创建延迟交换机（类型为x-delayed-message）
<span class="hljs-bullet">  *</span> 发送消息时设置x-delay头部（延迟时间，单位毫秒）
<span class="hljs-bullet">-</span> 方案2：使用TTL+死信队列实现延迟消息
<span class="hljs-bullet">  *</span> 创建延迟队列，设置TTL
<span class="hljs-bullet">  *</span> 延迟队列的消息过期后进入死信队列（实际是目标队列）
<span class="hljs-bullet">  *</span> 消费者从目标队列消费消息

步骤6：实现消息生产者服务
<span class="hljs-bullet">-</span> 创建MessageProducerService服务类
<span class="hljs-bullet">-</span> 实现sendMessage方法，发送普通消息
<span class="hljs-bullet">-</span> 实现sendDelayedMessage方法，发送延迟消息
<span class="hljs-bullet">-</span> 实现sendReliableMessage方法，发送可靠消息（带确认回调）

步骤7：实现消息消费者服务
<span class="hljs-bullet">-</span> 创建MessageConsumerService服务类
<span class="hljs-bullet">-</span> 使用@RabbitListener注解监听队列
<span class="hljs-bullet">-</span> 实现消息处理逻辑，包含异常处理
<span class="hljs-bullet">-</span> 处理成功后调用basicAck确认，失败后调用basicNack拒绝
</code></pre>
<h5 data-id="heading-44">第三步：标注每个子步骤的技术关键点</h5>
<p><strong>技术关键点</strong>：</p>
<ul>
<li><strong>步骤1关键点</strong>：RabbitMQ版本需与Spring Boot版本匹配，Spring Boot 3.x需使用RabbitMQ 3.12+</li>
<li><strong>步骤2关键点</strong>：发布确认模式需在配置类中设置RabbitTemplate的ConfirmCallback和ReturnCallback</li>
<li><strong>步骤3关键点</strong>：手动确认模式下，必须调用basicAck，否则消息会一直留在队列中；异常情况下需调用basicNack并设置requeue=false，让消息进入死信队列</li>
<li><strong>步骤4关键点</strong>：死信队列的绑定需在队列声明时设置参数，不能后续修改</li>
<li><strong>步骤5关键点</strong>：延迟消息插件方案更简单直接，但需要安装插件；TTL方案无需插件，但实现较复杂</li>
<li><strong>步骤6关键点</strong>：消息持久化需同时设置delivery-mode和队列的durable属性</li>
<li><strong>步骤7关键点</strong>：消费者方法需捕获异常，避免异常导致消息丢失；建议使用try-catch包裹业务逻辑</li>
</ul>
<h5 data-id="heading-45">第四步：设计对应的CoT提示词</h5>
<p><strong>完整CoT提示词</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">请帮我实现基于RabbitMQ的Java消息队列生产者/消费者，实现消息可靠投递和延迟消息功能，请按以下步骤思考并实现：

【需求背景】
我需要实现一个消息队列系统，要求：
<span class="hljs-bullet">1.</span> 消息可靠投递：确保消息不丢失，支持发送确认和消费确认
<span class="hljs-bullet">2.</span> 死信队列：处理失败的消息，避免消息丢失
<span class="hljs-bullet">3.</span> 延迟消息：支持延迟指定时间后投递消息（如订单30分钟未支付自动取消）

【技术栈限定】
<span class="hljs-bullet">-</span> Spring Boot 3.2.0
<span class="hljs-bullet">-</span> Java 17
<span class="hljs-bullet">-</span> RabbitMQ 3.12.0
<span class="hljs-bullet">-</span> Spring AMQP（spring-boot-starter-amqp）

【实现步骤】

步骤1：引入RabbitMQ依赖和配置连接
<span class="hljs-bullet">-</span> 在pom.xml中添加spring-boot-starter-amqp依赖
<span class="hljs-bullet">-</span> 在application.yml中配置RabbitMQ连接信息：
<span class="hljs-bullet">  *</span> spring.rabbitmq.host: 127.0.0.1
<span class="hljs-bullet">  *</span> spring.rabbitmq.port: 5672
<span class="hljs-bullet">  *</span> spring.rabbitmq.username: guest
<span class="hljs-bullet">  *</span> spring.rabbitmq.password: guest
<span class="hljs-bullet">  *</span> spring.rabbitmq.virtual-host: /
<span class="hljs-bullet">-</span> 配置RabbitMQTemplate和ConnectionFactory（使用自动配置即可）

步骤2：实现消息可靠投递机制（生产者端）
<span class="hljs-bullet">-</span> 在application.yml中开启发布确认和返回模式：
<span class="hljs-bullet">  *</span> spring.rabbitmq.publisher-confirm-type: correlated
<span class="hljs-bullet">  *</span> spring.rabbitmq.publisher-returns: true
<span class="hljs-bullet">-</span> 创建RabbitMQConfig配置类：
<span class="hljs-bullet">  *</span> 配置RabbitTemplate的ConfirmCallback，处理消息发送成功/失败的回调
<span class="hljs-bullet">  *</span> 配置RabbitTemplate的ReturnCallback，处理路由失败的消息
<span class="hljs-bullet">  *</span> 设置mandatory=true，确保路由失败的消息能触发ReturnCallback
<span class="hljs-bullet">-</span> 消息持久化设置：
<span class="hljs-bullet">  *</span> 在发送消息时设置MessageProperties的delivery-mode为2（持久化）
<span class="hljs-bullet">  *</span> 声明队列时设置durable=true

步骤3：实现消息确认机制（消费者端）
<span class="hljs-bullet">-</span> 在application.yml中设置手动确认模式：
<span class="hljs-bullet">  *</span> spring.rabbitmq.listener.simple.acknowledge-mode: manual
<span class="hljs-bullet">-</span> 在消费者方法中：
<span class="hljs-bullet">  *</span> 使用@RabbitListener注解监听队列
<span class="hljs-bullet">  *</span> 方法参数包含Channel和Message（或使用@Payload和@Header）
<span class="hljs-bullet">  *</span> 消息处理成功后调用channel.basicAck(deliveryTag, false)确认消息
<span class="hljs-bullet">  *</span> 消息处理失败时调用channel.basicNack(deliveryTag, false, false)拒绝消息（不重新入队，进入死信队列）

步骤4：实现死信队列机制
<span class="hljs-bullet">-</span> 创建死信交换机（DLX）和死信队列（DLQ）：
<span class="hljs-bullet">  *</span> 死信交换机名称：dlx.exchange
<span class="hljs-bullet">  *</span> 死信队列名称：dlq.queue
<span class="hljs-bullet">  *</span> 绑定关系：dlq.queue绑定到dlx.exchange，routing-key为dlq.routing.key
<span class="hljs-bullet">-</span> 在业务队列声明时设置死信参数：
<span class="hljs-bullet">  *</span> x-dead-letter-exchange: dlx.exchange
<span class="hljs-bullet">  *</span> x-dead-letter-routing-key: dlq.routing.key
<span class="hljs-bullet">-</span> 创建死信队列的消费者：
<span class="hljs-bullet">  *</span> 监听dlq.queue队列
<span class="hljs-bullet">  *</span> 处理死信消息（记录日志、发送告警、持久化到数据库等）

步骤5：实现延迟消息功能
<span class="hljs-bullet">-</span> 使用RabbitMQ延迟消息插件方案（推荐）：
<span class="hljs-bullet">  *</span> 安装rabbitmq-delayed-message-exchange插件
<span class="hljs-bullet">  *</span> 在RabbitMQConfig中声明延迟交换机（类型为x-delayed-message，arguments包含x-delayed-type: direct）
<span class="hljs-bullet">  *</span> 创建延迟队列，绑定到延迟交换机
<span class="hljs-bullet">  *</span> 发送消息时设置x-delay头部（延迟时间，单位毫秒）
<span class="hljs-bullet">-</span> 如果无法安装插件，使用TTL+死信队列方案：
<span class="hljs-bullet">  *</span> 创建延迟队列，设置TTL（通过队列参数x-message-ttl或消息属性expiration）
<span class="hljs-bullet">  *</span> 延迟队列绑定到死信交换机，设置x-dead-letter-exchange和x-dead-letter-routing-key指向目标队列
<span class="hljs-bullet">  *</span> 消息在延迟队列中过期后，自动进入目标队列

步骤6：实现消息生产者服务
<span class="hljs-bullet">-</span> 创建MessageProducerService服务类：
<span class="hljs-bullet">  *</span> 注入RabbitTemplate
<span class="hljs-bullet">  *</span> 实现sendMessage方法：发送普通消息到指定队列
<span class="hljs-bullet">  *</span> 实现sendDelayedMessage方法：发送延迟消息（设置x-delay头部）
<span class="hljs-bullet">  *</span> 实现sendReliableMessage方法：发送可靠消息（设置delivery-mode=2，持久化）
<span class="hljs-bullet">-</span> 消息发送方法需包含异常处理：
<span class="hljs-bullet">  *</span> 捕获AmqpException异常
<span class="hljs-bullet">  *</span> 记录错误日志
<span class="hljs-bullet">  *</span> 考虑实现重试机制（使用Spring Retry）

步骤7：实现消息消费者服务
<span class="hljs-bullet">-</span> 创建MessageConsumerService服务类：
<span class="hljs-bullet">  *</span> 使用@RabbitListener注解监听业务队列
<span class="hljs-bullet">  *</span> 方法参数：@Payload String message, Channel channel, @Header(AmqpHeaders.DELIVERY<span class="hljs-emphasis">_TAG) long deliveryTag
  * 实现消息处理逻辑，使用try-catch包裹：
    - 处理成功：调用channel.basicAck(deliveryTag, false)
    - 处理失败：调用channel.basicNack(deliveryTag, false, false)，让消息进入死信队列
  * 记录处理日志（成功和失败都要记录）

【异常场景处理】
1. RabbitMQ连接失败：
   - 捕获AmqpConnectException异常
   - 记录错误日志
   - 考虑实现连接重试机制

2. 消息发送失败：
   - 在ConfirmCallback中处理发送失败的回调
   - 记录失败消息内容，考虑持久化到数据库，后续重试

3. 消息消费异常：
   - 捕获业务异常，调用basicNack拒绝消息
   - 记录异常日志，包含消息内容和异常堆栈
   - 避免无限重试，设置最大重试次数

4. 死信队列消息处理：
   - 死信消息需持久化到数据库，便于后续分析和人工处理
   - 发送告警通知（邮件、短信等）

【输出要求】
1. 提供完整的配置文件（application.yml）
2. 提供RabbitMQConfig配置类代码（包含交换机、队列声明，ConfirmCallback、ReturnCallback配置）
3. 提供MessageProducerService服务类代码（包含所有发送方法）
4. 提供MessageConsumerService服务类代码（包含消费者方法和异常处理）
5. 提供死信队列消费者的代码
6. 提供数据库表设计（用于存储死信消息）
7. 提供使用示例（Controller中调用生产者服务发送消息）
8. 代码需符合阿里巴巴Java开发手册规范，包含详细注释
9. 提供测试用例（使用@SpringBootTest测试消息发送和消费）

请按照以上步骤，输出完整的实现方案。
</span></code></pre>
<hr/>
<h4 data-id="heading-46">5.3 自我检查清单</h4>
<p>完成CoT提示词设计后，请对照以下清单检查：</p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>需求边界是否清晰</strong>：是否明确了功能范围、技术约束、异常处理要求？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>技术栈是否限定</strong>：是否指定了具体的版本号和依赖？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>步骤是否细化</strong>：每个步骤是否包含具体的技术实现细节？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>关键点是否标注</strong>：是否说明了每个步骤的技术关键点和注意事项？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>异常场景是否考虑</strong>：是否列出了需要处理的异常场景和处理方案？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>输出格式是否明确</strong>：是否要求了代码格式、注释规范、测试用例等？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>实用性是否足够</strong>：生成的提示词是否可以直接用于AI交互，解决实际问题？</li>
</ul>
<hr/>
<h3 data-id="heading-47">总结</h3>
<p>通过本指南的学习，Java开发人员应掌握：</p>
<ol>
<li><strong>CoT提示词的核心概念</strong>：理解CoT提示词的本质是步骤化推理，类似于代码逻辑流程</li>
<li><strong>CoT提示词的构成要素</strong>：掌握需求边界定义、技术栈限定、步骤化推理引导、输出格式要求四个核心模块</li>
<li><strong>复杂需求的拆解方法</strong>：学会将复杂Java技术需求拆解为AI可理解的步骤序列</li>
<li><strong>避坑技巧</strong>：了解常见问题（步骤过于笼统、未限定技术细节、忽略异常场景）及优化方案</li>
<li><strong>实战应用能力</strong>：能够独立设计高质量的CoT提示词，解决实际开发问题</li>
</ol>
<p><strong>下一步行动建议</strong>：</p>
<ul>
<li>在实际工作中尝试使用CoT提示词解决技术问题</li>
<li>根据实际效果不断优化和调整提示词结构</li>
<li>积累不同场景下的CoT提示词模板，形成个人知识库</li>
<li>与团队成员分享CoT提示词的使用经验，共同提升AI辅助开发的效率</li>
</ul>
<hr/>
<p><strong>附录：常用CoT提示词模板</strong></p>
<h4 data-id="heading-48">模板1：功能开发类</h4>
<pre><code class="hljs language-css" lang="css">请帮我实现<span class="hljs-selector-attr">[功能描述]</span>，请按以下步骤思考并实现：

【需求背景】
<span class="hljs-selector-attr">[详细描述需求背景和业务场景]</span>

【技术栈限定】
- <span class="hljs-selector-attr">[技术1]</span>：<span class="hljs-selector-attr">[版本号]</span>
- <span class="hljs-selector-attr">[技术2]</span>：<span class="hljs-selector-attr">[版本号]</span>
- ...

【实现步骤】
步骤<span class="hljs-number">1</span>：<span class="hljs-selector-attr">[步骤描述]</span>
- <span class="hljs-selector-attr">[技术细节1]</span>
- <span class="hljs-selector-attr">[技术细节2]</span>

步骤<span class="hljs-number">2</span>：<span class="hljs-selector-attr">[步骤描述]</span>
- <span class="hljs-selector-attr">[技术细节1]</span>
- <span class="hljs-selector-attr">[技术细节2]</span>

...

【异常场景处理】
<span class="hljs-number">1</span>. <span class="hljs-selector-attr">[异常场景1]</span>：<span class="hljs-selector-attr">[处理方案]</span>
<span class="hljs-number">2</span>. <span class="hljs-selector-attr">[异常场景2]</span>：<span class="hljs-selector-attr">[处理方案]</span>

【输出要求】
<span class="hljs-number">1</span>. <span class="hljs-selector-attr">[要求1]</span>
<span class="hljs-number">2</span>. <span class="hljs-selector-attr">[要求2]</span>
...

请按照以上步骤，输出完整的实现方案。
</code></pre>
<h4 data-id="heading-49">模板2：问题优化类</h4>
<pre><code class="hljs language-css" lang="css">请帮我优化<span class="hljs-selector-attr">[现有功能/问题]</span>，请按以下步骤分析并优化：

【问题背景】
<span class="hljs-selector-attr">[描述当前存在的问题和影响]</span>

【现状分析】
- <span class="hljs-selector-attr">[现状1]</span>
- <span class="hljs-selector-attr">[现状2]</span>

【优化目标】
- <span class="hljs-selector-attr">[目标1]</span>
- <span class="hljs-selector-attr">[目标2]</span>

【优化步骤】
步骤<span class="hljs-number">1</span>：<span class="hljs-selector-attr">[步骤描述]</span>
- <span class="hljs-selector-attr">[优化方案]</span>
- <span class="hljs-selector-attr">[关键技术点]</span>

步骤<span class="hljs-number">2</span>：<span class="hljs-selector-attr">[步骤描述]</span>
- <span class="hljs-selector-attr">[优化方案]</span>
- <span class="hljs-selector-attr">[关键技术点]</span>

...

【验证方法】
- <span class="hljs-selector-attr">[验证方法1]</span>
- <span class="hljs-selector-attr">[验证方法2]</span>

【输出要求】
<span class="hljs-number">1</span>. <span class="hljs-selector-attr">[要求1]</span>
<span class="hljs-number">2</span>. <span class="hljs-selector-attr">[要求2]</span>
...

请按照以上步骤，输出优化方案和代码。
</code></pre>
<hr/>
<p><em>本文档持续更新中，欢迎反馈和改进建议。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[深度学习]LSTM模型的构建模块(如何添加层)]]></title>    <link>https://juejin.cn/post/7592134330312425515</link>    <guid>https://juejin.cn/post/7592134330312425515</guid>    <pubDate>2026-01-07T03:15:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592134330312425515" data-draft-id="7592133956733747241" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[深度学习]LSTM模型的构建模块(如何添加层)"/> <meta itemprop="keywords" content="深度学习"/> <meta itemprop="datePublished" content="2026-01-07T03:15:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [深度学习]LSTM模型的构建模块(如何添加层)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T03:15:47.000Z" title="Wed Jan 07 2026 03:15:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题:我想使用lstm模型架构, 但是我不知道这个模型中有哪些模块, 比如我应该在神经网络中添加什么层?这个层是起到了什么作用?我应该在什么情况下添加什么层</h2>
<p>LSTM（长短期记忆网络）是一种特殊的循环神经网络（RNN），用于处理序列数据。它通过引入<code>门控机制</code>来解决传统RNN在<code>长序列训练中</code>可能出现的<code>梯度消失或爆炸</code>问题。下面我将详细介绍LSTM模型中的关键模块，以及如何构建一个LSTM网络。</p>
<h3 data-id="heading-1">LSTM模型中的关键模块</h3>
<ol>
<li>
<p><strong>LSTM单元（LSTM Cell）</strong> ：这是LSTM的核心，每个LSTM单元包含以下部分：</p>
<ul>
<li><strong>遗忘门（Forget Gate）</strong> ：决定从细胞状态中丢弃哪些信息。</li>
<li><strong>输入门（Input Gate）</strong> ：决定哪些新信息被存储在细胞状态中。</li>
<li><strong>输出门（Output Gate）</strong> ：基于细胞状态，决定输出什么信息。</li>
</ul>
<p>每个门都包含一个sigmoid激活函数，输出在0到1之间，表示信息的通过比例。此外，还有一个tanh激活函数用于生成新的候选值。</p>
</li>
<li>
<p><strong>循环层（Recurrent Layer）</strong> ：LSTM单元按照时间步展开，形成循环层，使得网络能够处理序列数据。</p>
</li>
</ol>
<h3 data-id="heading-2">构建LSTM网络时通常添加的层</h3>
<p>在构建LSTM模型时，除了LSTM层本身，我们通常还会添加其他类型的层。</p>
<p>以下是一个典型的LSTM网络结构：</p>
<ol>
<li>
<p><strong>嵌入层（Embedding Layer，可选）</strong> ：当处理<code>文本数据</code>时，通常首先将单词索引转换为密集向量表示,也就是embedding表示(稠密,低维的向量)。嵌入层可以学习到单词之间的语义关系。</p>
<ul>
<li>作用：将离散的符号（如单词）映射到连续的向量空间。</li>
<li>使用情况：处理文本分类、语言模型等任务时，如果输入是整数序列（例如单词索引），则添加嵌入层。</li>
</ul>
</li>
<li>
<p><strong>LSTM层（LSTM Layer）</strong> ：这是处理序列数据的主要层。</p>
<ul>
<li>作用：从输入序列中提取特征，并保持时间步之间的状态信息。</li>
<li>参数：通常需要指定隐藏状态的大小（即LSTM单元的数量）。</li>
<li>使用情况：处理任何序列数据，如时间序列预测、自然语言处理等。</li>
</ul>
</li>
<li>
<p><strong>Dropout层（可选）</strong> ：为了防止过拟合，可以在LSTM层<code>之后</code>添加Dropout层。</p>
<ul>
<li>作用：在训练过程中随机丢弃一部分神经元，以减少对特定神经元的依赖，提高泛化能力。</li>
<li>使用情况：当模型出现过拟合时，可以添加Dropout层。</li>
</ul>
</li>
<li>
<p><strong>重复LSTM层（可选）</strong> ：可以堆叠多个LSTM层，<code>以增加模型的复杂度。</code></p>
<ul>
<li>作用：深层LSTM可以学习更复杂的序列模式。</li>
<li>使用情况：当问题比较复杂，单层LSTM不足以捕捉模式时。</li>
</ul>
</li>
<li>
<p><strong>全连接层（Dense Layer）</strong> ：通常用于最终的输出。</p>
<ul>
<li>作用：将LSTM层的输出映射到所需的输出维度，例如<code>分类任务</code>中，使用<code>softmax激活函数</code>输出每个类别的概率。</li>
<li>使用情况：几乎所有的LSTM网络在最后都会添加全连接层，用于分类或回归。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">示例代码（使用Keras）</h3>
<p>下面是一个简单的LSTM模型示例，用于文本分类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> tensorflow.keras.models <span class="hljs-keyword">import</span> Sequential  <span class="hljs-comment"># 序列模型</span>
<span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> Embedding, LSTM, Dense, Dropout

<span class="hljs-comment"># 初始化一个空的序列模型</span>
model = Sequential()

<span class="hljs-comment"># 嵌入层，假设词汇表大小为10000，嵌入维度为128，输入序列长度为100</span>
model.add(Embedding(input_dim=<span class="hljs-number">10000</span>, 
                    output_dim=<span class="hljs-number">128</span>, 
                    input_length=<span class="hljs-number">100</span>))


<span class="hljs-comment"># 第一层LSTM，返回整个序列的输出，以便传递给下一层</span>
model.add(LSTM(units=<span class="hljs-number">64</span>, return_sequences=<span class="hljs-literal">True</span>))


<span class="hljs-comment"># 可以添加Dropout</span>
model.add(Dropout(<span class="hljs-number">0.5</span>))

<span class="hljs-comment"># 第二层LSTM，只返回最后一个时间步的输出</span>
model.add(LSTM(units=<span class="hljs-number">64</span>))

<span class="hljs-comment"># 又加了一层dropout层, 防止过拟合</span>
model.add(Dropout(<span class="hljs-number">0.5</span>))

<span class="hljs-comment"># 全连接层，假设是二分类问题</span>
model.add(Dense(units=<span class="hljs-number">1</span>, activation=<span class="hljs-string">'sigmoid'</span>))

model.<span class="hljs-built_in">compile</span>(optimizer=<span class="hljs-string">'adam'</span>, loss=<span class="hljs-string">'binary_crossentropy'</span>, metrics=[<span class="hljs-string">'accuracy'</span>])
model.summary()

</code></pre>
<h3 data-id="heading-4">如何选择添加什么层？</h3>
<ul>
<li><strong>嵌入层</strong>：当输入是离散的符号（如单词）且没有预训练的词向量时，可以添加嵌入层。如果有预训练的词向量（如Word2Vec、GloVe），可以使用预训练的权重初始化嵌入层。</li>
<li><strong>LSTM层</strong>：根据问题的复杂性选择LSTM单元的数量和层数。对于简单问题，一层LSTM可能足够；对于复杂问题，可以堆叠多层LSTM。</li>
<li><strong>Dropout层</strong>：如果模型在训练集上表现良好，但在验证集上表现差（过拟合），则可以添加Dropout层。通常Dropout率设置在0.2到0.5之间。</li>
<li><strong>全连接层</strong>：根据任务类型选择。例如，多分类问题使用softmax激活函数，二分类使用sigmoid，回归问题不使用激活函数。</li>
</ul>
<h3 data-id="heading-5">注意事项</h3>
<ul>
<li>当堆叠多层LSTM时，需要设置前一层LSTM的<code>return_sequences=True</code>，以便将序列输出传递给下一层。</li>
<li>LSTM层的单元数量（即隐藏状态大小）是一个重要的超参数，需要根据任务调整。</li>
</ul>
<p>希望这些信息能帮助你构建LSTM模型。根据具体任务，你可能需要调整层数、每层的单元数、Dropout率等超参数。</p>
<hr/>
<hr/>
<hr/>
<p>我来详细解释LSTM模型的构建模块，帮助你理解何时该添加什么层。</p>
<h3 data-id="heading-6"><strong>LSTM模型的核心模块</strong></h3>
<h4 data-id="heading-7"><strong>1. 输入层 (Input Layer)</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Keras示例</span>
<span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> Input
input_layer = Input(shape=(sequence_length, features))
</code></pre>
<p><strong>作用</strong>：定义模型输入数据的形状
<strong>何时添加</strong>：总是需要，作为第一层</p>
<h4 data-id="heading-8"><strong>2. 嵌入层 (Embedding Layer) - 文本处理专用</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> Embedding
embedding = Embedding(
    input_dim=vocab_size,  <span class="hljs-comment"># 词汇表大小</span>
    output_dim=embedding_dim,  <span class="hljs-comment"># 词向量维度</span>
    input_length=sequence_length
)
</code></pre>
<p><strong>作用</strong>：将离散的单词索引转换为密集向量表示
<strong>何时添加</strong>：处理文本数据时，在Input层之后</p>
<h4 data-id="heading-9"><strong>3. LSTM层 (核心层)</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> LSTM

<span class="hljs-comment"># 基础LSTM</span>
lstm_layer = LSTM(units=<span class="hljs-number">64</span>, return_sequences=<span class="hljs-literal">False</span>)

<span class="hljs-comment"># 返回完整序列（用于堆叠多层LSTM）</span>
lstm_layer = LSTM(units=<span class="hljs-number">64</span>, return_sequences=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 双向LSTM（效果通常更好）</span>
<span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> Bidirectional
bilstm = Bidirectional(LSTM(units=<span class="hljs-number">64</span>))
</code></pre>
<p><strong>作用</strong>：处理序列数据，捕捉时间依赖关系
<strong>参数说明</strong>：</p>
<ul>
<li><code>units</code>：隐藏状态的维度（通常32-512）</li>
<li><code>return_sequences</code>：
<ul>
<li><code>False</code>：只返回最后一个时间步的输出（用于分类）</li>
<li><code>True</code>：返回所有时间步的输出（用于序列标注或堆叠多层）</li>
</ul>
</li>
<li><code>dropout</code>：输入丢弃率</li>
<li><code>recurrent_dropout</code>：循环丢弃率</li>
</ul>
<p><strong>何时添加</strong>：总是需要，至少要有一层LSTM</p>
<h4 data-id="heading-10"><strong>4. Dropout层 / 正则化层</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> Dropout, BatchNormalization

dropout = Dropout(<span class="hljs-number">0.5</span>)  <span class="hljs-comment"># 丢弃50%的神经元</span>
batch_norm = BatchNormalization()
</code></pre>
<p><strong>作用</strong>：防止过拟合，提高泛化能力
<strong>何时添加</strong>：</p>
<ul>
<li>模型在训练集表现好但验证集差时</li>
<li>数据集较小或模型较复杂时</li>
<li>通常在LSTM层后或Dense层前</li>
</ul>
<h4 data-id="heading-11"><strong>5. 全连接层 (Dense Layer)</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> Dense

<span class="hljs-comment"># 分类任务</span>
dense_layer = Dense(units=num_classes, activation=<span class="hljs-string">'softmax'</span>)

<span class="hljs-comment"># 回归任务</span>
dense_layer = Dense(units=<span class="hljs-number">1</span>, activation=<span class="hljs-string">'linear'</span>)
</code></pre>
<p><strong>作用</strong>：将学习到的特征映射到输出空间
<strong>何时添加</strong>：</p>
<ul>
<li>输出层：总是需要（分类或回归）</li>
<li>中间层：需要增加模型复杂度时</li>
</ul>
<h4 data-id="heading-12"><strong>6. 其他辅助层</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 卷积层（用于提取局部特征）</span>
<span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> Conv1D
conv = Conv1D(filters=<span class="hljs-number">64</span>, kernel_size=<span class="hljs-number">3</span>, activation=<span class="hljs-string">'relu'</span>)

<span class="hljs-comment"># 池化层（用于降维）</span>
<span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> MaxPooling1D
pooling = MaxPooling1D(pool_size=<span class="hljs-number">2</span>)

<span class="hljs-comment"># 注意力层（用于关注重要部分）</span>
<span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> Attention
attention = Attention()
</code></pre>
<h3 data-id="heading-13"><strong>不同场景下的模型架构示例</strong></h3>
<h4 data-id="heading-14"><strong>场景1：文本分类（单层LSTM）</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> tensorflow.keras.models <span class="hljs-keyword">import</span> Sequential
<span class="hljs-keyword">from</span> tensorflow.keras.layers <span class="hljs-keyword">import</span> *

model = Sequential([
    Embedding(vocab_size=<span class="hljs-number">10000</span>, output_dim=<span class="hljs-number">128</span>, input_length=<span class="hljs-number">100</span>),
    LSTM(units=<span class="hljs-number">64</span>, dropout=<span class="hljs-number">0.2</span>, recurrent_dropout=<span class="hljs-number">0.2</span>),
    Dropout(<span class="hljs-number">0.5</span>),
    Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>),
    Dense(<span class="hljs-number">3</span>, activation=<span class="hljs-string">'softmax'</span>)  <span class="hljs-comment"># 3分类</span>
])
</code></pre>
<h4 data-id="heading-15"><strong>场景2：时间序列预测（多层LSTM）</strong></h4>
<pre><code class="hljs language-python" lang="python">model = Sequential([
    Input(shape=(<span class="hljs-number">30</span>, <span class="hljs-number">1</span>)),  <span class="hljs-comment"># 30个时间步，每个步长1个特征</span>
    LSTM(units=<span class="hljs-number">50</span>, return_sequences=<span class="hljs-literal">True</span>),
    BatchNormalization(),
    LSTM(units=<span class="hljs-number">50</span>, return_sequences=<span class="hljs-literal">False</span>),
    Dropout(<span class="hljs-number">0.3</span>),
    Dense(<span class="hljs-number">25</span>, activation=<span class="hljs-string">'relu'</span>),
    Dense(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 预测1个值</span>
])
</code></pre>
<h4 data-id="heading-16"><strong>场景3：序列标注（双向LSTM）</strong></h4>
<pre><code class="hljs language-python" lang="python">model = Sequential([
    Embedding(<span class="hljs-number">10000</span>, <span class="hljs-number">128</span>),
    Bidirectional(LSTM(<span class="hljs-number">64</span>, return_sequences=<span class="hljs-literal">True</span>)),  <span class="hljs-comment"># 返回完整序列</span>
    Dropout(<span class="hljs-number">0.3</span>),
    TimeDistributed(Dense(<span class="hljs-number">32</span>, activation=<span class="hljs-string">'relu'</span>)),  <span class="hljs-comment"># 每个时间步独立处理</span>
    Dense(num_tags, activation=<span class="hljs-string">'softmax'</span>)  <span class="hljs-comment"># 每个时间步的分类</span>
])
</code></pre>
<h4 data-id="heading-17"><strong>场景4：复杂任务（CNN + LSTM）</strong></h4>
<pre><code class="hljs language-python" lang="python">model = Sequential([
    Conv1D(filters=<span class="hljs-number">64</span>, kernel_size=<span class="hljs-number">3</span>, activation=<span class="hljs-string">'relu'</span>, 
           input_shape=(<span class="hljs-number">100</span>, <span class="hljs-number">1</span>)),  <span class="hljs-comment"># 提取局部特征</span>
    MaxPooling1D(pool_size=<span class="hljs-number">2</span>),  <span class="hljs-comment"># 降维</span>
    LSTM(<span class="hljs-number">50</span>, return_sequences=<span class="hljs-literal">True</span>),
    LSTM(<span class="hljs-number">50</span>),
    Dense(<span class="hljs-number">1</span>)
])
</code></pre>
<h3 data-id="heading-18"><strong>层添加决策流程</strong></h3>
<pre><code class="hljs language-ini" lang="ini">是否需要处理文本数据？
├── 是：添加 Embedding 层
└── 否：直接使用数值特征

添加第一层LSTM：
├── 需要后续LSTM层？设置 <span class="hljs-attr">return_sequences</span>=<span class="hljs-literal">True</span>
└── 不需要？设置 <span class="hljs-attr">return_sequences</span>=<span class="hljs-literal">False</span>

是否需要捕捉双向信息？
├── 是：使用 Bidirectional(LSTM())
└── 否：使用普通 LSTM()

模型是否过拟合？
├── 是：添加 Dropout(0.2-0.5) 或 BatchNormalization
└── 否：跳过

是否需要更复杂的特征表示？
├── 是：添加更多 LSTM 层 或 Dense 层
└── 否：直接连接输出层

任务类型是什么？
├── 分类：最后一层用 softmax（多分类）或 sigmoid（二分类）
├── 回归：最后一层用 linear 激活
└── 序列标注：用 TimeDistributed 包装输出层
</code></pre>
<h3 data-id="heading-19"><strong>实用建议</strong></h3>
<ol>
<li>
<p><strong>从简单开始</strong>：先尝试单层LSTM + Dropout + 输出层</p>
</li>
<li>
<p><strong>逐步复杂化</strong>：如果效果不好，再添加更多层</p>
</li>
<li>
<p><strong>通用推荐架构</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">Input</span> → <span class="hljs-selector-attr">[Embedding]</span> → <span class="hljs-built_in">LSTM</span>(<span class="hljs-number">64</span>-<span class="hljs-number">128</span>) → <span class="hljs-built_in">Dropout</span>(<span class="hljs-number">0.2</span>-<span class="hljs-number">0.5</span>) → <span class="hljs-built_in">Dense</span>(output)
</code></pre>
</li>
<li>
<p><strong>超参数设置</strong>：</p>
<ul>
<li>LSTM units：32, 64, 128, 256（逐渐增加）</li>
<li>Dropout率：0.2-0.5</li>
<li>学习率：0.001（Adam优化器默认）</li>
</ul>
</li>
<li>
<p><strong>调试技巧</strong>：</p>
<ul>
<li>过拟合？增加Dropout或减少LSTM单元数</li>
<li>欠拟合？增加LSTM层数或单元数</li>
<li>训练慢？减少批大小或序列长度</li>
</ul>
</li>
</ol>
<p>需要我针对你的具体任务类型（文本分类、时间序列预测等）提供更详细的架构建议吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 智能体高可靠设计模式：竞争代理组合]]></title>    <link>https://juejin.cn/post/7592094314473127971</link>    <guid>https://juejin.cn/post/7592094314473127971</guid>    <pubDate>2026-01-07T03:32:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592094314473127971" data-draft-id="7592147128215781428" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 智能体高可靠设计模式：竞争代理组合"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-07T03:32:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="俞凡"/> <meta itemprop="url" content="https://juejin.cn/user/290747765274222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 智能体高可靠设计模式：竞争代理组合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/290747765274222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    俞凡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-07T03:32:59.000Z" title="Wed Jan 07 2026 03:32:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><em>本系列介绍增强现代智能体系统可靠性的设计模式，以直观方式逐一介绍每个概念，拆解其目的，然后实现简单可行的版本，演示其如何融入现实世界的智能体系统。本系列一共 14 篇文章，这是第 6 篇。原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Flevelup.gitconnected.com%2Fbuilding-the-14-key-pillars-of-agentic-ai-229e50f65986" title="https://levelup.gitconnected.com/building-the-14-key-pillars-of-agentic-ai-229e50f65986" target="_blank" ref="nofollow noopener noreferrer">Building the 14 Key Pillars of Agentic AI</a></em></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6261c3c1eec64cfd94d619d91b102e1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-e5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768361579&amp;x-signature=Zt5MiopkMp6Otnwv0XNYlH7cVBA%3D" alt="" loading="lazy"/></p>
<p>优化智能体解决方案需要软件工程确保组件协调、并行运行并与系统高效交互。例如<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FSpeculative_execution" title="https://en.wikipedia.org/wiki/Speculative_execution" target="_blank" ref="nofollow noopener noreferrer">预测执行</a>，会尝试处理可预测查询以<strong>降低延迟</strong>，或者进行<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.arm.com%2Fcommunity%2Farm-community-blogs%2Fb%2Fembedded-and-microcontrollers-blog%2Fposts%2Fcomparing-lock-step-redundant-execution-versus-split-lock-technologies" title="https://developer.arm.com/community/arm-community-blogs/b/embedded-and-microcontrollers-blog/posts/comparing-lock-step-redundant-execution-versus-split-lock-technologies" target="_blank" ref="nofollow noopener noreferrer">冗余执行</a>，即<strong>对同一智能体重复执行多次</strong>以防单点故障。其他增强现代智能体系统可靠性的模式包括：</p>
<ul>
<li><strong>并行工具</strong>：智能体同时执行独立 API 调用以隐藏 I/O 延迟。</li>
<li><strong>层级智能体</strong>：管理者将任务拆分为由执行智能体处理的小步骤。</li>
<li><strong>竞争性智能体组合</strong>：多个智能体提出答案，系统选出最佳。</li>
<li><strong>冗余执行</strong>：即两个或多个智能体解决同一任务以检测错误并提高可靠性。</li>
<li><strong>并行检索和混合检索</strong>：多种检索策略协同运行以提升上下文质量。</li>
<li><strong>多跳检索</strong>：智能体通过迭代检索步骤收集更深入、更相关的信息。</li>
</ul>
<p>还有很多其他模式。</p>
<p>本系列将实现最常用智能体模式背后的基础概念，以直观方式逐一介绍每个概念，拆解其目的，然后实现简单可行的版本，演示其如何融入现实世界的智能体系统。</p>
<p>所有理论和代码都在 GitHub 仓库里：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFareedKhan-dev%2Fagentic-parallelism" title="https://github.com/FareedKhan-dev/agentic-parallelism" target="_blank" ref="nofollow noopener noreferrer">🤖 Agentic Parallelism: A Practical Guide 🚀</a></p>
<p>代码库组织如下：</p>
<pre><code class="hljs language-erlang" lang="erlang">agentic-parallelism/
    ├── <span class="hljs-number">01</span>_parallel_tool_use.ipynb
    ├── <span class="hljs-number">02</span>_parallel_hypothesis.ipynb
    ...
    ├── <span class="hljs-number">06</span>_competitive_agent_ensembles.ipynb
    ├── <span class="hljs-number">07</span>_agent_assembly_line.ipynb
    ├── <span class="hljs-number">08</span>_decentralized_blackboard.ipynb
    ...
    ├── <span class="hljs-number">13</span>_parallel_context_preprocessing.ipynb
    └── <span class="hljs-number">14</span>_parallel_multi_hop_retrieval.ipynb
</code></pre>
<hr/>
<h2 data-id="heading-0">竞争代理组合</h2>
<p>在智能体解决方案中，每个 AI 智能体都有其特定偏见、优势和劣势。</p>
<p>使用多样化代理组合可以降低单一代理产生次优或缺陷输出的风险。</p>
<p>通过结合多模型或提示策略，系统更具韧性，避免单点故障，更有可能产出高质量输出。</p>
<p>这种模式相当于人工智能寻求 “第二意见” 或进行竞争性设计流程。</p>
<p>我们将构建三个风格迥异的文案代理组合，负责撰写产品描述，然后看看评估器如何基于这些代理的输出进行推理，选择最佳方案，从而显著提升质量控制流程。</p>
<p>首先，组合的力量来自其成员的多样性。我们将利用两个不同的 LLM 家族创建三种不同的文案“角色”，以最大化多样性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFacePipeline
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer, AutoModelForCausalLM, pipeline
<span class="hljs-keyword">from</span> langchain_google_vertexai <span class="hljs-keyword">import</span> ChatVertexAI
<span class="hljs-keyword">import</span> torch

<span class="hljs-comment"># LLM 1: Llama 3 8B Instruct (开源, 通过 Hugging Face 本地部署)</span>
<span class="hljs-comment"># 为两个角色赋能</span>
model_id = <span class="hljs-string">"meta-llama/Meta-Llama-3-8B-Instruct"</span>
tokenizer = AutoTokenizer.from_pretrained(model_id)
hf_model = AutoModelForCausalLM.from_pretrained(
    model_id,
    torch_dtype=torch.bfloat16,
    device_map=<span class="hljs-string">"auto"</span>,
    load_in_4bit=<span class="hljs-literal">True</span>
)
pipe = pipeline(<span class="hljs-string">"text-generation"</span>, model=hf_model, tokenizer=tokenizer, max_new_tokens=<span class="hljs-number">1024</span>, do_sample=<span class="hljs-literal">True</span>, temperature=<span class="hljs-number">0.7</span>, top_p=<span class="hljs-number">0.9</span>)
llama3_llm = HuggingFacePipeline(pipeline=pipe)

<span class="hljs-comment"># LLM 2: Claude 3.5 Sonnet on Vertex AI (专有, 基于云服务)</span>
<span class="hljs-comment"># 使用来自不同厂商的模型和训练方法引入了显著的多样性</span>
claude_sonnet_llm = ChatVertexAI(model_name=<span class="hljs-string">"claude-3-5-sonnet@001"</span>, temperature=<span class="hljs-number">0.7</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"LLMs Initialized: Llama 3 and Claude 3.5 Sonnet are ready to compete."</span>)
</code></pre>
<p>通过使用两个完全不同的模型 —— 开源的 Llama 3 和谷歌的 Claude 3.5 Sonnet，确保组合拥有真正的多样性。这些代理拥有不同写作风格、知识门槛和固有偏见，而这正是我们想要的强有力竞争过程。</p>
<p>接下来定义 Pydantic 模型，以结构化文案代理和最终评估器的产出。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.pydantic_v1 <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductDescription</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""有标题和正文的结构化产品描述，是文案代理的输出"""</span>
    headline: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"A catchy, attention-grabbing headline for the product."</span>)
    body: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"A short paragraph (2-3 sentences) detailing the product's benefits and features."</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FinalEvaluation</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""评估器代理的结构化输出，包含最佳描述和详细评论"""</span>
    best_description: ProductDescription = Field(description=<span class="hljs-string">"The winning product description chosen by the judge."</span>)
    critique: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"A detailed, point-by-point critique explaining why the winner was chosen over the other options, referencing the evaluation criteria."</span>)
    winning_agent: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"The name of the agent that produced the winning description (e.g., 'Claude_Sonnet_Creative', 'Llama3_Direct', 'Llama3_Luxury')."</span>)
</code></pre>
<p>这些数据模型就是通信协议。</p>
<ol>
<li><code>ProductDescription</code> 模版确保三家竞争者以相同且一致的格式提交输出。</li>
<li><code>FinalEvaluation</code> 模版更为关键，迫使评估器代理不仅要选择一个 <code>winning_agent</code>，还要提供详细评审（<code>critique</code>），使决策过程透明且可审计。</li>
</ol>
<p>现在定义 <code>GraphState</code> 和代理节点。节点将通过辅助功能创建，以减少重复代码。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict, Annotated, <span class="hljs-type">Dict</span>
<span class="hljs-keyword">import</span> operator
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GraphState</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    product_name: <span class="hljs-built_in">str</span>
    product_category: <span class="hljs-built_in">str</span>
    features: <span class="hljs-built_in">str</span>
    <span class="hljs-comment"># 字典存储来自竞争代理的结果，并通过 operator.update 合并</span>
    competitor_results: Annotated[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, ProductDescription], operator.update]
    final_evaluation: FinalEvaluation
    performance_log: Annotated[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], operator.add]

<span class="hljs-comment"># 创建竞争节点的辅助“工厂”函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_competitor_node</span>(<span class="hljs-params">agent_name: <span class="hljs-built_in">str</span>, llm, prompt</span>):
    <span class="hljs-comment"># 每个竞争者都是一条链：提示词 -&gt; LLM -&gt; Pydantic 结构化输出</span>
    chain = prompt | llm.with_structured_output(ProductDescription)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">competitor_node</span>(<span class="hljs-params">state: GraphState</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"--- [COMPETITOR: <span class="hljs-subst">{agent_name}</span>] Starting generation... ---"</span>)
        start_time = time.time()
        result = chain.invoke({
            <span class="hljs-string">"product_name"</span>: state[<span class="hljs-string">'product_name'</span>],
            <span class="hljs-string">"product_category"</span>: state[<span class="hljs-string">'product_category'</span>],
            <span class="hljs-string">"features"</span>: state[<span class="hljs-string">'features'</span>]
        })
        execution_time = time.time() - start_time
        log = <span class="hljs-string">f"[<span class="hljs-subst">{agent_name}</span>] Completed in <span class="hljs-subst">{execution_time:<span class="hljs-number">.2</span>f}</span>s."</span>
        <span class="hljs-built_in">print</span>(log)
        <span class="hljs-comment"># 输出键与代理名称匹配，以便于聚合</span>
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"competitor_results"</span>: {agent_name: result}, <span class="hljs-string">"performance_log"</span>: [log]}
    <span class="hljs-keyword">return</span> competitor_node
</code></pre>
<p><code>create_competitor_node</code> 是构建多元化组合的最简单方式，输入名称、LLM 和提示符，返回一个完备的、支持结构化输出的 <code>LangGraph</code> 节点。让我们能够轻松定义三位竞争对手，让每个都有独特的模型和个性。</p>
<p>现在创建三个竞争节点和最终评估器节点。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用工厂创建三个竞争节点</span>
<span class="hljs-comment"># 每个都有不同的模型和提示词组合，以确保多样性</span>
claude_creative_node = create_competitor_node(<span class="hljs-string">"Claude_Sonnet_Creative"</span>, claude_sonnet_llm, claude_creative_prompt)
llama3_direct_node = create_competitor_node(<span class="hljs-string">"Llama3_Direct"</span>, llama3_llm, llama3_direct_prompt)
llama3_luxury_node = create_competitor_node(<span class="hljs-string">"Llama3_Luxury"</span>, llama3_llm, llama3_luxury_prompt)

<span class="hljs-comment"># 评估器节点</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">judge_node</span>(<span class="hljs-params">state: GraphState</span>):
    <span class="hljs-string">"""评估所有竞争者的结果并选出获胜者"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"--- [JUDGE] Evaluating competing descriptions... ---"</span>)
    start_time = time.time()
    
    <span class="hljs-comment"># 根据评估器提示，将不同描述格式化</span>
    descriptions_to_evaluate = <span class="hljs-string">""</span>
    <span class="hljs-keyword">for</span> name, desc <span class="hljs-keyword">in</span> state[<span class="hljs-string">'competitor_results'</span>].items():
        descriptions_to_evaluate += <span class="hljs-string">f"--- Option from <span class="hljs-subst">{name}</span> ---\nHeadline: <span class="hljs-subst">{desc.headline}</span>\nBody: <span class="hljs-subst">{desc.body}</span>\n\n"</span>
    
    <span class="hljs-comment"># 创建评估链</span>
    judge_chain = judge_prompt | llm.with_structured_output(FinalEvaluation)
    evaluation = judge_chain.invoke({
        <span class="hljs-string">"product_name"</span>: state[<span class="hljs-string">'product_name'</span>],
        <span class="hljs-string">"descriptions_to_evaluate"</span>: descriptions_to_evaluate
    })
    
    execution_time = time.time() - start_time
    log = <span class="hljs-string">f"[Judge] Completed evaluation in <span class="hljs-subst">{execution_time:<span class="hljs-number">.2</span>f}</span>s."</span>
    <span class="hljs-built_in">print</span>(log)
    
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"final_evaluation"</span>: evaluation, <span class="hljs-string">"performance_log"</span>: [log]}
</code></pre>
<p>现在确定了组合里的三个代理，有三个不同的文案节点，每个节点都针对不同风格设计，还有一个评估节点负责根据收集到的输出进行最终关键评估。</p>
<p>最后用“扇出扇入”架构组装图。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, END

workflow = StateGraph(GraphState)

<span class="hljs-comment"># 添加三个竞争节点</span>
workflow.add_node(<span class="hljs-string">"claude_creative"</span>, claude_creative_node)
workflow.add_node(<span class="hljs-string">"llama3_direct"</span>, llama3_direct_node)
workflow.add_node(<span class="hljs-string">"llama3_luxury"</span>, llama3_luxury_node)

<span class="hljs-comment"># 添加最终评估节点</span>
workflow.add_node(<span class="hljs-string">"judge"</span>, judge_node)

<span class="hljs-comment"># 入口点是节点列表，告诉 LangGraph 并行运行这些节点</span>
workflow.set_entry_point([<span class="hljs-string">"claude_creative"</span>, <span class="hljs-string">"llama3_direct"</span>, <span class="hljs-string">"llama3_luxury"</span>])

<span class="hljs-comment"># 列表中的边意味着图在继续之前会等待所有边完成，这就是扇入</span>
workflow.add_edge([<span class="hljs-string">"claude_creative"</span>, <span class="hljs-string">"llama3_direct"</span>, <span class="hljs-string">"llama3_luxury"</span>], <span class="hljs-string">"judge"</span>)

<span class="hljs-comment"># 最后一步是评估器决策</span>
workflow.add_edge(<span class="hljs-string">"judge"</span>, END)
app = workflow.<span class="hljs-built_in">compile</span>()
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33cd82e577c24078bebdd977cfe4091c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-e5Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768361579&amp;x-signature=rj656UU%2FwKEwM3HUt4k9vauyTtg%3D" alt="组合代理" loading="lazy"/></p>
<p>现在进行最后的一对一分析，审视这三种竞争性描述及评估器的最终决定，以理解该组合的好处。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json

<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"            THE COMPETING PRODUCT DESCRIPTIONS"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">60</span>)


<span class="hljs-keyword">for</span> name, desc <span class="hljs-keyword">in</span> final_state[<span class="hljs-string">'competitor_results'</span>].items():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n--- [<span class="hljs-subst">{name}</span>] ---"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Headline: <span class="hljs-subst">{desc[<span class="hljs-string">'headline'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Body: <span class="hljs-subst">{desc[<span class="hljs-string">'body'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"                  THE JUDGE'S FINAL VERDICT"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">60</span>)
final_eval = final_state[<span class="hljs-string">'final_evaluation'</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\nWinning Agent: <span class="hljs-subst">{final_eval[<span class="hljs-string">'winning_agent'</span>]}</span>\n"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Winning Description:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - Headline: <span class="hljs-subst">{final_eval[<span class="hljs-string">'best_description'</span>][<span class="hljs-string">'headline'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - Body: <span class="hljs-subst">{final_eval[<span class="hljs-string">'best_description'</span>][<span class="hljs-string">'body'</span>]}</span>\n"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Judge's Critique:"</span>)
<span class="hljs-built_in">print</span>(final_eval[<span class="hljs-string">'critique'</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"-"</span>*<span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"                      PERFORMANCE ANALYSIS"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span>*<span class="hljs-number">60</span>)


competitor_times = [<span class="hljs-number">7.33</span>, <span class="hljs-number">6.12</span>, <span class="hljs-number">6.45</span>]
judge_time = <span class="hljs-number">8.91</span>
parallel_time = <span class="hljs-built_in">max</span>(competitor_times)
sequential_time = <span class="hljs-built_in">sum</span>(competitor_times)
total_time = parallel_time + judge_time
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\nTotal Execution Time: <span class="hljs-subst">{total_time:<span class="hljs-number">.2</span>f}</span> seconds\n"</span>)
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#### 输出 ####</span>
============================================================
            THE COMPETING PRODUCT DESCRIPTIONS
============================================================

--- [Claude_Sonnet_Creative] ---
Headline: Your Life, Unlocked. Your Wellness, Understood.
Body: The Aura Smart Ring <span class="hljs-keyword">is</span> more than a tracker; its your silent wellness partner. Crafted <span class="hljs-keyword">from</span> durable titanium, it deciphers your body signals-sleep, activity, <span class="hljs-keyword">and</span> heart rate-translating them into insights that empower your every day. With a <span class="hljs-number">7</span>-day battery, its always on, always learning, always you.
--- [Llama3_Direct] ---
Headline: Track Everything. Wear Nothing.
Body: Meet the Aura Smart Ring. Get elite sleep <span class="hljs-keyword">and</span> activity tracking, <span class="hljs-number">24</span>/<span class="hljs-number">7</span> heart rate monitoring, <span class="hljs-keyword">and</span> a <span class="hljs-number">7</span>-day battery. Built <span class="hljs-keyword">from</span> tough titanium, it delivers powerful health insights without the bulk of a watch.
--- [Llama3_Luxury] ---
Headline: Master Your Narrative.
Body: For the discerning individual, the Aura Smart Ring <span class="hljs-keyword">is</span> an emblem of effortle...ously engineered <span class="hljs-keyword">from</span> aerospace-grade titanium, it provides a seamless interface to your personal biometrics. Command your well-being <span class="hljs-keyword">with</span> seven days of uninterrupted power <span class="hljs-keyword">and</span> unparalleled insight.

============================================================
                  THE JUDGES FINAL VERDICT
============================================================
Winning Agent: Claude_Sonnet_Creative
Winning Description:
  - Headline: Your Life, Unlocked. Your Wellness, Understood.
  - Body: The Aura Smart Ring <span class="hljs-keyword">is</span> more than a tracker; its your silent wellness partner. Crafted <span class="hljs-keyword">from</span> durable titanium, it deciphers your body<span class="hljs-string">'s signals-sleep, activity, and heart rate-translating them into insights that empower your every day. With a 7-day battery, it'</span>s always on, always learning, always you.

------------------------------------------------------------
                      PERFORMANCE ANALYSIS
------------------------------------------------------------
Total Execution Time: <span class="hljs-number">16.24</span> seconds
</code></pre>
<p>最终分析强调了竞争组合模式的两个关键优势。</p>
<ol>
<li><strong>通过多样性+评估器实现高质量</strong>：三个代理产生了明显不同的输出 Llama3_Direct（有力）、Llama3_Luxury（理想）和 Claude_Sonnet_Creative（利益驱动）。这种多样性为评估器代理提供了更强有力的评估工具。其最终选择体现了对权衡的明确推理，表明质量来自过程（竞争+评估），而非单一模型。</li>
<li><strong>通过并行性实现高性能</strong>：所有代理并行运行使流水线速度比顺序执行快了 63%，仅以最慢代理的时间开销，就获得了多样化输出，带来更高的质量和更高的运行效率。</li>
</ol>
<hr/>
<blockquote>
<p>Hi，我是俞凡，一名兼具技术深度与管理视野的技术管理者。曾就职于 Motorola，现任职于 Mavenir，多年带领技术团队，聚焦后端架构与云原生，持续关注 AI 等前沿方向，也关注人的成长，笃信持续学习的力量。在这里，我会分享技术实践与思考。欢迎关注公众号「DeepNoMind」，星标不迷路。也欢迎访问独立站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.deepnomind.com" title="https://www.deepnomind.com" target="_blank" ref="nofollow noopener noreferrer">www.DeepNoMind.com</a>，一起交流成长。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>