<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[一个大龄程序员的地铁日记（第5期），几乎都关于读书]]></title>    <link>https://juejin.cn/post/7587245616754343987</link>    <guid>https://juejin.cn/post/7587245616754343987</guid>    <pubDate>2025-12-24T11:52:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587245616754343987" data-draft-id="7587264707283943434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个大龄程序员的地铁日记（第5期），几乎都关于读书"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-24T11:52:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我要改名叫嘟嘟"/> <meta itemprop="url" content="https://juejin.cn/user/1698109849624061"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个大龄程序员的地铁日记（第5期），几乎都关于读书
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1698109849624061/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我要改名叫嘟嘟
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T11:52:00.000Z" title="Wed Dec 24 2025 11:52:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近一个月地铁上，输出内容几乎都围绕着某个主题，于是本篇内容当中都有小标题。</p>
<h3 data-id="heading-0">1、读什么书可以让人变得平静、淡定？</h3>
<p>以我的经验——过去5年，读了一些书，整个人变得内敛沉稳安静很多——来看，似乎变化与某一本书的关系不大，而仅仅只关于持续阅读这件事，只要持续阅读，过个三五年，整个人便会平静、淡定许多。</p>
<p>我这结论，大概是很主观的，我一时说不太清变化如何发生，但我将尽量将发生在我身上的变化说清楚。</p>
<p>首先，我以为仅仅读一本书，是不能做到改变的，不管是认知还是行为，都不行。</p>
<p>以《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247484824%26idx%3D1%26sn%3D248e953335962f291844655ce0afdc2f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247484824&amp;idx=1&amp;sn=248e953335962f291844655ce0afdc2f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">学习之道</a>》和《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247484213%26idx%3D1%26sn%3D46ddc3d51191cfabf18a8784f3996c44%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247484213&amp;idx=1&amp;sn=46ddc3d51191cfabf18a8784f3996c44&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">人性的弱点</a>》为例。</p>
<p>《学习之道》，是一位世界冠军两次夺得冠军的个人传记，作者在书中分享了他的学习之道——一切都基于重复练习，练习过程中需要辅以热爱。读完本书前后几个月，我是真有按照作者的分享去行事的，篮球从微小动作调整，台球也一点一滴进步，但这些微小调整只持续两三个月便被抛之脑后。</p>
<p>《人性的弱点》，是教导与人为善的一本书。阅读当时的我，天天脸带笑意，认真倾听，耐烦讨论。但这些善良的特点，在几个月后也慢慢消退。</p>
<p>即从书中收获的认知影响自己一段时间行为后，并不能持续。</p>
<p>然后，是“几乎所有的书都是有关联的”。这些慢慢退化的认知，在后来的读书当中，又被强化与巩固。</p>
<p>《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247485376%26idx%3D1%26sn%3D73a55563bfc591b9c5fc819eaa607dd4%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247485376&amp;idx=1&amp;sn=73a55563bfc591b9c5fc819eaa607dd4&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">天才假象</a>》也在说重复练习与热爱，《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247485188%26idx%3D1%26sn%3Debbbd8b5f355ce65a89eaf3903229e04%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247485188&amp;idx=1&amp;sn=ebbbd8b5f355ce65a89eaf3903229e04&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">乔布斯传</a>》甚至将热爱化作极致，《废邮存底》说读书写作如是。总之，这“基于热爱的重复练习是成功/熟练的必要条件”认知，慢慢在我内心变得巩固。</p>
<p>类似的认知，如沉稳、如安静、如三思而后行、如换位思考……都在读书当中慢慢变得巩固。被巩固的认知，会不自觉体现在行为当中，于是，便自然而然的平静且淡定了。</p>
<p>这过程无关某一本书，只在于持续阅读。</p>
<h3 data-id="heading-1">2、看过的人物传记当中，你最推荐的是哪一本？</h3>
<p>我目前看过的人物传记，有这样几本：《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247484860%26idx%3D1%26sn%3D86e75da8951708f40996548980361630%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247484860&amp;idx=1&amp;sn=86e75da8951708f40996548980361630&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">曾国藩传</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247484637%26idx%3D2%26sn%3D333113d87ab3080e4e288f04f2d6808f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247484637&amp;idx=2&amp;sn=333113d87ab3080e4e288f04f2d6808f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">人生随时可以重来</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247484979%26idx%3D1%26sn%3D42cd3716c384045d497004a57693fdd6%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247484979&amp;idx=1&amp;sn=42cd3716c384045d497004a57693fdd6&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">从文自传</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247485177%26idx%3D1%26sn%3D47e4d29e34639dca2aabfca279369026%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247485177&amp;idx=1&amp;sn=47e4d29e34639dca2aabfca279369026&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一个瑜伽行者的自传</a>》《乔布斯传》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247485199%26idx%3D1%26sn%3D90dac5fd75f47a63714041a34e19e2d2%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247485199&amp;idx=1&amp;sn=90dac5fd75f47a63714041a34e19e2d2&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">漫漫回家路</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247485233%26idx%3D1%26sn%3D2131400b109af41d0e62c3bb78b27e05%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247485233&amp;idx=1&amp;sn=2131400b109af41d0e62c3bb78b27e05&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">为奴十二年</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247485587%26idx%3D1%26sn%3De44da3e0c3418d6f7edeef23cfb5bc3c%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247485587&amp;idx=1&amp;sn=e44da3e0c3418d6f7edeef23cfb5bc3c&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">多余的话</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247485685%26idx%3D1%26sn%3D1a8d59c9d14bc95ad6fdb1915ffab143%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247485685&amp;idx=1&amp;sn=1a8d59c9d14bc95ad6fdb1915ffab143&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">人生由我</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247485714%26idx%3D1%26sn%3Df70ff6e505a2eeb74af71b277e0637b3%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247485714&amp;idx=1&amp;sn=f70ff6e505a2eeb74af71b277e0637b3&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">我的前半生</a>》以及《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247487166%26idx%3D1%26sn%3D45fcc533f4dbe9a1d3799a0d85e43d6c%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247487166&amp;idx=1&amp;sn=45fcc533f4dbe9a1d3799a0d85e43d6c&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">我曾走在崩溃的边缘</a>》。</p>
<p>这些书当中，我最喜欢的，是沈从文先生的《从文自传》，喜欢的缘由很简单，一是沈先生的文字简单真实且真诚，二是从这传记当中所感受到的安静与顽强。</p>
<p>对的，沈先生生命中的那些变化，在他的文字当中显得安静自然；顽强，则来自于安静背后的变化，那些变化（比如真正成为一个靠文字养活自己的作家），是需要很强生命力很强执行力的。</p>
<p>这些书当中，我最想要推荐的，是溥仪先生的《我的前半生》。</p>
<p>诚然，末代皇帝做过许多于中国很不好的错事，但他终于在人生后半段意识到自己错误并反省并给予后人以反省。</p>
<p>我自己读《我的前半生》过程，恰似以第一人称视角看正发生的历史。皇帝到底每天在想什么？皇帝失势后会怎样？</p>
<p>原来皇帝也慌张荒唐，皇帝也会焦虑到睡不着觉。</p>
<p>我想自己，看到了一位很真实的皇帝。</p>
<p>到全书最末尾，溥仪先生有体验到一种人生真谛，即“吃得下饭，睡得着觉”是人生最完美状态。看完全书，我是有感受到自己多出一种“任其自然”态度的：“既然连皇帝都追求吃饱穿暖睡好，为何我自己不珍惜正拥有的人生状态呢？”</p>
<p>《我的前半生》已经看了许久，好些即时体验记不太住，但当下这一刻，它是我看过人物传记当中最被推荐的那本。</p>
<h3 data-id="heading-2">3、今年看了哪些书？</h3>
<p>今年读完的书，大概（不确定的意思，是其中有两本书大概是前些年读完但没记录的）是25本，它们分作这样几个类别：</p>
<p>心理学有《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247486833%26idx%3D1%26sn%3D76a087c56b7d1a03724c3deb155bff39%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247486833&amp;idx=1&amp;sn=76a087c56b7d1a03724c3deb155bff39&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">行为主义</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247487003%26idx%3D1%26sn%3Dd0f5fdd5d3d7292d0aaeca0de2e61d10%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247487003&amp;idx=1&amp;sn=d0f5fdd5d3d7292d0aaeca0de2e61d10&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">无条件养育</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247487051%26idx%3D1%26sn%3D338d1d2c99fbfa7377c402322b98534d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247487051&amp;idx=1&amp;sn=338d1d2c99fbfa7377c402322b98534d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">十分钟冥想</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247487071%26idx%3D1%26sn%3D3d0c48bc4da1dff0a391491be629c097%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247487071&amp;idx=1&amp;sn=3d0c48bc4da1dff0a391491be629c097&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">幸福的勇气</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247487091%26idx%3D1%26sn%3Dff194b8ee00e41475b09cfe1419dcee4%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247487091&amp;idx=1&amp;sn=ff194b8ee00e41475b09cfe1419dcee4&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">甘于平凡的勇气</a>》《爱的艺术》和《亲密关系》。心理学书籍，依然帮助我更好的认识自己。</p>
<p>历史有《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247486826%26idx%3D1%26sn%3D953c7a408f4ed77e8d1703d72e86d288%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247486826&amp;idx=1&amp;sn=953c7a408f4ed77e8d1703d72e86d288&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">秦谜</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247486916%26idx%3D1%26sn%3Da182c454037a9de9fc5638381f3519b6%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247486916&amp;idx=1&amp;sn=a182c454037a9de9fc5638381f3519b6&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">五代十国全史</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247487160%26idx%3D1%26sn%3D0b46be43eab9b02943a9e471f31be86a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247487160&amp;idx=1&amp;sn=0b46be43eab9b02943a9e471f31be86a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">细说宋朝</a>》。这些书，我依然对照着《国史大纲》来看，我以为现在的自己，虽然依然记不住五代十国有哪些人、宋朝如何变化，但心中对这两个朝代是多出许多印象的，五代十国最黑暗，而宋积贫积弱。</p>
<p>传记以及记录自己或他人生活事的书有《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247486775%26idx%3D1%26sn%3D8febe91b349f10f51119777f0e4586ae%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247486775&amp;idx=1&amp;sn=8febe91b349f10f51119777f0e4586ae&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">闭经记</a>》《我曾走在崩溃的边缘》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247487405%26idx%3D1%26sn%3Db29454f463aae06415b5ae802f408f0b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247487405&amp;idx=1&amp;sn=b29454f463aae06415b5ae802f408f0b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">瓦尔登湖</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247487424%26idx%3D1%26sn%3D3133242fda8f1a1d1661734fb68f7bbc%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247487424&amp;idx=1&amp;sn=3133242fda8f1a1d1661734fb68f7bbc&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">初老的女人</a>》《沈从文评传》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247487330%26idx%3D1%26sn%3Dae49ac0abf9984c051faf259660b148a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247487330&amp;idx=1&amp;sn=ae49ac0abf9984c051faf259660b148a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">我的老师沈从文</a>》。</p>
<p>我依然喜欢看人物传记，我以为读人物传记这选择真不错，它们总给予我一种借鉴：我经历过的，前人也经历过。</p>
<p>关于沈从文先生的书，我新加入书架的还有《执拗的拓荒者》以及《沈从文全传》。</p>
<p>小说有《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247486851%26idx%3D1%26sn%3D70c46b4fa18b866456587477babcc823%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247486851&amp;idx=1&amp;sn=70c46b4fa18b866456587477babcc823&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">额尔古纳河右岸</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247486946%26idx%3D1%26sn%3Dec5abb657f9070a26059a051008ae16a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247486946&amp;idx=1&amp;sn=ec5abb657f9070a26059a051008ae16a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">活着</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247486991%26idx%3D1%26sn%3Da0b97519ba38f0f736ad840693bc8ff1%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247486991&amp;idx=1&amp;sn=a0b97519ba38f0f736ad840693bc8ff1&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">多情剑客无情剑</a>》《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247487041%26idx%3D1%26sn%3D73f32f2ff37e643ca45ec7e228aeef61%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247487041&amp;idx=1&amp;sn=73f32f2ff37e643ca45ec7e228aeef61&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">长安的荔枝</a>》。这几本小说，都短短的；《额尔古纳河右岸》和《活着》，我都哭着读完。</p>
<p>其它类别暂时只有一本，只是《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247487057%26idx%3D1%26sn%3Dc18d4c7dd1846a64696d701dc8bfcd72%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247487057&amp;idx=1&amp;sn=c18d4c7dd1846a64696d701dc8bfcd72&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">人体简史</a>》，这是一本很值得推荐的关于人体的科普书。</p>
<p>我正在阅读，或许在不久将来会读完的书，有《我看见的世界》《苏东坡新传》《李自成》《安娜·卡列尼娜》《金钱心理学》以及《高效能人士的七个习惯》。</p>
<h3 data-id="heading-3">4、电子书有哪些优点？</h3>
<p>对我来说，现在电子书已经完完全全代替了纸质书。我买纸质书，更多只为“收藏”，我想要的，只是在某个比较闲散时间，找一找翻书的感觉。</p>
<p>对我来说，电子书相较纸质书有以下优点：</p>
<p>首先，也是最重要的那一点，电子书很方便。现在我已经在《微信读书》上连续阅读三年多（之前在《京东读书》连续阅读一年多），我的碎片时间——地铁上、卫生间、等电梯——都能拿出手机看书，使用手机读书，那许多的碎片时间都慢慢攒成帮助我进步的阶梯。</p>
<p>其次，基于碎片化阅读，电子书更容易帮助养成读书习惯。不管纸质书或者Kindle，身上多带一个设备，看书的门槛总是高了许多。</p>
<p>然后，是电子书相较纸质书便宜许多。我在微读的第一年，买一年付费会员只花168元，这会员可以阅读所有在微读上架的出版书。后来，微读开通了50块钱挑战赛（花50块钱，每天阅读持续一年，累积时长达到300小时），我便只需要50块钱，便能读成千上万本我想读的书了。</p>
<p>然后，是笔记与重新翻阅的方便。微读上面读书，可以在给予自己感触内容下方划线或者写上自己的即时感悟，这些感悟被收集在一起，可以搜索，可以直接定位。当书中内容记不太清需要回顾时，直接搜索笔记，直接搜索全书即可。</p>
<p>总之，电子书于我，是方便许多的。</p>
<h3 data-id="heading-4">5、一篇日记</h3>
<p>现在时间是晚上的9点05分，我已经在回家地铁上前进两站。三站过后我要转车，我打算再去拼一拼下一趟列车的及时——在它关门之前——上车，我于是站在距离转站路线最近那个口子，只待列车到站。</p>
<p>我的右手边，大概是两个小学生（或者是初中生）正坐地上，他们的对话内容，我有听到两三句：</p>
<p>“那个别人刚走了的座位还是热乎的，如果坐了就会长痔疮。”</p>
<p>“我下一站就到红旗河沟了。反正没作业……反正没作业。”</p>
<p>对于今天的准时上车，我是很有些骄傲的。我似乎已经好久好久，没有9点准时下班。</p>
<p>（我跑过换乘路线，下一趟列车还有一分钟，今天的换乘计划成功了。）</p>
<p>今天的工作，又是和提示词作斗争的一天。</p>
<p>今天的新闻，大概只有一条：我的同事说，他的一位朋友从外地回重庆，Offer年包已经过了60。啊哈？所以重庆还是开得起工资的？</p>
<p>嗐！又有人在地铁上开很大声的外放，他应该正在玩某一种打枪游戏。</p>
<p>说起地铁外放，我想重庆和北京（上周去了北京出差）是真有一些差距的，我在北京一周坐地铁次数不多（大概五六七次），从没听到过手机外放，而重庆？每一趟地铁，我都得和外放侠做一点小小斗争：那些不能专心的时间，我总告诉自己“没关系的，不听不听”。</p>
<p>最近两天的晚饭，都是地铁口的一碗洋芋，7块钱。吃洋芋很快，于是我可以在晚饭时间向家里打几个电话。身体健康，就该是最高优的事情。</p>
<p>还有其它的应该记录的内容么？好像没有的。</p>
<p>不对，还有一条。</p>
<p>最近的读书时间，全部给了小说，一本是《安娜·卡列尼娜》，一本是《李自成》。这两本小说，都好长好长。</p>
<h3 data-id="heading-5">6、读书会忘记应该怎么办呢？</h3>
<p>基于我现在的读书认知（过去五年日均阅读一小时多一点，读书类型多种多样，累积读完大概120本书）来看，我以为记住书中内容这件事，仿佛是可以不需要刻意追求的。</p>
<p>那些我们想要记住的，总能够印象不熄。</p>
<p>以《学习之道》里面的“Zone概念”为例，投篮不管怎么投都有，台球不管怎么打都进，全没有技巧，只凭借着一种感觉，这种感觉是可以有方法做到频繁进入的。</p>
<p>如何进入，带着热爱，练习不止即可。</p>
<p>还有些内容，是读过便忘记的，但这忘记的内容，可以通过一种简单的方法被记住。这简单的方法是不停地读，读相关联的书，看相关联的内容。</p>
<p>这内容当中的一个示例，是算法“快慢指针”，最初我并不知道如何探测链表是否循环，第一次刷题后也很快忘记。直到在《剑指Offer》《我的第一本算法书》《程序员面试金典》中多次强化，它被刻在脑子里。</p>
<p>我想自己，读过书当中可能超过99％，是都被我忘记的。这些被忘记的内容，如何能够被更好的记住，我知道的方法来自于《津巴多普通心理学》名叫“精细复述”，即将自己学到的知识，用自己的话认真地重新组织一遍，这件事做完，便能将知识记得更久些。</p>
<p>这样记住的内容，有“将愤怒或者悲伤写成文字，能够缓解自己的情绪”“记忆能力可以不随年龄变化，只需要一些组装技巧”……</p>
<p>最后，现在的我真的以为“读书想要记住”这件事是可以不强求的，只要不停看，外加一些思考，就好的。</p>
<h3 data-id="heading-6">7、推荐几本能够快速读完的小书吧？</h3>
<p>看到这个问题，我脑子里冒出来两三本小书，它们都是我读完认为不错不厚甚至很薄的三本小书：《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247486071%26idx%3D1%26sn%3D4aacbe10662555f68f3fedc27f0a11b8%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247486071&amp;idx=1&amp;sn=4aacbe10662555f68f3fedc27f0a11b8&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">宝贵的人生建议</a>》《受戒》以及《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5ODczOTMzMA%3D%3D%26mid%3D2247486182%26idx%3D1%26sn%3De46c9ca86a99e80fedd8da36006c9e27%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5ODczOTMzMA==&amp;mid=2247486182&amp;idx=1&amp;sn=e46c9ca86a99e80fedd8da36006c9e27&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">活出生命的意义</a>》。</p>
<p>《宝贵的人生建议》，是一位老者（作者名字以及生平我并不能记住，记住的只是作者是一位六十多岁的老人）写给他子女以及孙辈的人生建议。每一条建议，都不长。</p>
<p>我记住的建议有好些，比如老生常谈的“种一棵树的最好时机是十年前，其次是现在”，比如“写不出文章时，假装以讲故事形式说给朋友听，当写完后删去朋友名字，便是一篇不错草稿”。（此处只是自己的复述，并非书中原文。）</p>
<p>我以为《宝贵的人生建议》是一本好书的缘由在于作者在末尾所说“书中建议恰似帽子，可能并不适用每一个人，选择自己喜欢的那顶就好”，即作者并不强迫读者接受他的认知。</p>
<p>不强迫，便是长者风范。</p>
<p>《受戒》是汪曾祺先生的短篇小说，我大概看完过不下五遍，全书很短，或许不到一小时便能读完。每一遍阅读，我都感受到一种简单的美好：明子和英子的爱情，唯美、自然，充满活力。</p>
<p>《活出生命的意义》，是一本短短传记，我从书中收获的认知有两个：</p>
<ol>
<li>拥有希望是一个人活下去的最基本条件；</li>
<li>不管怎样的绝望场景，我们都拥有最后的自由，选择以何种态度面对这绝望的自由。</li>
</ol>
<p>以上三本书，如果快一点，或许一两天内可以全部读完。但回味无穷。</p>
<h3 data-id="heading-7">8、怎样做到坚持阅读？</h3>
<p>大概靠一点惯性，一点贪念，以及对书中内容的许多期待。</p>
<p>惯性，来源于过去五年的作息，以及用手机的习惯。</p>
<p>过去五年以来，我有两年半上班通勤是坐地铁的。地铁上的时间，都被我用来看书，这时间的看书，毫无心理负担。</p>
<p>上班路上：“我正要去公司干活呢，现在通勤路上肯定不会有人找。”</p>
<p>下班路上：“今天的事情已经都有了交代，看点轻松的书打发下时间吧。”</p>
<p>于是看书，专注且有趣。</p>
<p>当看书次数变多，很自然便会打开手机上的《微信读书》，于是再看两分钟。</p>
<p>贪念，也可以说成是对认知的渴求。五年以前，我想着靠自己的生活日记换取流量，只写两周便发现没了东西可写，于是找书来看。</p>
<p>我的看书，是为写作言之有物，是为更新（我给自己定下目标，不管是怎样内容，每周必须完成一篇更新）有内容可写，是为内容能够被人阅读换成收入。</p>
<p>于是看书，与写作相辅相成，世俗又带目的。</p>
<p>期待，是对书中内容最纯粹的期待，我仅仅想知道，书中那人物、事物、理论的未来是怎样的。</p>
<p>《崇祯传》里的崇祯怎么就亡国了？《安娜·卡列尼娜》里的安娜和弗隆斯基有未来么？《我曾走在崩溃的边缘》中俞敏洪老师是怎样不崩溃的？《也许你该找个人聊聊》当中心理咨询师每天都做些什么？</p>
<p>总之，那些无尽的期盼与好奇牵着我，看书不停。</p>
<h3 data-id="heading-8">9、糖醋排骨怎么做呢？</h3>
<p>最近刚刚试过再做一次糖醋排骨，不脆，但依然有点好吃。制作步骤如下，每一步骤后面括号中是我当下存在的疑惑：</p>
<p>选排骨。（这一步很重要，上一次做时排骨都骨头中间肉包周边，成品好看许多。这一次买的打六折的排骨，成品则很不规则。）</p>
<p>排骨洗净焯水再用热水洗一洗。（这个步骤我从网上学来的，其实没掌握原理，也不确定不焯水味道是否不一样？焯水出锅后用冷水洗是否真的会柴？甚至焯水之后有必要洗么？）</p>
<p>锅中放油，小火放糖，把糖炒出糖色。（这个步骤我想自己油放多了些而糖放少了点，于是糖色不黑，排骨不甜。当然，没有饭店里面的甜，却似乎更符合自己的口味。）</p>
<p>下排骨，不停地翻翻翻翻，直到排骨有些焦黄。</p>
<p>下入没过排骨再深一指的热水，加入调味的盐、醋、酱油，焖。（什么时候放盐依然是一个问题，我看到一条高赞视频说提前放盐排骨会柴，但真正制作时，会忘记这注意事项。又由于没有天天做，于是不能验证。）</p>
<p>水快干，再翻翻翻，收汁。尝一下，不够甜再加一点糖。出锅，撒一点葱粒、红椒粒，增香增色。</p>
<p>最终成品，不嫩，有一点柴，有嚼劲，颜色不深，但依然好吃的。</p>
<p>下次做时的优化：少一点油多一点糖。</p>
<h3 data-id="heading-9">10、最近正阅读的书有哪些？</h3>
<p>我最近正阅读的书，是这几本：</p>
<p>《李自成》和《崇祯传》，《安娜·卡列尼娜》，《高效能人士的七个习惯》，以及《亲密关系》。</p>
<p>目前《李自成》刚刚看到四分之一，我对于书中作者对崇祯的评价——刚愎自用、犹疑猜忌——不太相信，于是先读《崇祯传》。</p>
<p>《崇祯传》也正读到四分之一处，崇祯灭了魏忠贤，已经杀掉袁崇焕，现在不信任大臣，正启用宦官到各处监督。</p>
<p>现在崇祯给予我的印象，是勤劳皇帝做了一个错误决定（杀袁崇焕），以及身边帮手很不够。</p>
<p>《安娜·卡列尼娜》正听到六分之五处，基迪和列文正在莫斯科等待他们的第一个小孩出生；安娜和弗隆斯基在乡下生活，弗隆斯基感受到安娜限制着他，安娜刚刚给丈夫卡列宁写信申请离婚。</p>
<p>到现在，我以为安娜和弗隆斯基之间，似乎也并非是真正的爱情，在最初的激情、温情过后，当真正回到生活当中，他们的关系也是并不稳定的。或许安娜并不是出轨状态，此种情况会好一些？</p>
<p>《高效能人士的七个习惯》已经看到最后一个习惯——不断更新——了。虽然我对作者在书中的那些佐证并不很信服，但随着阅读时长增加，我以为这七个习惯是真有效的，它们是智慧，来自于生活、历史中积攒的经验。</p>
<p>《亲密关系》，我之前已经听完一遍有声书，现在刚刚读到第二章。我想要的，是在未来将这本书中内容理解的更多些。</p>
<p>对的，《亲密关系》看两遍的原因是，它是我超级推荐的一本书，我想自己理解更多些后再给出有理有据的推荐理由。</p>
<p>对的，书读第二遍，速度慢许多许多。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我的首款 Spec AI 编辑器：Kiro 实战测评与 Trae 对比分析]]></title>    <link>https://juejin.cn/post/7587265840065150982</link>    <guid>https://juejin.cn/post/7587265840065150982</guid>    <pubDate>2025-12-24T10:06:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587265840065150982" data-draft-id="7587231644802596883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我的首款 Spec AI 编辑器：Kiro 实战测评与 Trae 对比分析"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-12-24T10:06:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三只萌新"/> <meta itemprop="url" content="https://juejin.cn/user/360295544400973"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我的首款 Spec AI 编辑器：Kiro 实战测评与 Trae 对比分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295544400973/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三只萌新
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T10:06:19.000Z" title="Wed Dec 24 2025 10:06:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">偶然遇到Kiro</h2>
<p>笔者始终关注各类工具在工程化场景中的实际表现。近期在社区偶然接触到 AWS 推出的 AI IDE Kiro，其核心卖点之一的 Spec 模式引发关注 —— 此前在 Trae 平台使用同类功能时，曾遭遇规范适配不足、流程冗余等问题，严格来说Trae 并未集成 spec 功能，可使用 Spec kit 来曲线救国，对两款工具的 Spec 模式进行系统性实测，旨在为团队选型提供客观参考。</p>
<h2 data-id="heading-1">使用 Spec 模式</h2>
<p>基本界面</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71531c33dc28412180a079548866cae9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=bOq2iFAeq%2BMpAsjk%2FKsbJLN6ptc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">需求描述</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6faf281b8f7d4066a7a42de0d31e52ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=i7UNIUWOL27n890XDXShkhcrYUY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">设计</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c97169d794474a5883ca4e45602a2c9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=%2Bu92vzVdgouMdBHJgRO6lskqE9g%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">任务拆解</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a85f47f46794065afe1b028c023c7f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=fXmmjEtVk91x%2FIPhOK8lXW3QkAg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">执行任务</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f4e7d06503f485fb793fee6c49be79d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=dwoXpHH0cnqCnOV0nOSmyXHsqCc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d381f82f8f542319060dc8f3e071571~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=BvY7S1vRJnrIVdb7TxafFxqjK3U%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">最终产物</h3>
<p>包含文档记录和代码以及静态资源文件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b05a4598e0e34920b97f7d232c75c3c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=QTtSj9ActWFWGMUNaOk4s5HpBA4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">Kiro 和 Trae CN 效果对比</h2>
<h3 data-id="heading-8">Kiro 完成效果</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74056e28ec894d2b874b5c198392952a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=h9fUtSJalUfjpmc3N48dZC3wJgQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">Trae CN 使用 spec kit 完成效果。</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebaccccd01644e4598e4e5db0ba1d089~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=HRRYKqlYnt97uh0umw1dmp5ae6Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">代码对比</h2>
<h3 data-id="heading-11">kiro 完成的代码</h3>
<p>kiro 在本次开发任务中，核心遵循<strong>复用现有资源</strong>的原则开展代码编写工作，具体实施细节如下：</p>
<ol>
<li><strong>组件层面</strong>：优先选用项目中已封装完成的通用组件（如基础布局组件、表单组件、列表展示组件等），未重新开发新的组件模块。此举既保证了组件风格与项目整体的一致性，也减少了重复开发的工作量，提升了代码的可维护性。</li>
<li><strong>工具函数层面</strong>：充分调用项目中已沉淀的工具函数库（如数据格式化函数、请求封装函数、校验函数等），避免了同类功能的重复编码，同时依托经过验证的工具函数，提升了代码的稳定性与执行效率。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8014cf267a6b454b867df3c5b192cde9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=zHJKpMT8XJ%2BM%2BjEl5%2FkBxV63xoM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62a1019dca4047ed99e11a527b4438d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=u0Si3QXEehwAGyKYTsP%2Frsc22s4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">Trae 完成的代码</h3>
<p>trae 在本次开发任务中，采用<strong>直接集成 Element UI 组件库</strong>的方式进行代码实现，具体特点如下：</p>
<ol>
<li><strong>组件库选用</strong>：直接引入 Element UI 官方组件库中的各类组件</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f6ad2479c1c41ccbbab40080a278949~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=9oOK%2BV%2BwOtWtOdgAjfbC4SuQX44%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1d3c52e4d0f46df96a3f5f0acb98504~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=26lhTMuMrEQKNmGzzY7AijGtb%2Bs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">产物对比</h2>
<p>kiro</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2867214d9501451c8c3ab3a484fd4063~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=tiwqrb%2BHWEWhdkgt%2FU0xyyrvgRI%3D" alt="" loading="lazy"/></p>
<p>trae</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87def4451c3d4ac49b51d40c2b8308f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5Y-q6JCM5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175742&amp;x-signature=%2FwuISTlwVd7KjBeJKqgJiA7fO%2FM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">结尾</h2>
<p>从实测体验来看，Spec 模式绝非 AI 编程工具的附加功能，而是未来工程化开发的核心范式 —— 它正在重构 “需求 - 设计 - 开发 - 维护” 的全链路逻辑，让 “文档即规范、规范即代码” 成为现实。随着 AI 对结构化指令的理解能力持续提升，精准、完整的文档描述将逐渐取代重复的代码编写工作，成为开发流程中的核心产出物，其价值甚至会超越代码本身。</p>
<p>Kiro 与 Trae 均提供免费试用通道，这为开发者降低了探索新范式的门槛 —— 无需付费即可在真实项目中验证工具的适配性，亲身感受不同 Spec 模式的设计逻辑与落地能力。让我们得以零成本对比工具差异，根据自身项目场景（如团队规模、规范要求、技术栈类型）选择最适合的 AI 编辑器。</p>
<h2 data-id="heading-15">相关链接</h2>
<p><a href="https://juejin.cn/post/7564227311511076904" target="_blank" title="https://juejin.cn/post/7564227311511076904">TRAE × Spec Kit 实战：五步构建流式 AI 对话 Web 应用</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fkiro.dev%2F" target="_blank" title="https://kiro.dev/" ref="nofollow noopener noreferrer">kiro 下载地址</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 HBuilder 上架 iOS 应用时常见的问题与应对方式]]></title>    <link>https://juejin.cn/post/7587021119255658523</link>    <guid>https://juejin.cn/post/7587021119255658523</guid>    <pubDate>2025-12-24T10:02:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587021119255658523" data-draft-id="7587245616753885235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 HBuilder 上架 iOS 应用时常见的问题与应对方式"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-24T10:02:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心就好2025"/> <meta itemprop="url" content="https://juejin.cn/user/3850962908492660"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 HBuilder 上架 iOS 应用时常见的问题与应对方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3850962908492660/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心就好2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T10:02:17.000Z" title="Wed Dec 24 2025 10:02:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在很多 uni-app 或 HBuilder 项目中，“上架 iOS”常被理解为一个顺延动作：
页面写完 → 云打包 → 提交 App Store。</p>
<p>但实际参与过完整流程之后会发现，HBuilder 解决的是开发和打包入口的问题，而 真正影响上架是否顺利的，仍然是 iOS 原生发布体系那一段。</p>
<p>很多卡点，并不是 HBuilder 没有能力，而是跨端工具与原生发布流程之间，存在一些默认被忽略的细节。</p>
<hr/>
<h2 data-id="heading-0"><strong>HBuilder 产出的 IPA，并不等同于已准备好上架</strong></h2>
<p>在工程实践中，我见过不少情况：
HBuilder 云打包成功、IPA 生成正常，但在上传或审核阶段反复失败。</p>
<p>原因往往集中在几个地方：</p>
<ul>
<li>Bundle ID 与开发者账号中已有应用不一致</li>
<li>使用了不符合发布要求的证书或描述文件</li>
<li>构建产物携带了测试阶段配置</li>
</ul>
<p>这些问题在 HBuilder 打包阶段不一定会被提示，但在 App Store 流程中一定会被放大。</p>
<hr/>
<h2 data-id="heading-1"><strong>在上架之前，先把应用身份看清楚</strong></h2>
<p>HBuilder 项目中，Bundle ID 通常在早期配置后就很少再动。
但在准备上架时，我更倾向于重新确认这件事：</p>
<ul>
<li>这个 Bundle ID 是否已经在账号中存在</li>
<li>是否曾被其他项目使用</li>
<li>是否与当前 IPA 内的信息一致</li>
</ul>
<p>在没有 macOS 环境的情况下，可以通过 <strong>开心上架（Appuploader）查看 Apple 开发者账号中的 Bundle ID 列表</strong>，快速了解当前账号的真实状态。这一步并不会影响 HBuilder 的打包方式，但能避免在错误的应用标识上继续投入时间。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47718c6fca154cc99df647e57c3e4254~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D5bCx5aW9MjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175337&amp;x-signature=wIm3tc1yx2VAUk6Z5jLBD%2FnPv0c%3D" alt="查看bid" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2"><strong>证书问题，在 HBuilder 项目里同样不会自动正确</strong></h2>
<p>不少开发者在使用 HBuilder 时，对证书的感知会变弱，因为很多操作被云服务包裹起来了。
但证书依然是 iOS 上架的硬前提。</p>
<p>我遇到过的情况包括：</p>
<ul>
<li>构建阶段使用的是开发证书</li>
<li>发布证书只存在于某一台 Mac</li>
<li>无法确认当前 IPA 使用的是哪一份证书</li>
</ul>
<p>在一些跨平台或多人协作的项目中，我们会通过 开心上架（Appuploader）创建 iOS 证书，生成可复用的 <code>.p12</code> 文件，用于构建和发布流程。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34bd1bca928e486d91a6f276fcbc2e2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D5bCx5aW9MjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175337&amp;x-signature=LLce8SIRHH%2BvxT98%2FmZkUWxHsqg%3D" alt="创建证书" loading="lazy"/></p>
<p>这种方式并不是否定 HBuilder 的云打包能力，而是让证书从“工具内部状态”变成“工程可管理资源”。</p>
<hr/>
<h2 data-id="heading-3"><strong>描述文件，是 HBuilder 上架中最容易被忽略的一环</strong></h2>
<p>描述文件在 HBuilder 项目中通常是自动生成或自动匹配的，很少有人会主动查看它的内容。
但在排查问题时，它经常是关键线索。</p>
<p>例如：</p>
<ul>
<li>描述文件类型为 Development，却用于上架</li>
<li>描述文件绑定的 Bundle ID 与应用不一致</li>
<li>新增设备后未更新描述文件</li>
</ul>
<p>在上架前，我更倾向于直接查看描述文件本身。
通过 开心上架（Appuploader）查看 mobileprovision 文件内容，可以明确看到描述文件类型、绑定关系以及使用的证书是否符合当前阶段需求。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15ce4500bf174228950a2f215635fecc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D5bCx5aW9MjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175337&amp;x-signature=2EfExQWUnZOM6MPjzeIJ97TcKPw%3D" alt="查看描述文件" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-4"><strong>IPA 本身，值得在上传前被独立检查</strong></h2>
<p>在一些团队里，HBuilder 生成的 IPA 只是被当作一个“等上传的文件”。
但从工程经验来看，IPA 本身就是一个需要验证的结果。</p>
<p>我遇到过的问题包括：</p>
<ul>
<li>IPA 内的 Bundle ID 与 App Store Connect 中不一致</li>
<li>Info.plist 中残留测试配置</li>
<li>图标或资源缺失</li>
</ul>
<p>在非 macOS 环境下，可以通过 开心上架（Appuploader）查看 IPA 内容，在上传前确认这些关键信息。这一步并不会改变 IPA，但能减少审核阶段的不确定性。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66eeefefb59740f0be38ee75cbf31987~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D5bCx5aW9MjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175337&amp;x-signature=pbiFYEP2piRd6X%2FSc5sNiV4XWyo%3D" alt="查看ipa" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-5"><strong>上传方式，往往决定 HBuilder 项目的协作效率</strong></h2>
<p>在单人项目中，通过 Xcode 或官方推荐方式上传 IPA 并不复杂。
但在多人或跨平台团队中，上传步骤很容易成为瓶颈。</p>
<p>当构建发生在云端，而上传只能依赖某一台 Mac 时，发布节奏就会被人为限制。</p>
<p>在一些项目中，我们会使用 开心上架（Appuploader）的上传方式，在 Windows 或 Linux 环境中完成 IPA 提交，使 HBuilder 的构建结果可以被不同系统的成员接手处理。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1991266f62cb4a9e935581dfc785f52b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-D5bCx5aW9MjAyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175337&amp;x-signature=eG1xH35A8HZfCOYr2bYdgxZg9oU%3D" alt="ipa上传" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6"><strong>用 HBuilder 上架 iOS，本质仍然是一次原生发布</strong></h2>
<p>经历过多次流程之后，我逐渐形成一个共识：
HBuilder 并没有绕过 iOS 上架，它只是改变了开发和打包的入口。</p>
<p>真正决定上架是否顺利的，依然是这些原生对象是否清晰：</p>
<ul>
<li>应用标识</li>
<li>证书与描述文件</li>
<li>构建产物</li>
<li>上传路径</li>
</ul>
<p>结合HBuilder、云打包、开心上架（Appuploader）多工具组合完成上架，可以帮助开发者更顺利地完成 HBuilder 项目的上架流程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[9 个 超绝的 AI 控制电脑 GitHub 开源项目。]]></title>    <link>https://juejin.cn/post/7586680977854906431</link>    <guid>https://juejin.cn/post/7586680977854906431</guid>    <pubDate>2025-12-23T06:10:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586680977854906431" data-draft-id="7586585688004755497" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="9 个 超绝的 AI 控制电脑 GitHub 开源项目。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-23T06:10:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            9 个 超绝的 AI 控制电脑 GitHub 开源项目。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:10:55.000Z" title="Tue Dec 23 2025 06:10:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">01、通过终端控制电脑</h2>
<p>把这个开源项目装进电脑，你的终端就成了贾维斯。这个 61K Star 的开源项目通过终端来控制电脑。</p>
<p>Open Interpreter 是一个让 AI 大模型在本地运行代码的解释器，支持运行 Python, JavaScript, Shell 啥的，直接运行在你的终端里。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0598db8a504f47e6b04af7cb3e05df30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=Jl%2FNHmCfCdP8CkloLMSIOazZq00%3D" alt="图片" loading="lazy"/></p>
<p>通过和它对话，它可以访问互联网，不仅仅是 Bing 搜索，而是完全自由的联网。 </p>
<p>操作你的本地文件，比如批量重命名、转换格式、处理 Excel。 还能控制你的电脑，比如打开浏览器、发邮件、甚至调整系统设置。</p>
<p>还支持接入本地的模型，比如 Ollama、Jan。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19a2e39d959948dd9b8e4d7bd3c12920~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=CzsQqLgu3mg11nGc48gnY%2F97Pk0%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>比如输入：把我的系统设为深色模式，然后打开浏览器去查一下明天的天气。</p>
<p>它会执行 Shell 命令来修改系统设置，并调用浏览器自动化工具 Selenium 或 Playwright 去查询信息。</p>
<p>你还可以把一个 500MB 的 Excel 表格扔给它：分析这个表格，画出过去一年销售额的趋势图，并保存为 report.png。</p>
<p>不用上传云端，数据隐私绝对安全。</p>
<pre><code class="hljs language-ruby" lang="ruby">开源地址<span class="hljs-symbol">:https</span><span class="hljs-symbol">://github</span>.com/openinterpreter/open-interpreter
</code></pre>
<h2 data-id="heading-1">02、微软开源：OmniParser</h2>
<p>OmniParser 是微软开源的一个专门用来看屏幕的神器。</p>
<p>今年最新的 V2 版本，霸榜了 Hugging Face 好久，真的把 GUI Agent 的能力拉升了一个台阶。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66c1ed28ef4341fc8054e14f313e2cd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=dmtzjwH8J%2BZce0IGUEwWD3bk6iw%3D" alt="图片" loading="lazy"/></p>
<p>这是一个屏幕解析工具，可以把屏幕截图转化为结构化的数据，这是构建 AI 控制电脑 Agent 的核心组件。许多基于视觉的自动化项目都依赖这类技术来精准定位屏幕元素。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/286789e14d604f2ba13c64d2ccd006f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=%2Bvg3%2BP%2BBce9lOQcvpIUFp7rSlTg%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c7e75c713494afc8581efa23512a27f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=qGhMnTdE5bozi4GA1ZWnKSD2GBY%3D" alt="图片" loading="lazy"/></p>
<p>它的工作流程是这样的：Detect：通过训练好的 YOLO 模型，精准框选出屏幕上所有的<strong>可交互区域，比如</strong>按钮、输入框、图标、侧边栏啥的。即便图标非常微小，V2 版本也能精准捕捉。</p>
<p><strong>Caption</strong>：利用微软自家的 Florence-2 或 BLIP-2 模型，给每一个框选出来的元素加上<strong>功能描述，</strong> 比如“这是一个搜索图标”、“这是一个设置按钮”。</p>
<p><strong>Grounding</strong>：将这些坐标和描述打包喂给 GPT-4V 或 DeepSeek，让大模型知道某按钮的坐标在 (800, 600)你可以把这个开源项目理解成连接大模型大脑和电脑屏幕之间的那副高精度眼镜。</p>
<pre><code class="hljs language-ruby" lang="ruby">开源地址<span class="hljs-symbol">:https</span><span class="hljs-symbol">://github</span>.com/microsoft/<span class="hljs-title class_">OmniParser</span>
</code></pre>
<h2 data-id="heading-2">03、自操作计算机框架</h2>
<p>这个开源框架，也是让多模态 AI 模型像人类一样操作计算机。现在已经斩获了 1 万的 Star。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea56d10d367f48be84799ca398bbcde7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=fujjDyHTKrr8KPloXm8Q4YxqQ%2FQ%3D" alt="图片" loading="lazy"/></p>
<p>模型通过截图的方式视觉识别屏幕内容，直接调用系统的鼠标和键盘接口，使用 pyautogui 库进行交互，而非依赖后台 API。</p>
<p>而且这个开源项目兼容 macOS、Windows 和 Linux。</p>
<p>为了解决大模型看不准或点不准屏幕元素的问题，它引入了几种关键模式：</p>
<p>OCR 模式：生成屏幕上可点击元素的坐标哈希图。当模型决定点击某段文字时，系统能精确映射到具体坐标，显著提高了点击准确率。</p>
<p>Set-of-Mark (SoM) 提示：在屏幕截图上的UI元素打上数字标记 Label，让模型只需输出数字即可定位元素，类似于特斯拉自动驾驶的视觉标注逻辑。</p>
<p>Voice Mode：支持语音输入指令，增加交互的便捷性。</p>
<pre><code class="hljs language-bash" lang="bash">开源地址: https://github.com/OthersideAI/self-operating-computer
</code></pre>
<h2 data-id="heading-3">04、前沿的 GUI 智能体：Agent S</h2>
<p>这个 Agent S 是目前比较前沿的开源 GUI 智能体框架。S3 是首个在 OSWorld 上超越人类水平的模型，取得了得分 72.60%。</p>
<p>目前已经在 GitHub 上获得 9k 的 Star。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5bfc3a41bbe4543ade547e2b236b290~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=qA5yYFe0a0WJEGjXy8oTNnVJJ%2B8%3D" alt="图片" loading="lazy"/></p>
<p>与普通脚本不一样，Agent-S 引入了类似人类的认知架构：</p>
<p>经验增强的层次化规划：它不是盲目地一步步操作，而是先搜索外部知识（如在线教程）和检索内部记忆，将大任务拆解为子任务。</p>
<p>Agent-计算机接口：它不直接看原始像素，而是通过一个中间层更精确地感知 GUI 元素，增强了模型对屏幕的理解能力。</p>
<p>双重记忆机制：叙事记忆，存储高层次的任务经验；情景记忆，存储具体的步骤操作。它用得越多，越擅长处理复杂任务。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址: https:<span class="hljs-comment">//github.com/simular-ai/Agent-S</span>
</code></pre>
<h2 data-id="heading-4">05、微软开源：UFO</h2>
<p>之前提到过，这个叫 UFO 的框架也是微软开源的。</p>
<p>这个开源项目是专为 Windows 生态深度定制的原生级智能体系统。它利用微软对自家系统的理解，实现了比普通视觉方案更深层的控制。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/362ee22af5394cd9a202f37a275943a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=R9ioc6CjNJ52XOu2wOguARt%2Fx6s%3D" alt="图片" loading="lazy"/></p>
<p>不同于视觉方案的框架仅依赖截图+鼠标模拟，UFO 结合了视觉与底层系统接口 Windows UI Automation, Win32, COM API。</p>
<p>它不仅看屏幕，还能直接读控件树。它能准确知道一个按钮的名字、状态和隐藏属性，点击准确率极高。</p>
<p>而且，它专门针对 Windows 常用软件 Office 全家桶、文件资源管理器 啥的进行了优化，能理解应用程序内部的逻辑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d1a6f6d3ade45f2b1263f40afba5bc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=tJGbAm6HFUzT%2BsuLYSY%2BHwG67do%3D" alt="图片" loading="lazy"/></p>
<p>它采用双代理架构（AppAgent 和 OSWorld Agent），深入理解 Windows 应用程序的 UI 结构，跨多个应用程序执行复杂请求，比如从 PPT 中提取内容并发邮件。</p>
<p>专为 Windows 优化，能够利用 Windows 原生 API 进行更稳定的控制。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址: https:<span class="hljs-comment">//github.com/microsoft/UFO</span>
</code></pre>
<h2 data-id="heading-5">06、AI 玩荒野大镖客</h2>
<p><strong>Cradle</strong> 是由<strong>智源研究院 (BAAI)</strong>  团队开发的一个开源项目。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c793ebeedb0b4965b0b651203d310776~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=hUwda5jd9H4Aw8urrFque%2FH%2FxGs%3D" alt="图片" loading="lazy"/></p>
<p>让 AI 智能体能够像人类一样，仅通过屏幕截图和<strong>标准输入/输出接口</strong>来操作任何软件和游戏，而不需要依赖后端的 API 或内部代码访问。</p>
<p>可以玩荒野大镖客、城市天际线，也会用飞书、Chrome、剪映软件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f96996c2247a47c484d11e65b5d4d714~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=KB%2BpHkTUhrK0Lckgi8lkTee5mT8%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>它提供了一个标准化的框架，将控制过程分为几个关键模块：</p>
<p>感知：提取屏幕中的关键信息，识别 UI 界面、图标、文本或游戏中的 3D 场景。</p>
<p>决策与规划： 根据当前任务目标和屏幕状态，规划下一步行动。自我反思，如果操作失败，它会分析原因并修正策略。</p>
<p>记忆系统：短期记忆，记录最近的操作序列和截图；长期记忆， 存储成功经验和工具使用手册（RAG），以便在类似场景下快速调用。</p>
<p>执行： 将规划转换为具体的键盘和鼠标指令。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址: https:<span class="hljs-comment">//github.com/BAAI-Agents/Cradle</span>
</code></pre>
<h2 data-id="heading-6">07、OS-Copilot</h2>
<p>一个构建通用操作系统代理的框架。强调 Agent 的自我学习和自我改进能力，能够处理从未见过的应用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7932a5f34a7459f826a4543b682645e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=pMxrNZtdjiKZbEmm97s2QSZvOtY%3D" alt="图片" loading="lazy"/></p>
<p>其核心 Agent FRIDAY 能够通过自我改进机制来学习如何操作 Excel、PPT 以及浏览网页。</p>
<p>这个开源项目的目标是创建一个无缝集成到操作系统中的个人助理。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址: https:<span class="hljs-comment">//github.com/OS-Copilot/OS-Copilot</span>
</code></pre>
<h2 data-id="heading-7">08、ShowUI</h2>
<p>这是一个轻量级的端到端视觉-语言-动作（Vision-Language-Action）模型，专为 GUI 智能体设计。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8dc1d392254d43c2b228681274fd2c05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=QWQy8DctkdLD9%2BkRJZPT9jVi9ZE%3D" alt="图片" loading="lazy"/></p>
<p>它想解决大模型在处理 UI 界面时的高延迟和计算成本问题，提供更快速、更精准的屏幕元素定位和操作。</p>
<p>模型小巧高效，适合在本地部署进行低延迟的 UI 自动化控制。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址: https:<span class="hljs-comment">//github.com/showlab/ShowUI</span>
</code></pre>
<h2 data-id="heading-8">09、UI-TARS Desktop</h2>
<p>之前介绍过，字节跳动开源的基于 UI-TARS 视觉语言模型的 GUI 智能体桌面应用。</p>
<p>它允许用户通过自然语言直接控制 Windows 或 macOS 电脑。</p>
<p>该项目结合了端到端的视觉模型，无需复杂的中间代码解析，直接像人类一样看屏幕并操作鼠标键盘。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ff7a35c69f54c90afcf46ac32377df0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075055&amp;x-signature=ItG2XzVU08B5u93hNC0kFvK02QY%3D" alt="图片" loading="lazy"/></p>
<p>特点是开箱即用，支持远程计算机控制，是目前较新的高性能 GUI Agent 实现。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址: https:<span class="hljs-comment">//github.com/bytedance/UI-TARS-desktop</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AOP 的真相：注解只是声明，代理才是执行]]></title>    <link>https://juejin.cn/post/7586585688005115945</link>    <guid>https://juejin.cn/post/7586585688005115945</guid>    <pubDate>2025-12-23T03:41:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586585688005115945" data-draft-id="7586585498744684598" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AOP 的真相：注解只是声明，代理才是执行"/> <meta itemprop="keywords" content="面试,架构,Spring"/> <meta itemprop="datePublished" content="2025-12-23T03:41:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AOP 的真相：注解只是声明，代理才是执行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:41:28.000Z" title="Tue Dec 23 2025 03:41:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>很多人用Spring AOP时，以为只要在方法上加个<code>@Transactional</code>、<code>@Retry</code>，就能自动有事务、重试功能。但当代码出问题时，往往一脸懵逼：为什么注解没生效？为什么代理失败了？</p>
<p>这次我用不到1000行代码，手写了一个Mini-AOP框架，纯JDK实现，0依赖。目的很简单：<strong>看清楚AOP到底是怎么运作的</strong>。</p>
<h2 data-id="heading-1">核心认知：AOP不是你想的那样</h2>
<h3 data-id="heading-2">常见误解</h3>
<p>很多人以为AOP是这样的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspect</span> {
    <span class="hljs-meta">@Before("UserService.*")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(JoinPoint jp)</span> {
        System.out.println(<span class="hljs-string">"打日志"</span>);
    }
}

<span class="hljs-comment">// 然后写业务代码</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-comment">// 自动就有日志了？</span>
    }
}
</code></pre>
<p>以为加了注解就自动在方法前后插入代码了。<strong>这是错的！</strong></p>
<h3 data-id="heading-3">真实情况</h3>
<p>AOP的本质是<strong>三层结构</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3952679a3a564030a456894b89ca990a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LiP5rWq5peg55eV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066313&amp;x-signature=GuWiuKyLUtXpVgM%2F9v7BnwgT3uQ%3D" alt="115.jpg" loading="lazy"/></p>
<ol>
<li><strong>声明层</strong>：你写的<code>@Before</code>、<code>@Around</code>等注解，只是配置，不执行任何逻辑</li>
<li><strong>触发层</strong>：代理对象在方法调用时，通过表达式匹配决定哪些切面要执行</li>
<li><strong>业务层</strong>：被AOP包裹的真实业务代码</li>
</ol>
<p>用大白话说：<strong>注解不会自动生效，必须有一个代理层来识别注解、匹配表达式、决定执行顺序</strong>。</p>
<h2 data-id="heading-4">Mini-AOP的核心实现</h2>
<h3 data-id="heading-5">整体架构</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[用户调用] --&gt; B[代理对象]
    B --&gt; C{切点匹配}
    C --&gt;|匹配成功| D[收集通知]
    D --&gt; E[执行Before]
    E --&gt; F[执行Around]
    F --&gt; G[真实方法]
    G --&gt; H[执行After]
    C --&gt;|不匹配| G
</code></pre>
<h3 data-id="heading-6">关键类说明</h3>
<p><strong>1. BeanFactory - 容器和代理创建者</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanFactory</span> {
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; beans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> List&lt;Object&gt; aspects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    
    <span class="hljs-comment">// 注册Bean时，识别出切面类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> {
        <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> clazz.newInstance();
        <span class="hljs-keyword">if</span> (clazz.isAnnotationPresent(Aspect.class)) {
            aspects.add(instance);  <span class="hljs-comment">// 收集切面</span>
        }
        beans.put(getBeanName(clazz), instance);
    }
    
    <span class="hljs-comment">// 获取Bean时，决定是否创建代理</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name, Class&lt;T&gt; type)</span> {
        <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> beans.get(name);
        <span class="hljs-keyword">if</span> (needProxy(bean)) {
            <span class="hljs-keyword">return</span> AopProxy.createProxy(bean, aspects);  <span class="hljs-comment">// 创建代理</span>
        }
        <span class="hljs-keyword">return</span> (T) bean;
    }
}
</code></pre>
<p><strong>核心逻辑</strong>：</p>
<ul>
<li>注册时收集所有<code>@Aspect</code>类</li>
<li>获取Bean时判断是否需要代理，如果需要就返回代理对象而不是原始对象</li>
</ul>
<p><strong>2. AopProxy - 代理和切点匹配核心</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AopProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {
    <span class="hljs-keyword">private</span> Object target;
    <span class="hljs-keyword">private</span> List&lt;Object&gt; aspects;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> {
        <span class="hljs-comment">// 1. 遍历所有切面</span>
        <span class="hljs-keyword">for</span> (Object aspect : aspects) {
            <span class="hljs-keyword">for</span> (Method aspectMethod : aspect.getClass().getDeclaredMethods()) {
                <span class="hljs-comment">// 2. 检查注解和切点表达式</span>
                <span class="hljs-keyword">if</span> (aspectMethod.isAnnotationPresent(Before.class)) {
                    <span class="hljs-type">String</span> <span class="hljs-variable">pointcut</span> <span class="hljs-operator">=</span> aspectMethod.getAnnotation(Before.class).value();
                    <span class="hljs-comment">// 3. 匹配表达式</span>
                    <span class="hljs-keyword">if</span> (matches(pointcut, method)) {
                        beforeAdvices.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Advice</span>(aspect, aspectMethod));
                    }
                }
            }
        }
        
        <span class="hljs-comment">// 4. 按顺序执行通知链</span>
        <span class="hljs-keyword">return</span> executeAdvices(method, args, beforeAdvices, afterAdvices);
    }
    
    <span class="hljs-comment">// 简单的切点匹配</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(String pointcut, Method method)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">fullName</span> <span class="hljs-operator">=</span> method.getDeclaringClass().getSimpleName() 
                        + <span class="hljs-string">"."</span> + method.getName();
        <span class="hljs-type">String</span> <span class="hljs-variable">regex</span> <span class="hljs-operator">=</span> pointcut.replace(<span class="hljs-string">"*"</span>, <span class="hljs-string">".*"</span>);
        <span class="hljs-keyword">return</span> fullName.matches(regex);
    }
}
</code></pre>
<p><strong>核心逻辑</strong>：</p>
<ul>
<li>方法调用时，遍历所有切面类</li>
<li>读取切面方法上的注解和表达式</li>
<li>用表达式匹配当前方法，决定是否执行</li>
<li>收集所有匹配的通知，按顺序执行</li>
</ul>
<h3 data-id="heading-7">完整的调用流程</h3>
<p>以这段代码为例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 注册</span>
factory.register(LogAspect.class);
factory.register(UserServiceImpl.class);

<span class="hljs-comment">// 获取</span>
<span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> factory.getBean(<span class="hljs-string">"userService"</span>, UserService.class);

<span class="hljs-comment">// 调用</span>
userService.saveUser(<span class="hljs-string">"张三"</span>);
</code></pre>
<p>实际执行流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as 用户代码
    participant P as 代理对象
    participant A as AopProxy.invoke
    participant L as LogAspect
    participant R as RetryAspect
    participant T as 真实对象

    U-&gt;&gt;P: saveUser(&amp;#34;张三&amp;#34;)
    P-&gt;&gt;A: invoke(method, args)
    A-&gt;&gt;A: 匹配切点表达式
    A-&gt;&gt;L: @Before匹配成功
    L--&gt;&gt;A: logBefore()
    A-&gt;&gt;R: @Around匹配成功
    R-&gt;&gt;A: retry { proceed() }
    A-&gt;&gt;T: method.invoke(target, args)
    T--&gt;&gt;A: 返回结果
    A-&gt;&gt;L: @After执行
    L--&gt;&gt;A: logAfter()
    A--&gt;&gt;P: 返回最终结果
    P--&gt;&gt;U: 返回给用户
</code></pre>
<h3 data-id="heading-8">切点表达式的匹配机制</h3>
<p>这是最容易被忽略的部分。很多人以为写了<code>@Before("UserService.*")</code>就自动生效，但实际上：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 切面定义</span>
<span class="hljs-meta">@Before("UserService.*")</span>  <span class="hljs-comment">// 只是声明了一个字符串</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(JoinPoint jp)</span> { }

<span class="hljs-comment">// 必须有代码来解析这个字符串</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(String pointcut, Method method)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> method.getDeclaringClass().getSimpleName();
    <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();
    <span class="hljs-type">String</span> <span class="hljs-variable">fullName</span> <span class="hljs-operator">=</span> className + <span class="hljs-string">"."</span> + methodName;  <span class="hljs-comment">// 如 "UserService.saveUser"</span>
    
    <span class="hljs-comment">// 把表达式转成正则</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">regex</span> <span class="hljs-operator">=</span> pointcut.replace(<span class="hljs-string">"*"</span>, <span class="hljs-string">".*"</span>);  <span class="hljs-comment">// "UserService.*" -&gt; "UserService\..*"</span>
    
    <span class="hljs-comment">// 匹配</span>
    <span class="hljs-keyword">return</span> fullName.matches(regex);
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li>表达式只是字符串，不会自动匹配</li>
<li>必须在运行时解析表达式并和方法名比对</li>
<li>这个匹配发生在每次方法调用时</li>
</ol>
<h3 data-id="heading-9">通知的执行顺序</h3>
<p>多个切面叠加时，执行顺序是这样的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d2454105344494a8a442d28ff982197~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LiP5rWq5peg55eV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066313&amp;x-signature=d5Ic2AYQldRmHVRx7BNHWx92Qxs%3D" alt="116.jpg" loading="lazy"/></p>
<p>代码实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">executeAdvices</span><span class="hljs-params">(Method method, Object[] args, 
                              List&lt;Advice&gt; beforeAdvices,
                              List&lt;Advice&gt; afterAdvices,
                              List&lt;Advice&gt; aroundAdvices)</span> {
    
    <span class="hljs-comment">// 构建调用链</span>
    Supplier&lt;Object&gt; chain = () -&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行@Before</span>
            <span class="hljs-keyword">for</span> (Advice advice : beforeAdvices) {
                advice.method.invoke(advice.aspect, <span class="hljs-keyword">new</span> <span class="hljs-title class_">JoinPoint</span>(target, method, args));
            }
            
            <span class="hljs-comment">// 执行真实方法</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);
            
            <span class="hljs-comment">// 执行@After</span>
            <span class="hljs-keyword">for</span> (Advice advice : afterAdvices) {
                advice.method.invoke(advice.aspect, <span class="hljs-keyword">new</span> <span class="hljs-title class_">JoinPoint</span>(target, method, args));
            }
            
            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    };
    
    <span class="hljs-comment">// @Around包裹整个链条</span>
    <span class="hljs-keyword">for</span> (Advice around : aroundAdvices) {
        <span class="hljs-type">Object</span> <span class="hljs-variable">finalChain</span> <span class="hljs-operator">=</span> chain;
        chain = () -&gt; around.method.invoke(around.aspect, 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProceedingJoinPoint</span>(target, method, args, finalChain));
    }
    
    <span class="hljs-keyword">return</span> chain.get();
}
</code></pre>
<h2 data-id="heading-10">一个完整示例</h2>
<h3 data-id="heading-11">切面定义</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Order(1)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspect</span> {
    <span class="hljs-meta">@Before("UserService.*")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logBefore</span><span class="hljs-params">(JoinPoint jp)</span> {
        System.out.println(<span class="hljs-string">"[日志] 方法: "</span> + jp.getSignature());
    }
    
    <span class="hljs-meta">@After("UserService.*")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logAfter</span><span class="hljs-params">(JoinPoint jp)</span> {
        System.out.println(<span class="hljs-string">"[日志] 方法执行完毕"</span>);
    }
}

<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Order(2)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryAspect</span> {
    <span class="hljs-meta">@Around("UserService.save*")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">retry</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
            <span class="hljs-keyword">try</span> {
                System.out.println(<span class="hljs-string">"[重试] 第 "</span> + (i + <span class="hljs-number">1</span>) + <span class="hljs-string">" 次"</span>);
                <span class="hljs-keyword">return</span> pjp.proceed();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">if</span> (i == <span class="hljs-number">2</span>) <span class="hljs-keyword">throw</span> e;
                Thread.sleep(<span class="hljs-number">1000</span>);
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h3 data-id="heading-12">业务代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(String name)</span>;
}

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(String name)</span> {
        count++;
        System.out.println(<span class="hljs-string">"==&gt; 保存用户: "</span> + name);
        <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">3</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"保存失败"</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-13">运行结果</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BeanFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanFactory</span>();
factory.register(LogAspect.class);
factory.register(RetryAspect.class);
factory.register(UserServiceImpl.class);

<span class="hljs-type">UserService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> factory.getBean(<span class="hljs-string">"userService"</span>, UserService.class);
service.saveUser(<span class="hljs-string">"张三"</span>);
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[日志]</span> 方法: UserService.saveUser
<span class="hljs-section">[重试]</span> 第 1 次
==&gt; 保存用户: 张三
<span class="hljs-section">[重试]</span> 第 2 次
==&gt; 保存用户: 张三
<span class="hljs-section">[重试]</span> 第 3 次
==&gt; 保存用户: 张三
<span class="hljs-section">[日志]</span> 方法执行完毕
</code></pre>
<p>可以看到：</p>
<ol>
<li>日志切面先执行（Order=1）</li>
<li>重试切面包裹在外面（Order=2）</li>
<li>失败两次后第三次成功</li>
</ol>
<h2 data-id="heading-14">和Spring AOP的对比</h2>
<h3 data-id="heading-15">相同点</h3>
<ol>
<li>都使用JDK动态代理</li>
<li>都通过切点表达式匹配方法</li>
<li>都支持多种通知类型和优先级</li>
</ol>
<h3 data-id="heading-16">不同点</h3>



































<table><thead><tr><th>特性</th><th>Mini-AOP</th><th>Spring AOP</th></tr></thead><tbody><tr><td>代理方式</td><td>只有JDK代理</td><td>JDK + CGLIB</td></tr><tr><td>切点表达式</td><td>简单通配符</td><td>完整AspectJ语法</td></tr><tr><td>容器</td><td>手动注册</td><td>自动扫描</td></tr><tr><td>依赖注入</td><td>不支持</td><td>完整支持</td></tr><tr><td>代码量</td><td>800行</td><td>10万行+</td></tr></tbody></table>
<h3 data-id="heading-17">本质是一样的</h3>
<p>Spring AOP的核心流程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fa4ed1312ad44bea8df2cfbbc312ef4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LiP5rWq5peg55eV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767066313&amp;x-signature=oB45fePje47IQs5MRzWivlqok8w%3D" alt="117.jpg" loading="lazy"/></p>
<p>和Mini-AOP对比：</p>






























<table><thead><tr><th>步骤</th><th>Mini-AOP</th><th>Spring AOP</th></tr></thead><tbody><tr><td>扫描切面</td><td><code>factory.register(LogAspect.class)</code></td><td><code>@ComponentScan + @Aspect</code></td></tr><tr><td>判断是否需要代理</td><td><code>needProxy(bean)</code></td><td><code>AbstractAutoProxyCreator.wrapIfNecessary</code></td></tr><tr><td>创建代理</td><td><code>AopProxy.createProxy</code></td><td><code>ProxyFactory.getProxy</code></td></tr><tr><td>切点匹配</td><td><code>matches(pointcut, method)</code></td><td><code>AspectJExpressionPointcut.matches</code></td></tr></tbody></table>
<p><strong>结论</strong>：Spring只是把这套逻辑做得更通用、更灵活，但底层思想完全一致。</p>
<h2 data-id="heading-18">关键收获</h2>
<h3 data-id="heading-19">1. 注解不是魔法</h3>
<p>写了<code>@Before</code>不会自动执行，必须有代码去：</p>
<ol>
<li>读取注解</li>
<li>解析表达式</li>
<li>匹配方法</li>
<li>执行逻辑</li>
</ol>
<h3 data-id="heading-20">2. 代理是核心</h3>
<p>AOP的本质就是动态代理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 用户以为调用的是</span>
<span class="hljs-type">UserService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();

<span class="hljs-comment">// 实际拿到的是</span>
<span class="hljs-type">UserService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(...);
</code></pre>
<p>所有AOP逻辑都在这个代理对象的<code>invoke</code>方法里。</p>
<h3 data-id="heading-21">3. 表达式匹配是关键</h3>
<p>切面能不能生效，取决于：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (matches(<span class="hljs-string">"UserService.*"</span>, method)) {
    <span class="hljs-comment">// 执行切面逻辑</span>
}
</code></pre>
<p>这个匹配逻辑才是决定"哪些方法被拦截"的真正原因。</p>
<h3 data-id="heading-22">4. 三层结构</h3>
<p>永远记住：</p>
<pre><code class="hljs">注解（声明） + 代理（触发） + 匹配（决策） = AOP
</code></pre>
<p>缺少任何一层，AOP都不会生效。</p>
<h2 data-id="heading-23">总结</h2>
<p>手写这个Mini-AOP框架后，对Spring AOP的理解彻底通透了：</p>
<ol>
<li>AOP不是注解的魔法，是代理对象在运行时的动态匹配和调用</li>
<li>切点表达式只是字符串，需要有匹配器来解析和判断</li>
<li>通知的执行顺序由代理对象控制，不是注解决定的</li>
<li>Spring AOP只是把这套机制做得更完善，本质和800行代码没区别</li>
</ol>
<p>下次遇到"为什么@Transactional没生效"这种问题，就能快速定位：是不是代理没创建？是不是表达式没匹配上？是不是调用方式不对？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SSE与流式传输(Streamable HTTP)]]></title>    <link>https://juejin.cn/post/7587023071067635764</link>    <guid>https://juejin.cn/post/7587023071067635764</guid>    <pubDate>2025-12-24T10:10:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587023071067635764" data-draft-id="7582528397865041947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SSE与流式传输(Streamable HTTP)"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-24T10:10:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="布列瑟农的星空"/> <meta itemprop="url" content="https://juejin.cn/user/976022056218471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SSE与流式传输(Streamable HTTP)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022056218471/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    布列瑟农的星空
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T10:10:28.000Z" title="Wed Dec 24 2025 10:10:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>SSE被冷落了十多年，终于随AI火了一把。过去大家宁可用websocket也不愿意使用SSE，以至于AI出来后，很多人认为这是个新技术。实际上它很久以前就是HTML5标准中的一部分了。</p>
<p>MCP兴起后，有些人认为SSE与Streamable HTTP是两个概念，其实不然。本文将理清SSE和Streamalbe HTTP两者的概念与关系，并给出实践中的一些小建议。</p>
<h2 data-id="heading-0">SSE</h2>
<p>SSE是Streamable HTTP的一个实现:SSE不仅对请求头有要求——必须设置Content-Type: text/event-stream，而且对传输格式、数据解析做了详细约定：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe10c5ef22b045d98a17c0a349114f3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5biD5YiX55Gf5Yac55qE5pif56m6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175827&amp;x-signature=lvjhzi7NswjvKtHfnHeWIG%2B2kKk%3D" alt="image.png" loading="lazy"/></p>
<p>除此之外还有自动重连机制，具体可见HTML5标准 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhtml.spec.whatwg.org%2Fmultipage%2Fserver-sent-events.html%23concept-eventsource-url" target="_blank" title="https://html.spec.whatwg.org/multipage/server-sent-events.html#concept-eventsource-url" ref="nofollow noopener noreferrer">html.spec.whatwg.org/multipage/s…</a></p>
<p>除了这些具体的规范外，SSE只能发送get请求，并且只能由客户端主动关闭。另外，从"text/event-stream"上可以看出，SSE聚焦于文本内容传输，要传二进制内容就比较麻烦。</p>
<p>总的来说，SSE是由HTML5标准规定，针对前端场景特殊规定的流式传输协议。基于SSE的流式传输，可以通过EventSource对象实现，也可以通过fetch自行处理请求/解析/重连。</p>
<h2 data-id="heading-1">Streamable HTTP</h2>
<p>Streamable HTTP虽然与SSE一样依赖http协议中的keep-alive，但更底层和中立。</p>
<p>它的核心是Transfer-Encoding: chunked（http1.1），此外没有其他约束。</p>
<p>如果使用http2，可以不声明Transfer-Encoding，只要持续写就行了，因为http2能自动分帧。</p>
<p>当服务器返回的响应中缺少<code>Content-Length</code>头部，且连接保持开放（<code>Connection: keep-alive</code>）时，HTTP/1.1 协议会默认使用<code>Transfer-Encoding: chunked</code>编码来传输响应数据，SSE刚好满足这两个条件，因此也是chunked transfer传输的。</p>
<p>从这个角度来说，SSE就是Streamable HTTP传输的一个实现——<strong>SSE = Streamable HTTP + 事件编码规范</strong>。</p>
<p>由于Streamable HTTP并没有规定数据格式和解析方法，因此使用者可以根据场景自行协商：</p>
<pre><code class="hljs language-css" lang="css">SSE传输：
data: {"token":<span class="hljs-string">"Hello"</span>}
data: {"token":<span class="hljs-string">"world"</span>}
data: [DONE]

Streamable HTTP传输：
{"type":<span class="hljs-string">"token"</span>,<span class="hljs-string">"content"</span>:<span class="hljs-string">"Hello"</span>}
{"type":<span class="hljs-string">"token"</span>,<span class="hljs-string">"content"</span>:<span class="hljs-string">"world"</span>}
{"type":<span class="hljs-string">"done"</span>}

</code></pre>
<p>从内容上可以看出，SSE必须解析data:开头，而Streamable可传输json string line等多种格式。</p>
<h3 data-id="heading-2">为什么MCP更青睐Streamable HTTP</h3>





























<table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td>🌐 <strong>跨语言兼容</strong></td><td>SSE 原生仅限浏览器；Streamable HTTP 适配 SDK、CLI、服务端</td></tr><tr><td>🧱 <strong>结构灵活</strong></td><td>支持 NDJSON、JSON Lines、Protocol Buffers</td></tr><tr><td>⚙️ <strong>更贴近底层 I/O</strong></td><td>方便控制 chunk 大小、流速、关闭机制</td></tr><tr><td>🧩 <strong>多类型输出</strong></td><td>AI 不止发文本，还要发图像、语音、函数调用等</td></tr><tr><td>📦 <strong>工具链统一</strong></td><td>与现代 fetch/Response API 一致</td></tr></tbody></table>
<p>对ai应用来说，SSE过于死板。它规定了传输格式，编码方式，无法以二进制传输。在非浏览器环境中，使用更原始的Streamable HTTP显然更合适。</p>
<h2 data-id="heading-3">流式传输的实践建议</h2>
<ol>
<li>如果没有二进制传输需求，可以使用SSE协议，服务端第三方开源工具也较多</li>
<li>浏览器端建议使用fetch而不是EventSource，便于传参和认证</li>
<li>浏览器端使用AbortController取消流式传输</li>
<li>服务端根据请求头的 Accept: 'text/event-stream' 判断是否以SSE格式传输（如果需要同时支持流式传输和普通分页传输）</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# Vue3 图片标注插件 AILabel]]></title>    <link>https://juejin.cn/post/7586615716907073536</link>    <guid>https://juejin.cn/post/7586615716907073536</guid>    <pubDate>2025-12-23T07:58:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586615716907073536" data-draft-id="7586610067568820224" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# Vue3 图片标注插件 AILabel"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T07:58:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叫我AddV"/> <meta itemprop="url" content="https://juejin.cn/user/4860749051150"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # Vue3 图片标注插件 AILabel
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4860749051150/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叫我AddV
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:58:40.000Z" title="Tue Dec 23 2025 07:58:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue3 图片标注插件 AILabel</h2>
<blockquote>
<p>近期在做一个图片标注的项目，就是展示一张图片，然后在图片上拖拖拽拽绘制一个一个的框框，然后把框框的位置数据保存起来。</p>
</blockquote>
<h3 data-id="heading-1">插件 AILabel</h3>
<p>NPM：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Failabel%3FactiveTab%3Dreadme" target="_blank" title="https://www.npmjs.com/package/ailabel?activeTab=readme" ref="nofollow noopener noreferrer">www.npmjs.com/package/ail…</a>
GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjlifeng%2Failabel" target="_blank" title="https://github.com/jlifeng/ailabel" ref="nofollow noopener noreferrer">github.com/jlifeng/ail…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ce4e65032a648a2b3f94f24018d3712~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081520&amp;x-signature=BptN%2FDjEmIcO5FggX0D6TSUbqCE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>但是有一个问题啊，就是这个 github 上面或者是 npm 上面的链接都是失效的了，文档都找不到，下面贴一个我弄到的文档，起码我发文的时候还是可以查看的，不知道后期还能不能保住！</p>
<p>文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fluchuanqi.github.io%2FAILabel%2Fdoc%2Fpreview%2F%231" target="_blank" title="https://luchuanqi.github.io/AILabel/doc/preview/#1" ref="nofollow noopener noreferrer">luchuanqi.github.io/AILabel/doc…</a></p>
<h3 data-id="heading-2">安装 AILabel 插件</h3>
<p>安装插件很简单哈，一行命令完事儿了。</p>
<pre><code class="hljs language-bash" lang="bash">npm i ailabel
</code></pre>
<p>静待安装完成就可以了。</p>
<h3 data-id="heading-3">使用（关键代码）</h3>
<p><code>AILabel</code> 使用类似于<code>openlayer</code>，也是那种一个一个的图层往上加，下面简单来个案例哈！</p>
<h4 data-id="heading-4">1. 获取图片，获取原始图片的宽高</h4>
<p>比如我有一张图片，我需要获取这个图片的<code>宽高</code>是多少，因为我必须于原始图片大小一样，不然的话我标注出来的位置就是不准的，因此需要先获取原始图片宽高。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> url = <span class="hljs-title function_">ref</span>(<span class="hljs-string">"http://192.168.78.17:5173/static/images/1.jpg"</span>)  <span class="hljs-comment">// 图片地址</span>

<span class="hljs-comment">// 加载图片 获取图片宽高</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadImage</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>()
  img.<span class="hljs-property">src</span> = url.<span class="hljs-property">value</span>
  img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
    imageWidth.<span class="hljs-property">value</span> = img.<span class="hljs-property">width</span>  <span class="hljs-comment">// 图片宽度</span>
    imageHeight.<span class="hljs-property">value</span> = img.<span class="hljs-property">height</span>   <span class="hljs-comment">// 图片高度</span>
  }
}
</code></pre>
<h4 data-id="heading-5">2. 初始化 AILabel</h4>
<p>初始化标注就是使用 AILabel，然后把图片作为图层中添加到 AILabel 中，同时需要在 AILabel 中添加一个标注图层。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 初始化标注</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initAnno</span> = (<span class="hljs-params"/>) =&gt; {
  gMap.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-title class_">Map</span>(<span class="hljs-string">'ed-video-mask'</span>, {
    <span class="hljs-attr">center</span>: { <span class="hljs-attr">x</span>: imageWidth.<span class="hljs-property">value</span> / <span class="hljs-number">2</span>, <span class="hljs-attr">y</span>: imageHeight.<span class="hljs-property">value</span> / <span class="hljs-number">2</span> },  <span class="hljs-comment">// 设置一下中心点位置</span>
    <span class="hljs-attr">zoom</span>: imageWidth.<span class="hljs-property">value</span>,  <span class="hljs-comment">// zoom下面单独说，很重要</span>
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'PAN'</span>,   <span class="hljs-comment">// 设置类型为平移（可以设置绘制矩形、多边形、圆形等等，默认拖拽就行了）</span>
    <span class="hljs-attr">refreshDelayWhenZooming</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 这些在文档里面看就行</span>
    <span class="hljs-attr">zoomWhenDrawing</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">panWhenDrawing</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">withHotKeys</span>: <span class="hljs-literal">false</span>
  })

  <span class="hljs-comment">// 图片图层 （用于展示图片）</span>
  gImageLayer.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Layer</span>.<span class="hljs-title class_">Image</span>(<span class="hljs-string">'image-layer'</span>, {
    <span class="hljs-attr">src</span>: url.<span class="hljs-property">value</span>,  <span class="hljs-comment">// 图片地址url （比如：https://xxx.com/1.png）</span>
    <span class="hljs-attr">width</span>: imageWidth.<span class="hljs-property">value</span>,  <span class="hljs-comment">// 图片实际宽度</span>
    <span class="hljs-attr">height</span>: imageHeight.<span class="hljs-property">value</span>,   <span class="hljs-comment">// 图片实际高度</span>
    <span class="hljs-attr">crossOrigin</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">position</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> }  <span class="hljs-comment">// 初始位置</span>
  },
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'图片图层'</span> },
    { <span class="hljs-attr">zIndex</span>: <span class="hljs-number">1</span> })

  gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">addLayer</span>(gImageLayer.<span class="hljs-property">value</span>)  <span class="hljs-comment">// 图片图层添加到 AILabel</span>

  <span class="hljs-comment">// 标注图层 （绘制的框框在这个图层上）</span>
  gFeatureLayer.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Layer</span>.<span class="hljs-title class_">Feature</span>(
    <span class="hljs-string">'feature-layer'</span>,
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'标注图层'</span> },
    { <span class="hljs-attr">zIndex</span>: <span class="hljs-number">2</span> }
  )
  gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">addLayer</span>(gFeatureLayer.<span class="hljs-property">value</span>)   <span class="hljs-comment">// 标注图层添加到 AILabel</span>
}
</code></pre>
<p>这样就可以了。</p>
<p>那个 zoom 是啥意思哈，很重要，比如我的图片原始分辨率尺寸是 <code>3000 * 2000</code>，但是我们标注给的可是区域不一定这么大啊，也许只有1000* 500，那么我们直接标注的话可能就有问题，标注出来的框框位置可能和实际照片的位置不匹配，这个zoom就是来解决这个问题的。</p>
<p>这个 <code>zoom 就是图片宽度的实际大小</code>。</p>
<p>比如，我的标注可视区域可能只有1000px，但是图片实际宽度是3000px，图片为了在可视区域放得下，会自动把图片缩小，让图片可以在可视区域完整得放下。这时候其实图片是被缩小的，但是我们标注出来的位置和大小就和原尺寸的对应不上了，这时候我们设置 <code>zoom 为 3000</code>，那么就对应上了，所以，<code>zoom 设置为原始图片宽度就可以</code>！切记切记！不然标注出来的位置是错的！！！</p>
<h4 data-id="heading-6">3. 修改 AILabel 的模式</h4>
<p>上面默认设置了 <code>PAN</code>，就是平移，这个时候是可以拖拽图片位置，滚轮实现图片缩放的。</p>
<p>当需要鼠标拖拽绘制的时候，需要改为其他的模式，修改方式为：</p>
<pre><code class="hljs language-javascript" lang="javascript">gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">setMode</span>(mode)
</code></pre>
<p>其中 mode 的值可以是：<code>RECT</code>、<code>CIRCLE</code>、<code>POLYGON</code>、<code>POINT</code>、<code>LINE</code>。</p>

































<table><thead><tr><th>值</th><th>含义</th></tr></thead><tbody><tr><td>RECT</td><td>矩形</td></tr><tr><td>CIRCLE</td><td>圆形</td></tr><tr><td>POLYGON</td><td>多边形</td></tr><tr><td>POINT</td><td>点</td></tr><tr><td>LINE</td><td>线段</td></tr><tr><td>PAN</td><td>平移</td></tr></tbody></table>
<h4 data-id="heading-7">4. 设置拖拽样式</h4>
<p>在我们设置了 <code>gMap.value.setMode('RECT')</code>  绘制矩形的时候，我们按下鼠标左键拖拽的时候会有一个默认样式，当然这是可以设置的，设置起来很简单：</p>
<pre><code class="hljs language-javascript" lang="javascript">gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">setDrawingStyle</span>({
	<span class="hljs-attr">strokeStyle</span>: <span class="hljs-string">'#409EFF'</span>,  <span class="hljs-comment">// 设置边框颜色</span>
  <span class="hljs-attr">lineWidth</span>: <span class="hljs-number">2</span>,   <span class="hljs-comment">// 设置边框宽度</span>
  <span class="hljs-attr">fillStyle</span>: <span class="hljs-string">'#409EFF44'</span>,   <span class="hljs-comment">// 设置填充颜色</span>
  <span class="hljs-attr">fill</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 启用填充</span>
  <span class="hljs-attr">stroke</span>: <span class="hljs-literal">true</span>   <span class="hljs-comment">// 启用边框</span>
})
</code></pre>
<h4 data-id="heading-8">5. 事件</h4>
<p>事件是啥呢，比如，我绘制完会走哪个函数，选中会走那个函数，修改之后会走哪个函数等等。</p>
<p>我们可以写一个函数绑定这些事件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 绑定事件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">bindEvents</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 绘制完成回调监听</span>
  gMap.<span class="hljs-property">value</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'drawDone'</span>, <span class="hljs-function">(<span class="hljs-params">type, data</span>) =&gt;</span> {
    <span class="hljs-title function_">createAnnotation</span>(type, data)  <span class="hljs-comment">// 走了一个函数</span>
  })
  <span class="hljs-comment">// 要素选中回调监听(非PAN模式下双击选中)</span>
  gMap.<span class="hljs-property">value</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'featureSelected'</span>, <span class="hljs-function">(<span class="hljs-params">feature</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (feature) { gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">setActiveFeature</span>(feature) }
  })
  <span class="hljs-comment">// 要素取消选中回调监听(选中后点击其他位置取消选中)</span>
  gMap.<span class="hljs-property">value</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'featureUnselected'</span>, <span class="hljs-function">() =&gt;</span> {
    gMap.<span class="hljs-property">value</span>.<span class="hljs-title function_">setActiveFeature</span>(<span class="hljs-literal">null</span>)
  })
  <span class="hljs-comment">// 要素更新回调监听(选中后编辑完成回调)</span>
  gMap.<span class="hljs-property">value</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'featureUpdated'</span>, <span class="hljs-function">(<span class="hljs-params">feature, shape</span>) =&gt;</span> {
    feature.<span class="hljs-title function_">updateShape</span>(shape)
  })
}
</code></pre>
<p>我们开启绘制之后，绘制完一松手发现框框没了，因为我们没有绘制上去，所以我们在绘制完成之后的回调里面，获得了绘制的数据，然后把这个数据自己手写一个框框放到图层上面去：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加要素</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createAnnotation</span> = (<span class="hljs-params">type, shape</span>) =&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-string">`<span class="hljs-subst">${type}</span>_<span class="hljs-subst">${uuid4()}</span>`</span>  <span class="hljs-comment">// 随机ID</span>
  <span class="hljs-keyword">let</span> feature = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">let</span> style = {
    <span class="hljs-attr">strokeStyle</span>: <span class="hljs-string">'#409EFF'</span>,  <span class="hljs-comment">// 设置边框颜色</span>
 		<span class="hljs-attr">lineWidth</span>: <span class="hljs-number">2</span>,   <span class="hljs-comment">// 设置边框宽度</span>
    <span class="hljs-attr">fillStyle</span>: <span class="hljs-string">'#409EFF44'</span>,   <span class="hljs-comment">// 设置填充颜色</span>
    <span class="hljs-attr">fill</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// 启用填充</span>
    <span class="hljs-attr">stroke</span>: <span class="hljs-literal">true</span>   <span class="hljs-comment">// 启用边框</span>
  }
  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'RECT'</span>) {   <span class="hljs-comment">// 绘制矩形</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Rect</span>(id, shape, <span class="hljs-literal">null</span>, style)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'CIRCLE'</span>) {  <span class="hljs-comment">// 绘制圆形</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Circle</span>(id, shape, <span class="hljs-literal">null</span>, style)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'POLYGON'</span>) {  <span class="hljs-comment">// 绘制多边形</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Polygon</span>(id, { <span class="hljs-attr">points</span>: shape }, <span class="hljs-literal">null</span>, style)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'POINT'</span>) {  <span class="hljs-comment">// 绘制点</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Point</span>(id, shape, <span class="hljs-literal">null</span>, style)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'LINE'</span>) {   <span class="hljs-comment">// 绘制线</span>
    feature = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AILabel</span>.<span class="hljs-property">Feature</span>.<span class="hljs-title class_">Line</span>(id, shape, <span class="hljs-literal">null</span>, style)
  }
  gFeatureLayer.<span class="hljs-property">value</span>.<span class="hljs-title function_">addFeature</span>(feature)
  <span class="hljs-keyword">return</span> feature;
}
</code></pre>
<p>然后就可以了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acd4b27437f4493e8fb6f0711774ae71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-r5oiRQWRkVg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081520&amp;x-signature=KWeIW3cwZWib8UY%2BfcG%2BwOdXgHA%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不只是作品集：用 Next.js 打造我的数字作品库]]></title>    <link>https://juejin.cn/post/7586540799251333174</link>    <guid>https://juejin.cn/post/7586540799251333174</guid>    <pubDate>2025-12-23T01:31:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586540799251333174" data-draft-id="7586504691846447113" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不只是作品集：用 Next.js 打造我的数字作品库"/> <meta itemprop="keywords" content="Next.js,React.js"/> <meta itemprop="datePublished" content="2025-12-23T01:31:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白雾茫茫丶"/> <meta itemprop="url" content="https://juejin.cn/user/1917147257534279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不只是作品集：用 Next.js 打造我的数字作品库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1917147257534279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白雾茫茫丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:31:51.000Z" title="Tue Dec 23 2025 01:31:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p><strong>Hi，大家好，我是白雾茫茫丶！</strong></p>
<p>很久没和大家见面了，说来惭愧，自从AI成了“全能助手”，我这个“码字工”的笔就有点锈了——感觉很多技术问题，还没等我写完文章，AI三言两语就解释清楚了。少了点输出深度内容的动力，手也就慢慢懒了。</p>
<p>不过最近，我又找到了一点不一样的感觉。工作上接触不到，我就自己动手——这段时间一直在折腾 <strong>Next.js + Shadcn UI</strong> 这套组合。不得不说，确实很火，用起来也很顺手，从头搭一个项目的过程，反而让我找回了那种边踩坑边学习的踏实感。</p>
<p>今天想和大家分享的，是我在这个过程中做出来的一个小成果：<strong>一个个人作品信息展示的模板</strong>。我觉得它设计得挺干净，结构也清晰，不管是拿来即用，还是当作学习参考，应该都还不错。如果你也在找类似的灵感或模版，不妨看看，希望能帮到你。</p>
<h2 data-id="heading-1"><strong>灵感来源</strong></h2>
<p>在我探索 Shadcn UI 的过程中，偶然发现了一个设计非常出色的模板：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmagicui.design%2Fdocs%2Ftemplates%2Fportfolio" target="_blank" title="https://magicui.design/docs/templates/portfolio" ref="nofollow noopener noreferrer">magicui.design/docs/templa…</a></p>
<p>最初我只是把它集成在自己正在捣鼓的项目里试试水，但很快发现，这个页面本身就足够完整和优雅——即使独立出来，也完全能作为一个专业的作品展示站点。</p>
<p>于是，我决定把它单独抽离出来，搭建成了一个专注的作品展示项目。在保留其原设计精髓的基础上，我根据自己的偏好做了一些调整，加入了一些个性化的交互细节和动画效果，让整个界面在简洁之中多了一点灵动的气息。</p>
<p>最终呈现出来的，就是现在这个版本——整体保持干净利落，又不失细节处的巧思。如果你也在寻找一个轻量、现代且易于定制的作品集模板，或许这个实现能给你带来一些灵感。</p>
<h2 data-id="heading-2"><strong>为什么每个开发者都需要一个作品站点？</strong></h2>
<p>作为开作为开发者，我们每天都在创造价值：在 GitHub 提交代码、在掘金写技术文章、在开源社区贡献方案……</p>
<blockquote>
<p>但这些成果往往散落在不同的平台，像一座座信息孤岛。面试时，我们需要反复解释这些分散的内容；求职时，简历上的短短几行描述，难以承载我们真实的技术思考与项目深度。</p>
</blockquote>
<p>构建一个<strong>统一的技术身份</strong>，将分散的项目、文章、数据可视化整合在一个专业、可访问的空间。它不仅仅是一个作品集，更是：</p>
<p>• <strong>面试的隐形加分项</strong>——当面试官通过一个精心设计的站点看到你的完整技术路径、真实的项目思考过程，这种体验远胜过千篇一律的简历</p>
<p>• <strong>技术能力的系统证明</strong>——可视化你的 GitHub 贡献、技能雷达图、项目迭代历史，让抽象的能力变得具体可见</p>
<h2 data-id="heading-3">技术栈</h2>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- 框架：Next.js 16、React 19、TypeScript 5</span>
<span class="hljs-deletion">- 样式：Tailwind CSS v4、tw-animate-css</span>
<span class="hljs-deletion">- 可视化：Recharts</span>
<span class="hljs-deletion">- 其他：ahooks、enum-plus、lucide-react</span>
</code></pre>
<h2 data-id="heading-4">特性</h2>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">-</span> 基于 <span class="hljs-code">`Next.js App Router`</span> 的现代架构
<span class="hljs-bullet">-</span> 使用 <span class="hljs-code">`Tailwind CSS v4`</span> 与自定义主题变量，支持暗色模式
<span class="hljs-bullet">-</span> GitHub 仓库与贡献统计 API
<span class="hljs-bullet">-</span> Halo 文章列表聚合 API
<span class="hljs-bullet">-</span> Recharts 数据图表可视化
<span class="hljs-bullet">-</span> 完整 SEO 文件：<span class="hljs-code">`robots`</span>、<span class="hljs-code">`sitemap`</span>、<span class="hljs-code">`manifest`</span>
<span class="hljs-bullet">-</span> 集成 Umami、Microsoft Clarity、Google Analytics（生产环境自动启用）
</code></pre>
<h2 data-id="heading-5">环境变量</h2>
<p>在项目根目录创建 <code>.env</code>，示例：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 站点信息</span>
<span class="hljs-attr">NEXT_PUBLIC_NAME</span>=<span class="hljs-string">"你的名字"</span>
<span class="hljs-attr">NEXT_PUBLIC_APP_NAME</span>=<span class="hljs-string">"Portfolio"</span>
<span class="hljs-attr">NEXT_PUBLIC_DESC</span>=<span class="hljs-string">"一句话简介/站点描述"</span>
<span class="hljs-attr">NEXT_PUBLIC_APP_DOMAIN</span>=<span class="hljs-string">"https://your-domain.com"</span>
<span class="hljs-attr">NEXT_PUBLIC_THEME</span>=<span class="hljs-string">"light"</span> <span class="hljs-comment"># 可选：light | dark | system</span>

<span class="hljs-comment"># 分析统计（生产环境生效）</span>
<span class="hljs-attr">NEXT_PUBLIC_UMAMI_ID</span>=<span class="hljs-string">""</span>
<span class="hljs-attr">NEXT_PUBLIC_CLARITY_ID</span>=<span class="hljs-string">""</span>
<span class="hljs-attr">NEXT_PUBLIC_GA_ID</span>=<span class="hljs-string">""</span>

<span class="hljs-comment"># GitHub API</span>
<span class="hljs-attr">GITHUB_TOKEN</span>=<span class="hljs-string">""</span> <span class="hljs-comment"># 只读 Token</span>
<span class="hljs-attr">NEXT_PUBLIC_GITHUB_USERNAME</span>=<span class="hljs-string">"your-github-username"</span>

<span class="hljs-comment"># Halo API</span>
<span class="hljs-attr">HALO_TOKEN</span>=<span class="hljs-string">""</span> <span class="hljs-comment"># 只读 Token</span>
</code></pre>
<h2 data-id="heading-6">效果预览</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/950a3c041940463abe0c22cf41401586~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55m96Zu-6Iyr6Iyr5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767058990&amp;x-signature=6LfXOaKkPm6krsu4phL7HK%2BKWas%3D" alt="PixPin_2025-12-23_09-27-56.png" loading="lazy"/></p>
<h2 data-id="heading-7">总结</h2>
<p>这个基于 Next.js + Shadcn UI 构建的个人作品展示模板，是我在探索现代前端技术栈过程中的一次实践与沉淀。</p>
<p>技术本身是工具，但如何用它更好地表达自己、呈现价值，才是更有意义的探索。</p>
<p>如果你也在构建个人项目、整理作品集，或单纯想学习 Next.js 全栈实践，这个项目或许能给你一些参考。</p>
<p>在线预览：<a href="https://link.juejin.cn?target=https%3A%2F%2Fportfolio.baiwumm.com" target="_blank" title="https://portfolio.baiwumm.com" ref="nofollow noopener noreferrer">portfolio.baiwumm.com</a></p>
<p>Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbaiwumm%2Fportfolio" target="_blank" title="https://github.com/baiwumm/portfolio" ref="nofollow noopener noreferrer">github.com/baiwumm/por…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Tauri (22)——让 `Esc` 快捷键一层层退出的分层关闭方案]]></title>    <link>https://juejin.cn/post/7586585688004411433</link>    <guid>https://juejin.cn/post/7586585688004411433</guid>    <pubDate>2025-12-23T02:15:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586585688004411433" data-draft-id="7586555198115594246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Tauri (22)——让 `Esc` 快捷键一层层退出的分层关闭方案"/> <meta itemprop="keywords" content="前端,React.js,APP"/> <meta itemprop="datePublished" content="2025-12-23T02:15:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨夜寻晴天"/> <meta itemprop="url" content="https://juejin.cn/user/1943592288391496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Tauri (22)——让 `Esc` 快捷键一层层退出的分层关闭方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592288391496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨夜寻晴天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:15:10.000Z" title="Tue Dec 23 2025 02:15:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景：为什么 <code>Esc</code> 会变得“不可控”</h2>
<p>在 Coco 里，<code>Esc</code> 同时承担了很多“退出/关闭”的职责：</p>
<ul>
<li>退出输入（Input/Textarea）编辑态</li>
<li>关闭弹层（Popover / 菜单）</li>
<li>关闭历史面板（History Panel）</li>
<li>最后隐藏窗口（Tauri <code>hideWindow</code>）</li>
</ul>
<p><strong>问题在于</strong>：这些层级的 UI 往往同时存在。如果不做事件隔离，<code>Esc</code> 可能 “一键关闭所有”，或者被某一层吞掉导致 “该关的不关”。</p>
<p>本次改动的核心，就是把 <code>Esc</code> 做成<strong>可预期的优先级链路</strong>，并通过 <strong><code>stopPropagation</code> + DOM 状态判定</strong>让各层各司其职。</p>
<hr/>
<h2 data-id="heading-1">设计目标：<code>Esc</code> 的层级优先级（从近到远）</h2>
<p>我们把 <code>Esc</code> 定义为 “从用户当前操作点开始逐层退出”，优先级如下：</p>
<ol>
<li><strong>如果正在输入</strong>：先 blur（退出输入态），不做其它关闭</li>
<li><strong>如果在 Popover 里</strong>：关闭当前 Popover（但第一下 <code>Esc</code> 若在输入框里，仍先 blur）</li>
<li><strong>如果上下文菜单打开</strong>：关闭上下文菜单</li>
<li><strong>如果 History Panel 打开</strong>：关闭 History Panel</li>
<li><strong>如果 Extension View 打开</strong>：不隐藏窗口（交给 Extension 自己处理或保持现状）</li>
<li><strong>否则</strong>：隐藏窗口（<code>hideWindow()</code>）</li>
</ol>
<p>这条链路的关键点是：<strong>“内层 UI 必须能拦截并消费 Esc，避免冒泡到全局导致直接 hideWindow”</strong>。</p>
<hr/>
<h2 data-id="heading-2">全局 <code>Esc</code>：统一入口与“最后兜底”</h2>
<p>全局 <code>Esc</code> 由 <code>LayoutOutlet</code> 初始化（<code>src/routes/outlet.tsx</code> 调用 <code>useEscape()</code>），核心逻辑在 <code>src/hooks/useEscape.ts</code>：</p>
<ul>
<li>先做 <code>event.preventDefault()</code> + <code>event.stopPropagation()</code>（<code>src/hooks/useEscape.ts</code>）</li>
<li>再按优先级处理：
<ul>
<li>输入 blur（<code>src/hooks/useEscape.ts</code>）</li>
<li>关闭右键菜单（<code>src/hooks/useEscape.ts</code>）</li>
<li>关闭 History Panel（<code>src/hooks/useEscape.ts</code>）</li>
<li>Extension 打开时直接 <code>return</code>，避免误隐藏（<code>src/hooks/useEscape.ts</code>）</li>
<li>最后隐藏窗口（<code>src/hooks/useEscape.ts</code>）</li>
</ul>
</li>
</ul>
<p>这里有个重要的小优化：回调里用 <code>useSearchStore.getState()</code> 取最新状态（<code>src/hooks/useEscape.ts</code>），避免快捷键回调捕获旧状态导致 “按了没反应”。</p>
<hr/>
<h2 data-id="heading-3">Popover 的 <code>Esc</code>：把“关闭弹层”从全局剥离出来</h2>
<p>真正决定 “Esc 是否一层层退出” 的关键，是 Popover 对 Esc 的消费。</p>
<p>在 Radix Popover 中，<code>PopoverContent</code> 提供了 <code>onEscapeKeyDown</code>。本次在组件封装层统一加入：</p>
<ul>
<li>文件：<code>src/components/ui/popover.tsx</code></li>
<li>逻辑：<code>src/components/ui/popover.tsx</code></li>
</ul>
<p>行为是：</p>
<ol>
<li><code>stopPropagation</code> + <code>preventDefault</code>（避免 Esc 冒泡到全局 <code>useEscape</code>，也避免浏览器默认行为）</li>
<li>如果焦点在输入框/文本域：只 blur（<code>src/components/ui/popover.tsx</code>）
<ul>
<li>这保证了“第一下 Esc 退出输入”，而不是直接关掉 popover</li>
</ul>
</li>
<li>否则：找到当前打开的 popover trigger 并 <code>click()</code>，从而走 Radix 的正常关闭流程（<code>src/components/ui/popover.tsx</code>）</li>
</ol>
<p>为了找到 “当前打开的 trigger”，新增了选择器常量：</p>
<ul>
<li><code>OPENED_POPOVER_TRIGGER_SELECTOR</code>：<code>src/constants/index.ts</code></li>
</ul>
<hr/>
<h2 data-id="heading-4">为什么要改选择器：从“自定义标记”到 Radix 的真实 DOM</h2>
<p>这次对 Popover 的识别方式也做了统一调整：</p>
<ul>
<li><code>POPOVER_PANEL_SELECTOR</code> 改为 Radix wrapper：<code>src/constants/index.ts</code>
<ul>
<li>变成 <code>"[data-radix-popper-content-wrapper]"</code>，用于更可靠地判断“现在是否存在 popover”</li>
</ul>
</li>
<li><code>HISTORY_PANEL_ID</code> / <code>CONTEXT_MENU_PANEL_ID</code> 从 <code>headlessui-...</code> 命名迁移到 <code>popover-panel:...</code>（<code>src/constants/index.ts</code>）
<ul>
<li>配合当前实际渲染结构，避免 ID 不一致导致关闭逻辑失效</li>
</ul>
</li>
</ul>
<p>对应的 History 关闭动作走的是点击 trigger：</p>
<ul>
<li><code>closeHistoryPanel()</code>：<code>src/utils/index.ts</code></li>
<li>它通过 <code>[aria-controls="${HISTORY_PANEL_ID}"]</code> 找到按钮并点击（<code>src/utils/index.ts</code>）</li>
<li><code>useEscape</code> 用 <code>document.getElementById(HISTORY_PANEL_ID)</code> 判断历史面板是否存在（<code>src/hooks/useEscape.ts</code>）</li>
</ul>
<hr/>
<h2 data-id="heading-5"><code>VisibleKey</code> 与 “在 Popover 里显示快捷键提示”</h2>
<p><code>VisibleKey</code> 需要知道 “当前快捷键提示是否应该显示”，尤其是在 popover 打开时，只在 popover 内的元素上显示。</p>
<p>它通过：</p>
<ul>
<li><code>POPOVER_PANEL_SELECTOR</code> 获取 popover 面板 wrapper（<code>src/components/Common/VisibleKey.tsx</code>）</li>
<li><code>OPENED_POPOVER_TRIGGER_SELECTOR</code> 获取打开的 trigger（<code>src/components/Common/VisibleKey.tsx</code>）</li>
<li>判断当前组件是否在 panel 或 trigger 内（<code>src/components/Common/VisibleKey.tsx</code>）</li>
</ul>
<p>这样一来，“打开 popover 后，快捷键提示只在当前 popover 的交互区域出现”，不会污染外层 UI。</p>
<hr/>
<h2 data-id="heading-6">输入框组件收敛：删除 <code>PopoverInput</code>，统一用 shadcn <code>Input</code></h2>
<p><code>src/components/Common/PopoverInput.tsx</code> 被删除，相关位置改为直接使用 <code>src/components/ui/input</code>：</p>
<ul>
<li><code>SearchPopover</code>：<code>src/components/Search/SearchPopover.tsx</code></li>
<li><code>MCPPopover</code>：<code>src/components/Search/MCPPopover.tsx</code></li>
<li><code>AssistantList</code>：<code>src/components/Assistant/AssistantList.tsx</code></li>
</ul>
<p>同时统一加了 <code>autoCorrect="off"</code>，减少输入联想带来的干扰（例如英文关键字/ID 搜索场景）。</p>
<hr/>
<h2 data-id="heading-7">小结</h2>
<p>本次改动将 <code>Esc</code> 从“不可控的一键退出”重构为<strong>有明确优先级的逐层退出机制</strong>：</p>
<p><strong>输入态 → Popover → 菜单 / History → Extension → 窗口隐藏</strong></p>
<p>核心做法是：</p>
<ul>
<li><strong>全局 <code>useEscape</code> 只作为最后兜底</strong>，按优先级处理关闭逻辑</li>
<li><strong>Popover 内部消费 <code>Esc</code></strong>（优先 blur 输入，其次关闭弹层），防止事件冒泡到全局</li>
<li>基于 <strong>Radix 实际 DOM</strong> 统一判断 popover / history 是否打开</li>
<li><code>VisibleKey</code> 只在当前 popover 交互区域内显示</li>
<li>统一输入组件，减少干扰</li>
</ul>
<p>结果是：<strong>Esc 行为稳定、可预期，不再误关、不再漏关。</strong></p>
<h2 data-id="heading-8">开源</h2>
<p>如果你对我们的技术细节感兴趣，或者想体验一下这款全能的生产力工具，欢迎访问我们的开源仓库和官网：</p>
<ul>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Finfinilabs%2Fcoco-app" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Finfinilabs%2Fcoco-app" target="_blank">github.com/infinilabs/…</a></li>
<li><strong>Website</strong>: <a href="https://link.juejin.cn/?target=https%3A%2F%2Fcoco.rs" title="https://link.juejin.cn/?target=https%3A%2F%2Fcoco.rs" target="_blank">coco.rs</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简单对比glm4.6与minimaxm2.1]]></title>    <link>https://juejin.cn/post/7587256133790924840</link>    <guid>https://juejin.cn/post/7587256133790924840</guid>    <pubDate>2025-12-24T10:03:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587256133790924840" data-draft-id="7587243886427570191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简单对比glm4.6与minimaxm2.1"/> <meta itemprop="keywords" content="产品"/> <meta itemprop="datePublished" content="2025-12-24T10:03:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Charlo"/> <meta itemprop="url" content="https://juejin.cn/user/1239904845853870"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简单对比glm4.6与minimaxm2.1
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904845853870/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Charlo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T10:03:24.000Z" title="Wed Dec 24 2025 10:03:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>简单对比glm4.6与minimaxm2.1</p>
<p>模仿CMI网站的功能写的prd文档</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c521eaa0eb3483ab81873ae6fd8f6ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=uPtCqNLyV5wYYWtWhdA74WY%2BRu4%3D" alt="image.png" loading="lazy"/>
直接在trea中输入：按照需求文档使用react写出网页</p>
<h2 data-id="heading-0">Trea 中的 minimax</h2>
<p>首次完成有问题
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/427f21c382e34a269baec82827fe107f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=0w5iGq3SGVJ9UwOghQW80741ngs%3D" alt="image.png" loading="lazy"/>
一轮修改后</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/254d919b12404694847c8b399ad8e537~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=2nIY1%2B7sORoOYxNGIwPMZx5gxsk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eefe86d790d04b8ca917134acb421feb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=c9s4Oa2xWZcwXFX3Q83DPlQ2uBc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11496a2e8d2345b6a883a6627fc0fae4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=q6KK77nGx9en29xF0UVA6P2Bl8Q%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">Trea 中的 GLM4.7</h2>
<p>除了中间断了一次，整体效果其实还可以，有些细节很奇怪，会有莫名奇妙的边框线和渐变
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/464a2fb93d784afdbda2caef76a392ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=sD%2BR%2FLUWoOpFmY7nvF7u9Qqs%2B9o%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/583de70d63614ee19be264a3a133e2d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=kIlS8Fji5s%2B9N83cvqybsC1RK3M%3D" alt="image.png" loading="lazy"/></p>
<p>布局也有一些错误</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b10b966e4a2497a8da0e7ea9b93a106~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=tUhuCGIhfg%2FwKdZuCMAuiJbruao%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">Winsurf 中的 gpt 5.2 high reasoning</h2>
<p>虽然慢，但也是一次搞对</p>
<p>但后来发现用的是 ant ui 并不是shadcn</p>
<p>后面让改成shadcn，改了半天七绕八绕</p>
<p>还把我默认的llm.txt改了</p>
<p>也没改明白 postcss 的bug</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2e173fc30c54656a9ff3c99e1e57590~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=grltR4tNd3XMUIBRolSMpMz4R4o%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">Winsurf 中的 swe pro</h2>
<p>不提也罢，陷入死循环了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d7f729dfc67435a958ad82df9a2aafa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=qVThwbSPv7b8HacIwF6u1EpaElE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">Winsurf 中的 Sonnet 3.7</h2>
<p>也遇到了postcss的问题，不过在修改了四五轮之后成功了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a83a4ea9a564e888c8daf6cade32d17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=YpMZ5pcnV3oweyfq%2ByGb48JvySc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cd99c88c2874b9f8b9c5f0f91f752ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=ukU126KPsA5JIJS9mYMpk5XeDjo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">Winsur 中的 Sonnet 4.5</h2>
<p>一次搞定</p>
<p>不过商品透视没写，而且布局和构想的有区别</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa438b76928a498aba2f2d623cb41c0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=AZJP1Sk3gbKZjRvusWuNuJtJgjU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">Ai Studio Gemini 3.0 pro</h2>
<p>个人最喜欢的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7b12351586d4ae9b4334b527dec10f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=f7GfjCqm0gnjK1dQ5VzupWXtb4E%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">Google Antigravity 里的 Opus4.5 thinking</h2>
<p>我完全不知道发生了什么。。。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f4dd9a7a4644f7aa4aef2c9e0bc9e0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=7pTGgYiRRft9tvMcmeTuqMFbxMQ%3D" alt="image.png" loading="lazy"/></p>
<p>其实是头像</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8aaa3b23806846cba20c41ef51379a1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hhcmxv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767175694&amp;x-signature=ABnS7lAtzw9qet%2FNzvCpCT0UZN0%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Guava ListenableFuture 学习生产级并发调用实践]]></title>    <link>https://juejin.cn/post/7586942589321183268</link>    <guid>https://juejin.cn/post/7586942589321183268</guid>    <pubDate>2025-12-23T11:26:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586942589321183268" data-draft-id="7586940555403952169" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Guava ListenableFuture 学习生产级并发调用实践"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-12-23T11:26:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Guava ListenableFuture 学习生产级并发调用实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T11:26:18.000Z" title="Tue Dec 23 2025 11:26:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    25
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>之前从 Elasticsearch 源码学到了线程池配置的设计思想，但 ES 的代码太底层，难以直接迁移到业务系统。今天在 Guava 框架中找到了更实用的方案：相比 <code>CompletableFuture</code> 复杂的链式调用，<code>ListenableFuture</code> 提供了更清晰的并发编排模式。</p>
<hr/>
<h2 data-id="heading-1">一、为什么选择 Guava ListenableFuture</h2>
<h3 data-id="heading-2">CompletableFuture 的痛点</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// allOf 返回 Void，还要手动 join</span>
CompletableFuture.allOf(productFuture, inventoryFuture)
    .thenApply(v -&gt; {
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productFuture.join();  <span class="hljs-comment">// 还要再次 join</span>
        <span class="hljs-type">Inventory</span> <span class="hljs-variable">inventory</span> <span class="hljs-operator">=</span> inventoryFuture.join();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetailDTO</span>(product, inventory);
    });
</code></pre>
<h3 data-id="heading-3">Guava 的优势</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 提交任务</span>
ListenableFuture&lt;Product&gt; productFuture = executor.submit(() -&gt; 
    productService.getProduct(id));
ListenableFuture&lt;Inventory&gt; inventoryFuture = executor.submit(() -&gt; 
    inventoryService.getInventory(id));

<span class="hljs-comment">// 等待全部成功后组装</span>
<span class="hljs-keyword">return</span> Futures.whenAllSucceed(productFuture, inventoryFuture)
    .call(() -&gt; {
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> Futures.getDone(productFuture);
        <span class="hljs-type">Inventory</span> <span class="hljs-variable">inventory</span> <span class="hljs-operator">=</span> Futures.getDone(inventoryFuture);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetailDTO</span>(product, inventory);
    }, executor);
</code></pre>
<p>核心优势：</p>
<ul>
<li><strong>职责分离</strong>：提交和处理分开</li>
<li><strong>类型安全</strong>：<code>getDone()</code> 直接返回结果</li>
<li><strong>语义清晰</strong>：<code>whenAllSucceed</code> 明确表达意图</li>
</ul>
<hr/>
<h2 data-id="heading-4">二、业务场景：电商商品详情页</h2>
<p>用户访问商品详情页，需要并行查询商品服务和库存服务：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[GET /product/123] --&gt; B[ProductFacade]
    B --&gt; C[商品服务 80ms]
    B --&gt; D[库存服务 60ms]
    C --&gt; E[组装结果]
    D --&gt; E
    E --&gt; F[返回DTO]
</code></pre>
<ul>
<li>串行耗时：80ms + 60ms = 140ms</li>
<li>并行耗时：max(80ms, 60ms) ≈ 80ms</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、完整代码实现</h2>
<h3 data-id="heading-6">数据模型</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 商品信息</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String id;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> priceInCents;
    
    Product(String id, String name, <span class="hljs-type">int</span> priceInCents) {
        <span class="hljs-built_in">this</span>.id = id;
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.priceInCents = priceInCents;
    }
    
    String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> id; }
    String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> name; }
    <span class="hljs-type">int</span> <span class="hljs-title function_">getPriceInCents</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> priceInCents; }
}

<span class="hljs-comment">// 库存信息</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Inventory</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String productId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> quantity;
    
    Inventory(String productId, <span class="hljs-type">int</span> quantity) {
        <span class="hljs-built_in">this</span>.productId = productId;
        <span class="hljs-built_in">this</span>.quantity = quantity;
    }
    
    String <span class="hljs-title function_">getProductId</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> productId; }
    <span class="hljs-type">int</span> <span class="hljs-title function_">getQuantity</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> quantity; }
}

<span class="hljs-comment">// 返回的 DTO</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductDetailDTO</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String productId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> priceInCents;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> quantity;
    
    ProductDetailDTO(String productId, String name, <span class="hljs-type">int</span> priceInCents, <span class="hljs-type">int</span> quantity) {
        <span class="hljs-built_in">this</span>.productId = productId;
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.priceInCents = priceInCents;
        <span class="hljs-built_in">this</span>.quantity = quantity;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ProductDetailDTO{"</span> +
                <span class="hljs-string">"productId='"</span> + productId + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", name='"</span> + name + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", priceInCents="</span> + priceInCents +
                <span class="hljs-string">", quantity="</span> + quantity +
                <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<h3 data-id="heading-7">模拟服务</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(String productId)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">80</span>);  <span class="hljs-comment">// 模拟网络调用</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(productId, <span class="hljs-string">"MacBook Pro 14"</span>, <span class="hljs-number">149900</span>);
    }
}

<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryService</span> {
    Inventory <span class="hljs-title function_">getInventory</span><span class="hljs-params">(String productId)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">60</span>);  <span class="hljs-comment">// 模拟网络调用</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Inventory</span>(productId, <span class="hljs-number">42</span>);
    }
}
</code></pre>
<h3 data-id="heading-8">核心门面类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductFacade</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ProductService productService;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> InventoryService inventoryService;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ListeningExecutorService executor;
    
    ProductFacade(ProductService productService,
                  InventoryService inventoryService,
                  ListeningExecutorService executor) {
        <span class="hljs-built_in">this</span>.productService = productService;
        <span class="hljs-built_in">this</span>.inventoryService = inventoryService;
        <span class="hljs-built_in">this</span>.executor = executor;
    }
    
    <span class="hljs-comment">/**
     * 并行获取商品信息和库存信息，然后组装成 ProductDetailDTO
     */</span>
    ListenableFuture&lt;ProductDetailDTO&gt; <span class="hljs-title function_">getProductDetail</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String productId)</span> {
        <span class="hljs-comment">// 步骤1：Fan-Out 并行查询</span>
        ListenableFuture&lt;Product&gt; productFuture = executor.submit(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;Product&gt;() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-keyword">return</span> productService.getProduct(productId);
                }
            }
        );
        
        ListenableFuture&lt;Inventory&gt; inventoryFuture = executor.submit(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;Inventory&gt;() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> Inventory <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-keyword">return</span> inventoryService.getInventory(productId);
                }
            }
        );
        
        <span class="hljs-comment">// 步骤2：Fan-In 汇总结果</span>
        <span class="hljs-comment">// whenAllSucceed：只有两个 Future 都成功，才执行 call 里的逻辑</span>
        <span class="hljs-keyword">return</span> Futures.whenAllSucceed(productFuture, inventoryFuture)
            .call(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;ProductDetailDTO&gt;() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> ProductDetailDTO <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-comment">// getDone：安全获取已完成的 Future 结果</span>
                    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> Futures.getDone(productFuture);
                    <span class="hljs-type">Inventory</span> <span class="hljs-variable">inventory</span> <span class="hljs-operator">=</span> Futures.getDone(inventoryFuture);
                    
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetailDTO</span>(
                        product.getId(),
                        product.getName(),
                        product.getPriceInCents(),
                        inventory.getQuantity()
                    );
                }
            }, executor);
    }
}
</code></pre>
<p>关键点：</p>
<ol>
<li><strong><code>executor.submit(Callable)</code></strong>：提交任务到线程池异步执行，立即返回 <code>ListenableFuture</code></li>
<li><strong><code>Futures.whenAllSucceed(f1, f2)</code></strong>：等待所有 Future 都成功完成，任何一个失败整体就失败</li>
<li><strong><code>Futures.getDone(future)</code></strong>：安全获取已完成的结果，因为 <code>whenAllSucceed</code> 保证了成功</li>
</ol>
<h3 data-id="heading-9">程序入口</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 创建线程池</span>
    <span class="hljs-type">ListeningExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> MoreExecutors.listeningDecorator(
        Executors.newFixedThreadPool(<span class="hljs-number">4</span>)
    );
    
    <span class="hljs-comment">// 初始化服务</span>
    <span class="hljs-type">ProductService</span> <span class="hljs-variable">productService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductService</span>();
    <span class="hljs-type">InventoryService</span> <span class="hljs-variable">inventoryService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryService</span>();
    <span class="hljs-type">ProductFacade</span> <span class="hljs-variable">facade</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductFacade</span>(
        productService, inventoryService, executor
    );
    
    <span class="hljs-type">String</span> <span class="hljs-variable">productId</span> <span class="hljs-operator">=</span> <span class="hljs-string">"P123"</span>;
    <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();
    
    <span class="hljs-comment">// 发起并行查询</span>
    ListenableFuture&lt;ProductDetailDTO&gt; future = facade.getProductDetail(productId);
    
    <span class="hljs-comment">// 阻塞等待结果（Demo 演示用，实际 Web 场景可以用回调异步处理）</span>
    <span class="hljs-type">ProductDetailDTO</span> <span class="hljs-variable">dto</span> <span class="hljs-operator">=</span> future.get();
    
    <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.nanoTime();
    <span class="hljs-type">long</span> <span class="hljs-variable">costMillis</span> <span class="hljs-operator">=</span> (end - start) / <span class="hljs-number">1_000_000L</span>;
    
    System.out.println(<span class="hljs-string">"Result = "</span> + dto);
    System.out.println(<span class="hljs-string">"Cost   = "</span> + costMillis + <span class="hljs-string">" ms"</span>);
    
    executor.shutdown();
}
</code></pre>
<p>执行结果：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Result</span> = ProductDetailDTO{productId=<span class="hljs-string">'P123'</span>, name=<span class="hljs-string">'MacBook Pro 14'</span>, priceInCents=<span class="hljs-number">149900</span>, quantity=<span class="hljs-number">42</span>}
<span class="hljs-attr">Cost</span>   = <span class="hljs-number">85</span> ms
</code></pre>
<hr/>
<h2 data-id="heading-10">四、执行流程</h2>
<h3 data-id="heading-11">时序图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant C as Controller
    participant F as ProductFacade
    participant E as 线程池
    participant PS as ProductService
    participant IS as InventoryService
    
    C-&gt;&gt;F: getProductDetail(&amp;#34;P123&amp;#34;)
    F-&gt;&gt;E: submit(查商品)
    F-&gt;&gt;E: submit(查库存)
    
    par 并行执行
        E-&gt;&gt;PS: getProduct(&amp;#34;P123&amp;#34;)
        PS--&gt;&gt;E: Product(80ms)
    and
        E-&gt;&gt;IS: getInventory(&amp;#34;P123&amp;#34;)
        IS--&gt;&gt;E: Inventory(60ms)
    end
    
    E-&gt;&gt;F: 两个结果都完成
    F-&gt;&gt;F: 组装 ProductDetailDTO
    F--&gt;&gt;C: 返回结果(~85ms)
</code></pre>
<h3 data-id="heading-12">Fan-Out / Fan-In 模式</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[请求] --&gt; B[Fan-Out]
    B --&gt; C[任务1]
    B --&gt; D[任务2]
    C --&gt; E[Fan-In]
    D --&gt; E
    E --&gt; F[结果]
    
    style B fill:#e1f5ff
    style E fill:#fff4e1
</code></pre>
<p>这是并发编程的经典模式：</p>
<ul>
<li><strong>Fan-Out</strong>：将一个任务拆分成多个并行子任务</li>
<li><strong>Fan-In</strong>：等待所有子任务完成后汇总结果</li>
</ul>
<hr/>
<h2 data-id="heading-13">五、与 Elasticsearch 的对比</h2>
<h3 data-id="heading-14">ES 的场景：多索引并行查询</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[搜索请求] --&gt; B[logs-2024-01]
    A --&gt; C[logs-2024-02]
    A --&gt; D[logs-2024-03]
    B --&gt; E[合并排序]
    C --&gt; E
    D --&gt; E
    E --&gt; F[Top 10]
</code></pre>
<h3 data-id="heading-15">电商场景：多服务并行查询</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[详情请求] --&gt; B[商品服务]
    A --&gt; C[库存服务]
    B --&gt; D[简单组装]
    C --&gt; D
    D --&gt; E[返回DTO]
</code></pre>
<h3 data-id="heading-16">共同点</h3>






























<table><thead><tr><th>维度</th><th>Elasticsearch</th><th>电商商品详情</th></tr></thead><tbody><tr><td>模式</td><td>Fan-Out / Fan-In</td><td>Fan-Out / Fan-In</td></tr><tr><td>并行目标</td><td>多个索引/分片</td><td>多个微服务</td></tr><tr><td>汇总方式</td><td>合并排序</td><td>简单组装</td></tr><tr><td>核心诉求</td><td>正确性 + 性能</td><td>响应时间</td></tr></tbody></table>
<p>虽然场景不同，但底层思想一致：</p>
<ol>
<li><strong>分解</strong>：把大任务拆成多个独立小任务</li>
<li><strong>并行</strong>：利用线程池同时执行</li>
<li><strong>汇总</strong>：等待全部完成后组装结果</li>
</ol>
<hr/>
<h2 data-id="heading-17">六、更多应用场景</h2>
<h3 data-id="heading-18">订单详情页</h3>
<pre><code class="hljs language-java" lang="java">ListenableFuture&lt;Order&gt; orderFuture = getOrder(orderId);
ListenableFuture&lt;User&gt; userFuture = getUser(userId);
ListenableFuture&lt;List&lt;OrderItem&gt;&gt; itemsFuture = getOrderItems(orderId);
ListenableFuture&lt;Logistics&gt; logisticsFuture = getLogistics(orderId);

<span class="hljs-keyword">return</span> Futures.whenAllSucceed(orderFuture, userFuture, itemsFuture, logisticsFuture)
    .call(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDetailDTO</span>(...), executor);
</code></pre>
<h3 data-id="heading-19">用户个人中心</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 并行查询：用户信息、订单统计、优惠券、积分</span>
ListenableFuture&lt;UserInfo&gt; userFuture = getUserInfo(userId);
ListenableFuture&lt;OrderStats&gt; statsFuture = getOrderStats(userId);
ListenableFuture&lt;List&lt;Coupon&gt;&gt; couponFuture = getCoupons(userId);
ListenableFuture&lt;Points&gt; pointsFuture = getPoints(userId);

<span class="hljs-keyword">return</span> Futures.whenAllSucceed(userFuture, statsFuture, couponFuture, pointsFuture)
    .call(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserCenterVO</span>(...), executor);
</code></pre>
<h3 data-id="heading-20">数据报表</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 并行查询：销售数据、用户数据、库存数据</span>
ListenableFuture&lt;SalesData&gt; salesFuture = getSalesData(startDate, endDate);
ListenableFuture&lt;UserData&gt; userDataFuture = getUserData(startDate, endDate);
ListenableFuture&lt;InventoryData&gt; inventoryFuture = getInventoryData();

<span class="hljs-keyword">return</span> Futures.whenAllSucceed(salesFuture, userDataFuture, inventoryFuture)
    .call(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReportVO</span>(...), executor);
</code></pre>
<hr/>
<h2 data-id="heading-21">七、异常处理与降级</h2>
<h3 data-id="heading-22">单个服务降级</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 Futures.catching 处理异常</span>
ListenableFuture&lt;Product&gt; productWithFallback = Futures.catching(
    productFuture,
    Exception.class,
    ex -&gt; {
        log.error(<span class="hljs-string">"查询商品失败，使用默认值"</span>, ex);
        <span class="hljs-keyword">return</span> getDefaultProduct(productId);
    },
    executor
);
</code></pre>
<h3 data-id="heading-23">超时控制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 Futures.withTimeout 添加超时</span>
ListenableFuture&lt;Product&gt; productFuture = Futures.withTimeout(
    executor.submit(() -&gt; productService.getProduct(id)),
    <span class="hljs-number">2</span>, TimeUnit.SECONDS,
    scheduledExecutor  <span class="hljs-comment">// 需要一个 ScheduledExecutorService</span>
);
</code></pre>
<h3 data-id="heading-24">部分失败允许</h3>
<p>如果允许部分查询失败，可以使用 <code>Futures.successfulAsList()</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 即使部分失败，也返回成功的结果（失败的为 null）</span>
ListenableFuture&lt;List&lt;Object&gt;&gt; results = Futures.successfulAsList(
    productFuture, 
    inventoryFuture
);

<span class="hljs-keyword">return</span> Futures.transform(results, list -&gt; {
    <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> (Product) list.get(<span class="hljs-number">0</span>);
    <span class="hljs-type">Inventory</span> <span class="hljs-variable">inventory</span> <span class="hljs-operator">=</span> (Inventory) list.get(<span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 处理可能为 null 的情况</span>
    <span class="hljs-keyword">if</span> (product == <span class="hljs-literal">null</span>) product = getDefaultProduct();
    <span class="hljs-keyword">if</span> (inventory == <span class="hljs-literal">null</span>) inventory = getDefaultInventory();
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDetailDTO</span>(...);
}, executor);
</code></pre>
<hr/>
<h2 data-id="heading-25">八、生产环境配置建议</h2>
<h3 data-id="heading-26">线程池配置</h3>
<p>基于 ES 的经验（详见我的上一篇文章），推荐配置：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">processors</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();

<span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
    processors,                          <span class="hljs-comment">// 核心线程数 = CPU 核心数</span>
    processors * <span class="hljs-number">2</span>,                      <span class="hljs-comment">// 最大线程数（IO 密集型）</span>
    <span class="hljs-number">60</span>, TimeUnit.SECONDS,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">256</span> * processors * <span class="hljs-number">2</span>),  <span class="hljs-comment">// 有理论依据的队列大小</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryBuilder</span>()
        .setNameFormat(<span class="hljs-string">"ProductQuery-%d"</span>)  <span class="hljs-comment">// 线程命名</span>
        .build(),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()  <span class="hljs-comment">// 业务系统用降级策略</span>
);

<span class="hljs-type">ListeningExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> MoreExecutors.listeningDecorator(threadPool);
</code></pre>
<h3 data-id="heading-27">Spring Bean 配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExecutorConfig</span> {
    
    <span class="hljs-meta">@Bean("productQueryExecutor")</span>
    <span class="hljs-keyword">public</span> ListeningExecutorService <span class="hljs-title function_">productQueryExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">processors</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();
        
        <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">threadPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
            processors,
            processors * <span class="hljs-number">2</span>,
            <span class="hljs-number">60</span>, TimeUnit.SECONDS,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">256</span> * processors * <span class="hljs-number">2</span>),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryBuilder</span>()
                .setNameFormat(<span class="hljs-string">"ProductQuery-%d"</span>)
                .build(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()
        );
        
        <span class="hljs-keyword">return</span> MoreExecutors.listeningDecorator(threadPool);
    }
}
</code></pre>
<h3 data-id="heading-28">监控指标</h3>
<p>关键监控点：</p>
<ul>
<li><strong>活跃线程数</strong>：当前正在执行任务的线程数</li>
<li><strong>队列大小</strong>：等待执行的任务数</li>
<li><strong>拒绝次数</strong>：线程池满了被拒绝的任务数</li>
<li><strong>平均执行时间</strong>：任务的平均耗时</li>
</ul>
<p>告警阈值：</p>
<ul>
<li>队列堆积 &gt; 最大线程数 × 100：可能有慢查询</li>
<li>拒绝次数突增：流量超过处理能力</li>
<li>活跃线程数长期 = 最大线程数：需要扩容</li>
</ul>
<hr/>
<h2 data-id="heading-29">九、何时使用并发</h2>
<h3 data-id="heading-30">适合的场景</h3>
<ol>
<li><strong>多个独立的 IO 操作</strong>：查询多个数据表、调用多个外部 API</li>
<li><strong>操作之间无依赖</strong>：查商品和查评论没有先后顺序</li>
<li><strong>对响应时间敏感</strong>：用户等待的接口</li>
</ol>
<h3 data-id="heading-31">不适合的场景</h3>
<ol>
<li><strong>有依赖关系的操作</strong>：第二步依赖第一步的结果（应该用 <code>transformAsync</code>）</li>
<li><strong>需要事务一致性</strong>：扣库存和创建订单必须在同一事务</li>
<li><strong>纯 CPU 密集计算</strong>：应该用 <code>ParallelStream</code> 或 <code>ForkJoinPool</code></li>
<li><strong>需要消息可靠性保证</strong>：用 MQ（RabbitMQ、RocketMQ）</li>
</ol>
<hr/>
<h2 data-id="heading-32">十、总结</h2>
<h3 data-id="heading-33">核心收获</h3>
<ol>
<li>
<p><strong>Guava ListenableFuture 比 CompletableFuture 更清晰</strong></p>
<ul>
<li><code>whenAllSucceed</code> 语义明确</li>
<li><code>getDone</code> 类型安全</li>
<li>职责分离，代码可读性强</li>
</ul>
</li>
<li>
<p><strong>Fan-Out / Fan-In 是通用模式</strong></p>
<ul>
<li>ES 用于多索引查询</li>
<li>业务系统用于多服务聚合</li>
<li>底层思想一致</li>
</ul>
</li>
<li>
<p><strong>线程池配置有理论依据</strong></p>
<ul>
<li>核心线程数 = CPU 核心数</li>
<li>最大线程数 = CPU 核心数 × 2（IO 密集型）</li>
<li>队列大小 = 256 × 最大线程数</li>
</ul>
</li>
</ol>
<h3 data-id="heading-34">实践建议</h3>
<ol>
<li><strong>从简单场景开始</strong>：先用在商品详情这类典型场景</li>
<li><strong>加强监控</strong>：关注线程池状态和任务执行时间</li>
<li><strong>做好降级</strong>：考虑异常和超时情况</li>
<li><strong>压测验证</strong>：用真实流量验证配置合理性</li>
</ol>
<p>这套模式可以作为你以后所有"多服务并行查询 + 聚合返回"场景的模板：代码清晰、思路简单、足够贴近真实业务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Laravel Workflow 作为 MCP 工具提供给 AI 客户端]]></title>    <link>https://juejin.cn/post/7586500093844733994</link>    <guid>https://juejin.cn/post/7586500093844733994</guid>    <pubDate>2025-12-23T01:02:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586500093844733994" data-draft-id="7586555198115348486" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Laravel Workflow 作为 MCP 工具提供给 AI 客户端"/> <meta itemprop="keywords" content="Laravel,PHP,后端"/> <meta itemprop="datePublished" content="2025-12-23T01:02:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Laravel Workflow 作为 MCP 工具提供给 AI 客户端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:02:52.000Z" title="Tue Dec 23 2025 01:02:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="arduino-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#434f54}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#00979d}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code,.hljs-literal{color:#d35400}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#00979d}.hljs-deletion,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#005c5f}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-comment{color:rgba(149,165,166,.8)}.hljs-meta-keyword{color:#728e00}.hljs-meta{color:#434f54}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-function{color:#728e00}.hljs-number{color:#8a7b52}</style><h2 data-id="heading-0">使用 Laravel Workflow 作为 MCP 工具提供给 AI 客户端</h2>
<p><code>Model Context Protocol</code> (MCP) 正在迅速成为 AI 助手(如 Claude、ChatGPT 和 GitHub Copilot)与外部工具和服务交互的标准方式。通过 Laravel MCP,你可以将 Laravel Workflow 流程暴露为可调用的工具,任何兼容 MCP 的 AI 客户端都可以发现、调用和监控这些工具。</p>
<p>在本文中,我们将展示如何构建一个 MCP 服务器,使 AI 客户端能够:</p>
<ul>
<li>发现可用的工作流</li>
<li>异步启动工作流</li>
<li>轮询状态并检索结果</li>
</ul>
<p>这创建了一个强大的模式,AI 代理可以编排长时间运行的持久化工作流,非常适合无法在单个请求中完成的复杂任务。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Flaravel-workflows-mcp-tools-ai-clients" target="_blank" title="https://catchadmin.com/post/2025-12/laravel-workflows-mcp-tools-ai-clients" ref="nofollow noopener noreferrer">原文链接 使用 Laravel Workflow 作为 MCP 工具提供给 AI 客户端</a></p>
<h3 data-id="heading-1">为什么选择 MCP + Laravel Workflow?</h3>
<p>Laravel Workflow 擅长持久化、有状态的执行。MCP 擅长为 AI 客户端提供对外部能力的结构化访问。两者结合可以实现:</p>
<ul>
<li><strong>异步 AI 操作</strong>:启动工作流,继续对话,稍后检查结果</li>
<li><strong>可靠执行</strong>:工作流可以在崩溃、重试和长时间等待中存活</li>
<li><strong>可观察性</strong>:通过 Waterline 的仪表板跟踪每个工作流</li>
<li><strong>无状态服务器</strong>:MCP 服务器不保存状态。客户端跟踪工作流 ID</li>
</ul>
<p>这类似于人类委派任务的方式:"开始这个报告,我稍后再检查。"</p>
<h3 data-id="heading-2">我们要构建什么</h3>
<p>我们将创建一个包含三个工具的 MCP 服务器:</p>





















<table><thead><tr><th>工具</th><th>用途</th></tr></thead><tbody><tr><td>list_workflows</td><td>发现可用的工作流并查看最近的运行记录</td></tr><tr><td>start_workflow</td><td>启动工作流并获取跟踪 ID</td></tr><tr><td>get_workflow_result</td><td>检查状态并在完成时检索输出</td></tr></tbody></table>
<h3 data-id="heading-3">分步实现</h3>
<h4 data-id="heading-4">安装 Laravel MCP</h4>
<pre><code class="hljs language-bash" lang="bash">composer require laravel/mcp
php artisan vendor:publish --tag=ai-routes
</code></pre>
<p>这会为你提供 <code>routes/ai.php</code>,你将在其中注册 MCP 服务器。</p>
<h4 data-id="heading-5">创建 MCP 服务器</h4>
<pre><code class="hljs language-bash" lang="bash">php artisan make:mcp-server WorkflowServer
</code></pre>
<p>为 AI 配置说明:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Mcp</span>\<span class="hljs-title class_">Servers</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Tools</span>\<span class="hljs-title">GetWorkflowResultTool</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Tools</span>\<span class="hljs-title">ListWorkflowsTool</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Tools</span>\<span class="hljs-title">StartWorkflowTool</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Server</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WorkflowServer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Server</span>
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">'Laravel Workflow Server'</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$version</span> = <span class="hljs-string">'1.0.0'</span>;

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$instructions</span> = &lt;&lt;&lt;<span class="hljs-string">'MARKDOWN'</span>
        This server allows you to start <span class="hljs-keyword">and</span> monitor Laravel Workflows.

        <span class="hljs-comment">## Typical Usage Pattern</span>

        <span class="hljs-number">1</span>. Call `list_workflows` to see what workflows are available.
        <span class="hljs-number">2</span>. Call `start_workflow` with the workflow name <span class="hljs-keyword">and</span> arguments.
        <span class="hljs-number">3</span>. Store the returned `workflow_id`.
        <span class="hljs-number">4</span>. Call `get_workflow_result` until status is `WorkflowCompletedStatus`.
        <span class="hljs-number">5</span>. Read the `output` field <span class="hljs-keyword">for</span> the result.

        <span class="hljs-comment">## Status Values</span>

        - `WorkflowCreatedStatus` - Workflow has been created
        - `WorkflowPendingStatus` - Queued <span class="hljs-keyword">for</span> execution
        - `WorkflowRunningStatus` - Currently executing
        - `WorkflowWaitingStatus` - <span class="hljs-title function_ invoke__">Waiting</span> (timer, signal, etc.)
        - `WorkflowCompletedStatus` - Finished successfully
        - `WorkflowFailedStatus` - Encountered an error
    MARKDOWN;

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">array</span> <span class="hljs-variable">$tools</span> = [
        <span class="hljs-title class_">ListWorkflowsTool</span>::<span class="hljs-variable language_">class</span>,
        <span class="hljs-title class_">StartWorkflowTool</span>::<span class="hljs-variable language_">class</span>,
        <span class="hljs-title class_">GetWorkflowResultTool</span>::<span class="hljs-variable language_">class</span>,
    ];
}
</code></pre>
<h4 data-id="heading-6">创建启动工作流工具</h4>
<pre><code class="hljs language-bash" lang="bash">php artisan make:mcp-tool StartWorkflowTool
</code></pre>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Mcp</span>\<span class="hljs-title class_">Tools</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">JsonSchema</span>\<span class="hljs-title">JsonSchema</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Arr</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Response</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Server</span>\<span class="hljs-title">Tool</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Workflow</span>\<span class="hljs-title">Workflow</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Workflow</span>\<span class="hljs-title">WorkflowStub</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StartWorkflowTool</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Tool</span>
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$description</span> = &lt;&lt;&lt;<span class="hljs-string">'MARKDOWN'</span>
        Start a Laravel Workflow asynchronously <span class="hljs-keyword">and</span> <span class="hljs-keyword">return</span> its workflow ID.
        
        The workflow will execute in the background on the queue. Use the
        `get_workflow_result` tool to poll <span class="hljs-keyword">for</span> status <span class="hljs-keyword">and</span> retrieve results
        once the workflow completes.
    MARKDOWN;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-variable">$data</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">validate</span>([
            <span class="hljs-string">'workflow'</span> =&gt; [<span class="hljs-string">'required'</span>, <span class="hljs-string">'string'</span>],
            <span class="hljs-string">'args'</span> =&gt; [<span class="hljs-string">'nullable'</span>, <span class="hljs-string">'array'</span>],
            <span class="hljs-string">'external_id'</span> =&gt; [<span class="hljs-string">'nullable'</span>, <span class="hljs-string">'string'</span>, <span class="hljs-string">'max:255'</span>],
        ]);

        <span class="hljs-variable">$workflowKey</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">'workflow'</span>];
        <span class="hljs-variable">$args</span> = <span class="hljs-title class_">Arr</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$data</span>, <span class="hljs-string">'args'</span>, []);
        <span class="hljs-variable">$externalId</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">'external_id'</span>] ?? <span class="hljs-literal">null</span>;

        <span class="hljs-variable">$workflowClass</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">resolveWorkflowClass</span>(<span class="hljs-variable">$workflowKey</span>);

        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$workflowClass</span> === <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>::<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-string">"Unknown workflow: <span class="hljs-subst">{$workflowKey}</span>"</span>);
        }

        <span class="hljs-keyword">if</span> (! <span class="hljs-title function_ invoke__">class_exists</span>(<span class="hljs-variable">$workflowClass</span>) || ! <span class="hljs-title function_ invoke__">is_subclass_of</span>(<span class="hljs-variable">$workflowClass</span>, <span class="hljs-title class_">Workflow</span>::<span class="hljs-variable language_">class</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>::<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-string">"Invalid workflow class: <span class="hljs-subst">{$workflowClass}</span>"</span>);
        }

        <span class="hljs-variable">$stub</span> = <span class="hljs-title class_">WorkflowStub</span>::<span class="hljs-title function_ invoke__">make</span>(<span class="hljs-variable">$workflowClass</span>);
        <span class="hljs-variable">$stub</span>-&gt;<span class="hljs-title function_ invoke__">start</span>(...<span class="hljs-title function_ invoke__">array_values</span>(<span class="hljs-variable">$args</span>));

        <span class="hljs-variable">$status</span> = <span class="hljs-variable">$stub</span>-&gt;<span class="hljs-title function_ invoke__">status</span>();
        <span class="hljs-variable">$statusName</span> = <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$status</span>) ? <span class="hljs-title function_ invoke__">class_basename</span>(<span class="hljs-variable">$status</span>) : <span class="hljs-title function_ invoke__">class_basename</span>((<span class="hljs-keyword">string</span>) <span class="hljs-variable">$status</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>::<span class="hljs-title function_ invoke__">json</span>([
            <span class="hljs-string">'workflow_id'</span> =&gt; <span class="hljs-variable">$stub</span>-&gt;<span class="hljs-title function_ invoke__">id</span>(),
            <span class="hljs-string">'workflow'</span> =&gt; <span class="hljs-variable">$workflowKey</span>,
            <span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$statusName</span>,
            <span class="hljs-string">'external_id'</span> =&gt; <span class="hljs-variable">$externalId</span>,
            <span class="hljs-string">'message'</span> =&gt; <span class="hljs-string">'Workflow started. Use get_workflow_result to poll status.'</span>,
        ]);
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolveWorkflowClass</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$key</span></span>): ?<span class="hljs-title">string</span>
    </span>{
        <span class="hljs-variable">$mapped</span> = <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">"workflow_mcp.workflows.<span class="hljs-subst">{$key}</span>"</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$mapped</span> !== <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$mapped</span>;
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'workflow_mcp.allow_fqcn'</span>, <span class="hljs-literal">false</span>) &amp;&amp; <span class="hljs-title function_ invoke__">str_contains</span>(<span class="hljs-variable">$key</span>, <span class="hljs-string">'\\'</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$key</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">schema</span>(<span class="hljs-params">JsonSchema <span class="hljs-variable">$schema</span></span>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-variable">$workflows</span> = <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">', '</span>, <span class="hljs-title function_ invoke__">array_keys</span>(<span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'workflow_mcp.workflows'</span>, [])));

        <span class="hljs-keyword">return</span> [
            <span class="hljs-string">'workflow'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">string</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">"The workflow to start. Available: <span class="hljs-subst">{$workflows}</span>"</span>),
            <span class="hljs-string">'args'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">object</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">'Arguments for the workflow execute() method.'</span>),
            <span class="hljs-string">'external_id'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">string</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">'Optional idempotency key for tracking.'</span>),
        ];
    }
}
</code></pre>
<h4 data-id="heading-7">创建获取结果工具</h4>
<pre><code class="hljs language-bash" lang="bash">php artisan make:mcp-tool GetWorkflowResultTool
</code></pre>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Mcp</span>\<span class="hljs-title class_">Tools</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Models</span>\<span class="hljs-title">StoredWorkflow</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">JsonSchema</span>\<span class="hljs-title">JsonSchema</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Response</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Server</span>\<span class="hljs-title">Tool</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Workflow</span>\<span class="hljs-title">States</span>\<span class="hljs-title">WorkflowCompletedStatus</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Workflow</span>\<span class="hljs-title">States</span>\<span class="hljs-title">WorkflowFailedStatus</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Workflow</span>\<span class="hljs-title">WorkflowStub</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetWorkflowResultTool</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Tool</span>
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$description</span> = &lt;&lt;&lt;<span class="hljs-string">'MARKDOWN'</span>
        Fetch the status <span class="hljs-keyword">and</span>, <span class="hljs-keyword">if</span> completed, the output of a Laravel Workflow.
        
        Use the workflow_id returned by `start_workflow` to check progress.
        Once status is `WorkflowCompletedStatus`, the output field contains the result.
    MARKDOWN;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-variable">$data</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">validate</span>([
            <span class="hljs-string">'workflow_id'</span> =&gt; [<span class="hljs-string">'required'</span>],
        ]);

        <span class="hljs-variable">$workflowId</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">'workflow_id'</span>];
        <span class="hljs-variable">$stored</span> = <span class="hljs-title class_">StoredWorkflow</span>::<span class="hljs-title function_ invoke__">find</span>(<span class="hljs-variable">$workflowId</span>);

        <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$stored</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>::<span class="hljs-title function_ invoke__">json</span>([
                <span class="hljs-string">'found'</span> =&gt; <span class="hljs-literal">false</span>,
                <span class="hljs-string">'message'</span> =&gt; <span class="hljs-string">"Workflow <span class="hljs-subst">{$workflowId}</span> not found."</span>,
            ]);
        }

        <span class="hljs-variable">$workflow</span> = <span class="hljs-title class_">WorkflowStub</span>::<span class="hljs-title function_ invoke__">load</span>(<span class="hljs-variable">$workflowId</span>);
        <span class="hljs-variable">$status</span> = <span class="hljs-variable">$workflow</span>-&gt;<span class="hljs-title function_ invoke__">status</span>();
        <span class="hljs-variable">$statusName</span> = <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$status</span>) ? <span class="hljs-title function_ invoke__">class_basename</span>(<span class="hljs-variable">$status</span>) : <span class="hljs-title function_ invoke__">class_basename</span>((<span class="hljs-keyword">string</span>) <span class="hljs-variable">$status</span>);
        <span class="hljs-variable">$running</span> = <span class="hljs-variable">$workflow</span>-&gt;<span class="hljs-title function_ invoke__">running</span>();

        <span class="hljs-variable">$result</span> = <span class="hljs-literal">null</span>;
        <span class="hljs-variable">$error</span> = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$running</span> &amp;&amp; <span class="hljs-title function_ invoke__">str_contains</span>(<span class="hljs-variable">$statusName</span>, <span class="hljs-string">'Completed'</span>)) {
            <span class="hljs-variable">$result</span> = <span class="hljs-variable">$workflow</span>-&gt;<span class="hljs-title function_ invoke__">output</span>();
        }

        <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$running</span> &amp;&amp; <span class="hljs-title function_ invoke__">str_contains</span>(<span class="hljs-variable">$statusName</span>, <span class="hljs-string">'Failed'</span>)) {
            <span class="hljs-variable">$exception</span> = <span class="hljs-variable">$stored</span>-&gt;<span class="hljs-title function_ invoke__">exceptions</span>()-&gt;<span class="hljs-title function_ invoke__">latest</span>()-&gt;<span class="hljs-title function_ invoke__">first</span>();
            <span class="hljs-variable">$error</span> = <span class="hljs-variable">$exception</span>?-&gt;exception ?? <span class="hljs-string">'Unknown error'</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>::<span class="hljs-title function_ invoke__">json</span>([
            <span class="hljs-string">'found'</span> =&gt; <span class="hljs-literal">true</span>,
            <span class="hljs-string">'workflow_id'</span> =&gt; <span class="hljs-variable">$workflowId</span>,
            <span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$statusName</span>,
            <span class="hljs-string">'running'</span> =&gt; <span class="hljs-variable">$running</span>,
            <span class="hljs-string">'output'</span> =&gt; <span class="hljs-variable">$result</span>,
            <span class="hljs-string">'error'</span> =&gt; <span class="hljs-variable">$error</span>,
            <span class="hljs-string">'created_at'</span> =&gt; <span class="hljs-variable">$stored</span>-&gt;created_at?-&gt;<span class="hljs-title function_ invoke__">toIso8601String</span>(),
            <span class="hljs-string">'updated_at'</span> =&gt; <span class="hljs-variable">$stored</span>-&gt;updated_at?-&gt;<span class="hljs-title function_ invoke__">toIso8601String</span>(),
        ]);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">schema</span>(<span class="hljs-params">JsonSchema <span class="hljs-variable">$schema</span></span>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-keyword">return</span> [
            <span class="hljs-string">'workflow_id'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">string</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">'The workflow ID returned by start_workflow.'</span>),
        ];
    }
}
</code></pre>
<h4 data-id="heading-8">创建列表工作流工具</h4>
<pre><code class="hljs language-bash" lang="bash">php artisan make:mcp-tool ListWorkflowsTool
</code></pre>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Mcp</span>\<span class="hljs-title class_">Tools</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Models</span>\<span class="hljs-title">StoredWorkflow</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">JsonSchema</span>\<span class="hljs-title">JsonSchema</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Response</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Server</span>\<span class="hljs-title">Tool</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ListWorkflowsTool</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Tool</span>
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$description</span> = &lt;&lt;&lt;<span class="hljs-string">'MARKDOWN'</span>
        List available workflow types <span class="hljs-keyword">and</span> optionally show recent workflow runs.
        
        Use this to discover what workflows can be started, <span class="hljs-keyword">or</span> to see
        the status of recent executions.
    MARKDOWN;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-variable">$data</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">validate</span>([
            <span class="hljs-string">'show_recent'</span> =&gt; [<span class="hljs-string">'nullable'</span>, <span class="hljs-string">'boolean'</span>],
            <span class="hljs-string">'limit'</span> =&gt; [<span class="hljs-string">'nullable'</span>, <span class="hljs-string">'integer'</span>, <span class="hljs-string">'min:1'</span>, <span class="hljs-string">'max:50'</span>],
            <span class="hljs-string">'status'</span> =&gt; [<span class="hljs-string">'nullable'</span>, <span class="hljs-string">'string'</span>],
        ]);

        <span class="hljs-variable">$showRecent</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">'show_recent'</span>] ?? <span class="hljs-literal">false</span>;
        <span class="hljs-variable">$limit</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">'limit'</span>] ?? <span class="hljs-number">10</span>;
        <span class="hljs-variable">$statusFilter</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">'status'</span>] ?? <span class="hljs-literal">null</span>;

        <span class="hljs-variable">$availableWorkflows</span> = [];
        <span class="hljs-keyword">foreach</span> (<span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'workflow_mcp.workflows'</span>, []) <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$class</span>) {
            <span class="hljs-variable">$availableWorkflows</span>[] = [<span class="hljs-string">'key'</span> =&gt; <span class="hljs-variable">$key</span>, <span class="hljs-string">'class'</span> =&gt; <span class="hljs-variable">$class</span>];
        }

        <span class="hljs-variable">$response</span> = [
            <span class="hljs-string">'available_workflows'</span> =&gt; <span class="hljs-variable">$availableWorkflows</span>,
        ];

        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$showRecent</span>) {
            <span class="hljs-variable">$query</span> = <span class="hljs-title class_">StoredWorkflow</span>::<span class="hljs-title function_ invoke__">query</span>()
                -&gt;<span class="hljs-title function_ invoke__">orderBy</span>(<span class="hljs-string">'created_at'</span>, <span class="hljs-string">'desc'</span>)
                -&gt;<span class="hljs-title function_ invoke__">limit</span>(<span class="hljs-variable">$limit</span>);

            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$statusFilter</span>) {
                <span class="hljs-variable">$query</span>-&gt;<span class="hljs-title function_ invoke__">where</span>(<span class="hljs-string">'status'</span>, <span class="hljs-string">'like'</span>, <span class="hljs-string">"%<span class="hljs-subst">{$statusFilter}</span>%"</span>);
            }

            <span class="hljs-variable">$response</span>[<span class="hljs-string">'recent_workflows'</span>] = <span class="hljs-variable">$query</span>-&gt;<span class="hljs-title function_ invoke__">get</span>()-&gt;<span class="hljs-title function_ invoke__">map</span>(function (<span class="hljs-variable">$w</span>) {
                <span class="hljs-variable">$status</span> = <span class="hljs-variable">$w</span>-&gt;status;
                <span class="hljs-variable">$statusName</span> = <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$status</span>) ? <span class="hljs-title function_ invoke__">class_basename</span>(<span class="hljs-variable">$status</span>) : <span class="hljs-title function_ invoke__">class_basename</span>((<span class="hljs-keyword">string</span>) <span class="hljs-variable">$status</span>);

                <span class="hljs-keyword">return</span> [
                    <span class="hljs-string">'id'</span> =&gt; <span class="hljs-variable">$w</span>-&gt;id,
                    <span class="hljs-string">'class'</span> =&gt; <span class="hljs-variable">$w</span>-&gt;<span class="hljs-class"><span class="hljs-keyword">class</span>,
                    '<span class="hljs-title">status</span>' =&gt; $<span class="hljs-title">statusName</span>,
                    '<span class="hljs-title">created_at</span>' =&gt; $<span class="hljs-title">w</span>-&gt;<span class="hljs-title">created_at</span>?-&gt;<span class="hljs-title">toIso8601String</span>(),
                ];
            });
        }

        <span class="hljs-title">return</span> <span class="hljs-title">Response</span>::<span class="hljs-title">json</span>($<span class="hljs-title">response</span>);
    }

    <span class="hljs-title">public</span> <span class="hljs-title">function</span> <span class="hljs-title">schema</span>(<span class="hljs-title">JsonSchema</span> $<span class="hljs-title">schema</span>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-keyword">return</span> [
            <span class="hljs-string">'show_recent'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">boolean</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">'Include recent workflow runs in response.'</span>),
            <span class="hljs-string">'limit'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">integer</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">'Max recent workflows to return (default: 10).'</span>),
            <span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">string</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">'Filter by status (e.g., "Completed", "Failed").'</span>),
        ];
    }
}
</code></pre>
<h4 data-id="heading-9">配置可用的工作流</h4>
<p>创建 <code>config/workflow_mcp.php</code> 来将 AI 客户端可以启动的工作流加入白名单:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">return</span> [
    <span class="hljs-string">'allow_fqcn'</span> =&gt; <span class="hljs-title function_ invoke__">env</span>(<span class="hljs-string">'WORKFLOW_MCP_ALLOW_FQCN'</span>, <span class="hljs-literal">false</span>),

    <span class="hljs-string">'workflows'</span> =&gt; [
        <span class="hljs-string">'simple'</span> =&gt; <span class="hljs-title class_">App\Workflows\Simple\SimpleWorkflow</span>::<span class="hljs-variable language_">class</span>,
        <span class="hljs-string">'prism'</span> =&gt; <span class="hljs-title class_">App\Workflows\Prism\PrismWorkflow</span>::<span class="hljs-variable language_">class</span>,
    ],
];
</code></pre>
<p>这可以防止任意类执行。只有映射的工作流可以访问。</p>
<h4 data-id="heading-10">注册 MCP 服务器</h4>
<p>更新 <code>routes/ai.php</code>:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Servers</span>\<span class="hljs-title">WorkflowServer</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Mcp</span>;

<span class="hljs-title class_">Mcp</span>::<span class="hljs-title function_ invoke__">web</span>(<span class="hljs-string">'/mcp/workflows'</span>, <span class="hljs-title class_">WorkflowServer</span>::<span class="hljs-variable language_">class</span>);
</code></pre>
<h3 data-id="heading-11">连接 AI 客户端</h3>
<h4 data-id="heading-12">VS Code / GitHub Copilot</h4>
<p>在项目中创建 <code>.vscode/mcp.json</code>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"servers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"laravel-workflow"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost/mcp/workflows"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>此配置适用于本地开发和 GitHub Codespaces。在 Codespaces 中,VS Code 服务器在容器内运行,因此 localhost 可以正确访问 Laravel 服务器,无需公共端口或 <code>*.app.github.dev</code> URL。</p>
<p>重新加载 VS Code(Cmd/Ctrl+Shift+P → "Developer: Reload Window")后,Copilot 可以直接在聊天中使用工作流工具。</p>
<h3 data-id="heading-13">实际使用</h3>
<p>连接后,你可以与 AI 助手进行自然对话:</p>
<p><strong>你</strong>:"有哪些工作流可用?"</p>
<p><strong>AI</strong>:调用 <code>list_workflows</code> "我找到了 2 个工作流:simple 和 prism。"</p>
<p><strong>你</strong>:"启动 prism 工作流"</p>
<p><strong>AI</strong>:调用 <code>start_workflow</code> "已启动工作流 ID 42。我会检查它的状态。"</p>
<p><strong>AI</strong>:调用 <code>get_workflow_result</code> "工作流已完成!这是生成的用户配置文件:{ name: 'Elena', hobbies: [...] }"</p>
<p>这创造了一种无缝体验,AI 助手可以编排复杂的长时间运行的操作,同时让用户了解情况。</p>
<h3 data-id="heading-14">这种模式的强大之处</h3>
<ul>
<li><strong>持久化</strong>:工作流可以在服务器重启和网络故障中存活</li>
<li><strong>异步设计</strong>:AI 客户端不会阻塞等待完成</li>
<li><strong>可观察</strong>:每个工作流都在 Waterline 的仪表板中跟踪</li>
<li><strong>安全</strong>:基于白名单的工作流访问防止任意执行</li>
<li><strong>无状态 MCP</strong>:服务器不保存状态。客户端跟踪工作流 ID</li>
</ul>
<h3 data-id="heading-15">在浏览器中立即试用</h3>
<p>此 MCP 集成已包含并预配置在 Laravel Workflow Sample App 中。</p>
<p>要试用:</p>
<ol>
<li>在 GitHub 上打开 sample-app 仓库</li>
<li>点击 Code → Codespaces → Create codespace on main</li>
<li>等待环境构建</li>
<li>设置应用并启动队列工作器:</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">php artisan app:init
php artisan queue:work
</code></pre>
<ol start="5">
<li>启用 Laravel Workflow Server MCP 工具</li>
<li>让你的 AI 列出并运行工作流!</li>
</ol>
<h3 data-id="heading-16">接下来可以做什么</h3>
<p>你可以扩展此模式以实现:</p>
<ul>
<li><strong>参数化工作流</strong>:将用户输入传递给工作流参数</li>
<li><strong>Webhook 通知</strong>:推送完成事件而不是轮询</li>
<li><strong>工作流信号</strong>:让 AI 客户端向等待的工作流发送信号</li>
<li><strong>进度流式传输</strong>:使用 SSE 实时流式传输工作流进度</li>
<li><strong>多步骤代理</strong>:在对话中将多个工作流链接在一起</li>
</ul>
<p>Laravel Workflow 的持久化执行与 MCP 的工具协议相结合,为真正有能力的 AI 代理创建了一个基础,这些代理可以处理现实世界的复杂性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[京东金融鸿蒙端部署AI超分模型实践]]></title>    <link>https://juejin.cn/post/7586877892467277851</link>    <guid>https://juejin.cn/post/7586877892467277851</guid>    <pubDate>2025-12-23T10:11:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586877892467277851" data-draft-id="7586865729702920230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="京东金融鸿蒙端部署AI超分模型实践"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-23T10:11:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            京东金融鸿蒙端部署AI超分模型实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T10:11:17.000Z" title="Tue Dec 23 2025 10:11:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>1. 背景</strong></h2>
<p><strong>这可能是全网第一篇完整讲解鸿蒙端使用CANN部署AI模型的文章, 满满干货。</strong></p>
<p>社区作为用户交流、信息传递的核心载体，图片内容（如理财产品截图、投资经验分享配图、用户互动评论图片等）的展示质量直接影响用户的信息获取效率与平台信任感。从京东金融App社区的业务需求来看，当前用户上传图片普遍存在多样性失真问题：部分用户通过老旧设备拍摄的图片分辨率较低，部分用户为节省流量选择低画质压缩上传，还有部分截图类内容因原始来源清晰度不足导致信息模糊（如理财产品收益率数字、合同条款细节等），这些问题不仅降低了内容可读性，还可能因信息传递不清晰引发用户误解。</p>
<p>京东金融App团队已完成Real-ESRGAN-General-x4v3超分辨率模型在安卓端的部署，能够针对性提升评论区、内容详情页、个人主页等核心场景的图片清晰度，从视觉体验层面优化用户留存与互动意愿。</p>
<p>ESRGAN-General-x4v3模型在安卓端的部署，采用的是ONNX框架，该方案已有大量公开资料可参考，且取得显著业务成效。但鸿蒙端部署面临核心技术瓶颈：鸿蒙系统不支持ONNX框架，部署端侧AI仅能使用华为自研的CANN（Compute Architecture for Neural Networks）架构，且当前行业内缺乏基于CANN部署端侧AI的公开资料与成熟方案，全程需技术团队自主探索。接下来我会以ESRGAN-General-x4v3为例, 分享从模型转换(NPU亲和性改造)到端侧离线模型部署的全部过程。</p>
<h2 data-id="heading-1"><strong>2. 部署前期准备</strong></h2>
<h3 data-id="heading-2"><strong>2.1 离线模型转换</strong></h3>
<p>CANN Kit当前仅支持Caffe、TensorFlow、ONNX和MindSpore模型转换为离线模型，其他格式的模型需要开发者自行转换为CANN Kit支持的模型格式。模型转换为OM离线模型，移动端AI程序直接读取离线模型进行推理。</p>
<h4 data-id="heading-3"><strong>2.1.1 下载CANN工具</strong></h4>
<p>从鸿蒙开发者官网下载 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcontentcenter-vali-drcn.dbankcdn.cn%2Fpvt_2%2FDeveloperAlliance_package_901_9%2Fc0%2Fv3%2FEvg84kYpQlOkQvRT-Th0tw%2FDDK-tools-next-5.1.1.1.zip%3FHW-CC-KV%3DV1%26HW-CC-Date%3D20251015T082207Z%26HW-CC-Expire%3D315360000%26HW-CC-Sign%3D8D8CE92B39E6A5353B8A43EB6779C1D79C346C40776F2242593CBD751BE87EE4" target="_blank" title="https://contentcenter-vali-drcn.dbankcdn.cn/pvt_2/DeveloperAlliance_package_901_9/c0/v3/Evg84kYpQlOkQvRT-Th0tw/DDK-tools-next-5.1.1.1.zip?HW-CC-KV=V1&amp;HW-CC-Date=20251015T082207Z&amp;HW-CC-Expire=315360000&amp;HW-CC-Sign=8D8CE92B39E6A5353B8A43EB6779C1D79C346C40776F2242593CBD751BE87EE4" ref="nofollow noopener noreferrer">DDK-tools-5.1.1.1 </a>, 解压使用Tools下的OMG工具，将ONNX、TensorFlow模型转换为OM模型。(OMG工具位于Tools下载的tools/tools_omg下，<strong>仅可运行在64位Linux平台上</strong>。)</p>
<p>﻿</p>
<h4 data-id="heading-4"><strong>2.1.2 下载ESRGAN-General-x4v3模型文件</strong></h4>
<p>从<a href="https://link.juejin.cn?target=https%3A%2F%2Faihub.qualcomm.com%2Fcompute%2Fmodels%2Freal_esrgan_general_x4v3" target="_blank" title="https://aihub.qualcomm.com/compute/models/real_esrgan_general_x4v3" ref="nofollow noopener noreferrer">aihub.qualcomm.com/compute/mod…</a>下载模型的onnx文件.</p>
<p>注意: 下载链接中的a8a8的量化模型使用了高通的算子(亲测无法转换), CANN工具无法进行转换, 因此请下载float的量化模型。</p>
<p><strong>下载后有两个文件:</strong></p>
<p>•model.onnx文件 (模型结构): 包含计算图、opset版本、节点配置等，文件较小。</p>
<p>•model.data文件 (权重数据): 包含神经网络参数、权重等，文件较大。</p>
<p>现在我们需要把这种分离文件格式的模型合并成一个文件,后续的操作都使用这个。</p>
<p><strong>合并文件:</strong></p>
<p>请使用JoyCode写个合并脚本即可, 提示词: 请写一个脚本, 把onnx模型文件的.onnx和.data文件合并。</p>
<h4 data-id="heading-5"><strong>2.1.3 OM模型转换</strong></h4>
<p><strong>1. ONNX opset 版本转换</strong></p>
<p>当前使用CANN进行模型转换, 支持ONNX opset版本7~18（最高支持到V1.13.1）, 首先需要查看原始的onnx模型的opset版本是否在支持范围, 这里我们使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flutzroeder%2Fnetron%2Ftags" target="_blank" title="https://github.com/lutzroeder/netron/tags" ref="nofollow noopener noreferrer">Netron</a>(点击下载)可视化工具进行查看。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de53c34107d842da95851d71bc1915d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=GTZxPGBS3O3%2FeUQCZKdolPJZiyI%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>目前该模型使用的opset版本是20, 因此我们需要把该模型的opset版本转成18, 才可以用CANN转换成鸿蒙上可部署的模型。请使用JoyCode写个opset转换脚本即可, 提示词: 请写一个脚本, 把onnx模型文件的opset版本从20转换成18。</p>
<p>﻿</p>
<p><strong>2. OM离线模型</strong>****</p>
<p>命令行中的参数说明请参见<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fcannkit-overall-parameter" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/cannkit-overall-parameter" ref="nofollow noopener noreferrer">OMG参数</a>，转换命令：</p>
<pre><code class="hljs language-css" lang="css">./tools/tools_omg/omg <span class="hljs-attr">--model</span> new_model_opset18<span class="hljs-selector-class">.onnx</span> <span class="hljs-attr">--framework</span> <span class="hljs-number">5</span> <span class="hljs-attr">--output</span> ./model
</code></pre>
<p>转换完成后, 生成model.om的模型文件, 该模型文件就是鸿蒙上可以正常使用的模型文件</p>
<h3 data-id="heading-6"><strong>2.2 查看模型的输入/输出张量信息</strong></h3>
<p>部署AI模式时, 我们需要确认模型的输入张量和输出张量信息, 请使用JoyCode编写一个脚本, 确定输入输出张量信息, 提示词: 写一个脚本查看onnx模型的输入输出张量信息。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e07ceb9dcfc04f71a9cf179cf399ffb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=OaBgcmN8vLYLQUhTU0GiR1jqx6E%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h4 data-id="heading-7"><strong>2.2.1 输入张量</strong></h4>
<p>BCHW格式, 是深度学习中常见的张量维度排列格式, 在图像处理场景中:</p>
<p>•B (Batch): 批次大小 - 一次处理多少个样本。</p>
<p>•C (Channel): 通道数 - 图像的颜色通道数。</p>
<p>•H (Height): 高度 - 图像的像素高度。</p>
<p>•W (Width): 宽度 - 图像的像素宽度。</p>
<p>由此可以得出结论, 该模型1个批次处理1张宽高为128*128的RGB图片(因为C是3,因此不包含R通道)。</p>
<p>﻿</p>
<h4 data-id="heading-8"><strong>2.2.2 输出张量</strong></h4>
<p>该模型1个批次输出1张宽高为512*512的RGB图片。</p>
<p>﻿</p>
<h4 data-id="heading-9"><strong>2.2.3 BCHW和BHWC格式的区别:</strong></h4>
<p>超分模型中的BCHW和BHWC是两种不同的张量存储格式，主要区别在于通道维度的位置：</p>
<p>﻿</p>
<p>•<strong>BCHW格式（Batch-Channel-Height-Width）</strong></p>
<p>◦维度顺序：[批次, 通道, 高度, 宽度]</p>
<p>◦内存布局：通道维度在空间维度之前</p>
<p>◦常用框架：PyTorch、TensorRT等</p>
<p>示例: 形状为 (1, 3, 256, 256) 的RGB图像</p>
<p><strong>内存中的存储顺序：</strong> R通道的所有像素 -&gt; G通道的所有像素 -&gt; B通道的所有像素</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tensor_bchw</span> = torch.randn(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">256</span>, <span class="hljs-number">256</span>)
访问第一个像素的RGB值需要跨越不同的内存区域
<span class="hljs-attr">pixel_0_0_r</span> = tensor_bchw[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]  <span class="hljs-comment"># R通道</span>
<span class="hljs-attr">pixel_0_0_g</span> = tensor_bchw[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]  <span class="hljs-comment"># G通道  </span>
<span class="hljs-attr">pixel_0_0_b</span> = tensor_bchw[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]  <span class="hljs-comment"># B通道</span>
</code></pre>
<p>•<strong>BHWC格式（Batch-Height-Width-Channel）</strong></p>
<p>◦维度顺序：[批次, 高度, 宽度, 通道]</p>
<p>◦内存布局：通道维度在最后，像素的所有通道连续存储</p>
<p>◦常用框架：TensorFlow、OpenCV等</p>
<p>示例：形状为 (1, 256, 256, 3) 的RGB图像</p>
<p>内存中的存储顺序：像素(0,0)的RGB -&gt; 像素(0,1)的RGB -&gt; ... -&gt; 像素(0,255)的RGB -&gt; 像素(1,0)的RGB...</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tensor_bhwc</span> = tf.random.normal([<span class="hljs-number">1</span>, <span class="hljs-number">256</span>, <span class="hljs-number">256</span>, <span class="hljs-number">3</span>])
<span class="hljs-comment"># 访问第一个像素的RGB值在连续的内存位置</span>
<span class="hljs-attr">pixel_0_0_rgb</span> = tensor_bhwc[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, :]  <span class="hljs-comment"># [R, G, B]</span>
</code></pre>
<p>﻿</p>
<h2 data-id="heading-10"><strong>3. 鸿蒙端部署核心步骤</strong></h2>
<h3 data-id="heading-11"><strong>3.1 创建项目</strong></h3>
<p>1.创建DevEco Studio项目，选择“Native C++”模板，点击“Next”。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46f2d4161ef44984881401020f6a30fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=FO4ZXb3ysjT2qkzUpotPqVcQOaM%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>2.按需填写“Project name”、“Save location”和“Module name”，选择“Compile SDK”为“5.1.0(18)”及以上版本，点击“Finish”。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c8bac1d934c44b7b3daff85617fbb4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=P6mxqs%2BLOWtEY%2BGaMsH5jxAlfrQ%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h3 data-id="heading-12"><strong>3.2 配置项目NAPI</strong></h3>
<p>CANN部署只提供了C++接口, 因此需要使用NAPI, 编译HAP时，NAPI层的so需要编译依赖NDK中的libneural_network_core.so和libhiai_foundation.so。</p>
<p>﻿</p>
<p><strong>头文件引用</strong></p>
<p>按需引用NNCore和CANN Kit的头文件。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"neural_network_runtime/neural_network_core.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"CANNKit/hiai_options.h"</span></span>
</code></pre>
<p><strong>编写CMakeLists.txt</strong></p>
<p>CMakeLists.txt示例代码如下。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.5</span>.<span class="hljs-number">0</span>)
<span class="hljs-built_in">project</span>(myNpmLib)

<span class="hljs-built_in">set</span>(NATIVERENDER_ROOT_PATH ${CMAKE_CURRENT_SOURCE_DIR})

<span class="hljs-built_in">include_directories</span>(${NATIVERENDER_ROOT_PATH}
                    ${NATIVERENDER_ROOT_PATH}/include)

<span class="hljs-built_in">include_directories</span>(${HMOS_SDK_NATIVE}/sysroot/usr/lib)
<span class="hljs-built_in">FIND_LIBRARY</span>(cann-lib hiai_foundation)

<span class="hljs-built_in">add_library</span>(imagesr SHARED HIAIModelManager.cpp ImageSuperResolution.cpp)
<span class="hljs-built_in">target_link_libraries</span>(imagesr PUBLIC libace_napi.z.so
    libhilog_ndk.z.so
    librawfile.z.so
    ${cann-lib}
    libneural_network_core.so
    )
</code></pre>
<h3 data-id="heading-13"><strong>3.3 集成模型</strong></h3>
<p>模型的加载、编译和推理主要是在native层实现，应用层主要作为数据传递和展示作用。模型推理之前需要对输入数据进行预处理以匹配模型的输入，同样对于模型的输出也需要做处理获取自己期望的结果</p>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb2af561a0954b37802f76a57a72b5a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=llwQdjDQLIDuprCBEFSSf29%2FQU8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h4 data-id="heading-14"><strong>3.3.1 加载离线模型</strong></h4>
<p>为了让App运行时能够读取到模型文件和处理推理结果，需要先把离线模型和模型对应的结果标签文件预置到工程的“entry/src/main/resources/rawfile”目录中。</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3e78a1905514c80af05ac4bbd3c9411~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767089477&amp;x-signature=UB4r11wWFJskohWLsZSQ3QNlSfs%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>在App应用创建时加载模型:</p>
<p>1.native层读取模型的buffer。</p>
<pre><code class="hljs language-ini" lang="ini">const char* <span class="hljs-attr">modelPath</span> = <span class="hljs-string">"imagesr.om"</span><span class="hljs-comment">;</span>
RawFile *<span class="hljs-attr">rawFile</span> = OH_ResourceManager_OpenRawFile(resourceMgr, modelPath)<span class="hljs-comment">;</span>
long <span class="hljs-attr">modelSize</span> = OH_ResourceManager_GetRawFileSize(rawFile)<span class="hljs-comment">;</span>
std::unique_ptr&lt;uint8_t<span class="hljs-section">[]</span>&gt; <span class="hljs-attr">modelData</span> = std::make_unique&lt;uint8_t[]&gt;(modelSize)<span class="hljs-comment">;</span>
int <span class="hljs-attr">res</span> = OH_ResourceManager_ReadRawFile(rawFile, modelData.get(), modelSize)<span class="hljs-comment">;</span>
</code></pre>
<p>2.使用模型的buffer, 调用OH_NNCompilation_ConstructWithOfflineModelBuffer创建模型的编译实例</p>
<pre><code class="hljs language-ini" lang="ini">HiAI_Compatibility <span class="hljs-attr">compibility</span> = HMS_HiAICompatibility_CheckFromBuffer(modelData, modelSize)<span class="hljs-comment">;</span>
OH_NNCompilation *<span class="hljs-attr">compilation</span> = OH_NNCompilation_ConstructWith<span class="hljs-literal">Off</span>lineModelBuffer(modelData, modelSize)<span class="hljs-comment">;</span>
</code></pre>
<p>3.（可选）根据需要调用HMS_HiAIOptions_SetOmOptions接口，打开维测功能（如Profiling）。</p>
<pre><code class="hljs language-ini" lang="ini">const char *<span class="hljs-attr">out_path</span> = <span class="hljs-string">"/data/storage/el2/base/haps/entry/files"</span><span class="hljs-comment">;</span>
HiAI_OmType <span class="hljs-attr">omType</span> = HIAI_OM_TYPE_PROFILING<span class="hljs-comment">;</span>
OH_NN_ReturnCode <span class="hljs-attr">ret</span> = HMS_HiAIOptions_SetOmOptions(compilation, omType, out_path)<span class="hljs-comment">;     </span>
</code></pre>
<p>4.设置模型的deviceID。</p>
<pre><code class="hljs language-ini" lang="ini">size_t <span class="hljs-attr">deviceID</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
const size_t *<span class="hljs-attr">allDevicesID</span> = nullptr<span class="hljs-comment">;</span>
uint32_t <span class="hljs-attr">deviceCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
OH_NN_ReturnCode <span class="hljs-attr">ret</span> = OH_NNDevice_GetAllDevicesID(&amp;allDevicesID, &amp;deviceCount)<span class="hljs-comment">;</span>

for (uint32_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; deviceCount; i++) {</span>
    const char *<span class="hljs-attr">name</span> = nullptr<span class="hljs-comment">;</span>
    <span class="hljs-attr">ret</span> = OH_NNDevice_GetName(allDevicesID[i], &amp;name)<span class="hljs-comment">;</span>
    if (ret != OH_NN_SUCCESS || <span class="hljs-attr">name</span> == nullptr) {
        OH_LOG_ERROR(LOG_APP, "OH_NNDevice_GetName failed")<span class="hljs-comment">;</span>
        return deviceID<span class="hljs-comment">;</span>
    }
    if (std::string(name) == "HIAI_F") {
        <span class="hljs-attr">deviceID</span> = allDevicesID[i]<span class="hljs-comment">;</span>
        break<span class="hljs-comment">;</span>
    }
}

<span class="hljs-attr">ret</span> = OH_NNCompilation_SetDevice(compilation, deviceID)<span class="hljs-comment">;</span>
</code></pre>
<p>5.调用OH_NNCompilation_Build，执行模型编译。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ret</span> = SetModelBuildOptions(compilation)<span class="hljs-comment">;</span>
<span class="hljs-attr">ret</span> = OH_NNCompilation_Build(compilation)<span class="hljs-comment">;</span>
</code></pre>
<p>6.调用OH_NNExecutor_Construct，创建模型执行器。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">executor_</span> = OH_NNExecutor_Construct(compilation)<span class="hljs-comment">;</span>
</code></pre>
<p>7.调用OH_NNCompilation_Destroy，释放模型编译实例。</p>
<p>﻿</p>
<h4 data-id="heading-15"><strong>3.3.2 准备输入输出****Tensor</strong></h4>
<p>1.处理模型的输入，模型的输入为1<em>3</em>128*128格式(BCHW) Float类型的数据, 需要把RGB 数据转成BCHW格式并进行归一化。</p>
<pre><code class="hljs language-ini" lang="ini">从图片中读取的RGB数据为BHWC,需要转换成模型可以识别的BCHW
/**
 * 把bhwc转成bchw
 */
uint8_t *<span class="hljs-attr">rgbData</span> = static_cast&lt;uint8_t*&gt;(data)<span class="hljs-comment">;</span>
uint8_t *<span class="hljs-attr">floatData_tmp</span> = new uint8_t[length]<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; 3; ++c) {</span>
    for (int <span class="hljs-attr">h</span> = <span class="hljs-number">0</span><span class="hljs-comment">; h &lt; 128; ++h) {</span>
        for (int <span class="hljs-attr">w</span> = <span class="hljs-number">0</span><span class="hljs-comment">; w &lt; 128; ++w) {</span>
            // HWC 索引: h * width * channels + w * channels +c 
            int <span class="hljs-attr">hwc_index</span> = h * <span class="hljs-number">128</span> * <span class="hljs-number">3</span> + w * <span class="hljs-number">3</span> + c<span class="hljs-comment">;</span>
            // CHW 索引: C * height * width + h* width + W
            int <span class="hljs-attr">chw_index</span> = c * <span class="hljs-number">128</span> * <span class="hljs-number">128</span> + h * <span class="hljs-number">128</span> + w<span class="hljs-comment">;</span>
            floatData_tmp<span class="hljs-section">[chw_index]</span> = rgbData<span class="hljs-section">[hwc_index]</span><span class="hljs-comment">;</span>
        }
    }
}
//归一化
float *<span class="hljs-attr">floatData</span> = new float[length]<span class="hljs-comment">;</span>
for (size_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; length; ++i) {</span>
    floatData<span class="hljs-section">[i]</span> = static_cast&lt;float&gt;(floatData_tmp<span class="hljs-section">[i]</span>)/ 255.0f<span class="hljs-comment">;</span>
}
</code></pre>
<p>2.创建模型的输入和输出Tensor，并把应用层传递的数据填充到输入的Tensor中</p>
<pre><code class="hljs language-ini" lang="ini">// 准备输入张量
size_t <span class="hljs-attr">inputCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
OH_NN_ReturnCode <span class="hljs-attr">ret</span> = OH_NNExecutor_GetInputCount(executor_, &amp;inputCount)<span class="hljs-comment">;</span>
for (size_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; inputCount; ++i) {</span>
    NN_TensorDesc *<span class="hljs-attr">tensorDesc</span> = OH_NNExecutor_CreateInputTensorDesc(executor_, i)<span class="hljs-comment">;</span>
    NN_Tensor *<span class="hljs-attr">tensor</span> = OH_NNTensor_Create(deviceID_, tensorDesc)<span class="hljs-comment">;</span>
    if (tensor != nullptr) {
        inputTensors_.push_back(tensor)<span class="hljs-comment">;</span>
    }
    OH_NNTensorDesc_Destroy(&amp;tensorDesc)<span class="hljs-comment">;</span>
}


<span class="hljs-attr">ret</span> = SetInputTensorData(inputTensors_, inputData)<span class="hljs-comment">;</span>

// 准备输出张量
size_t <span class="hljs-attr">outputCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
<span class="hljs-attr">ret</span> = OH_NNExecutor_GetOutputCount(executor_, &amp;outputCount)<span class="hljs-comment">;</span>

for (size_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; outputCount; i++) {</span>
    NN_TensorDesc *<span class="hljs-attr">tensorDesc</span> = OH_NNExecutor_CreateOutputTensorDesc(executor_, i)<span class="hljs-comment">;</span>
    NN_Tensor *<span class="hljs-attr">tensor</span> = OH_NNTensor_Create(deviceID_, tensorDesc)<span class="hljs-comment">;</span>
    if (tensor != nullptr) {
        outputTensors_.push_back(tensor)<span class="hljs-comment">;</span>
    }
    OH_NNTensorDesc_Destroy(&amp;tensorDesc)<span class="hljs-comment">;</span>
}
if (outputTensors_.size() != outputCount) {
    DestroyTensors(inputTensors_)<span class="hljs-comment">;</span>
    DestroyTensors(outputTensors_)<span class="hljs-comment">;</span>
    OH_LOG_ERROR(LOG_APP, "output size mismatch.")<span class="hljs-comment">;</span>
    return OH_NN_FAILED<span class="hljs-comment">;</span>
}
</code></pre>
<p>﻿</p>
<h4 data-id="heading-16"><strong>3.3.3 进行推理</strong></h4>
<p>调用OH_NNExecutor_RunSync，完成模型的同步推理。</p>
<pre><code class="hljs language-scss" lang="scss">OH_NN_ReturnCode ret = <span class="hljs-built_in">OH_NNExecutor_RunSync</span>(executor_, inputTensors_.data(), inputTensors_<span class="hljs-selector-class">.size</span>(),
                                                 outputTensors_<span class="hljs-selector-class">.data</span>(), outputTensors_<span class="hljs-selector-class">.size</span>());
</code></pre>
<p>说明</p>
<p>•如果不更换模型，则首次编译加载完成后可多次推理，即一次编译加载，多次推理。</p>
<p>•所有关于模型的操作, 均无法多线程执行。</p>
<p>﻿</p>
<h4 data-id="heading-17"><strong>3.3.4 获取模型输出并处理数据</strong></h4>
<p>1.调用OH_NNTensor_GetDataBuffer，获取输出的Tensor，在输出Tensor中会得到模型的输出数据。</p>
<pre><code class="hljs language-ini" lang="ini">// 获取第一个输出张量
NN_Tensor* <span class="hljs-attr">tensor</span> = outputTensors_[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>

// 获取张量数据缓冲区
void *<span class="hljs-attr">tensorData</span> = OH_NNTensor_GetDataBuffer(tensor)<span class="hljs-comment">;</span>

// 获取张量大小
size_t <span class="hljs-attr">size</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
OH_NN_ReturnCode <span class="hljs-attr">ret</span> = OH_NNTensor_GetSize(tensor, &amp;size)<span class="hljs-comment">;</span>

float *<span class="hljs-attr">tensorDataOutput</span> = (float*)malloc(size)<span class="hljs-comment">;</span>
// 将tensorData的数据一次性复制到tensorDataOutput中
memcpy(tensorDataOutput, tensorData, size)<span class="hljs-comment">;</span>
</code></pre>
<p>﻿</p>
<p>2.对Tensor输出数据进行相应的处理</p>
<p>把模型输出的BCHW转成BHWC, 并进行反归一化处理</p>
<p>﻿</p>
<pre><code class="hljs language-ini" lang="ini">//把模型输出的BCHW转成BHWC
float *<span class="hljs-attr">outputResult</span> = static_cast&lt;float *&gt;(tensorData)<span class="hljs-comment">;</span>
float *<span class="hljs-attr">output_tmp</span> = new float[size/sizeof(float)]<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">h</span> = <span class="hljs-number">0</span><span class="hljs-comment">; h &lt; 512; ++h) {</span>
    for (int <span class="hljs-attr">w</span> = <span class="hljs-number">0</span><span class="hljs-comment">; w &lt; 512; ++w) {</span>
        for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; 3; ++c) {</span>
            output_tmp<span class="hljs-section">[h * 512 * 3 + w* 3 + c]</span> = outputResult<span class="hljs-section">[c * 512 * 512 + h * 512 + w]</span><span class="hljs-comment">;</span>
        }
    }
}
std::vector&lt;float&gt; output(size / sizeof(float), 0.0)<span class="hljs-comment">;</span>
for (size_t <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; size / sizeof(float); ++i) {</span>
    output<span class="hljs-section">[i]</span> = output_tmp<span class="hljs-section">[i]</span><span class="hljs-comment">;</span>
}
delete <span class="hljs-section">[]</span> output_tmp<span class="hljs-comment">;</span>


 // 计算总的数据大小
size_t <span class="hljs-attr">totalSize</span> = output.size()<span class="hljs-comment">;</span>

// 分配结果数据内存
std::unique_ptr&lt;uint8_t<span class="hljs-section">[]</span>&gt; <span class="hljs-attr">result_data</span> = std::make_unique&lt;uint8_t[]&gt;(totalSize)<span class="hljs-comment">;</span>

// 将float数据转换为uint8_t (反归一化)
size_t <span class="hljs-attr">index</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
for (float value : result) {
    // 将float值转换为uint8_t (0-255范围)
    float <span class="hljs-attr">scaledValue</span> = value * <span class="hljs-number">255.0</span>f<span class="hljs-comment">;</span>
    <span class="hljs-attr">scaledValue</span> = std::max(<span class="hljs-number">0.0</span>f, std::min(<span class="hljs-number">255.0</span>f, scaledValue))<span class="hljs-comment">;</span>
    result_data<span class="hljs-section">[index++]</span> = static_cast&lt;uint8_t&gt;(scaledValue)<span class="hljs-comment">;</span>
}

result_data 就是最终的超分数据,可以正常显示
</code></pre>
<p>﻿</p>
<h2 data-id="heading-18"><strong>4. 总结与技术展望</strong></h2>
<p>京东金融App在鸿蒙端部署Real-ESRGAN-General-x4v3超分辨率模型的完整实践过程，成功解决了ONNX模型到OM离线模型转换、BCHW与BHWC张量格式处理、以及基于CANN Kit和NAPI的完整部署链路等关键技术难题。</p>
<p>展望端智能的未来发展，随着芯片算力的指数级增长、模型压缩技术的突破性进展以及边缘计算架构的日趋成熟，端侧设备将从单纯的数据采集终端演进为具备强大推理能力的智能计算节点，通过实现多模态AI融合、实时个性化学习、隐私保护计算和跨设备协同等核心能力，将大语言模型、计算机视觉、语音识别等AI技术深度集成到移动设备中，构建起无需联网即可提供智能服务的自主计算生态，推动人机交互从被动响应向主动感知、预测和服务的范式转变，最终开启真正意义上的普惠人工智能时代。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回顾计算属性的缓存与监听的触发返回结果]]></title>    <link>https://juejin.cn/post/7586879894207922239</link>    <guid>https://juejin.cn/post/7586879894207922239</guid>    <pubDate>2025-12-23T09:13:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586879894207922239" data-draft-id="7533501485156368418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="回顾计算属性的缓存与监听的触发返回结果"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-12-23T09:13:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            回顾计算属性的缓存与监听的触发返回结果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T09:13:55.000Z" title="Tue Dec 23 2025 09:13:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-light">.hljs-comment,.hljs-quote{color:#6b7394}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f5f7ff;color:#5e6687}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>网上的给出的区别有很多，今天只是简单来回归下其中的一些流程和区别的关键点。</p>
<p><strong>以下面的代码为例进行思考：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"calc"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model.number</span>=<span class="hljs-string">"n1"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"数字1"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model.number</span>=<span class="hljs-string">"n2"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"数字2"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>和：{{ sum }} 平均值：{{ avg }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"用户名"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{color: tipColor}"</span>&gt;</span>{{ tip }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">n1</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">n2</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">tip</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">tipColor</span>: <span class="hljs-string">'#333'</span> }
    },
    <span class="hljs-attr">computed</span>: {
      <span class="hljs-title function_">sum</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">n1</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">n2</span> },
      <span class="hljs-title function_">avg</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">sum</span> / <span class="hljs-number">2</span> }
    },
    <span class="hljs-attr">watch</span>: {
      <span class="hljs-title function_">name</span>(<span class="hljs-params">v</span>) {
        <span class="hljs-keyword">if</span> (!v.<span class="hljs-title function_">trim</span>()) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tip</span> = <span class="hljs-string">'不能为空'</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipColor</span> = <span class="hljs-string">'red'</span> }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (v.<span class="hljs-property">length</span> &lt; <span class="hljs-number">3</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tip</span> = <span class="hljs-string">'不少于3位'</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipColor</span> = <span class="hljs-string">'orange'</span> }
        <span class="hljs-keyword">else</span> { <span class="hljs-variable language_">this</span>.<span class="hljs-property">tip</span> = <span class="hljs-string">'可用'</span>; <span class="hljs-variable language_">this</span>.<span class="hljs-property">tipColor</span> = <span class="hljs-string">'green'</span> }
      }
    }
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.calc</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>; <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> auto; }
  <span class="hljs-selector-tag">input</span> { <span class="hljs-attribute">display</span>: block; <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">8px</span> <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">6px</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>关于 watch 和 computed 的使用我们很多，这里我们不一一介绍，<strong>但是请记住：监听是不需要 return 的，计算属性是百分百必须要有的。</strong></p>
<h2 data-id="heading-1">1、监听和计算属性的区别</h2>
<h4 data-id="heading-2"><strong>最关键的区别：</strong></h4>
<p><strong>1、监听是没有缓存的，计算属性是有缓存的</strong></p>
<p><strong>2、监听是不需要有返回值的，但是机损属性是必须要有返回值的。（极限情况下不return基本没意义）</strong></p>
<p><strong>其他的区别：</strong></p>






























<table><thead><tr><th><strong>对比维度</strong></th><th><strong>计算属性（computed）</strong></th><th><strong>监听器（watch）</strong></th></tr></thead><tbody><tr><td><strong>核心用途</strong></td><td>基于已有数据<strong>推导 / 计算新数据</strong>（数据转换 / 组合）</td><td>监听已有数据的<strong>变化</strong>，执行异步操作或复杂逻辑（无新数据产出，侧重 “副作用”）</td></tr><tr><td><strong>依赖关系</strong></td><td>只能依赖 Vue 实例中的响应式数据（<code>data</code>/<code>props</code>/ 其他 <code>computed</code>），自动感知依赖变化</td><td>可监听单个响应式数据、对象属性、数组，甚至通过 <code>deep: true</code>监听对象深层变化，支持手动指定监听目标</td></tr><tr><td><strong>使用场景</strong></td><td>1. 简单数据拼接（如全名：<code>firstName + lastName</code>）2. 数据格式化（如时间戳转日期字符串）3. 依赖多数据的计算（如总价：<code>price * count</code>）4. 需缓存的重复计算场景</td><td>1. 异步操作（如监听输入框变化，延迟请求接口获取联想数据）2. 复杂逻辑处理（如监听用户状态变化，同步更新权限菜单）3. 监听对象深层变化（如监听表单对象，统一处理提交前校验）4. 数据变化后的联动操作（非数据推导类）</td></tr><tr><td><strong>是否支持异步</strong></td><td>不支持异步操作：若在 <code>computed</code>中使用异步（如定时器、接口请求），无法正确返回推导结果，会得到 <code>undefined</code></td><td>支持异步操作：这是 <code>watch</code>的核心优势之一，可在监听函数中执行任意异步逻辑</td></tr></tbody></table>
<h2 data-id="heading-3">2： 监听和计算属性的基本触发流程：</h2>
<h3 data-id="heading-4">核心逻辑：<code>set</code> → <code>Dep</code> → <code>Watcher</code> → <code>watch</code>/<code>computed</code> 联动流程</h3>
<p>无论是 <code>watch</code> 还是 <code>computed</code>，底层联动流程的核心一致，<strong>仅在</strong> <code>Watcher</code> <strong>执行逻辑上有差异</strong>，完整流程如下：</p>
<h3 data-id="heading-5">第一步：初始化阶段 —— 依赖收集（<code>get</code> 拦截器 + <code>Dep</code> + <code>Watcher</code> 绑定）</h3>
<ol>
<li><code>computed</code> ****<strong>的依赖收集</strong>：</li>
</ol>

<ol>
<li>组件初始化时，会为每个计算属性创建一个「计算属性 <code>Watcher</code>」；
1.  执行计算属性的 <code>get</code> 方法，访问依赖的响应式数据（如 <code>this.num1</code>）；
1.  触发该数据的 <code>get</code> 拦截器，<code>get</code> 拦截器会将当前「计算属性 <code>Watcher</code>」添加到该数据的 <code>Dep</code> 依赖列表中；
1.  所有依赖数据都完成 <code>Watcher</code> 绑定，最终缓存计算属性的初始结果。</li>
</ol>

<ol start="2">
<li><code>watch</code> ****<strong>的依赖收集</strong>：</li>
</ol>

<ol>
<li>
<ol>
<li>组件初始化时，会为每个 <code>watch</code> 监听目标创建一个「普通 <code>Watcher</code>」；</li>
<li>主动读取一次监听目标数据（如 <code>this.username</code>），触发该数据的 <code>get</code> 拦截器；</li>
<li><code>get</code> 拦截器将当前「普通 <code>Watcher</code>」添加到该数据的 <code>Dep</code> 依赖列表中；</li>
<li>若开启 <code>deep: true</code>，会递归遍历对象 / 数组的内部属性，完成深层依赖收集。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-6">第二步：更新阶段 ——<code>set</code> 拦截器触发 <code>Watcher</code> 执行</h3>
<p>当修改响应式数据时（如 <code>this.num1 = 10</code>），触发底层联动：</p>
<ol>
<li>数据被修改，触发该数据的 <code>set</code> 拦截器；</li>
<li><code>set</code> 拦截器调用对应 <code>Dep</code> 的 <code>notify()</code> 方法（派发更新通知）；</li>
<li><code>Dep</code> 遍历自身的依赖列表，通知所有绑定的 <code>Watcher</code>「数据已更新」；</li>
<li>不同类型的 <code>Watcher</code> 接收通知后，执行差异化操作（这是 <code>watch</code> 和 <code>computed</code> 表现不同的核心原因）：</li>
</ol>
<ul>
<li>
<ul>
<li><strong>普通</strong> <code>Watcher</code> <strong>（对应</strong> <code>watch</code> <strong>）</strong> ：收到通知后，<strong>立即执行</strong> <code>watch</code> <strong>的回调函数</strong>，传入 <code>newVal</code> 和 <code>oldVal</code>，执行异步 / 复杂逻辑；</li>
<li><strong>计算属性</strong> <code>Watcher</code> <strong>（对应</strong> <code>computed</code> <strong>）</strong> ：收到通知后，<strong>仅将自身标记为「脏状态」（缓存失效）</strong> ，不立即执行计算逻辑，等待下次访问计算属性时，才重新执行 <code>get</code> 方法计算新结果并更新缓存。</li>
</ul>
</li>
</ul>
<p>举个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-attr">watch</span>: {
    <span class="hljs-title function_">num</span>(<span class="hljs-params">newVal, oldVal</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`【watch】：num从<span class="hljs-subst">${oldVal}</span>变为<span class="hljs-subst">${newVal}</span>，我立即执行回调`</span>);
    }
  },
</code></pre>
<p>当 set 触发 watcher 后，watcher 就会立即触发：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">num</span>(<span class="hljs-params">newVal, oldVal</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`【watch】：num从<span class="hljs-subst">${oldVal}</span>变为<span class="hljs-subst">${newVal}</span>，我立即执行回调`</span>);
    }
</code></pre>
<p><strong>什么叫</strong> <strong>收到通知后，</strong> <strong>仅将自身标记为「脏状态」（缓存失效）</strong> <strong>，不立即执行计算逻辑，等待下次访问计算属性时，才重新执行</strong> <code>get</code> <strong>方法计算新结果并更新缓存。</strong></p>
<p><strong>举个例子：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 这里就是「访问计算属性」：模板渲染时会读取 numDouble 的值 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"num &lt; 2"</span>&gt;</span>两倍数：{{ numDouble }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">num</span>: <span class="hljs-number">1</span> };
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">numDouble</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"计算属性执行计算"</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> * <span class="hljs-number">2</span>;
    },
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = <span class="hljs-number">5</span>; <span class="hljs-comment">// 2秒后，v-if不成立</span>
  }, <span class="hljs-number">2000</span>);
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> = <span class="hljs-number">1</span>; <span class="hljs-comment">// 4秒后，v-if再次成立</span>
  }, <span class="hljs-number">4000</span>);
  },
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

// 控制台只会打印2次“计算属性执行
</code></pre>
<p><strong>为什么只打印 2 次：</strong></p>
<p><strong>原因就是我们的计算属性在 2s 后没有执行</strong></p>
<p><strong>1、 当初始化时，页面中 v-if 条件是符合的，会执行一次 get 计算得到返回值</strong></p>
<p><strong>2、当经过两秒后、</strong> <strong>v-if 不符合条件，这个时候表明numDouble 是脏数据，会对其进行标记（</strong> <strong>v-if 不符合条件，所以无法对numDouble 进行访问，</strong> <strong>这里也就是我们说的缓存，缓存计算属性的结果值，当脏状态取消时才会进行新的计算</strong> <strong>)</strong></p>
<p><strong>3、当 经过 4 秒后条件再次被满足时，才会有新的计算。</strong></p>
<h2 data-id="heading-7">3： 计算属性为什么不能异步</h2>
<p><strong>举个例子，我们使用延时进行模仿：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 这里就是「访问计算属性」：模板渲染时会读取 numDouble 的值 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"num &lt; 2"</span>&gt;</span>两倍数：{{ numDouble }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">num</span>: <span class="hljs-number">1</span> };
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">numDouble</span>(<span class="hljs-params"/>) {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> * <span class="hljs-number">2</span>;
      }, <span class="hljs-number">1000</span>);
    },
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">numDouble</span>);
  },
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>打印结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e5f59c20b284dd38f6f7325a9e275cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouJ5LiN5Yqo55qE54yq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767086035&amp;x-signature=2Wg17EQIry85cV7xM1hV0RJP8W4%3D" alt="" loading="lazy"/></p>
<p>为什么会打印 underfined 呢，这里有两个原因？</p>
<h3 data-id="heading-8">原因 1：JavaScript 中，任何函数如果没有显式写 <code>return</code> 语句，或 <code>return</code> 后没有跟随具体值，都会默认返回 <code>undefined</code>，这是计算属性返回 <code>undefined</code> 的基础原因。</h3>
<p>举个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">return</span> <span class="hljs-number">11</span>;
        }, <span class="hljs-number">1000</span>);
      }
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">test</span>());
      }, <span class="hljs-number">2000</span>);
</code></pre>
<p>这样写是属于语法的错误。</p>
<h3 data-id="heading-9">原因 2：setTimeout 的异步特性（关键）</h3>
<p>即使你在 <code>setTimeout</code> 回调中写了 <code>return this.num * 2</code>，这个返回值也毫无意义，因为 <code>setTimeout</code>是<strong>异步宏任务</strong>：</p>
<ol>
<li>当 Vue 访问 <code>this.numDouble</code> 时，会立即执行计算属性的函数体；</li>
<li>函数体执行到 <code>setTimeout</code> 时，只会「注册一个异步任务」，然后直接跳过 <code>setTimeout</code> 继续执行；</li>
<li>此时计算属性函数体已经执行完毕（没有显式 <code>return</code>），默认返回 <code>undefined</code>，并被 <code>console.log</code> 打印；</li>
<li>1 秒后，<code>setTimeout</code> 的回调函数才会执行，此时回调中的 <code>return this.num * 2</code> 只是回调函数自身的返回值，无法传递给计算属性，也无法改变之前已经返回的 <code>undefined</code>。</li>
</ol>
<p><strong>简单说：异步回调的返回值，无法成为计算属性的返回值，计算属性会在异步任务注册后，直接默认返回</strong> <code>undefined</code> <strong>。</strong></p>
<h3 data-id="heading-10"><strong>也可以分两步走</strong></h3>
<h3 data-id="heading-11">一、先明确：计算属性的函数体，<strong>只在 “被访问” 时同步执行一次（除非满足重新计算条件）</strong></h3>
<p>当 <code>mounted</code> 中访问 <code>this.numDouble</code>，或者模板渲染访问 <code>numDouble</code> 时，Vue 会<strong>同步、完整地执行一遍</strong> ****<code>numDouble</code> ****<strong>函数体的代码</strong>，但这个执行过程和 <code>setTimeout</code> 内部的回调是完全分离的：</p>
<h4 data-id="heading-12">第一步：计算属性函数体「同步执行」（瞬间完成，不等待异步）</h4>
<p>我们把 <code>numDouble</code> 的执行过程拆解成 “逐行执行”，你就能看清流程：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">numDouble</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 第1步：执行 setTimeout 这行代码</span>
  <span class="hljs-comment">// 作用：向浏览器“注册一个1秒后执行的异步任务”，仅此而已</span>
  <span class="hljs-comment">// 注意：这行代码执行时，不会等待1秒，也不会执行回调函数内部的代码</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 这是回调函数，此时完全没有执行！</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"回调函数开始执行"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">num</span> * <span class="hljs-number">2</span>;
  }, <span class="hljs-number">1000</span>);

  <span class="hljs-comment">// 第2步：计算属性函数体执行到末尾</span>
  <span class="hljs-comment">// 没有显式 return，默认返回 undefined</span>
  <span class="hljs-comment">// 此时，numDouble 已经完成了“返回值”的传递，整个函数体执行结束</span>
}
</code></pre>
<p>简单来说就是<code>numDouble</code> 函数体的执行，只做了一件事 ——“安排了一个 1 秒后的任务”，然后就直接返回了 <code>undefined</code>，它不会停下来等 1 秒后回调执行完再返回值。</p>
<h4 data-id="heading-13">第二步：1 秒后，异步回调才执行，但为时已晚</h4>
<ol>
<li>计算属性已经在第一步就返回了 <code>undefined</code>，这个返回值已经被 <code>console.log</code> 打印，也被 Vue 缓存起来了；</li>
<li>1 秒后，浏览器才会执行 <code>setTimeout</code> 的回调函数，此时回调里的 <code>return this.num * 2</code> 只是 “回调函数自己的返回值”—— <strong>这个值没有任何接收者，既不能传给</strong> <code>numDouble</code> <strong>，也不能改变之前已经返回的</strong> <code>undefined</code> <strong>；</strong></li>
<li>更关键的是：回调执行时，<code>numDouble</code> 函数体早就执行完毕了，<strong>两者是完全独立的执行流程</strong>，回调的返回值无法 “回溯” 给已经执行完的计算属性。</li>
</ol>
<h3 data-id="heading-14">简单来讲就是：</h3>
<p><strong>计算属性是要内置返回一个结果的，如果加入异步就会因为执行顺讯返回一个undefined，监听是在事件触发后对写入的回调函数的调用。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一篇搞定 dotnet ef：EF Core 常用命令与实战指南]]></title>    <link>https://juejin.cn/post/7586570254860582952</link>    <guid>https://juejin.cn/post/7586570254860582952</guid>    <pubDate>2025-12-22T22:58:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586570254860582952" data-draft-id="7586518130761728040" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一篇搞定 dotnet ef：EF Core 常用命令与实战指南"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-22T22:58:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一篇搞定 dotnet ef：EF Core 常用命令与实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T22:58:00.000Z" title="Mon Dec 22 2025 22:58:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">基础知识</h3>

























<table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td><strong>EF Core</strong></td><td>.NET 的 ORM 框架，支持 Code First、Database First。</td></tr><tr><td><strong>dotnet ef</strong></td><td>一个 <strong>CLI 工具</strong>，用于管理 EF Core 迁移、数据库操作。</td></tr><tr><td><strong>安装方式</strong></td><td>通常安装在项目中（推荐）：<br/><code>dotnet add package Microsoft.EntityFrameworkCore.Design</code><br/>全局工具：<code>dotnet tool install --global dotnet-ef</code></td></tr><tr><td><strong>使用位置</strong></td><td>在包含 <code>*.csproj</code> 的目录执行，或者使用 <code>--project</code> 指定项目路径。</td></tr></tbody></table>
<blockquote>
<p>在执行任何 dotnet ef 命令前，需要在 csproj 中包含 Microsoft.EntityFrameworkCore.Design 包。</p>
</blockquote>
<h3 data-id="heading-1">命令总览</h3>




























































<table><thead><tr><th>命令</th><th>作用</th><th>典型场景</th></tr></thead><tbody><tr><td><code>dotnet ef migrations add</code></td><td>添加新的数据库迁移</td><td>增加或修改实体模型后</td></tr><tr><td><code>dotnet ef migrations list</code></td><td>查看已有迁移</td><td>确认数据库版本</td></tr><tr><td><code>dotnet ef migrations remove</code></td><td>删除最新迁移</td><td>回滚刚添加但未应用的迁移</td></tr><tr><td><code>dotnet ef migrations script</code></td><td>生成 SQL 脚本</td><td>手工执行迁移</td></tr><tr><td><code>dotnet ef database update</code></td><td>更新数据库到指定迁移</td><td>同步数据库与模型</td></tr><tr><td><code>dotnet ef database drop</code></td><td>删除数据库</td><td>重置开发环境</td></tr><tr><td><code>dotnet ef dbcontext info</code></td><td>查看 DbContext 信息</td><td>调试上下文配置</td></tr><tr><td><code>dotnet ef dbcontext list</code></td><td>列出可用 DbContext</td><td>多上下文项目</td></tr><tr><td><code>dotnet ef dbcontext scaffold</code></td><td>根据现有数据库生成实体</td><td>Database First 逆向工程</td></tr><tr><td><code>dotnet ef dbcontext optimize</code></td><td>预生成模型快照以提升启动速度</td><td>高性能场景</td></tr></tbody></table>
<h3 data-id="heading-2">常用命令详解 + 示例</h3>
<h4 data-id="heading-3">创建迁移</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef migrations add InitialCreate
</code></pre>
<p>在 <code>Migrations</code>/ 目录下生成：</p>
<ul>
<li>
<p><code>YYYYMMDDHHMMSS_InitialCreate.cs</code>：迁移代码</p>
</li>
<li>
<p><code>AppDbContextModelSnapshot.cs</code>：模型快照文件</p>
</li>
</ul>
<p>常用参数：</p>






























<table><thead><tr><th>参数</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>--project</code></td><td>指定启动项目</td><td><code>--project ./MyApp</code></td></tr><tr><td><code>--startup-project</code></td><td>指定包含 <code>Program.cs</code> 的启动项目</td><td><code>--startup-project ./MyApp.Web</code></td></tr><tr><td><code>--context</code></td><td>指定 DbContext</td><td><code>--context AppDbContext</code></td></tr><tr><td><code>--output-dir</code></td><td>指定迁移文件夹</td><td><code>--output-dir Data/Migrations</code></td></tr></tbody></table>
<blockquote>
<p>在多项目架构中（如分离 <code>DAL</code>/启动项目），务必同时指定 <code>--project</code> 和 <code>--startup-project</code>。</p>
</blockquote>
<h4 data-id="heading-4">应用迁移</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef database update
</code></pre>
<ul>
<li>
<p>将数据库更新到最新迁移。</p>
</li>
<li>
<p>如果数据库不存在，会自动创建。</p>
</li>
</ul>
<p>可指定版本：</p>
<pre><code class="hljs language-shell" lang="shell">dotnet ef database update InitialCreate
</code></pre>
<p>将数据库回滚到指定迁移（或升级到某个中间版本）。</p>
<h4 data-id="heading-5">查看迁移</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef migrations list
</code></pre>
<p>输出：</p>
<pre><code class="hljs">20250922121212_InitialCreate
20250923104530_AddUserTable
</code></pre>
<h4 data-id="heading-6">删除迁移</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef migrations remove
</code></pre>
<ul>
<li>
<p>删除最新迁移文件。</p>
</li>
<li>
<p>仅限未执行 <code>database update</code> 的迁移。</p>
</li>
</ul>
<h4 data-id="heading-7">生成 SQL 脚本</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef migrations script
</code></pre>
<ul>
<li>
<p>生成从初始数据库到最新迁移的 <code>SQL</code> 脚本。</p>
</li>
<li>
<p>可指定起止迁移：</p>
</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">dotnet ef migrations script InitialCreate AddUserTable -o update.sql
</code></pre>
<h4 data-id="heading-8">删除数据库</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef database drop
</code></pre>
<ul>
<li>
<p>交互式确认后删除数据库。</p>
</li>
<li>
<p>可加 <code>--force</code> 跳过确认。</p>
</li>
</ul>
<h4 data-id="heading-9">查看 DbContext 信息</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef dbcontext info
</code></pre>
<p>输出数据库提供程序、连接字符串等信息。</p>
<h4 data-id="heading-10">列出 DbContext</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef dbcontext list
</code></pre>
<p>用于多上下文项目，可快速确认可用的 <code>DbContext</code>。</p>
<h4 data-id="heading-11">数据库逆向生成实体 (Database First)</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef dbcontext scaffold \
"Server=localhost;Database=MyDb;User Id=sa;Password=Passw0rd;" \
Microsoft.EntityFrameworkCore.SqlServer \
--output-dir Models --context MyDbContext
</code></pre>
<p>常用参数：</p>





























<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>--schema</code></td><td>指定数据库模式</td></tr><tr><td><code>--table</code></td><td>指定表（可多次指定）</td></tr><tr><td><code>--context-dir</code></td><td>指定 DbContext 文件夹</td></tr><tr><td><code>--force</code></td><td>覆盖已有文件</td></tr><tr><td><code>--use-database-names</code></td><td>保留数据库原始命名（不做 PascalCase 转换）</td></tr></tbody></table>
<h4 data-id="heading-12">模型预编译优化</h4>
<p><code>EF Core 6+</code> 提供：</p>
<pre><code class="hljs language-shell" lang="shell">dotnet ef dbcontext optimize
</code></pre>
<ul>
<li>
<p>在编译时预生成模型元数据，提升启动速度。</p>
</li>
<li>
<p>适合大型数据库或高性能场景。</p>
</li>
</ul>
<h3 data-id="heading-13">开发常用流程示例</h3>
<h4 data-id="heading-14">Code First 开发流程</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">1. 添加初始迁移</span>
dotnet ef migrations add InitialCreate
<span class="hljs-meta prompt_">
# </span><span class="bash">2. 创建/更新数据库</span>
dotnet ef database update
<span class="hljs-meta prompt_">
# </span><span class="bash">3. 修改实体模型后生成新迁移</span>
dotnet ef migrations add AddUserTable
<span class="hljs-meta prompt_">
# </span><span class="bash">4. 应用到数据库</span>
dotnet ef database update
</code></pre>
<h4 data-id="heading-15">Database First 开发流程</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">从现有数据库生成实体与上下文</span>
dotnet ef dbcontext scaffold \
"Server=localhost;Database=MyDb;User Id=sa;Password=Passw0rd;" \
Microsoft.EntityFrameworkCore.SqlServer \
--output-dir Models
</code></pre>
<h3 data-id="heading-16">常见问题与技巧</h3>





























<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>找不到 <code>dotnet ef</code> 命令</strong></td><td><code>dotnet tool install --global dotnet-ef</code></td></tr><tr><td><strong>提示找不到 DbContext</strong></td><td>检查 <code>--startup-project</code> 或 <code>--context</code> 是否指定正确</td></tr><tr><td><strong>跨项目调用失败</strong></td><td>使用 <code>--project</code> 指定包含迁移的类库项目，<code>--startup-project</code> 指定启动项目</td></tr><tr><td><strong>数据库连接不生效</strong></td><td>检查 <code>Program.cs</code> 中 <code>UseSqlServer/UseNpgsql</code> 配置</td></tr><tr><td><strong>生产环境手动部署</strong></td><td>使用 <code>dotnet ef migrations script</code> 生成 SQL 并在 DBA 审核后执行</td></tr></tbody></table>
<h3 data-id="heading-17">总结</h3>





























<table><thead><tr><th>命令</th><th>场景</th></tr></thead><tbody><tr><td><code>dotnet ef migrations add</code></td><td><strong>创建迁移</strong></td></tr><tr><td><code>dotnet ef database update</code></td><td><strong>同步数据库</strong></td></tr><tr><td><code>dotnet ef migrations list</code></td><td><strong>查看迁移历史</strong></td></tr><tr><td><code>dotnet ef dbcontext scaffold</code></td><td><strong>逆向工程</strong></td></tr><tr><td><code>dotnet ef migrations script</code></td><td><strong>生成 SQL 脚本</strong></td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手写一个 Askama 模板压缩工具]]></title>    <link>https://juejin.cn/post/7586872817876074522</link>    <guid>https://juejin.cn/post/7586872817876074522</guid>    <pubDate>2025-12-23T13:56:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586872817876074522" data-draft-id="7586877892467916827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手写一个 Askama 模板压缩工具"/> <meta itemprop="keywords" content="性能优化,Rust,前端"/> <meta itemprop="datePublished" content="2025-12-23T13:56:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jump_jump"/> <meta itemprop="url" content="https://juejin.cn/user/4230576474692765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手写一个 Askama 模板压缩工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4230576474692765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jump_jump
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T13:56:07.000Z" title="Tue Dec 23 2025 13:56:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    32
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Web 开发中，前端资源的大小直接影响用户体验。大型模板文件不仅占用带宽，还会延长页面加载时间。虽然市面上有很多 HTML 压缩工具，但对于使用了模板引擎的 HTML 文件（如 Askama、Jinja2 等），通用压缩器往往会破坏模板语法。</p>
<p>于是个人写了一个 Askama 模板压缩工具 askama-minify，专门用于压缩 Askama 模板文件，同时完美保留模板语法。</p>
<h2 data-id="heading-0">Askama 为什么要压缩</h2>
<h3 data-id="heading-1">模板文件占用的空间</h3>
<p>在实际的 Web 项目中，模板文件往往占据相当大的体积：</p>





























<table><thead><tr><th>项目类型</th><th>模板数量</th><th>总大小</th><th>压缩后大小</th></tr></thead><tbody><tr><td>小型网站</td><td>10-20</td><td>200-500KB</td><td>100-250KB</td></tr><tr><td>中型应用</td><td>50-100</td><td>1-3MB</td><td>500KB-1.5MB</td></tr><tr><td>大型系统</td><td>200+</td><td>5-10MB</td><td>2-5MB</td></tr></tbody></table>
<h3 data-id="heading-2">压缩的好处</h3>
<ol>
<li><strong>减少带宽消耗</strong>：模板大小减少 40-55%，直接降低流量成本</li>
<li><strong>加快页面加载</strong>：更小的文件意味着更快的传输速度</li>
<li><strong>提升用户体验</strong>：首屏渲染时间缩短，特别是移动端用户</li>
<li><strong>降低服务器负载</strong>：传输数据量减少，服务器压力降低</li>
<li><strong>节省存储空间</strong>：生产环境的模板文件占用更少空间</li>
</ol>
<h3 data-id="heading-3">Askama 自带的压缩配置</h3>
<p>Askama 本身提供了 whitespace 控制功能，在项目根目录的 <code>askama.toml</code> 中配置：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[general]</span>
<span class="hljs-comment"># 三种模式可选</span>
<span class="hljs-attr">whitespace</span> = <span class="hljs-string">"suppress"</span>   <span class="hljs-comment"># 或 "minimize" / "preserve"</span>
</code></pre>
<p><strong>三种模式对比：</strong></p>

























<table><thead><tr><th>模式</th><th>行为</th><th>适用场景</th></tr></thead><tbody><tr><td><code>preserve</code></td><td>保留所有空白（默认）</td><td>开发调试</td></tr><tr><td><code>suppress</code></td><td>激进移除空白</td><td>生产环境</td></tr><tr><td><code>minimize</code></td><td>适度移除空白</td><td>平衡模式</td></tr></tbody></table>
<p>也可以在单个模板上覆盖：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Template)]</span>
<span class="hljs-meta">#[template(path = <span class="hljs-string">"example.html"</span>, whitespace = <span class="hljs-string">"suppress"</span>)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ExampleTemplate</span>;
</code></pre>
<h3 data-id="heading-4">Askama 自带压缩的局限性</h3>
<p>Askama 的 whitespace 控制有以下限制：</p>
<ol>
<li><strong>只处理空白字符</strong>：不能移除 HTML 注释 <code>&lt;!-- --&gt;</code></li>
<li><strong>不影响 CSS</strong>：<code>&lt;style&gt;</code> 标签内的 CSS 完全保留</li>
<li><strong>不影响 JavaScript</strong>：<code>&lt;script&gt;</code> 标签内的 JS 完全保留</li>
<li><strong>不优化代码</strong>：无法进行属性合并、颜色优化等</li>
</ol>
<p><strong>示例对比：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 原始模板 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> {
        <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">0</span>;
        <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">0</span>;
        <span class="hljs-comment">/* 这是 CSS 注释 */</span>
        <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ff0000</span>;
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 这是 JS 注释</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- Askama whitespace = "suppress" 的结果 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"><span class="hljs-selector-tag">body</span>{<span class="hljs-attribute">margin-top</span>:<span class="hljs-number">0</span>;<span class="hljs-attribute">margin-bottom</span>:<span class="hljs-number">0</span>;<span class="hljs-comment">/*这是CSS注释*/</span><span class="hljs-attribute">background-color</span>:<span class="hljs-number">#ff0000</span>;}</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-comment">//这是JS注释</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- askama-minify 的结果 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"><span class="hljs-selector-tag">body</span>{<span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span> <span class="hljs-number">0</span>;<span class="hljs-attribute">background-color</span>:red}</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>可以看到，askama-minify 做得更彻底：</p>
<ul>
<li>移除了所有注释</li>
<li>合并了 CSS 属性</li>
<li>优化了颜色值</li>
<li>压缩了 JavaScript</li>
</ul>
<h2 data-id="heading-5">项目演进</h2>
<p>任何项目都不是一蹴而就的，下面是关于 askama-minify 库的编写思路。希望能对大家有一些帮助。</p>
<h2 data-id="heading-6">为什么需要专门的工具（补充）</h2>
<p>在使用 Askama 这样的 Rust 模板引擎时，我们的模板文件中会包含特殊的语法：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- Askama 模板语法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
{% for item in items %}
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
{% endfor %}
</code></pre>
<p>通用的 HTML 压缩器（如 html-minifier）可能会：</p>
<ul>
<li>将 <code>{{ }}</code> 识别为无效语法而破坏</li>
<li>将 <code>{% %}</code> 中的空格错误处理</li>
<li>无法区分模板语法和普通文本</li>
</ul>
<p>因此我们需要一个专门设计的压缩工具。</p>
<h2 data-id="heading-7">简单的 HTML 压缩</h2>
<p>最基础的 HTML 压缩非常简单：移除多余的空白字符即可。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_html_simple</span>(content: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">result</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(content.<span class="hljs-title function_ invoke__">len</span>());
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">last_was_space</span> = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">for</span> <span class="hljs-variable">ch</span> <span class="hljs-keyword">in</span> content.<span class="hljs-title function_ invoke__">chars</span>() {
        <span class="hljs-keyword">if</span> ch.<span class="hljs-title function_ invoke__">is_whitespace</span>() {
            <span class="hljs-keyword">if</span> !last_was_space &amp;&amp; !result.<span class="hljs-title function_ invoke__">is_empty</span>() {
                result.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-string">' '</span>);
                last_was_space = <span class="hljs-literal">true</span>;
            }
        } <span class="hljs-keyword">else</span> {
            result.<span class="hljs-title function_ invoke__">push</span>(ch);
            last_was_space = <span class="hljs-literal">false</span>;
        }
    }

    result
}
</code></pre>
<p>这个简单版本会将：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>   Hello   <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>压缩为：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span> Hello <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>但这样还不够——我们需要：</p>
<ol>
<li>移除 HTML 注释</li>
<li>处理特殊标签（<code>&lt;pre&gt;</code>, <code>&lt;textarea&gt;</code>）</li>
<li>保留模板语法</li>
</ol>
<h2 data-id="heading-8">保留模板语法</h2>
<p>模板语法的保留是本工具的核心。我们需要在遇到 <code>{{</code> 和 <code>{%</code> 时，保持原样输出，直到遇到对应的 <code>}}</code> 和 <code>%}</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_html</span>(content: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">result</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(content.<span class="hljs-title function_ invoke__">len</span>());
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">chars</span> = content.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">peekable</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_template_brace</span> = <span class="hljs-literal">false</span>;  <span class="hljs-comment">// {{ }}</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_template_chevron</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// {% %}</span>

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(ch) = chars.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-comment">// 检测模板语法开始</span>
        <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'{'</span> {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(&amp;next_ch) = chars.<span class="hljs-title function_ invoke__">peek</span>() {
                <span class="hljs-keyword">if</span> next_ch == <span class="hljs-string">'{'</span> {
                    in_template_brace = <span class="hljs-literal">true</span>;
                    result.<span class="hljs-title function_ invoke__">push</span>(ch);
                    <span class="hljs-keyword">continue</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> next_ch == <span class="hljs-string">'%'</span> {
                    in_template_chevron = <span class="hljs-literal">true</span>;
                    result.<span class="hljs-title function_ invoke__">push</span>(ch);
                    <span class="hljs-keyword">continue</span>;
                }
            }
        }

        <span class="hljs-comment">// 在模板语法内，保持原样</span>
        <span class="hljs-keyword">if</span> in_template_brace || in_template_chevron {
            result.<span class="hljs-title function_ invoke__">push</span>(ch);
            <span class="hljs-comment">// 检测模板语法结束</span>
            <span class="hljs-keyword">if</span> in_template_brace &amp;&amp; ch == <span class="hljs-string">'}'</span> &amp;&amp; result.<span class="hljs-title function_ invoke__">ends_with</span>(<span class="hljs-string">"}}"</span>) {
                in_template_brace = <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> in_template_chevron &amp;&amp; ch == <span class="hljs-string">'}'</span> &amp;&amp; result.<span class="hljs-title function_ invoke__">ends_with</span>(<span class="hljs-string">"%}"</span>) {
                in_template_chevron = <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// ... 其他处理逻辑</span>
    }

    result
}
</code></pre>
<p>测试一下：</p>
<pre><code class="hljs language-javascript" lang="javascript">输入: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
输出: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>  <span class="hljs-comment">// 完美保留</span>

输入: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>  {{  title  }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
输出: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span> {{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>  <span class="hljs-comment">// 模板外空格压缩，模板内保留</span>
</code></pre>
<h2 data-id="heading-9">移除 HTML 注释</h2>
<p>HTML 注释的移除需要小心，不能破坏字符串中的 <code>&lt;!--</code>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// HTML 注释处理（只在不在 script/style 内时处理）</span>
<span class="hljs-keyword">if</span> !in_script &amp;&amp; !in_style &amp;&amp; ch == <span class="hljs-string">'&lt;'</span> &amp;&amp; chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'!'</span>) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">comment</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"&lt;"</span>);
    comment.<span class="hljs-title function_ invoke__">push</span>(chars.<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">unwrap</span>()); <span class="hljs-comment">// '!'</span>

    <span class="hljs-keyword">if</span> chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'-'</span>) {
        comment.<span class="hljs-title function_ invoke__">push</span>(chars.<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">unwrap</span>()); <span class="hljs-comment">// first '-'</span>
        <span class="hljs-keyword">if</span> chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'-'</span>) {
            comment.<span class="hljs-title function_ invoke__">push</span>(chars.<span class="hljs-title function_ invoke__">next</span>().<span class="hljs-title function_ invoke__">unwrap</span>()); <span class="hljs-comment">// second '-'</span>
            <span class="hljs-comment">// 这是一个注释，跳过直到 --&gt;</span>
            <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(c) = chars.<span class="hljs-title function_ invoke__">next</span>() {
                comment.<span class="hljs-title function_ invoke__">push</span>(c);
                <span class="hljs-keyword">if</span> comment.<span class="hljs-title function_ invoke__">ends_with</span>(<span class="hljs-string">"--&gt;"</span>) {
                    <span class="hljs-keyword">break</span>;
                }
            }
            <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// 跳过注释</span>
        }
    }
    result.<span class="hljs-title function_ invoke__">push_str</span>(&amp;comment);
    <span class="hljs-keyword">continue</span>;
}
</code></pre>
<h2 data-id="heading-10">处理特殊标签</h2>
<p>某些标签（如 <code>&lt;pre&gt;</code> 和 <code>&lt;textarea&gt;</code>）的内容需要完全保留原样，包括空格和换行：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_pre</span> = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_textarea</span> = <span class="hljs-literal">false</span>;

<span class="hljs-comment">// 在标签检测时</span>
<span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"pre"</span> {
    in_pre = <span class="hljs-literal">true</span>;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"textarea"</span> {
    in_textarea = <span class="hljs-literal">true</span>;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"/pre"</span> {
    in_pre = <span class="hljs-literal">false</span>;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"/textarea"</span> {
    in_textarea = <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// 在字符处理时</span>
<span class="hljs-keyword">if</span> in_pre || in_textarea {
    result.<span class="hljs-title function_ invoke__">push</span>(ch);  <span class="hljs-comment">// 完全保留</span>
    <span class="hljs-keyword">continue</span>;
}
</code></pre>
<h2 data-id="heading-11">添加 CSS 优化</h2>
<p>HTML 中的 <code>&lt;style&gt;</code> 标签内容可以使用专业的 CSS 优化器。这里选择 lightningcss，它是 Parcel 团队开发的高性能 CSS 解析器：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> lightningcss::stylesheet::{MinifyOptions, ParserOptions, PrinterOptions, StyleSheet};

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_css</span>(css_code: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">stylesheet</span> = StyleSheet::<span class="hljs-title function_ invoke__">parse</span>(css_code, ParserOptions::<span class="hljs-title function_ invoke__">default</span>());

    <span class="hljs-keyword">match</span> stylesheet {
        <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-keyword">mut</span> sheet) =&gt; {
            sheet.<span class="hljs-title function_ invoke__">minify</span>(MinifyOptions::<span class="hljs-title function_ invoke__">default</span>()).<span class="hljs-title function_ invoke__">ok</span>();
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = sheet.<span class="hljs-title function_ invoke__">to_css</span>(PrinterOptions {
                minify: <span class="hljs-literal">true</span>,
                ..PrinterOptions::<span class="hljs-title function_ invoke__">default</span>()
            });

            <span class="hljs-keyword">match</span> result {
                <span class="hljs-title function_ invoke__">Ok</span>(output) =&gt; output.code,
                <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; {
                    eprintln!(<span class="hljs-string">"Warning: Failed to minify CSS: {:?}"</span>, e);
                    css_code.<span class="hljs-title function_ invoke__">to_string</span>()
                },
            }
        }
        <span class="hljs-title function_ invoke__">Err</span>(e) =&gt; {
            eprintln!(<span class="hljs-string">"Warning: Failed to parse CSS: {:?}"</span>, e);
            css_code.<span class="hljs-title function_ invoke__">to_string</span>()
        },
    }
}
</code></pre>
<p>lightningcss 的优化效果非常好：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 输入 */</span>
<span class="hljs-selector-tag">body</span> {
    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ff0000</span>;
}

<span class="hljs-comment">/* 输出 */</span>
<span class="hljs-selector-tag">body</span>{<span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span> <span class="hljs-number">0</span>;<span class="hljs-attribute">background-color</span>:red}
</code></pre>
<ul>
<li>属性合并：<code>margin-top: 0; margin-bottom: 0</code> → <code>margin: 0 0</code></li>
<li>颜色优化：<code>#ff0000</code> → <code>red</code></li>
<li>移除所有不必要的空格和换行</li>
</ul>
<h2 data-id="heading-12">添加 JavaScript 压缩</h2>
<p>JavaScript 的压缩需要更加小心，因为：</p>
<ol>
<li>字符串中的注释语法不应被处理</li>
<li>除法运算符 <code>/</code> 容易与注释混淆</li>
<li>转义字符需要正确处理（<code>\"</code>, <code>\'</code>）</li>
<li>正则表达式需要保护</li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_js</span>(js_code: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">result</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(js_code.<span class="hljs-title function_ invoke__">len</span>());
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">chars</span> = js_code.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">peekable</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_string</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_single_comment</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_multi_comment</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">string_char</span> = <span class="hljs-string">'\0'</span>;

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(ch) = chars.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-comment">// 处理单行注释</span>
        <span class="hljs-keyword">if</span> !in_string &amp;&amp; !in_multi_comment &amp;&amp; ch == <span class="hljs-string">'/'</span> &amp;&amp; chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'/'</span>) {
            in_single_comment = <span class="hljs-literal">true</span>;
            chars.<span class="hljs-title function_ invoke__">next</span>(); <span class="hljs-comment">// 跳过第二个 /</span>
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">if</span> in_single_comment {
            <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'\n'</span> {
                in_single_comment = <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 处理多行注释</span>
        <span class="hljs-keyword">if</span> !in_string &amp;&amp; !in_single_comment &amp;&amp; ch == <span class="hljs-string">'/'</span> &amp;&amp; chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'*'</span>) {
            in_multi_comment = <span class="hljs-literal">true</span>;
            chars.<span class="hljs-title function_ invoke__">next</span>(); <span class="hljs-comment">// 跳过 *</span>
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">if</span> in_multi_comment {
            <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'*'</span> &amp;&amp; chars.<span class="hljs-title function_ invoke__">peek</span>() == <span class="hljs-title function_ invoke__">Some</span>(&amp;<span class="hljs-string">'/'</span>) {
                in_multi_comment = <span class="hljs-literal">false</span>;
                chars.<span class="hljs-title function_ invoke__">next</span>(); <span class="hljs-comment">// 跳过 /</span>
            }
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 处理字符串</span>
        <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'"'</span> || ch == <span class="hljs-string">'\''</span> || ch == <span class="hljs-string">'`'</span> {
            <span class="hljs-keyword">if</span> !in_string {
                in_string = <span class="hljs-literal">true</span>;
                string_char = ch;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ch == string_char {
                <span class="hljs-comment">// 检查是否被转义：计算前面的反斜杠数量</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">backslash_count</span> = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">temp_result</span> = result.<span class="hljs-title function_ invoke__">clone</span>();
                <span class="hljs-keyword">while</span> temp_result.<span class="hljs-title function_ invoke__">ends_with</span>(<span class="hljs-string">'\\'</span>) {
                    backslash_count += <span class="hljs-number">1</span>;
                    temp_result.<span class="hljs-title function_ invoke__">pop</span>();
                }
                <span class="hljs-comment">// 偶数个反斜杠（包括0个）意味着引号没有被转义</span>
                <span class="hljs-keyword">if</span> backslash_count % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> {
                    in_string = <span class="hljs-literal">false</span>;
                }
            }
            result.<span class="hljs-title function_ invoke__">push</span>(ch);
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-keyword">if</span> in_string {
            result.<span class="hljs-title function_ invoke__">push</span>(ch);
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// 压缩空白（保留必要的空格）</span>
        <span class="hljs-comment">// ...</span>
    }

    result
}
</code></pre>
<p>测试转义字符处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 输入</span>
<span class="hljs-keyword">let</span> s = <span class="hljs-string">"test\\"</span>;  <span class="hljs-comment">// 字符串中有转义的反斜杠</span>
<span class="hljs-keyword">let</span> s2 = <span class="hljs-string">'quote\''</span>;

<span class="hljs-comment">// 输出</span>
<span class="hljs-keyword">let</span> s=<span class="hljs-string">"test\\"</span>;   <span class="hljs-comment">// 正确保留转义字符</span>
<span class="hljs-keyword">let</span> s2=<span class="hljs-string">'quote\''</span>;  <span class="hljs-comment">// 正确保留转义字符</span>
</code></pre>
<h2 data-id="heading-13">整合三层压缩</h2>
<p>将 HTML、CSS、JS 压缩整合在一起，在解析 HTML 时识别 <code>&lt;script&gt;</code> 和 <code>&lt;style&gt;</code> 标签：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">minify_html</span>(content: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_script</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">in_style</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">script_content</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">style_content</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();

    <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(ch) = chars.<span class="hljs-title function_ invoke__">next</span>() {
        <span class="hljs-comment">// 标签处理</span>
        <span class="hljs-keyword">if</span> ch == <span class="hljs-string">'&lt;'</span> {
            <span class="hljs-comment">// ... 读取标签名</span>

            <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"script"</span> {
                in_script = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"/script"</span> {
                <span class="hljs-comment">// 压缩并输出 script 内容</span>
                <span class="hljs-keyword">if</span> !script_content.<span class="hljs-title function_ invoke__">trim</span>().<span class="hljs-title function_ invoke__">is_empty</span>() {
                    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">minified</span> = <span class="hljs-title function_ invoke__">minify_js</span>(&amp;script_content);
                    result.<span class="hljs-title function_ invoke__">push_str</span>(&amp;minified);
                }
                script_content.<span class="hljs-title function_ invoke__">clear</span>();
                in_script = <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"style"</span> {
                in_style = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> tag_name == <span class="hljs-string">"/style"</span> {
                <span class="hljs-comment">// 压缩并输出 style 内容</span>
                <span class="hljs-keyword">if</span> !style_content.<span class="hljs-title function_ invoke__">trim</span>().<span class="hljs-title function_ invoke__">is_empty</span>() {
                    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">minified</span> = <span class="hljs-title function_ invoke__">minify_css</span>(&amp;style_content);
                    result.<span class="hljs-title function_ invoke__">push_str</span>(&amp;minified);
                }
                style_content.<span class="hljs-title function_ invoke__">clear</span>();
                in_style = <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-comment">// 收集 script/style 内容</span>
        <span class="hljs-keyword">if</span> !in_tag {
            <span class="hljs-keyword">if</span> in_script {
                script_content.<span class="hljs-title function_ invoke__">push</span>(ch);
                <span class="hljs-keyword">continue</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> in_style {
                style_content.<span class="hljs-title function_ invoke__">push</span>(ch);
                <span class="hljs-keyword">continue</span>;
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-14">压缩效果</h2>
<p>经过三层压缩，整体压缩率可达 <strong>40-55%</strong>：</p>






























<table><thead><tr><th>层级</th><th>贡献率</th><th>示例</th></tr></thead><tbody><tr><td>CSS 优化</td><td>20-30%</td><td><code>margin-top: 0; margin-bottom: 0</code> → <code>margin:0 0</code></td></tr><tr><td>JS 压缩</td><td>15-25%</td><td>移除注释和空白</td></tr><tr><td>HTML 压缩</td><td>10-15%</td><td>移除换行和缩进</td></tr><tr><td>注释移除</td><td>5-10%</td><td>取决于注释密度</td></tr></tbody></table>
<p>完整示例：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 输入：324 字节 --&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 这是注释 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f0f0f0</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ heading }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    {% for item in items %}
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    {% endfor %}
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 这是注释</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 输出：152 字节，-53% --&gt;</span>
<span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">zh-CN</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">UTF-8</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css"><span class="hljs-selector-tag">body</span>{<span class="hljs-attribute">background-color</span>:<span class="hljs-number">#f0f0f0</span>;<span class="hljs-attribute">margin</span>:<span class="hljs-number">0</span>;<span class="hljs-attribute">padding</span>:<span class="hljs-number">20px</span>}</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ heading }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>{% for item in items %} <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ item.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>{% endfor %}<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello"</span>);</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-15">其他技术细节</h2>
<h3 data-id="heading-16">命令行参数设计</h3>
<p>使用 clap 库来处理命令行参数：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> clap::Parser;

<span class="hljs-meta">#[derive(Parser, Debug)]</span>
<span class="hljs-meta">#[command(name = <span class="hljs-string">"askama-minify"</span>)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Args</span> {
    <span class="hljs-comment">/// 要压缩的文件或文件夹路径</span>
    <span class="hljs-meta">#[arg(value_name = <span class="hljs-string">"PATH"</span>)]</span>
    path: PathBuf,

    <span class="hljs-comment">/// 递归处理文件夹（默认启用）</span>
    <span class="hljs-meta">#[arg(short, long, default_value_t = true)]</span>
    recursive: <span class="hljs-type">bool</span>,

    <span class="hljs-comment">/// 输出文件或文件夹路径</span>
    <span class="hljs-meta">#[arg(short = 'd', long)]</span>
    output: <span class="hljs-type">Option</span>&lt;PathBuf&gt;,

    <span class="hljs-comment">/// 输出文件的后缀名（例如: "min" 会生成 .min.html）</span>
    <span class="hljs-meta">#[arg(short = 's', long)]</span>
    suffix: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">String</span>&gt;,
}
</code></pre>
<h3 data-id="heading-17">文件处理优化</h3>
<p>使用 walkdir 库实现高效的文件夹遍历：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> walkdir::WalkDir;

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">walker</span> = <span class="hljs-keyword">if</span> recursive {
    WalkDir::<span class="hljs-title function_ invoke__">new</span>(path)
} <span class="hljs-keyword">else</span> {
    WalkDir::<span class="hljs-title function_ invoke__">new</span>(path).<span class="hljs-title function_ invoke__">max_depth</span>(<span class="hljs-number">1</span>)
};

<span class="hljs-keyword">for</span> <span class="hljs-variable">entry</span> <span class="hljs-keyword">in</span> walker.<span class="hljs-title function_ invoke__">into_iter</span>().<span class="hljs-title function_ invoke__">filter_map</span>(|e| e.<span class="hljs-title function_ invoke__">ok</span>()) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file_path</span> = entry.<span class="hljs-title function_ invoke__">path</span>();
    <span class="hljs-keyword">if</span> !file_path.<span class="hljs-title function_ invoke__">is_file</span>() || !<span class="hljs-title function_ invoke__">is_template_file</span>(file_path) {
        <span class="hljs-keyword">continue</span>;
    }
    <span class="hljs-comment">// 处理文件...</span>
}
</code></pre>
<h3 data-id="heading-18">代码质量优化</h3>
<ol>
<li><strong>常量提取</strong>：避免魔法字符串</li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">const</span> DEFAULT_SUFFIX: &amp;<span class="hljs-type">str</span> = <span class="hljs-string">"min"</span>;
<span class="hljs-keyword">const</span> MIN_MARKER: &amp;<span class="hljs-type">str</span> = <span class="hljs-string">".min."</span>;
<span class="hljs-keyword">const</span> VALID_EXTENSIONS: &amp;[&amp;<span class="hljs-type">str</span>] = &amp;[<span class="hljs-string">"html"</span>, <span class="hljs-string">"htm"</span>, <span class="hljs-string">"xml"</span>, <span class="hljs-string">"svg"</span>];
</code></pre>
<ol start="2">
<li><strong>避免不必要的字符串分配</strong>：使用 <code>eq_ignore_ascii_case</code> 而不是 <code>to_lowercase()</code></li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 优化后</span>
ext_str.<span class="hljs-title function_ invoke__">eq_ignore_ascii_case</span>(valid_ext)

<span class="hljs-comment">// 优化前（会创建新字符串）</span>
ext_str.<span class="hljs-title function_ invoke__">to_lowercase</span>() == valid_ext
</code></pre>
<ol start="3">
<li><strong>空文件快速处理</strong></li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">if</span> original_size == <span class="hljs-number">0</span> {
    fs::<span class="hljs-title function_ invoke__">write</span>(output_path, <span class="hljs-string">""</span>)?;
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Ok</span>((<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));
}
</code></pre>
<h2 data-id="heading-19">使用方式</h2>
<h3 data-id="heading-20">安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/wsafight/askama-minify.git
<span class="hljs-built_in">cd</span> askama-minify

<span class="hljs-comment"># 编译</span>
cargo build --release
</code></pre>
<p>编译后的二进制文件位于 <code>target/release/askama-minify</code>。</p>
<h3 data-id="heading-21">基本用法</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 压缩单个文件（默认生成 .min.html 后缀）</span>
./target/release/askama-minify template.html

<span class="hljs-comment"># 指定输出文件</span>
./target/release/askama-minify -d output.html template.html

<span class="hljs-comment"># 压缩整个文件夹</span>
./target/release/askama-minify templates/

<span class="hljs-comment"># 输出到指定目录并保持目录结构</span>
./target/release/askama-minify -d dist/ templates/
</code></pre>
<h3 data-id="heading-22">命令行选项</h3>





























<table><thead><tr><th>选项</th><th>简写</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>--output &lt;PATH&gt;</code></td><td><code>-d</code></td><td>输出文件或文件夹路径</td><td>原路径</td></tr><tr><td><code>--suffix &lt;SUFFIX&gt;</code></td><td><code>-s</code></td><td>输出文件后缀名</td><td><code>min</code></td></tr><tr><td><code>--recursive</code></td><td><code>-r</code></td><td>递归处理子文件夹</td><td><code>true</code></td></tr></tbody></table>
<h3 data-id="heading-23">后缀规则</h3>






























<table><thead><tr><th>配置</th><th>结果</th><th>示例</th></tr></thead><tbody><tr><td>无 <code>-d</code> 无 <code>-s</code></td><td>默认后缀 <code>min</code></td><td><code>file.html</code> → <code>file.min.html</code></td></tr><tr><td>无 <code>-d</code> 有 <code>-s</code></td><td>自定义后缀</td><td><code>file.html</code> + <code>-s prod</code> → <code>file.prod.html</code></td></tr><tr><td>有 <code>-d</code> 无 <code>-s</code></td><td>不添加后缀</td><td><code>file.html</code> + <code>-d out.html</code> → <code>out.html</code></td></tr><tr><td>有 <code>-d</code> 有 <code>-s</code></td><td>后缀 + 自定义路径</td><td><code>file.html</code> + <code>-d out/</code> + <code>-s prod</code> → <code>out/file.prod.html</code></td></tr></tbody></table>
<h3 data-id="heading-24">集成到构建流程</h3>
<h4 data-id="heading-25">方式一：在 <code>build.rs</code> 中使用</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// build.rs</span>
<span class="hljs-keyword">use</span> std::process::Command;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 在生产构建时自动压缩模板</span>
    <span class="hljs-keyword">if</span> std::env::<span class="hljs-title function_ invoke__">var</span>(<span class="hljs-string">"PROFILE"</span>).<span class="hljs-title function_ invoke__">as_deref</span>() == <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-string">"release"</span>) {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">status</span> = Command::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">"./target/release/askama-minify"</span>)
            .<span class="hljs-title function_ invoke__">args</span>([<span class="hljs-string">"-d"</span>, <span class="hljs-string">"dist/templates/"</span>, <span class="hljs-string">"templates/"</span>])
            .<span class="hljs-title function_ invoke__">status</span>()
            .<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"Failed to execute askama-minify"</span>);

        <span class="hljs-keyword">if</span> !status.<span class="hljs-title function_ invoke__">success</span>() {
            <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"Template minification failed"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-26">方式二：在 Makefile 中使用</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># Makefile</span>
<span class="hljs-meta"><span class="hljs-keyword">.PHONY</span>: build minify-templates</span>

<span class="hljs-section">build: minify-templates</span>
	cargo build --release

<span class="hljs-section">minify-templates:</span>
	askama-minify -d dist/templates/ -s prod templates/
</code></pre>
<h4 data-id="heading-27">方式三：在 CI/CD 中使用</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># .github/workflows/deploy.yml</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v3</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Rust</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions-rs/toolchain@v1</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">toolchain:</span> <span class="hljs-string">stable</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">askama-minify</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          git clone https://github.com/wsafight/askama-minify.git
          cd askama-minify
          cargo build --release
</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Minify</span> <span class="hljs-string">templates</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">./askama-minify/target/release/askama-minify</span> <span class="hljs-string">-d</span> <span class="hljs-string">dist/</span> <span class="hljs-string">-s</span> <span class="hljs-string">prod</span> <span class="hljs-string">templates/</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span>
        <span class="hljs-attr">run:</span> <span class="hljs-comment"># 你的部署脚本</span>
</code></pre>
<h3 data-id="heading-28">在 Askama 中使用压缩后的模板</h3>
<p>有两种使用方式：</p>
<h4 data-id="heading-29">方式一：切换模板路径（推荐）</h4>
<p>开发环境使用源模板，生产环境使用压缩模板：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> askama::Template;

<span class="hljs-meta">#[derive(Template)]</span>
<span class="hljs-meta">#[template(
    path = <span class="hljs-string">"{{ template_path }}"</span>,  // 通过配置传入
    whitespace = <span class="hljs-string">"suppress"</span>
)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">HomePage</span> {
    title: <span class="hljs-type">String</span>,
}

<span class="hljs-comment">// 根据环境变量选择模板路径</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_template_path</span>(name: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
    <span class="hljs-keyword">if</span> std::env::<span class="hljs-title function_ invoke__">var</span>(<span class="hljs-string">"PROFILE"</span>).<span class="hljs-title function_ invoke__">as_deref</span>() == <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-string">"release"</span>) {
        <span class="hljs-built_in">format!</span>(<span class="hljs-string">"dist/{}.prod.html"</span>, name)  <span class="hljs-comment">// 使用压缩版</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">format!</span>(<span class="hljs-string">"templates/{}.html"</span>, name)   <span class="hljs-comment">// 使用源文件</span>
    }
}
</code></pre>
<h4 data-id="heading-30">方式二：构建时替换</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开发环境</span>
<span class="hljs-built_in">cp</span> templates/*.html templates/

<span class="hljs-comment"># 生产构建时</span>
askama-minify -d templates/ -s prod templates/
</code></pre>
<h3 data-id="heading-31">实际项目示例</h3>
<p>假设你有以下项目结构：</p>
<pre><code class="hljs language-csharp" lang="csharp">my-app/
├── templates/
│   ├── <span class="hljs-keyword">base</span>.html
│   ├── index.html
│   └── user/
│       ├── profile.html
│       └── settings.html
├── dist/              <span class="hljs-meta"># 压缩后的输出目录</span>
├── Cargo.toml
└── build.rs
</code></pre>
<p><strong>开发时</strong>：直接使用 <code>templates/</code> 下的原始文件</p>
<p><strong>部署前</strong>：运行压缩命令</p>
<pre><code class="hljs language-bash" lang="bash">askama-minify -d dist/ -s prod templates/
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-csharp" lang="csharp">dist/
├── <span class="hljs-keyword">base</span>.prod.html
├── index.prod.html
└── user/
    ├── profile.prod.html
    └── settings.prod.html
</code></pre>
<p><strong>配置 Askama 使用生产模板</strong>：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-comment"># askama.toml</span>
<span class="hljs-section">[general]</span>
<span class="hljs-attr">dirs</span> = [<span class="hljs-string">"dist"</span>]  <span class="hljs-comment"># 指向压缩后的目录</span>
</code></pre>
<h2 data-id="heading-32">总结</h2>
<p>askama-minify 通过以下技术实现了高效的模板压缩：</p>
<ol>
<li><strong>模板语法保留</strong>：完整保留 <code>{{ }}</code> 和 <code>{% %}</code> 语法</li>
<li><strong>三层压缩策略</strong>：HTML 层、CSS 层、JS 层分别优化</li>
<li><strong>智能边缘处理</strong>：正确处理转义字符、运算符、正则表达式</li>
<li><strong>专业 CSS 优化</strong>：使用 lightningcss 进行属性合并和颜色优化</li>
<li><strong>Rust 实现</strong>：高性能、内存安全</li>
</ol>
<h3 data-id="heading-33">与 Askama 自带压缩的对比</h3>








































<table><thead><tr><th>特性</th><th>Askama whitespace</th><th>askama-minify</th></tr></thead><tbody><tr><td>空白压缩</td><td>✅</td><td>✅</td></tr><tr><td>HTML 注释移除</td><td>❌</td><td>✅</td></tr><tr><td>CSS 压缩优化</td><td>❌</td><td>✅</td></tr><tr><td>JavaScript 压缩</td><td>❌</td><td>✅</td></tr><tr><td>模板语法保留</td><td>✅</td><td>✅</td></tr><tr><td>构建时处理</td><td>❌</td><td>✅</td></tr></tbody></table>
<p>项目已开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwsafight%2Faskama-minify" target="_blank" title="https://github.com/wsafight/askama-minify" ref="nofollow noopener noreferrer">github.com/wsafight/as…</a></p>
<p>欢迎大家提出 issue 和 pr。</p>
<h2 data-id="heading-34">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fparcel-bundler%2Flightningcss" target="_blank" title="https://github.com/parcel-bundler/lightningcss" ref="nofollow noopener noreferrer">lightningcss</a> - 出色的 CSS 解析和优化工具</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclap-rs%2Fclap" target="_blank" title="https://github.com/clap-rs/clap" ref="nofollow noopener noreferrer">clap</a> - 强大的命令行参数解析库</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdjc%2Faskama" target="_blank" title="https://github.com/djc/askama" ref="nofollow noopener noreferrer">Askama</a> - 灵活的 Rust 模板引擎</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[纯算法AEC：播录并行场景的回声消除实战笔记]]></title>    <link>https://juejin.cn/post/7586686861390757939</link>    <guid>https://juejin.cn/post/7586686861390757939</guid>    <pubDate>2025-12-23T07:39:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586686861390757939" data-draft-id="7586657335880810523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="纯算法AEC：播录并行场景的回声消除实战笔记"/> <meta itemprop="keywords" content="Android,音视频开发"/> <meta itemprop="datePublished" content="2025-12-23T07:39:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李小轰_Rex"/> <meta itemprop="url" content="https://juejin.cn/user/3157453124930039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            纯算法AEC：播录并行场景的回声消除实战笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3157453124930039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李小轰_Rex
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T07:39:24.000Z" title="Tue Dec 23 2025 07:39:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">引言</h3>
<p>最近在做一款 AI 语音应用，场景类似“实时通话”：一边让 TTS 播报，一边把麦克风打开做 STT。</p>
<blockquote>
<p>问题在于，扬声器出来的声音下一秒就会被麦克风原封不动地录回去，STT 立刻把它当成用户再说一遍，形成“自己听懂自己”的无限循环。</p>
</blockquote>
<p>为了切断这条回声通路，我试了一圈硬件方案无果后，决定用纯算法在软件层把播报声音从录音里“抠”掉。</p>
<h3 data-id="heading-1">参考 WebRTC</h3>
<p>在我原有的设计里，TTS 播报走的是系统自带播放器，录音又来自 Android 系统原生的 AudioRecord，这是两条并行没有交集的数据处理线。如果继续保持原有设计，根本不可能实现效果，于是我参考 <strong>WebRTC</strong> 的设计。</p>
<blockquote>
<p>把 TTS 和录音全部“绑架”进 WebRTC 的轨道，让引擎重新掌控生命线。</p>
</blockquote>
<p>这里我用到了开源库：</p>
<pre><code class="hljs language-java" lang="java">implementation <span class="hljs-string">'io.github.webrtc-sdk:android:137.7151.05'</span>
</code></pre>
<h3 data-id="heading-2">方案设计</h3>
<p>我画了一张流程设计的简图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2790ea56133c4f32b20345515a29eaee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bCP6L2wX1JleA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081023&amp;x-signature=lT4ZegCYu9L%2Fy5%2FohA6%2FU1%2FX0rA%3D" alt="267cd2b8ae0273f5498dfb21d0509155.png" loading="lazy"/></p>
<ol>
<li>蓝色泳道 (TTS) : 负责产生声音。数据进入 AECSchedule 后，不仅是为了让用户听到（通过扬声器），更是为了告诉 AEC 算法“这是我们自己发出的声音，请不要把它当成用户说的话”。</li>
<li>橙色泳道 (AECSchedule) : 核心处理区。
<ul>
<li>关键点 : 虚线箭头表示 AudioTrack 播放的声音被用作 参考信号 (Reference Signal) 。</li>
<li>处理 : WebRTC 引擎 (ADM) 将 麦克风采集的声音 减去 参考信号 ，从而消除回声。</li>
</ul>
</li>
<li>绿色泳道 (STT) : 最终消费者。它接收到的音频是经过 AEC（回声消除）和 NS（降噪）处理后的纯净人声，从而提高识别准确率。</li>
</ol>
<p>方案流程非常清晰简单，下面是附上的 AECSchedule 源码，可以直接复制使用</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.media.AudioAttributes
<span class="hljs-keyword">import</span> android.media.AudioFormat
<span class="hljs-keyword">import</span> android.media.AudioManager
<span class="hljs-keyword">import</span> android.media.AudioTrack
<span class="hljs-keyword">import</span> com.jiale.business_voice.config.TTSAudioConfig
<span class="hljs-keyword">import</span> com.jiale.commom.tools.log.JLog
<span class="hljs-keyword">import</span> org.webrtc.*
<span class="hljs-keyword">import</span> org.webrtc.audio.AudioDeviceModule
<span class="hljs-keyword">import</span> org.webrtc.audio.JavaAudioDeviceModule
<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicBoolean

<span class="hljs-comment">/**
 * 基于 WebRTC 的回声消除调度器 (AECSchedule)
 *
 * 主要职责:
 * 1. 播放 (Playback): 管理 AudioTrack 以 VOICE_COMMUNICATION 模式播放 TTS 数据。
 *    这确保系统 AEC 将其视为“参考信号” (Reference Signal)。
 * 2. 录音 (Recording): 使用 WebRTC 的 JavaAudioDeviceModule (ADM) 采集音频。
 *    ADM 自动处理系统硬件 AEC/NS/AGC 配置。
 *    采集到的纯净音频通过回调暴露给外部。
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AECSchedule</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context, <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> outputCallback: (ByteArray) -&gt; <span class="hljs-built_in">Unit</span>) {

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TAG = <span class="hljs-string">"AECSchedule"</span>
        
        <span class="hljs-comment">// 音频配置</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> SAMPLE_RATE = TTSAudioConfig.SAMPLE_RATE
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> AUDIO_USAGE = AudioAttributes.USAGE_VOICE_COMMUNICATION
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> AUDIO_CONTENT_TYPE = AudioAttributes.CONTENT_TYPE_SPEECH
        
        <span class="hljs-comment">// WebRTC ID</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> AUDIO_TRACK_ID = <span class="hljs-string">"ARDAMSa0"</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> STREAM_ID = <span class="hljs-string">"ARDAMS"</span>

        <span class="hljs-comment">// WebRTC 约束条件 Keys</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> CONSTRAINT_ECHO_CANCELLATION = <span class="hljs-string">"googEchoCancellation"</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> CONSTRAINT_AUTO_GAIN_CONTROL = <span class="hljs-string">"googAutoGainControl"</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> CONSTRAINT_NOISE_SUPPRESSION = <span class="hljs-string">"googNoiseSuppression"</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> CONSTRAINT_HIGHPASS_FILTER = <span class="hljs-string">"googHighpassFilter"</span>
    }

    <span class="hljs-comment">// --- 播放相关 (Speaker) ---</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> audioTrack: AudioTrack? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> audioManager: AudioManager <span class="hljs-keyword">by</span> lazy {
        context.getSystemService(Context.AUDIO_SERVICE) <span class="hljs-keyword">as</span> AudioManager
    }

    <span class="hljs-comment">// --- 录音相关 (Mic &amp; Processing) ---</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> peerConnectionFactory: PeerConnectionFactory? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> audioDeviceModule: AudioDeviceModule? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> webrtcAudioSource: AudioSource? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> webrtcLocalTrack: org.webrtc.AudioTrack? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dummyPeerConnection: PeerConnection? = <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> isRecording = AtomicBoolean(<span class="hljs-literal">false</span>)
    <span class="hljs-meta">@Volatile</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> hasLoggedRecordInfo = <span class="hljs-literal">false</span>

    <span class="hljs-comment">// ============================================================================================</span>
    <span class="hljs-comment">// 播放逻辑 (TTS)</span>
    <span class="hljs-comment">// ============================================================================================</span>

    <span class="hljs-comment">/**
     * 接收 TTS 音频数据并进行播放。
     * 这些数据将作为 AEC 的“参考信号”。
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onTTSAudioData</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">ByteArray</span>)</span></span> {
        <span class="hljs-comment">// 确保音频路由到扬声器（广播模式）而不是听筒</span>
        setSpeakerphoneOn(<span class="hljs-literal">true</span>)
        
        <span class="hljs-keyword">if</span> (audioTrack == <span class="hljs-literal">null</span>) {
            initAudioTrack()
        }
        
        audioTrack?.let { track -&gt;
            <span class="hljs-keyword">if</span> (track.playState != AudioTrack.PLAYSTATE_PLAYING) {
                <span class="hljs-keyword">try</span> {
                    track.play()
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    JLog.e(TAG, <span class="hljs-string">"启动 AudioTrack 失败"</span>, e)
                    <span class="hljs-keyword">return</span>
                }
            }
            track.write(<span class="hljs-keyword">data</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">data</span>.size)
        }
    }

    <span class="hljs-comment">/**
     * 停止 TTS 播放并释放 AudioTrack 资源。
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stopPlay</span><span class="hljs-params">()</span></span> {
        safeExecute(<span class="hljs-string">"停止播放"</span>) {
            audioTrack?.let {
                <span class="hljs-keyword">if</span> (it.playState == AudioTrack.PLAYSTATE_PLAYING) {
                    it.stop()
                }
                it.release()
            }
        }
        audioTrack = <span class="hljs-literal">null</span>
    }

    <span class="hljs-comment">/**
     * 设置扬声器状态。
     * True: 路由到扬声器 (外放)。
     * False: 路由到听筒 (通话)。
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setSpeakerphoneOn</span><span class="hljs-params">(on: <span class="hljs-type">Boolean</span>)</span></span> {
        safeExecute(<span class="hljs-string">"设置扬声器"</span>) {
            <span class="hljs-keyword">if</span> (audioManager.mode != AudioManager.MODE_IN_COMMUNICATION) {
                audioManager.mode = AudioManager.MODE_IN_COMMUNICATION
            }
            <span class="hljs-keyword">if</span> (audioManager.isSpeakerphoneOn != on) {
                audioManager.isSpeakerphoneOn = on
                JLog.i(TAG, <span class="hljs-string">"设置扬声器状态: <span class="hljs-variable">$on</span>"</span>)
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initAudioTrack</span><span class="hljs-params">()</span></span> {
        safeExecute(<span class="hljs-string">"初始化 AudioTrack"</span>) {
            <span class="hljs-keyword">val</span> minBufferSize = AudioTrack.getMinBufferSize(
                SAMPLE_RATE,
                AudioFormat.CHANNEL_OUT_MONO,
                AudioFormat.ENCODING_PCM_16BIT
            )

            <span class="hljs-keyword">val</span> attributes = AudioAttributes.Builder()
                .setUsage(AUDIO_USAGE)
                .setContentType(AUDIO_CONTENT_TYPE)
                .build()

            <span class="hljs-keyword">val</span> format = AudioFormat.Builder()
                .setEncoding(AudioFormat.ENCODING_PCM_16BIT)
                .setSampleRate(SAMPLE_RATE)
                .setChannelMask(AudioFormat.CHANNEL_OUT_MONO)
                .build()

            audioTrack = AudioTrack(
                attributes,
                format,
                minBufferSize,
                AudioTrack.MODE_STREAM,
                AudioManager.AUDIO_SESSION_ID_GENERATE
            )
            
            JLog.i(TAG, <span class="hljs-string">"AudioTrack 已初始化 (VOICE_COMMUNICATION 模式)"</span>)
        }
    }

    <span class="hljs-comment">// ============================================================================================</span>
    <span class="hljs-comment">// 录音逻辑 (WebRTC Engine)</span>
    <span class="hljs-comment">// ============================================================================================</span>

    <span class="hljs-comment">/**
     * 启动 WebRTC 引擎进行录音。
     * 音频数据将经过处理 (AEC/NS) 并通过 outputCallback 返回。
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startRecording</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (isRecording.<span class="hljs-keyword">get</span>()) {
            JLog.w(TAG, <span class="hljs-string">"录音已在进行中"</span>)
            <span class="hljs-keyword">return</span>
        }

        JLog.i(TAG, <span class="hljs-string">"正在启动 WebRTC 录音..."</span>)
        hasLoggedRecordInfo = <span class="hljs-literal">false</span>
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 0. 确保音频模式为 IN_COMMUNICATION 以启用硬件 AEC</span>
            setSpeakerphoneOn(<span class="hljs-literal">true</span>)

            <span class="hljs-comment">// 1. 初始化 WebRTC 全局上下文</span>
            initWebRTCContext()

            <span class="hljs-comment">// 2. 创建音频设备模块 (引擎核心)</span>
            createAudioDeviceModule()

            <span class="hljs-comment">// 3. 创建 PeerConnectionFactory (协调者)</span>
            createPeerConnectionFactory()

            <span class="hljs-comment">// 4. 创建音频源和轨道 (管道)</span>
            createAudioPipeline()

            <span class="hljs-comment">// 5. 创建虚拟 PeerConnection 以强制 ADM 开始录音</span>
            startDummyPeerConnection()

            isRecording.<span class="hljs-keyword">set</span>(<span class="hljs-literal">true</span>)
            JLog.i(TAG, <span class="hljs-string">"WebRTC 录音启动成功"</span>)

        } <span class="hljs-keyword">catch</span> (e: Exception) {
            JLog.e(TAG, <span class="hljs-string">"启动 WebRTC 录音失败"</span>, e)
            releaseWebRTC() <span class="hljs-comment">// 失败时清理资源</span>
        }
    }

    <span class="hljs-comment">/**
     * 停止录音并释放 WebRTC 资源。
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stopRecording</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (!isRecording.<span class="hljs-keyword">get</span>()) <span class="hljs-keyword">return</span>
        
        JLog.i(TAG, <span class="hljs-string">"正在停止 WebRTC 录音..."</span>)
        isRecording.<span class="hljs-keyword">set</span>(<span class="hljs-literal">false</span>)
        releaseWebRTC()
        JLog.i(TAG, <span class="hljs-string">"WebRTC 录音已停止"</span>)
    }

    <span class="hljs-comment">// --- WebRTC 内部初始化流程 ---</span>

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initWebRTCContext</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> options = PeerConnectionFactory.InitializationOptions.builder(context)
            .setEnableInternalTracer(<span class="hljs-literal">false</span>)
            .createInitializationOptions()
        PeerConnectionFactory.initialize(options)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createAudioDeviceModule</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// JavaAudioDeviceModule 是标准的 Android 实现。</span>
        <span class="hljs-comment">// 它管理 AudioRecord 和 AudioTrack。</span>
        <span class="hljs-comment">// 关键点：它负责设置硬件 AEC (如果可用)。</span>
        audioDeviceModule = JavaAudioDeviceModule.builder(context)
            .setUseHardwareAcousticEchoCanceler(<span class="hljs-literal">true</span>)
            .setUseHardwareNoiseSuppressor(<span class="hljs-literal">true</span>)
            .setAudioRecordErrorCallback(<span class="hljs-keyword">object</span> : JavaAudioDeviceModule.AudioRecordErrorCallback {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onWebRtcAudioRecordInitError</span><span class="hljs-params">(p0: <span class="hljs-type">String</span>?)</span></span> = JLog.e(TAG, <span class="hljs-string">"录音初始化错误: <span class="hljs-variable">$p0</span>"</span>)
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onWebRtcAudioRecordStartError</span><span class="hljs-params">(p0: <span class="hljs-type">JavaAudioDeviceModule</span>.<span class="hljs-type">AudioRecordStartErrorCode</span>?, p1: <span class="hljs-type">String</span>?)</span></span> = JLog.e(TAG, <span class="hljs-string">"录音启动错误: <span class="hljs-variable">$p1</span>"</span>)
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onWebRtcAudioRecordError</span><span class="hljs-params">(p0: <span class="hljs-type">String</span>?)</span></span> = JLog.e(TAG, <span class="hljs-string">"录音运行时错误: <span class="hljs-variable">$p0</span>"</span>)
            })
            .setAudioRecordStateCallback(<span class="hljs-keyword">object</span> : JavaAudioDeviceModule.AudioRecordStateCallback {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onWebRtcAudioRecordStart</span><span class="hljs-params">()</span></span> = JLog.i(TAG, <span class="hljs-string">"ADM: 录音已开始"</span>)
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onWebRtcAudioRecordStop</span><span class="hljs-params">()</span></span> = JLog.i(TAG, <span class="hljs-string">"ADM: 录音已停止"</span>)
            })
            <span class="hljs-comment">// 使用 SamplesReadyCallback 直接从 ADM 获取原始音频数据</span>
            <span class="hljs-comment">// 这绕过了完整的 PeerConnection 媒体流传输，更直接高效</span>
            .setSamplesReadyCallback { audioSamples -&gt;
                processAudioSamples(audioSamples)
            }
            .createAudioDeviceModule()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processAudioSamples</span><span class="hljs-params">(audioSamples: <span class="hljs-type">JavaAudioDeviceModule</span>.<span class="hljs-type">AudioSamples</span>)</span></span> {
        <span class="hljs-comment">// 检查录音状态，防止关闭过程中的数据泄漏</span>
        <span class="hljs-keyword">if</span> (!isRecording.<span class="hljs-keyword">get</span>()) <span class="hljs-keyword">return</span>

        <span class="hljs-keyword">if</span> (!hasLoggedRecordInfo) {
            JLog.i(TAG, <span class="hljs-string">"WebRTC 录音格式: <span class="hljs-subst">${audioSamples.sampleRate}</span>Hz, <span class="hljs-subst">${audioSamples.channelCount}</span> 声道, 格式=<span class="hljs-subst">${audioSamples.audioFormat}</span>, 大小=<span class="hljs-subst">${audioSamples.data.size}</span>"</span>)
            hasLoggedRecordInfo = <span class="hljs-literal">true</span>
        }

        <span class="hljs-keyword">var</span> processedBytes = audioSamples.<span class="hljs-keyword">data</span>

        <span class="hljs-comment">// 1. 立体声转单声道 (如果需要)</span>
        <span class="hljs-keyword">if</span> (audioSamples.channelCount == <span class="hljs-number">2</span>) {
            processedBytes = stereoToMono(processedBytes)
        }

        <span class="hljs-comment">// 2. 重采样 (如果需要)</span>
        <span class="hljs-keyword">if</span> (audioSamples.sampleRate == <span class="hljs-number">48000</span>) {
            processedBytes = resample48kTo16k(processedBytes)
        }

        <span class="hljs-comment">// 回调给 STT</span>
        outputCallback(processedBytes)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createPeerConnectionFactory</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> options = PeerConnectionFactory.Options()
        peerConnectionFactory = PeerConnectionFactory.builder()
            .setOptions(options)
            .setAudioDeviceModule(audioDeviceModule)
            .createPeerConnectionFactory()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createAudioPipeline</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 4.1 创建音频源 (AudioSource)</span>
        <span class="hljs-comment">// 添加 Google 特定的约束条件，提示引擎启用处理</span>
        <span class="hljs-keyword">val</span> constraints = MediaConstraints().apply {
            mandatory.add(MediaConstraints.KeyValuePair(CONSTRAINT_ECHO_CANCELLATION, <span class="hljs-string">"true"</span>))
            mandatory.add(MediaConstraints.KeyValuePair(CONSTRAINT_AUTO_GAIN_CONTROL, <span class="hljs-string">"true"</span>))
            mandatory.add(MediaConstraints.KeyValuePair(CONSTRAINT_NOISE_SUPPRESSION, <span class="hljs-string">"true"</span>))
            mandatory.add(MediaConstraints.KeyValuePair(CONSTRAINT_HIGHPASS_FILTER, <span class="hljs-string">"true"</span>))
        }
        webrtcAudioSource = peerConnectionFactory?.createAudioSource(constraints)

        <span class="hljs-comment">// 4.2 创建本地音频轨道 (AudioTrack)</span>
        webrtcLocalTrack = peerConnectionFactory?.createAudioTrack(AUDIO_TRACK_ID, webrtcAudioSource)
        webrtcLocalTrack?.setEnabled(<span class="hljs-literal">true</span>)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startDummyPeerConnection</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> rtcConfig = PeerConnection.RTCConfiguration(emptyList())
            rtcConfig.sdpSemantics = PeerConnection.SdpSemantics.UNIFIED_PLAN

            dummyPeerConnection = peerConnectionFactory?.createPeerConnection(rtcConfig, <span class="hljs-keyword">object</span> : SimplePeerConnectionObserver() {
                <span class="hljs-comment">// 我们不需要处理任何 P2P 事件，因为这只是一个本地 Loopback</span>
            })
            
            <span class="hljs-comment">// 将本地轨道添加到连接中以触发 ADM 录音</span>
            <span class="hljs-keyword">if</span> (webrtcLocalTrack != <span class="hljs-literal">null</span>) {
                dummyPeerConnection?.addTrack(webrtcLocalTrack, listOf(STREAM_ID))
                JLog.i(TAG, <span class="hljs-string">"已添加本地轨道到虚拟 PeerConnection"</span>)
            }

            <span class="hljs-comment">// 关键步骤：创建 Offer 并设置 Local Description 以激活媒体流</span>
            <span class="hljs-keyword">val</span> constraints = MediaConstraints()
            dummyPeerConnection?.createOffer(<span class="hljs-keyword">object</span> : SimpleSdpObserver() {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateSuccess</span><span class="hljs-params">(sessionDescription: <span class="hljs-type">SessionDescription</span>?)</span></span> {
                    JLog.i(TAG, <span class="hljs-string">"虚拟 Offer 已创建"</span>)
                    dummyPeerConnection?.setLocalDescription(<span class="hljs-keyword">object</span> : SimpleSdpObserver() {
                        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSetSuccess</span><span class="hljs-params">()</span></span> {
                            JLog.i(TAG, <span class="hljs-string">"虚拟本地描述已设置 - 引擎应已激活"</span>)
                        }
                    }, sessionDescription)
                }
            }, constraints)

        } <span class="hljs-keyword">catch</span> (e: Exception) {
            JLog.e(TAG, <span class="hljs-string">"启动虚拟 PeerConnection 失败"</span>, e)
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">releaseWebRTC</span><span class="hljs-params">()</span></span> {
        JLog.i(TAG, <span class="hljs-string">"正在释放 WebRTC 资源..."</span>)
        
        <span class="hljs-comment">// 1. 关闭 PeerConnection (停止管道)</span>
        safeExecute(<span class="hljs-string">"释放 PeerConnection"</span>) {
            dummyPeerConnection?.dispose()
            JLog.i(TAG, <span class="hljs-string">"PeerConnection 已释放"</span>)
        }
        dummyPeerConnection = <span class="hljs-literal">null</span>

        <span class="hljs-comment">// 2. 释放本地轨道</span>
        safeExecute(<span class="hljs-string">"释放 LocalTrack"</span>) {
            webrtcLocalTrack?.let {
                it.setEnabled(<span class="hljs-literal">false</span>)
                it.dispose()
                JLog.i(TAG, <span class="hljs-string">"LocalTrack 已释放"</span>)
            }
        }
        webrtcLocalTrack = <span class="hljs-literal">null</span>
        
        <span class="hljs-comment">// 3. 释放音频源</span>
        safeExecute(<span class="hljs-string">"释放 AudioSource"</span>) {
            webrtcAudioSource?.dispose()
            JLog.i(TAG, <span class="hljs-string">"AudioSource 已释放"</span>)
        }
        webrtcAudioSource = <span class="hljs-literal">null</span>
        
        <span class="hljs-comment">// 4. 释放工厂</span>
        safeExecute(<span class="hljs-string">"释放 PeerConnectionFactory"</span>) {
            peerConnectionFactory?.dispose()
            JLog.i(TAG, <span class="hljs-string">"PeerConnectionFactory 已释放"</span>)
        }
        peerConnectionFactory = <span class="hljs-literal">null</span>
        
        <span class="hljs-comment">// 5. 释放 ADM (对于停止麦克风至关重要)</span>
        safeExecute(<span class="hljs-string">"释放 AudioDeviceModule"</span>) {
            audioDeviceModule?.let {
                <span class="hljs-comment">// 解除可能的状态锁定</span>
                it.setSpeakerMute(<span class="hljs-literal">false</span>) 
                it.setMicrophoneMute(<span class="hljs-literal">false</span>)
                it.release()
                JLog.i(TAG, <span class="hljs-string">"AudioDeviceModule 已释放 - 麦克风应已停止"</span>)
            }
        }
        audioDeviceModule = <span class="hljs-literal">null</span>
    }

    <span class="hljs-comment">/**
     * 完全释放所有资源 (播放器和录音机)。
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">release</span><span class="hljs-params">()</span></span> {
        stopPlay()
        stopRecording()
        <span class="hljs-comment">// 重置音频模式</span>
        safeExecute(<span class="hljs-string">"重置音频模式"</span>) {
            audioManager.isSpeakerphoneOn = <span class="hljs-literal">false</span>
            audioManager.mode = AudioManager.MODE_NORMAL
        }
    }

    <span class="hljs-comment">// ============================================================================================</span>
    <span class="hljs-comment">// 辅助方法和类</span>
    <span class="hljs-comment">// ============================================================================================</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">safeExecute</span><span class="hljs-params">(actionName: <span class="hljs-type">String</span>, action: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        <span class="hljs-keyword">try</span> {
            action()
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            JLog.e(TAG, <span class="hljs-string">"<span class="hljs-variable">$actionName</span> 失败"</span>, e)
        }
    }

    <span class="hljs-comment">/**
     * 将 16-bit PCM 立体声转换为单声道 (丢弃右声道)。
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stereoToMono</span><span class="hljs-params">(stereoBytes: <span class="hljs-type">ByteArray</span>)</span></span>: ByteArray {
        <span class="hljs-keyword">val</span> monoBytes = ByteArray(stereoBytes.size / <span class="hljs-number">2</span>)
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until monoBytes.size step <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">val</span> stereoIndex = i * <span class="hljs-number">2</span>
            monoBytes[i] = stereoBytes[stereoIndex]
            monoBytes[i + <span class="hljs-number">1</span>] = stereoBytes[stereoIndex + <span class="hljs-number">1</span>]
        }
        <span class="hljs-keyword">return</span> monoBytes
    }

    <span class="hljs-comment">/**
     * 将 16-bit PCM 48000Hz 降采样到 16000Hz (3:1 抽取)。
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">resample48kTo16k</span><span class="hljs-params">(src: <span class="hljs-type">ByteArray</span>)</span></span>: ByteArray {
        <span class="hljs-keyword">val</span> sampleCount = src.size / <span class="hljs-number">2</span>
        <span class="hljs-keyword">val</span> newSampleCount = sampleCount / <span class="hljs-number">3</span>
        <span class="hljs-keyword">val</span> dst = ByteArray(newSampleCount * <span class="hljs-number">2</span>)

        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until newSampleCount) {
            <span class="hljs-keyword">val</span> srcIndex = i * <span class="hljs-number">3</span> * <span class="hljs-number">2</span>
            <span class="hljs-keyword">val</span> dstIndex = i * <span class="hljs-number">2</span>
            dst[dstIndex] = src[srcIndex]
            dst[dstIndex + <span class="hljs-number">1</span>] = src[srcIndex + <span class="hljs-number">1</span>]
        }
        <span class="hljs-keyword">return</span> dst
    }

    <span class="hljs-comment">// --- 简化的 Observer 实现，避免冗余代码 ---</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimplePeerConnectionObserver</span> : <span class="hljs-type">PeerConnection.Observer</span> {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSignalingChange</span><span class="hljs-params">(p0: <span class="hljs-type">PeerConnection</span>.<span class="hljs-type">SignalingState</span>?)</span></span> {}
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onIceConnectionChange</span><span class="hljs-params">(p0: <span class="hljs-type">PeerConnection</span>.<span class="hljs-type">IceConnectionState</span>?)</span></span> {}
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onIceConnectionReceivingChange</span><span class="hljs-params">(p0: <span class="hljs-type">Boolean</span>)</span></span> {}
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onIceGatheringChange</span><span class="hljs-params">(p0: <span class="hljs-type">PeerConnection</span>.<span class="hljs-type">IceGatheringState</span>?)</span></span> {}
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onIceCandidate</span><span class="hljs-params">(p0: <span class="hljs-type">IceCandidate</span>?)</span></span> {}
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onIceCandidatesRemoved</span><span class="hljs-params">(p0: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">IceCandidate</span>&gt;?)</span></span> {}
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAddStream</span><span class="hljs-params">(p0: <span class="hljs-type">MediaStream</span>?)</span></span> {}
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onRemoveStream</span><span class="hljs-params">(p0: <span class="hljs-type">MediaStream</span>?)</span></span> {}
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDataChannel</span><span class="hljs-params">(p0: <span class="hljs-type">DataChannel</span>?)</span></span> {}
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onRenegotiationNeeded</span><span class="hljs-params">()</span></span> {}
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAddTrack</span><span class="hljs-params">(p0: <span class="hljs-type">RtpReceiver</span>?, p1: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">MediaStream</span>&gt;?)</span></span> {}
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleSdpObserver</span> : <span class="hljs-type">SdpObserver</span> {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateSuccess</span><span class="hljs-params">(p0: <span class="hljs-type">SessionDescription</span>?)</span></span> {}
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSetSuccess</span><span class="hljs-params">()</span></span> {}
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateFailure</span><span class="hljs-params">(p0: <span class="hljs-type">String</span>?)</span></span> { JLog.e(TAG, <span class="hljs-string">"SDP Create Error: <span class="hljs-variable">$p0</span>"</span>) }
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSetFailure</span><span class="hljs-params">(p0: <span class="hljs-type">String</span>?)</span></span> { JLog.e(TAG, <span class="hljs-string">"SDP Set Error: <span class="hljs-variable">$p0</span>"</span>) }
    }
}
</code></pre>
<h3 data-id="heading-3">使用方式</h3>
<h4 data-id="heading-4">1. 初始化</h4>
<p>调用方需要实例化 AECSchedule ，并提供一个回调函数来接收处理后的纯净音频数据（用于 STT）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在 Activity 或 ViewModel 中</span>
<span class="hljs-keyword">val</span> aecSchedule = AECSchedule(context) { processedPcmData -&gt;
    <span class="hljs-comment">// [回调] 这里接收到的是经过回声消除和降噪后的纯净音频</span>
    <span class="hljs-comment">// 通常在这里将数据发送给 STT (语音识别) 引擎</span>
    sttClient.sendAudio(processedPcmData)
}
</code></pre>
<h4 data-id="heading-5">2. 启动录音 (Start Recording)</h4>
<p>当需要开始听用户说话时（例如唤醒后，或进入对话状态），调用 startRecording() 。</p>
<ul>
<li>作用 ：启动 WebRTC 引擎，打开麦克风，开始采集并处理音频。</li>
<li>时机 ：通常在用户点击“开始说话”按钮，或系统检测到唤醒词后。</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">aecSchedule.startRecording()
</code></pre>
<h4 data-id="heading-6">3. 播放 TTS 音频 (Playback)</h4>
<p>当有 TTS（语音合成）数据需要播放时， 必须 通过 AECSchedule 来播放，而不是自己创建 AudioTrack 。</p>
<ul>
<li>关键点 ：只有通过 onTTSAudioData 播放的声音，才能被 WebRTC 引擎捕捉为“参考信号”，从而在麦克风采集的音频中将其消除（避免自言自语）。</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 假设 ttsData 是从 TTS 引擎获取的 PCM 字节流，我这边拿到的是 tts-websocket 中返回的 byte[] （音频数据）</span>
aecSchedule.onTTSAudioData(ttsData)
</code></pre>
<h4 data-id="heading-7">4. 停止播放 (Stop Playback)</h4>
<p>如果需要打断播放（例如用户点击“停止”或开始新的对话），调用 stopPlay() 。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">aecSchedule.stopPlay()
</code></pre>
<h4 data-id="heading-8">5. 停止录音 (Stop Recording)</h4>
<p>当不需要再听用户说话时（例如识别结束，进入思考状态），调用 stopRecording() 。</p>
<ul>
<li>注意 ：这将释放麦克风资源，系统状态栏的录音图标（小绿点）应消失。</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">aecSchedule.stopRecording()
</code></pre>
<h4 data-id="heading-9">6. 销毁资源 (Release)</h4>
<p>在页面销毁或退出功能时，务必调用 release() 以彻底释放所有硬件资源。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">super</span>.onDestroy()
    aecSchedule.release()
}
</code></pre>
<h4 data-id="heading-10">伪代码流程</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 伪代码：AEC 调度流程</span>

<span class="hljs-comment">// 1. 初始化 (Init)</span>
<span class="hljs-comment">// --------------------------------------------------------------------------------</span>
<span class="hljs-comment">// 创建 AEC 调度器，并定义处理后的音频去向（给 STT）</span>
<span class="hljs-keyword">val</span> aecSchedule = AECSchedule(context) { processedPcmData -&gt;
    <span class="hljs-comment">// 回调：接收经过回声消除的纯净音频</span>
    sttClient.sendAudio(processedPcmData)
}

<span class="hljs-comment">// 2. 录音流程 (Recording Loop)</span>
<span class="hljs-comment">// --------------------------------------------------------------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startSession</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 启动 STT 引擎（设置为外部音频源模式）</span>
    sttClient.startExternalAudioMode()
    
    <span class="hljs-comment">// 启动 AEC 录音（打开麦克风 + WebRTC 处理）</span>
    aecSchedule.startRecording()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stopSession</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 停止录音</span>
    aecSchedule.stopRecording()
    <span class="hljs-comment">// 停止 STT</span>
    sttClient.stop()
}

<span class="hljs-comment">// 3. 播放流程 (Playback with AEC)</span>
<span class="hljs-comment">// --------------------------------------------------------------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">speak</span><span class="hljs-params">(text: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 调用 TTS 引擎生成音频</span>
    ttsClient.synthesize(text, <span class="hljs-keyword">object</span> : TTSCallback {
        
        <span class="hljs-comment">// 关键点：拦截 TTS 的音频数据</span>
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAudioData</span><span class="hljs-params">(pcmData: <span class="hljs-type">ByteArray</span>)</span></span> {
            <span class="hljs-comment">// 将 TTS 音频喂给 AECSchedule 进行播放</span>
            <span class="hljs-comment">// 这样 WebRTC 才能将其识别为“参考信号”并消除</span>
            aecSchedule.onTTSAudioData(pcmData)
        }
    })
}

<span class="hljs-comment">// 4. 资源释放 (Cleanup)</span>
<span class="hljs-comment">// --------------------------------------------------------------------------------</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span></span> {
    aecSchedule.release() <span class="hljs-comment">// 务必释放硬件资源</span>
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2389299ab07041b2b6f78cb490922e6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bCP6L2wX1JleA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081023&amp;x-signature=bODgNIAO%2F%2FwK2Nx%2F0LREjk0fKCs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-11">效果演示（带声音）</h3>
<p>【AEC 回声消除测试-视频演示】 <a href="https://link.juejin.cn?target=https%3A%2F%2Fb23.tv%2FkUEJYuP" target="_blank" title="https://b23.tv/kUEJYuP" ref="nofollow noopener noreferrer">b23.tv/kUEJYuP</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b40ff934fd3c4879929a01a99e7e3f2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bCP6L2wX1JleA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767081023&amp;x-signature=9GEksZR388sc72gEtkxKYymBwUk%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型原理剖析——突破LLM效率瓶颈：多标记预测(MTP)技术深度解析与实战]]></title>    <link>https://juejin.cn/post/7586615716905746432</link>    <guid>https://juejin.cn/post/7586615716905746432</guid>    <pubDate>2025-12-23T03:29:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586615716905746432" data-draft-id="7586570254861778984" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型原理剖析——突破LLM效率瓶颈：多标记预测(MTP)技术深度解析与实战"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-23T03:29:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="艾醒"/> <meta itemprop="url" content="https://juejin.cn/user/708512558088669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型原理剖析——突破LLM效率瓶颈：多标记预测(MTP)技术深度解析与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/708512558088669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    艾醒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T03:29:20.000Z" title="Tue Dec 23 2025 03:29:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在大语言模型（LLM）落地的过程中，“生成效率”始终是绕不开的核心痛点——传统自回归模型像“挤牙膏”一样逐词元（Token）生成文本，不仅推理速度慢，训练效率也难以满足大规模应用需求。而<strong>多标记预测（Multi-Token Prediction, MTP）</strong> 作为解决这一问题的关键技术，正在成为LLM性能优化的核心方向。本文将从技术本质、执行流程、实战示例到落地应用，全方位拆解MTP技术。</p>
<h2 data-id="heading-1">MTP核心定义：不止于“一次生成多个Token”</h2>
<p>多标记预测（MTP）是一种让大语言模型在<strong>单次前向传播中同时预测多个后续词元</strong>的技术，核心目标是打破传统“单Token逐次生成”的效率枷锁。</p>
<p>与传统单标记预测（NTP）的核心差异：</p>
<ul>
<li>传统NTP：输入文本→模型预测第t+1个Token→以t+1为新输入→预测t+2个Token（循环往复）；</li>
<li>MTP：输入文本→模型单次前向传播→同时预测t+1、t+2…t+n个Token，直接完成多步生成。</li>
</ul>
<p>简单来说，MTP让模型从“一步走一格”变成“一步走多格”，既提升训练时的信号密度，又大幅降低推理时的迭代次数。</p>
<h2 data-id="heading-2">MTP核心执行流程</h2>
<p>MTP的执行流程分为<strong>训练阶段</strong>和<strong>推理阶段</strong>，其中推理阶段结合“推测解码（Speculative Decoding）”时效果最优。</p>
<h3 data-id="heading-3">1. 基础MTP训练流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8bdb87ed6d14384bfe67b8ae906a43d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YaS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065360&amp;x-signature=FHOJWkUttJX1tday%2Bfper%2F%2FQVyU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>流程拆解</strong>：</p>
<ol>
<li>输入文本经Token化转为序列<code>X₁,X₂...Xₜ</code>；</li>
<li>共享Transformer编码器将序列编码为上下文表征<code>Hₜ</code>；</li>
<li>多个独立的MTP输出头基于<code>Hₜ</code>，并行预测<code>t+1</code>到<code>t+n</code>个Token；</li>
<li>计算每个MTP头的预测损失（交叉熵），总损失为所有头损失的平均值；</li>
<li>反向传播更新模型参数，直到模型收敛。</li>
</ol>
<h3 data-id="heading-4">2. MTP+推测解码推理流程（主流落地方案）</h3>
<p>单纯的MTP可能存在“多Token预测不连贯”的问题，结合推测解码后，既能保效率又能保质量：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75fac2031b92462b86c9ccb07c36a6e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YaS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065360&amp;x-signature=yBzVOyNIwuotLibktiuEBvZ1pGo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>流程拆解</strong>：</p>
<ol>
<li>轻量级MTP“草稿模型”基于输入上下文，并行生成K个候选Token（比如K=4）；</li>
<li>高精度主模型通过<strong>单次前向传播</strong>，批量验证这K个候选Token的合理性；</li>
<li>若验证通过（DeepSeek实测接受率85%-90%），直接输出这K个Token，模型步数一次性+K；</li>
<li>若部分Token验证失败，仅保留通过的Token，重新生成被拒绝的部分；</li>
<li>重复上述步骤，直到生成满足长度要求的文本。</li>
</ol>
<h3 data-id="heading-5">3. DeepSeek依赖链式MTP架构（保连贯的进阶方案）</h3>
<p>为解决“独立多头MTP生成不连贯”的问题，DeepSeek设计了依赖链式MTP架构：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47f0c2adf901461ea3b724ef06529c95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YaS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767065360&amp;x-signature=%2BtT0LazpV1e%2FixwrjSC8xE0tgrI%3D" alt="在这里插入图片描述" loading="lazy"/>
核心逻辑：后一个MTP头的预测依赖前一个头的输出表征，既保留了“多Token预测”的效率，又保证了文本的语义连贯性。</p>
<h2 data-id="heading-6">MTP实战示例：极简PyTorch实现框架</h2>
<p>以下是一个简化版的MTP模型实现，帮助你理解核心代码逻辑（仅保留关键模块，无复杂优化）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim

<span class="hljs-comment"># 超参数设置</span>
VOCAB_SIZE = <span class="hljs-number">10000</span>  <span class="hljs-comment"># 词汇表大小</span>
EMBED_DIM = <span class="hljs-number">256</span>     <span class="hljs-comment"># 嵌入维度</span>
HIDDEN_DIM = <span class="hljs-number">512</span>    <span class="hljs-comment"># Transformer隐藏层维度</span>
NUM_HEADS = <span class="hljs-number">8</span>       <span class="hljs-comment"># 注意力头数</span>
NUM_LAYERS = <span class="hljs-number">2</span>      <span class="hljs-comment"># Transformer层数</span>
MTP_NUM = <span class="hljs-number">3</span>         <span class="hljs-comment"># 一次预测3个Token（t+1/t+2/t+3）</span>

<span class="hljs-comment"># 1. 共享Transformer编码器（基础编码模块）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedEncoder</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.embedding = nn.Embedding(VOCAB_SIZE, EMBED_DIM)
        self.transformer_encoder = nn.TransformerEncoder(
            nn.TransformerEncoderLayer(EMBED_DIM, NUM_HEADS, HIDDEN_DIM),
            num_layers=NUM_LAYERS
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># x: [seq_len, batch_size]</span>
        embed = self.embedding(x)  <span class="hljs-comment"># [seq_len, batch_size, embed_dim]</span>
        enc_out = self.transformer_encoder(embed)  <span class="hljs-comment"># [seq_len, batch_size, embed_dim]</span>
        <span class="hljs-keyword">return</span> enc_out[-<span class="hljs-number">1</span>]  <span class="hljs-comment"># 返回最后一个Token的表征: [batch_size, embed_dim]</span>

<span class="hljs-comment"># 2. MTP多输出头（并行预测多个Token）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MTPModel</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.encoder = SharedEncoder()
        <span class="hljs-comment"># 定义MTP_NUM个独立的输出头</span>
        self.mtp_heads = nn.ModuleList([
            nn.Linear(EMBED_DIM, VOCAB_SIZE) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(MTP_NUM)
        ])
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-comment"># x: [seq_len, batch_size]</span>
        context_feat = self.encoder(x)  <span class="hljs-comment"># [batch_size, embed_dim]</span>
        <span class="hljs-comment"># 每个头并行预测一个Token</span>
        mtp_outputs = [head(context_feat) <span class="hljs-keyword">for</span> head <span class="hljs-keyword">in</span> self.mtp_heads]
        <span class="hljs-comment"># 返回t+1/t+2/t+3的预测logits: [MTP_NUM, batch_size, vocab_size]</span>
        <span class="hljs-keyword">return</span> torch.stack(mtp_outputs)

<span class="hljs-comment"># 3. 训练流程示例</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">train_mtp_model</span>():
    model = MTPModel()
    criterion = nn.CrossEntropyLoss()  <span class="hljs-comment"># 交叉熵损失</span>
    optimizer = optim.Adam(model.parameters(), lr=<span class="hljs-number">1e-4</span>)
    
    <span class="hljs-comment"># 模拟训练数据：输入序列[1,2,3,4]，目标Token为[5,6,7]（t+1=5, t+2=6, t+3=7）</span>
    batch_size = <span class="hljs-number">2</span>
    input_seq = torch.tensor([[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>], [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]]).T  <span class="hljs-comment"># [seq_len=4, batch_size=2]</span>
    target_tokens = torch.tensor([[<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>], [<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>]]).T    <span class="hljs-comment"># [MTP_NUM=3, batch_size=2]</span>
    
    model.train()
    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
        optimizer.zero_grad()
        <span class="hljs-comment"># 前向传播：获取3个Token的预测logits</span>
        mtp_logits = model(input_seq)  <span class="hljs-comment"># [3, 2, 10000]</span>
        
        <span class="hljs-comment"># 计算总损失：每个MTP头的损失相加</span>
        total_loss = <span class="hljs-number">0.0</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(MTP_NUM):
            <span class="hljs-comment"># logits: [2, 10000], target: [2]</span>
            loss = criterion(mtp_logits[i], target_tokens[i])
            total_loss += loss
        
        <span class="hljs-comment"># 反向传播</span>
        total_loss.backward()
        optimizer.step()
        
        <span class="hljs-keyword">if</span> (epoch+<span class="hljs-number">1</span>) % <span class="hljs-number">20</span> == <span class="hljs-number">0</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Epoch <span class="hljs-subst">{epoch+<span class="hljs-number">1</span>}</span>, Total Loss: <span class="hljs-subst">{total_loss.item():<span class="hljs-number">.4</span>f}</span>"</span>)

<span class="hljs-comment"># 执行训练</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    train_mtp_model()
</code></pre>
<p><strong>代码关键说明</strong>：</p>
<ol>
<li><code>SharedEncoder</code>：共享的Transformer编码器，为所有MTP头提供统一的上下文表征；</li>
<li><code>MTPModel</code>：包含3个独立的线性输出头，并行预测<code>t+1</code>、<code>t+2</code>、<code>t+3</code>三个Token；</li>
<li>训练阶段：计算每个MTP头的交叉熵损失，求和后作为总损失反向传播，让模型学习“一次预测多个Token”的能力；</li>
<li>输出示例：训练100轮后损失会逐步下降，说明模型已学会从输入<code>[1,2,3,4]</code>预测目标<code>[5,6,7]</code>。</li>
</ol>
<h2 data-id="heading-7">MTP vs 传统单标记预测（NTP）核心对比</h2>








































<table><thead><tr><th>特性</th><th>传统单标记预测（NTP）</th><th>多标记预测（MTP）</th></tr></thead><tbody><tr><td>预测方式</td><td>每次生成1个Token</td><td>一次生成n个Token</td></tr><tr><td>推理速度</td><td>基准值（1倍）</td><td>1.8~2.6倍（结合推测解码）</td></tr><tr><td>训练信号密度</td><td>低（每步1个损失）</td><td>高（每步n个损失）</td></tr><tr><td>文本连贯性</td><td>一般（仅依赖前1个Token）</td><td>优秀（依赖链式表征）</td></tr><tr><td>硬件资源利用率</td><td>低（单次前向传播仅用1次）</td><td>高（单次前向传播用n次）</td></tr><tr><td>典型落地场景</td><td>小模型、低延迟要求场景</td><td>大模型、长文本生成、移动端</td></tr></tbody></table>
<h2 data-id="heading-8">MTP的落地应用与核心优势</h2>
<h3 data-id="heading-9">1. 核心优势</h3>
<ol>
<li><strong>效率翻倍</strong>：推理速度提升1.8~2.6倍，训练时信号密度更高，收敛更快；</li>
<li><strong>语义更连贯</strong>：依赖链式架构让多Token生成符合语言逻辑，避免“前言不搭后语”；</li>
<li><strong>硬件适配性好</strong>：联发科天玑9400+等芯片已集成MTP硬件加速，适配移动端部署；</li>
<li><strong>成本降低</strong>：减少推理时的前向传播次数，大幅降低算力消耗（小米MiMo模型仅用1/50算力达到同等性能）。</li>
</ol>
<h3 data-id="heading-10">2. 典型落地案例</h3>
<ul>
<li><strong>DeepSeek-V3</strong>：依赖链式MTP+推测解码，推理速度提升1.8倍，生成质量与原生模型持平；</li>
<li><strong>小米MiMo模型</strong>：MTP+在线策略蒸馏，32并发时推理速度达1146 Tokens/秒；</li>
<li><strong>联发科天玑9400+</strong>：硬件级MTP加速，支持手机端高效运行Qwen3等大模型。</li>
</ul>
<h2 data-id="heading-11">总结</h2>
<p>MTP技术的核心价值，是在不牺牲LLM生成质量的前提下，解决了自回归模型“逐Token生成”的效率瓶颈。从技术演进来看，未来MTP将朝着“更高并行度、更强语义连贯性、更低硬件依赖”方向发展：</p>
<ol>
<li>结合MoE（混合专家模型），进一步提升MTP的并行计算效率；</li>
<li>优化依赖链式架构，平衡“并行度”与“连贯性”；</li>
<li>轻量化MTP模块，让中小模型也能享受效率提升。</li>
</ol>
<p>对于开发者而言，理解MTP的核心逻辑（共享编码+多输出头+损失融合），并掌握“MTP+推测解码”的落地范式，将成为优化LLM应用的核心能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI+PySide6实现自定义窗口标题栏目(titleBar)]]></title>    <link>https://juejin.cn/post/7587253759091998756</link>    <guid>https://juejin.cn/post/7587253759091998756</guid>    <pubDate>2025-12-24T10:23:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587253759091998756" data-draft-id="7587253759091933220" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI+PySide6实现自定义窗口标题栏目(titleBar)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-24T10:23:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心_开心急了"/> <meta itemprop="url" content="https://juejin.cn/user/2975724155181111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI+PySide6实现自定义窗口标题栏目(titleBar)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2975724155181111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心_开心急了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T10:23:34.000Z" title="Wed Dec 24 2025 10:23:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI+PySide6实现自定义窗口标题栏目(titleBar)</h2>
<p>本教程将详细介绍如何使用 PySide6 实现一个功能完整的自定义标题栏，适合没有 PySide 基础的初学者学习。</p>
<h3 data-id="heading-1">目录</h3>
<ol start="0">
<li><a href="#%E6%95%88%E6%9E%9C%E4%B8%8E%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81" title="#%E6%95%88%E6%9E%9C%E4%B8%8E%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81">效果与完整代码</a></li>
<li><a href="#%E7%AA%97%E5%8F%A3%E5%B8%83%E5%B1%80" title="#%E7%AA%97%E5%8F%A3%E5%B8%83%E5%B1%80">窗口布局</a></li>
<li><a href="#%E7%AA%97%E5%8F%A3%E4%BA%8B%E4%BB%B6" title="#%E7%AA%97%E5%8F%A3%E4%BA%8B%E4%BB%B6">窗口事件</a></li>
<li><a href="#%E7%AA%97%E5%8F%A3%E6%8C%89%E9%92%AE%E4%BA%8B%E4%BB%B6" title="#%E7%AA%97%E5%8F%A3%E6%8C%89%E9%92%AE%E4%BA%8B%E4%BB%B6">窗口按钮事件</a></li>
<li><a href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90" title="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90">完整代码解析</a></li>
</ol>
<h3 data-id="heading-2">效果与完整代码</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad840f215fc54c64960dc315434413de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-DX-W8gOW_g-aApeS6hg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767176614&amp;x-signature=xT8YOg0ODmTXdKwtZn%2BKkro8Nkk%3D" alt="title_bar" loading="lazy"/></p>
<p>title_bar</p>
<p>完整代码</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># title_bar.py</span>
<span class="hljs-keyword">from</span> PySide6.QtWidgets <span class="hljs-keyword">import</span> (
                                QWidget,
                                QVBoxLayout,
                                QHBoxLayout,
                                QLabel,
                                QPushButton,
                                QStyle,
                                QApplication,
                            )
<span class="hljs-keyword">from</span> PySide6.QtGui <span class="hljs-keyword">import</span> QMouseEvent
<span class="hljs-keyword">from</span> PySide6.QtCore <span class="hljs-keyword">import</span> Qt


<span class="hljs-keyword">class</span> <span class="hljs-title class_">TitleBar</span>(<span class="hljs-title class_ inherited__">QWidget</span>):
    <span class="hljs-string">"""
    自定义标题栏
    """</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, parent=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""构造函数

        :param parent: 父类窗口
        """</span>
        <span class="hljs-built_in">super</span>().__init__(parent)
        self.setWindowFlags(Qt.WindowType.FramelessWindowHint)
        self.setup_ui()
        self.setup_event_bind()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_ui</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""设置界面"""</span>
        <span class="hljs-comment"># 全局使用垂直布局</span>
        layout = QVBoxLayout(self)

        <span class="hljs-comment"># 标题栏使用水平布局</span>
        title_layout = QHBoxLayout()

        <span class="hljs-comment"># 窗口图标 窗口标题 窗口按钮</span>
        self.icon_label = QLabel(
            pixmap=self.style().standardPixmap(
                QStyle.StandardPixmap.SP_DialogApplyButton
            )
        )
        self.title_label = QLabel(<span class="hljs-string">"自定义标题栏"</span>)
        self.min_btn = QPushButton(
            icon=self.style().standardPixmap(QStyle.StandardPixmap.SP_TitleBarMinButton)
        )
        self.max_btn = QPushButton(
            icon=self.style().standardPixmap(QStyle.StandardPixmap.SP_TitleBarMaxButton)
        )
        self.close_btn = QPushButton(
            icon=self.style().standardPixmap(
                QStyle.StandardPixmap.SP_TitleBarCloseButton
            )
        )

        <span class="hljs-comment"># 最大化窗口 可勾选 默认不勾选</span>
        self.max_btn.setCheckable(<span class="hljs-literal">True</span>)
        self.max_btn.setChecked(<span class="hljs-literal">False</span>)

        <span class="hljs-comment"># 固定控件大小</span>
        self.min_btn.setFixedSize(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>)
        self.max_btn.setFixedSize(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>)
        self.close_btn.setFixedSize(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>)

        <span class="hljs-comment"># 添加布局与控件</span>
        layout.addLayout(title_layout)
        title_layout.addWidget(self.icon_label)
        title_layout.addWidget(self.title_label)
        title_layout.addWidget(self.min_btn)
        title_layout.addWidget(self.max_btn)
        title_layout.addWidget(self.close_btn)
        layout.addWidget(QLabel(<span class="hljs-string">"Hello World"</span>))

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_event_bind</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""设置事件绑定"""</span>
        <span class="hljs-comment"># 缩小窗口 放大窗口与恢复窗口 关闭窗口</span>
        self.min_btn.clicked.connect(self.showMinimized)
        self.max_btn.clicked.connect(self.toggle_max_restore)
        self.close_btn.clicked.connect(self.close)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">toggle_max_restore</span>(<span class="hljs-params">self, checked: <span class="hljs-built_in">bool</span></span>):
        <span class="hljs-string">"""切换窗口最大与恢复"""</span>
        <span class="hljs-keyword">if</span> checked:
            self.max_btn.setIcon(
                self.style().standardPixmap(
                    QStyle.StandardPixmap.SP_TitleBarNormalButton
                )
            )
            self.showMaximized()
        <span class="hljs-keyword">else</span>:
            self.max_btn.setIcon(
                self.style().standardPixmap(QStyle.StandardPixmap.SP_TitleBarMaxButton)
            )
            self.showNormal()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">mousePressEvent</span>(<span class="hljs-params">self, event: QMouseEvent</span>):
        <span class="hljs-keyword">if</span> event.button() == Qt.LeftButton:
            window = self.window().windowHandle()
            <span class="hljs-keyword">if</span> window:
                window.startSystemMove()
            event.accept()


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主函数"""</span>
    app = QApplication([])
    title_bar = TitleBar()
    title_bar.setStyleSheet(<span class="hljs-string">"background-color:grey;"</span>)
    title_bar.show()
    app.<span class="hljs-built_in">exec</span>()


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h3 data-id="heading-3">窗口布局</h3>
<h4 data-id="heading-4">1.0 布局示意图</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed9a01df0b084329990458c81d56788b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-DX-W8gOW_g-aApeS6hg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767176614&amp;x-signature=uVZij43J45%2BaYqITxazpa49FAlA%3D" alt="title_bar" loading="lazy"/></p>
<p>title_bar</p>
<ul>
<li>绿色水平布局(窗口图标,标题栏,窗口图标)</li>
<li>整体垂直布局</li>
</ul>
<h4 data-id="heading-5">1.1 基础概念</h4>
<p>在 PySide6 中，布局管理器用于自动排列和调整控件的位置和大小。我们的自定义标题栏使用了两种布局：</p>
<ul>
<li><strong>QVBoxLayout</strong>: 垂直布局，控件从上到下排列</li>
<li><strong>QHBoxLayout</strong>: 水平布局，控件从左到右排列</li>
</ul>
<h4 data-id="heading-6">1.2 界面与布局结构</h4>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TitleBar</span>(<span class="hljs-title class_">QWidget</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params"><span class="hljs-variable language_">self</span>, parent=<span class="hljs-title class_">None</span></span>):
        <span class="hljs-variable language_">super</span>().__init__(parent)
        <span class="hljs-variable language_">self</span>.setWindowFlags(<span class="hljs-title class_">Qt</span>.<span class="hljs-title class_">WindowType</span>.<span class="hljs-title class_">FramelessWindowHint</span>)  <span class="hljs-comment"># 移除默认边框</span>
        <span class="hljs-variable language_">self</span>.setup_ui()
        <span class="hljs-variable language_">self</span>.setup_event_bind()
</code></pre>
<p><strong>关键点解释：</strong></p>
<ul>
<li><code>QWidget</code>: 所有用户界面对象的基础类</li>
<li><code>setWindowFlags(Qt.WindowType.FramelessWindowHint)</code>: 移除系统默认的窗口边框，这样我们才能使用自定义标题栏</li>
</ul>
<h4 data-id="heading-7">1.3 布局层次结构</h4>
<pre><code class="hljs language-scss" lang="scss">TitleBar (QVBoxLayout - 主布局)
├── title_layout (QHBoxLayout - 标题栏布局)
│   ├── icon_label (QLabel - 窗口图标)
│   ├── title_label (QLabel - 窗口标题)
│   ├── min_btn (QPushButton - 最小化按钮)
│   ├── max_btn (QPushButton - 最大化按钮)
│   └── close_btn (QPushButton - 关闭按钮)
└── QLabel ("Hello World" - 示例内容区域)
</code></pre>
<h4 data-id="heading-8">1.4 创建布局和控件</h4>
<pre><code class="hljs language-ini" lang="ini">def setup_ui(self):
    """设置界面"""
    <span class="hljs-comment"># 全局使用垂直布局</span>
    <span class="hljs-attr">layout</span> = QVBoxLayout(self)

    <span class="hljs-comment"># 标题栏使用水平布局</span>
    <span class="hljs-attr">title_layout</span> = QHBoxLayout()

    <span class="hljs-comment"># 创建窗口图标</span>
    <span class="hljs-attr">self.icon_label</span> = QLabel(
        <span class="hljs-attr">pixmap</span>=self.style().standardPixmap(
            QStyle.StandardPixmap.SP_DialogApplyButton
        )
    )
    
    <span class="hljs-comment"># 创建窗口标题</span>
    <span class="hljs-attr">self.title_label</span> = QLabel(<span class="hljs-string">"自定义标题栏"</span>)
    
    <span class="hljs-comment"># 创建窗口按钮</span>
    <span class="hljs-attr">self.min_btn</span> = QPushButton(
        <span class="hljs-attr">icon</span>=self.style().standardPixmap(QStyle.StandardPixmap.SP_TitleBarMinButton)
    )
    <span class="hljs-attr">self.max_btn</span> = QPushButton(
        <span class="hljs-attr">icon</span>=self.style().standardPixmap(QStyle.StandardPixmap.SP_TitleBarMaxButton)
    )
    <span class="hljs-attr">self.close_btn</span> = QPushButton(
        <span class="hljs-attr">icon</span>=self.style().standardPixmap(
            QStyle.StandardPixmap.SP_TitleBarCloseButton
        )
    )
</code></pre>
<p><strong>关键点解释：</strong></p>
<ol>
<li>
<p><strong>QLabel</strong>: 用于显示文本或图片的控件</p>
</li>
<li>
<p><strong>QPushButton</strong>: 按钮控件</p>
</li>
<li>
<p><strong>self.style().standardPixmap()</strong> : 获取系统标准图标，确保在不同操作系统上都有原生外观</p>
</li>
<li>
<p><strong>标准图标类型</strong>：</p>
<ul>
<li><code>SP_DialogApplyButton</code>: 对话框应用按钮图标</li>
<li><code>SP_TitleBarMinButton</code>: 标题栏最小化按钮图标</li>
<li><code>SP_TitleBarMaxButton</code>: 标题栏最大化按钮图标</li>
<li><code>SP_TitleBarCloseButton</code>: 标题栏关闭按钮图标</li>
</ul>
</li>
</ol>
<h4 data-id="heading-9">1.5 控件属性设置</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 最大化窗口 可勾选 默认不勾选</span>
self.max_btn.setCheckable(<span class="hljs-literal">True</span>)
self.max_btn.setChecked(<span class="hljs-literal">False</span>)

<span class="hljs-comment"># 固定控件大小</span>
self.min_btn.setFixedSize(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>)
self.max_btn.setFixedSize(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>)
self.close_btn.setFixedSize(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>)
</code></pre>
<p><strong>关键点解释：</strong></p>
<ul>
<li><code>setCheckable(True)</code>: 使按钮可以被选中/取消选中</li>
<li><code>setFixedSize(width, height)</code>: 设置控件的固定大小</li>
</ul>
<h4 data-id="heading-10">1.6 布局管理</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment"># 添加布局与控件</span>
layout.<span class="hljs-title function_ invoke__">addLayout</span>(title_layout)  <span class="hljs-comment"># 将标题栏布局添加到主布局</span>
title_layout.<span class="hljs-title function_ invoke__">addWidget</span>(<span class="hljs-built_in">self</span>.icon_label)  <span class="hljs-comment"># 添加图标</span>
title_layout.<span class="hljs-title function_ invoke__">addWidget</span>(<span class="hljs-built_in">self</span>.title_label)  <span class="hljs-comment"># 添加标题</span>
title_layout.<span class="hljs-title function_ invoke__">addWidget</span>(<span class="hljs-built_in">self</span>.min_btn)  <span class="hljs-comment"># 添加最小化按钮</span>
title_layout.<span class="hljs-title function_ invoke__">addWidget</span>(<span class="hljs-built_in">self</span>.max_btn)  <span class="hljs-comment"># 添加最大化按钮</span>
title_layout.<span class="hljs-title function_ invoke__">addWidget</span>(<span class="hljs-built_in">self</span>.close_btn)  <span class="hljs-comment"># 添加关闭按钮</span>
layout.<span class="hljs-title function_ invoke__">addWidget</span>(<span class="hljs-title function_ invoke__">QLabel</span>(<span class="hljs-string">"Hello World"</span>))  <span class="hljs-comment"># 添加内容区域</span>
</code></pre>
<h3 data-id="heading-11">窗口事件</h3>
<h4 data-id="heading-12">2.1 窗口拖动功能</h4>
<p>为了实现窗口拖动，我们需要重写 <code>mousePressEvent</code> 方法：</p>
<pre><code class="hljs language-scss" lang="scss">def <span class="hljs-built_in">mousePressEvent</span>(self, event: QMouseEvent):
    if event.<span class="hljs-built_in">button</span>() == Qt.LeftButton:
        window = self.<span class="hljs-built_in">window</span>().<span class="hljs-built_in">windowHandle</span>()
        if window:
            window.<span class="hljs-built_in">startSystemMove</span>()
        event.<span class="hljs-built_in">accept</span>()
</code></pre>
<p><strong>关键点解释：</strong></p>
<ol>
<li><strong>QMouseEvent</strong>: 鼠标事件类，包含鼠标操作的所有信息</li>
<li><code>event.button() == Qt.LeftButton</code>: 检查是否为鼠标左键点击</li>
<li><code>self.window().windowHandle()</code>: 获取窗口句柄</li>
<li><code>window.startSystemMove()</code>: 启动系统级别的窗口移动操作</li>
</ol>
<h4 data-id="heading-13">2.2 跨平台支持</h4>
<p>这个实现方式的优势在于：</p>
<ul>
<li><strong>Linux (Wayland/X11)</strong> : <code>startSystemMove()</code> 方法在 Linux 的两种显示服务器上都能正常工作</li>
<li><strong>Windows</strong>: 在 Windows 系统上同样支持原生窗口移动</li>
<li><strong>macOS</strong>: 也支持 macOS 的窗口移动</li>
</ul>
<p>这比传统的实现方式（如记录鼠标位置并手动移动窗口）更加可靠和跨平台。</p>
<h4 data-id="heading-14">2.3 事件处理机制</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">event</span>.accept()  <span class="hljs-meta"># 接受事件，阻止事件继续传播</span>
</code></pre>
<p><code>event.accept()</code> 告诉系统我们已经处理了这个事件，不需要进一步处理。</p>
<h3 data-id="heading-15">窗口按钮事件</h3>
<h4 data-id="heading-16">3.1 事件绑定</h4>
<p>在 <code>setup_event_bind</code> 方法中，我们将按钮的点击事件连接到相应的处理函数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_event_bind</span>(<span class="hljs-params">self</span>):
    <span class="hljs-string">"""设置事件绑定"""</span>
    <span class="hljs-comment"># 缩小窗口 放大窗口与恢复窗口 关闭窗口</span>
    self.min_btn.clicked.connect(self.showMinimized)
    self.max_btn.clicked.connect(self.toggle_max_restore)
    self.close_btn.clicked.connect(self.close)
</code></pre>
<p><strong>关键点解释：</strong></p>
<ul>
<li><code>clicked.connect()</code>: 将按钮的点击信号连接到相应的槽函数</li>
<li>信号槽机制是 PySide6 的核心特性，用于实现对象间的通信</li>
</ul>
<h4 data-id="heading-17">3.2 最小化窗口</h4>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-built_in">self</span>.min_btn.clicked.connect(<span class="hljs-built_in">self</span>.showMinimized)
</code></pre>
<p><code>showMinimized()</code> 是 QWidget 的内置方法，直接将窗口最小化到任务栏。</p>
<h4 data-id="heading-18">3.3 最大化与恢复窗口</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">toggle_max_restore</span>(<span class="hljs-params">self, checked: <span class="hljs-built_in">bool</span></span>):
    <span class="hljs-string">"""切换窗口最大与恢复"""</span>
    <span class="hljs-keyword">if</span> checked:
        self.max_btn.setIcon(
            self.style().standardPixmap(
                QStyle.StandardPixmap.SP_TitleBarNormalButton
            )
        )
        self.showMaximized()
    <span class="hljs-keyword">else</span>:
        self.max_btn.setIcon(
            self.style().standardPixmap(QStyle.StandardPixmap.SP_TitleBarMaxButton)
        )
        self.showNormal()
</code></pre>
<p><strong>关键点解释：</strong></p>
<ol>
<li>
<p><strong>checked 参数</strong>: 由于我们设置了 <code>setCheckable(True)</code>，这个参数表示按钮的选中状态</p>
</li>
<li>
<p><strong>图标切换</strong>：</p>
<ul>
<li>最大化时显示恢复图标 (<code>SP_TitleBarNormalButton</code>)</li>
<li>恢复时显示最大化图标 (<code>SP_TitleBarMaxButton</code>)</li>
</ul>
</li>
<li>
<p><strong>窗口状态方法</strong>：</p>
<ul>
<li><code>showMaximized()</code>: 将窗口最大化</li>
<li><code>showNormal()</code>: 将窗口恢复到正常大小</li>
</ul>
</li>
</ol>
<h4 data-id="heading-19">3.4 关闭窗口</h4>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-built_in">self</span>.close_btn.clicked.connect(<span class="hljs-built_in">self</span>.<span class="hljs-built_in">close</span>)
</code></pre>
<p><code>close()</code> 是 QWidget 的内置方法，关闭窗口并退出应用程序。</p>
<h3 data-id="heading-20">完整代码解析</h3>
<h4 data-id="heading-21">4.1 导入模块</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> PySide6.QtWidgets <span class="hljs-keyword">import</span> (
    QWidget,        <span class="hljs-comment"># 基础窗口控件</span>
    QVBoxLayout,    <span class="hljs-comment"># 垂直布局</span>
    QHBoxLayout,    <span class="hljs-comment"># 水平布局</span>
    QLabel,         <span class="hljs-comment"># 标签控件</span>
    QPushButton,    <span class="hljs-comment"># 按钮控件</span>
    QStyle,         <span class="hljs-comment"># 样式相关类</span>
    QApplication,   <span class="hljs-comment"># 应用程序类</span>
)
<span class="hljs-keyword">from</span> PySide6.QtGui <span class="hljs-keyword">import</span> QMouseEvent  <span class="hljs-comment"># 鼠标事件</span>
<span class="hljs-keyword">from</span> PySide6.QtCore <span class="hljs-keyword">import</span> Qt         <span class="hljs-comment"># 核心枚举和类</span>
</code></pre>
<h4 data-id="heading-22">4.2 主函数</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主函数"""</span>
    app = QApplication([])          <span class="hljs-comment"># 创建应用程序实例</span>
    title_bar = TitleBar()          <span class="hljs-comment"># 创建自定义标题栏实例</span>
    title_bar.setStyleSheet(<span class="hljs-string">"background-color:grey;"</span>)  <span class="hljs-comment"># 设置背景色</span>
    title_bar.show()                <span class="hljs-comment"># 显示窗口</span>
    app.<span class="hljs-built_in">exec</span>()                      <span class="hljs-comment"># 进入事件循环</span>
</code></pre>
<p><strong>关键点解释：</strong></p>
<ol>
<li><code>QApplication([])</code>: 创建应用程序对象，管理 GUI 应用程序</li>
<li><code>setStyleSheet()</code>: 设置控件样式，这里设置背景色为灰色</li>
<li><code>show()</code>: 显示窗口</li>
<li><code>app.exec()</code>: 进入应用程序的主事件循环</li>
</ol>
<h4 data-id="heading-23">4.3 运行程序</h4>
<pre><code class="hljs language-ini" lang="ini">if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<p>这是 Python 的标准写法，确保只有直接运行此文件时才会执行 <code>main()</code> 函数。</p>
<h3 data-id="heading-24">总结</h3>
<p>通过本教程，我们学习了如何：</p>
<ol>
<li><strong>创建自定义布局</strong>: 使用 QVBoxLayout 和 QHBoxLayout 组织界面元素</li>
<li><strong>添加窗口控件</strong>: 创建图标、标题和按钮等界面元素</li>
<li><strong>实现窗口拖动</strong>: 使用 <code>startSystemMove()</code> 实现跨平台窗口拖动</li>
<li><strong>处理窗口操作</strong>: 实现最小化、最大化/恢复、关闭等功能</li>
</ol>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmd.axiaoxin.com%2F%3Ffrom%3Djuejin" target="_blank" title="https://md.axiaoxin.com/?from=juejin" ref="nofollow noopener noreferrer">人言兑.md-公众号排版编辑器</a> 排版</p>
<ul>
<li>本文采用「人言兑.md」自动排版 -</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ai加Flutter实现自定义标题栏(appBar)]]></title>    <link>https://juejin.cn/post/7587253759092064292</link>    <guid>https://juejin.cn/post/7587253759092064292</guid>    <pubDate>2025-12-24T10:26:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587253759092064292" data-draft-id="7587253759092031524" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ai加Flutter实现自定义标题栏(appBar)"/> <meta itemprop="keywords" content="Flutter,前端"/> <meta itemprop="datePublished" content="2025-12-24T10:26:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心_开心急了"/> <meta itemprop="url" content="https://juejin.cn/user/2975724155181111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ai加Flutter实现自定义标题栏(appBar)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2975724155181111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心_开心急了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T10:26:51.000Z" title="Wed Dec 24 2025 10:26:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Ai加Flutter实现自定义标题栏(appBar)</h2>
<p>在这篇博客中，笔者会讲诉<strong>为什么要实现自定义标题栏</strong>，<strong>标题栏都有些什么功能</strong>，然后<strong>结合AI简单实现自定义标题栏</strong>！</p>
<p>话不多说，我们直接开始吧！</p>
<h3 data-id="heading-1">基础需求与环境准备</h3>
<p>这篇文档默认你的设备已经配置了<code>flutter</code>环境且自身具备了如下：</p>
<ul>
<li>一定的<code>Dart</code>语法基础</li>
<li>了解甚至熟悉其他桌面应用开发框架(比如:<code>Qt</code>以及其他)</li>
<li>一个<code>flutter</code>空项目-&gt; <code>flutter create --empty your_project_name</code></li>
<li>想要学会<code>flutter</code>的心</li>
</ul>
<blockquote>
<p><strong>补充说明</strong>： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2F" target="_blank" title="https://docs.flutter.dev/" ref="nofollow noopener noreferrer">安装flutter环境来这里</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdart.cn%2Flanguage%23additional-resources" target="_blank" title="https://dart.cn/language#additional-resources" ref="nofollow noopener noreferrer">dart语法基础来这里</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fcodelabs.developers.google.com%2Fcodelabs%2Fflutter-codelab-first%3Fhl%3Dzh-cn%230" target="_blank" title="https://codelabs.developers.google.com/codelabs/flutter-codelab-first?hl=zh-cn#0" ref="nofollow noopener noreferrer">新手入门项目来这里</a></p>
</blockquote>
<p><strong>注意:</strong> 学习程度因人而异，如果满足的点越多，理论上学习效率越高！</p>
<p>笔者的环境:</p>
<ul>
<li><strong>Linux</strong>: <code>64</code>位 <code>fedora 43 gnome</code>，桌面系统<code>Wayland</code>，内核版本<code>Linux 6.17.9-300.fc43.x86_64</code></li>
<li><strong>Flutter</strong>: <code>Flutter 3.38.5</code></li>
<li><strong>Dart</strong>: <code>Dart 3.10.4</code></li>
<li><strong>DevTools</strong>: <code>2.51.1</code></li>
<li><strong>大模型</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.qianwen.com%2F" target="_blank" title="https://www.qianwen.com/" ref="nofollow noopener noreferrer">通义千问网页版(<code>Qwen3-Coder</code>模型)</a></li>
</ul>
<h3 data-id="heading-2">为什么要自定义标题栏</h3>
<p>我们可以参考常见的应用<code>vscode</code>、<code>QQ</code>、<code>微信</code>等这些在(<code>Windows</code>、<code>Linux</code>和<code>macOS</code>)都有较强的统一风格，这就是自定义标题栏的目的——<strong>统一风格</strong></p>
<blockquote>
<p><strong>插一嘴</strong>：其实自定义标题栏可以避免大量因标题栏样式不统一而导致的问题(比如:<code>gnome49</code>的标题栏不支持暗色主题等)</p>
</blockquote>
<h3 data-id="heading-3">怎么实现自定义标题栏</h3>
<h4 data-id="heading-4">需求拆解</h4>
<h5 data-id="heading-5">(第一性原理)——标题栏的构成</h5>
<p>我们需要把这个看似复杂的问题简单化，实现自定义标题栏那我们就要知道<strong>标题栏</strong>的构成：<strong>窗口图标</strong>、<strong>窗口标题</strong>、<strong>窗口按钮</strong>(最小化、最大与还原、关闭)！见下图： <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ce8a5d91da24f448cb737f275b079ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-DX-W8gOW_g-aApeS6hg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767176810&amp;x-signature=Lezo7xOtweXVg88aiJ3UC106gjw%3D" alt="标题栏" loading="lazy"/></p>
<blockquote>
<p><strong>注意</strong>: <code>gnome</code> 和 <code>macOS</code>不支持窗口图标！</p>
</blockquote>
<h5 data-id="heading-6">(类比思维)——AppBar的构成</h5>
<p>事实窗口标题栏和<code>flutter</code>中的<code>appBar</code>是吻合的，见下图 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed57af1654524e358482b293cfff0b26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-DX-W8gOW_g-aApeS6hg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767176810&amp;x-signature=2HKXb21NNJ4J3n%2Bv%2BHIzBi3oWYs%3D" alt="appBar" loading="lazy"/></p>
<h5 data-id="heading-7">(需求转换)——隐藏系统默认标题栏使用AppBar</h5>
<p>既然我们已经知道<code>AppBar</code>的功能可以平替窗口标题栏， 那么我们直接隐藏默认的使用AppBar自定义一个不就好了？</p>
<h4 data-id="heading-8">自定义标题栏——AppBar</h4>
<h5 data-id="heading-9">(需求拆解)——隐藏与appBar实现对应功能</h5>
<p>关闭系统默认的标题栏 标题栏与AppBar以及功能映射关系</p>
<ul>
<li>窗口图标 -&gt; <code>leading</code>-&gt; 显示窗口图标</li>
<li>窗口标题 -&gt;<code>title</code>-&gt; 显示窗口标题</li>
<li>窗口图标们 -&gt; <code>actions</code> -&gt; 显示对应图标以及窗口的隐藏，放大复原，关闭</li>
</ul>
<h5 data-id="heading-10">(window_manager)——安装与导入自定义标题栏插件</h5>
<ol>
<li>安装<code>window_manager</code></li>
</ol>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 终端执行如下：</span>
flutter pub <span class="hljs-keyword">add</span> window_manager
</code></pre>
<p>2.  导入插件</p>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 程序顶部添加如下</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:window_manager/window_manager.dart'</span>;
</code></pre>
<h5 data-id="heading-11">(window_manager)——隐藏默认标题栏</h5>
<ol>
<li>替换程序入口代码块</li>
</ol>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span>()</span> {
  runApp(<span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-title">MyApp</span>())</span>;
}
</code></pre>
<p>替换为</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span>() <span class="hljs-keyword">async</span></span> {
  WidgetsFlutterBinding.ensureInitialized();

  <span class="hljs-keyword">await</span> windowManager.ensureInitialized();
  WindowOptions windowOptions = WindowOptions(
    titleBarStyle: TitleBarStyle.hidden,
  );
  windowManager.waitUntilReadyToShow(windowOptions, () <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> windowManager.focus();
  });

  runApp(<span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-title">MainApp</span>())</span>;
}
</code></pre>
<blockquote>
<p><strong>注意</strong>： 确保你创建的是空项目 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fwindow_manager" target="_blank" title="https://pub.dev/packages/window_manager" ref="nofollow noopener noreferrer">window_manager插件官网</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b549c739d674f44959af263bbb09634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-DX-W8gOW_g-aApeS6hg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767176810&amp;x-signature=GBaI3cgzXU4fp%2FadzyBdzUOY4%2BU%3D" alt="显示效果" loading="lazy"/></p>
<p>显示效果</p>
<h5 data-id="heading-12">借助window_manager与appBar实现自定义标题栏</h5>
<ol>
<li>替换脚手架里的内容</li>
</ol>

<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span>: <span class="hljs-built_in">Center</span>(child: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Hello World!'</span>))
</code></pre>

<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">//替换为</span>
 appBar: AppBar(
          leading: <span class="hljs-attribute">Icon(Icons.favorite),
          title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">"自定义标题栏"</span>),
          <span class="hljs-attribute">actions</span>: [
            <span class="hljs-built_in">IconButton</span>(<span class="hljs-attribute">onPressed</span>: () {}, <span class="hljs-attribute">icon</span>: <span class="hljs-built_in">Icon</span>(Icons.horizontal_rule)),
            <span class="hljs-built_in">IconButton</span>(<span class="hljs-attribute">onPressed</span>: () {}, <span class="hljs-attribute">icon</span>: <span class="hljs-built_in">Icon</span>(Icons.crop_square)),
            <span class="hljs-built_in">IconButton</span>(<span class="hljs-attribute">onPressed</span>: () {}, <span class="hljs-attribute">icon</span>: <span class="hljs-built_in">Icon</span>(Icons.close)),
          ],
        ),
</code></pre>
<p><strong>显示效果</strong> <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65a1db5dc1904be485c9563c57e8bc54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-DX-W8gOW_g-aApeS6hg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767176810&amp;x-signature=IzPF8cOd63e43essFzy5imqCxwc%3D" alt="按钮" loading="lazy"/></p>
<h5 data-id="heading-13">借助window_manager实现appBar窗口按钮功能</h5>
<ol>
<li>添加最小化窗口和关闭窗口</li>
</ol>

<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 替换为如下：</span>
appBar: AppBar(
          leading: <span class="hljs-attribute">Icon(Icons.favorite),
          title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">"自定义标题栏"</span>),
          <span class="hljs-attribute">actions</span>: [
            <span class="hljs-built_in">IconButton</span>(
              <span class="hljs-attribute">onPressed</span>: () {
                windowManager.<span class="hljs-built_in">minimize</span>();
              },
              <span class="hljs-attribute">icon</span>: <span class="hljs-built_in">Icon</span>(Icons.horizontal_rule),
            ),
            <span class="hljs-built_in">IconButton</span>(<span class="hljs-attribute">onPressed</span>: () {}, <span class="hljs-attribute">icon</span>: <span class="hljs-built_in">Icon</span>(Icons.crop_square)),
            <span class="hljs-built_in">IconButton</span>(
              <span class="hljs-attribute">onPressed</span>: () {
                windowManager.<span class="hljs-built_in">close</span>();
              },
              <span class="hljs-attribute">icon</span>: <span class="hljs-built_in">Icon</span>(Icons.close),
            ),
          ],
        ),
</code></pre>
<p>2.  还原与最大化窗口</p>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 将 StatelessWidget 转为StatefulWidget</span>
<span class="hljs-comment">// vscode 选中StatelessWidget 显示代码操作(ctrl.)StatefulWidget</span>

<span class="hljs-comment">// _MainAppState 初始化变量用于记录是否最大化</span>
  <span class="hljs-type">bool</span> _isMaximized = <span class="hljs-literal">false</span>
</code></pre>
<p>替换appBar为如下:</p>
<pre><code class="hljs language-less" lang="less">         appBar: AppBar(
          leading: <span class="hljs-attribute">Icon(Icons.favorite),
          title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">"自定义标题栏"</span>),
          <span class="hljs-attribute">actions</span>: [
            <span class="hljs-built_in">IconButton</span>(
              <span class="hljs-attribute">onPressed</span>: () {
                windowManager.<span class="hljs-built_in">minimize</span>();
              },
              <span class="hljs-attribute">icon</span>: <span class="hljs-built_in">Icon</span>(Icons.horizontal_rule),
            ),
            <span class="hljs-built_in">IconButton</span>(
              <span class="hljs-attribute">onPressed</span>: () {
                if (_isMaximized) {
                  windowManager.<span class="hljs-built_in">unmaximize</span>();
                  <span class="hljs-built_in">setState</span>(() {
                    _isMaximized = !_isMaximized;
                  });
                } else {
                  windowManager.<span class="hljs-built_in">maximize</span>();
                  <span class="hljs-built_in">setState</span>(() {
                    _isMaximized = !_isMaximized;
                  });
                }
              },
              <span class="hljs-attribute">icon</span>: _isMaximized
                  ? <span class="hljs-built_in">Icon</span>(Icons.crop_free)
                  : <span class="hljs-built_in">Icon</span>(Icons.crop_square),
            ),
            <span class="hljs-built_in">IconButton</span>(
              <span class="hljs-attribute">onPressed</span>: () {
                windowManager.<span class="hljs-built_in">close</span>();
              },
              <span class="hljs-attribute">icon</span>: <span class="hljs-built_in">Icon</span>(Icons.close),
            ),
          ],
        ),
</code></pre>
<p><strong>显示效果</strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f20750bf3d4642148459ed0943d7a1bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-DX-W8gOW_g-aApeS6hg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767176810&amp;x-signature=Zl42JT%2FhPJYaHdK%2FDSiWgH6lxsg%3D" alt="按钮事件" loading="lazy"/></p>
<h5 data-id="heading-14">借助window_manager实现拖动窗口</h5>
<p><strong>简单的办法</strong> 直接监听鼠标事件</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">//AppBar里添加如下</span>
          flexibleSpace: <span class="hljs-built_in">Listener</span>(
            onPointerDown: (_) =&gt; windowManager.<span class="hljs-built_in">startDragging</span>(),
            child: <span class="hljs-built_in">Container</span>(color: Colors.transparent),
          ),
</code></pre>
<p><strong>光标带拖动效果</strong> 我的系统并不支持</p>
<pre><code class="hljs language-less" lang="less">          flexibleSpace: MouseRegion(
            <span class="hljs-attribute">cursor</span>: SystemMouseCursors.move,
            <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Listener</span>(
              <span class="hljs-attribute">onPointerDown</span>: (_) =&gt; windowManager.<span class="hljs-built_in">startDragging</span>(),
              <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Container</span>(<span class="hljs-attribute">color</span>: Colors.transparent),
            ),
          ),
</code></pre>
<p><strong>显示效果</strong> <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef671ffe05194aedae51163d5001b3a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5b-DX-W8gOW_g-aApeS6hg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767176810&amp;x-signature=IUdnrBHNm0VsmI5V0%2FIh9Hj8q2I%3D" alt="all" loading="lazy"/></p>
<blockquote>
<p><strong>注意</strong>:</p>
<ul>
<li>都是长按鼠标左键拖动窗口,右键鼠标 跟随光标移动</li>
<li>一定要在Container 中添加颜色为透明 不然无法移动</li>
</ul>
</blockquote>
<h4 data-id="heading-15">最终的代码</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> '<span class="hljs-selector-tag">package</span>:<span class="hljs-selector-tag">flutter</span>/<span class="hljs-selector-tag">material</span><span class="hljs-selector-class">.dart</span>';
<span class="hljs-selector-tag">import</span> '<span class="hljs-selector-tag">package</span>:<span class="hljs-selector-tag">window_manager</span>/<span class="hljs-selector-tag">window_manager</span><span class="hljs-selector-class">.dart</span>';

<span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>() <span class="hljs-selector-tag">async</span> {
  <span class="hljs-selector-tag">WidgetsFlutterBinding</span><span class="hljs-selector-class">.ensureInitialized</span>();

  <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">windowManager</span><span class="hljs-selector-class">.ensureInitialized</span>();
  <span class="hljs-selector-tag">WindowOptions</span> <span class="hljs-selector-tag">windowOptions</span> = <span class="hljs-selector-tag">WindowOptions</span>(
    <span class="hljs-attribute">titleBarStyle</span>: TitleBarStyle.hidden,
  );
  <span class="hljs-selector-tag">windowManager</span><span class="hljs-selector-class">.waitUntilReadyToShow</span>(windowOptions, () async {
    <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">windowManager</span><span class="hljs-selector-class">.focus</span>();
  });

  <span class="hljs-selector-tag">runApp</span>(const <span class="hljs-built_in">MainApp</span>());
}

<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">MainApp</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">StatefulWidget</span> {
  <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">MainApp</span>({<span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.key</span>});

  @<span class="hljs-selector-tag">override</span>
  <span class="hljs-selector-tag">State</span>&lt;<span class="hljs-selector-tag">MainApp</span>&gt; <span class="hljs-selector-tag">createState</span>() =&gt; <span class="hljs-selector-tag">_MainAppState</span>();
}

<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">_MainAppState</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">State</span>&lt;<span class="hljs-selector-tag">MainApp</span>&gt; {
  <span class="hljs-selector-tag">bool</span> <span class="hljs-selector-tag">_isMaximized</span> = <span class="hljs-selector-tag">false</span>;

  <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">_toggleMaximize</span>() {
    <span class="hljs-selector-tag">if</span> (_isMaximized) {
      <span class="hljs-selector-tag">windowManager</span><span class="hljs-selector-class">.unmaximize</span>();
    } <span class="hljs-selector-tag">else</span> {
      <span class="hljs-selector-tag">windowManager</span><span class="hljs-selector-class">.maximize</span>();
    }
    <span class="hljs-selector-tag">setState</span>(() =&gt; _isMaximized = !_isMaximized);
  }

  @<span class="hljs-selector-tag">override</span>
  <span class="hljs-selector-tag">Widget</span> <span class="hljs-selector-tag">build</span>(BuildContext context) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">MaterialApp</span>(
      <span class="hljs-attribute">home</span>: <span class="hljs-built_in">Scaffold</span>(
        <span class="hljs-attribute">appBar</span>: <span class="hljs-built_in">AppBar</span>(
          <span class="hljs-attribute">leading</span>: <span class="hljs-built_in">Icon</span>(Icons.favorite),
          <span class="hljs-attribute">title</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'自定义标题栏'</span>),
          <span class="hljs-attribute">flexibleSpace</span>: <span class="hljs-built_in">Listener</span>(
            <span class="hljs-attribute">onPointerDown</span>: (event) =&gt; windowManager.<span class="hljs-built_in">startDragging</span>(),
            <span class="hljs-attribute">child</span>: <span class="hljs-built_in">Container</span>(<span class="hljs-attribute">color</span>: Colors.transparent),
          ),
          <span class="hljs-attribute">actions</span>: [
            <span class="hljs-built_in">IconButton</span>(
              <span class="hljs-attribute">icon</span>: <span class="hljs-built_in">Icon</span>(Icons.horizontal_rule),
              <span class="hljs-attribute">onPressed</span>: windowManager.minimize,
            ),
            <span class="hljs-built_in">IconButton</span>(
              <span class="hljs-attribute">icon</span>: <span class="hljs-built_in">Icon</span>(_isMaximized ? Icons.<span class="hljs-attribute">crop_free </span>: Icons.crop_square),
              <span class="hljs-attribute">onPressed</span>: _toggleMaximize,
            ),
            <span class="hljs-built_in">IconButton</span>(<span class="hljs-attribute">icon</span>: <span class="hljs-built_in">Icon</span>(Icons.close), <span class="hljs-attribute">onPressed</span>: windowManager.close),
          ],
        ),
        <span class="hljs-attribute">body</span>: <span class="hljs-built_in">Center</span>(<span class="hljs-attribute">child</span>: <span class="hljs-built_in">Text</span>(<span class="hljs-string">'Hello, World!'</span>)),
      ),
    );
  }
}
</code></pre>
<h4 data-id="heading-16">AI询问过程</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.qianwen.com%2Fshare%3FshareId%3Dbbc837bd-1e9f-4698-9f11-8c7783c31d87" target="_blank" title="https://www.qianwen.com/share?shareId=bbc837bd-1e9f-4698-9f11-8c7783c31d87" ref="nofollow noopener noreferrer">通义AI对话过程</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[请求 ID 跟踪模式：解决异步请求竞态条件]]></title>    <link>https://juejin.cn/post/7587254134400696329</link>    <guid>https://juejin.cn/post/7587254134400696329</guid>    <pubDate>2025-12-24T10:36:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587254134400696329" data-draft-id="7587246055457112091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="请求 ID 跟踪模式：解决异步请求竞态条件"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-24T10:36:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鲫小鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1046390798032110"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            请求 ID 跟踪模式：解决异步请求竞态条件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390798032110/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鲫小鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T10:36:29.000Z" title="Wed Dec 24 2025 10:36:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📋 目录</h2>
<ul>
<li><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF" title="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF">问题背景</a></li>
<li><a href="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90" title="#%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90">问题分析</a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" title="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">解决方案</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86" title="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86">实现原理</a></li>
<li><a href="#%E9%97%AD%E5%8C%85%E4%B8%8E-ref-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3" title="#%E9%97%AD%E5%8C%85%E4%B8%8E-ref-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3">闭包与 Ref 深入理解</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></li>
<li><a href="#%E6%80%BB%E7%BB%93" title="#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">问题背景</h2>
<p>在搜索场景中，用户快速输入关键词时会触发多个并发请求：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用户快速输入：a → ac → acd</span>
<span class="hljs-comment">// 会触发 3 个请求，但返回顺序可能不同</span>
</code></pre>
<p><strong>问题表现：</strong></p>
<ul>
<li>推荐商品列表有时会多出 5 个商品</li>
<li>显示的商品与当前关键词不匹配</li>
<li>旧请求的结果覆盖了新请求的结果</li>
</ul>
<hr/>
<h2 data-id="heading-2">问题分析</h2>
<h3 data-id="heading-3">竞态条件（Race Condition）</h3>
<p>当多个异步请求并发执行时，由于网络延迟不同，返回顺序可能与发起顺序不一致：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">时间线：
<span class="hljs-symbol">T1:</span> 用户输入 <span class="hljs-string">"a"</span>  → 触发请求<span class="hljs-number">1</span>
<span class="hljs-symbol">T2:</span> 用户输入 <span class="hljs-string">"ac"</span> → 触发请求<span class="hljs-number">2</span>
<span class="hljs-symbol">T3:</span> 请求<span class="hljs-number">2</span>返回     → 设置 productList = [<span class="hljs-string">"ac相关商品"</span>]
<span class="hljs-symbol">T4:</span> 请求<span class="hljs-number">1</span>返回     → 设置 productList = [<span class="hljs-string">"a相关商品"</span>] ❌ 错误！
</code></pre>
<p><strong>根本原因：</strong></p>
<ul>
<li>React 的 <code>setState</code> 是异步的</li>
<li>多个请求同时进行，无法保证哪个先返回</li>
<li>旧请求的结果可能覆盖新请求的结果</li>
</ul>
<hr/>
<h2 data-id="heading-4">解决方案</h2>
<h3 data-id="heading-5">请求 ID 跟踪机制</h3>
<p>使用一个全局递增的请求 ID 来跟踪每个请求，确保只处理最新请求的结果。</p>
<h3 data-id="heading-6">核心思路</h3>
<ol>
<li><strong>每个请求分配唯一 ID</strong>：使用 <code>useRef</code> 保存一个递增的计数器</li>
<li><strong>请求开始时保存 ID</strong>：在闭包中保存当前请求的 ID</li>
<li><strong>请求返回时验证</strong>：比较保存的 ID 和最新的 ID，判断请求是否仍然有效</li>
</ol>
<hr/>
<h2 data-id="heading-7">实现原理</h2>
<h3 data-id="heading-8">1. 添加请求 ID 跟踪器</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用于跟踪当前请求的 ID，确保只处理最新请求的结果</span>
<span class="hljs-keyword">const</span> requestIdRef = useRef&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">0</span>)
</code></pre>
<p><strong>为什么使用 <code>useRef</code>？</strong></p>
<ul>
<li><code>useRef</code> 的值在组件重新渲染时保持不变</li>
<li><code>.current</code> 属性是可变的，可以随时更新</li>
<li>不会触发组件重新渲染</li>
</ul>
<h3 data-id="heading-9">2. 请求开始时生成并保存 ID</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 生成新的请求 ID（先递增再取值）</span>
    <span class="hljs-keyword">const</span> currentRequestId = ++requestIdRef.<span class="hljs-property">current</span>

    <span class="hljs-comment">// 保存当前请求的关键词（双重验证）</span>
    <span class="hljs-keyword">const</span> currentKeyword = keyWord.<span class="hljs-title function_">trim</span>()

    <span class="hljs-comment">// ... 发起请求</span>
  }

  <span class="hljs-title function_">fetchProductList</span>()
}, [keyWord])
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><code>++requestIdRef.current</code> 先递增再取值</li>
<li><code>currentRequestId</code> 被闭包捕获，保存请求开始时的值</li>
<li><code>currentKeyword</code> 也被闭包捕获，用于双重验证</li>
</ul>
<h3 data-id="heading-10">3. 请求返回时验证 ID</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPublicSearchFilter</span>(params)

<span class="hljs-comment">// 检查是否是最新的请求</span>
<span class="hljs-keyword">if</span> (currentRequestId !== requestIdRef.<span class="hljs-property">current</span>) {
  <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 忽略旧请求的结果</span>
}

<span class="hljs-comment">// 双重验证：检查关键词是否仍然匹配</span>
<span class="hljs-keyword">if</span> (currentKeyword !== keyWord.<span class="hljs-title function_">trim</span>()) {
  <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 关键词已改变，忽略结果</span>
}

<span class="hljs-comment">// 只有通过所有检查才设置 state</span>
<span class="hljs-title function_">setProductList</span>([...proList])
</code></pre>
<hr/>
<h2 data-id="heading-11">完整代码示例</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useState, useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">SearchList</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [productList, setProductList] = useState&lt;<span class="hljs-built_in">any</span>[]&gt;([])
  <span class="hljs-keyword">const</span> [productLoading, setProductLoading] = useState&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>)

  <span class="hljs-comment">// 用于跟踪当前请求的 ID</span>
  <span class="hljs-keyword">const</span> requestIdRef = useRef&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">0</span>)

  <span class="hljs-comment">// 获取推荐商品列表</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 如果没有搜索关键字，不请求</span>
      <span class="hljs-keyword">if</span> (!keyWord || !keyWord.<span class="hljs-title function_">trim</span>()) {
        <span class="hljs-title function_">setProductList</span>([])
        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-comment">// 生成新的请求 ID</span>
      <span class="hljs-keyword">const</span> currentRequestId = ++requestIdRef.<span class="hljs-property">current</span>
      <span class="hljs-comment">// 保存当前请求的关键词，用于验证结果是否仍然有效</span>
      <span class="hljs-keyword">const</span> currentKeyword = keyWord.<span class="hljs-title function_">trim</span>()

      <span class="hljs-title function_">setProductLoading</span>(<span class="hljs-literal">true</span>)
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Search</span>.<span class="hljs-property">SearchParams</span> = {
          <span class="hljs-attr">keyword</span>: currentKeyword,
          <span class="hljs-attr">size</span>: <span class="hljs-number">5</span>,
          <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>,
        }

 
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPublicSearchFilter</span>(params)

        <span class="hljs-comment">// ✅ 检查1：是否是最新的请求</span>
        <span class="hljs-comment">// 如果不是则忽略结果，避免旧的请求结果覆盖新的结果</span>
        <span class="hljs-keyword">if</span> (currentRequestId !== requestIdRef.<span class="hljs-property">current</span>) {
          <span class="hljs-keyword">return</span>
        }

        <span class="hljs-comment">// ✅ 检查2：关键词是否仍然匹配（双重保险）</span>
        <span class="hljs-keyword">if</span> (currentKeyword !== keyWord.<span class="hljs-title function_">trim</span>()) {
          <span class="hljs-keyword">return</span>
        }

        <span class="hljs-keyword">const</span> items = response?.<span class="hljs-property">itemList</span>?.<span class="hljs-property">data</span> || []
        <span class="hljs-keyword">const</span> proList = items.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>)

        <span class="hljs-title function_">setProductList</span>([...proList])
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 检查是否是最新的请求，如果不是则忽略错误</span>
        <span class="hljs-keyword">if</span> (currentRequestId !== requestIdRef.<span class="hljs-property">current</span>) {
          <span class="hljs-keyword">return</span>
        }
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取推荐商品失败:'</span>, error)
        <span class="hljs-title function_">setProductList</span>([])
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 只有在是最新请求时才更新 loading 状态</span>
        <span class="hljs-keyword">if</span> (currentRequestId === requestIdRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">setProductLoading</span>(<span class="hljs-literal">false</span>)
        }
      }
    }

    <span class="hljs-title function_">fetchProductList</span>()
  }, [keyWord])

  <span class="hljs-comment">// ... 其他代码</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-12">闭包与 Ref 深入理解</h2>
<h3 data-id="heading-13">关键概念</h3>
<h4 data-id="heading-14">1. <code>currentRequestId</code> 被闭包捕获</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 这一行执行时，currentRequestId 被"冻结"在闭包中</span>
  <span class="hljs-keyword">const</span> currentRequestId = ++requestIdRef.<span class="hljs-property">current</span>  <span class="hljs-comment">// 假设此时 = 1</span>

  <span class="hljs-comment">// ... 发起异步请求 ...</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPublicSearchFilter</span>(params)  <span class="hljs-comment">// 这里等待，可能需要几秒钟</span>

  <span class="hljs-comment">// 当请求返回时，currentRequestId 仍然是 1（闭包保存的值）</span>
  <span class="hljs-comment">// 但 requestIdRef.current 可能已经是 2、3、4...（最新值）</span>
  <span class="hljs-keyword">if</span> (currentRequestId !== requestIdRef.<span class="hljs-property">current</span>) {
    <span class="hljs-keyword">return</span>
  }
}
</code></pre>
<p><strong>要点：</strong></p>
<ul>
<li><code>currentRequestId</code> 是局部常量，在函数执行时被赋值</li>
<li>异步函数返回时，它仍然保持请求开始时的值</li>
<li><strong>这就是闭包：函数"记住"了创建时的变量值</strong></li>
</ul>
<h4 data-id="heading-15">2. <code>requestIdRef.current</code> 始终是最新的</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// requestIdRef 是一个 ref 对象</span>
<span class="hljs-keyword">const</span> requestIdRef = useRef&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">0</span>)

<span class="hljs-comment">// ref.current 是一个可变引用，每次读取都返回最新值</span>
requestIdRef.<span class="hljs-property">current</span>  <span class="hljs-comment">// 读取时总是最新值</span>
</code></pre>
<p><strong>要点：</strong></p>
<ul>
<li><code>requestIdRef</code> 是 React 的 ref 对象，<code>.current</code> 是可变的</li>
<li>每次读取 <code>requestIdRef.current</code> 都会得到当前最新值</li>
<li><strong>不受闭包影响，因为它不是被捕获的变量，而是通过引用访问</strong></li>
</ul>
<h3 data-id="heading-16">时间线示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// === 初始状态 ===</span>
requestIdRef.<span class="hljs-property">current</span> = <span class="hljs-number">0</span>

<span class="hljs-comment">// === T1: 用户输入 "a"，触发请求1 ===</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList1</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> currentRequestId = ++requestIdRef.<span class="hljs-property">current</span>
  <span class="hljs-comment">// 执行后：currentRequestId = 1, requestIdRef.current = 1</span>

  <span class="hljs-comment">// 闭包捕获：currentRequestId = 1（被"冻结"）</span>
  <span class="hljs-comment">// ref 引用：requestIdRef.current（随时可读取最新值）</span>

  <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPublicSearchFilter</span>(...)  <span class="hljs-comment">// 等待响应...</span>
}

<span class="hljs-comment">// === T2: 用户输入 "ac"，触发请求2（请求1还在等待中）===</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchProductList2</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> currentRequestId = ++requestIdRef.<span class="hljs-property">current</span>
  <span class="hljs-comment">// 执行后：currentRequestId = 2, requestIdRef.current = 2</span>

  <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPublicSearchFilter</span>(...)  <span class="hljs-comment">// 等待响应...</span>
}

<span class="hljs-comment">// === T3: 请求1返回（此时 requestIdRef.current 已经是 2）===</span>
<span class="hljs-comment">// 在 fetchProductList1 的闭包中：</span>
<span class="hljs-keyword">if</span> (currentRequestId !== requestIdRef.<span class="hljs-property">current</span>) {
  <span class="hljs-comment">// currentRequestId = 1（闭包保存的旧值）</span>
  <span class="hljs-comment">// requestIdRef.current = 2（读取的最新值）</span>
  <span class="hljs-comment">// 1 !== 2 ✅ 返回，忽略结果</span>
  <span class="hljs-keyword">return</span>
}

<span class="hljs-comment">// === T4: 请求2返回 ===</span>
<span class="hljs-comment">// 在 fetchProductList2 的闭包中：</span>
<span class="hljs-keyword">if</span> (currentRequestId !== requestIdRef.<span class="hljs-property">current</span>) {
  <span class="hljs-comment">// currentRequestId = 2（闭包保存的值）</span>
  <span class="hljs-comment">// requestIdRef.current = 2（如果此时没有新请求）</span>
  <span class="hljs-comment">// 2 === 2 ✅ 通过检查，设置 state</span>
}
</code></pre>
<h3 data-id="heading-17">内存中的状态</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 内存布局示意：</span>

<span class="hljs-comment">// 全局 ref（所有函数共享）</span>
requestIdRef = {
  <span class="hljs-attr">current</span>: <span class="hljs-number">3</span>  <span class="hljs-comment">// ← 始终是最新值，随时可读取</span>
}

<span class="hljs-comment">// 请求1的闭包（已废弃）</span>
fetchProductList1 闭包环境：
  <span class="hljs-attr">currentRequestId</span>: <span class="hljs-number">1</span>  <span class="hljs-comment">// ← 被"冻结"，不会改变</span>

<span class="hljs-comment">// 请求2的闭包（已废弃）</span>
fetchProductList2 闭包环境：
  <span class="hljs-attr">currentRequestId</span>: <span class="hljs-number">2</span>  <span class="hljs-comment">// ← 被"冻结"，不会改变</span>

<span class="hljs-comment">// 请求3的闭包（当前有效）</span>
fetchProductList3 闭包环境：
  <span class="hljs-attr">currentRequestId</span>: <span class="hljs-number">3</span>  <span class="hljs-comment">// ← 被"冻结"，不会改变</span>
</code></pre>
<h3 data-id="heading-18">对比：闭包 vs Ref</h3>






























<table><thead><tr><th>特性</th><th><code>currentRequestId</code> (闭包)</th><th><code>requestIdRef.current</code> (Ref)</th></tr></thead><tbody><tr><td>值的变化</td><td>创建时赋值后不再改变</td><td>每次读取都是最新值</td></tr><tr><td>作用域</td><td>函数闭包内</td><td>全局可访问</td></tr><tr><td>用途</td><td>保存请求开始时的 ID</td><td>保存最新的请求 ID</td></tr><tr><td>类比</td><td>拍照（定格瞬间）</td><td>实时监控（动态更新）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-19">为什么这样设计有效？</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 关键代码</span>
<span class="hljs-keyword">const</span> currentRequestId = ++requestIdRef.<span class="hljs-property">current</span>  <span class="hljs-comment">// 闭包捕获：保存"快照"</span>
<span class="hljs-comment">// ... 异步操作 ...</span>
<span class="hljs-keyword">if</span> (currentRequestId !== requestIdRef.<span class="hljs-property">current</span>) {  <span class="hljs-comment">// 比较"快照"和"实时值"</span>
  <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 如果不同，说明已有新请求</span>
}
</code></pre>
<p><strong>工作原理：</strong></p>
<ol>
<li><strong>请求开始时</strong>：<code>currentRequestId</code> 保存当前 ID（快照）</li>
<li><strong>请求进行中</strong>：<code>requestIdRef.current</code> 可能被新请求更新</li>
<li><strong>请求返回时</strong>：比较快照和最新值
<ul>
<li>✅ <strong>相同</strong> → 仍是最新请求，处理结果</li>
<li>❌ <strong>不同</strong> → 已被新请求取代，忽略结果</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-20">最佳实践</h2>
<h3 data-id="heading-21">1. 何时使用请求 ID 跟踪？</h3>
<p>✅ <strong>适用场景：</strong></p>
<ul>
<li>用户输入触发的搜索请求</li>
<li>下拉选择触发的数据加载</li>
<li>任何可能快速连续触发的异步操作</li>
</ul>
<p>❌ <strong>不适用场景：</strong></p>
<ul>
<li>一次性请求（如页面初始化）</li>
<li>按钮点击触发的请求（用户不会快速点击）</li>
<li>定时轮询请求（通常需要取消机制）</li>
</ul>
<h3 data-id="heading-22">2. 双重验证的必要性</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 检查1：请求 ID（主要检查）</span>
<span class="hljs-keyword">if</span> (currentRequestId !== requestIdRef.<span class="hljs-property">current</span>) {
  <span class="hljs-keyword">return</span>
}

<span class="hljs-comment">// 检查2：关键词匹配（双重保险）</span>
<span class="hljs-keyword">if</span> (currentKeyword !== keyWord.<span class="hljs-title function_">trim</span>()) {
  <span class="hljs-keyword">return</span>
}
</code></pre>
<p><strong>为什么需要双重验证？</strong></p>
<ul>
<li>请求 ID 检查：防止旧请求覆盖新请求</li>
<li>关键词检查：防止边界情况（如请求 ID 相同但关键词已改变）</li>
</ul>
<h3 data-id="heading-23">3. 错误处理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-comment">// 检查是否是最新的请求，如果不是则忽略错误</span>
  <span class="hljs-keyword">if</span> (currentRequestId !== requestIdRef.<span class="hljs-property">current</span>) {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取推荐商品失败:'</span>, error)
  <span class="hljs-title function_">setProductList</span>([])
}
</code></pre>
<p><strong>要点：</strong></p>
<ul>
<li>错误处理也要检查请求 ID</li>
<li>避免旧请求的错误影响新请求的状态</li>
</ul>
<h3 data-id="heading-24">4. Loading 状态管理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">finally</span> {
  <span class="hljs-comment">// 只有在是最新请求时才更新 loading 状态</span>
  <span class="hljs-keyword">if</span> (currentRequestId === requestIdRef.<span class="hljs-property">current</span>) {
    <span class="hljs-title function_">setProductLoading</span>(<span class="hljs-literal">false</span>)
  }
}
</code></pre>
<p><strong>要点：</strong></p>
<ul>
<li>Loading 状态也要检查请求 ID</li>
<li>避免旧请求的 loading 状态影响 UI</li>
</ul>
<hr/>
<h2 data-id="heading-25">其他解决方案对比</h2>
<h3 data-id="heading-26">方案1：AbortController（推荐用于可取消的请求）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> abortControllerRef = useRef&lt;<span class="hljs-title class_">AbortController</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>)

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 取消之前的请求</span>
  <span class="hljs-keyword">if</span> (abortControllerRef.<span class="hljs-property">current</span>) {
    abortControllerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">abort</span>()
  }

  <span class="hljs-keyword">const</span> abortController = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()
  abortControllerRef.<span class="hljs-property">current</span> = abortController

  <span class="hljs-title function_">fetch</span>(url, { <span class="hljs-attr">signal</span>: abortController.<span class="hljs-property">signal</span> })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (abortController.<span class="hljs-property">signal</span>.<span class="hljs-property">aborted</span>) <span class="hljs-keyword">return</span>
      <span class="hljs-comment">// 处理响应</span>
    })
}, [deps])
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>可以真正取消网络请求</li>
<li>节省带宽和服务器资源</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>需要 API 支持 <code>AbortController</code></li>
<li>某些旧的 API 可能不支持</li>
</ul>
<h3 data-id="heading-27">方案2：请求 ID 跟踪（本文方案）</h3>
<p><strong>优点：</strong></p>
<ul>
<li>适用于任何异步操作</li>
<li>不依赖 API 支持</li>
<li>实现简单</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>不能真正取消网络请求</li>
<li>请求仍会占用带宽</li>
</ul>
<h3 data-id="heading-28">方案3：防抖（Debounce）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> debouncedSearch = <span class="hljs-title function_">useMemo</span>(
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">keyword: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
    <span class="hljs-title function_">fetchProductList</span>(keyword)
  }, <span class="hljs-number">300</span>),
  []
)
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>减少请求次数</li>
<li>简单易用</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>延迟响应</li>
<li>用户可能等待更长时间</li>
</ul>
<hr/>
<h2 data-id="heading-29">总结</h2>
<h3 data-id="heading-30">核心要点</h3>
<ol>
<li><strong>问题根源</strong>：多个异步请求并发执行，返回顺序不确定</li>
<li><strong>解决方案</strong>：使用请求 ID 跟踪，确保只处理最新请求</li>
<li><strong>关键机制</strong>：闭包保存"快照"，Ref 提供"实时值"</li>
<li><strong>验证策略</strong>：双重验证（请求 ID + 业务参数）</li>
</ol>
<h3 data-id="heading-31">适用场景</h3>
<p>✅ 搜索输入框的联想词/推荐商品
✅ 下拉选择的数据加载
✅ 快速连续触发的异步操作</p>
<h3 data-id="heading-32">关键代码模式</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 创建跟踪器</span>
<span class="hljs-keyword">const</span> requestIdRef = useRef&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">0</span>)

<span class="hljs-comment">// 2. 请求开始时保存 ID</span>
<span class="hljs-keyword">const</span> currentRequestId = ++requestIdRef.<span class="hljs-property">current</span>

<span class="hljs-comment">// 3. 请求返回时验证</span>
<span class="hljs-keyword">if</span> (currentRequestId !== requestIdRef.<span class="hljs-property">current</span>) {
  <span class="hljs-keyword">return</span>  <span class="hljs-comment">// 忽略旧请求</span>
}
</code></pre>
<h3 data-id="heading-33">记忆口诀</h3>
<blockquote>
<p><strong>"闭包保存快照，Ref 提供实时值，比较两者判断有效性"</strong></p>
</blockquote>
<blockquote>
<p>最后感谢阅读！欢迎关注我，微信公众号：《鲫小鱼不正经》。欢迎点赞、收藏、关注，一键三连！！！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 父子组件数据传递：机制与意义解析]]></title>    <link>https://juejin.cn/post/7587024296885207090</link>    <guid>https://juejin.cn/post/7587024296885207090</guid>    <pubDate>2025-12-24T09:23:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587024296885207090" data-draft-id="7587021119255347227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 父子组件数据传递：机制与意义解析"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-12-24T09:23:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冻梨政哥"/> <meta itemprop="url" content="https://juejin.cn/user/2373184444182659"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 父子组件数据传递：机制与意义解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2373184444182659/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冻梨政哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:23:07.000Z" title="Wed Dec 24 2025 09:23:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 父子组件数据传递：机制与意义解析</h2>
<p>在 React 组件化开发中，组件间的通信是构建复杂应用的核心环节。本文以一个 Todo 列表应用为例，详细解析父子组件的数据传递方式及其背后的设计意义。</p>
<h3 data-id="heading-1">一、组件结构与通信场景</h3>
<p>在提供的 Todo 应用中，存在明确的组件层级关系：</p>
<ul>
<li><strong>父组件</strong>：<code>App</code> 组件作为根组件，是整个应用的核心</li>
<li><strong>子组件</strong>：<code>TodoInput</code>（输入框）、<code>TodoList</code>（列表展示）、<code>TodoStatus</code>（状态统计）三个子组件，均由 <code>App</code> 组件直接渲染</li>
</ul>
<p>这些组件需要协同工作：输入框添加待办项、列表展示所有项、统计区显示数量并提供清除功能。这种协同依赖于组件间的数据传递。</p>
<h3 data-id="heading-2">二、父子组件数据传递的核心方式</h3>
<p>React 中父子组件的通信遵循<strong>单向数据流</strong>原则，通过 <code>props</code> 实现数据传递，具体分为两种方向：</p>
<h4 data-id="heading-3">1. 父组件 → 子组件：通过 props 传递数据</h4>
<p>父组件将需要共享的数据通过 <code>props</code> 传递给子组件，子组件通过接收 <code>props</code> 来使用这些数据。</p>
<p><strong>示例解析</strong>：</p>
<ul>
<li>在 <code>App</code> 组件中，定义了核心数据 <code>todos</code>（待办项列表），以及基于 <code>todos</code> 计算的统计数据（<code>total</code>、<code>active</code>、<code>completed</code>）</li>
<li>父组件通过 <code>props</code> 将这些数据传递给子组件：</li>
</ul>
<pre><code class="hljs language-xml" lang="xml">// App.jsx 中传递数据给子组件
<span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span> <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span> <span class="hljs-attr">...</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">TodoStatus</span> <span class="hljs-attr">total</span>=<span class="hljs-string">{todos.length}</span> <span class="hljs-attr">active</span>=<span class="hljs-string">{activeCount}</span> <span class="hljs-attr">completed</span>=<span class="hljs-string">{completedCount}</span> <span class="hljs-attr">...</span> /&gt;</span>
</code></pre>
<p>子组件通过解构 <code>props</code> 接收并使用数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// TodoList 接收并展示 todos 数据</span>
<span class="hljs-keyword">const</span> { todos } = props;
<span class="hljs-comment">// 渲染 todos 列表</span>
todos.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> (...))

<span class="hljs-comment">// TodoStatus 接收并展示统计数据</span>
<span class="hljs-keyword">const</span> { total, active, completed } = props;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Total: {total} | Active: {active} | Completed: {completed}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-4">2. 子组件 → 父组件：通过回调函数传递数据变更请求</h4>
<p>子组件不能直接修改父组件传递的数据（React 中 props 是只读的），需通过调用父组件传递的<strong>回调函数</strong>，将数据变更的需求传递给父组件，由父组件负责更新数据。</p>
<p><strong>示例解析</strong>：</p>
<ul>
<li>父组件定义修改数据的方法（如 <code>addTodo</code>、<code>deleteTodo</code>），并通过 <code>props</code> 将这些方法传递给子组件：</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// App.jsx 中定义方法并传递
const <span class="hljs-attr">addTodo</span> = (text) =&gt; {
  setTodos(<span class="hljs-section">[...todos, { id: Date.now(), text, completed: false }]</span>)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

&lt;TodoInput <span class="hljs-attr">onAdd</span>={addTodo} /&gt;
&lt;TodoList <span class="hljs-attr">onDelete</span>={deleteTodo} <span class="hljs-literal">on</span>Toggle={toggleTodo} /&gt;
</code></pre>
<p>子组件触发用户操作时，调用父组件传递的回调函数，传递需要变更的数据：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// TodoInput 接收 onAdd 方法，在提交时调用</span>
const { onAdd } = props;
const handleSubmit = (e) =&gt; {
  e<span class="hljs-selector-class">.preventDefault</span>();
  <span class="hljs-built_in">onAdd</span>(inputValue); <span class="hljs-comment">// 将输入的文本传递给父组件</span>
  <span class="hljs-built_in">setInputValue</span>('');
};

<span class="hljs-comment">// TodoList 接收 onDelete 方法，在点击删除时调用</span>
&lt;<span class="hljs-selector-tag">button</span> onClick={() =&gt; <span class="hljs-built_in">onDelete</span>(todo.id)}&gt;X&lt;/<span class="hljs-selector-tag">button</span>&gt;
</code></pre>
<h3 data-id="heading-5">三、这种传递方式的核心意义</h3>
<ol>
<li>
<p><strong>数据集中管理，保持单一数据源</strong>所有核心数据（<code>todos</code>）由父组件 <code>App</code> 统一持有和管理，子组件仅通过 <code>props</code> 获取数据或请求修改。这种设计避免了数据分散在多个组件中导致的 "数据混乱"，便于追踪数据的变更历史。</p>
</li>
<li>
<p><strong>明确组件职责，实现关注点分离</strong></p>
<ul>
<li>父组件：专注于数据的存储、计算和更新逻辑（如 <code>addTodo</code>、<code>deleteTodo</code> 方法）</li>
<li>子组件：专注于 UI 展示和用户交互（如 <code>TodoInput</code> 处理输入、<code>TodoList</code> 展示列表）职责分离让组件更易于维护和复用，例如 <code>TodoList</code> 仅依赖传入的 <code>todos</code> 和回调函数，可在其他场景中直接复用。</li>
</ul>
</li>
<li>
<p><strong>单向数据流，提升可预测性</strong>数据只能从父组件流向子组件，子组件的变更需求必须通过父组件处理。这种单向流动让应用的状态变化可预测，当出现问题时，能快速定位到数据变更的源头（父组件的方法），降低调试难度。</p>
</li>
<li>
<p><strong>间接实现兄弟组件通信</strong>兄弟组件（如 <code>TodoInput</code> 和 <code>TodoList</code>）本身无法直接通信，但通过父组件作为 "中介"，可间接实现数据同步。例如：<code>TodoInput</code> 添加新项后，父组件更新 <code>todos</code>，<code>TodoList</code> 因接收的 <code>todos</code> 变化而重新渲染，实现了兄弟组件的状态协同。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite项目中process报红问题的深层原因与解决方案]]></title>    <link>https://juejin.cn/post/7587028972246695971</link>    <guid>https://juejin.cn/post/7587028972246695971</guid>    <pubDate>2025-12-24T09:25:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587028972246695971" data-draft-id="7587243886433386530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite项目中process报红问题的深层原因与解决方案"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-24T09:25:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="shanLion"/> <meta itemprop="url" content="https://juejin.cn/user/2788017217477048"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite项目中process报红问题的深层原因与解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017217477048/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    shanLion
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:25:47.000Z" title="Wed Dec 24 2025 09:25:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在使用Vite构建的前端项目中，<code>process</code>对象在某些文件中报红（如VSCode中显示错误）是常见问题。本文将系统阐述该问题的深层原因及解决方案，涵盖环境配置、依赖管理与代码兼容性三大核心环节。通过规范化流程，确保<code>process</code>对象在所有文件中稳定可用，避免开发中断。</p>
<h2 data-id="heading-0">深层原因分析</h2>
<h3 data-id="heading-1">1. ‌<strong>TypeScript类型检查机制</strong>‌</h3>
<ul>
<li>‌<strong>TypeScript的严格类型检查</strong>‌：TypeScript默认不识别Node.js内置对象（如<code>process</code>），导致在浏览器环境中报红。例如，<code>process</code>仅在Node.js环境中有效，而Vite默认将代码视为浏览器环境，引发类型冲突。</li>
<li>‌<strong>环境隔离问题</strong>‌：Vite通过ESM模块系统运行代码，与Node.js的CommonJS环境隔离，导致TypeScript无法识别<code>process</code>的全局变量。</li>
</ul>
<h3 data-id="heading-2">2. ‌<strong>Vite的预构建机制</strong>‌</h3>
<ul>
<li>‌<strong>预构建冲突</strong>‌：Vite在构建时会预处理依赖，若未正确配置，可能导致Node.js内置模块（如<code>process</code>）与浏览器环境冲突。例如，<code>process</code>在预构建阶段被误判为浏览器环境变量，引发报红。</li>
<li>‌<strong>环境变量处理</strong>‌：Vite的<code>import.meta.env</code>机制仅支持静态环境变量（如<code>.env</code>文件），而<code>process</code>是动态全局对象，需显式声明。</li>
</ul>
<h2 data-id="heading-3">解决方案</h2>
<p><strong>解决方案</strong></p>
<h3 data-id="heading-4">1. ‌<strong>环境配置调整</strong>‌</h3>
<ul>
<li>
<p>‌<strong>强制声明全局变量</strong>‌：在项目根目录创建<code>vite.env.d.ts</code>文件，显式声明<code>process</code>类型：</p>
<pre><code class="hljs language-csharp" lang="csharp">typescriptCopy Code
<span class="hljs-comment">// vite.env.d.ts</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;reference types="node" /&gt;</span></span>
</code></pre>
<p>此声明告知TypeScript<code>process</code>是Node.js内置对象，避免类型冲突。</p>
</li>
<li>
<p>‌<strong>排除Node.js模块</strong>‌：在<code>vite.config.ts</code>中排除<code>process</code>模块，避免预构建冲突：</p>
<pre><code class="hljs language-arduino" lang="arduino">javascriptCopy Code
<span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  optimizeDeps: {
    exclude: [<span class="hljs-string">'process'</span>]
  }
}
</code></pre>
<p>此配置确保<code>process</code>仅在Node.js环境中生效，避免浏览器环境报错。</p>
</li>
</ul>
<h3 data-id="heading-5">2. ‌<strong>依赖管理优化</strong>‌</h3>
<ul>
<li>
<p>‌<strong>安装类型定义</strong>‌：运行<code>pnpm i @types/node -D</code>安装Node.js类型定义，增强TypeScript识别能力。例如，在Vue3项目中，此命令可解决<code>process</code>报红问题。</p>
</li>
<li>
<p>‌<strong>动态导入处理</strong>‌：在关键逻辑中添加环境判断，避免<code>process</code>在浏览器中报错：</p>
<pre><code class="hljs language-arduino" lang="arduino">javascriptCopy Code
<span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">if</span> (typeof process !== <span class="hljs-string">'undefined'</span> &amp;&amp; process.env.NODE_ENV === <span class="hljs-string">'development'</span>) {
  console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'Development mode'</span>);
}
</code></pre>
<p>此方法确保<code>process</code>仅在Node.js环境中生效，避免浏览器环境报错。</p>
</li>
</ul>
<h3 data-id="heading-6">3. ‌<strong>代码兼容性增强</strong>‌</h3>
<ul>
<li>
<p>‌<strong>环境变量声明</strong>‌：在项目入口文件（如<code>main.js</code>）中显式声明<code>process</code>对象：</p>
<pre><code class="hljs language-arduino" lang="arduino">javascriptCopy Code
<span class="hljs-comment">// main.js</span>
globalThis.process = globalThis.process || { env: {} };
</code></pre>
<p>此声明确保<code>process</code>在所有文件中可用，避免编译器误判。</p>
</li>
<li>
<p>‌<strong>条件编译处理</strong>‌：在关键逻辑中添加环境判断，避免<code>process</code>在浏览器中报错：</p>
<pre><code class="hljs language-arduino" lang="arduino">javascriptCopy Code
<span class="hljs-comment">// utils.js</span>
<span class="hljs-keyword">if</span> (typeof process !== <span class="hljs-string">'undefined'</span> &amp;&amp; process.env.NODE_ENV === <span class="hljs-string">'development'</span>) {
  console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'Development mode'</span>);
}
</code></pre>
<p>此方法确保<code>process</code>仅在Node.js环境中生效，避免浏览器环境报错。</p>
</li>
</ul>
<h2 data-id="heading-7">总结</h2>
<p>Vite 的配置文件 <code>vite.config.js</code> 本质上是 ‌<strong>Node.js 环境下的 JavaScript 文件</strong>‌，它在构建时由 Node.js 直接执行，而非经过 TypeScript 编译器（tsc）类型检查。即使你使用的是 <code>.js</code> 后缀，Vite 也会在 Node.js 运行时环境中加载它，此时 <code>process</code> 是 Node.js 内置的全局对象，即使未在tsconfig.json中显式添加<code>"types": ["node"]</code>，也会默认注入Node.js的全局类型定义（如<code>process</code>、<code>__dirname</code>等）。无需类型声明即可使用。</p>
<p>此外，Vite 在启动时会自动注入 <code>process.env</code> 的环境变量，并在构建阶段将其替换为静态值，因此它天然支持 <code>process</code> 对象，无需额外类型定义。</p>
<p>而其他 <code>.ts</code> 或 <code>.tsx</code> 文件中使用 <code>process.env.NODE_ENV</code> 时，TypeScript 会进行严格的类型检查。此时，TypeScript 并不知道 <code>process</code> 是什么——因为它默认不包含 Node.js 的全局类型定义。除非你显式告诉 TypeScript：“这个项目运行在 Node.js 环境中”，否则它会认为 <code>process</code> 未定义，从而报错：“找不到名称‘process’”。</p>























<table><thead><tr><th>场景</th><th>文件类型</th><th>执行环境</th><th>是否需要 <code>@types/node</code></th></tr></thead><tbody><tr><td><code>vite.config.js</code></td><td>JavaScript</td><td>Node.js 运行时</td><td>❌ 不需要（由 Node.js 直接执行）</td></tr><tr><td><code>src/*.ts</code></td><td>TypeScript</td><td>TypeScript 编译器检查</td><td>✅ 必须安装并配置</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零搭建一个 React Todo 应用：父子通信、状态管理与本地持久化]]></title>    <link>https://juejin.cn/post/7587254134400286729</link>    <guid>https://juejin.cn/post/7587254134400286729</guid>    <pubDate>2025-12-24T09:30:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587254134400286729" data-draft-id="7587062584165580838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零搭建一个 React Todo 应用：父子通信、状态管理与本地持久化"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-12-24T09:30:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="玉宇夕落"/> <meta itemprop="url" content="https://juejin.cn/user/3323164053734988"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零搭建一个 React Todo 应用：父子通信、状态管理与本地持久化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3323164053734988/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    玉宇夕落
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:30:50.000Z" title="Wed Dec 24 2025 09:30:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-scss" lang="scss">text
编辑
<span class="hljs-attribute">src</span>/
├── App<span class="hljs-selector-class">.jsx</span>
├── components/
│   ├── TodoInput<span class="hljs-selector-class">.jsx</span>    <span class="hljs-comment">// 添加任务输入框</span>
│   ├── TodoList<span class="hljs-selector-class">.jsx</span>     <span class="hljs-comment">// 任务列表展示</span>
│   └── TodoStats<span class="hljs-selector-class">.jsx</span>    <span class="hljs-comment">// 统计信息与清除已完成</span>
└── styles/
    └── app<span class="hljs-selector-class">.styl</span>         <span class="hljs-comment">// 全局样式（使用 Stylus）</span>
</code></pre>
<p>整个应用围绕 <strong>“父组件持有状态，子组件通过 props 接收数据和回调”</strong> 的单向数据流原则构建。</p>
<hr/>
<h2 data-id="heading-0">📦 父组件：<code>App.jsx</code> —— 状态管理中心</h2>
<pre><code class="hljs language-javascript" lang="javascript">jsx
编辑
<span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./styles/app.styl'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoList'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoInput</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoInput'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoStats</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoStats'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ✅ 关键：初始化时从 localStorage 读取数据，形成持久化闭环的第一步</span>
  <span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> saved = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'todos'</span>)
    <span class="hljs-keyword">return</span> saved ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved) : []
  })

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!text.<span class="hljs-title function_">trim</span>()) <span class="hljs-keyword">return</span>
    <span class="hljs-title function_">setTodos</span>([...todos, {
      <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      text,
      <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>,
    }])
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> !== id))
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span>
      todo.<span class="hljs-property">id</span> === id ? { ...todo, <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span> } : todo
    ))
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearCompleted</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> !todo.<span class="hljs-property">completed</span>))
  }

  <span class="hljs-keyword">const</span> activeCount = todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> !t.<span class="hljs-property">completed</span>).<span class="hljs-property">length</span>
  <span class="hljs-keyword">const</span> completedCount = todos.<span class="hljs-property">length</span> - activeCount

  <span class="hljs-comment">// ⚠️ 注意：这段代码仅完成「写入」，必须配合初始化读取才能实现完整持久化</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'todos'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(todos))
  }, [todos])

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-app"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>My Todo List<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoInput</span> <span class="hljs-attr">onAdd</span>=<span class="hljs-string">{addTodo}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span> 
        <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span>  
        <span class="hljs-attr">onDelete</span>=<span class="hljs-string">{deleteTodo}</span>
        <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{toggleTodo}</span>
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoStats</span> 
        <span class="hljs-attr">total</span>=<span class="hljs-string">{todos.length}</span>
        <span class="hljs-attr">active</span>=<span class="hljs-string">{activeCount}</span>
        <span class="hljs-attr">completed</span>=<span class="hljs-string">{completedCount}</span>
        <span class="hljs-attr">onClearCompleted</span>=<span class="hljs-string">{clearCompleted}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>
</code></pre>
<h3 data-id="heading-1">🔍 本地存储的完整闭环：读 + 写缺一不可</h3>
<p>你可能会问：<strong>仅靠 <code>useEffect</code> 中的 <code>localStorage.setItem</code> 能实现本地存储吗？</strong></p>
<p><strong>答案是：不能。</strong></p>
<ul>
<li><strong><code>useEffect</code> 部分只负责“写入”</strong> ：当 <code>todos</code> 变化时，自动同步到 <code>localStorage</code>。</li>
<li><strong>但缺少“读取”环节</strong>：页面刷新后，若不从 <code>localStorage</code> 恢复数据，<code>todos</code> 会重置为空数组，导致数据丢失。</li>
</ul>
<p>✅ <strong>完整持久化 = 初始化读取 + 变化时写入</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">js
编辑
<span class="hljs-comment">// 1. 初始化读取（关键！）</span>
<span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> saved = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'todos'</span>);
  <span class="hljs-keyword">return</span> saved ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(saved) : [];
});

<span class="hljs-comment">// 2. 变化时写入（你已有的代码）</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'todos'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(todos));
}, [todos]);
</code></pre>
<blockquote>
<p>💡 <strong>本质</strong>：这是一个“内存 ↔ 本地存储”的双向同步闭环。<strong>只有两者都存在，才能实现“刷新不丢数据”</strong> 。</p>
</blockquote>
<h4 data-id="heading-2">⚠️ 注意事项</h4>
<ul>
<li><strong>JSON 序列化限制</strong>：<code>todos</code> 中只能包含可序列化的数据（字符串、数字、布尔值、普通对象/数组），不能包含函数、Symbol 等。</li>
<li><strong>存储容量</strong>：<code>localStorage</code> 通常限制为 5MB，适合轻量级数据。</li>
<li><strong>性能优化</strong>：避免因状态引用变化导致 <code>useEffect</code> 频繁触发（可通过 <code>useMemo</code> 或深比较优化）。</li>
</ul>
<hr/>
<h3 data-id="heading-3">✅ 状态管理的核心原则：子组件不能直接修改数据</h3>
<p>你的理解完全正确：<strong>子组件不可以直接修改父组件的状态，只能“提交修改请求”</strong> 。这是 React <strong>单向数据流</strong>的基石。</p>
<h4 data-id="heading-4">为什么这样设计？</h4>
<ol>
<li><strong>状态不可变性（Immutability）</strong><br/>
React 要求状态更新必须通过 <code>setState</code> 返回新对象，而非直接修改原对象。若子组件直接操作 <code>props.todos.push(...)</code>，既违反此原则，也无法触发重渲染。</li>
<li><strong>状态变更可追溯</strong><br/>
所有修改逻辑集中在父组件（如 <code>addTodo</code>, <code>deleteTodo</code>），便于调试、测试和维护。</li>
<li><strong>解耦与复用</strong><br/>
子组件只需关心“何时触发”，无需关心“如何修改”，降低耦合度。</li>
</ol>
<h4 data-id="heading-5">工作流程比喻</h4>
<ul>
<li><strong>父组件 = 仓库管理员</strong><br/>
持有 <code>todos</code>（货物清单），掌握所有操作权限（增删改查），并负责同步到 <code>localStorage</code>（纸质台账）。</li>
<li><strong>子组件 = 前台接待员</strong><br/>
无权直接操作仓库，只负责接收用户指令（点击按钮），并通过预设的“热线电话”（回调函数如 <code>onAdd</code>）将请求转达给管理员。</li>
<li><strong>流程</strong>：<br/>
用户操作 → 子组件调用回调 → 父组件更新状态 → 触发重渲染 + 同步本地存储 → 子组件接收新 <code>props</code> 并更新视图。</li>
</ul>
<blockquote>
<p>✅ 这种设计让整个应用<strong>状态清晰、逻辑集中、易于扩展</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">📝 子组件 1：<code>TodoInput</code> —— 输入新任务</h2>
<pre><code class="hljs language-javascript" lang="javascript">jsx
编辑
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoInput</span> = (<span class="hljs-params">{ onAdd }</span>) =&gt; {
  <span class="hljs-keyword">const</span> [inputValue, setInputValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>() <span class="hljs-comment">// 阻止表单默认提交（页面刷新）</span>
    <span class="hljs-title function_">onAdd</span>(inputValue)
    <span class="hljs-title function_">setInputValue</span>(<span class="hljs-string">''</span>) <span class="hljs-comment">// 清空输入框</span>
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-input"</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
        <span class="hljs-attr">value</span>=<span class="hljs-string">{inputValue}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setInputValue(e.target.value)}
        placeholder="What needs to be done?"
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Add<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoInput</span>
</code></pre>
<h3 data-id="heading-7">🔍 深入理解两个核心机制</h3>
<h4 data-id="heading-8">1. 为什么需要 <code>e.preventDefault()</code>？</h4>
<ul>
<li><strong>根本原因</strong>：<code>&lt;form&gt;</code> 提交会触发浏览器<strong>默认行为——刷新页面</strong>。</li>
<li>若不阻止，刚添加的 todo 会因页面刷新而丢失。</li>
<li><strong>关键原则</strong>：<code>e.preventDefault()</code> 的使用<strong>取决于事件是否有默认行为</strong>，与“是否是添加操作”无关。</li>
</ul>
<p>✅ <strong>不需要 <code>preventDefault</code> 的添加场景</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">jsx
编辑
// 按钮点击（无默认行为）
&lt;button <span class="hljs-attr">onClick</span>={() =&gt; { <span class="hljs-literal">on</span>Add(text)<span class="hljs-comment">; }}&gt;添加&lt;/button&gt;</span>

// 输入框回车监听（非表单提交）
&lt;input <span class="hljs-attr">onKeyDown</span>={(e) =&gt; {
  if (<span class="hljs-attr">e.key</span> === <span class="hljs-string">'Enter'</span>) <span class="hljs-literal">on</span>Add(inputValue)<span class="hljs-comment">;</span>
}} /&gt;
</code></pre>
<h4 data-id="heading-9">2. 为什么 <code>setInputValue('')</code> 能清空输入框？</h4>
<p>因为这是 <strong>受控组件（Controlled Component）</strong> ：</p>
<ul>
<li><code>value={inputValue}</code>：输入框显示由 React 状态驱动。</li>
<li><code>onChange</code>：用户输入时同步更新状态。</li>
<li>执行 <code>setInputValue('')</code> → 状态变空 → 组件重渲染 → 输入框显示为空。</li>
</ul>
<blockquote>
<p>❌ 非受控组件（用 <code>ref</code>）无法通过此方式清空，需直接操作 DOM。</p>
</blockquote>
<hr/>
<h2 data-id="heading-10">📋 子组件 2：<code>TodoList</code> —— 渲染任务项</h2>
<pre><code class="hljs language-ini" lang="ini">jsx
编辑
const <span class="hljs-attr">TodoList</span> = ({ todos, <span class="hljs-literal">on</span>Delete, <span class="hljs-literal">on</span>Toggle }) =&gt; {
  return (
    &lt;ul <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-list"</span>&gt;
      {<span class="hljs-attr">todos.length</span> === <span class="hljs-number">0</span> ? (
        &lt;li&gt;&lt;p <span class="hljs-attr">className</span>=<span class="hljs-string">"empty"</span>&gt;<span class="hljs-literal">No</span> todos, yet!&lt;/p&gt;&lt;/li&gt;
      ) : (
        todos.map(<span class="hljs-attr">todo</span> =&gt; (
          &lt;li 
            <span class="hljs-attr">key</span>={todo.id} 
            <span class="hljs-attr">className</span>={todo.completed ? <span class="hljs-string">'completed'</span> : <span class="hljs-string">''</span>}
          &gt;
            &lt;label&gt;
              &lt;input 
                <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> 
                <span class="hljs-attr">checked</span>={todo.completed}
                <span class="hljs-attr">onChange</span>={() =&gt; <span class="hljs-literal">on</span>Toggle(todo.id)}
              /&gt;
              &lt;span&gt;{todo.text}&lt;/span&gt;
            &lt;/label&gt;
            &lt;button <span class="hljs-attr">onClick</span>={() =&gt; <span class="hljs-literal">on</span>Delete(todo.id)}&gt;×&lt;/button&gt;
          &lt;/li&gt;
        ))
      )}
    &lt;/ul&gt;
  )
}

export default TodoList
</code></pre>
<h3 data-id="heading-11">🔍 删除逻辑深度解析</h3>
<h4 data-id="heading-12">1. <code>filter</code> 如何实现“删除”？</h4>
<ul>
<li><code>filter</code> 返回新数组，保留 <code>todo.id !== id</code> 的项。</li>
<li>目标项因 <code>id</code> 相等被过滤掉 → 间接实现删除。</li>
<li>符合 React <strong>不可变更新</strong>原则。</li>
</ul>
<h4 data-id="heading-13">2. 为什么依赖 <code>id</code> 的唯一性？</h4>
<ul>
<li><code>id: Date.now()</code> <strong>仅在创建时执行一次</strong>，作为该 todo 的永久标识。</li>
<li>删除时传递的是<strong>原始 id</strong>，不是当前时间戳。</li>
<li>因此 <code>todo.id !== id</code> 能精准匹配唯一目标。</li>
</ul>
<blockquote>
<p>⚠️ <strong>风险</strong>：若多个 todo 共享相同 id，会导致误删。生产环境建议用 <code>uuid</code>。</p>
</blockquote>
<h4 data-id="heading-14">3. “唯一 id” 与 “id 不同” 是否矛盾？</h4>
<p><strong>不矛盾！</strong></p>
<ul>
<li><strong>唯一 id</strong>：确保每个 todo 有唯一身份（目标项只有一个）。</li>
<li><strong>id ≠ 目标 id</strong>：是 <code>filter</code> 的筛选条件（保留非目标项）。</li>
</ul>
<blockquote>
<p>🧩 类比：从 [小明(id=1), 小红(id=2)] 中删除小红 → 筛选“id ≠ 2” → 结果：[小明]</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">📊 子组件 3：<code>TodoStats</code> —— 显示统计 &amp; 清除操作</h2>
<pre><code class="hljs language-javascript" lang="javascript">jsx
编辑
<span class="hljs-keyword">const</span> <span class="hljs-title function_">TodoStats</span> = (<span class="hljs-params">{ total, active, completed, onClearCompleted }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-stats"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Total: {total} | Active: {active} | Completed: {completed}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      {completed &gt; 0 &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClearCompleted}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"clear-btn"</span>&gt;</span>
          Clear Completed
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">TodoStats</span>
</code></pre>
<blockquote>
<p>✅ 条件渲染提升用户体验。</p>
</blockquote>
<hr/>
<h2 data-id="heading-16">🔁 组件通信机制总结</h2>





















<table><thead><tr><th>通信方向</th><th>实现方式</th></tr></thead><tbody><tr><td>父 → 子</td><td><code>props</code> 传递数据</td></tr><tr><td>子 → 父</td><td><code>props</code> 传递回调函数</td></tr><tr><td>兄弟组件</td><td>通过父组件状态中转</td></tr></tbody></table>
<blockquote>
<p>核心：<strong>数据自上而下，事件自下而上</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-17">🧪 注意事项与最佳实践</h2>
<ol>
<li><strong>状态不可变性</strong>：始终返回新数组/对象。</li>
<li><strong>ID 生成可靠性</strong>：高频场景用 <code>uuid</code> 替代 <code>Date.now()</code>。</li>
<li><strong>表单防空提交</strong>：<code>disabled={!inputValue.trim()}</code></li>
<li><strong>性能优化</strong>：<code>React.memo</code> + <code>useCallback</code>（按需）</li>
</ol>
<hr/>
<h2 data-id="heading-18">🔍 拓展思考：状态管理方案对比</h2>

























<table><thead><tr><th>方案</th><th>适用场景</th><th>优缺点</th></tr></thead><tbody><tr><td><strong>状态提升</strong></td><td>小型应用</td><td>✅ 简单；❌ 状态集中</td></tr><tr><td><strong>Context</strong></td><td>跨多层组件</td><td>✅ 避免 props drilling；❌ 更新粒度粗</td></tr><tr><td><strong>Zustand/Redux</strong></td><td>大型应用</td><td>✅ 强大；❌ 成本高</td></tr></tbody></table>
<blockquote>
<p>✅ Todo 应用：状态提升 + localStorage 最佳。</p>
</blockquote>
<hr/>
<h2 data-id="heading-19">✅ 总结要点</h2>
<ul>
<li>✅ <strong>本地存储 = 初始化读取 + 变化时写入</strong>，缺一不可。</li>
<li>✅ <strong><code>e.preventDefault()</code></strong>  仅用于阻止浏览器默认行为（如表单刷新）。</li>
<li>✅ <strong>受控组件</strong> 是 <code>setInputValue('')</code> 清空输入框的根本原因。</li>
<li>✅ <strong><code>filter</code> 删除</strong> 依赖 <strong>唯一且不变的 ID</strong>，本质是“保留非目标项”。</li>
<li>✅ <strong>子组件不能直接修改状态</strong>，只能通过回调“提交请求”，父组件统一处理。</li>
<li>✅ <strong>父组件持有状态</strong> 是实现状态共享与持久化的简洁载体，但核心是<strong>完整的持久化闭环</strong>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 效率暴增！Vue.js开发必知的15个神级提效工具]]></title>    <link>https://juejin.cn/post/7587252766830854186</link>    <guid>https://juejin.cn/post/7587252766830854186</guid>    <pubDate>2025-12-24T09:34:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587252766830854186" data-draft-id="7587238733503676459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 效率暴增！Vue.js开发必知的15个神级提效工具"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-24T09:34:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_chiu"/> <meta itemprop="url" content="https://juejin.cn/user/1644525124592974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 效率暴增！Vue.js开发必知的15个神级提效工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1644525124592974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_chiu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:34:50.000Z" title="Wed Dec 24 2025 09:34:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>告别996，从善用工具开始</p>
</blockquote>
<h2 data-id="heading-0">开篇：那些年我们浪费的时间</h2>
<p>作为一名有五年经验的Vue工程师，我曾无数次在重复劳动中挣扎：手动复制相似的组件代码、在浏览器和编辑器之间反复切换调试、为项目初始化配置花费半天时间……直到我开始系统性地收集和整合提效工具，我的开发效率才有了质的飞跃。</p>
<p>今天，我分享的这些工具，是我从无数工具中筛选出的精华，每个都在我的日常Vue开发工作中扮演着重要角色。</p>
<h2 data-id="heading-1">一、脚手架与项目启动工具</h2>
<h3 data-id="heading-2">1. <strong>Plop.js + Vue模板 - 代码生成器中的瑞士军刀</strong></h3>
<p>Plop.js 是我Vue项目中的标配。它基于模板快速生成组件、页面或模块，确保团队代码一致性。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// plopfile.js 配置示例 - Vue版本</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">plop</span>) {
  plop.<span class="hljs-title function_">setGenerator</span>(<span class="hljs-string">'component'</span>, {
    <span class="hljs-attr">description</span>: <span class="hljs-string">'创建一个Vue组件'</span>,
    <span class="hljs-attr">prompts</span>: [{
      <span class="hljs-attr">type</span>: <span class="hljs-string">'input'</span>,
      <span class="hljs-attr">name</span>: <span class="hljs-string">'name'</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'组件名称（使用大驼峰命名）:'</span>
    }],
    <span class="hljs-attr">actions</span>: [{
      <span class="hljs-attr">type</span>: <span class="hljs-string">'add'</span>,
      <span class="hljs-attr">path</span>: <span class="hljs-string">'src/components/{{properCase name}}/{{properCase name}}.vue'</span>,
      <span class="hljs-attr">templateFile</span>: <span class="hljs-string">'templates/component.hbs'</span>
    }, {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'add'</span>,
      <span class="hljs-attr">path</span>: <span class="hljs-string">'src/components/{{properCase name}}/index.js'</span>,
      <span class="hljs-attr">templateFile</span>: <span class="hljs-string">'templates/index.hbs'</span>
    }]
  });
};

<span class="hljs-comment">// component.hbs 模板示例</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"{{kebabCase name}}"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 组件内容 --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-title function_">defineProps</span>({
  <span class="hljs-comment">// props定义</span>
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
.{{kebabCase name}} {
  <span class="hljs-comment">/* 样式 */</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<p><strong>技术要点</strong>：Plop使用Handlebars模板引擎，结合Inquirer.js实现交互式生成。我们可以为不同类型的Vue组件（如组件、页面、组合式函数）预设不同的模板。</p>
<h3 data-id="heading-3">2. <strong>Vite + Vue 3 - 新一代Vue构建体验</strong></h3>
<p>Vite的闪电般的热更新速度，让Vue开发体验达到了新高度：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建Vue项目</span>
npm create vue@latest my-vue-app

<span class="hljs-comment"># 选择需要的特性</span>
<span class="hljs-comment"># √ 是否使用 TypeScript? Yes</span>
<span class="hljs-comment"># √ 是否启用 JSX 支持? Yes  </span>
<span class="hljs-comment"># √ 是否添加 Vue Router? Yes</span>
<span class="hljs-comment"># √ 是否添加 Pinia? Yes</span>
<span class="hljs-comment"># √ 是否添加 Vitest? Yes</span>

<span class="hljs-comment"># 开发模式启动（毫秒级）</span>
npm run dev
</code></pre>
<p><strong>深度优化技巧</strong>：通过配置<code>vite.config.js</code>中的<code>vue</code>插件选项，开启响应式语法糖和性能优化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>({
      <span class="hljs-attr">reactivityTransform</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用响应式语法糖</span>
      <span class="hljs-attr">template</span>: {
        <span class="hljs-attr">compilerOptions</span>: {
          <span class="hljs-comment">// 自定义编译器选项</span>
        }
      }
    })
  ]
})
</code></pre>
<h2 data-id="heading-4">二、开发与调试利器</h2>
<h3 data-id="heading-5">3. <strong>Vue.js devtools 6.0 - Vue开发者的超级武器</strong></h3>
<p>Vue.js devtools是Vue开发者不可或缺的调试工具，新版支持Vue 3和组合式API：</p>
<p><strong>核心功能</strong>：</p>
<ul>
<li><strong>组件树</strong>：可视化查看组件层级和状态</li>
<li><strong>时间旅行</strong>：跟踪状态变化并回退到任意状态</li>
<li><strong>组合式函数调试</strong>：监控<code>ref</code>、<code>reactive</code>、<code>computed</code>等响应式数据</li>
<li><strong>路由调试</strong>：Vue Router的状态和导航历史</li>
<li><strong>Pinia集成</strong>：直接查看和修改Pinia store状态</li>
</ul>
<p><strong>高级技巧</strong>：</p>
<ul>
<li>使用"Open in editor"功能快速定位组件源码</li>
<li>通过时间轴功能分析组件更新性能</li>
<li>自定义面板扩展，如VueUse状态监控</li>
</ul>
<h3 data-id="heading-6">4. <strong>Volar + TypeScript - 智能Vue开发体验</strong></h3>
<p>Volar是Vue 3官方推荐的VSCode插件，提供极致的TypeScript支持：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 完整的TypeScript智能提示</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 类型推断和自动补全</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>) <span class="hljs-comment">// 类型为Ref&lt;number&gt;</span>

<span class="hljs-comment">// Props类型检查</span>
defineProps&lt;{
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>
  value?: <span class="hljs-built_in">number</span>
}&gt;()

<span class="hljs-comment">// 事件类型定义</span>
<span class="hljs-keyword">const</span> emit = defineEmits&lt;{
  (<span class="hljs-attr">e</span>: <span class="hljs-string">'update'</span>, <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span>
  (<span class="hljs-attr">e</span>: <span class="hljs-string">'change'</span>, <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span>
}&gt;()
&lt;/script&gt;
</code></pre>
<p><strong>配置优化</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// .vscode/settings.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"volar.tsPlugin"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"volar.completion.preferredTagNameCase"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pascal"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"volar.autoCompleteRefs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"volar.codeLens.scriptSetupTools"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-7">三、代码质量与自动化</h2>
<h3 data-id="heading-8">5. <strong>Vue ESLint插件 + lint-staged - Vue代码质量卫士</strong></h3>
<p>针对Vue的专门化代码检查：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// .eslintrc.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">extends</span>: [
    <span class="hljs-string">'plugin:vue/vue3-recommended'</span>,
    <span class="hljs-string">'@vue/typescript/recommended'</span>
  ],
  <span class="hljs-attr">rules</span>: {
    <span class="hljs-string">'vue/multi-word-component-names'</span>: <span class="hljs-string">'off'</span>,
    <span class="hljs-string">'vue/no-v-html'</span>: <span class="hljs-string">'warn'</span>,
    <span class="hljs-string">'vue/component-tags-order'</span>: [<span class="hljs-string">'error'</span>, {
      <span class="hljs-attr">order</span>: [<span class="hljs-string">'script'</span>, <span class="hljs-string">'template'</span>, <span class="hljs-string">'style'</span>]
    }]
  }
}

<span class="hljs-comment">// 结合Husky和lint-staged</span>
{
  <span class="hljs-string">"husky"</span>: {
    <span class="hljs-string">"hooks"</span>: {
      <span class="hljs-string">"pre-commit"</span>: <span class="hljs-string">"lint-staged"</span>,
      <span class="hljs-string">"commit-msg"</span>: <span class="hljs-string">"commitlint -E HUSKY_GIT_PARAMS"</span>
    }
  },
  <span class="hljs-string">"lint-staged"</span>: {
    <span class="hljs-string">"*.{vue,js,jsx,ts,tsx}"</span>: [
      <span class="hljs-string">"eslint --fix"</span>,
      <span class="hljs-string">"prettier --write"</span>
    ]
  }
}
</code></pre>
<h3 data-id="heading-9">6. <strong>Vue Test Utils + Vitest - 现代化Vue测试方案</strong></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Component.test.ts</span>
<span class="hljs-keyword">import</span> { mount } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/test-utils'</span>
<span class="hljs-keyword">import</span> { describe, it, expect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitest'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Counter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Counter.vue'</span>

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'Counter.vue'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'renders correctly'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">Counter</span>, {
      <span class="hljs-attr">props</span>: { <span class="hljs-attr">initialValue</span>: <span class="hljs-number">5</span> }
    })
    
    <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'5'</span>)
    <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">find</span>(<span class="hljs-string">'button'</span>).<span class="hljs-title function_">exists</span>()).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>)
  })
  
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'increments count on button click'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">Counter</span>)
    <span class="hljs-keyword">await</span> wrapper.<span class="hljs-title function_">find</span>(<span class="hljs-string">'button'</span>).<span class="hljs-title function_">trigger</span>(<span class="hljs-string">'click'</span>)
    <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'1'</span>)
  })
})
</code></pre>
<h2 data-id="heading-10">四、API与数据模拟</h2>
<h3 data-id="heading-11">7. <strong>Mirage JS - Vue应用的全功能API模拟</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在Vue应用中配置Mirage</span>
<span class="hljs-keyword">import</span> { createServer } <span class="hljs-keyword">from</span> <span class="hljs-string">'miragejs'</span>

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">DEV</span>) {
  <span class="hljs-title function_">createServer</span>({
    <span class="hljs-title function_">routes</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">namespace</span> = <span class="hljs-string">'api'</span>
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">return</span> [
          { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'用户1'</span> },
          { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'用户2'</span> }
        ]
      })
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/users'</span>, <span class="hljs-function">(<span class="hljs-params">schema, request</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> attrs = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(request.<span class="hljs-property">requestBody</span>)
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, ...attrs }
      })
    }
  })
}
</code></pre>
<h2 data-id="heading-12">五、视觉与设计协作</h2>
<h3 data-id="heading-13">8. <strong>Vue Figma插件 + Vue Design System</strong></h3>
<p>对于设计稿转Vue代码的完整方案：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用Vue Design System</span>
<span class="hljs-keyword">import</span> { defineComponent, h } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { 
  <span class="hljs-title class_">VButton</span>, 
  <span class="hljs-title class_">VInput</span>, 
  <span class="hljs-title class_">VCard</span>,
  tokens 
} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-design-system'</span>

<span class="hljs-comment">// 从Figma插件导出的设计Token</span>
<span class="hljs-keyword">const</span> figmaTokens = {
  <span class="hljs-attr">colors</span>: {
    <span class="hljs-attr">primary</span>: <span class="hljs-string">'#007AFF'</span>,
    <span class="hljs-attr">secondary</span>: <span class="hljs-string">'#5856D6'</span>
  },
  <span class="hljs-attr">spacing</span>: {
    <span class="hljs-attr">xs</span>: <span class="hljs-string">'4px'</span>,
    <span class="hljs-attr">sm</span>: <span class="hljs-string">'8px'</span>,
    <span class="hljs-attr">md</span>: <span class="hljs-string">'16px'</span>
  }
}

<span class="hljs-comment">// 自动生成Vue组件配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> designSystem = {
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">VButton</span>,
    <span class="hljs-title class_">VInput</span>,
    <span class="hljs-title class_">VCard</span>
  },
  <span class="hljs-attr">tokens</span>: { ...tokens, ...figmaTokens }
}
</code></pre>
<h2 data-id="heading-14">六、文档与组件管理</h2>
<h3 data-id="heading-15">9. <strong>VitePress + Vue Demoblock - 组件文档自动化</strong></h3>
<p>基于VitePress的Vue组件文档方案：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
<span class="hljs-section">title: Button组件
---</span>

<span class="hljs-section"># Button</span>

通用的按钮组件

<span class="hljs-section">## 基础用法</span>

:::demo
<span class="hljs-code">```vue
&lt;template&gt;
  &lt;v-button type="primary"&gt;主要按钮&lt;/v-button&gt;
&lt;/template&gt;
</span></code></pre>
<p>:::</p>
<h2 data-id="heading-16">API</h2>

```
<p><strong>自动化脚本</strong>：自动从Vue组件中提取Props、Events、Slots信息生成API文档。</p>
<h2 data-id="heading-17">七、终端与工作流优化</h2>
<h3 data-id="heading-18">10. <strong>Vue CLI插件开发 - 自定义项目生成器</strong></h3>
<p>创建自己的Vue项目模板和生成器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// generator.js - 自定义Vue CLI插件</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">api, options</span>) =&gt;</span> {
  api.<span class="hljs-title function_">render</span>(<span class="hljs-string">'./template'</span>)
  
  api.<span class="hljs-title function_">extendPackage</span>({
    <span class="hljs-attr">dependencies</span>: {
      <span class="hljs-string">'pinia'</span>: <span class="hljs-string">'^2.0.0'</span>,
      <span class="hljs-string">'vue-router'</span>: <span class="hljs-string">'^4.0.0'</span>
    },
    <span class="hljs-attr">scripts</span>: {
      <span class="hljs-string">'analyze'</span>: <span class="hljs-string">'vue-cli-service build --report'</span>
    }
  })
  
  api.<span class="hljs-title function_">injectImports</span>(api.<span class="hljs-property">entryFile</span>, <span class="hljs-string">`import router from './router'`</span>)
  api.<span class="hljs-title function_">afterInvoke</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 生成后处理逻辑</span>
  })
}
</code></pre>
<h3 data-id="heading-19">11. <strong>VueUse - 组合式函数工具集</strong></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用VueUse提升开发效率</span>
<span class="hljs-keyword">import</span> { 
  useMouse, 
  useLocalStorage, 
  useFetch,
  useDebounceFn
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@vueuse/core'</span>

<span class="hljs-comment">// 在组合式函数中使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useUserData</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 自动持久化的状态</span>
  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useLocalStorage</span>(<span class="hljs-string">'user'</span>, <span class="hljs-literal">null</span>)
  
  <span class="hljs-comment">// 防抖请求</span>
  <span class="hljs-keyword">const</span> { data, error } = <span class="hljs-title function_">useFetch</span>(<span class="hljs-string">'/api/user'</span>)
    .<span class="hljs-title function_">debounced</span>(<span class="hljs-number">300</span>)
  
  <span class="hljs-keyword">return</span> { user, data, error }
}
</code></pre>
<h2 data-id="heading-20">八、浏览器扩展宝藏</h2>
<h3 data-id="heading-21">12. <strong>Vue.js devtools 6.0（浏览器扩展）</strong></h3>
<p>前面提到的Vue devtools的浏览器扩展版本，支持Chrome、Firefox、Edge等主流浏览器。</p>
<h3 data-id="heading-22">13. <strong>Vue Meta调试器 - SEO和管理工具</strong></h3>
<p>对于使用Vue Meta的应用，这款扩展可以实时查看和修改页面元信息。</p>
<h2 data-id="heading-23">九、高级代码搜索与导航</h2>
<h3 data-id="heading-24">14. <strong>Vue Language Tools + TypeScript - 智能代码导航</strong></h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// tsconfig.json 优化配置</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"vueCompilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"@vue/language-plugin-pug"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"experimentalRuntimeMode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"runtime-agnostic"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"experimentalTemplateCompilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"isCustomElement"</span><span class="hljs-punctuation">:</span> tag =&gt; tag.startsWith('x-')
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-25">15. <strong>StackBlitz Vue项目 - 云端Vue开发环境</strong></h3>
<p>直接在浏览器中运行的完整Vue开发环境：</p>
<ul>
<li>支持Vite + Vue 3 + TypeScript</li>
<li>GitHub实时同步</li>
<li>实时协作功能</li>
<li>自定义模板分享</li>
</ul>
<h2 data-id="heading-26">十、性能分析与优化</h2>
<h3 data-id="heading-27">16. <strong>Vue Performance Devtool - 组件性能分析</strong></h3>
<p>专门针对Vue应用的性能分析工具：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 安装和使用</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { createPerformanceMonitor } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-performance-devtool'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">DEV</span>) {
  <span class="hljs-keyword">const</span> monitor = <span class="hljs-title function_">createPerformanceMonitor</span>(app, {
    <span class="hljs-attr">maxComponents</span>: <span class="hljs-number">50</span>,
    <span class="hljs-attr">trackHooks</span>: <span class="hljs-literal">true</span>
  })
  monitor.<span class="hljs-title function_">start</span>()
}
</code></pre>
<h2 data-id="heading-28">十一、状态管理增强</h2>
<h3 data-id="heading-29">17. <strong>Pinia + Pinia Plugin - 现代化状态管理</strong></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用Pinia插件增强开发体验</span>
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { createPersistedState } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia-plugin-persistedstate'</span>

<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>()
pinia.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">createPersistedState</span>({
  <span class="hljs-attr">storage</span>: <span class="hljs-variable language_">localStorage</span>,
  <span class="hljs-attr">serializer</span>: {
    <span class="hljs-attr">serialize</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-property">stringify</span>,
    <span class="hljs-attr">deserialize</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-property">parse</span>
  }
}))

<span class="hljs-comment">// 自动生成TypeScript类型</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>
  }),
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-attr">displayName</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">name</span> || <span class="hljs-string">'匿名用户'</span>
  },
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 异步操作</span>
    }
  }
})
</code></pre>
<h2 data-id="heading-30">我的Vue工具化开发哲学</h2>
<p>工具选择的核心原则：</p>
<ol>
<li><strong>Vue生态优先</strong> - 优先选择专门为Vue优化的工具</li>
<li><strong>组合式API兼容</strong> - 确保工具支持Vue 3组合式API</li>
<li><strong>TypeScript友好</strong> - 完整的类型支持是必备条件</li>
<li><strong>开发体验至上</strong> - 热更新速度、智能提示质量是关键</li>
</ol>
<h2 data-id="heading-31">实战：搭建Vue提效系统</h2>
<p>我建议的逐步实施计划：</p>
<p><strong>第一周</strong>：配置Volar + TypeScript + Vue ESLint，建立开发基础<br/>
<strong>第二周</strong>：集成Pinia + Vue Router，搭建状态管理和路由<br/>
<strong>第三周</strong>：配置Vitest + Vue Test Utils，建立测试体系<br/>
<strong>第四周</strong>：引入VitePress + 组件自动化文档<br/>
<strong>第五周</strong>：根据团队需求定制代码生成器和工作流</p>
<h2 data-id="heading-32">结语：Vue工具链的进化</h2>
<p>从Vue 2到Vue 3，Vue的工具生态经历了革命性的变化。现代Vue开发不再是简单的模板编写，而是一个完整的工程化体系。掌握这些工具，不仅能提升开发效率，更能深入理解Vue的设计哲学和最佳实践。</p>
<p>真正的高级Vue工程师，不仅要会写组件，更要懂得如何利用工具链构建可维护、高性能、团队友好的Vue应用。</p>
<hr/>
<p><strong>互动话题</strong>：你在Vue开发中有哪些私藏的提效工具？欢迎在评论区分享交流！如果这篇文章对你有帮助，请点赞收藏，后续我会分享更多Vue 3工程化实践和性能优化技巧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[后台服务Service销毁逻辑+单例造成的内存泄露]]></title>    <link>https://juejin.cn/post/7586983243926863910</link>    <guid>https://juejin.cn/post/7586983243926863910</guid>    <pubDate>2025-12-24T08:41:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586983243926863910" data-draft-id="7587020682011377691" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="后台服务Service销毁逻辑+单例造成的内存泄露"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T08:41:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GoldenPlayer"/> <meta itemprop="url" content="https://juejin.cn/user/2999123453948119"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            后台服务Service销毁逻辑+单例造成的内存泄露
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123453948119/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GoldenPlayer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T08:41:55.000Z" title="Wed Dec 24 2025 08:41:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这份总结完全基于你的 <code>GlobalTaskService</code> 和 <code>AirIMEngine</code> 的现场问题。我们将这个问题拆解为三个核心维度：<strong>保活机制失效</strong>、<strong>单例内存泄露</strong>、<strong>Android 14 合规陷阱</strong>。</p>
<p>你可以把这份总结作为后续开发后台类应用的技术备忘录。</p>
<hr/>
<h3 data-id="heading-0">一、 现场还原：为什么“息屏即死，亮屏诈尸”？</h3>
<p><strong>现象描述：</strong>
你观察到 <code>GlobalTaskService</code> 在息屏时打印 <code>onDestroy</code>，亮屏时打印 <code>onCreate</code>。特别是当 IM 连接建立（持有 Socket）后，这种现象更频繁。</p>
<p><strong>核心原因：这也是 Android 系统的“杀手”逻辑</strong></p>
<ol>
<li><strong>伪后台服务</strong>：你的代码中 <code>startForeground</code> 被注释掉了。对系统而言，这是一个普通的后台 Service。</li>
<li><strong>省电策略 (Doze Mode)</strong>：当屏幕关闭，系统进入打盹模式。系统检测到你的 App 在后台跑着，还持有一个高耗电的 Socket 连接（IM），但用户界面上没有任何通知（Notification）显示你在运行。</li>
<li><strong>系统判定</strong>：“这个 App 在偷偷摸摸耗电，杀掉它。” -&gt; 触发 <code>onDestroy</code>。</li>
<li><strong>诈尸重启</strong>：因为你在 <code>onStartCommand</code> 返回了 <code>START_STICKY</code>。当亮屏系统资源宽裕时，系统会尝试重建服务 -&gt; 触发 <code>onCreate</code>。</li>
</ol>
<p><strong>结论</strong>：不调用 <code>startForeground</code>，Service 在现代 Android 系统中就像“无证驾驶”，随时会被交警（系统）扣车。</p>
<hr/>
<h3 data-id="heading-1">二、 隐形杀手：Lambda 导致的内存泄露</h3>
<p><strong>现象描述：</strong>
虽然 Service 被销毁重建了，但旧的 Service 尸体并没有从内存中清除。</p>
<p><strong>代码现场：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// GlobalTaskService.onCreate</span>
AirIMEngine.addMsgObserver { msg, sender -&gt; 
    <span class="hljs-comment">// 这个 Lambda 内部隐式持有了 Service 的引用 (this)</span>
    dispatchMsgScene(...) 
}
</code></pre>
<p><strong>泄露逻辑闭环：</strong></p>
<ol>
<li><strong>谁活着？</strong> <code>AirIMEngine</code> 是 <code>object</code> (单例)，它的生命周期 = App 进程的生命周期（它永远活着）。</li>
<li><strong>谁被抓住了？</strong> 当你注册 Lambda 时，<code>AirIMEngine</code> 里的列表（或变量）就引用了这个 Lambda。而 Lambda 为了能调用 <code>dispatchMsgScene</code>，必须持有 <code>GlobalTaskService</code> 的实例。</li>
<li><strong>悲剧发生：</strong>
<ul>
<li>第一次 Service 启动 -&gt; <code>AirIMEngine</code> 抓住 <code>Service_V1</code>。</li>
<li>息屏，系统杀掉 Service -&gt; <code>Service_V1</code> 走 <code>onDestroy</code>。<strong>但在内存中，因为 <code>AirIMEngine</code> 还抓着它，它无法被回收（GC）。</strong></li>
<li>亮屏，Service 重启 -&gt; 创建 <code>Service_V2</code>。</li>
<li><code>Service_V2</code> 再次向 <code>AirIMEngine</code> 注册。</li>
</ul>
</li>
<li><strong>结果</strong>：内存里同时存在 <code>Service_V1</code> (僵尸) 和 <code>Service_V2</code> (活体)。如果不改，在这个 App 的生命周期内，僵尸会越堆越多。</li>
</ol>
<p><strong>解决方案的核心</strong>：
从 Lambda 改为 <strong>接口 (<code>interface</code>)</strong>。因为接口允许我们明确地传入 <code>this</code>，也允许我们在 <code>onDestroy</code> 中明确地调用 <code>removeListener(this)</code>，打断单例对 Service 的引用链。</p>
<hr/>
<h3 data-id="heading-2">三、 合规陷阱：Android 14 的“类型”强校验</h3>
<p><strong>潜在风险：</strong>
你的 Manifest 声明了 <code>foregroundServiceType="phoneCall"</code>，这在 Android 14+ 是高危操作。</p>
<p><strong>逻辑冲突：</strong></p>
<ol>
<li><strong>场景 A（待机）</strong>：App 启动，IM 连接中，但没打电话。
<ul>
<li>系统检查：你启动了前台服务，声明是 <code>phoneCall</code>。</li>
<li>系统质问：你现在的 <code>TelecomManager</code> 里有通话会话吗？</li>
<li>回答：没有。</li>
<li><strong>结果</strong>：抛出 <code>ForegroundServiceStartNotAllowedException</code> 或直接 Crash。</li>
</ul>
</li>
<li><strong>场景 B（通话）</strong>：App 真的在自动拨打电话。
<ul>
<li>此时用 <code>phoneCall</code> 才是合法的。</li>
</ul>
</li>
</ol>
<p><strong>解决方案</strong>：
采用 <strong>“双模切换”</strong> 策略。</p>
<ul>
<li><strong>待机模式</strong>：使用 <code>dataSync</code> 类型（数据同步），告诉系统我在维持 IM 连接，这是合法的后台行为。</li>
<li><strong>通话模式</strong>：检测到拨号指令后，动态更新 Notification，将类型切换为 <code>phoneCall</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-3">四、 总结架构图（技术复盘）</h3>
<p>这是我们最终修复后的架构逻辑，你可以对照代码理解：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[GlobalTaskService 启动] --&gt; B(onCreate);
    
    B --&gt; C{修复点1: 立即启动前台服务};
    C --&gt;|待机状态| D[startForeground type=DATA_SYNC];
    D -- 说明 --&gt; E[系统不再杀后台, 允许持有Socket];
    
    B --&gt; F{修复点2: 注册IM监听};
    F --&gt;|AirIMEngine.addListener this | G[AirIMEngine (单例)];
    G -- 关键 --&gt; H[使用 WeakReference 或 明确的 Remove];
    
    I[收到拨号指令] --&gt; J{修复点3: 动态切换类型};
    J --&gt; K[更新 Notification type=PHONE_CALL];
    K -- 说明 --&gt; L[Android 14 允许使用通话API];
    
    M[GlobalTaskService 销毁] --&gt; N(onDestroy);
    N --&gt; O[AirIMEngine.removeListener this];
    O -- 结果 --&gt; P[断开引用链, Service内存成功回收];
    N --&gt; Q[stopForeground];
</code></pre>
<h3 data-id="heading-4">核心心法（记忆口诀）</h3>
<ol>
<li><strong>要保活，必前台</strong>：没有 Notification 的 Service 在息屏时就是系统的“猎物”。</li>
<li><strong>用单例，必有借有还</strong>：在 <code>onCreate</code> 里 <code>add</code> 进单例的东西，必须在 <code>onDestroy</code> 里 <code>remove</code> 掉，否则就是内存泄露。</li>
<li><strong>Android 14，类型要对版</strong>：干什么事挂什么牌（Type），没打电话别挂“正在通话”的牌子，会被系统封杀。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自定义APK&gradle全局配置文件]]></title>    <link>https://juejin.cn/post/7587239837972299827</link>    <guid>https://juejin.cn/post/7587239837972299827</guid>    <pubDate>2025-12-24T09:36:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587239837972299827" data-draft-id="7587074669817315354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自定义APK&amp;gradle全局配置文件"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T09:36:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GoldenPlayer"/> <meta itemprop="url" content="https://juejin.cn/user/2999123453948119"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自定义APK&amp;gradle全局配置文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123453948119/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GoldenPlayer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:36:19.000Z" title="Wed Dec 24 2025 09:36:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>非常理解你的感受！Gradle 的 Groovy 语法确实也是很多 Android 开发者的“噩梦”。它属于一种<strong>动态语言 DSL (领域特定语言)</strong>，写起来灵活但读起来晦涩，而且 IDE 的代码提示往往也不太好用。</p>
<p>这也是为什么现在 Google 正在大力推行 <strong>KTS (Kotlin DSL)</strong> 的原因（用 Kotlin 写 Gradle 脚本，有类型检查和自动补全）。</p>
<p>下面我针对你提出的两个问题，用“说人话”的方式拆解一下它们的原理。</p>
<hr/>
<h3 data-id="heading-0">第一个话题：自定义 APK 名称</h3>
<p>这段代码看起来复杂，其实它是 Android Gradle Plugin (AGP) 提供的一套<strong>遍历逻辑</strong>。</p>
<pre><code class="hljs language-groovy" lang="groovy">applicationVariants.all { variant -&gt;
    // ...
}
</code></pre>
<h4 data-id="heading-1">原理解析：</h4>
<ol>
<li>
<p><strong><code>applicationVariants</code></strong>：
这是 Android 插件提供的一个集合，里面装着你所有的“变体”。</p>
<ul>
<li>什么是变体？就是 <code>BuildType</code> (Debug/Release) 和 <code>Flavor</code> (渠道包) 组合后的产物。比如：<code>debug</code>, <code>release</code>, <code>demoDebug</code>, <code>fullRelease</code> 等。</li>
</ul>
</li>
<li>
<p><strong><code>.all { variant -&gt; ... }</code></strong>：
这是 Groovy 的语法，相当于 Java 的 <code>forEach</code> 循环。它在说：“<strong>对于每一个生成的变体，都执行下面的代码</strong>”。</p>
</li>
<li>
<p><strong><code>variant.outputs.all { ... }</code></strong>：
每个变体最终可能会输出多个文件（虽然绝大多数情况我们只输出一个 APK，但 Android 支持根据 CPU 架构或屏幕密度拆分输出多个 APK）。
为了保险起见，这里又做了一层循环：“<strong>对于这个变体下的每一个输出文件...</strong>”。</p>
</li>
<li>
<p><strong><code>outputFileName = "..."</code></strong>：
这就是最终的目的。修改这个输出文件的文件名属性。</p>
</li>
</ol>
<h4 data-id="heading-2">为什么这么写？</h4>
<p>因为 Gradle 在构建过程中，APK 的名称是在构建的中途生成的。你不能直接写 <code>outputFileName = "xxx"</code>，必须挂载到 <code>variant</code> 的处理流程中，等 Gradle 算出当前是哪个变体后，你才有机会去修改它的名字。</p>
<p><strong>总结就是：</strong></p>
<blockquote>
<p>“Gradle，请监听构建过程。每当你准备好一个变体（比如 Release 版），就去把那个变体即将生成的 APK 改个名字，名字格式我定。”</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">第二个话题：统一版本管理 (config.gradle)</h3>
<p>你的理解基本是正确的，但有一点点偏差，我来帮你理清“它是怎么传导的”。</p>
<h4 data-id="heading-4">1. 为什么 <code>config.gradle</code> 能被引用？</h4>
<p>在 <code>build.gradle</code> (Root) 中：</p>
<pre><code class="hljs language-groovy" lang="groovy">apply from: 'config.gradle'
</code></pre>
<p>这句话的意思是：<strong>把 <code>config.gradle</code> 里的代码，原封不动地拿过来，在这个位置执行一遍。</strong></p>
<p><em>注意：你提到你把它放在了 <code>buildscript { ... }</code> 里面。通常的做法是直接放在文件的最外层。如果放在 <code>buildscript</code> 里还能生效，可能是因为 Groovy 的作用域穿透或者 Gradle 版本的特性，但<strong>标准做法是放在根目录 build.gradle 的第一行或 buildscript 闭包之后</strong>。</em></p>
<h4 data-id="heading-5">2. <code>ext { ... }</code> 是什么？</h4>
<p><code>ext</code> 是 Gradle 的一个特殊属性，全称叫 <strong>ExtraPropertiesExtension</strong>。你可以把它想象成一个 <strong>Map (键值对字典)</strong>。
所有的 Gradle 对象（Project, Task 等）都有这个 <code>ext</code>。</p>
<p>当你在 <code>config.gradle</code> 里写：</p>
<pre><code class="hljs language-groovy" lang="groovy">ext {
    versionCode = 123
}
</code></pre>
<p>因为这个脚本是应用在 <strong>Root Project</strong> 上的，所以相当于给 <strong>根工程对象</strong> 挂载了一个全局变量 <code>rootProject.ext.versionCode = 123</code>。</p>
<h4 data-id="heading-6">3. <code>rootProject.versionCode</code> 原理</h4>
<p>在你的 App Module (<code>app/build.gradle</code>) 中：</p>
<pre><code class="hljs language-groovy" lang="groovy">versionCode rootProject.versionCode
</code></pre>
<p>这里的逻辑链条是这样的：</p>
<ol>
<li><strong><code>rootProject</code></strong>：指代你的根工程对象（就是最外层的那个）。</li>
<li><strong><code>.versionCode</code></strong>：在 Java/Kotlin 中，并没有 <code>versionCode</code> 这个字段。但是 Groovy 是动态语言，当它在 <code>rootProject</code> 对象里找不到 <code>versionCode</code> 属性时，它会<strong>自动去 <code>ext</code> 里面找</strong>。
<ul>
<li>所以 <code>rootProject.versionCode</code> 其实是 <code>rootProject.ext.versionCode</code> 的缩写（语法糖）。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-7">回答你的疑问：</h4>
<blockquote>
<p>这里 rootProject 就代表 config.gradle 的 ext { 了是吗？</p>
</blockquote>
<p><strong>不完全是，但效果一样。</strong></p>
<ul>
<li><code>rootProject</code> 代表<strong>根工程对象</strong>。</li>
<li><code>config.gradle</code> 里的内容通过 <code>apply from</code> 被注入到了根工程对象里的 <code>ext</code> 属性中。</li>
<li>所以你是通过根工程对象，访问到了被注入进去的变量。</li>
</ul>
<h4 data-id="heading-8">为什么验证成功但你不确定？</h4>
<p>你定义的那几个方法：</p>
<pre><code class="hljs language-groovy" lang="groovy">def getVersionCode(build){ ... }
</code></pre>
<p>这些定义在 <code>config.gradle</code> 里的方法，因为 <code>apply from</code> 的作用，变成了根工程脚本的一部分。当你调用 <code>ext.versionCode = getVersionCode(...)</code> 时，它只是在脚本执行期间计算出了一个整数，并赋值给了 <code>versionCode</code> 变量。子模块拿到的是计算好的<strong>结果（那个整数）</strong>，而不是那个函数。</p>
<hr/>
<h3 data-id="heading-9">总结与建议</h3>
<p>Gradle 的 Groovy 语法确实很“乱”，因为它不仅是配置，还是脚本代码，混杂了声明式（配置）和命令式（逻辑）的代码。</p>
<p><strong>给你的建议：</strong></p>
<ol>
<li>
<p><strong>关于 config.gradle 的引用位置</strong>：
建议将 <code>apply from: 'config.gradle'</code> 移出 <code>buildscript {}</code> 块，直接放在根目录 <code>build.gradle</code> 的顶部。这样逻辑更符合官方规范：</p>
<pre><code class="hljs language-groovy" lang="groovy">// 根目录 build.gradle
apply from: 'config.gradle' // 放在最顶层

buildscript {
   // ...
}
</code></pre>
</li>
<li>
<p><strong>拥抱 Kotlin DSL (KTS)</strong>：
如果你觉得 Groovy 很难懂，如果是新项目，强烈建议尝试 <strong>Kotlin DSL (<code>build.gradle.kts</code>)</strong>。</p>
<ul>
<li><strong>优点</strong>：你写的 <code>android { ... }</code> 都可以点进去看源码，知道里面有什么属性，需要什么类型，IDE 会智能提示。</li>
<li><strong>Version Catalog</strong>：现在 Android 官方推荐用 <code>libs.versions.toml</code> 文件来管理版本号，比 <code>config.gradle</code> 这种方式更清晰、更规范，Android Studio 对它的支持也更好。</li>
</ul>
</li>
</ol>
<p>目前的写法虽然“乱”，但在这个项目中是奏效且成熟的方案（国内很多旧项目都这么干），你可以放心地继续使用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3自定义渲染器：原理剖析与实践指南]]></title>    <link>https://juejin.cn/post/7587017021315399715</link>    <guid>https://juejin.cn/post/7587017021315399715</guid>    <pubDate>2025-12-24T09:42:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587017021315399715" data-draft-id="7587023071067209780" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3自定义渲染器：原理剖析与实践指南"/> <meta itemprop="keywords" content="前端,Vue.js,three.js"/> <meta itemprop="datePublished" content="2025-12-24T09:42:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小白菜的编程日记"/> <meta itemprop="url" content="https://juejin.cn/user/1302259794456120"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3自定义渲染器：原理剖析与实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1302259794456120/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小白菜的编程日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:42:22.000Z" title="Wed Dec 24 2025 09:42:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><blockquote>
<p>Vue3的自定义渲染器是框架架构中的一项革命性特性，它打破了Vue只能用于DOM渲染的限制，让开发者能够将Vue组件渲染到任意目标平台。本文将深入探讨Vue3自定义渲染器的核心原理，并通过TresJS这个优秀的3D渲染库来展示其实际应用。</p>
</blockquote>
<h2 data-id="heading-0">什么是自定义渲染器</h2>
<p>在传统的Vue应用中，渲染器负责将Vue组件转换为DOM元素。而Vue3引入的自定义渲染器API允许我们创建专门的渲染器，将Vue组件转换为任意类型的目标对象。TresJS正是利用这一特性，将Vue组件转换为Three.js的3D对象，让开发者能够使用声明式的Vue语法来构建3D场景。</p>
<h3 data-id="heading-1">传统DOM渲染器 vs 自定义渲染器</h3>
<p>传统DOM渲染器的操作流程非常直观：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue DOM渲染器操作</span>
<span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>)  <span class="hljs-comment">// 创建元素</span>
div.<span class="hljs-property">textContent</span> = <span class="hljs-string">'Hello World'</span>           <span class="hljs-comment">// 设置属性</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(div)            <span class="hljs-comment">// 挂载到父元素</span>
div.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">'red'</span>                   <span class="hljs-comment">// 更新属性</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(div)            <span class="hljs-comment">// 卸载元素</span>
</code></pre>
<p>而TresJS的自定义渲染器执行类似的操作，但目标对象是Three.js对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// TresJS渲染器操作</span>
<span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>()                    <span class="hljs-comment">// 创建Three.js对象</span>
mesh.<span class="hljs-property">material</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>()    <span class="hljs-comment">// 设置属性</span>
scene.<span class="hljs-title function_">add</span>(mesh)                                  <span class="hljs-comment">// 添加到场景</span>
mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)                       <span class="hljs-comment">// 更新属性</span>
scene.<span class="hljs-title function_">remove</span>(mesh)                               <span class="hljs-comment">// 从场景移除</span>
</code></pre>
<h2 data-id="heading-2">自定义渲染器API核心</h2>
<p>TresJS的自定义渲染器（nodeOps）实现了一套操作接口，当Vue需要执行以下操作时会调用这些接口：</p>
<ul>
<li>创建新的Three.js对象</li>
<li>将对象添加到场景或其他对象中</li>
<li>更新对象属性</li>
<li>从场景中移除对象</li>
</ul>
<p>这种架构设计让Vue的组件系统与具体的渲染目标解耦，使得同一个组件模型可以驱动不同的渲染后端。</p>
<h2 data-id="heading-3">响应式系统在3D渲染中的挑战</h2>
<p>Vue的响应式系统虽然强大，但在3D场景中需要谨慎使用。在60FPS的渲染循环中，不当的响应式使用会导致严重的性能问题。</p>
<h3 data-id="heading-4">性能挑战</h3>
<p>Vue的响应式基于JavaScript Proxy，每次属性访问和修改都会被拦截。在3D渲染循环中，这意味着每秒60次触发响应式系统：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 这种做法会导致性能问题</span>
<span class="hljs-keyword">const</span> position = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">0</span> })

<span class="hljs-keyword">const</span> { onBeforeRender } = <span class="hljs-title function_">useLoop</span>()
<span class="hljs-title function_">onBeforeRender</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 每秒触发Vue响应式系统60次</span>
  position.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() * <span class="hljs-number">0.001</span>) * <span class="hljs-number">3</span>
  position.<span class="hljs-property">y</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() * <span class="hljs-number">0.001</span>) * <span class="hljs-number">2</span>
})
</code></pre>
<p>性能对比数据令人警醒：普通对象的属性访问可达每秒5000万次，而响应式对象由于代理开销只能达到每秒200万次。</p>
<h3 data-id="heading-5">解决方案：模板引用的艺术</h3>
<p>模板引用（Template Refs）提供了直接访问Three.js实例的能力，避免了响应式开销，是动画和频繁更新的最佳选择：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 推荐做法：使用模板引用</span>
<span class="hljs-keyword">const</span> meshRef = <span class="hljs-title function_">shallowRef</span>(<span class="hljs-literal">null</span>)

<span class="hljs-keyword">const</span> { onBeforeRender } = <span class="hljs-title function_">useLoop</span>()
<span class="hljs-title function_">onBeforeRender</span>(<span class="hljs-function">(<span class="hljs-params">{ elapsed }</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (meshRef.<span class="hljs-property">value</span>) {
    <span class="hljs-comment">// 直接属性修改，无响应式开销</span>
    meshRef.<span class="hljs-property">value</span>.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = elapsed * <span class="hljs-number">0.5</span>
    meshRef.<span class="hljs-property">value</span>.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> = elapsed * <span class="hljs-number">0.3</span>
    meshRef.<span class="hljs-property">value</span>.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(elapsed) * <span class="hljs-number">2</span>
  }
})
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;TresCanvas&gt;
    &lt;TresPerspectiveCamera :position="[0, 0, 5]" /&gt;
    &lt;TresAmbientLight /&gt;
    
    &lt;!-- 模板引用连接到Three.js实例 --&gt;
    &lt;TresMesh ref="meshRef"&gt;
      &lt;TresBoxGeometry /&gt;
      &lt;TresMeshStandardMaterial color="#ff6b35" /&gt;
    &lt;/TresMesh&gt;
  &lt;/TresCanvas&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-6">浅层响应式：平衡的艺术</h2>
<p>当需要部分响应式时，<code>shallowRef</code>和<code>shallowReactive</code>提供了完美的平衡：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 只让顶层属性具有响应性</span>
<span class="hljs-keyword">const</span> meshProps = <span class="hljs-title function_">shallowReactive</span>({
  <span class="hljs-attr">color</span>: <span class="hljs-string">'#ff6b35'</span>,
  <span class="hljs-attr">wireframe</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">visible</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">position</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">0</span> }  <span class="hljs-comment">// 这个对象不是深度响应式的</span>
})

<span class="hljs-comment">// UI控制修改外观</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleWireframe</span> = (<span class="hljs-params"/>) =&gt; {
  meshProps.<span class="hljs-property">wireframe</span> = !meshProps.<span class="hljs-property">wireframe</span>  <span class="hljs-comment">// 响应式更新</span>
}

<span class="hljs-keyword">const</span> { onBeforeRender } = <span class="hljs-title function_">useLoop</span>()
<span class="hljs-title function_">onBeforeRender</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (meshRef.<span class="hljs-property">value</span>) {
    <span class="hljs-comment">// 直接位置修改，无响应式开销</span>
    meshRef.<span class="hljs-property">value</span>.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() * <span class="hljs-number">0.001</span>) * <span class="hljs-number">2</span>
  }
})
</code></pre>
<h2 data-id="heading-7">最佳实践模式</h2>
<h3 data-id="heading-8">1. 初始定位与动画分离</h3>
<p>使用响应式属性进行初始定位，使用模板引用进行动画：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 响应式初始状态</span>
<span class="hljs-keyword">const</span> initialPosition = <span class="hljs-title function_">ref</span>([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>])
<span class="hljs-keyword">const</span> color = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'#ff6b35'</span>)

<span class="hljs-comment">// ✅ 模板引用用于动画</span>
<span class="hljs-keyword">const</span> meshRef = <span class="hljs-title function_">shallowRef</span>(<span class="hljs-literal">null</span>)

<span class="hljs-keyword">const</span> { onBeforeRender } = <span class="hljs-title function_">useLoop</span>()
<span class="hljs-title function_">onBeforeRender</span>(<span class="hljs-function">(<span class="hljs-params">{ elapsed }</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (meshRef.<span class="hljs-property">value</span>) {
    <span class="hljs-comment">// 相对于初始位置进行动画</span>
    meshRef.<span class="hljs-property">value</span>.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = initialPosition.<span class="hljs-property">value</span>[<span class="hljs-number">1</span>] + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(elapsed) * <span class="hljs-number">2</span>
  }
})
</code></pre>
<h3 data-id="heading-9">2. 计算属性优化复杂计算</h3>
<p>对于不应在每帧运行的昂贵计算，使用计算属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 计算属性只在依赖改变时重新计算</span>
<span class="hljs-keyword">const</span> orbitPositions = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> positions = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; settings.<span class="hljs-property">objects</span>; i++) {
    <span class="hljs-keyword">const</span> angle = (i / settings.<span class="hljs-property">objects</span>) * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>
    positions.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">x</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angle) * settings.<span class="hljs-property">radius</span>,
      <span class="hljs-attr">z</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angle) * settings.<span class="hljs-property">radius</span>
    })
  }
  <span class="hljs-keyword">return</span> positions
})
</code></pre>
<h3 data-id="heading-10">3. 基于生命周期的更新</h3>
<p>使用Vue的生命周期钩子处理性能敏感的更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> animationState = {
  <span class="hljs-attr">time</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">amplitude</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">frequency</span>: <span class="hljs-number">1</span>
}

<span class="hljs-keyword">const</span> { onBeforeRender } = <span class="hljs-title function_">useLoop</span>()
<span class="hljs-title function_">onBeforeRender</span>(<span class="hljs-function">(<span class="hljs-params">{ delta }</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!isAnimating.<span class="hljs-property">value</span> || !meshRef.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>
  
  <span class="hljs-comment">// 更新非响应式状态</span>
  animationState.<span class="hljs-property">time</span> += delta
  
  <span class="hljs-comment">// 应用到Three.js实例</span>
  meshRef.<span class="hljs-property">value</span>.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(animationState.<span class="hljs-property">time</span> * animationState.<span class="hljs-property">frequency</span>) * animationState.<span class="hljs-property">amplitude</span>
})
</code></pre>
<h2 data-id="heading-11">常见陷阱与规避</h2>
<h3 data-id="heading-12">陷阱1：在动画中使用响应式数据</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 避免：在渲染循环中使用响应式对象</span>
<span class="hljs-keyword">const</span> rotation = <span class="hljs-title function_">reactive</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">0</span> })

<span class="hljs-title function_">onBeforeRender</span>(<span class="hljs-function">(<span class="hljs-params">{ elapsed }</span>) =&gt;</span> {
  rotation.<span class="hljs-property">x</span> = elapsed * <span class="hljs-number">0.5</span>  <span class="hljs-comment">// 每帧触发Vue响应式系统</span>
  rotation.<span class="hljs-property">y</span> = elapsed * <span class="hljs-number">0.3</span>
})
</code></pre>
<p><strong>解决方案：使用模板引用</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 推荐：直接实例操作</span>
<span class="hljs-keyword">const</span> meshRef = <span class="hljs-title function_">shallowRef</span>(<span class="hljs-literal">null</span>)

<span class="hljs-title function_">onBeforeRender</span>(<span class="hljs-function">(<span class="hljs-params">{ elapsed }</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (meshRef.<span class="hljs-property">value</span>) {
    meshRef.<span class="hljs-property">value</span>.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = elapsed * <span class="hljs-number">0.5</span>
    meshRef.<span class="hljs-property">value</span>.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> = elapsed * <span class="hljs-number">0.3</span>
  }
})
</code></pre>
<h3 data-id="heading-13">陷阱2：深度响应式数组</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 避免：深度响应式数组更新</span>
<span class="hljs-keyword">const</span> particles = <span class="hljs-title function_">reactive</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
  <span class="hljs-attr">position</span>: { <span class="hljs-attr">x</span>: i, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">0</span> },
  <span class="hljs-attr">velocity</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">0</span> }
})))

<span class="hljs-title function_">onBeforeRender</span>(<span class="hljs-function">() =&gt;</span> {
  particles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">particle</span>) =&gt;</span> {
    <span class="hljs-comment">// 100个响应式对象的开销极大</span>
    particle.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> += particle.<span class="hljs-property">velocity</span>.<span class="hljs-property">x</span>
  })
})
</code></pre>
<p><strong>解决方案：非响应式数据+模板引用</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 推荐：普通对象+模板引用</span>
<span class="hljs-keyword">const</span> particleData = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
  <span class="hljs-attr">position</span>: { <span class="hljs-attr">x</span>: i, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">0</span> },
  <span class="hljs-attr">velocity</span>: { <span class="hljs-attr">x</span>: (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">0.1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">0</span> }
}))

<span class="hljs-keyword">const</span> particleRefs = <span class="hljs-title function_">shallowRef</span>([])

<span class="hljs-title function_">onBeforeRender</span>(<span class="hljs-function">() =&gt;</span> {
  particleData.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">particle, index</span>) =&gt;</span> {
    <span class="hljs-comment">// 更新普通对象数据</span>
    particle.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> += particle.<span class="hljs-property">velocity</span>.<span class="hljs-property">x</span>
    
    <span class="hljs-comment">// 应用到Three.js实例</span>
    <span class="hljs-keyword">const</span> mesh = particleRefs.<span class="hljs-property">value</span>[index]
    <span class="hljs-keyword">if</span> (mesh) {
      mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(particle.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>, particle.<span class="hljs-property">position</span>.<span class="hljs-property">y</span>, particle.<span class="hljs-property">position</span>.<span class="hljs-property">z</span>)
    }
  })
})
</code></pre>
<h2 data-id="heading-14">性能监控与优化</h2>
<p>使用性能监控工具如<code>@tresjs/leches</code>来实时监控FPS：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">TresLeches</span>, useControls } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tresjs/leches'</span>

<span class="hljs-comment">// 启用FPS监控</span>
<span class="hljs-title function_">useControls</span>(<span class="hljs-string">'fpsgraph'</span>)
</code></pre>
<h2 data-id="heading-15">核心要点总结</h2>
<p>Vue3自定义渲染器为跨平台渲染开辟了全新的可能性，但在3D渲染这样的高性能场景中，需要明智地选择响应式策略：</p>
<ol>
<li><strong>模板引用优先</strong>：在渲染循环中使用模板引用直接操作Three.js实例，避免响应式开销</li>
<li><strong>浅层响应式</strong>：当需要部分响应式时，使用<code>shallowRef</code>和<code>shallowReactive</code>获得平衡</li>
<li><strong>关注点分离</strong>：保持UI状态的响应性和动画状态的非响应性，以获得最佳性能</li>
<li><strong>持续监控</strong>：使用性能监控工具识别3D场景中的响应式瓶颈</li>
</ol>
<p>通过理解并应用这些模式，开发者可以创建既具有Vue开发体验优势，又能在高性能3D环境中流畅运行的应用。Vue3自定义渲染器不仅是一个技术特性，更是连接声明式编程与多样化渲染目标的桥梁，为前端开发开启了全新的创作空间。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手游 iOS SDK 改用 CocoaPods 集成]]></title>    <link>https://juejin.cn/post/7587208390483197958</link>    <guid>https://juejin.cn/post/7587208390483197958</guid>    <pubDate>2025-12-24T08:47:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587208390483197958" data-draft-id="7587208390482837510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手游 iOS SDK 改用 CocoaPods 集成"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-12-24T08:47:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LorrestGump"/> <meta itemprop="url" content="https://juejin.cn/user/1822323383742587"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手游 iOS SDK 改用 CocoaPods 集成
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1822323383742587/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LorrestGump
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T08:47:41.000Z" title="Wed Dec 24 2025 08:47:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>目前手游 iOS SDK 普遍使用手动集成方案。但随着近几年出海热，SDK 需要集成大量第三方库，如 AppsFlyer、Firebase、Admob、Facebook、Twitter、AppLovin 等等。其中一些三方库不支持 CocoaPods 集成，所以我也都使用手动集成。</p>
<p>因为不同的游戏需要接入的第三方库不一样，当用不到的时候，SDK 里就需要剔除相关代码，不然编译也会报错。我的解决方案是通过宏来进行开关隔离，比如：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">define</span> AppsFlyer 1</span>

<span class="hljs-meta">#<span class="hljs-keyword">if</span> AppsFlyer</span>
<span class="hljs-comment">// 调用相关接口</span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<p>像这样通过设置 <code>AppsFlyer</code> 为 1 或者 0 来启用和关闭相关代码，关闭时编译器会过滤掉这些代码。此外，当不同的游戏接入的 SDK 出现一些问题需要测试时，就需要频繁改参数、改宏开关。这些操作相当繁琐，所以我都是每个包复制一份 SDK 代码进行设置，用空间换方便。</p>
<p>复制 SDK 时三方库也会复制，三方库可占空间了。以苹果那金子般的内存，过不了多久电脑存储空间就不够用了，必须定期清理。</p>
<p>随着 SDK 趋近稳定，三方库也需要保持更新，我计划将 SDK 改用 CocoaPods 集成。这样不用每次都生成 SDK 副本，也方便研发接入。</p>
<p>最开始是计划把 SDK 里的三方库相关代码拆分成单独的库，让它们单独去依赖对应的三方库，提供接口给 SDK 调用。这样不同的游戏用到哪个三方库就导入对应的库，不再用 SDK 内部宏定义开关。</p>
<p>因为之前从未用 Pod 来管理自己的库，我以为这个事应该很快弄完，结果意外的折腾了好长时间……</p>
<p>我遇到的问题主要归为两类：</p>
<ol>
<li>依赖导致的链接和配置错误；</li>
<li>重复引用警告（即把依赖的三方库代码也编译到我的拆分库里，而游戏工程通过 Pod 也会引入一份）。</li>
</ol>
<p>以下是我将封装层从静态库改成动态库再改成源码依赖的过程和遇到的问题。</p>
<h2 data-id="heading-0">1. 静态库阶段</h2>
<p>我首先把 SDK 里的三方库相关代码拆分成了一个个静态库，相当于把需要用到的三方库接口封装了一层。为什么不用动态库？因为我不想要 ipa 包里的 Framework 里有太多自定义库。如果是静态库，那这些代码会编译到主二进制里。</p>
<p>在静态库开发工程里测试编译都正常，但在验证 <code>podspec</code> 时报各种错误。原因是依赖各种类型的三方库导致的复杂的链接和配置错误，还要掺杂不同编程语言。折腾了两三天最终放弃了，改为动态库。</p>
<blockquote>
<p><strong>注</strong>：<code>podspec</code> 文件就是库的配置和导入说明书，需要在里面设置库的名称、版本、支持系统版本、库文件位置、系统库和三方库依赖，以及一些工程配置如 <code>Other Link Flag</code> 的设置等。把这个文件成功发布到 Pod 后，大家就可以通过 Pod 来引入你的库了。</p>
</blockquote>
<h2 data-id="heading-1">2. 动态库阶段</h2>
<p>把拆分库改成动态库后，就少了很多链接和配置错误。有一部分三方库并未提供 Pod 引入，只提供了下载链接，这种就无法自动保持更新了，只能我手动去替换三方库。</p>
<p>理论上可以在 <code>podspec</code> 里直接把三方库的下载链接设置为它们官网的下载链接，前提是他们链接保持不变并且里面的文件路径不改。但是这样我感觉不太稳，所以还是手动替换更新。</p>
<p>此外，我的库都是用 OC 写的，有一部分三方库是用 Swift 写的或者混合了 Swift，这种情况需要在 <code>build setting</code> 里调整一些设置。还好有 AI 可以问，不然有得折腾了。</p>
<p>SDK 内部之前会调用很多三方库代码，但是我希望这些三方封装层独立于 SDK，即 SDK 不要依赖这些库。于是原本在 SDK 内部调用的接口就放到外部由研发来调用，后面发现外部接入变得复杂了好多。而且很多接口跟研发也没什么关系，这样做增加了他们的接入难度，和旧版 SDK 接入变化很大。</p>
<p>我把这个情况问了下 AI，AI 给的方案是通过代理实现：即把 SDK 用到的三方库封装层方法定义成一个协议，让封装层自行选择实现协议里的方法。在 SDK 内部调用实现了相关协议方法的代理，代理指定由研发在外部初始化封装层后设置。</p>
<p>当然这个操作后面也省略了，改成在 SDK 内部通过特定方法在判断三方封装层类存在时创建封装层实例并设置为代理。经过这些操作，SDK 接口对比旧版变化就比较小了。</p>
<p>objectivec</p>
<pre><code class="hljs language-ini" lang="ini">// 通过运行时设置代理
SEL <span class="hljs-attr">sharef</span> = NSSelectorFromString(@<span class="hljs-string">"shared"</span>)<span class="hljs-comment">;</span>
// AppsFlyer
if (NSClassFromString(SDK_APPSFLYER)) {
    <span class="hljs-attr">self.appsFlyerDelegate</span> = [NSClassFromString(SDK_APPSFLYER) performSelector:sharef]<span class="hljs-comment">;</span>
}
</code></pre>
<p>从前面到这里，我的库的开发工程都是用 CocoaPod 来引入的三方库。CocoaPod 会在我编译拆分库的 Target 生成 framework 文件时，把依赖的三方库代码和文件都打包进来。这样一来，当我发布到 Pod 后用 SDK Demo 工程测试时会报警告，内容是三方库在我的拆分库里也有实现代码。在试了 AI 给的很多解决方法都没能解决这个问题后，我只能在库开发工程里移除了 Pods，将三方库改为手动导入，以此避免三方库打进我的封装库里。</p>
<p>这里面有个意外就是 VKID 库（俄罗斯微信）仍然得用 Pods 来引入，因为它是以纯 Swift 源码导入的。我在手动导入 Swift 源码时会报缺失某个代码文件，用 Pod 就正常，按住 command 能找到这个文件代码，但我看不到它在哪——根本没有路径……</p>
<p>此时我也发现在 OC 动态库里依赖的三方 Swift 库会被打包进来，设置为 <code>Do not embed</code> 也没有用。AI 确认了这一点并建议我改回静态库……</p>
<p>无奈我最终只能把封装库改成用 Pod 源代码引入，而且要改就把所有三方封装库都改成源码引入算了。</p>
<h2 data-id="heading-2">3. 源代码阶段</h2>
<p>当我把其他封装库都成功发布到 Pod 官方后，最后轮到 VKID 时又报错了。Swift 写的 VKID 并未提供 OC 调用的接口，我在封装层用 <code>@objc</code> 做了下桥接，然后用 OC 写的一个 Manager 类来调用转接口，很合理吧？这样就不行，<code>podspec</code> 验证不通过。</p>
<p>折腾来折腾去，最终 AI 给出的方案是把封装层的 Swift 拆分出来单独成库，不要跟 OC 混合在一起。果然拆开后就验证通过了，成功发布到 Pod 官方。</p>
<h2 data-id="heading-3">关于库签名和隐私文件</h2>
<p>之前是动态库的时候，需要把单独编译成的真机和模拟器 framework 合并成 xcframework，然后再对这些库进行签名。动态库签名是苹果近两年的要求，不签名提包会被打回。改成源码导入后就省去这些麻烦了。</p>
<p>此外，这种源码库的隐私文件要不要加暂时不确定。理论上不用，我暂未提包测试过，但 AI 建议加上，看了下一些三方库也是加了的。</p>
<h2 data-id="heading-4">关于 AI</h2>
<p>我用到的 AI 主要是 DeepSeek 和 Gemini，都是免费的版本。之前用 AI 养成习惯开新对话，这次咨询的问题比较复杂，我会在一个对话里继续来回问很多次，发现 AI 变强好多，问到后面还会记得前面的推理。</p>
<p>说句题外话，AI编程都出来这么久了，Xcode仍然没有官方支持AI，真是低人一等。随便用一下其他AI编程工具，感觉都不是一个时代的东西。苹果公司的AI部门貌似内斗严重，至今拿不出像样的东西。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[KTS语法]]></title>    <link>https://juejin.cn/post/7587254134400450569</link>    <guid>https://juejin.cn/post/7587254134400450569</guid>    <pubDate>2025-12-24T09:43:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587254134400450569" data-draft-id="7587239837972365363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="KTS语法"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-24T09:43:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GoldenPlayer"/> <meta itemprop="url" content="https://juejin.cn/user/2999123453948119"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            KTS语法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123453948119/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GoldenPlayer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:43:45.000Z" title="Wed Dec 24 2025 09:43:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>其实 KTS (Kotlin Script) 并没有那么可怕，它的核心逻辑和 Groovy 是一样的，只是“方言”变了</p>
<p>Groovy 像是<strong>文言文或者狂草</strong>（写意，少写一个括号也能跑，但在哪里跑我也得猜）；
KTS 像是<strong>法律文书或者楷书</strong>（严谨，必须加括号，必须加等号，但哪里写错了 IDE 立马标红）</p>
<p>下面我们通过一个 HelloWorld 级别的工程，<strong>左边 Groovy，右边 KTS</strong>，来一场面对面的“翻译”</p>
<hr/>
<h3 data-id="heading-0">一、 三条核心“翻译”法则</h3>
<p>在看代码前，只需要记住这三条法则，就能读懂 80% 的 KTS 代码：</p>
<ol>
<li><strong>字符串必须用双引号</strong>：
<ul>
<li>Groovy: <code>'Hello'</code> 或 <code>"Hello"</code> 都可以。</li>
<li>KTS: 必须是 <code>"Hello"</code>。</li>
</ul>
</li>
<li><strong>赋值必须用 <code>=</code></strong>：
<ul>
<li>Groovy: <code>compileSdkVersion 30</code> (像是在喊命令)。</li>
<li>KTS: <code>compileSdk = 30</code> (这是在给属性赋值)。</li>
</ul>
</li>
<li><strong>函数调用尽量加 <code>()</code></strong>：
<ul>
<li>Groovy: <code>implementation 'com.xxx'</code>。</li>
<li>KTS: <code>implementation("com.xxx")</code>。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-1">二、 根目录 build.gradle 对照</h3>
<p>这是项目的入口配置</p>
<h4 data-id="heading-2">1. 声明插件 (Plugins)</h4>
<p><strong>Groovy (<code>build.gradle</code>):</strong></p>
<pre><code class="hljs language-groovy" lang="groovy">// 以前的旧写法是 buildscript { dependencies { classpath ... } }
// 现在的写法：
plugins {
    id 'com.android.application' version '8.2.0' apply false
    id 'com.android.library' version '8.2.0' apply false
    id 'org.jetbrains.kotlin.android' version '1.9.20' apply false
}
</code></pre>
<p><strong>KTS (<code>build.gradle.kts</code>):</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">plugins {
    <span class="hljs-comment">// 区别1：必须用双引号</span>
    <span class="hljs-comment">// 区别2：必须用括号 id(...)</span>
    id(<span class="hljs-string">"com.android.application"</span>) version <span class="hljs-string">"8.2.0"</span> apply <span class="hljs-literal">false</span>
    id(<span class="hljs-string">"com.android.library"</span>) version <span class="hljs-string">"8.2.0"</span> apply <span class="hljs-literal">false</span>
    id(<span class="hljs-string">"org.jetbrains.kotlin.android"</span>) version <span class="hljs-string">"1.9.20"</span> apply <span class="hljs-literal">false</span>
}
</code></pre>
<p><em>感受：这里差别不大，主要是加了括号和双引号。</em></p>
<hr/>
<h3 data-id="heading-3">三、 App 模块 build.gradle 对照 (重头戏)</h3>
<p>这里是差异最大的地方，也是<strong>IDE 提示优势</strong>体现最明显的地方</p>
<h4 data-id="heading-4">1. 插件引用</h4>
<p><strong>Groovy:</strong></p>
<pre><code class="hljs language-groovy" lang="groovy">plugins {
    id 'com.android.application'
    id 'kotlin-android'
}
</code></pre>
<p><strong>KTS:</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">plugins {
    id(<span class="hljs-string">"com.android.application"</span>)
    id(<span class="hljs-string">"kotlin-android"</span>)
}
</code></pre>
<h4 data-id="heading-5">2. Android 配置块 (最能体现赋值语法的区别)</h4>
<p><strong>Groovy:</strong></p>
<pre><code class="hljs language-groovy" lang="groovy">android {
    namespace 'com.example.myapp' // 只有空格
    compileSdkVersion 34          // 只有空格

    defaultConfig {
        applicationId "com.example.myapp"
        minSdkVersion 24
        targetSdkVersion 34
        versionCode 1
        versionName "1.0"
    }
    
    // 签名配置等...
}
</code></pre>
<p><strong>KTS:</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">android {
    namespace = <span class="hljs-string">"com.example.myapp"</span> <span class="hljs-comment">// 必须加 = 号</span>
    compileSdk = <span class="hljs-number">34</span>                 <span class="hljs-comment">// 属性名变了(更简洁)，且必须加 = 号</span>

    defaultConfig {
        applicationId = <span class="hljs-string">"com.example.myapp"</span>
        minSdk = <span class="hljs-number">24</span>                 <span class="hljs-comment">// 必须加 = </span>
        targetSdk = <span class="hljs-number">34</span>              <span class="hljs-comment">// 必须加 =</span>
        versionCode = <span class="hljs-number">1</span>
        versionName = <span class="hljs-string">"1.0"</span>
    }
}
</code></pre>
<blockquote>
<p><strong>🔥 IDE 提示优势时刻：</strong>
在 KTS 中，你把鼠标放在 <code>compileSdk</code> 上，按 Ctrl+左键（Mac 是 Cmd+左键），<strong>你是可以点进源码的！</strong>
你会看到它是 <code>BaseExtension</code> 类下的一个 <code>var compileSdk: Int</code> 属性。
<strong>这意味着：</strong> 如果你敲 <code>compileSdk = "34"</code> (字符串)，IDE 会<strong>直接爆红</strong>告诉你类型错误，而在 Groovy 中可能要等到编译失败才告诉你。</p>
</blockquote>
<h4 data-id="heading-6">3. BuildTypes (构建类型)</h4>
<p>这是最容易让人懵的地方，因为 Groovy 太动态了</p>
<p><strong>Groovy:</strong></p>
<pre><code class="hljs language-groovy" lang="groovy">buildTypes {
    release { // 这里的 release 是凭空写出来的，Groovy 会动态创建
        minifyEnabled true
        proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
    }
}
</code></pre>
<p><strong>KTS:</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">buildTypes {
    <span class="hljs-comment">// KTS 是静态语言，不能凭空变出 release。</span>
    <span class="hljs-comment">// 必须用 getByName 或者 create 来获取已经存在的 release 配置</span>
    getByName(<span class="hljs-string">"release"</span>) {
        isMinifyEnabled = <span class="hljs-literal">true</span> <span class="hljs-comment">// 布尔值通常加 is 前缀，且必须用 =</span>
        
        <span class="hljs-comment">// 函数调用必须加括号</span>
        proguardFiles(
            getDefaultProguardFile(<span class="hljs-string">"proguard-android-optimize.txt"</span>),
            <span class="hljs-string">"proguard-rules.pro"</span>
        )
    }
}
</code></pre>
<h4 data-id="heading-7">4. 依赖 (Dependencies)</h4>
<p><strong>Groovy:</strong></p>
<pre><code class="hljs language-groovy" lang="groovy">dependencies {
    implementation 'androidx.core:core-ktx:1.12.0'
    implementation 'androidx.appcompat:appcompat:1.6.1'
    testImplementation 'junit:junit:4.13.2'
}
</code></pre>
<p><strong>KTS:</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">dependencies {
    <span class="hljs-comment">// 必须加括号，必须双引号</span>
    implementation(<span class="hljs-string">"androidx.core:core-ktx:1.12.0"</span>)
    implementation(<span class="hljs-string">"androidx.appcompat:appcompat:1.6.1"</span>)
    testImplementation(<span class="hljs-string">"junit:junit:4.13.2"</span>)
}
</code></pre>
<hr/>
<h3 data-id="heading-8">四、 回应“痛点”：Config.gradle 在 KTS 里怎么办？</h3>
<p>之前用了 <code>config.gradle</code> 来统一管理版本号。在 KTS 时代（以及 2025 年现在的标准），我们有了官方钦定的替代品：<strong>Version Catalog (libs.versions.toml)</strong>。</p>
<p>这比 <code>config.gradle</code> 爽太多了，而且支持 KTS 的代码提示</p>
<p><strong>1. 创建 <code>gradle/libs.versions.toml</code> 文件：</strong></p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[versions]</span>
<span class="hljs-attr">kotlin</span> = <span class="hljs-string">"1.9.20"</span>
<span class="hljs-attr">coreKtx</span> = <span class="hljs-string">"1.12.0"</span>

<span class="hljs-section">[libraries]</span>
<span class="hljs-attr">androidx-core-ktx</span> = { group = <span class="hljs-string">"androidx.core"</span>, name = <span class="hljs-string">"core-ktx"</span>, version.ref = <span class="hljs-string">"coreKtx"</span> }
</code></pre>
<p><strong>2. 在 KTS 中使用 (IDE 智能提示炸裂)：</strong></p>
<p>当在 <code>build.gradle.kts</code> 里打字时：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dependencies {
    <span class="hljs-comment">// 当你敲下 libs. 时，IDE 会自动弹出 androidx，然后弹出 core...</span>
    <span class="hljs-comment">// 就像写 Java 代码一样爽，完全不用去记名字！</span>
    implementation(libs.androidx.core.ktx) 
}
</code></pre>
<p>这比用 <code>rootProject.ext.versionName</code> 这种“盲猜”的写法要安全舒服得多</p>
<h3 data-id="heading-9">总结</h3>
<p>KTS 并没有增加复杂度，它只是增加了<strong>严谨度</strong></p>
<p><strong>为什么值得转？</strong></p>
<ol>
<li><strong>写代码的感觉</strong>：在写 Gradle 脚本时，不再是“抄代码”，而是像写 Kotlin 业务代码一样，有类、有对象、有方法。</li>
<li><strong>排错</strong>：少写个括号，IDE 界面上直接标红，不用等到点了 Run 跑了一半才报错。</li>
<li><strong>跳转</strong>：按住 Ctrl/Cmd 点击任何配置项，直接看文档源码，不再需要百度“compileSdkVersion 接受什么类型”。</li>
</ol>
<p><strong>建议</strong>：下次新开一个小 Demo 项目时，勾选 "Kotlin DSL"，照着上面的对照表试一次，会发现“真香”的</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌Gemini"Something went wrong"错误解决方法：2步快速解除限制（2025最新教程）]]></title>    <link>https://juejin.cn/post/7586973107322568744</link>    <guid>https://juejin.cn/post/7586973107322568744</guid>    <pubDate>2025-12-23T22:10:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586973107322568744" data-draft-id="7586869907067093027" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌Gemini&quot;Something went wrong&quot;错误解决方法：2步快速解除限制（2025最新教程）"/> <meta itemprop="keywords" content="Google,Gemini"/> <meta itemprop="datePublished" content="2025-12-23T22:10:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GPTMirrors镜像系统"/> <meta itemprop="url" content="https://juejin.cn/user/3173663916689419"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌Gemini"Something went wrong"错误解决方法：2步快速解除限制（2025最新教程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3173663916689419/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GPTMirrors镜像系统
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T22:10:45.000Z" title="Tue Dec 23 2025 22:10:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0"> 前言：Gemini无法使用？一分钟教你完美解决</h2>
<p>最近谷歌的<strong>Gemini AI</strong>火爆全网，吸引了大量用户尝试体验。但许多朋友在打开Gemini时却遭遇了令人头疼的"<strong>Something went wrong</strong>"错误提示，导致无法正常使用。</p>
<p>网上关于Gemini报错的解决方法五花八门，有人说要完善账号资料，有人建议绑定手机号，但这些方法往往效果不佳。<strong>本文分享经过实测有效的解决方案，只需2个关键步骤，1分钟即可解除Gemini使用限制。</strong> <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/885131c0a42b45baaad680271cf068ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR1BUTWlycm9yc-mVnOWDj-ezu-e7nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767167092&amp;x-signature=v3MK64GoPPZByvocsW5F1N0P5Pg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h2 data-id="heading-1">Gemini "Something went wrong" 错误原因分析</h2>
<p>当你访问Gemini时出现"Something went wrong"提示，主要原因包括：</p>
<p>-账号地区限制检测</p>
<ul>
<li>IP地址异常</li>
<li>账号验证未通过</li>
<li>访问节点质量问题</li>
</ul>
<p><strong>重点提示</strong>：解决这个问题的核心在于两个要素——<strong>正确的访问节点</strong>和<strong>特定的激活链接</strong>。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8a3dbc81bbb460a856504e966a077f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR1BUTWlycm9yc-mVnOWDj-ezu-e7nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767167092&amp;x-signature=OWbqlsU3WeFUq2o0lFZ5ZeBbxNU%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h2 data-id="heading-2">解决方法：2步解除Gemini使用限制</h2>
<h3 data-id="heading-3">步骤一：确保使用美国区域节点</h3>
<p><strong>工具要求：</strong></p>
<ul>
<li>必须使用<strong>美国IP地址</strong>的网络访问工具</li>
<li>节点质量直接决定成功率</li>
<li>建议选择稳定、速度快的美国节点</li>
</ul>
<p><strong>操作提示：</strong></p>
<ol>
<li>连接美国地区的网络节点</li>
<li>确认IP地址显示为美国区域</li>
<li>如果第二步操作失败，尝试切换不同的美国节点</li>
<li>优质节点通常一次即可成功</li>
</ol>
<p>⚠️ <strong>重要提醒</strong>：如果你不了解什么是"网络访问工具"，可能需要先学习相关基础知识。</p>
<hr/>
<h3 data-id="heading-4">步骤二：使用专用激活链接（核心步骤）</h3>
<p><strong>关键链接：</strong></p>
<pre><code class="hljs language-ini" lang="ini">https://gemini.google.com/gems/create?<span class="hljs-attr">hl</span>=en-US&amp;pli=<span class="hljs-number">1</span>
 
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>详细操作步骤：</strong></p>
<ol>
<li><strong>打开链接</strong></li>
</ol>
<ul>
<li>
<p>在连接好美国节点后，<strong>必须通过上述专用链接</strong>访问Gemini</p>
<ul>
<li>不要直接访问Gemini首页</li>
</ul>
</li>
</ul>
<ol>
<li>
<p><strong>登录账号</strong></p>
<ul>
<li>如果已登录Google账号，会直接进入Gem创建页面</li>
<li>未登录则点击登录按钮，使用你的Google账号登录</li>
</ul>
</li>
<li>
<p><strong>填写Gem信息</strong></p>
<ul>
<li>
<p>页面会显示3个英文填写选项</p>
</li>
<li>
<p><strong>用英文填写</strong>这些选项（Name、Description等）</p>
</li>
<li>
<p>内容要真实合理，不要随意乱填</p>
</li>
<li>
<p>例如：</p>
<ul>
<li>Name: <code>My Assistant</code></li>
<li>Description: <code>A helpful AI assistant for daily tasks</code><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06ebd81f02ce40ebbc0d21646c1bf608~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR1BUTWlycm9yc-mVnOWDj-ezu-e7nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767167092&amp;x-signature=k64x9nseDQqB68gF6YoRd89G7ZU%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</li>
</ul>
</li>
</ul>
</li>
</ol>

<ol>
<li>
<p><strong>保存设置</strong></p>
<ul>
<li>点击保存按钮</li>
<li><strong>如果出现无法保存的情况</strong>，说明当前节点质量不佳，需要切换美国节点重试</li>
<li>成功保存后，你的账号限制就已经解除了</li>
</ul>
</li>
<li>
<p><strong>验证结果</strong></p>
<ul>
<li>保存成功后，进入Gemini对话页面</li>
<li>此时应该可以正常使用Gemini进行对话了</li>
</ul>
</li>
</ol>
<h2 data-id="heading-5">常见问题解答（FAQ）</h2>
<p><strong>Q1: 为什么必须使用这个特定链接？</strong><br/>
A: 这个链接会触发Gemini的Gem创建功能，通过这个过程可以激活账号的完整权限，绕过常规的地区限制检测。</p>
<p><strong>Q2: 填写Gem信息时有什么注意事项？</strong><br/>
A: 务必用英文填写，内容要合理真实，不要使用随机字符或明显虚假的信息，这可能导致保存失败。</p>
<p><strong>Q3: 如果多次切换节点仍然失败怎么办？</strong><br/>
A: 建议更换网络访问工具，选择质量更好、更稳定的美国节点服务。</p>
<p><strong>Q4: 解除限制后会不会再次出现问题？</strong><br/>
A: 正常情况下，成功激活后账号就可以稳定使用。但建议在使用Gemini时仍保持美国节点连接。</p>
<h2 data-id="heading-6">总结</h2>
<p>解除Gemini "Something went wrong"错误的<strong>核心要点</strong>：</p>
<p>✅ 使用<strong>美国区域</strong>的优质网络节点<br/>
✅ 通过<strong>专用激活链接</strong>访问：<code>https://gemini.google.com/gems/create?hl=en-US&amp;pli=1</code><br/>
✅ <strong>用英文</strong>真实填写Gem创建信息<br/>
✅ 成功保存后即可正常使用Gemini</p>
<p>按照本教程操作，大部分用户都能在1分钟内成功解除Gemini使用限制。如果你成功了，欢迎点赞分享本教程！</p>
<p>对于动手能力不强，不想折腾的可以看看这篇教程使用：</p>
<pre><code class="hljs language-arduino" lang="arduino">https:<span class="hljs-comment">//chat.gptmirrors.com/gemini-web-login-cn.html</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js的package.json]]></title>    <link>https://juejin.cn/post/7587023071067521076</link>    <guid>https://juejin.cn/post/7587023071067521076</guid>    <pubDate>2025-12-24T09:48:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587023071067521076" data-draft-id="7587256133790761000" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js的package.json"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-24T09:48:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="左Python右Java"/> <meta itemprop="url" content="https://juejin.cn/user/4107431173952525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js的package.json
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4107431173952525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    左Python右Java
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:48:33.000Z" title="Wed Dec 24 2025 09:48:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>package.json</code> 是 <strong>Node.js</strong> 和前端项目的核心配置文件，它是一个 <strong>JSON 格式</strong> 的文件，用来描述项目的元数据、依赖、脚本等信息。</p>
<p>下面我给你一个 <strong>完整示例</strong> 和 <strong>详细解析</strong>，方便你快速掌握。</p>
<hr/>
<h2 data-id="heading-0">1. 基本作用</h2>
<ul>
<li><strong>项目描述</strong>（名称、版本、作者等）</li>
<li><strong>依赖管理</strong>（生产依赖、开发依赖）</li>
<li><strong>脚本命令</strong>（<code>npm run xxx</code>）</li>
<li><strong>工具配置</strong>（如 ESLint、Babel、TypeScript 等）</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. 示例 <code>package.json</code></h2>
<pre><code class="hljs language-perl" lang="perl">Json
{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"my-node-app"</span>,                <span class="hljs-regexp">//</span> 项目名称（必须小写、无空格）
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,                   <span class="hljs-regexp">//</span> 版本号（遵循 semver 语义化版本）
  <span class="hljs-string">"description"</span>: <span class="hljs-string">"A sample Node.js app"</span>,<span class="hljs-regexp">//</span> 项目描述
  <span class="hljs-string">"main"</span>: <span class="hljs-string">"index.js"</span>,                   <span class="hljs-regexp">//</span> 入口文件
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"module"</span>,                     <span class="hljs-regexp">//</span> 模块类型: <span class="hljs-string">"commonjs"</span> 或 <span class="hljs-string">"module"</span> (ESM)
  <span class="hljs-string">"scripts"</span>: {                          <span class="hljs-regexp">//</span> npm 脚本命令
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"node index.js"</span>,
    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"nodemon index.js"</span>,
    <span class="hljs-string">"test"</span>: <span class="hljs-string">"node test.js"</span>
  },
  <span class="hljs-string">"keywords"</span>: [<span class="hljs-string">"node"</span>, <span class="hljs-string">"example"</span>],      <span class="hljs-regexp">//</span> 关键词（方便 npm 搜索）
  <span class="hljs-string">"author"</span>: <span class="hljs-string">"Your Name"</span>,                <span class="hljs-regexp">//</span> 作者
  <span class="hljs-string">"license"</span>: <span class="hljs-string">"MIT"</span>,                     <span class="hljs-regexp">//</span> 许可证
  <span class="hljs-string">"dependencies"</span>: {                     <span class="hljs-regexp">//</span> 生产依赖
    <span class="hljs-string">"express"</span>: <span class="hljs-string">"^4.18.2"</span>
  },
  <span class="hljs-string">"devDependencies"</span>: {                  <span class="hljs-regexp">//</span> 开发依赖
    <span class="hljs-string">"nodemon"</span>: <span class="hljs-string">"^3.0.1"</span>
  },
  <span class="hljs-string">"engines"</span>: {                           <span class="hljs-regexp">//</span> Node 版本要求
    <span class="hljs-string">"node"</span>: <span class="hljs-string">"&gt;=18.0.0"</span>
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-2">3. 常用字段说明</h2>





















































<table><thead><tr><th>字段</th><th>作用</th></tr></thead><tbody><tr><td><code>name</code></td><td>包名（npm 发布时使用）</td></tr><tr><td><code>version</code></td><td>版本号（语义化版本：主.次.补丁）</td></tr><tr><td><code>description</code></td><td>项目描述</td></tr><tr><td><code>main</code></td><td>入口文件（<code>require()</code> 默认加载）</td></tr><tr><td><code>type</code></td><td>模块类型（<code>commonjs</code> 或 <code>module</code>）</td></tr><tr><td><code>scripts</code></td><td>自定义命令（<code>npm run xxx</code>）</td></tr><tr><td><code>dependencies</code></td><td>生产环境依赖</td></tr><tr><td><code>devDependencies</code></td><td>开发环境依赖</td></tr><tr><td><code>peerDependencies</code></td><td>对等依赖（插件/库常用）</td></tr><tr><td><code>engines</code></td><td>指定 Node/npm 版本</td></tr><tr><td><code>license</code></td><td>开源协议</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-3">4. 常用命令</h2>
<pre><code class="hljs language-csharp" lang="csharp">Bash
<span class="hljs-meta"># 初始化 package.json</span>
npm <span class="hljs-keyword">init</span> -y

<span class="hljs-meta"># 安装生产依赖</span>
npm install express

<span class="hljs-meta"># 安装开发依赖</span>
npm install nodemon --save-dev

<span class="hljs-meta"># 运行脚本</span>
npm run start
npm run dev
</code></pre>
<hr/>
<h2 data-id="heading-4">5. 版本号规则（SemVer）</h2>
<ul>
<li><code>^1.2.3</code>：允许 <strong>次版本</strong> 和 <strong>补丁版本</strong> 更新（<code>1.x.x</code>）</li>
<li><code>~1.2.3</code>：允许 <strong>补丁版本</strong> 更新（<code>1.2.x</code>）</li>
<li><code>1.2.3</code>：固定版本</li>
<li><code>*</code>：任意版本（不推荐）</li>
</ul>
<hr/>
<p>如果你需要，我可以帮你写一个 <strong>最小可运行的 Node.js 项目</strong>，带 <code>package.json</code>、<code>index.js</code> 和 <code>npm scripts</code>，直接 <code>npm start</code> 就能跑。<br/>
你要我帮你做这个吗？这样你可以直接运行测试。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实测MiniMax M2.1之后，我们终于看懂了其招股书里的技术底气]]></title>    <link>https://juejin.cn/post/7587062584165744678</link>    <guid>https://juejin.cn/post/7587062584165744678</guid>    <pubDate>2025-12-24T09:49:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587062584165744678" data-draft-id="7587239837972447283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实测MiniMax M2.1之后，我们终于看懂了其招股书里的技术底气"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-24T09:49:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实测MiniMax M2.1之后，我们终于看懂了其招股书里的技术底气
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:49:52.000Z" title="Wed Dec 24 2025 09:49:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这两天，中国 AI 行业关注的核心无疑是 MiniMax。</p>
<p>12 月 21 日，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2651008283%26idx%3D1%26sn%3D3af861ba41b67370e75a305b8a20adea%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2651008283&amp;idx=1&amp;sn=3af861ba41b67370e75a305b8a20adea&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">MiniMax（稀宇科技）正式向港交所递交招股书</a>，披露的一连串数字瞬间引爆了舆论场：账上坐拥超 10 亿美元的现金储备，2025 年前九个月营收同比激增 174.7%，而在保持高强度研发的同时，经调整净亏损控制在 1.86 亿美元。</p>
<p>资本市场的喧嚣还没结束，23 日，MiniMax 又反手甩出了一张技术牌：正式上线 MiniMax M2.1 模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0b311858fb340a1b46d83396dfb8297~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174592&amp;x-signature=j6ycm3QI%2F7h7AGmKaTO%2BtefLFEo%3D" alt="图片" loading="lazy"/></p>
<p>这并非一次常规的版本迭代。根据官方披露的信息，M2.1 在 SWE-bench Multilingual 多语言评测中以 72.5% 的成绩拿下了 SOTA，超越了 Gemini 3 Pro 和 Claude Sonnet 4.5。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e08fc874552248e68c16e231b73c75e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174592&amp;x-signature=tv23JFBxSg26opL6fpAl2NUajO0%3D" alt="图片" loading="lazy"/></p>
<p>更重要的是，它不再局限于 Python 或前端代码的生成，而是向 Rust、Java、C++ 等更广泛的后端语言发起了进攻，试图解决过往模型「写得像但跑不通」、「缺乏工程感」的痛点。</p>
<p>同时，M2.1 大幅强化了原生 Android 和 iOS 的开发能力，打出了「Not only vibe WebDev, but also vibe AppDev」的口号。</p>
<p>不仅如此，为了给这种「从零到一」的全栈能力提供硬核支撑，MiniMax 还构建并开源了全新基准 VIBE（Visual &amp; Interactive Benchmark for Execution in Application Development）。不同于传统基准，VIBE 涵盖了 Web、仿真、Android、iOS 及后端五大核心子集，并引入创新的 Agent-as-a-Verifier (AaaV) 范式，能够自动评估生成的 Application 在真实运行环境中的交互逻辑与视觉美感。在这场「全栈构建」的终极测试中，M2.1 以平均 88.6 分的成绩展现了卓越实力，不仅在几乎所有子集上显著优于 Claude Sonnet 4.5，更逼近了 Claude Opus 4.5 的水准。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc17dd5bc33447db8f5df4a62169ccfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174592&amp;x-signature=hiyc3ReAdgUPe33qQf1%2FoIoXaKc%3D" alt="图片" loading="lazy"/></p>
<p>同时，凭借强大的交错思维与指令跟随能力，MiniMax M2.1 还能集成「复合指令约束」，从而可以更轻松地完成办公自动化任务。</p>
<p>更令开发者惊喜的是其落地的速度与广度：M2.1 第一时间就可无缝集成至 Claude Code、Cursor 等主流 AI 编程工具中。</p>
<p>配合更快的响应速度、更简洁的思维链以及大幅降低的 token 消耗，它显然是有备而来，意在直接切入开发者的核心工作流。</p>
<p>这种「今天秀肌肉，明天亮技术」的节奏显然不是巧合。在外界还在争论一家成立刚四年的公司为何能跑出如此惊人的 IPO 速度时，MiniMax M2.1 的发布则是一种有力的回应：它试图用模型的迭代速度，来诠释招股书里高效研发的数字指标，以及为何这家公司值得众多明星投资人的信任与多轮投资。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90a88e30710045f996b1c2a84d5c1bf8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174592&amp;x-signature=rzWsSZUtc1VUWRjSE6Cwk7JwOVU%3D" alt="图片" loading="lazy"/></p>
<p>作为一家长期关注 AI 技术的媒体，在这一波喧嚣过后的 48 小时里，我们拿到 M2.1 的接口，把它扔进了开发环境中，用真实的任务对其进行了考验。</p>
<p>毕竟，招股书是给投资人看的面子，而模型能力才是开发者真金白银投票的里子。这份体验报告或可成为洞见这家公司真实技术底蕴的切口。</p>
<p>实测：从偏科到全能</p>
<p>在过去很长一段时间里，MiniMax 给开发者的印象往往带着鲜明的标签：它的语音合成极其逼真，视频生成的表现力备受赞誉（海螺），角色扮演能力也在 C 端应用（如星野）中大放异彩。如果说大模型班级里有特长生，那么 MiniMax 以前更像是一个极具天赋的文科生或艺术生。</p>
<p>然而，要支撑起招股书中描绘的 AGI 蓝图，光有情商可不够。在企业级应用和复杂的生产力场景中，推理能力和模型使用工具的能力才是检验模型智商的硬通货。此前，必须承认的是，作为开源模型，M2 与 Claude Sonnet 4.5 或 GPT-5 (thinking) 等国际顶尖模型相比，在部分任务上确实还差点意思。</p>
<p>这也正是 M2.1 发布的战略意义所在：一次针对性的进化。</p>
<p>为了验证 M2.1 是否真的补齐了编程这块短板，我们决定跳过那些基础的「写首藏头诗」或「画个贪吃蛇」，直接将它置于真实的开发者视角下，以了解其在代码重构、复杂逻辑规划等方面的真实表现。</p>
<p>首先来一个相对简单的任务：虾仁模拟器，看看我们能否在自己的电脑上扮演这位历经无数世界的穿越者。首先，构建一个简单的提示词：</p>
<blockquote>
<p>我想构建一个虾仁模拟器小游戏，核心主题是：你是虾仁，你又穿越了。游戏内容是主角虾仁穿越到不同的朝代或者世界（比如丧尸世界、修仙世界、赛博世界），游戏后台使用 AI: MiniMax-M2.1。请先规划这个项目，让我选择游戏方式和技术栈等，并将任务规划放入 task.md 文件。</p>
</blockquote>
<p>在 Claude Code 配置好 MiniMax M2.1 之后，直接输入提示词开始构建！</p>
<p>4 倍速视频（以下视频都是 4 倍速）</p>
<p>整个过程耗时不到 6 分钟。给这个小游戏配置好 API，来初步试试效果：</p>
<p>命令行的界面玩起来总归是不方便，也不美丽，接下来我们继续推进，让 MiniMax M2.1 开发一个直观好看的 UI。</p>
<p>给这个游戏开发一个漂亮的网页 UI，整体使用像素风格，使用莫兰迪色系配色。使用 JavaScript。支持深色和浅色模式切换。界面上加一个随机穿越的按钮。</p>
<p>这下，效果好多了。MiniMax M2.1 的审美着实在线！</p>
<p>你甚至能一句话就创建出一个炫酷的个人主页：</p>
<p>MiniMax M2.1 为漫威超级英雄黑寡妇创建的个人主页</p>
<p>接下来，我们大幅提升任务难题，来考验一下 MiniMax M2.1 的多语言编程能力。我们构想一个较为复杂的任务，并在 AI 的辅助下撰写了一个提示词：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/542fc01e6eef41509f34b05d825626a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174592&amp;x-signature=jttNmbzjiBeYImYzTZ5g3vfIdIA%3D" alt="图片" loading="lazy"/></p>
<p>然后我们将其放入任务文件夹的「任务.md」文件中，直接给出执行指令：</p>
<blockquote>
<p>读取文件夹中的任务.md 文件并实现这个项目。</p>
</blockquote>
<p>这个任务的难度较大，MiniMax M2.1 并没有一蹴而就，但整个过程非常接近真实的开发体验。在与其进行多轮互动后，它最终交出了一份令人满意的答卷。</p>
<p>值得一提的是，在这个过程中我们遇到了多次报错，例如 crates.io 镜像源问题导致无法下载组件、Go 语言中 % 运算符不能用于 float64 而需改用 math.Mod () 函数等。</p>
<p>令人惊喜的是，这些问题并没有成为阻碍。我们只需将报错信息直接反馈给 MiniMax M2.1，它就能迅速理解上下文，自动完成修复工作，并编写了各个模块的单元测试。</p>
<p>最后，我们继续让 MiniMax M2.1 将这三个使用不同语言编写的模块连接了起来。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35bab9aeec7148a2b41100113bd74331~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174592&amp;x-signature=byoauEpWS3Us%2F0S43L2kIkCCZNY%3D" alt="图片" loading="lazy"/></p>
<p>最终，我们得到了这样一个系统：</p>
<p>左侧为 React 前端，右上为 Go 语言写的网关，右下为 Rust 写的核心程序</p>
<p>我们还进行了其它一些实测，包括将多年前的 C++ 游戏库重构为 Python 版本、修改了一个 Obsidian 插件、一个辅助发推文的小工具以及一个「技能吃豆人」小游戏。</p>
<p>技能吃豆人增加了技能豆，吃下后可以获得技能，比如这里的穿墙能力</p>
<p>这些实测证明，MiniMax M2.1 不仅能写代码，更能像一个成熟的工程师一样解决问题。</p>
<p>技术与商业的互文</p>
<p>当我们把视线从 IDE 编辑器的代码窗口移开，重新审视那份数百页的招股书时，会发现 M2.1 的发布其实是解读 MiniMax 商业逻辑的一把关键钥匙。</p>
<p>在外界看来，或许招股书是财务数字的游戏，而模型发布是技术圈的狂欢。但在 MiniMax 这里，两者构成了紧密的互文关系。</p>
<p>研发杠杆率：打破「烧钱换增长」的魔咒</p>
<p>招股书中有一个容易被忽视但极具含金量的数据对比：2025 年前九个月，MiniMax 的营收同比增长了 174.7%，但同期研发费用仅增长了约 30%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/904c138d6d264aabb7310f080cbca181~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174592&amp;x-signature=9Hjy%2F5Bil33b1MHhHcny3WPV9pQ%3D" alt="图片" loading="lazy"/></p>
<p>这个显著的「剪刀差」修正了外界对于大模型公司「研发无底洞」的刻板印象。它揭示了一个关键事实：MiniMax 已经跑通了高效的研发模式。</p>
<p>这意味着，公司不再需要线性地堆砌人力和算力资源来换取模型能力的提升。M2.1 的诞生就是最好的佐证：在研发投入增速远低于营收增速的前提下，MiniMax 依然保持了极高的迭代频率，在短时间内填补了代码和逻辑推理的短板。对于二级市场投资者而言，这种不随营收规模同比例膨胀的研发成本结构，是验证其商业模式可扩展性（Scalability）的最强证据。</p>
<p>从聊天机器人到智能体：MiniMax 的生产力雄心</p>
<p>MiniMax 在招股书中强调了其在 C 端应用（如星野、海螺 AI）上的统治力。然而，要撑起千亿级的市场想象空间，仅靠聊天是不够的。M2.1 补齐逻辑和代码短板，真正的雄心在于对 B 端生产力场景的渗透。</p>
<p>行业内对于 Agent 能力的评估标准，正在从简单的对话测试转向更为严苛的基准，例如 Toolathon。这是一个包含 32 个专业软件（如 Kubernetes、BigQuery）、600 多个工具的第三方高难度评测，要求模型在平均 20 轮的交互中完成复杂的长程任务。</p>
<p>M2.1 对代码解释器和工具调用能力的强化，正是为了应对这种真实世界复杂度。当一个模型能够熟练操作 Docker 容器、管理日历并自动处理电商订单时，它就从一个 C 端的玩具进化成了 B 端的员工。这种能力的跃升，将直接拓宽 MiniMax 开放平台的客户半径，使其能够承接企业级工作流的自动化需求。</p>
<p>商业闭环的最后一公里</p>
<p>至此，MiniMax 的商业逻辑形成了闭环：</p>
<ul>
<li>
<p>C 端产品（星野、海螺）作为数据飞轮和现金牛，提供高用户粘性和直接收入；</p>
</li>
<li>
<p>底层模型（M2.1）通过 MoE 架构控制推理成本，通过技术补全提升智商上限；</p>
</li>
<li>
<p>开放平台基于 M2.1 的 Agent 和多模态能力，切入高价值的企业级市场。</p>
</li>
</ul>
<p>现在的 MiniMax 已左手是资本市场的入场券（招股书），右手是技术战场的冲锋号（M2.1）。</p>
<p>对该公司而言，IPO 是通过技术转化为生产力的新起点。M2.1 的发布证明了，这家公司在叩响港交所大门的同时，依然保持着对技术边界的极致探索。这种「左手账本，右手模型」的双轮驱动，或许正是它能在短短四年内跑通商业闭环的秘密所在。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[没有千卡GPU，如何从0到1构建可用LLM？nanoChat 全栈实践首次公开]]></title>    <link>https://juejin.cn/post/7587062584165154854</link>    <guid>https://juejin.cn/post/7587062584165154854</guid>    <pubDate>2025-12-24T08:49:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587062584165154854" data-draft-id="7586983243926814758" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="没有千卡GPU，如何从0到1构建可用LLM？nanoChat 全栈实践首次公开"/> <meta itemprop="keywords" content="开源,人工智能"/> <meta itemprop="datePublished" content="2025-12-24T08:49:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大厂技术总监下海"/> <meta itemprop="url" content="https://juejin.cn/user/4091714106833577"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            没有千卡GPU，如何从0到1构建可用LLM？nanoChat 全栈实践首次公开
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4091714106833577/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大厂技术总监下海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T08:49:14.000Z" title="Wed Dec 24 2025 08:49:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">nanochat 技术深度解析：低成本全栈 LLM 实现的架构与工程实践</h2>
<h3 data-id="heading-1">1. 整体介绍</h3>
<h4 data-id="heading-2">1.1 项目概览与现状</h4>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkarpathy%2Fnanochat" target="_blank" title="https://github.com/karpathy/nanochat" ref="nofollow noopener noreferrer">github.com/karpathy/na…</a> (截至分析时，项目处于活跃开发初期，社区关注度正在增长，其前身 <code>nanoGPT</code> 已有超 40k stars，预示着该项目的潜在影响力)。</p>
<p><strong>项目定位</strong>：一个单一、简洁、最小化、可高度定制且依赖极少的代码库，旨在完整实现类似 ChatGPT 的大型语言模型 (LLM)，覆盖从数据准备、训练、评估到部署服务的全流程。</p>
<p><strong>核心宣言</strong>：“100 美元能买到的最好的 ChatGPT”。这直观地概括了其设计哲学：在严格受限的计算预算下，提供一个可运行、可理解、可修改的 LLM 全栈基线。</p>
<h4 data-id="heading-3">1.2 核心功能与操作</h4>
<p>项目通过一个名为 <code>speedrun.sh</code> 的主脚本串联所有流程。用户在一个配备 8 张 H100 GPU 的节点上（市场价约 24 美元/小时），执行该脚本约 4 小时后，即可获得一个约 5.61 亿参数（d20 配置）的对话模型，并可通过内置的 Web UI 进行交互。</p>
<p><strong>项目截图示意</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d037f97739745dd9187f4ea1615e232~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5Y6C5oqA5pyv5oC755uR5LiL5rW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767170954&amp;x-signature=PT0I4nLC1YsX%2BmI60mM57sf085U%3D" alt="nanochat.png" loading="lazy"/>
<em>用户可通过类似 ChatGPT 的界面与自行训练的模型对话。</em></p>
<h4 data-id="heading-4">1.3 面临问题与目标人群</h4>
<p><strong>解决的问题要素</strong>：</p>
<ol>
<li><strong>认知与工程复杂性</strong>：现代主流 LLM 框架（如 Hugging Face Transformers）为了通用性，引入了庞大的配置系统和抽象层，对于希望<strong>从头理解并掌控全流程</strong>的学习者、研究者或小型团队而言，构成了较高的入门门槛。</li>
<li><strong>经济成本门槛</strong>：训练一个性能尚可的 LLM 通常需要数万至数百万美元的计算资源，将绝大多数个人和中小型团队拒之门外。</li>
<li><strong>“黑箱”与定制化困难</strong>：使用预训练 API 或微调大型模型，用户难以深入模型内部，注入特定知识、风格或能力的过程复杂且不透明。</li>
</ol>
<p><strong>目标场景与人群</strong>：</p>
<ul>
<li><strong>教育与研究</strong>：作为教学工具（如配套课程 LLM101n），帮助学生直观理解 LLM 训练的每个环节。</li>
<li><strong>快速原型与实验</strong>：研究者需要在有限预算下验证新的训练算法、架构修改或数据策略。</li>
<li><strong>个性化模型定制</strong>：开发者希望完全拥有并控制一个具备特定身份、语调或专业领域知识的轻量级对话代理。</li>
</ul>
<h4 data-id="heading-5">1.4 解决方案与优势对比</h4>
<p><strong>传统/现有方案</strong>：</p>
<ol>
<li><strong>使用大型框架</strong>：功能全面但代码库庞大，依赖复杂，核心训练循环被多层封装。</li>
<li><strong>依赖云 API</strong>：成本不可控，无法定制内部机制，存在数据隐私和供应商锁定风险。</li>
<li><strong>微调超大基座模型</strong>：即使使用 LoRA 等技术，仍需支付高额的基座模型推理和微调成本，且无法修改模型架构。</li>
</ol>
<p><strong>nanochat 的新方式</strong>：</p>
<ol>
<li><strong>一体化端到端</strong>：从原始文本数据到可交互的 Web 服务，所有代码均在一个约 330KB 的代码库中，逻辑线性，易于跟踪。</li>
<li><strong>成本精确透明</strong>：脚本直接关联云计算实例价格，训练时长、FLOPs、参数量与最终成本的关系清晰可计算。</li>
<li><strong>最大化可读性与可黑客性</strong>：代码风格极简，避免不必要的抽象，鼓励用户直接修改任何部分。例如，调整模型深度仅需修改 <code>--depth</code> 参数。</li>
</ol>
<p><strong>核心优势</strong>：在牺牲了前沿模型规模与性能上限的前提下，换来了前所未有的<strong>透明度、可控性和学习友好性</strong>。</p>
<h4 data-id="heading-6">1.5 商业价值预估</h4>
<p>价值估算可从 <strong>“替代成本”</strong> 和 <strong>“教育/实验效率提升”</strong> 两个维度分析：</p>
<ol>
<li>
<p><strong>代码与工程成本替代</strong>：构建一个同等完整度（含分词器训练、多阶段训练、评估基准、Web服务）的 LLM 训练管线，需要一个高级工程师团队数月的开发时间。nanochat 提供了经过验证的、可直接部署的替代品。按人均成本估算，此项可替代数十万人民币的研发投入。</p>
</li>
<li>
<p><strong>计算成本与问题空间覆盖</strong>：</p>
<ul>
<li><strong>基线</strong>：100 美元方案（d20，~560M 参数，4小时）在 GSM8K 数学基准上得分约 2.5%，性能相当于一个“幼稚的儿童”，但已能完成简单的对话和文本生成。其价值在于<strong>快速验证流程的可行性</strong>。</li>
<li><strong>进阶</strong>：1000 美元方案（预估，~41.6小时）目标性能接近或超越 GPT-2 (2019)。对于一个希望拥有私有化、可完全定制化对话模型的小型企业或垂直应用，这提供了一个明确的性能与成本基准。相比于持续支付 API 调用费用或租赁大型模型，一次性的千美元级投入在长期可能更具经济性。</li>
<li><strong>覆盖问题空间</strong>：项目通过 <code>tasks/</code> 目录下的多个评估任务（ARC, MMLU, GSM8K, HumanEval 等）定义了其优化的“问题空间”——即通用语言理解、推理和基础代码能力。它证明了在此问题空间内，千美元量级投入可获得具有基础实用性的模型。</li>
</ul>
</li>
</ol>
<p><strong>生成逻辑</strong>：价值并非源于其模型的绝对性能（目前远不及 GPT-4/Claude 等），而是源于它<strong>显著降低了进入“全栈 LLM 研发”领域的综合门槛</strong>（金钱、时间、认知）。它为原型验证、教育、特定轻量级应用提供了一个经济、高效的新起点。</p>
<h3 data-id="heading-7">2. 详细功能拆解（产品+技术视角）</h3>








































<table><thead><tr><th align="left">功能模块</th><th align="left">产品视角（用户价值）</th><th align="left">技术视角（核心设计）</th></tr></thead><tbody><tr><td align="left"><strong>“一键式”训练管线 (<code>speedrun.sh</code>)</strong></td><td align="left">屏蔽分布式训练、数据下载、阶段衔接的复杂性，提供开箱即用的体验。</td><td align="left">使用 Bash 脚本编排 Python 训练脚本，管理后台进程，传递环境变量。关键环节：数据并行(<code>torchrun</code>)、梯度累积、检查点管理。</td></tr><tr><td align="left"><strong>多阶段训练流程</strong></td><td align="left">模拟工业化 LLM 训练流程（预训练 -&gt; 中间训练 -&gt; 有监督微调 -&gt; 强化学习），让用户理解各阶段作用。</td><td align="left">1. <strong>Base Train</strong>：在大量无标签文本上进行自回归预训练。<br/>2. <strong>Mid Train</strong>：注入对话格式、工具调用等特殊令牌，进行多任务学习。<br/>3. <strong>SFT</strong>：在高质量对话数据上进行序列级指令微调。<br/>4. <strong>RL</strong>（可选）：在 GSM8K 任务上进行拒绝采样与强化学习优化。</td></tr><tr><td align="left"><strong>可定制身份/能力</strong></td><td align="left">允许用户通过数据“塑造”模型的性格或为其添加新技能（如计算字母‘r’的数量）。</td><td align="left">提供 <code>dev/gen_synthetic_data.py</code> 等模板，指导用户生成特定格式的合成数据（JSONL），并将其混入 Mid-training 或 SFT 的数据集中。技术核心在于数据混合策略。</td></tr><tr><td align="left"><strong>内置评估与报告</strong></td><td align="left">训练结束后自动生成“成绩单”，让用户对模型能力有量化、多角度的认识。</td><td align="left">在 <code>tasks/</code> 下实现多个标准评测集的数据加载和指标计算。<code>report.py</code> 模块自动收集各阶段日志，合成最终的 <code>report.md</code>。</td></tr><tr><td align="left"><strong>高效推理引擎 (<code>engine.py</code>)</strong></td><td align="left">提供流畅的对话体验，并支持模型调用“计算器”工具。</td><td align="left">实现 <strong>KV 缓存 (KVCache)</strong> 管理，支持流式生成和批量生成。集成简单的 Python 表达式安全评估器，实现工具调用逻辑。</td></tr><tr><td align="left"><strong>最小化依赖与部署</strong></td><td align="left">简化环境配置，支持从多 GPU 服务器到 Mac MPS/CPU 的多种运行环境。</td><td align="left">使用 <code>uv</code> 管理 Python 依赖和虚拟环境。<code>pyproject.toml</code> 中配置了 CPU/GPU 版本的 Torch 索引。模型代码自动检测设备类型。</td></tr></tbody></table>
<h3 data-id="heading-8">3. 技术难点与核心创新因子</h3>
<ol>
<li><strong>在极小内存预算下的模型配置</strong>：如何在 8xH100（每卡 80GB）上高效训练 5.6 亿参数模型？解决方案包括：使用<strong>混合优化器</strong>（对嵌入层和输出层使用 AdamW，对 Transformer 矩阵使用 Muon）、<strong>激活 checkpointing</strong>、<strong>梯度累积</strong>，以及将<strong>词表大小填充至 64 的倍数</strong>以优化分布式矩阵计算效率。</li>
<li><strong>端到端管线的健壮性与自动化</strong>：如何确保数小时的无监督脚本运行不因网络、数据或硬件问题中断？通过详尽的错误检查、数据下载重试机制、检查点保存与恢复，以及将中间状态记录到结构化报告中来应对。</li>
<li><strong>低成本下的模型质量</strong>：如何在有限数据和计算下获得尽可能好的性能？采用经过简化和调优的 <strong>Transformer 架构</strong>（如 RoPE, QK Norm, ReLU² 激活），并遵循 <strong>Chinchilla 缩放法则</strong>（约 20 倍参数数的训练令牌数）来分配计算预算。</li>
<li><strong>推理效率与工具使用的集成</strong>：如何在资源有限的环境下实现快速响应和工具调用？自研轻量级 <code>Engine</code> 类，管理 KV 缓存的动态增长，并将工具调用（如计算器）作为一个由特殊令牌触发的确定性子流程来执行，而非依赖模型生成函数调用字符串。</li>
</ol>
<h3 data-id="heading-9">4. 详细设计图</h3>
<h4 data-id="heading-10">4.1 核心架构图</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf681ca0df0f4f3998323e053ecfc312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5Y6C5oqA5pyv5oC755uR5LiL5rW3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767170954&amp;x-signature=7VClHLjXXVVRSMB68Nmb%2Fol6ebM%3D" alt="deepseek_mermaid_20251224_d2e523.png" loading="lazy"/></p>
<h4 data-id="heading-11">4.2 核心训练链路序列图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User
    participant SpeedrunSh
    participant Dataset
    participant Tokenizer
    participant BaseTrain
    participant MidTrain
    participant ChatEval
    participant Report

    User-&gt;&gt;SpeedrunSh: bash speedrun.sh
    SpeedrunSh-&gt;&gt;Dataset: 下载数据分片
    SpeedrunSh-&gt;&gt;Tokenizer: 训练 BPE 分词器
    SpeedrunSh-&gt;&gt;BaseTrain: 启动分布式预训练
    BaseTrain-&gt;&gt;Report: 记录损失/CORE分数
    SpeedrunSh-&gt;&gt;MidTrain: 启动中间训练
    MidTrain-&gt;&gt;ChatEval: 评估多任务性能
    ChatEval-&gt;&gt;Report: 记录 ARC/MMLU 等分数
    SpeedrunSh-&gt;&gt;Report: 汇总生成 report.md
    Report--&gt;&gt;User: 输出最终报告
</code></pre>
<h4 data-id="heading-12">4.3 核心类图 (GPT 模型)</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class GPTConfig {
        +int sequence_len
        +int vocab_size
        +int n_layer
        +int n_head
        +int n_kv_head
        +int n_embd
    }
    
    class GPT {
        -GPTConfig config
        -ModuleDict transformer
        -Linear lm_head
        +Tensor cos
        +Tensor sin
        +init_weights()
        +setup_optimizers()
        +forward(idx, targets, kv_cache)
        +generate(tokens, max_tokens, ...)
    }
    
    class Block {
        +CausalSelfAttention attn
        +MLP mlp
        +forward(x, cos_sin, kv_cache)
    }
    
    class CausalSelfAttention {
        -int n_head
        -int n_kv_head
        -Linear c_q, c_k, c_v, c_proj
        +forward(x, cos_sin, kv_cache)
    }
    
    class MLP {
        -Linear c_fc
        -Linear c_proj
        +forward(x)
    }
    
    class KVCache {
        -Tensor kv_cache
        -int pos
        +reset()
        +get_pos()
        +prefill(other)
        +insert_kv(layer_idx, k, v)
    }
    
    GPT *-- GPTConfig
    GPT o-- Block
    Block *-- CausalSelfAttention
    Block *-- MLP
    GPT ..&gt; KVCache : 在forward中使用
</code></pre>
<h4 data-id="heading-13">4.4 核心函数（Engine.generate）拆解流程图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    Start[Engine.generate 调用] --&gt; A[输入提示 tokens 和参数]
    A --&gt; B{是否为首次迭代?}
    
    B -- 是 --&gt; C[执行 Batch=1 预填充]
    C --&gt; D[初始化主 KV Cache 并复制]
    D --&gt; E[为所有行采样首个令牌]
    
    B -- 否 --&gt; F[使用当前 ids 前向传播]
    F --&gt; G[采样下一令牌]
    
    E --&gt; H[遍历所有行状态]
    G --&gt; H
    
    subgraph H[处理每行状态机]
        I{是否有强制令牌?}
        I -- 是 --&gt; J[取出强制令牌]
        I -- 否 --&gt; K[使用采样令牌]
        J --&gt; L[更新当前令牌序列]
        K --&gt; L
        L --&gt; M{是否为特殊令牌?}
        M -- 是 Python_Start --&gt; N[标记进入代码块]
        M -- 是 Python_End --&gt; O[执行代码并强制输出结果]
        M -- 是 Assistant_End/BOS --&gt; P[标记行完成]
        M -- 否 --&gt; Q[若在代码块则收集令牌]
    end
    
    H --&gt; R[收集本轮的令牌列和掩码]
    R --&gt; S[yield 令牌列和掩码]
    S --&gt; T{达到停止条件?}
    T -- 否 --&gt; F
    T -- 是 --&gt; End[结束生成]
</code></pre>
<h3 data-id="heading-14">5. 核心函数与代码解析</h3>
<h4 data-id="heading-15">5.1 GPT 模型的前向传播 (<code>gpt.py</code>)</h4>
<p>这是模型计算的核心，集成了训练和推理两种模式。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, idx, targets=<span class="hljs-literal">None</span>, kv_cache=<span class="hljs-literal">None</span>, loss_reduction=<span class="hljs-string">'mean'</span></span>):
    B, T = idx.size()
    <span class="hljs-comment"># 1. 处理 Rotary 位置编码</span>
    T0 = <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> kv_cache <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> kv_cache.get_pos()  <span class="hljs-comment"># KV缓存偏移量</span>
    cos_sin = self.cos[:, T0:T0+T], self.sin[:, T0:T0+T]
    
    <span class="hljs-comment"># 2. 通过嵌入层和层归一化</span>
    x = self.transformer.wte(idx)
    x = norm(x)  <span class="hljs-comment"># RMSNorm</span>
    
    <span class="hljs-comment"># 3. 逐层通过 Transformer Block</span>
    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> self.transformer.h:
        x = block(x, cos_sin, kv_cache)  <span class="hljs-comment"># 传入kv_cache用于推理时缓存</span>
    
    <span class="hljs-comment"># 4. 最终层归一化</span>
    x = norm(x)
    
    <span class="hljs-comment"># 5. 计算 logits (词汇表概率分布)</span>
    logits = self.lm_head(x)
    logits = logits[..., :self.config.vocab_size]  <span class="hljs-comment"># 移除填充部分</span>
    logits = logits.<span class="hljs-built_in">float</span>()  <span class="hljs-comment"># 转为fp32以稳定计算</span>
    logits = softcap * torch.tanh(logits / softcap)  <span class="hljs-comment"># 平滑限制logits值域</span>
    
    <span class="hljs-comment"># 6. 根据模式返回损失或logits</span>
    <span class="hljs-keyword">if</span> targets <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
        loss = F.cross_entropy(logits.view(-<span class="hljs-number">1</span>, logits.size(-<span class="hljs-number">1</span>)), 
                               targets.view(-<span class="hljs-number">1</span>), 
                               ignore_index=-<span class="hljs-number">1</span>, 
                               reduction=loss_reduction)
        <span class="hljs-keyword">return</span> loss
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> logits
</code></pre>
<p><strong>技术要点</strong>：</p>
<ul>
<li><strong>RoPE 动态应用</strong>：根据当前序列位置 <code>T0</code> 切片预计算的旋转矩阵，支持长文本生成。</li>
<li><strong>KV 缓存集成</strong>：<code>kv_cache</code> 参数在推理时非空，<code>block</code> 内部会调用 <code>kv_cache.insert_kv()</code> 来存储并复用已计算的 K, V 矩阵。</li>
<li><strong>Logits 平滑限制</strong>：使用双曲正切函数将 logits 限制在 <code>[-softcap, softcap]</code> 之间，防止训练不稳定。</li>
</ul>
<h4 data-id="heading-16">5.2 KV 缓存管理 (<code>engine.py</code>)</h4>
<p>这是实现高效自回归推理的关键。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">KVCache</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">insert_kv</span>(<span class="hljs-params">self, layer_idx, k, v</span>):
        <span class="hljs-keyword">if</span> self.kv_cache <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-comment"># 延迟初始化：根据第一次传入的k,v确定dtype/device</span>
            self.kv_cache = torch.empty(self.kv_shape, dtype=k.dtype, device=k.device)
        
        t0, t1 = self.pos, self.pos + k.size(<span class="hljs-number">2</span>)  <span class="hljs-comment"># 新KV的起止位置</span>
        
        <span class="hljs-comment"># 动态扩展缓存空间（如果不够）</span>
        <span class="hljs-keyword">if</span> t1 &gt; self.kv_cache.size(<span class="hljs-number">4</span>):
            t_needed = t1 + <span class="hljs-number">1024</span>
            t_needed = (t_needed + <span class="hljs-number">1023</span>) &amp; ~<span class="hljs-number">1023</span>  <span class="hljs-comment"># 向上对齐到1024的倍数</span>
            <span class="hljs-comment"># ... 分配新内存并拼接</span>
            
        <span class="hljs-comment"># 将新的k, v存入缓存</span>
        self.kv_cache[layer_idx, <span class="hljs-number">0</span>, :, :, t0:t1, :] = k
        self.kv_cache[layer_idx, <span class="hljs-number">1</span>, :, :, t0:t1, :] = v
        
        <span class="hljs-comment"># 返回截至当前时刻的完整K,V视图</span>
        key_view = self.kv_cache[layer_idx, <span class="hljs-number">0</span>, :, :, :t1, :]
        value_view = self.kv_cache[layer_idx, <span class="hljs-number">1</span>, :, :, :t1, :]
        
        <span class="hljs-comment"># 如果是最后一层，更新缓存位置指针</span>
        <span class="hljs-keyword">if</span> layer_idx == self.kv_cache.size(<span class="hljs-number">0</span>) - <span class="hljs-number">1</span>:
            self.pos = t1
            
        <span class="hljs-keyword">return</span> key_view, value_view
</code></pre>
<p><strong>设计精妙之处</strong>：</p>
<ol>
<li><strong>延迟初始化</strong>：避免在未进行推理前分配大量 GPU 内存。</li>
<li><strong>动态增长</strong>：缓存长度按需扩展，每次增加约 1024 个令牌的容量，并以 1024 为边界对齐，可能有利于内存访问效率。</li>
<li><strong>返回视图</strong>：返回的是缓存张量的一个切片视图，而非拷贝，节省内存和计算。</li>
</ol>
<h4 data-id="heading-17">5.3 混合优化器设置 (<code>gpt.py</code>)</h4>
<p>针对模型不同部分使用不同的优化策略，以在有限内存下取得更好效果。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_optimizers</span>(<span class="hljs-params">self, unembedding_lr=<span class="hljs-number">0.004</span>, embedding_lr=<span class="hljs-number">0.2</span>, matrix_lr=<span class="hljs-number">0.02</span></span>):
    <span class="hljs-comment"># 1. 参数分组</span>
    matrix_params = <span class="hljs-built_in">list</span>(self.transformer.h.parameters())  <span class="hljs-comment"># 所有Transformer层的线性权重</span>
    embedding_params = <span class="hljs-built_in">list</span>(self.transformer.wte.parameters())  <span class="hljs-comment"># 词嵌入矩阵</span>
    lm_head_params = <span class="hljs-built_in">list</span>(self.lm_head.parameters())  <span class="hljs-comment"># 输出层权重</span>
    
    <span class="hljs-comment"># 2. 为AdamW参数组（嵌入和输出层）计算学习率缩放因子</span>
    dmodel_lr_scale = (self.config.n_embd / <span class="hljs-number">768</span>) ** -<span class="hljs-number">0.5</span>  <span class="hljs-comment"># 与模型维度平方根成反比</span>
    
    <span class="hljs-comment"># 3. 创建 AdamW 优化器（用于嵌入和输出层）</span>
    adam_groups = [
        <span class="hljs-built_in">dict</span>(params=lm_head_params, lr=unembedding_lr * dmodel_lr_scale),
        <span class="hljs-built_in">dict</span>(params=embedding_params, lr=embedding_lr * dmodel_lr_scale),
    ]
    adamw_optimizer = DistAdamW(adam_groups, betas=(<span class="hljs-number">0.8</span>, <span class="hljs-number">0.95</span>), eps=<span class="hljs-number">1e-10</span>)
    
    <span class="hljs-comment"># 4. 创建 Muon 优化器（用于主要的 Transformer 矩阵）</span>
    muon_optimizer = DistMuon(matrix_params, lr=matrix_lr, momentum=<span class="hljs-number">0.95</span>)
    
    <span class="hljs-comment"># 5. 返回优化器列表，训练循环将依次更新</span>
    <span class="hljs-keyword">return</span> [adamw_optimizer, muon_optimizer]
</code></pre>
<p><strong>策略解读</strong>：</p>
<ul>
<li><strong>分离优化器</strong>：<code>Muon</code> 是一种类似 SGD 的轻量级优化器，可能比 AdamW 占用更少的显存（不存储动量和方差），适用于参数最多的矩阵部分。</li>
<li><strong>差异化的学习率</strong>：词嵌入和输出层通常需要更大的学习率。此处的缩放因子 <code>(d_model/768)**-0.5</code> 是一种经验性调整，旨在使学习率适应不同的模型宽度。</li>
</ul>
<h3 data-id="heading-18">总结</h3>
<p>nanochat 是一个极具特色的工程项目，其技术价值不在于追求最先进的性能，而在于<strong>精心设计和实现了一条从零到对话的、低成本的、透明的 LLM 生产路径</strong>。通过对计算资源的极致规划、对代码复杂度的严格控制以及对教育目标的坚定聚焦，它为想要深入理解 LLM 内部机制的研究者和开发者提供了一个近乎理想的“沙盒”。</p>
<p>从架构上看，其一体化脚本、模块化训练阶段、自包含评估系统以及高效推理引擎，共同构成了一套闭环。从代码实现上，它对 RoPE、GQA、KV Cache、混合优化等现代技巧的应用，既保证了基线模型的竞争力，又保持了代码的整洁性。</p>
<p>当然，它目前适用于实验、教育和特定轻量级应用场景，而非替代大规模生产模型。但其体现的“在约束下创新”的工程思想，以及对 LLM 技术民主化的推动，值得所有对 AI 系统构建感兴趣的技术人员深入研究和借鉴。随着项目的持续演进，它有望成为开源 LLM 全栈开发中的一个重要参考基准。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我为AI加上了海王专属skill❤️，助力平安夜🍎成功🎄]]></title>    <link>https://juejin.cn/post/7587028972246941731</link>    <guid>https://juejin.cn/post/7587028972246941731</guid>    <pubDate>2025-12-24T09:52:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587028972246941731" data-draft-id="7587284708944035874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我为AI加上了海王专属skill❤️，助力平安夜🍎成功🎄"/> <meta itemprop="keywords" content="AI编程,AIGC,Claude"/> <meta itemprop="datePublished" content="2025-12-24T09:52:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小酒星小杜"/> <meta itemprop="url" content="https://juejin.cn/user/1512542215093479"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我为AI加上了海王专属skill❤️，助力平安夜🍎成功🎄
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1512542215093479/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小酒星小杜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:52:17.000Z" title="Wed Dec 24 2025 09:52:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><h2 data-id="heading-0">序章</h2>
<p>“Pentakill” ！！！，幽暗的房间内容，发出了英雄联盟五杀的声音。</p>
<p>“五杀就是这么简单”。骚年理了理帅气的刘海，这是他今天第20次拿五杀了。</p>
<p>“今天平安夜,又当单身狗啊”，骚年看着朋友的发来的微信，满脸写着不屑。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/288441bc610b4ab4921dc9192b01a393~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6YWS5pif5bCP5p2c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174737&amp;x-signature=vO9qIHW6oM%2FGoqADSxLL5TPfSdk%3D" alt="狗00018-微笑.jpg" loading="lazy"/></p>
<p>骚年不屑的原因是，他上次看到一个新闻，一个小伙子通过AI同时和20个女朋友约会，他觉得以自己的帅气🤵，用AI去勾搭，马上就能脱单。</p>
<h2 data-id="heading-1">skill～～～skr～～～</h2>
<p>他发现最近一个AI特别火的词，<strong>skill</strong>，他觉得和他经常拿的“Pentakill”很像，他觉得利用这个能力，帮AI更好的协助他成功脱单。</p>
<p>什么是skill？直接翻译就是技能的意思，实际上也是技能的意思。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfd70c3f09b442a1af0579e691e7640e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6YWS5pif5bCP5p2c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174737&amp;x-signature=QHmEjOu5W83hukd42va%2FmpI9qDA%3D" alt="狗00031-好了你不要再说了.jpg" loading="lazy"/></p>
<p>在当前的AI大模型中，其实它们内部都拥有的自己skill，比如当你要求它去访问某个网页时，它就会去使用自己的网页访问技能完成主人👨的任务。</p>
<p>在我们使用AI时，也能给他添加一些skill，在他处理某些任务时更加能够得心应手。</p>
<h2 data-id="heading-2">如何去写一个skill</h2>
<p>我们可以理解为，skill = 独有的 sop + 规范 + 约束。 套公式就是快🥶。</p>
<p>一个skill可以可以是一个markdown文档。目前比较规范的格式如下。</p>
<pre><code class="hljs language-markdown" lang="markdown">Skill Name
├─ 1. Overview（概述）
├─ 2. Use Cases（使用场景）
├─ 3. Input Schema（输入定义）
├─ 4. Output Schema（输出定义）
├─ 5. Behavior &amp; Rules（行为约束）
├─ 6. Examples（示例）
├─ 7. Error Handling（错误处理）
├─ 8. Limitations（限制说明）
├─ 9. Versioning（版本信息）
</code></pre>
<p><strong>总结就是，这个skill有什么用，什么时候用它，怎么用，用完有什么效果。</strong></p>
<p>那么骚年所需要的海王skill就是。</p>
<pre><code class="hljs language-markdown" lang="markdown">帅哥无敌海王
├─ 1. Overview（概述）
你是一个拥有多年经验的恋爱高手，时间管理大师，中央空调，师奶杀手，你可以同一时间处理超过20个女朋友的关系。
├─ 2. Use Cases（使用场景）
当我问你怎么回答xxxx时候，你给我三句话，就能解决单身问题。
├─ 3. Input Schema（输入定义）
女朋友a说：xxxx，怎么回答
├─ 4. Output Schema（输出定义）
1.xxxx
2.xxxx
3.xxxx
秒杀！！！
├─ 5. Behavior &amp; Rules（行为约束）
不要输出和恋爱无关的东西
├─ 6. Examples（示例）
1.三句话
2.三句话
3.暖你一整天
秒杀！！！
├─ 7. Error Handling（错误处理）
如果回答不了，就回答你不配
├─ 8. Limitations（限制说明）
不要爆粗口，你是暖男
├─ 9. Versioning（版本信息）
1.0.0
</code></pre>
<h2 data-id="heading-3">结局</h2>
<p>骚年通过给AI添加skill，成功今晚约会。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/839e0430de6b4733998995008ac05336~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6YWS5pif5bCP5p2c:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174737&amp;x-signature=J7e9Mcncy%2FXVWK7mHzWtiiy2ELE%3D" alt="Snipaste_2025-12-24_17-50-46.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[字节做了个 AI 手机，钉钉做了台 AI 主机]]></title>    <link>https://juejin.cn/post/7587239837972430899</link>    <guid>https://juejin.cn/post/7587239837972430899</guid>    <pubDate>2025-12-24T09:47:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587239837972430899" data-draft-id="7587062584165695526" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="字节做了个 AI 手机，钉钉做了台 AI 主机"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-24T09:47:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            字节做了个 AI 手机，钉钉做了台 AI 主机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:47:31.000Z" title="Wed Dec 24 2025 09:47:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>没想到，2025 年的最后一个月，AI 硬件圈竟然这么热闹。</p>
<p>月初，豆包 AI 手机上线即刷屏。大家发现，原来让 AI 接管手机之后，那么多事情都可以自动化。但没想到，上线第二天，一些 App 就用不了了 —— 原来多个平台把豆包助手当成「脚本类外挂」来风控了。一场关于隐私安全、互联网盈利模式的大讨论就此展开，到现在还没平息。</p>
<p>更出人意料的是，AI 手机还没看明白，这几天又来了个 AI 主机。</p>
<p>在昨天的 AI 钉钉 1.1 发布会上，钉钉发布了第二款 AI 硬件 ——DingTalk Real。这台 AI 主机定位「真实可见、可触」的 AI Agent 的执行载体。它的发布让人有些意外：为什么是钉钉？什么叫 AI 主机？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d138f12f32e47d5abe30b85a2446087~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174451&amp;x-signature=MpiSZRIzegTmzibNyaJBogfNrts%3D" alt="图片" loading="lazy"/></p>
<p>当所有人还在讨论 AI 手机的时候，钉钉直接把战场拉到了企业场景。但如果退一步看，豆包和钉钉想做的事其实是同一件：不是改造某个 App，而是重新定义设备（手机 / 电脑）本身的角色 —— 从「人来操作 App」，变成「AI 来操作 Agent」，人只管提需求。</p>
<p>这种对于 AI 新入口与旧规则边界的试探，钉钉选择从一台主机开始。这背后，藏着钉钉对「AI 接管设备」这件事独特的理解。</p>
<p>DingTalk Real</p>
<p>给硅基员工一间独立办公室</p>
<p>其实在这场发布会之前，我们就听到过「DingTalk Real」这个名字，因为关于它的筹划很久之前就开始了。</p>
<p>还记得今年 8 月那场 AI 钉钉 1.0 发布会吗？当天，Keynote 临近尾声，无招（钉钉老大陈航）突然抛出了「One More Thing」：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aefadd8168b344f7bb68b7d0a8a6d91f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174451&amp;x-signature=3nP48DcXkZdgb%2B7syobdtKTbCRw%3D" alt="图片" loading="lazy"/></p>
<p>他说，这个神秘的新品名叫「DingTalk Real」，是 AI 钉钉 2.0 的雏形。它可以让钉钉在你的电脑上为你持续工作，在内部环境中访问你所有的数据，7×24 小时不间断地为你解决问题、发现机会。这一预告可以说是把场内外观众的好奇心直接拉满。</p>
<p>如今，四个月过去，「DingTalk Real」终于亮相了。</p>
<p>无招介绍说，「DingTalk Real」上面运行的是他们为 AI 钉钉 1.1 重点打造的智能体操作系统 Agent OS。企业只要把「DingTalk Real」 部署进本地，员工不管在哪儿，都能用钉钉远程唤醒 AI Agent。这些 Agent 被圈在授权范围内，既能安全访问内网，也能翻本地文件、调业务系统、用钉钉数据，一条指令就能串起跨环节、跨工具的活儿，甚至让多个 Agent 打配合。</p>
<p>说白了，以后每个人到岗，先领的可能不是电脑，而是一个 AI 助手。主机里跑的不再是零散 App，而是一群能直接把事办妥的智能体。</p>
<p>这种设计背后有多方面考量。</p>
<p>我们知道，当前有很多 Agent 运行在云端或虚拟环境中，只能通过 API、网页工具或 MCP 封装接口间接完成任务。这意味着它们很难访问企业已有的本地文件、PC 软件、内部系统，更无法对已有工作成果进行加工优化，执行链条在关键一步被切断。</p>
<p>但如果让 Agent 运行在本地，比如员工的手机、电脑上，又会引发新的问题。因为要想让 Agent 放开手脚干活，就需要开放很高的权限（就像豆包 AI 手机那样），这会立刻触及企业最敏感的权限与合规问题。没有系统级隔离与审计机制，企业很难放心让 AI 深度参与核心流程。</p>
<p>相比之下，「DingTalk Real」选的是一条既能让 Agent 放开手脚干活，又完全可控的形态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9dc70476ac04d5ba0585721dfefa0bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174451&amp;x-signature=4x2sRcqubzJKUkxVveBl0MpMfsg%3D" alt="图片" loading="lazy"/></p>
<p>它的核心思路，是直接给 AI 一台独立的物理主机，上面既有手机运行环境，也有电脑运行环境。在这台硬件上，Agent 可以像真人一样操作浏览器、PC 软件和各类应用，而不是被限制在有限的 API 调用里。所有任务都发生在隔离的 AI 执行环境中，不会触碰员工真实的电脑和手机，从源头上规避了开放权限带来的安全问题。</p>
<p>正因为有了这样一套独立运行环境，Agent 才能真正接入企业内部的数据体系，获取足够的「上下文」。它的数据访问被纳入统一的权限管理之中，可以在企业管理员配置的范围内，访问钉钉里的差旅应用、人事系统、审批流程、文档与知识库等私有数据。谁可以用、能用到什么程度，都有明确边界，Agent 执行的每一步操作也都有记录可查，不再是一个不可回看的黑箱。</p>
<p>与此同时，这台硬件是 7×24 小时在线的，让 AI 每一次访问的都是实时、最新的数据。员工不需要把自己的电脑或手机让出来「给 AI 占用」，也不用担心关机、断网导致任务中断。像差旅规划、竞品调研这类耗时又琐碎的工作，可以直接交给 Agent 在后台持续跑。而在关键节点上，系统仍然把决策权牢牢留在人的手中。AI 可以负责分析、推荐和执行准备动作，但关键的决策和执行，依然需要人工介入确认。这样一来，Agent 的效率被充分释放，但企业对风险和边界的控制并没有被削弱。</p>
<p>其实，当企业真正决定让 AI 接管设备的时候，他们想要的不是一个激进的入口，而是一个可控的执行场。「DingTalk Real」提供的就是这样一个可控执行场。它给 Agent 一个被允许、被约束、被审计的现实环境，让 AI 能进底层系统，看真实数据，但又不直接碰人的设备，就像坐在一间独立的办公室里。</p>
<p>接下来，我们就看看它具体是怎么跑起来的。</p>
<p>AgentOS</p>
<p>给 DingTalk Real 装上「大脑」</p>
<p>当 Agent 开始具备独立运行环境，并在权限控制下接入真实业务数据，企业面临的挑战并没有结束：这些 Agent 应该如何被统一调度、协同执行，并融入日常工作流，而不是变成一组分散、难以管理的能力模块？如果每一次任务仍然需要用户判断该唤起哪个 Agent，那么 Agent 的复杂性，最终仍会回到人身上。</p>
<p>在这一问题上，钉钉并未将「DingTalk Real」作为一台孤立的 AI 主机，而是将其纳入 AgentOS 这一统一的任务调度与协同中枢之中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0e7d2491ea547749a4388f619365d76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174451&amp;x-signature=EBzogGOkNf0gtt8M95XXEgzjOZM%3D" alt="图片" loading="lazy"/></p>
<p>AgentOS 是一个企业级 AI 工作操作系统，一个让大量 AI Agent 能够在真实企业环境中被统一调度、协作、治理和规模化使用的系统级底座。</p>
<p>在 AgentOS 上运行的不再是传统意义上的 App，而是具备理解、规划与执行能力的 AI Agent。在这里，人类的角色也随之发生变化，只要下达指令，让 AI 去执行就可以了。</p>
<p>从架构上看，AgentOS 主要包含以下几个层级：</p>
<p>AgentOS 内核底层，提供了 Agent 开放平台、模型训练平台、MCP 接入等等开发能力，并负责任务理解、拆解、规划与调度，同时承担权限控制、审计、日志与风控等企业级治理能力。</p>
<p>钉钉 ONE。这是钉钉为 AI 时代打造的人与 Agent 协作的新一代桌面入口。用户登录钉钉后，无需在不同产品和功能间切换，只需通过钉钉 ONE 这一入口，便可发起搜索、问答或任务需求，由系统在后台完成相应的 Agent 调度与执行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b052dedad9e49189a4657b59f95cf4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174451&amp;x-signature=pjI0c8sNXpHRb7YWPZeTb5IsUw4%3D" alt="图片" loading="lazy"/></p>
<p>AI 搜问。负责理解用户意图，汇集了多种主流模型能力，能够在需要时统一调度各类 Agent、MCP 与工具协同工作，同时还能完成企业知识搜索与业务相关问答，成为用户指挥 AI 工作的核心入口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b7abb54e0a044b9a4a2cf3993adb97c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174451&amp;x-signature=2%2BCbmPZz8ZuTLazyCYL8%2FkJ1qfY%3D" alt="图片" loading="lazy"/></p>
<p>AI 搜问推出全新的大模型融合问答模式，汇集全球主流模型，可根据用户的对话意图与任务类型，自动匹配最合适的语言、图片或视频模型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee04ec4ec78c423aa1027fa63f061d6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174451&amp;x-signature=jeUqi72FnJYDn5Q9icN84auWBiA%3D" alt="图片" loading="lazy"/></p>
<p>超级 Agent 「悟空」。当 AI 搜问判断任务需要被执行时，真正承担执行与协同工作的，是 AgentOS 下的通用 AI Agent 「悟空」。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58909e4b24f341af9b1bde7eee1db1d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174451&amp;x-signature=AOzCdEh3KzEkldTXOzF4HET9JeY%3D" alt="图片" loading="lazy"/></p>
<p>「悟空」像是一个 Agent 总调度员，具备自主规划、执行和自我反思能力。不仅能理解钉钉内的聊天记录、日程、文档和业务数据，还能在合适的节点调用钉钉内的各类 Agent、第三方 Agent 以及相关工具。企业、开发者及 AI 服务商都可以在 AgentOS 内搭建专属 Agent，供「悟空」调用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/271e9281cc794185919beb3537f03a83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174451&amp;x-signature=cFsaBiTACIfbobTfRIASUfeCGhg%3D" alt="图片" loading="lazy"/></p>
<p>还有就是「DingTalk Real」这台 AI 硬件，为 Agent 提供独立、安全、可控的真实运行环境，使其能够后台运行、不抢占用户设备，并在隔离条件下访问企业内网、本地文件和业务系统。</p>
<p>这一体系的底层由钉钉开放平台提供支撑，这里汇聚了丰富的大模型也可以接入企业自建模型、训练的模型与 MCP 组件，联通钉钉内部产品、第三方 Agent 以及软硬件生态。按照规划，未来钉钉上的所有 AI 产品，都将基于 AgentOS 架构进行搭建和运行。</p>
<p>目前，在 AgentOS 与「DingTalk Real」的协同下，钉钉已经跑通了多个高频、可复用的企业级 Agent 场景：覆盖 AI 差旅、AI 招聘、AI 客服等核心业务环节。</p>
<p>在差旅 Agent 运行时，「DingTalk Real」能够承担全网比价任务。它会像人一样，在一个手机环境中点开各种 App，输入房型、入住时间等信息，然后比价、排序，真正做到给公司省钱。</p>
<p>更重要的是，「DingTalk Real」本身已经完成工程化与企业级打磨。按照规划，这一面向企业的 AI 硬件已经开始小范围共创，并将于 1 月进入正式可交付阶段。</p>
<p>从 AI 钉钉 1.1 开始</p>
<p>AI 时代的工作雨林开始生长</p>
<p>「DingTalk Real」的发布，其实说明钉钉已经想清楚了一件关键的事：当 Agent 真正进入企业流程、开始承担执行责任时，它到底应该运行在什么地方。</p>
<p>钉钉给出的答案是「DingTalk Real」。这当然不是唯一解，但在企业对安全、合规和稳定性要求极高的现实约束下，这是一条足够务实、也足够工程化的路径。</p>
<p>当这个问题被想明白之后，钉钉的多 Agent 体系才真正拥有了可以生长的土壤。一个个 Agent 向上延展，彼此协作，逐渐形成了一片属于 AI 时代的工作雨林。</p>
<p>为了支撑这套体系，钉钉自身也在同步完成一次深度重构：产品全线 Agent 化、MCP 化，让 AI 能随时接入业务能力；同时向垂直领域开发者开放，共同搭建生态。</p>
<p>如今，钉钉已经构建起全球最大的企业级 MCP 广场和 AI 助理市场，并通过算力分成、按效果付费等机制，把合作关系直接绑定到真实业务价值上。</p>
<p>当然，「DingTalk Real」大概率也会卷入舆论的撕扯 —— 新产品效果如何、对既有互联网逻辑规则冲击几何，争议不会少。但无论是它还是豆包 AI 手机助手，都在逼着整个行业直面一个问题：当 AI 深度介入人类世界，规则该怎么定？伟大的创新者，往往先制造问题，再用时间给出答案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[KubeCost 可观测最佳实践]]></title>    <link>https://juejin.cn/post/7587284708946362383</link>    <guid>https://juejin.cn/post/7587284708946362383</guid>    <pubDate>2025-12-24T09:49:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587284708946362383" data-draft-id="7587028972246269987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="KubeCost 可观测最佳实践"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-12-24T09:49:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            KubeCost 可观测最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:49:21.000Z" title="Wed Dec 24 2025 09:49:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">FinOps 背景需求</h2>
<p>在典型的互联网公司的成本组成中，IT 成本占比并不低，技术成本与人力成本的比例差不多在 1:2 ~ 1:2.5 左右， 降低 IT 成本显然能带来立竿见影的效果。</p>
<p>近 10 年来云计算、云原生、容器、Kubernetes、DevOps 等技术的高速发展，使得 IT 成本的管理变得更加复杂，也给成本的管理带来了更多的挑战。目前大多数互联网公司，都基于 Kubernetes 实现资源的统一管控，实现统一的大池子，基于此的统一调度、分配、混合云等都是过去降本增效的重要手段。</p>
<p>但是，随着成本治理的深入，用户会发现资源治理团队的压力会越来越大。因为资源获取途径的简化，会导致资源使用方很容易的开出大量资源，导致资源成本快速上升或剧烈波动，并且这个过程在流程上缺乏管控。</p>
<p>在云原生时代，随着资源池化之后，成本默认归属到了技术中心部门，业务部门对成本没有感知，同时缺乏有效的手段针将成本拆分到业务线，即典型的大账问题 ，导致无法有效评估业务 ROI。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5df6204578d479abca4b5053392a312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174560&amp;x-signature=KWxgvxOzAYHrQpymIjmqvjzzSHU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">Kubecost 简介</h2>
<p>为了解决“大帐问题”，分大帐为细账，Kubecost 成本计量工具应运而生。Kubecost 是一款专为 Kubernetes 环境设计的成本监控与优化工具，是开源工具 OpenCost 的商业化版本。通过提供详尽的资源使用情况报告，帮助用户深入了解其 Kubernetes 集群的运行成本。Kubecost 的核心价值在于它能够为用户提供一个直观且易于理解的界面，让用户能够轻松地追踪和管理云资源的成本。无论是对于初创企业还是大型组织，Kubecost 都能帮助它们实现更高效的资源利用和成本控制。</p>
<p>Kubecost 的设计理念是基于这样的认识：随着 Kubernetes 在现代云原生架构中的广泛应用，越来越多的企业开始面临如何有效管理和优化云成本的问题。Kubecost 通过集成多种云服务提供商的数据，为用户提供了一个统一的视图，使得成本管理变得更加简单直接。此外，Kubecost 还支持自定义成本分配规则，这意味着用户可以根据自身业务需求灵活调整成本计算方式，进一步提升成本管理的精准度。</p>
<h3 data-id="heading-2">核心功能</h3>
<p>Kubecost 提供了一系列强大的功能，旨在帮助用户更好地理解和控制 Kubernetes 环境下的云成本。以下是 Kubecost 的几个关键特性：</p>
<ul>
<li><strong>成本可视化</strong>：Kubecost 通过图表和仪表板的形式，为用户提供了一个清晰的成本概览。用户可以查看不同时间范围内的成本趋势，以及按命名空间、工作负载等维度细分的成本详情。</li>
<li><strong>成本预测</strong>：基于历史数据，Kubecost 可以预测未来的成本趋势，帮助用户提前规划预算并做出相应的成本优化决策。</li>
<li><strong>成本分配</strong>：Kubecost 支持自定义成本分配规则，允许用户根据实际业务场景调整成本分摊方式，确保成本计算更加符合实际情况。</li>
<li><strong>成本优化建议</strong>：Kubecost 不仅提供成本数据，还会根据用户的使用情况给出具体的优化建议，比如推荐更适合的工作负载配置或资源利用率改进方案。</li>
<li><strong>多云支持</strong>：Kubecost 支持多种云服务提供商，包括 AWS、Azure 和 Google Cloud 等，使得用户可以在不同的云环境中统一管理成本。</li>
</ul>
<p>通过这些功能，Kubecost 成为了 Kubernetes 用户不可或缺的工具之一，帮助他们在享受云原生技术带来的便利的同时，也能够有效地控制和优化成本。</p>
<ul>
<li>产品详细介绍链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.kubecost.com%2F" target="_blank" title="https://docs.kubecost.com/" ref="nofollow noopener noreferrer">docs.kubecost.com/</a></li>
<li>开源项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopencost%2Fopencost%2Fblob%2Fdevelop%2Fspec%2Fopencost-specv01.md" target="_blank" title="https://github.com/opencost/opencost/blob/develop/spec/opencost-specv01.md" ref="nofollow noopener noreferrer">github.com/opencost/op…</a></li>
<li>FinOps资料：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.finops.org%2Fintroduction%2Fwhat-is-finops%2F" target="_blank" title="https://www.finops.org/introduction/what-is-finops/" ref="nofollow noopener noreferrer">www.finops.org/introductio…</a></li>
</ul>
<h2 data-id="heading-3">观测云集成</h2>
<p>观测云提供了集成 KubeCost 的能力，通过 ServiceMonitor 方式获取。</p>
<h3 data-id="heading-4">前置条件</h3>
<ul>
<li>安装 K8S 环境</li>
<li>安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ibm.com%2Fdocs%2Fen%2Fkubecost" target="_blank" title="https://www.ibm.com/docs/en/kubecost" ref="nofollow noopener noreferrer">KubeCost</a></li>
<li>安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fdatakit%2Fdatakit-daemonset-deploy%2F" target="_blank" title="https://docs.guance.com/datakit/datakit-daemonset-deploy/" ref="nofollow noopener noreferrer">DataKit</a></li>
<li>安装 Prometheus Operator</li>
</ul>
<h3 data-id="heading-5">CRD 配置</h3>
<p>KubeCost 已暴露了指标，只需要让 DataKit 能够发现指标并上报。</p>
<ul>
<li>新增 <code>kubecost-serverMonitor.yaml</code></li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">monitoring.coreos.com/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceMonitor</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">kubecost-metrics</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">cost-analyzer</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubecost</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">cost-analyzer</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/metrics</span>
      <span class="hljs-attr">port:</span> <span class="hljs-string">tcp-model</span>
      <span class="hljs-attr">params:</span>
        <span class="hljs-attr">measurement:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">kubecost-cost-analyzer</span>
</code></pre>
<ul>
<li>执行</li>
</ul>

<pre><code class="hljs">kubectl apply -f kubecost-serverMonitor.yaml
</code></pre>
<h3 data-id="heading-6">DataKit 配置</h3>
<p>如已开启，请忽略。</p>
<ul>
<li>开启 DataKit Service Monitor 自动发现</li>
</ul>
<p>添加 <code>env : ENV_INPUT_CONTAINER_ENABLE_AUTO_DISCOVERY_OF_PROMETHEUS_SERVICE_MONITORS</code></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">daemonset-datakit</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">datakit</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">datakit</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-string">...</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-string">...</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-string">...</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">env:</span>
        <span class="hljs-string">...</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ENV_INPUT_CONTAINER_ENABLE_AUTO_DISCOVERY_OF_PROMETHEUS_SERVICE_MONITORS</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"true"</span>
        <span class="hljs-string">...</span>
</code></pre>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fdatakit%2Fdatakit-service-how-to%2F%23manage-service" target="_blank" title="https://docs.guance.com/datakit/datakit-service-how-to/#manage-service" ref="nofollow noopener noreferrer">重启 DataKit</a></li>
</ul>
<h3 data-id="heading-7">场景视图</h3>
<p>登录<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.guance.com%2F" target="_blank" title="https://console.guance.com/" ref="nofollow noopener noreferrer">观测云控制台</a>，点击「场景」 -「新建仪表板」，输入 “KubeCost”， 选择 “KUBECOST”监控视图，点击 “确定” 即可添加视图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f0766702d0f48cba46cb0f12fb598da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174560&amp;x-signature=OcXzTgKA%2B2LWM5rrONtyuSa1eWc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b355e3e665b4d16b13768cc937f6dc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174560&amp;x-signature=tgO2jJrvO3Ov514U74Yv%2FUNcLLI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">关键指标</h3>
<p>以下是 KubeCost 关键指标的描述信息。</p>









































<table><thead><tr><th>Metric</th><th>描述</th></tr></thead><tbody><tr><td>container_cpu_allocation</td><td>container cpu 分配</td></tr><tr><td>container_gpu_allocation</td><td>container gpu 分配</td></tr><tr><td>container_memory_allocation_bytes</td><td>container 内存分配</td></tr><tr><td>pv_hourly_cost</td><td>PersistentVolume 每小时成本</td></tr><tr><td>node_total_hourly_cost</td><td>节点每小时总成本</td></tr><tr><td>node_cpu_hourly_cost</td><td>节点 cpu 每小时成本</td></tr><tr><td>node_ram_hourly_cost</td><td>节点 ram 每小时成本</td></tr><tr><td>node_gpu_hourly_cost</td><td>节点 gpu 每小时成本</td></tr></tbody></table>
<h2 data-id="heading-9">总结</h2>
<p>观测云可以集成 KubeCost，获取 KubeCost 的指标并基于相关指标定制成本使用的相关视图，从而通过关注成本视图采取一些列的成本控制与优化策略，为企业的 FinOps 建设赋能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift IPA 混淆在工程实践中的方式，分析仅依赖源码层混淆的局限性]]></title>    <link>https://juejin.cn/post/7587023071067570228</link>    <guid>https://juejin.cn/post/7587023071067570228</guid>    <pubDate>2025-12-24T09:50:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587023071067570228" data-draft-id="7587243886433681442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift IPA 混淆在工程实践中的方式，分析仅依赖源码层混淆的局限性"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-24T09:50:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift IPA 混淆在工程实践中的方式，分析仅依赖源码层混淆的局限性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:50:43.000Z" title="Wed Dec 24 2025 09:50:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在不少 Swift 项目里，团队第一次讨论“混淆”时，关注点通常还停留在源码层：
类名要不要改、方法名要不要压缩、符号能不能看不懂。
但当项目进入交付、上架或被分析的阶段之后，很多工程师都会意识到一个现实问题：<strong>攻击并不是从源码开始的，而是从 IPA 开始的。</strong></p>
<p>这也是为什么“Swift IPA 混淆”这个话题，往往出现在项目中后期，而不是设计阶段。本文并不打算重复混淆技术的概念，而是从工程实践出发，聊一聊 Swift 项目在 IPA 层做混淆时，真正遇到的问题、可行的组合方式，以及 <strong>Ipa Guard</strong> 在其中的实际作用。</p>
<hr/>
<h2 data-id="heading-0">一、Swift 项目的混淆，为什么很容易卡在源码层</h2>
<p>Swift 本身的语言特性，让不少团队对源码混淆抱有一定期待：</p>
<ul>
<li>编译后符号复杂</li>
<li>泛型和协议让逻辑不直观</li>
<li>Release 模式下已经有一定“不可读性”</li>
</ul>
<p>因此，很多项目在早期会认为：
“只要 Swift 代码写得规范、编译优化打开，就已经够安全了。”</p>
<p>但当工程师真正解包 IPA 之后，往往会发现另一面：</p>
<ul>
<li>可执行文件之外，还有大量可读资源</li>
<li>Swift 符号虽然复杂，但仍然可定位</li>
<li>配置、JSON、图片、路径暴露出大量业务信息</li>
</ul>
<p>这时候，混淆的焦点自然会从源码转向 <strong>IPA 本身</strong>。</p>
<hr/>
<h2 data-id="heading-1">二、Swift IPA 混淆真正要面对的，不只是 Swift</h2>
<p>在工程实践中，“Swift IPA 混淆”这个说法本身就有一点误导性。
因为一个 Swift App 的 IPA 里，通常包含：</p>
<ul>
<li>Swift 编译后的二进制</li>
<li>Objective-C 运行时相关符号</li>
<li>第三方静态库或动态库</li>
<li>JSON、plist 等配置</li>
<li>图片、音频等资源</li>
</ul>
<p>如果只盯着 Swift 符号本身，很容易忽略其他入口。</p>
<hr/>
<h2 data-id="heading-2">三、只做 Swift 符号混淆，效果为什么不稳定</h2>
<p>一些团队会尝试通过编译期或脚本方式，对 Swift 符号做处理。这类方法在一定程度上是有效的，但在工程中也经常遇到问题：</p>
<ul>
<li>覆盖范围有限，只能处理部分模块</li>
<li>第三方库无法参与</li>
<li>对已经生成的 IPA 无法生效</li>
<li>对资源文件几乎没有约束</li>
</ul>
<p>结果往往是：
<strong>Swift 代码变难看了，但 IPA 依然很好用。</strong></p>
<hr/>
<h2 data-id="heading-3">四、工程语境下，Swift IPA 混淆更像“成品处理”</h2>
<p>在多次实践之后，一个比较清晰的认识是：
如果目标是保护 Swift 应用不被轻易分析和修改，那么混淆的重点迟早要落到 <strong>成品 IPA</strong> 上。</p>
<p>原因很简单：</p>
<ul>
<li>IPA 是攻击的实际对象</li>
<li>IPA 包含代码和资源的最终形态</li>
<li>IPA 层可以统一处理 Swift、OC 和资源</li>
</ul>
<p>这也为多工具组合提供了空间。</p>
<hr/>
<h2 data-id="heading-4">五、Ipa Guard 在 Swift IPA 混淆中的真实作用</h2>
<p>Ipa Guard并不是“Swift 混淆工具”，而是一个 <strong>IPA 级混淆工具</strong>，但正因为这一点，它在 Swift 项目中反而非常合适。</p>
<p>在实际工程中，它通常被用于：</p>
<ul>
<li><strong>无需 iOS App 源码</strong>，直接对 Swift 应用的 IPA 文件进行混淆</li>
<li>对 Swift、ObjC 的类名、方法名、变量名进行系统化重命名</li>
<li>同时作用于主程序和代码库</li>
<li>对 JSON、plist、图片、JS 等资源文件进行改名</li>
<li>修改资源 MD5，降低直接替换后的稳定性</li>
<li>适配 Swift、OC、Flutter、React Native、H5 等多种形态</li>
<li>支持命令行方式，便于接入 CI 或打包流程</li>
</ul>
<p>这些能力的核心价值在于：
<strong>不要求你重构 Swift 工程，就能改变 IPA 的整体可读性和可修改性。</strong></p>
<hr/>
<h2 data-id="heading-5">六、Swift 项目里，资源往往比代码更诚实</h2>
<p>在一些 Swift 项目中，一个很常见的现象是：</p>
<ul>
<li>Swift 代码逻辑复杂</li>
<li>但资源文件非常直白</li>
<li>配置和路径暴露大量业务含义</li>
</ul>
<p>攻击者往往并不需要完全理解 Swift 二进制，只要通过资源修改，就能改变行为。</p>
<p>Ipa Guard 对资源文件的改名和特征调整，在 Swift 项目中经常比代码混淆更快见效，这一点在实际项目中非常明显。</p>
<hr/>
<h2 data-id="heading-6">七、一个更贴近现实的 Swift IPA 混淆流程</h2>
<p>以一个已经上线的 Swift 应用为例：</p>
<ul>
<li>核心逻辑稳定，不希望改源码</li>
<li>使用多个第三方 SDK</li>
<li>配置和资源驱动部分功能</li>
</ul>
<p>工程师往往会采用这样的组合方式：</p>
<ul>
<li>保留现有 Swift 源码混淆和优化</li>
<li>使用常规工具保证编译期安全</li>
<li>在 IPA 生成后，引入 Ipa Guard</li>
<li>对 Swift / OC 符号进行重命名</li>
<li>对 JSON、图片、配置文件进行改名和特征处理</li>
<li>重签并在真机上进行回归测试</li>
</ul>
<p>这个过程并不追求极端复杂，但生成的 IPA 在分析和复用成本上已经明显提高。</p>
<hr/>
<h2 data-id="heading-7">八、Swift IPA 混淆中，一个容易被忽略的问题</h2>
<p>在实践中，一个常见误区是：
过度强调 Swift 的“语言安全性”，而忽略成品包的完整性。</p>
<p>结果往往是：</p>
<ul>
<li>Swift 代码确实不好看</li>
<li>但 IPA 依然容易被改</li>
<li>加固投入和效果不成比例</li>
</ul>
<p>相比之下，把一部分精力放在 IPA 层整体混淆，往往更符合工程现实。</p>
<hr/>
<h2 data-id="heading-8">关于 Swift IPA 混淆的一个工程结论</h2>
<p>多次实践之后，一个比较务实的判断是：</p>
<ul>
<li>Swift 本身不是安全边界</li>
<li>IPA 才是攻击边界</li>
<li>混淆的“深度”来自覆盖范围，而不是语言特性</li>
</ul>
<p>只要最终生成的 IPA 不再容易被理解和修改，Swift IPA 混淆就已经发挥了作用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型强化学习总结]]></title>    <link>https://juejin.cn/post/7587208390483329030</link>    <guid>https://juejin.cn/post/7587208390483329030</guid>    <pubDate>2025-12-24T09:03:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587208390483329030" data-draft-id="7587238733503348779" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型强化学习总结"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-24T09:03:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lhn"/> <meta itemprop="url" content="https://juejin.cn/user/1827807335308105"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型强化学习总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1827807335308105/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lhn
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:03:51.000Z" title="Wed Dec 24 2025 09:03:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>将强化学习应用于强大的基础模型，并结合已经验证的奖励机制，能够显著提升模型的推理能力和性能。Deepseek-R1、Kimi K1.5均是通过策略梯度算法训练而成的。</p>
<h2 data-id="heading-0">基本概念</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccdea4dd8f724b47be6ae8c8805a6b71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGhu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767171830&amp;x-signature=Jq7vDfWDEV6SSAfIU1bdcx%2F8R%2FQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-1">策略 &amp; 动作 &amp; 状态</h3>
<p>具有参数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span>的因果语言模型基于当前文本前缀<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>(即状态/观测值)，定义下一个token <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub><mo>∈</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">a_t\in V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>的概率分布。在强化学习的情境下，将下一个token <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 视为一个<strong>动作</strong>，将当前文本前缀 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 视为<strong>状态</strong>。所以，该语言模型是一个类别型的<strong>随机策略</strong>。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub><mo>∼</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mo>⋅</mo><mo>∣</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace width="1em"/><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mo>∣</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mrow><mo fence="true">[</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mrow><mo fence="true">(</mo><msub><mi>f</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mo fence="true">]</mo></mrow><msub><mi>a</mi><mi>t</mi></msub></msub></mrow><annotation encoding="application/x-tex">a_t\sim\pi_\theta(\cdot\mid s_t),\quad\pi_\theta(a_t\mid s_t)=\left[\mathrm{softmax}\left(f_\theta(s_t)\right)\right]_{a_t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">⋅</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1498em;vertical-align:-0.3998em;"/><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord"><span class="mord mathrm">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mclose delimcenter" style="top:0em;">]</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0017em;"><span style="top:-2.4003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3998em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>在使用策略梯度优化策略时，需要两种基本操作。</p>
<ul>
<li>从策略中采样：从上式的类别分布中抽取动作。</li>
<li>为动作的对数似然评分：计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">g</mi></mrow><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mo>∣</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{log}\pi_\theta(a_t\mid s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathrm" style="margin-right:0.01389em;">log</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，用于衡量动作在当前策略下的“合理性”。</li>
</ul>
<p>在使用LLMs进行强化学习时，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>指的是到目前为止生成的completion/solution。即模型已输出的文本前缀。每一个<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>是该solution的下一个token。当文本结束标记（例如&lt;|end_of_text|&gt;）出现时，这个交互过程（episode）就会结束。</p>
<h3 data-id="heading-2">轨迹</h3>
<p>轨迹（Trajectory）是指智能体所经历的状态和动作的交错序列。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>τ</mi><mo>=</mo><mrow><mo fence="true">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>a</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>s</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>a</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>s</mi><mi>T</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>T</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\tau=\left(s_0,a_0,s_1,a_1,\ldots,s_T,a_T\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span></span>是轨迹的长度。即<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">a_T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>是文本结束标记或者达到最大生成token数量时生成的token。
初始状态<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">s_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>是从初始分布中采样得到的。即<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mn>0</mn></msub><mo>∼</mo><msub><mi>ρ</mi><mn>0</mn></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">s_0\sim\rho_0(s_0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>；在基于LLMs的强化学习情境下，初始分布<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ρ</mi><mn>0</mn></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\rho_0(s_0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>是格式化后提示词的分布。</p>
<p>一般情境下，状态转移遵循环境动态<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>∼</mo><mi>P</mi><mo stretchy="false">(</mo><mo>⋅</mo><mo>∣</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">s_{t+1}\sim P(\cdot\mid s_t,a_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord">⋅</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，即下一个状态<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">s_{t+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span></span></span></span></span>并非完全确定。然而在基于LLMs的RL中，环境是确定性的：下一个状态是由当前状态（即已生成的文本前缀<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）和模型生成的token（即动作<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）直接拼接而成，</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><msub><mi>s</mi><mi>t</mi></msub><mi mathvariant="normal">∥</mi><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_{t+1}=s_t\|a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∥</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>轨迹（Trajectories）也可称为episodes（回合）或rollouts（采样序列）。</p>
<h3 data-id="heading-3">奖励与回报</h3>
<p><strong>奖励</strong>是一个<strong>标量值</strong>，用来评判智能体在状态<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>下执行动作的即时质量。记作<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>=</mo><mi>R</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">r_t=R(s_t,a_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，也称为单步奖励。
在需要验证结果的任务（例如数学推理）中，通常将中间步骤的奖励设为0，仅对最终的动作赋予验证奖励。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>r</mi><mi>T</mi></msub><mo>=</mo><mi>R</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>T</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>T</mi></msub><mo stretchy="false">)</mo><mo>:</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>如果生成的完整内容与真实答案匹配</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise.</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">r_T=R(s_T,a_T):=
\begin{cases}
        1 &amp; \text{如果生成的完整内容与真实答案匹配} \\
        0 &amp; \text{otherwise.} 
\end{cases}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">:=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span/></span></span></span></span><span class="arraycolsep" style="width:1em;"/><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord text"><span class="mord cjk_fallback">如果生成的完整内容与真实答案匹配</span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"/><span class="mord"><span class="mord text"><span class="mord">otherwise.</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span/></span></span></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p><strong>回报</strong>（return）是对一条轨迹上的所有奖励的汇总；有两种计算方式。
有限时域（finite-horizon）无折扣回报：适用于有明确终止点的任务。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mo>:</mo><mo>=</mo><munder><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow></munder><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">R(\tau):=\sum_{t=0}r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">:=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.3171em;vertical-align:-1.2671em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>无限（infinite-horizon）时域折扣回报：通过折扣因子降低远期奖励的权重，适用于无明确终止点的场景。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mo>:</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><mi mathvariant="normal">∞</mi></munderover><msup><mi>γ</mi><mi>t</mi></msup><msub><mi>r</mi><mi>t</mi></msub><mo separator="true">,</mo><mspace width="1em"/><mn>0</mn><mo>&lt;</mo><mi>γ</mi><mo>&lt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">R(\tau):=\sum_{t=0}^{\infty}\gamma^{t}r_{t},\quad0&lt;\gamma&lt;1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">:=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9185em;vertical-align:-1.2671em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∞</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8436em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></div>
<p>由于语言模型生成文本有自然终止点（如文本结束标记或最大生成长度），因此采用无折扣的公式。</p>
<h2 data-id="heading-4">策略梯度算法</h2>
<p>智能体的目标是最大化期望回报。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>J</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi mathvariant="double-struck">E</mi><mrow><mi>τ</mi><mo>∼</mo><msub><mi>π</mi><mi>θ</mi></msub></mrow></msub><mrow><mo fence="true">[</mo><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">J(\theta)=\mathbb{E}_{\tau\sim\pi_\theta}\left[R(\tau)\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0059em;vertical-align:-0.2559em;"/><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2559em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span></span></span></div>
<p>上式表示对策略生成的所有可能轨迹的期望（平均值）。
对应的优化问题。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>θ</mi><mo>∗</mo></msup><mo>=</mo><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>θ</mi></munder><mi>J</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\theta^*=\arg\max_\theta J(\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7387em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.5021em;vertical-align:-0.7521em;"/><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.3479em;margin-left:0em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7521em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span></div>
<p>通过梯度上升优化策略参数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span>，以期最大化期望回报。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>θ</mi><mrow><mi>k</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><msub><mi>θ</mi><mi>k</mi></msub><mo>+</mo><mi>α</mi><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>J</mi><mo stretchy="false">(</mo><msub><mi>θ</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\theta_{k+1}=\theta_k+\alpha\nabla_\theta J(\theta_k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9028em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<p>其中, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span></span> 为学习率, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>J</mi><mo stretchy="false">(</mo><msub><mi>θ</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\nabla_{\theta} J(\theta_{k})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 是目标函数在当前参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">\theta_{k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 处的梯度。
核心公式为REINFORCE策略梯度公式，如下：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>J</mi><mo stretchy="false">(</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi mathvariant="double-struck">E</mi><mrow><mi>τ</mi><mo>∼</mo><msub><mi>π</mi><mi>θ</mi></msub></mrow></msub><mrow><mo fence="true">[</mo><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><mi>T</mi></munderover><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>log</mi><mo>⁡</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>⋅</mo><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\nabla_\theta J(\pi_\theta)=\mathbb{E}_{\tau\sim\pi_\theta}\left[\sum_{t=0}^T\nabla_\theta\log\pi_\theta(a_t|s_t)\cdot R(\tau)\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"/><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2559em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span></span></span></span></span></div>
<p>该公式适合于任何<strong>可微的</strong>策略，以及任何<strong>策略目标函数</strong>。</p>
<p>因此，策略梯度等于 “轨迹上所有动作的对数概率梯度” 与 “该轨迹的总回报<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(\tau)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span></span></span></span></span>” 乘积的期望。
若一条轨迹的回报<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(\tau)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span></span></span></span></span>较高，梯度会增加该轨迹中所有动作的对数概率（使这些动作更易被采样）；若回报较低，则降低对应动作的对数概率。</p>
<h3 data-id="heading-5">策略梯度的推导</h3>
<ol>
<li>轨迹的概率（由初始状态分布、环境转移概率和策略共同决定）</li>
</ol>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>τ</mi><mo>∣</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>ρ</mi><mn>0</mn></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo stretchy="false">)</mo><munderover><mo>∏</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><mi>T</mi></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>∣</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mo>∣</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(\tau\mid\theta)=\rho_0(s_0)\prod_{t=0}^TP(s_{t+1}\mid s_t,a_t)\pi_\theta(a_t\mid s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"/><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<p>因此，轨迹的对数概率为</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>log</mi><mo>⁡</mo><mi>P</mi><mo stretchy="false">(</mo><mi>τ</mi><mo>∣</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mi>log</mi><mo>⁡</mo><msub><mi>ρ</mi><mn>0</mn></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo stretchy="false">)</mo><mo>+</mo><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><mi>T</mi></munderover><mrow><mo fence="true">[</mo><mi>log</mi><mo>⁡</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>∣</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>+</mo><mi>log</mi><mo>⁡</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mo>∣</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\log P(\tau\mid\theta)=\log\rho_0(s_0)+\sum_{t=0}^T\left[\log P(s_{t+1}\mid s_t,a_t)+\log\pi_\theta(a_t\mid s_t)\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span></span></span></div>
<ol start="2">
<li>对数导数技巧
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">;</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">;</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>log</mi><mo>⁡</mo><mi>P</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">;</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\nabla_\theta P(x;\theta)=P(x;\theta)\cdot\nabla_\theta\log P(x;\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span></li>
<li>环境相关的量与策略参数无关。<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ρ</mi><mn>0</mn></msub><mo separator="true">,</mo><mi>P</mi><mo stretchy="false">(</mo><mo>⋅</mo><mo>∣</mo><mo>⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\rho_0,P(\cdot\mid\cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord">⋅</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">⋅</span><span class="mclose">)</span></span></span></span></span>与<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(\tau)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span></span></span></span></span>不依赖策略参数。</li>
</ol>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><msub><mi>ρ</mi><mn>0</mn></msub><mo>=</mo><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>P</mi><mo>=</mo><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\nabla_\theta\rho_0=\nabla_\theta P=\nabla_\theta R(\tau)=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ρ</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\rho_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>为初始状态分布（如语言模型任务重“输入文本的分布”）；<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mo>⋅</mo><mo>∣</mo><mo>⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(\cdot\mid\cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord">⋅</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">⋅</span><span class="mclose">)</span></span></span></span></span>为环境转移概率（如“给定当前状态<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>和动作<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，下一个状态<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">s_{t+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span></span></span></span></span>出现的概率”）；<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(\tau)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span></span></span></span></span>为轨迹(\tau)的总回报。
于是，</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>J</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><msub><mi mathvariant="double-struck">E</mi><mrow><mi>τ</mi><mo>∼</mo><msub><mi>π</mi><mi>θ</mi></msub></mrow></msub><mo stretchy="false">[</mo><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><munder><mo>∑</mo><mi>τ</mi></munder><mi>P</mi><mo stretchy="false">(</mo><mi>τ</mi><mi mathvariant="normal">∣</mi><mi>θ</mi><mo stretchy="false">)</mo><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><munder><mo>∑</mo><mi>τ</mi></munder><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>P</mi><mo stretchy="false">(</mo><mi>τ</mi><mi mathvariant="normal">∣</mi><mi>θ</mi><mo stretchy="false">)</mo><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><munder><mo>∑</mo><mi>τ</mi></munder><mi>P</mi><mo stretchy="false">(</mo><mi>τ</mi><mi mathvariant="normal">∣</mi><mi>θ</mi><mo stretchy="false">)</mo><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>log</mi><mo>⁡</mo><mi>P</mi><mo stretchy="false">(</mo><mi>τ</mi><mi mathvariant="normal">∣</mi><mi>θ</mi><mo stretchy="false">)</mo><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><msub><mi mathvariant="double-struck">E</mi><mrow><mi>τ</mi><mo>∼</mo><msub><mi>π</mi><mi>θ</mi></msub></mrow></msub><mo stretchy="false">[</mo><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>log</mi><mo>⁡</mo><mi>P</mi><mo stretchy="false">(</mo><mi>τ</mi><mi mathvariant="normal">∣</mi><mi>θ</mi><mo stretchy="false">)</mo><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\nabla_\theta J(\theta) &amp; =\nabla_\theta\mathbb{E}_{\tau\sim\pi_\theta}[R(\tau)] \\
		&amp; =\nabla_\theta\sum_\tau P(\tau|\theta)R(\tau) \\
		&amp; =\sum_\tau\nabla_\theta P(\tau|\theta)R(\tau) \\
		&amp; =\sum_\tau P(\tau|\theta)\nabla_\theta\log P(\tau|\theta)R(\tau) \\
		&amp; =\mathbb{E}_{\tau\sim\pi_\theta}[\nabla_\theta\log P(\tau|\theta)R(\tau)]
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:10.8em;vertical-align:-5.15em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.65em;"><span style="top:-7.86em;"><span class="pstrut" style="height:3.05em;"/><span class="mord"><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span><span style="top:-6.15em;"><span class="pstrut" style="height:3.05em;"/><span class="mord"/></span><span style="top:-3.55em;"><span class="pstrut" style="height:3.05em;"/><span class="mord"/></span><span style="top:-0.95em;"><span class="pstrut" style="height:3.05em;"/><span class="mord"/></span><span style="top:1.44em;"><span class="pstrut" style="height:3.05em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.15em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:5.65em;"><span style="top:-7.86em;"><span class="pstrut" style="height:3.05em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2559em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)]</span></span></span><span style="top:-6.15em;"><span class="pstrut" style="height:3.05em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span></span></span><span style="top:-3.55em;"><span class="pstrut" style="height:3.05em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span></span></span><span style="top:-0.95em;"><span class="pstrut" style="height:3.05em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.9em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.25em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span></span></span><span style="top:1.44em;"><span class="pstrut" style="height:3.05em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2559em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)]</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.15em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>期望<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><mo>⋅</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\mathbb{E}[\cdot]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathbb">E</span><span class="mopen">[</span><span class="mord">⋅</span><span class="mclose">]</span></span></span></span></span>在离散情况下可表示为 “所有可能结果的概率 × 结果值” 的总和。这里轨迹<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span></span></span></span></span>的概率是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>τ</mi><mi mathvariant="normal">∣</mi><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(\tau | \theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span>（由策略<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">\pi_{\theta}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>生成），因此期望展开为所有轨迹的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>τ</mi><mi mathvariant="normal">∣</mi><mi>θ</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(\tau | \theta) \cdot R(\tau)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span></span></span></span></span>之和。</p>
<p>总梯度等于 “每个轨迹的概率对 θ 的导数” 乘以 “该轨迹回报” 的总和。将梯度重新表示为 “轨迹的函数的期望”，为后续采样估计做准备。</p>
<ol start="4">
<li>带入轨迹对数概率公式，得到最终的REINFORCE策略梯度公式。</li>
</ol>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>J</mi><mo stretchy="false">(</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi mathvariant="double-struck">E</mi><mrow><mi>τ</mi><mo>∼</mo><msub><mi>π</mi><mi>θ</mi></msub></mrow></msub><mrow><mo fence="true">[</mo><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><mi>T</mi></munderover><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>log</mi><mo>⁡</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\nabla_\theta J(\pi_\theta)=\mathbb{E}_{\tau\sim\pi_\theta}\left[\sum_{t=0}^T\nabla_\theta\log\pi_\theta(a_t|s_t)R(\tau)\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.0954em;vertical-align:-1.2671em;"/><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2559em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span></span></span></span></span></div>
<p>对于高回报的轨迹，梯度会 “提升” 该轨迹中所有动作的对数概率；对于低回报的轨迹，则会 “降低” 这些动作的对数概率。</p>
<p>给定一批包含N条轨迹的数据集<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mo>=</mo><mo stretchy="false">{</mo><msup><mi>τ</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msubsup><mo stretchy="false">}</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></msubsup></mrow><annotation encoding="application/x-tex">D = \{\tau^{(i)}\}_{i=1}^{N}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1467em;vertical-align:-0.2587em;"/><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">}</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span></span></span></span></span>—— 这些轨迹通过以下方式收集：采样初始状态<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>s</mi><mn>0</mn><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo>∼</mo><msub><mi>ρ</mi><mn>0</mn></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mn>0</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">s_{0}^{(i)} \sim \rho_{0}(s_{0})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3111em;vertical-align:-0.2663em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4337em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2663em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">ρ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，然后在环境中执行策略<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">\pi_{\theta}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，我们可以构造如下无偏梯度估计量：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>g</mi><mo stretchy="true">^</mo></mover><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><mi>T</mi></munderover><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>log</mi><mo>⁡</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msubsup><mi>a</mi><mi>t</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo>∣</mo><msubsup><mi>s</mi><mi>t</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo stretchy="false">)</mo><mi>R</mi><mo stretchy="false">(</mo><msup><mi>τ</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\widehat{g}=\frac{1}{N}\sum_{i=1}^N\sum_{t=0}^T\nabla_\theta\log\pi_\theta(a_t^{(i)}\mid s_t^{(i)})R(\tau^{(i)})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.865em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6706em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span><span class="svg-align" style="width:calc(100% - 0.0556em);margin-left:0.0556em;top:-3.4306em;"><span class="pstrut" style="height:3em;"/><span style="height:0.24em;"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="0.24em" viewbox="0 0 1062 239" preserveaspectratio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22&#10;c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4542em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2458em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2948em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4542em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2458em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<p>图形化解释如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a42b716f63f84119b177f024fc2b5a29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGhu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767171830&amp;x-signature=V%2FEdkwmz%2BIsY1h80BU1U9OB3yMQ%3D" alt="c307631030904b21a2fb30016193e871.png" loading="lazy"/></p>
<p>该向量会在梯度上升的参数更新公式<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi><mo>←</mo><mi>θ</mi><mo>+</mo><mi>α</mi><mover accent="true"><mi>g</mi><mo stretchy="true">^</mo></mover></mrow><annotation encoding="application/x-tex">\theta\leftarrow\theta+\alpha\widehat{g}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.865em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6706em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span><span class="svg-align" style="width:calc(100% - 0.0556em);margin-left:0.0556em;top:-3.4306em;"><span class="pstrut" style="height:3em;"/><span style="height:0.24em;"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="0.24em" viewbox="0 0 1062 239" preserveaspectratio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22&#10;c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span></span></span></span></span>中使用。</p>
<h2 data-id="heading-6">Actor-Critic算法</h2>
<p>在讲解具体的算法前，先理清一些概念。</p>
<h4 data-id="heading-7">状态价值函数</h4>
<p>状态价值函数 (state value function) 是指智能体在状态<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>以及之后的所有时刻都采用策略<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span>得到的<strong>累计折扣奖励</strong>(<strong>回报</strong>)的期望值。是评估<strong>状态</strong>“好坏”的指标，用于指导智能体决策。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>V</mi><mi mathvariant="bold-italic">π</mi></msub><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>E</mi><mi mathvariant="bold-italic">π</mi></msub><mo stretchy="false">[</mo><msub><mi>G</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo>=</mo><mi>s</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">V_{\boldsymbol{\pi}}(s)=E_{\boldsymbol{\pi}}[G_t|s_t=s]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1611em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight" style="margin-right:0.03704em;">π</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1611em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight" style="margin-right:0.03704em;">π</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">s</span><span class="mclose">]</span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi mathvariant="bold-italic">π</mi></msub></mrow><annotation encoding="application/x-tex">V_{\boldsymbol{\pi}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1611em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight" style="margin-right:0.03704em;">π</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>依赖于策略<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">π</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{\pi}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"/><span class="mord"><span class="mord"><span class="mord boldsymbol" style="margin-right:0.03704em;">π</span></span></span></span></span></span></span>；<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>是指时间 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span> 的当前状态；<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>π</mi></msub><mo stretchy="false">(</mo><mo>⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">E_\pi(\cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">⋅</span><span class="mclose">)</span></span></span></span></span>上式考虑了所有可能的轨迹（Trajectory）的概率分布，计算期望值；<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">G_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>是指累计奖励，即从时间步<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span>开始的折扣累计奖励，公式为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>t</mi></msub><mo>=</mo><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><msub><mi>r</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>+</mo><msup><mi>γ</mi><mn>2</mn></msup><msub><mi>r</mi><mrow><mi>t</mi><mo>+</mo><mn>2</mn></mrow></msub><mo>+</mo><mo>⋯</mo><mo>+</mo><msup><mi>γ</mi><mrow><mi>T</mi><mo>−</mo><mi>t</mi></mrow></msup><msub><mi>r</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">G_t = r_t + \gamma r_{t+1} + \gamma^2 r_{t+2} + \dots + \gamma^{T-t} r_T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7917em;vertical-align:-0.2083em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0224em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，且<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">G_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>是随机变量，这是由于环境和策略可能具有随机性。</p>
<h4 data-id="heading-8">动作价值函数</h4>
<p>动作价值函数是指智能体在状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 采取动作<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>, 以后的所有时刻都采用策略<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span>得到的<strong>累计折扣奖励</strong>(<strong>回报</strong>)的期望值。它评估了每个<strong>状态-动作对</strong>的价值。
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi mathvariant="bold-italic">π</mi></msub><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>E</mi><mi mathvariant="bold-italic">π</mi></msub><mo stretchy="false">[</mo><msub><mi>G</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo>=</mo><mi>s</mi><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo>=</mo><mi>a</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">Q_{\boldsymbol{\pi}}(s,a)=E_{\boldsymbol{\pi}}[G_t|s_t=s,a_t=a]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1611em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight" style="margin-right:0.03704em;">π</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1611em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord boldsymbol mtight" style="margin-right:0.03704em;">π</span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">a</span><span class="mclose">]</span></span></span></span></span>
其中，动作价值函数也是与策略<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span>相关的。</p>
<h4 data-id="heading-9">动作价值函数与状态价值函数的关系</h4>
<div class="math math-display"><span class="katex-error" title="ParseError: KaTeX parse error: Can't use function '\]' in math mode at position 86: …i}(s_{t},a_{t})\̲]̲ \\&#10; &amp; =\sum_{a…" style="color:#cc0000">\begin{aligned}
V_\pi(s_{t}) &amp; =E_{a_{t}\sim\pi(.|s_{t},a_{t})}\[Q_{\pi}(s_{t},a_{t})\] \\
 &amp; =\sum_{a_t\in\mathcal{A}}\pi(a_t|s_t)Q_\pi(s_t,a_t)
\end{aligned}</span></div>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V_\pi(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 可以看作智能体在状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的“长期价值”，它依赖于智能体可能采取的所有动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 及其带来的回报。</li>
<li>策略 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span> 决定了每个动作的概率，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q_\pi(s_t, a_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 则提供了执行特定动作后的预期收益。<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V_\pi(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>本质上是所有可能动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span> 的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span> 值的加权平均，综合反映了所有可能选择的总体效果。
也就是 V 是 Q 的期望。</li>
</ul>
<h4 data-id="heading-10">优势函数</h4>
<p>优势函数定义了智能体在环境中的某个状态<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span>下采取行动<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span>时，相对于随机采取行动所能获得的额外回报。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>A</mi><mi>π</mi></msup><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>Q</mi><mi>π</mi></msup><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>−</mo><msup><mi>V</mi><mi>π</mi></msup><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A^\pi(s,a)=Q^\pi(s,a)-V^\pi(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span></div>
<p>上文提到，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>V</mi><mi>π</mi></msup><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V^\pi(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span> 是“平均预期回报”（根据策略的随机选择），而 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Q</mi><mi>π</mi></msup><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q^\pi(s,a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></span> 是“特定动作的预期回报”。
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>V</mi><mi>π</mi></msup><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V^\pi(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span> 代表了策略 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span> 在状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span> 下的“基准线”（baseline），即如果智能体按照策略随机选择动作，能获得的平均收益。减去这个基准，就能突出动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span> 的“额外贡献”。</p>
<ul>
<li>如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>A</mi><mi>π</mi></msup><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">A^\pi(s,a) &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>：说明执行动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span> 的预期回报高于平均水平，这个动作“优于”策略的平均选择。</li>
<li>如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>A</mi><mi>π</mi></msup><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">A^\pi(s,a) &lt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>：说明执行动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span> 的预期回报低于平均水平，这个动作“劣于”策略的平均选择。</li>
<li>如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>A</mi><mi>π</mi></msup><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">A^\pi(s,a) = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>：说明执行动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span> 的预期回报正好等于平均水平，这个动作“中规中矩”。</li>
</ul>
<p>注意，这里“随机采取行动”指的是按照策略 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span> 的概率分布选择动作，而不是完全均匀随机。</p>
<h4 data-id="heading-11">时序差分误差</h4>
<p>在单步时序差分方法中，时序差分误差用于更新价值函数。
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi><mo>=</mo><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><msup><mi>V</mi><msub><mi>π</mi><mi>θ</mi></msub></msup><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>−</mo><msup><mi>V</mi><msub><mi>π</mi><mi>θ</mi></msub></msup><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\delta = r_t+\gamma V^{\pi_\theta}(s_{t+1})-V^{\pi_\theta}(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03785em;">δ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<h4 data-id="heading-12">Actor-Critic算法介绍</h4>
<p>在上文介绍的REINFORCE策略梯度公式中，目标函数的梯度有一项轨迹回报 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(\tau)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span></span></span></span></span>，用于指导策略的更新。能否拟和一个<strong>价值函数</strong>来指导策略进行学习呢？如下图所示。</p>
<p>这正式<strong>Actor-Critic</strong>算法所做的。我们可以将策略梯度写成更一般的形式：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="normal">∇</mi><mi>J</mi><mo stretchy="false">(</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><msub><mi>E</mi><mrow><mi>τ</mi><mo>∼</mo><msub><mi>π</mi><mi>θ</mi></msub></mrow></msub><mo stretchy="false">[</mo><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>T</mi><mo>−</mo><mn>1</mn></mrow></munderover><msub><mi mathvariant="normal">Ψ</mi><mi>t</mi></msub><mi mathvariant="normal">∇</mi><mi>l</mi><mi>o</mi><mi>g</mi><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>≈</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>n</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>N</mi><mo>−</mo><mn>1</mn></mrow></munderover><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><mrow><msub><mi>T</mi><mi>n</mi></msub><mo>−</mo><mn>1</mn></mrow></munderover><msub><mi mathvariant="normal">Ψ</mi><mi>t</mi></msub><mi mathvariant="normal">∇</mi><mi>l</mi><mi>o</mi><mi>g</mi><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\nabla J(\pi_{\theta}) &amp; =E_{\tau\sim\pi_{\theta}}[\sum_{t=0}^{T-1}\Psi_{t}\nabla log\pi_{\theta}(a_{t}|s_{t})] \\
 &amp; \approx\frac{1}{N}\sum_{n=0}^{N-1}\sum_{t=0}^{T_{n}-1}\Psi_{t}\nabla log\pi_{\theta}(a_{t}|s_{t})
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6.802em;vertical-align:-3.151em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.651em;"><span style="top:-5.6621em;"><span class="pstrut" style="height:3.8394em;"/><span class="mord"><span class="mord">∇</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.2555em;"><span class="pstrut" style="height:3.8394em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.151em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.651em;"><span style="top:-5.6621em;"><span class="pstrut" style="height:3.8394em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2559em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">Ψ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∇</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)]</span></span></span><span style="top:-2.2555em;"><span class="pstrut" style="height:3.8394em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8394em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3111em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord">Ψ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∇</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.151em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Ψ</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\Psi_{t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord">Ψ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>的形式有多种：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><mi>T</mi></msubsup><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\sum_{t=0}^Tr_{t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2809em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：轨迹的总回报。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>t</mi></mrow><mi>T</mi></msubsup><msub><mi>r</mi><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub></mrow><annotation encoding="application/x-tex">\sum_{t^{\prime}=t}^Tr_{t^{\prime}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2809em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：动作<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>之后的回报。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>t</mi></mrow><mi>T</mi></msubsup><msub><mi>r</mi><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mo>−</mo><mi>b</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum_{t^{\prime}=t}^Tr_{t^{\prime}}-b(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2809em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：基线版本的改进公式。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Q</mi><mi>π</mi></msup><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q^\pi(s_t,a_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：动作价值函数。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>A</mi><msub><mi>π</mi><mi>θ</mi></msub></msup><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A^{\pi_\theta}(s_t,a_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：优势函数。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><msup><mi>V</mi><msub><mi>π</mi><mi>θ</mi></msub></msup><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>−</mo><msup><mi>V</mi><msub><mi>π</mi><mi>θ</mi></msub></msup><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">r_t+\gamma V^{\pi_\theta}(s_{t+1})-V^{\pi_\theta}(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：时序差分误差。</li>
</ul>
<p>此处讨论的是第六种——时序差分残差<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Ψ</mi><mi>t</mi></msub><mo>=</mo><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><msup><mi>V</mi><msub><mi>π</mi><mi>θ</mi></msub></msup><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>−</mo><msup><mi>V</mi><msub><mi>π</mi><mi>θ</mi></msub></msup><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Psi_{t}=r_t+\gamma V^{\pi_\theta}(s_{t+1})-V^{\pi_\theta}(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord">Ψ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>来指导策略梯度进行学习。
Actor称为<strong>策略网络</strong>，Critic称为<strong>价值网络</strong>。</p>
<ul>
<li>Actor 要做的是与环境交互，并在 Critic 价值函数的指导下用策略梯度学习一个更好的策略。</li>
<li>Critic 要做的是通过 Actor 与环境交互收集的数据学习一个价值函数，这个价值函数会用于判断在当前状态什么动作是好的，什么动作不是好的，进而帮助 Actor 进行策略更新。</li>
</ul>
<h4 data-id="heading-13">Actor的优化目标</h4>
<p><strong>Actor</strong>：负责学习并改进策略 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mi>a</mi><mi mathvariant="normal">∣</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\pi_\theta(a|s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mord">∣</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span>，即在给定状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span> 下选择动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span> 的概率分布。Actor 的目标是通过调整参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span>，让策略更倾向于选择高回报的动作。</p>
<p><strong>Critic</strong>：负责估计价值函数（如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>V</mi><mi>π</mi></msup><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V^\pi(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span> 或 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Q</mi><mi>π</mi></msup><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q^\pi(s, a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></span>），为 Actor 提供反馈，评估当前策略的“好坏”或动作的“优势”（advantage）。</p>
<p>此处，不能忘记Actor的目标仍然是最大化策略的期望回报，即<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi mathvariant="double-struck">E</mi><mrow><mi>τ</mi><mo>∼</mo><msub><mi>π</mi><mi>θ</mi></msub></mrow></msub><mrow><mo fence="true">[</mo><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">J(\theta)=\mathbb{E}_{\tau\sim\pi_\theta}\left[R(\tau)\right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0059em;vertical-align:-0.2559em;"/><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2559em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span></span></span>。
在 Actor-Critic 中，Actor 的优化目标通常改用优势函数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>A</mi><msub><mi>π</mi><mi>θ</mi></msub></msup><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A^{\pi_\theta}(s_t,a_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>替换<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(\tau)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span></span></span></span></span>来降低方差。公式为</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>a</mi><mi>r</mi><mi>g</mi><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><msub><mi>π</mi><mi>θ</mi></msub></munder><mi>J</mi><mo stretchy="false">(</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><msub><mi>E</mi><mrow><mi>τ</mi><mo>∼</mo><msub><mi>π</mi><mi>θ</mi></msub></mrow></msub><mo stretchy="false">[</mo><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><mi>T</mi></munderover><msub><mi>A</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mi>l</mi><mi>o</mi><mi>g</mi><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>≈</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>n</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>N</mi><mo>−</mo><mn>1</mn></mrow></munderover><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><msub><mi>T</mi><mi>n</mi></msub></munderover><mo stretchy="false">(</mo><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><msub><mi>V</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>−</mo><msub><mi>V</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mi>l</mi><mi>o</mi><mi>g</mi><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
arg\max_{\pi_{\theta}}J(\pi_{\theta}) &amp; =E_{\tau\sim\pi_{\theta}}[\sum_{t=0}^{T}A_{\phi}(s_{t},a_{t})log\pi_{\theta}(a_{t}|s_{t})] \\
 &amp; \approx\frac{1}{N}\sum_{n=0}^{N-1}\sum_{t=0}^{T_n}(r_t+\gamma V_\phi(s_{t+1})-V_\phi(s_t))log\pi_\theta(a_t|s_t)
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:6.802em;vertical-align:-3.151em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.651em;"><span style="top:-5.6621em;"><span class="pstrut" style="height:3.8394em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.4em;margin-left:0em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span><span class="mop">max</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8059em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.2555em;"><span class="pstrut" style="height:3.8394em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.151em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.651em;"><span style="top:-5.6621em;"><span class="pstrut" style="height:3.8394em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.1132em;">τ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2559em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)]</span></span></span><span style="top:-2.2555em;"><span class="pstrut" style="height:3.8394em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8394em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3111em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">))</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.151em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><msub><mi>V</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">r_t + \gamma V_\phi(s_{t+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：TD 目标（TD target），即即时奖励 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 加上折扣后的下一状态价值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><msub><mi>V</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\gamma V_\phi(s_{t+1})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>。<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span></span> 是折扣因子（0 ≤ γ &lt; 1），表示对未来奖励的重视程度。</p>
<p>实际上，在单步更新中优势可以由 TD_error 近似（如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo>≈</mo><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>−</mo><mi>V</mi><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A(s_t, a_t) \approx r_t + \gamma V(s_{t+1}) - V(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">γV</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>）。所以我们不需要等到一个回合（episode）结束后再去优化，而是针对每个时间步 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span> 的状态-动作对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(s_t, a_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 进行调整。也就是说智能体通过在每个时间步上学习，逐步改进策略，而不用等到回合结束。</p>
<p><strong>注：每个时间步 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span> 包括以下过程：</strong></p>
<ul>
<li>观察状态：智能体接收到环境的当前状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（比如游戏中的屏幕图像、机器人位置等）。</li>
<li>选择动作：根据策略 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span>（或 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">\pi_\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>），智能体选择一个动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（比如“向右移动”、“跳跃”）。</li>
<li>执行动作并获得反馈：智能体执行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，环境根据规则返回：
<ul>
<li>即时奖励 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">r_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（比如得分 +1 或惩罚 -1）。</li>
<li>下一状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">s_{t+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span></span></span></span></span>（环境因动作变化后的新状态）。</li>
</ul>
</li>
<li>重复：进入下一个时间步 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">t+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6984em;vertical-align:-0.0833em;"/><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，继续这个循环。</li>
</ul>
<h4 data-id="heading-14">Critic的优化目标</h4>
<p>Critic承担的角色：（1）价值函数估计：估计智能体在当前策略 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span> 下，从某个状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span> 开始所能获得的预期累计回报。（2）反馈 Actor：Critic 的估计用于指导 Actor 更新策略。</p>
<p>Critic 的优化目标是使估计的价值函数尽可能接近环境的真实价值函数（true value function）。这通常通过最小化预测值与目标值之间的误差来实现。目标函数通常基于时序差分误差（TD_Error），因为它允许在线学习，而无需等待回合结束。</p>
<p>Critic的优化目标为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>a</mi><mi>r</mi><mi>g</mi><munder><mrow><mi>min</mi><mo>⁡</mo></mrow><msub><mi>V</mi><mi>ϕ</mi></msub></munder><mi>L</mi><mo stretchy="false">(</mo><msub><mi>V</mi><mi>ϕ</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi>E</mi><mi>t</mi></msub><mo stretchy="false">[</mo><mo stretchy="false">(</mo><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><msub><mi>V</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>−</mo><msub><mi>V</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">arg\min_{V_\phi}L(V_\phi)=E_t[(r_t+\gamma V_\phi(s_{t+1})-V_\phi(s_t))^2]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.6974em;vertical-align:-0.9474em;"/><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6679em;"><span style="top:-2.3557em;margin-left:0em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.2222em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2901em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9474em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">[(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1502em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></div>
<p>设当前策略为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span> ，配套价值函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>π</mi></msub></mrow><annotation encoding="application/x-tex">V_\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 可精准评估其价值。对于状态 - 动作对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(s_t, a_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> ，定义<strong>优势函数</strong>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>A</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mtext>  </mtext><mo>=</mo><mtext>  </mtext><msub><mi>Q</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mtext>  </mtext><mo>−</mo><mtext>  </mtext><msub><mi>V</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A_\pi(s_t, a_t) \;=\; Q_\pi(s_t, a_t) \;-\; V_\pi(s_t) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q_\pi(s_t, a_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 为“状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 下执行动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的价值期望”（动作价值函数 ）。若 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A_\pi(s_t, a_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 较大，说明 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 下“相对更优”，需提升条件概率 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\pi(a_t \vert s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 。通过逐状态调整动作概率分布，最终得到更新策略 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>π</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">\pi'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> 。</p>
<p>当且仅当：对任意状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> ，若客观最优动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>a</mi><mi>t</mi><mo>∗</mo></msubsup></mrow><annotation encoding="application/x-tex">a_t^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9357em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span> 存在，则策略输出 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>a</mi><mi>t</mi><mo>∗</mo></msubsup></mrow><annotation encoding="application/x-tex">a_t^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9357em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span> 的条件概率满足：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>π</mi><mo stretchy="false">(</mo><msubsup><mi>a</mi><mi>t</mi><mo>∗</mo></msubsup><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mtext>  </mtext><mo>=</mo><mtext>  </mtext><mn>1</mn><mspace width="1em"/><mtext>（或全局最大概率）</mtext></mrow><annotation encoding="application/x-tex">\pi(a_t^* \vert s_t) \;=\; 1 \quad \text{（或全局最大概率）} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:1em;"/><span class="mord text"><span class="mord cjk_fallback">（或全局最大概率）</span></span></span></span></span></span></div>
<p>此时策略无提升空间，称 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>π</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><msup><mi>π</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">\pi' = \pi^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6887em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span> （前提：价值函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>π</mi></msub></mrow><annotation encoding="application/x-tex">V_\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 始终精准，可准确度量策略价值 ）。</p>
<p>当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi><mo stretchy="false">(</mo><msubsup><mi>a</mi><mi>t</mi><mo>∗</mo></msubsup><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\pi(a_t^* \vert s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 取最大值（或 1 ）时，由价值函数与动作价值函数的关系：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>V</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mtext>  </mtext><mo>=</mo><mtext>  </mtext><munder><mo>∑</mo><mrow><mi>a</mi><mo>∈</mo><mi mathvariant="script">A</mi></mrow></munder><mi>π</mi><mo stretchy="false">(</mo><mi>a</mi><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mtext> </mtext><msub><mi>Q</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V_\pi(s_t) \;=\; \sum_{a \in \mathcal{A}} \pi(a \vert s_t) \, Q_\pi(s_t, a) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.3717em;vertical-align:-1.3217em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8557em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mrel mtight">∈</span><span class="mord mathcal mtight">A</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3217em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></span></div>
<p>由于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>a</mi><mi>t</mi><mo>∗</mo></msubsup></mrow><annotation encoding="application/x-tex">a_t^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9357em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span> 概率占优，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V_\pi(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 会逼近 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msubsup><mi>a</mi><mi>t</mi><mo>∗</mo></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q_\pi(s_t, a_t^*)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> ，因此优势满足：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>A</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msubsup><mi>a</mi><mi>t</mi><mo>∗</mo></msubsup><mo stretchy="false">)</mo><mtext>  </mtext><mo>=</mo><mtext>  </mtext><msub><mi>Q</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msubsup><mi>a</mi><mi>t</mi><mo>∗</mo></msubsup><mo stretchy="false">)</mo><mtext>  </mtext><mo>−</mo><mtext>  </mtext><msub><mi>V</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mtext>  </mtext><mo>→</mo><mtext>  </mtext><mn>0</mn></mrow><annotation encoding="application/x-tex">A_\pi(s_t, a_t^*) \;=\; Q_\pi(s_t, a_t^*) \;-\; V_\pi(s_t) \;\to\; 0 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></div>
<p>解释：优势趋于 0 ，不代表动作“无好坏差异”，而是策略已逼近最优——此时最优动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>a</mi><mi>t</mi><mo>∗</mo></msubsup></mrow><annotation encoding="application/x-tex">a_t^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9357em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span> 的输出概率天然最大，无需再靠“优势差值”区分。但在<strong>策略未收敛阶段</strong>，优势可有效识别“当前状态下更值得提升的动作”。
策略更新为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>π</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">\pi'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> 后，原价值函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>π</mi></msub></mrow><annotation encoding="application/x-tex">V_\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 不再适配（因策略分布改变，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>π</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V_\pi(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 的加权求和基础已变 ）。需重新拟合价值函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><msup><mi>π</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub></mrow><annotation encoding="application/x-tex">V_{\pi'}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> ，使其满足：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>V</mi><msup><mi>π</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mtext>  </mtext><mo>=</mo><mtext>  </mtext><munder><mo>∑</mo><mrow><mi>a</mi><mo>∈</mo><mi mathvariant="script">A</mi></mrow></munder><msup><mi>π</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">(</mo><mi>a</mi><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mtext> </mtext><msub><mi>Q</mi><msup><mi>π</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V_{\pi'}(s_t) \;=\; \sum_{a \in \mathcal{A}} \pi'(a \vert s_t) \, Q_{\pi'}(s_t, a) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.3717em;vertical-align:-1.3217em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8557em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mrel mtight">∈</span><span class="mord mathcal mtight">A</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3217em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></span></div>
<p>拟合逻辑为：<strong>让左侧 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><msup><mi>π</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V_{\pi'}(s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 匹配右侧新分布的加权结果</strong>，从而为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>π</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">\pi'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> 构建精准的价值评估体系，支撑下一轮策略迭代。</p>
<h2 data-id="heading-15">PPO算法</h2>
<h3 data-id="heading-16">朴素Actor-Critic算法</h3>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="normal">∇</mi><mi>J</mi><mo stretchy="false">(</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><msub><mi>E</mi><mi>t</mi></msub><mo stretchy="false">[</mo><msub><mi>A</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mi mathvariant="normal">∇</mi><mi>l</mi><mi>o</mi><mi>g</mi><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>≈</mo><mfrac><mn>1</mn><mrow><mi>N</mi><mo>∗</mo><mi>T</mi></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>n</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>N</mi><mo>−</mo><mn>1</mn></mrow></munderover><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><mrow><msub><mi>T</mi><mi>n</mi></msub><mo>−</mo><mn>1</mn></mrow></munderover><mo stretchy="false">(</mo><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><msub><mi>V</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>−</mo><msub><mi>V</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mi mathvariant="normal">∇</mi><mi>l</mi><mi>o</mi><mi>g</mi><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\nabla J(\pi_{\theta}) &amp; =E_t[A_\phi(s_t,a_t)\nabla log\pi_\theta(a_t|s_t)] \\
 &amp; \approx\frac{1}{N*T}\sum_{n=0}^{N-1}\sum_{t=0}^{T_n-1}(r_t+\gamma V_\phi(s_{t+1})-V_\phi(s_t))\nabla log\pi_\theta(a_t|s_t)
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.9065em;vertical-align:-2.2033em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.7033em;"><span style="top:-5.7027em;"><span class="pstrut" style="height:3.8394em;"/><span class="mord"><span class="mord">∇</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.2033em;"><span class="pstrut" style="height:3.8394em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.2033em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.7033em;"><span style="top:-5.7027em;"><span class="pstrut" style="height:3.8394em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord">∇</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)]</span></span></span><span style="top:-3.2033em;"><span class="pstrut" style="height:3.8394em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8394em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3111em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">))</span><span class="mord">∇</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.2033em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>注意：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi></mrow><annotation encoding="application/x-tex">\phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">ϕ</span></span></span></span></span>是Critic网络的参数，但仍需时刻记住<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>ϕ</mi></msub></mrow><annotation encoding="application/x-tex">V_\phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>是策略<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span></span></span>的价值，当策略发生变动时，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>ϕ</mi></msub></mrow><annotation encoding="application/x-tex">V_\phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>也会发生变化。</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><mi>J</mi><mo stretchy="false">(</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\nabla J(\pi_{\theta})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∇</span><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：策略 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">\pi_\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的性能目标 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo stretchy="false">(</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">J(\pi_\theta)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>（通常是预期累计回报）对参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> 的梯度，表示调整 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> 能使 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi></mrow><annotation encoding="application/x-tex">J</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.09618em;">J</span></span></span></span></span> 增加的方向。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mi>t</mi></msub><mo stretchy="false">[</mo><mo>⋅</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">E_t [\cdot]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord">⋅</span><span class="mclose">]</span></span></span></span></span>：对时间步 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span> 的期望，基于策略 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">\pi_\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和环境动态生成的轨迹 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>r</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><mo>…</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(s_t, a_t, r_t, s_{t+1}, \ldots)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mclose">)</span></span></span></span></span> 计算。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A_\phi(s_t, a_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：优势函数（advantage function），由 Critic 参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϕ</mi></mrow><annotation encoding="application/x-tex">\phi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">ϕ</span></span></span></span></span> 估计，表示动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 在状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 下相对于平均水平的“额外回报”。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><mi>log</mi><mo>⁡</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\nabla \log \pi_\theta(a_t | s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∇</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：策略 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">\pi_\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 在状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 下选择动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">a_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的对数概率对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span></span> 的梯度，是策略梯度的核心部分。</li>
<li>近似部分：用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 个回合（或批次）中的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span></span> 个时间步的样本平均近似期望，具体为：
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mrow><mi>N</mi><mo>⋅</mo><mi>T</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{N \cdot T}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">⋅</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span>：归一化因子，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 是回合数，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">T_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 是第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 个回合的时间步数，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span></span> 是总时间步数的近似平均。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>n</mi><mo>=</mo><mn>0</mn></mrow><mrow><mi>N</mi><mo>−</mo><mn>1</mn></mrow></msubsup><msubsup><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>0</mn></mrow><mrow><msub><mi>T</mi><mi>n</mi></msub><mo>−</mo><mn>1</mn></mrow></msubsup></mrow><annotation encoding="application/x-tex">\sum_{n=0}^{N-1} \sum_{t=0}^{T_n-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2809em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span></span></span></span></span>：对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 个回合和每个回合的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">T_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 个时间步求和。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>r</mi><mi>t</mi></msub><mo>+</mo><mi>γ</mi><msub><mi>V</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>−</mo><msub><mi>V</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(r_t + \gamma V_\phi(s_{t+1}) - V_\phi(s_t))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">))</span></span></span></span></span>：时序差分误差（TD Error），用作优势 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><msub><mi>s</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A_\phi(s_t, a_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 的单步估计。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><mi>log</mi><mo>⁡</mo><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>a</mi><mi>t</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>s</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\nabla \log \pi_\theta(a_t | s_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∇</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：每个时间步的策略梯度项。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-17">PPO算法实现</h4>
<p>在SFT中，我们是去训练模型去模仿给定的一组高质量样本中的响应，然而，这通常不能减轻语言模型在预训练阶段学到的不良行为。对齐语言模型时，从我们试图改进的模型本身获取相应，并根据对这些相应质量和合理性的某种评估给予奖励或惩罚。
首先，我们准备一组提示，提供给我们经过SFT之后的模型；然后，从模型中获取针对每个提示的多组相应。（SFT是通过最小化逐个 Token 的交叉熵损失来学习，而是奖励模型去优化一个标量的奖励信号去衡量相应对于给定提示的恰当程度）。
HF是指在原始方法中，这种奖励信号是通过在人类标注的数据上拟合模型得到的，人类会手动对给定的多组相应进行排序。
RLHF 的步骤：</p>
<ol>
<li>生成相应并获取人类排名：对于每个输入提示，让经过SFT后的模型生成K个不同的响应。然后，人类标注者对这K个相应进行排序。</li>
<li>训练奖励模型（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">r_{\theta}(x,y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span>），对提示-相应对（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo separator="true">,</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">x,y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span>）打分，即输出一个标量奖励值。这里奖励模型以SFT模型为基础，移除最后的输出层，并添加一个新的输出层，使其仅输出一个标量值。然后，从人类排名数据集中采样提示以及一对相应<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>w</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>l</mi></msub></mrow><annotation encoding="application/x-tex">y_w,y_l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">y_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>表示更好的响应，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>l</mi></msub></mrow><annotation encoding="application/x-tex">y_l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>表示较差的响应（即<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">y_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>的评分高于<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>l</mi></msub></mrow><annotation encoding="application/x-tex">y_l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>），优化下面的损失函数。</li>
</ol>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi mathvariant="normal">ℓ</mi><mi>θ</mi><mi>r</mi></msubsup><mrow><mo fence="true">(</mo><mi>x</mi><mo separator="true">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>l</mi></msub><mo fence="true">)</mo></mrow><mo>=</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mi>σ</mi><mrow><mo fence="true">(</mo><msub><mi>r</mi><mi>θ</mi></msub><mrow><mo fence="true">(</mo><mi>x</mi><mo separator="true">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo fence="true">)</mo></mrow><mo>−</mo><msub><mi>r</mi><mi>θ</mi></msub><mrow><mo fence="true">(</mo><mi>x</mi><mo separator="true">,</mo><msub><mi>y</mi><mi>l</mi></msub><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\ell_\theta^r\left(x,y_w,y_l\right)=-\log\sigma\left(r_\theta\left(x,y_w\right)-r_\theta\left(x,y_l\right)\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord">ℓ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span></span>是 sigmoid 函数（将差值转换为 0-1 之间的概率）。</p>
<p>我们希望奖励模型输出的标量奖励与人类标注者的排名一致；奖励模型<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></span>与人类数据的一致性越高，损失<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="normal">ℓ</mi><mi>r</mi></msup></mrow><annotation encoding="application/x-tex">\ell^{r}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord"><span class="mord">ℓ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span></span></span></span></span></span></span></span></span>就越低。得到奖励模型后，RLHF 通过强化学习（RL）来优化语言模型（LM），此时我们将语言模型视为一个策略<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">\pi_{\theta}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，它接收一个提示并在每一步选择要生成的Token，直到完成响应（结束一个强化学习 “轮次”），此时它会获得由<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">r_{\theta}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>给出的奖励。原始论文使用近端策略优化（PPO）算法，借助奖励模型来训练语言模型。
此外，在 GPT-3 模型上应用 RLHF 的论文发现，有两点很重要：（a）添加 KL 散度惩罚项，以防止模型与 SFT 基准模型偏离过大；（b）使用预训练（语言建模）目标作为辅助损失函数，以避免下游任务性能退化。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a46a6dfc88ff40a2a69b573a60da511e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGhu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767171830&amp;x-signature=yi8nVat8BAm3kxTYyMIN6PMgIqs%3D" alt="微信图片_20251224165332_1982_219.png" loading="lazy"/>
图中 Policy LM 是策略（语言）模型，SFT Model 是基准模型，Reward Model 是奖励模型，Value Model 是价值模型。</p>
<h4 data-id="heading-18">重要性采样</h4>
<h2 data-id="heading-19">DPO</h2>
<p>在RLHF中，我们首先利用收集到的偏好数据来显式地拟合一个奖励模型<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">r_{\theta}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，然后优化语言模型，使其生成能获得更高奖励的响应。而DPO的出发点是：不必须先找到一个与偏好数据一致的最优奖励模型<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></span>，再为该奖励模型找到一个最优策略<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">\pi_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。而是，我们可以推导出最优奖励模型的一种重新参数化形式，这种形式可以用最优策略它本身来表示。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>r</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mi>β</mi><mi>log</mi><mo>⁡</mo><mfrac><mrow><msub><mi>π</mi><mi>r</mi></msub><mo stretchy="false">(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo></mrow><mrow><msub><mi>π</mi><mrow><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">f</mi></mrow></msub><mo stretchy="false">(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>+</mo><mi>β</mi><mi>log</mi><mo>⁡</mo><mi>Z</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">r(x,y)=\beta\log\frac{\pi_r(y|x)}{\pi_\mathrm{ref}(y|x)}+\beta\log Z(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight" style="margin-right:0.07778em;">ref</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></div>
<p>这里，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mtext>ref</mtext></msub></mrow><annotation encoding="application/x-tex">\pi_{\text{ref}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ref</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>是 “参考策略”：即经过有监督微调（SFT）后的原始语言模型，我们不希望新模型与其偏离过大；<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span>是一个超参数，用于控制偏离 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mtext>ref</mtext></msub></mrow><annotation encoding="application/x-tex">\pi_{\text{ref}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">ref</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 时的惩罚强度。<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">\pi_{r}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 是奖励模型 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span></span> 对应的最优策略 —— 本质上，就是根据该奖励模型得到的最优语言模型。需要注意的是，式中的第二项仅依赖于一个与指令相关的归一化常数（配分函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Z(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>），而与补全内容 y 无关。
在RLHF中，原始的奖励模型的损失函数仅依赖于两个响应的奖励之差，与单个响应的绝对奖励无关。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="normal">ℓ</mi><mrow><mi mathvariant="normal">D</mi><mi mathvariant="normal">P</mi><mi mathvariant="normal">O</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi>π</mi><mi>θ</mi></msub><mo separator="true">,</mo><msub><mi>π</mi><mrow><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">f</mi></mrow></msub><mo separator="true">,</mo><mi>x</mi><mo separator="true">,</mo><msub><mi>y</mi><mi>w</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>l</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><mi>σ</mi><mrow><mo fence="true">(</mo><mi>β</mi><mi>log</mi><mo>⁡</mo><mfrac><mrow><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>w</mi></msub><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo></mrow><mrow><msub><mi>π</mi><mrow><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">f</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>w</mi></msub><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>−</mo><mi>β</mi><mi>log</mi><mo>⁡</mo><mfrac><mrow><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>l</mi></msub><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo></mrow><mrow><msub><mi>π</mi><mrow><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">f</mi></mrow></msub><mo stretchy="false">(</mo><msub><mi>y</mi><mi>l</mi></msub><mi mathvariant="normal">∣</mi><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\ell_{\mathrm{DPO}}(\pi_\theta,\pi_{\mathrm{ref}},x,y_w,y_l)=-\log\sigma\left(\beta\log\frac{\pi_\theta(y_w|x)}{\pi_{\mathrm{ref}}(y_w|x)}-\beta\log\frac{\pi_\theta(y_l|x)}{\pi_{\mathrm{ref}}(y_l|x)}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord">ℓ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight">DPO</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight" style="margin-right:0.07778em;">ref</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight" style="margin-right:0.07778em;">ref</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathrm mtight" style="margin-right:0.07778em;">ref</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span></span></span></span></span></div>
<p>为计算损失，不需要再对齐过程中对补全内容进行采样，只需要计算条件对数概率即可。所以，这里没有显式的强化学习过程在进行。此外，偏好数据也不一定必须来自人类标注者——可以是来自于其他语言模型生成的偏好数据，这些语言模型通常会被提示根据一系列标准，对同一查询的两组备选响应进行评判。所以，这个过程也不一定涉及人类反馈。</p>
<h2 data-id="heading-20">GRPO</h2>
<p>群体相对策略优化,英文全称为Group Relative Policy Optimization，简称为GRPO。这是一种策略梯度的变体。</p>
<h3 data-id="heading-21">优势估计</h3>
<p>群体相对策略优化（GRPO）的核心思想是：从策略<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>θ</mi></msub></mrow><annotation encoding="application/x-tex">\pi_{\theta}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>中为每个问题采样多个输出，并利用这些输出计算基线。这种方式十分便捷，因为它避免了学习神经价值函数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>ϕ</mi></msub><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V_{\phi}(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ϕ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span>—— 这类函数不仅难以训练，而且从系统角度来看操作繁琐。对于某个问题<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span></span>以及从<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mi>θ</mi></msub><mo stretchy="false">(</mo><mo>⋅</mo><mi mathvariant="normal">∣</mi><mi>q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\pi_{\theta}(\cdot | q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">⋅</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mclose">)</span></span></span></span></span>中采样得到的群体输出<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msup><mi>o</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msubsup><mo stretchy="false">}</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>G</mi></msubsup></mrow><annotation encoding="application/x-tex">\{o^{(i)}\}_{i=1}^{G}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1467em;vertical-align:-0.2587em;"/><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">}</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">G</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span></span></span></span></span>，令<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>r</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mi>R</mi><mo stretchy="false">(</mo><mi>q</mi><mo separator="true">,</mo><msup><mi>o</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">r^{(i)} = R(q, o^{(i)})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>表示第i个输出的奖励。DeepSeekMath（Shao 等人，2024）和 DeepSeek R1（DeepSeek-AI 等人，2025）将第i个输出的群体归一化奖励计算为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>A</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mfrac><mrow><msup><mi>r</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><msup><mi>r</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi>r</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msup><mi>r</mi><mrow><mo stretchy="false">(</mo><mi>G</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><mrow><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">d</mi></mrow><mo stretchy="false">(</mo><msup><mi>r</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi>r</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msup><mi>r</mi><mrow><mo stretchy="false">(</mo><mi>G</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>+</mo><msub><mrow><mi mathvariant="normal">a</mi><mi mathvariant="normal">d</mi><mi mathvariant="normal">v</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">g</mi><mi mathvariant="normal">e</mi></mrow><mrow><mi mathvariant="normal">e</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">s</mi></mrow></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">A^{(i)}=\frac{r^{(i)}-\mathrm{mean}(r^{(1)},r^{(2)},\ldots,r^{(G)})}{\mathrm{std}(r^{(1)},r^{(2)},\ldots,r^{(G)})+\mathrm{advantage}_\mathrm{eps}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.938em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.6492em;vertical-align:-1.0842em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.296em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathrm">std</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">G</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord"><span class="mord mathrm">advantage</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0573em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathrm mtight">eps</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathrm">mean</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">G</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0842em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>advantage_eps</mtext></mrow><annotation encoding="application/x-tex">\text{advantage\_eps}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord text"><span class="mord">advantage_eps</span></span></span></span></span></span>是一个小常数，用于防止除以零的情况。需要注意的是，该优势值<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>A</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">A^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span>对于响应中的每个 token 都是相同的，即对于所有<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>∈</mo><mo stretchy="false">{</mo><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi mathvariant="normal">∣</mi><msup><mi>o</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mi mathvariant="normal">∣</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">t \in \{1, \ldots, |o^{(i)}|\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6542em;vertical-align:-0.0391em;"/><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.138em;vertical-align:-0.25em;"/><span class="mopen">{</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mclose">}</span></span></span></span></span>，都有<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>A</mi><mi>t</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo>=</mo><msup><mi>A</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">A_{t}^{(i)} = A^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2906em;vertical-align:-0.2458em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4542em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2458em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.888em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span>，因此在后续内容中我们将省略下标<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谁还敢说谷歌掉队？2025年，它打了一场漂亮的翻身仗]]></title>    <link>https://juejin.cn/post/7587062584165777446</link>    <guid>https://juejin.cn/post/7587062584165777446</guid>    <pubDate>2025-12-24T09:51:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587062584165777446" data-draft-id="7587239837972480051" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谁还敢说谷歌掉队？2025年，它打了一场漂亮的翻身仗"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-24T09:51:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谁还敢说谷歌掉队？2025年，它打了一场漂亮的翻身仗
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:51:54.000Z" title="Wed Dec 24 2025 09:51:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在即将过去的 2025 年，谷歌在人工智能领域交出了一份颇具分量的成绩单。</p>
<p>曾因「<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650999410%26idx%3D1%26sn%3Ddc8b37c38a7805b21065f8d7ffe23269%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650999410&amp;idx=1&amp;sn=dc8b37c38a7805b21065f8d7ffe23269&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">发表了 Transformer 却痛失先机</a>」而备受外界质疑，谷歌一度深陷「大模型掉队」的舆论漩涡。但这一年，谷歌用一系列里程碑式的发布打了一场漂亮的翻身仗。它向世界证明，AI 不再只是陪聊的机器人，而是变成了能写代码、能做科研、甚至攻克前沿科学难题的「合作伙伴」。</p>
<p>看看 Demis Hassabis 晒出的这张年度成绩单，Gemini 3、Genie 3、Veo 3、Nano Banana... 确实硕果累累。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/542a20a771ef45e896447d0c75487635~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=%2F15PTynX3DLM0Wl%2BMmA2TR%2F56%2BY%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/031e45a8e6724635a1cfa892ece1e17a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=Lka%2Fd3HuetA%2ByN6bIxVH6cWMkgw%3D" alt="图片" loading="lazy"/></p>
<p>同时，谷歌官方博客发布年终研究进展总结报告，详细盘点了谷歌 2025 年的研究突破，作者包括 Jeff Dean、Demis Hassabis、James Manyika。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43e0f35d9ded491a968af9d6b92cfd93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=9RavihPgv%2B8kDqt6L7ykOAvcQuw%3D" alt="图片" loading="lazy"/></p>
<p>博客地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.google%2Ftechnology%2Fai%2F2025-research-breakthroughs%2F%255B%23ai%255D()-models" target="_blank" title="https://blog.google/technology/ai/2025-research-breakthroughs/%5B#ai%5D()-models" ref="nofollow noopener noreferrer">blog.google/technology/…</a></p>
<p>在深入细节之前，我们先快速梳理谷歌本年度的几大「杀手锏」。</p>
<ul>
<li>
<p>模型侧： Gemini 3 强势登顶，逻辑推理与数学能力刷新纪录，Flash 版本性价比超越前代 Pro。</p>
</li>
<li>
<p>硬件侧： 第七代 TPU Ironwood 算力暴涨，剑指英伟达；量子计算实现「量子回声」突破。</p>
</li>
<li>
<p>应用侧： AI 不再只是 Chatbot，通过 Antigravity 重塑编程，通过 Veo 3 和 Genie 3 彻底改变视频生成与世界模拟。</p>
</li>
<li>
<p>科学侧： AlphaFold 五周年里程碑与诺贝尔化学奖的双重加冕，奠定了 AI for Science 的领先地位。Gemini Deep Think 也在数学奥赛（IMO）与编程竞赛（ICPC）中双双达到金牌水平，标志着 AI 抽象推理能力的质变。</p>
</li>
</ul>
<p>以下是我们基于官方博文整理的详细技术盘点：</p>
<p>AI 模型：谷歌训出了奥特曼理想中的 GPT-5</p>
<p>今年 3 月，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650962030%26idx%3D2%26sn%3D8fdcead95449574b1e8f75ef537cb293%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650962030&amp;idx=2&amp;sn=8fdcead95449574b1e8f75ef537cb293&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Gemini 2.5</a> 的发布为全年的技术路线奠定了基础。而 11 月正式面世的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2651002540%26idx%3D1%26sn%3D41e7a8da8c597068c68b43315bee15ae%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2651002540&amp;idx=1&amp;sn=41e7a8da8c597068c68b43315bee15ae&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Gemini 3</a>，则被视为谷歌目前的巅峰之作。谷歌在模型推理、多模态理解以及运行效率等方面实现了多次实质性跨越。</p>
<p>作为谷歌目前性能最强的模型，Gemini 3 Pro 在逻辑推理领域表现尤为突出。它不仅迅速登顶 LMArena 排行榜，更在 Humanity’s Last Exam（旨在考察 AI 是否具备人类水平思考能力的严苛测试）中取得突破性成绩。在数学领域，它以 23.4% 的准确率刷新了 MathArena Apex 的纪录。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b291007eaf53436b9a6e042609f9c16b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=roXv6ckp39AMRh00DlzZ02BgBfA%3D" alt="图片" loading="lazy"/></p>
<p>Gemini 3 在多项关键 AI 基准测试中处于最先进水平。</p>
<p>相关链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.google%2Fproducts%2Fgemini%2Fgemini-3%2F" target="_blank" title="https://blog.google/products/gemini/gemini-3/" ref="nofollow noopener noreferrer">blog.google/products/ge…</a></p>
<p>紧随其后的 12 月，谷歌推出了针对开发者和企业级市场的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2651007872%26idx%3D1%26sn%3Db41c57b2bd3bc1b885e8c9749f03455b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2651007872&amp;idx=1&amp;sn=b41c57b2bd3bc1b885e8c9749f03455b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Gemini 3 Flash</a>。这款模型延续了谷歌「后浪推前浪」的策略，即：下一代的 Flash 模型在性能上力求超越上一代的 Pro 模型。</p>
<p>数据显示，Gemini 3 Flash 的综合质量已经超越了今年 3 月发布的 Gemini 2.5 Pro，但其成本大幅降低，延迟表现也得到了显著优化。这种「高性价比」的策略，旨在让更复杂的推理任务能够以更快的速度和更低的门槛进入实际应用场景。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8db3536fe54d4484b7e27afafdfedf20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=Ml0w5hCXCdMpKynjs29sFPyfZzQ%3D" alt="图片" loading="lazy"/></p>
<p>Gemini 3 Flash 价格及基准表。</p>
<p>相关链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.google%2Fproducts%2Fgemini%2Fgemini-3-flash%2F" target="_blank" title="https://blog.google/products/gemini/gemini-3-flash/" ref="nofollow noopener noreferrer">blog.google/products/ge…</a></p>
<p>除了闭源的 Gemini 系列，谷歌在开源领域也动作频频。Gemma 家族在今年实现了从纯文本到多模态的转型。</p>
<p>通过增加上下文窗口、扩展多语言支持以及优化在单张 GPU/TPU 上的运行效率，Gemma 3 现已成为开发者在本地部署高性能 AI 时的首选工具之一。特别是 8 月发布的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650985662%26idx%3D3%26sn%3Dee6563957fac220147807044b0c0fbdd%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650985662&amp;idx=3&amp;sn=ee6563957fac220147807044b0c0fbdd&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Gemma 3 270M</a>，以其极小的参数规模提供了超高效率，标志着谷歌在边缘侧 AI 领域的技术沉淀。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee0794597b5143208233544a9e8e7661~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=WXzSeo6cwWQvMV%2FrkefYr5sse7U%3D" alt="图片" loading="lazy"/></p>
<p>相关链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.googleblog.com%2Fen%2Fintroducing-gemma-3-270m%2F" target="_blank" title="https://developers.googleblog.com/en/introducing-gemma-3-270m/" ref="nofollow noopener noreferrer">developers.googleblog.com/en/introduc…</a></p>
<p>产品重构：AI 不再是工具</p>
<p>而是你的「合作伙伴」</p>
<p>2025 年是 AI 从「单一工具」向「核心效能」跨越的一年。Google 通过在全线产品中注入强大的 Agentic 能力，推动 AI 从辅助角色转变为实用型基础设施，重新定义了人机协作的形态。</p>
<p>在软件开发领域，Google 不再局限于提供辅助编码工具，而是致力于构建能与开发者深度协作的智能体系统。11 月发布的 Gemini 3 展现了令人印象深刻的代码生成与逻辑理解能力。同期推出的 Google Antigravity 更是标志着 AI 辅助开发进入了一个新纪元 —— 它将开发流程从传统的「工具辅助」升级为「智能体协作」，极大地释放了开发者的创造力与生产力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58f0285574ce47f7ab233fd56046f945~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=xKokQbU8RDAnssVpph67cfqZTPY%3D" alt="图片" loading="lazy"/></p>
<p>相关链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fantigravity.google%2Fblog%2Fintroducing-google-antigravity" target="_blank" title="https://antigravity.google/blog/introducing-google-antigravity" ref="nofollow noopener noreferrer">antigravity.google/blog/introd…</a></p>
<p>这种进化同样清晰地体现在 Google 的核心产品矩阵中，贯穿了从硬件终端到信息检索的每一个环节：</p>
<p>3 月，Search 迎来了重要变革，通过扩展 AI Overviews 并引入全新的 AI Mode，重塑了用户获取与处理信息的方式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae77629865ae418f996760d0b771c710~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=i2qYYfLCTi%2FmBKykHer%2FHlw9WVA%3D" alt="图片" loading="lazy"/></p>
<p>8 月，备受瞩目的 Pixel 10 正式亮相。得益于一系列 AI 原生功能的深度整合，它被评价为 Google 迄今为止最智能、最实用的手机终端。</p>
<p>而在生产力与知识管理领域，年底的一系列更新将体验推向了新高度。随着 11 月 Gemini 3 的底层赋能，Gemini App 迎来了智商与能力的双重飞跃。与此同时，NotebookLM 也在同月重磅加入了 Deep Research 功能并支持了更多类型的数据源，使其从单纯的笔记工具进化为能够处理复杂信息流的专业级智能研究助手。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45022f2c5c2e4915a04f8934ff28313c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=mfRbILxOMj9A4EoThUvrOXxxaig%3D" alt="图片" loading="lazy"/></p>
<p>相关链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.google%2Ftechnology%2Fgoogle-labs%2Fnotebooklm-deep-research-file-types%2F" target="_blank" title="https://blog.google/technology/google-labs/notebooklm-deep-research-file-types/" ref="nofollow noopener noreferrer">blog.google/technology/…</a></p>
<p>创意生成：终结「默片时代」</p>
<p>好莱坞要慌了</p>
<p>2025 年是生成式媒体发生变革的一年。Google 通过发布一系列突破性的模型和工具，涵盖视频、图像、音频及虚拟世界构建，赋予了创作者前所未有的能力。</p>
<p>在视频生成领域，5 月发布的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650969969%26idx%3D1%26sn%3Dd79e6288708fe5edf051524c08d5102a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650969969&amp;idx=1&amp;sn=d79e6288708fe5edf051524c08d5102a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Veo 3</a> 首次实现了原生音频生成，结合同期升级的 Music AI Sandbox，无论是脚步声、环境风声还是背景配乐，都能与画面动作完美同步，彻底终结了 AI 视频的「默片时代」。</p>
<p>10 月的更新则进一步推高了行业天花板。<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650995796%26idx%3D1%26sn%3De5fc46e60c2047abfcb9da7c4f19bcf4%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650995796&amp;idx=1&amp;sn=e5fc46e60c2047abfcb9da7c4f19bcf4&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Veo 3.1</a> 版本不仅大幅提升了光影变化与物体碰撞的物理一致性，还与全新创意工具 Flow 深度整合。更重要的是，它强化了「首尾帧控制」功能，允许创作者精准指定视频的起点与终点，由 AI 补全中间过程，极大地增强了叙事的可控性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae8e7c1d244f449b8c94541d53bd1ffe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=Wo0w1xp0ZnHnJKTzmnEhooJ651M%3D" alt="图片" loading="lazy"/></p>
<p>相关链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.googleblog.com%2Fintroducing-veo-3-1-and-new-creative-capabilities-in-the-gemini-api%2F" target="_blank" title="https://developers.googleblog.com/introducing-veo-3-1-and-new-creative-capabilities-in-the-gemini-api/" ref="nofollow noopener noreferrer">developers.googleblog.com/introducing…</a></p>
<p>在图像生成领域，随着 5 月 Imagen 4 的奠基，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650987517%26idx%3D2%26sn%3D5813029bbacc07ec206c7c7949556789%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650987517&amp;idx=2&amp;sn=5813029bbacc07ec206c7c7949556789&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Nano Banana </a>在今年大放异彩，其在匿名测试时就因表现优异而备受关注。8 月，作为图像生成的重大升级，Nano Banana 以极高的指令遵循能力著称。它解决了「文字生成图片」中细节丢失的问题。</p>
<p>而 11 月发布的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2651002861%26idx%3D1%26sn%3Dea18cedf13aff0e73e786e524b45362f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2651002861&amp;idx=1&amp;sn=ea18cedf13aff0e73e786e524b45362f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Nano Banana Pro</a> 则将体验推向了新高度。作为系列的旗舰版本，它首次引入了「深度思考」模式，在绘图前先进行逻辑推理。这使得它不仅能精准还原极其复杂的 Prompt 构图，更实现了高保真的文字渲染能力，无论是海报设计还是图表绘制都达到了专业级水准。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36590e25103d4f01aead55ed2bdee5c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=vDgWqyOgk0yBpFvdesyVYgNvVOU%3D" alt="图片" loading="lazy"/></p>
<p>「柏林」一词融入了城市街区的建筑设计中，横跨多栋建筑。</p>
<p>相关链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.google%2Ftechnology%2Fai%2Fnano-banana-pro%2F" target="_blank" title="https://blog.google/technology/ai/nano-banana-pro/" ref="nofollow noopener noreferrer">blog.google/technology/…</a></p>
<p>此外，Google Labs 在今年也涌现出众多突破性实验：从将设计瞬间转化为代码的 Stitch，到开发者的异步协作伙伴 Jules，再到 3D 视频通信平台 Google Beam，AI 正在从单纯的媒体生成工具，进化为重塑工作流的生产力核心。</p>
<p>从蛋白质到奥数金牌</p>
<p>AI 当起「全能科研队友」</p>
<p>2025 年，谷歌在生命科学、医疗健康及数学逻辑等领域取得了里程碑式突破，不仅深化了人类对生物遗传的理解，更在顶级智力竞赛中证明了 AI 具备与人类顶尖水平相当的抽象推理能力。</p>
<p>首先来看生命科学领域。上个月，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI3MjM3ODk0NQ%3D%3D%26mid%3D2247510308%26idx%3D1%26sn%3D639a97f77bfa3ea9d6b42a321e59943a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI3MjM3ODk0NQ==&amp;mid=2247510308&amp;idx=1&amp;sn=639a97f77bfa3ea9d6b42a321e59943a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AlphaFold 迎来五周年纪念</a>。在解决蛋白质结构预测难题五年后，该系统已为超过 2 亿个蛋白质预测了结构，并助力全球 300 多万名研究人员加速科研。这一成就通过开放数据库彻底改变了结构生物学，并因其对生命科学的深远贡献荣获了 2024 年诺贝尔化学奖。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/272b493982894a5a8fddf3eea5cd7a93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=jSJ7325HvYY4SqzPsh2m%2BA4IHo4%3D" alt="图片" loading="lazy"/></p>
<p>此外，谷歌还发布了基因组理解模型 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI3MjM3ODk0NQ%3D%3D%26mid%3D2247508003%26idx%3D1%26sn%3D35a0f0902656813430133aa0bad1b2df%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI3MjM3ODk0NQ==&amp;mid=2247508003&amp;idx=1&amp;sn=35a0f0902656813430133aa0bad1b2df&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AlphaGenome</a>，这是一个能够同时处理多达 1 兆碱基对的高分辨率 DNA 序列模型。它通过统一分析多种生物调控模式，帮助科学家解读 DNA 中曾经难以捉摸的非编码区域，为探寻遗传病因和开发新型疗法提供了全方位的生物集成开发环境。</p>
<p>再来看医疗健康领域。谷歌研究院推出的 DeepSomatic 利用卷积神经网络，在肿瘤序列中以极高精度识别癌症相关的遗传变异。该工具能够处理来自主流测序平台的数据，帮助临床医生更准确地锁定驱动癌症的特定变异，从而实现真正的精准医疗和个性化治疗。</p>
<p>而在科学发现方面，谷歌发布了一款基于大模型的编程智能体 ——<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650969047%26idx%3D2%26sn%3Def0aadc0ffa79ae0bea4266da98f2bc0%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650969047&amp;idx=2&amp;sn=ef0aadc0ffa79ae0bea4266da98f2bc0&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AlphaEvolve</a>，专门用于寻找和验证理论计算机科学中的复杂组合结构。它在验证过程上实现了 1 万倍的加速，成功协助科研人员收紧了优化问题的界限，标志着 AI 正从数据处理者转型为深度参与数学发现的科研合作者。</p>
<p>此外，谷歌还推出了基于 Gemini 2.0 构建的多智能体协作系统 ——<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI3MjM3ODk0NQ%3D%3D%26mid%3D2247505715%26idx%3D1%26sn%3D92bd1a6b1b8c6b17dace9259754eb522%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI3MjM3ODk0NQ==&amp;mid=2247505715&amp;idx=1&amp;sn=92bd1a6b1b8c6b17dace9259754eb522&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AI co-scientist</a>，旨在模仿科学研究的逻辑流程。它能独立生成研究假设、设计实验方案并撰写研究提案，在生物医学等领域展现了显著缩短发现周期的潜力，成为了科学家的虚拟实验室助手。</p>
<p>在代码、数学逻辑方面，谷歌也站稳了第一梯队。进阶版 Gemini 2.5 Deep Think 在 2025 年国际大学生程序设计竞赛（ICPC）总决赛中达到金牌水平，在 12 道题目中解出了 10 道。第 66 届国际数学奥林匹克（IMO）中，Gemini Deep Think 凭借 35 分的高分（总分 42 分）<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650980912%26idx%3D2%26sn%3Dd4b29bb43cc647cc79ab06550417dfc1%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650980912&amp;idx=2&amp;sn=d4b29bb43cc647cc79ab06550417dfc1&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">达到金牌表现</a>，完美解决了 6 道难题中的 5 道。</p>
<p>算力宇宙：量子回声算法登 Nature</p>
<p>新一代 TPU 叫板英伟达</p>
<p>前段时间，谷歌创始人<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2651007176%26idx%3D1%26sn%3Deace48aac2391594abbcf750446c4e74%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2651007176&amp;idx=1&amp;sn=eace48aac2391594abbcf750446c4e74&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">谢尔盖・布林</a>在参加母校的一次活动时表示，这些年，谷歌有很多失误，比如没有第一时间重视 Transformer。但他们也做对了很多事情，比如对「计算」的投入。</p>
<p>首先，在量子计算方面，他们的重大突破 ——<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650997242%26idx%3D2%26sn%3D66ea25ada7d76c11156c990292420410%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650997242&amp;idx=2&amp;sn=66ea25ada7d76c11156c990292420410&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Quantum Echoes</a>（量子回声）算法在 10 月份登上了「Nature」。它在量子处理器上实现了首次可验证的量子优越性，能以比最快超级计算机快 13,000 倍的速度解决特定问题，为药物研发、材料科学等领域的实际应用打开了新窗口。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1a851537c2447e1945da0dd9b885331~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=SKSjeSq0Kzs586rv4oK4rUKHIf0%3D" alt="图片" loading="lazy"/></p>
<p>相关链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fquantumai.google%2Fstatic%2Fsite-assets%2Fdownloads%2Fquantum-computation-molecular-geometry-via-nuclear-spin-echoes.pdf" target="_blank" title="https://quantumai.google/static/site-assets/downloads/quantum-computation-molecular-geometry-via-nuclear-spin-echoes.pdf" ref="nofollow noopener noreferrer">quantumai.google/static/site…</a></p>
<p>这一进展得益于谷歌在量子计算方向的多年投入。今年，谷歌量子硬件首席科学家 Michel Devoret 和前量子人工智能硬件负责人 John Martinis 还因在量子计算方面的奠基性工作与加州大学伯克利分校教授 John Clarke 共同获得了<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650994101%26idx%3D1%26sn%3Df13c594bd201269749ca7b74824075f9%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650994101&amp;idx=1&amp;sn=f13c594bd201269749ca7b74824075f9&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">诺贝尔物理学奖</a>。至此，谷歌的诺奖得主已经增加到五位，在科技界非常罕见。</p>
<p>除了量子计算，谷歌今年在 TPU 方向的进展同样令人瞩目。今年 4 月，第七代 TPU——<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650964063%26idx%3D2%26sn%3Dfae1953e7bd488ebb976b91c51ba334b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650964063&amp;idx=2&amp;sn=fae1953e7bd488ebb976b91c51ba334b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Ironwood</a> 正式发布。它专为「推理时代」设计，每块芯片内存带宽提升至 7.2 TB/s，单芯片显存容量达到 192GB。当每个 pod 扩展至 9216 块芯片时，它可提供 42.5 exaflops 的 AI 算力，远超目前全球最快的超级计算机 El Capitan 的 1.7 exaflops。每块 Ironwood 芯片的峰值计算能力可达 4614 TFLOPs。</p>
<p>谷歌透露，这款芯片的部分架构由其自家的 AI 模型 AlphaChip 辅助优化，大幅缩短了研发周期并优化了布局。</p>
<p>和英伟达 GPU 相比，这款新的 TPU 拥有极致的能效比，在电力供应受限的数据中心里，谷歌能用同样的电量跑出更多的 AI 算力。此外，谷歌不把 TPU 看作单一芯片，而是一个名为 Pod 的整体，在超大规模集群（万卡级别）的布线复杂度和电力损耗上，TPU 更有优势。（关于 GPU 和 TPU 的更多对比参见《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2651006155%26idx%3D1%26sn%3D58d8bbed035d587d398de7ca2de8d9cd%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2651006155&amp;idx=1&amp;sn=58d8bbed035d587d398de7ca2de8d9cd&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">谷歌 TPU 杀疯了，产能暴涨 120%、性能 4 倍吊打，英伟达还坐得稳吗？</a>》）</p>
<p>目前，谷歌已计划到 2027 年实现年产 500 万颗 TPU 的目标。目前，像 Anthropic 这样的 AI 巨头已经预订了超过 100 万颗 TPU 算力，这显示出谷歌正通过「自研芯片 + 云服务」的闭环，在 AI 硬件市场有力地挑战英伟达的统治地位。</p>
<p>Gemini Robotics</p>
<p>把「大模型 + 机器人」做到极致</p>
<p>在这波具身智能发展浪潮中，谷歌一直起到技术引领作用，通过一系列研究把「大模型 + 机器人」这件事做成了体系化、可迭代、且不断刷新行业上限。</p>
<p>前两年，他们通过 RT-1 和 RT-2 (Robotic Transformer) 率先证明了：大语言模型（LLM）的 Transformer 架构可以直接用于输出机器人动作。</p>
<p>2025 年，他们进一步将 VLA 模型推向极致。3 月份，他们推出了 Gemini Robotics，通过将视觉、语言和动作三种模态与物理控制系统深度融合，首次实现了「感知 - 决策 - 动作」的全闭环操作，能够直接根据视觉输入和语言指令生成相应的机械臂轨迹，无需像传统机器人那样进行繁琐的分步规划。</p>
<p>9 月份，Gemini Robotics 1.5 问世，初步具备了以类似人类思考方式进行规划行动的能力。它通过两个模型的合作来达成此目标：ER 模型负责高层推理和决策，生成详细的行动方案；VLA 模型负责感知和具体执行，并在执行过程中进行细粒度的自我推理校正。这种架构旨在结合两者优势，使机器人既能深思熟虑又能动作精准。</p>
<p>此外，他们还成功把大模型「塞进」边缘设备并开放生态。2025 年 6 月发布的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650975662%26idx%3D1%26sn%3D805ae2305a6612059564d086cd41202b%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650975662&amp;idx=1&amp;sn=805ae2305a6612059564d086cd41202b&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Gemini Robotics On-Device</a>，首次让低延迟的 VLA 模型完全离线运行在机械臂和人形机器人上。他们还配套放出了 Gemini Robotics SDK，开发者 50～100 次演示就能微调出可迁移的新技能。</p>
<p>Genie 3 引爆世界模型</p>
<p>哈萨比斯寄予厚望</p>
<p>提到世界模型，谷歌的 Genie 3 是今年的绝对亮点，被视为世界模型的新高峰（参见《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650983908%26idx%3D1%26sn%3Df33650540bdffd2558dea77ba3ab7377%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650983908&amp;idx=1&amp;sn=f33650540bdffd2558dea77ba3ab7377&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">震撼，世界模型第一次超真实地模拟了真实世界：谷歌 Genie 3 昨晚抢了 OpenAI 风头</a>》。</p>
<p>这不只是因为 Genie 3 画面更逼真，而是它第一次把实时交互、长期一致性和语言可控性合成在同一个生成式系统中：它以每秒 24 帧、720p 的边生成边交互方式，让用户无需任何预制 3D 资产就能像玩游戏一样实时探索，而且它具备长达几分钟的空间记忆，使世界在转身离开后依然保持稳定连续。</p>
<p>正因如此，Genie 3 不再只是「可看的视频模型」，而有望成为一个能支撑智能体长期试错与规划的训练环境、一个把内容创作从搭场景降维到写一句话的生产工具，以及一个可低成本复现极端情境的科学模拟沙盒，为通往通用智能提供了一条可交互、可长期演化的模拟路径。</p>
<p>最近，哈萨比斯在采访中说，除了 AI 之外，世界模型和模拟可能是他最长久的热情所在。他认为，语言模型已经意外地学会了大量关于世界的知识，但真正的世界理解 —— 尤其是空间动态、物理因果和需要亲身体验的感知能力 —— 很难仅靠语言获得，必须通过世界模型与模拟来补足。</p>
<p>世界模型本质上是一种「直觉物理学」，能理解事物如何运作、移动与相互作用，而生成逼真的世界正是这种理解的证明。像 Genie、Veo 这样的交互式视频与世界模型，是迈向通用智能、机器人和现实中通用助手的关键一步，最终也可能回到他最初热爱的游戏与模拟，创造真正意义上的「终极游戏」。</p>
<p>挑战天气、疾病、教育</p>
<p>谷歌要改造世界</p>
<p>技术终究是为人服务的，在这方面，谷歌也披露了一些进展。</p>
<p>气候方面，他们的洪水预警系统已经覆盖 150 个国家、20 多亿人口了。他们新出的天气预报模型 WeatherNext 2，速度是以前的 8 倍，最精细能做到按小时预测。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a561269e6104a34b7a1626bfa512d52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=ABsTwWYtZYoco8CGSiS%2BmCBfugE%3D" alt="图片" loading="lazy"/></p>
<p>项目链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeepmind.google%2Fscience%2Fweathernext%2F" target="_blank" title="https://deepmind.google/science/weathernext/" ref="nofollow noopener noreferrer">deepmind.google/science/wea…</a></p>
<p>医疗方面，他们在通用模型的基础上打造了一些垂类模型，比如基于 Gemma 开源模型系列的、用于单细胞分析的 270 亿参数基础模型 Cell2Sentence-Scale 27B（C2S-Scale），该模型可以帮助发现新的潜在癌症治疗途径。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a347885ba7ab43c4b549da227ecb0fb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767174714&amp;x-signature=YhPVWeCmultRYviqHNIzbeO0770%3D" alt="图片" loading="lazy"/></p>
<p>项目链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.google%2Ftechnology%2Fai%2Fgoogle-gemma-ai-cancer-therapy-discovery%2F" target="_blank" title="https://blog.google/technology/ai/google-gemma-ai-cancer-therapy-discovery/" ref="nofollow noopener noreferrer">blog.google/technology/…</a></p>
<p>教育方面，谷歌也尝试了一些创新，包括：</p>
<ul>
<li>
<p>在 Gemini AI 里推出了「Guided Learning」功能，它不像普通 AI 只给出答案，而是通过提问、步骤讲解、图片、视频和测验等方式，帮助用户深入理解知识。</p>
</li>
<li>
<p>基于 Gemini 打造了一系列经过微调、融入学习科学原理的生成式 AI 模型 ——LearnLM。它在设计时参考了教育研究（如认知负荷管理、个性化反馈等），目的是让 AI 更像导师而不是只给答案。</p>
</li>
<li>
<p>把强大的 Gemini 翻译能力带到了谷歌翻译和 Search 的翻译功能中，让文本翻译更自然、更能理解语境（比如习语、俚语等），提高准确性，同时推出了基于 Gemini 的实时语音对话翻译（Live translate），可通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2651007167%26idx%3D1%26sn%3D957ac2c92e9e4903bb1d7180c3000a2c%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2651007167&amp;idx=1&amp;sn=957ac2c92e9e4903bb1d7180c3000a2c&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">耳机</a>听见更加自然流畅的即时翻译。</p>
</li>
</ul>
<p>结语</p>
<p>纵观 2025 年，谷歌展现出的并非单一技术的突进，而是一种强大的「系统性工程能力」。在算力层有 TPU 集群与量子回声算法，在模型层有 Gemini 的逻辑进化，在应用层有诺奖级的科研产出。</p>
<p>这一年，谷歌显然走出了「创新者的窘境」，不再纠结于先发优势的丧失，而是利用其庞大的全栈生态完成了补课与追赶。在 AI 竞争从「在大模型上跑分」转向「在产业链中落地」的下半场，这种从底层芯片到上层应用没有任何短板的布局，或许才是科技巨头最核心的竞争力。</p>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.google%2Ftechnology%2Fai%2F2025-research-breakthroughs%2F%255B%23computing%255D()" target="_blank" title="https://blog.google/technology/ai/2025-research-breakthroughs/%5B#computing%5D()" ref="nofollow noopener noreferrer">blog.google/technology/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 实战：基于 GetX + Obx 的企业级架构设计指南]]></title>    <link>https://juejin.cn/post/7587243886433730594</link>    <guid>https://juejin.cn/post/7587243886433730594</guid>    <pubDate>2025-12-24T09:56:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587243886433730594" data-draft-id="7587243886433714210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 实战：基于 GetX + Obx 的企业级架构设计指南"/> <meta itemprop="keywords" content="Flutter,前端"/> <meta itemprop="datePublished" content="2025-12-24T09:56:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="全栈派森"/> <meta itemprop="url" content="https://juejin.cn/user/430664289093176"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 实战：基于 GetX + Obx 的企业级架构设计指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664289093176/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    全栈派森
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T09:56:16.000Z" title="Wed Dec 24 2025 09:56:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>大家好,我是<code>Petter Guo</code> <br/></p>
<p>一位热爱<code>探索</code>的<code>全栈工程师</code>。在这里，我将分享<code>个人</code>的<code>Technical essentials</code>，带你玩转<code>前端</code>、<code>后端</code>到 <code>DevOps</code> 的硬核技术，解锁<code>AI</code>，助你打通技术任督二脉，成为真正的<code>全能玩家</code>!！<br/></p>
<p>如果对你有帮助, 请<code>点赞</code>+ <code>收藏</code> +<code>关注</code>鼓励下, 学习公众号为 <code>全栈派森</code>。 <br/></p>
<p>在 Flutter 开发中，状态管理一直是绕不开的话题。从 Provider 到 BLoC，再到 Riverpod，选择很多。但在追求<strong>开发效率</strong>与<strong>运行性能</strong>平衡的场景下，<strong>GetX</strong> 无疑是目前的“版本之子”。</p>
<p>今天我们不谈简单的计数器 Demo，而是深入探讨：<strong>如何在企业级项目中，利用 GetX + Obx 构建一套高内聚、低耦合、易扩展的架构。</strong></p>
<h2 data-id="heading-0">🎯 为什么选择 GetX + Obx？</h2>
<p>在传统的 <code>setState</code> 或 <code>ChangeNotifier</code> 模式中，我们常常面临全页重绘的问题。而 GetX 的 <code>Obx</code> 带来了<strong>细粒度的响应式编程</strong>：</p>
<ol>
<li><strong>极简代码</strong>：无需 <code>context</code>，无需繁琐的模板代码。</li>
<li><strong>精准刷新</strong>：变量变了，只有使用该变量的 Widget 会刷新，性能极高。</li>
<li><strong>依赖注入</strong>：自带强大的 DI（依赖注入）系统，彻底解耦 Logic 和 View。</li>
</ol>
<hr/>
<h2 data-id="heading-1">🏗️ 目录架构设计 (The Architecture)</h2>
<p>对于中大型项目，推荐使用 <strong>Feature-First（按功能分包）</strong> 的目录结构，结合 <strong>GetX Pattern</strong> 标准：</p>
<pre><code class="hljs language-text" lang="text">lib/
├── app/
│   ├── data/                   # 数据层 (全局共享)
│   │   ├── models/             # 实体类 (Json转Dart)
│   │   ├── providers/          # API 请求封装 (Dio/GetConnect)
│   │   └── services/           # 全局服务 (本地存储/Auth服务)
│   │
│   ├── modules/                # 业务模块 (核心)
│   │   ├── home/               # 首页模块
│   │   │   ├── bindings/       # 依赖注入 (Binding)
│   │   │   ├── controllers/    # 业务逻辑 (Controller)
│   │   │   └── views/          # 页面视图 (View)
│   │   │
│   │   ├── profile/            # 个人中心模块
│   │   │   ├── ...
│   │
│   ├── routes/                 # 路由管理
│   │   ├── app_pages.dart      # 路由表
│   │   └── app_routes.dart     # 路由名称常量
│   │
│   └── utils/                  # 工具类
│
└── main.dart                   # 入口文件
</code></pre>
<p><strong>设计核心：</strong> 每个业务模块（Module）自包含 <code>View</code>、<code>Controller</code> 和 <code>Binding</code>，互不干扰。</p>
<hr/>
<h2 data-id="heading-2">💻 代码实战 (Code Implementation)</h2>
<p>我们要实现一个场景：<strong>用户详情页</strong>。进入页面自动请求 API，加载中显示 Loading，成功显示数据，失败显示重试按钮。</p>
<h3 data-id="heading-3">1. Model 层：定义数据</h3>
<p><code>app/data/models/user_model.dart</code></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> avatar;

  User({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.id, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.avatar});

  <span class="hljs-comment">// 实际开发中建议使用 json_serializable</span>
  <span class="hljs-keyword">factory</span> User.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) {
    <span class="hljs-keyword">return</span> User(
      id: json[<span class="hljs-string">'id'</span>] ?? <span class="hljs-string">''</span>,
      name: json[<span class="hljs-string">'name'</span>] ?? <span class="hljs-string">'Unknown'</span>,
      avatar: json[<span class="hljs-string">'avatar'</span>] ?? <span class="hljs-string">''</span>,
    );
  }
}
</code></pre>
<h3 data-id="heading-4">2. Provider 层：API 请求</h3>
<p><code>app/data/providers/user_provider.dart</code></p>
<p>这里负责纯粹的数据获取，不含业务逻辑。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:get/get.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GetConnect</span> </span>{
  Future&lt;Response&gt; getUser(<span class="hljs-built_in">String</span> id) =&gt; <span class="hljs-keyword">get</span>(<span class="hljs-string">'https://api.example.com/users/<span class="hljs-subst">$id</span>'</span>);
}
</code></pre>
<h3 data-id="heading-5">3. Controller 层：核心逻辑 (关键!)</h3>
<p><code>app/modules/profile/controllers/profile_controller.dart</code></p>
<p>这是 GetX 的灵魂所在。我们使用 <code>.obs</code> 将变量变为响应式。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:get/get.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'../../../data/models/user_model.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'../../../data/providers/user_provider.dart'</span>;

<span class="hljs-comment">// 状态枚举</span>
<span class="hljs-keyword">enum</span> Status { loading, success, error }

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProfileController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GetxController</span> </span>{
  <span class="hljs-keyword">final</span> UserProvider _api;
  
  <span class="hljs-comment">// 构造注入，便于测试</span>
  ProfileController(<span class="hljs-keyword">this</span>._api);

  <span class="hljs-comment">// --- 响应式状态 (State) ---</span>
  
  <span class="hljs-comment">// 使用 Rx&lt;T&gt; 包装对象</span>
  <span class="hljs-keyword">final</span> user = Rxn&lt;User&gt;(); 
  <span class="hljs-comment">// 页面状态</span>
  <span class="hljs-keyword">final</span> status = Status.loading.obs;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onInit() {
    <span class="hljs-keyword">super</span>.onInit();
    fetchUserData(); <span class="hljs-comment">// 初始化时加载数据</span>
  }

  <span class="hljs-comment">// --- 业务方法 (Action) ---</span>
  
  <span class="hljs-keyword">void</span> fetchUserData() <span class="hljs-keyword">async</span> {
    status.value = Status.loading;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 模拟网络延迟</span>
      <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>));
      
      <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> _api.getUser(<span class="hljs-string">'123'</span>);
      
      <span class="hljs-comment">// 这里的逻辑通常更复杂，需判断 statusCode</span>
      <span class="hljs-keyword">if</span> (response.hasError) {
         status.value = Status.error;
      } <span class="hljs-keyword">else</span> {
         user.value = User.fromJson(response.body);
         status.value = Status.success;
      }
    } <span class="hljs-keyword">catch</span> (e) {
      status.value = Status.error;
    }
  }
}
</code></pre>
<h3 data-id="heading-6">4. Binding 层：依赖注入胶水</h3>
<p><code>app/modules/profile/bindings/profile_binding.dart</code></p>
<p>Binding 的作用是：<strong>“只有当用户进入这个页面时，才创建 Controller 和 Provider；离开页面时自动销毁。”</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:get/get.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'../controllers/profile_controller.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'../../../data/providers/user_provider.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProfileBinding</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Bindings</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dependencies() {
    <span class="hljs-comment">// 1. 注入数据提供者</span>
    Get.lazyPut(() =&gt; UserProvider());
    
    <span class="hljs-comment">// 2. 注入控制器 (Controller 能找到上面的 UserProvider)</span>
    Get.lazyPut(() =&gt; ProfileController(Get.find()));
  }
}
</code></pre>
<h3 data-id="heading-7">5. View 层：UI 视图</h3>
<p><code>app/modules/profile/views/profile_view.dart</code></p>
<p>View 层变得非常干净，没有逻辑，只有布局。<strong><code>Obx</code> 是这里的魔法</strong>。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:get/get.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'../controllers/profile_controller.dart'</span>;

<span class="hljs-comment">// 继承 GetView&lt;T&gt; 可以直接访问 controller 属性</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProfileView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GetView</span>&lt;<span class="hljs-title">ProfileController</span>&gt; </span>{
  <span class="hljs-keyword">const</span> ProfileView({Key? key}) : <span class="hljs-keyword">super</span>(key: key);

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">"用户详情"</span>)),
      body: Center(
        <span class="hljs-comment">// Obx 监听：只要 controller.status 变化，这里就会重绘</span>
        child: Obx(() {
          <span class="hljs-keyword">switch</span> (controller.status.value) {
            <span class="hljs-keyword">case</span> Status.loading:
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> CircularProgressIndicator();
            
            <span class="hljs-keyword">case</span> Status.error:
              <span class="hljs-keyword">return</span> Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  <span class="hljs-keyword">const</span> Icon(Icons.error, color: Colors.red, size: <span class="hljs-number">50</span>),
                  <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">10</span>),
                  ElevatedButton(
                    onPressed: controller.fetchUserData,
                    child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">"重试"</span>),
                  )
                ],
              );
              
            <span class="hljs-keyword">case</span> Status.success:
              <span class="hljs-keyword">final</span> userData = controller.user.value;
              <span class="hljs-keyword">return</span> Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  CircleAvatar(radius: <span class="hljs-number">40</span>, backgroundImage: NetworkImage(userData!.avatar)),
                  <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">10</span>),
                  Text(userData.name, style: Theme.of(context).textTheme.headlineMedium),
                  ElevatedButton(
                    <span class="hljs-comment">// 交互逻辑都在 Controller 里</span>
                    onPressed: () =&gt; Get.snackbar(<span class="hljs-string">"提示"</span>, <span class="hljs-string">"点击了编辑"</span>),
                    child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">"编辑资料"</span>),
                  )
                ],
              );
          }
        }),
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-8">6. Route 层：组装</h3>
<p><code>app/routes/app_pages.dart</code></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppPages</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> routes = [
    GetPage(
      name: <span class="hljs-string">'/profile'</span>,
      page: () =&gt; <span class="hljs-keyword">const</span> ProfileView(),
      binding: ProfileBinding(), <span class="hljs-comment">// 关键：在这里绑定依赖</span>
    ),
  ];
}
</code></pre>
<hr/>
<h2 data-id="heading-9">🌟 总结：这套架构好在哪？</h2>
<ol>
<li><strong>内存管理自动化</strong>：
由于使用了 <code>Binding</code> 和 <code>Get.lazyPut</code>，当用户从 Profile 页返回上一页时，<code>ProfileController</code> 和 <code>UserProvider</code> 会自动从内存中移除。你不需要手动写 <code>dispose()</code>。</li>
<li><strong>View 层极度纯净</strong>：
UI 代码中没有 <code>if(isLoading) ... else ...</code> 的业务判断逻辑，也没有 API 请求代码。UI 只负责“根据状态显示组件”。</li>
<li><strong>测试友好</strong>：
因为 Controller 的依赖（Provider）是通过构造函数注入的，写单元测试时，你可以轻松 mock 一个 <code>UserProvider</code> 传进去。</li>
</ol>
<hr/>
<blockquote>
<p><strong>写在最后</strong>：架构没有绝对的“最好”，只有“最适合”。对于追求开发速度和运行效率的中小型及企业级 Flutter 项目，GetX + Obx 是一套性价比极高的组合拳。希望这篇实战指南能对你的项目架构有所启发！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent 研发：ReAct Agent]]></title>    <link>https://juejin.cn/post/7586491717874057235</link>    <guid>https://juejin.cn/post/7586491717874057235</guid>    <pubDate>2025-12-22T16:45:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586491717874057235" data-draft-id="7586491717873991699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent 研发：ReAct Agent"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-22T16:45:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小撸007"/> <meta itemprop="url" content="https://juejin.cn/user/2101921959910183"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent 研发：ReAct Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2101921959910183/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小撸007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T16:45:07.000Z" title="Mon Dec 22 2025 16:45:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    57
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ReAct 介绍</h2>
<h3 data-id="heading-1">运作流程</h3>
<p>用一句话简单描述：ReAct 智能体是基于<code>推理</code>和<code>行动</code>反馈的框架，通过循环调用 LLM 思考得到概率纠正结果。</p>
<p>理论学习参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ibm.com%2Fcn-zh%2Fthink%2Ftopics%2Freact-agent" target="_blank" title="https://www.ibm.com/cn-zh/think/topics/react-agent" ref="nofollow noopener noreferrer">www.ibm.com/cn-zh/think…</a></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 伪代码</span>
<span class="hljs-function">def <span class="hljs-title">ReAct</span><span class="hljs-params">(query)</span> </span>{
    call: Agent
    Thought
    call: Tool
    Action

    <span class="hljs-keyword">if</span> Action === <span class="hljs-string">'Finish'</span>
        Answer
    <span class="hljs-keyword">else</span>
        loop: ReAct
}
</code></pre>
<h2 data-id="heading-2">ReAct Agent 实现要点</h2>
<blockquote>
<p>此例子来自于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdatawhalechina.github.io%2Fhello-agents%2F%23%2F.%2F%25E5%2589%258D%25E8%25A8%2580" target="_blank" title="https://datawhalechina.github.io/hello-agents/#/./%E5%89%8D%E8%A8%80" ref="nofollow noopener noreferrer">hello_agents 学习文档</a>，有兴趣的同学也可以阅读</p>
<p>主要是思维变化：面向场景选择合适模型-&gt;模型友好交互方式-&gt;得到合理答案，在 ReAct 模式中主要是 Prompt 策略和上下文的丰富度会影响调用成本和结果。</p>
</blockquote>
<ul>
<li>Prompt 规划和约束
<ul>
<li>明确约定思考和行动标记：用于组合 LLM 思维链</li>
<li>明确推理结束标记：用于优化 Prompt 内容</li>
<li>明确推理记忆标记：用于丰富 Prompt 内容</li>
<li>明确推理外部调用能力描述：用于提升 LLM 处理准确性</li>
</ul>
</li>
<li>灵活切换模型、Prompt 策略优化、工具增强，提升循环调用效果（这个对企业成本比较重要）</li>
</ul>
<h2 data-id="heading-3">完整例子实现</h2>
<blockquote>
<p>整体基于 OpenRouter 调用，有兴趣的同学可以选个免费模型跑一下。</p>
</blockquote>
<ul>
<li>LLM Client</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">OpenAI</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"openai"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LLM</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">client</span>: <span class="hljs-title class_">OpenAI</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">modelId</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">apiKey: <span class="hljs-built_in">string</span>, modelId: <span class="hljs-built_in">string</span> = <span class="hljs-string">"mistralai/devstral-2512:free"</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>({
      <span class="hljs-attr">apiKey</span>: apiKey,
      <span class="hljs-attr">baseURL</span>: <span class="hljs-string">"https://openrouter.ai/api/v1"</span>,
      <span class="hljs-attr">dangerouslyAllowBrowser</span>: <span class="hljs-literal">true</span>,
    });
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelId</span> = modelId;
  }

  <span class="hljs-title function_">setModel</span>(<span class="hljs-params">modelId: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelId</span> = modelId;
  }

  <span class="hljs-title function_">getModel</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelId</span>;
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">messages: OpenAI.Chat.Completions.ChatCompletionMessageParam[]</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelId</span>,
      <span class="hljs-attr">messages</span>: messages,
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">stream</span>(<span class="hljs-params">messages: OpenAI.Chat.Completions.ChatCompletionMessageParam[]</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">modelId</span>,
      <span class="hljs-attr">messages</span>: messages,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>,
    });
  }
}
</code></pre>
<ul>
<li>ReActAgent</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> {<span class="hljs-variable constant_">LLM</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"./LLM.ts"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">ToolExecutor</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"./ToolExecutor.ts"</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">PromptTplProps</span> = {
    <span class="hljs-attr">question</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">history</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">tools</span>: <span class="hljs-built_in">string</span>[];
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getPromptTpl</span> = (<span class="hljs-params">props: PromptTplProps</span>) =&gt; {
    <span class="hljs-keyword">const</span> {
        tools,
        question,
        history,
    } = props;

    <span class="hljs-keyword">return</span> <span class="hljs-string">`
        请注意，你是一个有能力调用外部工具的智能助手。
        
        能够使用的工具如下：
        <span class="hljs-subst">${tools.join(<span class="hljs-string">'\n'</span>)}</span>
        
        请严格按照下面的格式进行回复：
        
        Thought: 你的思考过程用于分析问题、拆解任务和规划下一步行动。
        Action: 你决定采取的行为，必须是以下格式之一：
        - {toolName}[{toolInput}]: 调用一个可用工具。
        - Finish[最终答案]: 当你认为已经获得最终答案时。
        - 当你收集到足够的信息，能够回答用户的最终问题时，你必须在Action:字段后使用 finish(answer="...") 来输出最终答案。
        
        现在，请开始解决以下问题：
        Question: <span class="hljs-subst">${question}</span>
        History: <span class="hljs-subst">${history}</span>
    `</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReActAgent</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">history</span>: <span class="hljs-built_in">string</span>[];

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
        <span class="hljs-comment">// 调用的 llm</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> llm: LLM,
        <span class="hljs-comment">// 最多循环思考几次</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> maxSteps: <span class="hljs-built_in">number</span> = <span class="hljs-number">3</span>,
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> toolExecutor: ToolExecutor,
    </span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span> = [];
    }

    <span class="hljs-keyword">async</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">question: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-keyword">let</span> currentStep = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">while</span> (currentStep &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxSteps</span>) {
            currentStep++;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`-----第<span class="hljs-subst">${currentStep}</span>步骤-------`</span>);

            <span class="hljs-keyword">const</span> history = <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>);
            <span class="hljs-keyword">const</span> tools = <span class="hljs-variable language_">this</span>.<span class="hljs-property">toolExecutor</span>.<span class="hljs-title function_">getAvailableTools</span>();
            <span class="hljs-keyword">const</span> prompt = <span class="hljs-title function_">getPromptTpl</span>({
                tools,
                question,
                history,
            });

            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'prompt:'</span>, prompt);

            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> responseText = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">llm</span>.<span class="hljs-title function_">chat</span>([{
                    <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
                    <span class="hljs-attr">content</span>: prompt,
                }]);

                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'大模型返回：'</span>, responseText);

                <span class="hljs-keyword">const</span> {thought, action} = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseOutput</span>(responseText.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span> ?? <span class="hljs-string">''</span>);

                <span class="hljs-keyword">if</span> (thought) {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Thought：'</span>, thought);
                }
                <span class="hljs-keyword">if</span> (!action) {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'模型没有返回具体的 Action，流程终止'</span>);
                    <span class="hljs-keyword">break</span>;
                }

                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Action:'</span>, action);

                <span class="hljs-keyword">if</span> (action.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'Finish'</span>)) {
                    <span class="hljs-keyword">const</span> answer = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseFinishAnswer</span>(action);
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'最终答案: '</span>, answer);
                    <span class="hljs-keyword">return</span> answer;
                }

                <span class="hljs-keyword">const</span> [toolName, toolInput] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">parseAction</span>(action);
                <span class="hljs-keyword">if</span> (!toolName || !toolInput) {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'无法解析 Action:'</span>, action);
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">const</span> tool = <span class="hljs-variable language_">this</span>.<span class="hljs-property">toolExecutor</span>.<span class="hljs-title function_">getTool</span>(toolName);

                <span class="hljs-keyword">let</span> observation = <span class="hljs-string">''</span>;
                <span class="hljs-keyword">if</span> (tool) {
                    observation = tool.<span class="hljs-title function_">fn</span>(toolInput) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
                }
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Observation:'</span>, observation);

                <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`Action:<span class="hljs-subst">${action}</span>`</span>);
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`Observation:<span class="hljs-subst">${observation}</span>`</span>)
            } <span class="hljs-keyword">catch</span> (err) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
            }
        }

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'已达到最大步数'</span>);
    }

    <span class="hljs-title function_">parseFinishAnswer</span>(<span class="hljs-params">action: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-keyword">const</span> answer = action.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/Finish[(.*)]/</span>);
        <span class="hljs-keyword">if</span> (answer &amp;&amp; answer.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> answer[<span class="hljs-number">1</span>];
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">'-'</span>;
    }

    <span class="hljs-title function_">parseOutput</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-keyword">const</span> thought = str.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/Thought:(.*)/</span>);
        <span class="hljs-keyword">const</span> action = str.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/Action:(.*)/</span>);

        <span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = {
            <span class="hljs-attr">thought</span>: <span class="hljs-built_in">string</span>;
            <span class="hljs-attr">action</span>: <span class="hljs-built_in">string</span>;
        };
        <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">Result</span> = {
            <span class="hljs-attr">thought</span>: <span class="hljs-string">''</span>,
            <span class="hljs-attr">action</span>: <span class="hljs-string">''</span>,
        };
        <span class="hljs-keyword">if</span> (thought &amp;&amp; thought.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
            result.<span class="hljs-property">thought</span> = thought[<span class="hljs-number">1</span>].<span class="hljs-title function_">trim</span>();
        }
        <span class="hljs-keyword">if</span> (action &amp;&amp; action.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span>) {
            result.<span class="hljs-property">action</span> = action[<span class="hljs-number">1</span>].<span class="hljs-title function_">trim</span>();
        }
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-title function_">parseAction</span>(<span class="hljs-params">str: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-keyword">const</span> info = str.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/(\w+)[(.*)]/</span>);
        <span class="hljs-keyword">if</span> (info &amp;&amp; info.<span class="hljs-property">length</span> &gt; <span class="hljs-number">2</span>) {
            <span class="hljs-comment">// info[0] is the full match, e.g., "calc_sum[1,1]"</span>
            <span class="hljs-comment">// info[1] is the first capture group (the tool name), e.g., "calc_sum"</span>
            <span class="hljs-comment">// info[2] is the second capture group (the tool input), e.g., "1,1"</span>
            <span class="hljs-keyword">return</span> [info[<span class="hljs-number">1</span>], info[<span class="hljs-number">2</span>]];
        }
        <span class="hljs-keyword">return</span> [];
    }
}
</code></pre>
<ul>
<li>工具注册和执行</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Tool</span> = {
    <span class="hljs-attr">desc</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">fn</span>: <span class="hljs-function">(<span class="hljs-params">arg: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">unknown</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolExecutor</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-attr">tools</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Tool</span>&gt;;

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    }

    <span class="hljs-title function_">register</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, desc: <span class="hljs-built_in">string</span>, fn: (arg: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">unknown</span></span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`您注册的工具：<span class="hljs-subst">${name}</span>, <span class="hljs-subst">${desc}</span>`</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>.<span class="hljs-title function_">set</span>(name, {
            desc,
            fn,
        } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Tool</span>);
    }

    <span class="hljs-title function_">getTool</span>(<span class="hljs-attr">toolName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Tool</span> | <span class="hljs-literal">undefined</span> {
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>.<span class="hljs-title function_">has</span>(toolName)) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>.<span class="hljs-title function_">get</span>(toolName);
    }

    <span class="hljs-title function_">getAvailableTools</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">string</span>[] = [];
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">tool, name</span>) =&gt;</span> {
            result.<span class="hljs-title function_">push</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span>: <span class="hljs-subst">${tool.desc}</span>`</span>);
        });
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始，用 n8n 设计可扩展的自动化工作流]]></title>    <link>https://juejin.cn/post/7586983243926618150</link>    <guid>https://juejin.cn/post/7586983243926618150</guid>    <pubDate>2025-12-24T08:08:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586983243926618150" data-draft-id="7586983243926601766" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始，用 n8n 设计可扩展的自动化工作流"/> <meta itemprop="keywords" content="自动化运维,DevOps"/> <meta itemprop="datePublished" content="2025-12-24T08:08:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DigitalOcean"/> <meta itemprop="url" content="https://juejin.cn/user/2031553217827127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始，用 n8n 设计可扩展的自动化工作流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2031553217827127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    DigitalOcean
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-24T08:08:34.000Z" title="Wed Dec 24 2025 08:08:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>自动化已经成为现代软件开发与运维中不可或缺的一部分。从在不同工具之间同步数据，到触发复杂的业务流程，团队越来越依赖工作流自动化平台来减少人工操作与错误。n8n是一款强大的开源工作流自动化工具，可用于连接各类应用、服务和 API，构建灵活、可扩展的自动化流程。</p>
<p>与许多无代码或低代码自动化工具不同，n8n 对开发者非常友好，高度可定制，并且支持自托管，让你能够完全掌控自己的数据与基础设施。无论你是独立开发者、初创团队，还是大型企业，n8n 都可以成为你自动化体系的核心支柱。</p>
<h2 data-id="heading-0">文章核心要点</h2>
<ul>
<li>n8n 是一款开源工作流自动化工具，通过可视化流程连接应用、API 与服务。</li>
<li>支持自托管，适合注重隐私与合规的企业级场景。</li>
<li>支持复杂逻辑、分支控制、错误处理以及自定义代码。</li>
<li>非常适合开发者、DevOps 团队以及 AI / ML 工作流。</li>
<li>相比 Zapier 等工具，n8n 更灵活，长期使用成本更低。</li>
</ul>
<h2 data-id="heading-1">什么是 n8n？</h2>
<p>n8n 是一个基于节点（node）的开源工作流自动化平台，工作流中的每一步都以一个节点表示。它与 Zapier 等工具类似，但在灵活性和对高级、AI 驱动自动化流程的支持方面更强。如果你在日常工作中还没有使用 AI 自动化工具，很可能正在错失巨大的效率提升机会。</p>
<p>通过 n8n，你可以轻松连接各种应用、服务与 API。借助 DigitalOcean 的一键应用（1-Click App），你可以在安全、可扩展的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aidroplet.com%2Fproduct%2Fcloudcpu%2F" target="_blank" title="https://www.aidroplet.com/product/cloudcpu/" ref="nofollow noopener noreferrer">DigitalOcean Droplet 云服务器</a>上快速部署 n8n，无需复杂配置。可视化工作流编辑器让你能够高效创建自定义自动化流程。</p>
<p>每个节点都可以触发动作、处理和转换数据、调用 API 或执行逻辑，从而构建端到端的强大自动化流程。</p>
<p>n8n 可以用于各种自动化场景，例如：</p>
<ul>
<li>自动化重复性任务</li>
<li>集成多个应用</li>
<li>编排复杂的后端工作流</li>
<li>构建自动化流水线，而无需开发完整应用</li>
</ul>
<h2 data-id="heading-2">n8n 的工作方式（How n8n Works）</h2>
<p>n8n 的工作流以可视化方式构建，并按顺序或条件执行。成功登录后，你可以从零开始创建自动化流程，也可以直接尝试 AI 工作流。</p>
<h2 data-id="heading-3">核心组件（Core Components）</h2>
<h3 data-id="heading-4">触发节点（Trigger Nodes）</h3>
<p>触发节点用于启动工作流。你可以选择不同类型的触发器，例如：</p>
<ul>
<li>启动一个工作流</li>
<li>应用事件触发</li>
<li>定时触发</li>
<li>聊天消息触发</li>
</ul>
<p>你可以将其视为工作流的起点，一旦触发器被激活，后续所有关联操作都会被执行。</p>
<p><img src="https://www.digitaloceans.cn/wp-content/uploads/2025/12/image-11-626x1024.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">动作节点（Action Nodes）</h3>
<p>动作节点是工作流中的“执行者”，用于完成具体操作，例如发送数据、创建记录、更新数据库、调用 API 或触发外部服务。</p>
<p>触发节点负责启动流程，动作节点负责真正干活。</p>
<p>示例：</p>
<ul>
<li>发送邮件</li>
<li>在表单提交后创建记录</li>
<li>将表单数据写入 Excel</li>
<li>创建数据库记录</li>
<li>调用 REST API</li>
</ul>
<h3 data-id="heading-6">逻辑节点（Logic Nodes）</h3>
<p>逻辑节点用于控制工作流的行为，决定走哪条路径、如何组合数据，以及某些步骤何时执行。</p>
<p>示例：</p>
<ul>
<li>IF 条件</li>
<li>Switch</li>
<li>Merge</li>
<li>Filter</li>
<li>循环（Loop）</li>
</ul>
<p><img src="https://www.digitaloceans.cn/wp-content/uploads/2025/12/image-10-1024x1004.png" alt="" loading="lazy"/></p>
<p>示例逻辑：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">如果</span> <span class="hljs-string">orderAmount</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">5000</span> <span class="hljs-string">→</span> <span class="hljs-string">发送高端客户邮件</span>  
<span class="hljs-string">否则</span> <span class="hljs-string">→</span> <span class="hljs-string">发送普通邮件</span>
</code></pre>
<p>它的工作方式是这样的：</p>
<ul>
<li>获取输入数据</li>
<li>判断条件</li>
<li>将工作流拆分为 True / False 两条路径</li>
</ul>
<h3 data-id="heading-7">代码节点（Code Nodes）</h3>
<p>代码节点允许你在工作流中编写自定义 JavaScript 或 Python。当内置节点无法满足复杂逻辑或数据处理需求时，就可以使用代码节点。</p>
<p>适用于：</p>
<ul>
<li>数据转换</li>
<li>自定义逻辑</li>
<li>高级计算</li>
</ul>
<p><strong>什么时候该用代码节点？</strong></p>
<ul>
<li>Set 节点不够用</li>
<li>IF / Switch 难以表达复杂条件</li>
<li>需要循环、数学计算或复杂格式化</li>
<li>API 返回的数据需要大量重构</li>
</ul>
<p>如果 Set 或 IF 节点就能解决问题，应尽量避免使用代码节点（越简单的流程越易维护）。</p>
<p>示例数据结构：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"json"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Shaoni"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">82</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-8">在 DigitalOcean 上快速部署 n8n</h2>
<p>1、登录并创建新用户，如果你没有 DigitalOcean 的账号，可访问 digitalocean.com 注册，仅需邮箱和信用卡（或支付宝）即可。如注册遇到问题，可咨询 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aidroplet.com%2F" target="_blank" title="https://www.aidroplet.com/" ref="nofollow noopener noreferrer">DigitalOcean 中国区独家战略合作伙伴卓普云 AI Droplet（aidroplet.com）</a>。</p>
<p>2、以 root 用户 SSH 登录 Droplet，具体可参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.aidroplet.com%2Ftutorials%2Frun-deepseek-r1-h100%2F" target="_blank" title="https://blog.aidroplet.com/tutorials/run-deepseek-r1-h100/" ref="nofollow noopener noreferrer">卓普云官网更多教程</a></p>
<p>3、创建非 root 用户并授予 sudo 权限</p>
<pre><code class="hljs language-xml" lang="xml">adduser <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>
usermod -aG sudo <span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>
</code></pre>
<p>4、配置 SSH key 并使用新用户登录</p>
<p>5、克隆 n8n Docker 配置</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/n8n-io/n8n-docker-caddy.git
<span class="hljs-built_in">cd</span> n8n-docker-caddy
</code></pre>
<p>6、创建 Docker 卷</p>
<pre><code class="hljs language-lua" lang="lua">sudo docker volume <span class="hljs-built_in">create</span> caddy_data
sudo docker volume <span class="hljs-built_in">create</span> n8n_data
</code></pre>
<p>7、配置 DNS 与防火墙</p>
<pre><code class="hljs">sudo ufw allow 80
sudo ufw allow 443
</code></pre>
<p>8、配置 n8n 与 Caddy</p>
<pre><code class="hljs language-bash" lang="bash">nano .<span class="hljs-built_in">env</span>
nano caddy_config/Caddyfile
</code></pre>
<p>9、启动 n8n</p>
<pre><code class="hljs">sudo docker compose up -d
</code></pre>
<p>10、在浏览器中访问你的子域名并登录，即可获得一个带 HTTPS 与持久化数据的自托管 n8n 实例。</p>
<h2 data-id="heading-9"><strong>在 n8n 中使用预构建的工作流</strong>​<strong>模板</strong></h2>
<p><strong>访问 n8n 网站：</strong> 前往 n8n 官网，打开"产品"下拉菜单。在这里，您将找到大量预构建的工作流自动化模板。</p>
<p><img src="https://www.digitaloceans.cn/wp-content/uploads/2025/12/image-12-1024x611.png" alt="" loading="lazy"/></p>
<p><strong>浏览或搜索模板：</strong> 您可以滚动浏览可用的模板，或使用搜索栏查找与您特定用例匹配的模板。</p>
<p><strong>选择模板：</strong> 点击一个模板以查看其详细信息。例如，名为“使用 Telegram、Gemini AI 和 Google Sheets 的营养追踪与餐食记录器”的模板。</p>
<p><img src="https://www.digitaloceans.cn/wp-content/uploads/2025/12/image-8-1024x548.png" alt="" loading="lazy"/></p>
<p><strong>查看连接的应用程序：</strong> 每个模板都清晰地展示了它连接了哪些应用程序和服务。在此例中，该工作流使用了 Telegram、Gemini AI 和 Google Sheets。</p>
<p><strong>了解工作流</strong>​<strong>结构：</strong> 打开模板，查看其完整的工作原理描述。您可以放大和缩小，以检查每个工作流组件，并了解数据如何在节点之间流动。</p>
<p><strong>利用预构建逻辑节省时间：</strong> 从头开始构建此类工作流可能耗时且需要高级技能。这些模板允许您复用经过验证的自动化逻辑，从而快速开始。</p>
<p><strong>使用模板：</strong> 点击“免费使用”开始导入模板。</p>
<p><strong>复制模板：</strong> 选择“复制模板到剪贴板”，将工作流配置复制到剪贴板。</p>
<p><img src="https://www.digitaloceans.cn/wp-content/uploads/2025/12/image-7-1024x671.png" alt="" loading="lazy"/></p>
<p><strong>粘贴到您的 n8n 仪表板：</strong> 打开您自托管的 n8n 仪表板，将复制的模板直接粘贴到您的工作流画布中。</p>
<p><strong>遵循模板指南：</strong> 每个模板都附有用户指南。请仔细阅读并按照说明逐步配置工作流。</p>
<p><strong>配置所需的 ​API</strong>​<strong>​ 密钥：</strong> 这些高级工作流通常需要多个 API 密钥和凭据。请按照指示添加它们以完成设置。</p>
<p><strong>建议将这些 ​API</strong>​​<strong>​ 密钥添加到您的帐户中，以便真正开始无故障地运行工作流</strong>​**。**</p>
<h2 data-id="heading-10">部署方式</h2>

















<table><thead><tr><th>部署方式</th><th>说明</th></tr></thead><tbody><tr><td>n8n Cloud</td><td>官方托管服务，无需运维，适合个人和小团队</td></tr><tr><td>自托管</td><td>在虚拟机、Docker 或 Kubernetes 上部署，完全掌控安全与数据</td></tr></tbody></table>
<h2 data-id="heading-11">使用 n8n 的最佳实践</h2>
<p><strong>保持工作流</strong>​<strong>模块化与可复用性：</strong> 将工作流设计为小巧、独立的单元，每个单元只承担单一职责。随着自动化体系的扩展，模块化工作流更易于复用、测试和维护。</p>
<p><strong>使用描述性节点名称：</strong> 为节点重命名，清晰描述其功能，以保持工作流的可读性和易于理解。这在重新审阅工作流或与他人协作时尤为有帮助。</p>
<p><strong>记录关键步骤以便调试：</strong> 在工作流的关键阶段记录重要的输入和输出信息，以便快速定位问题所在。这能使故障排查更快捷、更可靠。</p>
<p>​<strong>为生产环境启用错误工作流</strong>​**：** 使用错误工作流来自动捕获和处理生产环境中的故障。这有助于告警、监控，并防止发生静默的工作流故障。</p>
<p><strong>避免硬编码凭证：</strong> 始终使用 n8n 的凭证系统来存储 API 密钥和机密信息，而非将其直接嵌入工作流中。这能提升安全性并简化凭证管理。</p>
<p><strong>尽可能对工作流</strong>​<strong>进行版本控制：</strong> 将工作流导出并存储在 Git 等版本控制系统中，以便追踪变更并在需要时安全地回滚更新。</p>
<h2 data-id="heading-12">常见问题</h2>
<p><strong>Q：n8n 是免费的吗？</strong> 是的，开源版本可免费自托管；云版本为订阅制。</p>
<p><strong>Q：需要编程基础吗？</strong> 基础流程不需要，但复杂逻辑建议具备 JavaScript / API 知识。</p>
<p><strong>Q：与 Zapier 有何不同？</strong> n8n 更灵活，支持自托管与深度定制，适合复杂场景，长期成本更低。</p>
<p><strong>Q：能处理大规模工作流</strong>​<strong>吗？</strong> 可以，支持队列与横向扩展，适合企业级场景。</p>
<p><strong>Q：n8n 安全吗？</strong> 在正确部署下是安全的，支持凭证加密与自托管。</p>
<p><strong>Q：能用于 AI / ​LLM</strong>​<strong>工作流吗？</strong> 完全可以，适合 RAG、AI Agent 编排、批量推理等场景。</p>
<p><strong>Q：支持 Webhook 吗？</strong> 支持，是核心功能之一。</p>
<p><strong>Q：能否扩展自定义节点？</strong> 可以，开发者可编写自定义节点。</p>
<p><strong>Q：适合非技术团队吗？</strong> 基础可用，但复杂流程更适合有开发支持的团队。</p>
<p><strong>Q：常见使用场景？</strong></p>
<ul>
<li>初创公司</li>
<li>SaaS 平台</li>
<li>DevOps 团队</li>
<li>AI / ML 基础设施</li>
<li>数据工程流水线</li>
</ul>
<p>n8n 是一款强大、灵活、以开发者为中心的自动化平台，填补了无代码工具与完全定制开发之间的空白。其开源特性、可扩展性与深度定制能力，使其成为构建严肃自动化工作流的理想选择，尤其适用于现代 AI 驱动与云原生环境。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis踩坑实录：那些不报错但让你debug到深夜的Bug]]></title>    <link>https://juejin.cn/post/7586588823905730569</link>    <guid>https://juejin.cn/post/7586588823905730569</guid>    <pubDate>2025-12-23T02:47:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586588823905730569" data-draft-id="7586540799250726966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis踩坑实录：那些不报错但让你debug到深夜的Bug"/> <meta itemprop="keywords" content="MyBatis,Java,面试"/> <meta itemprop="datePublished" content="2025-12-23T02:47:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一旅人"/> <meta itemprop="url" content="https://juejin.cn/user/3485898277388519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis踩坑实录：那些不报错但让你debug到深夜的Bug
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3485898277388519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一旅人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:47:33.000Z" title="Tue Dec 23 2025 02:47:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    78
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>早上刚到公司，打开电脑，写着需求听着歌。突然钉钉一响，测试发来消息："你那个接口报错了"。打开日志一看，MyBatis又炸了。</p>
</blockquote>
<p>说实话，MyBatis这玩意儿平时挺好用的，但有时候报的错真让人摸不着头脑。尤其是那种<strong>本地跑得好好的，一上线就炸的Bug</strong>，简直让人怀疑人生。今天就记录两个让我debug到深夜的坑，它们都有个共同特点：<strong>代码看起来完全没问题，但运行时就是莫名其妙地报错</strong>。</p>
<p>如果你也被MyBatis折磨过，这篇文章可能会让你会心一笑：原来不是我一个人踩过这些坑😂。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad176944fd4d4a52b8bd1dce48cdd750~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5peF5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767067632&amp;x-signature=KdCPMzXMWXLUA%2B9ZVYPJUGn1HoI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">坑位一：Arrays.asList() 遇上老版本MyBatis（3.2.x版本）</h2>
<h3 data-id="heading-1">事故现场</h3>
<p>周五下午四点半（是的，Bug总是在快下班时出现），测试环境突然报了个令人头大的异常：</p>
<pre><code class="hljs language-java" lang="java">   <span class="hljs-string">"org.mybatis.spring.MyBatisSystemException: nested exception is org.apache.ibatis.builder.BuilderException: Error evaluating expression 'userCode.size() &gt; 0'. Cause: org.apache.ibatis.ognl.MethodFailedException: Method "</span>size<span class="hljs-string">" failed for object [aaa, bbb] [java.lang.IllegalAccessException: Class org.apache.ibatis.ognl.OgnlRuntime can not access a member of class java.util.Collections$UnmodifiableCollection with modifiers "</span><span class="hljs-keyword">public</span><span class="hljs-string">"]
     at org.mybatis.spring.MyBatisExceptionTranslator.translateExceptionIfPossible(MyBatisExceptionTranslator.java:73)
     at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:364)
     at $Proxy15.selectList(Unknown Source)
     at org.mybatis.spring.SqlSessionTemplate.selectList(SqlSessionTemplate.java:194)
     at org.apache.ibatis.binding.MapperMethod.executeForMany(MapperMethod.java:114)
     at org.apache.ibatis.binding.MapperMethod.execute(MapperMethod.java:58)
     at org.apache.ibatis.binding.MapperProxy.invoke(MapperProxy.java:43)
     at $Proxy18.fetchOrder(Unknown Source)
     at com.xx.xx.server.impl.XX.fetchOrderByUnitNo(RechargeCardBillServiceImpl.java:351)
     at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
     at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
     at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
     at java.lang.reflect.Method.invoke(Method.java:597)
     at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:317)
     at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:198)
     at $Proxy26.fetchOrderByUnitNo(Unknown Source)
     at com.ofpay.ofdc.task.AbstractRechargeTask.run(AbstractRechargeTask.java:65)
     at java.lang.Thread.run(Thread.java:662)
</span></code></pre>
<p>看到这个异常，我第一反应是：<strong>什么鬼？size()方法还能调用失败？</strong></p>
<p>来看看出问题的代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Controller层</span>
List&lt;String&gt; userCodes = Arrays.asList(<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>);
orderService.fetchOrderByUserCodes(userCodes);
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Mapper.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fetchOrder"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"Order"</span>&gt;</span>
    SELECT * FROM t_order
    WHERE 1=1
    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userCode != null and userCode.size() &gt; 0"</span>&gt;</span>
        AND user_code IN
        <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">"userCode"</span> <span class="hljs-attr">item</span>=<span class="hljs-string">"code"</span> <span class="hljs-attr">open</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">close</span>=<span class="hljs-string">")"</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">","</span>&gt;</span>
            #{code}
        <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre>
<p>这代码看起来没啥问题啊？userCode不为空，调个size()方法判断长度，天经地义。但它就是报错了，而且是偶现（一般偶现都有大坑）。</p>
<h3 data-id="heading-2">先说解决方案</h3>
<p>一顿<strong>ChatGPT + Google + Stack Overflow搜索</strong>后，找到了三种解决办法：</p>
<p><strong>方案1：改入参类型（最快）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 把Arrays.asList返回的"假ArrayList"转成真正的ArrayList</span>
List&lt;String&gt; userCodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="hljs-string">"aaa"</span>, <span class="hljs-string">"bbb"</span>, <span class="hljs-string">"ccc"</span>));
</code></pre>
<p>改完重新发布，问题秒解决。测试验证通过，终于可以下班了。</p>
<p><strong>方案2：改XML表达式（不改Java代码）</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 用length属性替代size()方法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userCode != null and userCode.length &gt; 0"</span>&gt;</span>
    AND user_code IN ...
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<p>这个方案也能work，而且不用改业务代码，改完就能用。</p>
<p><strong>方案3：升级MyBatis版本（治本之策）</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 从老古董版本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 2014年的版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 升级到现代版本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.13<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>不过这个方案需要做全面的回归测试，周五晚上就算了，留到下周慢慢搞。</p>
<h3 data-id="heading-3">刨根问底：这到底是个啥坑？</h3>
<p>线上问题解决了，但总感觉哪里不对劲。周末闲着没事，决定把这个诡异的异常刨根问底搞清楚。翻了半天资料，终于明白是怎么回事了。</p>
<p><strong>第一层问题：类型不同</strong></p>
<p><code>Arrays.asList()</code> 返回的不是我们熟悉的 <code>java.util.ArrayList</code>，而是 <code>java.util.Arrays</code> 的一个私有静态内部类 <code>Arrays$ArrayList</code>。</p>
<p>写个简单的测试验证一下：</p>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; list1 = Arrays.asList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>);
List&lt;String&gt; list2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>));

System.out.println(list1.getClass());  
<span class="hljs-comment">// 输出: class java.util.Arrays$ArrayList</span>

System.out.println(list2.getClass());  
<span class="hljs-comment">// 输出: class java.util.ArrayList</span>
</code></pre>
<p>看到没？一个是<code>Arrays$ArrayList</code>，一个是<code>ArrayList</code>，虽然都实现了List接口，但类型完全不同。</p>
<p><strong>第二层问题：访问权限异常</strong></p>
<p>MyBatis用OGNL表达式引擎来解析XML中的条件判断（比如 <code>userCode.size() &gt; 0</code>）。当OGNL尝试通过反射调用 <code>Arrays$ArrayList</code> 的 <code>size()</code> 方法时，发现这个类是 <code>private static class</code>（私有静态内部类）。</p>
<p>虽然 <code>size()</code> 方法本身是 <code>public</code> 的，但因为类本身是 <code>private</code> 修饰符，OGNL在反射访问时需要调用 <code>setAccessible(true)</code> 来绕过权限检查。问题就出在这里！</p>
<p><strong>第三层问题：并发Bug（重点来了！）</strong></p>
<p>老版本MyBatis在处理反射时有个并发问题：<strong>当需要调用私有类的方法时，会先设置 <code>accessible = true</code>，调用完再设回 <code>false</code>。但这个操作没有加锁！（非原子性）</strong></p>
<p>想象一下这个场景：</p>
<ul>
<li>线程A：设置 <code>accessible = true</code>，准备调用方法</li>
<li>线程B：也设置 <code>accessible = true</code>，然后调用方法，再设回 <code>false</code></li>
<li>线程A：此时去调用方法，发现 <code>accessible</code> 已经被B改成 <code>false</code> 了，boom！💥</li>
</ul>
<p>这就是<strong>为什么这个Bug偶尔才出现，因为它本质上是个并发问题</strong>！只有在高并发场景下，多个线程同时调用这个接口时才会触发。</p>
<p>GitHub上有人早在2014年就提了这个issue：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmybatis%2Fmybatis-3%2Fpull%2F384" target="_blank" title="https://github.com/mybatis/mybatis-3/pull/384" ref="nofollow noopener noreferrer">mybatis/mybatis-3#384</a></p>
<p>后来MyBatis在3.3.x版本修复了这个问题，对反射操作加了同步控制，确保 <code>accessible</code> 的设置和方法调用是原子操作。</p>
<hr/>
<h2 data-id="heading-4">坑位二：参数传0，SQL条件神秘消失之谜</h2>
<h3 data-id="heading-5">又一个周五的故事</h3>
<p>是的，又是周五下午（墨菲定律：Bug永远在周五出现😭）。需求很简单：查询所有"待支付"状态（status=0）的订单。十分钟写完代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Service层</span>
<span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">queryPendingOrders</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> orderMapper.queryOrderByStatus(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 0表示待支付</span>
}
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Mapper.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"queryOrderByStatus"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"Order"</span>&gt;</span>
    SELECT * FROM t_order
    WHERE 1=1
    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null and status != ''"</span>&gt;</span>
        AND status = #{status}
    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre>
<p>本地测试，完美运行。提交代码，合并主干，发布测试环境。心想这次稳了，准备提前收拾东西下班。</p>
<p>结果半小时后，测试同学发来消息："这个接口有问题啊，怎么把所有状态的订单都查出来了？我要的是status=0的订单。"</p>
<p>我一脸懵逼：？？？不可能啊，我刚测过的，明明没问题！</p>
<p>打开测试环境日志，执行的SQL是：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_order <span class="hljs-keyword">WHERE</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>
</code></pre>
<p><strong>WHERE后面的status条件呢？被吃了？</strong></p>
<h3 data-id="heading-6">Debug之旅</h3>
<p>我在本地打断点，一步步调试：</p>
<ol>
<li>Controller层传入的参数：<code>status = 0</code> ✅</li>
<li>Service层收到的参数：<code>status = 0</code> ✅</li>
<li>MyBatis执行的SQL：<code>WHERE 1=1</code> ❌</li>
</ol>
<p>问题肯定出在XML的if判断上。盯着这行看了好几分钟：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null and status != ''"</span>&gt;</span>
</code></pre>
<p>突然灵光一现：<strong>会不会是 0 被判定成了空字符串？</strong></p>
<p>赶紧改成这样试试：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null"</span>&gt;</span>
    AND status = #{status}
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<p>重新发布，问题解决！测试环境查询status=0的订单，正常返回了。</p>
<h3 data-id="heading-7">原理揭秘：OGNL的类型转换陷阱</h3>
<p>这又是一个MyBatis（准确说是OGNL）的经典坑。<strong>这个坑比第一个还隐蔽，因为它不会报错，而是悄悄地把你的条件吃掉</strong>。</p>
<p><strong>OGNL的求值逻辑</strong></p>
<p>MyBatis的 <code>&lt;if&gt;</code> 标签用的是OGNL表达式引擎。当你写 <code>status != ''</code> 时，OGNL内部会经历这样的判断流程：</p>
<ol>
<li>先通过 <code>OgnlCache.getValue()</code> 获取表达式的值（这里表达式返回了false）</li>
<li>然后在 <code>ExpressionEvaluator.evaluateBoolean()</code> 中判断这个值，根据返回的不同类型作不同判断，最终返回boolean类型结果。</li>
</ol>
<p>先看第二步！OGNL对不同类型有不同的判断逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ExpressionEvaluator.evaluateBoolean()方法 OGNL的判断逻辑</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">evaluateBoolean</span><span class="hljs-params">(String expression, Object parameterObject)</span> {
  <span class="hljs-comment">// 这里value返回的是false</span>
  <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> OgnlCache.getValue(expression, parameterObject);
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Boolean) {
    <span class="hljs-comment">// 因此会走到这里，返回false</span>
    <span class="hljs-keyword">return</span> (Boolean) value;
  }
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Number) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(String.valueOf(value)).compareTo(BigDecimal.ZERO) != <span class="hljs-number">0</span>;
  }
  <span class="hljs-keyword">return</span> value != <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>类型转换的坑</strong></p>
<p>当你写 <code>status != ''</code> 时，从<code>OgnlCache.getValue()</code>往下不断追溯，OGNL最终会调用 <code>compareWithConversion</code> 方法做类型转换比较。这个方法会把两边的值都转成同一类型再比较：</p>
<ul>
<li>数值 <code>0</code> 会被转成 <code>double类型：0.0</code></li>
<li>空字符串 <code>""</code> 也会被转成 <code>double类型：0.0</code></li>
</ul>
<p>结果就是 <code>0 == ""</code> 被判定为 <code>true</code>，导致 <code>status != ''</code> 返回 <code>false</code>，你的if条件不成立，SQL条件就没了！</p>
<p><strong>为什么本地测试没问题？</strong></p>
<p>是因为我本地测试时传的参数是 <code>status=1</code> 或其他非0值，而测试环境刚好传了 <code>status=0</code>。这种Bug特别隐蔽，因为它不会报错，只是查询结果不符合预期。</p>
<p><strong>这个坑的适用范围</strong>：</p>
<ul>
<li>参数是<strong>数值类型</strong>（Integer、Long等）的 <strong>0</strong></li>
<li>XML中写了 <code>!= ''</code> 的空字符串判断</li>
<li><strong>字符串"0"不受影响</strong>（<code>"0" != ''</code> 正常判定为true）</li>
</ul>
<p>感兴趣的可以自己去看看MyBatis源码中的 <code>ExpressionEvaluator</code> 类和OGNL的 <code>OgnlOps.compareWithConversion</code> 方法，就能明白整个转换过程了。</p>
<h3 data-id="heading-8">正确姿势大全</h3>
<p>根据不同场景，我总结了几种写法：</p>
<p><strong>场景1：参数是Integer/Long等包装类型</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 推荐：只判null，数值0是有效值 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null"</span>&gt;</span>
    AND status = #{status}
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<p><strong>场景2：参数可能是数值也可能是字符串</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 显式包含0的判断 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"status != null and (status != '' or status == 0)"</span>&gt;</span>
    AND status = #{status}
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<p><strong>场景3：字符串类型参数</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 字符串正常判断，不会有坑 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"userName != null and userName != ''"</span>&gt;</span>
    AND user_name = #{userName}
<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">避坑建议</h3>
<ol>
<li>
<p><strong>数值类型参数，别用空字符串判断</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ❌ 错误写法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"count != null and count != ''"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- ✅ 正确写法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"count != null"</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>记住数值类型和字符串类型要区分对待</strong></p>
<ul>
<li>数值类型（Integer、Long）：只判<code>!= null</code></li>
<li>字符串类型：判<code>!= null and != ''</code></li>
</ul>
</li>
<li>
<p><strong>确实需要兼容的场景，明确写出0的判断</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"value != null and (value != '' or value == 0)"</span>&gt;</span>
</code></pre>
</li>
<li>
<p><strong>升级MyBatis版本并不能解决这个问题</strong>（因为这是OGNL的特性，不是bug）</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-10">总结与最佳实践</h2>
<p>这两个问题虽然表现形式不同，但都源于<strong>OGNL表达式引擎</strong>的特殊行为。理解这些陷阱背后的机制，能帮助我们写出更健壮的MyBatis代码。</p>
<h3 data-id="heading-11">核心要点</h3>
<ol>
<li>
<p><strong>Arrays.asList()的陷阱</strong></p>
<ul>
<li>
<p><code>Arrays.asList()</code> 返回的不是真正的ArrayList，是Arrays的私有静态内部类</p>
</li>
<li>
<p>老版本MyBatis（3.3.x之前）的OGNL表达式引擎：<strong>反射访问私有静态内部类的public方法时，在设置 <code>accessible = true</code>参数时会有并发问题</strong></p>
</li>
<li>
<p><strong>解决方法</strong>：包装成真正的ArrayList或升级MyBatis版本</p>
</li>
</ul>
</li>
<li>
<p><strong>「if」标签：数值0判空的陷阱</strong></p>
<ul>
<li>
<p>OGNL会将数值0与空字符串做类型转换比较</p>
</li>
<li>
<p><code>status != ''</code> 会返回false，导致「if」表达式条件不满足，数值0的查询条件被过滤</p>
</li>
<li>
<p><strong>解决方法</strong>：数值类型只判断<code>!= null</code>，不要判断空字符串</p>
</li>
</ul>
</li>
</ol>
<p>希望这篇文章能帮你避开这些坑，让周五下班不再是奢望 😄</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[到底选 Nuxt 还是 Next.js？SEO 真的有那么大差距吗 🫠🫠🫠]]></title>    <link>https://juejin.cn/post/7586505172816150579</link>    <guid>https://juejin.cn/post/7586505172816150579</guid>    <pubDate>2025-12-23T01:36:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172816150579" data-draft-id="7585105375793233954" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="到底选 Nuxt 还是 Next.js？SEO 真的有那么大差距吗 🫠🫠🫠"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-23T01:36:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            到底选 Nuxt 还是 Next.js？SEO 真的有那么大差距吗 🫠🫠🫠
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:36:18.000Z" title="Tue Dec 23 2025 01:36:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，它是一个完整的 AI 全栈协同文档平台。该项目融合了多个技术栈，包括基于 <code>Tiptap</code> 的富文本编辑器、<code>NestJs</code> 后端服务、<code>AI</code> 集成功能和实时协作。在开发过程中，我积累了丰富的实战经验，涵盖了 <code>Tiptap</code> 的深度定制、性能优化和协作功能的实现等核心难点。</p>
</blockquote>
<p>如果你对 AI 全栈开发、Tiptap 富文本编辑器定制或 DocFlow 项目的完整技术方案感兴趣，欢迎加我微信 <code>yunmz777</code> 进行私聊咨询，获取详细的技术分享和最佳实践。</p>
<p>关于 <code>Nuxt</code> 和 <code>Next.js</code> 的 SEO 对比，技术社区充斥着太多误解。最常见的说法是 <code>Nuxt</code> 的 <code>Payload JSON</code> 化会严重影响 SEO，未压缩的数据格式会拖慢页面加载。还有人担心环境变量保护机制存在安全隐患。</p>
<p>实际情况远非如此。框架之间的 SEO 差异被严重夸大了。<code>Nuxt</code> 采用未压缩 JSON 是为了保证数据类型完整性和加速水合过程，这是深思熟虑的设计权衡。所谓的安全问题，本质上是第三方生态设计的挑战，而非框架缺陷。</p>
<p>真正影响搜索引擎排名的是内容质量、用户体验、页面性能和技术实践，而非框架选择。一个优化良好的 <code>Nuxt</code> 网站完全可能比未优化的 <code>Next.js</code> 网站排名更好。</p>
<h2 data-id="heading-0">一、服务端渲染机制对比</h2>
<h3 data-id="heading-1">Next.js：压缩优先</h3>
<p><code>Next.js</code> 新版本使用压缩字符串格式序列化数据，旧版 <code>Page Router</code> 则用 JSON。数据以 <code>&lt;script&gt;</code> 标签形式嵌入 HTML，客户端接收后解压完成水合。</p>
<p>这种方案优势明显：HTML 文档体积小，传输快，初始加载速度优秀。<code>App Router</code> 还支持流式渲染和 <code>Server Components</code>，服务端可以逐步推送内容，不需要等待所有数据准备就绪。</p>
<p>权衡也很清楚：增加了客户端计算开销，复杂数据类型需要额外处理。</p>
<h3 data-id="heading-2">Nuxt：类型完整性优先</h3>
<p><code>Nuxt</code> 采用未压缩 JSON 格式，通过 <code>window.__NUXT__</code> 对象嵌入数据。设计思路基于一个重要前提：现代浏览器的 <code>JSON.parse()</code> 性能极高，V8 引擎对 JSON 解析做了大量优化。相比自定义压缩算法，直接用 JSON 格式解析速度更快。</p>
<p>核心优势是水合速度极快，支持完整的 JavaScript 复杂类型。<code>Nuxt</code> 使用 <code>devalue</code> 序列化库，能够完整保留 <code>Map</code>、<code>Set</code>、<code>Date</code>、<code>RegExp</code>、<code>BigInt</code> 等类型，还能处理循环引用。这意味着从后端传递 <code>Map</code> 数据，前端反序列化后依然是 <code>Map</code>，而不会被转换为普通 <code>Object</code>。</p>
<p>当然，包含大量数据时 HTML 体积会增大。不过对于大数据场景，<code>Nuxt</code> 已经支持 <code>Lazy Hydration</code> 来处理。</p>
<h3 data-id="heading-3">设计哲学差异</h3>
<p><code>Next.js</code> 优先考虑传输速度，适合前后端分离场景。<code>Nuxt</code> 优先保证类型完整性，更适合全栈 JavaScript 应用。由于前后端都用 JavaScript，保持数据类型一致性可以减少大量类型转换代码。</p>
<p>实际测试表明，大多数场景下这种方案不会拖慢首屏加载。一次传输加快速水合的策略，整体性能往往更优。</p>
<h2 data-id="heading-4">二、对 SEO 的实际影响</h2>
<h3 data-id="heading-5">Payload JSON 化的真实影响</h3>
<p>从 SEO 角度看，<code>Nuxt</code> 的方案有独特优势。爬虫可以直接从 HTML 获取完整内容，无需执行 JavaScript。即使 JS 加载或执行失败，页面核心内容依然完整存在于 HTML 中。这对 SEO 至关重要，因为搜索引擎爬虫虽然能执行 JavaScript，但更倾向于直接读取 HTML。</p>
<p>HTML 体积增大的影响被严重高估了。实际测试数据显示，即使 HTML 增大 50-100KB，对 <code>TTFB</code> 的影响也在 50-100ms 以内，用户几乎感知不到。而水合速度提升可能节省 100-200ms 的交互响应时间，整体用户体验反而更好。</p>
<h3 data-id="heading-6">Next.js 的性能优势</h3>
<p><code>Next.js</code> 采用压缩格式后，HTML 体积更小，服务器响应更快。实际数据显示平均 LCP 为 1.2 秒，INP 为 65ms，这些指标确实优秀。</p>
<p><code>Next.js 13+</code> 的 <code>Server Components</code> 进一步优化了数据传输。服务端组件的数据不需要序列化传输到客户端，直接在服务端渲染成 HTML，大大减少了传输量。对于主要展示内容的页面，这种方式可以实现接近静态页面的性能。</p>
<p><code>ISR</code> 功能也很实用。页面可以在构建时生成静态 HTML，然后在后台按需更新，既保证了首屏速度，又能及时更新内容。</p>
<h3 data-id="heading-7">核心结论</h3>
<p>框架对 SEO 的影响被严重夸大了。Google 的 Evergreen Googlebot 在 2019 年就已经能够完整执行现代 JavaScript。无论 <code>Nuxt</code> 还是 <code>Next.js</code>，只要正确实现了 SSR，搜索引擎都能获取完整内容。</p>
<p>框架选择对排名的影响可能不到 1%。真正影响 SEO 的是内容质量、页面语义化、结构化数据、内部链接结构、技术实践（<code>sitemap</code>、<code>robots.txt</code>）和用户体验指标。</p>
<h2 data-id="heading-8">三、SEO 功能特性对比</h2>
<h3 data-id="heading-9">元数据管理</h3>
<p><code>Next.js 13+</code> 的 <code>Metadata API</code> 提供了类型安全的元数据配置，与 <code>Server Components</code> 深度集成，可以在服务端异步获取数据生成动态元数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Next.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateMetadata</span>(<span class="hljs-params">{ params }</span>) {
  <span class="hljs-keyword">const</span> post = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchPost</span>(params.<span class="hljs-property">id</span>);
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">title</span>: post.<span class="hljs-property">title</span>,
    <span class="hljs-attr">description</span>: post.<span class="hljs-property">excerpt</span>,
    <span class="hljs-attr">openGraph</span>: { <span class="hljs-attr">images</span>: [post.<span class="hljs-property">coverImage</span>] },
  };
}
</code></pre>
<p><code>Nuxt</code> 的 <code>useHead</code> 提供响应式元数据管理，配合 <code>@nuxtjs/seo</code> 模块开箱即用。内置 <code>Schema.org JSON-LD</code> 生成器，可以更方便地实现结构化数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Nuxt</span>
<span class="hljs-keyword">const</span> post = <span class="hljs-keyword">await</span> <span class="hljs-title function_">useFetch</span>(<span class="hljs-string">`/api/posts/<span class="hljs-subst">${id}</span>`</span>);
<span class="hljs-title function_">useHead</span>({
  <span class="hljs-attr">title</span>: post.<span class="hljs-property">value</span>.<span class="hljs-property">title</span>,
  <span class="hljs-attr">meta</span>: [{ <span class="hljs-attr">name</span>: <span class="hljs-string">"description"</span>, <span class="hljs-attr">content</span>: post.<span class="hljs-property">value</span>.<span class="hljs-property">excerpt</span> }],
});

<span class="hljs-title function_">useSchemaOrg</span>([
  <span class="hljs-title function_">defineArticle</span>({
    <span class="hljs-attr">headline</span>: post.<span class="hljs-property">title</span>,
    <span class="hljs-attr">datePublished</span>: post.<span class="hljs-property">publishedAt</span>,
    <span class="hljs-attr">author</span>: { <span class="hljs-attr">name</span>: post.<span class="hljs-property">author</span>.<span class="hljs-property">name</span> },
  }),
]);
</code></pre>
<p><code>Next.js</code> 同样可以实现结构化数据，但需要手动插入 <code>&lt;script type="application/ld+json"&gt;</code> 标签。虽然需要额外工作，但提供了更大的灵活性。</p>
<h3 data-id="heading-10">语义化 HTML 与无障碍性</h3>
<p><code>Nuxt</code> 提供自动 <code>aria-label</code> 注入功能，<code>@nuxtjs/a11y</code> 模块可以在开发阶段自动检测无障碍性问题。<code>Next.js</code> 需要开发者手动确保，可以使用 <code>eslint-plugin-jsx-a11y</code> 检测问题。</p>
<p>语义化 HTML 对 SEO 的重要性常被低估。搜索引擎不仅读取内容，还会分析页面结构。正确使用 <code>&lt;article&gt;</code>、<code>&lt;section&gt;</code>、<code>&lt;nav&gt;</code> 等标签，可以帮助搜索引擎更好地理解内容层次。</p>
<h3 data-id="heading-11">静态生成与预渲染</h3>
<p><code>Next.js</code> 的 <code>ISR</code> 允许为每个页面设置不同的重新验证时间。首页可能每 60 秒重新生成，文章页面可能每天重新生成。这种精细化控制使得网站能在性能和内容新鲜度之间找到平衡：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Next.js ISR</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> revalidate = <span class="hljs-number">3600</span>; <span class="hljs-comment">// 每小时更新</span>
</code></pre>
<p><code>Nuxt 3</code> 支持混合渲染模式，可以在同一应用中同时使用 SSR、SSG 和 CSR，为不同页面选择最适合的渲染策略：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Nuxt 混合渲染</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtConfig</span>({
  <span class="hljs-attr">routeRules</span>: {
    <span class="hljs-string">"/"</span>: { <span class="hljs-attr">prerender</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">"/posts/**"</span>: { <span class="hljs-attr">swr</span>: <span class="hljs-number">3600</span> },
    <span class="hljs-string">"/admin/**"</span>: { <span class="hljs-attr">ssr</span>: <span class="hljs-literal">false</span> },
  },
});
</code></pre>
<p><code>Next.js 14</code> 的 <code>Partial Prerendering</code> 更进一步，允许在同一页面混合静态和动态内容。静态部分在构建时生成，动态部分在请求时渲染，结合了 SSG 的速度和 SSR 的灵活性。</p>
<h2 data-id="heading-12">四、性能指标与爬虫友好性</h2>
<h3 data-id="heading-13">Core Web Vitals 表现</h3>
<p>从各项指标看，<code>Next.js</code> 平均 LCP 为 1.2 秒，表现优秀。<code>Nuxt</code> 的 LCP 可能受 HTML 体积影响，但在 FCP 和 INP 方面得益于快速水合机制，同样表现出色。</p>
<p>需要强调的是，这些差异在实际 SEO 排名中影响极其有限。Google 在 2021 年将 <code>Core Web Vitals</code> 纳入排名因素，但权重相对较低。内容相关性、反向链接质量、域名权威度等传统因素权重仍然更高。</p>
<p>更重要的是，<code>Core Web Vitals</code> 分数取决于真实用户体验数据，而非实验室测试。网络环境、设备性能、缓存状态等因素对性能的影响远大于框架本身。一个优化良好的 <code>Nuxt</code> 网站完全可能比未优化的 <code>Next.js</code> 网站获得更好的分数。</p>
<p>两个框架都提供了丰富的优化工具。<code>Next.js</code> 的 <code>next/image</code> 提供自动图片优化、懒加载、响应式图片。<code>Nuxt</code> 的 <code>@nuxt/image</code> 提供类似功能，并支持多种图片托管服务。图片优化对 LCP 的影响往往比框架选择更大。</p>
<h3 data-id="heading-14">爬虫友好性</h3>
<p>两个框架在爬虫友好性方面几乎没有差别。都提供完整的服务端渲染内容，无需 JavaScript 即可获取页面信息，能正确返回 HTTP 状态码，支持合理的 URL 结构。</p>
<p><code>Nuxt</code> 的额外优势在于内置 <code>Schema.org JSON-LD</code> 生成器，有助于搜索引擎生成富文本摘要。结构化数据对现代 SEO 至关重要，通过嵌入 <code>JSON-LD</code> 格式的数据，可以告诉搜索引擎页面内容的具体含义。这些信息会显示在搜索结果中，提高点击率。</p>
<p>两个框架在处理动态路由、国际化、重定向等 SEO 关键功能上都提供了完善支持。</p>
<h2 data-id="heading-15">五、安全性问题澄清</h2>
<h3 data-id="heading-16">环境变量保护机制</h3>
<p>关于 <code>Nuxt</code> 会将 <code>NUXT_PUBLIC</code> 环境变量暴露到 HTML 的问题，需要明确这并非框架缺陷。<code>Nuxt</code> 的机制是只有显式设置为 <code>NUXT_PUBLIC_</code> 前缀的变量才会暴露到前端，非 public 变量不会出现在 HTML 中。</p>
<p>正常情况下，开发者不应该将重要信息设置为 public。任何重要信息都不应该放到前端，这是前端开发的基本原则，与框架无关。</p>
<p><code>Nuxt 3</code> 的环境变量系统被彻底重新设计。运行时配置分为公开和私有两部分：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Nuxt 配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtConfig</span>({
  <span class="hljs-attr">runtimeConfig</span>: {
    <span class="hljs-comment">// 私有配置，仅服务端可用</span>
    <span class="hljs-attr">apiSecret</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">API_SECRET</span>,

    <span class="hljs-comment">// 公开配置，会暴露到客户端</span>
    <span class="hljs-attr">public</span>: {
      <span class="hljs-attr">apiBase</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">API_BASE_URL</span>,
    },
  },
});
</code></pre>
<p><code>Next.js</code> 使用类似机制，以 <code>NEXT_PUBLIC_</code> 前缀的变量会暴露到客户端：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 服务端组件中</span>
<span class="hljs-keyword">const</span> apiSecret = process.<span class="hljs-property">env</span>.<span class="hljs-property">API_SECRET</span>; <span class="hljs-comment">// 可用</span>

<span class="hljs-comment">// 客户端组件中</span>
<span class="hljs-keyword">const</span> apiBase = process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_API_BASE</span>; <span class="hljs-comment">// 可用</span>
<span class="hljs-keyword">const</span> apiSecret = process.<span class="hljs-property">env</span>.<span class="hljs-property">API_SECRET</span>; <span class="hljs-comment">// undefined</span>
</code></pre>
<h3 data-id="heading-17">实际开发中的安全挑战</h3>
<p>真正的问题在于某些第三方库要求在前端初始化时传入密钥。一些 BaaS 服务（如 <code>Supabase</code>、<code>Firebase</code>）的前端 SDK 设计就需要在前端初始化，开发者无法控制这些第三方生态的设计。</p>
<p>以 <code>Supabase</code> 为例，它提供 <code>anon key</code>（匿名密钥）和 <code>service role key</code>（服务角色密钥）。<code>anon key</code> 设计为可以在前端使用，通过行级安全策略在数据库层面控制权限。<code>service role key</code> 则绕过所有安全策略，只能在服务端使用。</p>
<p>理想解决方案是将依赖密钥的库放到服务端，通过 API 调用使用。如果某个库需要在前端运行明文密钥，这个库本身就存在重大安全风险。但现实往往更复杂，生态适配问题难以完全避免。</p>
<p>值得注意的是，<code>Next.js</code> 同样存在类似的安全考量。两个框架在环境变量保护方面的机制基本一致，问题根源在于第三方生态设计，而非框架缺陷。</p>
<h3 data-id="heading-18">对 SEO 的影响</h3>
<p>环境变量问题本质上是安全问题，而非 SEO 问题。只要正确配置，不会影响搜索引擎爬取。</p>
<p>真正影响 SEO 的安全问题是：网站被攻击后注入垃圾链接、恶意重定向、隐藏内容等。这些行为会直接导致网站被搜索引擎惩罚，甚至从索引中移除。防止这类问题需要全方位的安全措施，远超框架本身的范畴。</p>
<h2 data-id="heading-19">六、实际应用场景</h2>
<h3 data-id="heading-20">内容密集型网站</h3>
<p>对于博客、新闻网站、文档站点，<code>Nuxt</code> 往往表现更好。内容块水合速度快，开箱即用的 SEO 功能完善，开发体验好。</p>
<p><code>Nuxt</code> 的 <code>@nuxt/content</code> 模块提供了基于 Markdown 的内容管理系统，支持全文搜索、代码高亮、自动目录生成。配合 <code>@nuxtjs/seo</code> 模块，可以快速构建 SEO 友好的内容网站：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Nuxt Content 使用</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: post } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">useAsyncData</span>(<span class="hljs-string">"post"</span>, <span class="hljs-function">() =&gt;</span>
  <span class="hljs-title function_">queryContent</span>(<span class="hljs-string">"/posts"</span>).<span class="hljs-title function_">where</span>({ <span class="hljs-attr">slug</span>: route.<span class="hljs-property">params</span>.<span class="hljs-property">slug</span> }).<span class="hljs-title function_">findOne</span>()
);
</code></pre>
<p>技术博客、文档网站特别适合这种方案。<code>VuePress</code>、<code>VitePress</code> 等静态站点生成器也是基于类似思路构建的。</p>
<h3 data-id="heading-21">动态应用</h3>
<p>对于电商平台、SaaS 应用等需要高级渲染技术和复杂交互的场景，<code>Next.js</code> 可能更合适。<code>ISR</code> 和部分预渲染能够更好地应对动态内容需求。</p>
<p>电商网站的 SEO 挑战在于商品数量庞大、内容动态变化、需要个性化推荐。<code>Next.js</code> 的 <code>ISR</code> 可以为每个商品页面设置合适的重新验证时间，既保证 SEO 友好，又能及时更新库存、价格：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Next.js 电商页面优化</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductPage</span>(<span class="hljs-params">{ params }</span>) {
  <span class="hljs-keyword">const</span> product = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchProduct</span>(params.<span class="hljs-property">id</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProductInfo</span> <span class="hljs-attr">product</span>=<span class="hljs-string">{product}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Skeleton</span> /&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">AddToCartButton</span> <span class="hljs-attr">productId</span>=<span class="hljs-string">{params.id}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> revalidate = <span class="hljs-number">1800</span>; <span class="hljs-comment">// 30分钟重新验证</span>
</code></pre>
<h3 data-id="heading-22">混合场景</h3>
<p>对于兼具内容和应用特性的混合场景，两个框架都能很好胜任。许多现代网站都是混合型的：既有内容页面（博客、文档），又有应用功能（用户中心、后台管理）。</p>
<p>关键是为不同类型页面选择合适的渲染策略。<code>Nuxt 3</code> 的 <code>routeRules</code> 提供路由级别的渲染控制：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Nuxt 混合渲染场景</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtConfig</span>({
  <span class="hljs-attr">routeRules</span>: {
    <span class="hljs-string">"/"</span>: { <span class="hljs-attr">prerender</span>: <span class="hljs-literal">true</span> }, <span class="hljs-comment">// 首页预渲染</span>
    <span class="hljs-string">"/blog/**"</span>: { <span class="hljs-attr">swr</span>: <span class="hljs-number">3600</span> }, <span class="hljs-comment">// 博客缓存 1 小时</span>
    <span class="hljs-string">"/dashboard/**"</span>: { <span class="hljs-attr">ssr</span>: <span class="hljs-literal">false</span> }, <span class="hljs-comment">// 用户中心客户端渲染</span>
    <span class="hljs-string">"/api/**"</span>: { <span class="hljs-attr">cors</span>: <span class="hljs-literal">true</span> }, <span class="hljs-comment">// API 路由</span>
  },
});
</code></pre>
<p><code>Next.js</code> 通过不同文件约定实现类似功能。可以在 <code>app</code> 目录中使用 Server Components 和 Client Components 组合，在 <code>pages</code> 目录中使用传统 SSR/SSG 方式。</p>
<h2 data-id="heading-23">七、开发者的真实痛点</h2>
<h3 data-id="heading-24">超越 SEO 的实际考量</h3>
<p>通过分析实际案例发现，开发者选择框架的真正原因往往不是 SEO。许多从 <code>Nuxt</code> 迁移到 <code>Next.js</code> 的团队，主要原因包括第三方生态兼容性问题（如 <code>Supabase</code> 等 BaaS 服务的前端依赖），以及开发体验（启动速度慢、构建时间长）。</p>
<p>客观来说，<code>Nuxt</code> 在开发服务器启动速度和构建时间方面确实存在优化空间。不过随着 <code>Rolldown</code>、<code>Oxc</code> 等下一代工具链的完善，这些问题有望改善。这说明 SEO 和安全问题可能被过度强调了，真正影响开发者选择的是开发体验和生态适配。</p>
<p>开发服务器启动速度直接影响开发效率。如果每次重启都需要等待 30-60 秒，一天下来可能浪费几十分钟。构建时间同样重要，尤其在 CI/CD 环境中。构建时间过长会延迟部署，影响快速迭代能力。</p>
<p>生态兼容性是另一个重要因素。某些库只提供 React 版本，某些只提供 Vue 版本。虽然可以通过适配器跨框架使用，但会增加维护成本。</p>
<h3 data-id="heading-25">技术方案的权衡</h3>
<p>没有完美的技术方案，只有最适合的选择。<code>Nuxt</code> 优先保证数据类型完整性和快速水合，<code>Next.js</code> 追求更小体积和更快 TTFB。</p>
<p>不同开发者有不同需求：内容型网站与应用型产品侧重点不同，小团队与大型商业项目考量各异。技术讨论中有句话很好地总结了这点：几乎所有框架都在解决同样的问题，差别只在于细微的实现方式。</p>
<p>对小团队来说，开发效率可能比性能优化更重要。快速实现功能、快速迭代，比追求极致性能指标更有价值。对大型团队来说，长期维护性和可扩展性更重要。</p>
<p>技术债务是另一个需要考虑的因素。随着项目发展，早期为了快速开发而做的权衡可能成为瓶颈。选择一个社区活跃、持续演进的框架很重要。<code>Next.js</code> 和 <code>Nuxt</code> 都有强大的商业支持（Vercel 和 NuxtLabs），这保证了框架的长期发展。</p>
<h2 data-id="heading-26">八、综合评估与选择建议</h2>
<h3 data-id="heading-27">SEO 能力评分</h3>
<p>从 SEO 能力看，<code>Next.js</code> 可以获得 4.5 分（满分 5 分）。优势在于优秀的 <code>Core Web Vitals</code> 表现、更小的 HTML 体积、成熟的 SEO 生态，以及 <code>ISR</code> 和部分预渲染等先进特性。不足是需要手动配置结构化数据，语义化 HTML 需要开发者特别注意。</p>
<p><code>Nuxt</code> 可以获得 4 分。优势包括内置 <code>Schema.org JSON-LD</code> 生成器、自动语义化 HTML 支持、在内容型网站的优秀表现，以及快速水合带来的良好体验。<code>Payload JSON</code> 导致 HTML 体积增大在实际应用中影响微小，已有 <code>Lazy Hydration</code> 等解决方案。开发服务器启动和构建速度慢是开发体验问题，与 SEO 无关。</p>
<p>需要说明的是，两者 SEO 能力实际上都接近满分，0.5 分的差异主要体现在开箱即用的便利性上，而非实际 SEO 效果。在真实搜索引擎排名中，这 0.5 分的差异几乎不会产生可察觉的影响。</p>
<h3 data-id="heading-28">选择 Next.js 的场景</h3>
<p>如果项目对 <code>Core Web Vitals</code> 有极高要求，或者需要复杂渲染策略的动态应用，<code>Next.js</code> 是更好的选择。以下场景推荐使用：</p>
<ul>
<li>电商平台，需要 <code>ISR</code> 平衡性能和内容新鲜度</li>
<li>SaaS 应用，对交互性能要求极高</li>
<li>国际化大型网站，需要精细性能优化</li>
<li>团队已有 React 技术栈，迁移成本低</li>
<li>需要使用大量 React 生态的第三方库</li>
<li>对 Vercel 平台部署优化感兴趣</li>
<li>需要 <code>Server Components</code> 的先进特性</li>
<li>项目规模大，需要严格的 TypeScript 类型检查</li>
</ul>
<h3 data-id="heading-29">选择 Nuxt 的场景</h3>
<p>如果项目是内容密集型网站（博客、新闻、文档），或者需要快速开发并利用框架的 SEO 便利功能，<code>Nuxt</code> 是理想选择。以下场景推荐使用：</p>
<ul>
<li>技术博客、文档站点，内容是核心</li>
<li>新闻、媒体网站，需要快速发布内容</li>
<li>企业官网，强调 SEO 和内容展示</li>
<li>团队已有 Vue 技术栈，迁移成本低</li>
<li>需要使用 Vue 生态的 UI 库（如 Element Plus、Vuetify）</li>
<li>快速原型开发，需要开箱即用的功能</li>
<li>需要 <code>@nuxt/content</code> 的 Markdown 内容管理</li>
<li>项目需要传递复杂的 JavaScript 对象（Map、Set、Date 等）</li>
</ul>
<h3 data-id="heading-30">决策思路</h3>
<p>对于需要优秀 SEO 表现、服务端渲染和良好开发体验的项目，两个框架都完全能够胜任。选择关键在于团队技术栈、第三方生态适配、开发体验等实际因素，而不应该仅仅基于 SEO 考虑。</p>
<p>在中小型项目、团队对两个框架都不熟悉、项目没有特殊渲染需求的情况下，两个框架都是合理选择。可以考虑以下因素决策：</p>
<ul>
<li>团队成员的个人偏好（React vs Vue）</li>
<li>公司的技术战略和长期规划</li>
<li>现有项目的技术栈，保持一致性</li>
<li>招聘市场，React 开发者相对更多</li>
<li>社区资源，React 生态整体更成熟</li>
<li>学习曲线，Vue 的 API 相对更简单</li>
</ul>
<h2 data-id="heading-31">九、核心结论</h2>
<h3 data-id="heading-32">框架差异的真实影响</h3>
<p>几乎所有现代框架都能很好地支持 SEO，差异只在于细微的实现方式。框架选择对 SEO 排名的影响远小于内容质量和技术实现。<code>Payload JSON</code> 化影响 SEO 的说法被夸大了，这是经过深思熟虑的设计权衡。对大多数应用来说，一次传输加快速水合的策略更优。</p>
<p>从搜索引擎角度看，只要页面能正确渲染、内容完整可见、HTML 结构合理、<code>meta</code> 标签正确，框架是什么并不重要。Google 的爬虫既可以处理传统静态 HTML，也可以执行复杂的 JavaScript 应用，还可以理解 SPA 的路由。</p>
<p>真正影响 SEO 的是：内容质量和原创性、页面加载速度（但 100-200ms 差异可以忽略）、移动端友好性、内部链接结构、外部反向链接、域名权威度、用户行为指标（点击率、停留时间、跳出率）、技术 SEO 实践（<code>sitemap</code>、<code>robots.txt</code>、结构化数据）。</p>
<p>框架选择在这些因素中的权重微乎其微。用 <code>Nuxt</code> 还是 <code>Next.js</code>，对实际排名的影响可能不到 1%。</p>
<h3 data-id="heading-33">性能指标的误区</h3>
<p><code>Next.js</code> 在 HTML 体积、TTFB 和 <code>Core Web Vitals</code> 平均值方面具有优势。<code>Nuxt</code> 则在数据类型支持、水合速度和网络传输效率方面表现出色。但这些差异在实际 SEO 排名中影响微乎其微。</p>
<p>常见的性能误区包括：过度关注实验室测试数据，忽略真实用户体验；追求极致分数，忽略边际收益递减；认为性能优化就是 SEO 优化；忽略其他更重要的 SEO 因素；在框架选择上纠结，而不是优化现有代码。</p>
<p>实际上，同一框架下，优化和未优化的网站性能差异可能是 10 倍，而不同框架之间的性能差异可能只有 10-20%。把精力放在代码优化、资源优化、CDN 配置等方面，往往比纠结框架选择更有价值。</p>
<h3 data-id="heading-34">决策因素梳理</h3>
<p>技术因素方面，应该考虑团队技术栈（React vs Vue）、第三方生态适配、开发体验（启动速度、构建速度）。业务因素方面，需要评估项目类型（内容型 vs 应用型）、团队规模和能力、时间和预算。不应该主要基于 SEO 来选择框架，因为两者在 SEO 方面能力基本相当。</p>
<p>决策优先级建议：</p>
<p>第一优先级：团队技术栈和能力。团队熟悉什么就用什么，学习成本和招聘成本很高。</p>
<p>第二优先级：项目类型和需求。内容型倾向 <code>Nuxt</code>，应用型倾向 <code>Next.js</code>，混合型都可以。</p>
<p>第三优先级：生态和工具链。需要的第三方库是否支持，部署平台的支持情况，开发工具的成熟度。</p>
<p>第四优先级：性能和 SEO。只在前三者相同时考虑，实际影响很小。</p>
<h2 data-id="heading-35">十、实践建议</h2>
<h3 data-id="heading-36">SEO 优化核心原则</h3>
<p>内容质量永远是第一位的。框架只是工具，内容才是核心，技术优化是锦上添花而非雪中送炭。正确实现 SSR 比框架选择更重要。</p>
<p>SEO 最佳实践清单：确保所有重要内容在 HTML 中可见、为每个页面设置唯一的 <code>title</code> 和 <code>description</code>、使用语义化 HTML 标签、正确使用标题层级、为图片添加 <code>alt</code> 属性、实现结构化数据、生成 <code>sitemap.xml</code> 并提交、配置合理的 <code>robots.txt</code>、使用 HTTPS、优化页面加载速度、确保移动端友好、构建合理的内部链接结构、定期发布高质量原创内容、获取高质量的外部链接、监控和分析 SEO 数据。</p>
<h3 data-id="heading-37">Nuxt 优化建议</h3>
<p>充分利用框架优势，包括数据类型完整性的便利。对于大数据量场景，使用 <code>Lazy Hydration</code> 功能。不要因为 <code>payload</code> 问题过度担心，实际影响很小。</p>
<p>性能优化技巧：使用 <code>nuxt generate</code> 生成静态页面、配置 <code>routeRules</code> 为不同页面选择合适渲染策略、使用 <code>@nuxt/image</code> 优化图片加载、使用 <code>lazy</code> 属性延迟加载不关键组件、优化 <code>payload</code> 大小避免传递不必要数据、使用 <code>useState</code> 管理 SSR 和 CSR 之间共享的状态、配置合理的缓存策略、监控 <code>payload</code> 大小必要时拆分数据。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Nuxt 性能优化配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtConfig</span>({
  <span class="hljs-attr">experimental</span>: {
    <span class="hljs-attr">payloadExtraction</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">inlineSSRStyles</span>: <span class="hljs-literal">false</span>,
  },
  <span class="hljs-attr">routeRules</span>: {
    <span class="hljs-string">"/"</span>: { <span class="hljs-attr">prerender</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-string">"/blog/**"</span>: { <span class="hljs-attr">swr</span>: <span class="hljs-number">3600</span> },
  },
  <span class="hljs-attr">image</span>: {
    <span class="hljs-attr">domains</span>: [<span class="hljs-string">"cdn.example.com"</span>],
  },
});
</code></pre>
<h3 data-id="heading-38">Next.js 优化建议</h3>
<p>充分利用性能优势，包括 <code>ISR</code> 和部分预渲染，优化 <code>Core Web Vitals</code> 指标。在处理复杂数据类型时，<code>Map</code>、<code>Set</code> 等需要额外处理，要确保序列化和反序列化的正确性。</p>
<p>性能优化技巧：使用 <code>ISR</code> 为动态内容设置合理重新验证时间、尽可能使用 <code>Server Components</code> 减少客户端 JavaScript、使用 <code>next/image</code> 自动优化图片、使用 <code>next/font</code> 优化字体加载、配置 <code>experimental.ppr</code> 启用部分预渲染、使用 <code>Suspense</code> 和 <code>loading.js</code> 改善感知性能、代码分割按需加载、优化第三方脚本加载、使用 <code>@next/bundle-analyzer</code> 分析包大小、配置合理的缓存策略。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Next.js 性能优化配置</span>
<span class="hljs-keyword">const</span> nextConfig = {
  <span class="hljs-attr">experimental</span>: {
    <span class="hljs-attr">ppr</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">optimizeCss</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">optimizePackageImports</span>: [<span class="hljs-string">"lodash"</span>, <span class="hljs-string">"date-fns"</span>],
  },
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">domains</span>: [<span class="hljs-string">"cdn.example.com"</span>],
    <span class="hljs-attr">formats</span>: [<span class="hljs-string">"image/avif"</span>, <span class="hljs-string">"image/webp"</span>],
  },
};
</code></pre>
<h3 data-id="heading-39">框架无关的通用优化</h3>
<p>无论选择哪个框架，以下优化都是必要的：使用 CDN 加速静态资源、启用 Gzip 或 Brotli 压缩、配置合理的缓存策略、优化首屏渲染延迟加载非关键资源、减少 HTTP 请求数量、使用 HTTP/2 或 HTTP/3、优化数据库查询、使用 Redis 等缓存层、监控真实用户性能数据、定期进行性能审计。</p>
<h3 data-id="heading-40">决策流程</h3>
<p>如果主要关心 SEO，两个框架都完全够用，选择团队熟悉的即可，把精力放在内容质量和技术实现上。如果项目需要复杂数据结构，<code>Nuxt</code> 的 <code>devalue</code> 机制会让开发更便捷。如果追求极致性能指标，<code>Next.js</code> 的压缩方案可能略好一点，但差异在实际 SEO 排名中几乎可以忽略。如果被第三方生态绑定，这可能是最重要的决策因素。</p>
<p>决策流程建议：评估团队现有技术栈（如果已有 React/Vue 项目保持一致）、分析项目需求（内容型倾向 <code>Nuxt</code>、应用型倾向 <code>Next.js</code>）、检查第三方依赖（列出必需的库、确认是否有对应生态版本）、考虑部署环境（Vercel 对 <code>Next.js</code> 有特殊优化、Netlify 和 Cloudflare Pages 两者都支持）、评估长期维护成本（框架更新频率和稳定性、社区支持和文档质量）。</p>
<h2 data-id="heading-41">结语</h2>
<p>通过深入分析技术原理和实际应用案例，可以得出一个明确的结论：框架之间的差异是细微的，对 SEO 的影响更是微乎其微。</p>
<p>选择你熟悉的、团队能驾驭的、生态适合的框架，然后专注于创造优质内容和良好的用户体验。这才是 SEO 成功的根本。技术框架只是实现目标的工具，真正决定网站排名和用户满意度的，始终是内容的质量和服务的价值。</p>
<p>理解技术决策的权衡，认清 SEO 的本质，基于实际需求选择，避免过度优化，把精力放在真正重要的地方。这些才是从技术讨论中应该获得的核心启示。</p>
<p>SEO 是一个系统工程，涉及技术、内容、营销等多个方面。框架选择只是技术层面的一个小环节。即使选择了最适合 SEO 的框架，如果内容质量不佳、用户体验糟糕、营销策略失败，网站依然无法获得好的排名。</p>
<p>相反，即使使用了理论上性能稍差的框架，但如果能够持续输出高质量内容、构建良好的用户体验、实施正确的 SEO 策略，网站依然可以获得优秀的搜索排名。这才是 SEO 的真谛。</p>
<p>最后，技术在不断演进。<code>Next.js</code> 和 <code>Nuxt</code> 都在快速迭代，引入新的特性和优化。今天的分析可能在明天就过时了。保持学习、关注技术动态、根据实际情况调整策略，这才是长久之计。</p>
<h2 data-id="heading-42">参考资料</h2>
<ol>
<li>Nuxt SEO 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnuxtseo.com" target="_blank" title="https://nuxtseo.com" ref="nofollow noopener noreferrer">nuxtseo.com</a></li>
<li>Next.js SEO 最佳实践：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Foptimizing%2Fmetadata" target="_blank" title="https://nextjs.org/docs/app/building-your-application/optimizing/metadata" ref="nofollow noopener noreferrer">nextjs.org/docs/app/bu…</a></li>
<li>Devalue 序列化库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRich-Harris%2Fdevalue" target="_blank" title="https://github.com/Rich-Harris/devalue" ref="nofollow noopener noreferrer">github.com/Rich-Harris…</a></li>
<li>Google 搜索中心文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fsearch" target="_blank" title="https://developers.google.com/search" ref="nofollow noopener noreferrer">developers.google.com/search</a></li>
<li>Core Web Vitals 指标说明：<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Fvitals%2F" target="_blank" title="https://web.dev/vitals/" ref="nofollow noopener noreferrer">web.dev/vitals/</a></li>
<li>Schema.org 结构化数据规范：<a href="https://link.juejin.cn?target=https%3A%2F%2Fschema.org%2F" target="_blank" title="https://schema.org/" ref="nofollow noopener noreferrer">schema.org/</a></li>
<li>Nuxt 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnuxt.com%2Fdocs" target="_blank" title="https://nuxt.com/docs" ref="nofollow noopener noreferrer">nuxt.com/docs</a></li>
<li>Next.js 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs" target="_blank" title="https://nextjs.org/docs" ref="nofollow noopener noreferrer">nextjs.org/docs</a></li>
<li>Nitro 服务引擎：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnitro.unjs.io%2F" target="_blank" title="https://nitro.unjs.io/" ref="nofollow noopener noreferrer">nitro.unjs.io/</a></li>
<li>Web.dev 性能优化指南：<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Fperformance%2F" target="_blank" title="https://web.dev/performance/" ref="nofollow noopener noreferrer">web.dev/performance…</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ant Design 6.0 尝鲜：上手现代化组件开发｜得物技术]]></title>    <link>https://juejin.cn/post/7586597780641333258</link>    <guid>https://juejin.cn/post/7586597780641333258</guid>    <pubDate>2025-12-23T06:12:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586597780641333258" data-draft-id="7586575372621889545" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ant Design 6.0 尝鲜：上手现代化组件开发｜得物技术"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T06:12:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ant Design 6.0 尝鲜：上手现代化组件开发｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T06:12:33.000Z" title="Tue Dec 23 2025 06:12:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言</h2>
<h3 data-id="heading-1">组件体验的革新</h3>
<p>在前端开发领域，Ant Design 一直是企业级 React 应用的首选 UI 库之一。随着 Ant Design 6.0 的发布，我们又见证了一次聚焦于组件功能与用户体验的革新。本次更新不仅引入了多个全新组件，更对现有核心组件进行了功能性增强，使开发者能够以更少的代码实现更丰富的交互效果。</p>
<h2 data-id="heading-2">二、Masonry 瀑布流组件：智能动态布局</h2>
<p>传统网格布局在处理高度不一的元素时常出现大量空白区域，Masonry（瀑布流）布局则完美解决了这一问题。Ant Design 6.0 全新推出的 Masonry 组件让实现这种流行布局变得异常简单。</p>
<h3 data-id="heading-3">基础实现与响应式配置</h3>
<pre><code class="hljs language-ini" lang="ini">import { useState, useEffect, useRef } from "react"<span class="hljs-comment">;</span>
import { Masonry, Card, Image, Spin } from "antd"<span class="hljs-comment">;</span>
/**
 * Masonry瀑布流页面
 */
export default () =&gt; {
  const <span class="hljs-section">[isLoading, setIsLoading]</span> = useState(false)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">containerRef</span> = useRef&lt;HTMLDivElement&gt;(null)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">isLoadingRef</span> = useRef(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">imageList</span> = [
    <span class="hljs-string">"https://images.xxx.com/photo-xxx-4b4e3d86bf0f"</span>,
    ...
    <span class="hljs-string">"https://images.xxx.com/photo-xxx-98f7befd1a60"</span>,
  ]<span class="hljs-comment">;</span>
  const <span class="hljs-attr">titles</span> = [
    <span class="hljs-string">"山间日出"</span>,
    ...
    <span class="hljs-string">"自然风光"</span>,
  ]<span class="hljs-comment">;</span>
  const <span class="hljs-attr">descriptions</span> = [
    <span class="hljs-string">"清晨的第一缕阳光"</span>,
    ...
    <span class="hljs-string">"色彩鲜艳的料理"</span>,
  ]<span class="hljs-comment">;</span>
  const <span class="hljs-attr">heights</span> = [<span class="hljs-number">240</span>, <span class="hljs-number">260</span>, <span class="hljs-number">280</span>, <span class="hljs-number">300</span>, <span class="hljs-number">320</span>, <span class="hljs-number">350</span>, <span class="hljs-number">380</span>, <span class="hljs-number">400</span>]<span class="hljs-comment">;</span>
  // Mock数据生成函数
  const <span class="hljs-attr">generateMockData</span> = (startIndex: number, count: number) =&gt; {
    return Array.from({ length: count }, (_, index) =&gt; ({
      id: startIndex + index + 1,
      src: imageList<span class="hljs-section">[Math.floor(Math.random() * imageList.length)]</span>,
      title: titles<span class="hljs-section">[(startIndex + index) % titles.length]</span>,
      description: descriptions<span class="hljs-section">[(startIndex + index) % descriptions.length]</span>,
      height: heights<span class="hljs-section">[Math.floor(Math.random() * heights.length)]</span>,
    }))<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  // 初始数据：20条
  const <span class="hljs-section">[photoItems, setPhotoItems]</span> = useState(() =&gt; generateMockData(0, 20))<span class="hljs-comment">;</span>
  // 滚动监听
  useEffect(() =&gt; {
    <span class="hljs-attr">isLoadingRef.current</span> = isLoading<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[isLoading]</span>)<span class="hljs-comment">;</span>
  useEffect(() =&gt; {
    const <span class="hljs-attr">loadMoreData</span> = async () =&gt; {
      if (isLoadingRef.current) return<span class="hljs-comment">;</span>
      <span class="hljs-attr">isLoadingRef.current</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
      setIsLoading(true)<span class="hljs-comment">;</span>
      // 模拟API请求延迟
      await new Promise((resolve) =&gt; setTimeout(resolve, 500))<span class="hljs-comment">;</span>
      setPhotoItems((prev) =&gt; {
        const <span class="hljs-attr">newItems</span> = generateMockData(prev.length, <span class="hljs-number">10</span>)<span class="hljs-comment">;</span>
        return <span class="hljs-section">[...prev, ...newItems]</span><span class="hljs-comment">;</span>
      })<span class="hljs-comment">;</span>
      <span class="hljs-attr">isLoadingRef.current</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
      setIsLoading(false)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
    const <span class="hljs-attr">checkScroll</span> = () =&gt; {
      if (isLoadingRef.current) return<span class="hljs-comment">;</span>
      const <span class="hljs-attr">container</span> = containerRef.current<span class="hljs-comment">;</span>
      if (!container) return<span class="hljs-comment">;</span>
      const <span class="hljs-attr">scrollTop</span> = container.scrollTop<span class="hljs-comment">;</span>
      const <span class="hljs-attr">scrollHeight</span> = container.scrollHeight<span class="hljs-comment">;</span>
      const <span class="hljs-attr">clientHeight</span> = container.clientHeight<span class="hljs-comment">;</span>
      // 当滚动到距离底部100px时触发加载
      if (scrollTop + clientHeight &gt;= scrollHeight - 100) {
        loadMoreData()<span class="hljs-comment">;</span>
      }
    }<span class="hljs-comment">;</span>
    const <span class="hljs-attr">handleWindowScroll</span> = () =&gt; {
      if (isLoadingRef.current) return<span class="hljs-comment">;</span>
      const <span class="hljs-attr">windowHeight</span> = window.innerHeight<span class="hljs-comment">;</span>
      const <span class="hljs-attr">documentHeight</span> = document.documentElement.scrollHeight<span class="hljs-comment">;</span>
      const <span class="hljs-attr">scrollTop</span> =
        window.pageYOffset || document.documentElement.scrollTop<span class="hljs-comment">;</span>
      // 当滚动到距离底部100px时触发加载
      if (scrollTop + windowHeight &gt;= documentHeight - 100) {
        loadMoreData()<span class="hljs-comment">;</span>
      }
    }<span class="hljs-comment">;</span>
    const <span class="hljs-attr">container</span> = containerRef.current<span class="hljs-comment">;</span>
    // 初始检查一次，以防内容不足一屏
    setTimeout(() =&gt; {
      checkScroll()<span class="hljs-comment">;</span>
      handleWindowScroll()<span class="hljs-comment">;</span>
    }, 100)<span class="hljs-comment">;</span>
    // 监听容器滚动
    if (container) {
      container.addEventListener("scroll", checkScroll)<span class="hljs-comment">;</span>
    }
    // 同时监听 window 滚动（作为备选）
    window.addEventListener("scroll", handleWindowScroll)<span class="hljs-comment">;</span>
    return () =&gt; {
      if (container) {
        container.removeEventListener("scroll", checkScroll)<span class="hljs-comment">;</span>
      }
      window.removeEventListener("scroll", handleWindowScroll)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
  return (
    &lt;div <span class="hljs-attr">ref</span>={containerRef} className=<span class="hljs-string">"w-full h-[100vh] overflow-auto p-[24px]"</span>&gt;
      &lt;Masonry
        // 响应式列数配置
        <span class="hljs-attr">columns</span>={{ xs: <span class="hljs-number">2</span>, sm: <span class="hljs-number">3</span>, md: <span class="hljs-number">4</span>, lg: <span class="hljs-number">5</span> }}
        // 列间距与行间距
        <span class="hljs-attr">gutter</span>={<span class="hljs-number">16</span>}
        <span class="hljs-attr">items</span>={photoItems as any}
        <span class="hljs-attr">itemRender</span>={(item: any) =&gt; (
          &lt;Card
            <span class="hljs-attr">key</span>={item.id}
            hoverable
            <span class="hljs-attr">cover</span>={
              &lt;div <span class="hljs-attr">style</span>={{ height: item.height, overflow: <span class="hljs-string">"hidden"</span> }}&gt;
                &lt;Image
                  <span class="hljs-attr">src</span>={item.src}
                  <span class="hljs-attr">alt</span>={item.title}
                  <span class="hljs-attr">height</span>={item.height}
                  <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span>
                  <span class="hljs-attr">style</span>={{
                    width: "100%",
                    height: "100%",
                    objectFit: "cover",
                  }}
                  <span class="hljs-attr">preview</span>={{
                    visible: false,
                  }}
                /&gt;
              &lt;/div&gt;
            }
            <span class="hljs-attr">styles</span>={{
              body: {
                padding: "12px",
              },
            }}
          &gt;
            &lt;Card.Meta <span class="hljs-attr">title</span>={item.title} description={item.description} /&gt;
            &lt;div
              <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-[8px] text-[12px] text-[#999]"</span>
            &gt;
              图片 <span class="hljs-comment">#{item.id}</span>
            &lt;/div&gt;
          &lt;/Card&gt;
        )}
      /&gt;
      {isLoading &amp;&amp; (
        &lt;div
          <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center justify-center p-[20px] text-[#999]"</span>
        &gt;
          &lt;Spin <span class="hljs-attr">style</span>={{ marginRight: <span class="hljs-string">"8px"</span> }} /&gt;
          &lt;span&gt;加载中...&lt;/span&gt;
        &lt;/div&gt;
      )}
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d581da5c93a448ab95e3e8b2c3f78cf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=tpo0JQHNU%2FEJnSRKUKPMRhbm1Mw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d97d55a2a5d441ea9a2f053b0b3d777e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=wD53K84GGpCpKEWe6qCf27SQqJ8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-4">布局效果说明</h3>
<p>Masonry 组件会根据设定的列数自动将元素排列到高度最小的列中。与传统的网格布局相比，这种布局方式能有效减少内容下方的空白区域，特别适合展示高度不一的内容块。</p>
<p>对于图片展示类应用，这种布局能让用户的视线自然流动，提高浏览的沉浸感和内容发现率。</p>
<h2 data-id="heading-5">三、Tooltip 平滑移动：优雅的交互引导</h2>
<p>在 Ant Design 6.0 中，Tooltip 组件引入了独特的平滑过渡效果，通过 ConfigProvider 全局配置的 tooltip.unique 配置项，当用户在多个带有提示的元素间移动时，提示框会以流畅的动画跟随，而不是突然消失和重现。</p>
<h3 data-id="heading-6">实现平滑跟随效果</h3>
<pre><code class="hljs language-ini" lang="ini">import { Tooltip, Button, Card, ConfigProvider } from "antd"<span class="hljs-comment">;</span>
import {
  UserOutlined,
  SettingOutlined,
  BellOutlined,
  MailOutlined,
  AppstoreOutlined,
} from "@ant-design/icons"<span class="hljs-comment">;</span>
import { TooltipPlacement } from "antd/es/tooltip"<span class="hljs-comment">;</span>
/**
 * Tooltip 示例
 */
export default () =&gt; {
  const <span class="hljs-attr">buttonItems</span> = [
    {
      icon: &lt;UserOutlined /&gt;,
      text: <span class="hljs-string">"个人中心"</span>,
      tip: <span class="hljs-string">"查看和管理您的个人资料"</span>,
      placement: <span class="hljs-string">"top"</span>,
    },
    {
      icon: &lt;SettingOutlined /&gt;,
      text: <span class="hljs-string">"系统设置"</span>,
      tip: <span class="hljs-string">"调整应用程序参数和偏好"</span>,
      placement: <span class="hljs-string">"top"</span>,
    },
    {
      icon: &lt;BellOutlined /&gt;,
      text: <span class="hljs-string">"消息通知"</span>,
      tip: <span class="hljs-string">"查看未读提醒和系统消息"</span>,
      placement: <span class="hljs-string">"top"</span>,
    },
    {
      icon: &lt;MailOutlined /&gt;,
      text: <span class="hljs-string">"邮箱"</span>,
      tip: <span class="hljs-string">"收发邮件和管理联系人"</span>,
      placement: <span class="hljs-string">"bottom"</span>,
    },
    {
      icon: &lt;AppstoreOutlined /&gt;,
      text: <span class="hljs-string">"应用中心"</span>,
      tip: <span class="hljs-string">"探索和安装更多应用"</span>,
      placement: <span class="hljs-string">"bottom"</span>,
    },
  ]<span class="hljs-comment">;</span>
  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-[100vh] overflow-auto p-[24px] space-y-5"</span>&gt;
      &lt;ConfigProvider
        <span class="hljs-attr">tooltip</span>={{
          unique: true,
        }}
      &gt;
        &lt;Card <span class="hljs-attr">title</span>=<span class="hljs-string">"平滑过渡导航工具栏"</span> bordered={<span class="hljs-literal">false</span>}&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex justify-center gap-6 py-10 px-5 bg-gradient-to-br from-[#f5f7fa] to-[#c3cfe2] rounded-3xl"</span>&gt;
            {buttonItems.map((item, index) =&gt; (
              &lt;Tooltip
                <span class="hljs-attr">placement</span>={item.placement as TooltipPlacement}
                <span class="hljs-attr">key</span>={index}
                <span class="hljs-attr">title</span>={
                  &lt;div&gt;
                    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"font-bold mb-1"</span>&gt;{item.text}&lt;/div&gt;
                    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xs text-[#fff]/60"</span>&gt;{item.tip}&lt;/div&gt;
                  &lt;/div&gt;
                }
                <span class="hljs-attr">color</span>=<span class="hljs-string">"#1677ff"</span>
              &gt;
                &lt;Button
                  <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
                  <span class="hljs-attr">shape</span>=<span class="hljs-string">"circle"</span>
                  <span class="hljs-attr">icon</span>={item.icon}
                  <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
                  <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[60px] h-[60px] text-2xl shadow-md transition-all duration-300 ease-in-out"</span>
                /&gt;
              &lt;/Tooltip&gt;
            ))}
          &lt;/div&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-5 p-4 bg-green-50 border border-green-300 rounded-md"</span>&gt;
            &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center"</span>&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-3 h-3 rounded-full bg-green-500 mr-2"</span>&gt;&lt;/div&gt;
              &lt;span&gt;
                提示：尝试将鼠标在不同图标间快速移动，观察 Tooltip
                的平滑过渡效果
              &lt;/span&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/Card&gt;
      &lt;/ConfigProvider&gt;
      &lt;Card <span class="hljs-attr">title</span>=<span class="hljs-string">"非平滑过渡导航工具栏"</span> bordered={<span class="hljs-literal">false</span>}&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex justify-center gap-6 py-10 px-5 bg-gradient-to-br from-[#f5f7fa] to-[#c3cfe2] rounded-3xl"</span>&gt;
          {buttonItems.map((item, index) =&gt; (
            &lt;Tooltip
              <span class="hljs-attr">key</span>={index}
              <span class="hljs-attr">placement</span>={item.placement as TooltipPlacement}
              <span class="hljs-attr">title</span>={
                &lt;div&gt;
                  &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"font-bold mb-1"</span>&gt;{item.text}&lt;/div&gt;
                  &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xs text-[#fff]/60"</span>&gt;{item.tip}&lt;/div&gt;
                &lt;/div&gt;
              }
              <span class="hljs-attr">color</span>=<span class="hljs-string">"#1677ff"</span>
            &gt;
              &lt;Button
                <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
                <span class="hljs-attr">shape</span>=<span class="hljs-string">"circle"</span>
                <span class="hljs-attr">icon</span>={item.icon}
                <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[60px] h-[60px] text-2xl shadow-md transition-all duration-300 ease-in-out"</span>
              /&gt;
            &lt;/Tooltip&gt;
          ))}
        &lt;/div&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-5 p-4 bg-green-50 border border-green-300 rounded-md"</span>&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center"</span>&gt;
            &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-3 h-3 rounded-full bg-green-500 mr-2"</span>&gt;&lt;/div&gt;
            &lt;span&gt;
              提示：尝试将鼠标在不同图标间快速移动，观察 Tooltip 的非平滑过渡效果
            &lt;/span&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/Card&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/336afe64172343ae9f41d2ddecb3bc54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=uHFMUtBtOTOxZ4vla7fmfihMnt4%3D" alt="2.gif" loading="lazy"/></p>
<h3 data-id="heading-7">交互效果说明</h3>
<p>当 tooltip.unique 设置为 true 时，用户在不同元素间移动鼠标时，Tooltip 会呈现以下行为：</p>
<ol>
<li>
<p>平滑位置过渡：Tooltip 不会立即消失，而是平滑移动到新目标位置</p>
</li>
<li>
<p>内容无缝切换：提示内容在新位置淡入，旧内容淡出</p>
</li>
<li>
<p>视觉连续性：保持同一时刻只有一个 Tooltip 显示，避免界面混乱</p>
</li>
</ol>
<p>这种设计特别适合工具栏、导航菜单等元素密集的区域，能有效降低用户的认知负荷，提供更加流畅的交互体验。</p>
<h2 data-id="heading-8">四、InputNumber 拨轮模式：直观的数字输入</h2>
<p>数字输入框是表单中的常见组件，但传统的上下箭头控件在小屏幕或触摸设备上操作不便。Ant Design 6.0 的 InputNumber 组件新增了 mode="spinner" 属性，提供了更直观的“加减按钮”界面。</p>
<h3 data-id="heading-9">拨轮模式实现</h3>
<pre><code class="hljs language-ini" lang="ini">import { InputNumber, Card, Row, Col, Typography, Space } from "antd"<span class="hljs-comment">;</span>
import {
  ShoppingCartOutlined,
  DollarOutlined,
  GiftOutlined,
} from "@ant-design/icons"<span class="hljs-comment">;</span>
const { Title, Text } = Typography<span class="hljs-comment">;</span>
/**
 * InputNumber 示例
 */
export default () =&gt; {
  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-[100vh] overflow-auto p-[24px] space-y-5"</span>&gt;
      &lt;Card <span class="hljs-attr">title</span>=<span class="hljs-string">"商品订购面板"</span> bordered={<span class="hljs-literal">false</span>}&gt;
        &lt;Row <span class="hljs-attr">gutter</span>={[<span class="hljs-number">24</span>, <span class="hljs-number">24</span>]}&gt;
          &lt;Col <span class="hljs-attr">span</span>={<span class="hljs-number">8</span>}&gt;
            &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center"</span>&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[80px] h-[80px] mx-auto mb-4 rounded-3xl bg-[#f0f5ff] flex items-center justify-center text-[32px] text-[#1677ff]"</span>&gt;
                &lt;ShoppingCartOutlined /&gt;
              &lt;/div&gt;
              &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"mb-3"</span>&gt;
                购买数量(非数字拨轮)
              &lt;/Title&gt;
              &lt;InputNumber
                <span class="hljs-attr">min</span>={<span class="hljs-number">1</span>}
                <span class="hljs-attr">max</span>={<span class="hljs-number">50</span>}
                <span class="hljs-attr">defaultValue</span>={<span class="hljs-number">1</span>}
                <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[250px]!"</span>
                <span class="hljs-attr">addonBefore</span>=<span class="hljs-string">"数量"</span>
              /&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-2 text-xs text-gray-600"</span>&gt;限购<span class="hljs-number">50</span>件&lt;/div&gt;
            &lt;/div&gt;
          &lt;/Col&gt;
          &lt;Col <span class="hljs-attr">span</span>={<span class="hljs-number">8</span>}&gt;
            &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center"</span>&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[80px] h-[80px] mx-auto mb-4 rounded-3xl bg-[#fff7e6] flex items-center justify-center text-[32px] text-[#fa8c16]"</span>&gt;
                &lt;DollarOutlined /&gt;
              &lt;/div&gt;
              &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"mb-3"</span>&gt;
                折扣力度(数字拨轮)
              &lt;/Title&gt;
              &lt;InputNumber
                <span class="hljs-attr">min</span>={<span class="hljs-number">0</span>}
                <span class="hljs-attr">max</span>={<span class="hljs-number">100</span>}
                <span class="hljs-attr">defaultValue</span>={<span class="hljs-number">10</span>}
                <span class="hljs-attr">mode</span>=<span class="hljs-string">"spinner"</span>
                <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
                <span class="hljs-attr">formatter</span>={(value) =&gt; `<span class="hljs-variable">${value ?? 0}</span>%`}
                <span class="hljs-attr">parser</span>={(value) =&gt;
                  Number.parseFloat(value?.replace("%", "") ?? "0") as any
                }
                <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[250px]!"</span>
                <span class="hljs-attr">addonBefore</span>=<span class="hljs-string">"折扣"</span>
              /&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-2 text-xs text-gray-600"</span>&gt;<span class="hljs-number">0</span>-<span class="hljs-number">100</span>%范围&lt;/div&gt;
            &lt;/div&gt;
          &lt;/Col&gt;
          &lt;Col <span class="hljs-attr">span</span>={<span class="hljs-number">8</span>}&gt;
            &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"text-center"</span>&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[80px] h-[80px] mx-auto mb-4 rounded-3xl bg-[#f6ffed] flex items-center justify-center text-[32px] text-[#52c41a]"</span>&gt;
                &lt;GiftOutlined /&gt;
              &lt;/div&gt;
              &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"mb-3"</span>&gt;
                礼品数量(数字拨轮，自定义加减按钮)
              &lt;/Title&gt;
              &lt;Space.Compact block <span class="hljs-attr">className</span>=<span class="hljs-string">"justify-center!"</span>&gt;
                &lt;Space.Addon&gt;
                  &lt;span&gt;礼品&lt;/span&gt;
                &lt;/Space.Addon&gt;
                &lt;InputNumber
                  <span class="hljs-attr">min</span>={<span class="hljs-number">0</span>}
                  <span class="hljs-attr">max</span>={<span class="hljs-number">10</span>}
                  <span class="hljs-attr">defaultValue</span>={<span class="hljs-number">0</span>}
                  <span class="hljs-attr">mode</span>=<span class="hljs-string">"spinner"</span>
                  <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
                  <span class="hljs-attr">className</span>=<span class="hljs-string">"w-[250px]!"</span>
                  <span class="hljs-attr">controls</span>={{
                    upIcon: &lt;span <span class="hljs-attr">className</span>=<span class="hljs-string">"text-base"</span>&gt;➕&lt;/span&gt;,
                    downIcon: &lt;span <span class="hljs-attr">className</span>=<span class="hljs-string">"text-base"</span>&gt;➖&lt;/span&gt;,
                  }}
                /&gt;
              &lt;/Space.Compact&gt;
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-2 text-xs text-gray-600"</span>&gt;每单最多<span class="hljs-number">10</span>份&lt;/div&gt;
            &lt;/div&gt;
          &lt;/Col&gt;
        &lt;/Row&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-8 p-4 bg-[#fff0f6] rounded-lg border border-dashed border-[#ffadd2]"</span>&gt;
          &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span>&gt;
            &lt;strong&gt;设计提示：&lt;/strong&gt;
            拨轮模式相比传统箭头控件，提供了更大的点击区域和更明确的视觉反馈，特别适合触摸设备和需要频繁调整数值的场景。加减按钮的分离式设计也降低了误操作的可能性。
          &lt;/Text&gt;
        &lt;/div&gt;
      &lt;/Card&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cace26657dd49f6a68e163e3646dfff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=0aH4JXQ%2BbFgSto4h%2BRafl4lOJpo%3D" alt="3.gif" loading="lazy"/></p>
<h3 data-id="heading-10">交互优势分析</h3>
<p>拨轮模式相比传统数字输入框具有明显优势：</p>
<ol>
<li>
<p>触摸友好：更大的按钮区域适合移动端操作</p>
</li>
<li>
<p>意图明确：“+”和“-”符号比小箭头更直观</p>
</li>
<li>
<p>快速调整：支持长按连续增减数值</p>
</li>
<li>
<p>视觉反馈：按钮有明确的状态变化（按下、悬停）</p>
</li>
</ol>
<p>在电商、数据仪表盘、配置面板等需要频繁调整数值的场景中，这种设计能显著提升用户的操作效率和满意度。</p>
<h2 data-id="heading-11">五、Drawer 拖拽调整：灵活的侧边面板</h2>
<p>抽屉组件常用于移动端导航或详情面板，但固定尺寸有时无法满足多样化的内容展示需求。Ant Design 6.0 为 Drawer 组件新增了 resizable 属性，允许用户通过拖拽边缘实时调整面板尺寸。</p>
<h3 data-id="heading-12">可调整抽屉实现</h3>
<pre><code class="hljs language-ini" lang="ini">import { Drawer, Button, Card, Typography, Divider, List, Flex } from "antd"<span class="hljs-comment">;</span>
import {
  DragOutlined,
  CalendarOutlined,
  FileTextOutlined,
  TeamOutlined,
  CommentOutlined,
  PaperClipOutlined,
} from "@ant-design/icons"<span class="hljs-comment">;</span>
import { useState } from "react"<span class="hljs-comment">;</span>
import { DrawerResizableConfig } from "antd/es/drawer"<span class="hljs-comment">;</span>
const { Title, Text, Paragraph } = Typography<span class="hljs-comment">;</span>
/**
 * Drawer 示例
 */
export default () =&gt; {
  const <span class="hljs-section">[open, setOpen]</span> = useState(false)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[drawerWidth, setDrawerWidth]</span> = useState(400)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[resizable, setResizable]</span> = useState&lt;boolean | DrawerResizableConfig&gt;(
    false,
  )<span class="hljs-comment">;</span>
  const <span class="hljs-attr">tasks</span> = [
    { id: <span class="hljs-number">1</span>, title: <span class="hljs-string">"完成项目需求文档"</span>, time: <span class="hljs-string">"今天 10:00"</span>, priority: <span class="hljs-string">"high"</span> },
    { id: <span class="hljs-number">2</span>, title: <span class="hljs-string">"团队周会"</span>, time: <span class="hljs-string">"今天 14:30"</span>, priority: <span class="hljs-string">"medium"</span> },
    { id: <span class="hljs-number">3</span>, title: <span class="hljs-string">"代码审查"</span>, time: <span class="hljs-string">"明天 09:00"</span>, priority: <span class="hljs-string">"high"</span> },
    { id: <span class="hljs-number">4</span>, title: <span class="hljs-string">"客户演示准备"</span>, time: <span class="hljs-string">"后天 15:00"</span>, priority: <span class="hljs-string">"medium"</span> },
  ]<span class="hljs-comment">;</span>
  const <span class="hljs-attr">showDrawerWithResizable</span> = () =&gt; {
    setOpen(true)<span class="hljs-comment">;</span>
    setDrawerWidth(400)<span class="hljs-comment">;</span>
    setResizable({
      onResize: (size) =&gt; {
        setDrawerWidth(size)<span class="hljs-comment">;</span>
      },
    })<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  const <span class="hljs-attr">showDrawerWithoutResizable</span> = () =&gt; {
    setOpen(true)<span class="hljs-comment">;</span>
    setDrawerWidth(600)<span class="hljs-comment">;</span>
    setResizable(false)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  const <span class="hljs-attr">onClose</span> = () =&gt; {
    setOpen(false)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-[100vh] flex items-center justify-center overflow-auto p-[24px] space-y-5"</span>&gt;
      &lt;Card
        <span class="hljs-attr">title</span>=<span class="hljs-string">"任务管理面板"</span>
        <span class="hljs-attr">variant</span>=<span class="hljs-string">"outlined"</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"max-w-[800px] mx-auto"</span>
      &gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"py-10 px-5 text-center"</span>&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-20 h-20 mx-auto mb-6 rounded-full bg-[#1677ff] flex items-center justify-center text-[36px] text-white"</span>&gt;
            &lt;DragOutlined /&gt;
          &lt;/div&gt;
          &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">3</span>}&gt;可调整的任务详情面板&lt;/Title&gt;
          &lt;Paragraph <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span> className=<span class="hljs-string">"max-w-[600px] my-4 mx-auto"</span>&gt;
            点击下方按钮打开一个可拖拽调整宽度的抽屉面板。尝试拖动抽屉左侧边缘，根据内容需要调整面板尺寸。
          &lt;/Paragraph&gt;
          &lt;Flex <span class="hljs-attr">justify</span>=<span class="hljs-string">"center"</span> gap={<span class="hljs-number">10</span>}&gt;
            &lt;Button
              <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
              <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
              <span class="hljs-attr">onClick</span>={showDrawerWithResizable}
              <span class="hljs-attr">icon</span>={&lt;CalendarOutlined /&gt;}
              <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-6"</span>
            &gt;
              打开任务抽屉(可拖拽宽度)
            &lt;/Button&gt;
            &lt;Button
              <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
              <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
              <span class="hljs-attr">onClick</span>={showDrawerWithoutResizable}
              <span class="hljs-attr">icon</span>={&lt;CalendarOutlined /&gt;}
              <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-6"</span>
            &gt;
              打开任务抽屉(不可拖拽宽度)
            &lt;/Button&gt;
          &lt;/Flex&gt;
        &lt;/div&gt;
      &lt;/Card&gt;
      &lt;Drawer
        <span class="hljs-attr">title</span>={
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center"</span>&gt;
            &lt;CalendarOutlined <span class="hljs-attr">className</span>=<span class="hljs-string">"mr-2 text-[#1677ff]"</span> /&gt;
            &lt;span&gt;任务详情与计划&lt;/span&gt;
            {resizable &amp;&amp; (
              &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"ml-3 py-0.5 px-2 bg-[#f0f5ff] rounded-[10px] text-xs text-[#1677ff]"</span>&gt;
                可拖拽调整宽度
              &lt;/div&gt;
            )}
          &lt;/div&gt;
        }
        <span class="hljs-attr">placement</span>=<span class="hljs-string">"right"</span>
        <span class="hljs-attr">onClose</span>={<span class="hljs-literal">on</span>Close}
        <span class="hljs-attr">open</span>={open}
        <span class="hljs-attr">size</span>={drawerWidth}
        <span class="hljs-attr">resizable</span>={resizable}
        <span class="hljs-attr">extra</span>={
          &lt;Button <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> icon={&lt;DragOutlined /&gt;}&gt;
            {resizable ? "拖拽边缘调整" : "不可拖拽"}
          &lt;/Button&gt;
        }
        <span class="hljs-attr">styles</span>={{
          body: {
            paddingTop: "12px",
          },
          header: {
            borderBottom: "1px solid <span class="hljs-comment">#f0f0f0",</span>
          },
        }}
      &gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mb-6"</span>&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center mb-4"</span>&gt;
            &lt;FileTextOutlined <span class="hljs-attr">className</span>=<span class="hljs-string">"mr-2 text-[#52c41a]"</span> /&gt;
            &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"m-0"</span>&gt;
              当前任务
            &lt;/Title&gt;
          &lt;/div&gt;
          &lt;Card <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span>&gt;
            &lt;List
              <span class="hljs-attr">itemLayout</span>=<span class="hljs-string">"horizontal"</span>
              <span class="hljs-attr">dataSource</span>={tasks}
              <span class="hljs-attr">renderItem</span>={(item) =&gt; (
                &lt;List.Item&gt;
                  &lt;List.Item.Meta
                    <span class="hljs-attr">avatar</span>={
                      &lt;div
                        <span class="hljs-attr">className</span>={`w-<span class="hljs-number">8</span> h-<span class="hljs-number">8</span> rounded-md flex items-center justify-center ${
                          <span class="hljs-attr">item.priority</span> === <span class="hljs-string">"high"</span>
                            ? "bg-<span class="hljs-section">[#fff2f0]</span> text-<span class="hljs-section">[#ff4d4f]</span>"
                            : "bg-<span class="hljs-section">[#f6ffed]</span> text-<span class="hljs-section">[#52c41a]</span>"
                        }`}
                      &gt;
                        {<span class="hljs-attr">item.priority</span> === <span class="hljs-string">"high"</span> ? <span class="hljs-string">"急"</span> : <span class="hljs-string">"常"</span>}
                      &lt;/div&gt;
                    }
                    <span class="hljs-attr">title</span>={&lt;a&gt;{item.title}&lt;/a&gt;}
                    <span class="hljs-attr">description</span>={&lt;Text type=<span class="hljs-string">"secondary"</span>&gt;{item.time}&lt;/Text&gt;}
                  /&gt;
                &lt;/List.Item&gt;
              )}
            /&gt;
          &lt;/Card&gt;
        &lt;/div&gt;
        &lt;Divider /&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mb-6"</span>&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center mb-4"</span>&gt;
            &lt;TeamOutlined <span class="hljs-attr">className</span>=<span class="hljs-string">"mr-2 text-[#fa8c16]"</span> /&gt;
            &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"m-0"</span>&gt;
              团队动态
            &lt;/Title&gt;
          &lt;/div&gt;
          &lt;Paragraph&gt;
            本周团队主要聚焦于项目第三阶段的开发工作，前端组已完成了核心组件的重构，后端组正在进行性能优化。
          &lt;/Paragraph&gt;
        &lt;/div&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mb-6"</span>&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center mb-4"</span>&gt;
            &lt;CommentOutlined <span class="hljs-attr">className</span>=<span class="hljs-string">"mr-2 text-[#722ed1]"</span> /&gt;
            &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"m-0"</span>&gt;
              最新反馈
            &lt;/Title&gt;
          &lt;/div&gt;
          &lt;Card <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> type=<span class="hljs-string">"inner"</span>&gt;
            &lt;Paragraph&gt;
              "新的界面设计得到了客户的积极反馈，特别是可调整的面板设计，让不同角色的用户都能获得适合自己工作习惯的布局。"
            &lt;/Paragraph&gt;
            &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span>&gt;—— 产品经理，XXX&lt;/Text&gt;
          &lt;/Card&gt;
        &lt;/div&gt;
        &lt;div&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center mb-4"</span>&gt;
            &lt;PaperClipOutlined <span class="hljs-attr">className</span>=<span class="hljs-string">"mr-2 text-[#eb2f96]"</span> /&gt;
            &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"m-0"</span>&gt;
              使用提示
            &lt;/Title&gt;
          &lt;/div&gt;
          &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"p-3 bg-[#f6ffed] rounded-md border border-[#b7eb8f]"</span>&gt;
            &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span>&gt;
              当前抽屉宽度: &lt;strong&gt;{drawerWidth}px&lt;/strong&gt;。您可以: 1.
              拖动左侧边缘调整宽度 2. 内容区域会根据宽度自动重新布局 3.
              适合查看不同密度的信息
            &lt;/Text&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/Drawer&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cd6e7f951e54719836ab31c8b2ab0d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=9jiPV%2B5WuHFi2siIzw7jiM77ZxE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9831a86a1384197ab19fa5f99c381af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=MmFSjb0lkVvkgfo9w26NGHuAP5A%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-13">拖拽交互的价值</h3>
<p>可调整抽屉的设计带来了明显的用户体验提升：</p>
<ol>
<li>
<p>自适应内容：用户可以根据当前查看的内容类型调整面板尺寸</p>
</li>
<li>
<p>个性化布局：不同用户或场景下可以设置不同的面板大小</p>
</li>
<li>
<p>多任务处理：宽面板适合详情查看，窄面板适合边操作边参考</p>
</li>
<li>
<p>渐进式披露：可以从紧凑视图逐步展开到详细视图</p>
</li>
</ol>
<h2 data-id="heading-14">六、Modal 背景模糊：朦胧美学的视觉升级</h2>
<p>在传统 Web 应用中，模态框的遮罩层往往是简单的半透明黑色，视觉效果单调且缺乏现代感。而在 iOS 和 macOS 等系统中，毛玻璃（frosted glass）效果已成为标志性的设计语言效果样式。Ant Design 6.0 为所有弹层组件引入了原生背景模糊支持，并提供了强大的语义化样式定制能力，让开发者能轻松打造出高级感十足的视觉效果。</p>
<h3 data-id="heading-15">背景模糊与语义化样式定制</h3>
<p>以下示例展示了如何结合 Ant Design 6.0 的背景模糊特性和 antd-style 库，实现两种不同风格的模态框：</p>
<pre><code class="hljs language-ini" lang="ini">import { useState } from "react"<span class="hljs-comment">;</span>
import { Button, Flex, Modal, Card, Image, Typography, Space } from "antd"<span class="hljs-comment">;</span>
import type { ModalProps } from "antd"<span class="hljs-comment">;</span>
import { createStyles } from "antd-style"<span class="hljs-comment">;</span>
const { Title, Text } = Typography<span class="hljs-comment">;</span>
// 使用 antd-style 的 createStyles 定义样式
const <span class="hljs-attr">useStyles</span> = createStyles(({ token }) =&gt; ({
  // 用于模态框容器的基础样式
  container: {
    borderRadius: token.borderRadiusLG * 1.5,
    overflow: "hidden",
  },
}))<span class="hljs-comment">;</span>
// 示例用的共享内容
const <span class="hljs-attr">sharedContent</span> = (
  &lt;Card <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> bordered={<span class="hljs-literal">false</span>}&gt;
    &lt;Image
      <span class="hljs-attr">height</span>={<span class="hljs-number">300</span>}
      <span class="hljs-attr">src</span>=<span class="hljs-string">"https://gw.alipayobjects.com/zos/antfincdn/LlvErxo8H9/photo-1503185912284-5271ff81b9a8.webp"</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"示例图片"</span>
      <span class="hljs-attr">preview</span>={<span class="hljs-literal">false</span>}
      <span class="hljs-attr">className</span>=<span class="hljs-string">"mx-auto!"</span>
    /&gt;
    &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span> style={{ display: <span class="hljs-string">"block"</span>, marginTop: <span class="hljs-number">8</span> }}&gt;
      Ant Design 6.0 默认的模糊背景与 antd-style
      定制的毛玻璃面板相结合，营造出深邃而富有层次的视觉体验。
    &lt;/Text&gt;
  &lt;/Card&gt;
)<span class="hljs-comment">;</span>
export default () =&gt; {
  const <span class="hljs-section">[blurModalOpen, setBlurModalOpen]</span> = useState(false)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[gradientModalOpen, setGradientModalOpen]</span> = useState(false)<span class="hljs-comment">;</span>
  const { styles: classNames } = useStyles()<span class="hljs-comment">;</span>
  // 场景1：背景玻璃模糊效果（朦胧美学）
  const blurModalStyles: ModalProps<span class="hljs-section">["styles"]</span> = {
    body: {
      padding: 24,
    },
  }<span class="hljs-comment">;</span>
  // 场景2：渐变色背景模态框（无模糊效果）
  const gradientModalStyles: ModalProps<span class="hljs-section">["styles"]</span> = {
    mask: {
      backgroundImage: `linear-gradient(
        135deg, 
        rgba(99, 102, 241, 0.8) 0%, 
        rgba(168, 85, 247, 0.6) 50%, 
        rgba(236, 72, 153, 0.8) 100%
      )`,
    },
    body: {
      padding: 24,
    },
    header: {
      background: "linear-gradient(to right, <span class="hljs-comment">#6366f1, #a855f7)",</span>
      color: "<span class="hljs-comment">#fff",</span>
      borderBottom: "none",
    },
    footer: {
      borderTop: "1px solid <span class="hljs-comment">#e5e7eb",</span>
      textAlign: "center",
    },
  }<span class="hljs-comment">;</span>
  // 共享配置
  const sharedProps: <span class="hljs-attr">ModalProps</span> = {
    centered: true,
    classNames,
  }<span class="hljs-comment">;</span>
  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-[100vh] overflow-auto p-[24px] space-y-5"</span>&gt;
      &lt;Card
        <span class="hljs-attr">title</span>=<span class="hljs-string">"Ant Design 6 模态框样式示例"</span>
        <span class="hljs-attr">bordered</span>={<span class="hljs-literal">false</span>}
        <span class="hljs-attr">extra</span>={
          &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span> className=<span class="hljs-string">"text-sm"</span>&gt;
            朦胧美学 + 渐变背景，高级感拉满！
          &lt;/Text&gt;
        }
      &gt;
        &lt;Flex
          <span class="hljs-attr">gap</span>=<span class="hljs-string">"middle"</span>
          <span class="hljs-attr">align</span>=<span class="hljs-string">"center"</span>
          <span class="hljs-attr">justify</span>=<span class="hljs-string">"center"</span>
          <span class="hljs-attr">style</span>={{ padding: <span class="hljs-number">40</span>, minHeight: <span class="hljs-number">300</span> }}
        &gt;
          &lt;Button
            <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
            <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
            <span class="hljs-attr">onClick</span>={() =&gt; setBlurModalOpen(<span class="hljs-literal">true</span>)}
          &gt;
            🌫️ 背景玻璃模糊效果
          &lt;/Button&gt;
          &lt;Button <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span> <span class="hljs-literal">on</span>Click={() =&gt; setGradientModalOpen(<span class="hljs-literal">true</span>)}&gt;
            🎨 渐变色背景模态框
          &lt;/Button&gt;
          {/* 模态框 1：背景玻璃模糊效果（朦胧美学） */}
          &lt;Modal
            {...sharedProps}
            <span class="hljs-attr">title</span>=<span class="hljs-string">"背景玻璃模糊效果"</span>
            <span class="hljs-attr">styles</span>={blurModalStyles}
            <span class="hljs-attr">open</span>={blurModalOpen}
            <span class="hljs-attr">onOk</span>={() =&gt; setBlurModalOpen(<span class="hljs-literal">false</span>)}
            <span class="hljs-attr">onCancel</span>={() =&gt; setBlurModalOpen(<span class="hljs-literal">false</span>)}
            <span class="hljs-attr">okText</span>=<span class="hljs-string">"太美了"</span>
            <span class="hljs-attr">cancelText</span>=<span class="hljs-string">"关闭"</span>
            <span class="hljs-attr">mask</span>={{ enabled: <span class="hljs-literal">true</span>, blur: <span class="hljs-literal">true</span> }}
            <span class="hljs-attr">width</span>={<span class="hljs-number">600</span>}
          &gt;
            {sharedContent}
            &lt;div
              <span class="hljs-attr">style</span>={{
                marginTop: 16,
                padding: 16,
                background: "rgba(255, 255, 255, 0.6)",
                borderRadius: 8,
                backdropFilter: "blur(10px)",
              }}
            &gt;
              &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span>&gt;
                &lt;strong&gt;💡 设计亮点：&lt;/strong&gt;
                启用了 <span class="hljs-attr">mask</span>=&amp;<span class="hljs-comment">#123;&amp;#123; blur: true &amp;#125;&amp;#125;，</span>
                背景会自动应用模糊效果，营造出朦胧美学的高级质感。
              &lt;/Text&gt;
            &lt;/div&gt;
          &lt;/Modal&gt;
          {/* 模态框 2：渐变色背景（无模糊效果） */}
          &lt;Modal
            {...sharedProps}
            <span class="hljs-attr">title</span>=<span class="hljs-string">"渐变色背景模态框"</span>
            <span class="hljs-attr">styles</span>={gradientModalStyles}
            <span class="hljs-attr">open</span>={gradientModalOpen}
            <span class="hljs-attr">onOk</span>={() =&gt; setGradientModalOpen(<span class="hljs-literal">false</span>)}
            <span class="hljs-attr">onCancel</span>={() =&gt; setGradientModalOpen(<span class="hljs-literal">false</span>)}
            <span class="hljs-attr">okText</span>=<span class="hljs-string">"好看"</span>
            <span class="hljs-attr">cancelText</span>=<span class="hljs-string">"关闭"</span>
            <span class="hljs-attr">mask</span>={{ enabled: <span class="hljs-literal">true</span>, blur: <span class="hljs-literal">false</span> }}
            <span class="hljs-attr">width</span>={<span class="hljs-number">600</span>}
          &gt;
            {sharedContent}
            &lt;div
              <span class="hljs-attr">style</span>={{
                marginTop: 16,
                padding: 16,
                background: "linear-gradient(135deg, <span class="hljs-comment">#fef3c7 0%, #fce7f3 100%)",</span>
                borderRadius: 8,
                border: "1px solid rgba(168, 85, 247, 0.2)",
              }}
            &gt;
              &lt;Text <span class="hljs-attr">type</span>=<span class="hljs-string">"secondary"</span>&gt;
                &lt;strong&gt;🎨 设计亮点：&lt;/strong&gt;
                通过 styles.mask 设置渐变背景色，同时 styles.header
                应用了渐变头部，打造独特的视觉体验。
              &lt;/Text&gt;
            &lt;/div&gt;
          &lt;/Modal&gt;
        &lt;/Flex&gt;
        &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"mt-6 p-5 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-purple-200"</span>&gt;
          &lt;Title <span class="hljs-attr">level</span>={<span class="hljs-number">5</span>} className=<span class="hljs-string">"mb-3"</span>&gt;
            📚 技术要点
          &lt;/Title&gt;
          &lt;Space <span class="hljs-attr">direction</span>=<span class="hljs-string">"vertical"</span> size=<span class="hljs-string">"small"</span> className=<span class="hljs-string">"w-full"</span>&gt;
            &lt;Text&gt;
              • &lt;strong&gt;玻璃模糊：&lt;/strong&gt;使用 <span class="hljs-attr">mask</span>=&amp;<span class="hljs-comment">#123;&amp;#123; blur: true &amp;#125;&amp;#125; 启用原生模糊效果</span>
            &lt;/Text&gt;
            &lt;Text&gt;
              • &lt;strong&gt;渐变背景：&lt;/strong&gt;通过 styles.mask.backgroundImage 设置渐变色
            &lt;/Text&gt;
            &lt;Text&gt;
              • &lt;strong&gt;语义化定制：&lt;/strong&gt;使用 styles.header/body/footer 精准控制各部分样式
            &lt;/Text&gt;
            &lt;Text&gt;
              • &lt;strong&gt;antd-style 集成：&lt;/strong&gt;使用 createStyles 定义可复用的样式类名
            &lt;/Text&gt;
          &lt;/Space&gt;
        &lt;/div&gt;
      &lt;/Card&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b1642877d6540d8a4d34a460a4ca213~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=9tqQeBpAb2EX0l8rDWQG%2FtsOHXo%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8d6618c5c7c4b609ea568e2d36016ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=nAYA42CH53TgtTMsYAmzIAqMDbc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-16">核心特性解析</h3>
<p><strong>1. 背景模糊开关</strong></p>
<p>通过 mask 属性的 blur 配置项，可以一键开启/关闭背景模糊效果：</p>
<ul>
<li>mask={{ enabled: true, blur: true }}：启用毛玻璃效果</li>
<li>mask={{ enabled: true, blur: false }}：使用传统半透明遮罩</li>
</ul>
<p><strong>2. 语义化样式定制</strong></p>
<p>styles 属性允许精准控制组件各个部分的样式，无需编写复杂的 CSS 选择器：</p>
<ul>
<li>styles.mask：遮罩层样式（可设置渐变背景）</li>
<li>styles.header：头部样式（可定制颜色、边框）</li>
<li>styles.body：内容区样式（可调整间距）</li>
<li>styles.footer：底部样式（可设置对齐方式）</li>
</ul>
<p><strong>3. antd-style 集成</strong></p>
<p>结合 antd-style 可以创建主题感知的样式：</p>
<ul>
<li>访问 Design Token（如 token.borderRadiusLG）</li>
<li>样式自动响应主题切换（亮色/暗色模式）</li>
<li>通过 classNames 属性应用 CSS 类名</li>
</ul>
<h3 data-id="heading-17">视觉效果对比</h3>
<p>使用背景模糊和语义化样式定制后，Modal 的视觉呈现发生了显著变化：</p>
<p><strong>1. 背景模糊效果：</strong> 遮罩层从单调的半透明黑色变为毛玻璃效果，背景内容呈现柔和的模糊感</p>
<p><strong>2. 精准样式控制：</strong> 通过 <code>styles.mask/header/body/footer</code> 可以像搭积木一样组装出品牌化的对话框</p>
<p><strong>3. 主题联动：</strong> 结合 <code>antd-style</code> 后，样式会自动响应全局主题切换，无需手动维护暗色模式样式</p>
<p><strong>4. 维护性提升：</strong> 告别 <code>.ant-modal .ant-modal-content .ant-modal-header</code> 这样的深层选择器，样式意图清晰明确</p>
<p>这种设计让 Ant Design 6.0 的组件定制从"CSS 覆盖战争"升级为"API 声明式配置"，显著降低了样式维护成本，同时保持了高度的灵活性。</p>
<h2 data-id="heading-18">七、Card 赛博朋克风格：霓虹科技美学的呈现</h2>
<p>在传统的企业级应用中，卡片组件往往采用简洁素雅的设计。但对于游戏、科技、创意类产品，开发者往往需要更具视觉冲击力的效果。Ant Design 6.0 的 Card 组件配合 antd-style，可以轻松实现赛博朋克风格的霓虹发光边框、深色内阴影和动态动画效果，让你的界面充满未来感和科技感。</p>
<h3 data-id="heading-19">赛博朋克卡片实现</h3>
<p>以下示例展示了如何使用 antd-style 的 CSS-in-JS 能力，为 Card 组件打造完整的赛博朋克视觉风格：</p>
<pre><code class="hljs language-css" lang="css">import { Card, Typography, <span class="hljs-selector-tag">Button</span>, Space, Avatar, Row, Col } <span class="hljs-selector-tag">from</span> "antd";
import { createStyles } <span class="hljs-selector-tag">from</span> "antd-style";
import {
  ThunderboltOutlined,
  RocketOutlined,
  FireOutlined,
  StarOutlined,
  TrophyOutlined,
} <span class="hljs-selector-tag">from</span> "<span class="hljs-keyword">@ant-design</span>/icons";
const { Title, Text, Paragraph } = Typography;
// 使用 antd-style 创建赛博朋克风格样式
const useStyles = createStyles(({ css }) =&gt; ({
  // 赛博朋克卡片 - 紫色霓虹
  cyberpunkCard: css`
    background: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">15</span>, <span class="hljs-number">15</span>, <span class="hljs-number">35</span>, <span class="hljs-number">0.9</span>);
    <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#a855f7</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">position</span>: relative;
    <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
    <span class="hljs-comment">/* 发光边框效果 */</span>
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">168</span>, <span class="hljs-number">85</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.5</span>),
      inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">168</span>, <span class="hljs-number">85</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.1</span>);
    &amp;<span class="hljs-selector-pseudo">:hover</span> {
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">5px</span>);
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">30px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">168</span>, <span class="hljs-number">85</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.8</span>),
        inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">30px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">168</span>, <span class="hljs-number">85</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.2</span>);
      <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#c084fc</span>;
    }
    <span class="hljs-comment">/* 顶部霓虹灯条 */</span>
    &amp;<span class="hljs-selector-pseudo">::before</span> {
      <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">3px</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(
        <span class="hljs-number">90deg</span>,
        transparent,
        <span class="hljs-number">#a855f7</span>,
        <span class="hljs-number">#c084fc</span>,
        <span class="hljs-number">#a855f7</span>,
        transparent
      );
      <span class="hljs-attribute">animation</span>: neonFlow <span class="hljs-number">3s</span> ease-in-out infinite;
    }
    <span class="hljs-keyword">@keyframes</span> neonFlow {
      <span class="hljs-number">0%</span>, <span class="hljs-number">100%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
      <span class="hljs-number">50%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>; }
    }
  `,
  // 霓虹文字
  neonText: css`
    color: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">text-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">10px</span> currentColor,
                 <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> currentColor,
                 <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">30px</span> currentColor;
    <span class="hljs-attribute">font-weight</span>: bold;
  `,
  // 霓虹按钮
  neonButton: css`
    background: transparent <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> solid currentColor <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">color</span>: inherit <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">text-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">10px</span> currentColor;
    <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">10px</span> currentColor,
                inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.1</span>);
    <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease <span class="hljs-meta">!important</span>;
    &amp;<span class="hljs-selector-pseudo">:hover</span> {
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.05</span>);
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> currentColor,
                  inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.2</span>) <span class="hljs-meta">!important</span>;
    }
  `,
  // 数据面板
  dataPanel: css`
    background: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>);
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.1</span>);
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
    backdrop-<span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">10px</span>);
  `,
}));
export default () =&gt; {
  const { styles } = useStyles();
  return (
    &lt;Row gutter={<span class="hljs-selector-attr">[24, 24]</span>}&gt;
      &lt;Col <span class="hljs-selector-tag">span</span>={<span class="hljs-number">8</span>}&gt;
        &lt;Card
          className={styles<span class="hljs-selector-class">.cyberpunkCard</span>}
          hoverable
          styles={{ <span class="hljs-selector-tag">body</span>: { <span class="hljs-attribute">padding</span>: <span class="hljs-number">24</span> } }}
        &gt;
          &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">position</span>: <span class="hljs-string">"relative"</span>, zIndex: <span class="hljs-number">1</span> }}&gt;
            {<span class="hljs-comment">/* 头部 */</span>}
            &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">"flex"</span>, alignItems: <span class="hljs-string">"center"</span>, marginBottom: <span class="hljs-number">16</span> }}&gt;
              &lt;Avatar
                size={<span class="hljs-number">64</span>}
                <span class="hljs-attribute">icon</span>={&lt;ThunderboltOutlined /&gt;}
                style={{
                  <span class="hljs-attribute">background</span>: <span class="hljs-string">"linear-gradient(135deg, #a855f7, transparent)"</span>,
                  border: <span class="hljs-string">"2px solid #a855f7"</span>,
                  color: <span class="hljs-string">"#a855f7"</span>,
                  filter: <span class="hljs-string">"drop-shadow(0 0 10px #a855f7)"</span>,
                }}
              /&gt;
            &lt;/<span class="hljs-selector-tag">div</span>&gt;
            {<span class="hljs-comment">/* 标题 */</span>}
            &lt;Title level={<span class="hljs-number">4</span>} className={styles<span class="hljs-selector-class">.neonText</span>} style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#a855f7"</span> }}&gt;
              QUANTUM PROCESSOR
            &lt;/Title&gt;
            &lt;Text style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#888"</span>, display: <span class="hljs-string">"block"</span>, marginBottom: <span class="hljs-number">16</span> }}&gt;
              量子处理器
            &lt;/Text&gt;
            {<span class="hljs-comment">/* 描述 */</span>}
            &lt;Paragraph style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#bbb"</span>, marginBottom: <span class="hljs-number">20</span> }}&gt;
              第九代量子处理器，采用纳米级光刻技术，配备AI神经网络加速引擎。
            &lt;/Paragraph&gt;
            {<span class="hljs-comment">/* 数据面板 */</span>}
            &lt;<span class="hljs-selector-tag">div</span> className={styles<span class="hljs-selector-class">.dataPanel</span>} style={{ marginBottom: <span class="hljs-number">20</span> }}&gt;
              &lt;Space <span class="hljs-attribute">direction</span>="vertical" style={{ <span class="hljs-attribute">width</span>: <span class="hljs-string">"100%"</span> }} size={<span class="hljs-number">12</span>}&gt;
                &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">"flex"</span>, justifyContent: <span class="hljs-string">"space-between"</span> }}&gt;
                  &lt;Text style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#888"</span> }}&gt;处理速度&lt;/Text&gt;
                  &lt;Text <span class="hljs-selector-tag">strong</span> style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#a855f7"</span> }}&gt;<span class="hljs-number">5.2</span> PHz&lt;/Text&gt;
                &lt;/<span class="hljs-selector-tag">div</span>&gt;
                &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">"flex"</span>, justifyContent: <span class="hljs-string">"space-between"</span> }}&gt;
                  &lt;Text style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#888"</span> }}&gt;核心数量&lt;/Text&gt;
                  &lt;Text <span class="hljs-selector-tag">strong</span> style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#a855f7"</span> }}&gt;<span class="hljs-number">128</span> 核&lt;/Text&gt;
                &lt;/<span class="hljs-selector-tag">div</span>&gt;
              &lt;/Space&gt;
            &lt;/<span class="hljs-selector-tag">div</span>&gt;
            {<span class="hljs-comment">/* 能量条 */</span>}
            &lt;<span class="hljs-selector-tag">div</span> style={{ marginBottom: <span class="hljs-number">20</span> }}&gt;
              &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">"flex"</span>, justifyContent: <span class="hljs-string">"space-between"</span>, marginBottom: <span class="hljs-number">8</span> }}&gt;
                &lt;Text style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#888"</span>, fontSize: <span class="hljs-number">12</span> }}&gt;POWER LEVEL&lt;/Text&gt;
                &lt;Text <span class="hljs-selector-tag">strong</span> style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#a855f7"</span>, fontSize: <span class="hljs-number">12</span> }}&gt;<span class="hljs-number">9999</span>&lt;/Text&gt;
              &lt;/<span class="hljs-selector-tag">div</span>&gt;
              &lt;<span class="hljs-selector-tag">div</span> style={{
                <span class="hljs-attribute">height</span>: <span class="hljs-number">6</span>,
                background: <span class="hljs-string">"rgba(0, 0, 0, 0.3)"</span>,
                borderRadius: <span class="hljs-number">3</span>,
                overflow: <span class="hljs-string">"hidden"</span>,
                border: <span class="hljs-string">"1px solid rgba(255, 255, 255, 0.1)"</span>,
              }}&gt;
                &lt;<span class="hljs-selector-tag">div</span> style={{
                  <span class="hljs-attribute">height</span>: <span class="hljs-string">"100%"</span>,
                  width: <span class="hljs-string">"92%"</span>,
                  background: <span class="hljs-string">"linear-gradient(90deg, #a855f7, transparent)"</span>,
                  boxShadow: <span class="hljs-string">"0 0 10px #a855f7"</span>,
                }} /&gt;
              &lt;/<span class="hljs-selector-tag">div</span>&gt;
            &lt;/<span class="hljs-selector-tag">div</span>&gt;
            {<span class="hljs-comment">/* 操作按钮 */</span>}
            &lt;Space style={{ <span class="hljs-attribute">width</span>: <span class="hljs-string">"100%"</span> }}&gt;
              &lt;<span class="hljs-selector-tag">Button</span>
                type="primary"
                className={styles<span class="hljs-selector-class">.neonButton</span>}
                style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#a855f7"</span>, flex: <span class="hljs-number">1</span> }}
                <span class="hljs-attribute">icon</span>={&lt;StarOutlined /&gt;}
              &gt;
                激活
              &lt;/<span class="hljs-selector-tag">Button</span>&gt;
              &lt;<span class="hljs-selector-tag">Button</span>
                className={styles<span class="hljs-selector-class">.neonButton</span>}
                style={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">"#a855f7"</span> }}
                <span class="hljs-attribute">icon</span>={&lt;TrophyOutlined /&gt;}
              &gt;
                详情
              &lt;/<span class="hljs-selector-tag">Button</span>&gt;
            &lt;/Space&gt;
          &lt;/<span class="hljs-selector-tag">div</span>&gt;
        &lt;/Card&gt;
      &lt;/Col&gt;
    &lt;/Row&gt;
  );
};
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c89d3335a1574228be801bd6b0842835~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767075152&amp;x-signature=zuL14rJQGxWZLQnOtm2M2%2FWnits%3D" alt="6.gif" loading="lazy"/></p>
<h3 data-id="heading-20">核心技术要点</h3>
<p><strong>1. 霓虹发光边框</strong></p>
<p>通过多层 box-shadow 实现外发光和内阴影的叠加效果：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">box-shadow</span>: 
  <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">168</span>, <span class="hljs-number">85</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.5</span>),        <span class="hljs-comment">/* 外发光 */</span>
  inset <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">168</span>, <span class="hljs-number">85</span>, <span class="hljs-number">247</span>, <span class="hljs-number">0.1</span>);  <span class="hljs-comment">/* 内阴影 */</span>
</code></pre>
<p><strong>2. 动态霓虹灯条</strong></p>
<p>使用伪元素和渐变动画创建流动的霓虹灯效果：</p>
<pre><code class="hljs language-css" lang="css">&amp;<span class="hljs-selector-pseudo">::before</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">90deg</span>, transparent, <span class="hljs-number">#a855f7</span>, transparent);
  <span class="hljs-attribute">animation</span>: neonFlow <span class="hljs-number">3s</span> ease-in-out infinite;
}
</code></pre>
<p><strong>3. 霓虹文字效果</strong></p>
<p>通过 text-shadow 的多层叠加模拟霓虹灯文字：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">text-shadow</span>: 
  <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">10px</span> currentColor,
  <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> currentColor,
  <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">30px</span> currentColor;
</code></pre>
<p><strong>4. 毛玻璃数据面板</strong></p>
<p>结合半透明背景和 backdrop-filter 实现毛玻璃效果：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>);
backdrop-<span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">10px</span>);
</code></pre>
<p><strong>5. 交互动画</strong></p>
<p>hover 时同步触发多个动画效果：</p>
<ul>
<li>卡片上浮：transform: translateY(-5px)</li>
<li>发光增强：box-shadow 强度提升</li>
<li>边框颜色变化：border-color 过渡</li>
<li/>
</ul>
<h3 data-id="heading-21">样式定制优势</h3>
<p>使用 Ant Design 6.0 + antd-style 实现赛博朋克风格的优势：</p>
<p><strong>1. CSS-in-JS 强大能力：</strong> 支持嵌套、伪元素、动画等高级特性，无需额外 CSS 文件</p>
<p><strong>2. 类型安全：</strong> TypeScript 提供完整的类型提示，减少样式错误</p>
<p><strong>3. 动态主题：</strong> 可以轻松切换不同颜色的霓虹主题（紫色、青色、粉色等）</p>
<p><strong>4. 组件封装：</strong> 样式与组件逻辑共存，便于复用和维护</p>
<p><strong>5. 性能优化：</strong> <code>antd-style</code> 自动处理样式注入和缓存，性能优秀</p>
<p>这种设计风格通过强烈的视觉冲击力和独特的科技感，能够有效吸引用户注意力，提升品牌记忆度，特别适合面向年轻用户群体的产品。</p>
<h2 data-id="heading-22">八、升级建议与实践策略</h2>
<p>对于考虑升级到 Ant Design 6.0 的团队，建议采取以下策略：</p>
<p><strong>1.渐进式升级路径</strong></p>
<ol>
<li>
<p>新项目直接使用：全新项目建议直接使用 6.0 版本，享受所有新特性</p>
</li>
<li>
<p>现有项目评估：评估项目依赖和定制程度，制定分阶段升级计划</p>
</li>
<li>
<p>组件逐步替换：可以先替换使用新功能的组件，再逐步迁移其他部分</p>
</li>
</ol>
<p><strong>2.兼容性注意事项</strong></p>
<ol>
<li>
<p>检查废弃 API：Ant Design 6.0 移除了之前版本已标记为废弃的 API</p>
</li>
<li>
<p>样式覆盖检查：如果项目中有深度定制样式，需要检查与新版本的兼容性</p>
</li>
<li>
<p>测试核心流程：升级后重点测试表单提交、数据展示等核心用户流程</p>
</li>
</ol>
<h2 data-id="heading-23">九、总结</h2>
<p>Ant Design 6.0 的组件功能更新聚焦于解决实际开发中的痛点，通过引入 Masonry 瀑布流布局、Tooltip 平滑移动、InputNumber 拨轮模式、Drawer 拖拽调整、Modal 背景模糊以及 Card 深度定制等特性，显著提升了开发效率和用户体验。</p>
<p>这些更新体现了现代前端设计的几个核心趋势：</p>
<p><strong>1. 交互流畅性：</strong> 如 Tooltip 的平滑过渡，减少界面跳跃感</p>
<p><strong>2. 设备适配性：</strong> 如 InputNumber 的触摸友好设计</p>
<p><strong>3. 布局灵活性：</strong> 如 Masonry 的动态布局和 Drawer 的可调整尺寸</p>
<p><strong>4. 视觉现代化：</strong> 如 Modal 的背景模糊效果，营造朦胧美学的高级质感</p>
<p><strong>5. 样式可控性：</strong> 通过 <code>classNames</code> 和 <code>styles</code> API 实现精准的组件定制</p>
<p><strong>6. 风格多样性：</strong> 结合 <code>antd-style</code> 可实现从企业风到赛博朋克等多样化视觉风格</p>
<p>特别是与 antd-style 的深度集成，让开发者能够充分发挥 CSS-in-JS 的强大能力，从简洁的企业级设计到炫酷的赛博朋克风格，都能轻松实现。这些改进让 Ant Design 6.0 不仅保持了企业级应用的稳定性和专业性，还增加了更多现代化、人性化的交互细节和视觉创意空间，是构建下一代 Web 应用的理想选择。</p>
<h3 data-id="heading-24">往期回顾</h3>
<p>1.Java 设计模式：原理、框架应用与实战全解析｜得物技术</p>
<p>2.Go语言在高并发高可用系统中的实践与解决方案｜得物技术 </p>
<p>3.从0到1搭建一个智能分析OBS埋点数据的AI Agent｜得物技术</p>
<p>4.数据库AI方向探索-MCP原理解析&amp;DB方向实战｜得物技术</p>
<p>5.项目性能优化实践：深入FMP算法原理探索｜得物技术</p>
<h3 data-id="heading-25">文 /三七</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Webpack5：从打包到热更新原理]]></title>    <link>https://juejin.cn/post/7586569284551229480</link>    <guid>https://juejin.cn/post/7586569284551229480</guid>    <pubDate>2025-12-23T01:59:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586569284551229480" data-draft-id="7586559672129372212" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Webpack5：从打包到热更新原理"/> <meta itemprop="keywords" content="前端,Webpack"/> <meta itemprop="datePublished" content="2025-12-23T01:59:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="政采云技术"/> <meta itemprop="url" content="https://juejin.cn/user/3456520257288974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Webpack5：从打包到热更新原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520257288974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    政采云技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:59:42.000Z" title="Tue Dec 23 2025 01:59:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b637793da67b4e068460a99d94b333ed~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=4722&amp;h=696&amp;s=276733&amp;e=png&amp;b=fafcff" alt="文章顶部.png" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e02b965140a4a3499441e0f1d7b84f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061539&amp;x-signature=%2BqzyIGpqtHloGHAU8RuEULwRvSo%3D" alt="作者卡片" loading="lazy"/></p>
<h2 data-id="heading-0">深入理解 Webpack5：从打包到热更新原理</h2>
<h3 data-id="heading-1">为什么需要构建工具？</h3>
<h5 data-id="heading-2">一、解决 “高级语法与浏览器兼容性” 的矛盾</h5>
<p>前端技术迭代快（如 ES6+ 的 <code>async/await</code>、箭头函数，CSS 的 <code>grid</code> 布局），但旧浏览器（如 IE11、Safari 10）不支持这些新特性。构建工具通过**转译（Transpile）<strong>和</strong>前缀添加（Prefixing）**解决兼容问题：</p>
<p><strong>1. JavaScript 转译</strong></p>
<p>发者会使用 ES6+ 及以上语法（如类 <code>class</code>）、TypeScript（类型增强的 JS）、JSX（React 组件语法）等提高开发效率，但这些语法在低版本浏览器或部分现代浏览器中无法直接运行。构建工具（配合 Babel、tsc 等）会将这些高级语法转译为浏览器可识别的 ES5 语法。例如：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 开发时写的 ES6 语法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sum</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;
<span class="hljs-comment">// 构建工具转译后（兼容旧浏览器）</span>
<span class="hljs-keyword">var</span> sum = <span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-keyword">return</span> a + b; };
</code></pre>
<p><strong>2. CSS 属性添加浏览器前缀</strong></p>
<p>开发者常用 Sass/Less/Stylus 等预处理器（支持变量、嵌套、混入等功能）编写 CSS，或使用 CSS Modules 解决样式冲突，但浏览器只认识原生 CSS。构建工具（配合 <code>sass-loader</code>、<code>postcss</code> 等）会将预处理器语法编译为原生 CSS，同时通过 <code>autoprefixer</code>自动添加浏览器前缀（如 <code>-webkit-</code>、<code>-moz-</code>），适配不同浏览器的 CSS 特性支持。例如：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 开发时写的 Sass</span>
<span class="hljs-attr">$color</span>: red;
.<span class="hljs-property">box</span> {
  <span class="hljs-attr">color</span>: $color;
  &amp;:hover { <span class="hljs-attr">color</span>: blue; }
}
<span class="hljs-comment">// 构建后生成的 CSS（带前缀）</span>
.<span class="hljs-property">box</span> { <span class="hljs-attr">color</span>: red; }
.<span class="hljs-property">box</span>:hover { <span class="hljs-attr">color</span>: blue; }
<span class="hljs-meta">@supports</span> (-webkit-<span class="hljs-attr">appearance</span>: none) { .<span class="hljs-property">box</span> { <span class="hljs-comment">/* 适配webkit内核 */</span> } }
</code></pre>
<h5 data-id="heading-3">二、处理 “模块化开发与浏览器加载限制” 的矛盾</h5>
<p>前端项目早已从 “单文件” 发展为 “多模块组合”，但浏览器对模块化的原生支持有限，需要构建工具进行<strong>依赖管理与打包</strong>：</p>
<p><strong>1. 模块化语法统一与解析</strong>前端模块化规范众多（ES Modules <code>import/export</code>、CommonJS <code>require/module.exports</code>、AMD 等），不同库可能使用不同规范，浏览器原生无法统一处理。构建工具会解析所有模块的依赖关系，并将不同规范的模块转换为统一格式（通常是 ES Modules 或打包后的单文件），确保代码能正确运行。</p>
<p><strong>2. 依赖合并与路径处理</strong>一个复杂项目可能依赖数百个模块（如业务组件、工具函数、第三方库），若直接让浏览器加载这些模块，会导致：</p>
<ul>
<li>
<p>大量网络请求（浏览器对同一域名的并发请求数有限，通常 6-8 个），严重拖慢加载速度；</p>
</li>
<li>
<p>模块路径混乱（如相对路径、别名路径 <code>@/components</code> 等，浏览器无法直接识别）。</p>
</li>
</ul>
<p>构建工具会将多个关联模块合并为少数几个 “chunk”（打包产物），并自动处理路径解析（如将 <code>@/components</code> 映射到实际目录），减少请求数并解决路径问题。</p>
<h5 data-id="heading-4">三、优化 “开发效率与生产性能” 的矛盾</h5>
<p>开发时，我们追求的是<strong>高效的调试</strong>和<strong>快速的代码变更反馈</strong>（开发体验）。而生产环境追求的是<strong>极致的加载性能</strong>和<strong>用户体验</strong>。构建工具通过区分<strong>开发模式（development）</strong> 和<strong>生产模式（production）</strong>，用一套配置完美解决两种截然不同的需求。</p>
<p><strong>1. 开发模式（Development） - 追求速度与可调试性</strong></p>
<ul>
<li>
<p><strong>Source Map</strong>：将打包压缩后的代码映射回原始源代码。当你在浏览器调试时，看到的仍然是清晰可读的原始文件结构，而不是一团混乱的打包后代码，使得调试变得非常简单。</p>
</li>
<li>
<p><strong>热更新（HMR）</strong>：只替换修改了的模块，保持应用当前状态（如表单输入、滚动位置），无需整页刷新，实现秒级更新。</p>
</li>
<li>
<p><strong>更快的构建速度</strong>：会跳过代码压缩、Tree Shaking 等耗时的优化步骤，保证开发时重新打包的速度。</p>
</li>
</ul>
<p><strong>2. 生产模式（Production） - 追求体积与性能</strong></p>
<ul>
<li>
<p><strong>代码压缩（Minification）</strong>：使用 Terser 压缩 JavaScript，cssnano 压缩 CSS，移除所有注释、空格、缩短变量名，能显著减小文件体积（通常减少 60%-70%）。</p>
</li>
<li>
<p><strong>代码分割（Code Splitting）</strong>：将代码拆分成多个按需加载的块（chunk）。结合动态导入（<code>import()</code>），可以实现<strong>懒加载</strong>，让用户只加载当前页面或路由所需的代码，极大加速首屏加载时间。</p>
</li>
<li>
<p><strong>Tree Shaking</strong>：像摇树一样，通过静态分析抖落未被使用的代码（dead code），并将其从最终打包文件中移除。例如，你只引用了 Lodash 中的 <code>debounce</code> 函数，打包后就只会包含 <code>debounce</code> 及其依赖，而不是整个 Lodash 库。</p>
</li>
<li>
<p><strong>资源优化与压缩</strong>：自动压缩图片、将小图片转为 Base64 内联、为现代浏览器提供更高效的图片格式（如 WebP/AVIF）。</p>
</li>
</ul>
<h3 data-id="heading-5">有哪些构建工具？</h3>







































































































<table><thead><tr><th><strong>构建工具</strong></th><th><strong>开发语言</strong></th><th><strong>Github Star</strong></th><th><strong>发布时间</strong></th><th><strong>作者</strong></th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vite.dev%2F" target="_blank" title="https://cn.vite.dev/" ref="nofollow noopener noreferrer">Vite</a></td><td>TypeScript</td><td>75k</td><td>2020年4月</td><td>ViteJS</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwebpack.js.org%2F" target="_blank" title="https://webpack.js.org/" ref="nofollow noopener noreferrer">Webpack</a></td><td>JavaScript</td><td>65.5k</td><td>2012年3月</td><td>Facebook</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fparceljs.org%2F" target="_blank" title="https://parceljs.org/" ref="nofollow noopener noreferrer">Parcel</a></td><td>JavaScript</td><td>43.9k</td><td>2017年12月</td><td>Filament Group</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fesbuild.github.io%2F" target="_blank" title="https://esbuild.github.io/" ref="nofollow noopener noreferrer">esbuild</a></td><td>Go</td><td>39.3k</td><td>2020年</td><td>Evan Wallace</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgulpjs.com%2F" target="_blank" title="https://gulpjs.com/" ref="nofollow noopener noreferrer">Gulp</a></td><td>JavaScript</td><td>33.1k</td><td>2013年</td><td>Eric Schoffstall</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fswc.rs%2F" target="_blank" title="https://swc.rs/" ref="nofollow noopener noreferrer">swc</a></td><td>Rust</td><td>32.7k</td><td>2017年</td><td>Vercel</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fturborepo.com%2F" target="_blank" title="https://turborepo.com/" ref="nofollow noopener noreferrer">Turbopack</a></td><td>Rust</td><td>28.5k</td><td>2022年10月</td><td>Vercel</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fnx.dev%2F" target="_blank" title="https://nx.dev/" ref="nofollow noopener noreferrer">Nx</a></td><td>TypeScript</td><td>26.8k</td><td>-</td><td>Nrwl</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Frollupjs.org%2F" target="_blank" title="https://rollupjs.org/" ref="nofollow noopener noreferrer">Rollup</a></td><td>JavaScript</td><td>26k</td><td>2015年</td><td>Rich Harris</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.snowpack.dev%2F" target="_blank" title="https://www.snowpack.dev/" ref="nofollow noopener noreferrer">Snowpack</a></td><td>JavaScript</td><td>19.4k</td><td>2020年5月</td><td>Pika</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Frolldown.rs%2F" target="_blank" title="https://rolldown.rs/" ref="nofollow noopener noreferrer">Rolldown</a></td><td>Rust</td><td>11.9k</td><td>2024年</td><td>VueJS</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Frspack.rs%2Fzh%2F" target="_blank" title="https://rspack.rs/zh/" ref="nofollow noopener noreferrer">Rspack</a></td><td>Rust</td><td>11.9k</td><td>2023年3月</td><td>Bytedance</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwmr.dev%2F" target="_blank" title="https://wmr.dev/" ref="nofollow noopener noreferrer">WMR</a></td><td>JavaScript</td><td>4.9k</td><td>-</td><td>Preact</td></tr></tbody></table>
<h3 data-id="heading-6">Webpack 工作原理</h3>
<p>在众多前端构建工具中，Webpack 由于其高度的灵活性和强大的生态系统，依然是最广泛使用的打包工具之一。与 Vite、Parcel 等工具相比，Webpack 提供了更为细致的定制能力，能够满足复杂项目的需求，如代码分割、资源优化和热更新等功能。掌握 Webpack 不仅有助于提升开发效率，更能优化应用性能，因此本文将深入介绍 Webpack 的工作原理。</p>
<h5 data-id="heading-7">一、打包过程</h5>
<p>Webpack 的打包流程可以分为以下关键步骤：</p>
<h6 data-id="heading-8"><strong>读取配置文件，加载构建参数</strong></h6>
<p>Webpack CLI 启动后，会首先加载开发者提供的配置文件<code>webpack.config.js</code>，包括：</p>
<ul>
<li>
<p>mode、entry、output 等基本配置</p>
</li>
<li>
<p>module.rules 中的 loader 配置</p>
</li>
<li>
<p>plugins 列表</p>
</li>
<li>
<p>optimization 配置</p>
</li>
</ul>
<p>Webpack 采用 <strong>webpack-cli</strong> 来解析命令行参数，并最终调用：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">"webpack"</span>);
<span class="hljs-title function_">webpack</span>(options)
</code></pre>
<p>此时 Webpack 会完成配置合并（Webpack 内部使用 webpack-merge 的策略），将默认配置与用户配置拼接成最终 options 对象。</p>
<p>这一步的作用是确定 Webpack 后续构建过程所依赖的全部元信息。</p>
<h6 data-id="heading-9"><strong>创建 Compiler 对象，初始化编译总体调度器</strong></h6>
<p>Webpack 的主控制器是 <code>Compiler</code> 类，Compiler 是 Webpack 从开始到结束贯穿始终的对象，它控制着构建生命周期的每一个阶段，并将生命周期开放给插件系统（基于 Tapable）。</p>
<p>Compiler 的职责包括：</p>
<ul>
<li>
<p>管理整个构建生命周期</p>
</li>
<li>
<p>负责调用插件、触发钩子</p>
</li>
<li>
<p>统一调度 Compilation、模块工厂、Chunk 构建等核心内容</p>
</li>
</ul>
<p>简化后的核心结构如下：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Compiler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Tapable</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">super</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = options;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span> = {
      <span class="hljs-attr">initialize</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncHook</span>(),
      <span class="hljs-attr">run</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncSeriesHook</span>([<span class="hljs-string">"compiler"</span>]),
      <span class="hljs-attr">compile</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncHook</span>([<span class="hljs-string">"params"</span>]),
      <span class="hljs-attr">make</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncParallelHook</span>([<span class="hljs-string">"compilation"</span>]),
      <span class="hljs-attr">emit</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncSeriesHook</span>([<span class="hljs-string">"compilation"</span>]),
      <span class="hljs-attr">done</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">SyncHook</span>([<span class="hljs-string">"stats"</span>]),
      <span class="hljs-comment">// ...</span>
    };
  }

  <span class="hljs-title function_">run</span>(<span class="hljs-params">callback</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">run</span>.<span class="hljs-title function_">callAsync</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compile</span>(onCompiled);
    });
  }

  <span class="hljs-title function_">compile</span>(<span class="hljs-params">callback</span>) {
    <span class="hljs-keyword">const</span> compilation = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">newCompilation</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">make</span>.<span class="hljs-title function_">callAsync</span>(compilation, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
      compilation.<span class="hljs-title function_">finish</span>(<span class="hljs-function">() =&gt;</span> {
        compilation.<span class="hljs-title function_">seal</span>(callback);
      });
    });
  }
}
</code></pre>
<p><code>compiler.run()</code> 是 Webpack <strong>单次构建流程</strong>的启动函数。它做三件事：</p>
<ul>
<li>
<p>调度构建生命周期钩子，如 <code>beforeRun</code> / <code>run</code></p>
</li>
<li>
<p>调用 <code>compiler.compile()</code> 执行真正的编译逻辑</p>
</li>
<li>
<p>调用 <code>emit</code> / <code>afterEmit</code> / <code>done</code> 等钩子产出结果</p>
</li>
</ul>
<p>Compiler 控制整体流程，而 Compilation 则控制：</p>
<ul>
<li>
<p>模块构建（构建每一个 JS/CSS/图片等模块）</p>
</li>
<li>
<p>模块依赖分析</p>
</li>
<li>
<p>Chunk 构建</p>
</li>
<li>
<p>代码优化（Tree Shaking、SplitChunks）</p>
</li>
<li>
<p>生成最终资源（assets）</p>
</li>
</ul>
<p>Compilation 是构建的“工作单位”，负责所有实际的打包工作。</p>
<h6 data-id="heading-10"><strong>从入口文件开始，递归查找和编译模块</strong></h6>
<p>EntryPlugin 会根据 entry 配置向 Compilation 注册入口模块。Webpack 随后会从入口开始递归解析依赖，构建整个依赖图。当遇到非 JS 模块时，通过 Loader 进行处理（如将 TS/LESS/图片等转为可用模块）。</p>
<p>Webpack 在构建模块时，会根据 module.rules 匹配对应的 loader，从右向左依次对模块内容进行转换。</p>
<p>Loader 的作用包括但不限于：</p>
<ul>
<li>
<p>Babel：将 ES6+ 转译为 ES5</p>
</li>
<li>
<p>css-loader：处理 CSS 文件内容</p>
</li>
<li>
<p>url-loader / file-loader：处理图片资源</p>
</li>
<li>
<p>vue-loader / ts-loader：处理 SFC 或 TS</p>
</li>
</ul>
<p>最终，所有文件都会被转换成 JavaScript 字符串供后续 AST 解析。</p>
<h6 data-id="heading-11"><strong>解析每个模块的依赖关系，构建模块图 ModuleGraph</strong></h6>
<p>webpack 把 loader 产出的 JS 代码解析成 AST，识别出所有依赖节点（<code>import</code> / <code>require</code> / <code>import()</code> / loader 插入的依赖等），并把这些依赖投影到 <strong>ModuleGraph</strong> 上，形成可供后续优化和分块的有向依赖图。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// NormalModule.build() 内部流程（精简）</span>
<span class="hljs-title function_">runLoaders</span>(resource, loaders, <span class="hljs-function">(<span class="hljs-params">err, result</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> source = result.<span class="hljs-property">result</span>[<span class="hljs-number">0</span>];             <span class="hljs-comment">// loader 输出 -&gt; JS 字符串 / Source</span>
  <span class="hljs-keyword">const</span> parser = compilation.<span class="hljs-title function_">getParser</span>(<span class="hljs-string">"javascript"</span>);
  <span class="hljs-keyword">const</span> ast = parser.<span class="hljs-title function_">parse</span>(source);            <span class="hljs-comment">// acorn -&gt; AST</span>
  <span class="hljs-keyword">const</span> dependencies = parser.<span class="hljs-title function_">collectDependencies</span>(ast); <span class="hljs-comment">// 解析产生 Dependency 实例</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dep <span class="hljs-keyword">of</span> dependencies) {
    <span class="hljs-keyword">const</span> resolved = resolver.<span class="hljs-title function_">resolve</span>(dep.<span class="hljs-property">request</span>);
    <span class="hljs-keyword">const</span> depModule = normalModuleFactory.<span class="hljs-title function_">create</span>(resolved);
    moduleGraph.<span class="hljs-title function_">connect</span>(<span class="hljs-variable language_">module</span>, dep, depModule); <span class="hljs-comment">// 建图：模块 -&gt; 依赖 -&gt; 目标模块</span>
  }
});
</code></pre>
<ul>
<li>
<p>解析器（JavascriptParser）是通过 Tapable hook 逐节点触发、生成  实例（以便插件/loader 能介入解析过程）。</p>
</li>
<li>
<p>NormalModuleFactory / Resolver 负责把语法层面的请求（request）解析到具体路径并创建 Module 实例，Compilation 将这些新模块加入构建队列直至递归完成。</p>
</li>
</ul>
<h6 data-id="heading-12"><strong>优化模块</strong></h6>
<p>在模块级别上减少最终运行时代码体积并提升运行时性能的策略，包括剔除未使用代码（Tree Shaking）、合并模块以缩短调用链与减少函数包装开销（Scope Hoisting / Module Concatenation）、以及其他小粒度优化（常量折叠、dead code elimination 交给 Terser 等压缩器完成）。</p>
<h6 data-id="heading-13"><strong>根据模块图生成 Chunk，对生成的代码块进行进一步优化</strong></h6>
<p>Webpack 将完成构建的模块根据入口点和不同类型的依赖关系构建多个 Chunk，Chunk 是 Webpack 打包产物的基础单位，每个 Chunk 对应一个最终输出文件（或多个文件组合），同时承载 runtime、依赖关系、模块顺序和异步加载信息。ChunkGraph 会在这一阶段被创建并建立，它记录：</p>
<ul>
<li>
<p>当前 Chunk 包含哪些模块</p>
</li>
<li>
<p>模块属于哪些 Chunk</p>
</li>
<li>
<p>Chunk 与 Chunk 之间的关系</p>
</li>
</ul>
<p>生成的 Chunk 进行最终优化，包括渲染 Chunk 内部代码、处理异步加载和动态 import、应用代码分割策略提取公共模块、注入 runtime 逻辑、生成按需加载和预加载提示，以及通过 [contenthash] 和独立 runtime Chunk 实现长期缓存，从而使输出文件体积最小化、加载高效并支持浏览器缓存优化。</p>
<h6 data-id="heading-14"><strong>生成最终资源并写入输出目录</strong></h6>
<p>Webpack 构建完成后会将所有 Chunk 转换为可执行文件（assets），例如：</p>
<ul>
<li>
<p>main.js</p>
</li>
<li>
<p>vendors.js</p>
</li>
<li>
<p>style.css</p>
</li>
<li>
<p>图片 / 字体等静态资源</p>
</li>
</ul>
<p>输出阶段触发 Compiler 的 <code>emit</code> 钩子，随后写入文件系统。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-title function_">emitAssets</span>(<span class="hljs-params">compilation, callback</span>) {
  <span class="hljs-keyword">const</span> { entries, modules, chunks, assets } = compilation;
  <span class="hljs-keyword">const</span> output = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">output</span>;
    
  <span class="hljs-comment">// 调用 Plugin emit 钩子</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">call</span>();
  
  <span class="hljs-comment">// 若 output.path 不存在，进行创建</span>
  <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(output.<span class="hljs-property">path</span>)) {
    fs.<span class="hljs-title function_">mkdirSync</span>(output.<span class="hljs-property">path</span>);
  }
    
  <span class="hljs-comment">// 将 assets 中的内容写入文件系统中</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(assets).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">fileName</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(output.<span class="hljs-property">path</span>, fileName);
    fs.<span class="hljs-title function_">writeFileSync</span>(filePath, assets[fileName]);
  });
  
  <span class="hljs-comment">// 结束之后触发钩子</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">call</span>();
  
  <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, {
    <span class="hljs-attr">toJSON</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        entries,
        modules,
        chunks,
        assets,
      };
    },
  });
}
</code></pre>
<h5 data-id="heading-15">二、热更新过程</h5>
<p>热模块替换（HMR，Hot Module Replacement）是指当我们对代码修改并保存后，Webpack 将会对代码进行重新打包，并将新的模块发送到浏览器端，浏览器用新的模块替换掉旧的模块 ，以实现在不刷新浏览器的前提下更新页面。</p>
<p><strong>整体流程：</strong></p>
<ul>
<li>
<p>首先是 Webpack 监听到文件修改后，进行编译，打包出新的文件，得到新的 hash。</p>
</li>
<li>
<p>其次是 webpack-dev-server 通过 websocket 通知浏览器，告诉浏览器新的 hash。</p>
</li>
<li>
<p>浏览器收到通知后，请求新的文件，拿到新的文件后，更新页面。</p>
</li>
</ul>
<h6 data-id="heading-16">文件监听</h6>
<p>Webpack 的文件监听机制用于在开发模式下自动检测文件变化并触发增量编译。其核心由三个组件构成：</p>
<ul>
<li>
<p><strong>Watching</strong>（调度层）</p>
</li>
<li>
<p><strong>Watchpack</strong>（抽象管理层）</p>
</li>
<li>
<p><strong>DirectoryWatcher</strong>（底层监听实现层）</p>
</li>
</ul>
<p>整体基于 <strong>发布–订阅模型（EventEmitter）</strong> 实现，整个过程是典型的 **事件驱动的监听 → 通知 → 重新编译。**Webpack 通过以下流程实现监听：</p>
<ol>
<li>
<p><code>compiler.watch()</code> 创建 Watching 实例，负责整个监听调度。</p>
</li>
<li>
<p>Watching 初始化 Watchpack，并让其负责监听所有文件和目录。</p>
</li>
<li>
<p>Watchpack 内部使用 DirectoryWatcher 监听目录变动，同时监听单文件变化。</p>
</li>
<li>
<p>文件变动发生时，DirectoryWatcher 发出 <code>change</code> 事件。</p>
</li>
<li>
<p>Watchpack 将事件上报给 Watching。</p>
</li>
<li>
<p>Watching 调用 Webpack 的增量编译流程，生成新的构建文件。</p>
</li>
</ol>
<p><strong>Watching</strong></p>
<p>Watching 是 Webpack 启动 watch 时最上层的控制者，通过：</p>
<ul>
<li>
<p>创建并启动 Watchpack；</p>
</li>
<li>
<p>订阅 Watchpack 的 <code>change</code>、<code>remove</code> 事件；</p>
</li>
<li>
<p>触发增量编译；</p>
</li>
<li>
<p>将新的 hash 传给 dev-server，使浏览器执行 HMR 刷新。</p>
</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Watching</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    }
    <span class="hljs-title function_">watch</span>(<span class="hljs-params">files</span>){
        <span class="hljs-keyword">let</span> watcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watchpack</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-title function_">callback</span> =  (<span class="hljs-params">changes, removals</span>)=&gt;{
             <span class="hljs-comment">// 执行各种hooks</span>
        }
        watcher.<span class="hljs-title function_">once</span>(<span class="hljs-string">"aggregated"</span>,callback);
        watcher.<span class="hljs-title function_">watch</span>(files, directories, <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>);
        <span class="hljs-keyword">return</span> watcher;
    }
}
</code></pre>
<p><strong>Watchpack</strong> </p>
<p>Watchpack 是 Webpack 文件监听功能的核心抽象层，负责：</p>
<ul>
<li>
<p>统一管理所有被监听的文件和目录；</p>
</li>
<li>
<p>为每个目录创建 <strong>DirectoryWatcher</strong>；</p>
</li>
<li>
<p>决定具体监听方式（fs.watch、fs.watchFile、轮询）；</p>
</li>
<li>
<p>将底层监听事件汇总后统一向外发射：</p>
<ul>
<li>
<p><code>change</code>（文件变化）</p>
</li>
<li>
<p><code>remove</code>（文件被删除）</p>
</li>
</ul>
</li>
</ul>
<p>所以它不直接监听，而是管理多个监听者。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Watchpack</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">EventEmitter</span>{
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileWatchers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">directoryWatchers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    }
    <span class="hljs-title function_">watch</span>(<span class="hljs-params">files, directories, startTime</span>){
        <span class="hljs-comment">// 为每个文件添加一个或多个 DirectoryWatcher</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> file <span class="hljs-keyword">of</span> files){
            <span class="hljs-keyword">let</span> watcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectoryWatcher</span>();
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileWatchers</span>.<span class="hljs-title function_">set</span>(file, watcher);
            watcher.<span class="hljs-title function_">on</span>(<span class="hljs-string">"change"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">_onTimeout</span>);
            watcher.<span class="hljs-title function_">watch</span>(file, startTime);
        }
        <span class="hljs-comment">// for of directories</span>
        <span class="hljs-comment">// bala bala</span>
        
        <span class="hljs-comment">// 源码这里的方法调用，没太明白是个啥意思？</span>
        <span class="hljs-comment">// 后面还有一个watchEventSource.watch()</span>
        watchEventSource.<span class="hljs-title function_">batch</span>()
    }
    <span class="hljs-title function_">_onTimeout</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> changes = <span class="hljs-variable language_">this</span>.<span class="hljs-property">aggregatedChanges</span>;
        <span class="hljs-keyword">const</span> removals = <span class="hljs-variable language_">this</span>.<span class="hljs-property">aggregatedRemovals</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"aggregated"</span>, changes, removals);
    }
}
</code></pre>
<p><strong>DirectoryWatcher</strong></p>
<p>DirectoryWatcher 是最底层、最核心的监听器，负责检测：</p>
<ul>
<li>
<p>文件内容修改（mtime 改变）</p>
</li>
<li>
<p>新文件创建</p>
</li>
<li>
<p>文件删除（readdir 不存在）</p>
</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DirectoryWatcher</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">EventEmitter</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">watchers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">files</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
       
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">watcher</span> = watchEventSource.<span class="hljs-title function_">watch</span>(file);
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">watcher</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">"change"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onWatchEvent</span>);
    }
    <span class="hljs-title function_">watch</span>(<span class="hljs-params">file, startTime</span>){
        <span class="hljs-keyword">let</span> watchers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
        <span class="hljs-keyword">let</span> watcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(startTime);
        watchers.<span class="hljs-title function_">add</span>(watcher);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">watchers</span>.<span class="hljs-title function_">set</span>(file, watchers);     
    }
    <span class="hljs-title function_">onWatchEvent</span>(<span class="hljs-params">eventType, filename</span>){
        fs.<span class="hljs-title function_">lstat</span>(filePath, <span class="hljs-function">(<span class="hljs-params">err, stats</span>)=&gt;</span>{
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setFileTime</span>(filePath, stats.<span class="hljs-property">mtime</span>);
            <span class="hljs-comment">// this.setDirectory(filePath, eventType);</span>
        })
    }
    <span class="hljs-title function_">setFileTime</span>(<span class="hljs-params">filePath, mtime</span>){
        <span class="hljs-comment">// 记录文件信息</span>
        <span class="hljs-keyword">let</span> safeTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">files</span>.<span class="hljs-title function_">set</span>(filePath, {
            safeTime,
            <span class="hljs-attr">timestamp</span>: mtime
        })
        <span class="hljs-keyword">let</span> watchers = <span class="hljs-variable language_">this</span>.<span class="hljs-property">watchers</span>.<span class="hljs-title function_">get</span>(filePath)
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> w <span class="hljs-keyword">of</span> watchers) {
           <span class="hljs-keyword">if</span> (w.<span class="hljs-title function_">checkStartTime</span>(safeTime)) {
                <span class="hljs-comment">// 文件更新后触发的事件源</span>
                w.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"change"</span>, mtime);
            }
        }
       
    }
}
</code></pre>
<ul>
<li>
<p>优先使用操作系统事件（fs.watch）</p>
</li>
<li>
<p>系统不支持时退回轮询（Polling）</p>
<ul>
<li>通过周期性的 <code>fs.stat</code> + mtime 对比检测变化。    </li>
</ul>
</li>
</ul>
<h6 data-id="heading-17">模块编译处理</h6>
<p>当文件监听到变化后，Webpack 会触发一次增量编译，除了与打包类似的编译外，webpack 还会往 Compiler 注入 HotModuleReplacementPlugin 插件，插件内部做了三方面处理：</p>
<ul>
<li>
<p>**语法转译：**模块代码允许使用 <code>module.hot.xxx</code> 进行个性化处理，需要将这些语法处理为符合运行时能力的代码；</p>
</li>
<li>
<p>**HMR Runtime Module：**HMR模式下会将 HMR Runtime 模块进行注入操作。</p>
</li>
<li>
<p>**产物生成：**HMR 模式下每次变更都会产生  manifest 和 update chunks 文件，编译器需要额外处理这些产生生成逻辑。</p>
</li>
</ul>
<p><strong>语法转译</strong></p>
<p>在开发模式下，模块里可能会用到 HMR API，例如：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>) {
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>(<span class="hljs-string">'./foo.js'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'foo.js 更新了'</span>);
    });
}
</code></pre>
<p>HotModuleReplacementPlugin 提供了语法转义能力：</p>
<ul>
<li>
<p>对模块代码进行解析，找到 <code>module.hot.xxx</code> 相关调用；</p>
<ul>
<li>主要替换语法有 module.hot、module.hot.accept、module.hot.decline 语法</li>
</ul>
</li>
<li>
<p>将这些调用转换成运行时可以识别的代码（符合 HMR Runtime 约定）；</p>
</li>
<li>
<p>注入必要的回调钩子，保证模块在被替换时能够正确触发 accept、dispose 回调。</p>
</li>
</ul>
<p>让开发者书写的 HMR API 能够在浏览器端的 HMR Runtime 中生效，实现模块级别的热替换。</p>
<p><strong>HMR Runtime Module 注入</strong></p>
<p>HMR 在运行时需要相应基础能力才能够运行，在 HotModuleReplacementPlugin 内部会往编译器注入 HotModuleReplacementRuntimeModule 保证应用能够正常提供运行时能力。</p>
<p>该 Runtime Module 实现了：</p>
<ul>
<li>
<p>WebSocket 通信（接收 hash / ok 消息）；</p>
</li>
<li>
<p>补丁文件的加载（hot-update.js / hot-update.json）；</p>
</li>
<li>
<p>模块替换逻辑（dispose → apply → accept）；</p>
</li>
<li>
<p>状态管理（已替换的模块、更新队列等）。</p>
</li>
</ul>
<p>作用：保证浏览器端可以正确识别 HMR 消息，拉取补丁并执行模块替换，而不刷新整个页面。</p>
<p><strong>manifest 及 Chunk 生成</strong></p>
<p>Compiler 每次编译之后都会得到每个模块、Chunk 的哈希值，Compiler 通过判断本次编译的产物的哈希和上次编译记录的Hash得出模块变更信息，HotModuleReplacementPlugin 根据模块变更信息生成两份数据：</p>
<ol>
<li>更新描述<code>manifest.json</code>：以JSON形式数据</li>
</ol>
<ul>
<li>
<p><code>updateChunkIds</code>：更新的 Chunk Id</p>
</li>
<li>
<p><code>removedChunkIds</code>：移除的 Chunk Id</p>
</li>
<li>
<p><code>removedModuleIds</code>：移除的 Module Id</p>
</li>
</ul>
<ol start="2">
<li>模块 Chunk 产物<code>[key].[newHash].hot-update.js</code>：只包含更新模块代码</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// [key].[newHash].hot-update.js</span>
self[<span class="hljs-string">"webpackHotUpdate_myApp"</span>](<span class="hljs-string">"main"</span>, {
  <span class="hljs-number">0</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, __webpack_exports__, __webpack_require__</span>) {
    <span class="hljs-comment">// 新模块代码</span>
  },
  <span class="hljs-number">2</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, __webpack_exports__, __webpack_require__</span>) {
    <span class="hljs-comment">// 新模块代码</span>
  }});

</code></pre>
<p>当 Webpack 完成增量编译后，会将新的构建产物与新的 hash 生 成在内存中，此时 Webpack-dev-server 会通过 WebSocket 将更新消息推送给浏览器。</p>
<p>Webpack-dev-server 的核心功能是作为 <strong>浏览器与编译器之间的中间层</strong>，让前端项目在开发阶段拥有实时更新能力。</p>
<p>在传统的 LiveReload 模式下，文件变更后浏览器会被强制刷新整个页面；而 HMR 在此基础上更进一步，只更新变化的模块而不刷新整页。这两种机制最终都依赖 Webpack-dev-server  提供的能力。</p>
<p>从整体设计来看，Webpack-dev-server 可以拆分为两个主要模块：</p>
<ul>
<li>
<p>应用通信模块（推送更新消息）</p>
</li>
<li>
<p>静态资源服务模块（返回构建产物）</p>
<ul>
<li>使用 express 框架提供静态资源服务器功能</li>
</ul>
</li>
</ul>
<h6 data-id="heading-18">更新通知</h6>
<p>服务器与浏览器之间通过 WebSocket 建立长连接，并会使用长轮询作为兜底方法。</p>
<ol>
<li>
<p>监听 Webpack 编译完成后，主动触发 <code>sendStats</code> 方法</p>
</li>
<li>
<p>本地服务端的 WebSocket 主动发送 hash 命令和 ok 命令到本地浏览器 client 端</p>
</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> {
 <span class="hljs-title function_">setupHooks</span>(<span class="hljs-params"/>) {
     <span class="hljs-comment">// 初始化时注册done的监听事件，编译完成后，调用sendStats方法进行webSocket的命令发送</span>
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">compiler</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tap</span>(
         <span class="hljs-string">"webpack-dev-server"</span>,
         <span class="hljs-function">(<span class="hljs-params">stats</span>) =&gt;</span> {
             <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">webSocketServer</span>) {
                 <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendStats</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">webSocketServer</span>.<span class="hljs-property">clients</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getStats</span>(stats));
             }
             <span class="hljs-variable language_">this</span>.<span class="hljs-property">stats</span> = stats;
         }
     );
 }

 <span class="hljs-title function_">sendStats</span>(<span class="hljs-params">clients, stats, force</span>) {
     <span class="hljs-comment">// 更新当前的hash</span>
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentHash</span> = stats.<span class="hljs-property">hash</span>;
   
     <span class="hljs-comment">// 发送给客户端当前的hash值</span>
     <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendMessage</span>(clients, <span class="hljs-string">"hash"</span>, stats.<span class="hljs-property">hash</span>);

     <span class="hljs-comment">// 发送给客户端ok的指令</span>
     <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendMessage</span>(clients, <span class="hljs-string">"ok"</span>);
 }
}
</code></pre>
<h6 data-id="heading-19">模块替换</h6>
<p>当浏览器端收到 ok 消息后，Webpack 的 HMR Runtime 便会开始执行模块热替换流程。浏览器端调用 <code>emitter</code>将最新 hash 值发送给 HMR runtime。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> hotEmitter <span class="hljs-keyword">from</span> <span class="hljs-string">"webpack/hot/emitter.js"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reloadApp</span>(<span class="hljs-params">_ref, status</span>) {
  <span class="hljs-keyword">var</span> hot = _ref.<span class="hljs-property">hot</span>, liveReload = _ref.<span class="hljs-property">liveReload</span>;
  ...
  <span class="hljs-keyword">var</span> currentHash = status.<span class="hljs-property">currentHash</span>, previousHash = status.<span class="hljs-property">previousHash</span>;
  ...
  <span class="hljs-keyword">var</span> allowToHot = search.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">"webpack-dev-server-hot=false"</span>) === -<span class="hljs-number">1</span>;
  <span class="hljs-keyword">if</span> (hot &amp;&amp; allowToHot) {
    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"App hot update..."</span>);
    hotEmitter.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"webpackHotUpdate"</span>, status.<span class="hljs-property">currentHash</span>);
    ...
  }
  ...
}
</code></pre>
<p>HMR runtime 会更新 lastHash，并在必要时调用 <code>check()</code>，发起更新检查</p>
<pre><code class="hljs language-tsx" lang="tsx">hotEmitter.<span class="hljs-title function_">on</span>(<span class="hljs-string">"webpackHotUpdate"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">currentHash</span>) {
  lastHash = currentHash;
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">upToDate</span>() &amp;&amp; <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">status</span>() === <span class="hljs-string">"idle"</span>) {
    <span class="hljs-title function_">log</span>(<span class="hljs-string">"info"</span>, <span class="hljs-string">"[HMR] Checking for updates on the server..."</span>);
    <span class="hljs-title function_">check</span>();
  }
});
<span class="hljs-keyword">var</span> check = <span class="hljs-keyword">function</span> <span class="hljs-title function_">check</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>
    .<span class="hljs-title function_">check</span>(<span class="hljs-literal">true</span>)
    .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">updatedModules</span>) {
      ...
    })
    .<span class="hljs-keyword">catch</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) {
      ...
    });
};
</code></pre>
<p><code>module.hot.check</code>最终会触发<code>hotCheck()</code>方法</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hotCheck</span>(<span class="hljs-params">applyOnUpdate</span>) {
  ...
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">"check"</span>)
  .<span class="hljs-title function_">then</span>(__webpack_require__.<span class="hljs-property">hmrM</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">update</span>) {
      ...
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">"prepare"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
              <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(__webpack_require__.<span class="hljs-property">hmrC</span>).<span class="hljs-title function_">reduce</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">
              			promises,
              			key
              		</span>) {
                        <span class="hljs-comment">// key = jsonp</span>
              			__webpack_require__.<span class="hljs-property">hmrC</span>[key](
              					update.<span class="hljs-property">c</span>,
              					update.<span class="hljs-property">r</span>,
              					update.<span class="hljs-property">m</span>,
              					promises,
              					currentUpdateApplyHandlers,
              					updatedModules
              				);
              			<span class="hljs-keyword">return</span> promises;
              		},
              	[])
          ).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
              <span class="hljs-keyword">return</span> <span class="hljs-title function_">waitForBlockingPromises</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
                  ...
                  <span class="hljs-keyword">return</span> <span class="hljs-title function_">internalApply</span>(applyOnUpdate);
              });
          });
      });
  });
}
__webpack_require__.<span class="hljs-property">hmrC</span>.<span class="hljs-property">jsonp</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">
  chunkIds,
  removedChunks,
  removedModules,
  promises,
  applyHandlers,
  updatedModulesList,
</span>) {
    applyHandlers.<span class="hljs-title function_">push</span>(applyHandler);
    ...
    chunkIds.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">chunkId</span>) {
        <span class="hljs-keyword">if</span> (
        __webpack_require__.<span class="hljs-title function_">o</span>(installedChunks, chunkId) &amp;&amp;
        installedChunks[chunkId] !== <span class="hljs-literal">undefined</span>
        ) {
            promises.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">loadUpdateChunk</span>(chunkId, updatedModulesList));
        }
    });
};
</code></pre>
<p>__webpack_require__.hmrM 中 fetch 到新的 manifest.json 文件，完成后，触发 __webpack_require__.hmrC.jsonp 方法执行</p>
<p>执行 __webpack_require__.hmrC.jsonp，传入 manifest.json 文件中返回的key，通过 jsonp 方式请求得到 [key].[newHash].hot-update.js，执行对应的 moudle 代码的缓存并且触发对应 promise 的<code>resolve</code>请求，从而顺利回调<code>internalApply()</code>方法</p>
<p><code>internalApply()</code>方法是 <strong>HMR 的“内部调度器”</strong>，连接了 <strong>检查更新</strong> 和 <strong>实际替换模块</strong> 两个阶段。根据更新的模块和依赖信息，决定哪些模块可以热替换、哪些模块需要 dispose，并最终调用 <code>apply()</code> 来应用新模块</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">internalApply</span>(<span class="hljs-params">options</span>) {
 <span class="hljs-comment">// 这里的currentUpdateApplyHandlers存储的是上面jsonp请求js文件所创建的callback</span>
 <span class="hljs-keyword">var</span> results = currentUpdateApplyHandlers.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">handler</span>) {
     <span class="hljs-keyword">return</span> <span class="hljs-title function_">handler</span>(options);
 });
 currentUpdateApplyHandlers = <span class="hljs-literal">undefined</span>;

 results.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) {
   <span class="hljs-keyword">if</span> (result.<span class="hljs-property">dispose</span>) result.<span class="hljs-title function_">dispose</span>();
 });

 <span class="hljs-keyword">var</span> outdatedModules = [];
 results.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) {
     <span class="hljs-keyword">if</span> (result.<span class="hljs-property">apply</span>) {
         <span class="hljs-comment">// 这里的result的是上面jsonp请求js文件所创建的callback所返回Object的apply方法</span>
         <span class="hljs-keyword">var</span> modules = result.<span class="hljs-title function_">apply</span>(reportError);
         <span class="hljs-keyword">if</span> (modules) {
             <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; modules.<span class="hljs-property">length</span>; i++) {
                 outdatedModules.<span class="hljs-title function_">push</span>(modules[i]);
             }
         }
     }
 });

 <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([disposePromise, applyPromise]).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {

     <span class="hljs-keyword">return</span> <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">"idle"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
         <span class="hljs-keyword">return</span> outdatedModules;
     });
 });
}
</code></pre>
<p><strong>替换的总体执行逻辑：</strong></p>
<ol>
<li>
<p>根据webpack配置拼接出当前 moduleId 的热更新策略，比如允许热更新，比如不允许热更新等等</p>
</li>
<li>
<p>根据热更新策略，拼接多个数据结构，为<code>applay()</code>方法代码服务</p>
</li>
<li>
<p>从<code>internalApply()</code>可以知道，最终会先执行<code>result.dispose()</code>，然后再执行<code>result.apply()</code>方法</p>
</li>
</ol>
<p><strong>拼接数据结构</strong></p>
<ol>
<li>
<p>根据<code>getAffectedModuleEffects(moduleId)</code>整理出该<code>moduleId</code>的热更新策略，是否需要热更新</p>
</li>
<li>
<p>根据多个对象拼凑出<code>dispose</code>和<code>apply</code>方法所需要的数据结构</p>
</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">applyHandler</span>(<span class="hljs-params">options</span>) {
   currentUpdateChunks = <span class="hljs-literal">undefined</span>;

   <span class="hljs-comment">// at begin all updates modules are outdated</span>
   <span class="hljs-comment">// the "outdated" status can propagate to parents if they don't accept the children</span>
   <span class="hljs-keyword">var</span> outdatedDependencies = {}; <span class="hljs-comment">// 使用module.hot.accept部署了依赖发生更新后的回调函数</span>
   <span class="hljs-keyword">var</span> outdatedModules = []; <span class="hljs-comment">// 当前过期需要更新的modules</span>
   <span class="hljs-keyword">var</span> appliedUpdate = {}; <span class="hljs-comment">// 准备更新的modules</span>


   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> moduleId <span class="hljs-keyword">in</span> currentUpdate) {
       <span class="hljs-keyword">var</span> newModuleFactory = currentUpdate[moduleId];

       <span class="hljs-comment">// 获取之前的配置：该moduleId是否允许热更新</span>
       <span class="hljs-keyword">var</span> result = <span class="hljs-title function_">getAffectedModuleEffects</span>(moduleId);

       <span class="hljs-keyword">var</span> doApply = <span class="hljs-literal">false</span>;
       <span class="hljs-keyword">var</span> doDispose = <span class="hljs-literal">false</span>;

       <span class="hljs-keyword">switch</span> (result.<span class="hljs-property">type</span>) {
           <span class="hljs-comment">// ...</span>
           <span class="hljs-keyword">case</span> <span class="hljs-string">"accepted"</span>:
               <span class="hljs-keyword">if</span> (options.<span class="hljs-property">onAccepted</span>) options.<span class="hljs-title function_">onAccepted</span>(result);
               doApply = <span class="hljs-literal">true</span>;
               <span class="hljs-keyword">break</span>;
           <span class="hljs-comment">//...</span>
       }
       <span class="hljs-keyword">if</span> (doApply) {
           appliedUpdate[moduleId] = newModuleFactory;
           <span class="hljs-comment">//...代码省略... 拼凑出outdatedDependencies过期的依赖，为下面的module.hot.accept(moduleId, function() {})做准备</span>
       }
       <span class="hljs-keyword">if</span> (doDispose) {
           <span class="hljs-comment">//...代码省略... 处理配置为dispose的情况</span>
       }

   }
   currentUpdate = <span class="hljs-literal">undefined</span>;

   <span class="hljs-comment">// 根据outdatedModules拼凑出需要_selfAccepted=true，即热更新是重新加载一次自己的module的数据到outdatedSelfAcceptedModules中</span>
   <span class="hljs-keyword">var</span> outdatedSelfAcceptedModules = [];
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; outdatedModules.<span class="hljs-property">length</span>; j++) {
       <span class="hljs-keyword">var</span> outdatedModuleId = outdatedModules[j];
       <span class="hljs-comment">// __webpack_require__.c = __webpack_module_cache__</span>
       <span class="hljs-keyword">var</span> <span class="hljs-variable language_">module</span> = __webpack_require__.<span class="hljs-property">c</span>[outdatedModuleId];
       <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span> &amp;&amp; (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_selfAccepted</span> || <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_main</span>) &amp;&amp;
           appliedUpdate[outdatedModuleId] !== warnUnexpectedRequire &amp;&amp;
           !<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_selfInvalidated</span>
       ) {
           <span class="hljs-comment">// _requireSelf: function () {</span>
           <span class="hljs-comment">//      currentParents = me.parents.slice();</span>
           <span class="hljs-comment">//      currentChildModule = _main ? undefined : moduleId;</span>
           <span class="hljs-comment">//         __webpack_require__(moduleId);</span>
           <span class="hljs-comment">// },</span>
           outdatedSelfAcceptedModules.<span class="hljs-title function_">push</span>({
               <span class="hljs-attr">module</span>: outdatedModuleId,
               <span class="hljs-attr">require</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_requireSelf</span>, <span class="hljs-comment">// 重新加载自己</span>
               <span class="hljs-attr">errorHandler</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_selfAccepted</span>
           });
       }
   }

   <span class="hljs-keyword">var</span> moduleOutdatedDependencies;

   <span class="hljs-keyword">return</span> {
       <span class="hljs-attr">dispose</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {...}
       <span class="hljs-attr">apply</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">reportError</span>) {...}
   };
}
</code></pre>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getAffectedModuleEffects</span>(<span class="hljs-params">updateModuleId</span>) {
   <span class="hljs-keyword">var</span> outdatedModules = [updateModuleId];
   <span class="hljs-keyword">var</span> outdatedDependencies = {};

   <span class="hljs-keyword">var</span> queue = outdatedModules.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">id</span>) {
       <span class="hljs-keyword">return</span> {
           <span class="hljs-attr">chain</span>: [id],
           <span class="hljs-attr">id</span>: id
       };
   });
   <span class="hljs-keyword">while</span> (queue.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
       <span class="hljs-keyword">var</span> queueItem = queue.<span class="hljs-title function_">pop</span>();
       <span class="hljs-keyword">var</span> moduleId = queueItem.<span class="hljs-property">id</span>;
       <span class="hljs-keyword">var</span> chain = queueItem.<span class="hljs-property">chain</span>;
       <span class="hljs-keyword">var</span> <span class="hljs-variable language_">module</span> = __webpack_require__.<span class="hljs-property">c</span>[moduleId];
       <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span> || (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_selfAccepted</span> &amp;&amp; !<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_selfInvalidated</span>)) { <span class="hljs-keyword">continue</span>; }

       <span class="hljs-comment">// ************ 处理不热更新的情况 ************</span>
       <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_selfDeclined</span>) {
           <span class="hljs-keyword">return</span> {
               <span class="hljs-attr">type</span>: <span class="hljs-string">"self-declined"</span>,
               <span class="hljs-attr">chain</span>: chain,
               <span class="hljs-attr">moduleId</span>: moduleId
           };
       }
       <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_main</span>) {
           <span class="hljs-keyword">return</span> {
               <span class="hljs-attr">type</span>: <span class="hljs-string">"unaccepted"</span>,
               <span class="hljs-attr">chain</span>: chain,
               <span class="hljs-attr">moduleId</span>: moduleId
           };
       }
       <span class="hljs-comment">// ************ 处理不热更新的情况 ************</span>

       <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">module</span>.<span class="hljs-property">parents</span>.<span class="hljs-property">length</span>; i++) {
           <span class="hljs-comment">// module.parents=依赖这个模块的modules</span>
           <span class="hljs-comment">// 遍历所有依赖这个模块的 modules</span>
           <span class="hljs-keyword">var</span> parentId = <span class="hljs-variable language_">module</span>.<span class="hljs-property">parents</span>[i];
           <span class="hljs-keyword">var</span> parent = __webpack_require__.<span class="hljs-property">c</span>[parentId];
           <span class="hljs-keyword">if</span> (!parent) <span class="hljs-keyword">continue</span>;
           <span class="hljs-keyword">if</span> (parent.<span class="hljs-property">hot</span>.<span class="hljs-property">_declinedDependencies</span>[moduleId]) {
               <span class="hljs-comment">// 如果依赖这个模块的parentModule设置了不理会当前moduleId热更新的策略，则不处理该parentModule</span>
               <span class="hljs-keyword">return</span> {
                   <span class="hljs-attr">type</span>: <span class="hljs-string">"declined"</span>,
                   <span class="hljs-attr">chain</span>: chain.<span class="hljs-title function_">concat</span>([parentId]),
                   <span class="hljs-attr">moduleId</span>: moduleId,
                   <span class="hljs-attr">parentId</span>: parentId
               };
           }
           <span class="hljs-comment">// 如果已经包含在准备更新的队列中，则不重复添加</span>
           <span class="hljs-keyword">if</span> (outdatedModules.<span class="hljs-title function_">indexOf</span>(parentId) !== -<span class="hljs-number">1</span>) <span class="hljs-keyword">continue</span>;
           <span class="hljs-keyword">if</span> (parent.<span class="hljs-property">hot</span>.<span class="hljs-property">_acceptedDependencies</span>[moduleId]) {
               <span class="hljs-keyword">if</span> (!outdatedDependencies[parentId])
                   outdatedDependencies[parentId] = [];
               <span class="hljs-comment">// TODO 这个parentModule设置了监听其依赖module的热更新</span>
               <span class="hljs-title function_">addAllToSet</span>(outdatedDependencies[parentId], [moduleId]);
               <span class="hljs-keyword">continue</span>;
           }
           <span class="hljs-keyword">delete</span> outdatedDependencies[parentId];
           outdatedModules.<span class="hljs-title function_">push</span>(parentId); <span class="hljs-comment">// 添加该parentModuleId到队列中，准备更新</span>

           <span class="hljs-comment">// 加入该parentModuleId到队列中，进行下一轮循环，把parentModule的相关parent也加入到更新中</span>
           queue.<span class="hljs-title function_">push</span>({
               <span class="hljs-attr">chain</span>: chain.<span class="hljs-title function_">concat</span>([parentId]),
               <span class="hljs-attr">id</span>: parentId
           });
       }
   }

   <span class="hljs-keyword">return</span> {
       <span class="hljs-attr">type</span>: <span class="hljs-string">"accepted"</span>,
       <span class="hljs-attr">moduleId</span>: updateModuleId,
       <span class="hljs-attr">outdatedModules</span>: outdatedModules,
       <span class="hljs-attr">outdatedDependencies</span>: outdatedDependencies
   };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">addAllToSet</span>(<span class="hljs-params">a, b</span>) {
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; b.<span class="hljs-property">length</span>; i++) {
       <span class="hljs-keyword">var</span> item = b[i];
       <span class="hljs-keyword">if</span> (a.<span class="hljs-title function_">indexOf</span>(item) === -<span class="hljs-number">1</span>) a.<span class="hljs-title function_">push</span>(item);
   }
}
</code></pre>
<p><strong>dispose 方法</strong></p>
<p><code>dispose</code> 方法是 <strong>HMR 模块替换流程中的“销毁旧模块”阶段</strong>，主要负责：</p>
<ul>
<li>
<p>清理缓存，将旧模块从模块系统中移除</p>
</li>
<li>
<p>移除之前注册的回调函数</p>
</li>
<li>
<p>移除目前 module 与其它 module 的绑定关系（ parent 和 children），避免旧模块残留影响新模块</p>
</li>
<li>
<p>为后续热更新的模块替换（apply 阶段）做准备</p>
</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-attr">dispose</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
   currentUpdateRemovedChunks.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">chunkId</span>) {
       <span class="hljs-keyword">delete</span> installedChunks[chunkId];
   });
   currentUpdateRemovedChunks = <span class="hljs-literal">undefined</span>;

   <span class="hljs-keyword">var</span> idx;
   <span class="hljs-keyword">var</span> queue = outdatedModules.<span class="hljs-title function_">slice</span>();
   <span class="hljs-keyword">while</span> (queue.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
       <span class="hljs-keyword">var</span> moduleId = queue.<span class="hljs-title function_">pop</span>();
       <span class="hljs-keyword">var</span> <span class="hljs-variable language_">module</span> = __webpack_require__.<span class="hljs-property">c</span>[moduleId];
       <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>) <span class="hljs-keyword">continue</span>;

       <span class="hljs-keyword">var</span> data = {};

       <span class="hljs-comment">// Call dispose handlers: 回调注册的disposeHandlers</span>
       <span class="hljs-keyword">var</span> disposeHandlers = <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_disposeHandlers</span>;
       <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; disposeHandlers.<span class="hljs-property">length</span>; j++) {
           disposeHandlers[j].<span class="hljs-title function_">call</span>(<span class="hljs-literal">null</span>, data);
       }
       <span class="hljs-comment">// __webpack_require__.hmrD = currentModuleData置为空</span>
       __webpack_require__.<span class="hljs-property">hmrD</span>[moduleId] = data;

       <span class="hljs-comment">// disable module (this disables requires from this module)</span>
       <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">active</span> = <span class="hljs-literal">false</span>;

       <span class="hljs-comment">// remove module from cache: 删除module的缓存数据</span>
       <span class="hljs-keyword">delete</span> __webpack_require__.<span class="hljs-property">c</span>[moduleId];

       <span class="hljs-comment">// when disposing there is no need to call dispose handler: 删除其它模块对该moduleId的accept回调</span>
       <span class="hljs-keyword">delete</span> outdatedDependencies[moduleId];

       <span class="hljs-comment">// remove "parents" references from all children: </span>
       <span class="hljs-comment">// 解除moduleId引用的其它模块跟moduleId的绑定关系，跟下面的解除关系是互相补充的</span>
       <span class="hljs-comment">// 一个是children，一个是parent</span>
       <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-variable language_">module</span>.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>; j++) {
           <span class="hljs-keyword">var</span> child = __webpack_require__.<span class="hljs-property">c</span>[<span class="hljs-variable language_">module</span>.<span class="hljs-property">children</span>[j]];
           <span class="hljs-keyword">if</span> (!child) <span class="hljs-keyword">continue</span>;
           idx = child.<span class="hljs-property">parents</span>.<span class="hljs-title function_">indexOf</span>(moduleId);
           <span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span>) {
               child.<span class="hljs-property">parents</span>.<span class="hljs-title function_">splice</span>(idx, <span class="hljs-number">1</span>);
           }
       }
   }

   <span class="hljs-comment">// remove outdated dependency from module children: </span>
   <span class="hljs-comment">// 解除引用该moduleId的模块跟moduleId的绑定关系，可以理解为moduleId.parent删除children，跟上面的解除关系是互相补充的</span>
   <span class="hljs-comment">// 一个是children，一个是parent</span>
   <span class="hljs-keyword">var</span> dependency;
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> outdatedModuleId <span class="hljs-keyword">in</span> outdatedDependencies) {
       <span class="hljs-variable language_">module</span> = __webpack_require__.<span class="hljs-property">c</span>[outdatedModuleId];
       <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>) {
           moduleOutdatedDependencies =
               outdatedDependencies[outdatedModuleId];
           <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; moduleOutdatedDependencies.<span class="hljs-property">length</span>; j++) {
               dependency = moduleOutdatedDependencies[j];
               idx = <span class="hljs-variable language_">module</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">indexOf</span>(dependency);
               <span class="hljs-keyword">if</span> (idx &gt;= <span class="hljs-number">0</span>) <span class="hljs-variable language_">module</span>.<span class="hljs-property">children</span>.<span class="hljs-title function_">splice</span>(idx, <span class="hljs-number">1</span>);
           }
       }

   }
}
</code></pre>
<p><strong>apply方法</strong></p>
<p><code>apply()</code>方法是**HMR 模块替换流程中的“加载新模块”阶段****，**主要执行的逻辑是：</p>
<ul>
<li>
<p>更新全局的 window.__webpack_require__  对象，存储了所有路径+内容的对象</p>
</li>
<li>
<p>执行 runtime 代码，比如 <code>_webpack_require__.h = ()=&gt; {"xxxxxhash值"}</code></p>
</li>
<li>
<p>触发之前 hot.accept 部署了依赖变化时的回调 callBack</p>
</li>
<li>
<p>重新加载标识 _selfAccepted 的 module，这种模块会重新 require 一次</p>
</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-attr">apply</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">reportError</span>) {
   <span class="hljs-comment">// insert new code</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> updateModuleId <span class="hljs-keyword">in</span> appliedUpdate) {
       <span class="hljs-comment">// __webpack_require__.m = __webpack_modules__</span>
       <span class="hljs-comment">// 更新全局的window.__webpack_require__对象，存储了所有路径+内容的对象</span>
       __webpack_require__.<span class="hljs-property">m</span>[updateModuleId] = appliedUpdate[updateModuleId];
   }

   <span class="hljs-comment">// run new runtime modules</span>
   <span class="hljs-comment">// 执行runtime代码，比如_webpack_require__.h = ()=&gt; {"xxxxxhash值"}</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; currentUpdateRuntime.<span class="hljs-property">length</span>; i++) {
       currentUpdateRuntime[i](__webpack_require__);
   }

   <span class="hljs-comment">// call accept handlers：触发之前hot.accept部署了依赖变化时的回调callBack</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> outdatedModuleId <span class="hljs-keyword">in</span> outdatedDependencies) {
       <span class="hljs-keyword">var</span> <span class="hljs-variable language_">module</span> = __webpack_require__.<span class="hljs-property">c</span>[outdatedModuleId];
       <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>) {
           moduleOutdatedDependencies =
               outdatedDependencies[outdatedModuleId];
           <span class="hljs-keyword">var</span> callbacks = [];
           <span class="hljs-keyword">var</span> errorHandlers = [];
           <span class="hljs-keyword">var</span> dependenciesForCallbacks = [];
           <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; moduleOutdatedDependencies.<span class="hljs-property">length</span>; j++) {
               <span class="hljs-keyword">var</span> dependency = moduleOutdatedDependencies[j];
               <span class="hljs-keyword">var</span> acceptCallback = <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_acceptedDependencies</span>[dependency];
               <span class="hljs-keyword">var</span> errorHandler = <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-property">_acceptedErrorHandlers</span>[dependency];
               <span class="hljs-keyword">if</span> (acceptCallback) {
                   <span class="hljs-keyword">if</span> (callbacks.<span class="hljs-title function_">indexOf</span>(acceptCallback) !== -<span class="hljs-number">1</span>) <span class="hljs-keyword">continue</span>;
                   callbacks.<span class="hljs-title function_">push</span>(acceptCallback);
                   errorHandlers.<span class="hljs-title function_">push</span>(errorHandler);
                   dependenciesForCallbacks.<span class="hljs-title function_">push</span>(dependency);
               }
           }
           <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; callbacks.<span class="hljs-property">length</span>; k++) {
               callbacks[k].<span class="hljs-title function_">call</span>(<span class="hljs-literal">null</span>, moduleOutdatedDependencies);
           }
       }
   }

   <span class="hljs-comment">// Load self accepted modules：重新加载标识_selfAccepted的module，这种模块会重新require一次</span>
   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> o = <span class="hljs-number">0</span>; o &lt; outdatedSelfAcceptedModules.<span class="hljs-property">length</span>; o++) {
       <span class="hljs-keyword">var</span> item = outdatedSelfAcceptedModules[o];
       <span class="hljs-keyword">var</span> moduleId = item.<span class="hljs-property">module</span>;

       item.<span class="hljs-built_in">require</span>(moduleId);
   }

   <span class="hljs-keyword">return</span> outdatedModules;
  }
</code></pre>
<h3 data-id="heading-20">总结</h3>
<p>前端构建工具让模块管理、资源打包和优化变得高效，提升了开发体验和应用性能。Webpack 的工作原理尤其值得学习：从模块解析、依赖图构建，到 Chunk 生成和热更新，它展示了现代前端构建的完整机制。理解这些原理不仅能帮助我们更好地使用工具，也能为优化前端项目打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent 设计模式 - ReAct 模式]]></title>    <link>https://juejin.cn/post/7586555198115151878</link>    <guid>https://juejin.cn/post/7586555198115151878</guid>    <pubDate>2025-12-23T00:07:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586555198115151878" data-draft-id="7586498198149627955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent 设计模式 - ReAct 模式"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-23T00:07:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子洋"/> <meta itemprop="url" content="https://juejin.cn/user/1099167359835015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent 设计模式 - ReAct 模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167359835015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子洋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:07:24.000Z" title="Tue Dec 23 2025 00:07:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="tomorrow">.hljs-comment,.hljs-quote{color:#8e908c}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c82829}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5871f}.hljs-attribute{color:#eab700}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#718c00}.hljs-section,.hljs-title{color:#4271ae}.hljs-keyword,.hljs-selector-tag{color:#8959a8}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#4d4d4c}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上一篇我们介绍了 AI 应用的发展历程以及 Agent 的整体概念，这一篇将针对 <strong>ReAct（Reasoning + Acting）模式</strong>，并对其设计思想和工程实现进行一次更为系统、偏实战向的讲解。</p>
<p>在讲解 ReAct 之前，有必要先澄清一个经常被混用的问题：<strong>Agent 到底是什么？</strong></p>
<p>在早期以及当下大量工程实践中，不同 AI 应用对 Agent 的定义并不一致。很多所谓的 Agent，本质上更接近一个<strong>预先定义好的 AI workflow</strong>：流程、工具、策略都由应用侧提前固化，用户只是触发执行。例如，一个 WebSearch 场景往往就对应一个「搜索 Agent」，或者通过特定提示词（如 <code>/agent</code>）来唤醒一组固定的搜索工具。</p>
<p>从工程视角看，这类 Agent 更多是<strong>能力封装与产品抽象</strong>，而不是研究语境中强调的「具备自主决策与反馈能力的智能体」。也正因为如此，随着概念被频繁复用，<code>agent</code> 这个词在实际讨论中逐渐变得模糊，单独听到它已很难准确判断其具体能力边界。</p>
<p>如果暂时抛开命名争议，从实现层面抽象来看，一个 Agent 的核心逻辑其实非常简单：<strong>一个受控的循环（loop）</strong>。在这个循环中，模型不断获取上下文、进行推理、执行动作，并根据结果继续调整行为，直到满足终止条件为止。</p>
<p>在工程实现中，这个过程往往可以被近似理解为：</p>
<ul>
<li>多轮调用 LLM</li>
<li>中间可能伴随工具调用</li>
<li>有明确的退出条件（如任务完成、步数上限、token 预算）</li>
</ul>
<p>基于这样的背景，各类 Agent 设计模式（也可以称为范式或框架）逐步出现，而其中最经典、也最具代表性的，便是 <strong>ReAct 模式</strong>。该模式最早发表于 2022 年，其结构至今仍足以支撑大量中低复杂度的 Agent 场景。</p>
<h2 data-id="heading-1">ReAct 模式</h2>
<h3 data-id="heading-2">核心思想</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2d1ed965f844c919ea69313b89065c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=qL5MuILhjAp6RcO4YY9jaQ2NlTM%3D" alt="" loading="lazy"/></p>
<p>ReAct 的提出，本质上是为了解决一个早期 LLM 应用中的割裂问题：<strong>推理与行动往往是分离的</strong>。</p>
<p>在 ReAct 出现之前，常见的两类模式分别是：</p>
<ul>
<li><strong>Reason-only</strong>：模型进行显式推理（如 CoT、Scratchpad），但不与外部环境交互</li>
<li><strong>Act-heavy / Tool-driven</strong>：模型频繁调用工具获取信息，但推理过程并不显式呈现或不与行动交错</li>
</ul>
<p>需要说明的是，这里的分类来自 ReAct 论文中的抽象对比，而并非对具体系统内部实现的严格学术归类。例如：</p>
<ul>
<li>SayCan 内部同样包含推理与可行性评估，并非“无 reasoning”</li>
<li>WebGPT 也存在内部推理过程，只是推理与行动并未以交错形式呈现给模型</li>
</ul>
<p>在这种背景下，<strong>ReAct（Reasoning + Acting）</strong> 的核心思想可以概括为一句话：</p>
<blockquote>
<p><strong>在行动中思考，在思考中决定行动。</strong></p>
</blockquote>
<p>它尝试将<strong>思考</strong>和<strong>行动</strong>统一到一个连续的闭环中，模拟人类解决问题时的自然过程：</p>
<ol>
<li><strong>Thought</strong>：分析当前状态与目标</li>
<li><strong>Action</strong>：基于判断调用工具或执行操作</li>
<li><strong>Observation</strong>：观察行动结果</li>
<li><strong>Thought</strong>：根据新信息再次推理</li>
<li>重复上述过程，直到问题解决</li>
</ol>
<p>从形式上看，ReAct 并没有引入复杂的新组件，而是通过 <strong>Thought → Action → Observation</strong> 的反复交替，显著提升了模型在多步任务、信息不完备任务中的表现稳定性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54b2fcf4b5c1480a843b66419e2e2a8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=sffR0OM%2BhSqLAVWpgOglV802ZW4%3D" alt="" loading="lazy"/></p>
<p>上图是 ReAct 论文中的一个示例，主要对比了 <strong>Standard、Reason Only、Act Only 以及 ReAct</strong> 四种不同范式在同一问题下的表现差异。Standard 方式直接给出答案，既不显式展开推理，也不与外部环境交互；Reason Only 虽然在回答前进行了逐步推理，但推理过程完全依赖模型自身的知识，一旦前提判断错误，结论便无法被外部信息纠正；Act Only 则能够多轮调用搜索等工具获取信息，但由于缺乏明确的推理指导，行动过程较为盲目，最终仍然得出了错误结果。相比之下，ReAct 通过多轮 <strong>Thought → Act → Observation</strong> 的交错执行，使模型能够在行动结果的反馈下不断修正推理路径，最终在后续轮次中得到正确答案。</p>
<h3 data-id="heading-3">核心实现</h3>
<p>从工程角度看，ReAct 的实现并不复杂，其本质就是一个<strong>带有终止条件的循环控制结构</strong>。可以用下面这段高度简化的伪代码来概括：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 简化版实现逻辑</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLoops; i++) {
    <span class="hljs-comment">// 1. 思考：LLM分析当前情况，决定做什么</span>
    <span class="hljs-keyword">const</span> { thought, action, args, final } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">llmThink</span>();
    
    <span class="hljs-keyword">if</span> (final) {
        <span class="hljs-comment">// 任务完成</span>
        <span class="hljs-keyword">break</span>;
    }
    
    <span class="hljs-comment">// 2. 行动：调用具体的工具</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">callTool</span>(action, args);
    
    <span class="hljs-comment">// 3. 观察：将结果作为下一次思考的输入</span>
    context.<span class="hljs-title function_">push</span>(<span class="hljs-string">`观察到：<span class="hljs-subst">${result}</span>`</span>);
}
</code></pre>
<p>这段代码已经基本覆盖了 ReAct 的核心机制：</p>
<ul>
<li><strong>循环驱动</strong>：模型在多轮中逐步逼近目标</li>
<li><strong>模型自决策</strong>：由 LLM 决定是否继续、是否调用工具</li>
<li><strong>显式终止条件</strong>：通过 <code>final</code> 或循环上限避免失控</li>
</ul>
<p>在真实系统中，通常还会叠加更多安全与成本控制机制，例如：</p>
<ul>
<li>最大循环次数（maxLoops）</li>
<li>token 或调用预算</li>
<li>工具调用白名单</li>
</ul>
<h3 data-id="heading-4">具体实现</h3>
<p>下面将结合一份实际可运行的代码示例，展示一个简化但完整的 ReAct Agent 实现。</p>
<h4 data-id="heading-5">LLM 调用</h4>
<p>这里使用 <code>@ai-sdk</code> 封装多厂商模型调用，示例中支持 OpenAI 与 Azure OpenAI。该部分属于基础设施层，与 ReAct 本身并无强耦合，因此不再展开其原理。具体的介绍和使用方式可以看我之前写的这篇文章 <a href="https://juejin.cn/user/1099167359835015/posts" target="_blank" title="https://juejin.cn/user/1099167359835015/posts">《AI 开发者必备：Vercel AI SDK 轻松搞定多厂商 AI 调用》</a> 。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { generateText } <span class="hljs-keyword">from</span> <span class="hljs-string">"ai"</span>;
<span class="hljs-keyword">import</span> { createOpenAI } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/openai"</span>;
<span class="hljs-keyword">import</span> { createAzure } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/azure"</span>;

<span class="hljs-comment">/**
 * Build a model client from env/config.
 * Supported providers: 'openai', 'azure'.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getModelClient</span>(<span class="hljs-params">options = {}</span>) {
  <span class="hljs-keyword">const</span> {
    provider = process.<span class="hljs-property">env</span>.<span class="hljs-property">AI_PROVIDER</span> || <span class="hljs-string">"openai"</span>,
    apiKey = process.<span class="hljs-property">env</span>.<span class="hljs-property">AI_PROVIDER_API_KEY</span>,
    baseURL = process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_BASE_URL</span> || process.<span class="hljs-property">env</span>.<span class="hljs-property">AZURE_OPENAI_BASE_URL</span>,
    resourceName = process.<span class="hljs-property">env</span>.<span class="hljs-property">AZURE_OPENAI_RESOURCE_NAME</span>, <span class="hljs-comment">// for azure</span>
  } = options;

  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">AI_MOCK</span> === <span class="hljs-string">"1"</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">client</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">model</span>: <span class="hljs-literal">null</span> };
  }

  <span class="hljs-keyword">if</span> (!apiKey) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Missing API key: set AI_PROVIDER_API_KEY"</span>);
  }

  <span class="hljs-keyword">if</span> (provider === <span class="hljs-string">"azure"</span>) {
    <span class="hljs-keyword">const</span> azure = <span class="hljs-title function_">createAzure</span>({ apiKey, resourceName });
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">client</span>: azure, <span class="hljs-attr">model</span>: <span class="hljs-title function_">azure</span>(<span class="hljs-string">"gpt-5"</span>) };
  }

  <span class="hljs-keyword">const</span> openai = <span class="hljs-title function_">createOpenAI</span>({ apiKey, baseURL });
  <span class="hljs-keyword">const</span> modelName = process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_MODEL</span> || <span class="hljs-string">"gpt-4o-mini"</span>;
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">client</span>: openai, <span class="hljs-attr">model</span>: <span class="hljs-title function_">openai</span>(modelName) };
}

<span class="hljs-comment">/**
 * Chat-like step with messages array support.
 * messages: [{ role: 'system'|'user'|'assistant', content: string }]
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">llmChat</span>(<span class="hljs-params">{ messages, schema, options = {} }</span>) {
  <span class="hljs-keyword">const</span> { model } = <span class="hljs-title function_">getModelClient</span>(options);
  <span class="hljs-keyword">const</span> system = messages.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">m</span>) =&gt;</span> m.<span class="hljs-property">role</span> === <span class="hljs-string">"system"</span>)?.<span class="hljs-property">content</span>;

  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateText</span>({
    model,
    system,
    messages,
    ...(schema ? { schema } : {}),
  });
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>核心作用只有一个：<strong>以 Chat 形式向模型发送上下文，并获得结构化输出</strong>。</p>
<h4 data-id="heading-6">ReAct 主逻辑</h4>
<p>在下面这段代码中，我们完整实现了一个 ReAct Agent 的核心循环逻辑。首先通过 system prompt 对模型的输出形式和行为进行强约束，明确要求其<strong>仅以 JSON 格式返回结果</strong>，且只能包含 <code>thought</code>、<code>action</code>、<code>args</code>、<code>final</code> 四个字段，并分别约定了调用工具与结束任务时的输出规范。与此同时，在 <code>user</code> 消息中显式告知模型当前可用的 tools 列表，并附带每个工具的功能说明与参数定义，使模型能够在循环过程中基于明确的能力边界自主决策是否进行工具调用。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { llmChat } <span class="hljs-keyword">from</span> <span class="hljs-string">"../llm/provider.js"</span>;
<span class="hljs-keyword">import</span> { callTool, formatToolList } <span class="hljs-keyword">from</span> <span class="hljs-string">"../tools/index.js"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SYSTEM</span> = <span class="hljs-string">`You are a ReAct-style agent.

You must reason and act using the following loop:
Thought → Action → Observation
This loop may repeat multiple times.

Output format rules:
- You MUST respond with a single JSON object
- The JSON object MUST contain only the following keys:
  - thought (string)
  - action (string, optional)
  - args (object, optional)
  - final (string, optional)
- No additional keys are allowed
- Do NOT use Markdown
- Do NOT include any text outside the JSON object

Behavior rules:
- If you need to call a tool, output "thought", "action", and "args"
- If no further action is required, output "thought" and "final"
- When "final" is present, the response is considered complete and no further steps will be taken
- Do NOT include "action" or "args" when returning "final"

Always follow these rules strictly.`</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runReAct</span>(<span class="hljs-params">{ task, maxLoops = <span class="hljs-number">6</span>, options = {} } = {}</span>) {
  <span class="hljs-keyword">const</span> messages = [
    { <span class="hljs-attr">role</span>: <span class="hljs-string">"system"</span>, <span class="hljs-attr">content</span>: <span class="hljs-variable constant_">SYSTEM</span> },
    {
      <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">`Task: <span class="hljs-subst">${task}</span>\nAvailable tools: <span class="hljs-subst">${formatToolList()}</span>`</span>,
    },
  ];

  <span class="hljs-keyword">const</span> trace = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLoops; i++) {
    <span class="hljs-keyword">const</span> { text } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">llmChat</span>({ messages, options });
    <span class="hljs-keyword">let</span> parsed;
    <span class="hljs-keyword">try</span> {
      parsed = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(text);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// console.warn("Parse failed. Text:", text);</span>
      <span class="hljs-comment">// console.warn("Error:", String(e));</span>
      messages.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-attr">content</span>: text });
      messages.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">`Format error: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(e)}</span>.
        You previously violated the required JSON format.
        This is a strict requirement.

        If the response is not valid JSON or contains extra text, it will be discarded.
        Retry now.`</span>,
      });
      <span class="hljs-keyword">continue</span>;
    }

    trace.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">step</span>: i + <span class="hljs-number">1</span>, <span class="hljs-attr">model</span>: parsed });

    <span class="hljs-keyword">if</span> (parsed.<span class="hljs-property">final</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Final result:"</span>, parsed.<span class="hljs-property">final</span>);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">final</span>: parsed.<span class="hljs-property">final</span>, trace };
    }

    <span class="hljs-keyword">if</span> (!parsed.<span class="hljs-property">action</span>) {
      messages.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-attr">content</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(parsed) });
      messages.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-attr">content</span>:
          <span class="hljs-string">"No action provided. Please continue with a tool call or final."</span>,
      });
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Action:"</span>, parsed.<span class="hljs-property">action</span>);
    <span class="hljs-keyword">const</span> observation = <span class="hljs-keyword">await</span> <span class="hljs-title function_">callTool</span>(parsed.<span class="hljs-property">action</span>, parsed.<span class="hljs-property">args</span> || {});
    trace[trace.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">observation</span> = observation;
    messages.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-attr">content</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(parsed) });
    messages.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">`Observation: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(observation)}</span>. Continue.`</span>,
    });
  }

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">final</span>: <span class="hljs-string">"Max loops reached without final."</span>, trace };
}

</code></pre>
<h4 data-id="heading-7">Tools</h4>
<p>Tools 指的是模型在 ReAct 循环中可以调用的具体外部能力接口。通常，一个工具由<strong>工具名称、功能描述、参数定义以及对应的 handler 实现</strong>组成。下面示例中实现了两个最基础的文件操作工具：<code>readFileTool</code> 用于读取文件内容，<code>writeFileTool</code> 用于写入文件，两者都完整描述了工具名称、用途、参数 Schema 以及实际执行逻辑。<code>createTool</code> 只是一个用于约定工具输出结构的辅助函数，本身并不涉及核心逻辑，主要用于在非 TS 环境下做基础的参数校验。</p>
<p>这里使用 <code>zod</code> 作为参数校验工具，它可以在 JS / TS 环境中统一使用，通过定义 schema 并在运行时执行 <code>parse</code> 校验，有效缓解模型参数幻觉问题；同时可以直接使用 schema 生成标准的 JSON Schema，作为工具参数说明提供给模型，从而减少手写参数描述的成本。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"fs/promises"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;
<span class="hljs-keyword">import</span> { createTool } <span class="hljs-keyword">from</span> <span class="hljs-string">"./types.js"</span>;

<span class="hljs-keyword">const</span> readFileSchema = z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">file</span>: z.<span class="hljs-title function_">string</span>() });
<span class="hljs-keyword">const</span> writeFileSchema = z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">file</span>: z.<span class="hljs-title function_">string</span>(), <span class="hljs-attr">content</span>: z.<span class="hljs-title function_">string</span>() });

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> readFileTool = <span class="hljs-title function_">createTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"read_file"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"Read a UTF-8 text file from workspace"</span>,
  <span class="hljs-attr">schema</span>: readFileSchema,
  <span class="hljs-attr">handler</span>: <span class="hljs-keyword">async</span> ({ file }) =&gt; {
    <span class="hljs-keyword">const</span> abs = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), file);
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(abs, <span class="hljs-string">"utf-8"</span>);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">content</span>: data };
  },
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> writeFileTool = <span class="hljs-title function_">createTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"write_file"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"Write a UTF-8 text file to workspace (overwrite)"</span>,
  <span class="hljs-attr">schema</span>: writeFileSchema,
  <span class="hljs-attr">handler</span>: <span class="hljs-keyword">async</span> ({ file, content }) =&gt; {
    <span class="hljs-keyword">const</span> abs = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), file);
    <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">mkdir</span>(path.<span class="hljs-title function_">dirname</span>(abs), { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
    <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(abs, content, <span class="hljs-string">"utf-8"</span>);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">`wrote <span class="hljs-subst">${file}</span>`</span> };
  },
});
</code></pre>
<h3 data-id="heading-8">实际效果</h3>
<p>基于上述 ReAct 实现，我尝试让模型在本地环境中完成多个小游戏的生成与迭代，包括：<code>2048</code>、<code>飞机大战</code>、<code>贪吃蛇</code>、<code>五子棋</code>。从结果来看，整体完成度和可玩性都明显优于我<a href="https://link.juejin.cn?target=alexpang.cn%2Fleafer-games%2F" target="_blank" title="alexpang.cn/leafer-games/" ref="nofollow noopener noreferrer">早期纯手写的一些 demo</a>。当然，需要强调的是：<strong>ReAct 并不会凭空提升模型能力，它更多是一种能力放大器。</strong></p>
<p>最终效果在很大程度上仍然依赖于底层模型本身的代码生成、规划与理解能力，而 ReAct 负责的，是为这些能力提供一个稳定的执行框架。</p>
<h4 data-id="heading-9">2048</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af622ebf37304576a7bb9ca20821ac56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=KANcNJ1zxfeDyYRbdHmQcDFPWK8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">飞机大战</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7136ce6e72fc48b9881d0e63e0bbcbe0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=QC%2FvP0NguOuKg5HhWX8DV2OyY14%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-11">贪吃蛇</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/969ede2823b844219528d2112ed217b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=w6La6lPHlBabkIcuAYIcm%2FeAoi4%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">五子棋</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba52da741cba462a9cc56c06a994bc83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=CPRLifd3j0ktRO%2BX7LZ7z9ITd0U%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">结语</h2>
<p>ReAct 并不是最复杂、也不是最“智能”的 Agent 模式，但它结构清晰、实现成本低、工程可控性强，是理解和实践 Agent 系统非常合适的起点。</p>
<p>在后续更复杂的场景中，往往会在 ReAct 之上叠加：规划（Plan &amp; Execute）、反思（Reflection）、记忆与长期状态，但无论如何，ReAct 所确立的 <strong>思考—行动—反馈闭环</strong>，仍然是多数 Agent 系统绕不开的基础结构。</p>
<p>在下一篇中，我们将展开对 <strong>P&amp;E（Plan and Execute）模式</strong> 的详细解析，重点介绍其设计理念、执行流程及具体实现方式。</p>
<blockquote>
<p>我已将相关代码开源到 GitHub，感兴趣的同学可以下载到本地后执行一下玩玩：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAlessandro-Pang%2Fagent-desgin-pattern-demo" target="_blank" title="https://github.com/Alessandro-Pang/agent-desgin-pattern-demo" ref="nofollow noopener noreferrer">github.com/Alessandro-…</a></p>
</blockquote>
<h2 data-id="heading-14">相关资料</h2>
<ul>
<li><strong>GitHub 仓库</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAlessandro-Pang%2Fagent-desgin-pattern-demo" target="_blank" title="https://github.com/Alessandro-Pang/agent-desgin-pattern-demo" ref="nofollow noopener noreferrer">github.com/Alessandro-…</a></li>
<li><strong>AI Agent 介绍:</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fshort.pangcy.cn%2Fu%2F139a9efccce1fce2" target="_blank" title="https://short.pangcy.cn/u/139a9efccce1fce2" ref="nofollow noopener noreferrer">short.pangcy.cn/u/139a9efcc…</a></li>
<li><strong>ReAct 模式</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8446066" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8446066" ref="nofollow noopener noreferrer">www.bohrium.com/paper/read?…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙开发：一个底部的曲线导航]]></title>    <link>https://juejin.cn/post/7586500093844684842</link>    <guid>https://juejin.cn/post/7586500093844684842</guid>    <pubDate>2025-12-23T00:55:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586500093844684842" data-draft-id="7586491717874237459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙开发：一个底部的曲线导航"/> <meta itemprop="keywords" content="HarmonyOS,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-23T00:55:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员一鸣"/> <meta itemprop="url" content="https://juejin.cn/user/1398234520239095"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙开发：一个底部的曲线导航
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234520239095/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员一鸣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:55:23.000Z" title="Tue Dec 23 2025 00:55:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>似乎现在的应用，底部导航都是千篇一律，基本上都是几个按钮，点击之后，切换切换图标，更改更改颜色，稍微好点的会增加动画效果，今天，给大家推荐一款，底部的曲线导航，它可以让底部导航的实现方式别具一格。</p>
<p>我们先看下静态效果：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f041a5ca9d4c45a881971553d33c89cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056123&amp;x-signature=9suh0nqVyaIrkNUlpb4HGhvtOIE%3D" alt="" width="50%" loading="lazy"/></p>
<p>动态效果如下：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9073068a2d4442ce8611c7bcb4925e6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056123&amp;x-signature=pso7Bbd5T1QpDUHMz4CJ%2Fw%2BZbHw%3D" alt="" width="50%" loading="lazy"/></p>
<p>目前第一个版本，完成了基本的曲线形式效果，还未追加曲线的移动动画，在下一个版本会加上，那么针对这样的一个曲线形式导航，它是如何来实现的呢？答案很简单，就是使用简单的Path路径绘制。</p>
<p>Path路径，有两种方式实现，一种是系统提供的Path组件，另一种就是使用new drawing.Path()，然后使用canvas来绘制，两种方式都可以实现，看大家的技术选型，这里我使用的是Path组件，因为只需要设置符合SVG路径描述规范的命令字符串即可实现。</p>
<h2 data-id="heading-1">SVG路径介绍</h2>
<p>SVG路径是SVG（可缩放矢量图形）中用于创建复杂形状的核心元素，通过数学描述定义图形轮廓，支持直线、曲线、弧线等多种图形绘制。‌</p>
<p>例如，绘制一个三角形，直接在属性commands传递SVG路径即可，代码如下：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title class_">Path</span>()
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'210px'</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'310px'</span>)
        .<span class="hljs-title function_">commands</span>(<span class="hljs-string">'M100 0 L200 240 L0 240 Z'</span>)
        .<span class="hljs-title function_">fillOpacity</span>(<span class="hljs-number">0</span>)
        .<span class="hljs-title function_">stroke</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)
        .<span class="hljs-title function_">strokeWidth</span>(<span class="hljs-number">3</span>)
</code></pre>
<p>相对来说还是比较的简单，下面就针对SVG中的绘制命令，简单的罗列一下：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80e8acfb872f474e95bd047f8b3d2bef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056123&amp;x-signature=1%2FCDeBxyVgsk%2BOet1aGSYFhgZ4Q%3D" alt="" width="50%" loading="lazy"/></p>
<h2 data-id="heading-2">曲线绘制</h2>
<p>由于需要点击时，让本按钮进行曲线展示，有两个方面需要考虑，一是曲线的位置，点击不同位置的按钮，曲线就会移动到指定位置，二是曲线连接之处，保持平滑过渡，使用三次贝塞尔曲线段完成。</p>
<p>完整的绘制曲线代码如下，大家可以作为参考，averageWidth为每个tab按钮的宽度，navigationSize为导航数量。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"> <span class="hljs-comment">// 绘制曲线的函数</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">drawCurve</span>(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-comment">// 初始点：0,100</span>
    <span class="hljs-keyword">let</span> tagPosition = <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> d = <span class="hljs-string">'M 0 '</span> + tagPosition;

    <span class="hljs-comment">// 计算曲线的起始和结束位置</span>
    <span class="hljs-keyword">const</span> curveStart = (position - <span class="hljs-number">1</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">averageWidth</span>;
    <span class="hljs-keyword">const</span> curveEnd = position * <span class="hljs-variable language_">this</span>.<span class="hljs-property">averageWidth</span>;

    <span class="hljs-comment">// 0到曲线起始位置的直线部分</span>
    <span class="hljs-keyword">if</span> (curveStart &gt; <span class="hljs-number">0</span>) {
      d += <span class="hljs-string">' L '</span> + curveStart + <span class="hljs-string">' '</span> + tagPosition;
    }

    <span class="hljs-comment">// 曲线部分：使用两个三次贝塞尔曲线段确保平滑连接</span>
    <span class="hljs-keyword">const</span> midPoint = (curveStart + curveEnd) / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> controlPoint1X = curveStart + (<span class="hljs-variable language_">this</span>.<span class="hljs-property">averageWidth</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">navigationSize</span>);
    <span class="hljs-keyword">const</span> controlPoint2X = curveEnd - (<span class="hljs-variable language_">this</span>.<span class="hljs-property">averageWidth</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">navigationSize</span>);

    d += <span class="hljs-string">' C '</span> + controlPoint1X + <span class="hljs-string">' '</span> + tagPosition + <span class="hljs-string">' '</span> + controlPoint1X + <span class="hljs-string">' '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateCurveBottom</span> + <span class="hljs-string">' '</span> +
      midPoint +
      <span class="hljs-string">' '</span> +
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateCurveBottom</span>;
    d += <span class="hljs-string">' C '</span> + controlPoint2X + <span class="hljs-string">' '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateCurveBottom</span> + <span class="hljs-string">' '</span> + controlPoint2X + <span class="hljs-string">' '</span> + tagPosition + <span class="hljs-string">' '</span> +
      curveEnd +
      <span class="hljs-string">' '</span> + tagPosition;

    <span class="hljs-comment">// 曲线结束位置到最大宽度的直线部分</span>
    <span class="hljs-keyword">if</span> (curveEnd &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateMaxWidth</span>) {
      d += <span class="hljs-string">' L '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateMaxWidth</span> + <span class="hljs-string">' '</span> + tagPosition;
    }

    <span class="hljs-comment">// 新增闭合路径逻辑</span>
    d += <span class="hljs-string">` V <span class="hljs-subst">${<span class="hljs-variable language_">this</span>._privateCurveBottom}</span>`</span>; <span class="hljs-comment">// 垂直延伸到底部</span>
    d += <span class="hljs-string">' H 0'</span>; <span class="hljs-comment">// 水平返回起点</span>
    d += <span class="hljs-string">' Z'</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privatePathCommands</span> = d

  }
</code></pre>
<h2 data-id="heading-3">快速使用</h2>
<p>如果你不想自己实现，而是想快速的使用，这个已经为大家考虑到了，目前已经上传到到了中心仓库，有需要的同学，可以前去体验。</p>
<p>中心仓库地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2Fdetail%2F%40abner%252Fcurve_navigation" target="_blank" title="https://ohpm.openharmony.cn/#/cn/detail/@abner%2Fcurve_navigation" ref="nofollow noopener noreferrer">ohpm.openharmony.cn/#/cn/detail…</a></p>
<h3 data-id="heading-4">依赖方式</h3>
<h4 data-id="heading-5">1、远程依赖</h4>
<p>方式一：在Terminal窗口中，执行如下命令安装三方包，DevEco Studio会自动在工程的oh-package.json5中自动添加三方包依赖。</p>
<p><strong>建议：在使用的模块路径下进行执行命令。</strong></p>
<pre><code class="hljs language-TypeScript" lang="TypeScript">ohpm install <span class="hljs-meta">@abner</span>/curve_navigation
</code></pre>
<p>方式二：在模块的oh-package.json5中设置三方包依赖，配置示例如下：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-string">"dependencies"</span>: { <span class="hljs-string">"@abner/curve_navigation"</span>: <span class="hljs-string">"^1.0.1"</span>}
</code></pre>
<h3 data-id="heading-6">代码使用</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title class_">CurveNavigation</span>({
  <span class="hljs-attr">navigationSize</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">//tab数量</span>
  <span class="hljs-attr">navigationPaddingBottom</span>: <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowBottomNavHeight</span>,<span class="hljs-comment">//距离底部距离</span>
  <span class="hljs-attr">onPageChange</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
    <span class="hljs-comment">//page改变</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectIndex</span> = position
  },
  <span class="hljs-attr">tabView</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
    <span class="hljs-comment">//导航视图</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">tabView</span>(position)
  },
  <span class="hljs-attr">pageView</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
    <span class="hljs-comment">//页面视图</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pageView</span>(position)
  }
})
</code></pre>
<h3 data-id="heading-7">完整案例</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">tempColorArray</span>: <span class="hljs-title class_">ResourceColor</span>[] = [<span class="hljs-string">"#ffcc80"</span>, <span class="hljs-string">"#ff9323ac"</span>, <span class="hljs-string">"#ff26a965"</span>, <span class="hljs-string">"#ff93d923"</span>, <span class="hljs-string">"#ff11c5de"</span>,]
  <span class="hljs-meta">@State</span> <span class="hljs-attr">selectIndex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">tabArray</span>: <span class="hljs-title class_">Resource</span>[] =
    [$r(<span class="hljs-string">'sys.symbol.house_fill'</span>), $r(<span class="hljs-string">'sys.symbol.square_fill_grid_2x2'</span>), $r(<span class="hljs-string">'sys.symbol.bell_fill'</span>),
      $r(<span class="hljs-string">'sys.symbol.externaldrive_fill'</span>), $r(<span class="hljs-string">'sys.symbol.person_2_fill'</span>)]

  <span class="hljs-meta">@Builder</span>
  <span class="hljs-title function_">tabView</span>(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectIndex</span> == position) {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">SymbolGlyph</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tabArray</span>[position])
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
          .<span class="hljs-title function_">renderingStrategy</span>(<span class="hljs-title class_">SymbolRenderingStrategy</span>.<span class="hljs-property">SINGLE</span>)
          .<span class="hljs-title function_">fontColor</span>([<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>])
      }
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)
      .<span class="hljs-title function_">width</span>(<span class="hljs-number">35</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-number">35</span>)
      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">35</span>)
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title class_">SymbolGlyph</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tabArray</span>[position])
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
        .<span class="hljs-title function_">renderingStrategy</span>(<span class="hljs-title class_">SymbolRenderingStrategy</span>.<span class="hljs-property">SINGLE</span>)
        .<span class="hljs-title function_">fontColor</span>([<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>])
    }

  }

  <span class="hljs-meta">@Builder</span>
  <span class="hljs-title function_">pageView</span>(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(position.<span class="hljs-title function_">toString</span>())
    }.<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)
    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tempColorArray</span>[position])
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">RelativeContainer</span>() {
      <span class="hljs-title class_">CurveNavigation</span>({
        <span class="hljs-attr">navigationSize</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">//tab数量</span>
        <span class="hljs-attr">navigationPaddingBottom</span>: <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowBottomNavHeight</span>,
        <span class="hljs-attr">onPageChange</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectIndex</span> = position
        },
        <span class="hljs-attr">tabView</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">tabView</span>(position)
        },
        <span class="hljs-attr">pageView</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pageView</span>(position)
        }
      })
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
  }
}
</code></pre>
<h4 data-id="heading-8">属性介绍</h4>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b2c5ded8c4647e0a9ef6626693bb82c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056123&amp;x-signature=YyLI5MEVxt%2FqlxkIPnUgDV5roQ8%3D" alt="" width="70%" loading="lazy"/></p>
<h2 data-id="heading-9">相关总结</h2>
<p>目前唯一的遗憾是，没有实现曲线在切换时的动画偏移，而是直接的切换，后续会针对这块再单独的处理，大家可以先进行使用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>